function AreaWidget(e){var c="contains";var b="north";var g="south";var d="east";var a="west";var f="arealink";RamaddaUtil.inherit(this,{display:e,getHtml:function(){var o=this.display.getGet();var n=HtmlUtil.checkbox(this.display.getDomId(c),["title","Search mode: checked - contains, unchecked - overlaps"],false);var l=HtmlUtil.onClick(o+".areaWidget.areaLinkClick();",HtmlUtil.image(root+(this.linkArea?"/icons/link.png":"/icons/link_break.png"),[ATTR_TITLE,"Set bounds from map",ATTR_CLASS,"display-area-link","border","0",ATTR_ID,this.display.getDomId(f)]));var m=HtmlUtil.onClick(o+".areaWidget.useMyLocation();",HtmlUtil.image(root+"/icons/compass.png"),[ATTR_TITLE,"Set my location",ATTR_CLASS,"display-area-link","border","0"]);var k=HtmlUtil.onClick(o+".areaWidget.areaClear();",HtmlUtil.image(root+"/icons/eraser.png",[ATTR_TITLE,"Clear form",ATTR_CLASS,"display-area-link","border","0"]));var h=HtmlUtil.openTag(TAG_TABLE,[ATTR_CLASS,"display-area","border","0","cellpadding","0","cellspacing","0"]);h+=HtmlUtil.tr([],HtmlUtil.td(["align","center"],HtmlUtil.leftCenterRight(m,HtmlUtil.input(b,"",["placeholder","N",ATTR_CLASS,"input display-area-input","size","5",ATTR_ID,this.display.getDomId(b),ATTR_TITLE,"North"]),l,"20%","60%","20%")));h+=HtmlUtil.tr([],HtmlUtil.td([],HtmlUtil.input(a,"",["placeholder","W",ATTR_CLASS,"input  display-area-input","size","5",ATTR_ID,this.display.getDomId(a),ATTR_TITLE,"West"])+HtmlUtil.input(d,"",["placeholder","E",ATTR_CLASS,"input  display-area-input","size","5",ATTR_ID,this.display.getDomId(d),ATTR_TITLE,"East"])));h+=HtmlUtil.tr([],HtmlUtil.td(["align","center"],HtmlUtil.leftCenterRight(k,HtmlUtil.input(g,"",["placeholder","S",ATTR_CLASS,"input  display-area-input","size","5",ATTR_ID,this.display.getDomId(g),ATTR_TITLE,"South"]),n)));h+=HtmlUtil.closeTag(TAG_TABLE);return h},areaClear:function(){$("#"+this.display.getDomId(b)).val("");$("#"+this.display.getDomId(a)).val("");$("#"+this.display.getDomId(g)).val("");$("#"+this.display.getDomId(d)).val("");this.display.areaClear()},useMyLocation:function(){if(navigator.geolocation){var h=this;navigator.geolocation.getCurrentPosition(function(k){h.setUseMyLocation(k)})}else{}},setUseMyLocation:function(h){var k=h.coords.latitude;var m=h.coords.longitude;var l=5;if(this.display.myLocationOffset){l=parseFloat(this.display.myLocationOffset)}$("#"+this.display.getDomId(b)).val(k+l);$("#"+this.display.getDomId(a)).val(m-l);$("#"+this.display.getDomId(g)).val(k-l);$("#"+this.display.getDomId(d)).val(m+l);if(this.display.submitSearchForm){this.display.submitSearchForm()}},areaLinkClick:function(){this.linkArea=!this.linkArea;var k=root+(this.linkArea?"/icons/link.png":"/icons/link_break.png");$("#"+this.display.getDomId(f)).attr("src",k);if(this.linkArea&&this.lastBounds){var h=this.lastBounds;$("#"+this.display.getDomId(b)).val(formatLocationValue(h.top));$("#"+this.display.getDomId(a)).val(formatLocationValue(h.left));$("#"+this.display.getDomId(g)).val(formatLocationValue(h.bottom));$("#"+this.display.getDomId(d)).val(formatLocationValue(h.right))}},linkArea:false,lastBounds:null,handleEventMapBoundsChanged:function(k,h){bounds=h.bounds;this.lastBounds=bounds;if(!h.force&&!this.linkArea){return}$("#"+this.display.getDomId(b)).val(formatLocationValue(bounds.top));$("#"+this.display.getDomId(a)).val(formatLocationValue(bounds.left));$("#"+this.display.getDomId(g)).val(formatLocationValue(bounds.bottom));$("#"+this.display.getDomId(d)).val(formatLocationValue(bounds.right))},setSearchSettings:function(h){var k=$("#"+this.display.getDomId(c));if(k.is(":checked")){h.setAreaContains(true)}else{h.setAreaContains(false)}h.setBounds(this.display.getFieldValue(this.display.getDomId(b),null),this.display.getFieldValue(this.display.getDomId(a),null),this.display.getFieldValue(this.display.getDomId(g),null),this.display.getFieldValue(this.display.getDomId(d),null))}})}function DateRangeWidget(c){var a="date_start";var b="date_end";RamaddaUtil.inherit(this,{display:c,initHtml:function(){this.display.jq(a).datepicker();this.display.jq(b).datepicker()},setSearchSettings:function(e){var f=this.display.jq(a).val();var d=this.display.jq(a).val();e.setDateRange(f,d)},getHtml:function(){var d=HtmlUtil.input(a,"",["placeholder","Start date",ATTR_ID,c.getDomId(a),"size","10"])+" - "+HtmlUtil.input(b,"",["placeholder","End date",ATTR_ID,c.getDomId(b),"size","10"]);return d}})}var ID_FIELDS="fields";var ID_HEADER="header";var ID_TITLE=ATTR_TITLE;var ID_TITLE_EDIT="title_edit";var ID_DETAILS="details";var ID_DISPLAY_CONTENTS="contents";var ID_GROUP_CONTENTS="group_contents";var ID_DETAILS_MAIN="detailsmain";var ID_TOOLBAR="toolbar";var ID_TOOLBAR_INNER="toolbarinner";var ID_LIST="list";var ID_DIALOG="dialog";var ID_DIALOG_TABS="dialog_tabs";var ID_DIALOG_BUTTON="dialog_button";var ID_FOOTER="footer";var ID_FOOTER_LEFT="footer_left";var ID_FOOTER_RIGHT="footer_right";var ID_MENU_BUTTON="menu_button";var ID_MENU_OUTER="menu_outer";var ID_MENU_INNER="menu_inner";var ID_REPOSITORY="repository";var displayDebug=false;var PROP_DISPLAY_FILTER="displayFilter";var PROP_EXCLUDE_ZERO="excludeZero";var PROP_DIVID="divid";var PROP_FIELDS="fields";var PROP_LAYOUT_HERE="layoutHere";var PROP_HEIGHT="height";var PROP_WIDTH="width";function addRamaddaDisplay(a){if(window.globalDisplays==null){window.globalDisplays={}}window.globalDisplays[a.getId()]=a;if(a.displayId){window.globalDisplays[a.displayId]=a}}function getRamaddaDisplay(a){if(window.globalDisplays==null){return null}return window.globalDisplays[a]}function removeRamaddaDisplay(b){var a=getRamaddaDisplay(b);if(a){a.removeDisplay()}}function DisplayThing(d,b){if(b==null){b={}}for(var c in b){if(typeof b[c]=="string"){if(b[c]=="true"){b[c]=true}else{if(b[c]=="false"){b[c]=false}}}}for(var g in b){var e=g.split(".");if(e.length<=1){continue}var a=b;var f=a;var h=b[g];if(h=="true"){h=true}else{if(h=="false"){h=false}}for(var c=0;c<e.length;c++){var k=e[c];if(c==e.length-1){a[k]=h;break}var l=a[k];if(l==null){a[k]={};a=a[k]}else{a=l}}}this.displayId=null;$.extend(this,b);RamaddaUtil.defineMembers(this,{objectId:d,properties:b,displayParent:null,getId:function(){return this.objectId},setId:function(m){this.objectId=m},getUniqueId:function(m){return HtmlUtil.getUniqueId(m)},handleError:function(n,m){GuiUtils.handleError("An error has occurred:"+m,true,true)},toString:function(){return"DisplayThing:"+this.getId()},getDomId:function(m){return this.getId()+"_"+m},jq:function(m){return $("#"+this.getDomId(m))},writeHtml:function(n,m){$("#"+this.getDomId(n)).html(m)},getRecordHtml:function(q,s){var z=false;if(Utils.isDefined(this.showGeo)){z=(""+this.showGeo)=="true"}var y="<table class=formtable>";if(false&&q.hasLocation()){var t=q.getLatitude();var m=q.getLongitude();y+="<tr><td align=right><b>Latitude:</b></td><td>"+number_format(t,4,".","")+"</td></tr>";y+="<tr><td align=right><b>Longitude:</b></td><td>"+number_format(m,4,".","")+"</td></tr>"}for(var n=0;n<2;n++){for(var p=0;p<q.getData().length;p++){var v=s[p];if(n==0&&!v.derived){continue}else{if(n==1&&v.derived){continue}}var u=v.getLabel();u=this.formatRecordLabel(u);if(!z){if(v.isFieldGeo()){continue}}var w=q.getValue(p);if(typeof w=="number"){var x=w+"";if(x.indexOf(".")>=0){var o=1;if(Math.abs(w)<1.5){o=3}w=number_format(w,o,".","")}}y+="<tr><td align=right><b>"+u+":</b></td><td>"+w+"</td></tr>"}}if(q.hasElevation()){y+="<tr><td  align=right><b>Elevation:</b></td><td>"+number_format(q.getElevation(),4,".","")+"</td></tr>"}y+="</table>";return y},formatRecordLabel:function(m){m=m.replace(/!!/g," -- ");return m},getFormValue:function(o,n){var m=$("#"+this.getDomId(o)).val();if(m!=null){if(m.length>0){this.setProperty(o,m)}if(m=="none"){this.setProperty(o,null)}return m}return this.getProperty(o,n)},getName:function(){return this.getFormValue("name",this.getId())},getEventSource:function(){return this.getFormValue("eventSource","")},setDisplayParent:function(m){this.displayParent=m},getDisplayParent:function(){if(this.displayParent==null){this.displayParent=this.getLayoutManager()}return this.displayParent},removeProperty:function(m){this.properties[m]=null},setProperty:function(m,n){this.properties[m]=n},getSelfProperty:function(m,n){if(this[m]!=null){return this[m]}return this.getProperty(m,n)},formatNumber:function(m){if(!this.getProperty("format",true)){return m}return Utils.formatNumber(m)},getProperty:function(m,o){var n=this.properties[m];if(n!=null){return n}if(this.displayParent!=null){return this.displayParent.getProperty(m,o)}if(this.getDisplayManager){return this.getDisplayManager().getProperty(m,o)}return o}})}function RamaddaDisplay(n,g,l,c){RamaddaUtil.initMembers(this,{orientation:"horizontal"});var f;RamaddaUtil.inherit(this,f=new DisplayThing(g,c));this.getSuper=function(){return f};if(this.derived){if(this.derived.indexOf("[")==0){this.derived=JSON.parse(this.derived)}else{this.derived=[JSON.parse(this.derived)]}for(var e=0;e<this.derived.length;e++){var k=this.derived[e];if(!Utils.isDefined(k.isRow)&&!Utils.isDefined(k.isColumn)){k.isRow=true;k.isColumn=false}if(!k.isRow&&!k.isColumn){k.isRow=true}}}else{}RamaddaUtil.defineMembers(this,{type:l,displayManager:n,filters:[],dataCollection:new DataCollection(),selectedCbx:[],entries:[],wikiAttrs:["title","showTitle","showDetails","minDate","maxDate"],getDisplayManager:function(){return this.displayManager},getLayoutManager:function(){return this.getDisplayManager().getLayoutManager()},notifyEvent:function(d,p,o){if(this[d]==null){return}this[d].apply(this,[p,o])},toString:function(){return"RamaddaDisplay:"+this.type+" - "+this.getId()},getType:function(){return this.type},getClass:function(d){if(d==null){return this.getBaseClass()}return this.getBaseClass()+"-"+d},getBaseClass:function(){return"display-"+this.getType()},setDisplayManager:function(d){this.displayManager=d;this.setDisplayParent(d.getLayoutManager())},setContents:function(d){d=HtmlUtil.div([ATTR_CLASS,"display-contents-inner display-"+this.getType()+"-inner"],d);this.writeHtml(ID_DISPLAY_CONTENTS,d)},addEntry:function(d){this.entries.push(d)},setEntry:function(d){this.entries=[];this.addEntry(d);this.entry=d;this.entryId=d.getId();if(this.properties.data){this.dataCollection=new DataCollection();this.properties.data=this.data=new PointData(d.getName(),null,null,this.getRamadda().getRoot()+"/entry/show?entryid="+d.getId()+"&output=points.product&product=points.json&numpoints=5000",{entryId:this.entryId});this.data.loadData(this)}this.updateUI();var o="";if(this.getShowTitle()){o=d.getName();console.log(o);o=HtmlUtil.href(this.getRamadda().getEntryUrl(this.entryId),o);this.jq(ID_TITLE).html(o)}},handleEventRecordSelection:function(t,o){if(!t.getEntries){return}var d=t.getEntries();for(var p=0;p<d.length;p++){var s=d[p];var q=this.getEntries().indexOf(s)>=0;if(q){this.highlightEntry(s);break}}},areaClear:function(){this.getDisplayManager().notifyEvent("handleEventAreaClear",this)},handleEventEntrySelection:function(p,d){var o=this.getEntries().indexOf(d.entry)>=0;if(!o){return}if(d.selected){$("#"+this.getDomId(ID_TITLE)).addClass("display-title-select")}else{$("#"+this.getDomId(ID_TITLE)).removeClass("display-title-select")}},highlightEntry:function(d){$("#"+this.getDomId(ID_TITLE)).addClass("display-title-select")},getEntries:function(){return this.entries},getDisplayEntry:function(){var d=this.getEntries();if(d!=null&&d.length>0){return d[0]}if(this.entryId){var o={call:function(p){console.log("got entry "+p)}};return this.getRamadda().getEntry(this.entryId,o)}return null},hasEntries:function(){return this.entries!=null&&this.entries.length>0},getWaitImage:function(){return HtmlUtil.image(ramaddaBaseUrl+"/icons/progress.gif")},getLoadingMessage:function(){return HtmlUtil.div(["text-align","center"],this.getMessage("&nbsp;Loading data..."))},getMessage:function(d){return HtmlUtil.div([ATTR_CLASS,"display-message"],d)},getFieldValue:function(p,d){var o=$("#"+p);if(o.size()>0){return o.val()}return d},getFooter:function(){return HtmlUtil.div([ATTR_ID,this.getDomId(ID_FOOTER),ATTR_CLASS,"display-footer"],HtmlUtil.leftRight(HtmlUtil.div([ATTR_ID,this.getDomId(ID_FOOTER_LEFT),ATTR_CLASS,"display-footer-left"],""),HtmlUtil.div([ATTR_ID,this.getDomId(ID_FOOTER_RIGHT),ATTR_CLASS,"display-footer-right"],"")))},checkFixedLayout:function(){if(this.getIsLayoutFixed()){var o=this.getProperty(PROP_DIVID);if(o!=null){var d=this.getHtml();$("#"+o).html(d)}}},shouldSkipField:function(d){if(this.skipFields&&!this.skipFieldsList){this.skipFieldsList=this.skipFields.split(",")}if(this.skipFieldsList){return this.skipFieldsList.indexOf(d.getId())>=0}return false},fieldSelected:function(o){this.userHasSelectedAField=true;this.selectedFields=null;this.overrideFields=null;this.removeProperty(PROP_FIELDS);this.fieldSelectionChanged();if(o.shiftKey){var d=this.getSelectedFields();this.getDisplayManager().handleEventFieldsSelected(this,d)}},addFieldsCheckboxes:function(D){if(!this.hasData()){return}var Q=this.getProperty(PROP_FIELDS);if(Q!=null){if(Q.length==0){Q=null}}var C="";var u=this.getId()+"_checkbox";var G=this.getId()+"_groupby";var z=this.dataCollection.getList();if(D!=null){this.overrideFields=[]}var x={};var O=this.getStandardData(null,{includeIndex:false});var L=this.dataCollection.getList()[0].getRecordFields();var K={};var w=null;for(var q=1;q<O.length;q++){var E=O[q];if(w==null){w=[];for(var s=0;s<E.length;s++){w.push(false)}}for(var s=0;s<E.length;s++){if(!w[s]){if(E[s]!=null){w[s]=true}}}}for(var s=0;s<E.length;s++){}for(var t=0;t<z.length;t++){var N=z[t];var I=this.getFieldsToSelect(N);if(this.canDoGroupBy()){var L=N.getRecordFields();var M=0;for(e=0;e<L.length;e++){var p=L[e];if(p.getType()!="string"){continue}if(M==0){C+=HtmlUtil.div([ATTR_CLASS,"display-dialog-subheader"],"Group By");C+=HtmlUtil.openTag(TAG_DIV,[ATTR_CLASS,"display-fields"]);var B=this.groupBy==null||this.groupBy=="";C+=HtmlUtil.tag(TAG_DIV,[ATTR_TITLE,"none"],HtmlUtil.radio("none",this.getDomId("groupby"),G,"none",!B)+" None")}M++;var B=this.groupBy==p.getId();var d="groupby_"+t+"_"+e;p.radioId=this.getDomId(d);C+=HtmlUtil.tag(TAG_DIV,[ATTR_TITLE,p.getId()],HtmlUtil.radio(p.radioId,this.getDomId("groupby"),G,p.getId(),B)+" "+p.getLabel()+" ("+p.getId()+")")}if(M>0){C+=HtmlUtil.closeTag(TAG_DIV)}}if(this.canDoMultiFields()&&I.length>0){var H=this.getSelectedFields([]);var v=[];for(e=0;e<H.length;e++){v.push(H[e].getId())}var P="";C+=HtmlUtil.div([ATTR_CLASS,"display-dialog-subheader"],"Displayed Fields");C+=HtmlUtil.openTag(TAG_DIV,[ATTR_CLASS,"display-fields"]);for(var s=0;s<I.length;s++){var p=I[s];var d="cbx_"+t+"_"+s;p.checkboxId=this.getDomId(d);var B=false;var F=(w?w[p.getIndex()]:true);if(D!=null){for(var o=0;o<D.length;o++){if(D[o].getId()==p.getId()){B=true;this.overrideFields.push(p.getId());break}}}else{if(Q!=null){B=(Q.indexOf(p.getId())>=0);if(!B){B=(Q.indexOf("#"+(s+1))>=0)}}else{if(this.overrideFields!=null){B=this.overrideFields.indexOf(p.getId())>=0;if(!B){B=(this.overrideFields.indexOf("#"+(s+1))>=0)}}else{if(v.length>0){B=v.indexOf(p.getId())>=0}else{if(this.selectedCbx.indexOf(p.getId())>=0){B=true}else{if(this.selectedCbx.length==0){B=(e==0)}}}}}}var y=p.getLabel();if(x[y]){if(Utils.stringDefined(p.getUnit())){y=y+" ("+p.getUnit()+")"}else{y=y+" "+x[y]}x[y]++}else{x[y]=1}if(!F){P+=HtmlUtil.div([],y)}else{if(p.derived){y+=" (derived)"}C+=HtmlUtil.tag(TAG_DIV,[ATTR_TITLE,p.getId()],HtmlUtil.checkbox(p.checkboxId,["class",u],B)+" "+y)}}}if(P!=""){C+=HtmlUtil.div(["style","border-top:1px #888  solid;"],"<b>No Data Available</b>"+P)}C+=HtmlUtil.closeTag(TAG_DIV)}this.writeHtml(ID_FIELDS,C);this.userHasSelectedAField=false;var J=this;$("."+u).click(function(R){J.fieldSelected(R)});$("."+G).change(function(R){J.groupBy=$(this).val();J.displayData()})},fieldSelectionChanged:function(){if(this.displayData){this.displayData()}},defaultSelectedToAll:function(){return false},setSelectedFields:function(d){this.selectedFields=d;this.addFieldsCheckboxes(d)},getSelectedFields:function(d){this.lastSelectedFields=this.getSelectedFieldsInner(d);return this.lastSelectedFields},getSelectedFieldsInner:function(v){if(this.selectedFields){return this.selectedFields}var z=[];var x=this.dataCollection.getList();var q=this.getProperty(PROP_FIELDS);if(q!=null){if(q.length==0){q=null}}for(var y=0;y<x.length;y++){var C=x[y];var w=this.getFieldsToSelect(C);if(q!=null){for(e=0;e<w.length;e++){var B=w[e];var o=B.getId();if(q.indexOf(o)>=0||q.indexOf("#"+(e+1))>=0){z.push(B)}}}}if(q!=null&&q.length>0){return z}var d=null;var u=null;this.selectedCbx=[];var t=false;for(var y=0;y<x.length;y++){var C=x[y];d=this.getFieldsToSelect(C);for(e=0;e<d.length;e++){var B=d[e];if(u==null&&B.isNumeric){u=B}var D="cbx_"+y+"_"+e;var p=this.getDomId(D);var s=$("#"+p);if(s.size()){t=true}if(s.is(":checked")){this.selectedCbx.push(B.getId());z.push(B)}}}if(z.length==0&&!t){if(this.lastSelectedFields&&this.lastSelectedFields.length>0){return this.lastSelectedFields}}if(z.length==0){return this.getDefaultSelectedFields(d,v)}return z},getDefaultSelectedFields:function(d,q){if(this.defaultSelectedToAll()&&this.allFields!=null){var o=[];for(e=0;e<this.allFields.length;e++){var p=this.allFields[e];if(!p.isFieldGeo()){o.push(p)}}return o}if(q!=null){return q}for(e=0;e<d.length;e++){var p=d[e];if(p.isNumeric&&!p.isFieldGeo()){return[p]}}return[]},canDoGroupBy:function(){return false},canDoMultiFields:function(){return true},getFieldsToSelect:function(d){return d.getChartableFields(this)},getGet:function(){return"getRamaddaDisplay('"+this.getId()+"')"},publish:function(v){if(v==null){v="wikipage"}var u=[];var o=prompt("Name","");if(o==null){return}u.push("name");u.push(o);u.push("type");u.push(v);var s="";var y="";if(v=="wikipage"){y+='+section label="{{name}}"\n${extra}\n'}else{if(v=="blogentry"){y="<wiki>\n"}}y+=s;y+=this.getWikiText();for(var p=0;p<this.displays.length;p++){var t=this.displays[p];if(t.getIsLayoutFixed()){continue}y+=t.getWikiText()}if(v=="wikipage"){y+="-section\n\n"}else{if(v=="blogentry"){}}var x="";var q=this.getChildEntries();for(var p=0;p<q.length;p++){var w=q[p];x+=w.getId()+","}if(q.length>0){u.push("entries");u.push(x)}if(v=="media_photoalbum"){y=""}u.push("description_encoded");u.push(window.btoa(y));var d=HtmlUtil.getUrl(ramaddaBaseUrl+"/entry/publish",u);window.open(d,"_blank")},getChildEntries:function(u){var o={};var s=[];for(var q=0;q<this.displays.length;q++){var t=this.displays[q];if(!u&&t.getIsLayoutFixed()){continue}if(t.getEntries){var d=t.getEntries();if(d){for(var p=0;p<d.length;p++){if(o[d[p].getId()]!=null){continue}o[d[p].getId()]=true;s.push(d[p])}}}}return s},copyDisplayedEntries:function(){var q=[];for(var p=0;p<this.displays.length;p++){var s=this.displays[p];if(s.getIsLayoutFixed()){continue}if(s.getEntries){var d=s.getEntries();if(d){for(var o=0;o<d.length;o++){q.push(d[o])}}}}return this.copyEntries(q)},defineWikiAttributes:function(o){for(var d=0;d<o.length;d++){if(this.wikiAttrs.indexOf(o[d])<0){this.wikiAttrs.push(o[d])}}},getWikiAttributes:function(o){for(var p=0;p<this.wikiAttrs.length;p++){var d=this[this.wikiAttrs[p]];if(Utils.isDefined(d)){o.push(this.wikiAttrs[p]);o.push(d)}}},getWikiText:function(){var p=["layoutHere","false","type",this.type,"column",this.getColumn(),"row",this.getRow()];this.getWikiAttributes(p);var q=null;if(this.getEntries){var d=this.getEntries();if(d&&d.length>0){q=d[0].getId()}}if(!q){q=this.entryId}if(q){p.push("entry");p.push(q)}var o="{{display "+HtmlUtil.attrs(p)+"}}\n\n";return o},copyEntries:function(d){var t=[];var o={};for(var s=0;s<d.length;s++){var u=d[s];if(o[u.getId()]!=null){continue}o[u.getId()]=u;t.push(u)}var v="";for(var q=0;q<t.length;q++){var u=t[q];v+=u.getId()+","}var p=ramaddaBaseUrl+"/entry/copy?action.force=copy&from="+v;window.open(p,"_blank")},entryHtmlHasBeenDisplayed:function(p){if(p.getIsGroup()){var o=this;var q=function(s){var t=HtmlUtil.openTag(TAG_OL,[ATTR_CLASS,"display-entrylist-list",ATTR_ID,o.getDomId(ID_LIST)]);t+=o.getEntriesTree(s);t+=HtmlUtil.closeTag(TAG_OL);o.jq(ID_GROUP_CONTENTS+p.getIdForDom()).html(t);o.addEntrySelect()};var d=p.getChildrenEntries(q)}},getEntryHtml:function(p,s){var w={showHeader:true,headerRight:false,showDetails:this.getShowDetails()};$.extend(w,s);s=w;var d=this.getEntryMenuButton(p);var y="";if(s.showHeader){var t=d+" "+p.getLink(p.getIconImage()+" "+p.getName());if(s.headerRight){y+=HtmlUtil.leftRight(t,s.headerRight)}else{y+=t}}var u=HtmlUtil.getUniqueId("entry_");y+=HtmlUtil.div(["id",u],"");if(false){var v=this.getRamadda().getRoot()+"/entry/show?entryid="+p.getId()+"&decorate=false&output=metadataxml&details=true";console.log(v);$("#"+u).load(v,function(){alert("Load was performed.")})}y+=p.getDescription();var z=p.getMetadata();if(p.isImage()){var G=HtmlUtil.tag(TAG_IMG,["src",p.getResourceUrl(),ATTR_CLASS,"display-entry-image"]);y+=HtmlUtil.href(p.getResourceUrl(),G)+"<br>"}else{for(var E=0;E<z.length;E++){if(z[E].type=="content.thumbnail"){var C=z[E].value.attr1;var v;if(C.indexOf("http")==0){v=C}else{v=ramaddaBaseUrl+"/metadata/view/"+C+"?element=1&entryid="+p.getId()+"&metadata.id="+z[E].id+"&thumbnail=false"}y+=HtmlUtil.image(v,[ATTR_CLASS,"display-entry-thumbnail"])}}}if(p.getIsGroup()){y+=HtmlUtil.div([ATTR_ID,this.getDomId(ID_GROUP_CONTENTS+p.getIdForDom())],"")}y+=HtmlUtil.formTable();if(s.showDetails){if(p.url){y+=HtmlUtil.formEntry("URL:",HtmlUtil.href(p.url,p.url))}if(p.remoteUrl){y+=HtmlUtil.formEntry("URL:",HtmlUtil.href(p.remoteUrl,p.remoteUrl))}if(p.remoteRepository){y+=HtmlUtil.formEntry("From:",HtmlUtil.href(p.remoteRepository.url,p.remoteRepository.name))}}var o=p.getAttributes();if(p.getFilesize()>0){y+=HtmlUtil.formEntry("File:",p.getFilename()+" "+HtmlUtil.href(p.getResourceUrl(),HtmlUtil.image(ramaddaBaseUrl+"/icons/download.png"))+" "+p.getFormattedFilesize())}for(var B=0;B<o.length;B++){var q=o[B];var x=q.value;if(q.getCanShow&&!q.getCanShow()){continue}if(Utils.isFalse(q.canshow)){continue}if(q.isUrl&&q.isUrl()){var F="";var D=x.split("\n");for(var E=0;E<D.length;E++){var v=D[E].trim();if(v.length==0){continue}F+=HtmlUtil.href(v,v);F+="<br>"}x=F}y+=HtmlUtil.formEntry(q.label+":",x)}y+=HtmlUtil.closeTag(TAG_TABLE);return y},getEntriesTree:function(J,w){if(!w){w={}}var d=this.getProperty("columns",null);if(d!=null){var u=this.getProperty("columnNames",null);if(u!=null){u=u.split(",")}d=d.split(",");var P=[];var K=[];for(var Q=0;Q<d.length;Q++){var N=d[Q].split(":");var L=null,U=null;if(N.length>1){if(N[0]=="property"){U="property";L=d[Q]}else{L=N[0];U=N[1]}}else{L=d[Q];U=L}P.push(L);K.push(U)}d=P;if(u==null){u=K}return this.getEntriesTable(J,d,u)}var s=w.suffix;var M="";if(!s){s="null"}else{M=s;s="'"+s+"'"}var R=w.showIndex;var G="";var O="entryrow_"+this.getId();var D=true;for(var Q=0;Q<J.length;Q++){D=!D;var p=J[Q];var H=this.makeEntryToolbar(p);var E=p.getDisplayName();if(E.length>100){E=E.substring(0,99)+"..."}var T=p.getIconImage([ATTR_TITLE,"View entry"]);var C=HtmlUtil.tag(TAG_A,[ATTR_HREF,p.getEntryUrl()],T+" "+E);E="";var z=p.getIdForDom()+M;var v=p.getId();var t=HtmlUtil.image(icon_tree_closed,[ATTR_BORDER,"0","tree-open","false",ATTR_ID,this.getDomId(ID_TREE_LINK+z)]);var B=this.getGet()+".toggleEntryDetails(event, '"+v+"',"+s+");";var y=this.getGet()+".entryHeaderClick(event, '"+v+"',"+s+"); ";var I=HtmlUtil.onClick(B,t);var o="";if(R){o="#"+(Q+1)+" "}var x=HtmlUtil.div([ATTR_CLASS,"display-entrylist-name"],I+" "+o+C+" "+E);var S=HtmlUtil.div([ATTR_ID,this.getDomId(ID_DETAILS+z),ATTR_CLASS,"display-entrylist-details"],HtmlUtil.div([ATTR_CLASS,"display-entrylist-details-inner",ATTR_ID,this.getDomId(ID_DETAILS_INNER+z)],""));var F;if(this.getProperty("showToolbar",true)){F=HtmlUtil.leftRight(x,H,"8","4")}else{F=x}var q=HtmlUtil.div(["onclick",y,ATTR_ID,this.getDomId(ID_DETAILS_MAIN+z),ATTR_CLASS,"display-entrylist-entry-main entry-main-display-entrylist-"+(D?"even":"odd"),ATTR_ENTRYID,v],F);var F=HtmlUtil.div([ATTR_ID,this.getDomId("entryinner_"+z)],q+S);G+=HtmlUtil.tag(TAG_DIV,[ATTR_ID,this.getDomId("entry_"+z),ATTR_ENTRYID,v,ATTR_CLASS,"display-entrylist-entry"+O],F);G+="\n"}return G},addEntrySelect:function(){var d=this;var o=$("#"+this.getDomId(ID_DISPLAY_CONTENTS)+"  ."+this.getClass("entry-main"));o.unbind();o.mouseover(function(v){if(true){return}var t=$(this).attr(ATTR_ENTRYID);var x=Utils.cleanId(t);var s=d.getEntryToolbarId(x);var u=$("#"+s);u.show();var p="right top+1";var q="right top";var w=d.getDomId(ID_DETAILS_MAIN+x);u.position({of:$("#"+w),my:p,at:q,collision:"none none"})});o.mouseout(function(t){var q=$(this).attr(ATTR_ENTRYID);var u=Utils.cleanId(q);var p=d.getEntryToolbarId(q);var s=$("#"+p)});if(this.madeList){}this.madeList=true;if(false){this.jq(ID_LIST).selectable({cancel:"a",selected:function(t,u){var p=u.selected.getAttribute(ATTR_ENTRYID);d.toggleEntryDetails(t,p);if(true){return}d.hideEntryDetails(p);var s=d.getEntry(p);if(s==null){return}var q=null;if(t.shiftKey){q={zoomIn:true}}d.selectedEntries.push(s);d.getDisplayManager().handleEventEntrySelection(d,{entry:s,selected:true,zoom:q});d.lastSelectedEntry=s},unselected:function(t,u){if(true){return}var q=u.unselected.getAttribute(ATTR_ENTRYID);var s=d.getEntry(q);var p=d.selectedEntries.indexOf(s);if(p>-1){d.selectedEntries.splice(p,1);d.getDisplayManager().handleEventEntrySelection(d,{entry:s,selected:false})}}})}},getEntriesTable:function(w,s,z){var d=this.getProperty("columnWidths",null);if(d!=null){d=d.split(",")}var v=HtmlUtil.openTag(TAG_TABLE,[ATTR_WIDTH,"100%","cellpadding","0","cellspacing","0"]);v+=HtmlUtil.openTag(TAG_TR,["valign","top"]);for(var u=0;u<z.length;u++){v+=HtmlUtil.td([ATTR_ALIGN,"center",ATTR_CLASS,"display-entrytable-header"],z[u])}v+=HtmlUtil.closeTag(TAG_TR);for(var u=0;u<w.length;u++){v+=HtmlUtil.openTag(TAG_TR,["valign","top"]);var C=w[u];for(var t=0;t<s.length;t++){var o=null;if(d!=null){o=d[t]}var q=s[t];var B="";if(q=="name"){B=HtmlUtil.tag(TAG_A,[ATTR_HREF,C.getEntryUrl()],C.getName())}else{if(q.match(".*property:.*")){var x=q.substring("property:".length);var y=C.getMetadata();B="";for(var t=0;t<y.length;t++){var p=y[t];if(p.type==x){if(B!=""){B+="<br>"}B+=p.value.attr1}}}else{if(q=="description"){B=C.getDescription()}else{if(q=="date"){B=C.ymd;if(B==null){B=C.startDate}}else{B=C.getAttributeValue(q)}}}}var D=[ATTR_CLASS,"display-entrytable-cell"];if(o!=null){D.push(ATTR_WIDTH);D.push(o)}v+=HtmlUtil.td(D,B)}v+=HtmlUtil.closeTag(TAG_TR)}v+=HtmlUtil.closeTag(TAG_TABLE);return v},makeEntryToolbar:function(u){var o=this.getGet();var v=[];if(u.getType().getId()=="type_wms_layer"){v.push(HtmlUtil.tag(TAG_A,["onclick",o+".addMapLayer("+HtmlUtil.sqt(u.getId())+");"],HtmlUtil.image(ramaddaBaseUrl+"/icons/map.png",["border",0,ATTR_TITLE,"Add Map Layer"])))}if(u.getType().getId()=="geo_shapefile"){v.push(HtmlUtil.tag(TAG_A,["onclick",o+".addMapLayer("+HtmlUtil.sqt(u.getId())+");"],HtmlUtil.image(ramaddaBaseUrl+"/icons/map.png",["border",0,ATTR_TITLE,"Add Map Layer"])))}var t=this.getPointUrl(u);if(t!=null){v.push(HtmlUtil.tag(TAG_A,["onclick",o+".createDisplay("+HtmlUtil.sqt(u.getFullId())+","+HtmlUtil.sqt("table")+","+HtmlUtil.sqt(t)+");"],HtmlUtil.image(ramaddaBaseUrl+"/icons/table.png",["border",0,ATTR_TITLE,"Create Tabular Display"])));var d;v.push(d=HtmlUtil.tag(TAG_A,["onclick",o+".createDisplay("+HtmlUtil.sqt(u.getFullId())+","+HtmlUtil.sqt("linechart")+","+HtmlUtil.sqt(t)+");"],HtmlUtil.image(ramaddaBaseUrl+"/icons/chart_line_add.png",["border",0,ATTR_TITLE,"Create Chart"])))}v.push(HtmlUtil.tag(TAG_A,["onclick",o+".createDisplay("+HtmlUtil.sqt(u.getFullId())+","+HtmlUtil.sqt("entrydisplay")+","+HtmlUtil.sqt(t)+");"],HtmlUtil.image(ramaddaBaseUrl+"/icons/layout_add.png",["border",0,ATTR_TITLE,"Show Entry"])));if(u.getFilesize()>0){v.push(HtmlUtil.tag(TAG_A,[ATTR_HREF,u.getResourceUrl()],HtmlUtil.image(ramaddaBaseUrl+"/icons/download.png",["border",0,ATTR_TITLE,"Download ("+u.getFormattedFilesize()+")"])))}var s=this.getEntryMenuButton(u);v.push(s);var q=[];for(var p=0;p<v.length;p++){q.push(HtmlUtil.div([ATTR_CLASS,"display-entry-toolbar-item"],v[p]))}v=q;return HtmlUtil.div([ATTR_CLASS,"display-entry-toolbar",ATTR_ID,this.getEntryToolbarId(u.getIdForDom())],HtmlUtil.join(v,""))},getEntryToolbarId:function(d){var o=d.replace(/:/g,"_");o=o.replace(/=/g,"_");return this.getDomId(ID_TOOLBAR+"_"+o)},hideEntryDetails:function(d){},entryHeaderClick:function(o,d,q){var p=o.target;if(p.outerHTML){if(p.outerHTML.indexOf("<div")!=0){return}}this.toggleEntryDetails(o,d)},toggleEntryDetails:function(o,q,C){var y=this.getEntry(q);if(C==null){C=""}var x=this.jq(ID_TREE_LINK+y.getIdForDom()+C);var p=ID_DETAILS+y.getIdForDom()+C;var d=this.jq(p);var v=this.jq(ID_DETAILS_INNER+y.getIdForDom()+C);if(o&&o.shiftKey){var p=Utils.cleanId(q);var D=this.jq(ID_DETAILS_MAIN+p);if(!this.selectedEntriesFromTree){this.selectedEntriesFromTree={}}var s=D.attr("ramadda-selected")=="true";if(s){D.removeClass("display-entrylist-entry-main-selected");D.attr("ramadda-selected","false");this.selectedEntriesFromTree[y.getId()]=null}else{D.addClass("display-entrylist-entry-main-selected");D.attr("ramadda-selected","true");this.selectedEntriesFromTree[y.getId()]=y}this.getDisplayManager().handleEventEntrySelection(this,{entry:y,selected:!s});return}var u=x.attr("tree-open")=="true";if(u){x.attr("src",icon_tree_closed)}else{x.attr("src",icon_tree_open)}x.attr("tree-open",u?"false":"true");var w=d.attr("has-content")!=null;d.attr("has-content","true");if(w){}else{if(y.getIsGroup()){v.html(HtmlUtil.image(icon_progress));var B=this;var z=function(E){B.displayChildren(y,E,C)};var t=y.getChildrenEntries(z)}else{v.html(this.getEntryHtml(y,{showHeader:false}))}}if(u){d.hide()}else{d.show()}if(o&&o.stopPropagation){o.stopPropagation()}},getSelectedEntriesFromTree:function(){var d=[];if(this.selectedEntriesFromTree){for(var p in this.selectedEntriesFromTree){var o=this.selectedEntriesFromTree[p];if(o!=null){d.push(o)}}}return d},displayChildren:function(s,d,t){if(!t){t=""}var o=this.jq(ID_DETAILS_INNER+s.getIdForDom()+t);var p=this.getEntryHtml(s,{showHeader:false});if(d.length==0){o.html(p)}else{var q="";if(this.showDetailsForGroup){q+=p}q+=this.getEntriesTree(d);o.html(q);this.addEntrySelect()}},getEntryMenuButton:function(o){var d=HtmlUtil.onClick(this.getGet()+".showEntryMenu(event, '"+o.getId()+"');",HtmlUtil.image(ramaddaBaseUrl+"/icons/menu.png",[ATTR_CLASS,"display-entry-toolbar-item",ATTR_ID,this.getDomId(ID_MENU_BUTTON+o.getIdForDom())]));return d},setRamadda:function(d){this.ramadda=d},getRamadda:function(){if(this.ramadda!=null){return this.ramadda}if(this.ramaddaBaseUrl!=null){this.ramadda=getRamadda(this.ramaddaBaseUrl);return this.ramadda}return getGlobalRamadda()},getEntry:function(d,s){var p=this.getRamadda();var q=d.split(",");if(q.length==2){d=q[1];p=getRamadda(q[0])}var o=null;if(this.entryList!=null){o=this.entryList.getEntry(d)}if(o==null){o=p.getEntry(d)}if(o==null){console.log("Display.getEntry: entry not found id="+d+" repository="+p.getRoot());o=this.getRamadda().getEntry(d,s)}return o},addMapLayer:function(d){var o=this.getEntry(d);if(o==null){console.log("No entry:"+d);return}this.getDisplayManager().addMapLayer(this,o)},createDisplay:function(q,d,p){var s=this.getEntry(q);console.log("createDisplay: "+q+" "+d+" "+p);if(s==null){console.log("No entry:"+q);return null}var o={showMenu:true,sourceEntry:s,entryId:s.getId(),showTitle:true,showDetails:true,title:s.getName()};if(d!=DISPLAY_ENTRYLIST){if(p==null){p=this.getPointUrl(s)}var t={entry:s,entryId:s.getId()};o.data=new PointData(s.getName(),null,null,p,t)}if(this.lastDisplay!=null){o.column=this.lastDisplay.getColumn();o.row=this.lastDisplay.getRow()}else{o.column=this.getProperty("newColumn",this.getColumn());o.row=this.getProperty("newRow",this.getRow())}this.lastDisplay=this.getDisplayManager().createDisplay(d,o)},getPointUrl:function(o){var d=o.getService("points.json");if(d!=null){return d.url}d=o.getService("grid.point.json");if(d!=null){return d.url}return null},getEntryMenu:function(q){var z=this.getEntry(q);if(z==null){return"null entry"}var p=this.getGet();var s=[];var t=[];var x=[];var d=[];x.push(HtmlUtil.tag(TAG_LI,[],HtmlUtil.tag(TAG_A,["href",z.getEntryUrl(),"target","_"],"View Entry")));if(z.getFilesize()>0){t.push(HtmlUtil.tag(TAG_LI,[],HtmlUtil.tag(TAG_A,["href",z.getResourceUrl()],"Download "+z.getFilename()+" ("+z.getFormattedFilesize()+")")))}if(this.jsonUrl!=null){t.push(HtmlUtil.tag(TAG_LI,[],"Data: "+HtmlUtil.onClick(p+".fetchUrl('json');","JSON")+HtmlUtil.onClick(p+".fetchUrl('csv');","CSV")))}d.push(HtmlUtil.tag(TAG_LI,[],HtmlUtil.onClick(p+".createDisplay('"+z.getFullId()+"','entrydisplay');","New Entry Display")));var w=this.getPointUrl(z);console.log("entry:"+z.getName()+" url:"+w);if(w!=null){var y="";for(var u=0;u<this.getDisplayManager().displayTypes.length;u++){var v=this.getDisplayManager().displayTypes[u];if(!v.requiresData||!v.forUser){continue}d.push(HtmlUtil.tag(TAG_LI,[],HtmlUtil.tag(TAG_A,["onclick",p+".createDisplay("+HtmlUtil.sqt(z.getFullId())+","+HtmlUtil.sqt(v.type)+","+HtmlUtil.sqt(w)+");"],v.label)))}}if(t.length>0){s.push("<a>File</a>"+HtmlUtil.tag(TAG_UL,[],HtmlUtil.join(t)))}if(x.length>0){s.push("<a>View</a>"+HtmlUtil.tag(TAG_UL,[],HtmlUtil.join(x)))}if(d.length>0){s.push("<a>New</a>"+HtmlUtil.tag(TAG_UL,[],HtmlUtil.join(d)))}var B="";for(var u=0;u<s.length;u++){B+=HtmlUtil.tag(TAG_LI,[],s[u])}var o=HtmlUtil.tag(TAG_UL,[ATTR_ID,this.getDomId(ID_MENU_INNER+z.getIdForDom()),ATTR_CLASS,"sf-menu"],B);return o},showEntryMenu:function(o,d){var q=this.getEntryMenu(d);this.writeHtml(ID_MENU_OUTER,q);var p=this.getDomId(ID_MENU_BUTTON+Utils.cleanId(d));showPopup(o,p,this.getDomId(ID_MENU_OUTER),false,"right top","left bottom+9");$("#"+this.getDomId(ID_MENU_INNER+Utils.cleanId(d))).superfish({speed:"fast",delay:300})},fetchUrl:function(d,o){if(o==null){o=this.jsonUrl}o=this.getDisplayManager().getJsonUrl(o,this);if(o==null){return}if(d!=null&&d!="json"){o=o.replace("points.json","points."+d)}window.open(o,"_blank")},getMenuItems:function(d){},getDisplayMenuSettings:function(){var p="getRamaddaDisplay('"+this.getId()+"')";var s=HtmlUtil.onClick(p+".moveDisplayRight();","Right");var t=HtmlUtil.onClick(p+".moveDisplayLeft();","Left");var o=HtmlUtil.onClick(p+".moveDisplayTop();","Top");var d=HtmlUtil.onClick(p+".moveDisplayUp();","Up");var v=HtmlUtil.onClick(p+".moveDisplayDown();","Down");var u="<table class=formtable><tr><td align=right><b>Move:</b></td><td>"+o+" "+d+" "+v+" "+s+" "+t+"</td></tr><tr><td align=right><b>Row:</b></td><td> "+HtmlUtil.input("",this.getProperty("row",""),["size","7",ATTR_ID,this.getDomId("row")])+" &nbsp;&nbsp;<b>Col:</b> "+HtmlUtil.input("",this.getProperty("column",""),["size","7",ATTR_ID,this.getDomId("column")])+"</td></tr><tr><td align=right><b>Width:</b></td><td> "+HtmlUtil.input("",this.getProperty("width",""),["size","7",ATTR_ID,this.getDomId("width")])+"  <b>Height:</b> "+HtmlUtil.input("",this.getProperty("height",""),["size","7",ATTR_ID,this.getDomId("height")])+"</td></tr></table>";var q=HtmlUtil.checkbox(this.getDomId("showtitle"),[],this.showTitle)+" Title  "+HtmlUtil.checkbox(this.getDomId("showdetails"),[],this.showDetails)+" Details &nbsp;&nbsp;&nbsp;"+HtmlUtil.onClick(p+".askSetTitle();","Set Title");u+=HtmlUtil.formTable()+HtmlUtil.formEntry("Show:",q)+"</table>";return u},isLayoutHorizontal:function(){return this.orientation=="horizontal"},loadInitialData:function(){if(!this.needsData()||this.properties.data==null){return}if(this.properties.data.hasData()){this.addData(this.properties.data);return}this.properties.data.derived=this.derived;this.properties.data.loadData(this)},getData:function(){if(!this.hasData()){return null}var d=this.dataCollection.getList();return d[0]},hasData:function(){if(this.dataCollection==null){return false}return this.dataCollection.hasData()},getCreatedInteractively:function(){return this.createdInteractively==true},needsData:function(){return false},getShowMenu:function(){if(Utils.isDefined(this.showMenu)){return this.showMenu}return this.getProperty(PROP_SHOW_MENU,true)},askSetTitle:function(){var o=this.getTitle(false);var d=prompt("Title",o);if(d!=null){this.title=d;this.setProperty(ATTR_TITLE,d);this.setDisplayTitle(this.title)}},getShowDetails:function(){return this.getSelfProperty("showDetails",true)},setShowDetails:function(d){this.showDetails=d;if(this.showDetails){this.jq(ID_DETAILS).show()}else{this.jq(ID_DETAILS).hide()}},setShowTitle:function(d){this.showTitle=d;if(this.showTitle){this.jq(ID_TITLE).show()}else{this.jq(ID_TITLE).hide()}},getShowTitle:function(){return this.getSelfProperty("showTitle",true)},setDisplayProperty:function(d,o){this.setProperty(d,o);$("#"+this.getDomId(d)).val(o)},deltaColumn:function(o){var d=parseInt(this.getProperty("column",0));d+=o;if(d<0){d=0}this.setDisplayProperty("column",d);this.getLayoutManager().layoutChanged(this)},deltaRow:function(o){var d=parseInt(this.getProperty("row",0));d+=o;if(d<0){d=0}this.setDisplayProperty("row",d);this.getLayoutManager().layoutChanged(this)},moveDisplayRight:function(){if(this.getLayoutManager().isLayoutColumns()){this.deltaColumn(1)}else{this.getLayoutManager().moveDisplayDown(this)}},moveDisplayLeft:function(){if(this.getLayoutManager().isLayoutColumns()){this.deltaColumn(-1)}else{this.getLayoutManager().moveDisplayUp(this)}},moveDisplayUp:function(){if(this.getLayoutManager().isLayoutRows()){this.deltaRow(-1)}else{this.getLayoutManager().moveDisplayUp(this)}},moveDisplayDown:function(){if(this.getLayoutManager().isLayoutRows()){this.deltaRow(1)}else{this.getLayoutManager().moveDisplayDown(this)}},moveDisplayTop:function(){this.getLayoutManager().moveDisplayTop(this)},getDialogContents:function(o,t){var d=this.getGet();var q=[];this.getMenuItems(q);var s="<form>";s+=this.getDisplayMenuSettings();for(var p=0;p<q.length;p++){s+=HtmlUtil.div([ATTR_CLASS,"display-menu-item"],q[p])}s+="</form>";o.push("Display");t.push(s)},popup:function(t,q){var o=GuiUtils.getDomObject(q);var p=GuiUtils.getDomObject(t);if(!o||!p){return}var d="right top";var s="right bottom";showObject(o);jQuery("#"+q).position({of:jQuery("#"+t),my:d,at:s,collision:"none none"});jQuery("#"+q).position({of:jQuery("#"+t),my:d,at:s,collision:"none none"});$("#"+q).draggable()},initUI:function(){this.checkFixedLayout()},initDisplay:function(){this.initUI();this.setContents("<p>default html<p>")},updateUI:function(d){},getDoBs:function(){if(!(typeof this.dobs==="undefined")){return dobs}if(this.displayParent){return this.displayParent.getDoBs()}return false},cnt:0,getHtml:function(){var x=this.getDoBs();var t="";var d=this.getWidth();if(x){t+=HtmlUtil.openDiv(["class","minitron"])}if(d>0){t+=HtmlUtil.openDiv(["class","display-contents","style","width:"+d+";"])}else{t+=HtmlUtil.openDiv(["class","display-contents"])}t+=HtmlUtil.div([ATTR_CLASS,"ramadda-popup",ATTR_ID,this.getDomId(ID_MENU_OUTER)],"");var o=HtmlUtil.div([ATTR_CLASS,"display-dialog",ATTR_ID,this.getDomId(ID_DIALOG)],"");var q=this.getGet();var u="";if(this.getShowMenu()){u=HtmlUtil.onClick(q+".showDialog();",HtmlUtil.image(ramaddaBaseUrl+"/icons/downdart.png",[ATTR_CLASS,"display-dialog-button",ATTR_ID,this.getDomId(ID_DIALOG_BUTTON)]))}var w="";if(this.getShowTitle()){w=this.getTitle(false).trim()}if(u!=""||w!=""){this.cnt++;var p="";var v=w;if(w!=""&&this.entryId){v=HtmlUtil.href(this.getRamadda().getEntryUrl(this.entryId),w)}p=HtmlUtil.tag("div",[ATTR_CLASS,"display-title",ATTR_ID,this.getDomId(ID_TITLE)],v);if(u==""){t+=p}else{t+="<table class=display-header-table cellspacing=0 cellpadding=0 width=100%><tr><td>"+p+"</td><td align=right>"+u+"</td></tr></table>"}}var s=this.getContentsDiv();t+=s;t+=o;t+=HtmlUtil.closeTag(TAG_DIV);if(x){t+=HtmlUtil.closeTag(TAG_DIV)}return t},makeToolbar:function(s){var u="";var o=this.getGet();var d=s.addLabel;var t=[];var w=[];var q=[];if(!this.getIsLayoutFixed()){w.push("removeRamaddaDisplay('"+this.getId()+"')");t.push(ramaddaBaseUrl+"/icons/page_delete.png");q.push("Delete display")}w.push(o+".copyDisplay();");t.push(ramaddaBaseUrl+"/icons/page_copy.png");q.push("Copy Display");if(this.jsonUrl!=null){w.push(o+".fetchUrl('json');");t.push(ramaddaBaseUrl+"/icons/json.png");q.push("Download JSON");w.push(o+".fetchUrl('csv');");t.push(ramaddaBaseUrl+"/icons/csv.png");q.push("Download CSV")}for(var p=0;p<w.length;p++){var v=HtmlUtil.image(t[p],[ATTR_TITLE,q[p],ATTR_CLASS,"display-dialog-header-icon"]);if(d){v+=" "+q[p]+"<br>"}u+=HtmlUtil.onClick(w[p],v)}return u},makeDialog:function(){var t="";t+=HtmlUtil.div([ATTR_ID,this.getDomId(ID_HEADER),ATTR_CLASS,"display-header"]);var y=HtmlUtil.onClick("$('#"+this.getDomId(ID_DIALOG)+"').hide();",HtmlUtil.image(ramaddaBaseUrl+"/icons/close.gif",[ATTR_CLASS,"display-dialog-close",ATTR_TITLE,"Close Dialog"]));var x=y;var p="";var s=HtmlUtil.div([ATTR_CLASS,"display-dialog-header"],HtmlUtil.leftRight(p,x));var v=[];var z=[];this.getDialogContents(v,z);v.push("Edit");z.push(this.makeToolbar({addLabel:true}));var u="<ul>";var w="";for(var q=0;q<v.length;q++){var d=this.getDomId("tabs")+q;u+=HtmlUtil.tag("li",[],HtmlUtil.tag("a",["href","#"+d],v[q]));u+="\n";var o=HtmlUtil.div([ATTR_CLASS,"display-dialog-tab"],z[q]);w+=HtmlUtil.div(["id",d],o);w+="\n"}u+="</ul>\n";var w=HtmlUtil.div(["id",this.getDomId(ID_DIALOG_TABS)],u+w);dialogContents=s+w;return dialogContents},initDialog:function(){var o=this;var d=function(p){if(p&&p.which!=13){return}o.column=o.jq("column").val();o.row=o.jq("row").val();o.getLayoutManager().doLayout()};this.jq("column").keypress(d);this.jq("row").keypress(d);this.jq("showtitle").change(function(){o.setShowTitle(o.jq("showtitle").is(":checked"))});this.jq("showdetails").change(function(){o.setShowDetails(o.jq("showdetails").is(":checked"))});this.jq(ID_DIALOG_TABS).tabs()},showDialog:function(){var d=this.getDomId(ID_DIALOG);this.writeHtml(ID_DIALOG,this.makeDialog());this.popup(this.getDomId(ID_DIALOG_BUTTON),d);this.initDialog()},getContentsDiv:function(){var p="";var o=this.getWidth();if(o>0){p+="width:"+o+"px; /*overflow-x: auto;*/"}var d=this.getProperty("height",-1);if(d>0){p+=" height:"+d+"px;  max-height:"+d+"px; /*overflow-y: auto;*/"}return HtmlUtil.div([ATTR_CLASS,"display-contents-inner display-"+this.type,"style",p,ATTR_ID,this.getDomId(ID_DISPLAY_CONTENTS)],"")},copyDisplay:function(){var d={};$.extend(true,d,this);d.setId(d.getId()+this.getUniqueId("display"));addRamaddaDisplay(d);this.getDisplayManager().addDisplay(d)},removeDisplay:function(){this.getDisplayManager().removeDisplay(this)},prepareToLayout:function(){this.getColumn();this.getWidth();this.getHeight();this.getName();this.getEventSource()},getColumn:function(){return this.getFormValue("column",0)},getRow:function(){return this.getFormValue("row",0)},getWidth:function(){return this.getFormValue("width",0)},getHeight:function(){return this.getFormValue("height",0)},setDisplayTitle:function(o){var d=o;if(this.entryId){d=HtmlUtil.href(this.getRamadda().getEntryUrl(this.entryId),o)}if(this.getShowTitle()){this.jq(ID_TITLE).show()}else{this.jq(ID_TITLE).hide()}this.writeHtml(ID_TITLE,d)},getTitle:function(o){var q="";if(o&&this.hasEntries()){q=this.getEntryMenuButton(this.getEntries()[0])+" "}var t=this.getProperty(ATTR_TITLE);if(t!=null){return q+t}if(this.dataCollection==null){return q}var p=this.dataCollection.getList();t="";for(var s=0;s<p.length;s++){var d=p[s];if(s>0){t+="/"}t+=d.getName()}return q+t},getIsLayoutFixed:function(){return this.getProperty(PROP_LAYOUT_HERE,false)},doingQuickEntrySearch:false,doQuickEntrySearch:function(s,v){if(this.doingQuickEntrySearch){return}var t=s.term;if(t==null||t.length<=1){return}this.doingQuickEntrySearch=true;var d=new EntrySearchSettings({name:t,max:10});if(this.searchSettings){d.clearAndAddType(this.searchSettings.entryType)}var o=this;var q=this.getRamadda().getSearchUrl(d,OUTPUT_JSON);var p={entryListChanged:function(w){o.doneQuickEntrySearch(w,v)}};var u=new EntryList(this.getRamadda(),q,p,true)},doneQuickEntrySearch:function(s,q){var p=[];var d=s.getEntries();for(var o=0;o<d.length;o++){p.push(d[o].getName())}q(p);this.doingQuickEntrySearch=false},addData:function(d){var o=d.getRecords();if(o&&o.length>0){this.hasElevation=o[0].hasElevation()}else{this.hasElevation=false}this.dataCollection.addData(d);var p=d.entry;if(p==null){p=this.getRamadda().getEntry(d.entryId)}if(p){d.entry=p;this.addEntry(p)}},pointDataLoadFailed:function(d){this.inError=true;errorMessage=this.getProperty("errorMessage",null);if(errorMessage!=null){this.setContents(errorMessage);return}var o="";if(d&&d.errorcode&&d.errorcode=="warning"){o=d.error}else{o="<b>Sorry, but an error has occurred:</b>";if(!d){d="No data returned from server"}o+=HtmlUtil.tag("div",["style","background:#fff;margin:10px;padding:10px;border:1px #ccc solid;   border-radius: 0px;"],(d.error?d.error:d))}this.setContents(this.getMessage(o))},pointDataLoaded:function(d,o,p){if(!p){this.addData(d)}this.updateUI(d);if(!p){this.lastPointData=d;this.getDisplayManager().handleEventPointDataLoaded(this,d)}if(o!=null){this.jsonUrl=o}else{this.jsonUrl=null}},getDateFormatter:function(){var d=null;if(this.googleLoaded()){var o=this.getProperty("dateFormat",null);if(o){var p=0;this.timezone=this.getProperty("timezone");if(Utils.isDefined(this.timezone)){p=parseFloat(this.timezone)}d=new google.visualization.DateFormat({pattern:o,timeZone:p})}}return d},getHasDate:function(o){var q=null;this.hasDate=false;for(j=0;j<o.length;j++){var d=o[j];var p=d.getDate();if(p==null){continue}if(q!=null&&q.getTime()!=p.getTime()){this.hasDate=true;break}q=p}return this.hasDate},dateInRange:function(d){if(d!=null){if(this.minDateObj!=null&&d.getTime()<minDate){return false}if(this.maxDateObj!=null&&d.getTime()>maxDate){return false}}return true},getStandardData:function(o,K){var I=this.dataCollection.getList()[0];var W=this.getProperty(PROP_EXCLUDE_ZERO,false);if(o==null){o=I.getRecordFields()}if(K==null){K={includeIndex:true,includeIndexIfDate:false,groupByIndex:-1,raw:false}}var ad=K.groupByIndex;var O=[];var R=[];var E=[];for(aa=0;aa<o.length;aa++){var v=o[aa];if(v.isFieldNumeric()&&v.isFieldDate()){}var B=v.getLabel();if(v.getUnit()!=null){B+=" ("+v.getUnit()+")"}B=B.replace(/!!/g," -- ");E.push(B)}R.push(E);O.push("");this.minDateObj=Utils.parseDate(this.minDate,false);this.maxDateObj=Utils.parseDate(this.maxDate,true,this.minDateObj);if(this.minDateObj==null&&this.maxDateObj!=null){this.minDateObj=Utils.parseDate(this.minDate,false,this.maxDateObj)}var u=(this.minDateObj!=null?this.minDateObj.getTime():-1);var z=(this.maxDateObj!=null?this.maxDateObj.getTime():-1);if(this.minDateObj!=null||this.maxDateObj!=null){console.log("dates: "+this.minDateObj+" "+this.maxDateObj)}var T=0;if(Utils.isDefined(this.offset)){T=parseFloat(this.offset)}var Z=0;var P=this.indexField;var X=I.getRecords();var L=I.getRecordFields();this.hasDate=this.getHasDate(X);var F=this.getDateFormatter();var G=-1;for(Y=0;Y<X.length;Y++){var S=X[Y];var ac=S.getDate();if(!this.dateInRange(ac)){continue}G++;var af=[];if(K&&(K.includeIndex||K.includeIndexIfDate)){var p=null;if(P>=0){var v=L[P];af.push(S.getValue(P)+T);p=v.getLabel()}else{if(this.hasDate){af.push(this.getDateValue(ac,F));p="Date"}else{if(!K.includeIndexIfDate){af.push(Y);p="Index"}}}if(p!=null&&G==0){E.unshift(p)}}var J=true;var C=true;var Q=false;for(var aa=0;aa<o.length;aa++){var v=o[aa];if(v.isFieldNumeric()&&v.isFieldDate()){}var U=S.getValue(v.getIndex());if(T!=0){U+=T}if(U!=null){J=false}if(typeof U=="number"){Q=true;if(U!=0){C=false}}if(v.isFieldDate()){U=this.getDateValue(U,F)}af.push(U)}if(Q&&C&&W){continue}if(this.filters!=null){if(!this.applyFilters(S,af)){console.log(" skipping due to filters");continue}}if(ad>=0){O.push(S.getValue(ad))}R.push(af);if(!J){Z++}}if(Z==0){return[]}if(ad>=0){var w={};var x=[];var t=[];var N=[];N.push(K.groupByField.getLabel());for(var Y=0;Y<o.length;Y++){var v=o[Y];if(v.getIndex()==ad){continue}N.push(v.getLabel())}t.push(N);for(var aa=0;aa<R.length;aa++){var ae=R[aa];if(aa==0){continue}var ag=O[aa];var H=false;var d=w[ag];if(d==null){x.push(ag);d=new Array();t.push(d);d.push(ag);for(var Y=0;Y<ae.length;Y++){var v=o[Y];if(v.getIndex()==ad){continue}d.push(0)}w[ag]=d}else{}var M=0;for(var Y=0;Y<ae.length;Y++){var v=o[Y];if(v.getIndex()==ad){continue}var q=ae[Y];M++;if(Utils.isNumber(q)){if(typeof d[M]=="string"){d[M]=0}d[M]+=parseFloat(q)}else{if(d[M]==0){d[M]=""}var V=d[M];if(!Utils.isDefined(V)){V=""}if(V.length<150){if(!Utils.isDefined(q)){q=""}var y=(""+q);if(V.indexOf(y)<0){if(V!=""){V+=", "}V+=y;d[M]=V}}}}}for(var Y=0;Y<t.length;Y++){var D=t[Y];var V=null;for(var ab=0;ab<D.length;ab++){if(V){V+=","}V+=D[ab]}}return t}return R},googleLoaded:function(){if((typeof google==="undefined")||(typeof google.visualization==="undefined")||(typeof google.visualization.DateFormat==="undefined")){return false}return true},initDateFormats:function(){if(!this.googleLoaded()){return false}if(this.fmt_yyyy){return true}var d=0;this.timezone=this.getProperty("timezone");if(Utils.isDefined(this.timezone)){d=parseFloat(this.timezone)}this.fmt_yyyymmddhhmm=new google.visualization.DateFormat({pattern:"yyyy-MM-dd HH:mm'Z'",timeZone:d});this.fmt_yyyymmdd=new google.visualization.DateFormat({pattern:"yyyy-MM-dd",timeZone:d});this.fmt_yyyy=new google.visualization.DateFormat({pattern:"yyyy",timeZone:d});return true},getDateValue:function(d,o){if(!this.initDateFormats()){return d}date=new Date(d);if(!o){o=this.fmt_yyyymmddhhmm}var p=o.formatValue(date);date={v:date,f:p};return date},applyFilters:function(d,o){for(var p=0;p<this.filters.length;p++){if(!this.filters[p].recordOk(this,d,o)){return false}}return true}});var a=this.getProperty(PROP_DISPLAY_FILTER);if(a!=null){var b=a.split(";");for(var e=0;e<b.length;e++){a=b[e];var h=a.split(":");var m=h[0];if(m=="month"){this.filters.push(new MonthFilter(h[1]))}else{console.log("unknown filter:"+m)}}}}function DisplayGroup(b,f,c){var g=TAG_TABLE;var e="tabs";var d="columns";var h="rows";var a;RamaddaUtil.inherit(this,a=new RamaddaDisplay(b,f,"group",c));RamaddaUtil.defineMembers(this,{layout:this.getProperty(PROP_LAYOUT_TYPE,g)});RamaddaUtil.defineMembers(this,{displays:[],layout:this.getProperty(PROP_LAYOUT_TYPE,g),columns:this.getProperty(PROP_LAYOUT_COLUMNS,1),isLayoutColumns:function(){return this.layout==d},getDoBs:function(){return this.dobs},getWikiText:function(){var l=["layoutType",this.layout,"layoutColumns",this.columns,"showMenu","false","divid","$entryid_maindiv"];var k="";k+='<div id="{{entryid}}_maindiv"></div>\n\n';k+="{{group "+HtmlUtil.attrs(l)+"}}\n\n";return k},walkTree:function(l,m){for(var k=0;k<this.displays.length;k++){var n=this.displays[k];if(n.walkTree!=null){n.walkTree(l,m)}else{l.call(m,n)}}},collectEntries:function(k){if(k==null){k=[]}for(var l=0;l<this.displays.length;l++){var n=this.displays[l];if(n.collectEntries!=null){n.collectEntries(k)}else{var m=n.getEntries();if(m!=null&&m.length>0){k.push({source:n,entries:m})}}}return k},isLayoutRows:function(){return this.layout==h},getPosition:function(){for(var k=0;k<this.displays.length;k++){var l=this.displays[k];if(l.getPosition){return l.getPosition()}}},getDisplays:function(){return this.display},notifyEvent:function(m,p,o){var k=this.getDisplays();for(var l=0;l<this.displays.length;l++){var q=this.displays[l];if(q==p){continue}var n=q.getEventSource();if(n!=null&&n.length>0){if(n!=p.getId()&&n!=p.getName()){continue}}q.notifyEvent(m,p,o)}},getDisplaysToLayout:function(){var k=[];for(var l=0;l<this.displays.length;l++){if(this.displays[l].getIsLayoutFixed()){continue}k.push(this.displays[l])}return k},addDisplay:function(k){this.displays.push(k);this.doLayout()},layoutChanged:function(k){this.doLayout()},removeDisplay:function(l){var k=this.displays.indexOf(l);if(k>=0){this.displays.splice(k,1)}this.doLayout()},doLayout:function(){var u="";var x=100;var H=this.getDisplaysToLayout();var m=this.displays;for(var D=0;D<m.length;D++){var z=m[D];if(z.prepareToLayout!=null){z.prepareToLayout()}}var p=0;var F=null;if(typeof this.weights!="undefined"){F=this.weights.split(",")}if(this.layout==g){if(H.length==1){u+=HtmlUtil.div(["class"," display-wrapper"],H[0].getHtml())}else{var v=12/this.columns;var D=0;var I={};for(;D<H.length;D++){var G=H[D];if(Utils.isDefined(G.column)&&Utils.isDefined(G.row)&&G.columns>=0&&G.row>=0){var L=G.column+"_"+G.row;if(I[L]==null){I[L]=[]}I[L].push(G)}}D=0;for(;D<H.length;D++){x++;if(x>=this.columns){if(D>0){u+=HtmlUtil.closeTag(TAG_DIV)}u+=HtmlUtil.openTag("div",["class","row"]);x=0}var J=v;if(F!=null){if(p>=F.length){p=0}J=F[p];p++}u+=HtmlUtil.div(["class","col-md-"+J+" display-wrapper display-cell"],H[D].getHtml())}if(D>0){u+=HtmlUtil.closeTag(TAG_DIV)}}}else{if(this.layout==e){var K=HtmlUtil.getUniqueId("tabs_");u+=HtmlUtil.openTag(TAG_DIV,["id",K,"class","ui-tabs"]);u+=HtmlUtil.openTag(TAG_UL,[]);var C="";var B=0;for(var D=0;D<H.length;D++){var z=H[D];var q=z.getTitle(false);if(q.length>20){q=q.substring(0,19)+"..."}u+=HtmlUtil.tag(TAG_LI,[],HtmlUtil.tag(TAG_A,["href","#"+K+"-"+B],q));C+=HtmlUtil.div(["id",K+"-"+B,"class","ui-tabs-hide"],z.getHtml());B++}u+=HtmlUtil.closeTag(TAG_UL);u+=C;u+=HtmlUtil.closeTag(TAG_DIV)}else{if(this.layout==h){var s=[];for(var D=0;D<H.length;D++){var z=H[D];var o=z.getRow();if((""+o).length==0){o=0}while(s.length<=o){s.push([])}s[o].push(z.getHtml())}for(var D=0;D<s.length;D++){var t=s[D];var w=Math.round(100/t.length)+"%";u+=HtmlUtil.openTag(TAG_TABLE,["border","0","width","100%","cellpadding","0","cellspacing","0"]);u+=HtmlUtil.openTag(TAG_TR,["valign","top"]);for(var n=0;n<t.length;n++){var k=t[n];k=HtmlUtil.div(["class","display-cell"],k);u+=HtmlUtil.tag(TAG_TD,["width",w],k)}u+=HtmlUtil.closeTag(TAG_TR);u+=HtmlUtil.closeTag(TAG_TABLE)}}else{if(this.layout==d){var t=[];for(var D=0;D<H.length;D++){var z=H[D];var l=z.getColumn();if((""+l).length==0){l=0}while(t.length<=l){t.push([])}t[l].push(z.getHtml())}u+=HtmlUtil.openTag(TAG_DIV,["class","row"]);var w=Math.round(100/t.length)+"%";var v=12/t.length;for(var D=0;D<t.length;D++){var s=t[D];var E="";for(var y=0;y<s.length;y++){E+=s[y]}var J=v;if(F!=null){if(p>=F.length){p=0}J=F[p];p++}u+=HtmlUtil.div(["class","col-md-"+J],E)}u+=HtmlUtil.closeTag(TAG_DIV)}else{u+="Unknown layout:"+this.layout}}}}this.writeHtml(ID_DISPLAYS,u);if(this.layout==e){$("#"+K).tabs({})}this.initDisplay()},initDisplay:function(){for(var k=0;k<this.displays.length;k++){this.displays[k].initDisplay()}},setLayout:function(l,k){this.layout=l;if(k){this.columns=k}this.doLayout()},askMinZAxis:function(){var k=prompt("Minimum axis value","0");if(k!=null){k=parseFloat(k);for(var l=0;l<this.displays.length;l++){var m=this.displays[l];if(m.setMinZAxis){m.setMinZAxis(k)}}}},askMaxZAxis:function(){var k=prompt("Maximum axis value","0");if(k!=null){k=parseFloat(k);for(var l=0;l<this.displays.length;l++){var m=this.displays[l];if(m.setMaxZAxis){m.setMaxZAxis(k)}}}},askMinDate:function(){var m=this.minDate;if(!m){m="1950-0-0"}this.minDate=prompt("Minimum date",m);if(this.minDate!=null){for(var k=0;k<this.displays.length;k++){var l=this.displays[k];if(l.setMinDate){l.setMinDate(this.minDate)}}}},askMaxDate:function(){var m=this.maxDate;if(!m){m="2020-0-0"}this.maxDate=prompt("Maximum date",m);if(this.maxDate!=null){for(var k=0;k<this.displays.length;k++){var l=this.displays[k];if(l.setMaxDate){l.setMaxDate(this.maxDate)}}}},titlesOff:function(){for(var k=0;k<this.displays.length;k++){this.displays[k].setShowTitle(false)}},titlesOn:function(){for(var k=0;k<this.displays.length;k++){this.displays[k].setShowTitle(true)}},detailsOff:function(){for(var k=0;k<this.displays.length;k++){this.displays[k].setShowDetails(false)}this.doLayout()},detailsOn:function(){for(var k=0;k<this.displays.length;k++){this.displays[k].setShowDetails(true)}this.doLayout()},deleteAllDisplays:function(){this.displays=[];this.doLayout()},moveDisplayUp:function(l){var k=this.displays.indexOf(l);if(k<=0){return}this.displays.splice(k,1);this.displays.splice(k-1,0,l);this.doLayout()},moveDisplayDown:function(l){var k=this.displays.indexOf(l);if(k>=this.displays.length){return}this.displays.splice(k,1);this.displays.splice(k+1,0,l);this.doLayout()},moveDisplayTop:function(l){var k=this.displays.indexOf(l);if(k>=this.displays.length){return}this.displays.splice(k,1);this.displays.splice(0,0,l);this.doLayout()}})}var pointDataCache={};function DataCollection(){RamaddaUtil.defineMembers(this,{data:[],hasData:function(){for(var a=0;a<this.data.length;a++){if(this.data[a].hasData()){return true}}return false},getList:function(){return this.data},addData:function(a){this.data.push(a)},handleEventMapClick:function(d,b,e,c){for(var a=0;a<this.data.length;a++){this.data[a].handleEventMapClick(d,b,e,c)}}})}function BasePointData(a,b){if(b==null){b={}}RamaddaUtil.defineMembers(this,{recordFields:null,records:null,entryId:null,entry:null});$.extend(this,b);RamaddaUtil.defineMembers(this,{name:a,properties:b,initWith:function(c){this.recordFields=c.recordFields;this.records=c.records},handleEventMapClick:function(e,c,f,d){},hasData:function(){return this.records!=null},clear:function(){this.records=null;this.recordFields=null},getProperties:function(){return this.properties},getProperty:function(c,e){var d=this.properties[c];if(d==null){return e}return d},getRecordFields:function(){return this.recordFields},addRecordField:function(c){this.recordFields.push(c)},getRecords:function(){return this.records},getNumericFields:function(){var d=this.getRecordFields();var c=[];for(var e=0;e<d.length;e++){var f=d[e];if(f.isNumeric){c.push(f)}}return c},getChartableFields:function(k){var e=this.getRecordFields();var d=[];var g=/(TIME|HOUR|MINUTE|SECOND|YEAR|MONTH|DAY|LATITUDE|LONGITUDE|^ELEVATION$)/g;var g=/(xxxnoskip)/g;for(var f=0;f<e.length;f++){var h=e[f];if(!h.isNumeric||!h.isChartable()){continue}var c=h.getId().toUpperCase();if(c.match(g)){continue}d.push(h)}return RecordUtil.sort(d)},getNonGeoFields:function(g){var d=this.getRecordFields();var c=[];for(var e=0;e<d.length;e++){var f=d[e];if(f.isFieldGeo()){continue}c.push(f)}return c},loadData:function(c){},getName:function(){return this.name},getTitle:function(){if(this.records!=null&&this.records.length>0){return this.name+" - "+this.records.length+" points"}return this.name}})}function PointData(d,c,a,b,e){RamaddaUtil.inherit(this,new BasePointData(d,e));RamaddaUtil.defineMembers(this,{recordFields:c,records:a,url:b,loadingCnt:0,equals:function(f){return this.url==f.url},getIsLoading:function(){return this.loadingCnt>0},handleEventMapClick:function(h,f,k,g){this.lon=k;this.lat=g;if(h.getDisplayManager().hasGeoMacro(this.url)){this.loadData(h,true)}},startLoading:function(){this.loadingCnt++},stopLoading:function(){this.loadingCnt--},loadData:function(k,h){if(this.url==null){console.log("No URL");return}var g={lat:this.lat,lon:this.lon};var f=k.displayManager.getJsonUrl(this.url,k,g);this.loadPointJson(f,k,h)},loadPointJson:function(g,l,h){var f=this;this.startLoading();var n=this;var k=pointDataCache[g];if(k==null){k={pointData:null,pending:[]};pointDataCache[g]=k}if(k.pointData!=null){l.pointDataLoaded(k.pointData,g,h);return}k.pending.push(l);if(k.pending.length>1){return}console.log("loadPointJson:"+g);var m=$.getJSON(g,function(s){if(GuiUtils.isJsonError(s)){l.pointDataLoadFailed(s);return}var q=makePointData(s,n.derived,l);k.pointData=f.initWith(q);var p=k.pending;k.pending=[];for(var o=0;o<p.length;o++){p[o].pointDataLoaded(f,g,h)}f.stopLoading()}).fail(function(q,s,o){var p=s+": "+o;console.log("JSON error:"+p);l.pointDataLoadFailed(p);f.stopLoading()})}})}function DerivedPointData(d,c,b,a){RamaddaUtil.inherit(this,new BasePointData(c));RamaddaUtil.defineMembers(this,{displayManager:d,operation:a,pointDataList:b,loadDataCalls:0,display:null,pointDataLoaded:function(e){this.loadDataCalls--;if(this.loadDataCalls<=0){this.initData()}},equals:function(f){if(f.pointDataList==null){return false}if(this.pointDataList.length!=f.pointDataList.length){return false}for(var e in this.pointDataList){if(!this.pointDataList[e].equals(f.pointDataList[e])){return false}}return true},initData:function(){var e=this.pointDataList[0];if(this.pointDataList.length==1){this.records=e.getRecords();this.recordFields=e.getRecordFields()}else{if(this.pointDataList.length>1){var f=this.combineData(e,this.pointDataList[1]);this.records=f.records;this.recordFields=f.recordFields}}this.display.pointDataLoaded(this)},combineData:function(n,m){var s=n.getRecords();var p=m.getRecords();var k=[];var t;if(s.length!=p.length){console.log("bad records:"+s.length+" "+p.length)}if(this.operation=="average"){for(var q=0;q<s.length;q++){var f=s[q];var e=p[q];if(f.getDate()!=e.getDate()){console.log("Bad record date:"+f.getDate()+" "+e.getDate());break}var o=$.extend(true,{},f);var h=o.getData();var g=e.getData();for(var l=0;l<h.length;l++){h[l]=(h[l]+g[l])/2}k.push(o)}t=n.getRecordFields()}else{if(this.operation=="other func"){}}if(t==null){k=s;t=n.getRecordFields()}return{records:k,recordFields:t}},loadData:function(g){this.display=g;this.loadDataCalls=0;for(var f in this.pointDataList){var e=this.pointDataList[f];if(!e.hasData()){this.loadDataCalls++;e.loadData(this)}if(this.loadDataCalls==0){this.initData()}}}})}function RecordField(a){$.extend(this,{isDate:a.type=="date",isLatitude:false,isLongitude:false,isElevation:false});$.extend(this,a);$.extend(this,{isNumeric:a.type=="double"||a.type=="integer",properties:a});RamaddaUtil.defineMembers(this,{getIndex:function(){return this.index},isFieldGeo:function(){return this.isFieldLatitude()||this.isFieldLongitude()||this.isFieldElevation()},isFieldLatitude:function(){return this.isLatitude||this.id.toLowerCase()=="latitude"},isFieldLongitude:function(){return this.isLongitude||this.id.toLowerCase()=="longitude"},isFieldElevation:function(){return this.isElevation||this.id.toLowerCase()=="elevation"||this.id.toLowerCase()=="altitude"},isFieldNumeric:function(){return this.isNumeric},isFieldDate:function(){return this.isDate},isChartable:function(){return this.chartable},getSortOrder:function(){return this.sortorder},getId:function(){return this.id},getLabel:function(){if(this.label==null||this.label.length==0){return this.id}return this.label},setLabel:function(b){this.label=b},getType:function(){return this.type},getMissing:function(){return this.missing},setUnit:function(b){this.unit=b},getUnit:function(){return this.unit}})}function PointRecord(d,e,a,c,b){RamaddaUtil.defineMembers(this,{latitude:d,longitude:e,elevation:a,recordTime:c,data:b,getData:function(){return this.data},allZeros:function(){var f=this.getData();var h=false;var l=0;var k=0;for(var g=0;g<f.length;g++){if(typeof f[g]=="number"){l++;if(!isNaN(f[g])&&f[g]!=0){k++;break}}}if(l>0&&k==0){return true}return false},getValue:function(f){return this.data[f]},push:function(f){this.data.push(f)},hasLocation:function(){return !isNaN(this.latitude)},hasElevation:function(){return !isNaN(this.elevation)},getLatitude:function(){return this.latitude},getLongitude:function(){return this.longitude},getTime:function(){return this.time},getElevation:function(){return this.elevation},getDate:function(){return this.recordTime}})}function makePointData(Q,D,y){var b=[];var t=-1;var c=-1;var q=-1;var H=-1;var J=null;for(var T=0;T<Q.fields.length;T++){var n=Q.fields[T];var z=new RecordField(n);J=z;b.push(z);if(z.isFieldLatitude()){t=z.getIndex()}else{if(z.isFieldLongitude()){c=z.getIndex()}else{if(z.isFieldElevation()){q=z.getIndex()}else{if(z.isFieldDate()){H=z.getIndex()}}}}}if(!D){D=[]}if(D){var E=J.getIndex()+1;for(var I=0;I<D.length;I++){var Y=D[I];var R=Y.label;if(!R){R=Y.name}var z=new RecordField({type:"double",index:(E+I),chartable:true,id:Y.name,label:R});z.derived=Y;b.push(z)}}var s=[];var V=[];for(var T=0;T<Q.data.length;T++){var a=Q.data[T];var aa=a.values;var U=null;if((typeof a.date==="undefined")){if(H>=0){U=new Date(aa[H])}}else{if(a.date!=null&&a.date!=0){U=new Date(a.date)}}if((typeof a.latitude==="undefined")){if(t>=0){a.latitude=aa[t]}else{a.latitude=NaN}}if((typeof a.longitude==="undefined")){if(c>=0){a.longitude=aa[c]}else{a.longitude=NaN}}if((typeof a.elevation==="undefined")){if(q>=0){a.elevation=aa[q]}else{a.elevation=NaN}}if(D){for(var I=0;I<D.length;I++){var Y=D[I];if(!Y.isRow){continue}if(!Y.compiledFunction){var w=[];var g=(Y.columns.indexOf(";")>=0?Y.columns.split(";"):Y.columns.split(","));Y.fieldsToUse=[];for(var T=0;T<g.length;T++){var m=g[T].trim();w.push("v"+(T+1));var x=null;for(var B=0;B<b.length;B++){var W=b[B];if(W.getId()==m){x=W;break}}Y.fieldsToUse.push(x)}var h="";for(var T=0;T<w.length;T++){h+="var v"+(T+1)+"=args["+T+"];\n"}var P=Y["function"];if(P.indexOf("return")<0){P="return "+P}h+=P+"\n";Y.compiledFunction=new Function("args",h)}var O=[];var S=false;for(var B=0;B<Y.fieldsToUse.length;B++){var W=Y.fieldsToUse[B];var M=NaN;if(W!=null){M=aa[W.getIndex()];if(M==null){M=NaN}}if(!isNaN(M)){S=true}else{}O.push(M)}try{var u=NaN;if(S){u=Y.compiledFunction(O);if(Y.decimals>=0){u=u.toFixed(Y.decimals)}u=parseFloat(u)}else{}aa.push(u)}catch(X){console.log("Error evaluating function:"+Y["function"]+"\n"+X);aa.push(NaN)}}}V.push(aa);var L=new PointRecord(a.latitude,a.longitude,a.elevation,U,aa);s.push(L)}for(var I=0;I<D.length;I++){var Y=D[I];if(!Y.isColumn){continue}var W=Y["function"];var w=[];var g=Y.columns.split(",");for(var T=0;T<g.length;T++){var E=-1;for(var B=0;B<b.length;B++){var W=b[B];if(W.getId()==g[T]||W.getLabel()==g[T]){E=W.getIndex();console.log("index:"+E+" f:"+W.getId());break}}if(E<0){console.log("Could not find column index for field: "+g[T]);continue}w.push("c"+(T+1))}var C=RecordUtil.slice(V,E);var o=new Function(w,Y["function"]);console.log("daFunk - "+o);var G=o(C);console.log("got new:"+G+" "+(typeof G));if((typeof G)=="number"){for(var Z=0;Z<s.length;Z++){var L=s[Z];L.push(G)}}else{if(Utils.isDefined(G.length)){console.log("newData.length:"+G.length+" records.length:"+s.length);for(var Z=0;Z<G.length;Z++){var L=s[Z];if(!L){console.log("bad record: "+Z);L.push(NaN)}else{var M=G[Z];if(Y.decimals>=0){M=parseFloat(M.toFixed(Y.decimals))}L.push(M)}}}}}if(y!=null){for(var T=0;T<b.length;T++){var n=b[T];var K="field."+n.getId()+".";if(Utils.isDefined(y[K+"unit"])){n.setUnit(y[K+"unit"])}if(Utils.isDefined(y[K+"label"])){n.setLabel(y[K+"label"])}if(Utils.isDefined(y[K+"scale"])||Utils.isDefined(y[K+"offset1"])||Utils.isDefined(y[K+"offset2"])){var l=Utils.isDefined(y[K+"offset1"])?parseFloat(y[K+"offset1"]):0;var k=Utils.isDefined(y[K+"offset2"])?parseFloat(y[K+"offset2"]):0;var F=Utils.isDefined(y[K+"scale"])?parseFloat(y[K+"scale"]):1;var E=n.getIndex();for(var Z=0;Z<s.length;Z++){var L=s[Z];var aa=L.getData();var N=aa[E];aa[E]=(N+l)*F+k}}}}var p=Q.name;if((typeof p==="undefined")){p="Point Data"}return new PointData(p,b,s)}function makeTestPointData(){var a={fields:[{index:0,id:"field1",label:"Field 1",type:"double",missing:"-999.0",unit:"m"},{index:1,id:"field2",label:"Field 2",type:"double",missing:"-999.0",unit:"c"}],data:[[-64.77,-64.06,45,null,[8,1000]],[-65.77,-64.06,45,null,[9,500]],[-65.77,-64.06,45,null,[10,250]]]};return makePointData(a)}function RecordFilter(a){if(a==null){a={}}RamaddaUtil.defineMembers(this,{properties:a,recordOk:function(d,b,c){return true}})}function MonthFilter(a){RamaddaUtil.inherit(this,new RecordFilter());RamaddaUtil.defineMembers(this,{months:a.split(","),recordOk:function(f,b,c){for(i in this.months){var e=this.months[i];var d=b.getDate();if(d==null){return false}if(d.getMonth==null){return false}if(d.getMonth()==e){return true}}return false}})}var A={add:function(b,a){if(isNaN(b)||isNaN(a)){return NaN}return b+a},average:function(a){var c=0;if(a.length==0){return 0}for(var b=0;b<a.length;b++){c+=a[b]}return c/a.length},percentIncrease:function(c){var a=[];var f=0;if(c.length==0){return 0}var d;for(var e=0;e<c.length;e++){var b=c[e];var g=NaN;if(e>0&&d!=0){g=(b-d)/d}d=b;a.push(g*100)}return a},movingAverage:function(h,e){if(!e){e={}}if(!e.step){e.step=5}var k=[];console.log("STEP:"+e.step);for(var d=e.step;d<h.length;d++){var f=0;var a=0;for(var c=d-e.step;c<d;c++){if(h[c]==h[c]){f+=h[c];a++}}var g=(a>0?f/a:NaN);if(k.length==0){for(var b=0;b<e.step;b++){k.push(g)}}k.push(g)}console.log("MovingAverage: values:"+h.length+" new:"+k.length);return k},expMovingAverage:function(k,f){if(!f){f={}}if(!f.step){f.step=5}var l=A.movingAverage(k,f);var d=(2/(f.step+1));var m=[];console.log("STEP:"+f.step);for(var e=f.step;e<k.length;e++){var g=0;var a=0;for(var c=e-f.step;c<e;c++){if(k[c]==k[c]){g+=k[c];a++}}var h=(a>0?g/a:NaN);if(m.length==0){for(var b=0;b<f.step;b++){m.push(h)}}m.push(h)}console.log("MovingAverage: values:"+k.length+" new:"+m.length);return m},max:function(b){var a=NaN;for(var c=0;c<b.length;c++){if(c==0||b[c]>a){a=b[c]}}return a},min:function(a){var c=NaN;for(var b=0;b<a.length;b++){if(b==0||a[b]<c){c=a[b]}}return c}};var RecordUtil={getRanges:function(f,d){var g=[];var b=[];for(var e=0;e<f.length;e++){g.push(NaN);b.push(NaN)}for(var k=0;k<d.length;k++){for(var c=0;c<f.length;c++){var h=d[k].getValue(c);if(isNaN(h)){continue}g[c]=(isNaN(g[c])?h:Math.max(h,g[c]));b[c]=(isNaN(b[c])?h:Math.min(h,b[c]))}}var a=[];for(var c=0;c<f.length;c++){a.push([b[c],g[c]])}return a},getElevationRange:function(a,b){var e=NaN;var d=NaN;for(var f=0;f<b.length;f++){if(b[f].hasElevation()){var c=b[f].getElevation();e=(isNaN(e)?c:Math.max(c,e));d=(isNaN(d)?c:Math.min(c,d))}}return[d,e]},slice:function(b,c){var a=[];for(var d=0;d<b.length;d++){var e=b[d];if(e.getValue){a.push(e.getValue(c))}else{a.push(e[c])}}return a},sort:function(a){a=a.slice(0);a.sort(function(d,c){var f=d.getSortOrder();var e=c.getSortOrder();return f<e});return a},getPoints:function(c,g){var f=[];var h=NaN,b=NaN,e=NaN,d=NaN;if(c!=null){for(j=0;j<c.length;j++){var a=c[j];if(!isNaN(a.getLatitude())&&!isNaN(a.getLongitude())){if(j==0){h=a.getLatitude();e=a.getLatitude();b=a.getLongitude();d=a.getLongitude()}else{h=Math.max(h,a.getLatitude());e=Math.min(e,a.getLatitude());b=Math.min(b,a.getLongitude());d=Math.max(d,a.getLongitude())}f.push(new OpenLayers.Geometry.Point(a.getLongitude(),a.getLatitude()))}}}g[0]=h;g[1]=b;g[2]=e;g[3]=d;return f},findClosest:function(d,b,g,k){if(d==null){return null}var c=null;var h=1000000000;var f=-1;for(j=0;j<d.length;j++){var e=d[j];if(isNaN(e.getLatitude())){continue}var a=Math.sqrt((b-e.getLongitude())*(b-e.getLongitude())+(g-e.getLatitude())*(g-e.getLatitude()));if(a<h){h=a;c=e;f=j}}if(k!=null){k.index=f}return c},clonePoints:function(d){var b=[];for(var c=0;c<d.length;c++){var a=d[c];b.push(new OpenLayers.Geometry.Point(a.x,a.y))}return b}};var DISPLAY_FILTER="filter";var DISPLAY_ANIMATION="animation";var DISPLAY_LABEL="label";var DISPLAY_SHELL="shell";addGlobalDisplayType({type:DISPLAY_FILTER,label:"Filter",requiresData:false,category:"Controls"});addGlobalDisplayType({type:DISPLAY_ANIMATION,label:"Animation",requiresData:false,category:"Controls"});addGlobalDisplayType({type:DISPLAY_LABEL,label:"Text",requiresData:false,category:"Misc"});addGlobalDisplayType({type:DISPLAY_SHELL,label:"Analysis Shell",requiresData:false,category:"Misc"});function RamaddaFilterDisplay(c,b,a){RamaddaUtil.inherit(this,new RamaddaDisplay(c,b,a));addRamaddaDisplay(this);RamaddaUtil.defineMembers(this,{html:"<p>&nbsp;&nbsp;&nbsp;Nothing selected&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<p>",initDisplay:function(){this.initUI();this.setContents(this.html)}})}function RamaddaAnimationDisplay(f,e,c){var b="start";var a="stop";var d="time";RamaddaUtil.inherit(this,new RamaddaDisplay(f,e,DISPLAY_ANIMATION,c));addRamaddaDisplay(this);RamaddaUtil.defineMembers(this,{running:false,timestamp:0,index:0,sleepTime:500,iconStart:ramaddaBaseUrl+"/icons/display/control.png",iconStop:ramaddaBaseUrl+"/icons/display/control-stop-square.png",iconBack:ramaddaBaseUrl+"/icons/display/control-stop-180.png",iconForward:ramaddaBaseUrl+"/icons/display/control-stop.png",iconFaster:ramaddaBaseUrl+"/icons/display/plus.png",iconSlower:ramaddaBaseUrl+"/icons/display/minus.png",iconBegin:ramaddaBaseUrl+"/icons/display/control-double-180.png",iconEnd:ramaddaBaseUrl+"/icons/display/control-double.png",deltaIndex:function(g){this.stop();this.setIndex(this.index+g)},setIndex:function(g){if(g<0){g=0}this.index=g;this.applyStep()},toggle:function(){if(this.running){this.stop()}else{this.start()}},tick:function(){if(!this.running){return}this.index++;this.applyStep();var g=this;setTimeout(function(){g.tick()},this.sleepTime)},applyStep:function(){var l=this.displayManager.getDefaultData();if(l==null){return}var h=l.getRecords();if(h==null){$("#"+this.getDomId(d)).html("no records");return}if(this.index>=h.length){this.index=h.length-1}var g=h[this.index];var k="";if(g.getDate()!=null){k+=HtmlUtil.b("Date:")+" "+g.getDate()}else{k+=HtmlUtil.b("Index:")+" "+this.index}$("#"+this.getDomId(d)).html(k);this.displayManager.handleEventRecordSelection(this,null,this.index)},faster:function(){this.sleepTime=this.sleepTime/2;if(this.sleepTime==0){this.sleepTime=100}},slower:function(){this.sleepTime=this.sleepTime*1.5},start:function(){if(this.running){return}this.running=true;this.timestamp++;$("#"+this.getDomId(b)).attr("src",this.iconStop);this.tick()},stop:function(){if(!this.running){return}this.running=false;this.timestamp++;$("#"+this.getDomId(b)).attr("src",this.iconStart)},initDisplay:function(){this.initUI();this.stop();var g=this.getGet();var h="";h+=HtmlUtil.onClick(g+".setIndex(0);",HtmlUtil.image(this.iconBegin,[ATTR_TITLE,"beginning",ATTR_CLASS,"display-animation-button","xwidth","32"]));h+="  ";h+=HtmlUtil.onClick(g+".deltaIndex(-1);",HtmlUtil.image(this.iconBack,[ATTR_TITLE,"back 1",ATTR_CLASS,"display-animation-button","xwidth","32"]));h+="  ";h+=HtmlUtil.onClick(g+".toggle();",HtmlUtil.image(this.iconStart,[ATTR_TITLE,"play/stop",ATTR_CLASS,"display-animation-button","xwidth","32",ATTR_ID,this.getDomId(b)]));h+="  ";h+=HtmlUtil.onClick(g+".deltaIndex(1);",HtmlUtil.image(this.iconForward,[ATTR_TITLE,"forward 1",ATTR_CLASS,"display-animation-button","xwidth","32"]));h+="  ";h+=HtmlUtil.onClick(g+".faster();",HtmlUtil.image(this.iconFaster,[ATTR_CLASS,"display-animation-button",ATTR_TITLE,"faster","xwidth","32"]));h+="  ";h+=HtmlUtil.onClick(g+".slower();",HtmlUtil.image(this.iconSlower,[ATTR_CLASS,"display-animation-button",ATTR_TITLE,"slower","xwidth","32"]));h+=HtmlUtil.div([ATTR_ID,this.getDomId(d)],"&nbsp;");this.setDisplayTitle("Animation");this.setContents(h)}})}function RamaddaLabelDisplay(f,e,b){var d="text";var c="edit";var a;if(b&&!Utils.isDefined(b.showTitle)){b.showTitle=false}RamaddaUtil.inherit(this,a=new RamaddaDisplay(f,e,DISPLAY_LABEL,b));addRamaddaDisplay(this);this.text="";this.editMode=b.editMode;if(b.text){this.text=b.text}else{if(b.label){this.text=b.label}else{if(b.html){this.text=b.html}else{if(b.title){this.text=b.title}}}}if(b["class"]){this["class"]=b["class"]}else{this["class"]="display-text"}RamaddaUtil.defineMembers(this,{initDisplay:function(){var k=this;this.initUI();var g=this["class"];if(this.editMode){g+=" display-text-edit "}var l=HtmlUtil.div([ATTR_CLASS,g,ATTR_ID,this.getDomId(d)],this.text);if(this.editMode){l+=HtmlUtil.textarea(c,this.text,["rows",5,"cols",120,ATTR_SIZE,"120",ATTR_CLASS,"display-text-input",ATTR_ID,this.getDomId(c)])}this.setContents(l);if(this.editMode){var h=this.jq(c);h.blur(function(){k.text=h.val();h.hide();k.initDisplay()});this.jq(d).click(function(){var n=k.jq(d);var m=k.jq(c);m.show();m.css("z-index","9999");m.position({of:n,my:"left top",at:"left top",collision:"none none"});k.jq(d).html("hello there")})}},getWikiAttributes:function(g){a.getWikiAttributes(g);g.push("text");g.push(this.text)}})}function RamaddaShellDisplay(g,f,c){var e="input";var d="output";var b="message";var a;RamaddaUtil.inherit(this,a=new RamaddaDisplay(g,f,DISPLAY_SHELL,c));addRamaddaDisplay(this);RamaddaUtil.defineMembers(this,{history:[],historyIndex:-1,rootEntry:null,currentEntry:null,currentEntries:[],currentOutput:null,currentInput:null,initDisplay:function(){var n=this;this.initUI();var m=HtmlUtil.div([ATTR_CLASS,"display-shell-message",ATTR_ID,this.getDomId(b)],"");var k=HtmlUtil.div([ATTR_CLASS,"display-shell-output",ATTR_ID,this.getDomId(d)],"");var h=HtmlUtil.tag(TAG_INPUT,["placeholder","Enter JS here",ATTR_CLASS,"display-shell-input",ATTR_ID,this.getDomId(e)]);var l=m+k+h;this.setContents(l);if(this.currentOutput){this.getOutput().html(this.currentOutput)}if(this.currentInput){this.getInput().val(this.currentInput)}this.jq(e).keypress(function(p){if(p.which==0){return}if(p.ctrlKey){n.handleControlKey(p);return}if(p.which!=13){return}if(p.preventDefault){p.preventDefault()}var o=n.jq(e).val();n.processInput(o)})},writeStatusMessage:function(h){var k=this.jq(b);if(!h){k.hide();k.html("")}else{k.show();k.position({of:this.getOutput(),my:"left top",at:"left+4 top+4",collision:"none none"});k.html(h)}},clearInput:function(){this.jq(e).val("")},clearOutput:function(){this.writeStatusMessage(null);this.jq(d).html("")},handleControlKey:function(p){var m=p.which;var o=this.history;if(o.length<=0){return}var n=this.historyIndex;var l=-1;if(n<0||n>=o.length){n=o.length}if(m==112){l=n-1}else{if(m==110){l=n+1}}if(l>=0&&l<o.length){this.historyIndex=l;this.writeInput(o[l])}},writeInput:function(k){var h=this.getInput();if(h.val()==k){return}h.val(k).focus();this.currentInput=this.getInput().val()},getOutput:function(){return this.jq(d)},getInput:function(){return this.jq(e)},writeResult:function(k){this.writeStatusMessage(null);k=HtmlUtil.div([ATTR_CLASS,"display-shell-result"],k);var h=this.jq(d);h.append(k);h.animate({scrollTop:h.prop("scrollHeight")},1000);this.currentOutput=h.html();this.currentInput=this.getInput().val()},addHistory:function(h){if(this.history.length>0&&this.history[this.history.length-1]==h){return}this.history.push(h);this.historyIndex=-1},writeError:function(h){this.writeStatusMessage(h)},header:function(h){return HtmlUtil.div([ATTR_CLASS,"display-shell-header"],h)},processCommand_help:function(h,m,l){var k="";if(l!=null){k+=l}k+=this.header("RAMADDA Data Explorer Shell Help");k+="Navigation commands:<pre>pwd, ls, cd</pre>";k+="UI commands:<pre>history: ctrl-p, ctrl-n, !!  \nUI: clear, taller, shorter</pre>";this.writeResult(k)},uniqueCnt:0,displayEntries:function(h){this.currentEntries=h;var k=this.getEntriesTree(h,{showIndex:true,suffix:"_shell_"+(this.uniqueCnt++)});this.writeResult(k)},getEntryFromArgs:function(l,n){var o=this.currentEntries;if(o==null){return n}for(var m=0;m<l.length;m++){var h=l[m];if(h.match("^\d+$")){var k=parseInt(h);break}if(h=="-entry"){m++;var k=parseInt(l[m])-1;if(k<0||k>=o){this.writeError("Bad entry index:"+k+" should be between 1 and "+o.length);return}return o[k]}}return n},getCurrentEntry:function(){if(this.currentEntry==null){this.rootEntry=new Entry({id:ramaddaBaseEntry,name:"Root",type:"group"});this.currentEntry=this.rootEntry}return this.currentEntry},processCommand_pwd:function(h,n){var m=this.getCurrentEntry();var l=m.getIconImage([ATTR_TITLE,"View entry"]);var k=this.getEntriesTree([m],{suffix:"_YYY"});this.writeResult("Current entry:<br>"+k)},createPointDisplay:function(h,n,k){var m=this.getEntryFromArgs(n,this.getCurrentEntry());console.log("createDisplay got:"+m.getName());var l=this.getPointUrl(m);if(l==null){this.writeError("Not a point type:"+m.getName());return}this.createDisplay(m.getId(),k,l)},processCommand_table:function(h,k){this.createPointDisplay(h,k,DISPLAY_TABLE)},processCommand_linechart:function(h,k){this.createPointDisplay(h,k,DISPLAY_LINECHART)},processCommand_barchart:function(h,k){this.createPointDisplay(h,k,DISPLAY_BARCHART)},processCommand_bartable:function(h,k){this.createPointDisplay(h,k,DISPLAY_BARTABLE)},processCommand_hello:function(h,k){this.writeResult("Hello, how are you?")},processCommand_scatterplot:function(h,k){this.createPointDisplay(h,k,DISPLAY_SCATTERPLOT)},processCommand_blog:function(h,k){this.getLayoutManager().publish("blogentry")},processCommand_cd:function(h,l){if(l.length==0){this.currentEntry=this.rootEntry;this.processCommand_pwd("pwd",[]);return}var k=parseInt(l[1])-1;if(k<0||k>=this.currentEntries.length){this.writeError("Out of bounds: between 1 and "+this.currentEntries.length);return}this.currentEntry=this.currentEntries[k];this.processCommand_pwd("pwd",[])},processCommand_ls:function(h,n){var m=this;var l=function(o){m.displayEntries(o)};var k=this.getCurrentEntry().getChildrenEntries(l,"");if(k!=null){this.displayEntries(k)}else{this.writeStatusMessage("Listing entries...")}},entryListChanged:function(k){var h=k.getEntries();if(h.length==0){this.writeStatusMessage("Sorry, nothing found")}else{this.displayEntries(h)}},processCommand_search:function(k,p){var o="";for(var l=1;l<p.length;l++){o+=p[l]+" "}o=o.trim();var h=new EntrySearchSettings({text:o});var n=this.getRamadda();this.writeStatusMessage("Searching...");var m=n.getSearchUrl(h,OUTPUT_JSON);this.entryList=new EntryList(n,m,this,true)},processCommand_taller:function(h,k){if(!this.outputHeight){this.outputHeight=300}this.outputHeight+=parseInt(this.outputHeight*0.3);this.jq(d).css("max-height",this.outputHeight);this.jq(d).css("height",this.outputHeight)},processCommand_shorter:function(h,k){if(!this.outputHeight){this.outputHeight=300}this.outputHeight-=parseInt(this.outputHeight*0.3);this.jq(d).css("max-height",this.outputHeight);this.jq(d).css("height",this.outputHeight)},processCommand_clear:function(h){this.clearOutput();this.clearInput()},processInput:function(n){n=n.trim();if(n==""){return}var l=this.jq(e);var k=this.jq(d);var h=n.split(";");for(var m=0;m<h.length;m++){n=h[m];if(n=="!!"){if(this.history.length==0){this.writeError("No commands in history");return}n=this.history[this.history.length-1]}var p=n.split(" ");var o=p[0].trim();if(this["processCommand_"+o]){this["processCommand_"+o](n,p);this.addHistory(n);this.clearInput()}else{this.processCommand_help(n,p,"Unknown command: <i>"+n+"</i>");return}}}})}var CHARTS_CATEGORY="Charts";var DISPLAY_LINECHART="linechart";var DISPLAY_BARCHART="barchart";var DISPLAY_BARTABLE="bartable";var DISPLAY_BARSTACK="barstack";var DISPLAY_SCATTERPLOT="scatterplot";var DISPLAY_STATS="stats";var DISPLAY_PIECHART="piechart";var DISPLAY_TABLE="table";var DISPLAY_TEXT="text";var DISPLAY_CROSSTAB="crosstab";var DISPLAY_CORRELATION="correlation";var googleChartsLoaded=false;function googleChartsHaveLoaded(){googleChartsLoaded=true}google.charts.setOnLoadCallback(googleChartsHaveLoaded);function haveGoogleChartsLoaded(){if(!googleChartsLoaded){if(typeof google.visualization!=="undefined"){if(typeof google.visualization.BarChart!=="undefined"){googleChartsLoaded=true}}}return googleChartsLoaded}addGlobalDisplayType({type:DISPLAY_LINECHART,label:"Line Chart",requiresData:true,forUser:true,category:CHARTS_CATEGORY});addGlobalDisplayType({type:DISPLAY_BARCHART,label:"Bar Chart",requiresData:true,forUser:true,category:CHARTS_CATEGORY});addGlobalDisplayType({type:DISPLAY_BARSTACK,label:"Stacked Bar Chart",requiresData:true,forUser:true,category:CHARTS_CATEGORY});addGlobalDisplayType({type:DISPLAY_BARTABLE,label:"Bar Table",requiresData:true,forUser:true,category:CHARTS_CATEGORY});addGlobalDisplayType({type:DISPLAY_SCATTERPLOT,label:"Scatter Plot",requiresData:true,forUser:true,category:CHARTS_CATEGORY});addGlobalDisplayType({type:DISPLAY_STATS,label:"Stats Table",requiresData:false,forUser:true,category:CHARTS_CATEGORY});addGlobalDisplayType({type:DISPLAY_PIECHART,label:"Pie Chart",requiresData:true,forUser:true,category:CHARTS_CATEGORY});addGlobalDisplayType({type:DISPLAY_TABLE,label:"Table",requiresData:true,forUser:true,category:CHARTS_CATEGORY});addGlobalDisplayType({type:DISPLAY_TEXT,label:"Text Readout",requiresData:false,forUser:true,category:CHARTS_CATEGORY});addGlobalDisplayType({type:DISPLAY_CORRELATION,label:"Correlation",requiresData:true,forUser:true,category:CHARTS_CATEGORY});var PROP_CHART_MIN="chartMin";var PROP_CHART_MAX="chartMax";var PROP_CHART_TYPE="chartType";var DFLT_WIDTH="600px";var DFLT_HEIGHT="200px";function RamaddaFieldsDisplay(f,e,c,b){var d=this;this.TYPE="RamaddaFieldsDisplay";var a;RamaddaUtil.inherit(this,this.RamaddaDisplay=a=new RamaddaDisplay(f,e,c,b));RamaddaUtil.defineMembers(this,{needsData:function(){return true},initDisplay:function(){this.initUI();this.updateUI()},updateUI:function(){this.addFieldsCheckboxes()},getWikiAttributes:function(h){a.getWikiAttributes.call(this,h);if(this.lastSelectedFields){h.push("fields");var g="";for(var k=0;k<this.lastSelectedFields.length;k++){g+=this.lastSelectedFields[k].getId();g+=","}h.push(g)}},initDialog:function(){a.initDialog.call(this);this.addFieldsCheckboxes()},getDialogContents:function(h,l){var g="600";var k=HtmlUtil.div([ATTR_ID,this.getDomId(ID_FIELDS),"style","overflow-y: auto;    max-height:"+g+"px;"]," FIELDS ");h.push("Fields");l.push(k);a.getDialogContents.call(this,h,l)},handleEventFieldsSelected:function(h,g){this.userHasSelectedAField=true;this.overrideFields=null;this.removeProperty(PROP_FIELDS);this.setSelectedFields(g);this.fieldSelectionChanged()},getFieldsToSelect:function(g){return g.getRecordFields()},canDoMultiFields:function(){return true}})}function RamaddaMultiChart(displayManager,id,properties){var ID_CHART="chart";var ID_TRENDS_CBX="trends_cbx";var ID_PERCENT_CBX="percent_cbx";var ID_COLORS="colors";var _this=this;$(document).ready(function(){var cb=function(){_this.displayData()}});$.extend(this,{indexField:-1,colors:["blue","red","green","orange","fuchsia","teal","navy","silver"],curveType:"none",fontSize:0,vAxisMinValue:NaN,vAxisMaxValue:NaN,showTrendlines:false,showPercent:false,percentFields:null});if(properties.colors){this.colors=(""+properties.colors).split(",")}var SUPER;RamaddaUtil.inherit(this,SUPER=new RamaddaFieldsDisplay(displayManager,id,properties.chartType,properties));RamaddaUtil.defineMembers(this,{getType:function(){return this.getProperty(PROP_CHART_TYPE,DISPLAY_LINECHART)},initDisplay:function(){this.initUI();this.updateUI()},updateUI:function(){SUPER.updateUI.call(this);this.displayData()},getWikiAttributes:function(attrs){this.defineWikiAttributes(["vAxisMinValue","vAxisMaxValue"]);SUPER.getWikiAttributes.call(this,attrs);if(this.colors.join(",")!="blue,red,green"){attrs.push("colors");attrs.push(this.colors.join(", "))}},initDialog:function(){SUPER.initDialog.call(this);var _this=this;var updateFunc=function(){_this.vAxisMinValue=Utils.toFloat(_this.jq("vaxismin").val());_this.vAxisMaxValue=Utils.toFloat(_this.jq("vaxismax").val());_this.minDate=_this.jq("mindate").val();_this.maxDate=_this.jq("maxdate").val();_this.displayData()};this.jq("vaxismin").blur(updateFunc);this.jq("vaxismax").blur(updateFunc);this.jq("mindate").blur(updateFunc);this.jq("maxdate").blur(updateFunc);this.jq(ID_COLORS).keypress(function(e){if(e.which!=13){return}var v=_this.jq(ID_COLORS).val();_this.colors=v.split(",");_this.displayData();var pointData=_this.dataCollection.getList();_this.getDisplayManager().handleEventPointDataLoaded(_this,_this.lastPointData)});this.jq(ID_TRENDS_CBX).click(function(){_this.showTrendLines=_this.jq(ID_TRENDS_CBX).is(":checked");_this.displayData()});this.jq(ID_PERCENT_CBX).click(function(){_this.showPercent=_this.jq(ID_PERCENT_CBX).is(":checked");_this.displayData()})},setColor:function(){var v=prompt("Enter comma separated list of colors to use",this.colors.join(","));if(v!=null){this.colors=v.split(",");this.displayData();var pointData=this.dataCollection.getList();this.getDisplayManager().handleEventPointDataLoaded(this,this.lastPointData)}},getMenuItems:function(menuItems){SUPER.getMenuItems.call(this,menuItems);var get=this.getGet();var min="0";if(!isNaN(this.vAxisMinValue)){min=""+this.vAxisMinValue}var max="";if(!isNaN(this.vAxisMaxValue)){max=""+this.vAxisMaxValue}var tmp=HtmlUtil.formTable();tmp+=HtmlUtil.formEntry("Axis Range:",HtmlUtil.input("",min,["size","7",ATTR_ID,this.getDomId("vaxismin")])+" - "+HtmlUtil.input("",max,["size","7",ATTR_ID,this.getDomId("vaxismax")]));tmp+=HtmlUtil.formEntry("Date Range:",HtmlUtil.input("",this.minDate,["size","10",ATTR_ID,this.getDomId("mindate")])+" - "+HtmlUtil.input("",this.maxDate,["size","10",ATTR_ID,this.getDomId("maxdate")]));tmp+=HtmlUtil.formEntry("Colors:",HtmlUtil.input("",this.colors.join(","),["size","35",ATTR_ID,this.getDomId(ID_COLORS)]));tmp+="</table>";menuItems.push(tmp)},getChartType:function(){return this.getProperty(PROP_CHART_TYPE,DISPLAY_LINECHART)},defaultSelectedToAll:function(){if(this.chartType==DISPLAY_TABLE){return true}return SUPER.defaultSelectedToAll.call(this)},askMinZAxis:function(){this.setMinZAxis(prompt("Minimum axis value","0"))},setMinZAxis:function(v){if(v!=null){this.vAxisMinValue=parseFloat(v);this.displayData()}},askMaxZAxis:function(){this.setMaxZAxis(prompt("Maximum axis value","100"))},setMaxZAxis:function(v){if(v!=null){this.vAxisMaxValue=parseFloat(v);this.displayData()}},askMinDate:function(){var ex=this.minDate;if(ex==null||ex==""){ex="1800-01-01"}var v=prompt("Minimum date",ex);if(v==null){return}this.setMinDate(v)},setMinDate:function(v){this.minDate=v;this.displayData()},askMaxDate:function(){var ex=this.maxDate;if(ex==null||ex==""){ex="2100-01-01"}var v=prompt("Maximum date",ex);if(v==null){return}this.setMaxDate(v)},setMaxDate:function(v){this.maxDate=v;this.displayData()},getDialogContents:function(tabTitles,tabContents){var height="600";var html=HtmlUtil.div([ATTR_ID,this.getDomId(ID_FIELDS),"style","overflow-y: auto;    max-height:"+height+"px;"]," FIELDS ");html+=HtmlUtil.div([ATTR_CLASS,"display-dialog-subheader"],"Other");html+=HtmlUtil.checkbox(this.getDomId(ID_TRENDS_CBX),[],this.showTrendLines)+"  Show trend line";html+=" ";html+=HtmlUtil.checkbox(this.getDomId(ID_PERCENT_CBX),[],this.showPercent)+"  Show percent of displayed total<br>";html+="<br>";tabTitles.push("Fields");tabContents.push(html);SUPER.RamaddaDisplay.getDialogContents.call(this,tabTitles,tabContents)},handleEventMapClick:function(source,args){var pointData=this.dataCollection.getList();for(var i=0;i<pointData.length;i++){pointData[i].handleEventMapClick(this,source,args.lon,args.lat)}},handleEventRecordSelection:function(source,args){if(source==this){return}this.setChartSelection(args.index)},getFieldsToSelect:function(pointData){var chartType=this.getProperty(PROP_CHART_TYPE,DISPLAY_LINECHART);if(this.chartType==DISPLAY_TABLE||this.chartType==DISPLAY_BARTABLE){return pointData.getNonGeoFields()}return pointData.getChartableFields()},canDoGroupBy:function(){return this.chartType==DISPLAY_PIECHART||this.chartType==DISPLAY_TABLE},xcnt:0,displayData:function(){if(this.inError){return}if(!haveGoogleChartsLoaded()){var _this=this;var func=function(){_this.displayData()};this.setContents(this.getLoadingMessage());setTimeout(func,1000);return}if(this.inError){return}if(!this.hasData()){this.clearChart();this.setContents(this.getLoadingMessage());return}this.setContents(HtmlUtil.div([ATTR_CLASS,"display-message"],"Building display..."));this.allFields=this.dataCollection.getList()[0].getRecordFields();var chartType=this.getProperty(PROP_CHART_TYPE,DISPLAY_LINECHART);var selectedFields=this.getSelectedFields([]);if(selectedFields.length==0&&this.lastSelectedFields!=null){selectedFields=this.lastSelectedFields}if(selectedFields==null||selectedFields.length==0){if(this.chartType==DISPLAY_TABLE){selectedFields=this.dataCollection.getList()[0].getNonGeoFields()}else{selectedFields=this.getSelectedFields()}}if(selectedFields.length==0){this.setContents("No fields selected");return}var tmpFields=[];for(var i=0;i<selectedFields.length;i++){if(!this.shouldSkipField(selectedFields[i])){tmpFields.push(selectedFields[i])}}selectedFields=tmpFields;this.lastSelectedFields=selectedFields;var props={includeIndex:true};if(this.chartType==DISPLAY_TABLE||this.chartType==DISPLAY_BARTABLE||chartType==DISPLAY_PIECHART||chartType==DISPLAY_SCATTERPLOT){props.includeIndex=false}props.groupByIndex=-1;if(chartType==DISPLAY_PIECHART){if(!this.groupBy&&this.groupBy!=""){for(var i=0;i<this.allFields.length;i++){var field=this.allFields[i];if(field.getType()=="string"){this.groupBy=field.getId();break}}}}if(this.groupBy){for(var i=0;i<this.allFields.length;i++){var field=this.allFields[i];if(field.getId()==this.groupBy){props.groupByIndex=field.getIndex();props.groupByField=field;break}}}var fieldsToSelect=selectedFields;if(this.raw){fieldsToSelect=this.dataCollection.getList()[0].getRecordFields();props.raw=true}if(chartType==DISPLAY_BARTABLE){props.includeIndexIfDate=true}var dataHasIndex=props.includeIndex;var dataList=this.computedData;if(this["function"]&&this.computedData==null){var pointData=this.dataCollection.getList()[0];var allFields=pointData.getRecordFields();var records=pointData.getRecords();var indexField=this.indexField;var chartableFields=this.getFieldsToSelect(pointData);this.hasDate=this.getHasDate(records);var date_formatter=this.getDateFormatter();var setVars="";for(var i=0;i<chartableFields.length;i++){var field=chartableFields[i];setVars+="\tvar "+field.getId()+"=args."+field.getId()+";\n"}var code="function displayChartEval(args) {\n"+setVars+"\treturn  "+this["function"]+"\n}";eval(code);var newList=[];var fieldNames=null;var rowCnt=-1;var indexField=this.indexField;for(var rowIdx=0;rowIdx<records.length;rowIdx++){var record=records[rowIdx];var row=record.getData();var date=record.getDate();if(!this.dateInRange(date)){continue}rowCnt++;var values=[];var indexName=null;if(indexField>=0){var field=allFields[indexField];values.push(record.getValue(indexField)+offset);indexName=field.getLabel()}else{if(this.hasDate){values.push(this.getDateValue(date,date_formatter));indexName="Date"}else{values.push(rowIdx);indexName="Index"}}if(fieldNames==null){fieldNames=[indexName,this.functionName?this.functionName:"value"];newList.push(fieldNames)}var args={};for(var j=0;j<chartableFields.length;j++){var field=chartableFields[j];var value=row[field.getIndex()];args[field.getId()]=value}var value=displayChartEval(args);values.push(value);newList.push(values)}dataList=newList}if(dataList==null){dataList=this.getStandardData(fieldsToSelect,props)}this.computedData=dataList;if(this.rotateTable&&dataList.length){var header=dataList[0];var flipped=[];for(var rowIdx=1;rowIdx<dataList.length;rowIdx++){var row=dataList[rowIdx]}}if(dataList.length==0&&!this.userHasSelectedAField){var pointData=this.dataCollection.getList()[0];var chartableFields=this.getFieldsToSelect(pointData);for(var i=0;i<chartableFields.length;i++){var field=chartableFields[i];dataList=this.getStandardData([field],props);if(dataList.length>0){this.setSelectedFields([field]);break}}}if(dataList.length==0){this.setContents(HtmlUtil.div([ATTR_CLASS,"display-message"],"No data available"));return}if(this.showPercent){var newList=[];var isNumber=[];var isOk=[];var headerRow=null;var fields=null;if(this.percentFields!=null){fields=this.percentFields.split(",")}for(var i=0;i<dataList.length;i++){var row=dataList[i];if(i==0){headerRow=row;continue}if(i==1){var seenIndex=false;for(var j=0;j<row.length;j++){var valueIsNumber=(typeof row[j]=="number");var valueIsDate=(typeof row[j]=="object");if(valueIsNumber){if(dataHasIndex&&!seenIndex){valueIsNumber=false;seenIndex=true}}if(valueIsDate){seenIndex=true}if(valueIsNumber&&fields!=null){valueIsNumber=fields.indexOf(fieldsToSelect[j].getId())>=0||fields.indexOf("#"+(j+1))>=0}isNumber.push(valueIsNumber)}var newHeader=[];for(var j=0;j<headerRow.length;j++){var v=headerRow[j];if(!isNumber[j]){newHeader.push(v)}else{newHeader.push("% "+v)}}newList.push(newHeader)}var total=0;var cnt=0;for(var j=0;j<row.length;j++){if(isNumber[j]){total+=parseFloat(row[j]);cnt++}}var newRow=[];for(var j=0;j<row.length;j++){if(isNumber[j]){if(total!=0){var v=parseFloat(((row[j]/total)*100).toFixed(1));newRow.push(v)}else{newRow.push(NaN)}}else{newRow.push(row[j])}}newList.push(newRow)}dataList=newList}this.makeChart(chartType,dataList,selectedFields);var d=this.jq(ID_CHART);if(d.width()==0){if(!this.calledBackDisplay){this.calledBackDisplay=0}this.calledBackDisplay++;if(this.calledBackDisplay<5){var _this=this;var cb=function(){_this.displayData()};setTimeout(cb,3000)}}},printDataList:function(dataList){console.log("data list:"+dataList.length);for(var i=0;i<dataList.length;i++){var row=dataList[i];var s="";for(var j=0;j<row.length;j++){if(j>0){s+=", "}s+=row[j]}console.log("row: "+i+"  "+s)}},clearChart:function(){if(this.chart!=null){this.chart.clearChart()}},setChartSelection:function(index){if(this.chart!=null){this.chart.setSelection([{row:index,column:null}])}},tableHeaderMouseover:function(i,tooltip){},makeGoogleChart:function(chartType,dataList,selectedFields){if(typeof google=="undefined"){this.setContents("No google");return}if(chartType==DISPLAY_TABLE&&dataList.length>0){var header=dataList[0]}var dataTable=google.visualization.arrayToDataTable(dataList);for(var i=1;i<dataList.length;i++){var row=dataList[i];var s="";for(var j=0;j<row.length;j++){s=s+" -  "+row[j]}}var chartOptions={};$.extend(chartOptions,{lineWidth:1,colors:this.colors,curveType:this.curveType,vAxis:{}});if(this.lineWidth){chartOptions.lineWidth=this.lineWidth}if(this.fontSize>0){chartOptions.fontSize=this.fontSize}var defaultRange=this.getDisplayManager().getRange(selectedFields[0]);var range=[NaN,NaN];if(!isNaN(this.vAxisMinValue)){range[0]=parseFloat(this.vAxisMinValue)}else{if(defaultRange!=null){range[0]=defaultRange[0]}}if(!isNaN(this.vAxisMaxValue)){range[1]=parseFloat(this.vAxisMaxValue)}else{if(defaultRange!=null){range[1]=defaultRange[1]}}if(!isNaN(range[0])){chartOptions.vAxis.minValue=range[0]}if(!isNaN(range[1])){chartOptions.vAxis.maxValue=range[1]}var width="90%";var left="10%";useMultipleAxes=this.getProperty("useMultipleAxes",true);if(selectedFields.length>1&&useMultipleAxes){width="80%"}var chartId=this.getDomId(ID_CHART);var divAttrs=[ATTR_ID,chartId];if(chartType==DISPLAY_PIECHART){divAttrs.push("style");var style="";if(this.chartWidth){style+="width:"+this.chartWidth+";"}else{style+="width:600px;"}if(this.chartHeight){style+="height:"+this.chartHeight+";"}else{style+="height:400px;"}divAttrs.push(style)}else{}divAttrs.push("style");divAttrs.push("height:100%;");this.setContents(HtmlUtil.div(divAttrs,""));if(chartType==DISPLAY_LINECHART||chartType==DISPLAY_BARCHART||chartType==DISPLAY_BARSTACK){chartOptions.height=this.getProperty("chartHeight",this.getProperty("height","150"));$.extend(chartOptions,{legend:{position:"bottom"},chartArea:{left:left,top:10,height:"70%",width:width}});if(useMultipleAxes){$.extend(chartOptions,{series:[{targetAxisIndex:0},{targetAxisIndex:1}]})}if(this.showTrendLines){chartOptions.trendlines={0:{type:"linear",color:"green"}}}if(this.hAxis){if(chartOptions.hAxis){chartOptions.hAxis.title=this.hAxis}else{chartOptions.hAxis={title:this.hAxis}}}if(this.vAxis){if(chartOptions.vAxis){chartOptions.vAxis.title=this.vAxis}else{chartOptions.vAxis={title:this.vAxis}}}if(Utils.isDefined(this.chartHeight)){chartOptions.height=this.chartHeight}}if(chartType==DISPLAY_BARTABLE){var height="";if(Utils.isDefined(this.chartHeight)){height=this.chartHeight}else{if(dataList.length>1){var numBars=dataList.length;if(this.isStacked){height=numBars*22}else{height=numBars*22+numBars*14*(dataList[0].length-2)}}}var chartOptions={title:"the title",bars:"horizontal",colors:this.colors,width:(Utils.isDefined(this.chartWidth)?this.chartWidth:"100%"),chartArea:{left:"30%",top:0,width:"70%",height:"80%"},height:height,bars:"horizontal",tooltip:{showColorCode:true},legend:{position:"none"}};if(Utils.isDefined(this.isStacked)){chartOptions.isStacked=this.isStacked}if(this.hAxis){chartOptions.hAxis={title:this.hAxis}}if(this.vAxis){chartOptions.vAxis={title:this.vAxis}}this.chart=new google.charts.Bar(document.getElementById(chartId))}else{if(chartType==DISPLAY_BARCHART||chartType==DISPLAY_BARSTACK){if(chartType==DISPLAY_BARSTACK){chartOptions.isStacked=true}chartOptions.orientation="horizontal";this.chart=new google.visualization.BarChart(document.getElementById(chartId))}else{if(chartType==DISPLAY_SCATTERPLOT){var height=400;if(Utils.isDefined(this.chartHeight)){height=this.chartHeight}var width="100%";if(Utils.isDefined(this.chartWidth)){width=this.chartWidth}$("#"+chartId).css("width",width);$("#"+chartId).css("height",height);chartOptions={title:"",legend:"none",chartArea:{left:"10%",top:10,height:"80%",width:"90%"}};if(this.getShowTitle()){chartOptions.title=this.getTitle(true)}if(dataList.length>0&&dataList[0].length>1){chartOptions.hAxis={title:dataList[0][0]};chartOptions.vAxis={title:dataList[0][1]};if(!isNaN(this.vAxisMinValue)){chartOptions.hAxis.minValue=this.vAxisMinValue;chartOptions.vAxis.minValue=this.vAxisMinValue}if(!isNaN(this.vAxisMaxValue)){chartOptions.hAxis.maxValue=this.vAxisMaxValue;chartOptions.vAxis.maxValue=this.vAxisMaxValue}}this.chart=new google.visualization.ScatterChart(document.getElementById(chartId))}else{if(chartType==DISPLAY_PIECHART){if(this.is3D){chartOptions.is3D=true}if(this.pieHole){chartOptions.pieHole=this.pieHole}if(this.sliceVisibilityThreshold){chartOptions.sliceVisibilityThreshold=this.sliceVisibilityThreshold}this.chart=new google.visualization.PieChart(document.getElementById(chartId))}else{if(chartType==DISPLAY_TABLE){chartOptions.height=null;if(this.chartHeight){chartOptions.height=this.chartHeight}if(chartOptions.height==null){var height=this.getProperty("height",null);if(height){chartOptions.height=height}}if(chartOptions.height==null){chartOptions.height="300px"}chartOptions.allowHtml=true;if(dataList.length&&dataList[0].length>4){chartOptions.cssClassNames={headerCell:"display-table-header-max"}}else{chartOptions.cssClassNames={headerCell:"display-table-header"}}this.chart=new google.visualization.Table(document.getElementById(chartId))}else{this.chart=new google.visualization.LineChart(document.getElementById(chartId))}}}}}if(this.chart!=null){if(!Utils.isDefined(chartOptions.height)){chartOptions.height="100%"}this.chart.draw(dataTable,chartOptions);var theDisplay=this;google.visualization.events.addListener(this.chart,"onmouseover",function(event){mapVar=theDisplay.getProperty("mapVar",null);if(!Utils.stringDefined(mapVar)){return}row=event.row;pointData=theDisplay.dataCollection.getList()[0];var fields=pointData.getRecordFields();var records=pointData.getRecords();var record=records[row];map=ramaddaMapMap[mapVar];if(map){if(theDisplay.mouseOverPoint){map.removePoint(theDisplay.mouseOverPoint)}}else{}if(record&&map){latField=null;lonField=null;for(i=0;i<fields.length;i++){if(fields[i].isFieldLatitude()){latField=fields[i]}else{if(fields[i].isFieldLongitude()){lonField=fields[i]}}}if(latField&&lonField){lat=record.getValue(latField.getIndex());lon=record.getValue(lonField.getIndex());theDisplay.mouseOverPoint=map.addPoint(chartId,new OpenLayers.LonLat(lon,lat))}}});google.visualization.events.addListener(this.chart,"select",function(event){if(theDisplay.chart.getSelection){var selected=theDisplay.chart.getSelection();if(selected&&selected.length>0){var index=selected[0].row;theDisplay.displayManager.handleEventRecordSelection(theDisplay,theDisplay.dataCollection.getList()[0],index)}}})}}});this.makeChart=this.makeGoogleChart}function LinechartDisplay(c,b,a){a=$.extend({chartType:DISPLAY_LINECHART},a);RamaddaUtil.inherit(this,new RamaddaMultiChart(c,b,a));addRamaddaDisplay(this)}function BarchartDisplay(c,b,a){a=$.extend({chartType:DISPLAY_BARCHART},a);RamaddaUtil.inherit(this,new RamaddaMultiChart(c,b,a));addRamaddaDisplay(this)}function BarstackDisplay(c,b,a){a=$.extend({chartType:DISPLAY_BARSTACK,isStacked:true},a);RamaddaUtil.inherit(this,new RamaddaMultiChart(c,b,a));addRamaddaDisplay(this)}function PiechartDisplay(c,b,a){a=$.extend({chartType:DISPLAY_PIECHART},a);RamaddaUtil.inherit(this,new RamaddaMultiChart(c,b,a));addRamaddaDisplay(this)}function TableDisplay(c,b,a){a=$.extend({chartType:DISPLAY_TABLE},a);RamaddaUtil.inherit(this,new RamaddaMultiChart(c,b,a));addRamaddaDisplay(this)}function BartableDisplay(c,b,a){a=$.extend({chartType:DISPLAY_BARTABLE},a);RamaddaUtil.inherit(this,new RamaddaMultiChart(c,b,a));$.extend(this,{getDefaultSelectedFields:function(d,h){var e=[];for(i=0;i<d.length;i++){var g=d[i];if(!g.isNumeric){e.push(g);break}}for(i=0;i<d.length;i++){var g=d[i];if(g.isNumeric){e.push(g);break}}return e}});addRamaddaDisplay(this)}function ScatterplotDisplay(c,b,a){a=$.extend({chartType:DISPLAY_SCATTERPLOT},a);RamaddaUtil.inherit(this,new RamaddaMultiChart(c,b,a));$.extend(this,{getDefaultSelectedFields:function(d,h){var e=[];for(i=0;i<d.length;i++){var g=d[i];if(g.isNumeric){e.push(g);if(e.length>=2){break}}}return e}});addRamaddaDisplay(this)}function RamaddaTextDisplay(d,c,b){var a;$.extend(this,a=new RamaddaDisplay(d,c,DISPLAY_TEXT,b));addRamaddaDisplay(this);RamaddaUtil.defineMembers(this,{lastHtml:"<p>&nbsp;<p>&nbsp;<p>",initDisplay:function(){this.initUI();this.setContents(this.lastHtml)},handleEventRecordSelection:function(f,e){this.lastHtml=e.html;this.setContents(e.html)}})}function RamaddaStatsDisplay(d,c,b){var a;$.extend(this,{showMin:true,showMax:true,showAverage:true});RamaddaUtil.inherit(this,a=new RamaddaFieldsDisplay(d,c,DISPLAY_STATS,b));addRamaddaDisplay(this);RamaddaUtil.defineMembers(this,{"map-display":false,needsData:function(){return true},handleEventPointDataLoaded:function(f,e){if(!this.needsData()){if(this.dataCollection==null){this.dataCollection=f.dataCollection;this.updateUI()}}},getDefaultSelectedFields:function(e,m){if(m!=null&&m.length>0){return m}var g=this.getStandardData(null,{includeIndex:false});var n=(g.length==2);var f=[];for(i=0;i<e.length;i++){var k=e[i];if(!n&&!k.isNumeric){continue}var h=k.getLabel().toLowerCase();if(h.indexOf("latitude")>=0||h.indexOf("longitude")>=0){continue}f.push(k)}return f},getFieldsToSelect:function(e){return e.getRecordFields()},defaultSelectedToAll:function(){return true},fieldSelectionChanged:function(){this.updateUI()},updateUI:function(C){a.updateUI.call(this,C);if(!this.hasData()){this.setContents(this.getLoadingMessage());return}var D=this.getStandardData(null,{includeIndex:false});var x=this.dataCollection.getList()[0].getRecordFields();this.allFields=x;var u=this.getSelectedFields([]);var k={};var G=new Array();var B=(D.length==2);for(var f=1;f<D.length;f++){var s=D[f];if(f==1){for(var h=0;h<s.length;h++){G.push({isNumber:false,min:Number.MAX_SAFE_INTEGER,max:Number.MIN_SAFE_INTEGER,total:0})}}for(var F=0;F<u.length;F++){var e=u[F];var h=e.getIndex();var q=s[h];if(typeof q=="number"){var m=e.getLabel().toLowerCase();if(m.indexOf("latitude")>=0||m.indexOf("longitude")>=0){continue}if(!G[h].isNumber){G[h].max=q;G[h].min=q}G[h].isNumber=true;G[h].total+=q;G[h].max=Math.max(G[h].max,q);G[h].min=Math.min(G[h].min,q)}}}var y=(B?"0":"1");var p=HtmlUtil.openTag("table",["border",y,"bordercolor","#ccc","class","display-stats","cellspacing","1","cellpadding","5"]);var H=["&nbsp;"];if(!B){header=[""];if(this.showMin){header.push("Min");H.push("&nbsp;")}if(this.showMax){header.push("Max");H.push("&nbsp;")}header.push("Total");H.push("&nbsp;");if(this.showAverage){header.push("Average");H.push("&nbsp;")}p+=HtmlUtil.tr([],HtmlUtil.tds(["class","display-stats-header","align","center"],header))}var o=[];var n={};for(var F=0;F<u.length;F++){var e=u[F];var h=e.getIndex();var e=x[h];var E="";if(G[h].isNumber){var J="&nbsp;";var t=this.formatNumber(G[h].total/D.length);var m=e.getLabel().toLowerCase();if(m.indexOf("%")<0&&m.indexOf("percent")<0&&m.indexOf("median")<0){J=this.formatNumber(G[h].total)}var g=[];if(B){E=HtmlUtil.tds(["xalign","right"],[this.formatNumber(G[h].min)])}else{if(this.showMin){g.push(this.formatNumber(G[h].min))}if(this.showMax){g.push(this.formatNumber(G[h].max))}g.push(J);if(this.showAverage){g.push(t)}E=HtmlUtil.tds(["align","right"],g)}}else{E=HtmlUtil.tds([],H)}var z=(B?"right":"left");var m=e.getLabel();var w=m.split("!!");var I=m;m=w[w.length-1];if(B){m+=":"}var l=HtmlUtil.tr([],HtmlUtil.td(["align",z],"<b>"+HtmlUtil.tag("div",["title",I],m)+"</b>")+E);if(B){p+=l}else{p+=l}}p+="</table>";this.setContents(p);$(document).tooltip()},handleEventRecordSelection:function(f,e){}})}function RamaddaCrosstabDisplay(d,c,b){var a;RamaddaUtil.inherit(this,a=new RamaddaFieldsDisplay(d,c,DISPLAY_CROSSTAB,b));addRamaddaDisplay(this);this.columns=this.getProperty("columns","").split(",");this.rows=this.getProperty("rows","").split(",");RamaddaUtil.defineMembers(this,{"map-display":false,needsData:function(){return true},handleEventPointDataLoaded:function(f,e){if(!this.needsData()){if(this.dataCollection==null){this.dataCollection=f.dataCollection;this.updateUI()}}},fieldSelectionChanged:function(){this.updateUI()},updateUI:function(w){a.updateUI.call(this,w);if(!this.hasData()){this.setContents(this.getLoadingMessage());return}var p=this.getStandardData(null,{includeIndex:false});var t=this.dataCollection.getList()[0].getRecordFields();var l={};cols=[];rows=[];for(var m=0;m<this.columns.length;m++){var f=this.columns[m];for(var n=0;n<t.length;n++){field=t[n];if(f==field.getLabel()||f==("#"+(n+1))){cols.push(t[n]);break}}}for(var m=0;m<this.rows.length;m++){var f=this.rows[m];for(var n=0;n<t.length;n++){if(f==t[n].getLabel()||f==("#"+(n+1))){rows.push(t[n]);break}}}var o=HtmlUtil.openTag("table",["border","1px","bordercolor","#ccc","class","display-stats","cellspacing","1","cellpadding","5"]);var u={};var e={};for(var m=0;m<cols.length;m++){var k=cols[m];var v=k.getLabel();for(var h=1;h<p.length;h++){var s=p[h];var g=s[k.getIndex()];if(!(v in u)){u[v]=[]}var q=u[v];if(q.indexOf(g)<0){console.log(g);q.push(g)}}}for(v in u){u[v].sort();console.log(u[v])}for(var m=0;m<cols.length;m++){var k=cols[m];for(var h=1;h<p.length;h++){var s=p[h];for(var n=0;n<rows.length;n++){var x=rows[m]}}}o+="</table>";this.setContents(o);$(document).tooltip()}})}function RamaddaCorrelationDisplay(d,c,b){var a;$.extend(this,{colorBar:"red_white_blue",colorByMin:"-1",colorByMax:"1"});RamaddaUtil.inherit(this,a=new RamaddaFieldsDisplay(d,c,DISPLAY_CORRELATION,b));addRamaddaDisplay(this);RamaddaUtil.defineMembers(this,{"map-display":false,needsData:function(){return true},getMenuItems:function(h){a.getMenuItems.call(this,h);var e=this.getGet();var g=HtmlUtil.formTable();var f="<select id="+this.getDomId("colorbar")+">";for(table in Utils.ColorTables){if(table==this.colorBar){f+="<option selected>"+table+"</option>"}else{f+="<option>"+table+"</option>"}}f+="</select>";g+=HtmlUtil.formEntry("Color Bar:",f);g+=HtmlUtil.formEntry("Color By Range:",HtmlUtil.input("",this.colorByMin,["size","7",ATTR_ID,this.getDomId("colorbymin")])+" - "+HtmlUtil.input("",this.colorByMax,["size","7",ATTR_ID,this.getDomId("colorbymax")]));g+="</table>";h.push(g)},initDialog:function(){a.initDialog.call(this);var g=this;var f=function(){g.colorByMin=g.jq("colorbymin").val();g.colorByMax=g.jq("colorbymax").val();g.updateUI()};var e=function(){g.colorBar=g.jq("colorbar").val();g.updateUI()};this.jq("colorbymin").blur(f);this.jq("colorbymax").blur(f);this.jq("colorbar").change(e)},handleEventPointDataLoaded:function(f,e){if(!this.needsData()){if(this.dataCollection==null){this.dataCollection=f.dataCollection;this.updateUI()}}},fieldSelectionChanged:function(){this.updateUI()},updateUI:function(z){a.updateUI.call(this,z);if(!this.hasData()){this.setContents(this.getLoadingMessage());return}var B=this.getStandardData(null,{includeIndex:false});var u=this.dataCollection.getList()[0].getRecordFields();var t=this.getSelectedFields([]);if(t.length==0){t=u}var q=HtmlUtil.openTag("table",["border","1px","bordercolor","#ccc","class","display-correlation","cellspacing","1","cellpadding","5"]);q+="<tr><td class=display-heading>&nbsp;</td>";for(var G=0;G<t.length;G++){var f=t[G];if(!f.isFieldNumeric()||f.isFieldGeo()){continue}q+="<td align=center class=display-heading><b>"+f.getLabel()+"</b></td>"}q+="</tr>";var o=null;colorByMin=parseFloat(this.colorByMin);colorByMax=parseFloat(this.colorByMax);if(this.colorBar&&this.colorBar!="none"){o=Utils.ColorTables[this.colorBar]}for(var H=0;H<t.length;H++){var f=t[H];if(!f.isFieldNumeric()||f.isFieldGeo()){continue}q+="<tr><td class=display-heading><b>"+f.getLabel()+"</b></td>";for(var E=0;E<t.length;E++){var e=t[E];if(!e.isFieldNumeric()||e.isFieldGeo()){continue}var p=0;var n=0;var x=0;for(var h=1;h<B.length;h++){var s=B[h];var l=s[f.getIndex()];var k=s[e.getIndex()];p+=l;n+=k;x++}var w=p/x;var v=n/x;var F=0;var D=0;var C=0;for(var h=1;h<B.length;h++){var s=B[h];var l=s[f.getIndex()];var k=s[e.getIndex()];F+=(l-w)*(k-v);D+=(l-w)*(l-w);C+=(k-v)*(k-v)}r=F/Math.sqrt(D*C);var y="";if(o!=null){var g=(r-colorByMin)/(colorByMax-colorByMin);var m=parseInt(g*o.length);if(m>=o.length){m=o.length-1}else{if(m<0){m=0}}y="background-color:"+o[m]}q+='<td align=right style="'+y+'">'+r.toFixed(3)+"</td>"}q+="</tr>"}q+="</table>";this.setContents(q);$(document).tooltip()}})}var DISPLAY_D3_GLIDER_CROSS_SECTION="GliderCrossSection";var DISPLAY_D3_PROFILE="profile";var DISPLAY_D3_LINECHART="D3LineChart";addGlobalDisplayType({type:DISPLAY_D3_LINECHART,forUser:false,label:"D3 LineChart",requiresData:true,category:"Charts"});addGlobalDisplayType({type:DISPLAY_D3_PROFILE,forUser:false,label:"Profile",requiresData:true,category:"Charts"});addGlobalDisplayType({type:DISPLAY_D3_GLIDER_CROSS_SECTION,forUser:false,label:"Glider cross section",requiresData:true,category:"Charts"});var FIELD_TIME="time";var FIELD_DEPTH="depth";var FIELD_VALUE="value";var FIELD_SELECTEDFIELD="selectedfield";var TYPE_LATITUDE="latitude";var TYPE_LONGITUDE="longitude";var TYPE_TIME="time";var TYPE_VALUE="value";var TYPE_ELEVATION="elevation";var FUNC_MOVINGAVERAGE="movingAverage";var D3Util={foo:"bar",getAxis:function(a,b){var c;if(a==FIELD_TIME){c=d3.time.scale().range(b)}else{c=d3.scale.linear().range(b)}return c},getDataValue:function(c,a,b){var d;if(c.fieldIdx>=0){d=a.getData()[c.fieldIdx]}else{switch(c.type){case TYPE_TIME:d=new Date(a.getDate());break;case TYPE_ELEVATION:d=a.getElevation();break;case TYPE_LATITUDE:d=a.getLatitude();case TYPE_LONGITUDE:d=a.getLongitude();default:d=a.getData()[b]}}if(c.reverse==true){return -1*d}else{return d}},getColorFromColorBar:function(d,b){var a=["#00008B","#0000CD","#0000FF","#00FFFF","#7CFC00","#FFFF00","#FFA500","#FF4500","#FF0000","#8B0000"];var c=d3.scale.linear().domain([0,a.length-1]).range(b);var e=d3.scale.linear().range(a).domain(d3.range(0,a.length).map(c));color=e(d);return color},addColorBar:function(d,b,e,c){var a=d.append("g").attr({id:"colorBarG",transform:"translate("+(c-40)+",0)"});a.append("g").append("defs").append("linearGradient").attr({id:"colorBarGradient",x1:"0%",y1:"100%",x2:"0%",y2:"0%"}).selectAll("stop").data(b).enter().append("stop").attr({offset:function(g,f){return e*(f)+"%"},"stop-color":function(g,f){return b[f]},"stop-opacity":1});return a}};function RamaddaD3Display(e,d,b){testProperties=b;var c="svg";var a;RamaddaUtil.inherit(this,a=new RamaddaDisplay(e,d,"d3",b));addRamaddaDisplay(this);RamaddaUtil.defineMembers(this,{initDisplay:function(){this.initUI();this.setDisplayTitle(b.graph.title);var h=this.getProperty("innerWidth",600);var p=this.getProperty("innerHeight",300);var l={top:20,right:50,bottom:30,left:50};var k="height:"+p+"px;width:"+h+"px;";var m=HtmlUtil.div([ATTR_ID,this.getDomId(c),ATTR_STYLE,k],"");this.setContents(m);this.displayHeight=parseInt((d3.select("#"+this.getDomId(c)).style("height")).split("px")[0])-l.top-l.bottom;this.displayWidth=parseInt((d3.select("#"+this.getDomId(c)).style("width")).split("px")[0])-l.left-l.right;var g=this;var q=d3.behavior.zoom().on("zoom",function(){g.zoomBehaviour()});this.zoom=q;this.svg=d3.select("#"+this.getDomId(c)).append("svg").attr("width",this.displayWidth+l.left+l.right).attr("height",this.displayHeight+l.top+l.bottom).attr(ATTR_CLASS,"D3graph").call(q).on("click",function(){g.click(d3.event)}).on("dblclick",function(){g.dbclick(d3.event)}).append("g").attr("transform","translate("+l.left+","+l.top+")");this.x=D3Util.getAxis(b.graph.axis.x.type,[0,this.displayWidth-100]);this.y=D3Util.getAxis(b.graph.axis.y.type,[this.displayHeight,0]);this.xAxis=d3.svg.axis().scale(this.x).orient("bottom");this.yAxis=d3.svg.axis().scale(this.y).orient("left");this.svg.append("g").attr(ATTR_CLASS,"x axis").attr("transform","translate(0,"+this.displayHeight+")").call(this.xAxis);this.svg.append("g").attr(ATTR_CLASS,"y axis").call(this.yAxis);var f=["#00008B","#0000CD","#0000FF","#00FFFF","#7CFC00","#FFFF00","#FFA500","#FF4500","#FF0000","#8B0000"];var o=100/(f.length-1);var n=D3Util.addColorBar(this.svg,f,o,this.displayWidth);this.color=d3.scale.category10();this.updateUI()},needsData:function(){return true},initDialog:function(){this.addFieldsCheckboxes()},getDialogContents:function(){var f=this.getProperty(PROP_HEIGHT,"400");var g=HtmlUtil.div([ATTR_ID,this.getDomId(ID_FIELDS),ATTR_CLASS,"display-fields"]);g+=a.getDialogContents.apply(this);return g},fieldSelectionChanged:function(){this.updateUI()},updateUI:function(B){var D=false;if(!this.hasData()){return}test=this;var t=this.getSelectedFields();if(t.length==0){return}this.addFieldsCheckboxes();B=this.getData();if(B==null){console.log("no data");return}var v=B.getNumericFields();var z=B.getRecords();var h=RecordUtil.getRanges(v,z);var m=RecordUtil.getElevationRange(v,z);var l=(m[1]-m[0])*0.05;var p=this.x;var o=this.y;var w=this.color;var g=b.graph.axis;if(D){this.zoom.x(this.x);this.zoom.y(this.y)}else{this.x.domain(d3.extent(z,function(x){return D3Util.getDataValue(g.x,x,t[0].getIndex())}));this.y.domain(d3.extent(z,function(x){return D3Util.getDataValue(g.y,x,t[0].getIndex())}));this.zoom.x(this.x);this.zoom.y(this.y)}this.svg.selectAll(".y.axis").call(this.yAxis);this.svg.selectAll(".x.axis").call(this.xAxis);this.svg.selectAll(".line").remove();this.svg.selectAll(".legendElement").remove();var n=this;for(var C=0;C<t.length;C++){var E=t[C].getIndex();var u=h[E];var s=d3.svg.line().x(function(x){return p(D3Util.getDataValue(g.x,x,t[C].getIndex()))}).y(function(x){return o(D3Util.getDataValue(g.y,x,t[C].getIndex()))});displayLine=this.svg.append("path").datum(z).attr(ATTR_CLASS,"line").attr("d",s).on("mousemove",function(){n.mouseover(d3.event)}).attr("fill","none").attr("stroke",function(x){return w(C)}).attr("stroke-width","0.5px");if(b.graph.axis.z==FIELD_SELECTEDFIELD){displayLine.attr("stroke","url(#colorBarGradient)")}if(b.graph.derived!=null){var q=b.graph.derived.split(",");for(funcIdx=0;funcIdx<q.length;funcIdx++){var k=q[funcIdx];if(k==FUNC_MOVINGAVERAGE){var f=d3.svg.line().x(function(x){return p(D3Util.getDataValue(g.x,x,t[C].getIndex()))}).y(function(y,x){if(x==0){return _movingSum=D3Util.getDataValue(g.y,y,t[C].getIndex())}else{_movingSum+=D3Util.getDataValue(g.y,y,t[C].getIndex())}return o(_movingSum/x)}).interpolate("basis");this.svg.append("path").attr(ATTR_CLASS,"line").attr("d",f(z)).attr("fill","none").attr("stroke",function(x){return w(C)}).attr("stroke-width","1.5px").attr("viewBox","50 50 100 100 ").style("stroke-dasharray",("3, 3"))}else{console.log("Error: Unknown derived function:"+k)}}}this.svg.append("svg:rect").attr(ATTR_CLASS,"legendElement").attr("x",this.displayWidth-100).attr("y",(50+50*C)).attr("stroke",function(x){return w(C)}).attr("height",2).attr("width",40);this.svg.append("svg:text").attr(ATTR_CLASS,"legendElement").attr("x",this.displayWidth-100+40+10).attr("y",(55+55*C)).attr("stroke",function(x){return w(C)}).attr("style","font-size:50%").text(t[C].getLabel())}},zoomBehaviour:function(){this.updateUI(true)},handleEventRecordSelection:function(g,f){},mouseover:function(){testing=d3.event;console.log("mouseover")},click:function(f){console.log("click:"+f)},dbclick:function(f){this.zoom();this.updateUI()},getSVG:function(){return this.svg}})}function RamaddaD3LineChartDisplay(d,c,a){var b={};b.graph={title:"Line chart",derived:FUNC_MOVINGAVERAGE,axis:{y:{type:TYPE_VALUE,fieldname:FIELD_SELECTEDFIELD},x:{type:TYPE_TIME,fieldname:FIELD_TIME}}};a=$.extend(b,a);return new RamaddaD3Display(d,c,a)}function RamaddaProfileDisplay(d,c,a){var b={};b.graph={title:"Profile chart",derived:null,axis:{y:{type:TYPE_ELEVATION,fieldname:FIELD_DEPTH,fieldIdx:3,reverse:true},x:{type:TYPE_VALUE,fieldname:FIELD_VALUE}}};a=$.extend(b,a);return new RamaddaD3Display(d,c,a)}function RamaddaGliderCrossSectionDisplay(d,c,a){var b={};b.graph={title:"Glider cross section",derived:null,axis:{y:{type:TYPE_ELEVATION,fieldname:FIELD_DEPTH,reverse:true},x:{type:TYPE_TIME,fieldname:FIELD_TIME},z:FIELD_SELECTEDFIELD}};a=$.extend(b,a);return new RamaddaD3Display(d,c,a)}var DISPLAY_ENTRYLIST="entrylist";var DISPLAY_TESTLIST="testlist";var DISPLAY_ENTRYDISPLAY="entrydisplay";var DISPLAY_ENTRY_GALLERY="entrygallery";var DISPLAY_OPERANDS="operands";var DISPLAY_METADATA="metadata";var DISPLAY_TIMELINE="timeline";var DISPLAY_REPOSITORIES="repositories";var ID_RESULTS="results";var ID_ENTRIES="entries";var ID_DETAILS="details";var ID_DETAILS_INNER="detailsinner";var ID_PROVIDERS="providers";var ID_SEARCH_SETTINGS="searchsettings";var ATTR_ENTRYID="entryid";var ID_TREE_LINK="treelink";addGlobalDisplayType({type:DISPLAY_ENTRYLIST,label:"Entry List",requiresData:false,category:"Entry Displays"});addGlobalDisplayType({type:DISPLAY_TESTLIST,label:"Test  List",requiresData:false,category:"Entry Displays"});addGlobalDisplayType({type:DISPLAY_ENTRYDISPLAY,label:"Entry Display",requiresData:false,category:"Entry Displays"});addGlobalDisplayType({type:DISPLAY_ENTRY_GALLERY,label:"Entry Gallery",requiresData:false,category:"Entry Displays"});addGlobalDisplayType({type:DISPLAY_METADATA,label:"Metadata Table",requiresData:false,category:"Entry Displays"});function RamaddaEntryDisplay(k,b,h,g){var d;RamaddaUtil.inherit(this,d=new RamaddaDisplay(k,b,h,g));this.ramaddas=new Array();var e=this.getProperty("repositories",this.getProperty("repos",null));if(e!=null){var f=e.split(",");for(var c=0;c<f.length;c++){var l=f[c];l=l.trim();this.ramaddas.push(getRamadda(l))}if(this.ramaddas.length>0){var a=new RepositoryContainer("all","All entries");addRepository(a);for(var c=0;c<this.ramaddas.length;c++){a.addRepository(this.ramaddas[c])}this.ramaddas.push(a);this.setRamadda(this.ramaddas[0])}}RamaddaUtil.defineMembers(this,{searchSettings:new EntrySearchSettings({parent:g.entryParent,provider:g.provider,text:g.entryText,entryType:g.entryType,orderBy:g.orderBy}),entryList:g.entryList,entryMap:{},getSearchSettings:function(){if(this.providers!=null){var n=this.searchSettings.provider;var m=this.jq(ID_PROVIDERS).val();if(m!=null){n=m}this.searchSettings.provider=n}return this.searchSettings},getEntries:function(){if(this.entryList==null){return[]}return this.entryList.getEntries()}});if(g.entryType!=null){this.searchSettings.addType(g.entryType)}}function RamaddaSearcher(v,m,c,e){var g="-- None --";var k="textfield";var a="typefield";var l="typediv";var n="typefields";var q="metadatafield";var u="search";var h="form";var b="column";RamaddaUtil.initMembers(this,{showForm:true,showSearchSettings:true,showEntries:true,showType:true,doSearch:true,formOpen:true,fullForm:true,showMetadata:true,showToggle:true,showArea:true,showText:true,showDate:true,fields:null,formWidth:0,entriesWidth:0,types:null,entryTypes:null,metadataTypeList:[],showDetailsForGroup:false});var w;RamaddaUtil.inherit(this,w=new RamaddaEntryDisplay(v,m,c,e));var s=this.getProperty("metadataTypes","enum_tag:Tag");var o=s.split(",");for(var t=0;t<o.length;t++){var c=o[t];var f=c;var p=null;var d=c.split(":");if(d.length>1){c=d[0];if(d.length>=3){p=d[1];f=d[2]}else{f=d[1]}}this.metadataTypeList.push(new MetadataType(c,f,p))}RamaddaUtil.defineMembers(this,{haveSearched:false,haveTypes:false,metadata:{},metadataLoading:{},getDefaultHtml:function(){var C="";var y=this.isLayoutHorizontal();var F=this.getFooter();if(!this.getProperty("showFooter",true)){F=""}displayDebug=false;var z=[ATTR_ID,this.getDomId(ID_ENTRIES),ATTR_CLASS,this.getClass("content")];var x=this.getProperty("innerHeight",null);if(x==null){x=this.getProperty("entriesHeight",null)}if(x!=null){z.push(ATTR_STYLE);z.push("margin: 0px; padding: 0px;  min-height:"+x+"px; max-height:"+x+"px; overflow-y: auto;")}var D="";if(this.getProperty("showHeader",true)){D=HtmlUtil.div([ATTR_CLASS,"display-entries-results",ATTR_ID,this.getDomId(ID_RESULTS)],"&nbsp;")}var E=D+HtmlUtil.div(z,this.getLoadingMessage());if(y){C+=HtmlUtil.openTag(TAG_DIV,["class","row"]);var B=["class","col-md-12"];if(this.showForm){var G=[];if(this.formWidth===""){G=[]}else{if(this.formWidth!=0){G=[ATTR_WIDTH,this.formWidth]}}C+=HtmlUtil.tag(TAG_DIV,["class","col-md-4"],this.makeSearchForm());B=["class","col-md-8"]}if(this.showEntries){var G=[ATTR_WIDTH,"75%"];if(this.entriesWidth===""){G=[]}else{if(this.entriesWidth!=0){G=[ATTR_WIDTH,this.entriesWidth]}}C+=HtmlUtil.tag(TAG_DIV,B,E)}C+=HtmlUtil.closeTag("row");C+=HtmlUtil.openTag(TAG_DIV,["class","row"]);if(this.showForm){C+=HtmlUtil.tag(TAG_DIV,["class","col-md-6"],"")}if(this.showEntries){if(this.getProperty("showFooter",true)){C+=HtmlUtil.tag(TAG_DIV,["class","col-md-6"],F)}}C+=HtmlUtil.closeTag(TAG_DIV)}else{if(this.showForm){C+=this.makeSearchForm()}if(this.showEntries){C+=E;C+=F}}C+=HtmlUtil.div([ATTR_CLASS,"display-entry-popup",ATTR_ID,this.getDomId(ID_DETAILS)],"&nbsp;");return C},initDisplay:function(){var x=this;this.jq(u).button().click(function(B){x.submitSearchForm();B.preventDefault()});this.jq(k).autocomplete({source:function(B,C){}});this.jq(ID_REPOSITORY).selectBoxIt({});this.jq(ID_REPOSITORY).change(function(){var B=x.jq(ID_REPOSITORY).val();var C=getRamadda(B);x.setRamadda(C);x.addTypes(null);x.typeChanged()});this.jq(h).submit(function(B){x.submitSearchForm();B.preventDefault()});this.addTypes(this.entryTypes);for(var y=0;y<this.metadataTypeList.length;y++){var z=this.metadataTypeList[y];this.addMetadata(z,null)}if(!this.haveSearched){if(this.doSearch){this.submitSearchForm()}}},showEntryDetails:function(y,C,x,F){if(true){return}var E=this.getEntry(C);var z="#"+this.getDomId(ID_DETAILS+C);if(this.currentPopupEntry==E){this.hideEntryDetails(C);return}var D="right top";var G="right bottom";if(F){D="left top";G="left bottom"}this.currentPopupEntry=E;if(x==null){x=this.getDomId("entry_"+E.getIdForDom())}var H=HtmlUtil.onClick(this.getGet()+".hideEntryDetails('"+C+"');",HtmlUtil.image(ramaddaBaseUrl+"/icons/close.gif"));var B=this.getEntryHtml(E,{headerRight:H});$(z).html(B);$(z).show()},getResultsHeader:function(y){var E="Showing "+(this.searchSettings.skip+1)+"-"+(this.searchSettings.skip+Math.min(this.searchSettings.max,y.length));var x=[];var D=[];if(this.searchSettings.skip>0){x.push(HtmlUtil.onClick(this.getGet()+".loadPrevUrl();","Previous",[ATTR_CLASS,"display-link"]))}var C=false;if(y.length==this.searchSettings.getMax()){x.push(HtmlUtil.onClick(this.getGet()+".loadNextUrl();","Next",[ATTR_CLASS,"display-link"]));C=true}D.push(HtmlUtil.onClick(this.getGet()+".loadLess();",HtmlUtil.image(ramaddaBaseUrl+"/icons/minus-small-white.png",[ATTR_ALT,"View less",ATTR_TITLE,"View less","border","0"]),[ATTR_CLASS,"display-link"]));if(C){D.push(HtmlUtil.onClick(this.getGet()+".loadMore();",HtmlUtil.image(ramaddaBaseUrl+"/icons/plus-small-white.png",[ATTR_ALT,"View more",ATTR_TITLE,"View more","border","0"]),[ATTR_CLASS,"display-link"]))}var B="";var z="&nbsp;&nbsp;&nbsp;";B=E+z+HtmlUtil.join(x,"&nbsp;")+z+HtmlUtil.join(D,"&nbsp;");return B},submitSearchForm:function(){if(this.fixedEntries){return}this.haveSearched=true;var B=this.getSearchSettings();B.text=this.getFieldValue(this.getDomId(k),B.text);if(this.textRequired&&(B.text==null||B.text.trim().length==0)){this.writeHtml(ID_ENTRIES,"");return}if(this.haveTypes){B.entryType=this.getFieldValue(this.getDomId(a),B.entryType)}B.clearAndAddType(B.entryType);if(this.areaWidget){this.areaWidget.setSearchSettings(B)}if(this.dateRangeWidget){this.dateRangeWidget.setSearchSettings(B)}B.metadata=[];for(var y=0;y<this.metadataTypeList.length;y++){var x=this.metadataTypeList[y];var E=x.getValue();if(E==null){E=this.getFieldValue(this.getMetadataFieldId(x),null)}if(E!=null){B.metadata.push({type:x.getType(),value:E})}}var D=this.getRamadda();if(D.children){console.log("Searching  multiple ramaddas");this.entryList=new EntryListHolder(D,this);this.multiSearch={count:0};for(var y=0;y<D.children.length;y++){var C=D.children[y];var z=this.makeSearchUrl(C);this.updateForSearching(z);this.entryList.addEntryList(new EntryList(C,z,null,false));this.multiSearch.count++}this.entryList.doSearch(this)}else{this.multiSearch=null;var z=this.makeSearchUrl(this.getRamadda());console.log(z);this.entryList=new EntryList(this.getRamadda(),z,this,true);this.updateForSearching(z)}},handleSearchError:function(x,y){this.writeHtml(ID_ENTRIES,"");this.writeHtml(ID_RESULTS,"");console.log("Error performing search:"+y)},updateForSearching:function(x){var B=this.getRamadda().getSearchLinks(this.getSearchSettings());this.footerRight=B==null?"":"Links: "+HtmlUtil.join(B," - ");this.writeHtml(ID_FOOTER_RIGHT,this.footerRight);var z=this.searchMessage;if(z==null){z=this.getRamadda().getSearchMessage()}var y=this.getSearchSettings().provider;if(y!=null){z=null;if(this.providerMap!=null){z=this.providerMap[y]}if(z==null){z=y}z="Searching "+z}this.showMessage(z,HtmlUtil.div([ATTR_STYLE,"margin:20px;"],this.getWaitImage()));this.hideEntryDetails()},showMessage:function(y,x){this.writeHtml(ID_RESULTS,y);this.writeHtml(ID_ENTRIES,x)},prepareToLayout:function(){w.prepareToLayout.apply(this);this.savedValues={};var B=this.getSearchableColumns();for(var y=0;y<B.length;y++){var x=B[y];var C=this.getDomId(b+x.getName());var z=$("#"+C).val();if(z==null||z.length==0){continue}this.savedValues[C]=z}},makeSearchUrl:function(C){var x="";var E=this.getSearchableColumns();for(var z=0;z<E.length;z++){var y=E[z];var D=this.jq(b+y.getName()).val();if(D==null||D.length==0){continue}x+="&"+y.getSearchArg()+"="+encodeURI(D)}this.getSearchSettings().setExtra(x);var B=C.getSearchUrl(this.getSearchSettings(),OUTPUT_JSON);return B},makeSearchForm:function(){var z=HtmlUtil.openTag("form",[ATTR_ID,this.getDomId(h),"action","#"]);var B="";var L=this.getSearchSettings().text;if(L==null){var C=Utils.getUrlArgs(document.location.search);L=C.text}if(L==null){L=""}var F="search text";if(this.eg){F=this.eg}var N=HtmlUtil.input("",L,["placeholder",F,ATTR_CLASS,"display-search-input",ATTR_SIZE,"30",ATTR_ID,this.getDomId(k)]);var K=HtmlUtil.image(ramaddaBaseUrl+"/icons/magnifier.png",[ATTR_BORDER,"0",ATTR_TITLE,"Search"]);var H=[];var B="";B+=HtmlUtil.formTable();if(this.showArea){this.areaWidget=new AreaWidget(this);B+=HtmlUtil.formEntry("Area:",this.areaWidget.getHtml())}var ac=HtmlUtil.div([ATTR_ID,this.getDomId(u),ATTR_CLASS,"display-button"],K);if(this.ramaddas.length>0){var P=HtmlUtil.openTag(TAG_SELECT,[ATTR_ID,this.getDomId(ID_REPOSITORY),ATTR_CLASS,"display-repositories-select"]);var Y=ramaddaBaseUrl+"/icons/favicon.png";for(var V=0;V<this.ramaddas.length;V++){var ad=this.ramaddas[V];var S=[ATTR_TITLE,"",ATTR_VALUE,ad.getId(),"data-iconurl",Y];if(this.getRamadda().getId()==ad.getId()){S.push("selected");S.push(null)}var I=P+=HtmlUtil.tag(TAG_OPTION,S,ad.getName())}P+=HtmlUtil.closeTag(TAG_SELECT);H.push(P)}this.providerMap={};if(this.providers!=null){var E="";var Q=Utils.getUrlArgs(document.location.search).provider;var R=this.providers.split(",");var G=null;var X={};var J=[];for(var V=0;V<R.length;V++){var M=R[V].split(":");var O=M[0];O=O.replace(/_COLON_/g,":");var I=M.length>1?M[1]:O;if(I.length>40){I=I.substring(0,39)+"..."}this.providerMap[O]=I;var W="";if(O==Q){W+=" selected "}var U="";if(M.length>3){U=M[3]}var aa=X[U];if(aa==null){J.push(U);X[U]="";aa=""}if(M.length>2){var ae=M[2];ae=ae.replace(/\${urlroot}/g,ramaddaBaseUrl);ae=ae.replace(/\${root}/g,ramaddaBaseUrl);W+=' data-iconurl="'+ae+'" '}aa+="<option "+W+' value="'+O+'">'+I+"</option>\n";X[U]=aa}for(var y=0;y<J.length;y++){var U=J[y];if(U!=""){E+='<optgroup label="'+U+'">\n'}E+=X[U];if(U!=""){E+="</optgroup>"}}H.push(HtmlUtil.tag("select",["id",this.getDomId(ID_PROVIDERS),ATTR_CLASS,"display-search-providers"],E))}if(this.showType){H.push(HtmlUtil.span([ATTR_ID,this.getDomId(l)],HtmlUtil.span([ATTR_CLASS,"display-loading"],"Loading types...")))}if(this.showText){H.push(N)}var Z=this.isLayoutHorizontal();if(Z){var ab=HtmlUtil.join(H,"<br>");z+="<table><tr valign=top><td>"+ac+"</td><td>"+ab+"</td></tr></table>"}else{z+=ac+" "+HtmlUtil.join(H," ")}if(this.showDate){this.dateRangeWidget=new DateRangeWidget(this);B+=HtmlUtil.formEntry("Date Range:",this.dateRangeWidget.getHtml())}if(this.showMetadata){for(var V=0;V<this.metadataTypeList.length;V++){var D=this.metadataTypeList[V];var T=D.getValue();var x;if(T!=null){x=T}else{x=HtmlUtil.tag(TAG_SELECT,[ATTR_ID,this.getMetadataFieldId(D),ATTR_CLASS,"display-metadatalist"],HtmlUtil.tag(TAG_OPTION,[ATTR_TITLE,"",ATTR_VALUE,""],g))}B+=HtmlUtil.formEntry(D.getLabel()+":",x)}}B+=HtmlUtil.closeTag(TAG_TABLE);B+=HtmlUtil.div([ATTR_ID,this.getDomId(n)],"");if(this.showSearchSettings){var O=this.getDomId(ID_SEARCH_SETTINGS);if(this.showToggle){z+=HtmlUtil.div([ATTR_CLASS,"display-search-extra",ATTR_ID,O],HtmlUtil.toggleBlock("Search Settings",HtmlUtil.div([ATTR_CLASS,"display-search-extra-inner"],B),this.formOpen))}else{z+=HtmlUtil.div([ATTR_CLASS,"display-search-extra",ATTR_ID,O],HtmlUtil.div([ATTR_CLASS,"display-search-extra-inner"],B))}}z+='<input type="submit" style="position:absolute;left:-9999px;width:1px;height:1px;"/>';z+=HtmlUtil.closeTag("form");return z},handleEventMapBoundsChanged:function(y,x){if(this.areaWidget){this.areaWidget.handleEventMapBoundsChanged(y,x)}},typeChanged:function(){var x=this.getSearchSettings();x.skip=0;x.max=50;x.entryType=this.getFieldValue(this.getDomId(a),x.entryType);x.clearAndAddType(x.entryType);this.addExtraForm();this.submitSearchForm()},addMetadata:function(z,C){if(C==null){C=this.metadata[z.getType()]}if(C==null){var H=this;if(!this.metadataLoading[z.getType()]){this.metadataLoading[z.getType()]=true;C=this.getRamadda().getMetadataCount(z,function(I,J){H.addMetadata(I,J)})}}if(C==null){return}this.metadata[z.getType()]=C;var E=HtmlUtil.tag(TAG_OPTION,[ATTR_TITLE,"",ATTR_VALUE,""],g);for(var y=0;y<C.length;y++){var B=C[y].count;var G=C[y].value;var D=C[y].label;var F=[ATTR_VALUE,G,ATTR_CLASS,"display-metadatalist-item"];var x=false;if(x){F.push("selected");F.push(null)}E+=HtmlUtil.tag(TAG_OPTION,F,D+" ("+B+")")}$("#"+this.getMetadataFieldId(z)).html(E)},getMetadataFieldId:function(x){var y=x.getType();y=y.replace(".","_");return this.getDomId(q+y)},findEntryType:function(x){if(this.entryTypes==null){return null}for(var y=0;y<this.entryTypes.length;y++){var z=this.entryTypes[y];if(z.getId()==x){return z}}return null},addTypes:function(K){if(K==null){var L=this;K=this.getRamadda().getEntryTypes(function(O,N){L.addTypes(N)})}if(K==null){return}this.entryTypes=K;if(this.types){var B={};var y=this.types.split(",");for(var C=0;C<y.length;C++){var F=y[C];B[F]=true}var D=[];for(var C=0;C<this.entryTypes.length;C++){var F=this.entryTypes[C];if(B[F.getId()]){D.push(F)}else{if(F.getCategory()!=null&&B[F.getCategory()]){D.push(F)}}}this.entryTypes=D}this.haveTypes=true;var M=[];var J={};var H=HtmlUtil.openTag(TAG_SELECT,[ATTR_ID,this.getDomId(a),ATTR_CLASS,"display-typelist","onchange",this.getGet()+".typeChanged();"]);H+=HtmlUtil.tag(TAG_OPTION,[ATTR_TITLE,"",ATTR_VALUE,""],"Any Type");for(var C=0;C<this.entryTypes.length;C++){var F=this.entryTypes[C];var G=F.getIcon();var I=[ATTR_TITLE,F.getLabel(),ATTR_VALUE,F.getId(),ATTR_CLASS,"display-typelist-type","data-iconurl",G];var z=this.getSearchSettings().hasType(F.getId());if(z){I.push("selected");I.push(null)}var E=HtmlUtil.tag(TAG_OPTION,I,F.getLabel()+" ("+F.getEntryCount()+")");var x=J[F.getCategory()];if(x==null){J[F.getCategory()]=HtmlUtil.tag(TAG_OPTION,[ATTR_CLASS,"display-typelist-category",ATTR_TITLE,"",ATTR_VALUE,""],F.getCategory());M.push(F.getCategory())}J[F.getCategory()]+=E}for(var C in M){H+=J[M[C]]}H+=HtmlUtil.closeTag(TAG_SELECT);this.writeHtml(l,H);this.jq(a).selectBoxIt({});this.addExtraForm()},getSelectedType:function(){if(this.entryTypes==null){return null}for(var x=0;x<this.entryTypes.length;x++){var y=this.entryTypes[x];if(y.getId){if(this.getSearchSettings().hasType(y.getId())){return y}}}return null},getSearchableColumns:function(){var z=[];var B=this.getSelectedType();if(B==null){return z}var C=B.getColumns();if(C==null){return z}for(var y=0;y<C.length;y++){var x=C[y];if(!x.getCanSearch()){continue}z.push(x)}return z},addExtraForm:function(){if(this.savedValues==null){this.savedValues={}}var C="";var F=this.getSearchableColumns();for(var D=0;D<F.length;D++){var B=F[D];if(this.fields!=null&&this.fields.indexOf(B.getName())<0){continue}if(C.length==0){C+=HtmlUtil.formTable()}var H="";var z=this.getDomId(b+B.getName());var y=this.savedValues[z];if(y==null){y=this.jq(b+B.getName()).val()}if(y==null){y=""}if(B.isEnumeration()){H=HtmlUtil.openTag(TAG_SELECT,[ATTR_ID,z,ATTR_CLASS,"display-menu"]);H+=HtmlUtil.tag(TAG_OPTION,[ATTR_TITLE,"",ATTR_VALUE,""],"-- Select --");var J=B.getValues();for(var x in J){var I=J[x].value;var G=J[x].label;var E="";if(I==y){E=" selected "}H+=HtmlUtil.tag(TAG_OPTION,[ATTR_TITLE,G,ATTR_VALUE,I,E,null],G)}H+=HtmlUtil.closeTag(TAG_SELECT)}else{H=HtmlUtil.input("",y,[ATTR_CLASS,"input",ATTR_SIZE,"15",ATTR_ID,z])}C+=HtmlUtil.formEntry(B.getLabel()+":",H+" "+B.getSuffix())}if(C.length>0){C+=HtmlUtil.closeTag(TAG_TABLE)}this.writeHtml(n,C);$(".display-menu").selectBoxIt({})},getEntries:function(){if(this.entryList==null){return[]}return this.entryList.getEntries()},loadNextUrl:function(){this.getSearchSettings().skip+=this.getSearchSettings().max;this.submitSearchForm()},loadMore:function(){this.getSearchSettings().max=this.getSearchSettings().max+=50;this.submitSearchForm()},loadLess:function(){var x=this.getSearchSettings().max;x=parseInt(0.75*x);this.getSearchSettings().max=Math.max(1,x);this.submitSearchForm()},loadPrevUrl:function(){this.getSearchSettings().skip=Math.max(0,this.getSearchSettings().skip-this.getSearchSettings().max);this.submitSearchForm()},entryListChanged:function(x){this.entryList=x}})}function RamaddaEntrylistDisplay(e,d,b,c){var a;if(c==null){c=DISPLAY_ENTRYLIST}RamaddaUtil.inherit(this,a=new RamaddaSearcher(e,d,DISPLAY_ENTRYLIST,b));addRamaddaDisplay(this);RamaddaUtil.defineMembers(this,{haveDisplayed:false,selectedEntries:[],getSelectedEntries:function(){return this.selectedEntries},initDisplay:function(){var f=this;if(this.getIsLayoutFixed()&&this.haveDisplayed){return}this.haveDisplayed=true;this.initUI();this.setContents(this.getDefaultHtml());if(this.dateRangeWidget){this.dateRangeWidget.initHtml()}a.initDisplay.apply(this);if(this.entryList!=null&&this.entryList.haveLoaded){this.entryListChanged(this.entryList)}this.jq(ID_PROVIDERS).selectBoxIt({});this.jq(ID_PROVIDERS).change(function(){f.providerChanged()})},providerChanged:function(){var f=this.jq(ID_PROVIDERS).val();if(f!="this"){this.jq(ID_SEARCH_SETTINGS).hide()}else{this.jq(ID_SEARCH_SETTINGS).show()}},getMenuItems:function(g){a.getMenuItems.apply(this,g);if(this.getSelectedEntriesFromTree().length>0){var f=this.getGet();g.push(HtmlUtil.onClick(f+".makeDisplayList();","Make List"));g.push(HtmlUtil.onClick(f+".makeDisplayGallery();","Make Gallery"))}},makeDisplayList:function(){var f=this.getSelectedEntriesFromTree();if(f.length==0){return}var g={selectedEntries:f,showForm:false,showMenu:true,fixedEntries:true};g.entryList=new EntryList(this.getRamadda(),"",this,false);g.entryList.setEntries(f);this.getDisplayManager().createDisplay(DISPLAY_ENTRYLIST,g)},makeDisplayGallery:function(){var f=this.getSelectedEntriesFromTree();if(f.length==0){return}var g={selectedEntries:f};this.getDisplayManager().createDisplay(DISPLAY_ENTRY_GALLERY,g)},handleEventEntrySelection:function(g,f){this.selectEntry(f.entry,f.selected)},selectEntry:function(h,g){var k=false;if(g){this.jq("entry_"+h.getIdForDom()).addClass("ui-selected");var f=this.selectedEntries.indexOf(h);if(f<0){this.selectedEntries.push(h);k=true}}else{this.jq("entry_"+h.getIdForDom()).removeClass("ui-selected");var f=this.selectedEntries.indexOf(h);if(f>=0){this.selectedEntries.splice(f,1);k=true}}},makeEntriesDisplay:function(f){return this.getEntriesTree(f)},entryListChanged:function(m){if(this.multiSearch){this.multiSearch.count--}a.entryListChanged.apply(this,[m]);var f=this.entryList.getEntries();if(f.length==0){this.getSearchSettings().skip=0;this.getSearchSettings().max=50;var l="Nothing found";if(this.multiSearch){if(this.multiSearch.count>0){l="Nothing found so far. Still searching "+this.multiSearch.count+" repositories"}else{}}this.writeHtml(ID_ENTRIES,this.getMessage(l));this.writeHtml(ID_FOOTER_LEFT,"");this.writeHtml(ID_RESULTS,"&nbsp;");this.getDisplayManager().handleEventEntriesChanged(this,[]);return}this.writeHtml(ID_RESULTS,this.getResultsHeader(f));var g=this.getGet();this.writeHtml(ID_FOOTER_LEFT,"");if(this.footerRight!=null){this.writeHtml(ID_FOOTER_RIGHT,this.footerRight)}var k=this.makeEntriesDisplay(f);var h="";h+=HtmlUtil.openTag(TAG_OL,[ATTR_CLASS,this.getClass("list"),ATTR_ID,this.getDomId(ID_LIST)]);h+=k;h+=HtmlUtil.closeTag(TAG_OL);this.writeHtml(ID_ENTRIES,h);this.addEntrySelect();this.getDisplayManager().handleEventEntriesChanged(this,f)}})}function RamaddaTestlistDisplay(d,c,b){var a;RamaddaUtil.inherit(this,a=new RamaddaEntrylistDisplay(d,c,b,DISPLAY_TESTLIST));RamaddaUtil.defineMembers(this,{makeEntriesDisplay:function(e){return"Overridden display<br>"+this.getEntriesTree(e)}})}var RamaddaListDisplay=RamaddaEntrylistDisplay;function RamaddaEntrygalleryDisplay(e,d,b){var c="gallery";var a;RamaddaUtil.inherit(this,a=new RamaddaEntryDisplay(e,d,DISPLAY_ENTRY_GALLERY,b));addRamaddaDisplay(this);RamaddaUtil.defineMembers(this,{entries:b.entries,initDisplay:function(){this.initUI();var f=HtmlUtil.div([ATTR_ID,this.getDomId(c)],"Gallery");this.setContents(f);if(this.selectedEntries!=null){this.jq(c).html(this.getEntriesGallery(this.selectedEntries))}if(this.entryList!=null&&this.entryList.haveLoaded){this.entryListChanged(this.entryList)}},getEntriesGallery:function(k){var p="";var h="";var q=0;var n=[];for(var g=0;g<k.length;g++){var o=k[g];if(o.isImage()){n.push(o);var m=HtmlUtil.tag(TAG_A,[ATTR_HREF,o.getEntryUrl()],o.getName());q++;h+=HtmlUtil.tag(TAG_IMG,["src",o.getResourceUrl(),ATTR_WIDTH,"500",ATTR_ID,this.getDomId("entry_"+o.getIdForDom()),ATTR_ENTRYID,o.getId(),ATTR_CLASS,"display-entrygallery-entry"])+"<br>"+m+"<p>"}else{var l=o.getIconImage([ATTR_TITLE,"View entry"]);var m=HtmlUtil.tag(TAG_A,[ATTR_HREF,o.getEntryUrl()],l+" "+o.getName());p+=m+"<br>"}}if(q>1){var f="";for(var g=0;g<n.length;g++){var o=n[g];var m=HtmlUtil.tag(TAG_A,[ATTR_HREF,o.getEntryUrl()],o.getName());f+=HtmlUtil.tag(TAG_IMG,["src",o.getResourceUrl(),ATTR_WIDTH,"500",ATTR_ID,this.getDomId("entry_"+o.getIdForDom()),ATTR_ENTRYID,o.getId(),ATTR_CLASS,"display-entrygallery-entry"])+"<br>"+m+"<p>"}h=f}if(p!=""){if(q>0){h+="<hr>"}h+=p}return h}})}function RamaddaMetadataDisplay(d,c,b){if(b.formOpen==null){b.formOpen=false}var a;RamaddaUtil.inherit(this,a=new RamaddaSearcher(d,c,DISPLAY_METADATA,b));addRamaddaDisplay(this);RamaddaUtil.defineMembers(this,{haveDisplayed:false,initDisplay:function(){this.initUI();this.setContents(this.getDefaultHtml());a.initDisplay.apply(this);if(this.haveDisplayed&&this.entryList){this.entryListChanged(this.entryList)}this.haveDisplayed=true},entryListChanged:function(q){this.entryList=q;var B=this.entryList.getEntries();if(B.length==0){this.writeHtml(ID_ENTRIES,"Nothing found");this.writeHtml(ID_RESULTS,"&nbsp;");return}var k=[];var p={};var P={};for(var L=0;L<B.length;L++){var f=B[L];var z=f.getMetadata();for(var K=0;K<z.length;K++){var H=z[K];if(P[H.type]==null){P[H.type]="";k.push(H.type)}p[z[K].type]=z[K].label}}var y="";y+=HtmlUtil.openTag(TAG_TABLE,[ATTR_CLASS,"display-metadata-table",ATTR_WIDTH,"100%","cellpadding","5","cellspacing","0"]);var h=this.findEntryType(this.searchSettings.entryType);var x="Entry";if(h!=null){x=h.getLabel()}this.writeHtml(ID_RESULTS,this.getResultsHeader(B));var D=null;var g=this.getProperty("metadataTypes",null);if(g!=null){D=g.split(",")}else{D=k;D.sort()}var G={"content.pagestyle":true,"content.pagetemplate":true,"content.sort":true,"spatial.polygon":true};var o=[];o.push(HtmlUtil.th([ATTR_CLASS,"display-metadata-table-cell"],HtmlUtil.b(x)));for(var L=0;L<D.length;L++){var h=D[L];if(G[h]){continue}var w=p[D[L]];if(w==null){w=D[L]}o.push(HtmlUtil.th([ATTR_CLASS,"display-metadata-table-cell"],HtmlUtil.b(w)))}var M=HtmlUtil.tr(["valign","bottom"],HtmlUtil.join(o,""));y+=M;var E="<div class=display-metadata-divider></div>";var J=this.missingMessage;if(J=null){J="&nbsp;"}for(var s=0;s<B.length;s++){var f=B[s];var z=f.getMetadata();var u=[];var t=this.getDomId("entrylink"+f.getIdForDom());var v=f.getLink(f.getIconImage()+" "+f.getName());u.push(HtmlUtil.td([ATTR_CLASS,"display-metadata-table-cell"],HtmlUtil.div([ATTR_CLASS,"display-metadata-entrylink"],v)));for(var l=0;l<D.length;l++){var O=D[l];if(G[O]){continue}var e=null;for(var K=0;K<z.length;K++){var H=z[K];if(H.type==O){var N=null;if(H.type=="content.thumbnail"||H.type=="content.logo"){var n=this.getRamadda().getRoot()+"/metadata/view/"+H.value.attr1+"?element=1&entryid="+f.getId()+"&metadata.id="+H.id;N=HtmlUtil.image(n,[ATTR_WIDTH,"100"])}else{if(H.type=="content.url"||H.type=="dif.related_url"){var w=H.value.attr2;if(w==null||w==""){w=H.value.attr1}N=HtmlUtil.href(H.value.attr1,w)}else{if(H.type=="content.attachment"){var F=H.value.attr1.split("_file_");var I=F[1];var n=this.getRamadda().getRoot()+"/metadata/view/"+H.value.attr1+"?element=1&entryid="+f.getId()+"&metadata.id="+H.id;N=HtmlUtil.href(n,I)}else{N=H.value.attr1;if(H.value.attr2&&H.value.attr2.trim().length>0){N+=" - "+H.value.attr2}}}}if(N!=null){if(e==null){e=""}else{e+=E}e+=HtmlUtil.div([ATTR_CLASS,"display-metadata-item"],N)}}}if(e==null){e=J}if(e==null){e=""}var C=HtmlUtil.tag(TAG_A,[ATTR_STYLE,"color:#000;",ATTR_HREF,this.getRamadda().getRoot()+"/metadata/addform?entryid="+f.getId()+"&metadata.type="+O,"target","_blank","alt","Add metadata",ATTR_TITLE,"Add metadata"],"+");C=HtmlUtil.div(["class","display-metadata-table-add"],C);var Q=C+E;if(e.length>0){Q+=e}u.push(HtmlUtil.td([ATTR_CLASS,"display-metadata-table-cell"],HtmlUtil.div([ATTR_CLASS,"display-metadata-table-cell-contents"],Q)))}y+=HtmlUtil.tr(["valign","top"],HtmlUtil.join(u,""));if(((s+1)%10)==0){y+=M}}y+=HtmlUtil.closeTag(TAG_TABLE);this.jq(ID_ENTRIES).html(y)}})}function RamaddaTimelineDisplay(d,c,b){if(b.formOpen==null){b.formOpen=false}var a;RamaddaUtil.inherit(this,a=new RamaddaSearcher(d,c,DISPLAY_TIMELINE,b));addRamaddaDisplay(this);RamaddaUtil.defineMembers(this,{initDisplay:function(){this.initUI();this.setContents(this.getDefaultHtml());a.initDisplay.apply(this)},entryListChanged:function(l){this.entryList=l;var e=this.entryList.getEntries();var g="";if(e.length==0){this.writeHtml(ID_ENTRIES,"Nothing found");this.writeHtml(ID_RESULTS,"&nbsp;");return}var k={timeline:{headline:"The Main Timeline Headline Goes here",type:"default",text:"<p>Intro body text goes here, some HTML is ok</p>",asset:{media:"http://yourdomain_or_socialmedialink_goes_here.jpg",credit:"Credit Name Goes Here",caption:"Caption text goes here"},date:[{startDate:"2011,12,10",endDate:"2011,12,11",headline:"Headline Goes Here",text:"<p>Body text goes here, some HTML is OK</p>",tag:"This is Optional",classname:"optionaluniqueclassnamecanbeaddedhere",asset:{media:"http://twitter.com/ArjunaSoriano/status/164181156147900416",thumbnail:"optional-32x32px.jpg",credit:"Credit Name Goes Here",caption:"Caption text goes here"}},{startDate:"2012,12,10",endDate:"2012,12,11",headline:"Headline Goes Here",text:"<p>Body text goes here, some HTML is OK</p>",tag:"This is Optional",classname:"optionaluniqueclassnamecanbeaddedhere",asset:{media:"http://twitter.com/ArjunaSoriano/status/164181156147900416",thumbnail:"optional-32x32px.jpg",credit:"Credit Name Goes Here",caption:"Caption text goes here"}},{startDate:"2013,12,10",endDate:"2013,12,11",headline:"Headline Goes Here",text:"<p>Body text goes here, some HTML is OK</p>",tag:"This is Optional",classname:"optionaluniqueclassnamecanbeaddedhere",asset:{media:"http://twitter.com/ArjunaSoriano/status/164181156147900416",thumbnail:"optional-32x32px.jpg",credit:"Credit Name Goes Here",caption:"Caption text goes here"}}],era:[{startDate:"2011,12,10",endDate:"2011,12,11",headline:"Headline Goes Here",text:"<p>Body text goes here, some HTML is OK</p>",tag:"This is Optional"}]}};for(var f=0;f<e.length;f++){var h=e[f]}createStoryJS({type:"timeline",width:"800",height:"600",source:k,embed_id:this.getDomId(ID_ENTRIES)})}})}function RamaddaEntrydisplayDisplay(f,e,b){var a;$.extend(this,{sourceEntry:b.sourceEntry});RamaddaUtil.inherit(this,a=new RamaddaDisplay(f,e,DISPLAY_ENTRYDISPLAY,b));if(b.sourceEntry==null&&b.entryId!=null){var d=this;var c=function(g){var h=g[0];d.sourceEntry=h;d.initDisplay()};b.sourceEntry=this.getEntry(b.entryId,c)}addRamaddaDisplay(this);$.extend(this,{selectedEntry:null,initDisplay:function(){this.initUI();var h=this.title;if(this.sourceEntry!=null){this.addEntryHtml(this.sourceEntry);var g=this.sourceEntry.getEntryUrl();if(h==null){h=this.sourceEntry.getName()}h=HtmlUtil.tag("a",["href",g,"title",this.sourceEntry.getName(),"alt",this.sourceEntry.getName()],h)}else{this.addEntryHtml(this.selectedEntry);if(h==null){h="Entry Display"}}this.setDisplayTitle(h)},handleEventEntrySelection:function(l,g){if(this.sourceEntry!=null){return}var h=g.selected;var k=g.entry;if(!h){if(this.selectedEntry!=k){return}this.selectedEntry=null;this.setContents("");return}this.selectedEntry=k;this.addEntryHtml(this.selectedEntry)},getEntries:function(){return[this.sourceEntry]},addEntryHtml:function(h){if(h==null){this.setContents("&nbsp;");return}var g=this.getEntryHtml(h,{showHeader:false});this.setContents(g);this.entryHtmlHasBeenDisplayed(h)}})}function RamaddaOperandsDisplay(g,f,c){var d=TAG_SELECT;var b="select1";var a="select2";var e="newdisplay";$.extend(this,new RamaddaEntryDisplay(g,f,DISPLAY_OPERANDS,c));addRamaddaDisplay(this);$.extend(this,{baseUrl:null,initDisplay:function(){this.initUI();this.baseUrl=this.getRamadda().getSearchUrl(this.searchSettings,OUTPUT_JSON);if(this.entryList==null){this.entryList=new EntryList(this.getRamadda(),jsonUrl,this)}var h="";h+=HtmlUtil.div([ATTR_ID,this.getDomId(ID_ENTRIES),ATTR_CLASS,this.getClass("entries")],"");this.setContents(h)},entryListChanged:function(h){var n="<form>";n+="<p>";n+=HtmlUtil.openTag(TAG_TABLE,[ATTR_CLASS,"formtable","cellspacing","0","cellspacing","0"]);var o=this.entryList.getEntries();var k=this.getGet();for(var l=1;l<=2;l++){var q=HtmlUtil.openTag(TAG_SELECT,[ATTR_ID,this.getDomId(d+l)]);q+=HtmlUtil.tag(TAG_OPTION,[ATTR_TITLE,"",ATTR_VALUE,""],"-- Select --");for(var m=0;m<o.length;m++){var s=o[m];var p=s.getIconImage()+" "+s.getName();q+=HtmlUtil.tag(TAG_OPTION,[ATTR_TITLE,s.getName(),ATTR_VALUE,s.getId()],s.getName())}q+=HtmlUtil.closeTag(TAG_SELECT);n+=HtmlUtil.formEntry("Data:",q)}var q=HtmlUtil.openTag(TAG_SELECT,[ATTR_ID,this.getDomId(ID_CHARTTYPE)]);q+=HtmlUtil.tag(TAG_OPTION,[ATTR_TITLE,"",ATTR_VALUE,"linechart"],"Line chart");q+=HtmlUtil.tag(TAG_OPTION,[ATTR_TITLE,"",ATTR_VALUE,"barchart"],"Bar chart");q+=HtmlUtil.tag(TAG_OPTION,[ATTR_TITLE,"",ATTR_VALUE,"barstack"],"Stacked bars");q+=HtmlUtil.tag(TAG_OPTION,[ATTR_TITLE,"",ATTR_VALUE,"bartable"],"Bar table");q+=HtmlUtil.tag(TAG_OPTION,[ATTR_TITLE,"",ATTR_VALUE,"piechart"],"Pie chart");q+=HtmlUtil.tag(TAG_OPTION,[ATTR_TITLE,"",ATTR_VALUE,"scatterplot"],"Scatter Plot");q+=HtmlUtil.closeTag(TAG_SELECT);n+=HtmlUtil.formEntry("Chart Type:",q);n+=HtmlUtil.closeTag(TAG_TABLE);n+="<p>";n+=HtmlUtil.tag(TAG_DIV,[ATTR_CLASS,"display-button",ATTR_ID,this.getDomId(e)],"New Chart");n+="<p>";n+="</form>";this.writeHtml(ID_ENTRIES,n);var t=this;this.jq(e).button().click(function(u){t.createDisplay()})},createDisplay:function(){var o=this.getEntry(this.jq(b).val());var n=this.getEntry(this.jq(a).val());if(o==null){alert("No data selected");return}var m=[];m.push(new PointData(o.getName(),null,null,ramaddaBaseUrl+"/entry/show?&output=points.product&product=points.json&numpoints=1000&entryid="+o.getId()));if(n!=null){m.push(new PointData(n.getName(),null,null,ramaddaBaseUrl+"/entry/show?&output=points.product&product=points.json&numpoints=1000&entryid="+n.getId()))}var k="average";var l=new DerivedPointData(this.displayManager,"Derived Data",m,k);var h=l;var p=this.jq(ID_CHARTTYPE).val();g.createDisplay(p,{layoutFixed:false,data:h})}})}function RamaddaRepositoriesDisplay(c,b,a){RamaddaUtil.inherit(this,new RamaddaEntryDisplay(c,b,DISPLAY_REPOSITORIES,a));addRamaddaDisplay(this);RamaddaUtil.defineMembers(this,{initDisplay:function(){var d=this;this.initUI();var g="";if(this.ramaddas.length==0){g+=this.getMessage("No repositories specified")}else{g+=this.getMessage("Loading repository listing")}this.numberWithTypes=0;this.finishedInitDisplay=false;if(this.ramaddas.length>1){if(this.ramaddas[this.ramaddas.length-1].getRoot()=="all"){this.ramaddas.splice(this.ramaddas.length-1,1)}}for(var f=0;f<this.ramaddas.length;f++){if(f==0){}var h=this.ramaddas[f];var e=h.getEntryTypes(function(l,k){d.gotTypes(l,k)});if(e!=null){this.numberWithTypes++}}this.setDisplayTitle("Repositories");this.setContents(g);this.finishedInitDisplay=true;this.displayRepositories()},displayRepositories:function(){if(!this.finishedInitDisplay||this.numberWithTypes!=this.ramaddas.length){return}var z={};var u=[];var v="";v+=HtmlUtil.openTag(TAG_TABLE,[ATTR_CLASS,"display-repositories-table",ATTR_WIDTH,"100%",ATTR_BORDER,"1","cellspacing","0","cellpadding","5"]);for(var y=0;y<this.ramaddas.length;y++){var B=this.ramaddas[y];var w=B.getEntryTypes();for(var p=0;p<w.length;p++){var f=w[p];if(z[f.getId()]==null){z[f.getId()]=f;u.push(f)}}}v+=HtmlUtil.openTag(TAG_TR,["valign","bottom"]);v+=HtmlUtil.th([ATTR_CLASS,"display-repositories-table-header"],"Type");for(var y=0;y<this.ramaddas.length;y++){var B=this.ramaddas[y];var l=HtmlUtil.href(B.getRoot(),B.getName());v+=HtmlUtil.th([ATTR_CLASS,"display-repositories-table-header"],l)}v+="</tr>";var o=[];if(this.categories!=null){o=this.categories.split(",")}var t={};var s=[];for(var p=0;p<u.length;p++){var f=u[p];var k="";k+="<tr>";k+=HtmlUtil.td([],HtmlUtil.image(f.getIcon())+" "+f.getLabel());for(var y=0;y<this.ramaddas.length;y++){var B=this.ramaddas[y];var d=B.getEntryType(f.getId());var g="";if(d==null){k+=HtmlUtil.td([ATTR_CLASS,"display-repositories-table-type-hasnot"],"")}else{var n=HtmlUtil.tag(TAG_A,["href",B.getRoot()+"/search/type/"+d.getId(),"target","_blank"],d.getEntryCount());k+=HtmlUtil.td([ATTR_ALIGN,"right",ATTR_CLASS,"display-repositories-table-type-has"],n)}}k+="</tr>";var e=t[f.getCategory()];if(e==null){e=[];t[f.getCategory()]=e;s.push(f.getCategory())}e.push(k)}for(var y=0;y<s.length;y++){var h=s[y];if(o.length>0){var x=false;for(var m=0;m<o.length;m++){if(h==o[m]){x=true;break}if(h.match(o[m])){x=true;break}}if(!x){continue}}var q=t[h];v+="<tr>";v+=HtmlUtil.th(["colspan",""+(1+this.ramaddas.length)],h);v+="</tr>";for(var k=0;k<q.length;k++){v+=q[k]}}v+=HtmlUtil.closeTag(HtmlUtil.TAG_TABLE);this.setContents(v)},gotTypes:function(e,d){this.numberWithTypes++;this.displayRepositories()}})}var RamaddaGalleryDisplay=RamaddaEntrygalleryDisplay;function RamaddaExampleDisplay(e,d,b){var a="click";var c="data";RamaddaUtil.inherit(this,new RamaddaDisplay(e,d,"example",b));addRamaddaDisplay(this);RamaddaUtil.defineMembers(this,{initDisplay:function(){this.initUI();var f=this.getGet();var g="<p>";g+=HtmlUtil.onClick(f+".click();",HtmlUtil.div([ATTR_ID,this.getDomId(a)],"Click me"));g+="<p>";g+=HtmlUtil.div([ATTR_ID,this.getDomId(c)],"");this.setContents(g);this.updateUI()},needsData:function(){return true},updateUI:function(){var f=this.getData();if(f==null){return}var h=f.getRecordFields();var g=f.getRecords();var k="";k+="#records:"+g.length;this.jq(c).html(k)},handleEventRecordSelection:function(g,f){},click:function(){this.jq(a).html("Click again")}})}var PROP_LAYOUT_TYPE="layoutType";var PROP_LAYOUT_COLUMNS="layoutColumns";var PROP_SHOW_MAP="showMap";var PROP_SHOW_MENU="showMenu";var PROP_FROMDATE="fromDate";var PROP_TODATE="toDate";function addDisplayManager(a){if(window.globalDisplayManagers==null){window.globalDisplayManagers={}}window.globalDisplayManagers[a.getId()]=a;window.globalDisplayManager=a}function addGlobalDisplayType(a){if(window.globalDisplayTypes==null){window.globalDisplayTypes=[]}window.globalDisplayTypes.push(a)}function getOrCreateDisplayManager(d,a,b){if(!b){var c=getDisplayManager(d);if(c!=null){return c}if(window.globalDisplayManager!=null){return window.globalDisplayManager}}var c=new DisplayManager(d,a);if(window.globalDisplayManager==null){window.globalDisplayManager=c}return c}function getDisplayManager(b){if(window.globalDisplayManagers==null){return null}var a=window.globalDisplayManagers[b];return a}var ID_DISPLAYS="displays";function DisplayManager(argId,argProperties){var ID_MENU_BUTTON="menu_button";var ID_MENU_OUTER="menu_outer";var ID_MENU_INNER="menu_inner";RamaddaUtil.inherit(this,this.SUPER=new DisplayThing(argId,argProperties));RamaddaUtil.initMembers(this,{dataList:[],displayTypes:[],initMapBounds:null});if(window.globalDisplayTypes!=null){for(var i=0;i<window.globalDisplayTypes.length;i++){this.displayTypes.push(window.globalDisplayTypes[i])}}RamaddaUtil.defineMembers(this,{group:new DisplayGroup(this,argId,argProperties),showmap:this.getProperty(PROP_SHOW_MAP,null),addDisplayType:function(type,label){this.displayTypes.push({type:label})},getLayoutManager:function(){return this.group},collectEntries:function(){var entries=this.getLayoutManager().collectEntries();return entries},getData:function(){return this.dataList},handleEventFieldsSelected:function(source,fields){this.notifyEvent("handleEventFieldsSelected",source,fields)},handleEventEntriesChanged:function(source,entries){this.notifyEvent("handleEventEntriesChanged",source,entries)},handleEventMapBoundsChanged:function(source,bounds,forceSet){var args={bounds:bounds,force:forceSet};this.notifyEvent("handleEventMapBoundsChanged",source,args)},addMapLayer:function(source,entry){this.notifyEvent("addMapLayer",source,{entry:entry})},handleEventMapClick:function(mapDisplay,lon,lat){var indexObj=[];var records=null;for(var i=0;i<this.dataList.length;i++){var pointData=this.dataList[i];records=pointData.getRecords();if(records!=null){break}}var indexObj=[];var closest=RecordUtil.findClosest(records,lon,lat,indexObj);if(closest!=null){this.handleEventRecordSelection(mapDisplay,pointData,indexObj.index)}this.notifyEvent("handleEventMapClick",mapDisplay,{mapDisplay:mapDisplay,lon:lon,lat:lat})},handleEventRecordSelection:function(source,pointData,index){if(pointData==null&&this.dataList.length>0){pointData=this.dataList[0]}var fields=pointData.getRecordFields();var records=pointData.getRecords();if(records==null){return}if(index<0||index>=records.length){console.log("handleEventRecordSelection: bad index= "+index);return}var record=records[index];var values=this.getRecordHtml(record,fields);if(source.recordSelectionCallback){var func=source.recordSelectionCallback;if((typeof func)=="string"){func=window[func]}func({display:source,pointData:pointData,index:index,pointRecord:record})}var params={index:index,record:record,html:values};this.notifyEvent("handleEventRecordSelection",source,params);var entries=source.getEntries();if(entries!=null&&entries.length>0){this.handleEventEntrySelection(source,{entry:entries[0],selected:true})}},handleEventEntrySelection:function(source,props){this.notifyEvent("handleEventEntrySelection",source,props)},handleEventPointDataLoaded:function(source,pointData){this.notifyEvent("handleEventPointDataLoaded",source,pointData)},ranges:{},setRange:function(field,range){if(this.ranges[field.getId()]==null){this.ranges[field.getId()]=range}},getRange:function(field){return this.ranges[field.getId()]},makeMainMenu:function(){if(!this.getProperty(PROP_SHOW_MENU,true)){return""}var get="getDisplayManager('"+this.getId()+"')";var layout="getDisplayManager('"+this.getId()+"').getLayoutManager()";var html="";var newMenus={};var cats=[];var chartMenu="";for(var i=0;i<this.displayTypes.length;i++){var type=this.displayTypes[i];if(Utils.isDefined(type.forUser)&&!type.forUser){continue}var category=type.category;if(category==null){category="Misc"}if(newMenus[category]==null){newMenus[category]="";cats.push(category)}newMenus[category]+=HtmlUtil.tag(TAG_LI,[],HtmlUtil.tag(TAG_A,["onclick",get+".userCreateDisplay('"+type.type+"');"],type.label))}var newMenu="";for(var i=0;i<cats.length;i++){var cat=cats[i];if(cat=="Charts"){chartMenu=newMenus[cat]}var subMenu=HtmlUtil.tag("ul",[],newMenus[cat]);var catLabel=HtmlUtil.tag(TAG_A,[],cat);newMenu+=HtmlUtil.tag(TAG_LI,[],catLabel+subMenu)}var publishMenu=HtmlUtil.tag(TAG_LI,[],HtmlUtil.onClick(layout+".publish('media_photoalbum');","New Photo Album"))+"\n"+HtmlUtil.tag(TAG_LI,[],HtmlUtil.onClick(layout+".publish('wikipage');","New Wiki Page"))+"\n"+HtmlUtil.tag(TAG_LI,[],HtmlUtil.onClick(layout+".publish('blogentry');","New Blog Post"))+"\n";var fileMenu=HtmlUtil.tag(TAG_LI,[],"<a>Publish</a>"+HtmlUtil.tag("ul",[],publishMenu))+"\n"+HtmlUtil.tag(TAG_LI,[],HtmlUtil.onClick(layout+".copyDisplayedEntries();","Save entries"))+"\n";var titles=HtmlUtil.tag(TAG_DIV,["class","ramadda-menu-block"],"Titles: "+HtmlUtil.onClick(layout+".titlesOn();","On")+"/"+HtmlUtil.onClick(layout+".titlesOff();","Off"));var dates=HtmlUtil.tag(TAG_DIV,["class","ramadda-menu-block"],"Set date range: "+HtmlUtil.onClick(layout+".askMinDate();","Min")+"/"+HtmlUtil.onClick(layout+".askMaxDate();","Max"));var editMenu=HtmlUtil.tag(TAG_LI,[],HtmlUtil.tag(TAG_DIV,["class","ramadda-menu-block"],"Set axis range :"+HtmlUtil.onClick(layout+".askMinZAxis();","Min")+"/"+HtmlUtil.onClick(layout+".askMaxZAxis();","Max")))+HtmlUtil.tag(TAG_LI,[],dates)+HtmlUtil.tag(TAG_LI,[],titles)+"\n"+HtmlUtil.tag(TAG_LI,[],HtmlUtil.tag(TAG_DIV,["class","ramadda-menu-block"],"Details: "+HtmlUtil.onClick(layout+".detailsOn();","On",[])+"/"+HtmlUtil.onClick(layout+".detailsOff();","Off",[])))+HtmlUtil.tag(TAG_LI,[],HtmlUtil.onClick(layout+".deleteAllDisplays();","Delete all displays"))+"\n";var table=HtmlUtil.tag(TAG_DIV,["class","ramadda-menu-block"],"Table: "+HtmlUtil.onClick(layout+".setLayout('table',1);","1 column")+" / "+HtmlUtil.onClick(layout+".setLayout('table',2);","2 column")+" / "+HtmlUtil.onClick(layout+".setLayout('table',3);","3 column")+" / "+HtmlUtil.onClick(layout+".setLayout('table',4);","4 column"));var layoutMenu=HtmlUtil.tag(TAG_LI,[],table)+HtmlUtil.tag(TAG_LI,[],HtmlUtil.onClick(layout+".setLayout('rows');","Rows"))+"\n"+HtmlUtil.tag(TAG_LI,[],HtmlUtil.onClick(layout+".setLayout('columns');","Columns"))+"\n"+HtmlUtil.tag(TAG_LI,[],HtmlUtil.onClick(layout+".setLayout('tabs');","Tabs"));var menuBar=HtmlUtil.tag(TAG_LI,[],"<a>File</a>"+HtmlUtil.tag("ul",[],fileMenu));if(chartMenu!=""){menuBar+=HtmlUtil.tag(TAG_LI,[],"<a>Charts</a>"+HtmlUtil.tag("ul",[],chartMenu))}menuBar+=HtmlUtil.tag(TAG_LI,[],"<a>Edit</a>"+HtmlUtil.tag("ul",[],editMenu))+HtmlUtil.tag(TAG_LI,[],"<a>New</a>"+HtmlUtil.tag("ul",[],newMenu))+HtmlUtil.tag(TAG_LI,[],"<a>Layout</a>"+HtmlUtil.tag("ul",[],layoutMenu));var menu=HtmlUtil.div([ATTR_CLASS,"ramadda-popup",ATTR_ID,this.getDomId(ID_MENU_OUTER)],HtmlUtil.tag("ul",[ATTR_ID,this.getDomId(ID_MENU_INNER),ATTR_CLASS,"sf-menu"],menuBar));html+=menu;html+=HtmlUtil.tag(TAG_A,[ATTR_CLASS,"display-menu-button",ATTR_ID,this.getDomId(ID_MENU_BUTTON)],"&nbsp;");return html},hasGeoMacro:function(jsonUrl){return jsonUrl.match(/(\${latitude})/g)!=null},getJsonUrl:function(jsonUrl,display,props){var fromDate=display.getProperty(PROP_FROMDATE);if(fromDate!=null){jsonUrl+="&fromdate="+fromDate}var toDate=display.getProperty(PROP_TODATE);if(toDate!=null){jsonUrl+="&todate="+toDate}if(this.hasGeoMacro(jsonUrl)){var lon=props.lon;var lat=props.lat;if((lon==null||lat==null)&&this.map!=null){var tuple=this.getPosition();if(tuple!=null){lat=tuple[0];lon=tuple[1]}}if(lon!=null&&lat!=null){jsonUrl=jsonUrl.replace("${latitude}",lat.toString());jsonUrl=jsonUrl.replace("${longitude}",lon.toString())}}jsonUrl=jsonUrl.replace("${numpoints}",1000);return jsonUrl},getDefaultData:function(){for(var i in this.dataList){var data=this.dataList[i];var records=data.getRecords();if(records!=null){return data}}if(this.dataList.length>0){return this.dataList[0]}return null},writeDisplay:function(){if(this.originalLocation==null){this.originalLocation=document.location}var url=this.originalLocation+"#";url+="&display0=linechart";for(var attr in document){}document.location=url},userCreateDisplay:function(type,props){if(props==null){props={}}props.editMode=true;if(type==DISPLAY_LABEL&&props.text==null){var text=prompt("Text");if(text==null){return}props.text=text}return this.createDisplay(type,props)},createDisplay:function(type,props){if(props==null){props={}}if(props.data!=null){var haveItAlready=false;for(var i=0;i<this.dataList.length;i++){var existingData=this.dataList[i];if(existingData.equals(props.data)){props.data=existingData;haveItAlready=true;break}}if(!haveItAlready){this.dataList.push(props.data)}}var proc=type.substring(0,1).toUpperCase()+type.substring(1);var classname=null;var names=["Ramadda"+proc+"Display",proc+"Display",proc];var func=null;var funcName=null;var msg="";for(var i=0;i<names.length;i++){msg+=("trying:"+names[i]+"\n");if(window[names[i]]!=null){funcName=names[i];func=window[names[i]];break}}if(func==null){console.log("Error: could not find display function:"+type);alert("Error: could not find display function:"+type+" msg: "+msg);return}var displayId=this.getUniqueId("display");if(props.data==null&&this.dataList.length>0){props.data=this.dataList[0]}props.createdInteractively=true;if(!props.entryId){props.entryId=this.group.entryId}var display=eval(" new "+funcName+"(this,'"+displayId+"', props);");if(display==null){console.log("Error: could not create display using:"+funcName);alert("Error: could not create display using:"+funcName);return}this.addDisplay(display);return display},addDisplay:function(display){display.setDisplayManager(this);display.loadInitialData();this.getLayoutManager().addDisplay(display)},notifyEvent:function(func,source,data){this.getLayoutManager().notifyEvent(func,source,data)},removeDisplay:function(display){this.getLayoutManager().removeDisplay(display);this.notifyEvent("handleEventRemoveDisplay",this,display)}});addDisplayManager(this);var displaysHtml=HtmlUtil.div([ATTR_ID,this.getDomId(ID_DISPLAYS),ATTR_CLASS,"display-container"]);var html=HtmlUtil.openTag(TAG_DIV);html+=this.makeMainMenu();var targetDiv=this.getProperty("target");var _this=this;if(targetDiv!=null){$(document).ready(function(){$("#"+targetDiv).html(displaysHtml);_this.getLayoutManager().doLayout()})}else{html+=displaysHtml}html+=HtmlUtil.closeTag(TAG_DIV);$("#"+this.getId()).html(html);if(this.showmap){this.createDisplay("map")}var theDisplayManager=this;$("#"+this.getDomId(ID_MENU_BUTTON)).button({icons:{primary:"ui-icon-gear",secondary:"ui-icon-triangle-1-s"}}).click(function(event){var id=theDisplayManager.getDomId(ID_MENU_OUTER);showPopup(event,theDisplayManager.getDomId(ID_MENU_BUTTON),id,false,null,"left bottom");$("#"+theDisplayManager.getDomId(ID_MENU_INNER)).superfish({speed:"fast",delay:300})})}var DISPLAY_MAP="map";var displayMapMarkers=["marker.png","marker-blue.png","marker-gold.png","marker-green.png"];var currentMarker=-1;function getMapMarker(){currentMarker++;if(currentMarker>=displayMapMarkers.length){currentMarker=0}return ramaddaBaseUrl+"/lib/openlayers/v2/img/"+displayMapMarkers[currentMarker]}addGlobalDisplayType({type:DISPLAY_MAP,label:"Map"});function MapFeature(b,a){RamaddaUtil.defineMembers(this,{source:b,points:a})}function RamaddaMapDisplay(g,f,c){var d="latfield";var e="lonfield";var b="map";var a;RamaddaUtil.defineMembers(this,{showLocationReadout:false,showBoxes:true,showPercent:false,percentFields:null,kmlLayer:null,kmlLayerName:"",geojsonLayer:null,geojsonLayerName:""});RamaddaUtil.inherit(this,a=new RamaddaDisplay(g,f,DISPLAY_MAP,c));addRamaddaDisplay(this);RamaddaUtil.defineMembers(this,{initBounds:g.initMapBounds,mapBoundsSet:false,features:[],myMarkers:{},mapEntryInfos:{},sourceToLine:{},sourceToPoints:{},snarf:true,initDisplay:function(){this.initUI();var v=this;var l="";var C="min-height:200px;";var q=this.getWidth();if(Utils.isDefined(q)){if(q>0){C+="width:"+q+"px; "}else{if(q!=""){C+="width:"+q+";"}}}var n=this.getProperty("height",300);if(n>0){C+=" height:"+n+"px; "}l+=HtmlUtil.div([ATTR_CLASS,"display-map-map","style",C,ATTR_ID,this.getDomId(b)]);if(this.showLocationReadout){l+=HtmlUtil.openTag(TAG_DIV,[ATTR_CLASS,"display-map-latlon"]);l+=HtmlUtil.openTag("form");l+="Latitude: "+HtmlUtil.input(this.getDomId(d),"",["size","7",ATTR_ID,this.getDomId(d)]);l+="  ";l+="Longitude: "+HtmlUtil.input(this.getDomId(e),"",["size","7",ATTR_ID,this.getDomId(e)]);l+=HtmlUtil.closeTag("form");l+=HtmlUtil.closeTag(TAG_DIV)}this.setContents(l);var y={defaultMapLayer:this.getProperty("defaultMapLayer",map_default_layer)};var k=this.getProperty("mapLayers",null);var u=this;if(k){y.mapLayers=[k]}if(this.map){this.map.map.render(this.getDomId(b));return}this.map=new RepositoryMap(this.getDomId(b),y);if(this.doDisplayMap()){this.map.setDefaultCanSelect(false)}this.map.initMap(false);if(this.kmlLayer!=null){var h=ramaddaBaseUrl+"/entry/show?output=shapefile.kml&entryid="+this.kmlLayer;this.map.addKMLLayer(this.kmlLayerName,h,this.doDisplayMap(),null,null,null,function(E,D){u.vectorLoad(D)})}if(this.geojsonLayer!=null){h=this.getRamadda().getEntryDownloadUrl(this.geojsonLayer);this.map.addGeoJsonLayer(this.geojsonLayerName,h,this.doDisplayMap(),null,null,null,function(E,D){u.vectorLoad(D)})}this.map.addRegionSelectorControl(function(D){v.getDisplayManager().handleEventMapBoundsChanged(this,D,true)});this.map.addClickHandler(this.getDomId(e),this.getDomId(d),null,this);this.map.map.events.register("zoomend","",function(){u.mapBoundsChanged()});this.map.map.events.register("moveend","",function(){u.mapBoundsChanged()});if(this.initBounds!=null){var z=this.initBounds;this.setInitMapBounds(z[0],z[1],z[2],z[3])}var x=this.features;this.features=[];for(var w=0;w<x.length;w++){this.addFeature(x[w])}var m=this.getDisplayManager().collectEntries();for(var w=0;w<m.length;w++){var p=m[w];this.handleEventEntriesChanged(p.source,p.entries)}if(this.layerEntries){var t=function(D){v.handleLayerSelect(D)};var B=function(D){v.handleLayerUnselect(D)};var o=this.layerEntries.split(",");for(var w=0;w<o.length;w++){var s=o[w];var h=ramaddaBaseUrl+"/entry/show?output=shapefile.kml&entryid="+s;this.map.addKMLLayer("layer",h,true,t,B)}}},doDisplayMap:function(){var h=(this.kmlLayer!=null||this.geojsonLayer!=null)&&((""+this.getProperty("displayAsMap",""))=="true");return h},vectorLoad:function(h){this.vectorLayer=h;this.applyVectorMap()},handleLayerSelect:function(s){var v=this.layerSelectArgs;if(!this.layerSelectPath){if(!v){this.map.onFeatureSelect(s);return}this.layerSelectPath="/search/do"}var h=ramaddaBaseUrl+this.layerSelectPath;if(v){var u=v.split(",");for(var p=0;p<u.length;p++){var B=u[p];var n=B.split(":");var x=n[0];var y=n[1];var z=s.feature.attributes;var k=null;for(var t in z){var w=""+t;if(w==y){var q=null;if(typeof z[t]=="object"||typeof z[t]=="Object"){var l=z[t];q=l.value}else{q=z[t]}h=HtmlUtil.appendArg(h,x,q);h=h.replace("${"+x+"}",q)}}}}h=HtmlUtil.appendArg(h,"output","json");console.log("Doing search: "+h);var m=new EntryList(this.getRamadda(),h,null,false);m.doSearch(this);this.getEntryList().showMessage("Searching",HtmlUtil.div([ATTR_STYLE,"margin:20px;"],this.getWaitImage()))},getEntryList:function(){if(!this.entryListDisplay){var h={showMenu:true,showTitle:true,showDetails:true,layoutHere:false,showForm:false,doSearch:false};var k=this.getUniqueId("display");this.entryListDisplay=new RamaddaEntrylistDisplay(this.getDisplayManager(),k,h);this.getDisplayManager().addDisplay(this.entryListDisplay)}return this.entryListDisplay},entryListChanged:function(k){var h=k.getEntries();this.getEntryList().entryListChanged(k)},handleLayerUnselect:function(h){this.map.onFeatureUnselect(h)},addMapLayer:function(h,s){var o=this;var t=s.entry;if(!this.addedLayers){this.addedLayers={}}if(this.addedLayers[t.getId()]){var n=this.addedLayers[t.getId()];if(n){this.map.removeKMLLayer(n);this.addedLayers[t.getId()]=null}return}if(t.getType().getId()=="geo_shapefile"){var k=createBounds(t.getWest(),t.getSouth(),t.getEast(),t.getNorth());if(k.left<-180||k.right>180||k.bottom<-90||k.top>90){console.log("entry has bad bounds:"+t.getName()+" "+k);return}var m=function(u){o.handleLayerSelect(u)};var q=function(u){o.handleLayerUnselect(u)};var l=ramaddaBaseUrl+"/entry/show?output=shapefile.kml&entryid="+t.getId();var n=this.map.addKMLLayer(t.getName(),l,true,m,q);this.addedLayers[t.getId()]=n;k=this.map.transformLLBounds(k);this.map.map.zoomToExtent(k,true);return}var p=t.getAttributeValue("base_url");if(!Utils.stringDefined(p)){console.log("No base url:"+t.getId());return}var n=t.getAttributeValue("layer_name");if(n==null){n=t.getName()}console.log("layer:"+n);this.map.addWMSLayer(t.getName(),p,n,false)},mapBoundsChanged:function(){var h=this.map.map.calculateBounds();h=h.transform(this.map.sourceProjection,this.map.displayProjection);this.getDisplayManager().handleEventMapBoundsChanged(this,h)},addFeature:function(h){this.features.push(h);h.line=this.map.addPolygon("lines_"+h.source.getId(),RecordUtil.clonePoints(h.points),null)},loadInitialData:function(){if(this.getDisplayManager().getData().length>0){this.handleEventPointDataLoaded(this,this.getDisplayManager().getData()[0])}},getContentsDiv:function(){return HtmlUtil.div([ATTR_CLASS,"display-contents",ATTR_ID,this.getDomId(ID_DISPLAY_CONTENTS)],"")},handleEventAreaClear:function(){this.map.clearRegionSelector()},handleClick:function(h,l,k){this.getDisplayManager().handleEventMapClick(this,l,k)},getPosition:function(){var h=$("#"+this.getDomId(d)).val();var k=$("#"+this.getDomId(e)).val();if(h==null){return null}return[h,k]},setInitMapBounds:function(m,h,l,k){if(!this.map){return}this.map.centerOnMarkers(new OpenLayers.Bounds(h,l,k,m))},sourceToEntries:{},handleEventEntriesChanged:function(k,q){if(k==this.lastSource){this.map.clearSelectionMarker()}if((typeof k.forMap)!="undefined"&&!k.forMap){return}var s=this.sourceToEntries[k.getId()];if(s!=null){for(var p=0;p<s.length;p++){var m=k.getId()+"_"+s[p].getId();this.addOrRemoveEntryMarker(m,s[p],false)}}this.sourceToEntries[k.getId()]=q;var n=new OpenLayers.Layer.Markers("Markers");var y=new OpenLayers.Layer.Vector("Lines",{});var o=-90,w=180,t=90,u=-180;var x=false;for(var p=0;p<q.length;p++){var v=q[p];var m=k.getId()+"_"+v.getId();var l=this.addOrRemoveEntryMarker(m,q[p],true);if(v.hasBounds()){if(v.getNorth()>90||v.getSouth()<-90||v.getEast()>180||v.getWest()<-180){console.log("bad bounds on entry:"+v.getName()+" "+v.getNorth()+" "+v.getSouth()+" "+v.getEast()+" "+v.getWest());continue}o=Math.max(o,v.getNorth());t=Math.min(t,v.getSouth());u=Math.max(u,v.getEast());w=Math.min(w,v.getWest());x=true}}var h=(x?createBounds(w,t,u,o):null);this.map.centerOnMarkers(h)},handleEventEntrySelection:function(m,h){var n=this;var l=h.entry;if(l==null){this.map.clearSelectionMarker();return}var k=h.selected;if(!l.hasLocation()){return}},addOrRemoveEntryMarker:function(l,o,u){console.log("addOrRemoveEntryMarker");var k=this.mapEntryInfos[l];if(!u){if(k!=null){k.removeFromMap(this.map);this.mapEntryInfos[l]=null}}else{if(k==null){k=new MapEntryInfo(o);if(o.hasBounds()&&this.showBoxes){var s={};k.rectangle=this.map.addRectangle(l,o.getNorth(),o.getWest(),o.getSouth(),o.getEast(),s)}var n=o.getLatitude();var h=o.getLongitude();if(n<-90||n>90||h<-180||h>180){return}var p=new OpenLayers.LonLat(h,n);k.marker=this.map.addMarker(l,p,o.getIconUrl(),"",this.getEntryHtml(o));k.lineColor=o.lineColor;if(o.polygon){var q=[];for(var m=0;m<o.polygon.length;m+=2){q.push(new OpenLayers.Geometry.Point(o.polygon[m+1],o.polygon[m]))}var s={strokeColor:Utils.isDefined(o.lineColor)?o.lineColor:"blue",strokeWidth:Utils.isDefined(o.lineWidth)?o.lineWidth:3};k.polygon=this.map.addPolygon(l,q,s,k.marker)}var t=this;k.marker.entry=o;k.marker.ramaddaClickHandler=function(v){t.handleMapClick(v)};this.mapEntryInfos[l]=k;if(this.handledMarkers==null){this.map.centerToMarkers();this.handledMarkers=true}}}return k},handleMapClick:function(h){if(this.selectedMarker!=null){this.getDisplayManager().handleEventEntrySelection(this,{entry:this.selectedMarker.entry,selected:false})}this.getDisplayManager().handleEventEntrySelection(this,{entry:h.entry,selected:true});this.selectedMarker=h},getDisplayProp:function(k,l,h){if(Utils.isDefined(this[l])){return this[l]}l="map-"+l;if(Utils.isDefined(k[l])){return k[l]}return k.getProperty(l,h)},applyVectorMap:function(){if(!this.doDisplayMap()){return}if(!this.vectorLayer||!this.points){return}if(this.vectorMapApplied){return}this.vectorMapApplied=true;var n=this.vectorLayer.features.slice();console.log("starting:"+n.length);var s=this.points;for(var p=0;p<s.length;p++){var m=s[p];var l=m.center;var q=null;var t=-1;for(var o=0;o<n.length;o++){var v=n[o];var u=v.geometry;if(!u){break}bounds=u.getBounds();if(!bounds.contains(l.x,l.y)){continue}if(u.components){for(var k=0;k<u.components.length;k++){comp=u.components[k];bounds=comp.getBounds();if(!bounds.contains(l.x,l.y)){continue}if(comp.containsPoint&&comp.containsPoint(l)){q=v;t=o;break}}if(q){break}continue}if(!u.containsPoint){console.log("unknown geometry:"+u.CLASS_NAME);continue}if(u.containsPoint(l)){q=v;t=o;break}}if(q){n.splice(t,1);style=q.style;if(!style){style={stylename:"from display"}}$.extend(style,m.style);q.style=style;q.popupText=m.text}}if((""+this.getProperty("pruneFeatures",""))=="true"){this.vectorLayer.removeFeatures(n);var h=this.vectorLayer.getDataExtent();bounds=this.map.transformProjBounds(h);this.map.centerOnMarkers(bounds,true)}this.vectorLayer.redraw()},handleEventPointDataLoaded:function(s,t){this.pointData=t;if(s&&Utils.isDefined(s["map-display"])&&!s["map-display"]){return}var E=[NaN,NaN,NaN,NaN];var P=t.getRecords();var k=t.getRecordFields();var H=RecordUtil.getPoints(P,E);if(isNaN(E[0])){return}this.initBounds=E;this.setInitMapBounds(E[0],E[1],E[2],E[3]);if(this.map==null){return}if(H.length==0){return}var M=parseFloat(this.getDisplayProp(s,"radius",8));var G=parseFloat(this.getDisplayProp(s,"strokeWidth","1"));var p=this.getDisplayProp(s,"strokeColor","#000");var q=this.getDisplayProp(s,"colorBy",null);var F=this.getDisplayProp(s,"colorBar",null);var x=this.getDisplayProp(s,"sizeBy",null);var L=null;var U=this.getDisplayProp(s,"isTrajectory",false);if(U){this.map.addPolygon("id",H,null,null);return}if(F){L=Utils.ColorTables[F]}else{if(s.colors&&s.colors.length>0){L=s.colors;if(L.length==1&&Utils.ColorTables[L[0]]){L=Utils.ColorTables[L[0]]}}}if(L==null){L=Utils.ColorTables.grayscale}var P=t.getRecords();var u={id:q,minValue:0,maxValue:0,field:null,index:-1};var m={id:this.getDisplayProp(s,"sizeBy",null),minValue:0,maxValue:0,field:null,index:-1};for(var R=0;R<k.length;R++){var n=k[R];if(n.getId()==u.id||("#"+(R+1))==u.id){u.field=n}if(n.getId()==m.id||("#"+(R+1))==m.id){m.field=n}}m.index=m.field!=null?m.field.getIndex():-1;u.index=u.field!=null?u.field.getIndex():-1;var N=this.getProperty(PROP_EXCLUDE_ZERO,false);for(var R=0;R<H.length;R++){var O=P[R];var h=O.getData();var I=h[u.index];if(N&&I==0){continue}if(R==0||I>u.maxValue){u.maxValue=I}if(R==0||I<u.minValue){u.minValue=I}I=h[m.index];if(R==0||I>m.maxValue){m.maxValue=I}if(R==0||I<m.minValue){m.minValue=I}}if(this.showPercent){u.minValue=0;u.maxValue=100}u.minValue=this.getDisplayProp(s,"colorByMin",u.minValue);u.maxValue=this.getDisplayProp(s,"colorByMax",u.maxValue);var T=this.doDisplayMap();for(var R=0;R<H.length;R++){var O=P[R];var C=H[R];var w={pointRadius:M,strokeWidth:G,strokeColor:p};if(m.index>=0){var K=O.getData()[m.index];var V=(m.maxValue-m.minValue);var l=(V==0?NaN:(K-m.minValue)/V);w.pointRadius=6+parseInt(15*l)}if(u.index>=0){var K=O.getData()[u.index];var l=0;var J="";var o=null;if(this.percentFields!=null){o=this.percentFields.split(",")}if(this.showPercent){var z=0;var S=O.getData();var J="";for(var Q=0;Q<S.length;Q++){var D=k[Q].isNumeric&&!k[Q].isFieldGeo();if(D&&o!=null){D=o.indexOf(k[Q].getId())>=0||o.indexOf("#"+(Q+1))>=0}if(D){z+=S[Q];J+=" "+S[Q]}}if(z!=0){percent0=l=K/z*100;l=(l-u.minValue)/(u.maxValue-u.minValue)}}else{l=(K-u.minValue)/(u.maxValue-u.minValue)}var B=parseInt(l*L.length);if(B>=L.length){B=L.length-1}else{if(B<0){B=0}}w.fillOpacity=0.8;w.fillColor=L[B]}var y=this.getRecordHtml(O,k);C=this.map.addPoint("pt-"+R,C,w,y,T);if(!this.points){this.points=[]}this.points.push(C)}this.applyVectorMap()},handleEventRemoveDisplay:function(l,m){var k=this.mapEntryInfos[m];if(k!=null){k.removeFromMap(this.map)}var h=this.findFeature(m,true);if(h!=null){if(h.line!=null){this.map.removePolygon(h.line)}}},findFeature:function(m,l){for(var k in this.features){var h=this.features[k];if(h.source==m){if(l){this.features.splice(k,1)}return h}}return null},handleEventRecordSelection:function(p,m){var l=m.record;if(l.hasLocation()){var q=l.getLatitude();var o=l.getLongitude();if(q<-90||q>90||o<-180||o>180){return}var h=new OpenLayers.LonLat(o,q);var k=this.myMarkers[p];if(k!=null){this.map.removeMarker(k)}if(this.markerIcons==null){this.markerIcons={}}var n=this.markerIcons[p];if(n==null){n=getMapMarker();this.markerIcons[p]=n}this.myMarkers[p]=this.map.addMarker(p.getId(),h,n,"",m.html,null,24)}}})}function MapEntryInfo(a){RamaddaUtil.defineMembers(this,{entry:a,marker:null,rectangle:null,removeFromMap:function(b){if(this.marker!=null){b.removeMarker(this.marker)}if(this.rectangle!=null){b.removePolygon(this.rectangle)}if(this.polygon!=null){b.removePolygon(this.polygon)}}})}function RamaddaXlsDisplay(w,n,h){var s="xaxis";var q="yaxis";var d="group";var v="search";var f="table";var k="searchextra";var g="searchheader";var o="results";var u="downloadurl";var p="tablecontents";var e="searchdiv";var l="searchform";var a="searchtext";var m="tableholder";var b="table";var c="charttoolbar";var t="chart";RamaddaUtil.inherit(this,new RamaddaDisplay(w,n,"xls",h));addRamaddaDisplay(this);this.url=h.url;this.tableProps={fixedRowsTop:0,fixedColumnsLeft:0,rowHeaders:true,colHeaders:true,headers:null,skipRows:0,skipColumns:0};if(h!=null){$.extend(this.tableProps,h)}RamaddaUtil.defineMembers(this,{initDisplay:function(){this.initUI();this.setDisplayTitle("Table Data");var x=HtmlUtil.div(["id",this.getDomId(g)])+HtmlUtil.div(["id",this.getDomId(m)])+HtmlUtil.div(["id",this.getDomId(c)])+HtmlUtil.div(["id",this.getDomId(t)]);this.setContents(x);this.loadTableData(this.url)}});RamaddaUtil.defineMembers(this,{currentSheet:0,currentData:null,columnLabels:null,startRow:0,groupIndex:-1,xAxisIndex:-1,yAxisIndex:-1,header:null,cellSelected:function(C,y){this.startRow=C;if(this.jq("params-xaxis-select").attr("checked")){this.xAxisIndex=y}else{if(this.jq("params-group-select").attr("checked")){this.groupIndex=y}else{this.yAxisIndex=y}}var x="";var B="";var z="";this.setAxisLabel(s,this.getHeading(this.xAxisIndex,true));this.setAxisLabel(d,this.getHeading(this.groupIndex,true));this.setAxisLabel(q,this.getHeading(this.yAxisIndex,true))},getAxisLabelId:function(x){return"params-"+x+"-label"},setAxisLabel:function(x,y){x=this.getAxisLabelId(x);var z=HtmlUtil.getUniqueId();if(y.length>25){y=y.substring(0,25)+"..."}if(y.trim()!=""){y=HtmlUtil.span(["id",z,"class","ramadda-tag-box"],"&nbsp;&nbsp;"+y+"&nbsp;&nbsp;")}this.jq(x).html(y)},loadSheet:function(C){var G=$("[id^="+this.getDomId("sheet_")+"]");var x=$("#"+this.getDomId("sheet_")+C);G.css("font-weight","normal");x.css("font-weight","bold");G.css("border","1px #ccc solid");x.css("border","1px #666 solid");this.currentSheet=C;var E=this.sheets[C];if(E){var H=E.rows.slice(0);if(H.length>0){this.header=H[0]}}var B="";var D=this;var F={contextMenu:true,stretchH:"all",colHeaders:true,rowHeaders:true,minSpareRows:1,afterSelection:function(){if(arguments.length>2){for(var J=0;J<arguments.length;J++){}var K=arguments[0];var I=arguments[1];D.cellSelected(K,I)}}};$.extend(F,this.tableProps);if(this.tableProps.useFirstRowAsHeader){var y=H[0];F.colHeaders=y;H=H.splice(1)}for(var z=0;z<this.tableProps.skipRows;z++){H=H.splice(1)}if(H.length==0){this.displayMessage("No data found");this.jq(o).html("");return}this.jq(o).html("Found: "+H.length);F.data=H;this.currentData=H;if(this.tableProps.headers!=null){F.colHeaders=this.tableProps.headers}if(this.getProperty("showTable",true)){this.jq(b).handsontable(F)}},getDataForSheet:function(D,x){var z=this.sheets[D];var B=z.rows.slice(0);if(B.length>0){this.header=B[0]}if(this.tableProps.useFirstRowAsHeader){var C=B[0];if(x){x.colHeaders=C}B=B.splice(1)}for(var y=0;y<this.tableProps.skipRows;y++){B=B.splice(1)}return B},makeChart:function(F,D){if(typeof google=="undefined"){this.jq(t).html("No google chart available");return}if(D==null){D={}}var E=Utils.getDefined(D.xAxisIndex,this.xAxisIndex);var C=Utils.getDefined(D.groupIndex,this.groupIndex);var O=Utils.getDefined(D.yAxisIndex,this.yAxisIndex);if(O<0){alert("You must select a y-axis field.\n\nSelect the desired axis with the radio button.\n\nClick the column in the table to chart.");return}var y=this.currentSheet;if(!(typeof D.sheet=="undefined")){y=D.sheet}var H=this.getDataForSheet(y);if(H==null){this.jq(t).html("There is no data");return}var H=H.slice(1);for(var S=0;S<this.startRow-1;S++){H=H.slice(1)}var I=[];console.log("x:"+E+"  y:"+O+" group:"+C);for(var B=0;B<H.length;B++){var G=[];var N=0;if(E>=0){G.push(H[B][E])}else{G.push(B)}if(O>=0){G.push(H[B][O])}I.push(G);if(B<2){console.log("row:"+G)}}H=I;for(var B=0;B<H.length;B++){var K=H[B];for(var M=0;M<K.length;M++){var Q=K[M]+"";K[M]=parseFloat(Q.trim())}}var x=this.getHeading(E,true);var V=this.getHeading(O,true);var U=this.getHeading(C,true);this.columnLabels=[x,V];var T=this.columnLabels!=null?this.columnLabels:["Field 1","Field 2"];H.splice(0,0,T);var L=google.visualization.arrayToDataTable(H);var R={};var P="95%";$.extend(R,{legend:{position:"top"}});if(this.header!=null){if(E>=0){R.hAxis={title:this.header[E]}}if(O>=0){R.vAxis={title:this.header[O]}}}var J=HtmlUtil.getUniqueId();var z=["id",J];if(F=="scatterplot"){z.push("style");z.push("width: 450px; height: 450px;")}this.jq(t).append(HtmlUtil.div(z));if(F=="barchart"){R.chartArea={left:75,top:10,height:"60%",width:P};R.orientation="horizontal";this.chart=new google.visualization.BarChart(document.getElementById(J))}else{if(F=="table"){this.chart=new google.visualization.Table(document.getElementById(J))}else{if(F=="motion"){this.chart=new google.visualization.MotionChart(document.getElementById(J))}else{if(F=="scatterplot"){R.chartArea={left:50,top:30,height:400,width:400};R.legend="none";R.axisTitlesPosition="in";this.chart=new google.visualization.ScatterChart(document.getElementById(J))}else{$.extend(R,{lineWidth:1});R.chartArea={left:75,top:10,height:"60%",width:P};this.chart=new google.visualization.LineChart(document.getElementById(J))}}}}if(this.chart!=null){this.chart.draw(L,R)}},addNewChartListener:function(y,x){var z=this;$("#"+y+"-"+x).button().click(function(B){console.log("make chart:"+x);z.makeChart(x)})},makeSheetButton:function(z,x){var y=this;$("#"+z).button().click(function(B){y.loadSheet(x)})},clear:function(){this.jq(t).html("");this.startRow=0;this.groupIndex=-1;this.xAxisIndex=-1;this.yAxisIndex=-1;this.setAxisLabel(d,"");this.setAxisLabel(s,"");this.setAxisLabel(q,"")},getHeading:function(z,x){if(z<0){return""}if(this.header!=null&&z>=0&&z<this.header.length){var y=this.header[z];y=y.trim();if(y.length>0){return y}}if(x){return"Field "+(z+1)}return""},showTableData:function(U){var P=this;this.data=U;this.sheets=this.data.sheets;this.columns=U.columns;var R="";for(var y=0;y<this.sheets.length;y++){var L=this.getDomId("sheet_"+y);R+=HtmlUtil.div(["id",L,"class","ramadda-xls-button-sheet"],this.sheets[y].name);R+="\n"}var I="12";var M='<table width=100% style="max-width:1000px;" > ';if(this.sheets.length>1){I="10"}M+="<tr valign=top>";if(this.sheets.length>1){M+=HtmlUtil.td(["width","110"],HtmlUtil.div(["class","ramadda-xls-buttons"],R));I="10"}var N=HtmlUtil.getUniqueId();var T=this.getProperty("tableWidth","");var V=this.getProperty("tableHeight","300px");var S="";if(T!=""){S+=" width:"+T+";"}S+=" height: "+V+";";S+=" overflow: auto;";M+=HtmlUtil.td([],HtmlUtil.div(["id",this.getDomId(b),"class","ramadda-xls-table","style",S]));M+="</tr>";M+="</table>";var z="";var K=["barchart","linechart","scatterplot"];for(var Q=0;Q<K.length;Q++){z+=HtmlUtil.div(["id",N+"-"+K[Q],"class","ramadda-xls-button"],"Make "+K[Q]);z+="&nbsp;"}z+="&nbsp;";z+=HtmlUtil.div(["id",this.getDomId("removechart"),"class","ramadda-xls-button"],"Clear Charts");z+="<p>";z+="<form>Fields: ";z+='<input type=radio checked name="param" id="'+this.getDomId("params-yaxis-select")+'"> y-axis:&nbsp;'+HtmlUtil.div(["id",this.getDomId("params-yaxis-label"),"style","border-bottom:1px #ccc dotted;min-width:10em;display:inline-block;"],"");z+="&nbsp;&nbsp;&nbsp;";z+='<input type=radio  name="param" id="'+this.getDomId("params-xaxis-select")+'"> x-axis:&nbsp;'+HtmlUtil.div(["id",this.getDomId("params-xaxis-label"),"style","border-bottom:1px #ccc dotted;min-width:10em;display:inline-block;"],"");z+="&nbsp;&nbsp;&nbsp;";z+='<input type=radio  name="param" id="'+this.getDomId("params-group-select")+'"> group:&nbsp;'+HtmlUtil.div(["id",this.getDomId("params-group-label"),"style","border-bottom:1px #ccc dotted;min-width:10em;display:inline-block;"],"");z+="</form>";if(this.getProperty("showSearch",true)){var O=HtmlUtil.div(["style","display:inline-block;","id",this.getDomId(o)],"");var C=HtmlUtil.div(["style","display:inline-block;","id",this.getDomId(u)]);var G=HtmlUtil.div(["id",this.getDomId(e),"class","ramadda-xls-search-form"]);var H="";H+=HtmlUtil.openTag("form",["action","#","id",this.getDomId(l)]);H+=HtmlUtil.image(icon_tree_closed,["id",this.getDomId(v+"_open")]);H+="\n";H+=HtmlUtil.input(a,this.jq(a).val(),["size","60","id",this.getDomId(a),"placeholder","Search"]);H+="<input type=submit name='' style='display:none;'>";H+=HtmlUtil.openTag("div",["id",this.getDomId(k),"class","ramadda-xls-search-extra"],"");if(this.columns){var B=HtmlUtil.openTag("table",["class","formtable"]);for(var Q=0;Q<this.columns.length;Q++){var F=this.columns[Q];var L=f+"_"+F.name;var D=HtmlUtil.input(L,this.jq(L).val(),["id",this.getDomId(L),"placeholder","Search"]);B+=HtmlUtil.formEntry(F.name.replace("_"," ")+":",D)}B+=HtmlUtil.closeTag("table");H+=B}if(this.searchFields){var B=HtmlUtil.openTag("table",["class","formtable"]);for(var Q=0;Q<this.searchFields.length;Q++){var F=this.searchFields[Q];var L=f+"_"+F.name;var D=HtmlUtil.input(L,this.jq(L).val(),["id",this.getDomId(L),"placeholder","Search"]);B+=HtmlUtil.formEntry(F.label+":",D)}B+=HtmlUtil.closeTag("table");H+=B}H+="\n";H+=HtmlUtil.closeTag("div");H+="\n";H+=HtmlUtil.closeTag("form");this.jq(g).html(HtmlUtil.leftRight(G,O+" "+C));this.jq(e).html(H);if(!this.extraOpen){this.jq(k).hide()}this.jq(v+"_open").button().click(function(W){P.jq(k).toggle();P.extraOpen=!P.extraOpen;if(P.extraOpen){P.jq(v+"_open").attr("src",icon_tree_open)}else{P.jq(v+"_open").attr("src",icon_tree_closed)}})}if(this.getProperty("showTable",true)){this.jq(m).html(M);z+="<br>";if(this.getProperty("showChart",true)){this.jq(c).html(z)}}if(this.getProperty("showSearch",true)){this.jq(l).submit(function(W){W.preventDefault();P.loadTableData(P.url,"Searching...")});this.jq(a).focus();this.jq(a).select()}for(var Q=0;Q<K.length;Q++){this.addNewChartListener(N,K[Q])}this.jq("removechart").button().click(function(W){P.clear()});for(var y=0;y<this.sheets.length;y++){var L=this.getDomId("sheet_"+y);this.makeSheetButton(L,y)}var y=0;var E=/sheet=([^&]+)/g;var x=E.exec(window.location.search);if(x){y=x[1]}this.loadSheet(y);if(this.defaultCharts){for(var Q=0;Q<this.defaultCharts.length;Q++){var J=this.defaultCharts[Q];this.makeChart(J.type,J)}}this.setAxisLabel("params-yaxis-label",this.getHeading(this.yAxisIndex,true));this.displayDownloadUrl()},displayMessage:function(z,y){if(!y){y=icon_information}var x=HtmlUtil.hbox(HtmlUtil.image(y,["align","left"]),HtmlUtil.inset(z,10,10,5,10));x=HtmlUtil.div(["class","note"],x);this.jq(m).html(x)},displayDownloadUrl:function(){var y=this.lastUrl;if(y==null){this.jq(u).html("");return}y=y.replace("xls_json","media_tabular_extractsheet");y+="&execute=true";var x=HtmlUtil.image(ramaddaBaseUrl+"/icons/xls.png",["title","Download XLSX"]);this.jq(u).html(HtmlUtil.href(y,x))},loadTableData:function(y,B){this.url=y;if(!B){B=this.getLoadingMessage()}this.displayMessage(B,icon_progress);var F=this;var D=this.jq(a).val();if(D&&D!=""){y=y+"&table.text="+encodeURIComponent(D)}if(this.columns){for(var z=0;z<this.columns.length;z++){var x=this.columns[z];var E=f+"_"+x.name;var D=this.jq(E).val();if(D){y=y+"&table."+x.name+"="+encodeURIComponent(D)}}}if(this.searchFields){for(var z=0;z<this.searchFields.length;z++){var x=this.searchFields[z];var E=f+"_"+x.name;var D=this.jq(E).val();if(D){y=y+"&table."+x.name+"="+encodeURIComponent(D)}}}console.log("url:"+y);this.lastUrl=y;var C=$.getJSON(y,function(G){if(GuiUtils.isJsonError(G)){F.displayMessage("Error: "+G.error);return}F.showTableData(G)}).fail(function(I,J,G){var H=J+", "+G;F.displayMessage("An error occurred: "+G);console.log("JSON error:"+H)})}})};