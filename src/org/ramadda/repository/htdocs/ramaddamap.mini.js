var globalDebug=false;var map_google_terrain="google.terrain";var map_google_streets="google.streets";var map_google_hybrid="google.hybrid";var map_google_satellite="google.satellite";var map_esri_topo="esri.topo";var map_esri_street="esri.street";var map_esri_worldimagery="esri.worldimagery";var map_opentopo="opentopo";var map_usgs_topo="usgs.topo";var map_usgs_imagery="usgs.imagery";var map_usgs_relief="usgs.relief";var map_white="white";var map_blue="blue";var map_black="black";var map_ms_shaded="ms.shaded";var map_ms_hybrid="ms.hybrid";var map_ms_aerial="ms.aerial";var map_osm="osm";var map_wms_topographic="wms:Topo Maps,//terraservice.net/ogcmap.ashx,DRG";var map_ol_openstreetmap="ol.openstreetmap";var map_default_layer=map_osm;function createLonLat(b,a){b=parseFloat(b);a=parseFloat(a);return new OpenLayers.LonLat(b,a)}function createBounds(d,c,b,a){d=parseFloat(d);c=parseFloat(c);b=parseFloat(b);a=parseFloat(a);return new OpenLayers.Bounds(d,c,b,a)}function createProjection(a){return new OpenLayers.Projection(a)}var defaultLocation=createLonLat(-100,40);var defaultZoomLevel=11;var sphericalMercatorDefault=true;var maxLatValue=85;var maxExtent=createBounds(-20037508,-20037508,20037508,20037508);var earthCS=createProjection("EPSG:4326");var sphericalMercatorCS=createProjection("EPSG:900913");var sourceProjection=sphericalMercatorCS;var displayProjection=earthCS;var positionMarkerID="location";var latlonReadoutID="ramadda-map-latlonreadout";var ramaddaMaps=new Array();var wrapDatelineDefault=true;var zoomLevelsDefault=30;var ramaddaMapMap={};function ramaddaAddMap(a){ramaddaMaps.push(a)}function RepositoryMap(d,g){d=d||"map";ramaddaMapMap[d]=this;if(!g){g={}}ramaddaAddMap(this);var a=this;$.extend(this,{sourceProjection:sourceProjection,displayProjection:displayProjection,mapId:d,mapDivId:d,showScaleLine:true,showLayerSwitcher:true,showZoomPanControl:true,showZoomOnlyControl:false,showLatLonPosition:true,enableDragPan:true,defaultLocation:defaultLocation,initialZoom:defaultZoomLevel,latlonReadout:latlonReadoutID,map:null,defaultMapLayer:map_default_layer,defaultCanSelect:true,haveAddedDefaultLayer:false,layer:null,markers:null,vectors:null,boxes:null,kmlLayer:null,kmlLayerName:null,geojsonlLayer:null,geojsonLayerName:null,vectorLayers:[],features:{},lines:null,selectorBox:null,selectorMarker:null,listeners:[],initialLayers:[],imageLayers:{}});initMapFunctions(this);var f={pointRadius:3,fillOpacity:0.8,fillColor:"#e6e6e6",fill:true,strokeColor:"#999",strokeWidth:1,scrollToZoom:false,selectOnHover:false,highlightOnHover:true};$.extend(this,f);$.extend(this,g);this.defaults={};var a=this;if(Utils.isDefined(g.onSelect)){this.onSelect=g.onSelect}else{this.onSelect=null}if(g.initialLocation){this.defaultLocation=createLonLat(g.initialLocation[1],g.initialLocation[0])}else{if(Utils.isDefined(g.initialBounds)&&g.initialBounds[0]<=90&&g.initialBounds[0]>=-90){this.defaultBounds=createBounds(g.initialBounds[1],g.initialBounds[2],g.initialBounds[3],g.initialBounds[0])}}this.name="map";var c={projection:this.sourceProjection,displayProjection:this.displayProjection,units:"m",controls:[],maxResolution:156543.0339,maxExtent:maxExtent,div:this.mapDivId,eventListeners:{featureover:function(h){a.handleFeatureover(h.feature)},featureout:function(h){a.handleFeatureout(h.feature)},nofeatureclick:function(h){a.handleNofeatureclick(h.layer)},featureclick:function(h){a.handleFeatureclick(h.layer,h.feature)}}};this.map=new OpenLayers.Map(this.mapDivId,c);if(this.mapHidden){this.map.size=new OpenLayers.Size(1,1)}this.addBaseLayers();if(this.kmlLayer){var b=ramaddaBaseUrl+"/entry/show?output=shapefile.kml&entryid="+this.kmlLayer;this.addKMLLayer(this.kmlLayerName,b,false,null,null,null,null)}if(this.geojsonLayer){var b=getRamadda().getEntryDownloadUrl(this.geojsonLayer);this.addGeoJsonLayer(this.geojsonLayerName,b,false,null,null,null,null)}jQuery(document).ready(function(h){if(a.getMap()){a.getMap().updateSize()}})}function initMapFunctions(a){RamaddaUtil.defineMembers(a,{setMapDiv:function(c){this.mapHidden=false;this.mapDivId=c;a.getMap().render(a.mapDivId);a.getMap().updateSize();a.centerOnMarkers(a.dfltBounds)},handleFeatureover:function(c){layer=c.layer;if(layer.canSelect===false||!(layer.isMapLayer===true)){return}if(!c.isSelected){c.originalStyle=c.style;c.style=null;layer.drawFeature(c,"temporary")}},handleFeatureout:function(c){layer=c.layer;if(layer.canSelect===false||!(layer.isMapLayer===true)){return}c.style=c.originalStyle;if(!c.isSelected){layer.drawFeature(c,c.style||"default")}},handleNofeatureclick:function(c){if(c.canSelect===false){return}if(c&&c.selectedFeature){a.unselectFeature(c.selectedFeature)}},handleFeatureclick:function(d,c){if(!d){d=c.layer}if(d.canSelect===false||!(d.isMapLayer===true)){return}if(d.selectedFeature){d.drawFeature(d.selectedFeature,d.selectedFeature.style||"default");d.selectedFeature.isSelected=false;a.onPopupClose()}a.selectedFeature=c;d.selectedFeature=c;d.selectedFeature.isSelected=true;d.drawFeature(d.selectedFeature,"select");if(d.selectCallback){d.feature=d.selectedFeature;if(c.originalStyle){c.style=c.originalStyle}d.selectCallback(d)}},unselectFeature:function(c){if(!c){return}layer=c.layer;layer.drawFeature(layer.selectedFeature,layer.selectedFeature.style||"default");layer.selectedFeature.isSelected=false;layer.selectedFeature=null;this.selectedFeature=null;this.onPopupClose()},addLayer:function(c){if(this.map!=null){this.map.addLayer(c);this.checkLayerOrder()}else{this.initialLayers.push(c)}},checkLayerOrder:function(){if(this.circles){this.map.setLayerIndex(this.circles,this.map.layers.length-1);this.map.raiseLayer(this.circles,this.map.layers.length-1);this.circles.redraw()}if(this.markers){this.map.setLayerIndex(this.markers,this.map.layers.length-1);this.map.raiseLayer(this.markers,this.map.layers.length-1)}this.map.resetLayersZIndex()}});a.addImageLayer=function(l,d,p,f,h,k,v,q,u,g,x,t){var o=this;var c={forSelect:false,addBox:true,isBaseLayer:false};if(t){OpenLayers.Util.extend(c,t)}if(k>88){k=88}if(q<-88){q=-88}var r=createBounds(v,q,u,k);r=this.transformLLBounds(r);var j=new OpenLayers.Layer.Image(d,f,r,new OpenLayers.Size(g,x),{numZoomLevels:3,isBaseLayer:c.isBaseLayer,resolutions:this.map.layers[0].resolutions,maxResolution:this.map.layers[0].resolutions[0]});if(c.forSelect){a.selectImage=j}var m=new createLonLat(v,k);j.lonlat=this.transformLLPoint(m);j.setVisibility(h);j.id=l;j.text=this.getPopupText(p);j.ramaddaId=l;j.ramaddaName=d;this.addLayer(j);j.north=k;j.west=v;j.south=q;j.east=u;if(!this.imageLayers){this.imageLayers={}}this.imageLayers[l]=j;return j};a.addWMSLayer=function(f,d,g,c){var g=new OpenLayers.Layer.WMS(f,d,{layers:g,format:"image/png",isBaseLayer:false,srs:"epse:4326",transparent:true},{wrapDateLine:wrapDatelineDefault});if(c){g.isBaseLayer=true;g.visibility=false}else{g.isBaseLayer=false;g.visibility=true}this.addLayer(g)};a.addMapLayer=function(f,d,g,c,h){var g;if(/\/tile\//.exec(d)){g=new OpenLayers.Layer.XYZ(f,d,{sphericalMercator:sphericalMercatorDefault,numZoomLevels:zoomLevelsDefault,wrapDateLine:wrapDatelineDefault})}else{g=new OpenLayers.Layer.WMS(f,d,{layers:g,format:"image/png"},{wrapDateLine:wrapDatelineDefault})}if(c){g.isBaseLayer=true}else{g.isBaseLayer=false}g.visibility=false;g.reproject=true;this.addLayer(g);if(h){this.haveAddedDefaultLayer=true;this.map.setLayerIndex(g,0);this.map.setBaseLayer(g)}};a.getVectorLayerStyleMap=function(f,d){var g={pointRadius:this.pointRadius,fillOpacity:this.fillOpacity,fillColor:this.fillColor,fill:this.fill,strokeColor:this.strokeColor,strokeWidth:this.strokeWidth,select_fillOpacity:this.fillOpacity,select_fillColor:"#666",select_strokeColor:"#666",select_strokeWidth:1};if(d){RamaddaUtil.inherit(g,d)}var j=OpenLayers.Util.extend({},OpenLayers.Feature.Vector.style.temporary);$.extend(j,{pointRadius:g.pointRadius,fillOpacity:g.fillOpacity,strokeWidth:g.strokeWidth,strokeColor:g.strokeColor});var c=OpenLayers.Util.extend({},OpenLayers.Feature.Vector.style.select);$.extend(c,{pointRadius:3,fillOpacity:g.select_fillOpacity,fillColor:g.select_fillColor,strokeColor:g.select_strokeColor,strokeWidth:g.select_strokeWidth});var h=OpenLayers.Util.extend({},OpenLayers.Feature.Vector.style["default"]);$.extend(h,{pointRadius:g.pointRadius,fillOpacity:g.fillOpacity,fillColor:g.fillColor,fill:g.fill,strokeColor:g.strokeColor,strokeWidth:g.strokeWidth});map=new OpenLayers.StyleMap({temporary:j,"default":h,select:c});return map};a.onFeatureSelect=function(j){if(this.onSelect){func=window[this.onSelect];func(this,j);return}var q=new OpenLayers.Format.GeoJSON();var t=j.feature;var d=t.style||j.style;var r=q.write(t);var f=t.attributes;var h=t.popupText;if(!h){if(d&&d.balloonStyle){h=d.balloonStyle;for(var k in f){var l=k.replace("_"," ");var m="";if(typeof f[k]=="object"||typeof f[k]=="Object"){var g=f[k];m=g.value}else{m=f[k]}h=h.replace("${"+d.id+"/"+k+"}",m)}}else{h="<table>";for(var k in f){var l=k.replace("_"," ");h+='<tr><td align=right><div style="margin-right:5px;margin-bottom:3px;"><b>'+l+':</b></div></td><td><div style="margin-right:5px;margin-bottom:3px;">';if(f[k]!=null&&(typeof f[k]=="object"||typeof f[k]=="Object")){var g=f[k];h+=g.value}else{h+=f[k]}h+="</div></td></tr>"}h+="</table>"}}if(this.currentPopup){this.map.removePopup(this.currentPopup);this.currentPopup.destroy()}var c=new OpenLayers.Popup.FramedCloud("popup",t.geometry.getBounds().getCenterLonLat(),null,h,null,true,function(){a.onPopupClose()});t.popup=c;c.feature=t;a.map.addPopup(c);a.currentPopup=c};a.onFeatureUnselect=function(c){this.onPopupClose()};a.removeKMLLayer=function(c){this.map.removeLayer(c)};a.setDefaultCanSelect=function(c){this.defaultCanSelect=c};a.getCanSelect=function(c){if(((typeof c)=="undefined")||(c==null)){return this.defaultCanSelect}return c};a.addSelectCallback=function(f,g,c,d){var h=this;if(this.getCanSelect(g)){if(c==null||!Utils.isDefined(c)){c=function(j){h.onFeatureSelect(j)}}if(d==null||!Utils.isDefined(d)){d=function(j){h.onFeatureUnselect()}}f.selectCallback=c;f.unselectCallback=c}};a.initMapVectorLayer=function(g,h,d,f,c){var j=this;this.showLoadingImage();g.isMapLayer=true;g.canSelect=h;g.events.on({loadend:function(k){j.hideLoadingImage();if(k.response&&Utils.isDefined(k.response.code)&&k.response.code==OpenLayers.Protocol.Response.FAILURE){alert("An error occurred loading the map");return}if(j.centerOnMarkersCalled){j.centerOnMarkers(j.dfltBounds,j.centerOnMarkersForce)}if(c){c(j,g)}}});this.addLayer(g);this.addSelectCallback(g,h,d,f)};a.addGeoJsonLayer=function(h,g,l,d,k,f,c){var j=new OpenLayers.Layer.Vector(h,{projection:this.displayProjection,strategies:[new OpenLayers.Strategy.Fixed()],protocol:new OpenLayers.Protocol.HTTP({url:g,format:new OpenLayers.Format.GeoJSON({})})});j.styleMap=this.getVectorLayerStyleMap(j,f);this.initMapVectorLayer(j,l,d,k,c);return j};a.addKMLLayer=function(h,g,l,d,k,f,c){var j=new OpenLayers.Layer.Vector(h,{projection:this.displayProjection,strategies:[new OpenLayers.Strategy.Fixed()],protocol:new OpenLayers.Protocol.HTTP({url:g,format:new OpenLayers.Format.KML({extractStyles:true,extractAttributes:true,maxDepth:2})})});j.styleMap=this.getVectorLayerStyleMap(j,f);this.initMapVectorLayer(j,l,d,k,c);return j};a.addBaseLayers=function(){if(!this.mapLayers){this.mapLayers=[map_osm,map_esri_topo,map_esri_street,map_opentopo,map_usgs_topo,map_usgs_imagery,map_usgs_relief,map_white,map_blue,map_black]}var h=this.defaultMapLayer||map_osm;if(!this.haveAddedDefaultLayer&&h){var d=this.mapLayers.indexOf(h);if(d>=0){this.mapLayers.splice(d,1);this.mapLayers.splice(0,0,h)}}this.firstLayer=null;this.hybridLayer=null;this.defaultOLMapLayer=null;for(i=0;i<this.mapLayers.length;i++){mapLayer=this.mapLayers[i];if(mapLayer==null){continue}var g=null;if(mapLayer==map_google_hybrid){this.hybridLayer=g=new OpenLayers.Layer.Google("Google Hybrid",{type:google.maps.MapTypeId.HYBRID,numZoomLevels:zoomLevelsDefault,sphericalMercator:sphericalMercatorDefault,wrapDateLine:wrapDatelineDefault})}else{if(mapLayer==map_google_streets){g=new OpenLayers.Layer.Google("Google Streets",{numZoomLevels:zoomLevelsDefault,sphericalMercator:sphericalMercatorDefault,wrapDateLine:wrapDatelineDefault})}else{if(mapLayer==map_google_terrain){g=new OpenLayers.Layer.Google("Google Terrain",{numZoomLevels:zoomLevelsDefault,type:google.maps.MapTypeId.TERRAIN,sphericalMercator:sphericalMercatorDefault,wrapDateLine:wrapDatelineDefault})}else{if(mapLayer==map_google_satellite){g=new OpenLayers.Layer.Google("Google Satellite",{type:google.maps.MapTypeId.SATELLITE,numZoomLevels:zoomLevelsDefault,sphericalMercator:sphericalMercatorDefault,wrapDateLine:wrapDatelineDefault})}else{if(mapLayer==map_osm){urls=["//a.tile.openstreetmap.org/${z}/${x}/${y}.png","//b.tile.openstreetmap.org/${z}/${x}/${y}.png","//c.tile.openstreetmap.org/${z}/${x}/${y}.png"];g=new OpenLayers.Layer.OSM("Open Street Map",urls)}else{if(mapLayer==map_ms_shaded){g=new OpenLayers.Layer.VirtualEarth("Virtual Earth - Shaded",{type:VEMapStyle.Shaded,sphericalMercator:sphericalMercatorDefault,wrapDateLine:wrapDatelineDefault,numZoomLevels:zoomLevelsDefault})}else{if(mapLayer==map_ms_hybrid){g=new OpenLayers.Layer.VirtualEarth("Virtual Earth - Hybrid",{type:VEMapStyle.Hybrid,sphericalMercator:sphericalMercatorDefault,numZoomLevels:zoomLevelsDefault,wrapDateLine:wrapDatelineDefault})}else{if(mapLayer==map_ms_aerial){g=new OpenLayers.Layer.VirtualEarth("Virtual Earth - Aerial",{type:VEMapStyle.Aerial,sphericalMercator:sphericalMercatorDefault,numZoomLevels:zoomLevelsDefault,wrapDateLine:wrapDatelineDefault})}else{if(mapLayer==map_opentopo){var f="//a.tile.opentopomap.org/${z}/${x}/${y}.png}";g=new OpenLayers.Layer.XYZ("OpenTopo",f,{sphericalMercator:sphericalMercatorDefault,numZoomLevels:zoomLevelsDefault,wrapDateLine:wrapDatelineDefault})}else{if(mapLayer==map_esri_worldimagery){var f="https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}";g=new OpenLayers.Layer.XYZ("ESRI World Imagery",f,{sphericalMercator:sphericalMercatorDefault,numZoomLevels:zoomLevelsDefault,wrapDateLine:wrapDatelineDefault})}else{if(mapLayer==map_white){this.addImageLayer(map_white,"White Background","",ramaddaBaseUrl+"/images/white.png",false,90,-180,-90,180,50,50,{isBaseLayer:true});continue}else{if(mapLayer==map_blue){this.addImageLayer(map_blue,"Blue Background","",ramaddaBaseUrl+"/images/blue.png",false,90,-180,-90,180,50,50,{isBaseLayer:true});continue}else{if(mapLayer==map_black){this.addImageLayer(map_black,"Black Background","",ramaddaBaseUrl+"/images/black.png",false,90,-180,-90,180,50,50,{isBaseLayer:true});continue}else{if(mapLayer==map_usgs_topo){g=new OpenLayers.Layer.XYZ("USGS Topo","https://basemap.nationalmap.gov/ArcGIS/rest/services/USGSTopo/MapServer/tile/${z}/${y}/${x}",{sphericalMercator:true,isBaseLayer:true,attribution:"USGS - The National Map"})}else{if(mapLayer==map_usgs_imagery){g=new OpenLayers.Layer.XYZ("USGS Imagery","https://basemap.nationalmap.gov/ArcGIS/rest/services/USGSImageryOnly/MapServer/tile/${z}/${y}/${x}",{sphericalMercator:true,isBaseLayer:true,attribution:"USGS - The National Map"})}else{if(mapLayer==map_usgs_relief){g=new OpenLayers.Layer.XYZ("USGS Shaded Relief","https://basemap.nationalmap.gov/ArcGIS/rest/services/USGSShadedReliefOnly/MapServer/tile/${z}/${y}/${x}",{sphericalMercator:true,isBaseLayer:true,attribution:"USGS - The National Map"})}else{if(mapLayer==map_esri_topo){var f="//server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/${z}/${y}/${x}";g=new OpenLayers.Layer.XYZ("ESRI Topo",f,{sphericalMercator:sphericalMercatorDefault,numZoomLevels:zoomLevelsDefault,wrapDateLine:wrapDatelineDefault})}else{if(mapLayer==map_esri_street){var f="//server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/${z}/${y}/${x}";g=new OpenLayers.Layer.XYZ("ESRI Streets",f,{sphericalMercator:sphericalMercatorDefault,numZoomLevels:zoomLevelsDefault,wrapDateLine:wrapDatelineDefault})}else{if(/\/tile\//.exec(mapLayer)){var f=mapLayer;g=new OpenLayers.Layer.XYZ("ESRI China Map",f,{sphericalMercator:sphericalMercatorDefault,numZoomLevels:zoomLevelsDefault,wrapDateLine:wrapDatelineDefault})}else{var c=/wms:(.*),(.*),(.*)/.exec(mapLayer);if(!c){alert("no match for map layer:"+mapLayer);continue}this.addWMSLayer(c[1],c[2],c[3],true)}}}}}}}}}}}}}}}}}}}if(this.firstLayer==null){this.firstLayer=g}if(g!=null){if(mapLayer==this.defaultMapLayer){this.defaultOLMapLayer=g}this.addLayer(g)}}this.graticule=new OpenLayers.Control.Graticule({layerName:"Lat/Lon Lines",numPoints:2,labelled:true,visible:false});this.map.addControl(this.graticule);return};a.initSearch=function(c){$("#"+c).keyup(function(d){if(d.keyCode==13){a.searchMarkers($("#"+c).val())}})};a.searchMarkers=function(p){p=p.trim();p=p.toLowerCase();var m=p=="";var h=$(':input[id*="visibleall_'+this.mapId+'"]');h.prop("checked",m);if(this.markers){var l=this.getMarkers();for(var o=0;o<l.length;o++){k=l[o];var g=true;var f=$("#visible_"+this.mapId+"_"+k.ramaddaId);var c=k.name;if(m){g=true}else{if(!Utils.isDefined(c)){g=false}else{g=c.toLowerCase().includes(p)}}if(g){k.style.display="inline"}else{k.style.display="none"}f.prop("checked",g)}this.markers.redraw()}if(this.boxes&&this.boxes.markers){for(var k in this.boxes.markers){k=this.boxes.markers[k];c=k.name;var g=true;if(m){g=true}else{if(!Utils.isDefined(c)){g=false}else{g=c.toLowerCase().includes(p)}}k.display(g)}this.boxes.redraw()}if(this.lines){var d=this.lines.features;for(var j=0;j<d.length;j++){var q=d[j];c=q.name;var g=true;if(m){g=true}else{if(!Utils.isDefined(c)){g=false}else{g=c.toLowerCase().includes(p)}}if(g){q.style.display="inline"}else{q.style.display="none"}}this.lines.redraw()}};a.setLatLonReadout=function(c){this.latlonReadout=c};a.getMap=function(){return this.map};a.initMap=function(g){this.startTime=Date.now();if(this.inited){return}this.inited=true;var j=this;if(this.enableDragPan){this.map.addControl(new OpenLayers.Control.Navigation({zoomWheelEnabled:this.scrollToZoom,dragPanOptions:{enableKinetic:true}}))}if(this.showZoomPanControl&&!this.showZoomOnlyControl){this.map.addControl(new OpenLayers.Control.PanZoom())}if(this.showZoomOnlyControl&&!this.showZoomPanControl){this.map.addControl(new OpenLayers.Control.Zoom())}if(this.showScaleLine){this.map.addControl(new OpenLayers.Control.ScaleLine())}var t=new OpenLayers.Control();var p=new OpenLayers.Control();var r={keydown:function(v){if(v.keyCode==79){if(!j.imageLayers){return}for(id in j.imageLayers){image=j.imageLayers[id];if(!Utils.isDefined(image.opacity)){image.opacity=1}opacity=image.opacity;if(v.shiftKey){opacity+=0.1}else{opacity-=0.1}if(opacity<0){opacity=0}else{if(opacity>1){opacity=1}}image.setOpacity(opacity)}}if(v.keyCode==84){if(j.selectImage){j.selectImage.setVisibility(!j.selectImage.getVisibility())}}}};var u=new OpenLayers.Handler.Keyboard(p,r,{});u.activate();this.map.addControl(t);this.map.addControl(new OpenLayers.Control.KeyboardDefaults());if(this.showLayerSwitcher){this.map.addControl(new OpenLayers.Control.LayerSwitcher())}if(this.showLatLonPosition){var f=GuiUtils.getDomObject(this.latlonReadout);if(f){this.map.addControl(new OpenLayers.Control.MousePosition({numDigits:3,element:f.obj,prefix:"Position: "}))}else{this.map.addControl(new OpenLayers.Control.MousePosition({numDigits:3,prefix:"Position: "}))}}if(this.initialBoxes){this.initBoxes(this.initialBoxes);this.initialBoxes=null}if(this.defaultLocation&&!this.defaultBounds){var c=this.defaultLocation;var l=10;this.defaultBounds=createBounds(c.lon-l,c.lat-l,c.lon+l,c.lat+l);this.defaultLocation=null}if(this.defaultBounds){var o=this.defaultBounds.getCenterLonLat();var h=this.transformLLPoint(o);this.map.setCenter(h);this.map.zoomToExtent(this.transformLLBounds(this.defaultBounds));this.defaultBounds=null}else{this.map.zoomToMaxExtent()}for(var m=0;m<this.initialLayers.length;m++){this.addLayer(this.initialLayers[m])}this.initialLayers=[];if(g){this.addRegionSelectorControl()}var d=$(':input[id*="visible_'+this.mapId+'"]');var q=this;d.change(function(v){q.checkImageLayerVisibility();q.checkMarkerVisibility();q.checkLinesVisibility();q.checkBoxesVisibility()});var k=$(':input[id*="visibleall_'+this.mapId+'"]');k.change(function(v){d.prop("checked",k.is(":checked"));q.checkImageLayerVisibility();q.checkMarkerVisibility();q.checkLinesVisibility();q.checkBoxesVisibility()})};a.addVectorLayer=function(c,d){this.addLayer(c);if(this.getCanSelect(d)){this.vectorLayers.push(c);var f=this;if(!this.map.featureSelect){this.map.featureSelect=new OpenLayers.Control.SelectFeature(c,{multiple:false,hover:this.selectOnHover,onSelect:function(g){f.showMarkerPopup(g,true)}});this.map.addControl(this.map.featureSelect);this.map.featureSelect.activate()}else{this.map.featureSelect.setLayer(this.vectorLayers)}}};a.isLayerVisible=function(f,d){var c=$("#visible_"+this.mapId+"_"+f);if(c.size()==0&&d!=null){c=$("#visible_"+this.mapId+"_"+d)}if(c.size()==0){return true}return c.is(":checked")};a.initForDrawing=function(){var c=this;if(!c.drawingLayer){this.drawingLayer=new OpenLayers.Layer.Vector("Drawing");this.addLayer(c.drawingLayer)}this.drawControl=new OpenLayers.Control.DrawFeature(c.drawingLayer,OpenLayers.Handler.Point);this.map.addControl(c.drawControl)};a.drawingFeatureAdded=function(c){};a.addClickHandler=function(f,c,g,d){this.lonFldId=f;this.latFldId=c;if(this.clickHandler){return}if(!this.map){return}this.clickHandler=new OpenLayers.Control.Click();this.clickHandler.setLatLonZoomFld(f,c,g,d);this.clickHandler.setTheMap(this);this.map.addControl(this.clickHandler);this.clickHandler.activate()};a.setSelection=function(c,d,f){this.selectRegion=d;this.argBase=c;if(!GuiUtils){return}this.fldNorth=GuiUtils.getDomObject(this.argBase+"_north");if(this.fldNorth==null){this.fldNorth=GuiUtils.getDomObject(this.argBase+".north")}if(this.fldNorth==null){this.fldNorth=GuiUtils.getDomObject(this.mapId+"_north")}this.fldSouth=GuiUtils.getDomObject(this.argBase+"_south");if(!this.fldSouth){this.fldSouth=GuiUtils.getDomObject(this.argBase+".south")}if(this.fldSouth==null){this.fldSouth=GuiUtils.getDomObject(this.mapId+"_south")}this.fldEast=GuiUtils.getDomObject(this.argBase+"_east");if(!this.fldEast){this.fldEast=GuiUtils.getDomObject(this.argBase+".east")}if(this.fldEast==null){this.fldEast=GuiUtils.getDomObject(this.mapId+"_east")}this.fldWest=GuiUtils.getDomObject(this.argBase+"_west");if(!this.fldWest){this.fldWest=GuiUtils.getDomObject(this.argBase+".west")}if(this.fldWest==null){this.fldWest=GuiUtils.getDomObject(this.mapId+"_west")}this.fldLat=GuiUtils.getDomObject(this.argBase+"_latitude");if(!this.fldLat){this.fldLat=GuiUtils.getDomObject(this.argBase+".latitude")}if(this.fldLat==null){this.fldLat=GuiUtils.getDomObject(this.mapId+"_latitude")}this.fldLon=GuiUtils.getDomObject(this.argBase+"_longitude");if(!this.fldLon){this.fldLon=GuiUtils.getDomObject(this.argBase+".longitude")}if(this.fldLon==null){this.fldLon=GuiUtils.getDomObject(this.mapId+"_longitude")}if(this.fldLon){this.addClickHandler(this.fldLon.id,this.fldLat.id);this.setSelectionMarker(this.fldLon.obj.value,this.fldLat.obj.value)}};a.selectionPopupInit=function(){if(!this.inited){this.initMap(this.selectRegion);if(this.argBase&&!this.fldNorth){this.setSelection(this.argBase)}if(this.fldNorth){this.setSelectionBox(this.fldNorth.obj.value,this.fldWest.obj.value,this.fldSouth.obj.value,this.fldEast.obj.value)}if(this.fldLon){this.addClickHandler(this.fldLon.id,this.fldLat.id);this.setSelectionMarker(this.fldLon.obj.value,this.fldLat.obj.value)}}};a.setSelectionBoxFromFields=function(d){if(this.fldNorth){this.setSelectionBox(this.fldNorth.obj.value,this.fldWest.obj.value,this.fldSouth.obj.value,this.fldEast.obj.value);if(this.selectorBox){var c=this.selectorBox.bounds;this.map.setCenter(c.getCenterLonLat());if(d){this.map.zoomToExtent(c)}}}};a.toggleSelectorBox=function(c){if(this.selectorControl){if(c){this.selectorControl.activate();this.selectorControl.box.activate()}else{this.selectorControl.deactivate();this.selectorControl.box.deactivate()}}};a.resetExtent=function(){this.map.zoomToMaxExtent()};a.setSelectionBox=function(k,c,g,f){if(k==""||c==""||g==""||f==""){return}var j=createBounds(c,Math.max(g,-maxLatValue),f,Math.min(k,maxLatValue));if(!this.selectorBox){var d={color:"red",selectable:false};this.selectorBox=this.createBox("","Selector box",k,c,g,f,"",d)}else{this.selectorBox.bounds=this.transformLLBounds(j)}this.setViewToBounds(j);if(this.boxes){this.boxes.redraw()}if(a.selectImage){var h=createBounds(c,g,f,k);h=a.transformLLBounds(h);a.selectImage.extent=h;a.selectImage.redraw()}};a.clearSelectionMarker=function(){if(this.selectorMarker!=null){this.removeMarker(this.selectorMarker);this.selectorMarker=null}};a.clearSelectedFeatures=function(){if(this.map.controls!=null){var c=this.map.controls;for(i=0;i<c.length;i++){if(c[i].displayClass=="olControlSelectFeature"){c[i].unselectAll()}}}};a.setSelectionMarker=function(k,h,g,d){if(!k||!h||k==""||h==""){return}if(this.lonFldId!=null){$("#"+this.lonFldId).val(formatLocationValue(k));$("#"+this.latFldId).val(formatLocationValue(h))}console.log("selectionMarker");var f=new createLonLat(k,h);if(this.selectorMarker==null){this.selectorMarker=this.addMarker(positionMarkerID,f,"","","",20,10)}else{this.selectorMarker.lonlat=this.transformLLPoint(f)}if(this.markers){this.markers.redraw()}if(g){this.map.setCenter(this.selectorMarker.lonlat)}if(d){if(d.zoomOut){var l=this.map.getZoom();l--;if(this.map.isValidZoomLevel(l)){this.map.zoomTo(l)}return}if(d.zoomIn){var l=this.map.getZoom();l++;if(this.map.isValidZoomLevel(l)){this.map.zoomTo(l)}return}var j=d.offset;if(j){var c=this.transformLLBounds(createBounds(k-j,h-j,k+j,h+j));this.map.zoomToExtent(c)}}};a.transformLLBounds=function(d){if(!d){return}var c=d.clone();return c.transform(this.displayProjection,this.sourceProjection)};a.transformLLPoint=function(c){if(!c){return null}var d=c.clone();return d.transform(this.displayProjection,this.sourceProjection)};a.transformProjBounds=function(d){if(!d){return}var c=d.clone();return c.transform(this.sourceProjection,this.displayProjection)};a.transformProjPoint=function(c){if(!c){return}var d=c.clone();return d.transform(this.sourceProjection,this.displayProjection)};a.normalizeBounds=function(f){if(!this.map){return f}var g=f;var d=f.left;var c=f.right;var h=this.map.restrictedExtent;if(!h){h=maxExtent}if(h.left>=0){if(f.left<0){d=f.left+360}if(f.right<0){c=f.right+360}}if(d>c){c=f.right+360}d=Math.max(d,h.left);c=Math.min(c,h.right);g=createBounds(d,f.bottom,c,f.top);return g};a.findSelectionFields=function(){if(this.argBase&&!(this.fldNorth||this.fldLon)){this.setSelection(this.argBase)}};a.selectionClear=function(){this.findSelectionFields();if(this.fldNorth){this.fldNorth.obj.value="";this.fldSouth.obj.value="";this.fldWest.obj.value="";this.fldEast.obj.value=""}else{if(this.fldLat){this.fldLon.obj.value="";this.fldLat.obj.value=""}}if(this.selectorBox&&this.boxes){this.boxes.removeMarker(this.selectorBox);this.selectorBox=null}if(this.selectorMarker&&this.markers){this.removeMarker(this.selectorMarker);this.selectorMarker=null}};a.getMarkers=function(){if(this.markers==null){return[]}return this.markers.features},a.clearRegionSelector=function(c){if(!this.selectorControl){return}if(this.selectorControl.box){this.selectorControl.box.removeBox()}},a.addRegionSelectorControl=function(d){var c=this;if(c.selectorControl){return}c.selectorListener=d;c.selectorControl=new OpenLayers.Control();OpenLayers.Util.extend(c.selectorControl,{draw:function(){this.box=new OpenLayers.Handler.Box(c.selectorControl,{done:this.notice},{keyMask:OpenLayers.Handler.MOD_SHIFT,xxxboxDivClassName:"map-drag-box"});this.box.activate()},notice:function(f){var g=this.map.getLonLatFromPixel(new OpenLayers.Pixel(f.left,f.bottom));var h=this.map.getLonLatFromPixel(new OpenLayers.Pixel(f.right,f.top));g=c.transformProjPoint(g);h=c.transformProjPoint(h);var f=createBounds(g.lon,g.lat,h.lon,h.lat);f=c.normalizeBounds(f);c.setSelectionBox(f.top,f.left,f.bottom,f.right);c.findSelectionFields();if(d){d(f)}if(c.fldNorth){c.fldNorth.obj.value=formatLocationValue(f.top);c.fldSouth.obj.value=formatLocationValue(f.bottom);c.fldWest.obj.value=formatLocationValue(f.left);c.fldEast.obj.value=formatLocationValue(f.right)}}});c.map.addControl(c.selectorControl);c.panControl=new OpenLayers.Control();OpenLayers.Util.extend(c.panControl,{draw:function(){this.box=new OpenLayers.Handler.Drag(c.panControl,{down:this.down,move:this.move},{keyMask:OpenLayers.Handler.MOD_META,boxDivClassName:"map-drag-box"});this.box.activate()},down:function(f){this.firstPoint=this.map.getLonLatFromPixel(new OpenLayers.Pixel(f.x,f.y));this.firstPoint=c.transformProjPoint(this.firstPoint);c.findSelectionFields();if(c.fldNorth){n=this.origNorth=parseFloat(c.fldNorth.obj.value);s=this.origSouth=parseFloat(c.fldSouth.obj.value);w=this.origWest=parseFloat(c.fldWest.obj.value);e=this.origEast=parseFloat(c.fldEast.obj.value);f=this.firstPoint;this.doWest=false;this.doSouth=false;this.doEast=false;this.doNorth=false;if(f.lon<=e&&f.lon>=w&&f.lat<=n&&f.lat>=s){this.doSouth=this.doWest=this.doEast=this.doNorth=true;this.type="center"}else{if(f.lon>e){if(f.lat>n){this.type="ne";this.doEast=this.doNorth=true}else{if(f.lat<s){this.type="se";this.doSouth=this.doEast=true}else{this.type="e";this.doEast=true}}}else{if(f.lon<w){if(f.lat>n){this.type="nw";this.doWest=this.doNorth=true}else{if(f.lat<s){this.type="sw";this.doSouth=this.doWest=true}else{this.type="w";this.doWest=true}}}else{if(f.lat>n){this.type="n";this.doNorth=true}else{this.type="s";this.doSouth=true}}}}}},move:function(h){var g=this.map.getLonLatFromPixel(new OpenLayers.Pixel(h.x,h.y));g=c.transformProjPoint(g);dx=g.lon-this.firstPoint.lon;dy=g.lat-this.firstPoint.lat;newWest=this.origWest;newEast=this.origEast;newSouth=this.origSouth;newNorth=this.origNorth;if(this.doWest){newWest+=dx}if(this.doSouth){newSouth+=dy}if(this.doEast){newEast+=dx}if(this.doNorth){newNorth+=dy}var f=createBounds(newWest,newSouth,newEast,newNorth);f=c.normalizeBounds(f);c.setSelectionBox(f.top,f.left,f.bottom,f.right);c.findSelectionFields();if(!c.fldNorth){return}c.fldNorth.obj.value=f.top;c.fldSouth.obj.value=f.bottom;c.fldWest.obj.value=f.left;c.fldEast.obj.value=f.right}});c.map.addControl(c.panControl)};a.onPopupClose=function(c){if(this.currentPopup){this.map.removePopup(this.currentPopup);this.currentPopup.destroy();this.currentPopup=null;this.hiliteBox("");if(this.selectedFeature){this.unselectFeature(this.selectedFeature)}}};a.findObject=function(f,d){for(i=0;i<d.length;i++){var c=d[i].ramaddaId;if(!c){d[i].id}if(c==f){return d[i]}}return null};a.findMarker=function(c){if(!this.markers){return null}return this.findObject(c,this.getMarkers())};a.findFeature=function(c){return this.features[c]};a.findBox=function(c){if(!this.boxes){return null}return this.findObject(c,this.boxes.markers)};a.hiliteBox=function(c){if(this.currentBox){this.currentBox.setBorder("blue")}this.currentBox=this.findBox(c);if(this.currentBox){this.currentBox.setBorder("red")}};a.checkMarkerVisibility=function(){if(!this.markers){return}var d=this.getMarkers();for(var c=0;c<d.length;c++){marker=d[c];var f=this.isLayerVisible(marker.ramaddaId,marker.parentId);if(f){marker.style.display="inline"}else{marker.style.display="none"}}this.markers.redraw()};a.checkLinesVisibility=function(){if(!this.lines){return}var f=this.lines.features;for(var d=0;d<f.length;d++){var c=f[d];var g=this.isLayerVisible(c.ramaddaId);if(g){c.style.display="inline"}else{c.style.display="none"}}this.lines.redraw()};a.checkBoxesVisibility=function(){if(!this.boxes){return}for(var c in this.boxes.markers){c=this.boxes.markers[c];var d=this.isLayerVisible(c.ramaddaId);c.display(d)}this.boxes.redraw()};a.checkImageLayerVisibility=function(){if(!this.imageLayers){return}for(var c in this.imageLayers){var f=this.isLayerVisible(c);var d=this.imageLayers[c];d.setVisibility(f);if(!f){if(d.box){this.removeBox(d.box);d.box=null}}else{if(d.box){this.removeBox(d.box);d.box=this.createBox(c,"",d.north,d.west,d.south,d.east,d.text,{})}}}};a.hiliteMarker=function(d){var c=this.findMarker(d);if(!c){c=this.findFeature(d)}if(!c&&this.imageLayers){c=this.imageLayers[d]}if(!c){return}this.map.setCenter(c.lonlat);this.showMarkerPopup(c)};a.hideLoadingImage=function(){if(this.loadingImage){this.loadingImage.style.visibility="hidden"}};a.showLoadingImage=function(){if(this.loadingImage){this.loadingImage.style.visibility="inline";return}sz=new OpenLayers.Size();sz.h=50;sz.w=50;width=this.map.viewPortDiv.offsetWidth;height=this.map.viewPortDiv.offsetHeight;position=new OpenLayers.Pixel(width/2-sz.w/2,height/2-sz.h/2);this.loadingImage=OpenLayers.Util.createImage("loadingimage",position,sz,ramaddaBaseUrl+"/icons/mapprogress.gif");this.loadingImage.style.zIndex=1010;this.map.viewPortDiv.appendChild(this.loadingImage)};a.centerOnMarkers=function(h,j){this.centerOnMarkersCalled=true;this.centerOnMarkersForce=j;now=Date.now();var g=null;if(h){if(h.left<-180||h.left>180||h.right<-180||h.right>180||h.bottom<-90||h.bottom>90||h.top<-90||h.top>90){h=createBounds(-180,-90,180,90)}}this.dfltBounds=h;if(!j){if(this.markers){var k=this.markers.getDataExtent();g=this.transformProjBounds(k)}if(this.lines){var k=this.lines.getDataExtent();var c=this.transformProjBounds(k);if(g){g.extend(c)}else{g=c}}for(var d in this.getMap().layers){d=this.getMap().layers[d];if(!d.getDataExtent){continue}if(d.isBaseLayer||!d.getVisibility()){continue}var k=d.getDataExtent();if(k){var f=this.transformProjBounds(k);if(g){g.extend(f)}else{g=f}}}}if(!g){g=h}if(!g){return}if(!this.getMap()){this.defaultBounds=g;return}if(g.getHeight()>160){g.top=80;g.bottom=-80}this.setViewToBounds(g)};a.setViewToBounds=function(c){projBounds=this.transformLLBounds(c);if(projBounds.getWidth()==0){this.getMap().zoomTo(this.initialZoom)}else{this.getMap().zoomToExtent(projBounds)}this.getMap().setCenter(projBounds.getCenterLonLat())};a.setCenter=function(c){var d=this.transformLLPoint(c);this.getMap().setCenter(d)};a.zoomToMarkers=function(){if(!this.markers){return}bounds=this.markers.getDataExtent();if(bounds==null){return}this.getMap().setCenter(bounds.getCenterLonLat());this.getMap().zoomToExtent(bounds)};a.centerToMarkers=function(){if(!this.markers){return}bounds=this.markers.getDataExtent();this.getMap().setCenter(bounds.getCenterLonLat())};a.setInitialCenterAndZoom=function(f,c,d){this.defaultLocation=createLonLat(f,c);this.initialZoom=d};a.getPopupText=function(d,c){if(d==null){return null}if(d.indexOf("base64:")==0){d=window.atob(d.substring(7));if(d.indexOf("{")==0){props=JSON.parse(d);d=props.text;if(!d){d=""}if(c){c.inputProps=props}}}return d};a.seenMarkers={};a.addMarker=function(u,c,j,g,p,x,t,f,A){if(t==null){t=16}if(f==null){f=0}if(!this.markers){this.markers=new OpenLayers.Layer.Vector("Markers");this.addVectorLayer(this.markers,A)}if(!j){j=ramaddaBaseUrl+"/icons/marker.png"}var q=new OpenLayers.Size(t,t);var o=function(B){return new OpenLayers.Pixel(-(B.w/2),-(B.h/2)-f)};var z=new OpenLayers.Icon(j,q,null,o);var r=this.transformLLPoint(c);var m=new OpenLayers.Marker(r,z);var l=new OpenLayers.Feature.Vector(new OpenLayers.Geometry.Point(c.lon,c.lat).transform(this.displayProjection,this.sourceProjection),{description:""},{externalGraphic:j,graphicHeight:t,graphicWidth:t,graphicXOffset:-t/2,graphicYOffset:-t/2});l.ramaddaId=u;l.parentId=x;l.text=this.getPopupText(p,l);l.name=g;l.location=c;m.ramaddaId=u;m.text=this.getPopupText(p,m);m.name=g;m.location=c;var h=c+"";l.locationKey=h;var k=this.seenMarkers[h];if(k==null){k=[];this.seenMarkers[h]=k}else{}k.push(l);var v=this;var y=function(B){v.showMarkerPopup(m,true);if(m.ramaddaClickHandler!=null){m.ramaddaClickHandler.call(null,m)}OpenLayers.Event.stop(B)};m.events.register("click",m,y);m.events.register("touchstart",m,y);var d=this.isLayerVisible(m.ramaddaId,m.parentId);if(!d){m.display(false)}l.what="marker";this.markers.addFeatures([l]);return l};a.initBoxes=function(d){if(!this.getMap()){}this.addLayer(d);d.getFeatureFromEvent=function(f){return null};var c=new OpenLayers.Control.SelectFeature(d);this.getMap().addControl(c);c.activate()};a.removeBox=function(c){if(this.boxes&&c){this.boxes.removeMarker(c);this.boxes.redraw()}};a.addBox=function(c){if(!this.boxes){this.boxes=new OpenLayers.Layer.Boxes("Boxes",{wrapDateLine:wrapDatelineDefault});if(!this.getMap()){this.initialBoxes=this.boxes}else{this.initBoxes(this.boxes)}}this.boxes.addMarker(c);this.boxes.redraw()};a.createBox=function(g,f,k,t,o,q,u,j){if(u.indexOf("base64:")==0){u=window.atob(u.substring(7))}var p={color:"blue",selectable:true,zoomToExtent:false,sticky:false};for(var l in j){p[l]=j[l]}var d=createBounds(t,Math.max(o,-maxLatValue),q,Math.min(k,maxLatValue));var c=this.transformLLBounds(d);box=new OpenLayers.Marker.Box(c);box.sticky=p.sticky;var h=this;if(p.selectable){box.events.register("click",box,function(v){h.showMarkerPopup(box,true);OpenLayers.Event.stop(v)})}var m=new createLonLat(t,k);box.lonlat=this.transformLLPoint(m);box.text=this.getPopupText(u);box.name=f;box.setBorder(p.color,1);box.ramaddaId=g;var r={fillColor:"red",fillOpacity:1,pointRadius:5};if(p.zoomToExtent){this.centerOnMarkers(d)}this.addBox(box);return box};a.circleMarker=function(d,c){myattrs={pointRadius:12,stroke:true,strokeColor:"red",strokeWidth:2,fill:false};if(c){$.extend(myattrs,c)}marker=this.findMarker(d);if(!marker){return null}return this.addPoint(d,marker.location,myattrs)};a.uncircleMarker=function(c){feature=this.features[c];if(feature){this.circles.removeFeatures([feature])}};a.addPoint=function(d,k,l,m,f){var j=k;if(typeof k.x==="undefined"){k=new OpenLayers.Geometry.Point(k.lon,k.lat)}else{j=createLonLat(j.x,j.y)}var h=this;var g=OpenLayers.Util.extend({},OpenLayers.Feature.Vector.style["default"]);$.extend(g,{pointRadius:5,stroke:true,strokeColor:"red",strokeWidth:0,strokeOpacity:0.75,fill:true,fillColor:"blue",fillOpacity:0.75});if(l){$.extend(g,l);if(g.pointRadius<=0){g.pointRadius=1}}if(g.fillColor==""||g.fillColor=="none"){g.fillOpacity=0}if(g.strokeColor==""||g.strokeColor=="none"){g.strokeOpacity=0}var c=new OpenLayers.Geometry.Point(k.x,k.y);c.transform(this.displayProjection,this.sourceProjection);var o=new OpenLayers.Feature.Vector(c,null,g);o.center=c;o.ramaddaId=d;o.text=this.getPopupText(m,o);o.location=j;this.features[d]=o;if(!f){if(this.circles==null){this.circles=new OpenLayers.Layer.Vector("Circles Layer");this.addVectorLayer(this.circles)}this.circles.addFeatures([o])}return o};a.removePoint=function(c){if(this.circles){this.circles.removeFeatures([c])}};a.addRectangle=function(l,k,c,h,g,d,j){var f=[new OpenLayers.Geometry.Point(c,k),new OpenLayers.Geometry.Point(c,h),new OpenLayers.Geometry.Point(g,h),new OpenLayers.Geometry.Point(g,k),new OpenLayers.Geometry.Point(c,k)];return this.addPolygon(l,"",f,d,j)};a.addLine=function(d,c,h,k,g,j,m,f){var l=[new OpenLayers.Geometry.Point(k,h),new OpenLayers.Geometry.Point(j,g)];return this.addPolygon(d,c,l,m,f)};a.addLines=function(k,f,d,c,j){var h=[];for(var g=0;g<c.length;g+=2){h.push(new OpenLayers.Geometry.Point(c[g+1],c[g]))}return this.addPolygon(k,f,h,d,j)};a.removePolygon=function(c){if(this.lines){this.lines.removeFeatures([c])}};var b=0;a.addPolygon=function(f,d,o,p,k){var m=this;for(var j=0;j<o.length;j++){o[j].transform(this.displayProjection,this.sourceProjection)}var l=OpenLayers.Util.extend({},OpenLayers.Feature.Vector.style["default"]);var c=OpenLayers.Util.extend({},l);c.strokeColor="blue";c.strokeWidth=1;if(p){for(key in p){c[key]=p[key]}}if(!this.lines){this.lines=new OpenLayers.Layer.Vector("Lines",{style:l});this.addVectorLayer(this.lines)}var h=new OpenLayers.Geometry.LineString(o);var q=new OpenLayers.Feature.Vector(h,null,c);q.markerPopup=k;q.ramaddaId=f;q.location=new OpenLayers.LonLat(o[0].x,o[0].y);q.name=d;var g=this.isLayerVisible(q.ramaddaId);if(g){q.style.display="inline"}else{q.style.display="none"}this.lines.addFeatures([q]);return q};a.showMarkerPopup=function(d,k){if(this.entryClickHandler&&window[this.entryClickHandler]){if(!window[this.entryClickHandler](this,d)){return}}if(this.currentPopup){this.getMap().removePopup(this.currentPopup);this.currentPopup.destroy()}var l=d.ramaddaId;if(!l){l=d.id}this.hiliteBox(l);var f=this;if(d.inputProps){d.text=this.getPopupText(d.inputProps.text)}var h=d.text;if(k&&d.locationKey!=null){markers=this.seenMarkers[d.locationKey];if(markers.length>1){h="";for(var g=0;g<markers.length;g++){otherMarker=markers[g];if(g>0){h+="<hr>"}if(otherMarker.inputProps){otherMarker.text=this.getPopupText(otherMarker.inputProps.text)}h+=otherMarker.text;if(g>10){break}}}}var c=d.location;if(!c){return}if(typeof c.lon==="undefined"){c=createLonLat(c.x,c.y)}if(!h||h==""){if(c.lat==c.lat){h="Lon: "+c.lat+"<br>Lat: "+c.lon}}var j=this.transformLLPoint(c);popup=new OpenLayers.Popup.FramedCloud("popup",j,null,h,null,true,function(){f.onPopupClose()});if(d.inputProps&&d.inputProps.minSizeX){popup.minSize=new OpenLayers.Size(d.inputProps.minSizeX,d.inputProps.minSizeY)}d.popupText=popup;popup.marker=d;this.getMap().addPopup(popup);this.currentPopup=popup;if(d.inputProps&&d.inputProps.chartType){this.popupChart(d.inputProps)}};a.popupChart=function(d){var h=getOrCreateDisplayManager(d.divId,{},true);var g={entryId:d.entryId};var f=d.title;if(!f){f="Chart"}var c={title:f,layoutHere:true,divid:d.divId,entryId:d.entryId,fields:d.fields,vAxisMinValue:d.vAxisMinValue,vAxisMaxValue:d.vAxisMaxValue,data:new PointData(f,null,null,getRamadda().getRoot()+"/entry/show?entryid="+d.entryId+"&output=points.product&product=points.json&numpoints=1000",g)};h.createDisplay(d.chartType,c)},a.removeMarker=function(c){if(this.markers){this.markers.removeFeatures([c])}}}function formatLocationValue(a){return number_format(a,3,".","")}OpenLayers.Control.Click=OpenLayers.Class(OpenLayers.Control,{listeners:null,addListener:function(a){if(this.listeners==null){this.listeners=[]}this.listeners.push(a)},defaultHandlerOptions:{single:true,"double":false,pixelTolerance:0,stopSingle:false,stopDouble:false},initialize:function(a){this.handlerOptions=OpenLayers.Util.extend({},this.defaultHandlerOptions);OpenLayers.Control.prototype.initialize.apply(this,arguments);this.handler=new OpenLayers.Handler.Click(this,{click:this.trigger},this.handlerOptions)},setLatLonZoomFld:function(d,c,a,b){this.lonFldId=d;this.latFldId=c;this.zoomFldId=a;this.clickListener=b},setTheMap:function(a){this.theMap=a},trigger:function(d){var c=this.theMap.getMap().getLonLatFromViewPortPx(d.xy);var b=this.theMap.transformProjPoint(c);if(this.listeners!=null){for(var a=0;a<this.listeners.length;a++){this.listeners[a](b)}}if(!this.lonFldId){this.lonFldId="lonfld";this.latFldId="latfld";this.zoomFldId="zoomfld"}lonFld=GuiUtils.getDomObject(this.lonFldId);latFld=GuiUtils.getDomObject(this.latFldId);zoomFld=GuiUtils.getDomObject(this.zoomFldId);if(latFld&&lonFld){latFld.obj.value=formatLocationValue(b.lat);lonFld.obj.value=formatLocationValue(b.lon)}if(zoomFld){zoomFld.obj.value=this.theMap.getMap().getZoom()}if(this.clickListener!=null){this.clickListener.handleClick(this,b.lon,b.lat)}}});var CUSTOM_MAP="CUSTOM";var firstCustom=true;var MapUtils={mapRegionSelected:function(b,a){var c=$("#"+b).val();if(c==null){console.log("Error: No map region value");return}if(c==""){this.toggleMapWidget(a,false);return}var d=c.split(",");if(d.length==1){if(d[0]!=CUSTOM_MAP){return}else{if(!firstCustom){this.setMapRegion(a,"","","","","")}firstCustom=false;this.toggleMapWidget(a,true);return}}if(d.length!=5){return}this.toggleMapWidget(a,false);this.setMapRegion(a,d[0],d[1],d[2],d[3],d[4])},setMapRegion:function(b,f,g,a,d,c){$("#"+b+"_regionid").val(f);$("#"+b+"_north").val(g);$("#"+b+"_west").val(a);$("#"+b+"_south").val(d);$("#"+b+"_east").val(c)},toggleMapWidget:function(b,a){if(a){var c=window[b];if(c&&!c.inited){c.initMap(true)}$("#"+b+"_mapToggle").show()}else{$("#"+b+"_mapToggle").hide()}}};var markerMap={};function highlightMarkers(a,d,c,b,f){$(a).mouseenter(function(){if(c){$(this).css("background",c)}if(!$(this).data("mapid")){return}if(d.circleMarker($(this).data("mapid"),{strokeColor:"black",strokeWidth:1,fill:true,fillOpacity:0.5,fillColor:"red"})){return}if(f==null){return}if(!Utils.isDefined($(this).data("latitude"))){console.log("no lat");return}attrs={pointRadius:12,stroke:true,strokeColor:"blue",strokeWidth:2,fill:false};point=d.addPoint(f,new OpenLayers.LonLat($(this).data("longitude"),$(this).data("latitude")),attrs);markerMap[f]=point});$(a).mouseleave(function(){if(b){$(this).css("background",b)}if(!$(this).data("mapid")){return}if(f&&markerMap[f]){d.removePoint(markerMap[f]);markerMap[f]=null}d.uncircleMarker($(this).data("mapid"))})}function ramaddaFindFeature(d,a){for(var b=0;b<d.features.length;b++){var c=d.features[b];var g=c.geometry;if(!g){continue}bounds=g.getBounds();if(!bounds.contains(a.x,a.y)){continue}if(g.components){for(var f=0;f<g.components.length;f++){comp=g.components[f];bounds=comp.getBounds();if(!bounds.contains(a.x,a.y)){continue}if(comp.containsPoint&&comp.containsPoint(a)){return{feature:c,index:b}}}}else{if(!g.containsPoint){console.log("unknown geometry:"+g.CLASS_NAME);continue}if(g.containsPoint(a)){return{feature:c,index:b}}}}return null};