var globalDebug=false;var map_google_terrain="google.terrain";var map_google_streets="google.streets";var map_google_hybrid="google.hybrid";var map_google_satellite="google.satellite";var map_esri_topo="esri.topo";var map_esri_street="esri.street";var map_esri_worldimagery="esri.worldimagery";var map_opentopo="opentopo";var map_usgs_topo="usgs.topo";var map_usgs_imagery="usgs.imagery";var map_usgs_relief="usgs.relief";var map_ms_shaded="ms.shaded";var map_ms_hybrid="ms.hybrid";var map_ms_aerial="ms.aerial";var map_osm="osm";var map_wms_topographic="wms:Topo Maps,//terraservice.net/ogcmap.ashx,DRG";var map_ol_openstreetmap="ol.openstreetmap";var map_default_layer=map_osm;function createLonLat(c,b){c=parseFloat(c);b=parseFloat(b);return new OpenLayers.LonLat(c,b)}function createBounds(f,d,c,b){f=parseFloat(f);d=parseFloat(d);c=parseFloat(c);b=parseFloat(b);return new OpenLayers.Bounds(f,d,c,b)}function createProjection(b){return new OpenLayers.Projection(b)}var defaultLocation=createLonLat(-100,40);var defaultZoomLevel=11;var sphericalMercatorDefault=true;var maxLatValue=85;var maxExtent=createBounds(-20037508,-20037508,20037508,20037508);var earthCS=createProjection("EPSG:4326");var sphericalMercatorCS=createProjection("EPSG:900913");var sourceProjection=sphericalMercatorCS;var displayProjection=earthCS;var positionMarkerID="location";var latlonReadoutID="ramadda-map-latlonreadout";var ramaddaMaps=new Array();var wrapDatelineDefault=true;var zoomLevelsDefault=30;var ramaddaMapMap={};function ramaddaAddMap(b){ramaddaMaps.push(b)}function RepositoryMap(f,h){ramaddaMapMap[f]=this;if(!h){h={}}ramaddaAddMap(this);var b=this;if(f==null){f="map"}$.extend(this,{sourceProjection:sourceProjection,displayProjection:displayProjection,mapId:f,mapDivId:f,showScaleLine:true,showLayerSwitcher:true,showZoomPanControl:true,showZoomOnlyControl:false,showLatLonPosition:true,enableDragPan:true,defaultLocation:defaultLocation,initialZoom:defaultZoomLevel,latlonReadout:latlonReadoutID,map:null,defaultMapLayer:map_default_layer,defaultCanSelect:true,haveAddedDefaultLayer:false,layer:null,markers:null,vectors:null,boxes:null,kmlLayer:null,kmlLayerName:null,geojsonlLayer:null,geojsonLayerName:null,vectorLayers:[],features:{},lines:null,selectorBox:null,selectorMarker:null,listeners:[],initialLayers:[],imageLayers:{}});initMapFunctions(this);var g={pointRadius:3,fillOpacity:0.8,fillColor:"#e6e6e6",strokeColor:"#999",strokeWidth:1,scrollToZoom:false,selectOnHover:false,highlightOnHover:true};$.extend(this,g);$.extend(this,h);this.defaults={};var b=this;if(Utils.isDefined(h.onSelect)){this.onSelect=h.onSelect}else{this.onSelect=null}if(h.initialLocation){this.defaultLocation=createLonLat(h.initialLocation[1],h.initialLocation[0])}else{if(Utils.isDefined(h.initialBounds)&&h.initialBounds[0]<=90&&h.initialBounds[0]>=-90){this.defaultBounds=createBounds(h.initialBounds[1],h.initialBounds[2],h.initialBounds[3],h.initialBounds[0])}}this.name="map";var d={projection:this.sourceProjection,displayProjection:this.displayProjection,units:"m",controls:[],maxResolution:156543.0339,maxExtent:maxExtent,div:this.mapDivId,eventListeners:{featureover:function(j){layer=j.feature.layer;if(layer.canSelect===false||!(layer.isMapLayer===true)){return}if(!j.feature.isSelected){j.feature.originalStyle=j.feature.style;j.feature.style=null;j.feature.layer.drawFeature(j.feature,"temporary")}},featureout:function(j){layer=j.feature.layer;if(layer.canSelect===false||!(layer.isMapLayer===true)){return}j.feature.style=j.feature.originalStyle;if(!j.feature.isSelected){layer.drawFeature(j.feature,j.feature.style||"default")}},nofeatureclick:function(j){layer=j.layer;if(layer.canSelect===false){return}if(layer&&layer.selectedFeature){b.unselectFeature(layer.selectedFeature)}},featureclick:function(j){layer=j.layer;if(!layer){layer=j.feature.layer}if(layer.canSelect===false||!(layer.isMapLayer===true)){return}if(layer.selectedFeature){layer.drawFeature(layer.selectedFeature,layer.selectedFeature.style||"default");layer.selectedFeature.isSelected=false;b.onPopupClose()}b.selectedFeature=j.feature;layer.selectedFeature=j.feature;layer.selectedFeature.isSelected=true;layer.drawFeature(layer.selectedFeature,"select");if(layer.selectCallback){layer.feature=layer.selectedFeature;layer.selectCallback(layer)}}}};this.map=new OpenLayers.Map(this.mapDivId,d);this.addBaseLayers();if(this.kmlLayer){var c=ramaddaBaseUrl+"/entry/show?output=shapefile.kml&entryid="+this.kmlLayer;this.addKMLLayer(this.kmlLayerName,c,false,null,null,null,null)}if(this.geojsonLayer){var c=getRamadda().getEntryDownloadUrl(this.geojsonLayer);this.addGeoJsonLayer(this.geojsonLayerName,c,false,null,null,null,null)}jQuery(document).ready(function(j){if(b.map){b.map.updateSize()}})}function initMapFunctions(b){RamaddaUtil.defineMembers(b,{unselectFeature:function(d){if(!d){return}layer=d.layer;layer.drawFeature(layer.selectedFeature,layer.selectedFeature.style||"default");layer.selectedFeature.isSelected=false;layer.selectedFeature=null;this.selectedFeature=null;this.onPopupClose()},addLayer:function(d){if(this.map!=null){this.map.addLayer(d);this.checkLayerOrder()}else{this.initialLayers.push(d)}},checkLayerOrder:function(){if(this.circles){this.map.setLayerIndex(this.circles,this.map.layers.length-1);this.map.raiseLayer(this.circles,this.map.layers.length-1);this.circles.redraw()}if(this.markers){this.map.setLayerIndex(this.markers,this.map.layers.length-1);this.map.raiseLayer(this.markers,this.map.layers.length-1)}this.map.resetLayersZIndex()}});b.addImageLayer=function(m,f,q,g,j,l,x,r,v,h,y,u){var p=this;var d={forSelect:false,addBox:true};if(u){OpenLayers.Util.extend(d,u)}if(l>88){l=88}if(r<-88){r=-88}var t=createBounds(x,r,v,l);t=this.transformLLBounds(t);var k=new OpenLayers.Layer.Image(f,g,t,new OpenLayers.Size(h,y),{numZoomLevels:3,isBaseLayer:false,resolutions:this.map.layers[0].resolutions,maxResolution:this.map.layers[0].resolutions[0]});if(d.forSelect){b.selectImage=k}var o=new createLonLat(x,l);k.lonlat=this.transformLLPoint(o);k.setVisibility(j);k.id=m;k.text=this.getPopupText(q);k.ramaddaId=m;k.ramaddaName=f;this.addLayer(k);k.north=l;k.west=x;k.south=r;k.east=v;if(!this.imageLayers){this.imageLayers={}}this.imageLayers[m]=k};b.addWMSLayer=function(g,f,h,d){var h=new OpenLayers.Layer.WMS(g,f,{layers:h,format:"image/png",isBaseLayer:false,srs:"epse:4326",transparent:true},{wrapDateLine:wrapDatelineDefault});if(d){h.isBaseLayer=true;h.visibility=false}else{h.isBaseLayer=false;h.visibility=true}this.addLayer(h)};b.addMapLayer=function(g,f,h,d,j){var h;if(/\/tile\//.exec(f)){h=new OpenLayers.Layer.XYZ(g,f,{sphericalMercator:sphericalMercatorDefault,numZoomLevels:zoomLevelsDefault,wrapDateLine:wrapDatelineDefault})}else{h=new OpenLayers.Layer.WMS(g,f,{layers:h,format:"image/png"},{wrapDateLine:wrapDatelineDefault})}if(d){h.isBaseLayer=true}else{h.isBaseLayer=false}h.visibility=false;h.reproject=true;this.addLayer(h);if(j){this.haveAddedDefaultLayer=true;this.map.setLayerIndex(h,0);this.map.setBaseLayer(h)}};b.getVectorLayerStyleMap=function(g,f){var h={pointRadius:this.pointRadius,fillOpacity:this.fillOpacity,fillColor:this.fillColor,strokeColor:this.strokeColor,strokeWidth:this.strokeWidth,select_fillOpacity:this.fillOpacity,select_fillColor:"#666",select_strokeColor:"#666",select_strokeWidth:1};if(f){RamaddaUtil.inherit(h,f)}var k=OpenLayers.Util.extend({},OpenLayers.Feature.Vector.style.temporary);$.extend(k,{pointRadius:h.pointRadius,fillOpacity:h.fillOpacity,strokeWidth:h.strokeWidth,strokeColor:h.strokeColor});var d=OpenLayers.Util.extend({},OpenLayers.Feature.Vector.style.select);$.extend(d,{pointRadius:3,fillOpacity:h.select_fillOpacity,fillColor:h.select_fillColor,strokeColor:h.select_strokeColor,strokeWidth:h.select_strokeWidth});var j=OpenLayers.Util.extend({},OpenLayers.Feature.Vector.style["default"]);$.extend(j,{pointRadius:h.pointRadius,fillOpacity:h.fillOpacity,fillColor:h.fillColor,strokeColor:h.strokeColor,strokeWidth:h.strokeWidth});map=new OpenLayers.StyleMap({temporary:k,"default":j,select:d});return map};b.onFeatureSelect=function(k){if(this.onSelect){func=window[this.onSelect];func(this,k);return}var r=new OpenLayers.Format.GeoJSON();var u=k.feature;var f=u.style;var t=r.write(u);var g=u.attributes;var j=u.popupText;if((typeof j)=="object"){console.log("out:"+(typeof j)+" "+j);for(a in j){console.log("   "+a+"="+j[a])}}if(!j){if(f&&f.balloonStyle){j=f.balloonStyle;for(var l in g){var m=l.replace("_"," ");var q="";if(typeof g[l]=="object"||typeof g[l]=="Object"){var h=g[l];q=h.value}else{q=g[l]}j=j.replace("${"+f.id+"/"+l+"}",q)}}else{j="<table>";for(var l in g){var m=l.replace("_"," ");j+='<tr><td align=right><div style="margin-right:5px;margin-bottom:3px;"><b>'+m+':</b></div></td><td><div style="margin-right:5px;margin-bottom:3px;">';if(g[l]!=null&&(typeof g[l]=="object"||typeof g[l]=="Object")){var h=g[l];console.log("o="+h);j+=h.value}else{j+=g[l]}j+="</div></td></tr>"}j+="</table>"}}if(this.currentPopup){this.map.removePopup(this.currentPopup);this.currentPopup.destroy()}var d=new OpenLayers.Popup.FramedCloud("popup",u.geometry.getBounds().getCenterLonLat(),null,j,null,true,function(){b.onPopupClose()});u.popup=d;d.feature=u;b.map.addPopup(d);b.currentPopup=d};b.onFeatureUnselect=function(d){this.onPopupClose()};b.removeKMLLayer=function(d){this.map.removeLayer(d)};b.setDefaultCanSelect=function(d){this.defaultCanSelect=d};b.getCanSelect=function(d){if(((typeof d)=="undefined")||(d==null)){return this.defaultCanSelect}return d};b.initMapVectorLayer=function(h,k,f,g,d){var m=this;var j=this.showLoadingImage();h.isMapLayer=true;h.canSelect=k;h.events.on({loadend:function(o){m.hideLoadingImage(j);if(m.centerOnMarkersCalled){m.centerOnMarkers(m.dfltBounds,m.centerOnMarkersForce)}if(d){d(m,h)}}});this.addLayer(h);var l=false;if(this.getCanSelect(k)){if(f==null||!Utils.isDefined(f)){f=function(o){m.onFeatureSelect(o)}}if(g==null||!Utils.isDefined(g)){g=function(o){m.onFeatureUnselect()}}h.selectCallback=f;h.unselectCallback=f}};b.addGeoJsonLayer=function(j,h,m,f,l,g,d){var k=new OpenLayers.Layer.Vector(j,{projection:this.displayProjection,strategies:[new OpenLayers.Strategy.Fixed()],protocol:new OpenLayers.Protocol.HTTP({url:h,format:new OpenLayers.Format.GeoJSON({})})});k.styleMap=this.getVectorLayerStyleMap(k,g);this.initMapVectorLayer(k,m,f,l,d);return k};b.addKMLLayer=function(j,h,m,f,l,g,d){console.log("url:"+h);var k=new OpenLayers.Layer.Vector(j,{projection:this.displayProjection,strategies:[new OpenLayers.Strategy.Fixed()],protocol:new OpenLayers.Protocol.HTTP({url:h,format:new OpenLayers.Format.KML({extractStyles:true,extractAttributes:true,maxDepth:2})})});k.styleMap=this.getVectorLayerStyleMap(k,g);this.initMapVectorLayer(k,m,f,l,d);return k};b.addBaseLayers=function(){if(!this.mapLayers){this.mapLayers=[map_osm,map_esri_topo,map_opentopo,map_usgs_topo,map_usgs_imagery,map_usgs_relief]}var d=false;for(var h=0;h<this.mapLayers.length;h++){if(this.mapLayers[h].indexOf("google")>=0){d=true;break}}if(d&&!(google&&google.maps)){console.log("No google maps");return}var l=this.defaultMapLayer;if(!this.haveAddedDefaultLayer&&l){var g=this.mapLayers.indexOf(l);if(g>=0){this.mapLayers.splice(g,1);this.mapLayers.splice(0,0,l)}}this.firstLayer=null;this.hybridLayer=null;this.defaultOLMapLayer=null;for(h=0;h<this.mapLayers.length;h++){mapLayer=this.mapLayers[h];if(mapLayer==null){continue}var k=null;if(mapLayer==map_google_hybrid){this.hybridLayer=k=new OpenLayers.Layer.Google("Google Hybrid",{type:google.maps.MapTypeId.HYBRID,numZoomLevels:zoomLevelsDefault,sphericalMercator:sphericalMercatorDefault,wrapDateLine:wrapDatelineDefault})}else{if(mapLayer==map_google_streets){k=new OpenLayers.Layer.Google("Google Streets",{numZoomLevels:zoomLevelsDefault,sphericalMercator:sphericalMercatorDefault,wrapDateLine:wrapDatelineDefault})}else{if(mapLayer==map_google_terrain){k=new OpenLayers.Layer.Google("Google Terrain",{numZoomLevels:zoomLevelsDefault,type:google.maps.MapTypeId.TERRAIN,sphericalMercator:sphericalMercatorDefault,wrapDateLine:wrapDatelineDefault})}else{if(mapLayer==map_google_satellite){k=new OpenLayers.Layer.Google("Google Satellite",{type:google.maps.MapTypeId.SATELLITE,numZoomLevels:zoomLevelsDefault,sphericalMercator:sphericalMercatorDefault,wrapDateLine:wrapDatelineDefault})}else{if(mapLayer==map_osm){urls=["//a.tile.openstreetmap.org/${z}/${x}/${y}.png","//b.tile.openstreetmap.org/${z}/${x}/${y}.png","//c.tile.openstreetmap.org/${z}/${x}/${y}.png"];k=new OpenLayers.Layer.OSM("Open Street Map",urls)}else{if(mapLayer==map_ms_shaded){k=new OpenLayers.Layer.VirtualEarth("Virtual Earth - Shaded",{type:VEMapStyle.Shaded,sphericalMercator:sphericalMercatorDefault,wrapDateLine:wrapDatelineDefault,numZoomLevels:zoomLevelsDefault})}else{if(mapLayer==map_ms_hybrid){k=new OpenLayers.Layer.VirtualEarth("Virtual Earth - Hybrid",{type:VEMapStyle.Hybrid,sphericalMercator:sphericalMercatorDefault,numZoomLevels:zoomLevelsDefault,wrapDateLine:wrapDatelineDefault})}else{if(mapLayer==map_ms_aerial){k=new OpenLayers.Layer.VirtualEarth("Virtual Earth - Aerial",{type:VEMapStyle.Aerial,sphericalMercator:sphericalMercatorDefault,numZoomLevels:zoomLevelsDefault,wrapDateLine:wrapDatelineDefault})}else{if(mapLayer==map_opentopo){var j="//a.tile.opentopomap.org/${z}/${x}/${y}.png}";k=new OpenLayers.Layer.XYZ("OpenTopo",j,{sphericalMercator:sphericalMercatorDefault,numZoomLevels:zoomLevelsDefault,wrapDateLine:wrapDatelineDefault})}else{if(mapLayer==map_esri_worldimagery){var j="https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}";k=new OpenLayers.Layer.XYZ("ESRI - World Imagery",j,{sphericalMercator:sphericalMercatorDefault,numZoomLevels:zoomLevelsDefault,wrapDateLine:wrapDatelineDefault})}else{if(mapLayer==map_usgs_topo){k=new OpenLayers.Layer.XYZ("USGS Topo","https://basemap.nationalmap.gov/ArcGIS/rest/services/USGSTopo/MapServer/tile/${z}/${y}/${x}",{sphericalMercator:true,isBaseLayer:true,attribution:"USGS - The National Map"})}else{if(mapLayer==map_usgs_imagery){k=new OpenLayers.Layer.XYZ("USGS Imagery","https://basemap.nationalmap.gov/ArcGIS/rest/services/USGSImageryOnly/MapServer/tile/${z}/${y}/${x}",{sphericalMercator:true,isBaseLayer:true,attribution:"USGS - The National Map"})}else{if(mapLayer==map_usgs_relief){k=new OpenLayers.Layer.XYZ("USGS Shaded Relief","https://basemap.nationalmap.gov/ArcGIS/rest/services/USGSShadedReliefOnly/MapServer/tile/${z}/${y}/${x}",{sphericalMercator:true,isBaseLayer:true,attribution:"USGS - The National Map"})}else{if(mapLayer==map_esri_topo){var j="//server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/${z}/${y}/${x}";k=new OpenLayers.Layer.XYZ("ESRI - Topo",j,{sphericalMercator:sphericalMercatorDefault,numZoomLevels:zoomLevelsDefault,wrapDateLine:wrapDatelineDefault})}else{if(mapLayer==map_esri_street){var j="//server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/${z}/${y}/${x}";k=new OpenLayers.Layer.XYZ("ESRI - Streets",j,{sphericalMercator:sphericalMercatorDefault,numZoomLevels:zoomLevelsDefault,wrapDateLine:wrapDatelineDefault})}else{if(/\/tile\//.exec(mapLayer)){var j=mapLayer;k=new OpenLayers.Layer.XYZ("ESRI - China Map",j,{sphericalMercator:sphericalMercatorDefault,numZoomLevels:zoomLevelsDefault,wrapDateLine:wrapDatelineDefault})}else{var f=/wms:(.*),(.*),(.*)/.exec(mapLayer);if(!f){alert("no match for map layer:"+mapLayer);continue}this.addWMSLayer(f[1],f[2],f[3],true)}}}}}}}}}}}}}}}}if(this.firstLayer==null){this.firstLayer=k}if(k!=null){if(mapLayer==this.defaultMapLayer){this.defaultOLMapLayer=k}this.addLayer(k)}}this.graticule=new OpenLayers.Control.Graticule({layerName:"Lat/Lon Lines",numPoints:2,labelled:true,visible:false});this.map.addControl(this.graticule);return};b.initSearch=function(d){$("#"+d).keyup(function(f){if(f.keyCode==13){b.searchMarkers($("#"+d).val())}})};b.searchMarkers=function(q){q=q.trim();var o=q=="";var j=$(':input[id*="visibleall_'+this.mapId+'"]');j.prop("checked",o);if(this.markers){var m=this.getMarkers();for(var p=0;p<m.length;p++){l=m[p];var h=true;var g=$("#visible_"+this.mapId+"_"+l.ramaddaId);var d=l.name;if(o){h=true}else{if(!Utils.isDefined(d)){h=false}else{h=d.includes(q)}}if(h){l.style.display="inline"}else{l.style.display="none"}g.prop("checked",h)}this.markers.redraw()}if(this.boxes&&this.boxes.markers){for(var l in this.boxes.markers){l=this.boxes.markers[l];d=l.name;var h=true;if(o){h=true}else{if(!Utils.isDefined(d)){h=false}else{h=d.includes(q)}}l.display(h)}this.boxes.redraw()}if(this.lines){var f=this.lines.features;for(var k=0;k<f.length;k++){var r=f[k];d=r.name;var h=true;if(o){h=true}else{if(!Utils.isDefined(d)){h=false}else{h=d.includes(q)}}if(h){r.style.display="inline"}else{r.style.display="none"}}this.lines.redraw()}};b.setLatLonReadout=function(d){this.latlonReadout=d};b.getMap=function(){return this.map};b.initMap=function(h){this.startTime=Date.now();if(this.inited){return}this.inited=true;var k=this;if(this.enableDragPan){this.map.addControl(new OpenLayers.Control.Navigation({zoomWheelEnabled:this.scrollToZoom,dragPanOptions:{enableKinetic:true}}))}if(this.showZoomPanControl&&!this.showZoomOnlyControl){this.map.addControl(new OpenLayers.Control.PanZoom())}if(this.showZoomOnlyControl&&!this.showZoomPanControl){this.map.addControl(new OpenLayers.Control.Zoom())}if(this.showScaleLine){this.map.addControl(new OpenLayers.Control.ScaleLine())}var u=new OpenLayers.Control();var q=new OpenLayers.Control();var t={keydown:function(x){if(x.keyCode==79){if(!k.imageLayers){return}for(id in k.imageLayers){image=k.imageLayers[id];if(!Utils.isDefined(image.opacity)){image.opacity=1}opacity=image.opacity;if(x.shiftKey){opacity+=0.1}else{opacity-=0.1}if(opacity<0){opacity=0}else{if(opacity>1){opacity=1}}image.setOpacity(opacity)}}if(x.keyCode==84){if(k.selectImage){k.selectImage.setVisibility(!k.selectImage.getVisibility())}}}};var v=new OpenLayers.Handler.Keyboard(q,t,{});v.activate();this.map.addControl(u);this.map.addControl(new OpenLayers.Control.KeyboardDefaults());if(this.showLayerSwitcher){this.map.addControl(new OpenLayers.Control.LayerSwitcher())}if(this.showLatLonPosition){var g=GuiUtils.getDomObject(this.latlonReadout);if(g){this.map.addControl(new OpenLayers.Control.MousePosition({numDigits:3,element:g.obj,prefix:"Position: "}))}else{this.map.addControl(new OpenLayers.Control.MousePosition({numDigits:3,prefix:"Position: "}))}}if(this.initialBoxes){this.initBoxes(this.initialBoxes);this.initialBoxes=null}if(this.defaultLocation&&!this.defaultBounds){var d=this.defaultLocation;var m=10;this.defaultBounds=createBounds(d.lon-m,d.lat-m,d.lon+m,d.lat+m);this.defaultLocation=null}if(this.defaultBounds){var p=this.defaultBounds.getCenterLonLat();var j=this.transformLLPoint(p);this.map.setCenter(j);this.map.zoomToExtent(this.transformLLBounds(this.defaultBounds));this.defaultBounds=null}else{this.map.zoomToMaxExtent()}for(var o=0;o<this.initialLayers.length;o++){this.addLayer(this.initialLayers[o])}this.initialLayers=[];if(h){this.addRegionSelectorControl()}var f=$(':input[id*="visible_'+this.mapId+'"]');var r=this;f.change(function(x){r.checkImageLayerVisibility();r.checkMarkerVisibility();r.checkLinesVisibility();r.checkBoxesVisibility()});var l=$(':input[id*="visibleall_'+this.mapId+'"]');l.change(function(x){f.prop("checked",l.is(":checked"));r.checkImageLayerVisibility();r.checkMarkerVisibility();r.checkLinesVisibility();r.checkBoxesVisibility()})};b.addVectorLayer=function(d,f){this.addLayer(d);if(this.getCanSelect(f)){this.vectorLayers.push(d);var g=this;if(!this.map.featureSelect){this.map.featureSelect=new OpenLayers.Control.SelectFeature(d,{multiple:false,hover:this.selectOnHover,onSelect:function(h){g.showMarkerPopup(h,true)}});this.map.addControl(this.map.featureSelect);this.map.featureSelect.activate()}else{this.map.featureSelect.setLayer(this.vectorLayers)}}};b.isLayerVisible=function(g,f){var d=$("#visible_"+this.mapId+"_"+g);if(d.size()==0&&f!=null){d=$("#visible_"+this.mapId+"_"+f)}if(d.size()==0){return true}return d.is(":checked")};b.initForDrawing=function(){var d=this;if(!d.drawingLayer){this.drawingLayer=new OpenLayers.Layer.Vector("Drawing");this.addLayer(d.drawingLayer)}this.drawControl=new OpenLayers.Control.DrawFeature(d.drawingLayer,OpenLayers.Handler.Point);this.map.addControl(d.drawControl)};b.drawingFeatureAdded=function(d){};b.addClickHandler=function(g,d,h,f){this.lonFldId=g;this.latFldId=d;if(this.clickHandler){return}if(!this.map){return}this.clickHandler=new OpenLayers.Control.Click();this.clickHandler.setLatLonZoomFld(g,d,h,f);this.clickHandler.setTheMap(this);this.map.addControl(this.clickHandler);this.clickHandler.activate()};b.setSelection=function(d,f,g){this.selectRegion=f;this.argBase=d;if(!GuiUtils){return}this.fldNorth=GuiUtils.getDomObject(this.argBase+"_north");if(this.fldNorth==null){this.fldNorth=GuiUtils.getDomObject(this.argBase+".north")}if(this.fldNorth==null){this.fldNorth=GuiUtils.getDomObject(this.mapId+"_north")}this.fldSouth=GuiUtils.getDomObject(this.argBase+"_south");if(!this.fldSouth){this.fldSouth=GuiUtils.getDomObject(this.argBase+".south")}if(this.fldSouth==null){this.fldSouth=GuiUtils.getDomObject(this.mapId+"_south")}this.fldEast=GuiUtils.getDomObject(this.argBase+"_east");if(!this.fldEast){this.fldEast=GuiUtils.getDomObject(this.argBase+".east")}if(this.fldEast==null){this.fldEast=GuiUtils.getDomObject(this.mapId+"_east")}this.fldWest=GuiUtils.getDomObject(this.argBase+"_west");if(!this.fldWest){this.fldWest=GuiUtils.getDomObject(this.argBase+".west")}if(this.fldWest==null){this.fldWest=GuiUtils.getDomObject(this.mapId+"_west")}this.fldLat=GuiUtils.getDomObject(this.argBase+"_latitude");if(!this.fldLat){this.fldLat=GuiUtils.getDomObject(this.argBase+".latitude")}if(this.fldLat==null){this.fldLat=GuiUtils.getDomObject(this.mapId+"_latitude")}this.fldLon=GuiUtils.getDomObject(this.argBase+"_longitude");if(!this.fldLon){this.fldLon=GuiUtils.getDomObject(this.argBase+".longitude")}if(this.fldLon==null){this.fldLon=GuiUtils.getDomObject(this.mapId+"_longitude")}if(this.fldLon){this.addClickHandler(this.fldLon.id,this.fldLat.id);this.setSelectionMarker(this.fldLon.obj.value,this.fldLat.obj.value)}};b.selectionPopupInit=function(){if(!this.inited){this.initMap(this.selectRegion);if(this.argBase&&!this.fldNorth){this.setSelection(this.argBase)}if(this.fldNorth){this.setSelectionBox(this.fldNorth.obj.value,this.fldWest.obj.value,this.fldSouth.obj.value,this.fldEast.obj.value)}if(this.fldLon){this.addClickHandler(this.fldLon.id,this.fldLat.id);this.setSelectionMarker(this.fldLon.obj.value,this.fldLat.obj.value)}}};b.setSelectionBoxFromFields=function(f){if(this.fldNorth){this.setSelectionBox(this.fldNorth.obj.value,this.fldWest.obj.value,this.fldSouth.obj.value,this.fldEast.obj.value);if(this.selectorBox){var d=this.selectorBox.bounds;this.map.setCenter(d.getCenterLonLat());if(f){this.map.zoomToExtent(d)}}}};b.toggleSelectorBox=function(d){if(this.selectorControl){if(d){this.selectorControl.activate();this.selectorControl.box.activate()}else{this.selectorControl.deactivate();this.selectorControl.box.deactivate()}}};b.resetExtent=function(){this.map.zoomToMaxExtent()};b.setSelectionBox=function(l,d,h,g){if(l==""||d==""||h==""||g==""){return}var k=createBounds(d,Math.max(h,-maxLatValue),g,Math.min(l,maxLatValue));if(!this.selectorBox){var f={color:"red",selectable:false};this.selectorBox=this.createBox("","Selector box",l,d,h,g,"",f)}else{this.selectorBox.bounds=this.transformLLBounds(k)}this.setViewToBounds(k);if(this.boxes){this.boxes.redraw()}if(b.selectImage){var j=createBounds(d,h,g,l);j=b.transformLLBounds(j);b.selectImage.extent=j;b.selectImage.redraw()}};b.clearSelectionMarker=function(){if(this.selectorMarker!=null){this.removeMarker(this.selectorMarker);this.selectorMarker=null}};b.clearSelectedFeatures=function(){if(this.map.controls!=null){var d=this.map.controls;for(i=0;i<d.length;i++){if(d[i].displayClass=="olControlSelectFeature"){d[i].unselectAll()}}}};b.setSelectionMarker=function(l,j,h,f){if(!l||!j||l==""||j==""){return}if(this.lonFldId!=null){$("#"+this.lonFldId).val(formatLocationValue(l));$("#"+this.latFldId).val(formatLocationValue(j))}console.log("selectionMarker");var g=new createLonLat(l,j);if(this.selectorMarker==null){this.selectorMarker=this.addMarker(positionMarkerID,g,"","","",20,10)}else{this.selectorMarker.lonlat=this.transformLLPoint(g)}if(this.markers){this.markers.redraw()}if(h){this.map.setCenter(this.selectorMarker.lonlat)}if(f){if(f.zoomOut){var m=this.map.getZoom();m--;if(this.map.isValidZoomLevel(m)){this.map.zoomTo(m)}return}if(f.zoomIn){var m=this.map.getZoom();m++;if(this.map.isValidZoomLevel(m)){this.map.zoomTo(m)}return}var k=f.offset;if(k){var d=this.transformLLBounds(createBounds(l-k,j-k,l+k,j+k));this.map.zoomToExtent(d)}}};b.transformLLBounds=function(f){if(!f){return}var d=f.clone();return d.transform(this.displayProjection,this.sourceProjection)};b.transformLLPoint=function(d){if(!d){return null}var f=d.clone();return f.transform(this.displayProjection,this.sourceProjection)};b.transformProjBounds=function(f){if(!f){return}var d=f.clone();return d.transform(this.sourceProjection,this.displayProjection)};b.transformProjPoint=function(d){if(!d){return}var f=d.clone();return f.transform(this.sourceProjection,this.displayProjection)};b.normalizeBounds=function(g){if(!this.map){return g}var h=g;var f=g.left;var d=g.right;var j=this.map.restrictedExtent;if(!j){j=maxExtent}if(j.left>=0){if(g.left<0){f=g.left+360}if(g.right<0){d=g.right+360}}if(f>d){d=g.right+360}f=Math.max(f,j.left);d=Math.min(d,j.right);h=createBounds(f,g.bottom,d,g.top);return h};b.findSelectionFields=function(){if(this.argBase&&!(this.fldNorth||this.fldLon)){this.setSelection(this.argBase)}};b.selectionClear=function(){this.findSelectionFields();if(this.fldNorth){this.fldNorth.obj.value="";this.fldSouth.obj.value="";this.fldWest.obj.value="";this.fldEast.obj.value=""}else{if(this.fldLat){this.fldLon.obj.value="";this.fldLat.obj.value=""}}if(this.selectorBox&&this.boxes){this.boxes.removeMarker(this.selectorBox);this.selectorBox=null}if(this.selectorMarker&&this.markers){this.removeMarker(this.selectorMarker);this.selectorMarker=null}};b.getMarkers=function(){if(this.markers==null){return[]}return this.markers.features},b.clearRegionSelector=function(d){if(!this.selectorControl){return}if(this.selectorControl.box){this.selectorControl.box.removeBox()}},b.addRegionSelectorControl=function(f){var d=this;if(d.selectorControl){return}d.selectorListener=f;d.selectorControl=new OpenLayers.Control();OpenLayers.Util.extend(d.selectorControl,{draw:function(){this.box=new OpenLayers.Handler.Box(d.selectorControl,{done:this.notice},{keyMask:OpenLayers.Handler.MOD_SHIFT,xxxboxDivClassName:"map-drag-box"});this.box.activate()},notice:function(g){var h=this.map.getLonLatFromPixel(new OpenLayers.Pixel(g.left,g.bottom));var j=this.map.getLonLatFromPixel(new OpenLayers.Pixel(g.right,g.top));h=d.transformProjPoint(h);j=d.transformProjPoint(j);var g=createBounds(h.lon,h.lat,j.lon,j.lat);g=d.normalizeBounds(g);d.setSelectionBox(g.top,g.left,g.bottom,g.right);d.findSelectionFields();if(f){f(g)}if(d.fldNorth){d.fldNorth.obj.value=formatLocationValue(g.top);d.fldSouth.obj.value=formatLocationValue(g.bottom);d.fldWest.obj.value=formatLocationValue(g.left);d.fldEast.obj.value=formatLocationValue(g.right)}}});d.map.addControl(d.selectorControl);d.panControl=new OpenLayers.Control();OpenLayers.Util.extend(d.panControl,{draw:function(){this.box=new OpenLayers.Handler.Drag(d.panControl,{down:this.down,move:this.move},{keyMask:OpenLayers.Handler.MOD_META,boxDivClassName:"map-drag-box"});this.box.activate()},down:function(g){this.firstPoint=this.map.getLonLatFromPixel(new OpenLayers.Pixel(g.x,g.y));this.firstPoint=d.transformProjPoint(this.firstPoint);d.findSelectionFields();if(d.fldNorth){n=this.origNorth=parseFloat(d.fldNorth.obj.value);s=this.origSouth=parseFloat(d.fldSouth.obj.value);w=this.origWest=parseFloat(d.fldWest.obj.value);e=this.origEast=parseFloat(d.fldEast.obj.value);g=this.firstPoint;this.doWest=false;this.doSouth=false;this.doEast=false;this.doNorth=false;if(g.lon<=e&&g.lon>=w&&g.lat<=n&&g.lat>=s){this.doSouth=this.doWest=this.doEast=this.doNorth=true;this.type="center"}else{if(g.lon>e){if(g.lat>n){this.type="ne";this.doEast=this.doNorth=true}else{if(g.lat<s){this.type="se";this.doSouth=this.doEast=true}else{this.type="e";this.doEast=true}}}else{if(g.lon<w){if(g.lat>n){this.type="nw";this.doWest=this.doNorth=true}else{if(g.lat<s){this.type="sw";this.doSouth=this.doWest=true}else{this.type="w";this.doWest=true}}}else{if(g.lat>n){this.type="n";this.doNorth=true}else{this.type="s";this.doSouth=true}}}}}},move:function(j){var h=this.map.getLonLatFromPixel(new OpenLayers.Pixel(j.x,j.y));h=d.transformProjPoint(h);dx=h.lon-this.firstPoint.lon;dy=h.lat-this.firstPoint.lat;newWest=this.origWest;newEast=this.origEast;newSouth=this.origSouth;newNorth=this.origNorth;if(this.doWest){newWest+=dx}if(this.doSouth){newSouth+=dy}if(this.doEast){newEast+=dx}if(this.doNorth){newNorth+=dy}var g=createBounds(newWest,newSouth,newEast,newNorth);g=d.normalizeBounds(g);d.setSelectionBox(g.top,g.left,g.bottom,g.right);d.findSelectionFields();if(!d.fldNorth){return}d.fldNorth.obj.value=g.top;d.fldSouth.obj.value=g.bottom;d.fldWest.obj.value=g.left;d.fldEast.obj.value=g.right}});d.map.addControl(d.panControl)};b.onPopupClose=function(d){if(this.currentPopup){this.map.removePopup(this.currentPopup);this.currentPopup.destroy();this.currentPopup=null;this.hiliteBox("");if(this.selectedFeature){this.unselectFeature(this.selectedFeature)}}};b.findObject=function(g,f){for(i=0;i<f.length;i++){var d=f[i].ramaddaId;if(!d){f[i].id}if(d==g){return f[i]}}return null};b.findMarker=function(d){if(!this.markers){return null}return this.findObject(d,this.getMarkers())};b.findFeature=function(d){return this.features[d]};b.findBox=function(d){if(!this.boxes){return null}return this.findObject(d,this.boxes.markers)};b.hiliteBox=function(d){if(this.currentBox){this.currentBox.setBorder("blue")}this.currentBox=this.findBox(d);if(this.currentBox){this.currentBox.setBorder("red")}};b.checkMarkerVisibility=function(){if(!this.markers){return}var f=this.getMarkers();for(var d=0;d<f.length;d++){marker=f[d];var g=this.isLayerVisible(marker.ramaddaId,marker.parentId);if(g){marker.style.display="inline"}else{marker.style.display="none"}}this.markers.redraw()};b.checkLinesVisibility=function(){if(!this.lines){return}var g=this.lines.features;for(var f=0;f<g.length;f++){var d=g[f];var h=this.isLayerVisible(d.ramaddaId);if(h){d.style.display="inline"}else{d.style.display="none"}}this.lines.redraw()};b.checkBoxesVisibility=function(){if(!this.boxes){return}for(var d in this.boxes.markers){d=this.boxes.markers[d];var f=this.isLayerVisible(d.ramaddaId);d.display(f)}this.boxes.redraw()};b.checkImageLayerVisibility=function(){if(!this.imageLayers){return}for(var d in this.imageLayers){var g=this.isLayerVisible(d);var f=this.imageLayers[d];f.setVisibility(g);if(!g){if(f.box){this.removeBox(f.box);f.box=null}}else{if(f.box){this.removeBox(f.box);f.box=this.createBox(d,"",f.north,f.west,f.south,f.east,f.text,{})}}}};b.hiliteMarker=function(f){var d=this.findMarker(f);if(!d){d=this.findFeature(f)}if(!d&&this.imageLayers){d=this.imageLayers[f]}if(!d){return}this.map.setCenter(d.lonlat);this.showMarkerPopup(d)};b.hideLoadingImage=function(d){if(!d){d=this.loadingImage}if(d){d.style.visibility="hidden"}};b.showLoadingImage=function(){sz=new OpenLayers.Size();sz.h=50;sz.w=50;width=this.map.viewPortDiv.offsetWidth;height=this.map.viewPortDiv.offsetHeight;position=new OpenLayers.Pixel(width/2-sz.w/2,height/2-sz.h/2);this.loadingImage=OpenLayers.Util.createImage("loadingimage",position,sz,ramaddaBaseUrl+"/icons/mapprogress.gif");this.loadingImage.style.zIndex=1010;this.map.viewPortDiv.appendChild(this.loadingImage);return this.loadingImage};b.centerOnMarkers=function(j,k){this.centerOnMarkersCalled=true;this.centerOnMarkersForce=k;this.dfltBounds=j;now=Date.now();var h=null;if(j){if(j.left<-180||j.right>180||j.bottom<-90||j.top>90){console.log("Got bad dfltBounds:"+j);j=createBounds(-180,-90,180,90)}}if(!k){if(this.markers){var l=this.markers.getDataExtent();h=this.transformProjBounds(l)}if(this.lines){var l=this.lines.getDataExtent();var d=this.transformProjBounds(l);if(h){h.extend(d)}else{h=d}}for(var f in this.map.layers){f=this.map.layers[f];if(!f.getDataExtent){continue}if(f.isBaseLayer||!f.getVisibility()){continue}var l=f.getDataExtent();if(l){var g=this.transformProjBounds(l);if(h){h.extend(g)}else{h=g}}}}if(!h){h=j}if(!h){return}if(!this.map){this.defaultBounds=h;return}if(h.getHeight()>160){h.top=80;h.bottom=-80}this.setViewToBounds(h)};b.setViewToBounds=function(d){projBounds=this.transformLLBounds(d);if(projBounds.getWidth()==0){this.map.zoomTo(this.initialZoom)}else{this.map.zoomToExtent(projBounds)}this.map.setCenter(projBounds.getCenterLonLat())};b.setCenter=function(d){var f=this.transformLLPoint(d);this.map.setCenter(f)};b.zoomToMarkers=function(){if(!this.markers){return}bounds=this.markers.getDataExtent();if(bounds==null){return}this.map.setCenter(bounds.getCenterLonLat());this.map.zoomToExtent(bounds)};b.centerToMarkers=function(){if(!this.markers){return}bounds=this.markers.getDataExtent();this.map.setCenter(bounds.getCenterLonLat())};b.setInitialCenterAndZoom=function(g,d,f){this.defaultLocation=createLonLat(g,d);this.initialZoom=f};b.getPopupText=function(f,d){if(f==null){return null}if(f.indexOf("base64:")==0){f=window.atob(f.substring(7));if(f.indexOf("{")==0){props=JSON.parse(f);f=props.text;if(!f){f=""}if(d){d.inputProps=props}}}return f};b.seenMarkers={};b.addMarker=function(v,d,k,h,q,y,u,g,B){if(u==null){u=16}if(g==null){g=0}if(!this.markers){this.markers=new OpenLayers.Layer.Vector("Markers");this.addVectorLayer(this.markers,B)}if(!k){k=ramaddaBaseUrl+"/icons/marker.png"}var r=new OpenLayers.Size(u,u);var p=function(C){return new OpenLayers.Pixel(-(C.w/2),-(C.h/2)-g)};var A=new OpenLayers.Icon(k,r,null,p);var t=this.transformLLPoint(d);var o=new OpenLayers.Marker(t,A);var m=new OpenLayers.Feature.Vector(new OpenLayers.Geometry.Point(d.lon,d.lat).transform(this.displayProjection,this.sourceProjection),{description:""},{externalGraphic:k,graphicHeight:u,graphicWidth:u,graphicXOffset:-u/2,graphicYOffset:-u/2});m.ramaddaId=v;m.parentId=y;m.text=this.getPopupText(q,m);m.name=h;m.location=d;o.ramaddaId=v;o.text=this.getPopupText(q,o);o.name=h;o.location=d;var j=d+"";m.locationKey=j;var l=this.seenMarkers[j];if(l==null){l=[];this.seenMarkers[j]=l}else{}l.push(m);var x=this;var z=function(C){x.showMarkerPopup(o,true);if(o.ramaddaClickHandler!=null){o.ramaddaClickHandler.call(null,o)}OpenLayers.Event.stop(C)};o.events.register("click",o,z);o.events.register("touchstart",o,z);var f=this.isLayerVisible(o.ramaddaId,o.parentId);if(!f){o.display(false)}m.what="marker";this.markers.addFeatures([m]);return m};b.initBoxes=function(f){if(!this.map){}this.addLayer(f);f.getFeatureFromEvent=function(g){return null};var d=new OpenLayers.Control.SelectFeature(f);this.map.addControl(d);d.activate()};b.removeBox=function(d){if(this.boxes&&d){this.boxes.removeMarker(d);this.boxes.redraw()}};b.addBox=function(d){if(!this.boxes){this.boxes=new OpenLayers.Layer.Boxes("Boxes",{wrapDateLine:wrapDatelineDefault});if(!this.map){this.initialBoxes=this.boxes}else{this.initBoxes(this.boxes)}}this.boxes.addMarker(d);this.boxes.redraw()};b.createBox=function(h,g,l,u,p,r,v,k){if(v.indexOf("base64:")==0){v=window.atob(v.substring(7))}var q={color:"blue",selectable:true,zoomToExtent:false,sticky:false};for(var m in k){q[m]=k[m]}var f=createBounds(u,Math.max(p,-maxLatValue),r,Math.min(l,maxLatValue));var d=this.transformLLBounds(f);box=new OpenLayers.Marker.Box(d);box.sticky=q.sticky;var j=this;if(q.selectable){box.events.register("click",box,function(x){j.showMarkerPopup(box,true);OpenLayers.Event.stop(x)})}var o=new createLonLat(u,l);box.lonlat=this.transformLLPoint(o);box.text=this.getPopupText(v);box.name=g;box.setBorder(q.color,1);box.ramaddaId=h;var t={fillColor:"red",fillOpacity:1,pointRadius:5};if(q.zoomToExtent){this.centerOnMarkers(f)}this.addBox(box);return box};b.circleMarker=function(f,d){myattrs={pointRadius:12,stroke:true,strokeColor:"red",strokeWidth:2,fill:false};if(d){$.extend(myattrs,d)}marker=this.findMarker(f);if(!marker){return null}return this.addPoint(f,marker.location,myattrs)};b.uncircleMarker=function(d){feature=this.features[d];if(feature){this.circles.removeFeatures([feature])}};b.addPoint=function(f,l,m,o,g){var k=l;if(typeof l.x==="undefined"){l=new OpenLayers.Geometry.Point(l.lon,l.lat)}else{k=createLonLat(k.x,k.y)}var j=this;var h=OpenLayers.Util.extend({},OpenLayers.Feature.Vector.style["default"]);$.extend(h,{pointRadius:5,stroke:true,strokeColor:"red",strokeWidth:0,strokeOpacity:0.75,fill:true,fillColor:"blue",fillOpacity:0.75});if(m){$.extend(h,m);if(h.pointRadius<=0){h.pointRadius=1}}if(h.fillColor==""||h.fillColor=="none"){h.fillOpacity=0}if(h.strokeColor==""||h.strokeColor=="none"){h.strokeOpacity=0}var d=new OpenLayers.Geometry.Point(l.x,l.y);d.transform(this.displayProjection,this.sourceProjection);var p=new OpenLayers.Feature.Vector(d,null,h);p.center=d;p.ramaddaId=f;p.text=this.getPopupText(o,p);p.location=k;this.features[f]=p;if(!g){if(this.circles==null){this.circles=new OpenLayers.Layer.Vector("Circles Layer");this.addVectorLayer(this.circles)}this.circles.addFeatures([p])}return p};b.removePoint=function(d){if(this.circles){this.circles.removeFeatures([d])}};b.addRectangle=function(m,l,d,j,h,f,k){var g=[new OpenLayers.Geometry.Point(d,l),new OpenLayers.Geometry.Point(d,j),new OpenLayers.Geometry.Point(h,j),new OpenLayers.Geometry.Point(h,l),new OpenLayers.Geometry.Point(d,l)];return this.addPolygon(m,"",g,f,k)};b.addLine=function(f,d,j,l,h,k,o,g){var m=[new OpenLayers.Geometry.Point(l,j),new OpenLayers.Geometry.Point(k,h)];return this.addPolygon(f,d,m,o,g)};b.addLines=function(l,g,f,d,k){var j=[];for(var h=0;h<d.length;h+=2){j.push(new OpenLayers.Geometry.Point(d[h+1],d[h]))}return this.addPolygon(l,g,j,f,k)};b.removePolygon=function(d){if(this.lines){this.lines.removeAllFeatures();this.lines.removeFeatures([d])}};var c=0;b.addPolygon=function(g,f,p,q,l){var o=this;for(var k=0;k<p.length;k++){p[k].transform(this.displayProjection,this.sourceProjection)}var m=OpenLayers.Util.extend({},OpenLayers.Feature.Vector.style["default"]);var d=OpenLayers.Util.extend({},m);d.strokeColor="blue";d.strokeWidth=1;if(q){for(key in q){d[key]=q[key]}}if(!this.lines){this.lines=new OpenLayers.Layer.Vector("Lines",{style:m});this.addVectorLayer(this.lines)}var j=new OpenLayers.Geometry.LineString(p);var r=new OpenLayers.Feature.Vector(j,null,d);r.markerPopup=l;r.ramaddaId=g;r.location=new OpenLayers.LonLat(p[0].x,p[0].y);r.name=f;var h=this.isLayerVisible(r.ramaddaId);if(h){r.style.display="inline"}else{r.style.display="none"}this.lines.addFeatures([r]);return r};b.showMarkerPopup=function(f,l){if(this.entryClickHandler&&window[this.entryClickHandler]){if(!window[this.entryClickHandler](this,f)){return}}if(this.currentPopup){this.map.removePopup(this.currentPopup);this.currentPopup.destroy()}var m=f.ramaddaId;if(!m){m=f.id}this.hiliteBox(m);var g=this;if(f.inputProps){f.text=this.getPopupText(f.inputProps.text)}var j=f.text;if(l&&f.locationKey!=null){markers=this.seenMarkers[f.locationKey];if(markers.length>1){j="";for(var h=0;h<markers.length;h++){otherMarker=markers[h];if(h>0){j+="<hr>"}if(otherMarker.inputProps){otherMarker.text=this.getPopupText(otherMarker.inputProps.text)}j+=otherMarker.text;if(h>10){break}}}}var d=f.location;if(!d){return}if(typeof d.lon==="undefined"){d=createLonLat(d.x,d.y)}if(!j||j==""){if(d.lat==d.lat){j="Lon: "+d.lat+"<br>Lat: "+d.lon}}var k=this.transformLLPoint(d);popup=new OpenLayers.Popup.FramedCloud("popup",k,null,j,null,true,function(){g.onPopupClose()});if(f.inputProps&&f.inputProps.minSizeX){popup.minSize=new OpenLayers.Size(f.inputProps.minSizeX,f.inputProps.minSizeY)}f.popupText=popup;popup.marker=f;this.map.addPopup(popup);this.currentPopup=popup;if(f.inputProps&&f.inputProps.chartType){this.popupChart(f.inputProps)}};b.popupChart=function(f){var j=getOrCreateDisplayManager(f.divId,{},true);var h={entryId:f.entryId};var g=f.title;if(!g){g="Chart"}var d={title:g,layoutHere:true,divid:f.divId,entryId:f.entryId,fields:f.fields,vAxisMinValue:f.vAxisMinValue,vAxisMaxValue:f.vAxisMaxValue,data:new PointData(g,null,null,getRamadda().getRoot()+"/entry/show?entryid="+f.entryId+"&output=points.product&product=points.json&numpoints=1000",h)};j.createDisplay(f.chartType,d)},b.removeMarker=function(d){if(this.markers){this.markers.removeFeatures([d])}}}function formatLocationValue(b){return number_format(b,3,".","")}OpenLayers.Control.Click=OpenLayers.Class(OpenLayers.Control,{listeners:null,addListener:function(b){if(this.listeners==null){this.listeners=[]}this.listeners.push(b)},defaultHandlerOptions:{single:true,"double":false,pixelTolerance:0,stopSingle:false,stopDouble:false},initialize:function(b){this.handlerOptions=OpenLayers.Util.extend({},this.defaultHandlerOptions);OpenLayers.Control.prototype.initialize.apply(this,arguments);this.handler=new OpenLayers.Handler.Click(this,{click:this.trigger},this.handlerOptions)},setLatLonZoomFld:function(f,d,b,c){this.lonFldId=f;this.latFldId=d;this.zoomFldId=b;this.clickListener=c},setTheMap:function(b){this.theMap=b},trigger:function(f){var d=this.theMap.getMap().getLonLatFromViewPortPx(f.xy);var c=this.theMap.transformProjPoint(d);if(this.listeners!=null){for(var b=0;b<this.listeners.length;b++){this.listeners[b](c)}}if(!this.lonFldId){this.lonFldId="lonfld";this.latFldId="latfld";this.zoomFldId="zoomfld"}lonFld=GuiUtils.getDomObject(this.lonFldId);latFld=GuiUtils.getDomObject(this.latFldId);zoomFld=GuiUtils.getDomObject(this.zoomFldId);if(latFld&&lonFld){latFld.obj.value=formatLocationValue(c.lat);lonFld.obj.value=formatLocationValue(c.lon)}if(zoomFld){zoomFld.obj.value=this.theMap.getMap().getZoom()}if(this.clickListener!=null){this.clickListener.handleClick(this,c.lon,c.lat)}}});var CUSTOM_MAP="CUSTOM";var firstCustom=true;var MapUtils={mapRegionSelected:function(c,b){var d=$("#"+c).val();if(d==null){console.log("Error: No map region value");return}if(d==""){this.toggleMapWidget(b,false);return}var f=d.split(",");if(f.length==1){if(f[0]!=CUSTOM_MAP){return}else{if(!firstCustom){this.setMapRegion(b,"","","","","")}firstCustom=false;this.toggleMapWidget(b,true);return}}if(f.length!=5){return}this.toggleMapWidget(b,false);this.setMapRegion(b,f[0],f[1],f[2],f[3],f[4])},setMapRegion:function(c,g,h,b,f,d){$("#"+c+"_regionid").val(g);$("#"+c+"_north").val(h);$("#"+c+"_west").val(b);$("#"+c+"_south").val(f);$("#"+c+"_east").val(d)},toggleMapWidget:function(c,b){if(b){var d=window[c];if(d&&!d.inited){d.initMap(true)}$("#"+c+"_mapToggle").show()}else{$("#"+c+"_mapToggle").hide()}}};var markerMap={};function highlightMarkers(b,f,d,c,g){$(b).mouseenter(function(){if(d){$(this).css("background",d)}if(!$(this).data("mapid")){return}if(f.circleMarker($(this).data("mapid"),{strokeColor:"blue"})){return}if(g==null){return}if(!Utils.isDefined($(this).data("latitude"))){console.log("no lat");return}attrs={pointRadius:12,stroke:true,strokeColor:"blue",strokeWidth:2,fill:false};point=f.addPoint(g,new OpenLayers.LonLat($(this).data("longitude"),$(this).data("latitude")),attrs);markerMap[g]=point});$(b).mouseleave(function(){if(c){$(this).css("background",c)}if(!$(this).data("mapid")){return}if(g&&markerMap[g]){f.removePoint(markerMap[g]);markerMap[g]=null}f.uncircleMarker($(this).data("mapid"))})};