var ID_SEARCH_ATTRIBUTES="searchattributes",ID_EXPAND_WIKI_MENU="expandwikimenu",ID_EXPANDED_WIKI_MENU="expandedwikimenu",ID_UNEXPANDED_WIKI_MENU="unexpandedwikimenu",ID_LLM_LOADING="llm-loading",ID_LLM_PROMPT_PREFIX="llm-prompt-prefix",ID_LLM_PROMPT_SUFFIX="llm-prompt-suffix",ID_TRANSCRIBE_ADD_FILE="transcribe_addfile",ID_TRANSCRIBE_LABEL="transcribe_label",ID_TRANSCRIBE_PEN="transcribe_pen",ID_TRANSCRIBE_PLAY="transcribe_play",ID_TRANSCRIBE_DELETE="transcribe_delete",ID_TRANSCRIBE_TEXT="transcribe_text",ID_TRANSCRIBE_LOADING="transcribe_loading",wikiPopup=null;function WikiEditor(e,t,i,s,r){if(t){jqid(t).submit((()=>(this.editorChanged=!1,!0))),$(window).bind("beforeunload",(()=>{if(this.editorChanged)return"Changes have been made. Are you sure you want to exit?"}))}this.entryId=e,this.ID_WIKI_PREVIEW="preview",this.ID_WIKI_PREVIEW_INNER="preview_inner",this.ID_WIKI_PREVIEW_LIVE="preview_live",this.ID_WIKI_PREVIEW_CONTENTS="preview_contents",this.ID_WIKI_PREVIEW_OPEN="preview_open",this.ID_WIKI_PREVIEW_CLOSE="preview_close",this.ID_WIKI_PREVIEW_WORDCOUNT="preview_wordcount",this.ID_WIKI_PREVIEW_COPY="preview_copy",this.ID_WIKI_PREVIEW_DOWNLOAD="preview_download",this.ID_WIKI_MESSAGE="message",this.ID_WIKI_MENUBAR="menubar",this.ID_WIKI_POPUP_EDITOR="wiki-popup-editor",this.ID_WIKI_POPUP_OK="wiki-popup-ok",this.ID_WIKI_POPUP_CANCEL="wiki-popup-cancel",this.ID_WIKI_POPUP_TIDY="wiki-popup-tidy",this.ID_WIKI_POPUP_COMPACT="wiki-popup-compact",this.ID_LLM_INPUT="llm-input",this.initAttributes();let o={autoScrollEditorIntoView:!0,copyWithEmptySelection:!0};r&&$.extend(o,r);let a=o.authToken;delete o.authToken,$.extend(this,{id:i,authToken:a,editor:ace.edit(i),formId:t,hidden:s}),this.myDiv=jqid(this.getId()),WikiUtil.addWikiEditor(this),Utils.initDragAndDrop(this.getDiv(),(e=>{let t=this.lastPosition=this.getEditor().renderer.screenToTextCoordinates(e.clientX,e.clientY),i=new(0,ace.require("ace/range").Range)(t.row,t.column,t.row,t.column+5);this.dragMarker&&this.editor.session.removeMarker(this.dragMarker),this.dragMarker=this.getEditor().session.addMarker(i,"ace_active_char","text",!1)}),(e=>{this.clearDragAndDrop()}),((e,t,i,s)=>{this.clearDragAndDrop(),s||(this.lastPosition=this.getEditor().getCursorPosition()),Ramadda.handleDropEvent(e,t,i,this.entryId,this.authToken,((e,t,i,s)=>{this.handleEntryLink(t,i,this.lastPosition,!0,{isImage:s})}))})),this.editor.setBehavioursEnabled(!1),this.editor.setDisplayIndentGuides(!1),this.editor.setKeyboardHandler("emacs"),this.editor.setShowPrintMargin(!1),this.editor.getSession().setUseWrapMode(!0),this.editor.setOptions(o),this.editor.session.setMode("ace/mode/ramadda"),this.toolbar=jqid(this.getId()+"_toolbar"),this.editor.container.addEventListener("contextmenu",(e=>{e.preventDefault(),this.handlePopupMenu(e)})),this.editor.container.addEventListener("mouseup",(e=>{this.handleMouseUp(e)})),this.editor.container.addEventListener("dblclick",(e=>{e.shiftKey&&this.handleMouseUp(e,null,!0)})),this.editor.container.addEventListener("mouseleave",(e=>{this.handleMouseLeave(e)})),this.editor.container.addEventListener("mousemove",(e=>{this.handleMouseMove(e)})),this.editor.getSession().on("change",(e=>{if(this.editorChanged=!0,this.previewShown&&this.previewLive){if(this.previewPending)return;this.previewPending=setTimeout((()=>{this.previewPending=null,this.doPreview(this.entryId,!0)}),100)}})),this.getBlock().find("#"+this.id).append(HU.div([ATTR_STYLE,HU.css(CSS_DISPLAY,DISPLAY_NONE),ATTR_CLASS,"wiki-editor-message",ATTR_ID,this.domId(this.ID_WIKI_MESSAGE)])),this.wikiInitDisplaysButton(),this.initTagSearch(),this.jq("previewbutton").click((()=>{HU.hidePopupObject(),this.doPreview(this.entryId)})),this.jq("color").click((e=>{HU.hidePopupObject(),this.doColor(e)})),this.jq("find").click((()=>{HU.hidePopupObject(),this.doFind()})),this.jq("wordcount").click((()=>{HU.hidePopupObject(),this.doWordcount()})),this.jq("rewrite").click((()=>{HU.hidePopupObject(),this.doLlm()})),this.jq("transcribe").click((()=>{HU.hidePopupObject(),this.transcriber||(this.transcriber=new Transcriber(this,{entryId:this.entryId})),this.transcriber.doTranscribe()})),this.jq("tidy").click((()=>{HU.hidePopupObject(),this.doTidy()}))}function getWikiEditorMenuBlocks(e,t,i){let s=[],r=null,o=e=>{s.push(r={index:s.length,title:e,items:[]})},a=HU.classes(CLASS_MENUITEM,t?HU.classes(CLASS_HOVERABLE,CLASS_HIGHLIGHTABLE):""),n="";return e.forEach((e=>{(e=>{if(e.inline||e.inlineLabel)return void o(e.inline||e.inlineLabel);if(e.label&&!e.p)return n=e.label,void o(e.label);if(e.info)return void r.items.push(HU.div([ATTR_CLASS,a],HU.tag(TAG_I,[],e.info)));if(!e.p)return void console.log("Unknown arg:"+JSON.stringify(e));let t=e.label||e.p,s="";s=Utils.isDefined(e.ex)?String(e.ex):Utils.isDefined(e.d)?String(e.d):"",s=s.trim(),(s.indexOf(" ")>=0||""==s)&&(s='"'+s+'"'),s=s.replace(/\"/g,"&quot;");let l=s;if(s=" "+e.p+"="+s+" ",r){let o,d=t+" "+(e.tt??"")+" "+n;o=s.indexOf("|")>0&&s.indexOf("(")<0?"WikiUtil.chooseInsertText("+HU.squote(i)+","+HU.squote(e.p)+","+HU.squote(l)+","+(e.help?HU.squote(e.help):"null")+")":"WikiUtil.insertText('"+i+"','"+s+"')",i&&(t=HU.onClick(o,t)),r.items.push(HU.div(["data-block-index",r.index,ATTR_DATA_CORPUS,d,ATTR_CLASS,a,ATTR_DATA_TITLE,e.tt??"",ATTR_TITLE,e.tt??"","data-attribute",s],t))}else console.log("no attribute block")})(e)})),s}function getWikiEditorMenuBar(e,t,i){let s="";return s+=HU.tag(TAG_LI,[],HU.div([ATTR_ID,ID_SEARCH_ATTRIBUTES,ATTR_CLASS,HU.classes("wiki-popup-menu-header wiki-popup-menu-link",CLASS_CLICKABLE),ATTR_TITLE,"Search attributes"],HU.getIconImage(ICON_SEARCH))),e.forEach(((e,t)=>{if("string"==typeof e)return;let r,o=e.title;if(i&&o.toLowerCase().startsWith(i)){let e=Utils.makeLabel(o.substring(i.length).trim());""!=e&&(o=e)}0!=e.items.length&&(r=Array.isArray(e.items)?Utils.wrap(e.items,HU.open(TAG_LI),""):e.items,s+=HU.tag(TAG_LI,[],HU.div([ATTR_CLASS,"wiki-popup-menu-header wiki-popup-menu-link "],o)+HU.tag(TAG_UL,[ATTR_CLASS,"wiki-popup-menu-item"],r)))})),HU.div([ATTR_CLASS,"wiki-popup-menubar",ATTR_ID,t],HU.tag(TAG_UL,[ATTR_ID,t+"_inner",ATTR_CLASS,"sf-menu"],s))}function Transcriber(e,t){this.audioChunks=[],this.container=e;let i={appendLabel:"Append",addExtra:!0};t&&$.extend(i,t),this.opts=i}window.WikiUtil||(window.WikiUtil={initWikiEditor(e,t,i,s){let r=i+"_block",o=t+"_block";jqid(s).click((()=>{let e=WikiUtil.getWikiEditor(t);if(HU.isChecked(jqid(s))){jqid(r).css(CSS_DISPLAY,DISPLAY_NONE),jqid(o).css(CSS_DISPLAY,DISPLAY_BLOCK);let s=jqid(i).val();e.getEditor().setValue(s,8),jqid(t).focus()}else{let t=e.getEditor().getValue();jqid(i).val(t),jqid(r).css(CSS_DISPLAY,DISPLAY_BLOCK),jqid(o).css(CSS_DISPLAY,DISPLAY_NONE),jqid(i).focus()}}))},handleWikiEditorSubmit:function(){if(this.wikiEditors)for(a in this.wikiEditors){this.wikiEditors[a].handleSubmit()}},getWikiEditor:function(e){return this.wikiEditors?this.wikiEditors[e]:null},addWikiEditor:function(e,t){this.wikiEditors||(this.wikiEditors={}),t=t||e.getId(),this.wikiEditors[t]=e},insertDisplayText:function(e,t){let i=window.globalDisplayTypesMap[t];if(!i)return void WikiUtil.insertText(t);let s="{{";"group"==i.type?s+="group ":s+="display_"+i.type+" ",i.wiki&&(s+=i.wiki),s+="}} ",wikiPopup&&wikiPopup.hide(),WikiUtil.insertText(e,s)},chooseInsertText:function(e,t,i,s){let r=(i=i.replace(/&quot;/g,"").replace(/"/g,"")).split("|"),o="";r.forEach((i=>{let s=HU.div([ATTR_CLASS,HU.classes(CLASS_MENU_ITEM,CLASS_CLICKABLE),"data-id",e,"data-attr",t,ATTR_DATA_VALUE,i],i);o+=s})),o=HU.div([ATTR_STYLE,HU.css(CSS_MIN_WIDTH,HU.px(200),CSS_MAX_HEIGHT,HU.px(200),CSS_OVERFLOW_Y,OVERFLOW_AUTO,CSS_MARGIN_BOTTOM,HU.px(5))],o),s&&(o=HU.center(HU.div([ATTR_STYLE,HU.css(CSS_MARGIN,HU.px(5))],HU.href(RamaddaUtil.getUrl(s),"Help",[ATTR_TARGET,"_help",ATTR_CLASS,CLASS_BUTTON])))+o);let a=HU.makeDialog({content:o,title:"Select value for"+SPACE+t,header:!0,sticky:!0,draggable:!0,modal:!0});HU.findClass(a,CLASS_BUTTON).button(),HU.findClass(a,CLASS_CLICKABLE).click((function(){WikiUtil.insertText(e,$(this).attr("data-attr")+"="+HU.quote($(this).attr(ATTR_DATA_VALUE))),a.remove()}))},insertText:function(e,t,i){HU.hidePopupObject();let s=HU.getTooltip();s&&s.hide();let r=getHandler(e);if(r)return void r.insertText(t);let o=WikiUtil.getWikiEditor(e);if(o)return void o.insertAtCursor(t);let a=GuiUtils.getDomObject(e);a&&WikiUtil.insertAtCursor(e,a.obj,t,i)},insertAtCursor:function(e,t,i,s){let r=WikiUtil.getWikiEditor(e);if(!i.entryId||!r)return r?(i=Utils.decodeText(i),void r.insertAtCursor(i)):void HU.insertIntoTextarea(t,i,s);r.handleEntryLink(i.entryId,i.name,null,!1,i)},insertTags:function(e,t,i,s){HU.hidePopupObject();let r=getHandler(e);if(r)return void r.insertTags(t,i,s);let o=WikiUtil.getWikiEditor(e);o?o.insertTags(t,i,s):console.log("Could not find editor:"+e)},insertTagsInner:function(e,t,i,s,r){let o;i=Utils.decodeText(i),s=Utils.decodeText(s);let a=WikiUtil.getWikiEditor(e);if(a){a=a.getEditor();let e=i+s+" ",t=a.getCursorPosition();return a.insert(e),i.endsWith("\n")?(t.row++,t.column=0):t.column+=i.length,a.selection.moveTo(t.row,t.column),void a.focus()}if(t.selectionStart||"0"==t.selectionStart){let e=t.scrollTop;t.focus();let r=t.selectionStart,a=t.selectionEnd;return o=t.value.substring(r,a),t.value=t.value.substring(0,r)+i+o+s+t.value.substring(a,t.value.length),t.selectionStart=r+i.length+o.length+s.length,t.selectionEnd=t.selectionStart-s.length,void(t.scrollTop=e)}if(document.selection&&document.selection.createRange){let e;document.documentElement&&document.documentElement.scrollTop?e=document.documentElement.scrollTop:document.body&&(e=document.body.scrollTop),t.focus();let r=document.selection.createRange();o=r.text,r.text=i+o+s,r.select&&r.select(),document.documentElement&&document.documentElement.scrollTop?document.documentElement.scrollTop=e:document.body&&(document.body.scrollTop=e)}}}),WikiEditor.prototype={getId:function(){return this.id},domId:function(e){return this.getId()+"_"+e},getTranscribeAnchor:function(){return this.getScroller()},handleTranscribeText:function(e){this.getEditor().session.insert(this.getEditor().getCursorPosition(),e.trim())},handleEntryLink:function(e,t,i,s,r){$.getJSON(HU.url(RamaddaUtil.getUrl("/wiki/getmacros"),ARG_ENTRYID,e),(o=>{let a=[];o.forEach((t=>{if(!t.macro&&t.tag)return void a.push({label:t.label,value:t.tag});a.push({label:t.label+" - macro",value:'{{macro name="'+t.name+'" '+(t.properties??"")+'  entry="${entryid}"}}'});let i=t.macro.trim(),s=i.split('#entry="${entry}"');i=s.join("entry="+e),a.push({label:t.label+" - wiki text",value:i})})),this.handleEntryLinkInner(e,t,i,s,r,a)})).fail((o=>{console.log("failed to get macros"),this.handleEntryLinkInner(e,t,i,s,r)}))},handleEntryLinkInner:function(e,t,i,s,r,o){let a=HU.center(HU.b(t));a+=s?HU.br("The new entry has been added. What do you want to insert into the document?"):HU.br("What do you want to insert into the document?");let n=[];const l="ID",d=",ID",p="Import",h="entry=ID",c="Link",T="Wiki Text",u="Description",_="Image",I="Editable map",S="Tree",A="Grid",g="Gallery",m="Children IDS",E="Children Links",U="nothing",f="Thumbnail";o&&o.forEach((e=>{e.label?n.push({label:e.label,value:"base64:"+window.btoa(e.value)}):n.push(e)})),s?(r.isImage&&n.push(_),n.push(l),n.push(d),n.push(h),n.push(c),n.push(U)):(n.push(l),n.push(d),n.push(h),n.push(c),n.push(T),n.push(u),r.isImage&&n.push(_),n.push(f),r.isGeo&&n.push("Map"),"geo_editable_json"==r.entryType&&n.push(I),r.isGroup&&(n.push(S),n.push(A),n.push(g)),n.push(p),n.push(m),n.push(E)),a+=HU.select("",[ATTR_ID,this.domId("addtype")],n,this.lastWhat),a+=HU.p(),a+=HU.buttons([HU.div([ATTR_STYLE,HU.css(CSS_DISPLAY,DISPLAY_INLINE_BLOCK),ATTR_CLASS,CLASS_BUTTON,ATTR_ID,this.domId("addok")],LABEL_OK),HU.div([ATTR_STYLE,HU.css(CSS_DISPLAY,DISPLAY_INLINE_BLOCK),ATTR_CLASS,CLASS_BUTTON,ATTR_ID,this.domId("addcancel")],LABEL_CANCEL)]),a=HU.div([ATTR_STYLE,HU.css(CSS_PADDING,HU.px(10),CSS_WIDTH,HU.px(400))],a);this.addDialog=HU.makeDialog({content:a,anchor:this.getScroller(),title:"Select Entry",header:!0,sticky:!0,draggable:!0,modal:!0});let L=jqid(this.domId("addtype"));HU.initSelect(L),jqid(this.domId("addcancel")).button().click((()=>{this.addDialog.remove()})),jqid(this.domId("addok")).button().click((()=>{this.addDialog.remove();let s=this.lastWhat=L.val();s=Utils.convertText(s);let r="",o=e=>{i?this.getEditor().session.insert(i,e):this.insertAtCursor(e)};if(s==_)r="{{image entry="+e+' #caption="'+t+'" #width=75% #screenshot=true bordercolor="#ccc" align=center  }} ';else if("Map"==s)r="{{map entry="+e+" details=true}}";else if(s==I)r="{{editable_map entry="+e+" }}";else if(s==S)r="{{tabletree entry="+e+" }}";else if(s==l)r=e;else if(s==d)r=","+e;else if(s==h)r=" entry="+e+" ";else if(s==g)r="{{gallery entry="+e+" }}";else if(s==p)r="{{import entry="+e+" showTitle=false}}";else if(s==A)r="{{grid entry="+e+" }}";else{if(s==f)return void getGlobalRamadda().getEntry(e,(e=>{let t=e.getImageProperties();if(0==t.length)return void alert("No image properties are available");let i=e=>{console.log(e.url),o("{{image src="+HU.quote(e.url)+"\n #caption="+HU.quote(e.label??"")+'\n #width=75% #screenshot=true bordercolor="#ccc" align=center  }} ')};if(1==t.length)return void i(t[0]);let s=[HU.div([ATTR_ACTION,ACTION_OK,ATTR_CLASS,HU.classes(CLASS_BUTTON,CLASS_CLICKABLE)],LABEL_OK),HU.div([ATTR_ACTION,ACTION_CANCEL,ATTR_CLASS,HU.classes(CLASS_BUTTON,CLASS_CLICKABLE)],LABEL_CANCEL)],r=HU.buttons(s),a=HU.open(TAG_FORM);t.forEach(((e,t)=>{let i=HU.image(e.url,[ATTR_WIDTH,HU.px(250)]),s=HU.radio("image","image","imageselect","true",0==t,HU.attrs(ATTR_INDEX,t));a+=HU.div([ATTR_CLASS,CLASS_MENU_ITEM],s+SPACE+i)})),a+=HU.close(TAG_FORM),r+=HU.div([ATTR_STYLE,HU.css(CSS_MAX_HEIGHT,HU.px(300),CSS_OVERFLOW_Y,OVERFLOW_AUTO)],a);let n={anchor:this.toolbar,decorate:!0,title:"Select Image",header:!0,at:POS_LEFT_BOTTOM,my:POS_LEFT_TOP,content:r,draggable:!0},l=HU.makeDialog(n);l.find(HU.dotClass(CLASS_CLICKABLE)).button().click((function(){$(this).attr(ATTR_ACTION)==ACTION_OK&&l.find(".imageselect").each((function(){if(HU.isChecked($(this))){console.log($(this).attr(ATTR_INDEX));let e=+$(this).attr(ATTR_INDEX);i(t[e])}})),l.remove()}))}));if(s==T||s==u||s==m||"Children Links"==s){let t=HU.url(RamaddaUtils.getUrl("/entry/wikitext"),ARG_ENTRYID,e,ARG_RESPONSE,"json");return s==u?t=HU.url(t,ATTR_WHAT,"description"):s==E?t=HU.url(t,ATTR_WHAT,"children_links"):s==m&&(t=HU.url(t,ATTR_WHAT,"children_ids")),void $.get(t,(e=>{e=(e=String(e).replace(/^ *<wiki>\s/,"")).replace(/{{description}}/g,"").replace(/{{description +wikify=\"?true\"?}}/g,""),o(e)})).fail((e=>{let i="";e.responseJSON&&(i=e.responseJSON.error),console.log(t),console.dir(e),alert("An error occurred processing the URL:"+i)}))}if(s==c)r="[["+e+"|"+t+"]] ";else{if(s==U)return;s.indexOf("${entryid}")>=0&&(s=s.replace(/\${entryid}/g,e)),r=s.trim()}}o(r)}))},clearDragAndDrop:function(){this.dragMarker&&this.getEditor().session.removeMarker(this.dragMarker)},getDiv:function(){return this.myDiv},jq:function(e){return jqid(this.domId(e))},showMessage:function(e){this.jq(this.ID_WIKI_MESSAGE).css(CSS_DISPLAY,DISPLAY_BLOCK).html(e)},clearMessage:function(e){this.jq(this.ID_WIKI_MESSAGE).css(CSS_DISPLAY,DISPLAY_NONE),this.showingEntryPopup=!1},getEditor:function(){return this.editor},getValue:function(){return this.getEditor().getValue()},setValue:function(e){this.getEditor().setValue(e)},getBlock:function(){return jqid(this.getId()+"_block")},getScroller:function(){return HU.findClass(this.getBlock(),"ace_scroller")},getSession:function(){return this.getEditor().session},insertAtCursor:function(e){if(e=Utils.decodeText(e),this.popupShowing){let t=this.jq(this.ID_WIKI_POPUP_EDITOR)[0];if(t)return WikiUtil.insertAtCursor(null,t,e),t.focus(),this.jq(this.ID_WIKI_MENUBAR).find(HU.dotClass("wiki-popup-menu-item")).css(CSS_DISPLAY,DISPLAY_NONE),void setTimeout((()=>{this.jq(this.ID_WIKI_MENUBAR).find(HU.dotClass("wiki-popup-menu-item")).removeAttr(ATTR_STYLE)}),1e3)}this.getEditor().getCursorPosition();this.getEditor().insert(e),this.getEditor().focus()},insertTags:function(e,t,i){e=Utils.decodeText(e),t=Utils.decodeText(t),i=Utils.decodeText(i);let s=this.getEditor().getSelectedText(),r=(e??"")+(s?s+"\n":"")+(t??"")+" ",o=this.getEditor().getCursorPosition();this.getEditor().insert(r),e.endsWith("\n")?(o.row++,o.column=0):o.column+=e.length,this.getEditor().selection.moveTo(o.row,o.column),this.getEditor().focus()},getTagInfo:function(e){let t;e=e||this.getEditor().getCursorPosition();let i=this.getSession().doc.positionToIndex(e),s=this.getEditor().getValue(),r=-1,o=-1,a=!1,n=i,l=-1,d=/[0-9a-f\-]/;for(;n>=0;){let e=s[n];if(!e||!e.match(d))break;l=n--}let p=i;if(l>=0)for(n=i+1;n<s.length;){if(!s[n].match(d))break;p=n++}if(l>=0){let e=s.substring(l,p+1);e.match(/[0-9a-f\-]+-[0-9a-f\-]+-[0-9a-f\-]+-[0-9a-f\-]+-[0-9a-f\-]+/)&&(t=e)}for(n=i;n>=0;){if("{"!=s[n])a=!1,n--;else{if(a){r=n;break}a=!0,n--}}if(r>=0)for(a=!1,n=r;n<s.length;)if("}"!=s[n])n++,a=!1;else{if(a){o=n;break}a=!0,n++}if(i>=r&&i<=o&&r>=0&&o>=r){let e,i=s.substring(r,o+1),a=i.match(/\{\{ *([^ \n\}]+)/);if(a&&a.length>1&&(e=a[1]),e){let s="",n=i.trim().substring(2),l=n.indexOf(" "),d=n.indexOf("}}");n=-1!=l&&l<d?n.substring(l).trim():n.substring(d).trim(),n.endsWith("}}")&&(n=n.replace(/}}$/,"")),"group"==e?(s="group",e="display"):e.startsWith("display_")?(s=e.substring(8),e="display"):(a=i.match(/type *= *\"([^\"]+)\"?/),a&&a.length>1&&(s=a[1]));let p=0,h=this.getSession().doc.getAllLines(),c=0,T=-1,u=-1,_=-1,I=-1,S=r+1,A=o+1;h.every((e=>{let t=p+e.length+1;return-1==T&&t>=S&&(T=c,_=S-p-1),-1!=T&&-1==u&&t>=A?(u=c,I=A-p,!1):(c++,p=t,!0)}));let g={start:{row:T,column:_},end:{row:u,column:I}};return g=new(0,ace.require("ace/range").Range)(T,_,u,I),{range:g,entryId:t,tag:e,type:s,left:r,right:o,chunk:i,attrs:n}}}let h=i;for("\n"==s[h]&&h--;h>=0&&"\n"!==s[h];)h--;if(h<0&&"+"==s[h+1]&&(h=0),h>=0){let t=s.substring(h).trim();if(t.startsWith("+")){let i=t.indexOf("\n");i>=0&&(t=t.substring(0,i));let s=t.length,r=t.match("[^ ]+([^\n]*)$");if(r&&(r=r[1].trim()),!t)return null;let o=t.match("\\+([^ \n]+)[ \n]");if(!o)return;return t=o[1],{range:new(0,ace.require("ace/range").Range)(e.row,0,e.row,s),tag:t,type:"plus",attrs:r||""}}}return t?{entryId:t}:null},handleSubmit:function(){0==jqid(this.hidden).length&&console.log("WikiEdit.handleSubmit: no hidden value"),jqid(this.hidden).val(this.getEditor().getValue())},doFind:function(e){this.getEditor().execCommand("find")},doWordcount:function(e){null==e&&(e=this.getEditor().getValue()),e=e.replace(/<[^>]+>/g," ").replace(/<\/[^>]>/g," ").replace(/&nbsp;/g," "),e=Utils.split(e.replace(/[<>\n={}]/g," ")," ",!0,!0),alert("Approximately "+e.length+" words")},doTidy:function(){if(!confirm("This will remove blank links and trim each line. Continue?"))return;let e=this.getValue(),t="",i=(e,i)=>{t+=i?e+"\n":e.trim()+"\n"},s=!1,r=0;Utils.split(e,"\n").forEach((e=>{if(e.startsWith("-javascript"))return s=!1,void i(e);if(e.startsWith("+javascript"))return s=!0,void i(e);if(s){let i=e.trim(),s="",o=!0;if((i.match(/\}+\);?/)||i.match(/\} *,/))&&(r--,o=!1),r<0&&(r=0),new Array(r).fill(0).forEach((e=>{s+="\t"})),t+=s+i+"\n",i.startsWith("//")||!o)return;i.endsWith("{")?r++:(i.endsWith("}")||i.endsWith("});")||i.endsWith("});"))&&r--}else if(e.length<80)i(e);else if(e.startsWith(":"))i(e);else{for(e=e.trim();e.length>80;){let t=e.substring(0,80),s=e.substring(80),r=s.indexOf(" ");if(r<0){i(e),e="";break}i(t+s.substring(0,r)),e=s.substring(r)}""!=e&&i(e)}})),this.setValue(t)},doLlm:function(){this.addedLlmListener||this.editor.getSession().selection.on("changeSelection",(()=>{let e=this.getEditor().getSelectedText();Utils.stringDefined(e)&&!this.llmReplacing&&this.jq(this.ID_LLM_INPUT).val(e)}));let e=this.getEditor().getSelectedText()??"",t=[{value:"",label:"Select prompt"}],i=[{label:"Rewrite for college reader",prompt:"Rewrite the following text for a college educated reader:"},{label:"Rewrite for 5th grader",prompt:"Rewrite the following text for a 5th grade reader:"},"Can you give a short description of the below topic:","Write a comprehensive guide for the below topic:","Write a blog post on the below topic:",{label:"Make a lesson plan for the below topic",prompt:"I need help developing a lesson plan on the below topic for college studentss. The topic is:"},{label:"Check spelling",prompt:"List all of the words in the following text that are misspelled:"},{label:"Translate to English",prompt:"I want you to act as an English translator, spelling corrector and improver. I will speak to you in any language and you will detect the language, translate it and answer in the corrected and improved version of my text, in English. I want you to replace my simplified A0-level words and sentences with more beautiful and elegant, upper level English words and sentences. Keep the meaning same, but make them more literary. I want you to only reply the correction, the improvements and nothing else, do not write explanations."},{label:"Translate to Spanish",prompt:"I want you to act as an Spanish translator, spelling corrector and improver. I will speak to you in English and you will  translate it to Spanish and answer in the corrected and improved version of my text, in Spanish. I want you to only reply the correction, the improvements and nothing else, do not write explanations."},{label:"Translate to French",prompt:"I want you to act as an French translator, spelling corrector and improver. I will speak to you in English and you will  translate it to French and answer in the corrected and improved version of my text, in French. I want you to only reply the correction, the improvements and nothing else, do not write explanations."}];i.forEach(((e,i)=>{e.label?t.push({value:i,label:e.label}):t.push({value:i,label:e})}));let s=HU.getUniqueId(),r=HU.formTable()+HU.formEntryLabel("Prompt",HU.div([ATTR_ID,s]))+HU.formEntry("","Or enter prompt:")+HU.formEntryLabel("Prompt prefix",HU.textarea("",this.lastPromptPrefix??"",[ATTR_CLASS,"wiki-llm-input",ATTR_STYLE,HU.css(CSS_WIDTH,HU.px(500)),ATTR_ID,this.domId(ID_LLM_PROMPT_PREFIX),ATTR_ROWS,3]))+HU.formTableClose(),o=HU.css(CSS_BORDER,CSS_BASIC_BORDER,CSS_PADDING,HU.px(4),CSS_MARGIN,HU.px(4),CSS_FONT_STYLE,FONT_ITALIC);r+=HU.textarea("",e,[ATTR_PLACEHOLDER,"Enter input or select text in editor",ATTR_ID,this.domId(this.ID_LLM_INPUT),ATTR_ROWS,6,ATTR_COLS,80,ATTR_STYLE,o]),r+=HU.formTable()+HU.formEntryLabel("Prompt suffix",HU.input("",this.lastPromptSuffix??"",[ATTR_CLASS,"wiki-llm-input",ATTR_STYLE,HU.css(CSS_WIDTH,HU.px(500)),ATTR_ID,this.domId(ID_LLM_PROMPT_SUFFIX)]))+HU.formTableClose(),r+=HU.span([ATTR_ID,this.domId("llm-call")],"Evaluate"),r+=HU.div([ATTR_STYLE,HU.css(CSS_POSITION,POSITION_RELATIVE)],HU.textarea("","",[ATTR_PLACEHOLDER,"Results",ATTR_ID,this.domId("rewrite-results"),ATTR_ROWS,6,ATTR_COLS,80,ATTR_STYLE,o])+HU.div([ATTR_STYLE,HU.css(CSS_DISPLAY,DISPLAY_NONE,CSS_POSITION,POSITION_ABSOLUTE,CSS_TOP,HU.perc(50),CSS_LEFT,HU.perc(50),"-ms-transform",HU.translate("-50%","-50%"),CSS_TRANSFORM,HU.translate("-50%","-50%")),ATTR_ID,this.domId(ID_LLM_LOADING)],HU.image(RamaddaUtil.getCdnUrl("/icons/mapprogress.gif"),[ATTR_STYLE,HU.css(CSS_WIDTH,HU.px(100))]))),r+=HU.buttons([HU.span([ATTR_CLASS,CLASS_DIALOG_BUTTON,"replace","true"],"Replace"),HU.span([ATTR_CLASS,CLASS_DIALOG_BUTTON,"append","true"],"Append"),HU.span([ATTR_CLASS,CLASS_DIALOG_BUTTON,ATTR_CANCEL,!0,ATTR_ID,this.domId(ID_CANCEL)],LABEL_CANCEL)]),r=HU.div([ATTR_CLASS,CLASS_DIALOG],r);let a=this.llmDialog=HU.makeDialog({content:r,anchor:this.getScroller(),my:POS_LEFT_BOTTOM,at:"left+200 top-50",title:"LLM",header:!0,sticky:!0,draggable:!0,modal:!1}),n=t=>{e=this.jq(this.ID_LLM_INPUT).val()??"",this.jq(ID_LLM_LOADING).show();let i=RamaddaUtils.getUrl("/llm/rewrite"),s={usegpt4:!0,text:e};t?s.promptprefix=t:(s.promptprefix=this.lastPromptPrefix=this.jq(ID_LLM_PROMPT_PREFIX).val(),s.promptsuffix=this.lastPromptSuffix=this.jq(ID_LLM_PROMPT_SUFFIX).val()),$.post(i,s,(e=>{if(l.jq(ID_LLM_LOADING).hide(),!Utils.stringDefined(e.result))return void alert("No result");let t=e.result.trim();this.jq("rewrite-results").val(t)})).fail((e=>{l.jq(ID_LLM_LOADING).hide(),alert("Rewrite failed")}))};(()=>{let e=HU.select("",[ATTR_ID,this.domId("llmprompts")],t);jqid(s).html(e),this.jq("llmprompts").change((function(){let e=$(this).val(),t=i[e];if(!t)return;let s=t.prompt??t;Utils.stringDefined(s)&&(n(s),$(this).val(""))}))})(),a.find(HU.dotClass("wiki-llm-input")).keypress((function(e){13==e.keyCode&&n()})),this.jq("llm-call").button().click((()=>{n()}));let l=this;a.find(HU.dotClass(CLASS_DIALOG_BUTTON)).button().click((function(){if(l.llmReplacing=!0,$(this).attr(ATTR_CANCEL))return void a.remove();let e=l.jq("rewrite-results").val();e&&($(this).attr("replace")?l.getEditor().session.replace(l.getEditor().selection.getRange(),e):$(this).attr("append")?l.getEditor().session.insert(l.getEditor().getCursorPosition(),e):a.remove(),l.llmReplacing=!1)}))},doColor:function(e){let t=HU.tag(TAG_INPUT,[ATTR_STYLE,HU.css(CSS_WIDTH,HU.px(100),CSS_HEIGHT,HU.px(100)),ATTR_TYPE,"color",ATTR_ID,this.domId("color_picker")]);t+=HU.div([ATTR_CLASS,CLASS_BUTTONS],HU.span([ATTR_ID,this.domId("color_apply")],LABEL_APPLY)+SPACE1+HU.span([ATTR_ID,this.domId("color_ok")],LABEL_OK)+SPACE1+HU.span([ATTR_ID,this.domId("color_cancel")],LABEL_CANCEL)),t=HU.div([ATTR_CLASS,CLASS_DIALOG],t),this.colorDialog&&this.colorDialog.remove(),this.colorDialog=HU.makeDialog({content:t,anchor:this.getDiv(),my:POS_LEFT_BOTTOM,at:"left+200 top-50",title:"Select Color",header:!0,sticky:!0,draggable:!0,modal:!1});let i=this.jq("color_picker"),s=()=>{i.attr(ATTR_TYPE,"text").attr(ATTR_TYPE,"color"),i.remove(),this.colorMarker&&this.editor.session.removeMarker(this.colorMarker),this.colorDialog.remove(),this.colorDialog=null},r=()=>{let e=this.getEditor().getCursorPosition(),t=i.val();this.insertAtCursor(t);new(0,ace.require("ace/range").Range)(e.row,e.column,e.row,e.column+t.length);this.colorMarker&&this.editor.session.removeMarker(this.colorMarker)};this.jq("color_apply").button().click((()=>{r()})),this.jq("color_ok").button().click((()=>{r(),s()})),this.jq("color_cancel").button().click((()=>{s()})),setTimeout((()=>{i.trigger("click")}))},doPreview:async function(e,t){let i=this.getId();jqid(i);if(!t){let e=$(window).width()-200;jqid(this.domId(this.ID_WIKI_PREVIEW)).remove(),$(HU.div([ID,this.domId(this.ID_WIKI_PREVIEW),ATTR_CLASS,"wiki-editor-preview"],"")).appendTo(this.getBlock()),jqid(this.domId(this.ID_WIKI_PREVIEW)).css(CSS_WIDTH,HU.px(e)),this.previewShown=!0}let s=this.getValue(),r=RamaddaUtil.getUrl("/wikify");try{s="base64:"+Utils.utf8ToB64(s)}catch(e){return alert("some error occurred converting the text: "+e),void console.log(s)}$.post(r,{doImports:"false",entryid:e,wikitext:s},((i,s,r)=>{let o=this;if(t)this.jq(this.ID_WIKI_PREVIEW_INNER).html(i);else{let t=HU.span([ATTR_CLASS,HU.classes(CLASS_BUTTON,CLASS_CLICKABLE),ATTR_ID,this.domId(this.ID_WIKI_PREVIEW_CLOSE)],"Close"),s=Utils.join([t,HU.span([ATTR_CLASS,CLASS_CLICKABLE,ATTR_ID,this.domId(this.ID_WIKI_PREVIEW_OPEN)],HU.getIconImage("fa-sync",[ATTR_TITLE,"Preview Again"])),HU.checkbox("",[ATTR_TITLE,"Live Preview",ATTR_ID,this.domId(this.ID_WIKI_PREVIEW_LIVE)],this.previewLive,"Live")+SPACE4,HU.span([ATTR_CLASS,CLASS_CLICKABLE,ATTR_TITLE,"Word count",ATTR_ID,this.domId(this.ID_WIKI_PREVIEW_WORDCOUNT)],HU.getIconImage("fa-calculator"))],SPACE2),r=HU.span([ATTR_CLASS,CLASS_CLICKABLE,ATTR_ID,this.domId(this.ID_WIKI_PREVIEW_CLOSE)],HU.getIconImage("fa-window-close",[ATTR_TITLE,"Close Preview"]));r="",i=HU.div([ATTR_CLASS,CLASS_MENUBAR,ATTR_STYLE,HU.css(CSS_PADDING,HU.px(5),CSS_WIDTH,HU.perc(100),CSS_BORDER,CSS_BASIC_BORDER)],HU.leftRight(s,r))+(i=HU.div([ATTR_ID,this.domId(this.ID_WIKI_PREVIEW_INNER),ATTR_CLASS,"wiki-editor-preview-inner"],i));let a=jqid(this.domId(this.ID_WIKI_PREVIEW));try{a.html(i).show()}catch(e){a.html(HU.getErrorDialog("An error occurred:"+e))}a.draggable(),a.resizable({handles:"ne,nw"}),this.jq(this.ID_WIKI_PREVIEW_WORDCOUNT).click((function(){o.doWordcount(o.jq(o.ID_WIKI_PREVIEW_INNER).html())})),this.jq(this.ID_WIKI_PREVIEW_COPY).click((function(){let e=o.jq(o.ID_WIKI_PREVIEW_INNER).html();Utils.copyToClipboard(e),alert("Text is copied to clipboard")})),this.jq(this.ID_WIKI_PREVIEW_DOWNLOAD).click((function(){let e=o.jq(o.ID_WIKI_PREVIEW_INNER).html();Utils.makeDownloadFile("preview.html",e)})),this.jq(this.ID_WIKI_PREVIEW_LIVE).click((function(){o.previewLive=HU.isChecked($(this))})),this.jq(this.ID_WIKI_PREVIEW_OPEN).click((()=>{this.doPreview(e,!0)})),jqid(this.domId(this.ID_WIKI_PREVIEW_CLOSE)).button().click((()=>{this.previewShown=!1,jqid(this.domId(this.ID_WIKI_PREVIEW)).hide()}))}})).fail(((e,t,i)=>{console.log("error fetching preview:"+e)}))},getAttributeBlocks:function(e,t,i){let s=this;if(!e)return null;let{attrs:r,title:o,display:a,help:n}=this.getDisplayAttributes(e);n&&(n=RamaddaUtils.getUrl(n));let l=this.getWikiAttributes(e,(s=>{this.getAttributeBlocks(e,t,i)}));if(!1===l)return!1;if(l&&(r=Utils.mergeLists(r,l)),!r)return null;let d=getWikiEditorMenuBlocks(r,t,this.getId()),p=Utils.getColorTablePopup({xxxwikiEditor:this,itemize:!1,showToggle:!1,clazz:""}),h=(e,t,i)=>{let r=i.items;r=HU.div([ATTR_CLASS,"wiki-editor-popup-items wiki-editor-popup-colortable"],r);let o=HU.getUniqueId("find");r=HU.center(HU.div([ATTR_ID,o,ATTR_STYLE,HU.css(CSS_MIN_WIDTH,HU.px(400),CSS_MARGIN,HU.px(5))]))+r;let a=HU.makeDialog({content:r,anchor:$(window),xhidePopup:!1,my:POS_RIGHT_TOP,at:"left+"+event.x+" top+"+event.y,title:"Color Tables",header:!0,sticky:!1,draggable:!0,modal:!1});HU.initPageSearch(HU.dotClass(CLASS_COLORTABLE_SELECT),HU.dotClass(CLASS_COLORTABLE_CATEGORY),"Find colortable",!1,{target:jqid(o)}),a.find(HU.dotClass(CLASS_COLORTABLE_SELECT)).click((function(){let e=$(this).attr(ATTR_COLORTABLE);WikiUtil.insertText(s.getId()," colorTable="+e),a.remove()}))};"search"!=e.type&&"simplesearch"!=e.type&&d.push({title:"Color table",items:p,callback:h}),o||(o=null,this.wikiAttributesFromServer&&this.wikiAttributesFromServer[e.tag]&&this.wikiAttributesFromServer[e.tag][0]&&(o=this.wikiAttributesFromServer[e.tag][0].label),o||(o=Utils.makeLabel(e.tag)+" Properties"));let c={blocks:d,title:o,display:a,help:n};return i&&i(c),c},handleEntriesPopup:function(e,t,i){this.getEntryNames(e,(e=>{if(0!=e.length){if(e.length){let s=i??"";e.forEach((e=>{s+=(e.icon?HU.getIconImage(e.icon,[ATTR_WIDTH,HU.px(24)])+HU.space(1):"")+HU.href(HU.url(RamaddaUtil.getUrl(URL_ENTRY_SHOW),ARG_ENTRYID,e.id),e.name,[ATTR_TITLE,e.id,ATTR_TARGET,"_entries"])+HU.br()})),jqid(t).html(s)}}else jqid(t).html("No entries found")}),!0)},handlePopupMenu:function(e,t){let i=this.getTagInfo();if(!i)return;if(!i.chunk)return;if(!t)return void this.getAttributeBlocks(i,!0,(t=>{this.handlePopupMenu(e,t)}));let s=t.blocks,r=t.title,o=(t.display,t.help);if(0==s.length)return;let a=HU.open(TAG_DIV,[ATTR_CLASS,"wiki-editor-popup",ATTR_STYLE,HU.css(CSS_MIN_WIDTH,HU.px(400),CSS_MAX_WIDTH,HU.px(600))]);r||(r=Utils.makeLabel(i.tag)+" Properties");let n=HU.span([ATTR_ID,this.domId(ID_SEARCH_ATTRIBUTES),ATTR_CLASS,HU.classes("wiki-popup-menu-header",CLASS_CLICKABLE),ATTR_TITLE,"Search attributes"],HU.getIconImage(ICON_SEARCH))+""+HU.span([ATTR_ID,this.domId("edittag"),ATTR_CLASS,HU.classes("wiki-popup-menu-header",CLASS_CLICKABLE),ATTR_TITLE,"Edit tag"],HU.getIconImage("fas fa-edit"))+" "+r;o&&(n+=SPACE2+HU.href(o,HU.getIconImage(icon_help),[ATTR_TARGET,"_ramaddahelp"])),n=HU.div([ATTR_CLASS,"wiki-editor-popup-heading"],n),a+=n,a+=HU.thinLine(),a+=HU.vspace(HU.em(.5)),a+=HU.open(TAG_DIV,[ATTR_STYLE,HU.css(CSS_MARGIN,HU.px(5))]);let l=this.extractEntryIds(i.chunk);if(l.length){let e=Utils.getUniqueId("entrieslist");a+=HU.toggleBlock("Entries",HU.div([ATTR_ID,e,ATTR_CLASS,"wiki-editor-popup-items"],"Loading ...")),this.handleEntriesPopup(l,e)}let d={},p=0;Utils.splitList(s,3).forEach((e=>{a+=HU.open(TAG_DIV,[ATTR_CLASS,"wiki-editor-popup-section"]),e.forEach((e=>{if(p++,d[p]=e,"string"==typeof e)return void(a+=e);let t=e.title;if(e.callback)return t=HU.div(["data-block",p,ATTR_CLASS,HU.classes(CLASS_HOVERABLE,"ramadda-block-link",CLASS_CLICKABLE,"wiki-editor-popup-header")],t),void(a+=t);t=HU.div(["data-block",p,ATTR_CLASS,HU.classes(CLASS_CLICKABLE,CLASS_HOVERABLE,"wiki-editor-popup-header")],HU.getIconImage("fas fa-caret-right")+SPACE+t);let i=e.items.join("");i=HU.div([ATTR_CLASS,"wiki-editor-popup-items"],i),a+=t})),a+=HU.close(TAG_DIV)})),a+=HU.close(TAG_DIV,TAG_DIV),this.tagDialog&&this.tagDialog.remove();let h=this.tagDialog=HU.makeDialog({content:a,anchor:$(window),my:POS_LEFT_TOP,at:"left+"+e.x+" top+"+e.y,title:r,header:!0,sticky:!0,draggable:!0,modal:!1});h.find(HU.dotClass("wiki-editor-popup-header")).click((function(){let e=d[$(this).attr("data-block")];if(!e)return void alert("Could not find block");if(e.callback)return;let t=e.items.join("");t=HU.div([ATTR_CLASS,"wiki-editor-popup-items"],t);let i=HU.makeDialog({content:t,anchor:$(this),hidePopup:!1,my:POS_LEFT_TOP,at:POS_LEFT_BOTTOM});setTimeout((()=>{let e=()=>{i.hide(),$(document).off("click",e)};$(document).on("click",e)}),1)})),HU.findClass(h,"ramadda-block-link").click((function(){let e=d[$(this).attr("data-block")];e?e.callback(h,$(this),e):alert("Could not find block")})),jqid(this.domId("edittag")).click((()=>{h.remove(),this.showTagEdit(i,t)})),jqid(this.domId(ID_SEARCH_ATTRIBUTES)).click((()=>{this.makeSearchAttributesDialog(h,s,!1),h.remove()}))},handleMouseUp:function(e,t,i,s){let r=this.getEditor().renderer.screenToTextCoordinates(e.x,e.y);if(!r)return;let o=this.getTagInfo(r);if(o)if(s=s||this.editMode||i,this.setEditMode(!1),s)t?this.showTagEdit(o,t):this.getAttributeBlocks(o,!1,(t=>{this.handleMouseUp(e,t,i,!0)}));else if(o.entryId)if(e.shiftKey){let e=RamaddaUtils.getEntryUrl(o.entryId);window.open(e,"_blank")}else this.showEntryPopup(o.entryId)},showTagEdit:function(e,t){let i=this,s=t.blocks,r=t.title,o=(t.display,e.attrs),a=e.type??e.tag,n=this.domId(this.ID_WIKI_MENUBAR),l=getWikiEditorMenuBar(s,n,a),d=$(window).width()-100,p=HU.div([ATTR_ID,this.domId("wiki-editor-popup"),ATTR_CLASS,"wiki-editor-editor"],l+HU.textarea("",o,["spellcheck","false",ATTR_STYLE,HU.css(CSS_MAX_WIDTH,HU.perc(100),CSS_WIDTH,HU.px(d),CSS_HEIGHT,HU.px(300)),ATTR_ID,this.domId(this.ID_WIKI_POPUP_EDITOR)])+HU.br()+HU.div([ATTR_STYLE,HU.css(CSS_TEXT_ALIGN,ALIGN_CENTER,CSS_PADDING,HU.px(4))],HU.span([ATTR_TITLE,"Tidy the text",ATTR_ID,this.domId(this.ID_WIKI_POPUP_TIDY)],HU.getIconImage("fas fa-broom"))+SPACE1+HU.span([ATTR_TITLE,"Compact the text",ATTR_ID,this.domId(this.ID_WIKI_POPUP_COMPACT)],HU.getIconImage("fas fa-snowplow"))+SPACE1+HU.span([ATTR_ID,this.domId(this.ID_WIKI_POPUP_OK)],LABEL_OK)+SPACE1+HU.span([ATTR_ID,this.domId(this.ID_WIKI_POPUP_CANCEL)],LABEL_CANCEL))),h=HU.makeDialog({content:p,anchor:this.getScroller(),title:r,header:!0,sticky:!0,draggable:!0,modalContentsCss:HU.css(CSS_LEFT,HU.px(50))});jqid(ID_SEARCH_ATTRIBUTES).click((function(){i.makeSearchAttributesDialog($(this),s,!0)})),this.popupShowing=!0,this.jq(this.ID_WIKI_POPUP_EDITOR).focus(),this.jq(this.ID_WIKI_POPUP_CANCEL).button().click((()=>{this.popupShowing=!1,h.remove()}));let c=e=>{let t=this.jq(this.ID_WIKI_POPUP_EDITOR).val().trim(),i=Utils.parseAttributesAsList(t),s="",r=0;for(let t=0;t<i.length;t+=2){let o=i[t+1];null!=o&&(o.indexOf(",")>=0||o.indexOf(" ")>=0||o.indexOf("\n")>=0||""==o)&&(o='"'+o+'"'),s+=i[t]+"="+o,e?s+="\n":(r++,r>4?(r=0,s+="\n"):s+="  ")}this.jq(this.ID_WIKI_POPUP_EDITOR).val(s)};this.jq(this.ID_WIKI_POPUP_TIDY).button().click((()=>{c(!0)})),this.jq(this.ID_WIKI_POPUP_COMPACT).button().click((()=>{c(!1)})),this.jq(this.ID_WIKI_POPUP_OK).button().click((()=>{let t,i=this.jq(this.ID_WIKI_POPUP_EDITOR).val(),s=e.tag;"display"==s&&("group"==e.type?s="group":""!=e.type&&(s="display_"+e.type)),"plus"==e.type?(i=i.replace(/\n/g," "),t="+"+s+" "+i+" "):t="{{"+s+" "+i+"}}",this.popupShowing=!1,h.remove(),this.getSession().replace(e.range,t)}))},makeSearchAttributesDialog:function(e,t,i){let s=this,r="";t.forEach(((e,t)=>{if("string"==typeof e)return;if("Color table"==e.title)return;let i=e.title;r+=HU.div([ATTR_CLASS,"wiki-searchheader","data-block-index",e.index],HU.b(i)),r+=HU.open(TAG_DIV,[ATTR_CLASS,"wiki-search-items"]);let s=Utils.join(e.items," ");s=s.replace(/<div/g,"<span").replace(/\/div>/g,"/span>"),r+=s,r+=HU.close(TAG_DIV)}));let o=HU.input("","",[ATTR_PLACEHOLDER,"Search - string 1,string 2",ATTR_ID,s.domId("allsearch"),ATTR_WIDTH,10])+SPACE+HU.checkbox("",[ATTR_ID,s.domId("searchshowall")],!1,"Show descriptions");o=HU.div([ATTR_STYLE,HU.css(CSS_PADDING,HU.px(5),CSS_BORDER_BOTTOM,CSS_BASIC_BORDER)],o),r=HU.div([ATTR_STYLE,HU.css(CSS_MARGIN,HU.px(5))],r),r=o+HU.div([ATTR_ID,s.domId("allsearch_corpus"),ATTR_CLASS,"wikieditor-menu-popup",ATTR_STYLE,HU.css(CSS_WIDTH,HU.px(500),CSS_MAX_HEIGHT,HU.px(400),CSS_OVERFLOW_Y,OVERFLOW_AUTO)],r);HU.makeDialog({content:r,anchor:e,title:"Properties",header:!0,sticky:!0,draggable:!0});let a=jqid(s.domId("allsearch_corpus")).find(TAG_SPAN),n=jqid(s.domId("allsearch_corpus")).find(HU.dotClass("wiki-searchheader"));s.jq("searchshowall").change((function(){HU.isChecked($(this))?a.each((function(){let e=$(this),t=e.attr(ATTR_TITLE);if(!Utils.stringDefined(t))return;let i=e.find(TAG_A);i.length>0&&(e=i);let s=e.attr("origtext");Utils.stringDefined(s)||(s=e.html(),e.attr("origtext",s)),e.html(s+" - "+HU.span([ATTR_STYLE,HU.css(CSS_FONT_SIZE,HU.perc(70),CSS_FONT_STYLE,FONT_ITALIC)],t))})):a.each((function(){let e=$(this),t=e.find(TAG_A);t.length>0&&(e=t);let i=e.attr("origtext");i&&e.html(i)}))})),jqid(s.domId("allsearch")).focus(),jqid(s.domId("allsearch")).keyup((function(e){let t=$(this).val().trim().toLowerCase(),i={};t=""==t?[]:Utils.split(t,",",!0,!0),a.each((function(){if(0==t.length)$(this).show();else{let e=$(this).attr(ATTR_DATA_CORPUS);if(!e)return;e=e.toLowerCase();let s=!0;t.every((t=>{if(e.indexOf(t)<0){s=!1;try{e.match(t)&&(s=!0)}catch(e){}}return s})),s?($(this).show(),i[$(this).attr("data-block-index")]=!0):$(this).hide()}})),""==t?n.show():n.each((function(){i[$(this).attr("data-block-index")]?$(this).show():$(this).hide()}))}))},handleMouseLeave:function(e){this.setInContext(!1)},extractEntryIds:function(e){let t=/([a-z0-9]+-[a-z0-9]{4}-[a-z0-9]{4}-[a-z0-9]{4}-[a-z0-9]+)(.*)/,i=[],s=e.match(t);for(;s&&3==s.length;)i.push(s[1]),s=s[2].match(t);return i},getEntryNames:function(e,t,i){let s=()=>{let i=HU.url(RamaddaUtil.getUrl("/entry/names"),"entryids",Utils.join(e,","));this.getNamesPending=!0,$.getJSON(i,(e=>{this.getNamesPending=!1,t(e)}))};i?s():this.getNamesTimeout=setTimeout((()=>{s()}),1e3)},showEntryPopup:function(e){let t=HU.getUniqueId(""),i=HU.div([ATTR_ID,t,ATTR_STYLE,HU.css(CSS_DISPLAY,DISPLAY_INLINE_BLOCK)]);this.showMessage(i),this.showingEntryPopup=!0,this.handleEntriesPopup([e],t,HU.div([],"Shift-click to view:"))},setInContext:function(e,t,i,s){this.inContext=e;let r=this.getScroller();if(this.tagMarker&&this.editor.session.removeMarker(this.tagMarker),this.tagMarker=null,this.getNamesTimeout&&clearTimeout(this.getNamesTimeout),this.getNamesTimeout=null,s&&s.entryId)this.showEntryPopup(s.entryId);else if(!s||s.chunk){if(e){r.css(CSS_CURSOR,CURSOR_CONTEXT_MENU);let e=HU.b("Right-click: property menu; Shift/Double-click: editor");this.showMessage(e)}else r.css(CSS_CURSOR,CURSOR_TEXT),this.clearMessage(),this.lastTimeout&&clearTimeout(this.lastTimeout);this.lastTimeout=null}},handleMouseMove:function(e){this.lastTimeout&&clearTimeout(this.lastTimeout);let t=()=>{let t=this.getEditor().renderer.screenToTextCoordinates(e.x,e.y);if(!t)return;let i=this.getTagInfo(t);if(i){if(i.entryId&&this.showingEntryPopup)return;i.entryId=null,this.setInContext(!0,i.type,i.chunk,i)}else this.setInContext(!1)};this.inContext?t():this.lastTimeout=setTimeout(t,1e3)},getWikiAttributes:function(e,t){if(this.wikiAttributes[e.tag])return this.wikiAttributes[e.tag];let i=t=>(t||(t=[]),t=t.filter((e=>"tt"!=e.p)).map((e=>e.p?(String(e.p).startsWith("#")&&(e.p=String(e.p).substring(1)),e):e)),this.wikiAttributes[e.tag+"_extra"]&&(t=Utils.mergeLists(t,this.wikiAttributes[e.tag+"_extra"])),t);if(!this.wikiAttributesFromServer){let s=RamaddaUtils.getUrl("/wikitags");return $.getJSON(s,(s=>{this.wikiAttributesFromServer=s,t(i(this.wikiAttributesFromServer[e.tag]))})).fail((e=>{alert("Error loading wiki tags"),console.dir(e)})),!1}return i(this.wikiAttributesFromServer[e.tag])},getDisplayAttributes:function(e){let t=null,i=[],s=null,r="";if("plus"==e.type||e.tag&&"display"!=e.tag&&"group"!=e.tag)return{attrs:null,title:null,display:null};try{if(s=(new DisplayManager).createDisplay(e.type,{dummy:!0}),s&&(i=s.getWikiEditorTags(),s.getTypeDef&&(r=s.getTypeDef().help),s.getTypeLabel)){t=s.getTypeLabel(),null==t&&(t=Utils.makeLabel(e.type||"")),t+=" Properties";let i=s.getTypeHelpUrl();i&&(t=HU.href(i,t+SPACE+HU.getIconImage(icon_help),[ATTR_TARGET,"_ramaddahelp",ATTR_TITLE,"View help"]))}}catch(t){console.log("Error getting attrs for:"+e.type+" error:"+t+" stack:"+t.stack)}return{attrs:i,title:t,display:s,help:r}},wikiInitDisplaysButton:function(){if(!window.globalDisplayTypes)return;let e=this.getId(),t=jqid("displays_button"+e),i=window.globalDisplayTypes,s={},r=[];DISPLAY_CATEGORIES.forEach((e=>{s[e]=[],r.push(e)})),i.forEach((t=>{if(Utils.isDefined(t.forUser)&&!t.forUser)return;let i=t.category||CATEGORY_MISC;null==s[i]&&(s[i]=[],r.push(i));let o=t.tooltip??(t.label?HU.b(t.label):"");o=o.replace(/"/g,"&quot;");let a="WikiUtil.insertDisplayText('"+e+"','"+t.type+"')",n=HU.div(["data-category",i,ATTR_DATA_CORPUS,t.label+" "+o,ATTR_CLASS,"wiki-editor-popup-link"],HU.href("#",t.label,[ATTR_CLASS,"display-link ",ATTR_TITLE,o,"onclick",a]));s[i].push(n)}));let o="",a=HU.open(TAG_TABLE)+HU.open(TAG_TR,[ATTR_VALIGN,ALIGN_TOP]);for(let e=0;e<r.length;e++){let t=r[e],i=Utils.join(s[t],"<div>\n");o+=HU.div([ATTR_STYLE,HU.css(CSS_VERTICAL_ALIGN,ALIGN_TOP,CSS_MARGIN_RIGHT,HU.px(4),CSS_DISPLAY,DISPLAY_INLINE_BLOCK)],Utils.join(s[t],"")),a+=HU.td(["data-category",t,ATTR_CLASS,"wiki-editor-display-category"],HU.div([ATTR_STYLE,HU.css(CSS_MARGIN_RIGHT,HU.px(5))],HU.b(t))+HU.open(TAG_DIV,[ATTR_STYLE,HU.css(CSS_MARGIN_RIGHT,HU.px(5),CSS_MAX_HEIGHT,HU.px(250),CSS_OVERFLOW_Y,OVERFLOW_AUTO)])+i)}a=HU.div([ATTR_ID,"wiki-display-popup",ATTR_STYLE,HU.css(CSS_FONT_SIZE,HU.pt(10),CSS_WIDTH,HU.px(800))],a),this.displaysText=o;let n=HU.span([ATTR_TITLE,"Expand",ATTR_CLASS,CLASS_CLICKABLE,ATTR_ID,this.domId(ID_EXPAND_WIKI_MENU)],HU.getIconImage("fas fa-maximize")),l=HU.input("","",[ATTR_PLACEHOLDER,"Search",ATTR_ID,this.domId("displaysearch"),ATTR_WIDTH,10])+HU.space(2)+n,d=HU.div([ATTR_STYLE,HU.css(CSS_MARGIN,HU.px(10))],l+HU.div([ATTR_ID,this.domId(ID_EXPANDED_WIKI_MENU)])+HU.div([ATTR_ID,this.domId(ID_UNEXPANDED_WIKI_MENU)],a));t.click((()=>{this.wikiDisplayPopup&&this.wikiDisplayPopup.remove();let e=this.wikiDisplayPopup=HU.makeDialog({content:d,my:POS_LEFT_TOP,at:"left-200px bottom",title:"",anchor:t,draggable:!0,header:!0,initCall:()=>{jqid("wiki-display-popup").tooltip({classes:{"ui-tooltip":"wiki-editor-tooltip"},content:function(){return $(this).prop(ATTR_TITLE)},show:{effect:"slide",delay:500,duration:400},position:{my:POS_LEFT_TOP,at:POS_RIGHT_TOP}})}});wikiPopup&&wikiPopup.hide(),e.tooltip();let i=!1,s=null;this.jq(ID_EXPAND_WIKI_MENU).click((()=>{if(!s){s="",e.find(HU.dotClass("wiki-editor-display-category")).each((function(){let e=$(this).attr("data-category"),t=HU.open(TAG_TABLE,[ATTR_WIDTH,HU.perc(100),ATTR_STYLE,HU.css(CSS_WIDTH,HU.perc(100),"table-layout","fixed",CSS_BORDER_COLLAPSE,"separate",CSS_BORDER_SPACING,HU.px(4))]);t+=HU.open(TAG_TR,[ATTR_VALIGN,ALIGN_TOP]);let i=0;$(this).find(HU.dotClass("display-link")).each((function(){let s=$(this).attr("onclick");i++,i>3&&(i=1,t+=HU.close(TAG_TR)+HU.open(TAG_TR,[ATTR_VALIGN,ALIGN_TOP]));let r=$(this).attr(ATTR_TITLE),o=HU.div([ATTR_CLASS,CLASS_CLICKABLE,ATTR_STYLE,HU.css(CSS_DISPLAY,DISPLAY_INLINE_BLOCK)],r),a=HU.tag(TAG_TD,["data-category",e,ATTR_ONCLICK,s,ATTR_CLASS,HU.classes(CLASS_HOVERABLE,"wiki-editor-popup-link"),ATTR_WIDTH,HU.perc(33),ATTR_STYLE,HU.css(CSS_BORDER,CSS_BASIC_BORDER,CSS_MARGIN,HU.px(6),CSS_PADDING,HU.px(4))],o);t+=a,t+="\n"})),t+=HU.close(TAG_TR,TAG_TABLE),s+=HU.center(HU.div([ATTR_CLASS,"wiki-editor-display-category","data-category",e,ATTR_STYLE,HU.css(CSS_TEXT_ALIGN,ALIGN_CENTER,CSS_MARGIN_TOP,HU.px(10),CSS_FONT_WEIGHT,FONT_BOLD)],e))+t})),s=HU.div([ATTR_STYLE,HU.css(CSS_MAX_HEIGHT,HU.px(500),CSS_OVERFLOW_Y,OVERFLOW_AUTO,CSS_MIN_WIDTH,HU.px(700),CSS_MAX_WIDTH,HU.px(700),CSS_OVERFLOW_X,OVERFLOW_AUTO)],s),$(s).appendTo(r.jq(ID_EXPANDED_WIKI_MENU)).find(TAG_IMG).attr(ATTR_WIDTH,HU.px(200))}i=!i,i?(r.jq(ID_EXPAND_WIKI_MENU).html(HU.getIconImage("fas fa-minimize")),r.jq(ID_EXPANDED_WIKI_MENU).show(),r.jq(ID_UNEXPANDED_WIKI_MENU).hide()):(r.jq(ID_EXPAND_WIKI_MENU).html(HU.getIconImage("fas fa-maximize")),r.jq(ID_EXPANDED_WIKI_MENU).hide(),r.jq(ID_UNEXPANDED_WIKI_MENU).show())}));let r=this;this.jq("displaysearch").focus(),this.jq("displaysearch").keyup((function(t){let i=$(this).val().trim().toLowerCase(),s={},r=e.find(HU.dotClass("wiki-editor-popup-link")),o=e.find(HU.dotClass("wiki-editor-display-category"));r.each((function(){if(""==i)$(this).show();else{let e=$(this).attr(ATTR_DATA_CORPUS);if(e||(e=$(this).attr(ATTR_TITLE)),e||(e=$(this).html()),!e)return void console.log("no corpus",$(this).html());e=e.toLowerCase(),e.indexOf(i)>=0?($(this).show(),s[$(this).attr("data-category")]=!0):$(this).hide()}})),""==i?o.show():o.each((function(){s[$(this).attr("data-category")]?$(this).show():$(this).hide()}))})),wikiPopup=e}))},setEditMode:function(e){let t=jqid(this.id+"_toolbar_edit");this.editMode=e;let i=this.getScroller();if(!this.editMode)return t.find(TAG_I).css(CSS_COLOR,"#aaa"),t.css(CSS_BACKGROUND,COLOR_TRANSPARENT),void i.css(CSS_CURSOR,CURSOR_TEXT);t.find(TAG_I).css(CSS_COLOR,"blue"),t.css(CSS_BACKGROUND,"#aaa"),i.css(CSS_CURSOR,CURSOR_POINTER)},initTagSearch:function(){let e="";if(!this.toolbar)return;if(!this.formId)return;HU.findClass(this.toolbar,"wiki-menubar-tags").each((function(){""!=e&&(e+=HU.thinLine()),e+=HU.center(HU.b($(this).attr(ATTR_DATA_TITLE))),e+=$(this).html()})),this.displaysText&&(e+=HU.thinLine()+HU.center(HU.b("Data Displays"))+this.displaysText),e=HU.center(HU.input("","",[ATTR_PLACEHOLDER,"Find Tag",ATTR_ID,this.domId("tagsearch"),ATTR_STYLE,HU.css(CSS_MARGIN_TOP,HU.px(4)),ATTR_WIDTH,10]))+e,e=HU.div([ATTR_STYLE,HU.css(CSS_WIDTH,HU.px(600),CSS_HEIGHT,HU.px(300),CSS_MAX_HEIGHT,HU.px(300),CSS_OVERFLOW_Y,OVERFLOW_AUTO)],e);let t=this;this.toolbarEditButton=jqid(this.id+"_toolbar_edit"),this.toolbarEditButton.click((()=>{this.setEditMode(!this.editMode)})),jqid(this.id+"_toolbar_search").click((function(){this.tagSelectDialog&&this.tagSelectDialog.remove(),this.tagSelectDialog=HU.makeDialog({content:e,anchor:$(this),at:"left+300 bottom+40",title:"Tags",header:!0,draggable:!0}),t.jq("tagsearch").focus(),this.tagSelectDialog.find(TAG_A).tooltip({classes:{"ui-tooltip":"wiki-editor-tooltip"},content:function(){return $(this).prop(ATTR_TITLE)},show:{effect:"slide",delay:500,duration:400},position:{my:POS_LEFT_TOP,at:POS_RIGHT_TOP}}),HU.findClass(this.tagSelectDialog,"wiki-editor-popup-category").css(CSS_DISPLAY,DISPLAY_NONE);let i=this.tagSelectDialog.find(HU.dotClass("wiki-editor-popup-link"));t.jq("tagsearch").keyup((function(e){let t=$(this).val().trim().toLowerCase();HU.doPageSearch(t,i)}))}))},initAttributes:function(){this.groupAttributes=[{label:"Collection Properties"},{p:"orderby",ex:"name_up|name_down|date_up|date_down|changedate_up|createdate_up|entryorder_up|size_up|number_up|folder_up|type_up|field:<column>",tt:"sort type: name, date, change date, create date, etc",help:"/userguide/wiki/sortorder.html#heading-sorting_with_wiki_text"},{p:"ascending",ex:"true",tt:"direction of sort."},{label:"Specify entries",p:"entries",ex:'"entryid1,entryid2,entryid3.."',tt:"comma separated list of entry ids to use"},{label:"Specify entries by search",p:"entries",ex:"search:type:<some type>;orderby:date;ascending:false",tt:"comma separated list of entry ids to use"},{p:"entries.filter",ex:"file|folder|image|type:some type|geo|name:name pattern|suffix:file suffixes",tt:"allows you to select what entries to use"},{p:"exclude",ex:"entryid1,entryid2,entryid3..",tt:"comma separated list of entry ids to not use"},{p:"first",ex:"entryid1,entryid2,entryid3..",tt:"comma separated list of entry ids to use first"},{p:"last",ex:"entryid1,entryid2,entryid3..",tt:"comma separated list of entry ids to use last"},{p:"max",ex:"number of entries to use",tt:"max number of entries to use"},{p:"ignoreRequestOrderBy",ex:"true",tt:"If showing multiple lists in one page this keeps one list sort from affecting this list sort"}],this.wikiAttributesFromServer=null;let e=Utils.mergeLists([{label:"Table Tree"},{p:"simple",ex:!0},{p:"columns",ex:"name,date,createdate,creator,download,size,type,attachments"},{p:"showHeader",ex:!1},{p:"showDate",ex:!1},{p:"showTime",ex:!0},{p:"showCreateDate",ex:!1},{p:"showSize",ex:!1},{p:"showDownload",ex:!1},{p:"showCreator",ex:!0},{p:"showType",ex:!1},{p:"showAttachments",ex:"true"},{p:"showIcon",ex:!1},{p:"showThumbnails",ex:!1},{p:"showArrow",ex:!1},{p:"showForm",ex:!1},{p:"textStyle",tt:"Style for the text in the table"},{p:"textClass"},{p:"formOpen",ex:!0,tt:"Show the Apply action form by default"},{p:"showCrumbs",ex:!0},{p:"nameWidth",ex:"120"},{p:"dateWidth",ex:"120"},{p:"sizeWidth",ex:"120"},{p:"typeWidth",ex:"120"},{p:"attachmentsWidth",ex:"120"},{p:"metadataDisplay",ex:"archive_note:attr1=Arrangement:template=<b>{attr1}_colon_</b> {attr2}",tt:"Add metadata under the name. e.g.: type1:template={attr1},type2:attr1=Value:template={attr1}_colon_ {attr2}"},{p:"message",ex:""},{p:"treePrefix",ex:""},{p:"groupBy",ex:"field_name",tt:"group the tables from the entrys field"},{p:"groupLabelTemplate",ex:"Field: ${label}"},{p:"groupLayout",ex:"linear|tabs|accordion"},{p:"addPageSearch",d:!0,tt:"Add the page search form"},{p:"chunkSize",ex:"10",tt:"break up the list of entries into chunkSize lists and display each list"},{p:"numChunks",ex:"2",tt:"how many entry chunks"},{p:"chunkColumns",ex:"2",tt:'how many columns use "numChunks" to match number of chunks'},{p:"chunkStyle",ex:"margin:10px;",tt:"chunk style"}],this.groupAttributes),t=[{label:"Map Properties"},{p:"icon",ex:"#/icons/dots/green.png"},{p:"width",ex:"100%"},{p:"height",ex:"400"},{p:"defaultMapLayer",tt:"Default map layer. Look in the map layer list for ids",ex:"osm|google.roads|esri.street|google.hybrid|google.roads|google.terrain|google.satellite|opentopo|esri.topo|usfs|usgs.topo|naip|usgs.imagery|esri.shaded|esri.lightgray|esri.darkgray|esri.terrain|shadedrelief|esri.aeronautical|historic|osm.toner|osm.toner.lite"},{p:"overlays",tt:"Comma separated list of map overlays. Look in the map layer list for ids"},{p:"detailed",ex:"true",tt:"Add map layers, etc"},{p:"displayDiv",tt:"ID of div to show popup in"},{p:"displayColumns",ex:2,tt:"For multiple feature popups"},{p:"displayDivSticky",ex:!0,tt:"Keep the popup display in the div"},{p:"listEntries",ex:"true"},{p:"listInMap",ex:"true"},{p:"showEntriesSearch",ex:"true"},{p:"showCheckbox",ex:"true"},{p:"listHeader"},{p:"listWidth",ex:"300px"},{p:"listIconSize",ex:"24px"},{p:"skipEntries",ex:!0,tt:"Don't show the entries"},{p:"marker1",ex:"latitude:40,longitude:-105,color:red,radius:4,text:Some text",tt:"Can do marker1 ... markerN"},{p:"credits",tt:"Text to show at the bottom of the map"},{p:"hideIfNoLocations",tt:"Don't show map if no georeferenced data"},{p:"details",ex:"false"},{p:"showLines",ex:"true"},{p:"showCircles",ex:"true"},{p:"azimuthLength",tt:"km",d:"1.0"},{p:"azimuthColor",ex:"red"},{p:"azimuthWidth",ex:"2"},{p:"showBounds",ex:"false"},{p:"showMarkers",ex:"false"},{p:"showCameraDirection",ex:"false"},{p:"showLocationSearch",ex:"true"},{p:"showSearch",ex:"false"},{p:"showLayerToggle",ex:"true"},{p:"showLatLonLines",ex:"true"},{p:"showScaleLine",ex:"true"},{p:"showLayerSwitcher",ex:"true"},{p:"showLatLonPosition",ex:"true"},{p:"showZoomPanControl",ex:"true"},{p:"showZoomOnlyControl",ex:"true"},{p:"showBookmarks",ex:"true"},{p:"showBounds",ex:"true"},{p:"showOpacitySlider",ex:"true"},{p:"useThumbnail",ex:"true",tt:"Use the entry thumbnail"},{p:"addImageLayer",ex:"true",tt:"add the image as a georeferenced image layer"},{p:"iconSize",ex:"32"},{p:"iconWidth",ex:"32"},{p:"iconHeight",ex:"32"},{p:"layerStrokeColor",ex:"red"},{p:"layerStrokeWidth",ex:"2"},{p:"layerFillColor",ex:"red"},{p:"layerFillOpacity",ex:"0.5"},{p:"rules",ex:"attr1:== or != or &lt; or &gt; or  ~ (like):value:fillColor:red:strokeColor:black;attr2:",tt:"Specify style rules based on feature properties"},{p:"pointRadius",ex:""},{p:"strokeColor",ex:""},{p:"strokeWidth",ex:""},{p:"fillOpacity",ex:""},{p:"fillColor",ex:""},{p:"layerStrokeColor",ex:""},{p:"layerStrokeWith",ex:""},{p:"layerFillColor",ex:""},{p:"layerFillOpacity",ex:""},{p:"highlightStrokeColor",ex:""},{p:"highlightFillColor",ex:""},{p:"highlightStrokeWidth",ex:""},{p:"highlightFillOpacity",ex:""},{p:"zoomToLayer",tt:"Zoom to the layer extent on load",ex:"false"},{p:"popupWidth",ex:"200"},{p:"popupHeight",ex:"200"},{p:"doPopup",ex:"false"},{p:"doFeatureSelect",ex:"false"},{p:"doPopupSlider",ex:"true",tt:"Show the popup text on the side using a fixed position"},{p:"popupSliderRight",ex:"true"},{p:"enableDragPan",ex:"false"},{p:"addMarkerOnClick",ex:"true"},{p:"markerIcon",ex:"/repository/icons/map/marker-blue.png"},{p:"linked",ex:"true"},{p:"linkMouse",ex:"true"},{p:"linkGroup",ex:"some name"},{p:"layer",ex:"osm|esri.topo|google.roads|google.hybrid|esri.street|opentopo|usfs|caltopo.mapbuilder|usgs.topo|google.terrain|google.satellite|naip||naip.esri|naip.caltopo|usgs.imagery|esri.shaded|esri.lightgray|esri.darkgray|esri.terrain|shadedrelief|publiclands|historic|esri.aeronautical|osm.toner|osm.toner.lite|cartolight|watercolor|lightblue|blue|white|black|gray"},{p:"iconsonly",ex:"false"}];this.wikiAttributes={tree:e,tabletree:e,gallery_extra:this.groupAttributes,entries_template:Utils.mergeLists([{label:"Entries Template"},{p:"template",ex:"${name link=true}"},{p:"before"},{p:"after"}],this.groupAttributes),links:Utils.mergeLists([{label:"Links Properties"},{p:"info",ex:"List children entries"},{p:"showIcon",ex:"false"},{p:"showDescription",ex:"true"},{p:"showSnippet",ex:"true"},{p:"linkresource",ex:"true",tt:"Link to the resource"},{p:"linksBefore",ex:"url1;label1,url2;label2"},{p:"linksAfter",ex:"url1;label1,url2;label2"},{p:"separator",ex:"",tt:"Separator between links"},{p:"horizontal",ex:"true",tt:"Display horizontallly"},{p:"output",ex:"",tt:"Link to output"},{p:"target",ex:"_target",tt:"link target"},{p:"tagopen",ex:"html before link"},{p:"tagclose",ex:"html after link"},{p:"linksBefore",ex:'"url;label,url;label"'},{p:"linksAfter",ex:'"url;label,url;label"'},{p:"innerClass",ex:""},{p:"class",ex:"",tt:"link css class"},{p:"style",ex:"",tt:"link style"},{p:"chunkSize",ex:"10",tt:"break up the list of entries into chunkSize lists and display each list"},{p:"numChunks",ex:"2",tt:"how many entry chunks"},{p:"chunkColumns",ex:"2",tt:'how many columns use "numChunks" to match number of chunks'},{p:"chunkStyle",ex:"margin:10px;",tt:"chunk style"}],this.groupAttributes),section:[{label:"Section Properties"},{p:"title",ex:'"{{name}}"'},{p:"subTitle",ex:'""'},{p:"style",ex:'""'},{p:"titleStyle",ex:'""'},{p:"----",tt:"Add a line"},{p:"#",tt:"Colored sections"}],row:[{label:"Row Properties"},{p:"tight",ex:"true",tt:"Layout rows with no space"}],list:Utils.mergeLists([{label:"List Properties"},{p:"info",ex:":List children entries"},{p:"showIcon",ex:"false"},{p:"showDescription",ex:"true"},{p:"showSnippet",ex:"true"},{p:"linkresource",ex:"true",tt:"Link to the resource"},{p:"separator",ex:"",tt:"Separator between links"},{p:"output",ex:"",tt:"Link to output"},{p:"tagopen",ex:"",tt:"html before link"},{p:"tagclose",ex:"",tt:"html after link"},{p:"innerClass",ex:""},{p:"class",ex:"",tt:"link css class"},{p:"style",ex:"",tt:"link style"},{p:"chunkSize",ex:"10",tt:"break up the list of entries into chunkSize lists and display each list"},{p:"numChunks",ex:"2",tt:"how many entry chunks"},{p:"chunkColumns",ex:"2",tt:'how many columns use "numChunks" to match number of chunks'},{p:"chunkStyle",ex:"margin:10px;",tt:"chunk style"}],this.groupAttributes),information:[{label:"Information Properties"},{p:"info",ex:"Show entry information"},{p:"showResource",ex:"true"},{p:"showBase",ex:"true"},{p:"showDetails",ex:"true"},{p:"showAttachments",ex:"false"},{p:"showMetadata",ex:"false"},{p:"menus",ex:"file,edit,view,feeds,other,service"},{p:"menusTitle",ex:"Services"}],description:[{label:"Description Properties"},{p:"wikify",ex:"true"},{p:"prefix",ex:""},{p:"suffix",ex:""},{p:"convert",ex:"_newline=true"}],resource:[{label:"Resource Properties"},{p:"info",ex:"",tt:"Link to the resource"},{p:"title",ex:""},{p:"includeIcon",ex:"true"},{p:"url",ex:"true",tt:"Just include the URL"},{p:"message",ex:"",tt:"Message to show when no resource"}],link:[{label:"Link Properties"},{p:"info",ex:"Link to the entry"},{p:"linkresource",ex:"true",tt:"Link to the resource"},{p:"button",ex:"true",tt:"Make a button"},{p:"title",ex:"",tt:"Title to use"},{p:"action",tt:"Entry action",ex:"edit|access"},{p:"output",ex:"output type",tt:"Link to the given output"}],daterange:[{label:"Date Range Properties"},{p:"format",ex:"yyyy-MM-dd HH:mm:ss Z"},{p:"separator",ex:""}],html:[{label:"HTML Properties"},{p:"info",ex:"true",tt:"Include the HTML of the entry"},{p:"children",ex:"true",tt:"Include HTML of children entries"},{p:"showTitle",ex:"false"}],map:t,mapentry:t,name:[{label:"Name Properties"},{p:"link",ex:"true",tt:"Link to the entry"}],property:[{label:"Property Properties"},{p:"name",ex:""},{p:"value",ex:""}],group:Utils.mergeLists([{label:"Group Properties"},{p:"showMenu",ex:"true"},{p:"showTitle",ex:"true"},{p:"layoutType",ex:"table|flextable|tabs|columns|rows"},{p:"layoutColumns",ex:"1"},{p:"divid",ex:"",tt:"Specify a div id to write displays into"}]),tabs:Utils.mergeLists([{label:"Tabs Properties"},{p:"tag",ex:"html"},{p:"tabsStyle",ex:"min|center|minarrow"},{p:"showLink",ex:"false"},{p:"includeIcon",ex:"true"},{p:"textposition",ex:"top|left|right|bottom"}],this.groupAttributes),grid:Utils.mergeLists([{label:"Grid Properties"},{p:"tag",ex:"card"},{p:"width",ex:"300"},{p:"inner-height",ex:"100"},{p:"showIcon",ex:"true"},{p:"weights",ex:"4,4,4"},{p:"randomCount",ex:6,tt:"Only show a random selection of entries"},{p:"showSnippet",ex:"false"},{p:"showSnippetHover",ex:"true"},{p:"showLink",ex:"false"},{p:"showHeading",ex:"true"},{p:"showLine",ex:"true"},{p:"showSnippetHover",ex:"true"},{p:"showPlaceholderImage",ex:"true",tt:"Show placeholder image"},{p:"addTags",ex:"true"},{p:"tagTypes",ex:"content.keyword"},{p:"addPageSearch",d:!0,tt:"Add the page search form"},{p:"captionPrefix",ex:"Click to view example: ",tt:"To use for popup images"}],this.groupAttributes),frames:Utils.mergeLists([{label:"Frames Properties"},{p:"width",ex:"400"},{p:"height",ex:"400"},{p:"showIcon",ex:"false"},{p:"leftWidth",ex:"2"},{p:"tocStyle",ex:"font-size:9pt;"},{p:"template",ex:"page template or default"},{p:"rightWidth",ex:"10"},{p:"noTemplate",ex:"true",tt:"Don't use the page template in the frame"}],this.groupAttributes),accordian:Utils.mergeLists([{label:"Accordian Properties"},{p:"tag",ex:"html"},{p:"collapse",ex:"false"},{p:"border",ex:"0"},{p:"showLink",ex:"true"},{p:"includeIcon",ex:"false"},{p:"textposition",ex:"left"}],this.groupAttributes),table:Utils.mergeLists([{label:"Table Properties"},{p:"showEntryDetails",ex:"false"},{p:"columns",ex:"name,file,createdate,changedate,fromdate,todate,#entryField1,#entryField2"},{p:"tableOrdering",ex:"true"},{p:"showAllTypes",ex:"true"},{p:"showCategories",ex:"true"},{p:"showDate",ex:"true"},{p:"showCreateDate",ex:"true"},{p:"showChangeDate",ex:"true"},{p:"showColumns",ex:"false"},{p:"show&lt;column name&gt",ex:"false",tt:"show or hide the given column"},{p:"nameLabel",tt:"Override the name label"}],this.groupAttributes),recent:Utils.mergeLists([{label:"Recent Properties"},{p:"info",ex:"",tt:"List N days recent entries by day"},{p:"days",ex:"num days"}],this.groupAttributes),multi:[{label:"Multi Properties"},{info:"Create multiple wiki tags"},{p:"_tag",ex:"tag to create"},{p:"_template",ex:"",tt:"wiki text template. Escape { and } with backslash"},{p:"_entries",ex:"entries",tt:"entries to apply to"},{p:"_headers",ex:"comma separated headers"},{p:"_headerTemplate",ex:":heading {{name link=true}}"},{p:"_columns",ex:"number of columns"},{p:"_width",ex:"200",tt:"Set the width and flow the blocks"},{p:"_style",ex:"padding:10px;",tt:"Style for each block"},{p:"first",ex:".&lt;some attribute&gt;='attr for first tag'"},{p:"last",ex:".&lt;some attribute&gt;='attr for last tag'"},{p:"notlast",ex:".&lt;some attribute&gt;='attr for first N tags'"},{p:"notfirst",ex:".&lt;some attribute&gt;='attr for last N tags'"}],menu:[{label:"Menu Properties"},{p:"menus",ex:"file,edit,view,feeds,other"},{p:"popup",ex:"true"},{p:"breadcrumbs",ex:"true"}]}}},Transcriber.prototype={jq:function(e){return this.container.jq(e)},domId:function(e){return this.container.domId(e)},appendText:function(e){this.container.handleTranscribeText(e)},getAnchor:function(){return this.container.getTranscribeAnchor()},transcribeStart:function(){this.transcribePlaying=!0,this.mediaRecorder.start(),this.transcribeStartTime=new Date,this.jq(ID_TRANSCRIBE_PLAY).html(HU.getIconImage("fa-solid fa-stop fa-gray"));let e=()=>{let t=(new Date).getTime()-this.transcribeStartTime.getTime(),i=parseInt((this.transcribeElapsedTime+t)/1e3);this.jq(ID_TRANSCRIBE_LABEL).html(i+" seconds"),this.transcribeMonitor=setTimeout(e,500)};this.transcribeMonitor=setTimeout(e,500)},transcribeStop:function(){if(this.transcribePlaying=!1,this.transcribeStartTime){let e=(new Date).getTime()-this.transcribeStartTime.getTime();this.transcribeElapsedTime+=e}try{this.mediaRecorder.stop()}catch(e){}this.transcribeMonitor&&clearTimeout(this.transcribeMonitor),this.jq(ID_TRANSCRIBE_PLAY).html(HU.getIconImage("fa-solid fa-microphone fa-gray"))},transcribeClear:function(){this.audioChunks=[],this.transcribeMonitor&&clearTimeout(this.transcribeMonitor),this.transcribeElapsedTime=0;try{this.mediaRecorder.stop()}catch(e){}},transcribeDoIt:function(){if(this.callDoIt=!1,!this.audioChunks||0==this.audioChunks.length)return void alert("No audio has been captured");let e=new Blob(this.audioChunks,{type:this.transcribeMime}),t=(new FormData,RamaddaUtils.getUrl("/llm/transcribe")),i=new FormData;this.jq(ID_TRANSCRIBE_LOADING).show(),i.append("mimetype",this.transcribeMime),i.append("audio-file",e),i.append(ARG_ENTRYID,this.opts.entryId),i.append(ARG_GROUP,this.opts.entryId),HU.isChecked(this.jq("transcribe_sendtochat"))&&i.append("sendtochat","true"),HU.isChecked(this.jq(ID_TRANSCRIBE_ADD_FILE))&&i.append("addfile","true"),$.ajax({url:t,data:i,cache:!1,contentType:!1,processData:!1,method:"POST",type:"POST",success:e=>{this.jq(ID_TRANSCRIBE_LOADING).hide(),this.transcribeClear(),this.jq(ID_TRANSCRIBE_LABEL).html("0 seconds");let t=e.results??e.error;Utils.stringDefined(t)||(t="No results"),this.jq(ID_TRANSCRIBE_TEXT).val(t)},error:e=>{this.jq(ID_TRANSCRIBE_LOADING).hide(),alert("transcription failed"),console.log(e)}})},doTranscribe:function(){navigator.mediaDevices&&navigator.mediaDevices.getUserMedia?navigator.mediaDevices.getUserMedia({audio:!0}).then((e=>{if(this.transcribeMime=["audio/mp3","audio/mp4","audio/wav","audio/webm","audio/mpeg"].filter(MediaRecorder.isTypeSupported)[0],!this.transcribeMime)return void alert("No audio formats available");this.mediaRecorder=new MediaRecorder(e,{mimeType:this.transcribeMime}),this.mediaRecorder.addEventListener("dataavailable",(e=>{this.audioChunks.push(e.data)})),this.mediaRecorder.addEventListener("stop",(()=>{this.callDoIt&&this.transcribeDoIt()}));let t="",i=HU.hbox([HU.span([ATTR_TITLE,"Start recording",ATTR_CLASS,CLASS_CLICKABLE,ATTR_ID,this.domId(ID_TRANSCRIBE_PLAY)],HU.getIconImage("fa-solid fa-microphone fa-gray")),HU.span([ATTR_TITLE,"Transcribe recording",ATTR_CLASS,CLASS_CLICKABLE,ATTR_ID,this.domId(ID_TRANSCRIBE_PEN)],HU.getIconImage("fa-solid fa-pen fa-gray")),HU.boldLabel("Time")+HU.div([ATTR_STYLE,HU.css(CSS_DISPLAY,DISPLAY_INLINE_BLOCK,CSS_TEXT_ALIGN,ALIGN_RIGHT,CSS_WIDTH,HU.px(150)),ATTR_ID,this.domId(ID_TRANSCRIBE_LABEL)],"0 seconds"),HU.span([ATTR_TITLE,"Delete recording",ATTR_CLASS,CLASS_CLICKABLE,ATTR_ID,this.domId(ID_TRANSCRIBE_DELETE)],HU.getIconImage("fa-solid fa-delete-left fa-gray"))],HU.css(CSS_MARGIN_RIGHT,HU.px(5))),s=HU.checkbox("",[ATTR_ID,this.domId("transcribe_sendtochat"),ATTR_TITLE,"Apply LLM to transcription"],!1,"Apply LLM to transcription");s+=SPACE2,s+=HU.checkbox(this.domId(ID_TRANSCRIBE_ADD_FILE),[ATTR_ID,this.domId(ID_TRANSCRIBE_ADD_FILE),ATTR_TITLE,"Add audio file as entry"],!1,"Add as entry"),this.opts.addExtra?t+=HU.leftRightTable(i,s):t=i,t+=HU.div([ATTR_STYLE,HU.css(CSS_POSITION,POSITION_RELATIVE)],HU.textarea("","",[ATTR_PLACEHOLDER,"",ATTR_ID,this.domId(ID_TRANSCRIBE_TEXT),ATTR_ROWS,6,ATTR_COLS,80,ATTR_STYLE,HU.css(CSS_BORDER,CSS_BASIC_BORDER,CSS_PADDING,HU.px(4),CSS_MARGIN,HU.px(4),CSS_FONT_STYLE,FONT_ITALIC)])+HU.div([ATTR_STYLE,HU.css(CSS_DISPLAY,DISPLAY_NONE,CSS_POSITION,POSITION_ABSOLUTE,CSS_TOP,HU.perc(50),CSS_LEFT,HU.perc(50),"-ms-transform",HU.translate("-50%","-50%"),CSS_TRANSFORM,HU.translate("-50%","-50%")),ATTR_ID,this.domId(ID_TRANSCRIBE_LOADING)],HU.image(RamaddaUtil.getCdnUrl("/icons/mapprogress.gif"),[ATTR_STYLE,HU.css(CSS_WIDTH,HU.px(100))]))),t+=HU.buttons([HU.span([ATTR_CLASS,CLASS_DIALOG_BUTTON,"append","true"],this.opts.appendLabel),HU.span([ATTR_CLASS,CLASS_DIALOG_BUTTON,ATTR_ID,this.domId(ID_CANCEL)],LABEL_CANCEL)]),t=HU.div([ATTR_CLASS,CLASS_DIALOG],t);let r=()=>{this.transcribeClear()},o=this.transcribeDialog=HU.makeDialog({content:t,anchor:this.getAnchor(),my:POS_LEFT_BOTTOM,at:"left+200 top-50",title:"Transcribe",callback:r,header:!0,sticky:!0,draggable:!0,modal:!1});this.transcribeElapsedTime=0,this.jq(ID_TRANSCRIBE_PEN).button().click((()=>{this.transcribePlaying?(this.callDoIt=!0,this.transcribeStop()):this.transcribeDoIt()})),this.jq(ID_TRANSCRIBE_PLAY).button().click((()=>{this.transcribePlaying?this.transcribeStop():this.transcribeStart()})),this.jq(ID_TRANSCRIBE_DELETE).click((()=>{this.jq(ID_TRANSCRIBE_TEXT).val(""),this.transcribeStop(),this.transcribeClear(),this.jq(ID_TRANSCRIBE_LABEL).html("0 seconds")}));let a=this;o.find(HU.dotClass(CLASS_DIALOG_BUTTON)).button().click((function(){let e=a.jq(ID_TRANSCRIBE_TEXT).val()??"";$(this).attr("append")?a.appendText(e):(o.remove(),r())}))})).catch((e=>{alert(`Error initializing transcription: ${e}`)})):alert("media recording not supported")}};
