var wikiPopup=null;function WikiEditor(t,e,i,r,s){if(e){$("#"+e).submit((()=>(this.editorChanged=!1,!0))),$(window).bind("beforeunload",(()=>{if(this.editorChanged)return"Changes have been made. Are you sure you want to exit?"}))}this.entryId=t,this.ID_WIKI_PREVIEW="preview",this.ID_WIKI_PREVIEW_INNER="preview_inner",this.ID_WIKI_PREVIEW_LIVE="preview_live",this.ID_WIKI_PREVIEW_CONTENTS="preview_contents",this.ID_WIKI_PREVIEW_OPEN="preview_open",this.ID_WIKI_PREVIEW_CLOSE="preview_close",this.ID_WIKI_PREVIEW_WORDCOUNT="preview_wordcount",this.ID_WIKI_PREVIEW_COPY="preview_copy",this.ID_WIKI_PREVIEW_DOWNLOAD="preview_download",this.ID_WIKI_MESSAGE="message",this.ID_WIKI_MENUBAR="menubar",this.ID_WIKI_POPUP_EDITOR="wiki-popup-editor",this.ID_WIKI_POPUP_OK="wiki-popup-ok",this.ID_WIKI_POPUP_CANCEL="wiki-popup-cancel",this.ID_WIKI_POPUP_TIDY="wiki-popup-tidy",this.ID_WIKI_POPUP_COMPACT="wiki-popup-compact",this.ID_LLM_INPUT="llm-input",this.initAttributes();let o={autoScrollEditorIntoView:!0,copyWithEmptySelection:!0};s&&$.extend(o,s);let a=o.authToken;delete o.authToken,$.extend(this,{id:i,authToken:a,editor:ace.edit(i),formId:e,hidden:r}),this.myDiv=$("#"+this.getId()),WikiUtil.addWikiEditor(this),Utils.initDragAndDrop(this.getDiv(),(t=>{let e=this.lastPosition=this.getEditor().renderer.screenToTextCoordinates(t.clientX,t.clientY),i=new(0,ace.require("ace/range").Range)(e.row,e.column,e.row,e.column+5);this.dragMarker&&this.editor.session.removeMarker(this.dragMarker),this.dragMarker=this.getEditor().session.addMarker(i,"ace_active_char","text",!1)}),(t=>{this.clearDragAndDrop()}),((t,e,i,r)=>{this.clearDragAndDrop(),r||(this.lastPosition=this.getEditor().getCursorPosition()),Ramadda.handleDropEvent(t,e,i,this.entryId,this.authToken,((t,e,i,r)=>{this.handleEntryLink(e,i,this.lastPosition,!0,{isImage:r})}))})),this.editor.setBehavioursEnabled(!1),this.editor.setDisplayIndentGuides(!1),this.editor.setKeyboardHandler("emacs"),this.editor.setShowPrintMargin(!1),this.editor.getSession().setUseWrapMode(!0),this.editor.setOptions(o),this.editor.session.setMode("ace/mode/ramadda"),this.toolbar=$("#"+this.getId()+"_toolbar"),this.editor.container.addEventListener("contextmenu",(t=>{t.preventDefault(),this.handlePopupMenu(t)})),this.editor.container.addEventListener("mouseup",(t=>{this.handleMouseUp(t)})),this.editor.container.addEventListener("mouseleave",(t=>{this.handleMouseLeave(t)})),this.editor.container.addEventListener("mousemove",(t=>{this.handleMouseMove(t)})),this.editor.getSession().on("change",(t=>{if(this.editorChanged=!0,this.previewShown&&this.previewLive){if(this.previewPending)return;this.previewPending=setTimeout((()=>{this.previewPending=null,this.doPreview(this.entryId,!0)}),100)}})),this.getBlock().find("#"+this.id).append(HU.div([STYLE,HU.css("display","none"),CLASS,"wiki-editor-message",ID,this.domId(this.ID_WIKI_MESSAGE)])),this.wikiInitDisplaysButton(),this.initTagSearch(),this.jq("previewbutton").click((()=>{HtmlUtils.hidePopupObject(),this.doPreview(this.entryId)})),this.jq("color").click((t=>{HtmlUtils.hidePopupObject(),this.doColor(t)})),this.jq("find").click((()=>{HtmlUtils.hidePopupObject(),this.doFind()})),this.jq("wordcount").click((()=>{HtmlUtils.hidePopupObject(),this.doWordcount()})),this.jq("rewrite").click((()=>{HtmlUtils.hidePopupObject(),this.doLlm()})),this.jq("transcribe").click((()=>{HtmlUtils.hidePopupObject(),this.transcriber||(this.transcriber=new Transcriber(this,{})),this.transcriber.doTranscribe()})),this.jq("tidy").click((()=>{HtmlUtils.hidePopupObject(),this.doTidy()}))}function getWikiEditorMenuBlocks(t,e,i){let r=[],s=null,o=t=>{r.push(s={index:r.length,title:t,items:[]})},a="ramadda-menu-item "+(e?" ramadda-hoverable ramadda-highlightable ":"");return t.forEach((t=>{(t=>{if(t.inline||t.inlineLabel)return void o(t.inline||t.inlineLabel);if(t.label&&!t.p)return void o(t.label);if(t.info)return void s.items.push(HU.div([CLASS,a],"<i>"+t.info+"</i>"));if(!t.p)return void console.log("Unknown arg:"+JSON.stringify(t));let e=t.label||t.p,r="";if(r=Utils.isDefined(t.ex)?String(t.ex):Utils.isDefined(t.d)?String(t.d):"",r=r.trim(),(r.indexOf(" ")>=0||""==r)&&(r='"'+r+'"'),r=" "+t.p+"="+r+" ",r=r.replace(/\"/g,"&quot;"),s){let o=e+" "+(t.tt??"");i&&(e=HtmlUtils.onClick("WikiUtil.insertText('"+i+"','"+r+"')",e)),s.items.push(HU.div(["data-block-index",s.index,"data-corpus",o,CLASS,a,TITLE,t.tt||"","data-attribute",r],e))}else console.log("no attribute block")})(t)})),r}function getWikiEditorMenuBar(t,e,i){let r="";return r+=HU.tag(TAG_LI,[],HU.div(["id","searchattributes",CLASS,"wiki-popup-menu-header ramadda-clickable","title","Search attributes"],HU.getIconImage("fa-binoculars"))),t.forEach(((t,e)=>{if("string"==typeof t)return;let s=t.title;if(i&&s.toLowerCase().startsWith(i)){let t=Utils.makeLabel(s.substring(i.length).trim());""!=t&&(s=t)}if(0==t.items.length)return;let o=Utils.wrap(t.items,"<li>","");r+=HU.tag(TAG_LI,[],HU.div([CLASS,"wiki-popup-menu-header"],s)+HU.tag("ul",[CLASS,"wiki-popup-menu-item"],o))})),HU.div([CLASS,"wiki-popup-menubar",ATTR_ID,e],HU.tag("ul",[ATTR_ID,e+"_inner",ATTR_CLASS,"sf-menu"],r))}function Transcriber(t,e){this.audioChunks=[],this.container=t;let i={appendLabel:"Append",addExtra:!0};e&&$.extend(i,e),this.opts=i}window.WikiUtil||(window.WikiUtil={initWikiEditor(t,e,i,r){let s=i+"_block",o=e+"_block";$("#"+r).click((()=>{let t=WikiUtil.getWikiEditor(e);if($("#"+r).is(":checked")){$("#"+s).css("display","none"),$("#"+o).css("display","block");let r=$("#"+i).val();t.getEditor().setValue(r,8),$("#"+e).focus()}else{let e=t.getEditor().getValue();$("#"+i).val(e),$("#"+s).css("display","block"),$("#"+o).css("display","none"),$("#"+i).focus()}}))},handleWikiEditorSubmit:function(){if(this.wikiEditors)for(a in this.wikiEditors){this.wikiEditors[a].handleSubmit()}},getWikiEditor:function(t){return this.wikiEditors?this.wikiEditors[t]:null},addWikiEditor:function(t,e){this.wikiEditors||(this.wikiEditors={}),e=e||t.getId(),this.wikiEditors[e]=t},insertDisplayText:function(t,e){let i=window.globalDisplayTypesMap[e];if(!i)return void WikiUtil.insertText(e);let r="{{";"group"==i.type?r+="group ":r+="display_"+i.type+" ",i.wiki&&(r+=i.wiki),r+="}} ",wikiPopup&&wikiPopup.hide(),WikiUtil.insertText(t,r)},insertText:function(t,e){HtmlUtils.hidePopupObject();let i=HtmlUtils.getTooltip();i&&i.hide();let r=getHandler(t);if(r)return void r.insertText(e);let s=WikiUtil.getWikiEditor(t);if(s)return void s.insertAtCursor(e);let o=GuiUtils.getDomObject(t);o&&WikiUtil.insertAtCursor(t,o.obj,e)},insertAtCursor:function(t,e,i){let r=WikiUtil.getWikiEditor(t);if(!i.entryId||!r)return r?(i=Utils.decodeText(i),void r.insertAtCursor(i)):void HtmlUtils.insertIntoTextarea(e,i);r.handleEntryLink(i.entryId,i.name,null,!1,i)},insertTags:function(t,e,i,r){HtmlUtils.hidePopupObject();let s=getHandler(t);if(s)return void s.insertTags(e,i,r);let o=WikiUtil.getWikiEditor(t);o?o.insertTags(e,i,r):console.log("Could not find editor:"+t)},insertTagsInner:function(t,e,i,r,s){let o;i=Utils.decodeText(i),r=Utils.decodeText(r);let a=WikiUtil.getWikiEditor(t);if(a){a=a.getEditor();let t=i+r+" ",e=a.getCursorPosition();return a.insert(t),i.endsWith("\n")?(e.row++,e.column=0):e.column+=i.length,a.selection.moveTo(e.row,e.column),void a.focus()}if(e.selectionStart||"0"==e.selectionStart){let t=e.scrollTop;e.focus();let s=e.selectionStart,a=e.selectionEnd;return o=e.value.substring(s,a),e.value=e.value.substring(0,s)+i+o+r+e.value.substring(a,e.value.length),e.selectionStart=s+i.length+o.length+r.length,e.selectionEnd=e.selectionStart-r.length,void(e.scrollTop=t)}if(document.selection&&document.selection.createRange){let t;document.documentElement&&document.documentElement.scrollTop?t=document.documentElement.scrollTop:document.body&&(t=document.body.scrollTop),e.focus();let s=document.selection.createRange();o=s.text,s.text=i+o+r,s.select&&s.select(),document.documentElement&&document.documentElement.scrollTop?document.documentElement.scrollTop=t:document.body&&(document.body.scrollTop=t)}}}),WikiEditor.prototype={getId:function(){return this.id},domId:function(t){return this.getId()+"_"+t},getTranscribeAnchor:function(){return this.getScroller()},handleTranscribeText:function(t){this.getEditor().session.insert(this.getEditor().getCursorPosition(),t.trim())},handleEntryLink:function(t,e,i,r,s){$.getJSON(RamaddaUtil.getUrl("/wiki/getmacros?entryid="+t),(o=>{let a=[];o.forEach((e=>{a.push({label:e.label+" - macro",value:'{{macro name="'+e.name+'" '+(e.properties??"")+'  entry="${entryid}"}}'});let i=e.macro.trim(),r=i.split('#entry="${entry}"');i=r.join("entry="+t),a.push({label:e.label+" - wiki text",value:i})})),this.handleEntryLinkInner(t,e,i,r,s,a)})).fail((o=>{console.log("failed to get macros"),this.handleEntryLinkInner(t,e,i,r,s)}))},handleEntryLinkInner:function(t,e,i,r,s,o){let a=HU.center(HU.b(e));a+=r?"The new entry has been added. What do you want to insert into the document?<br>":"What do you want to insert into the document?<br>";let n=[];const l="ID",d="entry=ID",h="Link",p="Wiki Text",c="Description",u="Image",m="Editable map",g="Tree",f="Grid",I="Gallery",b="Import",x="Children IDS",y="Children Links",w="nothing";o&&o.forEach((t=>{t.label?n.push({label:t.label,value:"base64:"+window.btoa(t.value)}):n.push(t)})),r?(s.isImage&&n.push(u),n.push(l),n.push(d),n.push(h),n.push(w)):(n.push(l),n.push(d),n.push(h),n.push(p),n.push(c),s.isImage&&n.push(u),s.isGeo&&n.push("Map"),"geo_editable_json"==s.entryType&&n.push(m),s.isGroup&&(n.push(g),n.push(f),n.push(I)),n.push(b),n.push(x),n.push(y)),a+=HU.select("",[ATTR_ID,this.domId("addtype")],n,this.lastWhat),a+="<p>",a+=HU.div([STYLE,HU.css("display","inline-block"),CLASS,"ramadda-button",ID,this.domId("addok")],"OK")+SPACE3+HU.div([STYLE,HU.css("display","inline-block"),CLASS,"ramadda-button",ID,this.domId("addcancel")],"Cancel"),a=HU.div([STYLE,HU.css("padding","10px","width","400px")],a);let k=this.addDialog=HU.makeDialog({content:a,anchor:this.getScroller(),title:"Select Entry",header:!0,sticky:!0,draggable:!0,modal:!0}),T=k.find("#"+this.domId("addtype"));HU.initSelect(T),k.find("#"+this.domId("addcancel")).button().click((()=>{this.addDialog.remove()})),k.find("#"+this.domId("addok")).button().click((()=>{this.addDialog.remove();let r=this.lastWhat=T.val();r=Utils.convertText(r);let s="",o=t=>{i?this.getEditor().session.insert(i,t):this.insertAtCursor(t)};if(r==u)s="{{image entry="+t+' #caption="'+e+'" bordercolor="#ccc" align=center screenshot=true #width=75% }} ';else if("Map"==r)s="{{map entry="+t+" details=true}}";else if(r==m)s="{{editable_map entry="+t+" }}";else if(r==g)s="{{tabletree entry="+t+" }}";else if(r==l)s=t;else if(r==d)s=" entry="+t+" ";else if(r==I)s="{{gallery entry="+t+" }}";else if(r==b)s="{{import entry="+t+" }}";else if(r==f)s="{{grid entry="+t+" }}";else{if(r==p||r==c||r==x||"Children Links"==r){let e=RamaddaUtils.getUrl("/entry/wikitext?entryid="+t);return r==c?e+="&what=description":r==y?e+="&what=children_links":r==x&&(e+="&what=children_ids"),void $.get(e,(t=>{t=(t=String(t).replace(/^ *<wiki>\s/,"")).replace(/{{description}}/g,"").replace(/{{description +wikify=\"?true\"?}}/g,""),o(t)})).fail((t=>{alert("An error occurred:"+t)}))}if(r==h)s="[["+t+"|"+e+"]] ";else{if(r==w)return;r.indexOf("${entryid}")>=0&&(r=r.replace(/\${entryid}/g,t)),s=r.trim()}}o(s)}))},clearDragAndDrop:function(){this.dragMarker&&this.getEditor().session.removeMarker(this.dragMarker)},getDiv:function(){return this.myDiv},jq:function(t){return $("#"+this.domId(t))},showMessage:function(t){this.jq(this.ID_WIKI_MESSAGE).css("display","block").html(t)},clearMessage:function(t){this.jq(this.ID_WIKI_MESSAGE).css("display","none"),this.showingEntryPopup=!1},getEditor:function(){return this.editor},getValue:function(){return this.getEditor().getValue()},setValue:function(t){this.getEditor().setValue(t)},getBlock:function(){return $("#"+this.getId()+"_block")},getScroller:function(){return this.getBlock().find(".ace_scroller")},getSession:function(){return this.getEditor().session},insertAtCursor:function(t){t=Utils.decodeText(t);let e=this.getEditor().getSelectedText();if(e&&(t=t+"\n"+e),this.popupShowing){let e=this.jq(this.ID_WIKI_POPUP_EDITOR)[0];if(e)return WikiUtil.insertAtCursor(null,e,t),e.focus(),this.jq(this.ID_WIKI_MENUBAR).find(".wiki-popup-menu-item").css("display","none"),void setTimeout((()=>{this.jq(this.ID_WIKI_MENUBAR).find(".wiki-popup-menu-item").removeAttr("style")}),1e3)}this.getEditor().getCursorPosition();this.getEditor().insert(t),this.getEditor().focus()},insertTags:function(t,e,i){t=Utils.decodeText(t),e=Utils.decodeText(e),i=Utils.decodeText(i);let r=this.getEditor().getSelectedText(),s=(t??"")+(r?r+"\n":"")+(e??"")+" ",o=this.getEditor().getCursorPosition();this.getEditor().insert(s),t.endsWith("\n")?(o.row++,o.column=0):o.column+=t.length,this.getEditor().selection.moveTo(o.row,o.column),this.getEditor().focus()},getTagInfo:function(t){let e;t=t||this.getEditor().getCursorPosition();let i=this.getSession().doc.positionToIndex(t),r=this.getEditor().getValue(),s=-1,o=-1,a=!1,n=i,l=-1,d=/[0-9a-f\-]/;for(;n>=0;){let t=r[n];if(!t||!t.match(d))break;l=n--}let h=i;if(l>=0)for(n=i+1;n<r.length;){if(!r[n].match(d))break;h=n++}if(l>=0){let t=r.substring(l,h+1);t.match(/[0-9a-f\-]+-[0-9a-f\-]+-[0-9a-f\-]+-[0-9a-f\-]+-[0-9a-f\-]+/)&&(e=t)}for(n=i;n>=0;){if("{"!=r[n])a=!1,n--;else{if(a){s=n;break}a=!0,n--}}if(s>=0)for(a=!1,n=s;n<r.length;)if("}"!=r[n])n++,a=!1;else{if(a){o=n;break}a=!0,n++}if(i>=s&&i<=o&&s>=0&&o>=s){let t,i=r.substring(s,o+1),a=i.match(/\{\{ *([^ \n\}]+)/);if(a&&a.length>1&&(t=a[1]),t){let r="",n=i.trim().substring(2),l=n.indexOf(" "),d=n.indexOf("}}");n=-1!=l&&l<d?n.substring(l).trim():n.substring(d).trim(),n.endsWith("}}")&&(n=n.replace(/}}$/,"")),"group"==t?(r="group",t="display"):t.startsWith("display_")?(r=t.substring(8),t="display"):(a=i.match(/type *= *\"([^\"]+)\"?/),a&&a.length>1&&(r=a[1]));let h=0,p=this.getSession().doc.getAllLines(),c=0,u=-1,m=-1,g=-1,f=-1,I=s+1,b=o+1;p.every((t=>{let e=h+t.length+1;return-1==u&&e>=I&&(u=c,g=I-h-1),-1!=u&&-1==m&&e>=b?(m=c,f=b-h,!1):(c++,h=e,!0)}));let x={start:{row:u,column:g},end:{row:m,column:f}};return x=new(0,ace.require("ace/range").Range)(u,g,m,f),{range:x,entryId:e,tag:t,type:r,left:s,right:o,chunk:i,attrs:n}}}let p=i;for("\n"==r[p]&&p--;p>=0&&"\n"!==r[p];)p--;if(p<0&&"+"==r[p+1]&&(p=0),p>=0){let e=r.substring(p).trim();if(e.startsWith("+")){let i=e.indexOf("\n");i>=0&&(e=e.substring(0,i));let r=e.length,s=e.match("[^ ]+([^\n]*)$");if(s&&(s=s[1].trim()),!e)return null;let o=e.match("\\+([^ \n]+)[ \n]");if(!o)return;return e=o[1],{range:new(0,ace.require("ace/range").Range)(t.row,0,t.row,r),tag:e,type:"plus",attrs:s||""}}}return e?{entryId:e}:null},handleSubmit:function(){0==$("#"+this.hidden).length&&console.log("WikiEdit.handleSubmit: no hidden value"),$("#"+this.hidden).val(this.getEditor().getValue())},doFind:function(t){this.getEditor().execCommand("find")},doWordcount:function(t){null==t&&(t=this.getEditor().getValue()),t=t.replace(/<[^>]+>/g," ").replace(/<\/[^>]>/g," ").replace(/&nbsp;/g," "),t=Utils.split(t.replace(/[<>\n={}]/g," ")," ",!0,!0),alert("Approximately "+t.length+" words")},doTidy:function(){if(!confirm("This will remove blank links and trim each line. Continue?"))return;let t=this.getValue(),e="",i=(t,i)=>{e+=i?t+"\n":t.trim()+"\n"},r=!1,s=0;Utils.split(t,"\n").forEach((t=>{if(t.startsWith("-javascript"))return r=!1,void i(t);if(t.startsWith("+javascript"))return r=!0,void i(t);if(r){let i=t.trim(),r="",o=!0;if((i.match(/\}+\);?/)||i.match(/\} *,/))&&(s--,o=!1),s<0&&(s=0),new Array(s).fill(0).forEach((t=>{r+="\t"})),e+=r+i+"\n",i.startsWith("//")||!o)return;i.endsWith("{")?s++:(i.endsWith("}")||i.endsWith("});")||i.endsWith("});"))&&s--}else if(t.length<80)i(t);else if(t.startsWith(":"))i(t);else{for(t=t.trim();t.length>80;){let e=t.substring(0,80),r=t.substring(80),s=r.indexOf(" ");if(s<0){i(t),t="";break}i(e+r.substring(0,s)),t=r.substring(s)}""!=t&&i(t)}})),this.setValue(e)},doLlm:function(){this.addedLlmListener||this.editor.getSession().selection.on("changeSelection",(()=>{let t=this.getEditor().getSelectedText();Utils.stringDefined(t)&&!this.llmReplacing&&this.jq(this.ID_LLM_INPUT).val(t)}));let t=this.getEditor().getSelectedText()??"",e=[{value:"",label:"Select prompt"}],i=[{label:"Rewrite for college reader",prompt:"Rewrite the following text for a college educated reader:"},{label:"Rewrite for 5th grader",prompt:"Rewrite the following text for a 5th grade reader:"},"Can you give a short description of the below topic:","Write a comprehensive guide for the below topic:","Write a blog post on the below topic:",{label:"Make a lesson plan for the below topic",prompt:"I need help developing a lesson plan on the below topic for college studentss. The topic is:"},{label:"Check spelling",prompt:"List all of the words in the following text that are misspelled:"},{label:"Translate to English",prompt:"I want you to act as an English translator, spelling corrector and improver. I will speak to you in any language and you will detect the language, translate it and answer in the corrected and improved version of my text, in English. I want you to replace my simplified A0-level words and sentences with more beautiful and elegant, upper level English words and sentences. Keep the meaning same, but make them more literary. I want you to only reply the correction, the improvements and nothing else, do not write explanations."},{label:"Translate to Spanish",prompt:"I want you to act as an Spanish translator, spelling corrector and improver. I will speak to you in English and you will  translate it to Spanish and answer in the corrected and improved version of my text, in Spanish. I want you to only reply the correction, the improvements and nothing else, do not write explanations."},{label:"Translate to French",prompt:"I want you to act as an French translator, spelling corrector and improver. I will speak to you in English and you will  translate it to French and answer in the corrected and improved version of my text, in French. I want you to only reply the correction, the improvements and nothing else, do not write explanations."}];i.forEach(((t,i)=>{t.label?e.push({value:i,label:t.label}):e.push({value:i,label:t})}));let r=HU.getUniqueId(),s=HU.formTable()+HU.formEntry("Prompt:",HU.div(["id",r]))+HU.formEntry("","Or enter prompt:")+HU.formEntry("Prompt prefix:",HU.textarea("",this.lastPromptPrefix??"",[ATTR_CLASS,"wiki-llm-input","style","width:500px;","id",this.domId("llm-prompt-prefix"),"rows",5]))+HU.formEntry("Prompt suffix:",HU.input("",this.lastPromptSuffix??"",[ATTR_CLASS,"wiki-llm-input","style","width:500px;","id",this.domId("llm-prompt-suffix")]))+HU.formTableClose();s+=HU.textarea("",t,["placeholder","Enter input or select text in editor","id",this.domId(this.ID_LLM_INPUT),"rows",6,"cols",80,"style","border:var(--basic-border);padding:4px;margin:4px;font-style:italic;"]),s+="<br>",s+=HU.span(["id",this.domId("llm-call")],"Evaluate"),s+=HU.div(["style","position:relative;"],HU.textarea("","",["placeholder","Results","id",this.domId("rewrite-results"),"rows",6,"cols",80,"style","border:var(--basic-border);padding:4px;margin:4px;font-style:italic;"])+HU.div(["style","display:none;position:absolute;top: 50%; left: 50%; -ms-transform: translate(-50%, -50%); transform: translate(-50%, -50%);","id",this.domId("llm-loading")],HU.image(RamaddaUtil.getCdnUrl("/icons/mapprogress.gif"),["style","width:100px;"]))),s+=HU.buttons([HU.span([ATTR_CLASS,CLASS_DIALOG_BUTTON,"replace","true"],"Replace"),HU.span([ATTR_CLASS,CLASS_DIALOG_BUTTON,"append","true"],"Append"),HU.span([ATTR_CLASS,CLASS_DIALOG_BUTTON,"cancel","true",ATTR_ID,this.domId("cancel")],"Cancel")]),s=HU.div([ATTR_CLASS,CLASS_DIALOG],s);let o=this.llmDialog=HU.makeDialog({content:s,anchor:this.getScroller(),my:"left bottom",at:"left+200 top-50",title:"LLM",header:!0,sticky:!0,draggable:!0,modal:!1}),a=e=>{t=this.jq(this.ID_LLM_INPUT).val()??"",this.jq("llm-loading").show();let i=RamaddaUtils.getUrl("/llm/rewrite"),r={usegpt4:!0,text:t};e?r.promptprefix=e:(r.promptprefix=this.lastPromptPrefix=this.jq("llm-prompt-prefix").val(),r.promptsuffix=this.lastPromptSuffix=this.jq("llm-prompt-suffix").val()),$.post(i,r,(t=>{if(n.jq("llm-loading").hide(),!Utils.stringDefined(t.result))return void alert("No result");let e=t.result.trim();this.jq("rewrite-results").val(e)})).fail((t=>{n.jq("llm-loading").hide(),alert("Rewrite failed")}))};(()=>{let t=HU.select("",["id",this.domId("llmprompts")],e);jqid(r).html(t),this.jq("llmprompts").change((function(){let t=$(this).val(),e=i[t];if(!e)return;let r=e.prompt??e;Utils.stringDefined(r)&&(a(r),$(this).val(""))}))})(),o.find(".wiki-llm-input").keypress((function(t){13==t.keyCode&&a()})),this.jq("llm-call").button().click((()=>{a()}));let n=this;o.find(".ramadda-dialog-button").button().click((function(){if(n.llmReplacing=!0,$(this).attr("cancel"))return void o.remove();let t=n.jq("rewrite-results").val();t&&($(this).attr("replace")?n.getEditor().session.replace(n.getEditor().selection.getRange(),t):$(this).attr("append")?n.getEditor().session.insert(n.getEditor().getCursorPosition(),t):o.remove(),n.llmReplacing=!1)}))},doColor:function(t){let e=HU.tag("input",["style",HU.css("width","100px","height","100px"),"type","color","id",this.domId("color_picker")]);e+=HU.div([ATTR_CLASS,"ramadda-buttons"],HU.span([ID,this.domId("color_apply")],"Apply")+SPACE1+HU.span([ID,this.domId("color_ok")],"Ok")+SPACE1+HU.span([ID,this.domId("color_cancel")],"Cancel")),e=HU.div([ATTR_CLASS,CLASS_DIALOG],e),this.colorDialog&&this.colorDialog.remove(),this.colorDialog=HU.makeDialog({content:e,anchor:this.getDiv(),my:"left bottom",at:"left+200 top-50",title:"Select Color",header:!0,sticky:!0,draggable:!0,modal:!1});let i=this.jq("color_picker"),r=()=>{i.attr("type","text").attr("type","color"),i.remove(),this.colorMarker&&this.editor.session.removeMarker(this.colorMarker),this.colorDialog.remove(),this.colorDialog=null},s=()=>{let t=this.getEditor().getCursorPosition(),e=i.val();this.insertAtCursor(e);new(0,ace.require("ace/range").Range)(t.row,t.column,t.row,t.column+e.length);this.colorMarker&&this.editor.session.removeMarker(this.colorMarker)};this.jq("color_apply").button().click((()=>{s()})),this.jq("color_ok").button().click((()=>{s(),r()})),this.jq("color_cancel").button().click((()=>{r()})),setTimeout((()=>{i.trigger("click")}))},doPreview:async function(t,e){let i=this.getId();$("#"+i);if(!e){let t=$(window).width()-200;$("#"+this.domId(this.ID_WIKI_PREVIEW)).remove(),$(HU.div([ID,this.domId(this.ID_WIKI_PREVIEW),CLASS,"wiki-editor-preview"],"")).appendTo(this.getBlock()),$("#"+this.domId(this.ID_WIKI_PREVIEW)).css("width",t+"px"),this.previewShown=!0}let r=this.getValue(),s=ramaddaBaseUrl+"/wikify";$.post(s,{doImports:"false",entryid:t,wikitext:r},((i,r,s)=>{let o=this;if(e)this.jq(this.ID_WIKI_PREVIEW_INNER).html(i);else{let e=Utils.join([HU.span([CLASS,CLASS_CLICKABLE,ID,this.domId(this.ID_WIKI_PREVIEW_OPEN)],HtmlUtils.getIconImage("fa-sync",[ATTR_TITLE,"Preview Again"])),HU.checkbox("",[TITLE,"Live Preview",ID,this.domId(this.ID_WIKI_PREVIEW_LIVE)],this.previewLive,"Live")+SPACE4,HU.span([CLASS,CLASS_CLICKABLE,TITLE,"Wordcount",ID,this.domId(this.ID_WIKI_PREVIEW_WORDCOUNT)],HtmlUtils.getIconImage("fa-calculator")),HU.span([CLASS,CLASS_CLICKABLE,TITLE,"Copy",ID,this.domId(this.ID_WIKI_PREVIEW_COPY)],HtmlUtils.getIconImage("fa-copy")),HU.span([CLASS,CLASS_CLICKABLE,TITLE,"Download",ID,this.domId(this.ID_WIKI_PREVIEW_DOWNLOAD)],HtmlUtils.getIconImage("fa-download"))],SPACE2),r=HU.span([CLASS,CLASS_CLICKABLE,ID,this.domId(this.ID_WIKI_PREVIEW_CLOSE)],HtmlUtils.getIconImage("fa-window-close",[ATTR_TITLE,"Close Preview"]));i=HtmlUtils.div([CLASS,"ramadda-menubar","style","xtext-align:center;width:100%;border:1px solid #ccc"],HU.leftRight(e,r))+(i=HtmlUtils.div([ID,this.domId(this.ID_WIKI_PREVIEW_INNER),CLASS,"wiki-editor-preview-inner"],i));let s=$("#"+this.domId(this.ID_WIKI_PREVIEW));try{s.html(i).show()}catch(t){s.html(HU.getErrorDialog("An error occurred:"+t))}s.draggable(),s.resizable({handles:"ne,nw"}),this.jq(this.ID_WIKI_PREVIEW_WORDCOUNT).click((function(){o.doWordcount(o.jq(o.ID_WIKI_PREVIEW_INNER).html())})),this.jq(this.ID_WIKI_PREVIEW_COPY).click((function(){let t=o.jq(o.ID_WIKI_PREVIEW_INNER).html();Utils.copyToClipboard(t),alert("Text is copied to clipboard")})),this.jq(this.ID_WIKI_PREVIEW_DOWNLOAD).click((function(){let t=o.jq(o.ID_WIKI_PREVIEW_INNER).html();Utils.makeDownloadFile("preview.html",t)})),this.jq(this.ID_WIKI_PREVIEW_LIVE).click((function(){o.previewLive=$(this).is(":checked")})),this.jq(this.ID_WIKI_PREVIEW_OPEN).click((()=>{this.doPreview(t,!0)})),$("#"+this.domId(this.ID_WIKI_PREVIEW_CLOSE)).click((()=>{this.previewShown=!1,$("#"+this.domId(this.ID_WIKI_PREVIEW)).hide()}))}})).fail(((t,e,i)=>{console.log("error fetching preview:"+t)}))},getAttributeBlocks:function(t,e,i){if(!t)return null;let{attrs:r,title:s,display:o}=this.getDisplayAttributes(t),a=this.getWikiAttributes(t,(r=>{this.getAttributeBlocks(t,e,i)}));if(!1===a)return!1;if(a&&(r=Utils.mergeLists(r,a)),!r)return null;let n=getWikiEditorMenuBlocks(r,e,this.getId()),l=Utils.getColorTablePopup(this,!0);n.push({title:"Color table",items:l}),s||(s=null,this.wikiAttributesFromServer&&this.wikiAttributesFromServer[t.tag]&&this.wikiAttributesFromServer[t.tag][0]&&(s=this.wikiAttributesFromServer[t.tag][0].label),s||(s=Utils.makeLabel(t.tag)+" Properties"));let d={blocks:n,title:s,display:o};return i&&i(d),d},handleEntriesPopup:function(t,e,i){this.getEntryNames(t,(t=>{if(0!=t.length){if(t.length){let r=i??"";t.forEach((t=>{r+=(t.icon?HU.getIconImage(t.icon,["width","24px"])+HU.space(1):"")+HU.href(RamaddaUtil.getUrl("/entry/show")+"?entryid="+t.id,t.name,[ATTR_TITLE,t.id,"target","_entries"])+"<br>"})),jqid(e).html(r)}}else jqid(e).html("No entries found")}),!0)},handlePopupMenu:function(t,e){let i=this.getTagInfo();if(!i)return;if(!i.chunk)return;if(!e)return void this.getAttributeBlocks(i,!0,(e=>{this.handlePopupMenu(t,e)}));let r=e.blocks,s=e.title;e.display;if(0==r.length)return;let o=HU.open("div",[CLASS,"wiki-editor-popup","style","min-width:400px;"]);s||(s=Utils.makeLabel(i.tag)+" Properties");let a=HU.span(["id",this.domId("searchattributes"),CLASS,"wiki-popup-menu-header ramadda-clickable",ATTR_TITLE,"Search attributes"],HU.getIconImage("fa-binoculars")),n=HU.span(["id",this.domId("edittag"),CLASS,"wiki-popup-menu-header ramadda-clickable",ATTR_TITLE,"Edit tag"],HU.getIconImage("fas fa-edit"));o+=HU.div([CLASS,"wiki-editor-popup-heading"],a+""+n+" "+s);let l=this.extractEntryIds(i.chunk);if(l.length){let t=Utils.getUniqueId("entrieslist");o+=HU.toggleBlock("Entries",HU.div([ID,t,CLASS,"wiki-editor-popup-items"],"Loading ...")),this.handleEntriesPopup(l,t)}Utils.splitList(r,5).forEach((t=>{o+=HU.open("div",[CLASS,"wiki-editor-popup-section"]),t.forEach((t=>{if("string"==typeof t)return void(o+=t);let e=t.title;e=HU.div([CLASS,"wiki-editor-popup-header"],e);let i=t.items.join("");i=HU.div([CLASS,"wiki-editor-popup-items"],i),o+=HU.toggleBlock(t.title,i)})),o+=HU.close("div")})),o+="</div>";let d=HU.makeDialog({content:o,anchor:$(window),my:"left top",at:"left+"+t.x+" top+"+t.y,title:s,header:!0,sticky:!0,draggable:!0,modal:!1});HtmlUtils.setPopupObject(d),jqid(this.domId("edittag")).click((()=>{d.remove(),this.showTagEdit(i,e)})),jqid(this.domId("searchattributes")).click((()=>{d.remove(),this.makeSearchAttributesDialog(this.toolbar,r,!1)}))},handleMouseUp:function(t,e,i,r){let s=this.getEditor().renderer.screenToTextCoordinates(t.x,t.y);if(!s)return;let o=this.getTagInfo(s);if(o)if(r=r||this.editMode||t.metaKey||i,this.setEditMode(!1),r)e?this.showTagEdit(o,e):this.getAttributeBlocks(o,!1,(e=>{this.handleMouseUp(t,e,i,!0)}));else if(o.entryId)if(t.shiftKey){let t=RamaddaUtils.getEntryUrl(o.entryId);window.open(t,"_blank")}else this.showEntryPopup(o.entryId)},showTagEdit:function(t,e){let i=this,r=e.blocks,s=e.title,o=(e.display,t.attrs),a=t.type||t.tag,n=this.domId(this.ID_WIKI_MENUBAR),l=getWikiEditorMenuBar(r,n,a),d=$(window).width()-100,h=HU.div([ID,this.domId("wiki-editor-popup"),CLASS,"wiki-editor-editor"],l+HU.textarea("",o,["spellcheck","false",STYLE,HU.css("width",d+"px","height","300px"),ID,this.domId(this.ID_WIKI_POPUP_EDITOR),"xrows","10","xcols","120"])+"<br>"+HU.div([STYLE,HU.css("text-align","center","padding","4px")],HU.span([TITLE,"Tidy the text",ID,this.domId(this.ID_WIKI_POPUP_TIDY)],HU.getIconImage("fas fa-broom"))+SPACE1+HU.span([TITLE,"Compact the text",ID,this.domId(this.ID_WIKI_POPUP_COMPACT)],HU.getIconImage("fas fa-snowplow"))+SPACE1+HU.span([ID,this.domId(this.ID_WIKI_POPUP_OK)],"Ok")+SPACE1+HU.span([ID,this.domId(this.ID_WIKI_POPUP_CANCEL)],"Cancel"))),p=HU.makeDialog({content:h,anchor:this.getScroller(),title:s,header:!0,sticky:!0,draggable:!0,modal:!0,modalContentsCss:HU.css("left","50px")});jqid("searchattributes").click((function(){i.makeSearchAttributesDialog($(this),r,!0)})),this.popupShowing=!0,this.jq(this.ID_WIKI_POPUP_EDITOR).focus(),this.jq(this.ID_WIKI_POPUP_CANCEL).button().click((()=>{this.popupShowing=!1,p.remove()}));let c=t=>{let e=this.jq(this.ID_WIKI_POPUP_EDITOR).val().trim(),i=Utils.parseAttributesAsList(e),r="",s=0;for(let e=0;e<i.length;e+=2){let o=i[e+1];null!=o&&(o.indexOf(" ")>=0||o.indexOf("\n")>=0||""==o)&&(o='"'+o+'"'),r+=i[e]+"="+o,t?r+="\n":(s++,s>4?(s=0,r+="\n"):r+="  ")}this.jq(this.ID_WIKI_POPUP_EDITOR).val(r)};this.jq(this.ID_WIKI_POPUP_TIDY).button().click((()=>{c(!0)})),this.jq(this.ID_WIKI_POPUP_COMPACT).button().click((()=>{c(!1)})),this.jq(this.ID_WIKI_POPUP_OK).button().click((()=>{let e,i=this.jq(this.ID_WIKI_POPUP_EDITOR).val(),r=t.tag;"display"==r&&("group"==t.type?r="group":""!=t.type&&(r="display_"+t.type)),"plus"==t.type?(i=i.replace(/\n/g," "),e="+"+r+" "+i+" "):e="{{"+r+" "+i+"}}",this.popupShowing=!1,p.remove(),this.getSession().replace(t.range,e)}))},makeSearchAttributesDialog:function(t,e,i){let r=this,s="";e.forEach(((t,e)=>{if("string"==typeof t)return;if("Color table"==t.title)return;let i=t.title;s+=HU.div([ATTR_CLASS,"wiki-searchheader","data-block-index",t.index],HU.b(i)),s+="<div>";let r=Utils.join(t.items," ");r=r.replace(/<div/g,"<span").replace(/\/div>/g,"/span>"),s+=r,s+="</div>"})),s=HU.center(HU.input("","",["placeholder","Search","id",r.domId("allsearch"),"width","10"]))+HU.div(["id",r.domId("allsearch_corpus"),"style",HU.css("width","500px","max-height","400px","overflow-y","auto")],s),s=HU.div(["style","margin:5px;"],s);HU.makeDialog({content:s,anchor:t,title:"Attributes",header:!0,sticky:!0,draggable:!0,modal:i});let o=jqid(r.domId("allsearch_corpus")).find("span"),a=jqid(r.domId("allsearch_corpus")).find(".wiki-searchheader");jqid(r.domId("allsearch")).focus(),jqid(r.domId("allsearch")).keyup((function(t){let e=$(this).val().trim().toLowerCase(),i={};o.each((function(){if(""==e)$(this).show();else{let t=$(this).attr("data-corpus");if(!t)return;t=t.toLowerCase(),t.indexOf(e)>=0?($(this).show(),i[$(this).attr("data-block-index")]=!0):$(this).hide()}})),""==e?a.show():a.each((function(){i[$(this).attr("data-block-index")]?$(this).show():$(this).hide()}))}))},handleMouseLeave:function(t){this.setInContext(!1)},extractEntryIds:function(t){let e=/([a-z0-9]+-[a-z0-9]{4}-[a-z0-9]{4}-[a-z0-9]{4}-[a-z0-9]+)(.*)/,i=[],r=t.match(e);for(;r&&3==r.length;)i.push(r[1]),r=r[2].match(e);return i},getEntryNames:function(t,e,i){let r=()=>{let i=ramaddaBaseUrl+"/entry/names?entryids="+Utils.join(t,",");this.getNamesPending=!0,$.getJSON(i,(t=>{this.getNamesPending=!1,e(t)}))};i?r():this.getNamesTimeout=setTimeout((()=>{r()}),1e3)},showEntryPopup:function(t){let e=HU.getUniqueId(""),i=HU.div(["id",e,"style",HU.css("display","inline-block")]);this.showMessage(i),this.showingEntryPopup=!0,this.handleEntriesPopup([t],e,"Shift-click to view:<br>")},setInContext:function(t,e,i,r){this.inContext=t;let s=this.getScroller();if(this.tagMarker&&this.editor.session.removeMarker(this.tagMarker),this.tagMarker=null,this.getNamesTimeout&&clearTimeout(this.getNamesTimeout),this.getNamesTimeout=null,r&&r.entryId)this.showEntryPopup(r.entryId);else if(!r||r.chunk){if(t){s.css("cursor","context-menu");let t="Right-click to show property menu";this.showMessage(t)}else s.css("cursor","text"),this.clearMessage(),this.lastTimeout&&clearTimeout(this.lastTimeout);this.lastTimeout=null}},handleMouseMove:function(t){this.lastTimeout&&clearTimeout(this.lastTimeout);let e=()=>{let e=this.getEditor().renderer.screenToTextCoordinates(t.x,t.y);if(!e)return;let i=this.getTagInfo(e);if(i){if(i.entryId&&this.showingEntryPopup)return;i.entryId=null,this.setInContext(!0,i.type,i.chunk,i)}else this.setInContext(!1)};this.inContext?e():this.lastTimeout=setTimeout(e,1e3)},getWikiAttributes:function(t,e){if(this.wikiAttributes[t.tag])return this.wikiAttributes[t.tag];let i=e=>(e||(e=[]),e=e.map((t=>t.p?(String(t.p).startsWith("#")&&(t.p=String(t.p).substring(1)),t):t)),this.wikiAttributes[t.tag+"_extra"]&&(e=Utils.mergeLists(e,this.wikiAttributes[t.tag+"_extra"])),e);if(!this.wikiAttributesFromServer){let r=RamaddaUtils.getUrl("/wikitags");return $.getJSON(r,(r=>{this.wikiAttributesFromServer=r,e(i(this.wikiAttributesFromServer[t.tag]))})),!1}return i(this.wikiAttributesFromServer[t.tag])},getDisplayAttributes:function(t){let e=null,i=[],r=null;if("plus"==t.type||t.tag&&"display"!=t.tag&&"group"!=t.tag)return{attrs:null,title:null,display:null};try{if(r=(new DisplayManager).createDisplay(t.type,{dummy:!0}),r&&(i=r.getWikiEditorTags(),r.getTypeLabel)){e=r.getTypeLabel(),null==e&&(e=Utils.makeLabel(t.type||"")),e+=" Properties";let i=r.getTypeHelpUrl();i&&(e=HU.href(i,e+SPACE+HU.getIconImage(icon_help),["target","_ramaddahelp"]))}}catch(e){console.log("Error getting attrs for:"+t.type+" error:"+e+" stack:"+e.stack)}return{attrs:i,title:e,display:r}},wikiInitDisplaysButton:function(){if(!window.globalDisplayTypes)return;let t=this.getId(),e=$("#displays_button"+t),i=window.globalDisplayTypes,r={},s=[];DISPLAY_CATEGORIES.forEach((t=>{r[t]=[],s.push(t)})),i.forEach((e=>{if(Utils.isDefined(e.forUser)&&!e.forUser)return;let i=e.category||CATEGORY_MISC;null==r[i]&&(r[i]=[],s.push(i));let o=e.tooltip??(e.label?HU.b(e.label):"");o=o.replace(/"/g,"&quot;");let a="WikiUtil.insertDisplayText('"+t+"','"+e.type+"')",n=HU.div(["data-category",i,"data-corpus",e.label+" "+o,CLASS,"wiki-editor-popup-link"],HU.href("#",e.label,[CLASS,"display-link ",TITLE,o,"onclick",a]));r[i].push(n)}));let o="",a="<table><tr valign=top>";for(let t=0;t<s.length;t++){let e=s[t],i=Utils.join(r[e],"<div>\n");o+=HU.div([ATTR_STYLE,"vertical-align:top;margin-right4px;display:inline-block;"],Utils.join(r[e],"")),a+=HU.td(["data-category",e,CLASS,"wiki-editor-display-category"],HU.div([STYLE,"margin-right:5px;"],HU.b(e))+"<div style='margin-right:5px;max-height:250px;overflow-y:auto;'>"+i)}a=HU.div([ID,"wiki-display-popup",STYLE,"font-size:10pt;width:800px;"],a),this.displaysText=o;let n=HU.span([ATTR_TITLE,"Expand",ATTR_CLASS,CLASS_CLICKABLE,ATTR_ID,this.domId("expandwikimenu")],HU.getIconImage("fas fa-maximize")),l=HU.center(HU.input("","",["placeholder","Search","id",this.domId("displaysearch"),"width","10"])+HU.space(2)+n),d=HU.div(["style","margin:10px;"],l+HU.div([ATTR_ID,this.domId("expandedwikimenu")])+HU.div([ATTR_ID,this.domId("unexpandedwikimenu")],a));e.click((()=>{this.wikiDisplayPopup&&this.wikiDisplayPopup.remove();let t=this.wikiDisplayPopup=HU.makeDialog({content:d,my:"left top",at:"left-200px bottom",title:"",anchor:e,draggable:!0,header:!0,initCall:()=>{$("#wiki-display-popup").tooltip({classes:{"ui-tooltip":"wiki-editor-tooltip"},content:function(){return $(this).prop(ATTR_TITLE)},show:{effect:"slide",delay:500,duration:400},position:{my:"left top",at:"right top"}})}});wikiPopup&&wikiPopup.hide(),t.tooltip();let i=!1,r=null;this.jq("expandwikimenu").click((()=>{if(!r){r="",t.find(".wiki-editor-display-category").each((function(){let t=$(this).attr("data-category"),e="<table style=' border-collapse:separate;border-spacing: 4px;'><tr valign=top>",i=0;$(this).find(".display-link").each((function(){let r=$(this).attr("onclick");i++,i>3&&(i=1,e+="</tr><tr valign=top>");let s=$(this).attr(ATTR_TITLE),o=HU.div(["onclick",r,ATTR_CLASS,CLASS_CLICKABLE,ATTR_STYLE,HU.css("display","inline-block")],s);e+=HU.td(["data-corpus",Utils.stringDefined(s)?s:"none","data-category",t,ATTR_CLASS,CLASS_HOVERABLE+" wiki-editor-popup-link","width","33%",ATTR_STYLE,HU.css("border","var(--basic-border)","margin","6px","padding","4px")],o)})),e+="</tr></table>",r+=HU.center(HU.div([ATTR_CLASS,"wiki-editor-display-category","data-category",t,ATTR_STYLE,HU.css("text-align","center","margin-top","10px","font-weight","bold")],t))+e})),r=HU.div([ATTR_STYLE,HU.css("margin","50px","width","500px")],r),r=HU.div([ATTR_STYLE,HU.css("max-height","500px","overflow-y","auto","min-width","700px","max-width","700px","overflow-x","auto")],r),$(r).appendTo(s.jq("expandedwikimenu")).find("img").attr("width","200")}i=!i,i?(s.jq("expandwikimenu").html(HU.getIconImage("fas fa-minimize")),s.jq("expandedwikimenu").show(),s.jq("unexpandedwikimenu").hide()):(s.jq("expandwikimenu").html(HU.getIconImage("fas fa-maximize")),s.jq("expandedwikimenu").hide(),s.jq("unexpandedwikimenu").show())}));let s=this;this.jq("displaysearch").focus(),this.jq("displaysearch").keyup((function(e){let i=$(this).val().trim().toLowerCase(),r={},s=t.find(".wiki-editor-popup-link"),o=t.find(".wiki-editor-display-category");s.each((function(){if(""==i)$(this).show();else{let t=$(this).attr("data-corpus");if(t||(t=$(this).attr(ATTR_TITLE)),!t)return void console.log("nc",$(this).html());t=t.toLowerCase(),t.indexOf(i)>=0?($(this).show(),r[$(this).attr("data-category")]=!0):$(this).hide()}})),""==i?o.show():o.each((function(){r[$(this).attr("data-category")]?$(this).show():$(this).hide()}))})),wikiPopup=t}))},setEditMode:function(t){let e=$("#"+this.id+"_toolbar_edit");if(this.editMode=t,!this.editMode)return e.find("i").css("color","#aaa"),void e.css("background","transparent");e.find("i").css("color","blue"),e.css("background","#aaa")},initTagSearch:function(){let t="";if(!this.formId)return;$("#"+this.formId).find(".wiki-menubar-tags").each((function(){""!=t&&(t+="<thin_hr>"),t+=HU.center(HU.b($(this).attr("data-title"))),t+=$(this).html()})),this.displaysText&&(t+="<thin_hr>"+HU.center(HU.b("Data Displays"))+this.displaysText),t=HU.center(HU.input("","",["placeholder","Find Tag","id",this.domId("tagsearch"),"style","margin-top:4px;","width","10"]))+t,t=HU.div([ATTR_STYLE,HU.css("width","600px","height","300px","max-height","300px","overflow-y","auto")],t);let e=this;this.toolbarEditButton=$("#"+this.id+"_toolbar_edit"),this.toolbarEditButton.click((()=>{this.setEditMode(!this.editMode)})),$("#"+this.id+"_toolbar_search").click((function(){this.tagSelectDialog&&this.tagSelectDialog.remove(),this.tagSelectDialog=HU.makeDialog({content:t,anchor:$(this),at:"left+300 bottom+40",title:"Tags",header:!0,draggable:!0}),e.jq("tagsearch").focus(),this.tagSelectDialog.find("a").tooltip({classes:{"ui-tooltip":"wiki-editor-tooltip"},content:function(){return $(this).prop(ATTR_TITLE)},show:{effect:"slide",delay:500,duration:400},position:{my:"left top",at:"right top"}}),this.tagSelectDialog.find(".wiki-editor-popup-category").css("display","none");let i=this.tagSelectDialog.find(".wiki-editor-popup-link");e.jq("tagsearch").keyup((function(t){let e=$(this).val().trim().toLowerCase();HU.doPageSearch(e,i)}))}))},initAttributes:function(){this.groupAttributes=[{label:"Collection Properties"},{p:"orderby",ex:"name,date,changedate,createdate,entryorder,size,number",tt:"sort type: name, date, change date, create date, etc"},{p:"ascending",ex:"true",tt:"direction of sort."},{label:"Specify entries",p:"entries",ex:'"entryid1,entryid2,entryid3.."',tt:"comma separated list of entry ids to use"},{label:"Specify entries by search",p:"entries",ex:"search:type:<some type>;orderby:date;ascending:false",tt:"comma separated list of entry ids to use"},{p:"entries.filter",ex:"file|folder|image|type:some type|geo|name:name pattern|suffix:file suffixes",tt:"allows you to select what entries to use"},{p:"exclude",ex:"entryid1,entryid2,entryid3..",tt:"comma separated list of entry ids to not use"},{p:"first",ex:"entryid1,entryid2,entryid3..",tt:"comma separated list of entry ids to use first"},{p:"last",ex:"entryid1,entryid2,entryid3..",tt:"comma separated list of entry ids to use last"},{p:"max",ex:"number of entries to use",tt:"max number of entries to use"},{p:"ignoreRequestOrderBy",ex:"true",tt:"If showing multiple lists in one page this keeps one list sort from affecting this list sort"}],this.wikiAttributesFromServer=null;let t=Utils.mergeLists([{label:"Table Tree"},{p:"simple",ex:!0},{p:"columns",ex:"name,date,createdate,creator,download,size,type,attachments"},{p:"showHeader",ex:!1},{p:"showDate",ex:!1},{p:"showTime",ex:!0},{p:"showCreateDate",ex:!1},{p:"showSize",ex:!1},{p:"showDownload",ex:!1},{p:"showCreator",ex:!0},{p:"showType",ex:!1},{p:"showAttachments",ex:"true"},{p:"showIcon",ex:!1},{p:"showThumbnails",ex:!1},{p:"showArrow",ex:!1},{p:"showForm",ex:!1},{p:"textStyle",tt:"Style for the text in the table"},{p:"textClass"},{p:"formOpen",ex:!0,tt:"Show the Apply action form by default"},{p:"showCrumbs",ex:!0},{p:"nameWidth",ex:"120"},{p:"dateWidth",ex:"120"},{p:"sizeWidth",ex:"120"},{p:"typeWidth",ex:"120"},{p:"attachmentsWidth",ex:"120"},{p:"metadataDisplay",ex:"archive_note:attr1=Arrangement:template=<b>{attr1}_colon_</b> {attr2}",tt:"Add metadata under the name. e.g.: type1:template={attr1},type2:attr1=Value:template={attr1}_colon_ {attr2}"},{p:"message",ex:""},{p:"treePrefix",ex:""},{p:"addPageSearch",d:!0,tt:"Add the page search form"},{p:"chunkSize",ex:"10",tt:"break up the list of entries into chunkSize lists and display each list"},{p:"numChunks",ex:"2",tt:"how many entry chunks"},{p:"chunkColumns",ex:"2",tt:'how many columns use "numChunks" to match number of chunks'},{p:"chunkStyle",ex:"margin:10px;",tt:"chunk style"}],this.groupAttributes);this.wikiAttributes={tree:t,tabletree:t,gallery_extra:this.groupAttributes,links:Utils.mergeLists([{label:"Links Properties"},{p:"info",ex:"List children entries"},{p:"showIcon",ex:"false"},{p:"showDescription",ex:"true"},{p:"showSnippet",ex:"true"},{p:"linkresource",ex:"true",tt:"Link to the resource"},{p:"linksBefore",ex:"url1;label1,url2;label2"},{p:"linksAfter",ex:"url1;label1,url2;label2"},{p:"separator",ex:"",tt:"Separator between links"},{p:"horizontal",ex:"true",tt:"Display horizontallly"},{p:"output",ex:"",tt:"Link to output"},{p:"target",ex:"_target",tt:"link target"},{p:"tagopen",ex:"html before link"},{p:"tagclose",ex:"html after link"},{p:"linksBefore",ex:'"url;label,url;label"'},{p:"linksAfter",ex:'"url;label,url;label"'},{p:"innerClass",ex:""},{p:ATTR_CLASS,ex:"",tt:"link css class"},{p:"style",ex:"",tt:"link style"},{p:"chunkSize",ex:"10",tt:"break up the list of entries into chunkSize lists and display each list"},{p:"numChunks",ex:"2",tt:"how many entry chunks"},{p:"chunkColumns",ex:"2",tt:'how many columns use "numChunks" to match number of chunks'},{p:"chunkStyle",ex:"margin:10px;",tt:"chunk style"}],this.groupAttributes),section:[{label:"Section Properties"},{p:"title",ex:'"{{name}}"'},{p:"subTitle",ex:'""'},{p:"style",ex:'""'},{p:"titleStyle",ex:'""'},{p:"----",tt:"Add a line"},{p:"#",tt:"Colored sections"}],row:[{label:"Row Properties"},{p:"tight",ex:"true",tt:"Layout rows with no space"}],list:Utils.mergeLists([{label:"List Properties"},{p:"info",ex:":List children entries"},{p:"showIcon",ex:"false"},{p:"showDescription",ex:"true"},{p:"showSnippet",ex:"true"},{p:"linkresource",ex:"true",tt:"Link to the resource"},{p:"separator",ex:"",tt:"Separator between links"},{p:"output",ex:"",tt:"Link to output"},{p:"tagopen",ex:"",tt:"html before link"},{p:"tagclose",ex:"",tt:"html after link"},{p:"innerClass",ex:""},{p:ATTR_CLASS,ex:"",tt:"link css class"},{p:"style",ex:"",tt:"link style"},{p:"chunkSize",ex:"10",tt:"break up the list of entries into chunkSize lists and display each list"},{p:"numChunks",ex:"2",tt:"how many entry chunks"},{p:"chunkColumns",ex:"2",tt:'how many columns use "numChunks" to match number of chunks'},{p:"chunkStyle",ex:"margin:10px;",tt:"chunk style"}],this.groupAttributes),information:[{label:"Information Properties"},{p:"info",ex:"Show entry information"},{p:"showTitle",ex:"true"},{p:"showResource",ex:"true"},{p:"showBase",ex:"true"},{p:"showDetails",ex:"true"}],description:[{label:"Description Properties"},{p:"wikify",ex:"true"},{p:"prefix",ex:""},{p:"suffix",ex:""},{p:"convert",ex:"_newline=true"}],resource:[{label:"Resource Properties"},{p:"info",ex:"",tt:"Link to the resource"},{p:"title",ex:""},{p:"includeIcon",ex:"true"},{p:"url",ex:"true",tt:"Just include the URL"},{p:"message",ex:"",tt:"Message to show when no resource"}],link:[{label:"Link Properties"},{p:"info",ex:"Link to the entry"},{p:"linkresource",ex:"true",tt:"Link to the resource"},{p:"button",ex:"true",tt:"Make a button"},{p:"title",ex:"",tt:"Title to use"},{p:"output",ex:"output type",tt:"Link to the given output"}],daterange:[{label:"Date Range Properties"},{p:"format",ex:"yyyy-MM-dd HH:mm:ss Z"},{p:"separator",ex:""}],html:[{label:"HTML Properties"},{p:"info",ex:"true",tt:"Include the HTML of the entry"},{p:"children",ex:"true",tt:"Include HTML of children entries"},{p:"showTitle",ex:"false"}],map:[{label:"Map Properties"},{p:"icon",ex:"#/icons/dots/green.png"},{p:"width",ex:"100%"},{p:"height",ex:"400"},{p:"listEntries",ex:"true"},{p:"listInMap",ex:"true"},{p:"showCheckbox",ex:"true"},{p:"listHeader"},{p:"listWidth",ex:"300px"},{p:"listIconSize",ex:"24px"},{p:"skipEntries",ex:!0,tt:"Dont show the entries"},{p:"marker1",ex:"latitude:40,longitude:-105,color:red,radius:4,text:Some text",tt:"Can do marker1 ... markerN"},{p:"credits",tt:"Text to show at the bottom of the map"},{p:"hideIfNoLocations",tt:"Don't show map if no georeferenced data"},{p:"details",ex:"false"},{p:"showLines",ex:"true"},{p:"showCircles",ex:"true"},{p:"azimuthLength",tt:"km",d:"1.0"},{p:"azimuthColor",ex:"red"},{p:"azimuthWidth",ex:"2"},{p:"showBounds",ex:"false"},{p:"showMarkers",ex:"false"},{p:"showCameraDirection",ex:"false"},{p:"showLocationSearch",ex:"true"},{p:"showSearch",ex:"false"},{p:"showLayerToggle",ex:"true"},{p:"showLatLonLines",ex:"true"},{p:"showScaleLine",ex:"true"},{p:"showLayerSwitcher",ex:"true"},{p:"showLatLonPosition",ex:"true"},{p:"showZoomPanControl",ex:"true"},{p:"showZoomOnlyControl",ex:"true"},{p:"showBookmarks",ex:"true"},{p:"showBounds",ex:"true"},{p:"showOpacitySlider",ex:"true"},{p:"useThumbnail",ex:"true"},{p:"iconSize",ex:"32"},{p:"iconWidth",ex:"32"},{p:"iconHeight",ex:"32"},{p:"layerStrokeColor",ex:"red"},{p:"layerStrokeWidth",ex:"2"},{p:"layerFillColor",ex:"red"},{p:"layerFillOpacity",ex:"0.5"},{p:"rules",ex:"attr1:== or != or &lt; or &gt; or  ~ (like):value:fillColor:red:strokeColor:black;attr2:",tt:"Specify style rules based on feature properties"},{p:"pointRadius",ex:""},{p:"strokeColor",ex:""},{p:"strokeWidth",ex:""},{p:"fillOpacity",ex:""},{p:"fillColor",ex:""},{p:"layerStrokeColor",ex:""},{p:"layerStrokeWith",ex:""},{p:"layerFillColor",ex:""},{p:"layerFillOpacity",ex:""},{p:"highlightStrokeColor",ex:""},{p:"highlightFillColor",ex:""},{p:"highlightStrokeWidth",ex:""},{p:"highlightFillOpacity",ex:""},{p:"zoomToLayer",tt:"Zoom to the layer extent on load",ex:"false"},{p:"popupWidth",ex:"200"},{p:"popupHeight",ex:"200"},{p:"doPopupSlider",ex:"true"},{p:"popupSliderRight",ex:"true"},{p:"enableDragPan",ex:"false"},{p:"addMarkerOnClick",ex:"true"},{p:"markerIcon",ex:"/repository/icons/map/marker-blue.png"},{p:"linked",ex:"true"},{p:"linkMouse",ex:"true"},{p:"linkGroup",ex:"some name"},{p:"layer",ex:"osm|esri.topo|google.roads|google.hybrid|esri.street|opentopo|usfs|caltopo.mapbuilder|usgs.topo|google.terrain|google.satellite|naip|usgs.imagery|esri.shaded|esri.lightgray|esri.darkgray|esri.terrain|shadedrelief|publiclands|historic|esri.aeronautical|osm.toner|osm.toner.lite|cartolight|watercolor|lightblue|blue|white|black|gray"},{p:"iconsonly",ex:"false"}],name:[{label:"Name Properties"},{p:"link",ex:"true",tt:"Link to the entry"}],property:[{label:"Property Properties"},{p:"name",ex:""},{p:"value",ex:""}],group:Utils.mergeLists([{label:"Group Properties"},{p:"showMenu",ex:"true"},{p:"showTitle",ex:"true"},{p:"layoutType",ex:"table|flextable|tabs|columns|rows"},{p:"layoutColumns",ex:"1"},{p:"divid",ex:"",tt:"Specify a div id to write displays into"}]),tabs:Utils.mergeLists([{label:"Tabs Properties"},{p:"tag",ex:"html"},{p:"tabsStyle",ex:"min|center|minarrow"},{p:"showLink",ex:"false"},{p:"includeIcon",ex:"true"},{p:"textposition",ex:"top|left|right|bottom"}],this.groupAttributes),grid:Utils.mergeLists([{label:"Grid Properties"},{p:"tag",ex:"card"},{p:"width",ex:"300"},{p:"inner-height",ex:"100"},{p:"showIcon",ex:"true"},{p:"weights",ex:"4,4,4"},{p:"showSnippet",ex:"false"},{p:"showSnippetHover",ex:"true"},{p:"showLink",ex:"false"},{p:"showHeading",ex:"true"},{p:"showLine",ex:"true"},{p:"showSnippetHover",ex:"true"},{p:"showPlaceholderImage",ex:"true",tt:"Show placeholder image"},{p:"addTags",ex:"true"},{p:"tagTypes",ex:"content.keyword"},{p:"addPageSearch",d:!0,tt:"Add the page search form"},{p:"captionPrefix",ex:"Click to view example: ",tt:"To use for popup images"}],this.groupAttributes),frames:Utils.mergeLists([{label:"Frames Properties"},{p:"width",ex:"400"},{p:"height",ex:"400"},{p:"showIcon",ex:"false"},{p:"leftWidth",ex:"2"},{p:"template",ex:"page template or default"},{p:"rightWidth",ex:"10"},{p:"noTemplate",ex:"true",tt:"Don't use the page template in the frame"}],this.groupAttributes),accordian:Utils.mergeLists([{label:"Accordian Properties"},{p:"tag",ex:"html"},{p:"collapse",ex:"false"},{p:"border",ex:"0"},{p:"showLink",ex:"true"},{p:"includeIcon",ex:"false"},{p:"textposition",ex:"left"}],this.groupAttributes),table:Utils.mergeLists([{label:"Table Properties"},{p:"showEntryDetails",ex:"false"},{p:"columns",ex:"name,file,createdate,changedate,fromdate,todate,#entryField1,#entryField2"},{p:"tableOrdering",ex:"true"},{p:"showAllTypes",ex:"true"},{p:"showCategories",ex:"true"},{p:"showDate",ex:"true"},{p:"showCreateDate",ex:"true"},{p:"showChangeDate",ex:"true"},{p:"showColumns",ex:"false"},{p:"show&lt;column name&gt",ex:"false",tt:"show or hide the given column"},{p:"nameLabel",tt:"Override the name label"}],this.groupAttributes),recent:Utils.mergeLists([{label:"Recent Properties"},{p:"info",ex:"",tt:"List N days recent entries by day"},{p:"days",ex:"num days"}],this.groupAttributes),multi:[{label:"Multi Properties"},{info:"Create multiple wiki tags"},{p:"_tag",ex:"tag to create"},{p:"_template",ex:"",tt:"wiki text template. Escape { and } with backslash"},{p:"_entries",ex:"entries",tt:"entries to apply to"},{p:"_headers",ex:"comma separated headers"},{p:"_headerTemplate",ex:":heading {{name link=true}}"},{p:"_columns",ex:"number of columns"},{p:"_width",ex:"200",tt:"Set the width and flow the blocks"},{p:"_style",ex:"padding:10px;",tt:"Style for each block"},{p:"first",ex:".&lt;some attribute&gt;='attr for first tag'"},{p:"last",ex:".&lt;some attribute&gt;='attr for last tag'"},{p:"notlast",ex:".&lt;some attribute&gt;='attr for first N tags'"},{p:"notfirst",ex:".&lt;some attribute&gt;='attr for last N tags'"}],menu:[{label:"Menu Properties"},{p:"menus",ex:"file,edit,view,feeds,other"},{p:"popup",ex:"true"},{p:"breadcrumbs",ex:"true"}]}}},Transcriber.prototype={jq:function(t){return this.container.jq(t)},domId:function(t){return this.container.domId(t)},appendText:function(t){this.container.handleTranscribeText(t)},getAnchor:function(){return this.container.getTranscribeAnchor()},transcribeStart:function(){this.transcribePlaying=!0,this.mediaRecorder.start(),this.transcribeStartTime=new Date,this.jq("transcribe_play").html(HU.getIconImage("fa-solid fa-stop fa-gray"));let t=()=>{let e=(new Date).getTime()-this.transcribeStartTime.getTime(),i=parseInt((this.transcribeElapsedTime+e)/1e3);this.jq("transcribe_label").html(i+" seconds"),this.transcribeMonitor=setTimeout(t,500)};this.transcribeMonitor=setTimeout(t,500)},transcribeStop:function(){if(this.transcribePlaying=!1,this.transcribeStartTime){let t=(new Date).getTime()-this.transcribeStartTime.getTime();this.transcribeElapsedTime+=t}try{this.mediaRecorder.stop()}catch(t){}this.transcribeMonitor&&clearTimeout(this.transcribeMonitor),this.jq("transcribe_play").html(HU.getIconImage("fa-solid fa-microphone fa-gray"))},transcribeClear:function(){this.audioChunks=[],this.transcribeMonitor&&clearTimeout(this.transcribeMonitor),this.transcribeElapsedTime=0;try{this.mediaRecorder.stop()}catch(t){}},transcribeDoIt:function(){if(this.callDoIt=!1,!this.audioChunks||0==this.audioChunks.length)return void alert("No audio has been captured");let t=new Blob(this.audioChunks,{type:this.transcribeMime}),e=(new FormData,RamaddaUtils.getUrl("/llm/transcribe")),i=new FormData;this.jq("transcribe_loading").show(),i.append("mimetype",this.transcribeMime),i.append("audio-file",t),i.append("entryid",this.entryId),this.jq("transcribe_sendtochat").is(":checked")&&i.append("sendtochat","true"),this.jq("transcribe_addfile").is(":checked")&&i.append("addfile","true"),$.ajax({url:e,data:i,cache:!1,contentType:!1,processData:!1,method:"POST",type:"POST",success:t=>{this.jq("transcribe_loading").hide(),this.transcribeClear(),this.jq("transcribe_label").html("0 seconds");let e=t.results??t.error;Utils.stringDefined(e)||(e="No results"),this.jq("transcribe_text").val(e)},error:t=>{this.jq("transcribe_loading").hide(),alert("transcription failed"),console.log(t)}})},doTranscribe:function(){navigator.mediaDevices&&navigator.mediaDevices.getUserMedia?navigator.mediaDevices.getUserMedia({audio:!0}).then((t=>{if(this.transcribeMime=["audio/mp3","audio/mp4","audio/wav","audio/webm","audio/mpeg"].filter(MediaRecorder.isTypeSupported)[0],!this.transcribeMime)return void alert("No audio formats available");this.mediaRecorder=new MediaRecorder(t,{mimeType:this.transcribeMime}),this.mediaRecorder.addEventListener("dataavailable",(t=>{this.audioChunks.push(t.data)})),this.mediaRecorder.addEventListener("stop",(()=>{this.callDoIt&&this.transcribeDoIt()}));let e="",i=HU.hbox([HU.span([ATTR_TITLE,"Start recording",ATTR_CLASS,CLASS_CLICKABLE,"id",this.domId("transcribe_play")],HU.getIconImage("fa-solid fa-microphone fa-gray")),HU.span([ATTR_TITLE,"Transcribe recording",ATTR_CLASS,CLASS_CLICKABLE,"id",this.domId("transcribe_pen")],HU.getIconImage("fa-solid fa-pen fa-gray")),HU.b(" Time: ")+HU.div(["style",HU.css("display","inline-block","text-align","right","width","150px","xborder","var(--basic-border)"),"id",this.domId("transcribe_label")],"0 seconds"),HU.span([ATTR_TITLE,"Delete recording",ATTR_CLASS,CLASS_CLICKABLE,"id",this.domId("transcribe_delete")],HU.getIconImage("fa-solid fa-delete-left fa-gray"))],HU.css("margin-right","5px")),r=HU.checkbox("",["id",this.domId("transcribe_sendtochat"),ATTR_TITLE,"Send to LLM"],!1,"Send to LLM");r+=SPACE2,r+=HU.checkbox(this.domId("transcribe_addfile"),["id",this.domId("transcribe_addfile"),ATTR_TITLE,"Add audio file as entry"],!1,"Add file"),this.opts.addExtra?e+=HU.leftRightTable(i,r):e=i,e+=HU.div(["style","position:relative;"],HU.textarea("","",["placeholder","","id",this.domId("transcribe_text"),"rows",6,"cols",80,"style","border:var(--basic-border);padding:4px;margin:4px;font-style:italic;"])+HU.div(["style","display:none;position:absolute;top: 50%; left: 50%; -ms-transform: translate(-50%, -50%); transform: translate(-50%, -50%);","id",this.domId("transcribe_loading")],HU.image(RamaddaUtil.getCdnUrl("/icons/mapprogress.gif"),["style","width:100px;"]))),e+=HU.buttons([HU.span([ATTR_CLASS,CLASS_DIALOG_BUTTON,"append","true"],this.opts.appendLabel),HU.span([ATTR_CLASS,CLASS_DIALOG_BUTTON,ID,this.domId("cancel")],"Cancel")]),e=HU.div([ATTR_CLASS,CLASS_DIALOG],e);let s=()=>{this.transcribeClear()},o=this.transcribeDialog=HU.makeDialog({content:e,anchor:this.getAnchor(),my:"left bottom",at:"left+200 top-50",title:"Transcribe",callback:s,header:!0,sticky:!0,draggable:!0,modal:!1});this.transcribeElapsedTime=0,this.jq("transcribe_pen").click((()=>{this.transcribePlaying?(this.callDoIt=!0,this.transcribeStop()):this.transcribeDoIt()})),this.jq("transcribe_play").click((()=>{this.transcribePlaying?this.transcribeStop():this.transcribeStart()})),this.jq("transcribe_delete").click((()=>{this.jq("transcribe_text").val(""),this.transcribeStop(),this.transcribeClear(),this.jq("transcribe_label").html("0 seconds")}));let a=this;o.find(".ramadda-dialog-button").button().click((function(){let t=a.jq("transcribe_text").val()??"";$(this).attr("append")?a.appendText(t):(o.remove(),s())}))})).catch((t=>{alert(`Error initializing transcription: ${t}`)})):alert("media recording not supported")}};
