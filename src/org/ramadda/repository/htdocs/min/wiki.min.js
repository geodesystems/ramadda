var wikiPopup=null;function insertDisplayText(e,t){let i=window.globalDisplayTypesMap[t];if(!i)return void insertText(t);let s="{{";"group"==i.type?s+="group ":s+="display_"+i.type+" ",i.wiki&&(s+=i.wiki),s+="}} ",wikiPopup&&wikiPopup.hide(),insertText(e,s)}function insertText(e,t){HtmlUtils.hidePopupObject();var i=HtmlUtils.getTooltip();i&&i.hide();var s=getHandler(e);if(s)s.insertText(t);else{var o=HtmlUtils.getWikiEditor(e);if(o)o.insertAtCursor(t);else{var r=GuiUtils.getDomObject(e);r&&insertAtCursor(e,r.obj,t)}}}function insertAtCursor(e,t,i){var s=HtmlUtils.getWikiEditor(e);if(i.entryId&&s)s.handleEntryLink(i.entryId,i.name,null,!1,i);else if(i=Utils.decodeText(i),s)s.insertAtCursor(i);else{var o=t.scrollTop;if(document.selection)t.focus(),sel=document.selection.createRange(),sel.text=i;else if(t.selectionStart||"0"==t.selectionStart){var r=t.selectionStart,l=t.selectionEnd;t.value=t.value.substring(0,r)+i+t.value.substring(l,t.value.length);let e=r+i.length;t.selectionEnd=e}else t.value+=i;t.scrollTop=o}}function insertTags(e,t,i,s){HtmlUtils.hidePopupObject();var o=getHandler(e);if(o)return void o.insertTags(t,i,s);let r=HtmlUtils.getWikiEditor(e);r?r.insertTags(t,i,s):console.log("Could not find editor:"+e)}function insertTagsInner(e,t,i,s,o){var r;i=Utils.decodeText(i),s=Utils.decodeText(s);var l=HtmlUtils.getWikiEditor(e);if(l){var n=i+s+" ",a=(l=l.getEditor()).getCursorPosition();return l.insert(n),i.endsWith("\n")?(a.row++,a.column=0):a.column+=i.length,l.selection.moveTo(a.row,a.column),void l.focus()}if(t.selectionStart||"0"==t.selectionStart){var p=t.scrollTop;t.focus();var h=t.selectionStart,d=t.selectionEnd;return r=t.value.substring(h,d),t.value=t.value.substring(0,h)+i+r+s+t.value.substring(d,t.value.length),t.selectionStart=h+i.length+r.length+s.length,t.selectionEnd=t.selectionStart-s.length,void(t.scrollTop=p)}if(document.selection&&document.selection.createRange){if(document.documentElement&&document.documentElement.scrollTop)var u=document.documentElement.scrollTop;else if(document.body)u=document.body.scrollTop;t.focus();var c=document.selection.createRange();r=c.text,c.text=i+r+s,c.select&&c.select(),document.documentElement&&document.documentElement.scrollTop?document.documentElement.scrollTop=u:document.body&&(document.body.scrollTop=u)}}function WikiEditor(e,t,i,s,o){this.entryId=e,this.ID_WIKI_PREVIEW="preview",this.ID_WIKI_PREVIEW_INNER="preview_inner",this.ID_WIKI_PREVIEW_LIVE="preview_live",this.ID_WIKI_PREVIEW_CONTENTS="preview_contents",this.ID_WIKI_PREVIEW_OPEN="preview_open",this.ID_WIKI_PREVIEW_CLOSE="preview_close",this.ID_WIKI_PREVIEW_WORDCOUNT="preview_wordcount",this.ID_WIKI_PREVIEW_COPY="preview_copy",this.ID_WIKI_PREVIEW_DOWNLOAD="preview_download",this.ID_WIKI_MESSAGE="message",this.ID_WIKI_MENUBAR="menubar",this.ID_WIKI_POPUP_EDITOR="wiki-popup-editor",this.ID_WIKI_POPUP_OK="wiki-popup-ok",this.ID_WIKI_POPUP_CANCEL="wiki-popup-cancel",this.ID_WIKI_POPUP_TIDY="wiki-popup-tidy",this.ID_WIKI_POPUP_COMPACT="wiki-popup-compact",this.initAttributes();var r={autoScrollEditorIntoView:!0,copyWithEmptySelection:!0};o&&$.extend(r,o),$.extend(this,{id:i,editor:ace.edit(i),formId:t,hidden:s}),this.myDiv=$("#"+this.getId()),HU.addWikiEditor(this),Utils.initDragAndDrop(this.getDiv(),(e=>{let t=this.lastPosition=this.getEditor().renderer.screenToTextCoordinates(e.clientX,e.clientY),i=new(0,ace.require("ace/range").Range)(t.row,t.column,t.row,t.column+5);this.dragMarker&&this.editor.session.removeMarker(this.dragMarker),this.dragMarker=this.getEditor().session.addMarker(i,"ace_active_char","text",!1)}),(e=>{this.clearDragAndDrop()}),((e,t,i,s)=>{this.clearDragAndDrop(),s||(this.lastPosition=this.getEditor().getCursorPosition()),Ramadda.handleDropEvent(e,t,i,this.entryId,((e,t,i,s)=>{this.handleEntryLink(t,i,this.lastPosition,!0,{isImage:s})}))})),this.editor.setBehavioursEnabled(!1),this.editor.setDisplayIndentGuides(!1),this.editor.setKeyboardHandler("emacs"),this.editor.setShowPrintMargin(!1),this.editor.getSession().setUseWrapMode(!0),this.editor.setOptions(r),this.editor.session.setMode("ace/mode/ramadda"),this.toolbar=$("#"+this.getId()+"_toolbar"),this.editor.container.addEventListener("contextmenu",(e=>{e.preventDefault(),this.handlePopupMenu(e)})),this.editor.container.addEventListener("mousedown",(e=>{})),this.editor.container.addEventListener("mouseup",(e=>{this.handleMouseUp(e)})),this.editor.container.addEventListener("mouseleave",(e=>{this.handleMouseLeave(e)})),this.editor.container.addEventListener("mousemove",(e=>{this.handleMouseMove(e)})),this.editor.getSession().on("change",(e=>{if(this.previewShown&&this.previewLive){if(this.previewPending)return;this.previewPending=setTimeout((()=>{this.previewPending=null,this.doPreview(this.entryId,!0)}),100)}})),this.getBlock().find("#"+this.id).append(HU.div([STYLE,HU.css("display","none"),CLASS,"wiki-editor-message",ID,this.domId(this.ID_WIKI_MESSAGE)])),this.wikiInitDisplaysButton(),this.jq("previewbutton").click((()=>{HtmlUtils.hidePopupObject(),this.doPreview(this.entryId)})),this.jq("color").click((e=>{HtmlUtils.hidePopupObject(),this.doColor(e)})),this.jq("wordcount").click((()=>{HtmlUtils.hidePopupObject(),this.doWordcount()}))}function getWikiEditorMenuBlocks(e,t,i){let s=[],o=null,r=e=>{s.push(o={index:s.length,title:e,items:[]})},l="ramadda-menu-item "+(t?" ramadda-hoverable ramadda-highlightable ":"");return e.forEach((e=>{(e=>{if(e.inline||e.inlineLabel)return void r(e.inline||e.inlineLabel);if(e.label&&!e.p)return void r(e.label);if(e.info)return void o.items.push(HU.div([CLASS,l],"<i>"+e.info+"</i>"));if(!e.p)return void console.log("Unknown arg:"+JSON.stringify(e));let t=e.label||e.p,s="";if(s=Utils.isDefined(e.ex)?String(e.ex):Utils.isDefined(e.d)?String(e.d):"",s=s.trim(),(s.indexOf(" ")>=0||""==s)&&(s='"'+s+'"'),s=" "+e.p+"="+s+" ",s=s.replace(/\"/g,"&quot;"),o){let r=t+" "+(e.tt??"");i&&(t=HtmlUtils.onClick("insertText('"+i+"','"+s+"')",t)),o.items.push(HU.div(["data-block-index",o.index,"data-corpus",r,CLASS,l,TITLE,e.tt||"","data-attribute",s],t))}else console.log("no attribute block")})(e)})),s}function getWikiEditorMenuBar(e,t,i){let s="";return s+=HU.tag(TAG_LI,[],HU.div(["id","searchattributes",CLASS,"wiki-popup-menu-header ramadda-clickable","title","Search attributes"],HU.getIconImage("fa-binoculars"))),e.forEach(((e,t)=>{if("string"==typeof e)return;let o=e.title;if(i&&o.toLowerCase().startsWith(i)){let e=Utils.makeLabel(o.substring(i.length).trim());""!=e&&(o=e)}if(0==e.items.length)return;let r=Utils.wrap(e.items,"<li>","");s+=HU.tag(TAG_LI,[],HU.div([CLASS,"wiki-popup-menu-header"],o)+HU.tag("ul",[CLASS,"wiki-popup-menu-item"],r))})),HU.div([CLASS,"wiki-popup-menubar",ATTR_ID,t],HU.tag("ul",[ATTR_ID,t+"_inner",ATTR_CLASS,"sf-menu"],s))}WikiEditor.prototype={getId:function(){return this.id},domId:function(e){return this.getId()+"_"+e},handleEntryLink:function(e,t,i,s,o){let r=HU.center(HU.b(t));r+=s?"The new entry has been added. What do you want to insert into the document?<br>":"What do you want to insert into the document?<br>";let l=[];s?(o.isImage&&l.push("Image"),l.push("Link"),l.push("ID"),l.push("entry=ID"),l.push("Nothing")):(l.push("Link"),o.isImage&&l.push("Image"),o.isGeo&&l.push("Map"),"geo_editable_json"==o.entryType&&l.push("Editable map"),o.isGroup&&(l.push("Tree"),l.push("Grid"),l.push("Gallery")),l.push("Import"),l.push("ID"),l.push("entry=ID")),r+=HU.select("",[ATTR_ID,this.domId("addtype")],l,this.lastWhat),r+="<p>",r+=HU.div([STYLE,HU.css("display","inline-block"),CLASS,"ramadda-button",ID,this.domId("addok")],"OK")+SPACE3+HU.div([STYLE,HU.css("display","inline-block"),CLASS,"ramadda-button",ID,this.domId("addcancel")],"Cancel"),r=HU.div([STYLE,HU.css("padding","10px","width","400px")],r);let n=this.addDialog=HU.makeDialog({content:r,anchor:this.getScroller(),title:"New Entry",header:!0,sticky:!0,draggable:!0,modal:!0,xmodalContentsCss:HU.css("left","50px")}),a=n.find("#"+this.domId("addtype"));HU.initSelect(a),n.find("#"+this.domId("addcancel")).button().click((()=>{this.addDialog.remove()})),n.find("#"+this.domId("addok")).button().click((()=>{this.addDialog.remove();let s=this.lastWhat=a.val(),o="";if("Image"==s)o="{{image entry="+e+' caption="'+t+'" bordercolor="#ccc" align=center width=75% }} ';else if("Map"==s)o="{{map entry="+e+" details=true}}";else if("Editable map"==s)o="{{editable_map entry="+e+" }}";else if("Tree"==s)o="{{tabletree entry="+e+" }}";else if("ID"==s)o=e;else if("entry=ID"==s)o=" entry="+e+" ";else if("Gallery"==s)o="{{gallery entry="+e+" }}";else if("Import"==s)o="{{import entry="+e+" }}";else if("Grid"==s)o="{{grid entry="+e+" }}";else if("Link"==s)o="[["+e+"|"+t+"]] ";else{if("Nothing"==s)return;o=" {{"+s.toLowerCase()+" entry="+e+" }}"}i?this.getEditor().session.insert(i,o):this.insertAtCursor(o)}))},clearDragAndDrop:function(){this.dragMarker&&this.getEditor().session.removeMarker(this.dragMarker)},getDiv:function(){return this.myDiv},jq:function(e){return $("#"+this.domId(e))},showMessage:function(e){this.jq(this.ID_WIKI_MESSAGE).css("display","block").html(e)},clearMessage:function(e){this.jq(this.ID_WIKI_MESSAGE).css("display","none")},getEditor:function(){return this.editor},getValue:function(){return this.getEditor().getValue()},getBlock:function(){return $("#"+this.getId()+"_block")},getScroller:function(){return this.getBlock().find(".ace_scroller")},getSession:function(){return this.getEditor().session},insertAtCursor:function(e){if(e=Utils.decodeText(e),this.popupShowing){let t=this.jq(this.ID_WIKI_POPUP_EDITOR)[0];if(t)return insertAtCursor(null,t,e),t.focus(),this.jq(this.ID_WIKI_MENUBAR).find(".wiki-popup-menu-item").css("display","none"),void setTimeout((()=>{this.jq(this.ID_WIKI_MENUBAR).find(".wiki-popup-menu-item").removeAttr("style")}),1e3)}this.getEditor().getCursorPosition();this.getEditor().insert(e),this.getEditor().focus()},insertTags:function(e,t,i){var s=(e=Utils.decodeText(e))+(t=Utils.decodeText(t))+" ",o=this.getEditor().getCursorPosition();this.getEditor().insert(s),e.endsWith("\n")?(o.row++,o.column=0):o.column+=e.length,this.getEditor().selection.moveTo(o.row,o.column),this.getEditor().focus()},getTagInfo:function(e){e=e||this.getEditor().getCursorPosition();let t=this.getSession().doc.positionToIndex(e),i=this.getEditor().getValue(),s=t,o=-1,r=-1,l=!1;for(;s>=0;){if("{"!=i[s])l=!1,s--;else{if(l){o=s;break}l=!0,s--}}if(o>=0)for(l=!1,s=o;s<i.length;)if("}"!=i[s])s++,l=!1;else{if(l){r=s;break}l=!0,s++}if(t>=o&&t<=r&&o>=0&&r>=o){let e,t=i.substring(o,r+1),s=t.match(/\{\{ *([^ \n\}]+)/);if(s&&s.length>1&&(e=s[1]),e){let i="",l=t.trim().substring(2),n=l.indexOf(" "),a=l.indexOf("}}");l=-1!=n&&n<a?l.substring(n).trim():l.substring(a).trim(),l.endsWith("}}")&&(l=l.replace(/}}$/,"")),"group"==e?(i="group",e="display"):e.startsWith("display_")?(i=e.substring(8),e="display"):(s=t.match(/type *= *\"([^\"]+)\"?/),s&&s.length>1&&(i=s[1]));let p=0,h=this.getSession().doc.getAllLines(),d=0,u=-1,c=-1,g=-1,m=-1,I=o+1,f=r+1;h.every((e=>{let t=p+e.length+1;return-1==u&&t>=I&&(u=d,g=I-p-1),-1!=u&&-1==c&&t>=f?(c=d,m=f-p,!1):(d++,p=t,!0)}));let x={start:{row:u,column:g},end:{row:c,column:m}};return x=new(0,ace.require("ace/range").Range)(u,g,c,m),{range:x,tag:e,type:i,left:o,right:r,chunk:t,attrs:l}}}let n=t;for("\n"==i[n]&&n--;n>=0&&"\n"!==i[n];)n--;if(n<0&&"+"==i[n+1]&&(n=0),n>=0){let t=i.substring(n).trim();if(t.startsWith("+")){let i=t.indexOf("\n");i>=0&&(t=t.substring(0,i));let s=t.length,o=t.match("[^ ]+([^\n]*)$");if(o&&(o=o[1].trim()),!t)return null;let r=t.match("\\+([^ \n]+)[ \n]");if(!r)return;return t=r[1],{range:new(0,ace.require("ace/range").Range)(e.row,0,e.row,s),tag:t,type:"plus",attrs:o||""}}}return null},handleSubmit:function(){0==$("#"+this.hidden).length&&console.log("WikiEdit.handleSubmit: no hidden value"),$("#"+this.hidden).val(this.getEditor().getValue())},doWordcount:function(e){null==e&&(e=this.getEditor().getValue()),e=e.replace(/<[^>]+>/g," ").replace(/<\/[^>]>/g," ").replace(/&nbsp;/g," "),e=Utils.split(e.replace(/[<>\n={}]/g," ")," ",!0,!0),alert("Approximately "+e.length+" words")},doColor:function(e){let t=HU.tag("input",["style",HU.css("width","100px","height","100px"),"type","color","id",this.domId("color_picker")]);t+=HU.div(["class","ramadda-buttons"],HU.span([ID,this.domId("color_apply")],"Apply")+SPACE1+HU.span([ID,this.domId("color_ok")],"Ok")+SPACE1+HU.span([ID,this.domId("color_cancel")],"Cancel")),t=HU.div(["class","ramadda-dialog"],t),this.colorDialog&&this.colorDialog.remove(),this.colorDialog=HU.makeDialog({content:t,anchor:this.getDiv(),my:"left bottom",at:"left+200 top-50",title:"Select Color",header:!0,sticky:!0,draggable:!0,modal:!1});let i=this.jq("color_picker"),s=()=>{i.attr("type","text").attr("type","color"),i.remove(),this.colorMarker&&this.editor.session.removeMarker(this.colorMarker),this.colorDialog.remove(),this.colorDialog=null},o=()=>{let e=this.getEditor().getCursorPosition(),t=i.val();this.insertAtCursor(t),console.dir(e);new(0,ace.require("ace/range").Range)(e.row,e.column,e.row,e.column+t.length);this.colorMarker&&this.editor.session.removeMarker(this.colorMarker)};this.jq("color_apply").button().click((()=>{o()})),this.jq("color_ok").button().click((()=>{o(),s()})),this.jq("color_cancel").button().click((()=>{s()})),setTimeout((()=>{i.trigger("click")}))},doPreview:async function(e,t){let i=this.getId();$("#"+i);if(!t){let e=$(window).width()-200;$("#"+this.domId(this.ID_WIKI_PREVIEW)).remove(),$(HU.div([ID,this.domId(this.ID_WIKI_PREVIEW),CLASS,"wiki-editor-preview"],"")).appendTo(this.getBlock()),$("#"+this.domId(this.ID_WIKI_PREVIEW)).css("width",e+"px"),this.previewShown=!0}let s=this.getValue(),o=ramaddaBaseUrl+"/wikify";$.post(o,{doImports:"false",entryid:e,text:s},((i,s,o)=>{let r=this;if(t)this.jq(this.ID_WIKI_PREVIEW_INNER).html(i);else{let t=Utils.join([HU.span([CLASS,"ramadda-clickable",ID,this.domId(this.ID_WIKI_PREVIEW_OPEN)],HtmlUtils.getIconImage("fa-sync",["title","Preview Again"])),HU.checkbox("",[TITLE,"Live Preview",ID,this.domId(this.ID_WIKI_PREVIEW_LIVE)],this.previewLive,"")+SPACE4,HU.span([CLASS,"ramadda-clickable",TITLE,"Wordcount",ID,this.domId(this.ID_WIKI_PREVIEW_WORDCOUNT)],HtmlUtils.getIconImage("fa-calculator")),HU.span([CLASS,"ramadda-clickable",TITLE,"Copy",ID,this.domId(this.ID_WIKI_PREVIEW_COPY)],HtmlUtils.getIconImage("fa-copy")),HU.span([CLASS,"ramadda-clickable",TITLE,"Download",ID,this.domId(this.ID_WIKI_PREVIEW_DOWNLOAD)],HtmlUtils.getIconImage("fa-download"))],SPACE2),s=HU.span([CLASS,"ramadda-clickable",ID,this.domId(this.ID_WIKI_PREVIEW_CLOSE)],HtmlUtils.getIconImage("fa-window-close",["title","Close Preview"]));i=HtmlUtils.div([CLASS,"ramadda-menubar","style","xtext-align:center;width:100%;border:1px solid #ccc"],HU.leftRight(t,s))+(i=HtmlUtils.div([ID,this.domId(this.ID_WIKI_PREVIEW_INNER),CLASS,"wiki-editor-preview-inner"],i));let o=$("#"+this.domId(this.ID_WIKI_PREVIEW));try{o.html(i).show()}catch(e){o.html(HU.getErrorDialog("An error occurred:"+e))}o.draggable(),o.resizable({handles:"ne,nw"}),this.jq(this.ID_WIKI_PREVIEW_WORDCOUNT).click((function(){r.doWordcount(r.jq(r.ID_WIKI_PREVIEW_INNER).html())})),this.jq(this.ID_WIKI_PREVIEW_COPY).click((function(){let e=r.jq(r.ID_WIKI_PREVIEW_INNER).html();Utils.copyToClipboard(e),alert("Text is copied to clipboard")})),this.jq(this.ID_WIKI_PREVIEW_DOWNLOAD).click((function(){let e=r.jq(r.ID_WIKI_PREVIEW_INNER).html();Utils.makeDownloadFile("preview.html",e)})),this.jq(this.ID_WIKI_PREVIEW_LIVE).click((function(){r.previewLive=$(this).is(":checked")})),this.jq(this.ID_WIKI_PREVIEW_OPEN).click((()=>{this.doPreview(e,!0)})),$("#"+this.domId(this.ID_WIKI_PREVIEW_CLOSE)).click((()=>{this.previewShown=!1,$("#"+this.domId(this.ID_WIKI_PREVIEW)).hide()}))}})).fail(((e,t,i)=>{console.log("error fetching preview:"+e)}))},getAttributeBlocks:function(e,t,i){if(!e)return null;let{attrs:s,title:o,display:r}=this.getDisplayAttributes(e),l=this.getWikiAttributes(e,(s=>{this.getAttributeBlocks(e,t,i)}));if(!1===l)return!1;if(l&&(s=Utils.mergeLists(s,l)),!s)return null;let n=getWikiEditorMenuBlocks(s,t,this.getId()),a=Utils.getColorTablePopup(this,!0);n.push({title:"Color table",items:a}),o||(o=Utils.makeLabel(e.tag)+" Properties");let p={blocks:n,title:o,display:r};return i&&i(p),p},handleEntriesPopup:function(e,t){this.getEntryNames(e,(e=>{if(e.length){let i="";e.forEach((e=>{i+=HU.href(ramaddaBaseUrl+"/entry/show?entryid="+e.id,e.name,["title",e.id,"target","_entries"])+"<br>"})),jqid(t).html(i)}}),!0)},handlePopupMenu:function(e,t){let i=this.getTagInfo();if(!i)return;if(!i.chunk)return;if(!t)return void this.getAttributeBlocks(i,!0,(t=>{this.handlePopupMenu(e,t)}));let s=t.blocks,o=t.title;t.display;if(0==s.length)return;let r=HU.open("div",[CLASS,"wiki-editor-popup","style","min-width:400px;"]);o||(o=Utils.makeLabel(i.tag)+" Properties");let l=HU.span(["id",this.domId("searchattributes"),CLASS,"wiki-popup-menu-header ramadda-clickable","title","Search attributes"],HU.getIconImage("fa-binoculars"));r+=HU.div([CLASS,"wiki-editor-popup-heading"],l+" "+o);let n=this.extractEntryIds(i.chunk);if(n.length){let e=Utils.getUniqueId("entrieslist");r+=HU.toggleBlock("Entries",HU.div([ID,e,CLASS,"wiki-editor-popup-items"],"Loading...")),this.handleEntriesPopup(n,e)}Utils.splitList(s,5).forEach((e=>{r+=HU.open("div",[CLASS,"wiki-editor-popup-section"]),e.forEach((e=>{if("string"==typeof e)return void(r+=e);let t=e.title;t=HU.div([CLASS,"wiki-editor-popup-header"],t);let i=e.items.join("");i=HU.div([CLASS,"wiki-editor-popup-items"],i),r+=HU.toggleBlock(e.title,i)})),r+=HU.close("div")})),r+="</div>";let a=HU.makeDialog({content:r,anchor:$(window),my:"left top",at:"left+"+e.x+" top+"+e.y,title:o,header:!0,sticky:!0,draggable:!0,modal:!1});HtmlUtils.setPopupObject(a),jqid(this.domId("searchattributes")).click((()=>{a.remove(),this.makeSearchAttributesDialog(this.toolbar,s,!1)}))},handleMouseUp:function(e,t){let i=this;if(!e.metaKey)return;let s=this.getEditor().renderer.screenToTextCoordinates(e.x,e.y);if(!s)return;let o=this.getTagInfo(s);if(!o)return;if(!t)return void this.getAttributeBlocks(o,!1,(t=>{this.handleMouseUp(e,t)}));let r=t.blocks,l=t.title,n=(t.display,o.attrs),a=o.type||o.tag,p=this.domId(this.ID_WIKI_MENUBAR),h=getWikiEditorMenuBar(r,p,a),d=$(window).width()-100,u=HU.div([ID,this.domId("wiki-editor-popup"),CLASS,"wiki-editor-editor"],h+HU.textarea("",n,["spellcheck","false",STYLE,HU.css("width",d+"px","height","300px"),ID,this.domId(this.ID_WIKI_POPUP_EDITOR),"xrows","10","xcols","120"])+"<br>"+HU.div([STYLE,HU.css("text-align","center","padding","4px")],HU.span([TITLE,"Tidy the text",ID,this.domId(this.ID_WIKI_POPUP_TIDY)],HU.getIconImage("fas fa-broom"))+SPACE1+HU.span([TITLE,"Compact the text",ID,this.domId(this.ID_WIKI_POPUP_COMPACT)],HU.getIconImage("fas fa-snowplow"))+SPACE1+HU.span([ID,this.domId(this.ID_WIKI_POPUP_OK)],"Ok")+SPACE1+HU.span([ID,this.domId(this.ID_WIKI_POPUP_CANCEL)],"Cancel"))),c=HU.makeDialog({content:u,anchor:this.getScroller(),title:l,header:!0,sticky:!0,draggable:!0,modal:!0,modalContentsCss:HU.css("left","50px")});jqid("searchattributes").click((function(){i.makeSearchAttributesDialog($(this),r,!0)})),this.popupShowing=!0,this.jq(this.ID_WIKI_POPUP_EDITOR).focus(),this.jq(this.ID_WIKI_POPUP_CANCEL).button().click((()=>{this.popupShowing=!1,c.remove()}));let g=e=>{let t=this.jq(this.ID_WIKI_POPUP_EDITOR).val().trim(),i=Utils.parseAttributesAsList(t),s="",o=0;for(let t=0;t<i.length;t+=2){let r=i[t+1];null!=r&&(r.indexOf(" ")>=0||r.indexOf("\n")>=0||""==r)&&(r='"'+r+'"'),s+=i[t]+"="+r,e?s+="\n":(o++,o>4?(o=0,s+="\n"):s+="  ")}this.jq(this.ID_WIKI_POPUP_EDITOR).val(s)};this.jq(this.ID_WIKI_POPUP_TIDY).button().click((()=>{g(!0)})),this.jq(this.ID_WIKI_POPUP_COMPACT).button().click((()=>{g(!1)})),this.jq(this.ID_WIKI_POPUP_OK).button().click((()=>{let e,t=this.jq(this.ID_WIKI_POPUP_EDITOR).val(),i=o.tag;"display"==i&&("group"==o.type?i="group":""!=o.type&&(i="display_"+o.type)),"plus"==o.type?(t=t.replace(/\n/g," "),e="+"+i+" "+t+" "):e="{{"+i+" "+t+"}}",this.popupShowing=!1,c.remove(),this.getSession().replace(o.range,e)}))},makeSearchAttributesDialog:function(e,t,i){let s=this,o="";t.forEach(((e,t)=>{if("string"==typeof e)return;if("Color table"==e.title)return;let i=e.title;o+=HU.div(["class","wiki-searchheader","data-block-index",e.index],HU.b(i)),o+="<div>";let s=Utils.join(e.items," ");s=s.replace(/<div/g,"<span").replace(/\/div>/g,"/span>"),o+=s,o+="</div>"})),o=HU.center(HU.input("","",["placeholder","Search","id",s.domId("allsearch"),"width","10"]))+HU.div(["id",s.domId("allsearch_corpus"),"style",HU.css("width","500px","max-height","400px","overflow-y","auto")],o),o=HU.div(["style","margin:5px;"],o);HU.makeDialog({content:o,anchor:e,title:"Attributes",header:!0,sticky:!0,draggable:!0,modal:i});let r=jqid(s.domId("allsearch_corpus")).find("span"),l=jqid(s.domId("allsearch_corpus")).find(".wiki-searchheader");jqid(s.domId("allsearch")).keyup((function(e){let t=$(this).val().trim().toLowerCase(),i={};r.each((function(){if(""==t)$(this).show();else{let e=$(this).attr("data-corpus");if(!e)return;e=e.toLowerCase(),e.indexOf(t)>=0?($(this).show(),i[$(this).attr("data-block-index")]=!0):$(this).hide()}})),""==t?l.show():l.each((function(){i[$(this).attr("data-block-index")]?$(this).show():$(this).hide()}))}))},handleMouseLeave:function(e){this.setInContext(!1)},extractEntryIds:function(e){let t=/([a-z0-9]+-[a-z0-9]{4}-[a-z0-9]{4}-[a-z0-9]{4}-[a-z0-9]+)(.*)/,i=[],s=e.match(t);for(;s&&3==s.length;)i.push(s[1]),s=s[2].match(t);return i},getEntryNames:function(e,t,i){let s=()=>{let i=ramaddaBaseUrl+"/entry/names?entryids="+Utils.join(e,",");this.getNamesPending=!0,$.getJSON(i,(e=>{this.getNamesPending=!1,t(e)}))};i?s():this.getNamesTimeout=setTimeout((()=>{s()}),1e3)},setInContext:function(e,t,i){this.inContext=e;let s=this.getScroller();if(this.tagMarker&&this.editor.session.removeMarker(this.tagMarker),this.tagMarker=null,this.getNamesTimeout&&clearTimeout(this.getNamesTimeout),this.getNamesTimeout=null,e){s.css("cursor","context-menu");let e="Right-click to show property menu";"plus"!=t&&(e+="<br>Cmd-click to edit"),this.showMessage(e)}else s.css("cursor","text"),this.clearMessage(),this.lastTimeout&&clearTimeout(this.lastTimeout);this.lastTimeout=null},handleMouseMove:function(e){this.lastTimeout&&clearTimeout(this.lastTimeout);let t=()=>{let t=this.getEditor().renderer.screenToTextCoordinates(e.x,e.y);if(!t)return;let i=this.getTagInfo(t);i?this.setInContext(!0,i.type,i.chunk):this.setInContext(!1)};this.inContext?t():this.lastTimeout=setTimeout(t,1e3)},getWikiAttributes:function(e,t){if(this.wikiAttributes[e.tag])return this.wikiAttributes[e.tag];if(!this.wikiAttributesFromServer){let i=ramaddaBaseUrl+"/wikitags";return $.getJSON(i,(i=>{this.wikiAttributesFromServer=i,t(this.wikiAttributesFromServer[e.tag])})),!1}return this.wikiAttributesFromServer[e.tag]},getDisplayAttributes:function(e){let t=null,i=[],s=null;if("plus"==e.type)return{attrs:null,title:null,display:null};try{if(s=(new DisplayManager).createDisplay(e.type,{dummy:!0}),s&&(i=s.getWikiEditorTags(),s.getTypeLabel)){t=s.getTypeLabel(),null==t&&(t=Utils.makeLabel(e.type||"")),t+=" Properties";let i=s.getTypeHelpUrl();i&&(t=HU.href(i,t+SPACE+HU.getIconImage(icon_help),["target","_ramaddahelp"]))}}catch(t){console.log("Error getting attrs for:"+e.type+" error:"+t+" stack:"+t.stack)}return{attrs:i,title:t,display:s}},wikiInitDisplaysButton:function(){let e=this.getId(),t=$("#displays_button"+e);t.click((()=>{if(!window.globalDisplayTypes)return;var i=window.globalDisplayTypes,s={},o=[];DISPLAY_CATEGORIES.forEach((e=>{s[e]=[],o.push(e)})),i.forEach((t=>{if(Utils.isDefined(t.forUser)&&!t.forUser)return;var i=t.category||CATEGORY_MISC;null==s[i]&&(s[i]=[],o.push(i));let r=t.tooltip||"";r=r.replace(/"/g,"&quot;");let l="insertDisplayText('"+e+"','"+t.type+"')",n=HU.div([CLASS,"wiki-editor-popup-link"],HU.href("#",t.label,[CLASS,"display-link ",TITLE,r,"onclick",l]));s[i].push(n)}));let r="<table><tr valign=top>";for(let e=0;e<o.length;e++){let t=o[e],i=Utils.join(s[t],"<div>\n");r+=HU.td([],HU.div([STYLE,"margin-right:5px;"],HU.b(t))+"<div style='margin-right:5px;max-height:250px;overflow-y:auto;'>"+i)}r=HU.div([ID,"wiki-display-popup",STYLE,"font-size:10pt;width:800px;"],r);let l=HU.makeDialog({content:r,my:"left top",at:"left-200px bottom",title:"",anchor:t,draggable:!0,header:!0,initCall:()=>{$("#wiki-display-popup").tooltip({classes:{"ui-tooltip":"wiki-editor-tooltip"},content:function(){return $(this).prop("title")},show:{effect:"slide",delay:500,duration:400},position:{my:"left top",at:"right top"}})}});wikiPopup&&wikiPopup.hide(),wikiPopup=l}))},initAttributes:function(){this.groupAttributes=[{label:"Collection Properties"},{p:"sortby",ex:"name|date|changedate|createdate|entryorder|number",tt:"sort type -name,date, change date, create date"},{p:"sortdir",ex:"up|down",tt:"direction of sort. use up for oldest to youngest"},{p:"entries",ex:"entryid1,entryid2,entryid3..",tt:"comma separated list of entry ids to use"},{p:"entries.filter",ex:"file|folder|image|type:some type|geo|name:name pattern|suffix:file suffixes",tt:"allows you to select what entries to use"},{p:"exclude",ex:"entryid1,entryid2,entryid3..",tt:"comma separated list of entry ids to not use"},{p:"first",ex:"entryid1,entryid2,entryid3..",tt:"comma separated list of entry ids to use first"},{p:"last",ex:"entryid1,entryid2,entryid3..",tt:"comma separated list of entry ids to use last"},{p:"max",ex:"number of entries to use",tt:"max number of entries to use"}],this.wikiAttributesFromServer=null;let e=Utils.mergeLists([{label:"Table Tree"},{p:"simple",ex:!0},{p:"showHeader",ex:!1},{p:"showDate",ex:!1},{p:"showCreateDate",ex:!1},{p:"showSize",ex:!1},{p:"showType",ex:!1},{p:"showIcon",ex:!1},{p:"showThumbnails",ex:!1},{p:"showArrow",ex:!1},{p:"showForm",ex:!1},{p:"showCrumbs",ex:!0},{p:"message",ex:""},{p:"treePrefix",ex:""},{p:"chunkSize",ex:"10",tt:"break up the list of entries into chunkSize lists and display each list"},{p:"numChunks",ex:"2",tt:"how many entry chunks"},{p:"chunkColumns",ex:"2",tt:'how many columns use "numChunks" to match number of chunks'},{p:"chunkStyle",ex:"margin:10px;",tt:"chunk style"}],this.groupAttributes);this.wikiAttributes={tree:e,tabletree:e,links:Utils.mergeLists([{label:"Links Properties"},{p:"info",ex:"List children entries"},{p:"showIcon",ex:"false"},{p:"showDescription",ex:"true"},{p:"showSnippet",ex:"true"},{p:"linkresource",ex:"true",tt:"Link to the resource"},{p:"separator",ex:"",tt:"Separator between links"},{p:"horizontal",ex:"true",tt:"Display horizontallly"},{p:"output",ex:"",tt:"Link to output"},{p:"tagopen",ex:"html before link"},{p:"tagclose",ex:"html after link"},{p:"linksBefore",ex:'"url;label,url;label"'},{p:"linksAfter",ex:'"url;label,url;label"'},{p:"innerClass",ex:""},{p:"class",ex:"",tt:"link css class"},{p:"style",ex:"",tt:"link style"},{p:"chunkSize",ex:"10",tt:"break up the list of entries into chunkSize lists and display each list"},{p:"numChunks",ex:"2",tt:"how many entry chunks"},{p:"chunkColumns",ex:"2",tt:'how many columns use "numChunks" to match number of chunks'},{p:"chunkStyle",ex:"margin:10px;",tt:"chunk style"}],this.groupAttributes),section:[{label:"Section Properties"},{p:"title",ex:'"{{name}}"'},{p:"subTitle",ex:'""'},{p:"style",ex:'""'},{p:"titleStyle",ex:'""'},{p:"----",tt:"Add a line"},{p:"#",tt:"Colored sections"}],row:[{label:"Row Properties"},{p:"tight",ex:"true",tt:"Layout rows with no space"}],list:Utils.mergeLists([{label:"List Properties"},{p:"info",ex:":List children entries"},{p:"showIcon",ex:"false"},{p:"showDescription",ex:"true"},{p:"showSnippet",ex:"true"},{p:"linkresource",ex:"true",tt:"Link to the resource"},{p:"separator",ex:"",tt:"Separator between links"},{p:"output",ex:"",tt:"Link to output"},{p:"tagopen",ex:"",tt:"html before link"},{p:"tagclose",ex:"",tt:"html after link"},{p:"innerClass",ex:""},{p:"class",ex:"",tt:"link css class"},{p:"style",ex:"",tt:"link style"},{p:"chunkSize",ex:"10",tt:"break up the list of entries into chunkSize lists and display each list"},{p:"numChunks",ex:"2",tt:"how many entry chunks"},{p:"chunkColumns",ex:"2",tt:'how many columns use "numChunks" to match number of chunks'},{p:"chunkStyle",ex:"margin:10px;",tt:"chunk style"}],this.groupAttributes),information:[{label:"Information Properties"},{p:"info",ex:"Show entry information"},{p:"details",ex:"false"},{p:"showTitle",ex:"true"},{p:"showResource",ex:"true"},{p:"showBase",ex:"true"},{p:"showDetails",ex:"true"}],description:[{label:"Description Properties"},{p:"wikify",ex:"true"},{p:"prefix",ex:""},{p:"suffix",ex:""},{p:"convert",ex:"_newline=true"}],resource:[{label:"Resource Properties"},{p:"info",ex:"",tt:"Link to the resource"},{p:"title",ex:""},{p:"includeIcon",ex:"true"},{p:"url",ex:"true",tt:"Just include the URL"},{p:"message",ex:"",tt:"Message to show when no resource"}],link:[{label:"Link Properties"},{p:"info",ex:"Link to the entry"},{p:"linkresource",ex:"true",tt:"Link to the resource"},{p:"button",ex:"true",tt:"Make a button"},{p:"title",ex:"",tt:"Title to use"},{p:"output",ex:"output type",tt:"Link to the given output"}],daterange:[{label:"Date Range Properties"},{p:"format",ex:"yyyy-MM-dd HH:mm:ss Z"},{p:"separator",ex:""}],html:[{label:"HTML Properties"},{p:"info",ex:"true",tt:"Include the HTML of the entry"},{p:"children",ex:"true",tt:"Include HTML of children entries"},{p:"showTitle",ex:"false"}],map:[{label:"Map Properties"},{p:"icon",ex:"#/icons/dots/green.png"},{p:"width",ex:"100%"},{p:"height",ex:"400"},{p:"listentries",ex:"true"},{p:"details",ex:"false"},{p:"showLines",ex:"true"},{p:"showBounds",ex:"false"},{p:"showMarkers",ex:"false"},{p:"showCameraDirection",ex:"false"},{p:"showLocationSearch",ex:"true"},{p:"showCheckbox",ex:"true"},{p:"showSearch",ex:"false"},{p:"showLayerToggle",ex:"true"},{p:"showLatLonLines",ex:"true"},{p:"showScaleLine",ex:"true"},{p:"showLayerSwitcher",ex:"true"},{p:"showLatLonPosition",ex:"true"},{p:"showZoomPanControl",ex:"true"},{p:"showZoomOnlyControl",ex:"true"},{p:"showBookmarks",ex:"true"},{p:"showBounds",ex:"true"},{p:"showOpacitySlider",ex:"true"},{p:"useThumbnail",ex:"true"},{p:"iconSize",ex:"32"},{p:"iconWidth",ex:"32"},{p:"iconHeight",ex:"32"},{p:"layerStrokeColor",ex:"red"},{p:"layerStrokeWidth",ex:"2"},{p:"layerFillColor",ex:"red"},{p:"layerFillOpacity",ex:"0.5"},{p:"rules",ex:"attr1:== or != or &lt; or &gt; or  ~ (like):value:fillColor:red:strokeColor:black;attr2:",tt:"Specify style rules based on feature properties"},{p:"pointRadius",ex:""},{p:"strokeColor",ex:""},{p:"strokeWidth",ex:""},{p:"fillOpacity",ex:""},{p:"fillColor",ex:""},{p:"layerStrokeColor",ex:""},{p:"layerStrokeWith",ex:""},{p:"layerFillColor",ex:""},{p:"layerFillOpacity",ex:""},{p:"highlightStrokeColor",ex:""},{p:"highlightFillColor",ex:""},{p:"highlightStrokeWidth",ex:""},{p:"highlightFillOpacity",ex:""},{p:"popupWidth",ex:"200"},{p:"popupHeight",ex:"200"},{p:"doPopupSlider",ex:"true"},{p:"popupSliderRight",ex:"true"},{p:"linked",ex:"true"},{p:"linkMouse",ex:"true"},{p:"linkGroup",ex:"some name"},{p:"layer",ex:"osm|google.roads|esri.street|opentopo|esri.topo|usfs|usgs.topo|google.terrain|google.satellite|naip|usgs.imagery|esri.shaded|esri.lightgray|esri.darkgray|esri.terrain|shadedrelief|esri.aeronautical|historic|osm.toner|osm.toner.lite|watercolor"},{p:"iconsonly",ex:"false"}],name:[{label:"Name Properties"},{p:"link",ex:"true",tt:"Link to the entry"}],property:[{label:"Property Properties"},{p:"name",ex:""},{p:"value",ex:""}],group:Utils.mergeLists([{label:"Group Properties"},{p:"showMenu",ex:"true"},{p:"showTitle",ex:"true"},{p:"layoutType",ex:"table|flextable|tabs|columns|rows"},{p:"layoutColumns",ex:"1"},{p:"divid",ex:"",tt:"Specify a div id to write displays into"}]),tabs:Utils.mergeLists([{label:"Tabs Properties"},{p:"tag",ex:"html"},{p:"tabsStyle",ex:"min|center|minarrow"},{p:"showLink",ex:"false"},{p:"includeIcon",ex:"true"},{p:"textposition",ex:"top|left|right|bottom"}],this.groupAttributes),grid:Utils.mergeLists([{label:"Grid Properties"},{p:"tag",ex:"card"},{p:"inner-height",ex:"100"},{p:"columns",ex:"3"},{p:"showIcon",ex:"true"},{p:"weights",ex:""},{p:"showSnippet",ex:"false"},{p:"showSnippetHover",ex:"true"},{p:"showLink",ex:"false"},{p:"showHeading",ex:"true"},{p:"showLine",ex:"true"}],this.groupAttributes),frames:Utils.mergeLists([{label:"Frames Properties"},{p:"width",ex:"400"},{p:"height",ex:"400"},{p:"noTemplate",ex:"true",tt:"Don't use the page template in the frame"}],this.groupAttributes),accordian:Utils.mergeLists([{label:"Accordian Properties"},{p:"tag",ex:"html"},{p:"collapse",ex:"false"},{p:"border",ex:"0"},{p:"showLink",ex:"true"},{p:"includeIcon",ex:"false"},{p:"textposition",ex:"left"}],this.groupAttributes),table:Utils.mergeLists([{label:"Table Properties"},{p:"showCategories",ex:"true"},{p:"showDate",ex:"true"},{p:"showCreateDate",ex:"true"},{p:"showChangeDate",ex:"true"},{p:"show",ex:"&lt;column name&gt;=true"}],this.groupAttributes),recent:Utils.mergeLists([{label:"Recent Properties"},{p:"info",ex:"",tt:"List N days recent entries by day"},{p:"days",ex:"num days"}],this.groupAttributes),multi:[{label:"Multi Properties"},{info:"Create multiple wiki tags"},{p:"_tag",ex:"tag to create"},{p:"_template",ex:"",tt:"wiki text template. Escape { and } with backslash"},{p:"_entries",ex:"entries",tt:"entries to apply to"},{p:"_headers",ex:"comma separated headers"},{p:"_headerTemplate",ex:":heading {{name link=true}}"},{p:"_columns",ex:"number of columns"},{p:"_width",ex:"200",tt:"Set the width and flow the blocks"},{p:"_style",ex:"padding:10px;",tt:"Style for each block"},{p:"first",ex:".&lt;some attribute&gt;='attr for first tag'"},{p:"last",ex:".&lt;some attribute&gt;='attr for last tag'"},{p:"notlast",ex:".&lt;some attribute&gt;='attr for first N tags'"},{p:"notfirst",ex:".&lt;some attribute&gt;='attr for last N tags'"}],menu:[{label:"Menu Properties"},{p:"menus",ex:"file,edit,view,feeds,other"},{p:"popup",ex:"true"},{p:"breadcrumbs",ex:"true"}]}}};
