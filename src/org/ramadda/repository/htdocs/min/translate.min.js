var LANGUAGE_ENGLISH="en",LANGUAGE_SPANISH="es",ATTR_DATA_LANGUAGE="data-language",CLASS_LANGUAGE_BLOCK="ramadda-language-block",Translate={trackMissing:!1,packs:{},missing:{},language:null,init:function(){let a=HU.getIconImage("fas fa-language ramadda-header-icon"),t=a+HU.space(1),e=HU.span([ATTR_TITLE,"Change language",ATTR_CLASS,HU.classes(CLASS_CLICKABLE,"ramadda-page-link"),ATTR_ID,"ramadda_language_menu"],a);e=$(e).appendTo(jqid("ramadda_links_prefix")),e.click((()=>{let a="";a+=HU.div([ATTR_TITLE,"Clear language",ATTR_CLASS,HU.classes(CLASS_CLICKABLE,"ramadda-language-switch ramadda-menu-language-switch ramadda-user-link")],t+"Clear"),ramaddaLanguages.forEach((e=>{a+=HU.div([ATTR_DATA_LANGUAGE,e.id,ATTR_TITLE,"Switch language",ATTR_CLASS,HU.classes(CLASS_CLICKABLE,"ramadda-language-switch ramadda-menu-language-switch ramadda-user-link")],t+e.label)})),a=HU.div([],a),this.menuPopup&&this.menuPopup.remove(),this.menuPopup=HU.makeDialog({content:a,anchor:e,my:"right top",at:"right bottom"});let n=this;this.menuPopup.find(".ramadda-menu-language-switch").click((function(){n.switcherClicked($(this))}))})),this.switchLang=jqid("switchlang"),Translate.translate()},switcherClicked:function(a){let t=a.attr(ATTR_DATA_LANGUAGE);"showmissing"!=t?(HU.hidePopupObject(),this.setLanguage(t),Utils.setLocalStorage("ramadda-language",t),t==LANGUAGE_ENGLISH?Translate.translateInner(null,LANGUAGE_ENGLISH,{},!0):Translate.translate(null,t)):Translate.showMissing()},setDefaultLanguage:function(a){this.defaultLanguage=a||LANGUAGE_ENGLISH,this.language=a,Translate.translate(null,a)},checkSwitcher:function(){let a=this.language;$(".ramadda-language-switch").each((function(){$(this).attr(ATTR_DATA_LANGUAGE)==a?$(this).addClass("ramadda-link-bar-item-active"):$(this).removeClass("ramadda-link-bar-item-active")}))},showLanguages:function(a,t){let e=HU.getUniqueId("switcher"),n=HU.getUniqueId("contents"),s=HU.center(HU.div([ATTR_ID,e]))+HU.div([ATTR_ID,n]);jqid(a).html(s);let l=a=>{Translate.setLanguage(a),Translate.checkSwitcher(),a&&HU.addToDocumentUrl("language",a),Translate.loadPack(a,(t=>{let e=HU.getUniqueId("search"),s=HU.div([ATTR_ID,e]);s+=HU.open(TAG_TABLE),s+=HU.tr([],HU.tds([ATTR_STYLE,HU.css(CSS_MIN_WIDTH,HU.px(400))],[HU.b("English"),HU.b("Translated - "+a)])),Object.keys(t).sort(((a,t)=>a.length-t.length)).forEach((a=>{a.startsWith("language.")||(s+=HU.tr([ATTR_CLASS,"phrase"],HU.tds([],[a,t[a]])))})),s+=HU.close(TAG_TABLE),jqid(n).html(s),HU.initPageSearch(".phrase",null,null,!1,{target:"#"+e,focus:!0})}))};t&&l(t),Translate.addSwitcher(e,null,!1,{callback:l,skipEnglish:!0}),Translate.disable()},addSwitcher:function(a,t,e,n){if(e&&(this.trackMissing=!0),n=n??{},this.disabled)return;t?t=Utils.split(t,",",!0,!0):(t=[],ramaddaLanguages.forEach((a=>{t.push(a.id)})));let s=HU.open(TAG_DIV,[ATTR_CLASS,"ramadda-link-bar"]);t.forEach((a=>{if(n.skipEnglish&&a==LANGUAGE_ENGLISH)return;let t;if(ramaddaLanguages.forEach((e=>{e.id==a&&(t=e.label)})),!t){t=a;let e=Utils.split(t,":");e.length>=2?(a=e[0],t=e[1].replace("_"," ")):t=Utils.makeLabel(a)}s+=HU.span([ATTR_DATA_LANGUAGE,a,ATTR_TITLE,"Switch language",ATTR_CLASS,HU.classes(CLASS_CLICKABLE,"ramadda-link-bar-item ramadda-language-switch")],t)})),e&&(Translate.downloadMode=!0,s+=HU.span([ATTR_DATA_LANGUAGE,"showmissing",ATTR_CLASS,HU.classes(CLASS_CLICKABLE,"ramadda-link-bar-item ramadda-language-switch")],"Download missing")),s+=HU.close(TAG_DIV);let l=$(s);l.appendTo(jqid(a));let i=this;l.find(".ramadda-language-switch").click((function(){if(n.callback){let a=$(this).attr(ATTR_DATA_LANGUAGE);n.callback(a)}else i.switcherClicked($(this))})),this.checkSwitcher()},pending:{},loadPack:function(a,t){if(Translate.packs[a])return void t(Translate.packs[a]);if(Translate.pending[a])return void Translate.pending[a].push(t);Translate.pending[a]=[];let e=HU.url(RamaddaUtil.getUrl("/getlanguage"),"language",a);ramaddaCurrentEntry&&(e=HU.url(e,ARG_ENTRYID,ramaddaCurrentEntry)),$.ajax({url:e,dataType:"text",success:function(e){let n=Translate.makePack(e);$('.ramadda-dict[lang="'+a+'"]').each((function(){let a=Translate.makePack($(this).text());n=$.extend(n,a)})),Translate.packs[a]=n,t(Translate.packs[a]),Translate.pending[a]&&Translate.pending[a].forEach((t=>{t(Translate.packs[a])})),Translate.pending[a]=null}}).fail((function(){console.log("Failed to load url: "+e),Translate.packs[a]={}}))},makePack:function(a){let t={};return a?(Utils.split(a,"\n",!0,!0).forEach((a=>{if((a=a.replace(/\"/g,"")).startsWith("#"))return;let e=a.indexOf("=");if(e<0)return;let n=a.substring(0,e).trim(),s=a.substring(e+1).trim();"NA"!=s&&(t[n]=s)})),t):t},disable:function(){this.disabled=!0},setLanguage:function(a){this.language=ramaddaLanguage=a},translate:function(a,t){this.disabled||((t=this.language)||(t=this.defaultLanguage),t||("undefined"!==(t=this.language??Utils.getLocalStorage("ramadda-language"))&&"null"!==t||(t=null),t=t??ramaddaLanguage??navigator?.language??navigator?.userLanguage),Utils.stringDefined(t)?(t=(t=t.toLowerCase()).replace(/-.*/,""),this.setLanguage(t),t!=LANGUAGE_ENGLISH?Translate.loadPack(t,(e=>{Translate.translateInner(a,t,e)})):Translate.translateInner(a,t,{},!0)):t=LANGUAGE_ENGLISH)},haveDoneAnyTranslations:!1,phrases:{},definePhrase:function(a,t,e){let n=Translate.phrases[a];n||(n=Translate.phrases[a]={}),n[t]=e},canTranslate:function(a,t,e){return(!Translate.downloadMode||!a.hasClass("display-metadatalist-item"))&&(!a.hasClass("ramadda-notranslate")&&!a.hasClass(CLASS_LANGUAGE_BLOCK)&&(!(!t||t.indexOf("<")>=0)&&(!(t.length<=1)&&(!t.match(/.*[0-9].*/)&&(!t.match(/^[0-9]+/)&&!t.match(/ [0-9]+$/))))))},translateInner:function(a,t,e,n){let s,l;if(t=this.language,a?(s=$(a).find("*"),l=$(a).find(HU.dotClass(CLASS_LANGUAGE_BLOCK))):(s=$("*"),l=$(HU.dotClass(CLASS_LANGUAGE_BLOCK))),l.each((function(){$(this).attr(ATTR_DATA_LANGUAGE)==t?$(this).show():$(this).hide()})),this.checkSwitcher(),n&&!this.haveDoneAnyTranslations)return;if(this.haveDoneAnyTranslations=!0,!e)return void console.log("no language pack:"+t);let i=Translate.phrases[t];i&&$.extend(e,i);let r=a=>"lang-orig-"+(a??""),d=a=>"lang-current-"+(a??""),g=(a,t,s)=>{if("title"!=s&&"I"==a.prop("tagName"))return null;if(n){let t=a.attr(r(s));return t||null}if(t.indexOf(Utils.MSGCHAR)>=0){let e=Utils.tokenizeMessage(t),n="";return e.forEach((t=>{if("text"==t.type)return void(n+=t.value);let e=g(a,t.value,s);n+=e||t.value})),n}if(t=t.trim(),!Translate.canTranslate(a,t,s))return null;let l=t;if(e[t]||(t=t.toLowerCase()),e[t])return"<skip>"==e[t]?null:(a.attr(r(s),l),e[t]);if(this.trackMissing){let t=!0;a&&(a.hasClass("olButton")||a.hasClass("ramadda-text"))&&(t=!1);let e=a.prop("tagName");if(this.trackMissing&&"A"==e&&a.parent().hasClass("ramadda-text")&&(t=!1),"OPTION"==e){a.parent().hasClass("ramadda-text")&&(t=!1)}"TITLE"==e&&ramaddaThisEntry&&(t=!1),t&&(t=!Utils.isNoMsg(l)),t&&(Translate.missing[l]=!0)}return a.attr(r(s))},c={SCRIPT:!0,BR:!0,HTML:!0,STYLE:!0,TEXTAREA:!0,HEAD:!0,META:!0,LINK:!0,BODY:!0},u=[ATTR_PLACEHOLDER,ATTR_TITLE,ATTR_VALUE];s.each((function(){let a,e=$(this),n=e.prop("tagName");if(c[n])return;u.forEach((s=>{if(s==ATTR_VALUE&&("INPUT"!=n||"submit"!=e.attr("type")))return;let l=e.attr(s);if(l){let n=d(s);e.attr(n)!=t&&(e.attr(n,t),a=g(e,e.attr(r(s))??l,s),a&&e.attr(s,a))}}));let s=r(),l=d(),i=e.attr(s)??e.html();Translate.canTranslate(e,i)&&e.attr(l)!=t&&(a=g(e,i),a&&(e.html(a),e.attr(l,t)))}))},showMissing:function(){let a="";a+="#page: "+window.location.pathname+" title:"+document.title+"\n";let t=0;Object.keys(Translate.missing).forEach((e=>{e.length>100||e.match(/^[_\{\}=0-9]+/)||e.match(/ [0-9]+$/)||e.match(/\./)&&!e.match(/\s/)||e.match("Â©")||e.match(/^Test$/)||e.match(/^:.*/)||e.match(/^-.*/)||e.match(/.*&.*/)||e.match(/.*yyyy.*/i)||e.match(/.*ramadda.*/i)||Utils.isNoMsg(e)||(console.log(e),a+=e+"=\n",t++)})),0!=t?Utils.makeDownloadFile("phrases.txt",a):alert("No missing phrases")}};ramaddaLanguagesEnabled&&$(document).ready((function(){Translate.init()}));
