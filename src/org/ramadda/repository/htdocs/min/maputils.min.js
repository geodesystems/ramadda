var debugBounds=!1,getMapDebug=!1,debugPopup=!1,debugSelect=!1,RamaddaToFloat=e=>(null!=e&&(e=parseFloat(e)),e),MapUtils={me:"MapUtils",regions:null,POSITIONMARKERID:"location",LABEL_MAP:{aiannhr:"Federal Recognition",mtfcc:"Feature Class",geoid:"Geographic ID",aland:"Land Area",awater:"Water Area",countyfp:"County FIPS",statefp:"State FIPS",namelsad:"Name-LSAD",lsad:"Legal Area Descriptor",aiannhce:"American Indian Census Code",aiannhns:"Anerican Indian Standard Code",classfp:"Class Code",comptyp:"Component Type",intptlat:"Latitude",intptlon:"Longitude",usps:"USPS State Abbrev.",ansicode:"ANSI Code",funcstat:"Functional Status",drawseq:"Draw Sequence",cdsessn:"CD Session",cd115fp:"CD FIPS",affgeoid:"Amer. Fact Finder ID"},properties:{},testSize:{active:!1,out:null,fontUnit:"px",fontSize:3,line:"ABCDEFGHIJKLMNOPQRSTUVWXYZABCD\nABCDEFGHIJKLMNOPQRSTUVWXYZABCD",rows:2,seen:{}},MAP_RESOURCES:null,MAP_RESOURCES_MAP:null,initMapResources:function(){this.MAP_RESOURCES||$.getJSON(Ramadda.getUrl("/mapresources.json"),(e=>{this.MAP_RESOURCES_MAP={},this.MAP_RESOURCES=e,this.MAP_RESOURCES.forEach(((e,t)=>{this.MAP_RESOURCES_MAP[t]=e}))})).fail((e=>{console.error("Failed loading mapresources.json:"+e)}))},handleSize:function(e){if(!this.testSize.active)return;if(this.testSize.out||(this.testSize.out="let "+this.testSize.fontUnit+"Map={"),this.testSize.seen[this.testSize.fontSize])return;this.testSize.seen[this.testSize.fontSize]=!0;let t=this.testSize.fontSize+":{x:"+Utils.trimDecimals(e.width/this.testSize.line.length,2)+",y:"+Utils.trimDecimals(e.height/this.testSize.rows,2)+"},";console.log(t),this.testSize.out+=t+"\n",24==this.testSize.fontSize&&Utils.makeDownloadFile(this.testSize.fontUnit+"map.txt",this.testSize.out+"\n};\n")},loadTurf:function(e){if(!window.turf){let t=ramaddaCdn+"/lib/turf.min.js";return Utils.loadScript(t,e),!1}return!0},extendBounds:function(e,t){return e?(t&&e.extend(t),e):t},intercept:function(e,t,a,i){let r=e,n=t,o=a,s=i,l=Math.abs(n-s);return l>180&&(l=360-l),r+(180-n)*((o-r)/l)},crossIDL:function(e,t){if(e>0&&t<0||e<0&&t>0){if(Math.abs(e-t)>180)return!0}return!1},addMapProperty:function(e,t){this.properties[e]=t},getMapProperty:function(e,t){return this.properties[e]??t},makeLabel:function(e){if(!e)return e;let t=e.toLowerCase();return this.LABEL_MAP[t]??Utils.makeLabel(e)},stopEvent:function(e){OpenLayers.Event.stop(e)},createGraticule:function(e){return new OpenLayers.Control.Graticule(e)},createLinearRing:function(e){return new OpenLayers.Geometry.LinearRing(e)},createLineString:function(e){return new OpenLayers.Geometry.LineString(e)},createPolygon:function(e){return new OpenLayers.Geometry.Polygon(e)},createVector:function(e,t,a){return new OpenLayers.Feature.Vector(e,t,a)},formatLocationValue:function(e){e=parseFloat(e);let t=Math.pow(10,7);return e=Math.floor(e*t)/t},getVectorStyle:function(e){return OpenLayers.Feature.Vector.style[e]},createStyleMap:function(e){return new OpenLayers.StyleMap(e)},createLonLat:function(e,t){return new OpenLayers.LonLat(RamaddaToFloat(e),RamaddaToFloat(t))},createPoint:function(e,t){return new OpenLayers.Geometry.Point(RamaddaToFloat(e),RamaddaToFloat(t))},getCenter:function(e){return MapUtils.createPoint(e.left+(e.right-e.left)/2,e.bottom+(e.top-e.bottom)/2)},boundsDefined:function(e){return null!=e&&null!=e.left},createBoundsFromPoints:function(e){let t=0,a=0,i=0,r=0;return e.forEach(((e,n)=>{t=0==n?e.x:Math.min(t,e.x),a=0==n?e.x:Math.max(a,e.x),r=0==n?e.y:Math.max(r,e.y),i=0==n?e.y:Math.min(i,e.y)})),this.createBounds(t,i,a,r)},createBounds:function(e,t,a,i,r){if(!Utils.isNumber(e)&&e&&e.left&&!r)return this.createBounds(e.left,e.bottom,e.right,e.top,!0);return new OpenLayers.Bounds(RamaddaToFloat(e),RamaddaToFloat(t),RamaddaToFloat(a),RamaddaToFloat(i))},createPixel:function(e,t){return new OpenLayers.Pixel(e,t)},createSize:function(e,t){return new OpenLayers.Size(e,t)},createMarker:function(e,t){return new OpenLayers.Marker(e,t)},createBox:function(e){return new OpenLayers.Marker.Box(e)},createIcon:function(e,t,a,i){return new OpenLayers.Icon(e,t,a,i)},createImage:function(e,t,a,i){return OpenLayers.Util.createImage(e,t,a,i)},createLayerGeoJson:function(e,t,a){return MapUtils.createLayerVector(t,{projection:e.displayProjection,strategies:[new OpenLayers.Strategy.Fixed],protocol:new OpenLayers.Protocol.HTTP({url:a,format:new OpenLayers.Format.GeoJSON({ignoreExtraDims:!0})})})},createLayerKML:function(e,t,a){return MapUtils.createLayerVector(t,{projection:e.displayProjection,strategies:[new OpenLayers.Strategy.Fixed],protocol:new OpenLayers.Protocol.HTTP({url:a,format:new OpenLayers.Format.KML({extractStyles:!0,extractAttributes:!0,maxDepth:2})})})},createLayerGPX:function(e,t,a){return MapUtils.createLayerVector(t,{strategies:[new OpenLayers.Strategy.Fixed],projection:e.displayProjection,protocol:new OpenLayers.Protocol.HTTP({url:a,format:new OpenLayers.Format.GPX({extractStyles:!0,extractAttributes:!0,maxDepth:2})})})},createLayerImage:function(e,t,a,i,r){return new OpenLayers.Layer.Image(e,t,a,i,r)},createLayerWMS:function(e,t,a){return new OpenLayers.Layer.WMS(e,t,a)},createLayerXYZ:function(e,t,a){return new OpenLayers.Layer.XYZ(e,t,a)},createLayerMarkers:function(e,t){return new OpenLayers.Layer.Markers(e,t)},createLayerBoxes:function(e,t){return new OpenLayers.Layer.Boxes(e,t)},createLayerVector:function(e,t,a){return new OpenLayers.Layer.Vector(e,t,a)},createProjection:function(e){return new OpenLayers.Projection(e)},distance:function(e,t,a,i){const r=e*Math.PI/180,n=a*Math.PI/180,o=(a-e)*Math.PI/180,s=(i-t)*Math.PI/180,l=Math.sin(o/2)*Math.sin(o/2)+Math.cos(r)*Math.cos(n)*Math.sin(s/2)*Math.sin(s/2),p=6371e3*(2*Math.atan2(Math.sqrt(l),Math.sqrt(1-l)));return MapUtils.metersToFeet(p)},metersToFeet:function(e){return 3.28084*e},squareMetersToSquareFeet:function(e){return 10.7639*e},calculateArea:function(e){let t=0,a=e=>e*Math.PI/180;if(e.length>2){for(let i=0;i<e.length;i++){let r=e[i],n=i<e.length-1?e[i+1]:e[0];t+=a(n.x-r.x)*(2+Math.sin(a(r.y))+Math.sin(a(n.y)))}return t=6378137*t*6378137/2,t<0&&(t=-t),t=MapUtils.squareMetersToSquareFeet(t),t}return-1},squareFeetInASquareMile:27878400,symbols:{lightning:[0,0,4,2,6,0,10,5,6,3,4,5,0,0],rectangle:[0,0,4,0,4,10,0,10,0,0],diamond:[5,0,10,5,5,10,0,5,5,0],church:[4,0,6,0,6,4,10,4,10,6,6,6,6,14,4,14,4,6,0,6,0,4,4,4,4,0],_x:[0,0,6,6,3,3,6,0,0,6,3,3],thinx:[0,0,6,6,3,3,6,0,0,6,3,3],arrow:[0,10,5,7,10,10,5,0,0,10],downtriangle:[0,0,5,10,10,0],plane:[5,0,5,0,4,1,4,3,0,5,0,6,4,5,4,8,2,10,3,10,5,9,5,9,8,10,8,10,6,8,6,5,10,6,10,5,6,3,6,1,5,0,5,0]},initSymbols:function(){for(a in this.symbols)OpenLayers.Renderer.symbol[a]=this.symbols[a]},isFeatureVisible:function(e){return!e.style||"none"!=e.style.display},setFeatureVisible:function(e,t){if(!e.style){if(t)return;e.style=e.layer?$.extend({},e.layer.style):{}}e.style.display=t?"inline":"none",$.extend(e.style,{display:e.style.display})},declutter:function(e,t,a){let i={fontSize:"12px",padding:1,granularity:1};a&&$.extend(i,a),i.padding=Math.min(10,i.padding);let r={4:{x:1.75,y:5.99},5:{x:2.19,y:7.5},6:{x:2.63,y:8.99},7:{x:3.07,y:10.16},8:{x:3.51,y:11.83},9:{x:3.94,y:13.25},10:{x:4.38,y:14.66},11:{x:4.82,y:16.08},12:{x:5.26,y:17.5},13:{x:5.69,y:19.16},14:{x:6.13,y:20.33},15:{x:6.56,y:22},16:{x:7,y:23.41},17:{x:7.44,y:24.83},18:{x:7.88,y:26.25},19:{x:8.31,y:27.66},20:{x:8.75,y:29.08},21:{x:9.19,y:30.5},22:{x:9.62,y:31.91},23:{x:10.06,y:33.58},24:{x:10.5,y:34.75}},n=(i.fontSize??"12px").match(/^([0-9]+)($|[^\d]+)/),o=12,s="px";n&&(o=parseInt(n[1]),s=n[2]);let l={4:{x:1.31,y:4.5},5:{x:1.64,y:5.62},6:{x:1.97,y:6.75},7:{x:2.3,y:7.87},8:{x:2.63,y:9},9:{x:2.96,y:10},10:{x:3.29,y:11.25},11:{x:3.62,y:12},12:{x:3.94,y:13.25},13:{x:4.27,y:14.25},14:{x:4.6,y:15.24},15:{x:4.93,y:16.5},16:{x:5.26,y:17.5},17:{x:5.58,y:18.75},18:{x:5.91,y:19.75},19:{x:6.24,y:21},20:{x:6.56,y:22},21:{x:6.89,y:22.75},22:{x:7.22,y:24},23:{x:7.55,y:25},24:{x:7.88,y:26.25}};"pt"==s&&(l=r);let p=()=>l[o]?l[o]:o<4?l[4]:l[25];if(i.pixelsPerCharacter||(i.pixelsPerCharacter=p().x*i.padding),i.pixelsPerLine||(i.pixelsPerLine=p().y*i.padding),this.testSize.active){let e=++this.testSize.fontSize;t.forEach((t=>{t.style.fontSize=e+this.testSize.fontUnit,t.style.label=this.testSize.line}))}let c,u=e.transformLLBounds(e.getBounds()),h=[];if(t.forEach(((t,a)=>{if(t.gridSpacingInfo=null,!t.geometry)return;if(!t.style)return;let r=t.geometry.getBounds();if(!u.contains(r)&&!u.intersectsBounds(r))return void MapUtils.setFeatureVisible(t,!1);MapUtils.setFeatureVisible(t,!0),h.push(t);let n=r.getCenterLonLat(),o=e.getMap().getViewPortPxFromLonLat(n),s=o.x,l=o.y,p=s,d=s,y=l,m=l,f=1,M=1;if(t.style.label){let e=t.style.label.split("\n"),a=0;e.forEach((e=>{a=Math.max(a,e.length)}));let r=M=i.pixelsPerCharacter*a,n=f=i.pixelsPerLine*e.length;p=o.x-r/2,d=o.x+r/2,y=o.y,m=o.y+n}else if(t.style.pointRadius){let e=+t.style.pointRadius;M=2*e,f=2*e,p==d&&(p=s-e,d=s+e),y==m&&(y=l-e,m=l+e)}else f=i.padding*(y-m),M=i.padding*(d-p);c?(c.minx=Math.min(c.minx,p),c.maxx=Math.max(c.maxx,d),c.miny=Math.min(c.miny,y),c.maxy=Math.max(c.maxy,m)):c={minx:p,maxx:d,miny:y,maxy:m},t.gridSpacingInfo={height:Math.ceil(f),width:Math.ceil(M),left:Math.floor(p),right:Math.ceil(d),top:Math.floor(y),bottom:Math.ceil(m)}})),!c)return;c={minx:Math.floor(c.minx),maxx:Math.ceil(c.maxx),miny:Math.floor(c.miny),maxy:Math.ceil(c.maxy)},t=h;let d=-c.minx,y=-c.miny,m=parseInt(c.maxx+d),f=parseInt(c.maxy+y),M={};t.forEach(((e,t)=>{if(!this.isFeatureVisible(e))return void console.log("not viz");let a=e.gridSpacingInfo,r=parseInt(d+a.left),n=parseInt(y+a.top),o=!0;if(r+e.gridSpacingInfo.width<0||n+e.gridSpacingInfo.height<0)o=!1,console.log("skipping:",r,n);else{let t=[];r=Math.max(0,r),n=Math.max(0,n);for(let a=r;o&&a<r+e.gridSpacingInfo.width&&!(a>=m);a+=i.granularity)for(let r=n;o&&r<n+e.gridSpacingInfo.height&&!(r>=f);r+=i.granularity){M[a+"_"+r]?o=!1:t.push([a,r])}o&&t.forEach((e=>{let t=e[0]+"_"+e[1];M[t]=!0}))}this.testSize.active&&(o=!1),o?(MapUtils.setFeatureVisible(e,!0)):(MapUtils.setFeatureVisible(e,!1))}))},makeDefaultFeatureText:function(e,t,a,i){t||(t=Object.keys(e));let r="<table>",n=[],o=[],s=[];return t.forEach((e=>{let t=e.toLowerCase();"latitude"==t||"lat"==t||"longitude"==t||"lon"==t||"long"==t?s.push(e):"name"==t?n.push(e):o.push(e)})),(t=Utils.mergeLists(n,o,s)).forEach((t=>{let n,o,s=t.toLowerCase();if("objectid"!=s&&"feature_type"!=s&&"shapearea"!=s&&"styleurl"!=s&&"shapelen"!=s){if(i&&(n=i(t)),Utils.isDefined(n)||(n=MapUtils.makeLabel(t)),"startdate"==s?n="Start Date":"enddate"==s?n="End Date":"aland"==s?n="Land Area":"awater"==s&&(n="Water Area"),r+="<tr valign=top><td align=right><div style='margin-right:5px;margin-bottom:3px;'><b>"+HU.span(["title",t],n)+":</b></div></td><td><div style='margin-right:5px;margin-bottom:3px;'>",null==e[t]||"object"!=typeof e[t]&&"Object"!=typeof e[t])o=""+e[t];else{o=""+e[t].value}(o.startsWith("http:")||o.startsWith("https:"))&&(o="<a target=_link href='"+o+"'>"+o+"</a>"),"null"!=o&&(a&&(o=a(t,o)),r+=o,r+="</div></td></tr>")}})),r+="</table>",r}};MapUtils.defaults={maxLatValue:85,zoomLevels:40,defaultZoomLevel:-1,maxExtent:MapUtils.createBounds(-20037508,-20037508,20037508,20037508),sourceProjection:MapUtils.createProjection("EPSG:900913"),displayProjection:MapUtils.createProjection("EPSG:4326"),units:"m",doSphericalMercator:!0,wrapDateline:!0,location:MapUtils.createLonLat(0,0)},MapUtils.circleHiliteAttrs={strokeColor:"black",strokeWidth:1,fill:!0,fillOpacity:.5,fillColor:"red"};var RAMADDA_MAP_LAYERS=[],RAMADDA_MAP_LAYERS_MAP={};function MapLayer(e,t,a,i){this.opts=i??{},Utils.stringDefined(e)||(e=Utils.makeID(t)),this.id=e,Utils.stringDefined(t)||(t=Utils.makeLabel(e)),this.name=t,this.url=a,RAMADDA_MAP_LAYERS.push(this),RAMADDA_MAP_LAYERS_MAP[e]=this}MapLayer.prototype={isForMap:function(){return!Utils.isDefined(this.opts.isForMap)||this.opts.isForMap},createMapLayer:function(e){return this.layer=this.createMapLayerInner(e),this.layer},createMapLayerInner:function(e){return this.opts.creator?this.opts.creator(this,e):"simple"==this.opts.type?e.makeSimpleWms(this.id):"wms"==this.opts.type?e.addWMSLayer(this.name,this.url,this.opts.layer,!Utils.isDefined(this.opts.isOverlay)||!this.opts.isOverlay):e.createXYZLayer(this.name,this.url,this.opts.attribution,this.opts.isOverlay)}};var map_default_layer="osm";new MapLayer("osm","OSM",["//a.tile.openstreetmap.org/${z}/${x}/${y}.png","//b.tile.openstreetmap.org/${z}/${x}/${y}.png","//c.tile.openstreetmap.org/${z}/${x}/${y}.png"],{attribution:"Map courtesy of OSM"}),new MapLayer("esri.topo","ESRI Topo","https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/${z}/${y}/${x}",{isForMap:!0,attribution:"Map courtesy of ESRI"}),new MapLayer("google.roads","Google Maps - Roads","https://mt0.google.com/vt/lyrs=m&hl=en&x=${x}&y=${y}&z=${z}",{attribution:"Map courtesy of Google"}),new MapLayer("google.hybrid","Google Maps - Hybrid","https://mt0.google.com/vt/lyrs=y&hl=en&x=${x}&y=${y}&z=${z}",{attribution:"Map courtesy of Google"}),new MapLayer("esri.street","ESRI Streets","https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/${z}/${y}/${x}",{attribution:"Map courtesy of ESRI"}),new MapLayer("opentopo","OpenTopo","//a.tile.opentopomap.org/${z}/${x}/${y}.png}",{attribution:"Map courtesy of OpenTopo"}),new MapLayer("usfs","Forest Service","https://caltopo.com/tile/f16a/${z}/${x}/${y}.png",{attribution:"Map courtesy of Caltopo"}),new MapLayer("caltopo.mapbuilder","MapBuilder Topo","https://img.caltopo.com/tile/mbt/${z}/${x}/${y}.png",{attribution:"Map courtesy of Caltopo"}),new MapLayer("usgs.topo","USGS Topo","https://basemap.nationalmap.gov/ArcGIS/rest/services/USGSTopo/MapServer/tile/${z}/${y}/${x}",{attribution:"USGS - The National Map"}),new MapLayer("google.terrain","Google Maps - Terrain","https://mt0.google.com/vt/lyrs=p&hl=en&x=${x}&y=${y}&z=${z}",{attribution:"Map courtesy of Google"}),new MapLayer("google.satellite","Google Maps - Satellite","https://mt0.google.com/vt/lyrs=s&hl=en&x=${x}&y=${y}&z=${z}",{attribution:"Map courtesy of Google"}),new MapLayer("naip","NAIP Imagery","https://caltopo.com/tile/n/${z}/${x}/${y}.png",{attribution:"Map courtesy of Caltopo"}),new MapLayer("usgs.imagery","USGS Imagery","https://basemap.nationalmap.gov/ArcGIS/rest/services/USGSImageryOnly/MapServer/tile/${z}/${y}/${x}",{attribution:"USGS - The National Map"}),new MapLayer("esri.shaded","ESRI Shaded Relief","https://server.arcgisonline.com/ArcGIS/rest/services/World_Shaded_Relief/MapServer/tile/${z}/${y}/${x}",{attribution:"Map courtesy of ESRI"}),new MapLayer("esri.lightgray","ESRI Light Gray","https://services.arcgisonline.com/arcgis/rest/services/Canvas/World_Light_Gray_Base/MapServer/tile/${z}/${y}/${x}",{attribution:"Map courtesy of ESRI"}),new MapLayer("esri.darkgray","ESRI Dark Gray","https://services.arcgisonline.com/arcgis/rest/services/Canvas/World_Dark_Gray_Base/MapServer/tile/${z}/${y}/${x}",{attribution:"Map courtesy of ESRI"}),new MapLayer("esri.terrain","ESRI Terrain","https://server.arcgisonline.com/ArcGIS/rest/services/World_Terrain_Base/MapServer/tile/${z}/${y}/${x}",{attribution:"Map courtesy of ESRI"}),new MapLayer("shadedrelief","Shaded Relief","https://caltopo.com/tile/hs_m315z45s3/${z}/${x}/${y}.png",{attribution:"Map courtesy of Caltopo"}),new MapLayer("publiclands","Public Lands","https://caltopo.com/tile/sma/${z}/${x}/${y}.png",{attribution:"Map courtesy of Caltopo",isOverlay:!0,legend:ramaddaBaseUrl+"/images/publiclands.png"}),new MapLayer("federallands","Federal Lands",["//gis.blm.gov/arcgis/rest/services/lands/BLM_Natl_SMA_Cached_without_PriUnk/MapServer/tile/${z}/${y}/${x}"],{legend:ramaddaBaseUrl+"/images/federallands.png",attribution:"Map courtesy of BLM"}),new MapLayer("seafloor","Seafloor",["//tiles.arcgis.com/tiles/C8EMgrsFcRFL6LrL/arcgis/rest/services/GEBCO_basemap_NCEI/MapServer/tile/${z}/${y}/${x}"]),new MapLayer("historic","Historic","https://caltopo.com/tile/1900/${z}/${x}/${y}.png",{attribution:"Map courtesy of Caltopo",isOverlay:!0}),new MapLayer("esri.aeronautical","ESRI Aeronautical","https://wms.chartbundle.com/mp/service",{type:"wms",layer:"sec",attribution:"Map courtesy of ESRI"}),new MapLayer("cartolight","Carto-Light","https://cartodb-basemaps-a.global.ssl.fastly.net/light_all/${z}/${x}/${y}.png"),new MapLayer("moon","Moon","https://cartocdn-gusc.global.ssl.fastly.net/opmbuilder/api/v1/map/named/opm-moon-basemap-v0-1/all/${z}/${x}/${y}.png"),new MapLayer("mars","Mars","https://cartocdn-gusc.global.ssl.fastly.net/opmbuilder/api/v1/map/named/opm-mars-basemap-v0-1/all/${z}/${x}/${y}.png"),new MapLayer("lightblue","","",{type:"simple"}),new MapLayer("blue","","",{type:"simple"}),new MapLayer("white","","",{type:"simple"}),new MapLayer("black","","",{type:"simple"}),new MapLayer("gray","","",{type:"simple"}),MapUtils.initSymbols();var ARG_ZOOMLEVEL="zoomLevel",ARG_MAPCENTER="mapCenter",ramaddaMapMap={};function ramaddaMapAdd(e){null==window.globalMapList&&(window.globalMapList=[]),window.globalMapList.push(e),ramaddaMapMap[e.mapId]=e}function ramaddaMapRemove(e){null==window.globalMapList&&(window.globalMapList=[]),window.globalMapList.push(e),delete ramaddaMapMap[e.mapId]}function ramaddaMapCheckLayout(){setTimeout((()=>{null!=window.globalMapList&&window.globalMapList.map((e=>{e.map.updateSize()}))}),1e3)}var ramaddaMapLastShareTime=0,ramaddaMapLastShareMap="";function ramaddaMapShareState(e,t){let a=(new Date).getTime();if(e.mapId!=ramaddaMapLastShareMap&&a-ramaddaMapLastShareTime<2e3)return;if(ramaddaMapLastShareTime=a,ramaddaMapLastShareMap=e.mapId,e.stateIsBeingSet)return;let i=e.params.linkGroup;if(e.params.linked||e.params.linkMouse||i){e.getBounds(),e.map.baseLayer,e.map.getZoom();for(var r=0;r<window.globalMapList.length;r++){var n=window.globalMapList[r];n.stateIsBeingSet||n.mapId==e.mapId||i==n.params.linkGroup&&(n.stateIsBeingSet=!0,n.receiveShareState(e,t),n.stateIsBeingSet=!1)}}}function CollisionHandler(e,t){t=t??{},$.extend(this,{map:e,countAtPoint:{},offset:0,state:{},collisionArgs:t.collisionArgs??{},collisionInfos:[]}),this.opts=t;let a=this.map.getBounds(),i=a.right-a.left,r=$("#"+this.map.mapDivId).width(),n=.025*i,o=t.pointSize??16,s=r/i,l=0;for(;s*this.offset<o&&l<100;)this.offset+=n,l++;this.getCollisionPoint=e=>{let t=MapUtils.createLonLat(e.x,e.y);t=this.map.transformLLPoint(t),t=this.map.getMap().getViewPortPxFromLonLat(t);const a=Math.round(t.x/o)*o,i=Math.round(t.y/o)*o;let r=this.map.transformProjPoint(this.map.getMap().getLonLatFromPixel({x:a,y:i})),n=MapUtils.createPoint(r.lon,r.lat);return this.countAtPoint[n]?this.countAtPoint[n]++:this.countAtPoint[n]=1,n}}function CollisionInfo(e,t,a,i){$.extend(this,{handler:e,fixed:!1,visible:!1,icon:null,iconSize:16,dotOpacity:1,dotColor:"blue",dotColorOn:null,dotColorOff:null,dotRadius:12,ringColor:"red",ringWidth:3,scaleDots:!1,labelTemplate:"${count}",labelColor:"#fff",labelFontSize:10,dots:null,collisionPoint:a,dot:null,numRecords:t,records:[],addLines:!1,lines:[],features:[]}),i&&($.extend(this,i),this.textGetter&&(this.myTextGetter=e=>this.textGetter(this.records))),Utils.stringDefined(this.labelTemplate)||(this.labelTemplate=null),this.visible&&this.checkLines()}CollisionHandler.prototype={initPoints:function(e){return e.map((e=>{null!==e.x&&null!==e.y&&(e.collisionPoint=this.getCollisionPoint(e))}))},getCollisionInfo:function(e,t){let a=this.state[e];return a||(a=this.state[e]=new CollisionInfo(this,this.countAtPoint[e],e,this.collisionArgs),this.collisionInfos.push(a)),a},getCollisionInfos:function(){return this.collisionInfos},addCollisionLines:function(e,t){this.opts.addCollisionLines?this.opts.addCollisionLines(e,t):this.map.getLinesLayer().addFeatures(t)},setCollisionVisible:function(e,t){this.opts.setCollisionVisible&&this.opts.setCollisionVisible(e,t)}},CollisionInfo.prototype={addRecord:function(e){this.records.push(e)},addLine:function(e){this.lines.push(e)},checkLines:function(){this.addedLines||(this.addedLines=!0,this.handler.addCollisionLines(this,this.lines))},createDots:function(e){if(this.dots=[],this.icon)this.dots.push(this.handler.map.createMarker("dot-"+e,[this.collisionPoint.x,this.collisionPoint.y],this.icon,"","",null,this.iconSize,null,null,null,null,!1));else{let t=this.getCollisionDotStyle(this),a=this.handler.map.createPoint("dot-"+e,this.collisionPoint,t,null,this.myTextGetter);this.dots.push(a),t=$.extend({},t),t.label=null,t.fillColor="transparent",t.strokeColor=this.ringColor,t.strokeWidth=this.ringWidth,a=this.handler.map.createPoint("dot2-"+e,this.collisionPoint,t,null,this.myTextGetter),this.dots.push(a)}return this.dots.forEach((e=>{e.collisionInfo=this})),this.dots},dotSelected:function(e){return!this.fixed&&(this.setVisible(!this.visible),!0)},styleCollisionDot:function(e){$.extend(e.style,this.getCollisionDotStyle(e.collisionInfo))},addFeatures:function(e){this.features.push(...e)},getCollisionDotStyle:function(e){let t=this.dotColor,a=this.dotRadius;if(!this.fixed){if(this.scaleDots){let t=e.numRecords;t>1&&(a=Math.min(Math.ceil(a+t/2),28))}t=e.visible?this.dotColorOn??t:this.dotColorOff??t}let i={fillColor:t,fillOpacity:this.dotOpacity,pointRadius:a};return this.labelTemplate&&(i=$.extend(i,{label:this.labelTemplate.replace("${count}",this.records.length),fontColor:this.labelColor,fontSize:this.labelFontSize,labelOutlineColor:"transparent"})),i},setVisible:function(e){this.visible=e,this.dots.forEach((e=>{this.styleCollisionDot(e),e.layer.drawFeature(e,e.style)})),this.checkLines(),this.lines.forEach((e=>{e.featureVisible=this.visible,this.handler.map.checkFeatureVisible(e,!0)})),this.handler.setCollisionVisible(this,e)}};
