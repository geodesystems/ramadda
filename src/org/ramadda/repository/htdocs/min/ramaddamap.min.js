var debugBounds=!1,getMapDebug=!1,debugPopup=!1,ramaddaMapRegions=null;let RamaddaToFloat=t=>(null!=t&&(t=parseFloat(t)),t);var MapUtils={me:"MapUtils",POSITIONMARKERID:"location",stopEvent:function(t){OpenLayers.Event.stop(t)},createGraticule:function(t){return new OpenLayers.Control.Graticule(t)},createLinearRing:function(t){return new OpenLayers.Geometry.LinearRing(t)},createLineString:function(t){return new OpenLayers.Geometry.LineString(t)},createPolygon:function(t){return new OpenLayers.Geometry.Polygon(t)},createVector:function(t,e,i){return new OpenLayers.Feature.Vector(t,e,i)},formatLocationValue:function(t){return number_format(t,4)},getVectorStyle:function(t){return OpenLayers.Feature.Vector.style[t]},createStyleMap:function(t){return new OpenLayers.StyleMap(t)},createLonLat:function(t,e){return new OpenLayers.LonLat(RamaddaToFloat(t),RamaddaToFloat(e))},createPoint:function(t,e){return new OpenLayers.Geometry.Point(RamaddaToFloat(t),RamaddaToFloat(e))},createBounds:function(t,e,i,a){return new OpenLayers.Bounds(RamaddaToFloat(t),RamaddaToFloat(e),RamaddaToFloat(i),RamaddaToFloat(a))},createPixel:function(t,e){return new OpenLayers.Pixel(t,e)},createSize:function(t,e){return new OpenLayers.Size(t,e)},createMarker:function(t,e){return new OpenLayers.Marker(t,e)},createBox:function(t){return new OpenLayers.Marker.Box(t)},createIcon:function(t,e,i,a){return new OpenLayers.Icon(t,e,i,a)},createImage:function(t,e,i,a){return OpenLayers.Util.createImage(t,e,i,a)},createLayerGeoJson:function(t,e,i){return MapUtils.createLayerVector(e,{projection:t.displayProjection,strategies:[new OpenLayers.Strategy.Fixed],protocol:new OpenLayers.Protocol.HTTP({url:i,format:new OpenLayers.Format.GeoJSON({})})})},createLayerKML:function(t,e,i){return MapUtils.createLayerVector(e,{projection:t.displayProjection,strategies:[new OpenLayers.Strategy.Fixed],protocol:new OpenLayers.Protocol.HTTP({url:i,format:new OpenLayers.Format.KML({extractStyles:!0,extractAttributes:!0,maxDepth:2})})})},createLayerGPX:function(t,e,i){return MapUtils.createLayerVector(e,{strategies:[new OpenLayers.Strategy.Fixed],projection:t.displayProjection,protocol:new OpenLayers.Protocol.HTTP({url:i,format:new OpenLayers.Format.GPX({extractStyles:!0,extractAttributes:!0,maxDepth:2})})})},createLayerImage:function(t,e,i,a,s){return new OpenLayers.Layer.Image(t,e,i,a,s)},createLayerWMS:function(t,e,i){return new OpenLayers.Layer.WMS(t,e,i)},createLayerXYZ:function(t,e,i){return new OpenLayers.Layer.XYZ(t,e,i)},createLayerMarkers:function(t,e){return new OpenLayers.Layer.Markers(t,e)},createLayerBoxes:function(t,e){return new OpenLayers.Layer.Boxes(t,e)},createLayerVector:function(t,e){return new OpenLayers.Layer.Vector(t,e)},createProjection:function(t){return new OpenLayers.Projection(t)},distance:function(t,e,i,a){const s=t*Math.PI/180,r=i*Math.PI/180,o=(i-t)*Math.PI/180,l=(a-e)*Math.PI/180,n=Math.sin(o/2)*Math.sin(o/2)+Math.cos(s)*Math.cos(r)*Math.sin(l/2)*Math.sin(l/2),h=6371e3*(2*Math.atan2(Math.sqrt(n),Math.sqrt(1-n)));return MapUtils.metersToFeet(h)},metersToFeet:function(t){return 3.28084*t},squareMetersToSquareFeet:function(t){return 10.7639*t},calculateArea:function(t){let e=0,i=t=>t*Math.PI/180;if(t.length>2){for(let a=0;a<t.length;a++){let s=t[a],r=a<t.length-1?t[a+1]:t[0];e+=i(r.x-s.x)*(2+Math.sin(i(s.y))+Math.sin(i(r.y)))}return e=6378137*e*6378137/2,e<0&&(e=-e),e=MapUtils.squareMetersToSquareFeet(e),e}return-1},squareFeetInASquareMile:27878400,symbols:{lightning:[0,0,4,2,6,0,10,5,6,3,4,5,0,0],rectangle:[0,0,4,0,4,10,0,10,0,0],church:[4,0,6,0,6,4,10,4,10,6,6,6,6,14,4,14,4,6,0,6,0,4,4,4,4,0],_x:[0,0,6,6,3,3,6,0,0,6,3,3],arrow:[0,0,5,10,10,0],plane:[5,0,5,0,4,1,4,3,0,5,0,6,4,5,4,8,2,10,3,10,5,9,5,9,8,10,8,10,6,8,6,5,10,6,10,5,6,3,6,1,5,0,5,0],arrow:[4,0,-2,10,12,10,6,0,4,0,-2,10,12,10,6,0]},initSymbols:function(){for(a in this.symbols)OpenLayers.Renderer.symbol[a]=this.symbols[a]}};MapUtils.defaults={maxLatValue:85,zoomLevels:40,defaultZoomLevel:-1,maxExtent:MapUtils.createBounds(-20037508,-20037508,20037508,20037508),sourceProjection:MapUtils.createProjection("EPSG:900913"),displayProjection:MapUtils.createProjection("EPSG:4326"),units:"m",doSphericalMercator:!0,wrapDateline:!0,location:MapUtils.createLonLat(0,0)},MapUtils.circleHiliteAttrs={strokeColor:"black",strokeWidth:1,fill:!0,fillOpacity:.5,fillColor:"red"};var RAMADDA_MAP_LAYERS=[],RAMADDA_MAP_LAYERS_MAP={};function MapLayer(t,e,i,a){this.opts=a??{},Utils.stringDefined(t)||(t=Utils.makeID(e)),this.id=t,Utils.stringDefined(e)||(e=Utils.makeLabel(t)),this.name=e,this.url=i,RAMADDA_MAP_LAYERS.push(this),RAMADDA_MAP_LAYERS_MAP[t]=this}MapLayer.prototype={isForMap:function(){return!Utils.isDefined(this.opts.isForMap)||this.opts.isForMap},createMapLayer:function(t){return this.opts.creator?this.opts.creator(this,t):"simple"==this.opts.type?t.makeSimpleWms(this.id):"wms"==this.opts.type?t.addWMSLayer(this.name,this.url,this.opts.layer,!Utils.isDefined(this.opts.isOverlay)||!this.opts.isOverlay):t.createXYZLayer(this.name,this.url,this.opts.attribution,this.opts.isOverlay)}};var map_default_layer="osm";new MapLayer("osm","OSM",["//a.tile.openstreetmap.org/${z}/${x}/${y}.png","//b.tile.openstreetmap.org/${z}/${x}/${y}.png","//c.tile.openstreetmap.org/${z}/${x}/${y}.png"]),new MapLayer("esri.topo","ESRI Topo","https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/${z}/${y}/${x}",{isForMap:!0}),new MapLayer("google.roads","Google Maps - Roads","https://mt0.google.com/vt/lyrs=m&hl=en&x=${x}&y=${y}&z=${z}"),new MapLayer("google.hybrid","Google Maps - Hybrid","https://mt0.google.com/vt/lyrs=y&hl=en&x=${x}&y=${y}&z=${z}"),new MapLayer("esri.street","ESRI Streets","https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/${z}/${y}/${x}"),new MapLayer("opentopo","OpenTopo","//a.tile.opentopomap.org/${z}/${x}/${y}.png}"),new MapLayer("usfs","Forest Service","https://caltopo.com/tile/f16a/${z}/${x}/${y}.png",{attribution:"Map from Caltopo"}),new MapLayer("caltopo.mapbuilder","MapBuilder Topo","https://img.caltopo.com/tile/mbt/${z}/${x}/${y}.png",{attribution:"Map from Caltopo"}),new MapLayer("usgs.topo","USGS Topo","https://basemap.nationalmap.gov/ArcGIS/rest/services/USGSTopo/MapServer/tile/${z}/${y}/${x}",{attribution:"USGS - The National Map"}),new MapLayer("google.terrain","Google Maps - Terrain","http://mt0.google.com/vt/lyrs=p&hl=en&x=${x}&y=${y}&z=${z}"),new MapLayer("google.satellite","Google Maps - Satellite","http://mt0.google.com/vt/lyrs=s&hl=en&x=${x}&y=${y}&z=${z}"),new MapLayer("naip","NAIP Imagery","https://caltopo.com/tile/n/${z}/${x}/${y}.png",{attribution:"Map from Caltopo"}),new MapLayer("usgs.imagery","USGS Imagery","https://basemap.nationalmap.gov/ArcGIS/rest/services/USGSImageryOnly/MapServer/tile/${z}/${y}/${x}",{attribution:"USGS - The National Map"}),new MapLayer("esri.shaded","ESRI Shaded Relief","https://server.arcgisonline.com/ArcGIS/rest/services/World_Shaded_Relief/MapServer/tile/${z}/${y}/${x}"),new MapLayer("esri.lightgray","ESRI Light Gray","https://services.arcgisonline.com/arcgis/rest/services/Canvas/World_Light_Gray_Base/MapServer/tile/${z}/${y}/${x}"),new MapLayer("esri.darkgray","ESRI Dark Gray","https://services.arcgisonline.com/arcgis/rest/services/Canvas/World_Dark_Gray_Base/MapServer/tile/${z}/${y}/${x}"),new MapLayer("esri.terrain","ESRI Terrain","https://server.arcgisonline.com/ArcGIS/rest/services/World_Terrain_Base/MapServer/tile/${z}/${y}/${x}"),new MapLayer("shadedrelief","Shaded Relief","https://caltopo.com/tile/hs_m315z45s3/${z}/${x}/${y}.png",{attribution:"Map from Caltopo"}),new MapLayer("publiclands","Public Lands","https://caltopo.com/tile/sma/${z}/${x}/${y}.png",{attribution:"Map from Caltopo",isOverlay:!0}),new MapLayer("historic","Historic","https://caltopo.com/tile/1900/${z}/${x}/${y}.png",{attribution:"Map from Caltopo",isOverlay:!0}),new MapLayer("esri.aeronautical","ESRI Aeronautical","https://wms.chartbundle.com/mp/service",{type:"wms",layer:"sec"}),new MapLayer("osm.toner","OSM-Toner","http://a.tile.stamen.com/toner/${z}/${x}/${y}.png"),new MapLayer("osm.toner.lite","OSM-Toner Lite","http://a.tile.stamen.com/toner-lite/${z}/${x}/${y}.png"),new MapLayer("watercolor","Watercolor","http://c.tile.stamen.com/watercolor/${z}/${x}/${y}.jpg"),new MapLayer("lightblue","","",{type:"simple"}),new MapLayer("blue","","",{type:"simple"}),new MapLayer("white","","",{type:"simple"}),new MapLayer("black","","",{type:"simple"}),new MapLayer("gray","","",{type:"simple"}),MapUtils.initSymbols();var ramaddaMapMap={};function ramaddaMapAdd(t){null==window.globalMapList&&(window.globalMapList=[]),window.globalMapList.push(t),ramaddaMapMap[t.mapId]=t}function ramaddaMapRemove(t){null==window.globalMapList&&(window.globalMapList=[]),window.globalMapList.push(t),delete ramaddaMapMap[t.mapId]}function ramaddaMapCheckLayout(){setTimeout((()=>{null!=window.globalMapList&&window.globalMapList.map((t=>{t.map.updateSize()}))}),1e3)}var ramaddaMapLastShareTime=0,ramaddaMapLastShareMap="";function ramaddaMapShareState(t,e){let i=(new Date).getTime();if(t.mapId!=ramaddaMapLastShareMap&&i-ramaddaMapLastShareTime<2e3)return;if(ramaddaMapLastShareTime=i,ramaddaMapLastShareMap=t.mapId,t.stateIsBeingSet)return;let a=t.params.linkGroup;if(t.params.linked||t.params.linkMouse||a){t.getBounds(),t.map.baseLayer,t.map.getZoom();for(var s=0;s<window.globalMapList.length;s++){var r=window.globalMapList[s];r.stateIsBeingSet||r.mapId==t.mapId||a==r.params.linkGroup&&(r.stateIsBeingSet=!0,r.receiveShareState(t,e),r.stateIsBeingSet=!1)}}}function RepositoryMap(t,e){ramaddaMapAdd(this);let i=this;e||(e={}),this.params=e,this.mapId=t||"map",e.mapCenter&&([lat,lon]=e.mapCenter.split(","),e.initialLocation={lon:lon,lat:lat});let a=!0;e.simple&&(a=!1);let s={pointRadius:3,strokeColor:"blue",strokeWidth:1,fillOpacity:.8,fillColor:"#e6e6e6",layerStrokeColor:"blue",layerStrokeWith:1,layerFillColor:"#ccc",layerFillOpacity:.3,highlightStrokeColor:"red",highlightFillColor:"blue",highlightStrokeWidth:2,highlightFillOpacity:.1,selectStrokeColor:null,selectFillColor:null,selectStrokeWidth:null,selectFillOpacity:.4,scrollToZoom:!0,selectOnHover:!1,highlightOnHover:!0,showLocationSearch:!1,imageOpacity:1,iconSize:null,iconWidth:null,iconHeight:null,tickSelectColor:"red",tickHoverColor:"blue",tickColor:"#888",showDates:!0,defaultMapLayer:map_default_layer,showLayerToggle:!1,showLatLonLines:!1,showScaleLine:a,showLayerSwitcher:a,showLatLonPosition:!1,showZoomPanControl:!1,showZoomOnlyControl:!0,showSearch:!1,showBookmarks:!1,showBounds:!0,showOpacitySlider:!1,doPopup:!0,doPopupSlider:!1,popupWidth:200,popupHeight:200,popupSliderRight:!1,doSelect:!0,enableDragPan:!0,linked:!1,linkGroup:null,linkMouse:!1};Utils.isDefined(e.initialZoom)||(e.initialZoom=Utils.isDefined(e.zoomLevel)?e.zoomLevel:MapUtils.defaults.defaultZoomLevel),$.extend(s,e),e=this.params=s,this.getProperty=(t,e)=>Utils.isDefined(this.params[t])?this.params[t]:e,$.extend(this,{name:"map",map:null,sourceProjection:MapUtils.defaults.sourceProjection,displayProjection:MapUtils.defaults.displayProjection,projectionUnits:MapUtils.defaults.units,mapDivId:this.mapId,defaultLocation:MapUtils.defaults.location,latlonReadout:null,haveAddedDefaultLayer:!1,defaultCanSelect:!0,layer:null,markers:null,vectors:null,allLayers:[],externalLayers:[],loadedLayers:[],nonSelectLayers:[],shareSelected:!1,boxes:null,kmlLayer:null,kmlLayerName:null,geojsonlLayer:null,geojsonLayerName:null,vectorLayers:[],features:{},lines:null,selectorBox:null,selectorMarker:null,listeners:[],fixedText:!1,initialLayers:[],imageLayers:{},imageLayersList:[]}),this.seenMarkers={},this.startDate=null,this.endDate=null,this.startFeature=null,this.endFeature=null,this.basePointStyle=null,this.defaultStyle={pointRadius:this.params.pointRadius,fillOpacity:this.params.fillOpacity,fillColor:this.params.fillColor,fill:this.params.fill,strokeColor:this.params.strokeColor,strokeWidth:this.params.strokeWidth},this.highlightStyle={strokeColor:this.params.highlightStrokeColor,strokeWidth:this.params.highlightStrokeWidth,fillColor:this.params.highlightFillColor,fillOpacity:this.params.highlightFillOpacity},Utils.isDefined(e.onSelect)?this.onSelect=e.onSelect:this.onSelect=null,e.initialLocation?(Array.isArray(e.initialLocation)?this.defaultLocation=MapUtils.createLonLat(e.initialLocation[1],e.initialLocation[0]):this.defaultLocation=MapUtils.createLonLat(e.initialLocation.lon,e.initialLocation.lat),debugBounds&&console.log("setting default location:"+this.defaultLocation)):Utils.isDefined(e.initialBounds)&&("string"==typeof e.initialBounds&&(e.initialBounds=e.initialBounds.split(",")),this.defaultBounds=MapUtils.createBounds(e.initialBounds[1],e.initialBounds[2],e.initialBounds[3],e.initialBounds[0]),this.defaultLocation=null,debugBounds&&console.log("setting default bounds-1:"+this.defaultBounds));var r={projection:this.sourceProjection,displayProjection:this.displayProjection,units:this.projectionUnits,controls:[],maxResolution:156543.0339,maxExtent:MapUtils.defaults.maxExtent,div:this.mapDivId,eventListeners:{featureover:function(t){i.featureOverHandler?i.featureOverHandler(t):i.handleFeatureover(t.feature)},featureout:function(t){i.featureOutHandler?i.featureOutHandler(t):i.handleFeatureout(t.feature)},nofeatureclick:function(t){i.handleNofeatureclick(t,t.layer)},featureclick:function(t){if(i.featureClickHandler&&!i.featureClickHandler(t))return;if(t.feature&&t.feature.noSelect)return;let e=(new Date).getTime();Utils.isDefined(i.lastClickTime)&&e-i.lastClickTime<500||(i.lastClickTime=e,i.handleFeatureclick(t.layer,t.feature,!1,t))}}};this.mapOptions=r,this.finishMapInit(),jQuery(document).ready((function(t){i.getMap()&&i.getMap().updateSize()}))}OpenLayers.Control.Click=OpenLayers.Class(OpenLayers.Control,{listeners:null,addListener:function(t){null==this.listeners&&(this.listeners=[]),this.listeners.push(t)},defaultHandlerOptions:{single:!0,double:!1,pixelTolerance:0,stopSingle:!1,stopDouble:!1},initialize:function(t){this.handlerOptions=$.extend({},this.defaultHandlerOptions),OpenLayers.Control.prototype.initialize.apply(this,arguments),this.handler=new OpenLayers.Handler.Click(this,{click:this.trigger},this.handlerOptions)},setLatLonZoomFld:function(t,e,i,a){this.lonFldId=t,this.latFldId=e,this.zoomFldId=i,this.clickListener=a},setTheMap:function(t){this.theMap=t},trigger:function(t){var e=this.theMap.getMap().getLonLatFromViewPortPx(t.xy),i=this.theMap.transformProjPoint(e);if(null!=this.listeners)for(var a=0;a<this.listeners.length;a++)this.listeners[a](i);this.lonFldId||(this.lonFldId="lonfld",this.latFldId="latfld",this.zoomFldId="zoomfld");let s=GuiUtils.getDomObject(this.lonFldId),r=GuiUtils.getDomObject(this.latFldId),o=GuiUtils.getDomObject(this.zoomFldId);r&&s&&(r.obj.value=MapUtils.formatLocationValue(i.lat),s.obj.value=MapUtils.formatLocationValue(i.lon)),o&&(o.obj.value=this.theMap.getMap().getZoom()),this.theMap.selectorMarker&&(this.theMap.removeMarker(this.theMap.selectorMarker),this.theMap.selectorMarker=this.theMap.addMarker(MapUtils.POSITIONMARKERID,i,"","","",20,10)),null!=this.clickListener&&this.clickListener.handleClick(this,t,i.lon,i.lat)}});var markerMap={};function ramaddaFindFeature(t,e){for(var i=0;i<t.features.length;i++){var a=t.features[i],s=a.geometry;if(s&&(bounds=s.getBounds(),bounds.contains(e.x,e.y)))if(s.components){for(var r=0;r<s.components.length;r++)if(comp=s.components[r],bounds=comp.getBounds(),bounds.contains(e.x,e.y)&&comp.containsPoint&&comp.containsPoint(e))return{feature:a,index:i}}else{if(!s.containsPoint){console.log("unknown geometry:"+s.CLASS_NAME);continue}if(s.containsPoint(e))return{feature:a,index:i}}}return null}RepositoryMap.prototype={firstCustomRegion:!0,CUSTOM_MAP:"CUSTOM",centerOnMarkers:function(t,e,i){debugBounds&&console.log("centerOnMarkers: force="+e+" dflt:"+t+" justMarkers:"+i),this.centerOnMarkersCalled=!0,this.centerOnMarkersForce=e;Date.now();let a=null;if(t&&(t.left<-180||t.left>180||t.right<-180||t.right>180||t.bottom<-90||t.bottom>90||t.top<-90||t.top>90)&&(t=MapUtils.createBounds(-180,-90,180,90)),this.dfltBounds=t,!e){let t=!1;if(this.externalLayers.forEach((e=>{let i=e.getDataExtent();debugBounds&&console.log("centerOnMarkers using external layer"),a=this.transformProjBounds(i),t=!0})),this.markers){let e=this.markers.getDataExtent();debugBounds&&console.log("centerOnMarkers using markers.getDataExtent"),a=this.transformProjBounds(e),t=!0}if(a&&isNaN(a.left)&&(a=null),this.circles){let e=this.circles.getDataExtent(),i=this.transformProjBounds(e);a?a.extend(i):a=i,t=!0,debugBounds&&console.log("centerOnMarkers using circles.getDataExtent:"+i)}if(a&&isNaN(a.left)&&(a=null),!a||!t||!i){if(this.lines){let t=this.lines.getDataExtent(),e=this.transformProjBounds(t);a?a.extend(e):a=e,debugBounds&&console.log("centerOnMarkers using lines.getDataExtent")}for(let t in this.getMap().layers){if(t=this.getMap().layers[t],!t.getDataExtent)continue;if(t.isBaseLayer||!t.getVisibility())continue;let e=t.getDataExtent();if(e){let i=this.transformProjBounds(e);a?a.extend(i):a=i,debugBounds&&console.log("centerOnMarkers using layer.getDataExtent: "+i+" layer="+t.name+" "+t.ramaddaId)}}}}if(a||(debugBounds&&console.log("centerOnMarkers using dfltBounds: "+t),a=t),a){if(!this.getMap())return this.defaultBounds=a,void(debugBounds&&console.log("centerOnMarkers: no map"));a.getHeight()>160&&(a.top=80,a.bottom=-80,debugBounds&&console.log("centerOnMarkers resetting height")),debugBounds&&console.log("calling setViewToBounds: "+a),this.setViewToBounds(a)}else debugBounds&&console.log("centerOnMarkers: no bounds")},initRegionSelector:function(t,e,i){this.regionSelector=$("#"+t),this.mapWidgetDiv=$("#"+e),this.mapWidgetDiv.hide(),$(document).ready((()=>{this.regionSelector.val()!=this.CUSTOM_MAP?this.mapWidgetDiv.hide():this.initMap(i),this.regionSelector.change((()=>{this.mapRegionSelected()})),this.mapRegionSelected()}))},mapRegionSelected:function(){let t=this.regionSelector.val();if(null===t)return void console.log("Error: No map region value");if(""==t)return void this.toggleMapWidget(!1);let e=t.split(",");if(1==e.length)return e[0]!=this.CUSTOM_MAP?void 0:(this.firstCustomRegionm||this.setMapRegion("","","","",""),this.firstCustomRegion=!1,void this.toggleMapWidget(!0));5==e.length&&(this.toggleMapWidget(!1),this.setMapRegion(e[0],e[1],e[2],e[3],e[4]))},setMapRegion:function(t,e,i,a,s){let r=this.mapId;$("#"+r+"_regionid").val(t),$("#"+r+"_north").val(e),$("#"+r+"_west").val(i),$("#"+r+"_south").val(a),$("#"+r+"_east").val(s)},toggleMapWidget:function(t){t?(this.inited||this.initMap(!0),this.mapWidgetDiv.show()):this.mapWidgetDiv.hide()},setViewToBounds:function(t){let e=this.transformLLBounds(t);0==e.getWidth()?(debugBounds&&console.log("setViewToBounds center"),this.getMap().setCenter(e.getCenterLonLat())):(this.getMap().setCenter(e.getCenterLonLat()),this.zoomToExtent(e))},setCenter:function(t){debugBounds&&console.log("setCenter"),this.getMap().panTo(this.transformLLPoint(t))},getZoom:function(){return this.getMap().getZoom()},setZoom:function(t){debugBounds&&console.log("setZoom"),this.getMap().zoomTo(t)},zoomToMarkers:function(){this.markers&&(bounds=this.markers.getDataExtent(),null!=bounds&&(this.getMap().setCenter(bounds.getCenterLonLat()),this.zoomToExtent(bounds)))},zoomToExtent:function(t,e){if(debugBounds&&console.log("zoomToExtent:"+t),isNaN(t.left)||isNaN(t.right)||isNaN(t.top)||isNaN(t.bottom))console.error("zoomToExtent: bounds are bad:"+t);else if(t.left!=t.right&&t.top!=t.bottom)this.getMap().zoomToExtent(t,e);else{t=this.transformProjBounds(t),console.log("centered:"+t);var i=t.getCenterLonLat();this.setCenter(i)}},centerToMarkers:function(){this.markers&&(bounds=this.markers.getDataExtent(),debugBounds&&console.log("centerToMarkers"),this.getMap().setCenter(bounds.getCenterLonLat()))},setInitialCenterAndZoom:function(t,e,i){this.defaultLocation=MapUtils.createLonLat(t,e),this.params.initialZoom=i},setInitialZoom:function(t){this.params.initialZoom=t},setInitialCenter:function(t,e){this.defaultLocation=MapUtils.createLonLat(t,e)},finishMapInit:function(){let t=this;if(this.params.showSearch){this.searchDiv=this.mapDivId+"_search";var e=HtmlUtils.checkbox(this.searchDiv+"_download",[],!1),i="<table width=100%><tr><td>"+('<input placeholder="Search - ? for help" id="'+this.searchDiv+'_input" size=40>')+' <span  id="'+this.searchDiv+'_message"></span></td><td align=right>'+e+" Download</td></tr></table>";$("#"+this.searchDiv).html(i),this.searchMsg=$("#"+this.searchDiv+"_message");var a=$("#"+this.searchDiv+"_input");a.keypress((function(e){13==e.which&&t.searchFor(a.val())}))}let s=t=>this.mapDivId+"_"+t,r=HU.open("table",[STYLE,HU.css("height","100%"),WIDTH,"100%","border","0"]),o=HtmlUtils.div([CLASS,"ramadda-map-inner","style","width:100%;height:100%;position:relative;","id",s("themap")]);r+=HU.tr([STYLE,HU.css("height","100%")],HU.td([WIDTH,"100%"],o)),r+="</table>",$("#"+this.mapDivId).html(o),$("#"+s("themap")).append(HtmlUtils.div(["id",s("progress"),CLASS,"ramadda-map-progess","style","z-index:3000;position:absolute;top:10px;left:50px;"],"")),$("#"+s("themap")).append(HtmlUtils.div(["id",s("label"),"style","z-index:1000;position:absolute;bottom:10px;left:10px;"],"")),$("#"+s("themap")).append(HtmlUtils.div(["id",s("toolbar"),"style","z-index:1000;position:absolute;top:10px;left:50%;    transform: translateX(-50%);"],"")),this.map=new OpenLayers.Map(this.mapDivId+"_themap",this.mapOptions);setTimeout((function(){t.getMap().events.register("changebaselayer","",(function(){t.baseLayerChanged()})),t.getMap().events.register("zoomend","ramaddamap",(function(){t.zoomChanged(),t.locationChanged(),t.setNoPointerEvents()})),t.getMap().events.register("moveend","ramaddamap",(function(){t.locationChanged()})),t.getMap().events.register("move","ramaddamap",(function(){t.locationChanged()}))}),2e3),this.mapHidden&&(this.getMap().size=MapUtils.createSize(1,1));try{window.initExtraMap&&initExtraMap(this)}catch(t){console.log("Error calling initExtraMap:"+t)}if(this.addBaseLayers(),this.kmlLayer){var l=ramaddaBaseUrl+"/entry/show?output=shapefile.kml&entryid="+this.kmlLayer;this.addKMLLayer(this.kmlLayerName,l,!1,null,null,null,null)}if(this.geojsonLayer){l=getRamadda().getEntryDownloadUrl(this.geojsonLayer);this.addGeoJsonLayer(this.geojsonLayerName,l,!1,null,null,null,null)}Utils.addDisplay(this);setTimeout((()=>{let e="Image Opacity:&nbsp;"+HU.div([ID,this.mapDivId+"_opacity_slider_div",STYLE,HU.css("display","inline-block","width","150px")],"");e=HU.span(["id",this.mapDivId+"_opacity_slider","style",this.params.showOpacitySlider?"display:inline":"display:none"],e),$("#"+this.mapDivId+"_header").append(e),$("#"+this.mapDivId+"_opacity_slider_div").slider({min:0,max:1,step:.05,value:t.params.imageOpacity,slide:function(e,i){t.params.imageOpacity=i.value,t.imageLayersList&&(t.allLayers.forEach((e=>{Utils.isDefined(e.canTakeOpacity)&&e.setOpacity(t.params.imageOpacity)})),t.imageLayersList.forEach((e=>{e.setOpacity(t.params.imageOpacity)})))}})}),200),setTimeout((()=>{let t=document.querySelector("#"+this.mapDivId+"_themap");t&&new ResizeObserver(Utils.throttle((()=>{this.getMap()&&this.getMap().updateSize()}),1e3)).observe(t)}),1e3)},showOpacitySlider:function(t){this.params.showOpacitySlider=t,t?$("#"+this.mapDivId+"_opacity_slider").css("display","inline"):$("#"+this.mapDivId+"_opacity_slider").css("display","none")},getBounds:function(){return this.transformProjBounds(this.getMap().getExtent())},zoomChanged:function(){},receiveShareState:function(t,e){if(e.center){if(!this.params.linked)return;this.getMap().setCenter(e.center,e.zoom)}else if(e.mouse){if(!this.params.linkMouse)return;this.sharedMouse&&this.getMarkersLayer().removeFeatures([this.sharedMouse],{silent:!0}),this.sharedMouse=this.addPoint("mouse",e.mouse,{},"")}},locationChanged:function(){ramaddaMapShareState(this,{center:this.map.getCenter(),zoom:this.map.getZoom()}),this.pendingLocationChangeTimeout&&clearTimeout(this.pendingLocationChangeTimeout),this.pendingLocationChangeTimeout=setTimeout((()=>{this.locationChangedInner(),this.pendingResizeTimeout=null}),500)},locationChangedInner:function(){let t=this.getBounds(),e=1e5,i=t=>Math.round(t*e)/e;t.top=i(t.top),t.left=i(t.left),t.bottom=i(t.bottom),t.right=i(t.right),HU.addToDocumentUrl("map_bounds",t.top+","+t.left+","+t.bottom+","+t.right),HU.addToDocumentUrl("zoomLevel",this.getMap().getZoom());let a=this.transformProjPoint(this.getMap().getCenter());HU.addToDocumentUrl("mapCenter",i(a.lat)+","+i(a.lon))},baseLayerChanged:function(){let t=this.getMap().baseLayer;t&&(t=t.ramaddaId,HU.addToDocumentUrl("defaultMapLayer",t),ramaddaMapShareState(this,"baseLayer"))},appendToolbar:function(t){$("#"+this.mapDivId+"_toolbar").append(t)},setMapDiv:function(t){this.mapHidden=!1,this.mapDivId=t,this.getMap().render(this.mapDivId),this.getMap().updateSize(),this.centerOnMarkers(this.dfltBounds)},makePopup:function(t,e,i){debugPopup&&console.log("makePopup"),i=i||{};let a=MapUtils.createSize(i.width||this.params.popupWidth||200,i.height||this.params.popupHeight||200);return new OpenLayers.Popup("popup",t,a,e,!0,i.callback?i.callback:()=>{this.onPopupClose()})},highlightMarkers:function(t,e,i,a){let s=this;e||(e="#ffffcc"),$(t).mouseenter((function(){e&&$(this).css("background",e),$(this).data("mapid")&&(s.circleMarker($(this).data("mapid"),MapUtils.circleHiliteAttrs)||null!=a&&(Utils.isDefined($(this).data("latitude"))?(attrs={pointRadius:12,stroke:!0,strokeColor:"blue",strokeWidth:2,fill:!1},point=s.addPoint(a,MapUtils.createLonLat($(this).data("longitude"),$(this).data("latitude")),attrs),markerMap[a]=point):console.log("no lat")))})),$(t).mouseleave((function(){i?$(this).css("background",i):$(this).css("background","transparent"),$(this).data("mapid")&&(a&&markerMap[a]&&(s.removePoint(markerMap[a]),markerMap[a]=null),s.uncircleMarker($(this).data("mapid")))}))},getLayerHighlightStyle:function(t){let e=$.extend({},this.highlightStyle);return t.highlightStyle&&$.extend(e,t.highlightStyle),e},handleFeatureover:function(t,e){if(this.doMouseOver||t.highlightText||t.highlightTextGetter){var i=t.location;if(i&&this.highlightFeature!=t){this.closeHighlightPopup();var a=this.transformLLPoint(i);let e=t.highlightTextGetter?t.highlightTextGetter(t):t.highlightText;Utils.stringDefined(e)||(e=t.text),Utils.stringDefined(e)&&(e=HtmlUtils.div(["style","padding:2px;"],e),this.highlightPopup=new OpenLayers.Popup("popup",a,t.highlightSize,e,!1),this.highlightPopup.backgroundColor=this.highlightBackgroundColor||"#ffffcc",this.highlightPopup.autoSize=!0,this.highlightPopup.keepInMap=!0,this.highlightPopup.padding=0,this.getMap().addPopup(this.highlightPopup))}}var s=t.layer;if(!0===s.isMapLayer){if(!1!==s.canSelect&&!s.noHighlight){var r=this;if(!t.isSelected){t.originalStyle=t.style,t.style=null;let i=this.getLayerHighlightStyle(s);if("transparent"!=i.fillColor&&t.originalStyle&&(i.fillColor=Utils.brighterColor(t.originalStyle.fillColor||i.fillColor,.4)),i.fillColor||(i.fillColor="blue"),Utils.isDefined(i.fillOpacity)||(i.fillOpacity=.3),s.drawFeature(t,i),this.params.displayDiv){this.displayedFeature=t;e||setTimeout((function(){if(r.displayedFeature==t){let e=r.getFeatureText(s,t);r.showText(e),r.dateFeatureOver(t)}}),500)}}}}else!e&&t.text&&this.showFeatureText(t)},closeHighlightPopup:function(){this.highlightPopup&&(this.getMap().removePopup(this.highlightPopup),this.highlightPopup.destroy(),this.highlightPopup=null,this.highlightFeature=null)},handleFeatureout:function(t,e){this.closeHighlightPopup();let i=t.layer;i&&!0!==i.isMapLayer?e||t.text&&!this.fixedText&&this.hideFeatureText(t):null!=i&&!1!==i.canSelect&&(t.style=t.originalStyle,t.isSelected||i.drawFeature(t,t.style||"default"),this.dateFeatureOut(t),e||this.displayedFeature!=t||this.fixedText||this.params.displayDivSticky||this.showText(""))},getLayerCanSelect:function(t){return!!t&&t.canSelect},handleNofeatureclick:function(t,e){if(Utils.isDefined(this.lastClickTime)){if((new Date).getTime()-this.lastClickTime<2e3)return}this.closePopup(),HtmlUtils.hidePopupObject(),!1!==e.canSelect&&e&&e.selectedFeature&&(this.unselectFeature(e.selectedFeature),this.clearDateFeature())},handleFeatureclick:function(t,e,i,a){if(t||(t=e.layer),debugPopup&&console.log("handleFeatureClick"),this.dateFeatureSelect(e),!1===t.canSelect)return void(debugPopup&&console.log("\tlayer no select"));if(t.selectedFeature&&this.unselectFeature(t.selectedFeature),!this.params.doSelect)return void(debugPopup&&console.log("\tparams no select"));this.selectedFeature=e,t.selectedFeature=e,t.selectedFeature.isSelected=!0;let s=$.extend({},e.style),r=this.getLayerHighlightStyle(t);if($.extend(s,{strokeColor:this.params.selectStrokeColor||r.strokeColor,strokeWidth:this.params.selectStrokeWidth||r.strokeWidth,strokeOpacity:this.params.selectStrokeOpacity||.75,fillOpacity:this.params.selectFillOpacity||r.fillOpacity,fill:!0}),"transparent"!=s.fillColor&&(s.fillColor=this.params.selectFillColor||r.fillColor),Utils.isDefined(s.pointRadius)&&(s.pointRadius=Math.round(1.5*s.pointRadius)),e.style&&e.style.externalGraphic&&(s=$.extend({},e.style),Utils.isDefined(s.graphicHeight)&&(s.graphicHeight*=1.5,s.graphicYOffset=-s.graphicHeight/2),Utils.isDefined(s.graphicWidth)&&(s.graphicWidth*=1.5,s.graphicXOffset=-s.graphicWidth/2)),t.drawFeature(t.selectedFeature,s),t.selectCallback?(t.feature=t.selectedFeature,e.originalStyle&&(e.style=e.originalStyle),debugPopup&&console.log("\thave a selectCallback"),t.selectCallback(t,a)):(debugPopup&&console.log("\tcalling showMarkerPopup"),this.showMarkerPopup(e,!0)),i){var o=e.geometry;if(o){var l=o.getBounds();l&&(this.zoomToExtent(l),this.getMap().setCenter(l.getCenterLonLat()))}}},unselectFeature:function(t){if(!t)return;t.renderIntent=null,t.isSelected=!1;let e=t.layer;e&&(e.drawFeature(e.selectedFeature,e.selectedFeature.style||"default"),e.selectedFeature.isSelected=!1,e.selectedFeature=null,this.selectedFeature=null,this.onPopupClose())},handleEntrySelect:function(t,e,i){if("geo_kml"!=i&&"geo_json"!=i&&"geo_shapefile"!=i)return null;var a;if("geo_kml"==i){var s=ramaddaBaseUrl+"/entry/get?entryid="+t;a=this.addKMLLayer(e,s,!0,null,null,null,null,!0)}else if("geo_json"==i){s=ramaddaBaseUrl+"/entry/get?entryid="+t;a=this.addGeoJsonLayer(e,s,!0,null,null,null,null,!0)}else{s=ramaddaBaseUrl+"/entry/show?output=shapefile.kml&entryid="+t;a=this.addKMLLayer(e,s,!0,null,null,null,null,!0)}return a},findLayer:function(t){for(var e=0;e<this.getMap().layers.length;e++)if(this.getMap().layers[e].ramaddaId==t)return this.getMap().layers[e];return null},addLayer:function(t,e){this.allLayers.push(t),t.initialVisibility=t.getVisibility(),null!=this.map?(this.getMap().addLayer(t),e&&this.nonSelectLayers.push(t),this.checkLayerOrder()):this.initialLayers.push(t)},toFrontLayer:function(t){Utils.toFront(this.nonSelectLayers,t),this.checkLayerOrder()},toBackLayer:function(t){Utils.toBack(this.nonSelectLayers,t),this.checkLayerOrder()},checkLayerOrder:function(){let t=this.numberOfBaseLayers;var e=!1;this.nonSelectLayers.forEach((e=>{this.getMap().setLayerIndex(e,t++)})),this.loadedLayers.forEach((e=>{this.getMap().setLayerIndex(e,t++)})),this.externalLayers.forEach((e=>{e.ramaddaLayerIndex?this.getMap().setLayerIndex(e,e.ramaddaLayerIndex):this.getMap().setLayerIndex(e,t++)})),this.boxes&&this.getMap().setLayerIndex(this.boxes,t++),this.lines&&this.getMap().setLayerIndex(this.lines,t++),this.circles&&this.getMap().setLayerIndex(this.circles,t++),this.markers&&this.getMap().setLayerIndex(this.markers,t++),this.labelLayer&&this.getMap().setLayerIndex(this.labelLayer,t++)},addImageLayer:function(t,e,i,a,s,r,o,l,n,h,d,u){let c={forSelect:!1,addBox:!0,isBaseLayer:!1};u&&$.extend(c,u),r>88&&(r=88),l<-88&&(l=-88);let p=MapUtils.createBounds(o,l,n,r),m=this.transformLLBounds(p),f=MapUtils.createLayerImage(e,a,m,MapUtils.createSize(h,d),{numZoomLevels:3,isBaseLayer:c.isBaseLayer,resolutions:this.getMap().layers[0]?this.getMap().layers[0].resolutions:null,maxResolution:this.getMap().layers[0]?this.getMap().layers[0].resolutions[0]:null});f.id=t,f.latLonBounds=p,c.forSelect&&(this.selectImage=f);let g=MapUtils.createLonLat(o,r);return f.lonlat=this.transformLLPoint(g),f.setVisibility(s),f.id=t,f.text=this.getPopupText(i),f.ramaddaId=t,f.ramaddaName=e,this.addLayer(f,!0),f.north=r,f.west=o,f.south=l,f.east=n,f.opacity=this.params.imageOpacity,this.imageLayers||(this.imageLayers={}),c.isBaseLayer||(this.imageLayers[t]=f,this.imageLayersList.push(f)),this.noPointerEventsLayers||(this.noPointerEventsLayers=[]),this.noPointerEventsLayers.push(f),this.setNoPointerEvents(),f},setNoPointerEvents:function(){this.noPointerEventsLayers&&setTimeout((()=>{this.noPointerEventsLayers.forEach((t=>{if(t.div)for(var e=t.div.childNodes,i=0,a=e.length;i<a;++i){var s=e[i].firstChild||e[i],r=e[i].lastChild;r&&"iframe"===r.nodeName.toLowerCase()&&(s=r.parentNode),s.style["pointer-events"]="none"}}))}),1e3)},addWMSLayer:function(t,e,i,a,s,r){r||(r={});let o={wrapDateLine:MapUtils.defaults.wrapDateline};r.opacity&&(o.opacity=r.opacity);i=MapUtils.createLayerWMS(t,e,{layers:i,format:"image/png",isBaseLayer:!1,srs:"epse:4326",transparent:!0},o);return a?(i.isBaseLayer=!0,i.visibility=!1):(i.isBaseLayer=!1,i.visibility=r.visible),this.addLayer(i,s),i},addMapLayer:function(t,e,i,a,s){(i=/\/tile\//.exec(e)?MapUtils.createLayerXYZ(t,e,{sphericalMercator:MapUtils.defaults.doSphericalMercator,numZoomLevels:MapUtils.defaults.zoomLevels,wrapDateLine:MapUtils.defaults.wrapDateline}):MapUtils.createLayerWMS(t,e,{layers:i,format:"image/png"},{wrapDateLine:MapUtils.defaults.wrapDateline})).isBaseLayer=!!a,i.visibility=!1,i.reproject=!0,this.addLayer(i),s&&(this.haveAddedDefaultLayer=!0,this.getMap().setLayerIndex(i,0),this.getMap().setBaseLayer(i))},getVectorLayerStyleMap:function(t,e,i){var a={pointRadius:this.params.pointRadius,fillOpacity:this.params.fillOpacity,fillColor:this.params.fillColor,fill:this.params.fill,strokeColor:this.params.strokeColor,strokeWidth:this.params.strokeWidth,select_fillOpacity:this.params.fillOpacity,select_fillColor:"#666",select_strokeColor:"#666",select_strokeWidth:1};e&&RamaddaUtil.inherit(a,e);var s=$.extend({},MapUtils.getVectorStyle("temporary"));$.extend(s,{pointRadius:a.pointRadius,fillOpacity:a.fillOpacity,strokeWidth:a.strokeWidth,strokeColor:a.strokeColor});var r=$.extend({},MapUtils.getVectorStyle("select"));$.extend(r,{pointRadius:3,fillOpacity:a.select_fillOpacity,fillColor:a.select_fillColor,strokeColor:a.select_strokeColor,strokeWidth:a.select_strokeWidth});var o=$.extend({},MapUtils.getVectorStyle("default"));$.extend(o,{pointRadius:a.pointRadius,fillOpacity:a.fillOpacity,fillColor:a.fillColor,fill:a.fill,strokeColor:a.strokeColor,strokeWidth:a.strokeWidth});let l=MapUtils.createStyleMap({temporary:s,default:o,select:r});i=i||this.getProperty("rules");let n=[];if(Utils.isDefined(i)){if(!Array.isArray(i)){let t=[];Utils.split(i,";",!0,!0).forEach((e=>{let i=Utils.split(e,":");if(i.length<3)return void console.log("bad rule:"+e);let a={property:i[0],type:i[1],value:i[2],style:{}};for(let t=3;t<i.length;t+=2)a.style[i[t]]=i[t+1];t.push(a)})),i=t}n=i}if(n.length>0){let t=[];n.forEach((e=>{let i=$.extend({},o),a=e.style;if("string"==typeof a){let t={};Utils.split(a,"\n",!0,!0).forEach((e=>{let i=Utils.split(e,":",!0,!0);2==i.length&&(t[i[0]]=i[1])})),a=t}i=$.extend(i,a),e.value=String(e.value??"");let s=e.value.match(/^\d*\.?\d*$/),r=("~="==e.type||e.type,{property:e.property,type:e.type});if(e.type==OpenLayers.Filter.Comparison.BETWEEN){let t=Utils.split(String(e.value),":",!0,!0);2==t.length&&(r.lowerBoundary=+t[0],r.upperBoundary=+t[1])}else r.value=s?+e.value:e.value;e=new OpenLayers.Rule({filter:new OpenLayers.Filter.Comparison(r),symbolizer:i});t.push(e),t.push(new OpenLayers.Rule({elseFilter:!0}))})),l.styles.default.addRules(t)}return l},getFeatureName:function(t){var e=t.attributes;for(var i in e){if((""+i).toLowerCase().includes("label"))if(a=this.getAttrValue(e,i))return a}for(var i in e){var a;if((""+i).toLowerCase().includes("name"))if(a=this.getAttrValue(e,i))return a}},getAttrValue:function(t,e){let i="";if("object"==typeof t[e]||"Object"==typeof t[e]){let a=t[e];a&&(i=""+a.value)}else i=""+t[e];return i},searchFor:function(t){t&&(t=t.trim()),""==t&&(t=null),this.searchText=t;let e=null,i=!1,a=$("#"+this.searchDiv+"_download").is(":checked"),s=[],r=!0;if(t){"?"==(t=t.trim())&&(i=!0),e=[];let a=(t=t.toLowerCase()).split("|");1==a.length&&(a=t.split("&"),r=1==a.length);for(let t=0;t<a.length;t++){let i=!1,s=!1,r=a[t],o=r.split(":"),l="",n=r;o.length>1&&(l=o[0],n=o[1]),n.startsWith("!")&&(i=!0,n=n.substring(1)),n.startsWith("=")&&(n=n.substring(1),s=!0),e.push({field:l,value:n,not:i,equals:s})}}else this.searchMsg.html("");for(let o in this.loadedLayers){let l=this.loadedLayers[o];l.selectedFeature&&this.handleNofeatureclick(null,l);for(let a in l.features){let o=l.features[a],n=o.attributes;if(!t){o.featureVisibleSearch=!0,s.push(n);continue}if(i){let t="&nbsp;&nbsp;&nbsp;",e="Enter, e.g.:<br>";e+=t+"<i>&lt;term&gt;</i> (any match)<br>",e+=t+"<i>=&lt;term&gt;</i> (exact match)<br>",e+=t+"<i>!&lt;term&gt;</i> (not match)<br>",e+=t+"<i>&lt;term 1&gt;|&lt;term 2&gt;</i> (match any)<br>",e+=t+"<i>&lt;term 1&gt;&amp;&lt;term 2&gt;</i> (match all)<br>",e+="Or by field:<br>";for(let i in n)e+=t+i.toLowerCase()+":<i>&lt;term&gt;</i><br>";return void this.showText(e)}let h=!1,d=!0,u=!1;for(let t in e){let i=e[t];for(let t in n){if(""!=i.field&&i.field!=t.toLowerCase())continue;let e=this.getAttrValue(n,t);if(e=e.toLowerCase().trim(),h=i.equals?e==i.value:e.includes(i.value),i.not){if(h=!h,!h)break}else if(h)break}h&&(u=!0),h||(d=!1)}r&&u||!r&&d?(o.featureVisibleSearch=!0,this.getFeatureVisible(o)&&s.push(n)):o.featureVisibleSearch=!1}if(this.centerOnMarkers(),a){let t="";for(let e in s){let i=s[e];for(let e in i)""!=t&&(t+=","),t+=e.toLowerCase();t+="\n";break}for(let e in s){let i=s[e],a="";for(let t in i){let e=this.getAttrValue(i,t);e.includes(",")&&(e='"'+e+'"'),""!=a&&(a+=","),a+=e}a+="\n",t+=a}Utils.makeDownloadFile("download.csv",t)}this.setFeatureVisibility(l)}},checkFeatureVisible:function(t,e,i){let a=t.layer,s=this.getFeatureVisible(t);t.originalStyle&&(t.style=t.originalStyle);let r=t.style;if(!r){r={};let e=a?a.styleMap.styles.default.defaultStyle:{};$.extend(r,e),t.style=r}return r.display=s?"inline":"none",e&&(t.isSelected||(t.renderIntent=null),a&&a.drawFeature(t,t.style||"default")),s},getFeatureVisible:function(t){let e=!0;return Utils.isDefined(t.featureVisibleSearch)&&!t.featureVisibleSearch&&(e=!1),Utils.isDefined(t.featureVisibleDate)&&!t.featureVisibleDate&&(e=!1),Utils.isDefined(t.featureVisible)&&!t.featureVisible&&(e=!1),e},setFeatureVisibility:function(t){let e=this,i=this.searchText||this.startDate&&this.endDate,a=null,s="",r=!1,o=!1,l=0,n=null;for(let e=0;e<t.features.length;e++){let i=t.features[e];if(this.checkFeatureVisible(i,!1)){this.dateFeatureSelect(i),r=!0,l++,n||(n=i),s+=HtmlUtils.div(["class","ramadda-map-feature","feature-index",""+e],this.getFeatureName(i));let t=i.geometry;if(t){let e=t.getBounds();a?a.extend(e):a=e}}else this.clearDateFeature(i),o=!0}if(1==l)this.showText(this.getFeatureText(t,n));else if(i||r&&o){let i=this.mapDivId+"_features";this.showText(HtmlUtils.div(["id",i,"class","ramadda-map-features"],s)),$("#"+i+" .ramadda-map-feature").click((function(i){let a=parseInt($(this).attr("feature-index"));e.handleFeatureclick(t,t.features[a],!0)})),$("#"+i+" .ramadda-map-feature").mouseover((function(){let i=parseInt($(this).attr("feature-index"));e.handleFeatureover(t.features[i],!0)})),$("#"+i+" .ramadda-map-feature").mouseout((function(){let i=parseInt($(this).attr("feature-index"));e.handleFeatureout(t.features[i],!0)}))}else this.clearDateFeature(),this.params.displayDivSticky||this.showText("");this.searchMsg&&(i?this.searchMsg.html(l+" matched"):this.searchMsg.html("")),t.redraw(),a?(this.zoomToExtent(a),this.getMap().setCenter(a.getCenterLonLat())):this.centerOnMarkers(this.dfltBounds,this.centerOnMarkersForce)},getFeatureText:function(t,e){if(e.textGetter){let t=e.textGetter(e);if(t)return debugPopup&&console.log("getFeatureText-feature has textGetter:"),t}if(this.textGetter){let i=this.textGetter(t,e);if(i)return debugPopup&&console.log("getFeatureText-map has textGetter:"+this.textGetter),i}let i=e.style||e.originalStyle||t.style,a=e.attributes,s=e.popupText;if(!s)if(i&&i.balloonStyle){s=i.balloonStyle;for(let t in a){t.replace("_"," ");let e="";if("object"==typeof a[t]||"Object"==typeof a[t]){e=""+a[t].value}else e=""+a[t];s=s.replace("${"+i.id+"/"+t+"}",e)}}else{debugPopup&&console.log("getFeatureText-using feature attributes"),s="<table>";for(let t in a){let e,i=t;if(lclabel=i.toLowerCase(),"objectid"!=lclabel&&"feature_type"!=lclabel&&"shapearea"!=lclabel&&"styleurl"!=lclabel&&"shapelen"!=lclabel){if("startdate"==lclabel?i="Start Date":"enddate"==lclabel?i="End Date":"aland"==lclabel?i="Land Area":"awater"==lclabel&&(i="Water Area"),i=i.replace(/_/g," "),i=Utils.camelCase(i),s+='<tr valign=top><td align=right><div style="margin-right:5px;margin-bottom:3px;"><b>'+HU.span(["title",t],i)+':</b></div></td><td><div style="margin-right:5px;margin-bottom:3px;">',null==a[t]||"object"!=typeof a[t]&&"Object"!=typeof a[t])e=""+a[t];else{e=""+a[t].value}(e.startsWith("http:")||e.startsWith("https:"))&&(e="<a href='"+e+"'>"+e+"</a>"),"null"!=e&&(s+=e,s+="</div></td></tr>")}}s+="</table>"}return s},onFeatureSelect:function(t,e){debugPopup&&console.log("\tonFeatureSelect");if(this.onSelect)return func=window[this.onSelect],func(this,t),void(debugPopup&&console.log("\thas onSelect"));let i=t.feature;if(this.featureSelectHandler&&!this.featureSelectHandler(i))return void(debugPopup&&console.log("\thas featureSelectHandler"));if(!this.getDoPopup())return;let a=this.getFeatureText(t,i);if(!a)return void(debugPopup&&console.log("\tno feature text"));debugPopup&&console.log("\thas feature text"),this.currentPopup&&(this.getMap().removePopup(this.currentPopup),this.currentPopup.destroy());let s=null;if(e&&e.event&&e.event.xy&&(s=this.getMap().getLonLatFromPixel(e.event.xy)),null==s&&(s=i.geometry.getBounds().getCenterLonLat()),this.showPopupSlider(s,a))return;let r=this.makePopup(s,a);i.popup=r,r.feature=i,this.getMap().addPopup(r),this.currentPopup=r},onFeatureUnselect:function(t){this.onPopupClose()},removeKMLLayer:function(t){this.removeLayer(t)},removeLayer:function(t,e){this.externalLayers=Utils.removeItem(this.externalLayers,t),this.allLayers=Utils.removeItem(this.allLayers,t),this.nonSelectLayers&&(this.nonSelectLayers=Utils.removeItem(this.nonSelectLayers,t)),this.loadedLayers&&(this.loadedLayers=Utils.removeItem(this.loadedLayers,t)),this.imageLayersList&&(this.imageLayersList=Utils.removeItem(this.imageLayersList,t)),e||this.getMap().removeLayer(t)},setDefaultCanSelect:function(t){this.defaultCanSelect=t},getCanSelect:function(t){return void 0===t||null==t?this.defaultCanSelect:t},addSelectCallback:function(t,e,i,a){let s=this;this.getCanSelect(e)&&(null!=i&&Utils.isDefined(i)||(i=function(t,e){return s.onFeatureSelect(t,e)}),null!=a&&Utils.isDefined(a)||(a=function(t,e){return s.onFeatureUnselect(t,e)}),t.selectCallback=i,t.unselectCallback=i)},initDates:function(t){let e=this,i=t.features,a=!1,s=!1;this.hasDates=!1,this.dates=[],this.dateFeatures=[],this.minDate=null,this.maxDate=null;for(let t=0;t<i.length;t++){let e=i[t],r=e.attributes;for(let t in r){let i=(""+t).toLowerCase(),o=i.includes("year")||i.includes("_yr");if(!i.includes("date")&&!o)continue;let l=this.getAttrValue(r,t);if(l&&"0"!=l)try{let t=Utils.parseDate(l);if(t&&isNaN(t.getTime()))continue;if(o?s=!0:a=!0,null!=this.startDate&&null!=this.endDate&&(t.getTime()<this.startDate.getTime()||t.getTime()>this.endDate.getTime()))continue;this.dates.push(t),this.dateFeatures.push(e),this.minDate=null==this.minDate||this.minDate.getTime()>t.getTime()?t:this.minDate,this.maxDate=null==this.maxDate||this.maxDate.getTime()<t.getTime()?t:this.maxDate,e.featureDate=t,this.hasDates=!0;break}catch(t){console.log("error:"+t)}}}if(this.hasDates&&this.params.showDates){let i=null;s&&(i={year:"numeric"}),$("#"+this.mapDivId+"_footer").html(HtmlUtils.div(["class","ramadda-map-animation","id",this.mapDivId+"_animation"],"")),this.animation=$("#"+this.mapDivId+"_animation");let a=HtmlUtils.div(["class","ramadda-map-animation-ticks","id",this.mapDivId+"_animation_ticks"],""),r=HtmlUtils.div(["class","ramadda-map-animation-info","id",this.mapDivId+"_animation_info"],"");this.animation.html(a+r);let o=Utils.formatDate(this.minDate,i),l=Utils.formatDate(this.maxDate,i);this.animationTicks=$("#"+this.mapDivId+"_animation_ticks"),this.animationInfo=$("#"+this.mapDivId+"_animation_info");let n="";this.startDate&&this.endDate&&(n=HtmlUtils.div(["id",this.mapDivId+"_ticks_reset","class","ramadda-map-animation-tick-reset"],"Reset"));let h="<table width=100%><tr valign=top><td width=40%>"+o+"</td><td align=center width=20%>"+n+"</td><td align=right width=40%>"+l+"</td></tr></table>";if(this.animationInfo.html(h),this.startDate&&this.endDate){$("#"+this.mapDivId+"_ticks_reset").click((function(){e.startDate=null,e.endDate=null,e.startFeature=null,e.endFeature=null,e.setFeatureDateRange(t,"Resetting range...")}))}let d=this.animationTicks.width(),u=d>0?5/d:0,c="",p=this.minDate.getTime(),m=this.maxDate.getTime();null!=this.startDate&&null!=this.endDate&&(p=this.startDate.getTime(),m=this.endDate.getTime());let f=m-p;if(f>0)for(let t=0;t<this.dates.length;t++){let e=this.dates[t],a=e.getTime();if(a<p||a>m)continue;let s=this.dateFeatures[t];s.dateIndex=t;let r=100*(a-p)/f;r-=r*u,i||(i={});let o=e.toLocaleDateString("en-US",i),l=Utils.camelCase(this.getFeatureName(s)),n="";n+=null!=l?l+"<br>":"",n+=o,n+="<br>shift-click: set visible range<br>cmd/ctrl-click:zoom",n+="",c+=HtmlUtils.div(["id",this.mapDivId+"_tick"+t,"feature-index",""+t,"style","left:"+r+"%","class","ramadda-map-animation-tick","title",n],"")}this.animationTicks.html(c);let g=$("#"+this.mapDivId+"_animation .ramadda-map-animation-tick");g.tooltip({content:function(){return $(this).prop("title")},position:{my:"left top",at:"left bottom+2"},classes:{"ui-tooltip":"ramadda-popup"}}),g.mouseover((function(){let t=parseInt($(this).attr("feature-index")),i=e.dateFeatures[t];e.handleFeatureover(i,!0)})),g.mouseout((function(){let t=parseInt($(this).attr("feature-index")),i=e.dateFeatures[t];e.handleFeatureout(i,!0)})),g.click((function(t){let i=parseInt($(this).attr("feature-index")),a=e.dateFeatures[i];if(t.shiftKey){if(null==e.startDate?(e.startDate=a.featureDate,e.startFeature=a,e.dateFeatureSelect(a)):null==e.endDate?(e.endDate=a.featureDate,e.endFeature=a,e.dateFeatureSelect(a)):(e.dateFeatureSelect(null),e.startDate=a.featureDate,e.startFeature=a,e.endDate=null,e.endFeature=null,e.dateFeatureSelect(a)),null!=e.startDate&&null!=e.endDate){if(e.startDate.getTime()==e.endDate.getTime())return e.startDate=null,e.startFeature=null,e.endDate=null,e.endFeature=null,void e.dateFeatureSelect(null);if(e.startDate.getTime()>e.endDate.getTime()){let t=e.startDate;e.startDate=e.endDate,e.endDate=t,t=e.startFeature,e.startFeature=e.endFeature,e.endFeature=t}e.setFeatureDateRange(a.layer)}}else{let i=t.metaKey||t.ctrlKey;null==e.startDate&&null==e.endDate||(e.startDate=null,e.endDate=null),e.clearDateFeature(),e.handleFeatureclick(a.layer,a,i)}}))}},setFeatureDateRange:function(t,e){this.dateFeatureSelect(null),e||(e="Setting range..."),this.animationTicks.html(e),setTimeout((()=>this.setFeatureDateRangeInner(t)),100)},setFeatureDateRangeInner:function(t){let e=t.features;t.selectedFeature&&this.unselectFeature(t.selectedFeature);for(let t=0;t<e.length;t++){let i=e[t];this.startDate&&this.endDate&&i.featureDate?i.featureVisibleDate=this.startDate.getTime()<=i.featureDate.getTime()&&i.featureDate.getTime()<=this.endDate.getTime():i.featureVisibleDate=!0}this.setFeatureVisibility(t),this.initDates(t)},dateFeatureSelect:function(t){let e=this.getFeatureTick(t);e.css("background-color",this.params.tickSelectColor),e.css("zIndex","100")},dateFeatureOver:function(t){this.closeTicks();let e=this.getFeatureTick(t);e.css("background-color",this.params.tickHoverColor),e.css("zIndex","100"),this.tickOpen&&this.tickOpen.tooltip("close"),this.tickOpen=e,e.tooltip("open")},dateFeatureOut:function(t){this.closeTicks();let e=this.getFeatureTick(t);!t||t!=this.startFeature&&t!=this.endFeature?(e.css("background-color",""),e.css("zIndex","0")):(e.css("background-color",this.params.tickSelectColor),e.css("zIndex","0")),this.tickOpen=null},closeTicks:function(){let t=this.getAllTicks();t.tooltip("close"),t.css("background-color","")},getAllTicks:function(){return jqid(this.mapDivId+"_animation_ticks").find(".ramadda-map-animation-tick")},getFeatureTick:function(t){return t?$("#"+this.mapDivId+"_tick"+t.dateIndex):$("#"+this.mapDivId+"_animation_ticks .ramadda-map-animation-tick")},clearDateFeature:function(t){let e=null!=t?$("#"+this.mapDivId+"_tick"+t.dateIndex):$("#"+this.mapDivId+"_animation_ticks .ramadda-map-animation-tick");e.css("background-color",""),e.css("zIndex","0")},initMapVectorLayer:function(t,e,i,a,s,r,o,l){let n=this;this.showLoadingImage(),t.isMapLayer=!0,t.canSelect=i,this.loadedLayers.push(t),t.events.on({loadend:function(i){if(n.hideLoadingImage(),i.response&&Utils.isDefined(i.response.code)&&i.response.code==OpenLayers.Protocol.Response.FAILURE)l?l(e,i.response):console.log("An error occurred loading the map:"+e+"\n"+JSON.stringify(i.response,null,2));else{if(o){let e=t.getDataExtent();e&&n.zoomToExtent(e,!0)}else n.centerOnMarkersCalled&&(n.dfltBounds||n.centerOnMarkers(n.dfltBounds,n.centerOnMarkersForce));r&&r(n,t),1==t.features.length&&n.params.displayDiv&&(n.fixedText=!0,n.showText(n.getFeatureText(t,t.features[0]))),n.initDates(t)}}}),this.addLayer(t),this.addSelectCallback(t,i,a,s)},getLayerProperty:function(t,e,i,a,s){let r=Utils.makeId(a);return this.getProperty(e+"_"+r,this.getProperty(e+i,this.getProperty(e,s)))},addMapFileLayer:function(t,e,i,s,r,o,l,n,h,d){let u=this.loadedLayers.length+1,c={strokeColor:this.getLayerProperty(t,"layerStrokeColor",u,i,"blue"),strokeWidth:this.getLayerProperty(t,"layerStrokeWidth",u,i,1),fillColor:this.getLayerProperty(t,"layerFillColor",u,i,"#ccc"),fillOpacity:this.getLayerProperty(t,"layerFillOpacity",u,i,.4)},p={};for(a in $.extend(p,this.highlightStyle),p){let e=String(a);e="highlight"+e.substring(0,1).toUpperCase()+e.substring(1),p[a]=this.getLayerProperty(t,e,u,i,p[a])}return t.highlightStyle=p,this.getLayerProperty(t,"noHighlight",u,i,!1)&&(t.noHighlight=!0),l=l||{},$.extend(c,l),t.styleMap=this.getVectorLayerStyleMap(t,c),this.checkLayerToggle(i,t,u,c),this.initMapVectorLayer(t,e,s,r,o,n,h,d),t},addGpxLayer:function(t,e,i,a,s,r,o,l,n){let h=MapUtils.createLayerGPX(this,t,e);return this.addMapFileLayer(h,e,t,i,a,s,r,o,l,n),h},printLayers:function(t){console.log(t),this.getMap().layers.forEach((t=>{t.name.indexOf("Cb")>=0&&console.log("\t"+t.name)}))},addGeoJsonLayer:function(t,e,i,a,s,r,o,l,n){let h=MapUtils.createLayerGeoJson(this,t,e);return this.addMapFileLayer(h,e,t,i,a,s,r,o,l,n),h},addKMLLayer:function(t,e,i,a,s,r,o,l,n){if(e.match(".kmz")){let t=$("<div  class=ramadda-map-message>Note: KMZ files are not supported</div>")[0];return void this.getMap().viewPortDiv.appendChild(t)}let h=MapUtils.createLayerKML(this,t,e);return this.addMapFileLayer(h,e,t,i,a,s,r,o,l,n),h},checkLayerToggle:function(t,e,i,a){let s=this.getLayerProperty(e,"layerVisible",i,t,!0);if(s||e.setVisibility(!1),this.params.showLayerToggle){let r=Utils.addAlphaToColor(a.fillColor,.4),o=HU.span([],HtmlUtils.checkbox(this.mapDivId+"_layertoggle"+i,["title","Toggle Layer"],s,t))+" ";o=HU.span([STYLE,HU.css("margin-right","5px","padding","5px","background",r)],o),$("#"+this.mapDivId+"_header").append(" "+o),$("#"+this.mapDivId+"_layertoggle"+i).change((function(){$(this).is(":checked")?e.setVisibility(!0):e.setVisibility(!1)}))}},createXYZLayer:function(t,e,i,a){let s={sphericalMercator:MapUtils.defaults.doSphericalMercator,numZoomLevels:MapUtils.defaults.zoomLevels,wrapDateLine:MapUtils.defaults.wrapDateline,isBaseLayer:!a,visibility:!1};return i&&(s.attribution=i),MapUtils.createLayerXYZ(t,e,s)},addBaseLayers:function(){this.mapLayers=Utils.mergeLists([],RAMADDA_MAP_LAYERS);let t=this.params.defaultMapLayer||"osm";if(!this.haveAddedDefaultLayer&&t){let e=-1,i=this.mapLayers.find(((i,a)=>{if(i.id==t)return e=a,!0}));e>=0&&(this.mapLayers.splice(e,1),this.mapLayers.splice(0,0,i))}this.firstLayer=null,this.hybridLayer=null,this.defaultOLMapLayer=null,this.baseLayers={},this.numberOfBaseLayers=0;let e="";for(let t=0;t<this.mapLayers.length;t++){let i=this.mapLayers[t];if(!i.isForMap())continue;let a=this.makeMapLayer(i);null==this.firstLayer&&(this.firstLayer=a),null!=a&&(""!=e&&(e+=","),e+=i.id+":"+a.name,a.ramaddaId=i.id,a.isBaseLayer?(this.baseLayers[i.id]=a,i.id==this.params.defaultMapLayer&&(this.defaultOLMapLayer=a),this.addBaseLayer(a)):this.addLayer(a))}this.graticule=MapUtils.createGraticule({layerName:"Lat/Lon Lines",lineSymbolizer:{strokeColor:"#888",strokeWidth:1,strokeOpacity:.2},xautoActivate:!1,numPoints:2,labelled:!0,visible:!0===this.params.showLatLonLines}),this.getMap().addControl(this.graticule)},makeMapLayer:function(t){let e;if(e="string"==typeof t?RAMADDA_MAP_LAYERS_MAP[t]:t,e){let t=e.createMapLayer(this);if(e.opts.alias&&(this.baseLayers[e.opts.alias]=t),e.opts.refresh){let i=()=>{t.getVisibility()&&t.redraw(!0),setTimeout(i,1e3*e.opts.refresh)};setTimeout(i,1e3*e.opts.refresh)}return t}if(/\/tile\//.exec(t)){let e=t;return MapUtils.createLayerXYZ("ESRI China Map",e,{sphericalMercator:MapUtils.defaults.doSphericalMercator,numZoomLevels:MapUtils.defaults.zoomLevels,wrapDateLine:MapUtils.defaults.wrapDateline})}{let e=/wms:(.*),(.*),(.*)/.exec(t);return e?this.addWMSLayer(e[1],e[2],e[3],!0):(console.log("no match for map layer:"+t),null)}},setGraticulesVisible:function(t){this.graticule&&(this.graticule.gratLayer.visibility=t,t?this.graticule.activate():this.graticule.deactivate(),this.graticule.gratLayer.redraw())},addBaseLayer:function(t){this.addLayer(t),this.numberOfBaseLayers++},getBaseLayer:function(t){if(this.baseLayers)return this.baseLayers[t]},makeSimpleWms:function(t){let e="/repository/wms?version=1.1.1&request=GetMap&layers="+t+"&FORMAT=image%2Fpng&SRS=EPSG%3A4326&BBOX=-180.0,-80.0,180.0,80.0&width=400&height=400";return this.addWMSLayer(Utils.makeLabel(t)+" background",e,t,!0)},initSearch:function(t){let e=this;$("#"+t).keyup((function(i){13==i.keyCode&&e.searchMarkers($("#"+t).val())}))},searchMarkers:function(t){let e=""==(t=(t=t.trim()).toLowerCase());$(':input[id*="visibleall_'+this.mapId+'"]').prop("checked",e);let i=MapUtils.createBounds(),a=0;if(this.markers){let s=this.getMarkers();for(let r=0;r<s.length;r++){marker=s[r];let o=!0,l=$("#visible_"+this.mapId+"_"+marker.ramaddaId),n=$("#block_"+this.mapId+"_"+marker.ramaddaId),h=marker.name;o=!!e||!!Utils.isDefined(h)&&h.toLowerCase().includes(t),o?(marker.style.display="inline",marker.location&&i.extend(marker.location),a++):marker.style.display="none",o?n.show():n.hide(),l.prop("checked",o)}this.markers.redraw()}if(this.boxes&&this.boxes.markers){for(let s in this.boxes.markers){s=this.boxes.markers[s],name=s.name;let r=!0;if(r=!!e||!!Utils.isDefined(name)&&name.toLowerCase().includes(t),s.display(r),r){let t=this.transformProjBounds(s.bounds);i.extend(t),a++}}this.boxes.redraw()}if(this.lines){let i=this.lines.features;for(let a=0;a<i.length;a++){let s=i[a];name=s.name;let r=!0;r=!!e||!!Utils.isDefined(name)&&name.toLowerCase().includes(t),s.style.display=r?"inline":"none"}this.lines.redraw()}a>0&&this.centerOnMarkers(i,!0)},setLatLonReadout:function(t){this.latlonReadout=t},getMap:function(){return getMapDebug&&console.trace(),this.map},initMap:function(t){let e=this;if(this.startTime=Date.now(),this.inited)return;if(this.inited=!0,this.params.enableDragPan&&this.getMap().addControl(new OpenLayers.Control.Navigation({zoomWheelEnabled:this.params.scrollToZoom,dragPanOptions:{enableKinetic:!0}})),this.params.scrollToZoom){document.querySelector("#"+this.mapDivId+"_themap").onwheel=t=>{this.tmp&&console.dir(this.tmp),this.tmp=null,t.preventDefault()}}this.params.showZoomPanControl&&!this.params.showZoomOnlyControl&&this.getMap().addControl(new OpenLayers.Control.PanZoom),this.params.showZoomOnlyControl&&!this.params.showZoomPanControl&&this.getMap().addControl(new OpenLayers.Control.Zoom),this.params.showScaleLine&&this.getMap().addControl(new OpenLayers.Control.ScaleLine);let i=new OpenLayers.Control,a=new OpenLayers.Control,s={keyup:function(t){e.handleKeyUp(t)},keydown:function(t){e.handleKeyDown(t)}};if(new OpenLayers.Handler.Keyboard(a,s,{}).activate(),this.getMap().addControl(i),this.getMap().addControl(new OpenLayers.Control.KeyboardDefaults),this.params.linkMouse&&this.getMap().events.register("mousemove",this.getMap(),(t=>{if(t.shiftKey){this.sharedMouse&&this.getMarkersLayer().removeFeatures([this.sharedMouse],{silent:!0});let e=this.getMap().getLonLatFromPixel(t.xy);e=this.transformProjPoint(e),ramaddaMapShareState(this,{mouse:e})}})),this.params.showLayerSwitcher&&this.getMap().addControl(new OpenLayers.Control.LayerSwitcher),this.params.showLatLonPosition){this.latlonReadout||(this.latlonReadout=this.mapId+"_latlonreadout");let t=GuiUtils.getDomObject(this.latlonReadout);t?this.getMap().addControl(new OpenLayers.Control.MousePosition({numDigits:5,element:t.obj,prefix:"Position: "})):this.getMap().addControl(new OpenLayers.Control.MousePosition({numDigits:5,prefix:"Position: "}))}this.params.showLocationSearch&&this.initLocationSearch(),this.defaultBounds&&(this.hadDefaultBounds=!0),this.applyDefaultLocation();for(let t=0;t<this.initialLayers.length;t++)this.addLayer(this.initialLayers[t]);this.initialLayers=[],t&&this.addRegionSelectorControl();let r=$(':input[id*="visible_'+this.mapId+'"]');r.change((function(t){e.checkImageLayerVisibility(),e.checkMarkerVisibility(),e.checkLinesVisibility(),e.checkBoxesVisibility()}));let o=$(':input[id*="visibleall_'+this.mapId+'"]');o.change((function(t){r.prop("checked",o.is(":checked")),e.checkImageLayerVisibility(),e.checkMarkerVisibility(),e.checkLinesVisibility(),e.checkBoxesVisibility()}));for(let t=1;;t++){let e=this.getProperty("marker"+t);if(!e)break;this.addMarkerEmbed(e)}},handleKeyUp:function(t){this.keyUpListener&&this.keyUpListener(t)},handleKeyDown:function(t){if(79==t.keyCode){if(!this.imageLayersList)return;if(this.ignoreKeyEvents)return;this.imageLayersList.forEach((e=>{Utils.isDefined(e.opacity)||(e.opacity=1),opacity=e.opacity,t.shiftKey?opacity+=.1:opacity-=.1,opacity<0?opacity=0:opacity>1&&(opacity=1),e.setOpacity(opacity)}))}84==t.keyCode&&this.selectImage&&this.selectImage.setVisibility(!this.selectImage.getVisibility()),this.keyDownListener&&this.keyDownListener(t)},addKeyUpListener:function(t){this.keyUpListener=t},addKeyDownListener:function(t){this.keyDownListener=t},applyDefaultLocation:function(){if(debugBounds&&console.log("apply default location:"+this.defaultLocation),this.defaultLocation){let t=this.transformLLPoint(this.defaultLocation);this.getMap().setCenter(t),this.params.initialZoom>=0||this.getMap().zoomTo(4),this.defaultLocation=null}else if(this.defaultBounds){let t=this.defaultBounds.getCenterLonLat(),e=this.transformLLPoint(t);debugBounds&&console.log("applying default bounds: center:"+t+" b:"+this.defaultBounds+" zoom:"+this.params.initialZoom),this.getMap().setCenter(e);let i=this.transformLLBounds(this.defaultBounds);if(this.zoomToExtent(i),this.params.initialZoom<0){this.defaultBounds.right,this.defaultBounds.left;let t=-1;t=this.map.getZoomForExtent(i)+2,this.params.initialZoom=t}this.defaultBounds=null}else this.getMap().zoomToMaxExtent();if(this.params.initialZoom>=0){debugBounds&&console.log("initial zoom:"+this.params.initialZoom);let t=this.params.initialZoom;this.params.initialZoom=-1,this.getMap().zoomTo(t),setTimeout((()=>{this.getMap().zoomTo(t)}),this.initialZoomTimeout)}},removeSearchMarkers:function(){if(this.searchMarkerList)for(let t=0;t<this.searchMarkerList.length;t++)this.removeMarker(this.searchMarkerList[t])},addAllLocationResults:function(){if(this.removeSearchMarkers(),this.searchMarkerList=[],!this.locationSearchResults)return;let t,e,i,a;for(let s=0;s<this.locationSearchResults.length;s++){let r=this.locationSearchResults[s],o=MapUtils.createLonLat(r.longitude,r.latitude),l=r.icon;l||(l=ramaddaCdn+"/icons/green-dot.png"),this.searchMarkerList.push(this.addMarker("search",o,l,"",r.name,20,20)),t=0==s?r.longitude:Math.max(t,r.longitude),e=0==s?r.longitude:Math.min(e,r.longitude),i=0==s?r.latitude:Math.max(i,r.latitude),a=0==s?r.latitude:Math.min(a,r.latitude)}let s=this.transformLLBounds(MapUtils.createBounds(e,a,t,i));this.zoomToExtent(s)},initLocationSearch:function(){if(this.selectRegion)return;let t=this,e=HtmlUtils.span(["style","padding-right:4px;","id",this.mapDivId+"_loc_search_wait"],"")+HtmlUtils.checkbox(this.mapDivId+"_loc_bounds",["title","Search in map bounds"],!1)+HtmlUtils.span(["title","Search in map bounds"]," In view ")+HtmlUtils.input("","",["class","ramadda-map-loc-input","title","^string - matches beginning","size","30","placeholder","Search location","id",this.mapDivId+"_loc_search"]);$("#"+this.mapDivId+"_footer2").html(e);let i=$("#"+this.mapDivId+"_loc_search"),a=$("#"+this.mapDivId+"_loc_bounds"),s=$("#"+this.mapDivId+"_loc_popup"),r=$("#"+this.mapDivId+"_loc_search_wait");i.blur((function(t){setTimeout((function(){r.html(""),s.hide()}),250)})),i.on("input",(function(e){s.hide(),""==i.val()&&t.removeSearchMarkers()})),i.keypress((function(e){let o=e.keyCode||e.which;if(27==o)return void s.hide();if(13!=o)return;r.html(HtmlUtils.image(icon_wait));let l=ramaddaBaseUrl+"/geocode?query="+encodeURIComponent(i.val());if(a.is(":checked")){let e=t.transformProjBounds(t.getMap().getExtent());l+="&bounds="+e.top+","+e.left+","+e.bottom+","+e.right}$.getJSON(l,(function(e){r.html("");let a=HtmlUtils.openTag("div",["style","max-height:400px;overflow-y:auto;"]);if(0==e.result.length)return void r.html("Nothing found");t.locationSearchResults=e.result;for(let t=0;t<e.result.length;t++){let i=e.result[t].name.replace('"',"'"),s=e.result[t].icon;s||(s=ramaddaCdn+"/icons/green-dot.png"),a+=HtmlUtils.div(["class","ramadda-map-loc","name",i,"icon",s,"latitude",e.result[t].latitude,"longitude",e.result[t].longitude],"<img width='16' src="+s+"> "+e.result[t].name)}a+=HtmlUtils.div(["class","ramadda-map-loc","name","all"],"Show all");a+=HtmlUtils.closeTag("div"),s.html(a),HtmlUtils.setPopupObject(s),s.show(),s.position({of:i,my:"left bottom",at:"left top",collision:"fit fit"}),s.find(".ramadda-map-loc").click((function(){s.hide();let e=$(this).attr("name");if("all"==e)return void t.addAllLocationResults();let i=parseFloat($(this).attr("latitude")),a=parseFloat($(this).attr("longitude")),r=$(this).attr("icon"),o=.05,l=t.transformLLBounds(MapUtils.createBounds(a-o,i-o,a+o,i+o)),n=MapUtils.createLonLat(a,i);t.removeSearchMarkers(),t.searchMarkerList=[],t.searchMarkerList.push(t.addMarker("search",n,r,"",e,20,20));let h=t.transformProjBounds(t.getMap().getExtent());Math.abs(h.top-h.bottom)>o?t.zoomToExtent(l):t.setCenter(MapUtils.createLonLat(a,i))}))})).fail((function(t,e,i){r.html("Error:"+i)}))}))},addVectorLayer:function(t,e){if(this.addLayer(t),this.vectorLayers.push(t),this.getCanSelect(e)){let e=this;this.getMap().featureSelect?this.getMap().featureSelect.layers.push(t):this.getMap().featureSelect=new OpenLayers.Control.SelectFeature([t],{multiple:!1,hover:this.selectOnHover,onSelect:function(t){e.showMarkerPopup(t,!0)}})}this.checkLayerOrder()},isLayerVisible:function(t,e){let i=$("#visible_"+this.mapId+"_"+t);return 0==i.length&&null!=e&&(i=$("#visible_"+this.mapId+"_"+e)),0==i.length||i.is(":checked")},initForDrawing:function(){let t=this;t.drawingLayer||(this.drawingLayer=MapUtils.createLayerVector("Drawing"),this.addLayer(t.drawingLayer)),this.drawControl=new OpenLayers.Control.DrawFeature(t.drawingLayer,OpenLayers.Handler.Point),this.getMap().addControl(t.drawControl)},drawingFeatureAdded:function(t){},addClickHandler:function(t,e,i,a){if(this.handleClickSelection=!0,this.lonFldId=t,this.latFldId=e,!this.clickHandler&&this.map)return this.clickHandler=new OpenLayers.Control.Click,this.clickHandler.setLatLonZoomFld(t,e,i,a),this.clickHandler.setTheMap(this),this.getMap().addControl(this.clickHandler),this.clickHandler.activate(),this.clickHandler},setSelection:function(t,e,i){this.selectRegion=e,this.argBase=t,GuiUtils&&(this.fldNorth=GuiUtils.getDomObject(this.argBase+"_north"),null==this.fldNorth&&(this.fldNorth=GuiUtils.getDomObject(this.argBase+".north")),null==this.fldNorth&&(this.fldNorth=GuiUtils.getDomObject(this.mapId+"_north")),this.fldSouth=GuiUtils.getDomObject(this.argBase+"_south"),this.fldSouth||(this.fldSouth=GuiUtils.getDomObject(this.argBase+".south")),null==this.fldSouth&&(this.fldSouth=GuiUtils.getDomObject(this.mapId+"_south")),this.fldEast=GuiUtils.getDomObject(this.argBase+"_east"),this.fldEast||(this.fldEast=GuiUtils.getDomObject(this.argBase+".east")),null==this.fldEast&&(this.fldEast=GuiUtils.getDomObject(this.mapId+"_east")),this.fldWest=GuiUtils.getDomObject(this.argBase+"_west"),this.fldWest||(this.fldWest=GuiUtils.getDomObject(this.argBase+".west")),null==this.fldWest&&(this.fldWest=GuiUtils.getDomObject(this.mapId+"_west")),this.fldLat=GuiUtils.getDomObject(this.argBase+"_latitude"),this.fldLat||(this.fldLat=GuiUtils.getDomObject(this.argBase+".latitude")),null==this.fldLat&&(this.fldLat=GuiUtils.getDomObject(this.mapId+"_latitude")),this.fldLon=GuiUtils.getDomObject(this.argBase+"_longitude"),null==this.fldLon&&(this.fldLon=GuiUtils.getDomObject(this.argBase+".longitude")),null==this.fldLon&&(this.fldLon=GuiUtils.getDomObject(this.mapId+"_longitude")),this.fldLon&&(this.addClickHandler(this.fldLon.id,this.fldLat.id),this.setSelectionMarker(this.fldLon.obj.value,this.fldLat.obj.value)))},selectionPopupInit:function(){this.inited||(this.initMap(this.selectRegion),this.argBase&&!this.fldNorth&&this.setSelection(this.argBase),this.fldNorth&&this.setSelectionBox(this.fldNorth.obj.value,this.fldWest.obj.value,this.fldSouth.obj.value,this.fldEast.obj.value,!0),this.fldLon&&(this.addClickHandler(this.fldLon.id,this.fldLat.id),this.setSelectionMarker(this.fldLon.obj.value,this.fldLat.obj.value))),this.map.updateSize()},setSelectionBoxFromFields:function(t){if(this.fldNorth&&(this.setSelectionBox(this.fldNorth.obj.value,this.fldWest.obj.value,this.fldSouth.obj.value,this.fldEast.obj.value,!0),this.selectorBox)){let e=this.selectorBox.bounds;this.getMap().setCenter(e.getCenterLonLat()),t&&this.zoomToExtent(e)}},toggleSelectorBox:function(t){this.selectorControl&&(t?(this.selectorControl.activate(),this.selectorControl.box.activate()):(this.selectorControl.deactivate(),this.selectorControl.box.deactivate()))},resetExtent:function(){debugBounds&&console.log("resetExtent"),this.getMap().zoomToMaxExtent()},setSelectionBox:function(t,e,i,a,s){if(""==t||""==e||""==i||""==a)return;let r=MapUtils.createBounds(e,Math.max(i,-MapUtils.defaults.maxLatValue),a,Math.min(t,MapUtils.defaults.maxLatValue));if(this.selectorBox)this.selectorBox.bounds=this.transformLLBounds(r);else{let s={color:"red",selectable:!1};this.selectorBox=this.createBox("","Selector box",t,e,i,a,"",s)}if(s&&(debugBounds&&console.log("calling setViewToBounds-1"),this.setViewToBounds(r)),this.boxes&&this.boxes.redraw(),this.selectImage){let s=MapUtils.createBounds(e,i,a,t);s=this.transformLLBounds(s),this.selectImage.extent=s,this.selectImage.redraw()}},clearSelectionMarker:function(){null!=this.selectorMarker&&(this.removeMarker(this.selectorMarker),this.selectorMarker=null)},clearSelectedFeatures:function(){if(null!=this.getMap().controls){let t=this.getMap().controls;for(i=0;i<t.length;i++)"olControlSelectFeature"==t[i].displayClass&&t[i].unselectAll()}},setSelectionMarker:function(t,e,i,a){if(!t||!e||""==t||""==e)return;null!=this.lonFldId&&($("#"+this.lonFldId).val(MapUtils.formatLocationValue(t)),$("#"+this.latFldId).val(MapUtils.formatLocationValue(e)));let s=MapUtils.createLonLat(t,e);if(null==this.selectorMarker?this.selectorMarker=this.addMarker(MapUtils.POSITIONMARKERID,s,"","","",20,10):this.selectorMarker.lonlat=this.transformLLPoint(s),this.markers&&this.markers.redraw(),i&&(debugBounds&&console.log("setSelectionMarker-1"),this.getMap().setCenter(this.selectorMarker.lonlat)),a){if(debugBounds&&console.log("setSelectionMarker-2"),a.zoomOut){let t=this.getMap().getZoom();return t--,void(this.getMap().isValidZoomLevel(t)&&this.getMap().zoomTo(t))}if(a.zoomIn){let t=this.getMap().getZoom();return t++,void(this.getMap().isValidZoomLevel(t)&&this.getMap().zoomTo(t))}let i=a.offset;if(i){let a=this.transformLLBounds(MapUtils.createBounds(t-i,e-i,t+i,e+i));this.zoomToExtent(a)}}},transformLLBounds:function(t){if(!t)return;return Utils.isDefined(t.north)&&(t=MapUtils.createBounds(t.west,t.south,t.east,t.north)),t.clone().transform(this.displayProjection,this.sourceProjection)},ensureLonLat:function(t){return t.length>0&&!t[0].transform&&(t=t.map((t=>t=MapUtils.createPoint(t.x,t.y)))),t},transformPoints:function(t){return(t=this.ensureLonLat(t)).forEach((t=>{t.transform(this.displayProjection,this.sourceProjection)})),t},transformLLPoint:function(t){if(!t)return null;return t.clone().transform(this.displayProjection,this.sourceProjection)},transformProjBounds:function(t){if(!t)return;return t.clone().transform(this.sourceProjection,this.displayProjection)},transformProjPoint:function(t){if(!t)return;return t.clone().transform(this.sourceProjection,this.displayProjection)},normalizeBounds:function(t){if(!this.map)return t;let e=t,i=t.left,a=t.right,s=this.getMap().restrictedExtent;return s||(s=this.maxExtent),s?(s.left>=0&&(t.left<0&&(i=t.left+360),t.right<0&&(a=t.right+360)),i>a&&(a=t.right+360),i=Math.max(i,s.left),a=Math.min(a,s.right),e=MapUtils.createBounds(i,t.bottom,a,t.top),e):t},findSelectionFields:function(){!this.argBase||this.fldNorth||this.fldLon||this.setSelection(this.argBase)},selectionClear:function(){this.findSelectionFields(),HU.addToDocumentUrl("map_bounds",""),this.fldNorth?(this.fldNorth.obj.value="",this.fldSouth.obj.value="",this.fldWest.obj.value="",this.fldEast.obj.value=""):this.fldLat&&(this.fldLon.obj.value="",this.fldLat.obj.value=""),this.selectorBox&&this.boxes&&(this.boxes.removeMarker(this.selectorBox),this.selectorBox=null),this.selectorMarker&&this.markers&&(this.removeMarker(this.selectorMarker),this.selectorMarker=null)},clearMarkers:function(){if(!this.markers)return;let t=this.getMarkers();this.markers.removeFeatures(t),this.markers.redraw()},getMarkers:function(){return null==this.markers?[]:this.markers.features},clearRegionSelector:function(t){this.selectorControl&&this.selectorControl.box&&this.selectorControl.box.removeBox()},addRegionSelectorControl:function(t,i){let a=this;a.selectorControl||(a.selectorListener=t,a.selectorControl=new OpenLayers.Control,OpenLayers.Util.extend(a.selectorControl,{draw:function(){this.box=new OpenLayers.Handler.Box(a.selectorControl,{done:this.notice},{keyMask:OpenLayers.Handler.MOD_SHIFT}),i||this.box.activate()},notice:function(e){let i=a.getMap().getLonLatFromPixel(MapUtils.createPixel(e.left,e.bottom)),s=a.getMap().getLonLatFromPixel(MapUtils.createPixel(e.right,e.top));i=a.transformProjPoint(i),s=a.transformProjPoint(s),e=MapUtils.createBounds(i.lon,i.lat,s.lon,s.lat),e=a.normalizeBounds(e),a.setSelectionBox(e.top,e.left,e.bottom,e.right,!1),a.findSelectionFields(),t&&t(e),a.fldNorth&&(a.fldNorth.obj.value=MapUtils.formatLocationValue(e.top),a.fldSouth.obj.value=MapUtils.formatLocationValue(e.bottom),a.fldWest.obj.value=MapUtils.formatLocationValue(e.left),a.fldEast.obj.value=MapUtils.formatLocationValue(e.right),HU.addToDocumentUrl("map_bounds",e.top+","+e.left+","+e.bottom+","+e.right))}}),a.map.addControl(a.selectorControl),a.panControl=new OpenLayers.Control,OpenLayers.Util.extend(a.panControl,{draw:function(){this.box=new OpenLayers.Handler.Drag(a.panControl,{down:this.down,move:this.move},{keyMask:OpenLayers.Handler.MOD_META,boxDivClassName:"map-drag-box"}),this.box.activate()},down:function(t){this.firstPoint=a.getMap().getLonLatFromPixel(MapUtils.createPixel(t.x,t.y)),this.firstPoint=a.transformProjPoint(this.firstPoint),a.findSelectionFields(),a.fldNorth&&(n=this.origNorth=parseFloat(a.fldNorth.obj.value),s=this.origSouth=parseFloat(a.fldSouth.obj.value),w=this.origWest=parseFloat(a.fldWest.obj.value),e=this.origEast=parseFloat(a.fldEast.obj.value),t=this.firstPoint,this.doWest=!1,this.doSouth=!1,this.doEast=!1,this.doNorth=!1,t.lon<=e&&t.lon>=w&&t.lat<=n&&t.lat>=s?(this.doSouth=this.doWest=this.doEast=this.doNorth=!0,this.type="center"):t.lon>e?t.lat>n?(this.type="ne",this.doEast=this.doNorth=!0):t.lat<s?(this.type="se",this.doSouth=this.doEast=!0):(this.type="e",this.doEast=!0):t.lon<w?t.lat>n?(this.type="nw",this.doWest=this.doNorth=!0):t.lat<s?(this.type="sw",this.doSouth=this.doWest=!0):(this.type="w",this.doWest=!0):t.lat>n?(this.type="n",this.doNorth=!0):(this.type="s",this.doSouth=!0))},move:function(t){let e=a.getMap().getLonLatFromPixel(MapUtils.createPixel(t.x,t.y));e=a.transformProjPoint(e),dx=e.lon-this.firstPoint.lon,dy=e.lat-this.firstPoint.lat,newWest=this.origWest,newEast=this.origEast,newSouth=this.origSouth,newNorth=this.origNorth,this.doWest&&(newWest+=dx),this.doSouth&&(newSouth+=dy),this.doEast&&(newEast+=dx),this.doNorth&&(newNorth+=dy);let i=MapUtils.createBounds(newWest,newSouth,newEast,newNorth);i=a.normalizeBounds(i),a.setSelectionBox(i.top,i.left,i.bottom,i.right,!1),a.findSelectionFields(),a.fldNorth&&(a.fldNorth.obj.value=MapUtils.formatLocationValue(i.top),a.fldSouth.obj.value=MapUtils.formatLocationValue(i.bottom),a.fldWest.obj.value=MapUtils.formatLocationValue(i.left),a.fldEast.obj.value=MapUtils.formatLocationValue(i.right))}}),a.map.addControl(a.panControl))},closePopup:function(t){this.currentPopup&&(this.getMap().removePopup(this.currentPopup),this.currentPopup.destroy(),this.currentPopup=null,this.hiliteBox(""),this.selectedFeature&&this.unselectFeature(this.selectedFeature))},onPopupClose:function(t){if(this.params.displayDiv&&$("#"+this.params.displayDiv).html(""),this.currentPopup){this.getMap().removePopup(this.currentPopup);try{this.currentPopup.destroy()}catch(t){}this.currentPopup=null,this.hiliteBox(""),this.selectedFeature&&this.unselectFeature(this.selectedFeature)}},findObject:function(t,e){for(i=0;i<e.length;i++){let a=e[i].ramaddaId;if(a||(a=e[i].id),a==t)return e[i]}return null},findMarker:function(t){return this.markers?this.findObject(t,this.getMarkers()):null},findFeature:function(t){return this.features[t]},findBox:function(t){return this.boxes?this.findObject(t,this.boxes.markers):null},hiliteBox:function(t){this.currentBox&&this.currentBox.setBorder(this.currentBox.defaultBorderColor||"blue",1),this.currentBox=this.findBox(t),this.currentBox&&this.currentBox.setBorder("red")},checkMarkerVisibility:function(){if(!this.markers)return;let t=this.getMarkers();for(let e=0;e<t.length;e++){marker=t[e];let i=this.isLayerVisible(marker.ramaddaId,marker.parentId);marker.style.display=i?"inline":"none"}this.markers.redraw()},checkLinesVisibility:function(){if(!this.lines)return;let t=this.lines.features;for(let e=0;e<t.length;e++){let i=t[e],a=this.isLayerVisible(i.ramaddaId);i.style.display=a?"inline":"none"}this.lines.redraw()},checkBoxesVisibility:function(){if(this.boxes){for(let t in this.boxes.markers){t=this.boxes.markers[t];let e=this.isLayerVisible(t.ramaddaId);t.display(e)}this.boxes.redraw()}},checkImageLayerVisibility:function(){this.imageLayersList&&this.imageLayersList.forEach((t=>{let e=this.isLayerVisible(t.id);t.setVisibility(e),e?t.box&&(this.removeBox(t.box),t.box=this.createBox(i,"",t.north,t.west,t.south,t.east,t.text,{})):t.box&&(this.removeBox(t.box),t.box=null)}))},hiliteMarker:function(t){let e=this.findMarker(t);if(e||(e=this.findFeature(t)),!e&&this.imageLayers&&(e=this.imageLayers[t]),!e)return;let i=e.latLonBounds;if(i){let t=this.transformLLBounds(i);this.zoomToExtent(t)}else debugBounds&&console.log("hiliteMarker"),this.setCenter(e.lonlat);this.showMarkerPopup(e)},clearAllProgress:function(){this.clearProgress(),this.hideLoadingImage()},clearProgress:function(t){$("#"+this.mapDivId+"_progress").hide()},setProgress:function(t){$("#"+this.mapDivId+"_progress").html(t),$("#"+this.mapDivId+"_progress").show()},setLabel:function(t){$("#"+this.mapDivId+"_label").html(t)},setCursor:function(t){jqid(this.mapDivId+"_themap").css("cursor",t??"default")},hideLoadingImage:function(){this.setCursor(),jqid(this.mapDivId+"_themap").css("cursor","default"),this.loadingImage&&(this.loadingImage.style.visibility="hidden")},showLoadingImage:function(){if(this.setCursor("progress"),this.loadingImage)return void(this.loadingImage.style.visibility="visible");let t=MapUtils.createSize(120,120),e=this.getMap().viewPortDiv.offsetWidth,i=this.getMap().viewPortDiv.offsetHeight,a=MapUtils.createPixel(e/2-t.w/2,i/2-t.h/2);this.loadingImage=MapUtils.createImage("loadingimage",a,t,ramaddaCdn+"/icons/mapprogress.gif"),this.loadingImage.style.zIndex=1010,this.getMap().viewPortDiv.appendChild(this.loadingImage)},centerOnMarkerLayer:function(){this.centerOnMarkers(null,!1,!0)},centerOnMarkersInit:function(){this.hadDefaultBounds||this.centerOnMarkers(null)},getLayerVisbileExtent:function(t){let e=null,i=t.features;if(!i)return t.getDataExtent();if(i.length>0){let t=null;for(let a=0,s=i.length;a<s;a++)i[a].getVisibility()&&(t=i[a].geometry,t&&(null===e&&(e=MapUtils.createBounds()),e.extend(t.getBounds())))}return e},zoomToLayer:function(t,e){let i=this.getLayerVisbileExtent(t);i||(i=t.extent),i&&(e&&(i=i.scale(parseFloat(e),i.getCenterPixel())),this.zoomToExtent(i,!1))},animateViewToBounds:function(t,e,i){Utils.isDefined(i)||(i=1),e||(e=this.transformProjBounds(this.getMap().getExtent()));if(i>10)return void this.setViewToBounds(t);let a=i/10;i++,newBounds=MapUtils.createBounds(e.left+(t.left-e.left)*a,e.bottom+(t.bottom-e.bottom)*a,e.right+(t.right-e.right)*a,e.top+(t.top-e.top)*a),this.setViewToBounds(newBounds),setTimeout((()=>this.animateViewToBounds(t,e,i)),125)},getPopupText:function(t,e){return null==t?null:(0==t.indexOf("base64:")&&0==(t=window.atob(t.substring(7))).indexOf("{")&&(props=JSON.parse(t),(t=props.text)||(t=""),e&&(e.inputProps=props)),t)},clearSeenMarkers:function(){this.seenMarkers={}},addEntryMarker:function(t,e,i,a,s,r,o){if(marker=this.addMarker(t,e,i,a,s),marker.entryType=r,marker.entryId=t,o&&o.fillColor){let i={pointRadius:o.radius||12,fillColor:o.fillColor,strokeWidth:o.strokeWidth,strokeColor:o.strokeColor};this.addPoint(t,e,i,"")}},createMarker:function(t,e,i,a,s,r,o,l,n,h,d){if("dot"==i)return this.createPoint(t,e,{},s);Utils.isDefined(e.x)&&(e=MapUtils.createLonLat(e.x,e.y)),d||(d={}),Array.isArray(e)&&(e=MapUtils.createLonLat(e[0],e[1]));let u=o||this.params.iconWidth||this.params.iconSize||20,c=o||this.params.iconHeight||this.params.iconSize||20;o=u,null==l&&(l=0),null==n&&(n=0),this.markers||(this.markers=MapUtils.createLayerVector("Markers"),this.addVectorLayer(this.markers,h)),i||(i=ramaddaCdn+"/icons/marker.png");let p=MapUtils.createSize(u,c),m=MapUtils.createIcon(i,p,null,(function(t){return MapUtils.createPixel(-o.w/2-l,-o.h/2-n)})),f=this.transformLLPoint(e),g=MapUtils.createMarker(f,m),y=MapUtils.createPoint(e.lon,e.lat).transform(this.displayProjection,this.sourceProjection),L={externalGraphic:i,graphicWidth:o,graphicXOffset:l+-o/2,graphicYOffset:-o/2,labelYOffset:-o,label:d.label};Utils.isDefined(d.rotation)&&(L.rotation=d.rotation);let M=MapUtils.createVector(y,{description:""},L);M.ramaddaId=t,M.parentId=r,M.text=this.getPopupText(s,M),M.name=a,M.location=e,g.ramaddaId=t,g.text=this.getPopupText(s,g),g.name=a,g.location=e;let k=e+"";M.locationKey=k;let b=this.seenMarkers[k];null==b&&(b=[],this.seenMarkers[k]=b),b.push(M);let x=this,v=function(t){x.showMarkerPopup(g,!0),null!=g.ramaddaClickHandler&&g.ramaddaClickHandler.call(null,g),MapUtils.stopEvent(t)};return g.events.register("click",g,v),g.events.register("touchstart",g,v),this.isLayerVisible(g.ramaddaId,g.parentId)||g.display(!1),M.what="marker",M},addMarkerEmbed:function(t){let e={};if(t.startsWith("base64:")&&(t=window.atob(t.substring(7))),0==t.indexOf("{"))e=JSON.parse(t);else{let[i,a,s]=t.split(",");e.lat=i,e.lon=a,e.text=s}let i=MapUtils.createLonLat(parseFloat(e.lon),parseFloat(e.lat));null!=e.size&&""!=e.size||(e.size=16);let a=e.type||"icon",s=e;if(s.pointRadius=e.size||"16",s.labelYOffset=-8-s.pointRadius,"icon"==a){let t=e.icon||"/markers/marker-red.png";this.addMarker("",i,t,e.description,e.description,"",parseFloat(e.size||"16"),null,!0,s)}else s.fillColor=s.fillColor||"blue",s.strokeWidth=s.strokeWidth||"1",s.graphicName=a,"none"==a&&(s.graphicName="circle",s.pointRadius=0,s.fillColor="transparent"),this.addPoint("",i,s,e.description),"circle"!=s.graphicName&&this.addPoint("",i,{pointRadius:s.pointRadius,strokeColor:"transparent",fillColor:"transparent"},e.description);this.setDoPopup(!0)},setDoPopup:function(t){this.params.doPopup=t},getDoPopup:function(t){return this.params.doPopup},addMarker:function(t,e,i,a,s,r,o,l,n,h,d,u){let c=this.createMarker(t,e,i,a,s,r,o,0,l,n,h);return c.lonlat=e,u||this.addMarkers([c]),d&&this.addPolygonString(d,{fill:!0,fillColor:"#0000ff",fillOpacity:.1,strokeWidth:1,strokeColor:"blue"},!0,s),c},createPolygonString:function(t,e,i,a){return this.createPolygonFromString(t,e,i,a)},createPolygonFromString:function(t,e,i,a){let s;[";",","].forEach((e=>{t.indexOf(e)>=0&&(s=e)}));let r=t.split(s),o=[];for(let t=2;t<r.length;t+=2){let e=parseFloat(r[t-2]),a=parseFloat(r[t-1]),s=parseFloat(r[t]),l=parseFloat(r[t+1]);if(!i){let t=e;e=a,a=t,t=s,s=l,l=t}o.push(MapUtils.createPoint(a,e)),o.push(MapUtils.createPoint(l,s))}let l=[];return o.length>0&&l.push(this.createPolygon("polygon","",o,e,a)),l},addPolygonString:function(t,e,i,a){let s=this.createPolygonFromString(t,e,i,a);return this.getLinesLayer().addFeatures(s),s},addMarkers:function(t){this.markers||(this.markers=MapUtils.createLayerVector("Markers"),this.addVectorLayer(this.markers,!0)),this.markers.addFeatures(t)},initBoxes:function(t){this.getMap(),this.addLayer(t),t.getFeatureFromEvent=function(t){return null}},removeBox:function(t){this.boxes&&t&&(this.boxes.removeMarker(t),this.boxes.redraw())},addBox:function(t){this.boxes||(this.boxes=MapUtils.createLayerBoxes("Boxes",{wrapDateLine:MapUtils.defaults.wrapDateline}),this.getMap()?this.initBoxes(this.boxes):this.initialBoxes=this.boxes),this.boxes.addMarker(t),this.boxes.redraw()},createBox:function(t,e,i,a,s,r,o,l){0==o.indexOf("base64:")&&(o=window.atob(o.substring(7)));let n={color:"blue",selectable:!0,zoomToExtent:!1,sticky:!1};for(let t in l)n[t]=l[t];n.color||(n.color=this.params.boxColor||"blue");let h=MapUtils.createBounds(a,Math.max(s,-MapUtils.defaults.maxLatValue),r,Math.min(i,MapUtils.defaults.maxLatValue)),d=this.transformLLBounds(h);box=MapUtils.createBox(d),box.sticky=n.sticky;let u=this;n.selectable&&box.events.register("click",box,(function(t){u.showMarkerPopup(box,!0),MapUtils.stopEvent(t)}));let c=MapUtils.createLonLat(a,i);return box.lonlat=this.transformLLPoint(c),box.text=this.getPopupText(o),box.name=e,box.setBorder(n.color,1),box.defaultBorderColor=n.color,box.ramaddaId=t,n.zoomToExtent&&this.centerOnMarkers(h),this.addBox(box),box},circleMarker:function(t,e){if(marker=this.findMarker(t),marker||(marker=this.findFeature(t)),!marker)return null;myattrs={pointRadius:12,stroke:!0,strokeColor:"red",strokeWidth:2,fill:!1},e&&$.extend(myattrs,e);return this.showFeatureText(marker),this.addPoint(t+"_circle",marker.location,myattrs)},addFeatureHighlightHandler:function(t){this.featureHighlightHandler=t},addFeatureSelectHandler:function(t){this.featureSelectHandler=t},showFeatureText:function(t){this.featureHighlightHandler&&this.featureHighlightHandler(t,!0);let e=this;if(t.text&&this.params.displayDiv){this.textFeature=t,setTimeout((function(){e.textFeature==t&&e.showText(e.textFeature.text)}),500)}},showText:function(t){$("#"+this.params.displayDiv).html(t)},hideFeatureText:function(t){this.featureHighlightHandler&&this.featureHighlightHandler(t,!1),t&&this.textFeature!=t||this.params.displayDivSticky||this.showText("")},createPoint:function(t,e,i,a,s,r){let o=e;void 0===e.x?e=MapUtils.createPoint(e.lon,e.lat):o=MapUtils.createLonLat(e.x,e.y),this.basePointStyle||(this.basePointStyle=$.extend({},MapUtils.getVectorStyle("default")),$.extend(this.basePointStyle,{pointRadius:5,stroke:!0,strokeColor:"red",strokeWidth:0,strokeOpacity:.75,fill:!0,fillColor:"blue",fillOpacity:.75}));let l=Object.assign({},this.basePointStyle);i&&(l=Object.assign(l,i),l.pointRadius<=0&&(l.pointRadius=1)),""!=l.fillColor&&"none"!=l.fillColor||(l.fillOpacity=0),""!=l.strokeColor&&"none"!=l.strokeColor||(l.strokeOpacity=0);let n=MapUtils.createPoint(e.x,e.y);n.transform(this.displayProjection,this.sourceProjection);let h=MapUtils.createVector(n,null,l);return h.center=n,h.ramaddaId=t,a&&(h.text=this.getPopupText(a,h)),h.textGetter=s,h.location=o,h.lonlat=o,this.features[t]=h,h},addPoint:function(t,e,i,a,s){let r=this.createPoint(t,e,i,a,s);return this.getMarkersLayer().addFeatures([r],{silent:!0}),r},addPoints:function(t){this.getMarkersLayer().addFeatures(t,{silent:!0})},getMarkersLayer:function(){return null==this.circles&&(this.circles=MapUtils.createLayerVector("Shapes"),this.circles.layerName="circles",this.circles.setZIndex(1),this.addVectorLayer(this.circles),this.circles.canSelect=!0),this.circles},setPointsVisibility:function(t){this.circles&&this.circles.setVisibility(t)},addRectangle:function(t,e,i,a,s,r,o){let l=[MapUtils.createPoint(i,e),MapUtils.createPoint(i,a),MapUtils.createPoint(s,a),MapUtils.createPoint(s,e),MapUtils.createPoint(i,e)];return this.addPolygon(t,"",l,r,o)},createLine:function(t,e,i,a,s,r,o,l){let n=[MapUtils.createPoint(a,i),MapUtils.createPoint(r,s)];return this.createPolygon(t,e,n,o,l)},addLine:function(t,e,i,a,s,r,o,l,n){let h=[MapUtils.createPoint(a,i),MapUtils.createPoint(r,s)];return this.addPolygon(t,e,h,o,l,n)},addLines:function(t,e,i,a,s){(i=i||{}).strokeWidth||(i.strokeWidth=this.params.strokeWidth),i.strokeColor||(i.strokeColor=this.params.strokeColor);let r=[];for(let t=0;t<a.length;t+=2)r.push(MapUtils.createPoint(a[t+1],a[t]));return this.addPolygon(t,e,r,i,s,!1,!0)},removePolygon:function(t){this.lines&&this.lines.removeFeatures([t])},createPolygon:function(t,e,i,a,s,r){let o;i.length>1?o=MapUtils.createLonLat(i[0].x+(i[1].x-i[0].x)/2,i[0].y+(i[1].y-i[0].y)/2):i.length>0&&(o=MapUtils.createLonLat(i[0].x,i[0].y)),i=this.transformPoints(i);let l,n=$.extend({},MapUtils.getVectorStyle("default")),h=$.extend({},n);if(a)for(let t in a)h[t]=a[t];l=r?MapUtils.createLineString(i):MapUtils.createPolygon(MapUtils.createLinearRing(i));let d=MapUtils.createVector(l,null,h);s||(s=e),d.text=s,d.ramaddaId=t,d.location=o,d.name=e;let u=this.isLayerVisible(d.ramaddaId);return d.style.display=u?"inline":"none",d},addPolygon:function(t,e,i,a,s,r,o){let l=this.createPolygon(t,e,i,a,s,o);return r||this.getLinesLayer().addFeatures([l]),l},getLinesLayer:function(){if(!this.lines){let t=$.extend({},MapUtils.getVectorStyle("default"));this.lines=MapUtils.createLayerVector("Lines",{style:t}),this.addVectorLayer(this.lines),this.lines.isMapLayer=!0}return this.lines},centerOnFeatures:function(t){let e=MapUtils.createBounds();if(t.forEach((t=>{let i=t.geometry.getBounds();e.extend(i)})),e.left!=e.right&&e.top!=e.bottom)this.zoomToExtent(e);else{e=this.transformProjBounds(e);var i=e.getCenterLonLat();this.setCenter(i)}},getHighlightLinesLayer:function(){if(!this.highlightlines){let t=$.extend({},MapUtils.getVectorStyle("default"));this.highlightlines=MapUtils.createLayerVector("Highlight Lines",{style:t}),this.addVectorLayer(this.highlightlines)}return this.highlightlines},handleMarkerLayer:function(){this.currentPopup&&(this.getMap().removePopup(this.currentPopup),this.currentPopup.destroy(),this.currentPopup=null);let t=this.currentEntryMarker;if(t.entryLayer){let e=this.loadedLayers.indexOf(t.entryLayer);return e>=0&&(this.loadedLayers=this.loadedLayers.slice(e)),this.getMap().removeLayer(t.entryLayer),void(t.entryLayer=null)}let e=this.handleEntrySelect(t.entryId,t.name,t.entryType);e&&(t.entryLayer=e)},showPopupSlider:function(t,e){return!(!this.params.doPopupSlider&&!this.params.popupSliderRight)&&(this.doingPopup=!0,setTimeout((()=>{let t=$("#"+this.mapDivId+"_slider");this.params.popupSliderRight?t.css("right","0px"):t.css("left","0px"),t.hide();let i=HU.getDimension(this.params.popupWidth),a=HU.div([STYLE,HU.css("width",i,"padding","5px")],HU.div([ID,this.mapDivId+"_sliderclose",CLASS,"ramadda-clickable"],HU.getIconImage(icon_close))+e);t.html(a),t.slideDown(800),$("#"+this.mapDivId+"_sliderclose").click((()=>{t.slideUp()})),setTimeout((()=>{this.doingPopup=!1}),10)}),1e3),!0)},showMarkerPopup:function(t,e,i){if(debugPopup&&console.log("showMarkerPopup"),this.entryClickHandler&&window[this.entryClickHandler]&&!window[this.entryClickHandler](this,t))return void(debugPopup&&console.log("\twindowClickHandler"));if(this.currentPopup&&(this.getMap().removePopup(this.currentPopup),this.currentPopup.destroy()),this.featureSelectHandler&&this.featureSelectHandler(t))return void(debugPopup&&console.log("\tfeatureSelectHandler returned true"));let a=t.ramaddaId;if(a||(a=t.id),this.shareSelected&&window.ramaddaDisplaySetSelectedEntry&&ramaddaDisplaySetSelectedEntry(a),!this.getDoPopup())return void(debugPopup&&console.log("\tparams.doPopup=false"));let s=t.inputProps||{};this.hiliteBox(a);let r;if(t.inputProps&&(t.text=this.getPopupText(t.inputProps.text)),t.textGetter?(r=t.textGetter(t),debugPopup&&console.log("\thas textGetter:"+r)):this.textGetter&&(r=this.textGetter(t.layer,t)),r||(r=t.text),!r)return void(debugPopup&&console.log("\tno marker text"));if(this.params.displayDiv)return $("#"+this.params.displayDiv).html(r),void(debugPopup&&console.log("\thad displayDiv"));if(e&&null!=t.locationKey&&(markers=this.seenMarkers[t.locationKey],markers&&markers.length>1)){r="";for(let e=0;e<markers.length;e++){if(otherMarker=markers[e],e>0&&(r+="<hr>"),otherMarker.inputProps&&(otherMarker.text=otherMarker.textGetter?otherMarker.textGetter(t):this.getPopupText(otherMarker.inputProps.text)),r+=otherMarker.text?otherMarker.text:otherMarker.textGetter?otherMarker.textGetter(t):"NA",e>10)break}}let o=t.location,l=null;if(o){if(void 0===o.lon&&(o=MapUtils.createLonLat(o.x,o.y)),r&&""!=r||o.lat==o.lat&&(r="Lon: "+o.lat+"<br>Lat: "+o.lon),t.entryType){let e=t.entryType;if("geo_kml"==e||"geo_json"==e||"geo_shapefile"==e){this.currentEntryMarker=t;let e="ramaddaMapMap['"+this.mapId+"'].handleMarkerLayer();",i=t.entryLayer?"Remove Layer":"Load Layer";r="<center>"+HtmlUtils.onClick(e,i)+"</center>"+r}}l=this.transformLLPoint(o)}else if(t.geometry){let e=t.geometry.getBounds();e&&(l=e.getCenterLonLat())}if(null==l)return console.log("No location for feature popup"),void(debugPopup&&console.log("\tno projPoint"));if(this.showPopupSlider(t.location,r))return;let n={};s.chartType&&(n.width=400);let h=HU.getUniqueId("div"),d=HU.div(["style","width:100%;","id",h]);n.width=n.width??s.minSizeX??this.params.popupWidth,n.height=n.height??s.minSizeY??this.params.popupHeight;let u=this.makePopup(l,d,n);t.popupText=u,u.marker=t,this.getMap().addPopup(u),jqid(h).html(r),debugPopup&&console.log("\tmade popup"),this.currentPopup=u,s.chartType&&this.popupChart(t.inputProps),this.popupHandler&&this.popupHandler(t,u)},popupChart:function(t){let e=getOrCreateDisplayManager(t.divId,{},!0),i={entryId:t.entryId},a=t.title;a||(a="Chart");let s=null==t.fields?null:t.fields.split(","),r={title:a,layoutHere:!0,divid:t.divId,entryId:t.entryId,fields:s,vAxisMinValue:t.vAxisMinValue,vAxisMaxValue:t.vAxisMaxValue,data:new PointData(a,null,null,getRamadda().getRoot()+"/entry/show?entryid="+t.entryId+"&output=points.product&product=points.json&numpoints=10000",i)};if(t.chartArgs){let e=t.chartArgs.split(",");for(let t=0;t<e.length;t+=2)r[e[t]]=e[t+1]}e.createDisplay(t.chartType,r)},uncircleMarker:function(t){feature=this.features[t+"_circle"],feature&&this.circles&&this.circles.removeFeatures([feature]),this.hideFeatureText(feature)},removePoint:function(t){this.removePoints([t])},removePointsLayer:function(){this.circles&&(this.removeLayer(this.circles),this.circles=null)},removeMarkersLayer:function(){this.markers&&(this.removeLayer(this.markers),this.markers=null)},removePoints:function(t){this.circles&&this.circles.removeFeatures(t)},removeMarker:function(t){this.removeMarkers([t])},removeMarkers:function(t){this.markers&&this.markers.removeFeatures(t)},createFeatureLayer:function(t,e,i,a){let s=$.extend({},MapUtils.getVectorStyle("default"));i&&$.extend(s,i),(a=a||{}).style=s;let r=MapUtils.createLayerVector(t||"Markers",a);return this.externalLayers.push(r),this.addVectorLayer(r,e),r}};
