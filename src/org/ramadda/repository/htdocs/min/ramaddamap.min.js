var debugBounds=!1,getMapDebug=!1,debugPopup=!1,debugSelect=!1,RamaddaToFloat=e=>(null!=e&&(e=parseFloat(e)),e),MapUtils={me:"MapUtils",regions:null,POSITIONMARKERID:"location",LABEL_MAP:{aiannhr:"Federal Recognition",mtfcc:"Feature Class",geoid:"Geographic ID",aland:"Land Area",awater:"Water Area",countyfp:"County FIPS",statefp:"State FIPS",namelsad:"Name-LSAD",lsad:"Legal Area Descriptor",aiannhce:"American Indian Census Code",aiannhns:"Anerican Indian Standard Code",classfp:"Class Code",comptyp:"Component Type",intptlat:"Latitude",intptlon:"Longitude",usps:"USPS State Abbrev.",ansicode:"ANSI Code",funcstat:"Functional Status",drawseq:"Draw Sequence",cdsessn:"CD Session",cd115fp:"CD FIPS",affgeoid:"Amer. Fact Finder ID"},properties:{},testSize:{active:!1,out:null,fontUnit:"px",fontSize:3,line:"ABCDEFGHIJKLMNOPQRSTUVWXYZABCD\nABCDEFGHIJKLMNOPQRSTUVWXYZABCD",rows:2,seen:{}},handleSize:function(e){if(!this.testSize.active)return;if(this.testSize.out||(this.testSize.out="let "+this.testSize.fontUnit+"Map={"),this.testSize.seen[this.testSize.fontSize])return;this.testSize.seen[this.testSize.fontSize]=!0;let t=this.testSize.fontSize+":{x:"+Utils.trimDecimals(e.width/this.testSize.line.length,2)+",y:"+Utils.trimDecimals(e.height/this.testSize.rows,2)+"},";console.log(t),this.testSize.out+=t+"\n",24==this.testSize.fontSize&&Utils.makeDownloadFile(this.testSize.fontUnit+"map.txt",this.testSize.out+"\n};\n")},loadTurf:function(e){if(!window.turf){let t=ramaddaCdn+"/lib/turf.min.js";return Utils.loadScript(t,e),!1}return!0},extendBounds:function(e,t){return e?(t&&e.extend(t),e):t},intercept:function(e,t,i,a){let s=e,r=t,o=i,l=a,n=Math.abs(r-l);return n>180&&(n=360-n),s+(180-r)*((o-s)/n)},crossIDL:function(e,t){if(e>0&&t<0||e<0&&t>0){if(Math.abs(e-t)>180)return!0}return!1},addMapProperty:function(e,t){this.properties[e]=t},getMapProperty:function(e,t){return this.properties[e]??t},makeLabel:function(e){if(!e)return e;let t=e.toLowerCase();return this.LABEL_MAP[t]??Utils.makeLabel(e)},stopEvent:function(e){OpenLayers.Event.stop(e)},createGraticule:function(e){return new OpenLayers.Control.Graticule(e)},createLinearRing:function(e){return new OpenLayers.Geometry.LinearRing(e)},createLineString:function(e){return new OpenLayers.Geometry.LineString(e)},createPolygon:function(e){return new OpenLayers.Geometry.Polygon(e)},createVector:function(e,t,i){return new OpenLayers.Feature.Vector(e,t,i)},formatLocationValue:function(e){e=parseFloat(e);let t=Math.pow(10,7);return e=Math.floor(e*t)/t},getVectorStyle:function(e){return OpenLayers.Feature.Vector.style[e]},createStyleMap:function(e){return new OpenLayers.StyleMap(e)},createLonLat:function(e,t){return new OpenLayers.LonLat(RamaddaToFloat(e),RamaddaToFloat(t))},createPoint:function(e,t){return new OpenLayers.Geometry.Point(RamaddaToFloat(e),RamaddaToFloat(t))},getCenter:function(e){return MapUtils.createPoint(e.left+(e.right-e.left)/2,e.bottom+(e.top-e.bottom)/2)},boundsDefined:function(e){return null!=e&&null!=e.left},createBoundsFromPoints:function(e){let t=0,i=0,a=0,s=0;return e.forEach(((e,r)=>{t=0==r?e.x:Math.min(t,e.x),i=0==r?e.x:Math.max(i,e.x),s=0==r?e.y:Math.max(s,e.y),a=0==r?e.y:Math.min(a,e.y)})),this.createBounds(t,a,i,s)},createBounds:function(e,t,i,a,s){if(!Utils.isNumber(e)&&e&&e.left&&!s)return this.createBounds(e.left,e.bottom,e.right,e.top,!0);return new OpenLayers.Bounds(RamaddaToFloat(e),RamaddaToFloat(t),RamaddaToFloat(i),RamaddaToFloat(a))},createPixel:function(e,t){return new OpenLayers.Pixel(e,t)},createSize:function(e,t){return new OpenLayers.Size(e,t)},createMarker:function(e,t){return new OpenLayers.Marker(e,t)},createBox:function(e){return new OpenLayers.Marker.Box(e)},createIcon:function(e,t,i,a){return new OpenLayers.Icon(e,t,i,a)},createImage:function(e,t,i,a){return OpenLayers.Util.createImage(e,t,i,a)},createLayerGeoJson:function(e,t,i){return MapUtils.createLayerVector(t,{projection:e.displayProjection,strategies:[new OpenLayers.Strategy.Fixed],protocol:new OpenLayers.Protocol.HTTP({url:i,format:new OpenLayers.Format.GeoJSON({})})})},createLayerKML:function(e,t,i){return MapUtils.createLayerVector(t,{projection:e.displayProjection,strategies:[new OpenLayers.Strategy.Fixed],protocol:new OpenLayers.Protocol.HTTP({url:i,format:new OpenLayers.Format.KML({extractStyles:!0,extractAttributes:!0,maxDepth:2})})})},createLayerGPX:function(e,t,i){return MapUtils.createLayerVector(t,{strategies:[new OpenLayers.Strategy.Fixed],projection:e.displayProjection,protocol:new OpenLayers.Protocol.HTTP({url:i,format:new OpenLayers.Format.GPX({extractStyles:!0,extractAttributes:!0,maxDepth:2})})})},createLayerImage:function(e,t,i,a,s){return new OpenLayers.Layer.Image(e,t,i,a,s)},createLayerWMS:function(e,t,i){return new OpenLayers.Layer.WMS(e,t,i)},createLayerXYZ:function(e,t,i){return new OpenLayers.Layer.XYZ(e,t,i)},createLayerMarkers:function(e,t){return new OpenLayers.Layer.Markers(e,t)},createLayerBoxes:function(e,t){return new OpenLayers.Layer.Boxes(e,t)},createLayerVector:function(e,t){return new OpenLayers.Layer.Vector(e,t)},createProjection:function(e){return new OpenLayers.Projection(e)},distance:function(e,t,i,a){const s=e*Math.PI/180,r=i*Math.PI/180,o=(i-e)*Math.PI/180,l=(a-t)*Math.PI/180,n=Math.sin(o/2)*Math.sin(o/2)+Math.cos(s)*Math.cos(r)*Math.sin(l/2)*Math.sin(l/2),h=6371e3*(2*Math.atan2(Math.sqrt(n),Math.sqrt(1-n)));return MapUtils.metersToFeet(h)},metersToFeet:function(e){return 3.28084*e},squareMetersToSquareFeet:function(e){return 10.7639*e},calculateArea:function(e){let t=0,i=e=>e*Math.PI/180;if(e.length>2){for(let a=0;a<e.length;a++){let s=e[a],r=a<e.length-1?e[a+1]:e[0];t+=i(r.x-s.x)*(2+Math.sin(i(s.y))+Math.sin(i(r.y)))}return t=6378137*t*6378137/2,t<0&&(t=-t),t=MapUtils.squareMetersToSquareFeet(t),t}return-1},squareFeetInASquareMile:27878400,symbols:{lightning:[0,0,4,2,6,0,10,5,6,3,4,5,0,0],rectangle:[0,0,4,0,4,10,0,10,0,0],diamond:[5,0,10,5,5,10,0,5,5,0],church:[4,0,6,0,6,4,10,4,10,6,6,6,6,14,4,14,4,6,0,6,0,4,4,4,4,0],_x:[0,0,6,6,3,3,6,0,0,6,3,3],thinx:[0,0,6,6,3,3,6,0,0,6,3,3],arrow:[0,0,5,10,10,0],downtriangle:[0,0,5,10,10,0],plane:[5,0,5,0,4,1,4,3,0,5,0,6,4,5,4,8,2,10,3,10,5,9,5,9,8,10,8,10,6,8,6,5,10,6,10,5,6,3,6,1,5,0,5,0]},initSymbols:function(){for(a in this.symbols)OpenLayers.Renderer.symbol[a]=this.symbols[a]},isFeatureVisible:function(e){return!e.style||"none"!=e.style.display},setFeatureVisible:function(e,t){if(!e.style){if(t)return;e.style=e.layer?$.extend({},e.layer.style):{}}e.style.display=t?"inline":"none",$.extend(e.style,{display:e.style.display})},gridFilter:function(e,t,i){let a={fontSize:"12px",padding:2};i&&$.extend(a,i),a.padding=Math.min(10,a.padding);let s={4:{x:1.75,y:5.99},5:{x:2.19,y:7.5},6:{x:2.63,y:8.99},7:{x:3.07,y:10.16},8:{x:3.51,y:11.83},9:{x:3.94,y:13.25},10:{x:4.38,y:14.66},11:{x:4.82,y:16.08},12:{x:5.26,y:17.5},13:{x:5.69,y:19.16},14:{x:6.13,y:20.33},15:{x:6.56,y:22},16:{x:7,y:23.41},17:{x:7.44,y:24.83},18:{x:7.88,y:26.25},19:{x:8.31,y:27.66},20:{x:8.75,y:29.08},21:{x:9.19,y:30.5},22:{x:9.62,y:31.91},23:{x:10.06,y:33.58},24:{x:10.5,y:34.75}},r=(a.fontSize??"12px").match(/^([0-9]+)($|[^\d]+)/),o=12,l="px";r&&(o=parseInt(r[1]),l=r[2]);let n={4:{x:1.31,y:4.5},5:{x:1.64,y:5.62},6:{x:1.97,y:6.75},7:{x:2.3,y:7.87},8:{x:2.63,y:9},9:{x:2.96,y:10},10:{x:3.29,y:11.25},11:{x:3.62,y:12},12:{x:3.94,y:13.25},13:{x:4.27,y:14.25},14:{x:4.6,y:15.24},15:{x:4.93,y:16.5},16:{x:5.26,y:17.5},17:{x:5.58,y:18.75},18:{x:5.91,y:19.75},19:{x:6.24,y:21},20:{x:6.56,y:22},21:{x:6.89,y:22.75},22:{x:7.22,y:24},23:{x:7.55,y:25},24:{x:7.88,y:26.25}};"pt"==l&&(n=s);let h,d=()=>n[o]?n[o]:o<4?n[4]:n[25];if(a.pixelsPerCharacter||(a.pixelsPerCharacter=d().x*a.padding),a.pixelsPerLine||(a.pixelsPerLine=d().y*a.padding),this.testSize.active){let e=++this.testSize.fontSize;t.forEach((t=>{t.style.fontSize=e+this.testSize.fontUnit,t.style.label=this.testSize.line}))}if(t.forEach((t=>{if(t.labelInfo=null,t.geometry&&t.style&&t.style.label){let i=t.style.label.split("\n"),s=0;i.forEach((e=>{s=Math.max(s,e.length)}));let r=t.geometry.getBounds().getCenterLonLat(),o=e.getMap().getViewPortPxFromLonLat(r),l=a.pixelsPerCharacter*s,n=a.pixelsPerLine*i.length,d=o.x-l/2,u=o.x+l/2,c=o.y,p=o.y+n;h?(h.minx=Math.min(h.minx,d),h.maxx=Math.max(h.maxx,u),h.miny=Math.min(h.miny,c),h.maxy=Math.max(h.maxy,p)):h={minx:d,maxx:u,miny:c,maxy:p},t.labelInfo={height:n,width:l,center:r,left:d,right:u,top:c,bottom:p}}})),!h)return;let u=-h.minx,c=-h.miny,p=parseInt(h.maxx+u),m=parseInt(h.maxy+c),g={};t.forEach(((e,t)=>{if(!this.isFeatureVisible(e))return;let i=e.labelInfo,a=parseInt(u+i.left),s=parseInt(c+i.top),r=!0;if(a+e.labelInfo.width<0||s+e.labelInfo.height<0)r=!1,console.log("skipping:",a,s);else{let t=[];a=Math.max(0,a),s=Math.max(0,s);for(let i=a;r&&i<a+e.labelInfo.width&&!(i>=p);i++)for(let a=s;r&&a<s+e.labelInfo.height&&!(a>=m);a++){g[i+"_"+a]?r=!1:t.push([i,a])}r&&t.forEach((e=>{let t=e[0]+"_"+e[1];g[t]=!0}))}this.testSize.active&&(r=!1),r?MapUtils.setFeatureVisible(e,!0):MapUtils.setFeatureVisible(e,!1)}))},makeDefaultFeatureText:function(e,t,i,a){t||(t=Object.keys(e));let s="<table>",r=[],o=[],l=[];return t.forEach((e=>{let t=e.toLowerCase();"latitude"==t||"lat"==t||"longitude"==t||"lon"==t||"long"==t?l.push(e):"name"==t?r.push(e):o.push(e)})),(t=Utils.mergeLists(r,o,l)).forEach((t=>{let r,o,l=t.toLowerCase();if("objectid"!=l&&"feature_type"!=l&&"shapearea"!=l&&"styleurl"!=l&&"shapelen"!=l){if(a&&(r=a(t)),Utils.isDefined(r)||(r=MapUtils.makeLabel(t)),"startdate"==l?r="Start Date":"enddate"==l?r="End Date":"aland"==l?r="Land Area":"awater"==l&&(r="Water Area"),s+="<tr valign=top><td align=right><div style='margin-right:5px;margin-bottom:3px;'><b>"+HU.span(["title",t],r)+":</b></div></td><td><div style='margin-right:5px;margin-bottom:3px;'>",null==e[t]||"object"!=typeof e[t]&&"Object"!=typeof e[t])o=""+e[t];else{o=""+e[t].value}(o.startsWith("http:")||o.startsWith("https:"))&&(o="<a href='"+o+"'>"+o+"</a>"),"null"!=o&&(i&&(o=i(t,o)),s+=o,s+="</div></td></tr>")}})),s+="</table>",s}};MapUtils.defaults={maxLatValue:85,zoomLevels:40,defaultZoomLevel:-1,maxExtent:MapUtils.createBounds(-20037508,-20037508,20037508,20037508),sourceProjection:MapUtils.createProjection("EPSG:900913"),displayProjection:MapUtils.createProjection("EPSG:4326"),units:"m",doSphericalMercator:!0,wrapDateline:!0,location:MapUtils.createLonLat(0,0)},MapUtils.circleHiliteAttrs={strokeColor:"black",strokeWidth:1,fill:!0,fillOpacity:.5,fillColor:"red"};var RAMADDA_MAP_LAYERS=[],RAMADDA_MAP_LAYERS_MAP={};function MapLayer(e,t,i,a){this.opts=a??{},Utils.stringDefined(e)||(e=Utils.makeID(t)),this.id=e,Utils.stringDefined(t)||(t=Utils.makeLabel(e)),this.name=t,this.url=i,RAMADDA_MAP_LAYERS.push(this),RAMADDA_MAP_LAYERS_MAP[e]=this}MapLayer.prototype={isForMap:function(){return!Utils.isDefined(this.opts.isForMap)||this.opts.isForMap},createMapLayer:function(e){return this.layer=this.createMapLayerInner(e),this.layer},createMapLayerInner:function(e){return this.opts.creator?this.opts.creator(this,e):"simple"==this.opts.type?e.makeSimpleWms(this.id):"wms"==this.opts.type?e.addWMSLayer(this.name,this.url,this.opts.layer,!Utils.isDefined(this.opts.isOverlay)||!this.opts.isOverlay):e.createXYZLayer(this.name,this.url,this.opts.attribution,this.opts.isOverlay)}};var map_default_layer="osm";new MapLayer("osm","OSM",["//a.tile.openstreetmap.org/${z}/${x}/${y}.png","//b.tile.openstreetmap.org/${z}/${x}/${y}.png","//c.tile.openstreetmap.org/${z}/${x}/${y}.png"]),new MapLayer("esri.topo","ESRI Topo","https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/${z}/${y}/${x}",{isForMap:!0}),new MapLayer("google.roads","Google Maps - Roads","https://mt0.google.com/vt/lyrs=m&hl=en&x=${x}&y=${y}&z=${z}"),new MapLayer("google.hybrid","Google Maps - Hybrid","https://mt0.google.com/vt/lyrs=y&hl=en&x=${x}&y=${y}&z=${z}"),new MapLayer("esri.street","ESRI Streets","https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/${z}/${y}/${x}"),new MapLayer("opentopo","OpenTopo","//a.tile.opentopomap.org/${z}/${x}/${y}.png}"),new MapLayer("usfs","Forest Service","https://caltopo.com/tile/f16a/${z}/${x}/${y}.png",{attribution:"Map from Caltopo"}),new MapLayer("caltopo.mapbuilder","MapBuilder Topo","https://img.caltopo.com/tile/mbt/${z}/${x}/${y}.png",{attribution:"Map from Caltopo"}),new MapLayer("usgs.topo","USGS Topo","https://basemap.nationalmap.gov/ArcGIS/rest/services/USGSTopo/MapServer/tile/${z}/${y}/${x}",{attribution:"USGS - The National Map"}),new MapLayer("google.terrain","Google Maps - Terrain","https://mt0.google.com/vt/lyrs=p&hl=en&x=${x}&y=${y}&z=${z}"),new MapLayer("google.satellite","Google Maps - Satellite","https://mt0.google.com/vt/lyrs=s&hl=en&x=${x}&y=${y}&z=${z}"),new MapLayer("naip","NAIP Imagery","https://caltopo.com/tile/n/${z}/${x}/${y}.png",{attribution:"Map from Caltopo"}),new MapLayer("usgs.imagery","USGS Imagery","https://basemap.nationalmap.gov/ArcGIS/rest/services/USGSImageryOnly/MapServer/tile/${z}/${y}/${x}",{attribution:"USGS - The National Map"}),new MapLayer("esri.shaded","ESRI Shaded Relief","https://server.arcgisonline.com/ArcGIS/rest/services/World_Shaded_Relief/MapServer/tile/${z}/${y}/${x}"),new MapLayer("esri.lightgray","ESRI Light Gray","https://services.arcgisonline.com/arcgis/rest/services/Canvas/World_Light_Gray_Base/MapServer/tile/${z}/${y}/${x}"),new MapLayer("esri.darkgray","ESRI Dark Gray","https://services.arcgisonline.com/arcgis/rest/services/Canvas/World_Dark_Gray_Base/MapServer/tile/${z}/${y}/${x}"),new MapLayer("esri.terrain","ESRI Terrain","https://server.arcgisonline.com/ArcGIS/rest/services/World_Terrain_Base/MapServer/tile/${z}/${y}/${x}"),new MapLayer("shadedrelief","Shaded Relief","https://caltopo.com/tile/hs_m315z45s3/${z}/${x}/${y}.png",{attribution:"Map from Caltopo"}),new MapLayer("publiclands","Public Lands","https://caltopo.com/tile/sma/${z}/${x}/${y}.png",{attribution:"Map from Caltopo",isOverlay:!0}),new MapLayer("federallands","Federal Lands",["//gis.blm.gov/arcgis/rest/services/lands/BLM_Natl_SMA_Cached_without_PriUnk/MapServer/tile/${z}/${y}/${x}"]),new MapLayer("seafloor","Seafloor",["//tiles.arcgis.com/tiles/C8EMgrsFcRFL6LrL/arcgis/rest/services/GEBCO_basemap_NCEI/MapServer/tile/${z}/${y}/${x}"]),new MapLayer("historic","Historic","https://caltopo.com/tile/1900/${z}/${x}/${y}.png",{attribution:"Map from Caltopo",isOverlay:!0}),new MapLayer("esri.aeronautical","ESRI Aeronautical","https://wms.chartbundle.com/mp/service",{type:"wms",layer:"sec"}),new MapLayer("osm.toner","OSM-Toner","https://tiles.stadiamaps.com/tiles/stamen_toner/${z}/${x}/${y}.png"),new MapLayer("osm.toner.lite","OSM-Toner Lite","https://tiles.stadiamaps.com/tiles/stamen_toner_lite/${z}/${x}/${y}.png"),new MapLayer("cartolight","Carto-Light","https://cartodb-basemaps-a.global.ssl.fastly.net/light_all/${z}/${x}/${y}.png"),new MapLayer("moon","Moon","https://cartocdn-gusc.global.ssl.fastly.net/opmbuilder/api/v1/map/named/opm-moon-basemap-v0-1/all/${z}/${x}/${y}.png"),new MapLayer("mars","Mars","https://cartocdn-gusc.global.ssl.fastly.net/opmbuilder/api/v1/map/named/opm-mars-basemap-v0-1/all/${z}/${x}/${y}.png"),new MapLayer("lightblue","","",{type:"simple"}),new MapLayer("blue","","",{type:"simple"}),new MapLayer("white","","",{type:"simple"}),new MapLayer("black","","",{type:"simple"}),new MapLayer("gray","","",{type:"simple"}),MapUtils.initSymbols();var ARG_ZOOMLEVEL="zoomLevel",ARG_MAPCENTER="mapCenter",ramaddaMapMap={};function ramaddaMapAdd(e){null==window.globalMapList&&(window.globalMapList=[]),window.globalMapList.push(e),ramaddaMapMap[e.mapId]=e}function ramaddaMapRemove(e){null==window.globalMapList&&(window.globalMapList=[]),window.globalMapList.push(e),delete ramaddaMapMap[e.mapId]}function ramaddaMapCheckLayout(){setTimeout((()=>{null!=window.globalMapList&&window.globalMapList.map((e=>{e.map.updateSize()}))}),1e3)}var ramaddaMapLastShareTime=0,ramaddaMapLastShareMap="";function ramaddaMapShareState(e,t){let i=(new Date).getTime();if(e.mapId!=ramaddaMapLastShareMap&&i-ramaddaMapLastShareTime<2e3)return;if(ramaddaMapLastShareTime=i,ramaddaMapLastShareMap=e.mapId,e.stateIsBeingSet)return;let a=e.params.linkGroup;if(e.params.linked||e.params.linkMouse||a){e.getBounds(),e.map.baseLayer,e.map.getZoom();for(var s=0;s<window.globalMapList.length;s++){var r=window.globalMapList[s];r.stateIsBeingSet||r.mapId==e.mapId||a==r.params.linkGroup&&(r.stateIsBeingSet=!0,r.receiveShareState(e,t),r.stateIsBeingSet=!1)}}}function RepositoryMap(e,t){ramaddaMapAdd(this);let i=this;t||(t={}),this.params=t,this.mapId=e||"map",[ARG_MAPCENTER,ARG_ZOOMLEVEL].forEach((e=>{Utils.stringDefined(HU.getUrlArgument(e))&&(t[e]=HU.getUrlArgument(e),debugBounds&&console.log("url arg:"+e+"="+t[e]))})),t.mapCenter&&([lat,lon]=t.mapCenter.replace("%2C",",").split(","),t.initialLocation={lon:lon,lat:lat});let a=!0;t.simple&&(a=!1);let s={pointRadius:3,strokeColor:"blue",strokeWidth:1,fillOpacity:.8,fillColor:"#e6e6e6",layerStrokeColor:"blue",layerStrokeWith:1,layerFillColor:"#ccc",layerFillOpacity:.3,highlightStrokeColor:"red",highlightFillColor:"match",highlightStrokeWidth:2,highlightFillOpacity:.5,selectStrokeColor:null,selectStrokeOpacity:null,selectFillColor:null,selectStrokeWidth:null,selectFillOpacity:.4,maxZoom:18,singlePointZoom:7,scrollToZoom:!0,selectOnHover:!1,highlightOnHover:!0,showLocationSearch:!1,imageOpacity:1,iconSize:null,iconWidth:null,iconHeight:null,changeSizeOnSelect:!0,tickSelectColor:"red",tickHoverColor:"blue",tickColor:"#888",showDates:!0,defaultMapLayer:map_default_layer,displayDivSticky:!0,showLayerToggle:!1,showLatLonLines:!1,showScaleLine:a,showLayerSwitcher:a,showLatLonPosition:!1,showZoomPanControl:!1,showZoomOnlyControl:!0,enableDragPan:!0,showSearch:!1,showBookmarks:!1,showBounds:!0,showOpacitySlider:!1,doPopup:!0,doPopupSlider:!1,popupWidth:400,popupHeight:250,popupSliderRight:!1,doSelect:!0,addMarkerOnClick:!1,linked:!1,linkGroup:null,linkMouse:!1};Utils.isDefined(t.initialZoom)?debugBounds&&console.log("initial zoom already set:",t.initialZoom):(t.initialZoom=Utils.isDefined(t[ARG_ZOOMLEVEL])?t[ARG_ZOOMLEVEL]:MapUtils.defaults.defaultZoomLevel,debugBounds&&console.log("setting initial zoom:",t.initialZoom)),$.extend(s,t),t=this.params=s,this.getProperty=(e,t)=>Utils.isDefined(this.params[e])?this.params[e]:t,$.extend(this,{name:"map",map:null,sourceProjection:MapUtils.defaults.sourceProjection,displayProjection:MapUtils.defaults.displayProjection,projectionUnits:MapUtils.defaults.units,mapDivId:this.mapId,defaultLocation:MapUtils.defaults.location,latlonReadout:null,haveAddedDefaultLayer:!1,defaultCanSelect:!0,layer:null,markers:null,vectors:null,allLayers:[],externalLayers:[],loadedLayers:[],nonSelectLayers:[],shareSelected:!1,boxes:null,kmlLayer:null,kmlLayerName:null,geojsonlLayer:null,geojsonLayerName:null,vectorLayers:[],features:{},lines:null,selectorBox:null,selectorMarker:null,listeners:[],fixedText:!1,initialLayers:[],imageLayers:{},imageLayersList:[]}),this.seenMarkers={},this.startDate=null,this.endDate=null,this.startFeature=null,this.endFeature=null,this.basePointStyle=null,this.defaultStyle={pointRadius:this.params.pointRadius,fillOpacity:this.params.fillOpacity,fillColor:this.params.fillColor,fill:this.params.fill,strokeColor:this.params.strokeColor,strokeWidth:this.params.strokeWidth},this.highlightStyle={strokeColor:this.params.highlightStrokeColor,strokeWidth:this.params.highlightStrokeWidth,fillColor:this.params.highlightFillColor,fillOpacity:this.params.highlightFillOpacity},Utils.isDefined(t.onSelect)?this.onSelect=t.onSelect:this.onSelect=null,t.initialLocation?(Array.isArray(t.initialLocation)?this.defaultLocation=MapUtils.createLonLat(t.initialLocation[1],t.initialLocation[0]):this.defaultLocation=MapUtils.createLonLat(t.initialLocation.lon,t.initialLocation.lat),debugBounds&&console.log("setting default location:"+this.defaultLocation)):Utils.isDefined(t.initialBounds)&&("string"==typeof t.initialBounds&&(t.initialBounds=t.initialBounds.split(",")),this.defaultBounds=MapUtils.createBounds(t.initialBounds[1],t.initialBounds[2],t.initialBounds[3],t.initialBounds[0]),this.defaultLocation=null,debugBounds&&console.log("setting default bounds-1:"+this.defaultBounds));var r={projection:this.sourceProjection,displayProjection:this.displayProjection,units:this.projectionUnits,controls:[],maxResolution:156543.0339,maxExtent:MapUtils.defaults.maxExtent,div:this.mapDivId,zoom:this.params.initialZoom,eventListeners:{featureover:function(e){i.featureOverHandler?i.featureOverHandler(e):i.handleFeatureover(e.feature)},featureout:function(e){i.featureOutHandler?i.featureOutHandler(e):i.handleFeatureout(e.feature)},nofeatureclick:function(e){debugSelect&&console.log("nofeatureclick"),i.handleNofeatureclick(e,e.layer)},featureclick:function(e){if(debugSelect&&console.log("featureclick"),i.featureClickHandler&&!i.featureClickHandler(e))return;if(e.feature&&e.feature.noSelect)return;let t=(new Date).getTime();Utils.isDefined(i.lastClickTime)&&t-i.lastClickTime<500||(i.lastClickTime=t,i.handleFeatureclick(e.layer,e.feature,!1,e))}}};this.mapOptions=r,this.finishMapInit(),jQuery(document).ready((function(e){i.getMap()&&i.getMap().updateSize()}))}OpenLayers.Control.Click=OpenLayers.Class(OpenLayers.Control,{listeners:null,addListener:function(e){null==this.listeners&&(this.listeners=[]),this.listeners.push(e)},defaultHandlerOptions:{single:!0,double:!1,pixelTolerance:0,stopSingle:!1,stopDouble:!1},initialize:function(e){this.handlerOptions=$.extend({},this.defaultHandlerOptions),OpenLayers.Control.prototype.initialize.apply(this,arguments),this.handler=new OpenLayers.Handler.Click(this,{click:this.trigger},this.handlerOptions)},setLatLonZoomFld:function(e,t,i,a){this.lonFldId=e,this.latFldId=t,this.zoomFldId=i,this.clickListener=a},setTheMap:function(e){this.theMap=e},trigger:function(e){let t=this.theMap.getMap().getLonLatFromViewPortPx(e.xy),i=this.theMap.transformProjPoint(t);if(null!=this.listeners)for(var a=0;a<this.listeners.length;a++)this.listeners[a](i);this.lonFldId||(this.lonFldId="lonfld",this.latFldId="latfld",this.zoomFldId="zoomfld");let s=GuiUtils.getDomObject(this.lonFldId),r=GuiUtils.getDomObject(this.latFldId),o=GuiUtils.getDomObject(this.zoomFldId);r&&s&&(r.obj.value=MapUtils.formatLocationValue(i.lat),s.obj.value=MapUtils.formatLocationValue(i.lon)),o&&(o.obj.value=this.theMap.getMap().getZoom()),(this.theMap.getProperty("addMarkerOnClick")||this.theMap.selectorMarker)&&this.theMap.addSelectionMarker(i),Utils.isDefined(this.clickListener)&&this.clickListener.handleClick(this,e,i.lon,i.lat)}});var markerMap={};function ramaddaFindFeature(e,t){for(var i=0;i<e.features.length;i++){var a=e.features[i],s=a.geometry;if(s&&(bounds=s.getBounds(),bounds.contains(t.x,t.y)))if(s.components){for(var r=0;r<s.components.length;r++)if(comp=s.components[r],bounds=comp.getBounds(),bounds.contains(t.x,t.y)&&comp.containsPoint&&comp.containsPoint(t))return{feature:a,index:i}}else{if(!s.containsPoint){console.log("unknown geometry:"+s.CLASS_NAME);continue}if(s.containsPoint(t))return{feature:a,index:i}}}return null}RepositoryMap.prototype={firstCustomRegion:!0,CUSTOM_MAP:"CUSTOM",validBounds:function(e){return!!e&&!(isNaN(e.bottom)||isNaN(e.left)||isNaN(e.right)||isNaN(e.top))},centerOnMarkers:function(e,t,i){debugBounds&&console.log("centerOnMarkers: force="+t+" dflt:"+e+" justMarkers:"+i),this.centerOnMarkersCalled=!0,this.centerOnMarkersForce=t;Date.now();let a=null;if(e&&(e.left<-180||e.left>180||e.right<-180||e.right>180||e.bottom<-90||e.bottom>90||e.top<-90||e.top>90)&&(e=MapUtils.createBounds(-180,-90,180,90)),this.dfltBounds=e,!t){let e=!1;if(i||this.externalLayers.forEach((t=>{let i=t.getDataExtent();debugBounds&&console.log("centerOnMarkers using external layer"),a=MapUtils.extendBounds(a,this.transformProjBounds(i)),e=!0})),this.markers){let t=this.markers.getDataExtent();debugBounds&&console.log("centerOnMarkers using markers.getDataExtent"),a=MapUtils.extendBounds(a,this.transformProjBounds(t)),e=!0}if(a&&isNaN(a.left)&&(a=null),this.circles){let t=this.circles.getDataExtent(),i=this.transformProjBounds(t);a=MapUtils.extendBounds(a,i),e=!0,debugBounds&&console.log("centerOnMarkers using circles.getDataExtent:"+i)}if(a&&isNaN(a.left)&&(a=null),!a||!e||!i){if(this.lines){let e=this.lines.getDataExtent();a=MapUtils.extendBounds(a,this.transformProjBounds(e)),debugBounds&&console.log("centerOnMarkers using lines.getDataExtent")}for(let e in this.getMap().layers){if(e=this.getMap().layers[e],!e.getDataExtent)continue;if(e.isBaseLayer||!e.getVisibility())continue;let t=e.getDataExtent();if(t){let i=this.transformProjBounds(t);if(!this.validBounds(i))continue;a=MapUtils.extendBounds(a,i),debugBounds&&console.log("centerOnMarkers using layer.getDataExtent: "+i+" layer="+e.name+" "+e.ramaddaId)}}}}if(a||(debugBounds&&console.log("centerOnMarkers using dfltBounds: "+e),a=e),a){if(!this.getMap())return this.defaultBounds=a,void(debugBounds&&console.log("centerOnMarkers: no map"));a.getHeight()>160&&(a.top=80,a.bottom=-80,debugBounds&&console.log("centerOnMarkers resetting height")),debugBounds&&console.log("calling setViewToBounds: "+a),this.setViewToBounds(a)}else debugBounds&&console.log("centerOnMarkers: no bounds")},initRegionSelector:function(e,t,i){this.regionSelector=$("#"+e),this.mapWidgetDiv=$("#"+t),this.mapWidgetDiv.hide(),$(document).ready((()=>{this.regionSelector.val()!=this.CUSTOM_MAP?this.mapWidgetDiv.hide():this.initMap(i),this.regionSelector.change((()=>{this.mapRegionSelected()})),this.mapRegionSelected()}))},mapRegionSelected:function(){let e=this.regionSelector.val();if(null===e)return void console.log("Error: No map region value");if(""==e)return void this.toggleMapWidget(!1);let t=e.split(",");if(1==t.length)return t[0]!=this.CUSTOM_MAP?void 0:(this.firstCustomRegionm||this.setMapRegion("","","","",""),this.firstCustomRegion=!1,void this.toggleMapWidget(!0));5==t.length&&(this.toggleMapWidget(!1),this.setMapRegion(t[0],t[1],t[2],t[3],t[4]))},setMapRegion:function(e,t,i,a,s){let r=this.mapId;$("#"+r+"_regionid").val(e),$("#"+r+"_north").val(t),$("#"+r+"_west").val(i),$("#"+r+"_south").val(a),$("#"+r+"_east").val(s)},toggleMapWidget:function(e){e?(this.inited||this.initMap(!0),this.mapWidgetDiv.show()):this.mapWidgetDiv.hide()},setViewToBounds:function(e){e.left,e.right;let t=this.transformLLBounds(e);0==t.getWidth()?(debugBounds&&console.log("setViewToBounds center max zoom:"+this.params.maxZoom),this.getMap().setCenter(t.getCenterLonLat()),this.zoomTo(this.params.singlePointZoom),this.getMap().setCenter(t.getCenterLonLat())):(this.getMap().setCenter(t.getCenterLonLat()),this.zoomToExtent(t)),this.getMap().getZoom()>this.params.maxZoom&&(debugBounds&&console.log("setViewToBounds- setting to max zoom",this.params.maxZoom),this.zoomTo(this.params.maxZoom))},setCenter:function(e){debugBounds&&console.log("setCenter"),this.getMap().setCenter(this.transformLLPoint(e))},getZoom:function(){return this.getMap().getZoom()},setZoom:function(e){this.zoomTo(e)},zoomTo:function(e,t){e<0&&(e=this.params.singlePointZoom),t&&e<this.getZoom()||(debugBounds&&console.log("zoomTo:",e),this.getMap().zoomTo(parseInt(e)))},zoomToLayer:function(e,t){let i=this.getLayerVisbileExtent(e);i||(i=e.extent),debugBounds&&console.log("zoomToLayer:",i),i&&(t&&(i=i.scale(parseFloat(t),i.getCenterPixel())),this.zoomToExtent(i,!1))},zoomToBounds:function(e){this.getMap().setCenter(e.getCenterLonLat()),this.zoomToExtent(e)},zoomToMarkers:function(){this.zoomToLayer(this.markers)},zoomToExtent:function(e,t){debugBounds&&console.log("zoomToExtent:",e);let i=e=>!isNaN(e)&&Utils.isDefined(e);if(i(e.left)&&i(e.right)&&i(e.top)&&i(e.bottom))if(e.left!=e.right&&e.top!=e.bottom)this.getMap().zoomToExtent(e,t);else{var a=(e=this.transformProjBounds(e)).getCenterLonLat();this.setCenter(a)}else debugBounds&&console.error("zoomToExtent: bounds are bad:"+e)},centerToMarkers:function(){this.markers&&(bounds=this.markers.getDataExtent(),debugBounds&&console.log("centerToMarkers"),this.getMap().setCenter(bounds.getCenterLonLat()))},setInitialCenterAndZoom:function(e,t,i){this.defaultLocation=MapUtils.createLonLat(e,t),this.setInitialZoom(i),this.params.initialZoom=i},setInitialZoom:function(e){this.params.initialZoom=e,debugBounds&&console.log("setInitialZoom:",this.params.initialZoom)},setInitialCenter:function(e,t){this.defaultLocation=MapUtils.createLonLat(e,t)},finishMapInit:function(){let e=this;if(this.params.showSearch){this.searchDiv=this.mapDivId+"_search";let t=HtmlUtils.checkbox(this.searchDiv+"_download",[],!1),i="<table width=100%><tr><td>"+('<input placeholder="Search - ? for help" id="'+this.searchDiv+'_input" size=40>')+' <span  id="'+this.searchDiv+'_message"></span></td><td align=right>'+t+" Download</td></tr></table>";$("#"+this.searchDiv).html(i),this.searchMsg=$("#"+this.searchDiv+"_message");let a=$("#"+this.searchDiv+"_input");a.keypress((function(t){13==t.which&&e.searchFor(a.val())}))}let t=e=>this.mapDivId+"_"+e,i=HU.open("table",[STYLE,HU.css("height","100%"),WIDTH,"100%","border","0"]),a=HtmlUtils.div([CLASS,"ramadda-map-inner","style","width:100%;height:100%;position:relative;","id",t("themap")]);i+=HU.tr([STYLE,HU.css("height","100%")],HU.td([WIDTH,"100%"],a)),i+="</table>",$("#"+this.mapDivId).html(a),$("#"+t("themap")).append(HtmlUtils.div(["id",t("progress"),CLASS,"ramadda-map-progess","style","z-index:3000;position:absolute;top:10px;left:40%;"],"")),$("#"+t("themap")).append(HtmlUtils.div(["id",t("label"),"style","z-index:1000;position:absolute;bottom:10px;left:10px;"],"")),$("#"+t("themap")).append(HtmlUtils.div(["id",t("toolbar"),"style","z-index:1000;position:absolute;top:10px;left:50%;    transform: translateX(-50%);"],"")),this.map=new OpenLayers.Map(this.mapDivId+"_themap",this.mapOptions);setTimeout((function(){e.getMap().events.register("changebaselayer","",(function(){e.baseLayerChanged()})),e.getMap().events.register("zoomend","ramaddamap",(function(){e.zoomChanged(),e.locationChanged(),e.setNoPointerEvents(),debugBounds&&console.log("zoomend",e.getMap().getZoom())})),e.getMap().events.register("moveend","ramaddamap",(function(){e.locationChanged()})),e.getMap().events.register("move","ramaddamap",(function(){e.locationChanged()}))}),5e3),this.mapHidden&&(this.getMap().size=MapUtils.createSize(1,1));try{window.initExtraMap&&initExtraMap(this)}catch(e){console.log("Error calling initExtraMap:"+e)}if(this.addBaseLayers(),this.kmlLayer){var s=ramaddaBaseUrl+"/entry/show?output=shapefile.kml&entryid="+this.kmlLayer;this.addKMLLayer(this.kmlLayerName,s,!1,null,null,null,null)}if(this.geojsonLayer){s=getRamadda().getEntryDownloadUrl(this.geojsonLayer);this.addGeoJsonLayer(this.geojsonLayerName,s,!1,null,null,null,null)}setTimeout((()=>{let t="Image Opacity:&nbsp;"+HU.div([ID,this.mapDivId+"_opacity_slider_div",STYLE,HU.css("display","inline-block","width","150px")],"");t=HU.span(["id",this.mapDivId+"_opacity_slider","style",this.params.showOpacitySlider?"display:inline":"display:none"],t),$("#"+this.mapDivId+"_header").append(t),$("#"+this.mapDivId+"_opacity_slider_div").slider({min:0,max:1,step:.05,value:e.params.imageOpacity,slide:function(t,i){e.params.imageOpacity=i.value,e.imageLayersList&&(e.allLayers.forEach((t=>{Utils.isDefined(t.canTakeOpacity)&&t.setOpacity(e.params.imageOpacity)})),e.imageLayersList.forEach((t=>{t.setOpacity(e.params.imageOpacity)})))}})}),200),this.getProperty("addMarkerOnClick")&&this.setSelection(),setTimeout((()=>{let e=document.querySelector("#"+this.mapDivId+"_themap");e&&new ResizeObserver(Utils.throttle((()=>{this.getMap()&&this.getMap().updateSize()}),1e3)).observe(e)}),1e3)},showOpacitySlider:function(e){this.params.showOpacitySlider=e,e?$("#"+this.mapDivId+"_opacity_slider").css("display","inline"):$("#"+this.mapDivId+"_opacity_slider").css("display","none")},getBounds:function(){return this.transformProjBounds(this.getMap().getExtent())},zoomChanged:function(){},receiveShareState:function(e,t){if(t.center){if(!this.params.linked)return;this.getMap().setCenter(t.center,t.zoom)}else if(t.marker)this.params.addMarkerOnClick&&this.addSelectionMarker(t.marker,!0);else if(t.mouse){if(!this.params.linkMouse)return;this.sharedMouse&&this.getMarkersLayer().removeFeatures([this.sharedMouse],{silent:!0}),this.sharedMouse=this.addPoint("mouse",t.mouse,{},"")}},locationChanged:function(){ramaddaMapShareState(this,{center:this.map.getCenter(),zoom:this.map.getZoom()}),this.pendingLocationChangeTimeout&&clearTimeout(this.pendingLocationChangeTimeout),this.pendingLocationChangeTimeout=setTimeout((()=>{this.locationChangedInner(),this.pendingResizeTimeout=null}),500)},locationChangedInner:function(){let e=this.getBounds(),t=1e5,i=e=>Math.round(e*t)/t;e.top=i(e.top),e.left=i(e.left),e.bottom=i(e.bottom),e.right=i(e.right),HU.addToDocumentUrl("map_bounds",e.top+","+e.left+","+e.bottom+","+e.right),debugBounds&&console.log("locationChanged: setting url args:",this.getMap().getZoom()),HU.addToDocumentUrl(ARG_ZOOMLEVEL,this.getMap().getZoom());let a=this.transformProjPoint(this.getMap().getCenter());HU.addToDocumentUrl(ARG_MAPCENTER,i(a.lat)+","+i(a.lon))},baseLayerChanged:function(){let e=this.getMap().baseLayer;e&&(e=e.ramaddaId,HU.addToDocumentUrl("defaultMapLayer",e),ramaddaMapShareState(this,"baseLayer"))},appendToolbar:function(e){$("#"+this.mapDivId+"_toolbar").append(e)},setMapDiv:function(e){this.mapHidden=!1,this.mapDivId=e,this.getMap().render(this.mapDivId),this.getMap().updateSize(),this.centerOnMarkers(this.dfltBounds)},addPopup:function(e){this.currentPopup=e,this.getMap().addPopup(e)},makePopup:function(e,t,i){debugPopup&&console.log("makePopup:"+t),i=i||{};let a=MapUtils.createSize(i.width||this.params.popupWidth||200,i.height||this.params.popupHeight||200);return new OpenLayers.Popup("popup",e,a,t,!0,i.callback?i.callback:()=>{this.onPopupClose()})},highlightMarkers:function(e,t,i,a){let s=this;t||(t="#ffffcc"),$(e).mouseenter((function(){t&&$(this).css("background",t),$(this).data("mapid")&&(s.circleMarker($(this).data("mapid"),MapUtils.circleHiliteAttrs)||null!=a&&(Utils.isDefined($(this).data("latitude"))?(attrs={pointRadius:12,stroke:!0,strokeColor:"blue",strokeWidth:2,fill:!1},point=s.addPoint(a,MapUtils.createLonLat($(this).data("longitude"),$(this).data("latitude")),attrs),markerMap[a]=point):console.log("no lat")))})),$(e).mouseleave((function(){i?$(this).css("background",i):$(this).css("background","transparent"),$(this).data("mapid")&&(a&&markerMap[a]&&(s.removePoint(markerMap[a]),markerMap[a]=null),s.uncircleMarker($(this).data("mapid")))}))},applyHighlightStyle:function(e){["pointRadius","highlightStrokeColor","highlightStrokeWidth","highlightFillColor","highlightFillOpacity"].forEach((t=>{if(Utils.isDefined(e[t])){let i=e[t];this.params[t]=i;let a=t.replace("highlight","");a=a.substring(0,1).toLowerCase()+a.substring(1),this.highlightStyle[a]=i}}))},getLayerHighlightStyle:function(e){let t=$.extend({},this.highlightStyle);return e.highlightStyle&&$.extend(t,e.highlightStyle),t},checkMatchStyle(e,t){["pointRadius","fillColor","fillOpacity","strokeColor","strokeOpacity","strokeWidth"].forEach((i=>{"match"==t[i]&&(Utils.stringDefined(e[i])?t[i]=e[i]:t[i]="transparent")}))},handleFeatureover:function(e,t){if(this.selectedFeature)return;if(this.doMouseOver||e.highlightText||e.highlightTextGetter){let t=e.location;if(t&&this.highlightFeature!=e){this.closeHighlightPopup();let i=this.transformLLPoint(t),a=e.highlightTextGetter?e.highlightTextGetter(e):e.highlightText;Utils.stringDefined(a)||(a=e.text),Utils.stringDefined(a)&&(a=HtmlUtils.div(["style","padding:2px;"],a),this.highlightPopup=new OpenLayers.Popup("popup",i,e.highlightSize,a,!1),this.highlightPopup.backgroundColor=this.highlightBackgroundColor||"#ffffcc",this.highlightPopup.autoSize=!0,this.highlightPopup.keepInMap=!0,this.highlightPopup.padding=0,this.addPopup(this.highlightPopup))}}let i=e.layer;if(!0===i.isMapLayer){if(!1!==i.canSelect&&!i.noHighlight&&!e.isSelected&&(this.highlightFeature(e),this.params.displayDiv&&(this.displayedFeature=e,!t))){this.pendingDisplayTextTimeout&&clearTimeout(this.pendingDisplayTextTimeout);let t=()=>{if(this.displayedFeature==e){let t=this.getFeatureText(i,e);this.showText(t),this.dateFeatureOver(e)}};this.pendingDisplayTextTimeout=setTimeout(t,500)}}else!t&&e.text&&this.showFeatureText(e)},unhighlightFeature:function(e){e.originalStyle&&(e.style=e.originalStyle,e.layer.drawFeature(e))},highlightFeature:function(e,t){let i=e.style;e.originalStyle=e.style,e.style=null;let a=e.layer,s=$.extend({},t??this.getLayerHighlightStyle(a));"transparent"!=s.fillColor&&"match"!=s.fillColor&&e.originalStyle&&(s.fillColor=Utils.brighterColor(e.originalStyle.fillColor||s.fillColor,.4)??s.fillColor),Utils.isDefined(s.fillOpacity)||(s.fillOpacity=.3),i=i??{},this.checkMatchStyle(i,s),i.strokeWidth&&(s.strokeWidth=+i.strokeWidth+1),Utils.stringDefined(i.externalGraphic)&&!Utils.stringDefined(s.externalGraphic)&&(s.externalGraphic=i.externalGraphic,i.graphicWidth&&(s.graphicWidth=1.3*i.graphicWidth),i.graphicHeight&&(s.graphicHeight=1.3*i.graphicHeight)),i.pointRadius&&!s.pointRadius&&(s.pointRadius=1.2*i.pointRadius),i.externalGraphic&&!s.externalGraphic&&(s.externalGraphic=i.externalGraphic,s.fillOpacity=1),e.layer.drawFeature(e,s)},closeHighlightPopup:function(){if(this.highlightPopup){this.getMap().removePopup(this.highlightPopup);try{this.highlightPopup.destroy()}catch(e){}this.highlightPopup=null,this.highlightFeature=null}},handleFeatureout:function(e,t){this.displayedFeature==e&&(this.displayedFeature=null,this.pendingDisplayTextTimeout&&clearTimeout(this.pendingDisplayTextTimeout),this.pendingDisplayTextTimeout=null),this.closeHighlightPopup();let i=e.layer;i&&!0!==i.isMapLayer?t||e.text&&!this.fixedText&&this.hideFeatureText(e):null!=i&&!1!==i.canSelect&&(e.originalStyle&&(e.style=e.originalStyle),e.isSelected||i.drawFeature(e,e.style||"default"),this.dateFeatureOut(e),t||this.displayedFeature!=e||this.fixedText||this.params.displayDivSticky||this.showText(""))},getLayerCanSelect:function(e){return!!e&&e.canSelect},handleNofeatureclick:function(e,t){if(Utils.isDefined(this.lastClickTime)){if((new Date).getTime()-this.lastClickTime<2e3)return}this.closePopup(),HtmlUtils.hidePopupObject(),!1!==t.canSelect&&t&&t.selectedFeature&&(this.unselectFeature(t.selectedFeature),this.clearDateFeature())},handleFeatureclick:function(e,t,i,a){if(e||(e=t.layer),debugPopup&&console.log("handleFeatureClick"),this.dateFeatureSelect(t),!1===e.canSelect)return void(debugPopup&&console.log("\tlayer no select"));if(e.selectedFeature&&this.unselectFeature(e.selectedFeature),!this.params.doSelect)return void(debugPopup&&console.log("\tparams no select"));this.selectedFeature=t,e.selectedFeature=t,e.selectedFeature.isSelected=!0;let s=t.style??{},r={};e.style&&$.extend(r,e.style),$.extend({},t.style);let o=this.getLayerHighlightStyle(e);if($.extend(r,{strokeColor:this.params.selectStrokeColor??o.strokeColor,strokeWidth:this.params.selectStrokeWidth??o.strokeWidth,strokeOpacity:this.params.selectStrokeOpacity??.75,fillColor:this.params.selectFillColor??o.fillColor,fillOpacity:this.params.selectFillOpacity??o.fillOpacity,pointRadius:this.params.selectPointRadius??o.pointRadius??s.pointRadius,fill:!0}),this.params.changeSizeOnSelect&&Utils.isDefined(r.pointRadius)&&(r.pointRadius=Math.round(1.5*r.pointRadius)),"transparent"!=r.fillColor&&(r.fillColor=this.params.selectFillColor||o.fillColor),"match"==r.fillColor&&(r.fillColor=r.strokeColor),this.checkMatchStyle(s,r),t.style&&t.style.externalGraphic&&(r=$.extend({},t.style),r.fillOpacity=.6,this.params.changeSizeOnSelect&&(Utils.isDefined(r.graphicHeight)&&(r.graphicHeight*=1.5,r.graphicYOffset=-r.graphicHeight/2),Utils.isDefined(r.graphicWidth)&&(r.graphicWidth*=1.5,r.graphicXOffset=-r.graphicWidth/2))),e.drawFeature(e.selectedFeature,r),e.selectCallback?(e.feature=e.selectedFeature,t.originalStyle&&(t.style=t.originalStyle),debugPopup&&console.log("\thave a selectCallback"),e.selectCallback(e.feature,e,a)):(debugPopup&&console.log("\tcalling showMarkerPopup"),this.showMarkerPopup(t,!0)),i){let e=t.geometry;if(e){let t=e.getBounds();t&&(this.zoomToExtent(t),this.getMap().setCenter(t.getCenterLonLat()))}}},unselectFeature:function(e){if(!e)return;e.renderIntent=null,e.isSelected=!1;let t=e.layer;t&&(t.drawFeature(t.selectedFeature,t.selectedFeature.style||"default"),t.selectedFeature.isSelected=!1,t.selectedFeature=null,this.selectedFeature=null,this.onPopupClose())},handleEntrySelect:function(e,t,i){if("geo_kml"!=i&&"geo_json"!=i&&"geo_shapefile"!=i)return null;var a;if("geo_kml"==i){var s=ramaddaBaseUrl+"/entry/get?entryid="+e;a=this.addKMLLayer(t,s,!0,null,null,null,null,!0)}else if("geo_json"==i){s=ramaddaBaseUrl+"/entry/get?entryid="+e;a=this.addGeoJsonLayer(t,s,!0,null,null,null,null,!0)}else{s=ramaddaBaseUrl+"/entry/show?output=shapefile.kml&entryid="+e;a=this.addKMLLayer(t,s,!0,null,null,null,null,!0)}return a},findLayer:function(e){for(var t=0;t<this.getMap().layers.length;t++)if(this.getMap().layers[t].ramaddaId==e)return this.getMap().layers[t];return null},addLayer:function(e,t){this.allLayers.push(e),e.initialVisibility=e.getVisibility(),null!=this.map?(this.getMap().addLayer(e),t?this.nonSelectLayers.push(e):this.loadedLayers.push(e),this.checkLayerOrder()):this.initialLayers.push(e)},toFrontLayer:function(e){Utils.toFront(this.nonSelectLayers,e),this.checkLayerOrder()},toBackLayer:function(e){Utils.toBack(this.nonSelectLayers,e),this.checkLayerOrder()},redraw:function(){this.getMap().layers.forEach((e=>{e.redraw()}))},checkLayerOrder:function(){let e=this.numberOfBaseLayers+100,t=!1;let i=!1,a=t=>{let a;a=t.ramaddaLayerIndex?t.ramaddaLayerIndex:e++,i||(i=t.theIndex!=a),t.theIndex=a,e=Math.max(e,a)};if(this.nonSelectLayers.forEach(a),this.loadedLayers.forEach(a),this.boxes&&a(this.boxes),this.lines&&a(this.lines),this.circles&&a(this.circles),this.markers&&a(this.markers),this.labelLayer&&a(this.labelLayer),i){let e=this.getMap().layers.filter((e=>!e.isBaseLayer)),t=this.getMap().layers.filter((e=>e.isBaseLayer));e.sort(((e,t)=>Utils.isDefined(e.theIndex)?Utils.isDefined(t.theIndex)?e.theIndex-t.theIndex:Utils.isDefined(e.theIndex)?1:-1:Utils.isDefined(t.theIndex)?-1:1)),t.push(...e),this.getMap().layers=t,this.getMap().resetLayersZIndex()}},addImageLayer:function(e,t,i,a,s,r,o,l,n,h,d,u,c){let p=this,m={forSelect:!1,addBox:!0,isBaseLayer:!1,alwaysInRange:!0};u&&$.extend(m,u),r>88&&(r=88),l<-88&&(l=-88);let g=MapUtils.createBounds(o,l,n,r),f=this.transformLLBounds(g),y=MapUtils.createLayerImage(t,a,f,MapUtils.createSize(h,d),{numZoomLevels:3,isBaseLayer:m.isBaseLayer,alwaysInRange:m.alwaysInRange,displayOutsideMaxExtent:!0,resolutions:this.getMap().layers[0]?this.getMap().layers[0].resolutions:null,maxResolution:this.getMap().layers[0]?this.getMap().layers[0].resolutions[0]:null});y.events.on({loadend:function(e){c&&c(p,y)}}),y.id=e,y.latLonBounds=g,m.forSelect&&(this.selectImage=y);let L=MapUtils.createLonLat(o,r);return y.lonlat=this.transformLLPoint(L),y.setVisibility(s),y.id=e,y.text=this.getPopupText(i),y.ramaddaId=e,y.ramaddaName=t,this.addLayer(y,!0),y.north=r,y.west=o,y.south=l,y.east=n,y.opacity=this.params.imageOpacity,this.imageLayers||(this.imageLayers={}),m.isBaseLayer||(this.imageLayers[e]=y,this.imageLayersList.push(y)),this.noPointerEventsLayers||(this.noPointerEventsLayers=[]),this.noPointerEventsLayers.push(y),this.setNoPointerEvents(),y},setNoPointerEvents:function(){this.noPointerEventsLayers&&setTimeout((()=>{this.noPointerEventsLayers.forEach((e=>{if(e.div)for(var t=e.div.childNodes,i=0,a=t.length;i<a;++i){var s=t[i].firstChild||t[i],r=t[i].lastChild;r&&"iframe"===r.nodeName.toLowerCase()&&(s=r.parentNode),s.style["pointer-events"]="none"}}))}),1e3)},addWMSLayer:function(e,t,i,a,s,r){r||(r={});let o={wrapDateLine:MapUtils.defaults.wrapDateline};r.opacity&&(o.opacity=r.opacity);i=MapUtils.createLayerWMS(e,t,{layers:i,format:"image/png",isBaseLayer:!1,srs:"epse:4326",transparent:!0},o);return a?(i.isBaseLayer=!0,i.visibility=!1):(i.isBaseLayer=!1,i.visibility=r.visible),this.addLayer(i,s),i},addMapLayer:function(e,t,i,a,s){(i=/\/tile\//.exec(t)?MapUtils.createLayerXYZ(e,t,{sphericalMercator:MapUtils.defaults.doSphericalMercator,numZoomLevels:MapUtils.defaults.zoomLevels,wrapDateLine:MapUtils.defaults.wrapDateline}):MapUtils.createLayerWMS(e,t,{layers:i,format:"image/png"},{wrapDateLine:MapUtils.defaults.wrapDateline})).isBaseLayer=!!a,i.visibility=!1,i.reproject=!0,this.addLayer(i),s&&(this.haveAddedDefaultLayer=!0,this.getMap().setLayerIndex(i,0),this.getMap().setBaseLayer(i))},getMapLayer:function(e){return RAMADDA_MAP_LAYERS_MAP[e]?.layer},getVectorLayerStyleMap:function(e,t,i){let a={pointRadius:this.params.pointRadius,fillOpacity:this.params.fillOpacity,fillColor:this.params.fillColor,fill:this.params.fill,strokeColor:this.params.strokeColor,strokeWidth:this.params.strokeWidth,select_fillOpacity:this.params.fillOpacity,select_fillColor:"#666",select_strokeColor:"#666",select_strokeWidth:1};t&&$.extend(a,t);let s=$.extend({},MapUtils.getVectorStyle("temporary"));$.extend(s,a);let r=$.extend({},MapUtils.getVectorStyle("select"));$.extend(r,{pointRadius:3,fillOpacity:a.select_fillOpacity,fillColor:a.select_fillColor,strokeColor:a.select_strokeColor,strokeWidth:a.select_strokeWidth,externalGraphic:a.externalGraphic});let o=$.extend({},MapUtils.getVectorStyle("default"));$.extend(o,{pointRadius:a.pointRadius,fillOpacity:a.fillOpacity,fillColor:a.fillColor,fillPattern:a.fillPattern,fill:a.fill,strokeColor:a.strokeColor,strokeWidth:a.strokeWidth,externalGraphic:a.externalGraphic});let l=MapUtils.createStyleMap({temporary:s,default:o,select:r});i=i||this.getProperty("rules");let n=[];if(Utils.isDefined(i)){if(!Array.isArray(i)){let e=[];Utils.split(i,";",!0,!0).forEach((t=>{let i=Utils.split(t,":");if(i.length<3)return void console.log("bad rule:"+t);let a={property:i[0],type:i[1],value:i[2],style:{}};for(let e=3;e<i.length;e+=2)a.style[i[e]]=i[e+1];e.push(a)})),i=e}n=i}if(n.length>0){let e=[];n.forEach((t=>{let i=$.extend({},o),a=t.style;if("string"==typeof a){let e={};Utils.split(a,"\n",!0,!0).forEach((t=>{let i=Utils.split(t,":",!0,!0);2==i.length&&(e[i[0]]=i[1])})),a=e}i=$.extend(i,a),t.value=String(t.value??"");let s=t.value.match(/^\d*\.?\d*$/),r=("~="==t.type||t.type,{property:t.property,type:t.type});if(t.type==OpenLayers.Filter.Comparison.BETWEEN){let e=Utils.split(String(t.value),":",!0,!0);2==e.length&&(r.lowerBoundary=+e[0],r.upperBoundary=+e[1])}else r.value=s?+t.value:t.value;let l=new OpenLayers.Rule({filter:new OpenLayers.Filter.Comparison(r),symbolizer:i});e.push(l)})),e.push(new OpenLayers.Rule({elseFilter:!0,symbolizer:t}));new OpenLayers.Rule({filter:new OpenLayers.Filter.Comparison,symbolizer:t});l.styles.default.addRules(e)}return l},getFeatureName:function(e){var t=e.attributes;for(var i in t){if((""+i).toLowerCase().includes("label"))if(a=this.getAttrValue(t,i))return a}for(var i in t){var a;if((""+i).toLowerCase().includes("name"))if(a=this.getAttrValue(t,i))return a}},getAttrValue:function(e,t){let i="";if("object"==typeof e[t]||"Object"==typeof e[t]){let a=e[t];a&&(i=""+a.value)}else i=""+e[t];return i},searchFor:function(e){e&&(e=e.trim()),""==e&&(e=null),this.searchText=e;let t=null,i=!1,a=$("#"+this.searchDiv+"_download").is(":checked"),s=[],r=!0;if(e){"?"==(e=e.trim())&&(i=!0),t=[];let a=(e=e.toLowerCase()).split("|");1==a.length&&(a=e.split("&"),r=1==a.length);for(let e=0;e<a.length;e++){let i=!1,s=!1,r=a[e],o=r.split(":"),l="",n=r;o.length>1&&(l=o[0],n=o[1]),n.startsWith("!")&&(i=!0,n=n.substring(1)),n.startsWith("=")&&(n=n.substring(1),s=!0),t.push({field:l,value:n,not:i,equals:s})}}else this.searchMsg.html("");for(let o in this.loadedLayers){let l=this.loadedLayers[o];l.selectedFeature&&this.handleNofeatureclick(null,l);for(let a in l.features){let o=l.features[a],n=o.attributes;if(!e){o.featureVisibleSearch=!0,s.push(n);continue}if(i){let e="&nbsp;&nbsp;&nbsp;",t="Enter, e.g.:<br>";t+=e+"<i>&lt;term&gt;</i> (any match)<br>",t+=e+"<i>=&lt;term&gt;</i> (exact match)<br>",t+=e+"<i>!&lt;term&gt;</i> (not match)<br>",t+=e+"<i>&lt;term 1&gt;|&lt;term 2&gt;</i> (match any)<br>",t+=e+"<i>&lt;term 1&gt;&amp;&lt;term 2&gt;</i> (match all)<br>",t+="Or by field:<br>";for(let i in n)t+=e+i.toLowerCase()+":<i>&lt;term&gt;</i><br>";return void this.showText(t)}let h=!1,d=!0,u=!1;for(let e in t){let i=t[e];for(let e in n){if(""!=i.field&&i.field!=e.toLowerCase())continue;let t=this.getAttrValue(n,e);if(t=t.toLowerCase().trim(),h=i.equals?t==i.value:t.includes(i.value),i.not){if(h=!h,!h)break}else if(h)break}h&&(u=!0),h||(d=!1)}r&&u||!r&&d?(o.featureVisibleSearch=!0,this.getFeatureVisible(o)&&s.push(n)):o.featureVisibleSearch=!1}if(this.centerOnMarkers(),a){let e="";for(let t in s){let i=s[t];for(let t in i)""!=e&&(e+=","),e+=t.toLowerCase();e+="\n";break}for(let t in s){let i=s[t],a="";for(let e in i){let t=this.getAttrValue(i,e);t.includes(",")&&(t='"'+t+'"'),""!=a&&(a+=","),a+=t}a+="\n",e+=a}Utils.makeDownloadFile("download.csv",e)}this.setFeatureVisibility(l)}},checkFeatureVisible:function(e,t,i){let a=e.layer,s=this.getFeatureVisible(e);if(e.ramaddaId){this.getVisibilityCheckbox(e.ramaddaId).prop("checked",s)}e.originalStyle&&(e.style=e.originalStyle);let r=e.style;if(!r){r={};let t=a?a.styleMap.styles.default.defaultStyle:{};$.extend(r,t),e.style=r}return r.display=s?"inline":"none",t&&(e.isSelected||(e.renderIntent=null),a&&a.drawFeature(e,e.style||"default")),s},getFeatureVisible:function(e){let t=!0;return Utils.isDefined(e.featureVisibleSearch)&&!e.featureVisibleSearch&&(t=!1),Utils.isDefined(e.featureVisibleDate)&&!e.featureVisibleDate&&(t=!1),Utils.isDefined(e.featureVisible)&&!e.featureVisible&&(t=!1),t},setFeatureVisibility:function(e){if(!e.features)return;let t=this,i=this.searchText||this.startDate&&this.endDate,a=null,s="",r=!1,o=!1,l=0,n=null;for(let t=0;t<e.features.length;t++){let i=e.features[t];if(this.checkFeatureVisible(i,!1)){this.dateFeatureSelect(i),r=!0,l++,n||(n=i),s+=HtmlUtils.div(["class","ramadda-map-feature","feature-index",""+t],this.getFeatureName(i));let e=i.geometry;if(e){let t=e.getBounds();a?a.extend(t):a=t}}else this.clearDateFeature(i),o=!0}if(1==l)this.showText(this.getFeatureText(e,n));else if(i||r&&o){let i=this.mapDivId+"_features";this.showText(HtmlUtils.div(["id",i,"class","ramadda-map-features"],s)),$("#"+i+" .ramadda-map-feature").click((function(i){let a=parseInt($(this).attr("feature-index"));t.handleFeatureclick(e,e.features[a],!0)})),$("#"+i+" .ramadda-map-feature").mouseover((function(){let i=parseInt($(this).attr("feature-index"));t.handleFeatureover(e.features[i],!0)})),$("#"+i+" .ramadda-map-feature").mouseout((function(){let i=parseInt($(this).attr("feature-index"));t.handleFeatureout(e.features[i],!0)}))}else this.clearDateFeature(),this.params.displayDivSticky||this.showText("");this.searchMsg&&(i?this.searchMsg.html(l+" matched"):this.searchMsg.html("")),e.redraw(),a?(this.zoomToExtent(a),this.getMap().setCenter(a.getCenterLonLat())):this.centerOnMarkers(this.dfltBounds,this.centerOnMarkersForce)},getFeatureText:function(e,t){if(t.textGetter){let e=t.textGetter(t);if(e)return debugPopup&&console.log("getFeatureText-feature has textGetter:"),e}if(e.textGetter){let i=e.textGetter(t);if(i)return debugPopup&&console.log("getFeatureText-layer has textGetter"),i}if(this.textGetter){let i=this.textGetter(e,t);if(i)return debugPopup&&console.log("getFeatureText-map has textGetter:"+this.textGetter),i}let i=t.style||t.originalStyle||e.style,a=t.attributes,s=t.popupText??t.text;if(!s)if(i&&(i.balloonStyle||i.popupText)){s=i.balloonStyle||i.popupText;for(let e in a){MapUtils.makeLabel(e);let t="";if("object"==typeof a[e]||"Object"==typeof a[e]){let i=a[e];t=""+(i?i.value:"")}else t=""+a[e];let r=e.toLowerCase();s=s.replace("${"+i.id+"/"+e+"}",t).replace("${"+e+"}",t).replace("${"+r+"}",t)}}else debugPopup&&console.log("getFeatureText-using feature attributes"),s=e.textGetter?e.textGetter(t):MapUtils.makeDefaultFeatureText(a);return s&&s.indexOf("${default}")>=0&&(s=s.replace("${default}",MapUtils.makeDefaultFeatureText(a))),s},onFeatureSelect:function(e,t){debugPopup&&console.log("\tonFeatureSelect");if(this.onSelect)return func=window[this.onSelect],func(this,e),void(debugPopup&&console.log("\thas onSelect"));let i=e.feature;if(this.featureSelectHandler&&this.featureSelectHandler(i))return void(debugPopup&&console.log("\thas featureSelectHandler"));if(!this.getDoPopup())return;let a=this.getFeatureText(e,i);if(!a)return void(debugPopup&&console.log("\tno feature text"));debugPopup&&console.log("\thas feature text"),this.currentPopup&&(this.getMap().removePopup(this.currentPopup),this.currentPopup.destroy(),this.currentPopup=null);let s=null;if(t&&t.event&&t.event.xy&&(s=this.getMap().getLonLatFromPixel(t.event.xy)),null==s&&(s=i.geometry.getBounds().getCenterLonLat()),this.showPopupSlider(s,a))return;let r=this.makePopup(s,a);i.popup=r,r.feature=i,this.addPopup(r)},onFeatureUnselect:function(e){this.onPopupClose()},removeKMLLayer:function(e){this.removeLayer(e)},removeLayer:function(e,t){this.externalLayers=Utils.removeItem(this.externalLayers,e),this.allLayers=Utils.removeItem(this.allLayers,e),this.nonSelectLayers&&(this.nonSelectLayers=Utils.removeItem(this.nonSelectLayers,e)),this.loadedLayers&&(this.loadedLayers=Utils.removeItem(this.loadedLayers,e)),this.imageLayersList&&(this.imageLayersList=Utils.removeItem(this.imageLayersList,e)),t||this.getMap().removeLayer(e)},setDefaultCanSelect:function(e){this.defaultCanSelect=e},getCanSelect:function(e){return void 0===e||null==e?this.defaultCanSelect:e},addSelectCallback:function(e,t,i,a){let s=this;this.getCanSelect(t)&&(null!=i&&Utils.isDefined(i)||(i=function(e,t,i){return s.onFeatureSelect(t,i)}),null!=a&&Utils.isDefined(a)||(a=function(e,t,i){return s.onFeatureUnselect(t,i)}),e.selectCallback=i,e.unselectCallback=i)},initDates:function(e){let t=this,i=e.features,a=!1,s=!1;this.hasDates=!1,this.dates=[],this.dateFeatures=[],this.minDate=null,this.maxDate=null;for(let e=0;e<i.length;e++){let t=i[e],r=t.attributes;for(let e in r){let i=(""+e).toLowerCase(),o=i.includes("year")||i.includes("_yr");if(!i.includes("date")&&!o)continue;let l=this.getAttrValue(r,e);if(l&&"0"!=l)try{let e=Utils.parseDate(l);if(e&&isNaN(e.getTime()))continue;if(o?s=!0:a=!0,null!=this.startDate&&null!=this.endDate&&(e.getTime()<this.startDate.getTime()||e.getTime()>this.endDate.getTime()))continue;this.dates.push(e),this.dateFeatures.push(t),this.minDate=null==this.minDate||this.minDate.getTime()>e.getTime()?e:this.minDate,this.maxDate=null==this.maxDate||this.maxDate.getTime()<e.getTime()?e:this.maxDate,t.featureDate=e,this.hasDates=!0;break}catch(e){console.log("error:"+e)}}}if(this.hasDates&&this.params.showDates){let i=null;s&&(i={year:"numeric"}),$("#"+this.mapDivId+"_footer").html(HtmlUtils.div(["class","ramadda-map-animation","id",this.mapDivId+"_animation"],"")),this.animation=$("#"+this.mapDivId+"_animation");let a=HtmlUtils.div(["class","ramadda-map-animation-ticks","id",this.mapDivId+"_animation_ticks"],""),r=HtmlUtils.div(["class","ramadda-map-animation-info","id",this.mapDivId+"_animation_info"],"");this.animation.html(a+r);let o=Utils.formatDate(this.minDate,i),l=Utils.formatDate(this.maxDate,i);this.animationTicks=$("#"+this.mapDivId+"_animation_ticks"),this.animationInfo=$("#"+this.mapDivId+"_animation_info");let n="";this.startDate&&this.endDate&&(n=HtmlUtils.div(["id",this.mapDivId+"_ticks_reset","class","ramadda-map-animation-tick-reset"],"Reset"));let h="<table width=100%><tr valign=top><td width=40%>"+o+"</td><td align=center width=20%>"+n+"</td><td align=right width=40%>"+l+"</td></tr></table>";if(this.animationInfo.html(h),this.startDate&&this.endDate){$("#"+this.mapDivId+"_ticks_reset").click((function(){t.startDate=null,t.endDate=null,t.startFeature=null,t.endFeature=null,t.setFeatureDateRange(e,"Resetting range...")}))}let d=this.animationTicks.width(),u=d>0?5/d:0,c="",p=this.minDate.getTime(),m=this.maxDate.getTime();null!=this.startDate&&null!=this.endDate&&(p=this.startDate.getTime(),m=this.endDate.getTime());let g=m-p;if(g>0)for(let e=0;e<this.dates.length;e++){let t=this.dates[e],a=t.getTime();if(a<p||a>m)continue;let s=this.dateFeatures[e];s.dateIndex=e;let r=100*(a-p)/g;r-=r*u,i||(i={});let o=t.toLocaleDateString("en-US",i),l=Utils.camelCase(this.getFeatureName(s)),n="";n+=null!=l?l+"<br>":"",n+=o,n+="<br>shift-click: set visible range<br>cmd/ctrl-click:zoom",n+="",c+=HtmlUtils.div(["id",this.mapDivId+"_tick"+e,"feature-index",""+e,"style","left:"+r+"%","class","ramadda-map-animation-tick","title",n],"")}this.animationTicks.html(c);let f=$("#"+this.mapDivId+"_animation .ramadda-map-animation-tick");f.tooltip({content:function(){return $(this).prop("title")},position:{my:"left top",at:"left bottom+2"},classes:{"ui-tooltip":"ramadda-popup"}}),f.mouseover((function(){let e=parseInt($(this).attr("feature-index")),i=t.dateFeatures[e];t.handleFeatureover(i,!0)})),f.mouseout((function(){let e=parseInt($(this).attr("feature-index")),i=t.dateFeatures[e];t.handleFeatureout(i,!0)})),f.click((function(e){let i=parseInt($(this).attr("feature-index")),a=t.dateFeatures[i];if(e.shiftKey){if(null==t.startDate?(t.startDate=a.featureDate,t.startFeature=a,t.dateFeatureSelect(a)):null==t.endDate?(t.endDate=a.featureDate,t.endFeature=a,t.dateFeatureSelect(a)):(t.dateFeatureSelect(null),t.startDate=a.featureDate,t.startFeature=a,t.endDate=null,t.endFeature=null,t.dateFeatureSelect(a)),null!=t.startDate&&null!=t.endDate){if(t.startDate.getTime()==t.endDate.getTime())return t.startDate=null,t.startFeature=null,t.endDate=null,t.endFeature=null,void t.dateFeatureSelect(null);if(t.startDate.getTime()>t.endDate.getTime()){let e=t.startDate;t.startDate=t.endDate,t.endDate=e,e=t.startFeature,t.startFeature=t.endFeature,t.endFeature=e}t.setFeatureDateRange(a.layer)}}else{let i=e.metaKey||e.ctrlKey;null==t.startDate&&null==t.endDate||(t.startDate=null,t.endDate=null),t.clearDateFeature(),t.handleFeatureclick(a.layer,a,i)}}))}},setFeatureDateRange:function(e,t){this.dateFeatureSelect(null),t||(t="Setting range..."),this.animationTicks.html(t),setTimeout((()=>this.setFeatureDateRangeInner(e)),100)},setFeatureDateRangeInner:function(e){let t=e.features;e.selectedFeature&&this.unselectFeature(e.selectedFeature);for(let e=0;e<t.length;e++){let i=t[e];this.startDate&&this.endDate&&i.featureDate?i.featureVisibleDate=this.startDate.getTime()<=i.featureDate.getTime()&&i.featureDate.getTime()<=this.endDate.getTime():i.featureVisibleDate=!0}this.setFeatureVisibility(e),this.initDates(e)},dateFeatureSelect:function(e){let t=this.getFeatureTick(e);t.css("background-color",this.params.tickSelectColor),t.css("zIndex","100")},dateFeatureOver:function(e){this.closeTicks();let t=this.getFeatureTick(e);t.css("background-color",this.params.tickHoverColor),t.css("zIndex","100"),this.tickOpen&&this.tickOpen.tooltip("close"),this.tickOpen=t,t.tooltip("open")},dateFeatureOut:function(e){this.closeTicks();let t=this.getFeatureTick(e);!e||e!=this.startFeature&&e!=this.endFeature?(t.css("background-color",""),t.css("zIndex","0")):(t.css("background-color",this.params.tickSelectColor),t.css("zIndex","0")),this.tickOpen=null},closeTicks:function(){let e=this.getAllTicks();e.tooltip("close"),e.css("background-color","")},getAllTicks:function(){return jqid(this.mapDivId+"_animation_ticks").find(".ramadda-map-animation-tick")},getFeatureTick:function(e){return e?$("#"+this.mapDivId+"_tick"+e.dateIndex):$("#"+this.mapDivId+"_animation_ticks .ramadda-map-animation-tick")},clearDateFeature:function(e){let t=null!=e?$("#"+this.mapDivId+"_tick"+e.dateIndex):$("#"+this.mapDivId+"_animation_ticks .ramadda-map-animation-tick");t.css("background-color",""),t.css("zIndex","0")},initMapVectorLayer:function(e,t,i,a,s,r,o,l){let n=this;this.showLoadingImage(),e.isMapLayer=!0,e.canSelect=i,this.loadedLayers.push(e),e.events.on({loadend:function(i){if(n.hideLoadingImage(),i.response&&Utils.isDefined(i.response.code)&&i.response.code==OpenLayers.Protocol.Response.FAILURE)l?l(t,i.response):console.log("An error occurred loading the map:"+t+"\n"+JSON.stringify(i.response,null,2));else{if(o){let t=e.getDataExtent();t&&n.zoomToExtent(t,!0)}else n.centerOnMarkersCalled&&(n.dfltBounds||n.centerOnMarkers(n.dfltBounds,n.centerOnMarkersForce));r&&r(n,e),1==e.features.length&&n.params.displayDiv&&(n.fixedText=!0,n.showText(n.getFeatureText(e,e.features[0]))),n.initDates(e)}}}),this.addLayer(e),this.addSelectCallback(e,i,a,s)},getLayerProperty:function(e,t,i,a,s){let r=Utils.makeId(a);return this.getProperty(t+"_"+r,this.getProperty(t+i,this.getProperty(t,s)))},addMapFileLayer:function(e,t,i,s,r,o,l,n,h,d){let u=this.loadedLayers.length+1,c={strokeColor:this.getLayerProperty(e,"layerStrokeColor",u,i,"blue"),strokeWidth:this.getLayerProperty(e,"layerStrokeWidth",u,i,1),fillColor:this.getLayerProperty(e,"layerFillColor",u,i,"#ccc"),fillOpacity:this.getLayerProperty(e,"layerFillOpacity",u,i,.4)},p={};for(a in $.extend(p,this.highlightStyle),p){let t=String(a);t="highlight"+t.substring(0,1).toUpperCase()+t.substring(1),p[a]=this.getLayerProperty(e,t,u,i,p[a])}return e.highlightStyle=p,this.getLayerProperty(e,"noHighlight",u,i,!1)&&(e.noHighlight=!0),l=l||{},$.extend(c,l),e.styleMap=this.getVectorLayerStyleMap(e,c),this.checkLayerToggle(i,e,u,c),this.initMapVectorLayer(e,t,s,r,o,n,h,d),e},addGpxLayer:function(e,t,i,a,s,r,o,l,n){let h=MapUtils.createLayerGPX(this,e,t);return this.addMapFileLayer(h,t,e,i,a,s,r,o,l,n),h},printLayers:function(e){console.log(e),this.getMap().layers.forEach((e=>{e.name.indexOf("Cb")>=0&&console.log("\t"+e.name)}))},addGeoJsonLayer:function(e,t,i,a,s,r,o,l,n){let h=MapUtils.createLayerGeoJson(this,e,t);return this.addMapFileLayer(h,t,e,i,a,s,r,o,l,n),h},addKMLLayer:function(e,t,i,a,s,r,o,l,n){if(t.match(".kmz")){let e=$("<div  class=ramadda-map-message>Note: KMZ files are not supported</div>")[0];return void this.getMap().viewPortDiv.appendChild(e)}let h=MapUtils.createLayerKML(this,e,t);return this.addMapFileLayer(h,t,e,i,a,s,r,o,l,n),h},checkLayerToggle:function(e,t,i,a){let s=this.getLayerProperty(t,"layerVisible",i,e,!0);if(s||t.setVisibility(!1),this.params.showLayerToggle){let r=Utils.addAlphaToColor(a.fillColor,.4),o=HU.span([],HtmlUtils.checkbox(this.mapDivId+"_layertoggle"+i,["title","Toggle Layer"],s,e))+" ";o=HU.span([STYLE,HU.css("margin-right","5px","padding","5px","background",r)],o),$("#"+this.mapDivId+"_header").append(" "+o),$("#"+this.mapDivId+"_layertoggle"+i).change((function(){$(this).is(":checked")?t.setVisibility(!0):t.setVisibility(!1)}))}},createXYZLayer:function(e,t,i,a,s){s=Utils.getBoolean(s);let r={sphericalMercator:MapUtils.defaults.doSphericalMercator,numZoomLevels:MapUtils.defaults.zoomLevels,wrapDateLine:MapUtils.defaults.wrapDateline,isBaseLayer:!a,visibility:s};return i&&(r.attribution=i),MapUtils.createLayerXYZ(e,t,r)},addBaseLayers:function(){this.mapLayers=Utils.mergeLists([],RAMADDA_MAP_LAYERS);let e=this.params.defaultMapLayer||"osm";if(!this.haveAddedDefaultLayer&&e){let t=-1,i=this.mapLayers.find(((i,a)=>{if(i.id==e)return t=a,!0}));t>=0&&(this.mapLayers.splice(t,1),this.mapLayers.splice(0,0,i))}this.firstLayer=null,this.hybridLayer=null,this.defaultOLMapLayer=null,this.baseLayers={},this.numberOfBaseLayers=0;let t="";for(let e=0;e<this.mapLayers.length;e++){let i=this.mapLayers[e];if(!i.isForMap())continue;let a=this.makeMapLayer(i);null==this.firstLayer&&(this.firstLayer=a),null!=a&&(""!=t&&(t+=","),t+=i.id+":"+a.name,a.ramaddaId=i.id,a.isBaseLayer?(this.baseLayers[i.id]=a,i.id==this.params.defaultMapLayer&&(this.defaultOLMapLayer=a),this.addBaseLayer(a)):this.addLayer(a))}this.graticule=this.createGraticule({strokeColor:"#888",strokeWidth:2,strokeOpacity:.5}),this.getMap().addControl(this.graticule)},createGraticule:function(e){return MapUtils.createGraticule({layerName:"Lat/Lon Lines",lineSymbolizer:e,xautoActivate:!1,numPoints:2,labelled:!0,visible:!0===this.params.showLatLonLines,renderers:["VML","SVG"]})},makeMapLayer:function(e){let t;if(t="string"==typeof e?RAMADDA_MAP_LAYERS_MAP[e]:e,t){let e=t.createMapLayer(this);if(t.opts.alias&&(this.baseLayers[t.opts.alias]=e),t.opts.refresh){let i=()=>{e.getVisibility()&&e.redraw(!0),setTimeout(i,1e3*t.opts.refresh)};setTimeout(i,1e3*t.opts.refresh)}return e}if(/\/tile\//.exec(e)){let t=e;return MapUtils.createLayerXYZ("ESRI China Map",t,{sphericalMercator:MapUtils.defaults.doSphericalMercator,numZoomLevels:MapUtils.defaults.zoomLevels,wrapDateLine:MapUtils.defaults.wrapDateline})}{let t=/wms:(.*),(.*),(.*)/.exec(e);return t?this.addWMSLayer(t[1],t[2],t[3],!0):(console.log("no match for map layer:"+e),null)}},setShowOverviewMap:function(e,t){if(!e)return this.overviewMap&&this.overviewMap.destroy(),void(this.overviewMap=null);if(!this.overviewMap){let e={maximized:!0,autoPan:!0};t&&$.extend(e,t),this.getMap().addControl(this.overviewMap=new OpenLayers.Control.OverviewMap(e))}},setGraticulesVisible:function(e,t){this.params.showLatLonLines=e,this.graticule&&(t&&(this.graticule.gratLayer.visibility=e,this.graticule.deactivate(),this.graticule.gratLayer.redraw(),this.getMap().removeControl(this.graticule),this.graticule=this.createGraticule(t),this.getMap().addControl(this.graticule)),this.graticule.gratLayer.visibility=e,e?this.graticule.activate():this.graticule.deactivate(),this.graticule.gratLayer.redraw())},addBaseLayer:function(e){this.addLayer(e),this.numberOfBaseLayers++},getBaseLayer:function(e){if(this.baseLayers)return this.baseLayers[e]},makeSimpleWms:function(e){let t="/repository/wms?version=1.1.1&request=GetMap&layers="+e+"&FORMAT=image%2Fpng&SRS=EPSG%3A4326&BBOX=-180.0,-80.0,180.0,80.0&width=400&height=400";return this.addWMSLayer(Utils.makeLabel(e)+" background",t,e,!0)},initSearch:function(e){let t=this;$("#"+e).keyup((function(i){13==i.keyCode&&t.searchMarkers($("#"+e).val())}))},getVisibilityCheckbox:function(e){let t=$("#visible_"+this.mapId+"_"+e);return 0==t.length&&(t=$("#visible_"+this.mapId+"_"+e.replace(/-/g,"_"))),t},searchMarkers:function(e){let t=""==(e=(e=e.trim()).toLowerCase());$(':input[id*="visibleall_'+this.mapId+'"]').prop("checked",t);let i=MapUtils.createBounds(),a=0;if(this.markers){let s=this.getMarkers();for(let r=0;r<s.length;r++){marker=s[r];let o=!0,l=this.getVisibilityCheckbox(marker.ramaddaId),n=$("#block_"+this.mapId+"_"+marker.ramaddaId),h=marker.name;o=!!t||!!Utils.isDefined(h)&&h.toLowerCase().includes(e),o?(marker.style.display="inline",marker.location&&i.extend(marker.location),a++):marker.style.display="none",o?n.show():n.hide(),l.prop("checked",o)}this.markers.redraw()}if(this.boxes&&this.boxes.markers){for(let s in this.boxes.markers){s=this.boxes.markers[s],name=s.name;let r=!0;if(r=!!t||!!Utils.isDefined(name)&&name.toLowerCase().includes(e),s.display(r),r){let e=this.transformProjBounds(s.bounds);i.extend(e),a++}}this.boxes.redraw()}if(this.lines){let i=this.lines.features;for(let a=0;a<i.length;a++){let s=i[a];name=s.name;let r=!0;r=!!t||!!Utils.isDefined(name)&&name.toLowerCase().includes(e),s.style.display=r?"inline":"none"}this.lines.redraw()}a>0&&this.centerOnMarkers(i,!0)},setLatLonReadout:function(e){this.latlonReadout=e},getMap:function(){return getMapDebug&&console.trace(),this.map},setDragPanEnabled:function(e){this.dragPanControl&&(e?this.dragPanControl.activate():this.dragPanControl.deactivate())},setZoomPanEnabled:function(e){e?this.panZoomControl||this.getMap().addControl(this.panZoomControl=new OpenLayers.Control.PanZoom):(this.panZoomControl&&this.panZoomControl.destroy(),this.panZoomControl=null)},initMap:function(e){let t=this;if(this.startTime=Date.now(),this.inited)return;if(this.inited=!0,this.dragPanControl=new OpenLayers.Control.Navigation({zoomWheelEnabled:this.params.scrollToZoom,dragPanOptions:{enableKinetic:!0}}),this.getMap().addControl(this.dragPanControl),this.setDragPanEnabled(this.params.enableDragPan),this.params.scrollToZoom){const e=document.querySelector("#"+this.mapDivId+"_themap");this.checkedBaseLayerDiv=!1,e.onwheel=e=>{if(!this.baseLayerDiv){let e=$("#"+this.mapDivId).find(".layersDiv");e.length>0&&(this.baseLayerDiv=e)}this.baseLayerDiv&&this.baseLayerDiv.is(":visible")||this.currentPopup&&this.currentPopup.div||e.preventDefault()}}this.params.showZoomPanControl&&!this.params.showZoomOnlyControl&&this.setZoomPanEnabled(!0),this.params.showZoomOnlyControl&&!this.params.showZoomPanControl&&this.getMap().addControl(new OpenLayers.Control.Zoom),this.params.showScaleLine&&this.getMap().addControl(new OpenLayers.Control.ScaleLine),this.params.showOverviewMap&&this.setShowOverviewMap(!0);let i=new OpenLayers.Control,a=new OpenLayers.Control,s={keyup:function(e){t.handleKeyUp(e)},keydown:function(e){t.handleKeyDown(e)}};new OpenLayers.Handler.Keyboard(a,s,{}).activate(),this.getMap().addControl(i),this.getMap().addControl(new OpenLayers.Control.KeyboardDefaults),this.params.linkMouse&&this.getMap().events.register("mousemove",this.getMap(),(e=>{if(e.shiftKey){this.sharedMouse&&this.getMarkersLayer().removeFeatures([this.sharedMouse],{silent:!0});let t=this.getMap().getLonLatFromPixel(e.xy);t=this.transformProjPoint(t),ramaddaMapShareState(this,{mouse:t})}})),this.params.showLayerSwitcher&&this.getMap().addControl(new OpenLayers.Control.LayerSwitcher),this.params.showLatLonPosition&&this.initMousePositionReadout(),this.params.showLocationSearch&&this.initLocationSearch(),this.defaultBounds&&(this.hadDefaultBounds=!0),this.applyDefaultLocation();for(let e=0;e<this.initialLayers.length;e++)this.addLayer(this.initialLayers[e]);this.initialLayers=[],e&&this.addRegionSelectorControl();let r=$(':input[id*="visible_'+this.mapId+'"]');r.change((function(e){t.checkImageLayerVisibility(),t.checkMarkerVisibility(),t.checkLinesVisibility(),t.checkBoxesVisibility()}));let o=$(':input[id*="visibleall_'+this.mapId+'"]');o.change((function(e){r.prop("checked",o.is(":checked")),t.checkImageLayerVisibility(),t.checkMarkerVisibility(),t.checkLinesVisibility(),t.checkBoxesVisibility()}));for(let e=1;;e++){let t=this.getProperty("marker"+e);if(!t)break;this.addMarkerEmbed(t)}},destroyMousePositionReadout:function(){this.mousePositionReadout&&this.mousePositionReadout.destroy(),this.mousePositionReadout=null},initMousePositionReadout:function(){if(this.mousePositionReadout)return;this.latlonReadout||(this.latlonReadout=this.mapId+"_latlonreadout");let e=GuiUtils.getDomObject(this.latlonReadout);e?this.getMap().addControl(this.mousePositionReadout=new OpenLayers.Control.MousePosition({numDigits:5,element:e.obj,prefix:""})):this.getMap().addControl(this.mousePositionReadout=new OpenLayers.Control.MousePosition({numDigits:5,prefix:""}))},handleKeyUp:function(e){this.keyUpListener&&this.keyUpListener(e)},handleKeyDown:function(e){if(!(this.keyDownListener&&this.keyDownListener(e)||event.ctrlKey)){if(79==e.keyCode||"Shift"==e.key){if(!this.imageLayersList)return;if(this.ignoreKeyEvents)return;this.imageLayersList.forEach((t=>{t.getVisibility()&&(Utils.isDefined(t.opacity)||(t.opacity=1),opacity=t.opacity,e.shiftKey?opacity+=.1:opacity-=.1,opacity<0?opacity=0:opacity>1&&(opacity=1),t.setOpacity(opacity))}))}84==e.keyCode&&this.selectImage&&this.selectImage.setVisibility(!this.selectImage.getVisibility())}},addKeyUpListener:function(e){this.keyUpListener=e},addKeyDownListener:function(e){this.keyDownListener=e},applyDefaultLocation:function(){if(debugBounds&&console.log("apply default location:"+this.defaultLocation),this.defaultLocation){let e=this.transformLLPoint(this.defaultLocation);this.getMap().setCenter(e),this.params.initialZoom>=0||(debugBounds&&console.log("zoomTo:",4),this.zoomTo(4)),this.defaultLocation=null}else if(this.defaultBounds){let e=this.defaultBounds.getCenterLonLat(),t=this.transformLLPoint(e);debugBounds&&console.log("applying default bounds: center:"+e+" b:"+this.defaultBounds+" zoom:"+this.params.initialZoom),this.getMap().setCenter(t);let i=this.transformLLBounds(this.defaultBounds);if(this.zoomToExtent(i),this.params.initialZoom<0){this.defaultBounds.right,this.defaultBounds.left;let e=-1;e=this.map.getZoomForExtent(i)+2,debugBounds&&console.log("overriding initialZoom:",e),this.params.initialZoom=e}this.defaultBounds=null}else this.getMap().zoomToMaxExtent();if(this.params.initialZoom>=0){let e=this.params.initialZoom;debugBounds&&console.log("initial zoom:"+e),this.params.initialZoom=-1,this.zoomTo(e),setTimeout((()=>{}),this.initialZoomTimeout??500)}},removeSearchMarkers:function(){if(this.searchMarkerList)for(let e=0;e<this.searchMarkerList.length;e++)this.removeMarker(this.searchMarkerList[e])},addAllLocationResults:function(){if(this.removeSearchMarkers(),this.searchMarkerList=[],!this.locationSearchResults)return;let e,t,i,a;for(let s=0;s<this.locationSearchResults.length;s++){let r=this.locationSearchResults[s],o=MapUtils.createLonLat(r.longitude,r.latitude),l=r.icon;l||(l=ramaddaCdn+"/icons/green-dot.png"),this.searchMarkerList.push(this.addMarker("search",o,l,"",r.name,20,20)),e=0==s?r.longitude:Math.max(e,r.longitude),t=0==s?r.longitude:Math.min(t,r.longitude),i=0==s?r.latitude:Math.max(i,r.latitude),a=0==s?r.latitude:Math.min(a,r.latitude)}let s=this.transformLLBounds(MapUtils.createBounds(t,a,e,i));this.zoomToExtent(s)},initLocationSearch:function(){if(this.selectRegion)return;let e=this,t=HtmlUtils.span(["style","padding-right:4px;","id",this.mapDivId+"_loc_search_wait"],"")+HtmlUtils.checkbox(this.mapDivId+"_loc_bounds",["title","Search in map bounds"],!1)+HtmlUtils.span(["title","Search in map bounds"]," In view ")+HtmlUtils.input("","",["class","ramadda-map-loc-input","title","^string - matches beginning","size","30","placeholder","Search location","id",this.mapDivId+"_loc_search"]);$("#"+this.mapDivId+"_footer2").html(t);let i=$("#"+this.mapDivId+"_loc_search"),a=$("#"+this.mapDivId+"_loc_bounds"),s=$("#"+this.mapDivId+"_loc_popup"),r=$("#"+this.mapDivId+"_loc_search_wait");i.blur((function(e){setTimeout((function(){r.html(""),s.hide()}),250)})),i.on("input",(function(t){s.hide(),""==i.val()&&e.removeSearchMarkers()})),i.keypress((function(t){let o=t.keyCode||t.which;if(27==o)return void s.hide();if(13!=o)return;r.html(HtmlUtils.image(icon_wait));let l=ramaddaBaseUrl+"/geocode?query="+encodeURIComponent(i.val());if(a.is(":checked")){let t=e.transformProjBounds(e.getMap().getExtent());l+="&bounds="+t.top+","+t.left+","+t.bottom+","+t.right}$.getJSON(l,(function(t){r.html("");let a=HtmlUtils.openTag("div",["style","max-height:400px;overflow-y:auto;"]);if(0==t.result.length)return void r.html("Nothing found");e.locationSearchResults=t.result;for(let e=0;e<t.result.length;e++){let i=t.result[e].name.replace('"',"'"),s=t.result[e].icon;s||(s=ramaddaCdn+"/icons/green-dot.png"),a+=HtmlUtils.div(["class","ramadda-map-loc","name",i,"icon",s,"latitude",t.result[e].latitude,"longitude",t.result[e].longitude],"<img width='16' src="+s+"> "+t.result[e].name)}a+=HtmlUtils.div(["class","ramadda-map-loc","name","all"],"Show all");a+=HtmlUtils.closeTag("div"),s.html(a),HtmlUtils.setPopupObject(s),s.show(),s.position({of:i,my:"left bottom",at:"left top",collision:"fit fit"}),s.find(".ramadda-map-loc").click((function(){s.hide();let t=$(this).attr("name");if("all"==t)return void e.addAllLocationResults();let i=parseFloat($(this).attr("latitude")),a=parseFloat($(this).attr("longitude")),r=$(this).attr("icon"),o=.05,l=e.transformLLBounds(MapUtils.createBounds(a-o,i-o,a+o,i+o)),n=MapUtils.createLonLat(a,i);e.removeSearchMarkers(),e.searchMarkerList=[],e.searchMarkerList.push(e.addMarker("search",n,r,"",t,20,20));let h=e.transformProjBounds(e.getMap().getExtent());Math.abs(h.top-h.bottom)>o?e.zoomToExtent(l):e.setCenter(MapUtils.createLonLat(a,i))}))})).fail((function(e,t,i){r.html("Error:"+i)}))}))},addVectorLayer:function(e,t){if(this.addLayer(e),this.vectorLayers.push(e),this.getCanSelect(t)){let t=this;this.getMap().featureSelect?this.getMap().featureSelect.layers.push(e):this.getMap().featureSelect=new OpenLayers.Control.SelectFeature([e],{multiple:!1,hover:this.selectOnHover,onSelect:function(e){t.showMarkerPopup(e,!0)}})}this.checkLayerOrder()},isLayerVisible:function(e,t){let i=this.getVisibilityCheckbox(e);return 0==i.length&&null!=t&&(i=$("#visible_"+this.mapId+"_"+t)),0==i.length||i.is(":checked")},initForDrawing:function(){let e=this;e.drawingLayer||(this.drawingLayer=MapUtils.createLayerVector("Drawing"),this.addLayer(e.drawingLayer)),this.drawControl=new OpenLayers.Control.DrawFeature(e.drawingLayer,OpenLayers.Handler.Point),this.getMap().addControl(e.drawControl)},drawingFeatureAdded:function(e){},addClickHandler:function(e,t,i,a){if(this.handleClickSelection=!0,this.lonFldId=e,this.latFldId=t,!this.clickHandler&&(this.clickListener=a,this.map))return this.clickHandler=new OpenLayers.Control.Click,this.clickHandler.setLatLonZoomFld(e,t,i,a),this.clickHandler.setTheMap(this),this.getMap().addControl(this.clickHandler),this.clickHandler.activate(),this.clickHandler},setSelection:function(e,t,i){this.selectRegion=t,this.argBase=e??"",GuiUtils&&(this.fldNorth=GuiUtils.getDomObject(this.argBase+"_north"),null==this.fldNorth&&(this.fldNorth=GuiUtils.getDomObject(this.argBase+".north")),null==this.fldNorth&&(this.fldNorth=GuiUtils.getDomObject(this.mapId+"_north")),this.fldSouth=GuiUtils.getDomObject(this.argBase+"_south"),this.fldSouth||(this.fldSouth=GuiUtils.getDomObject(this.argBase+".south")),null==this.fldSouth&&(this.fldSouth=GuiUtils.getDomObject(this.mapId+"_south")),this.fldEast=GuiUtils.getDomObject(this.argBase+"_east"),this.fldEast||(this.fldEast=GuiUtils.getDomObject(this.argBase+".east")),null==this.fldEast&&(this.fldEast=GuiUtils.getDomObject(this.mapId+"_east")),this.fldWest=GuiUtils.getDomObject(this.argBase+"_west"),this.fldWest||(this.fldWest=GuiUtils.getDomObject(this.argBase+".west")),null==this.fldWest&&(this.fldWest=GuiUtils.getDomObject(this.mapId+"_west")),this.fldLat=GuiUtils.getDomObject(this.argBase+"_latitude"),this.fldLat||(this.fldLat=GuiUtils.getDomObject(this.argBase+".latitude")),null==this.fldLat&&(this.fldLat=GuiUtils.getDomObject(this.mapId+"_latitude")),this.fldLon=GuiUtils.getDomObject(this.argBase+"_longitude"),null==this.fldLon&&(this.fldLon=GuiUtils.getDomObject(this.argBase+".longitude")),null==this.fldLon&&(this.fldLon=GuiUtils.getDomObject(this.mapId+"_longitude")),(this.fldLon||this.params.addMarkerOnClick)&&(this.addClickHandler(this?.fldLon?.id,this?.fldLat?.id),this.fldLon&&this.setSelectionMarker(this.fldLon.obj.value,this.fldLat.obj.value)))},selectionPopupInit:function(){this.inited||(this.initMap(this.selectRegion),this.argBase&&!this.fldNorth&&this.setSelection(this.argBase),this.fldNorth&&this.setSelectionBox(this.fldNorth.obj.value,this.fldWest.obj.value,this.fldSouth.obj.value,this.fldEast.obj.value,!0),this.fldLon&&(this.addClickHandler(this.fldLon.id,this.fldLat.id),this.setSelectionMarker(this.fldLon.obj.value,this.fldLat.obj.value))),this.map.updateSize()},setSelectionBoxFromFields:function(e){if(this.fldNorth&&(this.setSelectionBox(this.fldNorth.obj.value,this.fldWest.obj.value,this.fldSouth.obj.value,this.fldEast.obj.value,!0),this.selectorBox)){let t=this.selectorBox.bounds;this.getMap().setCenter(t.getCenterLonLat()),e&&this.zoomToExtent(t)}},toggleSelectorBox:function(e){this.selectorControl&&(e?(this.selectorControl.activate(),this.selectorControl.box.activate()):(this.selectorControl.deactivate(),this.selectorControl.box.deactivate()))},resetExtent:function(){debugBounds&&console.log("resetExtent"),this.getMap().zoomToMaxExtent()},setSelectionBox:function(e,t,i,a,s){if(""==e||""==t||""==i||""==a)return;let r=MapUtils.createBounds(t,Math.max(i,-MapUtils.defaults.maxLatValue),a,Math.min(e,MapUtils.defaults.maxLatValue));if(this.selectorBox)this.selectorBox.bounds=this.transformLLBounds(r);else{let s={color:"red",selectable:!1};this.selectorBox=this.createBox("","Selector box",e,t,i,a,"",s)}if(s&&(debugBounds&&console.log("calling setViewToBounds-1"),this.setViewToBounds(r)),this.boxes&&this.boxes.redraw(),this.selectImage){let s=MapUtils.createBounds(t,i,a,e);s=this.transformLLBounds(s),this.selectImage.extent=s,this.selectImage.redraw()}},clearSelectionMarker:function(){null!=this.selectorMarker&&(this.removeMarker(this.selectorMarker),this.selectorMarker=null)},clearSelectedFeatures:function(){if(null!=this.getMap().controls){let e=this.getMap().controls;for(i=0;i<e.length;i++)"olControlSelectFeature"==e[i].displayClass&&e[i].unselectAll()}},setSelectionMarker:function(e,t,i,a){if(!e||!t||""==e||""==t)return;null!=this.lonFldId&&($("#"+this.lonFldId).val(MapUtils.formatLocationValue(e)),$("#"+this.latFldId).val(MapUtils.formatLocationValue(t)));let s=MapUtils.createLonLat(e,t);if(null==this.selectorMarker?this.selectorMarker=this.addMarker(MapUtils.POSITIONMARKERID,s,"","","",20,10):this.selectorMarker.lonlat=this.transformLLPoint(s),this.markers&&this.markers.redraw(),i&&(debugBounds&&console.log("setSelectionMarker-1"),this.getMap().setCenter(this.selectorMarker.lonlat)),a){if(debugBounds&&console.log("setSelectionMarker-2"),a.zoomOut){let e=this.getMap().getZoom();return e--,void(this.getMap().isValidZoomLevel(e)&&this.zoomTo(e))}if(a.zoomIn){let e=this.getMap().getZoom();return e++,void(this.getMap().isValidZoomLevel(e)&&this.zoomTo(e))}let i=a.offset;if(i){let a=this.transformLLBounds(MapUtils.createBounds(e-i,t-i,e+i,t+i));this.zoomToExtent(a)}}},transformLLBounds:function(e){if(!e)return;return Utils.isDefined(e.north)&&(e=MapUtils.createBounds(e.west,e.south,e.east,e.north)),e.clone().transform(this.displayProjection,this.sourceProjection)},ensureLonLat:function(e){return e.length>0&&!e[0].transform&&(e=e.map((e=>e=MapUtils.createPoint(e.x,e.y)))),e},transformPoints:function(e){return(e=this.ensureLonLat(e)).forEach((e=>{e.transform(this.displayProjection,this.sourceProjection)})),e},transformLLPoint:function(e){if(!e)return null;return e.clone().transform(this.displayProjection,this.sourceProjection)},transformProjBounds:function(e){if(!e)return;return e.clone().transform(this.sourceProjection,this.displayProjection)},transformProjPoint:function(e){if(!e)return;return e.clone().transform(this.sourceProjection,this.displayProjection)},normalizeBounds:function(e){if(!this.map)return e;let t=e,i=e.left,a=e.right,s=this.getMap().restrictedExtent;return s||(s=this.maxExtent),s?(s.left>=0&&(e.left<0&&(i=e.left+360),e.right<0&&(a=e.right+360)),i>a&&(a=e.right+360),i=Math.max(i,s.left),a=Math.min(a,s.right),t=MapUtils.createBounds(i,e.bottom,a,e.top),t):e},findSelectionFields:function(){!this.argBase||this.fldNorth||this.fldLon||this.setSelection(this.argBase)},selectionClear:function(){this.findSelectionFields(),HU.addToDocumentUrl("map_bounds",""),this.fldNorth?(this.fldNorth.obj.value="",this.fldSouth.obj.value="",this.fldWest.obj.value="",this.fldEast.obj.value=""):this.fldLat&&(this.fldLon.obj.value="",this.fldLat.obj.value=""),this.selectorBox&&this.boxes&&(this.boxes.removeMarker(this.selectorBox),this.selectorBox=null),this.selectorMarker&&this.markers&&(this.removeMarker(this.selectorMarker),this.selectorMarker=null)},clearMarkers:function(){if(!this.markers)return;let e=this.getMarkers();this.markers.removeFeatures(e),this.markers.redraw()},getMarkers:function(){return null==this.markers?[]:this.markers.features},clearRegionSelector:function(e){this.selectorControl&&this.selectorControl.box&&this.selectorControl.box.removeBox()},addRegionSelectorControl:function(t,i){let a=this;a.selectorControl||(a.selectorListener=t,a.selectorControl=new OpenLayers.Control,OpenLayers.Util.extend(a.selectorControl,{draw:function(){this.box=new OpenLayers.Handler.Box(a.selectorControl,{done:this.notice},{keyMask:OpenLayers.Handler.MOD_SHIFT}),i||this.box.activate()},notice:function(e){let i=a.getMap().getLonLatFromPixel(MapUtils.createPixel(e.left,e.bottom)),s=a.getMap().getLonLatFromPixel(MapUtils.createPixel(e.right,e.top));i=a.transformProjPoint(i),s=a.transformProjPoint(s),e=MapUtils.createBounds(i.lon,i.lat,s.lon,s.lat),e=a.normalizeBounds(e),a.setSelectionBox(e.top,e.left,e.bottom,e.right,!1),a.findSelectionFields(),t&&t(e),a.fldNorth&&(a.fldNorth.obj.value=MapUtils.formatLocationValue(e.top),a.fldSouth.obj.value=MapUtils.formatLocationValue(e.bottom),a.fldWest.obj.value=MapUtils.formatLocationValue(e.left),a.fldEast.obj.value=MapUtils.formatLocationValue(e.right),HU.addToDocumentUrl("map_bounds",e.top+","+e.left+","+e.bottom+","+e.right))}}),a.map.addControl(a.selectorControl),a.panControl=new OpenLayers.Control,OpenLayers.Util.extend(a.panControl,{draw:function(){this.box=new OpenLayers.Handler.Drag(a.panControl,{down:this.down,move:this.move},{keyMask:OpenLayers.Handler.MOD_META,boxDivClassName:"map-drag-box"}),this.box.activate()},down:function(t){this.firstPoint=a.getMap().getLonLatFromPixel(MapUtils.createPixel(t.x,t.y)),this.firstPoint=a.transformProjPoint(this.firstPoint),a.findSelectionFields(),a.fldNorth&&(n=this.origNorth=parseFloat(a.fldNorth.obj.value),s=this.origSouth=parseFloat(a.fldSouth.obj.value),w=this.origWest=parseFloat(a.fldWest.obj.value),e=this.origEast=parseFloat(a.fldEast.obj.value),t=this.firstPoint,this.doWest=!1,this.doSouth=!1,this.doEast=!1,this.doNorth=!1,t.lon<=e&&t.lon>=w&&t.lat<=n&&t.lat>=s?(this.doSouth=this.doWest=this.doEast=this.doNorth=!0,this.type="center"):t.lon>e?t.lat>n?(this.type="ne",this.doEast=this.doNorth=!0):t.lat<s?(this.type="se",this.doSouth=this.doEast=!0):(this.type="e",this.doEast=!0):t.lon<w?t.lat>n?(this.type="nw",this.doWest=this.doNorth=!0):t.lat<s?(this.type="sw",this.doSouth=this.doWest=!0):(this.type="w",this.doWest=!0):t.lat>n?(this.type="n",this.doNorth=!0):(this.type="s",this.doSouth=!0))},move:function(e){let t=a.getMap().getLonLatFromPixel(MapUtils.createPixel(e.x,e.y));t=a.transformProjPoint(t),dx=t.lon-this.firstPoint.lon,dy=t.lat-this.firstPoint.lat,newWest=this.origWest,newEast=this.origEast,newSouth=this.origSouth,newNorth=this.origNorth,this.doWest&&(newWest+=dx),this.doSouth&&(newSouth+=dy),this.doEast&&(newEast+=dx),this.doNorth&&(newNorth+=dy);let i=MapUtils.createBounds(newWest,newSouth,newEast,newNorth);i=a.normalizeBounds(i),a.setSelectionBox(i.top,i.left,i.bottom,i.right,!1),a.findSelectionFields(),a.fldNorth&&(a.fldNorth.obj.value=MapUtils.formatLocationValue(i.top),a.fldSouth.obj.value=MapUtils.formatLocationValue(i.bottom),a.fldWest.obj.value=MapUtils.formatLocationValue(i.left),a.fldEast.obj.value=MapUtils.formatLocationValue(i.right))}}),a.map.addControl(a.panControl))},closePopup:function(e){if(this.currentPopup){this.getMap().removePopup(this.currentPopup);try{this.currentPopup.destroy()}catch(e){console.error("Error destroying map popup:"+e)}this.currentPopup=null,this.hiliteBox(""),this.selectedFeature&&this.unselectFeature(this.selectedFeature)}},onPopupClose:function(e){if(this.params.displayDiv&&this.showText(""),this.currentPopup){this.getMap().removePopup(this.currentPopup);try{this.currentPopup.destroy()}catch(e){}this.currentPopup=null,this.hiliteBox(""),this.selectedFeature&&this.unselectFeature(this.selectedFeature)}},findObject:function(e,t){for(i=0;i<t.length;i++){let a=t[i].ramaddaId;if(a||(a=t[i].id),a==e)return t[i]}return null},findMarker:function(e){return this.markers?this.findObject(e,this.getMarkers()):null},findFeature:function(e){return this.features[e]},findBox:function(e){return this.boxes?this.findObject(e,this.boxes.markers):null},hiliteBox:function(e){this.currentBox&&this.currentBox.setBorder(this.currentBox.defaultBorderColor||"blue",1),this.currentBox=this.findBox(e),this.currentBox&&this.currentBox.setBorder("red")},checkMarkerVisibility:function(){if(!this.markers)return;let e=this.getMarkers();for(let t=0;t<e.length;t++){marker=e[t];let i=this.isLayerVisible(marker.ramaddaId,marker.parentId);marker.style.display=i?"inline":"none"}this.markers.redraw()},checkLinesVisibility:function(){if(!this.lines)return;let e=this.lines.features;for(let t=0;t<e.length;t++){let i=e[t],a=this.isLayerVisible(i.ramaddaId);i.style.display=a?"inline":"none"}this.lines.redraw()},checkBoxesVisibility:function(){if(this.boxes){for(let e in this.boxes.markers){e=this.boxes.markers[e];let t=this.isLayerVisible(e.ramaddaId);e.display(t)}this.boxes.redraw()}},checkImageLayerVisibility:function(){this.imageLayersList&&this.imageLayersList.forEach((e=>{let t=this.isLayerVisible(e.id);e.setVisibility(t),t?e.box&&(this.removeBox(e.box),e.box=this.createBox(i,"",e.north,e.west,e.south,e.east,e.text,{})):e.box&&(this.removeBox(e.box),e.box=null)}))},hiliteMarker:function(e){let t=this.findMarker(e);if(t||(t=this.findFeature(e)),!t&&this.imageLayers&&(t=this.imageLayers[e],t||(t=this.imageLayers[e.replace(/_/g,"-")])),!t&&this.polygonMap&&(t=this.polygonMap[e],t))return void this.handleFeatureclick(t.layer,t,!1,{});if(!t)return;let i=t.latLonBounds;if(i){let e=this.transformLLBounds(i);this.zoomToExtent(e)}else debugBounds&&console.log("hiliteMarker"),this.setCenter(t.lonlat);this.showMarkerPopup(t)},clearAllProgress:function(){this.clearProgress(),this.hideLoadingImage()},clearProgress:function(e){$("#"+this.mapDivId+"_progress").hide()},setProgress:function(e){$("#"+this.mapDivId+"_progress").html(e),$("#"+this.mapDivId+"_progress").show()},setLabel:function(e){$("#"+this.mapDivId+"_label").html(e)},setCursor:function(e){jqid(this.mapDivId+"_themap").css("cursor",e??"default")},hideLoadingImage:function(){this.setCursor(),jqid(this.mapDivId+"_themap").css("cursor","default"),this.loadingImage&&(this.loadingImage.style.visibility="hidden")},showLoadingImage:function(){if(this.setCursor("progress"),this.loadingImage)return void(this.loadingImage.style.visibility="visible");let e=MapUtils.createSize(120,120),t=this.getMap().viewPortDiv.offsetWidth,i=this.getMap().viewPortDiv.offsetHeight,a=MapUtils.createPixel(t/2-e.w/2,i/2-e.h/2);this.loadingImage=MapUtils.createImage("loadingimage",a,e,ramaddaCdn+"/icons/mapprogress.gif"),this.loadingImage.style.zIndex=1010,this.getMap().viewPortDiv.appendChild(this.loadingImage)},centerOnMarkerLayer:function(){this.centerOnMarkers(null,!1,!0)},centerOnMarkersInit:function(){this.hadDefaultBounds||this.centerOnMarkers(null)},getLayerVisbileExtent:function(e){let t=null,i=e.features;if(!i)return e.getDataExtent();if(i.length>0){let e=null;for(let a=0,s=i.length;a<s;a++)i[a].getVisibility()&&(e=i[a].geometry,e&&(null===t&&(t=MapUtils.createBounds()),t.extend(e.getBounds())))}return t},animateViewToBounds:function(e,t,i){Utils.isDefined(i)||(i=1),t||(t=this.transformProjBounds(this.getMap().getExtent()));if(i>10)return void this.setViewToBounds(e);let a=i/10;i++,newBounds=MapUtils.createBounds(t.left+(e.left-t.left)*a,t.bottom+(e.bottom-t.bottom)*a,t.right+(e.right-t.right)*a,t.top+(e.top-t.top)*a),this.setViewToBounds(newBounds),setTimeout((()=>this.animateViewToBounds(e,t,i)),125)},getPopupText:function(e,t){return null==e?null:(0==e.indexOf("base64:")&&0==(e=window.atob(e.substring(7))).indexOf("{")&&(props=JSON.parse(e),(e=props.text)||(e=""),t&&(t.inputProps=props)),e)},clearSeenMarkers:function(){this.seenMarkers={}},addEntryMarker:function(e,t,i,a,s,r,o){if(marker=this.addMarker(e,t,i,a,s),marker.entryType=r,marker.entryId=e,o&&o.fillColor){let i={pointRadius:o.radius||12,fillColor:o.fillColor,strokeWidth:o.strokeWidth,strokeColor:o.strokeColor};this.addPoint(e,t,i,"")}},createMarker:function(e,t,i,a,s,r,o,l,n,h,d){if("dot"==i)return this.createPoint(e,t,{},s);Utils.isDefined(t.x)&&(t=MapUtils.createLonLat(t.x,t.y)),d=d??{},Array.isArray(t)&&(t=MapUtils.createLonLat(t[0],t[1]));let u=o||this.params.iconWidth||this.params.iconSize||20,c=o||this.params.iconHeight||this.params.iconSize||20;o=u,null==l&&(l=0),null==n&&(n=0),this.markers||(this.markers=MapUtils.createLayerVector("Markers"),this.addVectorLayer(this.markers,h)),Utils.stringDefined(i)||(i=ramaddaCdn+"/icons/marker.png");let p=MapUtils.createSize(u,c),m=MapUtils.createIcon(i,p,null,(function(e){return MapUtils.createPixel(-o.w/2-l,-o.h/2-n)})),g=this.transformLLPoint(t),f=MapUtils.createMarker(g,m),y=MapUtils.createPoint(t.lon,t.lat).transform(this.displayProjection,this.sourceProjection),L={externalGraphic:i,graphicWidth:o,graphicXOffset:l+-o/2,graphicYOffset:-o/2,labelYOffset:d.labelYOffset??-o,label:d.label};d.fontSize&&(L.fontSize=d.fontSize),Utils.isDefined(d.rotation)&&(L.rotation=d.rotation);let M=MapUtils.createVector(y,{description:""},L);M.ramaddaId=e,M.parentId=r,M.text=this.getPopupText(s,M),M.name=a,M.location=t,f.ramaddaId=e,f.text=this.getPopupText(s,f),f.name=a,f.location=t;let x=t+"";M.locationKey=x;let k=this.seenMarkers[x];null==k&&(k=[],this.seenMarkers[x]=k),k.push(M);let b=this,v=function(e){b.showMarkerPopup(f,!0),null!=f.ramaddaClickHandler&&f.ramaddaClickHandler.call(null,f),MapUtils.stopEvent(e)};return f.events.register("click",f,v),f.events.register("touchstart",f,v),this.isLayerVisible(f.ramaddaId,f.parentId)||f.display(!1),M.what="marker",M},addMarkerEmbed:function(e){let t={};if(e.startsWith("base64:")&&(e=window.atob(e.substring(7))),0==e.indexOf("{"))t=JSON.parse(e);else{let[i,a,s]=e.split(",");t.lat=i,t.lon=a,t.text=s}let i=MapUtils.createLonLat(parseFloat(t.lon),parseFloat(t.lat));null!=t.size&&""!=t.size||(t.size=16);let a=t.type||"icon",s=t;if(s.pointRadius=t.size||"16",s.labelYOffset=-8-s.pointRadius,"icon"==a){let e=t.icon||"/markers/marker-red.png";this.addMarker("",i,e,t.description,t.description,"",parseFloat(t.size||"16"),null,!0,s)}else s.fillColor=s.fillColor||"blue",s.strokeWidth=s.strokeWidth||"1",s.graphicName=a,"none"==a&&(s.graphicName="circle",s.pointRadius=0,s.fillColor="transparent"),this.addPoint("",i,s,t.description),"circle"!=s.graphicName&&this.addPoint("",i,{pointRadius:s.pointRadius,strokeColor:"transparent",fillColor:"transparent"},t.description);this.setDoPopup(!0)},setDoPopup:function(e){this.params.doPopup=e},getDoPopup:function(e){return this.params.doPopup},createPolygonFromString:function(e,t,i,a,s,r){let o;[";",","].forEach((e=>{t.indexOf(e)>=0&&(o=e)})),i=i??{fill:!0,fillColor:"#0000ff",fillOpacity:.05,strokeWidth:1,strokeColor:"blue"};let l=t.split(o),n=[],h=[],d=[h];for(let e=2;e<l.length;e+=2){let t=parseFloat(l[e-2]),i=parseFloat(l[e-1]),s=parseFloat(l[e]),o=parseFloat(l[e+1]);if(!a){let e=t;t=i,i=e,e=s,s=o,o=e}if(!(isNaN(t)||isNaN(s)||isNaN(i)||isNaN(o)))if(r)n.push(i,t,o,s);else if(MapUtils.crossIDL(i,o)){let e=MapUtils.intercept(t,i,s,o);h.push(MapUtils.createPoint(i,t)),h.push(MapUtils.createPoint(i<0?-180:180,e)),h=[],d.push(h),h.push(MapUtils.createPoint(o<0?-180:180,e)),h.push(MapUtils.createPoint(o,s))}else h.push(MapUtils.createPoint(i,t)),h.push(MapUtils.createPoint(o,s))}if(r)return n;let u=[];return d.forEach((t=>{t.length>0&&u.push(this.createPolygon(e,"",t,i,s,!1))})),u},addPolygonString:function(e,t,i,a,s){let r=this.createPolygonFromString(e,t,i,a,s);return this.getLinesLayer().addFeatures(r),r},addMarkers:function(e){this.markers||(this.markers=MapUtils.createLayerVector("Markers"),this.addVectorLayer(this.markers,!0)),this.markers.addFeatures(e)},initBoxes:function(e){this.getMap(),this.addLayer(e),e.getFeatureFromEvent=function(e){return null}},removeBox:function(e){this.boxes&&e&&(this.boxes.removeMarker(e),this.boxes.redraw())},addBox:function(e){this.boxes||(this.boxes=MapUtils.createLayerBoxes("Boxes",{wrapDateLine:MapUtils.defaults.wrapDateline}),this.getMap()?this.initBoxes(this.boxes):this.initialBoxes=this.boxes),this.boxes.addMarker(e),this.boxes.redraw()},createBox:function(e,t,i,a,s,r,o,l){0==o.indexOf("base64:")&&(o=window.atob(o.substring(7)));let n={color:"blue",selectable:!0,zoomToExtent:!1,sticky:!1};for(let e in l)n[e]=l[e];n.color||(n.color=this.params.boxColor||"blue");let h=MapUtils.createBounds(a,Math.max(s,-MapUtils.defaults.maxLatValue),r,Math.min(i,MapUtils.defaults.maxLatValue)),d=this.transformLLBounds(h);box=MapUtils.createBox(d),box.sticky=n.sticky;let u=this;n.selectable&&box.events.register("click",box,(function(e){u.showMarkerPopup(box,!0),MapUtils.stopEvent(e)}));let c=MapUtils.createLonLat(a,i);return box.lonlat=this.transformLLPoint(c),box.text=this.getPopupText(o),box.name=t,box.setBorder(n.color,1),box.defaultBorderColor=n.color,box.ramaddaId=e,n.zoomToExtent&&this.centerOnMarkers(h),this.addBox(box),box},circleMarker:function(e,t){if(marker=this.findMarker(e),marker||(marker=this.findFeature(e)),!marker)return null;myattrs={pointRadius:12,stroke:!0,strokeColor:"red",strokeWidth:2,fill:!1},t&&$.extend(myattrs,t);return this.showFeatureText(marker),this.addPoint(e+"_circle",marker.location,myattrs)},addFeatureHighlightHandler:function(e){this.featureHighlightHandler=e},addFeatureSelectHandler:function(e){this.featureSelectHandler=e},showFeatureText:function(e){this.featureHighlightHandler&&this.featureHighlightHandler(e,!0);let t=this;if(e.text&&this.params.displayDiv){this.textFeature=e,setTimeout((function(){t.textFeature==e&&t.showText(t.textFeature.text)}),500)}},showText:function(e){$("#"+this.params.displayDiv).html(e)},hideFeatureText:function(e){this.featureHighlightHandler&&this.featureHighlightHandler(e,!1),e&&this.textFeature!=e||this.params.displayDivSticky||this.showText("")},createPoint:function(e,t,i,a,s,r){let o=t;void 0===t.x?t=MapUtils.createPoint(t.lon,t.lat):o=MapUtils.createLonLat(t.x,t.y),this.basePointStyle||(this.basePointStyle=$.extend({},MapUtils.getVectorStyle("default")),$.extend(this.basePointStyle,{pointRadius:5,stroke:!0,strokeColor:"red",strokeWidth:0,strokeOpacity:.75,fill:!0,fillColor:"blue",fillOpacity:.75}));let l=Object.assign({},this.basePointStyle);i&&(l=Object.assign(l,i),l.pointRadius<=0&&(l.pointRadius=1)),""!=l.fillColor&&"none"!=l.fillColor||(l.fillOpacity=0),""!=l.strokeColor&&"none"!=l.strokeColor||(l.strokeOpacity=0);let n=MapUtils.createPoint(t.x,t.y);n.transform(this.displayProjection,this.sourceProjection);let h=MapUtils.createVector(n,null,l);return h.center=n,h.ramaddaId=e,a&&(h.text=this.getPopupText(a,h)),h.textGetter=s,h.location=o,h.lonlat=o,this.features[e]=h,h},addPoint:function(e,t,i,a,s){let r=this.createPoint(e,t,i,a,s);return this.getMarkersLayer().addFeatures([r],{silent:!0}),r},addPoints:function(e){this.getMarkersLayer().addFeatures(e,{silent:!0})},getMarkersLayer:function(){return null==this.circles&&(this.circles=MapUtils.createLayerVector("Shapes"),this.circles.layerName="circles",this.circles.setZIndex(1),this.addVectorLayer(this.circles),this.circles.canSelect=!0),this.circles},setPointsVisibility:function(e){this.circles&&this.circles.setVisibility(e)},addRectangle:function(e,t,i,a,s,r,o){let l=[MapUtils.createPoint(i,t),MapUtils.createPoint(i,a),MapUtils.createPoint(s,a),MapUtils.createPoint(s,t),MapUtils.createPoint(i,t)];return this.addPolygon(e,"",l,r,o)},createLine:function(e,t,i,a,s,r,o,l){let n=[MapUtils.createPoint(a,i),MapUtils.createPoint(r,s)];return this.createPolygon(e,t,n,o,l)},addLine:function(e,t,i,a,s,r,o,l,n){let h=[MapUtils.createPoint(a,i),MapUtils.createPoint(r,s)];return this.addPolygon(e,t,h,o,l,n)},addSelectionMarker:function(e,t){this.selectorMarker&&this.removeMarker(this.selectorMarker),this.selectorMarker=this.addMarker(MapUtils.POSITIONMARKERID,e,this.params.markerIcon??"","","",40,20),this.getProperty("addMarkerOnClick")&&(t||ramaddaMapShareState(this,{marker:e}))},addMarker:function(e,t,i,a,s,r,o,l,n,h,d,u){let c=this.createMarker(e,t,i,a,s,r,o,0,l,n,h);return c.lonlat=t,u||this.addMarkers([c]),d&&this.addPolygonString(e,d,null,!0,s),c},addLines:function(e,t,i,a,s,r){(i=i||{}).strokeWidth||(i.strokeWidth=this.params.strokeWidth),i.strokeColor||(i.strokeColor=this.params.strokeColor);let o=[];for(let e=0;e<a.length;e+=2)o.push(MapUtils.createPoint(a[e+1],a[e]));let l=this.addPolygon(e,t,o,i,s,!1,!0);if(r&&this.getLinesLayer()){let e=this.getLinesLayer().getDataExtent();e&&this.zoomToExtent(e,!0)}return l},removePolygon:function(e){this.lines&&this.lines.removeFeatures([e])},createPolygon:function(e,t,i,a,s,r){let o;i.length>1?o=MapUtils.createLonLat(i[0].x+(i[1].x-i[0].x)/2,i[0].y+(i[1].y-i[0].y)/2):i.length>0&&(o=MapUtils.createLonLat(i[0].x,i[0].y)),i=this.transformPoints(i);let l,n=$.extend({},MapUtils.getVectorStyle("default")),h=$.extend({},n);if(a)for(let e in a)h[e]=a[e];l=r?MapUtils.createLineString(i):MapUtils.createPolygon(MapUtils.createLinearRing(i));let d=MapUtils.createVector(l,null,h);s||(s=t),d.text=s,d.ramaddaId=e,d.location=o,d.name=t,this.polygonMap||(this.polygonMap={}),this.polygonMap[e]=d;let u=this.isLayerVisible(d.ramaddaId);return d.style.display=u?"inline":"none",d},addPolygon:function(e,t,i,a,s,r,o){let l=this.createPolygon(e,t,i,a,s,o);return r||this.getLinesLayer().addFeatures([l]),l},getLinesLayer:function(){if(!this.lines){let e=$.extend({},MapUtils.getVectorStyle("default"));this.lines=MapUtils.createLayerVector("Lines",{style:e}),this.addVectorLayer(this.lines),this.lines.isMapLayer=!0}return this.lines},getFeaturesBounds:function(e,t){if(!e)return null;let i=MapUtils.createBounds();return e.forEach(((e,t)=>{e.geometry&&MapUtils.isFeatureVisible(e)&&(i=MapUtils.extendBounds(i,e.geometry.getBounds()))})),t&&(i=this.transformProjBounds(i)),i},centerOnFeatures:function(e){let t=this.getFeaturesBounds(e);if(t.left!=t.right&&t.top!=t.bottom)this.zoomToExtent(t);else{t=this.transformProjBounds(t);let e=t.getCenterLonLat();this.setCenter(e)}},getHighlightLinesLayer:function(){if(!this.highlightlines){let e=$.extend({},MapUtils.getVectorStyle("default"));this.highlightlines=MapUtils.createLayerVector("Highlight Lines",{style:e}),this.addVectorLayer(this.highlightlines)}return this.highlightlines},handleMarkerLayer:function(){this.currentPopup&&(this.getMap().removePopup(this.currentPopup),this.currentPopup.destroy(),this.currentPopup=null);let e=this.currentEntryMarker;if(e.entryLayer){let t=this.loadedLayers.indexOf(e.entryLayer);return t>=0&&(this.loadedLayers=this.loadedLayers.slice(t)),this.getMap().removeLayer(e.entryLayer),void(e.entryLayer=null)}let t=this.handleEntrySelect(e.entryId,e.name,e.entryType);t&&(e.entryLayer=t)},showPopupSlider:function(e,t){return!(!this.params.doPopupSlider&&!this.params.popupSliderRight)&&(this.doingPopup=!0,setTimeout((()=>{let e=$("#"+this.mapDivId+"_slider");this.params.popupSliderRight?e.css("right","0px"):e.css("left","0px"),e.hide();let i=HU.getDimension(this.params.popupWidth),a=HU.div([STYLE,HU.css("width",i,"padding","5px")],HU.div([ID,this.mapDivId+"_sliderclose",CLASS,"ramadda-clickable"],HU.getIconImage(icon_close))+t);e.html(a),e.slideDown(800),$("#"+this.mapDivId+"_sliderclose").click((()=>{e.slideUp()})),setTimeout((()=>{this.doingPopup=!1}),10)}),500),!0)},showMarkerPopup:function(e,t,i){if(debugPopup&&console.log("showMarkerPopup"),this.entryClickHandler&&window[this.entryClickHandler]&&!window[this.entryClickHandler](this,e))return void(debugPopup&&console.log("\twindowClickHandler"));if(this.currentPopup){this.getMap().removePopup(this.currentPopup);try{this.currentPopup.destroy()}catch(e){}}if(this.featureSelectHandler&&this.featureSelectHandler(e))return void(debugPopup&&console.log("\tfeatureSelectHandler returned true"));let a=e.ramaddaId;if(a||(a=e.id),this.shareSelected&&window.ramaddaDisplaySetSelectedEntry&&ramaddaDisplaySetSelectedEntry(a),!this.getDoPopup())return void(debugPopup&&console.log("\tparams.doPopup=false"));let s=e.inputProps||{};this.hiliteBox(a);let r;if(e.inputProps&&(e.text=this.getPopupText(e.inputProps.text)),e.textGetter?(r=e.textGetter(e),debugPopup&&console.log("\thas textGetter:"+r)):this.textGetter&&(r=this.textGetter(e.layer,e)),r||(r=e.text),!r)return void(debugPopup&&console.log("\tno marker text"));if(this.params.displayDiv)return this.showText(r),void(debugPopup&&console.log("\thad displayDiv"));if(t&&null!=e.locationKey&&(markers=this.seenMarkers[e.locationKey],markers&&markers.length>1)){debugPopup&&console.log("showMarkerPopup: seenMarkers:",markers.length),r="";for(let t=0;t<markers.length;t++){if(otherMarker=markers[t],t>0&&(r+="<hr>"),otherMarker.inputProps&&(otherMarker.text=otherMarker.textGetter?otherMarker.textGetter(e):this.getPopupText(otherMarker.inputProps.text)),r+=otherMarker.text?otherMarker.text:otherMarker.textGetter?otherMarker.textGetter(e):"NA",t>10)break}}let o=e.location,l=null;if(o){if(void 0===o.lon&&(o=MapUtils.createLonLat(o.x,o.y)),r&&""!=r||o.lat==o.lat&&(r="Lon: "+o.lat+"<br>Lat: "+o.lon),e.entryType){let t=e.entryType;if("geo_kml"==t||"geo_json"==t||"geo_shapefile"==t){this.currentEntryMarker=e;let t="ramaddaMapMap['"+this.mapId+"'].handleMarkerLayer();",i=e.entryLayer?"Remove Layer":"Load Layer";r="<center>"+HtmlUtils.onClick(t,i)+"</center>"+r}}l=this.transformLLPoint(o)}else if(e.geometry){let t=e.geometry.getBounds();t&&(l=t.getCenterLonLat())}if(null==l)return void(debugPopup&&console.log("\tno projPoint"));if(this.showPopupSlider(e.location,r))return;let n={};s.chartType&&(n.width=400);let h=HU.getUniqueId("div"),d=HU.div(["style","width:100%;","id",h]);n.width=n.width??s.minSizeX??this.params.popupWidth,n.height=n.height??s.minSizeY??this.params.popupHeight;let u=this.makePopup(l,d,n);debugPopup&&console.log("showMarkerPopup:",r),e.popupText=u,u.marker=e,this.addPopup(u),jqid(h).html(r),debugPopup&&console.log("\tmade popup"),s.chartType&&this.popupChart(e.inputProps),this.popupHandler&&this.popupHandler(e,u)},popupChart:function(e){let t=getOrCreateDisplayManager(e.divId,{},!0),i={entryId:e.entryId},a=e.title;a||(a="Chart");let s=null==e.fields?null:e.fields.split(","),r={title:a,layoutHere:!0,divid:e.divId,entryId:e.entryId,fields:s,vAxisMinValue:e.vAxisMinValue,vAxisMaxValue:e.vAxisMaxValue,data:new PointData(a,null,null,getRamadda().getRoot()+"/entry/show?entryid="+e.entryId+"&output=points.product&product=points.json&numpoints=10000",i)};if(e.chartArgs){let t=e.chartArgs.split(",");for(let e=0;e<t.length;e+=2)r[t[e]]=t[e+1]}t.createDisplay(e.chartType,r)},uncircleMarker:function(e){feature=this.features[e+"_circle"],feature&&this.circles&&this.circles.removeFeatures([feature]),this.hideFeatureText(feature)},removePoint:function(e){this.removePoints([e])},removePointsLayer:function(){this.circles&&(this.removeLayer(this.circles),this.circles=null)},removeMarkersLayer:function(){this.markers&&(this.removeLayer(this.markers),this.markers=null)},removePoints:function(e){this.circles&&this.circles.removeFeatures(e)},removeMarker:function(e){this.removeMarkers([e])},removeMarkers:function(e){this.markers&&this.markers.removeFeatures(e),e.forEach((e=>{if(!e)return;if(!e.locationKey)return;this.seenMarkers[e.locationKey]&&(this.seenMarkers[e.locationKey]=Utils.removeElement(this.seenMarkers[e.locationKey],e))}))},createFeatureLayer:function(e,t,i,a){let s=$.extend({},MapUtils.getVectorStyle("default"));i&&$.extend(s,i),(a=a||{}).style=s;let r=MapUtils.createLayerVector(e||"Markers",a);return this.externalLayers.push(r),this.addVectorLayer(r,t),r}};
