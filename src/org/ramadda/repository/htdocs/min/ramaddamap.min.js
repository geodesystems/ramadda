var debugBounds=!1,getMapDebug=!1,ramaddaMapRegions=null,map_esri_topo="esri.topo",map_esri_street="esri.street",map_esri_worldimagery="esri.worldimagery",map_esri_terrain="esri.terrain",map_shaded_relief="shadedrelief",map_historic="historic",map_esri_shaded="esri.shaded",map_esri_lightgray="esri.lightgray",map_esri_darkgray="esri.darkgray",map_esri_physical="esri.physical",map_esri_aeronautical="esri.aeronautical",map_opentopo="opentopo",map_usgs_topo="usgs.topo",map_usgs_imagery="usgs.imagery",map_usgs_relief="usgs.relief",map_watercolor="watercolor",map_lightblue="lightblue",map_white="white",map_blue="blue",map_black="black",map_gray="gray",map_forestservice="usfs",map_naip="naip",map_publiclands="publiclands",map_osm="osm",map_osm_toner="osm.toner",map_osm_toner_lite="osm.toner.lite",map_ol_openstreetmap="ol.openstreetmap",map_ms_shaded="ms.shaded",map_ms_hybrid="ms.hybrid",map_ms_aerial="ms.aerial",map_default_layer=map_osm;OpenLayers.Renderer.symbol.lightning=[0,0,4,2,6,0,10,5,6,3,4,5,0,0],OpenLayers.Renderer.symbol.rectangle=[0,0,4,0,4,10,0,10,0,0],OpenLayers.Renderer.symbol.church=[4,0,6,0,6,4,10,4,10,6,6,6,6,14,4,14,4,6,0,6,0,4,4,4,4,0],OpenLayers.Renderer.symbol._x=[0,0,6,6,3,3,6,0,0,6,3,3],OpenLayers.Renderer.symbol.arrow=[0,0,5,10,10,0],OpenLayers.Renderer.symbol.plane=[5,0,5,0,4,1,4,3,0,5,0,6,4,5,4,8,2,10,3,10,5,9,5,9,8,10,8,10,6,8,6,5,10,6,10,5,6,3,6,1,5,0,5,0],OpenLayers.Renderer.symbol.arrow=[4,0,-2,10,12,10,6,0,4,0,-2,10,12,10,6,0];var MapUtils={me:"MapUtils",CUSTOM_MAP:"CUSTOM",POSITIONMARKERID:"location",formatLocationValue:function(e){return number_format(e,4)},createLonLat:function(e,t){return e=parseFloat(e),t=parseFloat(t),new OpenLayers.LonLat(e,t)},createBounds:function(e,t,i,a){return e=parseFloat(e),t=parseFloat(t),i=parseFloat(i),a=parseFloat(a),new OpenLayers.Bounds(e,t,i,a)},createProjection:function(e){return new OpenLayers.Projection(e)},mapRegionSelected:function(e,t){let i=$("#"+e).val();if(null==i)return void console.log("Error: No map region value");if(""==i)return void this.toggleMapWidget(t,!1);let a=i.split(",");if(1==a.length)return a[0]!=this.CUSTOM_MAP?void 0:(firstCustom||this.setMapRegion(t,"","","","",""),firstCustom=!1,void this.toggleMapWidget(t,!0));5==a.length&&(this.toggleMapWidget(t,!1),this.setMapRegion(t,a[0],a[1],a[2],a[3],a[4]))},setMapRegion:function(e,t,i,a,s,r){$("#"+e+"_regionid").val(t),$("#"+e+"_north").val(i),$("#"+e+"_west").val(a),$("#"+e+"_south").val(s),$("#"+e+"_east").val(r)},toggleMapWidget:function(e,t){if(t){let t=window[e];t&&!t.inited&&t.initMap(!0),$("#"+e+"_mapToggle").show()}else $("#"+e+"_mapToggle").hide()}};MapUtils.defaults={maxLatValue:85,zoomLevels:40,defaultZoomLevel:-1,maxExtent:MapUtils.createBounds(-20037508,-20037508,20037508,20037508),sourceProjection:MapUtils.createProjection("EPSG:900913"),displayProjection:MapUtils.createProjection("EPSG:4326"),units:"m",doSphericalMercator:!0,wrapDateline:!0,location:MapUtils.createLonLat(0,0)},MapUtils.circleHiliteAttrs={strokeColor:"black",strokeWidth:1,fill:!0,fillOpacity:.5,fillColor:"red"};var ramaddaMapMap={};function ramaddaMapAdd(e){null==window.globalMapList&&(window.globalMapList=[]),window.globalMapList.push(e),ramaddaMapMap[e.mapId]=e}function ramaddaMapRemove(e){null==window.globalMapList&&(window.globalMapList=[]),window.globalMapList.push(e),delete ramaddaMapMap[e.mapId]}function ramaddaMapCheckLayout(){setTimeout((()=>{null!=window.globalMapList&&window.globalMapList.map((e=>{e.map.updateSize()}))}),1e3)}var ramaddaMapLastShareTime=0,ramaddaMapLastShareMap="";function ramaddaMapShareState(e,t){let i=(new Date).getTime();if(e.mapId!=ramaddaMapLastShareMap&&i-ramaddaMapLastShareTime<2e3)return;if(ramaddaMapLastShareTime=i,ramaddaMapLastShareMap=e.mapId,e.stateIsBeingSet)return;let a=e.params.linkGroup;if(e.params.linked||e.params.linkMouse||a){e.getBounds(),e.map.baseLayer,e.map.getZoom();for(var s=0;s<window.globalMapList.length;s++){var r=window.globalMapList[s];r.stateIsBeingSet||r.mapId==e.mapId||a==r.params.linkGroup&&(r.stateIsBeingSet=!0,r.receiveShareState(e,t),r.stateIsBeingSet=!1)}}}function RepositoryMap(e,t){ramaddaMapAdd(this);let i=this;t||(t={}),this.params=t,this.mapId=e||"map",t.mapCenter&&([lat,lon]=t.mapCenter.split(","),t.initialLocation={lon:lon,lat:lat});let a=!0;t.simple&&(a=!1);let s={pointRadius:3,strokeColor:"blue",strokeWidth:1,fillOpacity:.8,fillColor:"#e6e6e6",layerStrokeColor:"blue",layerStrokeWith:1,layerFillColor:"#ccc",layerFillOpacity:.3,highlightStrokeColor:"red",highlightFillColor:"blue",highlightStrokeWidth:2,highlightFillOpacity:.1,selectStrokeColor:null,selectFillColor:null,selectStrokeWidth:null,selectFillOpacity:.4,scrollToZoom:!0,selectOnHover:!1,highlightOnHover:!0,showLocationSearch:!1,imageOpacity:1,iconSize:null,iconWidth:null,iconHeight:null,tickSelectColor:"red",tickHoverColor:"blue",tickColor:"#888",showDates:!0,defaultMapLayer:map_default_layer,showLayerToggle:!1,showLatLonLines:!1,showScaleLine:a,showLayerSwitcher:a,showLatLonPosition:!1,showZoomPanControl:!1,showZoomOnlyControl:!0,showSearch:!1,showBookmarks:!1,showBounds:!0,showOpacitySlider:!1,doPopup:!0,doPopupSlider:!1,popupWidth:200,popupHeight:200,popupSliderRight:!1,doSelect:!0,enableDragPan:!0,linked:!1,linkGroup:null,linkMouse:!1};Utils.isDefined(t.initialZoom)||(t.initialZoom=Utils.isDefined(t.zoomLevel)?t.zoomLevel:MapUtils.defaults.defaultZoomLevel),$.extend(s,t),t=this.params=s,this.getProperty=(e,t)=>Utils.isDefined(this.params[e])?this.params[e]:t,$.extend(this,{name:"map",map:null,sourceProjection:MapUtils.defaults.sourceProjection,displayProjection:MapUtils.defaults.displayProjection,projectionUnits:MapUtils.defaults.units,mapDivId:this.mapId,defaultLocation:MapUtils.defaults.location,latlonReadout:null,haveAddedDefaultLayer:!1,defaultCanSelect:!0,layer:null,markers:null,vectors:null,allLayers:[],externalLayers:[],loadedLayers:[],nonSelectLayers:[],shareSelected:!1,boxes:null,kmlLayer:null,kmlLayerName:null,geojsonlLayer:null,geojsonLayerName:null,vectorLayers:[],features:{},lines:null,selectorBox:null,selectorMarker:null,listeners:[],fixedText:!1,initialLayers:[],imageLayers:{},imageLayersList:[]}),this.seenMarkers={},this.startDate=null,this.endDate=null,this.startFeature=null,this.endFeature=null,this.basePointStyle=null,this.defaultStyle={pointRadius:this.params.pointRadius,fillOpacity:this.params.fillOpacity,fillColor:this.params.fillColor,fill:this.params.fill,strokeColor:this.params.strokeColor,strokeWidth:this.params.strokeWidth},this.highlightStyle={strokeColor:this.params.highlightStrokeColor,strokeWidth:this.params.highlightStrokeWidth,fillColor:this.params.highlightFillColor,fillOpacity:this.params.highlightFillOpacity},Utils.isDefined(t.onSelect)?this.onSelect=t.onSelect:this.onSelect=null,t.initialLocation?(Array.isArray(t.initialLocation)?this.defaultLocation=MapUtils.createLonLat(t.initialLocation[1],t.initialLocation[0]):this.defaultLocation=MapUtils.createLonLat(t.initialLocation.lon,t.initialLocation.lat),debugBounds&&console.log("setting default location:"+this.defaultLocation)):Utils.isDefined(t.initialBounds)&&("string"==typeof t.initialBounds&&(t.initialBounds=t.initialBounds.split(",")),this.defaultBounds=MapUtils.createBounds(t.initialBounds[1],t.initialBounds[2],t.initialBounds[3],t.initialBounds[0]),this.defaultLocation=null,debugBounds&&console.log("setting default bounds-1:"+this.defaultBounds));var r={projection:this.sourceProjection,displayProjection:this.displayProjection,units:this.projectionUnits,controls:[],maxResolution:156543.0339,maxExtent:MapUtils.defaults.maxExtent,div:this.mapDivId,eventListeners:{featureover:function(e){i.featureOverHandler?i.featureOverHandler(e):i.handleFeatureover(e.feature)},featureout:function(e){i.featureOutHandler?i.featureOutHandler(e):i.handleFeatureout(e.feature)},nofeatureclick:function(e){i.handleNofeatureclick(e.layer)},featureclick:function(e){if(i.featureClickHandler)return void i.featureClickHandler(e);if(e.feature&&e.feature.noSelect)return;let t=(new Date).getTime();Utils.isDefined(this.lastClickTime)&&t-this.lastClickTime<500||(this.lastClickTime=t,i.handleFeatureclick(e.layer,e.feature,!1,e))}}};this.mapOptions=r,this.finishMapInit(),jQuery(document).ready((function(e){i.getMap()&&i.getMap().updateSize()}))}OpenLayers.Control.Click=OpenLayers.Class(OpenLayers.Control,{listeners:null,addListener:function(e){null==this.listeners&&(this.listeners=[]),this.listeners.push(e)},defaultHandlerOptions:{single:!0,double:!1,pixelTolerance:0,stopSingle:!1,stopDouble:!1},initialize:function(e){this.handlerOptions=OpenLayers.Util.extend({},this.defaultHandlerOptions),OpenLayers.Control.prototype.initialize.apply(this,arguments),this.handler=new OpenLayers.Handler.Click(this,{click:this.trigger},this.handlerOptions)},setLatLonZoomFld:function(e,t,i,a){this.lonFldId=e,this.latFldId=t,this.zoomFldId=i,this.clickListener=a},setTheMap:function(e){this.theMap=e},trigger:function(e){var t=this.theMap.getMap().getLonLatFromViewPortPx(e.xy),i=this.theMap.transformProjPoint(t);if(null!=this.listeners)for(var a=0;a<this.listeners.length;a++)this.listeners[a](i);this.lonFldId||(this.lonFldId="lonfld",this.latFldId="latfld",this.zoomFldId="zoomfld");let s=GuiUtils.getDomObject(this.lonFldId),r=GuiUtils.getDomObject(this.latFldId),o=GuiUtils.getDomObject(this.zoomFldId);r&&s&&(r.obj.value=MapUtils.formatLocationValue(i.lat),s.obj.value=MapUtils.formatLocationValue(i.lon)),o&&(o.obj.value=this.theMap.getMap().getZoom()),null!=this.clickListener&&this.clickListener.handleClick(this,e,i.lon,i.lat)}});var firstCustom=!0,markerMap={};function ramaddaFindFeature(e,t){for(var i=0;i<e.features.length;i++){var a=e.features[i],s=a.geometry;if(s&&(bounds=s.getBounds(),bounds.contains(t.x,t.y)))if(s.components){for(var r=0;r<s.components.length;r++)if(comp=s.components[r],bounds=comp.getBounds(),bounds.contains(t.x,t.y)&&comp.containsPoint&&comp.containsPoint(t))return{feature:a,index:i}}else{if(!s.containsPoint){console.log("unknown geometry:"+s.CLASS_NAME);continue}if(s.containsPoint(t))return{feature:a,index:i}}}return null}RepositoryMap.prototype={centerOnMarkers:function(e,t,i){debugBounds&&console.log("centerOnMarkers: force="+t+" dflt:"+e+" justMarkers:"+i),this.centerOnMarkersCalled=!0,this.centerOnMarkersForce=t;Date.now();let a=null;if(e&&(e.left<-180||e.left>180||e.right<-180||e.right>180||e.bottom<-90||e.bottom>90||e.top<-90||e.top>90)&&(e=MapUtils.createBounds(-180,-90,180,90)),this.dfltBounds=e,!t){let e=!1;if(this.externalLayers.forEach((t=>{var i=t.getDataExtent();debugBounds&&console.log("centerOnMarkers using external layer"),a=this.transformProjBounds(i),e=!0})),this.markers){var s=this.markers.getDataExtent();debugBounds&&console.log("centerOnMarkers using markers.getDataExtent"),a=this.transformProjBounds(s),e=!0}if(a&&isNaN(a.left)&&(a=null),this.circles){let t=this.circles.getDataExtent(),i=this.transformProjBounds(t);a?a.extend(i):a=i,e=!0,debugBounds&&console.log("centerOnMarkers using circles.getDataExtent:"+i)}if(a&&isNaN(a.left)&&(a=null),!a||!e||!i){if(this.lines){s=this.lines.getDataExtent();var r=this.transformProjBounds(s);a?a.extend(r):a=r,debugBounds&&console.log("centerOnMarkers using lines.getDataExtent")}for(var o in this.getMap().layers){if((o=this.getMap().layers[o]).getDataExtent)if(!o.isBaseLayer&&o.getVisibility())if(s=o.getDataExtent()){var l=this.transformProjBounds(s);a?a.extend(l):a=l,debugBounds&&console.log("centerOnMarkers using layer.getDataExtent: "+l+" layer="+o.name+" "+o.ramaddaId)}}}}if(a||(debugBounds&&console.log("centerOnMarkers using dfltBounds: "+e),a=e),a){if(!this.getMap())return this.defaultBounds=a,void(debugBounds&&console.log("centerOnMarkers: no map"));a.getHeight()>160&&(a.top=80,a.bottom=-80,debugBounds&&console.log("centerOnMarkers resetting height")),debugBounds&&console.log("calling setViewToBounds: "+a),this.setViewToBounds(a)}else debugBounds&&console.log("centerOnMarkers: no bounds")},setViewToBounds:function(e){let t=this.transformLLBounds(e);0==t.getWidth()?(debugBounds&&console.log("setViewToBounds center"),this.getMap().setCenter(t.getCenterLonLat())):(this.getMap().setCenter(t.getCenterLonLat()),this.zoomToExtent(t))},setCenter:function(e){debugBounds&&console.log("setCenter"),this.getMap().panTo(this.transformLLPoint(e))},getZoom:function(){return this.getMap().getZoom()},setZoom:function(e){debugBounds&&console.log("setZoom"),this.getMap().zoomTo(e)},zoomToMarkers:function(){this.markers&&(bounds=this.markers.getDataExtent(),null!=bounds&&(this.getMap().setCenter(bounds.getCenterLonLat()),this.zoomToExtent(bounds)))},zoomToExtent:function(e,t){debugBounds&&console.log("zoomToExtent:"+e),this.getMap().zoomToExtent(e,t)},centerToMarkers:function(){this.markers&&(bounds=this.markers.getDataExtent(),debugBounds&&console.log("centerToMarkers"),this.getMap().setCenter(bounds.getCenterLonLat()))},setInitialCenterAndZoom:function(e,t,i){this.defaultLocation=MapUtils.createLonLat(e,t),this.params.initialZoom=i},setInitialZoom:function(e){this.params.initialZoom=e},setInitialCenter:function(e,t){this.defaultLocation=MapUtils.createLonLat(e,t)},finishMapInit:function(){let e=this;if(this.params.showSearch){this.searchDiv=this.mapDivId+"_search";var t=HtmlUtils.checkbox(this.searchDiv+"_download",[],!1),i="<table width=100%><tr><td>"+('<input placeholder="Search - ? for help" id="'+this.searchDiv+'_input" size=40>')+' <span  id="'+this.searchDiv+'_message"></span></td><td align=right>'+t+" Download</td></tr></table>";$("#"+this.searchDiv).html(i),this.searchMsg=$("#"+this.searchDiv+"_message");var a=$("#"+this.searchDiv+"_input");a.keypress((function(t){13==t.which&&e.searchFor(a.val())}))}let s=e=>this.mapDivId+"_"+e,r=HU.open("table",[STYLE,HU.css("height","100%"),WIDTH,"100%","border","0"]),o=HtmlUtils.div([CLASS,"ramadda-map-inner","style","width:100%;height:100%;position:relative;","id",s("themap")]);r+=HU.tr([STYLE,HU.css("height","100%")],HU.td([WIDTH,"100%"],o)),r+="</table>",$("#"+this.mapDivId).html(o),$("#"+s("themap")).append(HtmlUtils.div(["id",s("progress"),CLASS,"ramadda-map-progess","style","z-index:3000;position:absolute;top:10px;left:50px;"],"")),$("#"+s("themap")).append(HtmlUtils.div(["id",s("label"),"style","z-index:1000;position:absolute;bottom:10px;left:10px;"],"")),$("#"+s("themap")).append(HtmlUtils.div(["id",s("toolbar"),"style","z-index:1000;position:absolute;top:10px;left:50%;    transform: translateX(-50%);"],"")),this.params.showBookmarks,this.map=new OpenLayers.Map(this.mapDivId+"_themap",this.mapOptions);setTimeout((function(){e.getMap().events.register("changebaselayer","",(function(){e.baseLayerChanged()})),e.getMap().events.register("zoomend","",(function(){e.zoomChanged(),e.locationChanged(),e.setNoPointerEvents()})),e.getMap().events.register("moveend","",(function(){e.locationChanged()})),e.getMap().events.register("move","",(function(){e.locationChanged()}))}),2e3),this.mapHidden&&(this.getMap().size=new OpenLayers.Size(1,1)),this.addBaseLayers();try{window.initExtraMap?initExtraMap(this):console.log("No initExtraMap")}catch(e){console.log("Error calling initExtraMap:"+e)}if(this.kmlLayer){var l=ramaddaBaseUrl+"/entry/show?output=shapefile.kml&entryid="+this.kmlLayer;this.addKMLLayer(this.kmlLayerName,l,!1,null,null,null,null)}if(this.geojsonLayer){l=getRamadda().getEntryDownloadUrl(this.geojsonLayer);this.addGeoJsonLayer(this.geojsonLayerName,l,!1,null,null,null,null)}if(Utils.addDisplay(this),this.params.showOpacitySlider){setTimeout((()=>{let t=HU.div([ID,this.mapDivId+"_filter_range",STYLE,HU.css("display","inline-block","width","200px")],"");$("#"+this.mapDivId+"_header").append("Image Opacity: "+t),$("#"+this.mapDivId+"_filter_range").slider({min:0,max:1,step:.05,value:e.params.imageOpacity,slide:function(t,i){e.params.imageOpacity=i.value,e.imageLayersList&&e.imageLayersList.forEach((t=>{t.setOpacity(e.params.imageOpacity)}))}})}),200)}},setProgress:function(e){$("#"+this.mapDivId+"_progress").html(e)},setLabel:function(e){$("#"+this.mapDivId+"_label").html(e)},getBounds:function(){return this.transformProjBounds(this.getMap().getExtent())},zoomChanged:function(){},receiveShareState:function(e,t){if(t.center){if(!this.params.linked)return;this.getMap().setCenter(t.center,t.zoom)}else if(t.mouse){if(!this.params.linkMouse)return;this.sharedMouse&&this.getMarkersLayer().removeFeatures([this.sharedMouse],{silent:!0}),this.sharedMouse=this.addPoint("mouse",t.mouse,{},"")}},locationChanged:function(){ramaddaMapShareState(this,{center:this.map.getCenter(),zoom:this.map.getZoom()}),this.pendingLocationChangeTimeout&&clearTimeout(this.pendingLocationChangeTimeout),this.pendingLocationChangeTimeout=setTimeout((()=>{this.locationChangedInner(),this.pendingResizeTimeout=null}),500)},locationChangedInner:function(){let e=this.getBounds(),t=1e5,i=e=>Math.round(e*t)/t;e.top=i(e.top),e.left=i(e.left),e.bottom=i(e.bottom),e.right=i(e.right),HU.addToDocumentUrl("map_bounds",e.top+","+e.left+","+e.bottom+","+e.right),HU.addToDocumentUrl("zoomLevel",this.getMap().getZoom());let a=this.transformProjPoint(this.getMap().getCenter());HU.addToDocumentUrl("mapCenter",i(a.lat)+","+i(a.lon))},baseLayerChanged:function(){let e=this.getMap().baseLayer;e&&(e=e.ramaddaId,HU.addToDocumentUrl("defaultMapLayer",e),ramaddaMapShareState(this,"baseLayer"))},appendToolbar:function(e){$("#"+this.mapDivId+"_toolbar").append(e)},setMapDiv:function(e){this.mapHidden=!1,this.mapDivId=e,this.getMap().render(this.mapDivId),this.getMap().updateSize(),this.centerOnMarkers(this.dfltBounds)},makePopup:function(e,t){let i=new OpenLayers.Size(this.params.popupWidth||200,this.params.popupHeight||200);return new OpenLayers.Popup("popup",e,i,t,!0,(()=>{this.onPopupClose()}))},highlightMarkers:function(e,t,i,a){let s=this;t||(t="#ffffcc"),$(e).mouseenter((function(){t&&$(this).css("background",t),$(this).data("mapid")&&(s.circleMarker($(this).data("mapid"),MapUtils.circleHiliteAttrs)||null!=a&&(Utils.isDefined($(this).data("latitude"))?(attrs={pointRadius:12,stroke:!0,strokeColor:"blue",strokeWidth:2,fill:!1},point=s.addPoint(a,new OpenLayers.LonLat($(this).data("longitude"),$(this).data("latitude")),attrs),markerMap[a]=point):console.log("no lat")))})),$(e).mouseleave((function(){i?$(this).css("background",i):$(this).css("background","transparent"),$(this).data("mapid")&&(a&&markerMap[a]&&(s.removePoint(markerMap[a]),markerMap[a]=null),s.uncircleMarker($(this).data("mapid")))}))},getLayerHighlightStyle:function(e){let t=$.extend({},this.highlightStyle);return e.highlightStyle&&$.extend(t,e.highlightStyle),t},handleFeatureover:function(e,t){if(this.doMouseOver||e.highlightText||e.highlightTextGetter){var i=e.location;if(i&&this.highlightFeature!=e){this.closeHighlightPopup();var a=this.transformLLPoint(i);let t=e.highlightTextGetter?e.highlightTextGetter(e):e.highlightText;Utils.stringDefined(t)||(t=e.text),Utils.stringDefined(t)&&(t=HtmlUtils.div(["style","padding:2px;"],t),this.highlightPopup=new OpenLayers.Popup("popup",a,e.highlightSize,t,!1),this.highlightPopup.backgroundColor=this.highlightBackgroundColor||"#ffffcc",this.highlightPopup.autoSize=!0,this.highlightPopup.keepInMap=!0,this.highlightPopup.padding=0,this.getMap().addPopup(this.highlightPopup))}}var s=e.layer;if(!0===s.isMapLayer){if(!1!==s.canSelect&&!s.noHighlight){var r=this;if(!e.isSelected){e.originalStyle=e.style,e.style=null;let i=this.getLayerHighlightStyle(s);if("transparent"!=i.fillColor&&e.originalStyle&&(i.fillColor=Utils.brighterColor(e.originalStyle.fillColor||i.fillColor,.4)),i.fillColor||(i.fillColor="blue"),Utils.isDefined(i.fillOpacity)||(i.fillOpacity=.3),s.drawFeature(e,i),this.params.displayDiv){this.displayedFeature=e;t||setTimeout((function(){if(r.displayedFeature==e){let t=r.getFeatureText(s,e);r.showText(t),r.dateFeatureOver(e)}}),500)}}}}else!t&&e.text&&this.showFeatureText(e)},closeHighlightPopup:function(){this.highlightPopup&&(this.getMap().removePopup(this.highlightPopup),this.highlightPopup.destroy(),this.highlightPopup=null,this.highlightFeature=null)},handleFeatureout:function(e,t){this.closeHighlightPopup();let i=e.layer;i&&!0!==i.isMapLayer?t||e.text&&!this.fixedText&&this.hideFeatureText(e):null!=i&&!1!==i.canSelect&&(e.style=e.originalStyle,e.isSelected||i.drawFeature(e,e.style||"default"),this.dateFeatureOut(e),t||this.displayedFeature!=e||this.fixedText||this.params.displayDivSticky||this.showText(""))},getLayerCanSelect:function(e){return!!e&&e.canSelect},handleNofeatureclick:function(e){!1!==e.canSelect&&e&&e.selectedFeature&&(this.unselectFeature(e.selectedFeature),this.clearDateFeature())},handleFeatureclick:function(e,t,i,a){if(e||(e=t.layer),this.dateFeatureSelect(t),!1===e.canSelect)return;if(e.selectedFeature&&this.unselectFeature(e.selectedFeature),!this.params.doSelect)return;this.selectedFeature=t,e.selectedFeature=t,e.selectedFeature.isSelected=!0;let s=$.extend({},t.style),r=this.getLayerHighlightStyle(e);if($.extend(s,{strokeColor:this.params.selectStrokeColor||r.strokeColor,strokeWidth:this.params.selectStrokeWidth||r.strokeWidth,strokeOpacity:this.params.selectStrokeOpacity||.75,fillOpacity:this.params.selectFillOpacity||r.fillOpacity,fill:!0}),"transparent"!=s.fillColor&&(s.fillColor=this.params.selectFillColor||r.fillColor),Utils.isDefined(s.pointRadius)&&(s.pointRadius=Math.round(1.5*s.pointRadius)),t.style&&t.style.externalGraphic&&(s=$.extend({},t.style),Utils.isDefined(s.graphicHeight)&&(s.graphicHeight*=1.5,s.graphicYOffset=-s.graphicHeight/2),Utils.isDefined(s.graphicWidth)&&(s.graphicWidth*=1.5,s.graphicXOffset=-s.graphicWidth/2)),e.drawFeature(e.selectedFeature,s),e.selectCallback?(e.feature=e.selectedFeature,t.originalStyle&&(t.style=t.originalStyle),e.selectCallback(e,a)):this.showMarkerPopup(t,!0),i){var o=t.geometry;if(o){var l=o.getBounds();l&&(this.zoomToExtent(l),this.getMap().setCenter(l.getCenterLonLat()))}}},unselectFeature:function(e){if(!e)return;e.renderIntent=null,e.isSelected=!1;let t=e.layer;t&&(t.drawFeature(t.selectedFeature,t.selectedFeature.style||"default"),t.selectedFeature.isSelected=!1,t.selectedFeature=null,this.selectedFeature=null,this.onPopupClose())},handleEntrySelect:function(e,t,i){if("geo_kml"!=i&&"geo_json"!=i&&"geo_shapefile"!=i)return null;var a;if("geo_kml"==i){var s=ramaddaBaseUrl+"/entry/get?entryid="+e;a=this.addKMLLayer(t,s,!0,null,null,null,null,!0)}else if("geo_json"==i){s=ramaddaBaseUrl+"/entry/get?entryid="+e;a=this.addGeoJsonLayer(t,s,!0,null,null,null,null,!0)}else{s=ramaddaBaseUrl+"/entry/show?output=shapefile.kml&entryid="+e;a=this.addKMLLayer(t,s,!0,null,null,null,null,!0)}return a},findLayer:function(e){for(var t=0;t<this.getMap().layers.length;t++)if(this.getMap().layers[t].ramaddaId==e)return this.getMap().layers[t];return null},addLayer:function(e,t){this.allLayers.push(e),e.initialVisibility=e.getVisibility(),null!=this.map?(this.getMap().addLayer(e),t&&this.nonSelectLayers.push(e),this.checkLayerOrder()):this.initialLayers.push(e)},checkLayerOrder:function(){let e=this.numberOfBaseLayers;this.nonSelectLayers.every((t=>(this.getMap().setLayerIndex(t,e++),!0))),this.loadedLayers.every((t=>(this.getMap().setLayerIndex(t,e++),!0))),this.externalLayers.forEach((t=>{t.ramaddaLayerIndex?this.getMap().setLayerIndex(t,t.ramaddaLayerIndex):this.getMap().setLayerIndex(t,e++)})),this.boxes&&this.getMap().setLayerIndex(this.boxes,e++),this.lines&&this.getMap().setLayerIndex(this.lines,e++),this.circles&&this.getMap().setLayerIndex(this.circles,e++),this.markers&&this.getMap().setLayerIndex(this.markers,e++),this.labelLayer&&this.getMap().setLayerIndex(this.labelLayer,e++)},addImageLayer:function(e,t,i,a,s,r,o,l,n,h,d,u){var p={forSelect:!1,addBox:!0,isBaseLayer:!1};u&&OpenLayers.Util.extend(p,u),r>88&&(r=88),l<-88&&(l=-88);var c=MapUtils.createBounds(o,l,n,r),m=this.transformLLBounds(c),f=new OpenLayers.Layer.Image(t,a,m,new OpenLayers.Size(h,d),{numZoomLevels:3,isBaseLayer:p.isBaseLayer,resolutions:this.getMap().layers[0]?this.getMap().layers[0].resolutions:null,maxResolution:this.getMap().layers[0]?this.getMap().layers[0].resolutions[0]:null});f.id=e,f.latLonBounds=c,p.forSelect&&(this.selectImage=f);var g=new MapUtils.createLonLat(o,r);return f.lonlat=this.transformLLPoint(g),f.setVisibility(s),f.id=e,f.text=this.getPopupText(i),f.ramaddaId=e,f.ramaddaName=t,this.addLayer(f,!0),f.north=r,f.west=o,f.south=l,f.east=n,f.opacity=this.params.imageOpacity,this.imageLayers||(this.imageLayers={}),p.isBaseLayer||(this.imageLayers[e]=f,this.imageLayersList.push(f)),this.noPointerEventsLayers||(this.noPointerEventsLayers=[]),this.noPointerEventsLayers.push(f),this.setNoPointerEvents(),f},setNoPointerEvents:function(){this.noPointerEventsLayers&&setTimeout((()=>{this.noPointerEventsLayers.forEach((e=>{if(e.div)for(var t=e.div.childNodes,i=0,a=t.length;i<a;++i){var s=t[i].firstChild||t[i],r=t[i].lastChild;r&&"iframe"===r.nodeName.toLowerCase()&&(s=r.parentNode),s.style["pointer-events"]="none"}}))}),1e3)},addWMSLayer:function(e,t,i,a,s,r){r||(r={});let o={wrapDateLine:MapUtils.defaults.wrapDateline};r.opacity&&(o.opacity=r.opacity);i=new OpenLayers.Layer.WMS(e,t,{layers:i,format:"image/png",isBaseLayer:!1,srs:"epse:4326",transparent:!0},o);return a?(i.isBaseLayer=!0,i.visibility=!1):(i.isBaseLayer=!1,i.visibility=!0),this.addLayer(i,s),i},addMapLayer:function(e,t,i,a,s){(i=/\/tile\//.exec(t)?new OpenLayers.Layer.XYZ(e,t,{sphericalMercator:MapUtils.defaults.doSphericalMercator,numZoomLevels:MapUtils.defaults.zoomLevels,wrapDateLine:MapUtils.defaults.wrapDateline}):new OpenLayers.Layer.WMS(e,t,{layers:i,format:"image/png"},{wrapDateLine:MapUtils.defaults.wrapDateline})).isBaseLayer=!!a,i.visibility=!1,i.reproject=!0,this.addLayer(i),s&&(this.haveAddedDefaultLayer=!0,this.getMap().setLayerIndex(i,0),this.getMap().setBaseLayer(i))},getVectorLayerStyleMap:function(e,t){var i={pointRadius:this.params.pointRadius,fillOpacity:this.params.fillOpacity,fillColor:this.params.fillColor,fill:this.params.fill,strokeColor:this.params.strokeColor,strokeWidth:this.params.strokeWidth,select_fillOpacity:this.params.fillOpacity,select_fillColor:"#666",select_strokeColor:"#666",select_strokeWidth:1};t&&RamaddaUtil.inherit(i,t);var a=OpenLayers.Util.extend({},OpenLayers.Feature.Vector.style.temporary);$.extend(a,{pointRadius:i.pointRadius,fillOpacity:i.fillOpacity,strokeWidth:i.strokeWidth,strokeColor:i.strokeColor});var s=OpenLayers.Util.extend({},OpenLayers.Feature.Vector.style.select);$.extend(s,{pointRadius:3,fillOpacity:i.select_fillOpacity,fillColor:i.select_fillColor,strokeColor:i.select_strokeColor,strokeWidth:i.select_strokeWidth});var r=OpenLayers.Util.extend({},OpenLayers.Feature.Vector.style.default);return $.extend(r,{pointRadius:i.pointRadius,fillOpacity:i.fillOpacity,fillColor:i.fillColor,fill:i.fill,strokeColor:i.strokeColor,strokeWidth:i.strokeWidth}),new OpenLayers.StyleMap({temporary:a,default:r,select:s})},getFeatureName:function(e){var t=e.attributes;for(var i in t){if((""+i).toLowerCase().includes("label"))if(a=this.getAttrValue(t,i))return a}for(var i in t){var a;if((""+i).toLowerCase().includes("name"))if(a=this.getAttrValue(t,i))return a}},getAttrValue:function(e,t){let i="";if("object"==typeof e[t]||"Object"==typeof e[t]){let a=e[t];a&&(i=""+a.value)}else i=""+e[t];return i},searchFor:function(e){e&&(e=e.trim()),""==e&&(e=null),this.searchText=e;let t=null,i=!1,a=$("#"+this.searchDiv+"_download").is(":checked"),s=[],r=!0;if(e){"?"==(e=e.trim())&&(i=!0),t=[];let a=(e=e.toLowerCase()).split("|");1==a.length&&(a=e.split("&"),r=1==a.length);for(let e=0;e<a.length;e++){let i=!1,s=!1,r=a[e],o=r.split(":"),l="",n=r;o.length>1&&(l=o[0],n=o[1]),n.startsWith("!")&&(i=!0,n=n.substring(1)),n.startsWith("=")&&(n=n.substring(1),s=!0),t.push({field:l,value:n,not:i,equals:s})}}else this.searchMsg.html("");for(let o in this.loadedLayers){let l=this.loadedLayers[o];l.selectedFeature&&this.handleNofeatureclick(l);for(let a in l.features){let o=l.features[a],n=o.attributes;if(!e){o.featureVisibleSearch=!0,s.push(n);continue}if(i){let e="&nbsp;&nbsp;&nbsp;",t="Enter, e.g.:<br>";t+=e+"<i>&lt;term&gt;</i> (any match)<br>",t+=e+"<i>=&lt;term&gt;</i> (exact match)<br>",t+=e+"<i>!&lt;term&gt;</i> (not match)<br>",t+=e+"<i>&lt;term 1&gt;|&lt;term 2&gt;</i> (match any)<br>",t+=e+"<i>&lt;term 1&gt;&amp;&lt;term 2&gt;</i> (match all)<br>",t+="Or by field:<br>";for(let i in n)t+=e+i.toLowerCase()+":<i>&lt;term&gt;</i><br>";return void this.showText(t)}let h=!1,d=!0,u=!1;for(let e in t){let i=t[e];for(let e in n){if(""!=i.field&&i.field!=e.toLowerCase())continue;let t=this.getAttrValue(n,e);if(t=t.toLowerCase().trim(),h=i.equals?t==i.value:t.includes(i.value),i.not){if(h=!h,!h)break}else if(h)break}h&&(u=!0),h||(d=!1)}r&&u||!r&&d?(o.featureVisibleSearch=!0,this.getFeatureVisible(o)&&s.push(n)):o.featureVisibleSearch=!1}if(this.centerOnMarkers(),a){let e="";for(let t in s){let i=s[t];for(let t in i)""!=e&&(e+=","),e+=t.toLowerCase();e+="\n";break}for(let t in s){let i=s[t],a="";for(let e in i){let t=this.getAttrValue(i,e);t.includes(",")&&(t='"'+t+'"'),""!=a&&(a+=","),a+=t}a+="\n",e+=a}Utils.makeDownloadFile("download.csv",e)}this.setFeatureVisibility(l)}},checkFeatureVisible:function(e,t,i){let a=e.layer,s=this.getFeatureVisible(e);e.originalStyle&&(e.style=e.originalStyle);let r=e.style;if(!r){r={};let t=a?a.styleMap.styles.default.defaultStyle:{};$.extend(r,t),e.style=r}return r.display=s?"inline":"none",t&&(e.isSelected||(e.renderIntent=null),a&&a.drawFeature(e,e.style||"default")),s},getFeatureVisible:function(e){let t=!0;return Utils.isDefined(e.featureVisibleSearch)&&!e.featureVisibleSearch&&(t=!1),Utils.isDefined(e.featureVisibleDate)&&!e.featureVisibleDate&&(t=!1),Utils.isDefined(e.featureVisible)&&!e.featureVisible&&(t=!1),t},setFeatureVisibility:function(e){let t=this,i=this.searchText||this.startDate&&this.endDate,a=null,s="",r=!1,o=!1,l=0,n=null;for(let t=0;t<e.features.length;t++){let i=e.features[t];if(this.checkFeatureVisible(i,!1)){this.dateFeatureSelect(i),r=!0,l++,n||(n=i),s+=HtmlUtils.div(["class","ramadda-map-feature","feature-index",""+t],this.getFeatureName(i));let e=i.geometry;if(e){let t=e.getBounds();a?a.extend(t):a=t}}else this.clearDateFeature(i),o=!0}if(1==l)this.showText(this.getFeatureText(e,n));else if(i||r&&o){let i=this.mapDivId+"_features";this.showText(HtmlUtils.div(["id",i,"class","ramadda-map-features"],s)),$("#"+i+" .ramadda-map-feature").click((function(i){let a=parseInt($(this).attr("feature-index"));t.handleFeatureclick(e,e.features[a],!0)})),$("#"+i+" .ramadda-map-feature").mouseover((function(){let i=parseInt($(this).attr("feature-index"));t.handleFeatureover(e.features[i],!0)})),$("#"+i+" .ramadda-map-feature").mouseout((function(){let i=parseInt($(this).attr("feature-index"));t.handleFeatureout(e.features[i],!0)}))}else this.clearDateFeature(),this.params.displayDivSticky||this.showText("");this.searchMsg&&(i?this.searchMsg.html(l+" matched"):this.searchMsg.html("")),e.redraw(),a?(this.zoomToExtent(a),this.getMap().setCenter(a.getCenterLonLat())):this.centerOnMarkers(this.dfltBounds,this.centerOnMarkersForce)},getFeatureText:function(e,t){if(t.textGetter)return t.textGetter(t);if(this.textGetter)return this.textGetter(e,t);let i=t.style||t.originalStyle||e.style,a=t.attributes,s=t.popupText;if(!s)if(i&&i.balloonStyle){s=i.balloonStyle;for(let e in a){e.replace("_"," ");let t="";if("object"==typeof a[e]||"Object"==typeof a[e]){t=""+a[e].value}else t=""+a[e];s=s.replace("${"+i.id+"/"+e+"}",t)}}else{s="<table>";for(let e in a){let t,i=e;if(lclabel=i.toLowerCase(),"objectid"!=lclabel&&"feature_type"!=lclabel&&"shapearea"!=lclabel&&"styleurl"!=lclabel&&"shapelen"!=lclabel){if("startdate"==lclabel?i="Start Date":"enddate"==lclabel?i="End Date":"aland"==lclabel?i="Land Area":"awater"==lclabel&&(i="Water Area"),i=i.replace(/_/g," "),i=Utils.camelCase(i),s+='<tr valign=top><td align=right><div style="margin-right:5px;margin-bottom:3px;"><b>'+i+':</b></div></td><td><div style="margin-right:5px;margin-bottom:3px;">',null==a[e]||"object"!=typeof a[e]&&"Object"!=typeof a[e])t=""+a[e];else{t=""+a[e].value}(t.startsWith("http:")||t.startsWith("https:"))&&(t="<a href='"+t+"'>"+t+"</a>"),"null"!=t&&(s+=t,s+="</div></td></tr>")}}s+="</table>"}return s},onFeatureSelect:function(e,t){if(this.onSelect)return func=window[this.onSelect],void func(this,e);let i=e.feature;if(this.featureSelectHandler&&this.featureSelectHandler(i))return;if(!this.params.doPopup)return;let a=this.getFeatureText(e,i);if(!a)return;this.currentPopup&&(this.getMap().removePopup(this.currentPopup),this.currentPopup.destroy());let s=null;t&&t.event&&t.event.xy&&(s=this.getMap().getLonLatFromPixel(t.event.xy)),null==s&&(s=i.geometry.getBounds().getCenterLonLat());let r=this.makePopup(s,a);i.popup=r,r.feature=i,this.getMap().addPopup(r),this.currentPopup=r},onFeatureUnselect:function(e){this.onPopupClose()},removeKMLLayer:function(e){this.removeLayer(e)},removeLayer:function(e){this.externalLayers=OpenLayers.Util.removeItem(this.externalLayers,e),this.allLayers=OpenLayers.Util.removeItem(this.allLayers,e),this.nonSelectLayers&&(this.nonSelectLayers=OpenLayers.Util.removeItem(this.nonSelectLayers,e)),this.loadedLayers&&(this.loadedLayers=OpenLayers.Util.removeItem(this.loadedLayers,e)),this.imageLayersList&&(this.imageLayersList=OpenLayers.Util.removeItem(this.imageLayersList,e)),this.getMap().removeLayer(e)},setDefaultCanSelect:function(e){this.defaultCanSelect=e},getCanSelect:function(e){return void 0===e||null==e?this.defaultCanSelect:e},addSelectCallback:function(e,t,i,a){let s=this;this.getCanSelect(t)&&(null!=i&&Utils.isDefined(i)||(i=function(e,t){s.onFeatureSelect(e,t)}),null!=a&&Utils.isDefined(a)||(a=function(e,t){s.onFeatureUnselect(e,t)}),e.selectCallback=i,e.unselectCallback=i)},initDates:function(e){let t=this,i=e.features,a=!1,s=!1;this.hasDates=!1,this.dates=[],this.dateFeatures=[],this.minDate=null,this.maxDate=null;for(let e=0;e<i.length;e++){let t=i[e],r=t.attributes;for(let e in r){let i=(""+e).toLowerCase(),o=i.includes("year")||i.includes("_yr");if(!i.includes("date")&&!o)continue;let l=this.getAttrValue(r,e);if(l&&"0"!=l)try{let e=Utils.parseDate(l);if(e&&isNaN(e.getTime()))continue;if(o?s=!0:a=!0,null!=this.startDate&&null!=this.endDate&&(e.getTime()<this.startDate.getTime()||e.getTime()>this.endDate.getTime()))continue;this.dates.push(e),this.dateFeatures.push(t),this.minDate=null==this.minDate||this.minDate.getTime()>e.getTime()?e:this.minDate,this.maxDate=null==this.maxDate||this.maxDate.getTime()<e.getTime()?e:this.maxDate,t.featureDate=e,this.hasDates=!0;break}catch(e){console.log("error:"+e)}}}if(this.hasDates&&this.params.showDates){let i=null;s&&(i={year:"numeric"}),$("#"+this.mapDivId+"_footer").html(HtmlUtils.div(["class","ramadda-map-animation","id",this.mapDivId+"_animation"],"")),this.animation=$("#"+this.mapDivId+"_animation");let a=HtmlUtils.div(["class","ramadda-map-animation-ticks","id",this.mapDivId+"_animation_ticks"],""),r=HtmlUtils.div(["class","ramadda-map-animation-info","id",this.mapDivId+"_animation_info"],"");this.animation.html(a+r);let o=Utils.formatDate(this.minDate,i),l=Utils.formatDate(this.maxDate,i);this.animationTicks=$("#"+this.mapDivId+"_animation_ticks"),this.animationInfo=$("#"+this.mapDivId+"_animation_info");let n="";this.startDate&&this.endDate&&(n=HtmlUtils.div(["id",this.mapDivId+"_ticks_reset","class","ramadda-map-animation-tick-reset"],"Reset"));let h="<table width=100%><tr valign=top><td width=40%>"+o+"</td><td align=center width=20%>"+n+"</td><td align=right width=40%>"+l+"</td></tr></table>";if(this.animationInfo.html(h),this.startDate&&this.endDate){$("#"+this.mapDivId+"_ticks_reset").click((function(){t.startDate=null,t.endDate=null,t.startFeature=null,t.endFeature=null,t.setFeatureDateRange(e,"Resetting range...")}))}let d=this.animationTicks.width(),u=d>0?5/d:0,p="",c=this.minDate.getTime(),m=this.maxDate.getTime();null!=this.startDate&&null!=this.endDate&&(c=this.startDate.getTime(),m=this.endDate.getTime());let f=m-c;if(f>0)for(let e=0;e<this.dates.length;e++){let t=this.dates[e],a=t.getTime();if(a<c||a>m)continue;let s=this.dateFeatures[e];s.dateIndex=e;let r=100*(a-c)/f;r-=r*u,i||(i={});let o=t.toLocaleDateString("en-US",i),l=Utils.camelCase(this.getFeatureName(s)),n="";n+=null!=l?l+"<br>":"",n+=o,n+="<br>shift-click: set visible range<br>cmd/ctrl-click:zoom",n+="",p+=HtmlUtils.div(["id",this.mapDivId+"_tick"+e,"feature-index",""+e,"style","left:"+r+"%","class","ramadda-map-animation-tick","title",n],"")}this.animationTicks.html(p);let g=$("#"+this.mapDivId+"_animation .ramadda-map-animation-tick");g.tooltip({content:function(){return $(this).prop("title")},position:{my:"left top",at:"left bottom+2"},classes:{"ui-tooltip":"ramadda-popup"}}),g.mouseover((function(){let e=parseInt($(this).attr("feature-index")),i=t.dateFeatures[e];t.handleFeatureover(i,!0)})),g.mouseout((function(){let e=parseInt($(this).attr("feature-index")),i=t.dateFeatures[e];t.handleFeatureout(i,!0)})),g.click((function(e){let i=parseInt($(this).attr("feature-index")),a=t.dateFeatures[i];if(e.shiftKey){if(null==t.startDate?(t.startDate=a.featureDate,t.startFeature=a,t.dateFeatureSelect(a)):null==t.endDate?(t.endDate=a.featureDate,t.endFeature=a,t.dateFeatureSelect(a)):(t.dateFeatureSelect(null),t.startDate=a.featureDate,t.startFeature=a,t.endDate=null,t.endFeature=null,t.dateFeatureSelect(a)),null!=t.startDate&&null!=t.endDate){if(t.startDate.getTime()==t.endDate.getTime())return t.startDate=null,t.startFeature=null,t.endDate=null,t.endFeature=null,void t.dateFeatureSelect(null);if(t.startDate.getTime()>t.endDate.getTime()){let e=t.startDate;t.startDate=t.endDate,t.endDate=e,e=t.startFeature,t.startFeature=t.endFeature,t.endFeature=e}t.setFeatureDateRange(a.layer)}}else{let i=e.metaKey||e.ctrlKey;null==t.startDate&&null==t.endDate||(t.startDate=null,t.endDate=null),t.clearDateFeature(),t.handleFeatureclick(a.layer,a,i)}}))}},setFeatureDateRange:function(e,t){this.dateFeatureSelect(null),t||(t="Setting range..."),this.animationTicks.html(t),setTimeout((()=>this.setFeatureDateRangeInner(e)),100)},setFeatureDateRangeInner:function(e){let t=e.features;e.selectedFeature&&this.unselectFeature(e.selectedFeature);for(let e=0;e<t.length;e++){let i=t[e];this.startDate&&this.endDate&&i.featureDate?i.featureVisibleDate=this.startDate.getTime()<=i.featureDate.getTime()&&i.featureDate.getTime()<=this.endDate.getTime():i.featureVisibleDate=!0}this.setFeatureVisibility(e),this.initDates(e)},dateFeatureSelect:function(e){let t=this.getFeatureTick(e);t.css("background-color",this.params.tickSelectColor),t.css("zIndex","100")},dateFeatureOver:function(e){let t=this.getFeatureTick(e);t.css("background-color",this.params.tickHoverColor),t.css("zIndex","100"),this.tickOpen&&this.tickOpen.tooltip("close"),this.tickOpen=t,t.tooltip("open")},dateFeatureOut:function(e){let t=this.getFeatureTick(e);!e||e!=this.startFeature&&e!=this.endFeature?(t.css("background-color",""),t.css("zIndex","0")):(t.css("background-color",this.params.tickSelectColor),t.css("zIndex","0")),this.tickOpen=null,t.tooltip("close")},getFeatureTick:function(e){return e?$("#"+this.mapDivId+"_tick"+e.dateIndex):$("#"+this.mapDivId+"_animation_ticks .ramadda-map-animation-tick")},clearDateFeature:function(e){let t=null!=e?$("#"+this.mapDivId+"_tick"+e.dateIndex):$("#"+this.mapDivId+"_animation_ticks .ramadda-map-animation-tick");t.css("background-color",""),t.css("zIndex","0")},initMapVectorLayer:function(e,t,i,a,s,r){let o=this;this.showLoadingImage(),e.isMapLayer=!0,e.canSelect=t,this.loadedLayers.push(e),e.events.on({loadend:function(t){if(o.hideLoadingImage(),t.response&&Utils.isDefined(t.response.code)&&t.response.code==OpenLayers.Protocol.Response.FAILURE)console.log("An error occurred loading the map:"+JSON.stringify(t.response,null,2));else{if(r){let t=e.getDataExtent();t&&o.zoomToExtent(t,!0)}else o.centerOnMarkersCalled&&(o.dfltBounds||o.centerOnMarkers(o.dfltBounds,o.centerOnMarkersForce));s&&s(o,e),1==e.features.length&&o.params.displayDiv&&(o.fixedText=!0,o.showText(o.getFeatureText(e,e.features[0]))),o.initDates(e)}}}),this.addLayer(e),this.addSelectCallback(e,t,i,a)},getLayerProperty:function(e,t,i,a,s){let r=Utils.makeId(a);return this.getProperty(t+"_"+r,this.getProperty(t+i,this.getProperty(t,s)))},addMapFileLayer:function(e,t,i,s,r,o,l,n){let h=this.loadedLayers.length+1,d={strokeColor:this.getLayerProperty(e,"layerStrokeColor",h,t,"blue"),strokeWidth:this.getLayerProperty(e,"layerStrokeWidth",h,t,1),fillColor:this.getLayerProperty(e,"layerFillColor",h,t,"#ccc"),fillOpacity:this.getLayerProperty(e,"layerFillOpacity",h,t,.4)},u={};for(a in $.extend(u,this.highlightStyle),u){let i=String(a);i="highlight"+i.substring(0,1).toUpperCase()+i.substring(1),u[a]=this.getLayerProperty(e,i,h,t,u[a])}return e.highlightStyle=u,this.getLayerProperty(e,"noHighlight",h,t,!1)&&(e.noHighlight=!0),o=o||{},$.extend(d,o),e.styleMap=this.getVectorLayerStyleMap(e,d),this.checkLayerToggle(t,e,h,d),this.initMapVectorLayer(e,i,s,r,l,n),e},addGeoJsonLayer:function(e,t,i,a,s,r,o,l){let n=new OpenLayers.Layer.Vector(e,{projection:this.displayProjection,strategies:[new OpenLayers.Strategy.Fixed],protocol:new OpenLayers.Protocol.HTTP({url:t,format:new OpenLayers.Format.GeoJSON({})})});return this.addMapFileLayer(n,e,i,a,s,r,o,l),n},addKMLLayer:function(e,t,i,a,s,r,o,l){let n=new OpenLayers.Layer.Vector(e,{projection:this.displayProjection,strategies:[new OpenLayers.Strategy.Fixed],protocol:new OpenLayers.Protocol.HTTP({url:t,format:new OpenLayers.Format.KML({extractStyles:!0,extractAttributes:!0,maxDepth:2})})});return this.addMapFileLayer(n,e,i,a,s,r,o,l),n},checkLayerToggle:function(e,t,i,a){let s=this.getLayerProperty(t,"layerVisible",i,e,!0);if(s||t.setVisibility(!1),this.params.showLayerToggle){let r=Utils.addAlphaToColor(a.fillColor,.4),o=HU.span([],HtmlUtils.checkbox(this.mapDivId+"_layertoggle"+i,["title","Toggle Layer"],s,e))+" ";o=HU.span([STYLE,HU.css("margin-right","5px","padding","5px","background",r)],o),$("#"+this.mapDivId+"_header").append(" "+o),$("#"+this.mapDivId+"_layertoggle"+i).change((function(){$(this).is(":checked")?t.setVisibility(!0):t.setVisibility(!1)}))}},createXYZLayer:function(e,t,i,a){let s={sphericalMercator:MapUtils.defaults.doSphericalMercator,numZoomLevels:MapUtils.defaults.zoomLevels,wrapDateLine:MapUtils.defaults.wrapDateline,isBaseLayer:!a,visibility:!1};return i&&(s.attribution=i),new OpenLayers.Layer.XYZ(e,t,s)},addBaseLayers:function(){this.mapLayers||(this.mapLayers=[map_osm,map_esri_topo,map_esri_street,map_esri_shaded,map_esri_lightgray,map_esri_darkgray,map_esri_physical,map_esri_terrain,map_esri_aeronautical,map_opentopo,map_forestservice,map_usgs_topo,map_usgs_imagery,map_naip,map_publiclands,map_shaded_relief,map_historic,map_osm_toner,map_osm_toner_lite,map_watercolor,map_white,map_lightblue,map_gray,map_blue,map_black]);let e=this.params.defaultMapLayer||map_osm;if(!this.haveAddedDefaultLayer&&e){let t=this.mapLayers.indexOf(e);t>=0&&(this.mapLayers.splice(t,1),this.mapLayers.splice(0,0,e))}this.firstLayer=null,this.hybridLayer=null,this.defaultOLMapLayer=null,this.baseLayers={},this.numberOfBaseLayers=0;let t="";for(let e=0;e<this.mapLayers.length;e++){let i=this.mapLayers[e];if(null==i)continue;let a=null;if(i==map_osm){let e=["//a.tile.openstreetmap.org/${z}/${x}/${y}.png","//b.tile.openstreetmap.org/${z}/${x}/${y}.png","//c.tile.openstreetmap.org/${z}/${x}/${y}.png"];a=new OpenLayers.Layer.OSM("Open Street Map",e,{numZoomLevels:MapUtils.defaults.zoomLevels})}else if(i==map_osm_toner){let e=["http://a.tile.stamen.com/toner/${z}/${x}/${y}.png"];a=new OpenLayers.Layer.OSM("OSM-Toner",e,{numZoomLevels:MapUtils.defaults.zoomLevels})}else if(i==map_osm_toner_lite){let e=["http://a.tile.stamen.com/toner-lite/${z}/${x}/${y}.png"];a=new OpenLayers.Layer.OSM("OSM-Toner Lite",e,{numZoomLevels:MapUtils.defaults.zoomLevels})}else if(i==map_watercolor){let e=["http://c.tile.stamen.com/watercolor/${z}/${x}/${y}.jpg"];a=new OpenLayers.Layer.OSM("Watercolor",e,{numZoomLevels:MapUtils.defaults.zoomLevels})}else if(i==map_opentopo)a=this.createXYZLayer("OpenTopo","//a.tile.opentopomap.org/${z}/${x}/${y}.png}");else if(i==map_forestservice)a=this.createXYZLayer("Forest Service","https://caltopo.com/tile/f16a/${z}/${x}/${y}.png","Map from Caltopo");else if(i==map_naip)a=this.createXYZLayer("NAIP Imagery","https://caltopo.com/tile/n/${z}/${x}/${y}.png","Map from Caltopo");else{if(i==map_publiclands){this.addLayer(this.createXYZLayer("Public Lands","https://caltopo.com/tile/sma/${z}/${x}/${y}.png","Map from Caltopo",!0));continue}if(i==map_shaded_relief)a=this.createXYZLayer("Shaded Relief","https://caltopo.com/tile/hs_m315z45s3/${z}/${x}/${y}.png","Map from Caltopo");else if(i==map_historic)a=this.createXYZLayer("Historic","https://caltopo.com/tile/1900/${z}/${x}/${y}.png","Map from Caltopo",!0);else{if(i==map_white||i==map_lightblue||i==map_gray||i==map_blue||i==map_black||i==map_gray){this.makeSimpleWms(i);continue}if(i==map_usgs_topo)a=this.createXYZLayer("USGS Topo","https://basemap.nationalmap.gov/ArcGIS/rest/services/USGSTopo/MapServer/tile/${z}/${y}/${x}","USGS - The National Map");else if(i==map_usgs_imagery)a=this.createXYZLayer("USGS Imagery","https://basemap.nationalmap.gov/ArcGIS/rest/services/USGSImageryOnly/MapServer/tile/${z}/${y}/${x}","USGS - The National Map");else if(i==map_usgs_relief)a=this.createXYZLayer("USGS Shaded Relief","https://basemap.nationalmap.gov/ArcGIS/rest/services/USGSShadedReliefOnly/MapServer/tile/${z}/${y}/${x}","USGS - The National Map");else if(i==map_esri_worldimagery)a=this.createXYZLayer("ESRI World Imagery","https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}");else if(i==map_esri_topo)a=this.createXYZLayer("ESRI Topo","https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/${z}/${y}/${x}");else if(i==map_esri_aeronautical)a=this.addWMSLayer("ESRI Aeronautical","https://wms.chartbundle.com/mp/service","sec",!0);else if(i==map_esri_darkgray)a=this.createXYZLayer("ESRI Dark Gray","https://services.arcgisonline.com/arcgis/rest/services/Canvas/World_Dark_Gray_Base/MapServer/tile/${z}/${y}/${x}");else if(i==map_esri_lightgray)a=this.createXYZLayer("ESRI Light Gray","https://services.arcgisonline.com/arcgis/rest/services/Canvas/World_Light_Gray_Base/MapServer/tile/${z}/${y}/${x}");else if(i==map_esri_terrain)a=this.createXYZLayer("ESRI Terrain","https://server.arcgisonline.com/ArcGIS/rest/services/World_Terrain_Base/MapServer/tile/${z}/${y}/${x}");else if(i==map_esri_shaded)a=this.createXYZLayer("ESRI Shaded Relief","https://server.arcgisonline.com/ArcGIS/rest/services/World_Shaded_Relief/MapServer/tile/${z}/${y}/${x}");else if(i==map_esri_physical)a=this.createXYZLayer("ESRI Physical","https://server.arcgisonline.com/ArcGIS/rest/services/World_Physical_Map/MapServer/tile/${z}/${y}/${x}");else if(i==map_esri_street)a=this.createXYZLayer("ESRI Streets","https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/${z}/${y}/${x}");else if(/\/tile\//.exec(i)){let e=i;a=new OpenLayers.Layer.XYZ("ESRI China Map",e,{sphericalMercator:MapUtils.defaults.doSphericalMercator,numZoomLevels:MapUtils.defaults.zoomLevels,wrapDateLine:MapUtils.defaults.wrapDateline})}else if(i==map_ms_shaded)a=new OpenLayers.Layer.VirtualEarth("Virtual Earth - Shaded",{type:VEMapStyle.Shaded,sphericalMercator:MapUtils.defaults.doSphericalMercator,wrapDateLine:MapUtils.defaults.wrapDateline,numZoomLevels:MapUtils.defaults.zoomLevels});else if(i==map_ms_hybrid)a=new OpenLayers.Layer.VirtualEarth("Virtual Earth - Hybrid",{type:VEMapStyle.Hybrid,sphericalMercator:MapUtils.defaults.doSphericalMercator,numZoomLevels:MapUtils.defaults.zoomLevels,wrapDateLine:MapUtils.defaults.wrapDateline});else if(i==map_ms_aerial)a=new OpenLayers.Layer.VirtualEarth("Virtual Earth - Aerial",{type:VEMapStyle.Aerial,sphericalMercator:MapUtils.defaults.doSphericalMercator,numZoomLevels:MapUtils.defaults.zoomLevels,wrapDateLine:MapUtils.defaults.wrapDateline});else{let e=/wms:(.*),(.*),(.*)/.exec(i);if(!e){alert("no match for map layer:"+i);continue}this.addWMSLayer(e[1],e[2],e[3],!0)}}}null==this.firstLayer&&(this.firstLayer=a),null!=a&&(""!=t&&(t+=","),t+=i+":"+a.name,this.baseLayers[i]=a,a.ramaddaId=i,i==this.params.defaultMapLayer&&(this.defaultOLMapLayer=a),this.addBaseLayer(a))}this.graticule=new OpenLayers.Control.Graticule({layerName:"Lat/Lon Lines",xautoActivate:!1,numPoints:2,labelled:!0,visible:!0===this.params.showLatLonLines}),this.getMap().addControl(this.graticule)},addBaseLayer:function(e){this.addLayer(e),this.numberOfBaseLayers++},getBaseLayer:function(e){if(this.baseLayers)return this.baseLayers[e]},makeSimpleWms:function(e){let t="/repository/wms?version=1.1.1&request=GetMap&layers="+e+"&FORMAT=image%2Fpng&SRS=EPSG%3A4326&BBOX=-180.0,-80.0,180.0,80.0&width=400&height=400";this.addWMSLayer(Utils.makeLabel(e)+" background",t,e,!0)},initSearch:function(e){let t=this;$("#"+e).keyup((function(i){13==i.keyCode&&t.searchMarkers($("#"+e).val())}))},searchMarkers:function(e){let t=""==(e=(e=e.trim()).toLowerCase());$(':input[id*="visibleall_'+this.mapId+'"]').prop("checked",t);let i=new OpenLayers.Bounds,a=0;if(this.markers){let s=this.getMarkers();for(let r=0;r<s.length;r++){marker=s[r];let o=!0,l=$("#visible_"+this.mapId+"_"+marker.ramaddaId),n=$("#block_"+this.mapId+"_"+marker.ramaddaId),h=marker.name;o=!!t||!!Utils.isDefined(h)&&h.toLowerCase().includes(e),o?(marker.style.display="inline",marker.location&&i.extend(marker.location),a++):marker.style.display="none",o?n.show():n.hide(),l.prop("checked",o)}this.markers.redraw()}if(this.boxes&&this.boxes.markers){for(let s in this.boxes.markers){s=this.boxes.markers[s],name=s.name;let r=!0;if(r=!!t||!!Utils.isDefined(name)&&name.toLowerCase().includes(e),s.display(r),r){let e=this.transformProjBounds(s.bounds);i.extend(e),a++}}this.boxes.redraw()}if(this.lines){let i=this.lines.features;for(let a=0;a<i.length;a++){let s=i[a];name=s.name;let r=!0;r=!!t||!!Utils.isDefined(name)&&name.toLowerCase().includes(e),s.style.display=r?"inline":"none"}this.lines.redraw()}a>0&&this.centerOnMarkers(i,!0)},setLatLonReadout:function(e){this.latlonReadout=e},getMap:function(){return getMapDebug&&console.trace(),this.map},initMap:function(e){let t=this;if(this.startTime=Date.now(),this.inited)return;if(this.inited=!0,this.params.enableDragPan&&this.getMap().addControl(new OpenLayers.Control.Navigation({zoomWheelEnabled:this.params.scrollToZoom,dragPanOptions:{enableKinetic:!0}})),this.params.scrollToZoom){document.querySelector("#"+this.mapDivId+"_themap").onwheel=e=>{this.tmp&&console.dir(this.tmp),this.tmp=null,e.preventDefault()}}this.params.showZoomPanControl&&!this.params.showZoomOnlyControl&&this.getMap().addControl(new OpenLayers.Control.PanZoom),this.params.showZoomOnlyControl&&!this.params.showZoomPanControl&&this.getMap().addControl(new OpenLayers.Control.Zoom),this.params.showScaleLine&&this.getMap().addControl(new OpenLayers.Control.ScaleLine);let i=new OpenLayers.Control,a=new OpenLayers.Control,s={keydown:function(e){if(79==e.keyCode){if(!t.imageLayersList)return;if(t.ignoreKeyEvents)return;t.imageLayersList.forEach((t=>{Utils.isDefined(t.opacity)||(t.opacity=1),opacity=t.opacity,e.shiftKey?opacity+=.1:opacity-=.1,opacity<0?opacity=0:opacity>1&&(opacity=1),t.setOpacity(opacity)}))}84==e.keyCode&&t.selectImage&&t.selectImage.setVisibility(!t.selectImage.getVisibility())}};if(new OpenLayers.Handler.Keyboard(a,s,{}).activate(),this.getMap().addControl(i),this.getMap().addControl(new OpenLayers.Control.KeyboardDefaults),this.params.linkMouse&&this.getMap().events.register("mousemove",this.getMap(),(e=>{if(e.shiftKey){this.sharedMouse&&this.getMarkersLayer().removeFeatures([this.sharedMouse],{silent:!0});let t=this.getMap().getLonLatFromPixel(e.xy);t=this.transformProjPoint(t),ramaddaMapShareState(this,{mouse:t})}})),this.params.showLayerSwitcher&&this.getMap().addControl(new OpenLayers.Control.LayerSwitcher),this.params.showLatLonPosition){this.latlonReadout||(this.latlonReadout=this.mapId+"_latlonreadout");let e=GuiUtils.getDomObject(this.latlonReadout);e?this.getMap().addControl(new OpenLayers.Control.MousePosition({numDigits:5,element:e.obj,prefix:"Position: "})):this.getMap().addControl(new OpenLayers.Control.MousePosition({numDigits:5,prefix:"Position: "}))}this.params.showLocationSearch&&this.initLocationSearch(),this.defaultBounds&&(this.hadDefaultBounds=!0),this.applyDefaultLocation();for(let e=0;e<this.initialLayers.length;e++)this.addLayer(this.initialLayers[e]);this.initialLayers=[],e&&this.addRegionSelectorControl();let r=$(':input[id*="visible_'+this.mapId+'"]');r.change((function(e){t.checkImageLayerVisibility(),t.checkMarkerVisibility(),t.checkLinesVisibility(),t.checkBoxesVisibility()}));let o=$(':input[id*="visibleall_'+this.mapId+'"]');o.change((function(e){r.prop("checked",o.is(":checked")),t.checkImageLayerVisibility(),t.checkMarkerVisibility(),t.checkLinesVisibility(),t.checkBoxesVisibility()}))},applyDefaultLocation:function(){if(debugBounds&&console.log("apply default location:"+this.defaultLocation),this.defaultLocation){let e=this.transformLLPoint(this.defaultLocation);this.getMap().setCenter(e),this.params.initialZoom>=0||this.getMap().zoomTo(4),this.defaultLocation=null}else if(this.defaultBounds){let e=this.defaultBounds.getCenterLonLat(),t=this.transformLLPoint(e);debugBounds&&console.log("applying default bounds: center:"+e+" b:"+this.defaultBounds+" zoom:"+this.params.initialZoom),this.getMap().setCenter(t);let i=this.transformLLBounds(this.defaultBounds);if(this.zoomToExtent(i),this.params.initialZoom<0){this.defaultBounds.right,this.defaultBounds.left;let e=-1;e=this.map.getZoomForExtent(i)+2,this.params.initialZoom=e}this.defaultBounds=null}else this.getMap().zoomToMaxExtent();if(this.params.initialZoom>=0){debugBounds&&console.log("initial zoom:"+this.params.initialZoom);let e=this.params.initialZoom;this.params.initialZoom=-1,this.getMap().zoomTo(e),setTimeout((()=>{this.getMap().zoomTo(e)}),this.initialZoomTimeout)}},removeSearchMarkers:function(){if(this.searchMarkerList)for(let e=0;e<this.searchMarkerList.length;e++)this.removeMarker(this.searchMarkerList[e])},addAllLocationResults:function(){if(this.removeSearchMarkers(),this.searchMarkerList=[],!this.locationSearchResults)return;let e,t,i,a;for(let s=0;s<this.locationSearchResults.length;s++){let r=this.locationSearchResults[s],o=new MapUtils.createLonLat(r.longitude,r.latitude),l=r.icon;l||(l=ramaddaCdn+"/icons/green-dot.png"),this.searchMarkerList.push(this.addMarker("search",o,l,"",r.name,20,20)),e=0==s?r.longitude:Math.max(e,r.longitude),t=0==s?r.longitude:Math.min(t,r.longitude),i=0==s?r.latitude:Math.max(i,r.latitude),a=0==s?r.latitude:Math.min(a,r.latitude)}let s=this.transformLLBounds(MapUtils.createBounds(t,a,e,i));this.zoomToExtent(s)},initLocationSearch:function(){if(this.selectRegion)return;let e=this,t=HtmlUtils.span(["style","padding-right:4px;","id",this.mapDivId+"_loc_search_wait"],"")+HtmlUtils.checkbox(this.mapDivId+"_loc_bounds",["title","Search in map bounds"],!1)+HtmlUtils.span(["title","Search in map bounds"]," In view ")+HtmlUtils.input("","",["class","ramadda-map-loc-input","title","^string - matches beginning","size","30","placeholder","Search location","id",this.mapDivId+"_loc_search"]);$("#"+this.mapDivId+"_footer2").html(t);let i=$("#"+this.mapDivId+"_loc_search"),a=$("#"+this.mapDivId+"_loc_bounds"),s=$("#"+this.mapDivId+"_loc_popup"),r=$("#"+this.mapDivId+"_loc_search_wait");i.blur((function(e){setTimeout((function(){r.html(""),s.hide()}),250)})),i.on("input",(function(t){s.hide(),""==i.val()&&e.removeSearchMarkers()})),i.keypress((function(t){let o=t.keyCode||t.which;if(27==o)return void s.hide();if(13!=o)return;r.html(HtmlUtils.image(icon_wait));let l=ramaddaBaseUrl+"/geocode?query="+encodeURIComponent(i.val());if(a.is(":checked")){let t=e.transformProjBounds(e.getMap().getExtent());l+="&bounds="+t.top+","+t.left+","+t.bottom+","+t.right}$.getJSON(l,(function(t){r.html("");let a=HtmlUtils.openTag("div",["style","max-height:400px;overflow-y:auto;"]);if(0==t.result.length)return void r.html("Nothing found");e.locationSearchResults=t.result;for(let e=0;e<t.result.length;e++){let i=t.result[e].name.replace('"',"'"),s=t.result[e].icon;s||(s=ramaddaCdn+"/icons/green-dot.png"),a+=HtmlUtils.div(["class","ramadda-map-loc","name",i,"icon",s,"latitude",t.result[e].latitude,"longitude",t.result[e].longitude],"<img width='16' src="+s+"> "+t.result[e].name)}a+=HtmlUtils.div(["class","ramadda-map-loc","name","all"],"Show all");a+=HtmlUtils.closeTag("div"),s.html(a),HtmlUtils.setPopupObject(s),s.show(),s.position({of:i,my:"left bottom",at:"left top",collision:"fit fit"}),s.find(".ramadda-map-loc").click((function(){s.hide();let t=$(this).attr("name");if("all"==t)return void e.addAllLocationResults();let i=parseFloat($(this).attr("latitude")),a=parseFloat($(this).attr("longitude")),r=$(this).attr("icon"),o=.05,l=e.transformLLBounds(MapUtils.createBounds(a-o,i-o,a+o,i+o)),n=new MapUtils.createLonLat(a,i);e.removeSearchMarkers(),e.searchMarkerList=[],e.searchMarkerList.push(e.addMarker("search",n,r,"",t,20,20));let h=e.transformProjBounds(e.getMap().getExtent());Math.abs(h.top-h.bottom)>o?e.zoomToExtent(l):e.setCenter(MapUtils.createLonLat(a,i))}))})).fail((function(e,t,i){r.html("Error:"+i)}))}))},addVectorLayer:function(e,t){if(this.addLayer(e),this.vectorLayers.push(e),this.getCanSelect(t)){let t=this;this.getMap().featureSelect?this.getMap().featureSelect.layers.push(e):this.getMap().featureSelect=new OpenLayers.Control.SelectFeature([e],{multiple:!1,hover:this.selectOnHover,onSelect:function(e){t.showMarkerPopup(e,!0)}})}this.checkLayerOrder()},isLayerVisible:function(e,t){let i=$("#visible_"+this.mapId+"_"+e);return 0==i.length&&null!=t&&(i=$("#visible_"+this.mapId+"_"+t)),0==i.length||i.is(":checked")},initForDrawing:function(){let e=this;e.drawingLayer||(this.drawingLayer=new OpenLayers.Layer.Vector("Drawing"),this.addLayer(e.drawingLayer)),this.drawControl=new OpenLayers.Control.DrawFeature(e.drawingLayer,OpenLayers.Handler.Point),this.getMap().addControl(e.drawControl)},drawingFeatureAdded:function(e){},addClickHandler:function(e,t,i,a){if(this.lonFldId=e,this.latFldId=t,!this.clickHandler&&this.map)return this.clickHandler=new OpenLayers.Control.Click,this.clickHandler.setLatLonZoomFld(e,t,i,a),this.clickHandler.setTheMap(this),this.getMap().addControl(this.clickHandler),this.clickHandler.activate(),this.clickHandler},setSelection:function(e,t,i){this.selectRegion=t,this.argBase=e,GuiUtils&&(this.fldNorth=GuiUtils.getDomObject(this.argBase+"_north"),null==this.fldNorth&&(this.fldNorth=GuiUtils.getDomObject(this.argBase+".north")),null==this.fldNorth&&(this.fldNorth=GuiUtils.getDomObject(this.mapId+"_north")),this.fldSouth=GuiUtils.getDomObject(this.argBase+"_south"),this.fldSouth||(this.fldSouth=GuiUtils.getDomObject(this.argBase+".south")),null==this.fldSouth&&(this.fldSouth=GuiUtils.getDomObject(this.mapId+"_south")),this.fldEast=GuiUtils.getDomObject(this.argBase+"_east"),this.fldEast||(this.fldEast=GuiUtils.getDomObject(this.argBase+".east")),null==this.fldEast&&(this.fldEast=GuiUtils.getDomObject(this.mapId+"_east")),this.fldWest=GuiUtils.getDomObject(this.argBase+"_west"),this.fldWest||(this.fldWest=GuiUtils.getDomObject(this.argBase+".west")),null==this.fldWest&&(this.fldWest=GuiUtils.getDomObject(this.mapId+"_west")),this.fldLat=GuiUtils.getDomObject(this.argBase+"_latitude"),this.fldLat||(this.fldLat=GuiUtils.getDomObject(this.argBase+".latitude")),null==this.fldLat&&(this.fldLat=GuiUtils.getDomObject(this.mapId+"_latitude")),this.fldLon=GuiUtils.getDomObject(this.argBase+"_longitude"),this.fldLon||(this.fldLon=GuiUtils.getDomObject(this.argBase+".longitude")),null==this.fldLon&&(this.fldLon=GuiUtils.getDomObject(this.mapId+"_longitude")),this.fldLon&&(this.addClickHandler(this.fldLon.id,this.fldLat.id),this.setSelectionMarker(this.fldLon.obj.value,this.fldLat.obj.value)))},selectionPopupInit:function(){this.inited||(this.initMap(this.selectRegion),this.argBase&&!this.fldNorth&&this.setSelection(this.argBase),this.fldNorth&&this.setSelectionBox(this.fldNorth.obj.value,this.fldWest.obj.value,this.fldSouth.obj.value,this.fldEast.obj.value,!0),this.fldLon&&(this.addClickHandler(this.fldLon.id,this.fldLat.id),this.setSelectionMarker(this.fldLon.obj.value,this.fldLat.obj.value))),this.map.updateSize()},setSelectionBoxFromFields:function(e){if(this.fldNorth&&(this.setSelectionBox(this.fldNorth.obj.value,this.fldWest.obj.value,this.fldSouth.obj.value,this.fldEast.obj.value,!0),this.selectorBox)){let t=this.selectorBox.bounds;this.getMap().setCenter(t.getCenterLonLat()),e&&this.zoomToExtent(t)}},toggleSelectorBox:function(e){this.selectorControl&&(e?(this.selectorControl.activate(),this.selectorControl.box.activate()):(this.selectorControl.deactivate(),this.selectorControl.box.deactivate()))},resetExtent:function(){debugBounds&&console.log("resetExtent"),this.getMap().zoomToMaxExtent()},setSelectionBox:function(e,t,i,a,s){if(""==e||""==t||""==i||""==a)return;let r=MapUtils.createBounds(t,Math.max(i,-MapUtils.defaults.maxLatValue),a,Math.min(e,MapUtils.defaults.maxLatValue));if(this.selectorBox)this.selectorBox.bounds=this.transformLLBounds(r);else{let s={color:"red",selectable:!1};this.selectorBox=this.createBox("","Selector box",e,t,i,a,"",s)}if(s&&(debugBounds&&console.log("calling setViewToBounds-1"),this.setViewToBounds(r)),this.boxes&&this.boxes.redraw(),this.selectImage){let s=MapUtils.createBounds(t,i,a,e);s=this.transformLLBounds(s),this.selectImage.extent=s,this.selectImage.redraw()}},clearSelectionMarker:function(){null!=this.selectorMarker&&(this.removeMarker(this.selectorMarker),this.selectorMarker=null)},clearSelectedFeatures:function(){if(null!=this.getMap().controls){let e=this.getMap().controls;for(i=0;i<e.length;i++)"olControlSelectFeature"==e[i].displayClass&&e[i].unselectAll()}},setSelectionMarker:function(e,t,i,a){if(!e||!t||""==e||""==t)return;null!=this.lonFldId&&($("#"+this.lonFldId).val(MapUtils.formatLocationValue(e)),$("#"+this.latFldId).val(MapUtils.formatLocationValue(t)));let s=new MapUtils.createLonLat(e,t);if(null==this.selectorMarker?this.selectorMarker=this.addMarker(MapUtils.POSITIONMARKERID,s,"","","",20,10):this.selectorMarker.lonlat=this.transformLLPoint(s),this.markers&&this.markers.redraw(),i&&(debugBounds&&console.log("setSelectionMarker-1"),this.getMap().setCenter(this.selectorMarker.lonlat)),a){if(debugBounds&&console.log("setSelectionMarker-2"),a.zoomOut){let e=this.getMap().getZoom();return e--,void(this.getMap().isValidZoomLevel(e)&&this.getMap().zoomTo(e))}if(a.zoomIn){let e=this.getMap().getZoom();return e++,void(this.getMap().isValidZoomLevel(e)&&this.getMap().zoomTo(e))}let i=a.offset;if(i){let a=this.transformLLBounds(MapUtils.createBounds(e-i,t-i,e+i,t+i));this.zoomToExtent(a)}}},transformLLBounds:function(e){if(!e)return;return Utils.isDefined(e.north)&&(e=MapUtils.createBounds(e.west,e.south,e.east,e.north)),e.clone().transform(this.displayProjection,this.sourceProjection)},ensureLonLat:function(e){return e.length>0&&!e[0].transform&&(e=e.map((e=>e=new OpenLayers.Geometry.Point(e.x,e.y)))),e},transformPoints:function(e){return(e=this.ensureLonLat(e)).forEach((e=>{e.transform(this.displayProjection,this.sourceProjection)})),e},transformLLPoint:function(e){if(!e)return null;return e.clone().transform(this.displayProjection,this.sourceProjection)},transformProjBounds:function(e){if(!e)return;return e.clone().transform(this.sourceProjection,this.displayProjection)},transformProjPoint:function(e){if(!e)return;return e.clone().transform(this.sourceProjection,this.displayProjection)},normalizeBounds:function(e){if(!this.map)return e;let t=e,i=e.left,a=e.right,s=this.getMap().restrictedExtent;return s||(s=this.maxExtent),s?(s.left>=0&&(e.left<0&&(i=e.left+360),e.right<0&&(a=e.right+360)),i>a&&(a=e.right+360),i=Math.max(i,s.left),a=Math.min(a,s.right),t=MapUtils.createBounds(i,e.bottom,a,e.top),t):e},findSelectionFields:function(){!this.argBase||this.fldNorth||this.fldLon||this.setSelection(this.argBase)},selectionClear:function(){this.findSelectionFields(),HU.addToDocumentUrl("map_bounds",""),this.fldNorth?(this.fldNorth.obj.value="",this.fldSouth.obj.value="",this.fldWest.obj.value="",this.fldEast.obj.value=""):this.fldLat&&(this.fldLon.obj.value="",this.fldLat.obj.value=""),this.selectorBox&&this.boxes&&(this.boxes.removeMarker(this.selectorBox),this.selectorBox=null),this.selectorMarker&&this.markers&&(this.removeMarker(this.selectorMarker),this.selectorMarker=null)},clearMarkers:function(){if(!this.markers)return;let e=this.getMarkers();this.markers.removeFeatures(e),this.markers.redraw()},getMarkers:function(){return null==this.markers?[]:this.markers.features},clearRegionSelector:function(e){this.selectorControl&&this.selectorControl.box&&this.selectorControl.box.removeBox()},addRegionSelectorControl:function(t,i){let a=this;a.selectorControl||(a.selectorListener=t,a.selectorControl=new OpenLayers.Control,OpenLayers.Util.extend(a.selectorControl,{draw:function(){this.box=new OpenLayers.Handler.Box(a.selectorControl,{done:this.notice},{keyMask:OpenLayers.Handler.MOD_SHIFT,xxxboxDivClassName:"map-drag-box"}),i||this.box.activate()},notice:function(e){let i=a.getMap().getLonLatFromPixel(new OpenLayers.Pixel(e.left,e.bottom)),s=a.getMap().getLonLatFromPixel(new OpenLayers.Pixel(e.right,e.top));i=a.transformProjPoint(i),s=a.transformProjPoint(s),e=MapUtils.createBounds(i.lon,i.lat,s.lon,s.lat),e=a.normalizeBounds(e),a.setSelectionBox(e.top,e.left,e.bottom,e.right,!1),a.findSelectionFields(),t&&t(e),a.fldNorth&&(a.fldNorth.obj.value=MapUtils.formatLocationValue(e.top),a.fldSouth.obj.value=MapUtils.formatLocationValue(e.bottom),a.fldWest.obj.value=MapUtils.formatLocationValue(e.left),a.fldEast.obj.value=MapUtils.formatLocationValue(e.right),HU.addToDocumentUrl("map_bounds",e.top+","+e.left+","+e.bottom+","+e.right))}}),a.map.addControl(a.selectorControl),a.panControl=new OpenLayers.Control,OpenLayers.Util.extend(a.panControl,{draw:function(){this.box=new OpenLayers.Handler.Drag(a.panControl,{down:this.down,move:this.move},{keyMask:OpenLayers.Handler.MOD_META,boxDivClassName:"map-drag-box"}),this.box.activate()},down:function(t){this.firstPoint=a.getMap().getLonLatFromPixel(new OpenLayers.Pixel(t.x,t.y)),this.firstPoint=a.transformProjPoint(this.firstPoint),a.findSelectionFields(),a.fldNorth&&(n=this.origNorth=parseFloat(a.fldNorth.obj.value),s=this.origSouth=parseFloat(a.fldSouth.obj.value),w=this.origWest=parseFloat(a.fldWest.obj.value),e=this.origEast=parseFloat(a.fldEast.obj.value),t=this.firstPoint,this.doWest=!1,this.doSouth=!1,this.doEast=!1,this.doNorth=!1,t.lon<=e&&t.lon>=w&&t.lat<=n&&t.lat>=s?(this.doSouth=this.doWest=this.doEast=this.doNorth=!0,this.type="center"):t.lon>e?t.lat>n?(this.type="ne",this.doEast=this.doNorth=!0):t.lat<s?(this.type="se",this.doSouth=this.doEast=!0):(this.type="e",this.doEast=!0):t.lon<w?t.lat>n?(this.type="nw",this.doWest=this.doNorth=!0):t.lat<s?(this.type="sw",this.doSouth=this.doWest=!0):(this.type="w",this.doWest=!0):t.lat>n?(this.type="n",this.doNorth=!0):(this.type="s",this.doSouth=!0))},move:function(e){let t=a.getMap().getLonLatFromPixel(new OpenLayers.Pixel(e.x,e.y));t=a.transformProjPoint(t),dx=t.lon-this.firstPoint.lon,dy=t.lat-this.firstPoint.lat,newWest=this.origWest,newEast=this.origEast,newSouth=this.origSouth,newNorth=this.origNorth,this.doWest&&(newWest+=dx),this.doSouth&&(newSouth+=dy),this.doEast&&(newEast+=dx),this.doNorth&&(newNorth+=dy);let i=MapUtils.createBounds(newWest,newSouth,newEast,newNorth);i=a.normalizeBounds(i),a.setSelectionBox(i.top,i.left,i.bottom,i.right,!1),a.findSelectionFields(),a.fldNorth&&(a.fldNorth.obj.value=MapUtils.formatLocationValue(i.top),a.fldSouth.obj.value=MapUtils.formatLocationValue(i.bottom),a.fldWest.obj.value=MapUtils.formatLocationValue(i.left),a.fldEast.obj.value=MapUtils.formatLocationValue(i.right))}}),a.map.addControl(a.panControl))},closePopup:function(e){this.currentPopup&&(this.getMap().removePopup(this.currentPopup),this.currentPopup.destroy(),this.currentPopup=null,this.hiliteBox(""),this.selectedFeature&&this.unselectFeature(this.selectedFeature))},onPopupClose:function(e){this.params.displayDiv&&$("#"+this.params.displayDiv).html(""),this.currentPopup&&(this.getMap().removePopup(this.currentPopup),this.currentPopup.destroy(),this.currentPopup=null,this.hiliteBox(""),this.selectedFeature&&this.unselectFeature(this.selectedFeature))},findObject:function(e,t){for(i=0;i<t.length;i++){let a=t[i].ramaddaId;if(a||(a=t[i].id),a==e)return t[i]}return null},findMarker:function(e){return this.markers?this.findObject(e,this.getMarkers()):null},findFeature:function(e){return this.features[e]},findBox:function(e){return this.boxes?this.findObject(e,this.boxes.markers):null},hiliteBox:function(e){this.currentBox&&this.currentBox.setBorder(this.currentBox.defaultBorderColor||"blue",1),this.currentBox=this.findBox(e),this.currentBox&&this.currentBox.setBorder("red")},checkMarkerVisibility:function(){if(!this.markers)return;let e=this.getMarkers();for(let t=0;t<e.length;t++){marker=e[t];let i=this.isLayerVisible(marker.ramaddaId,marker.parentId);marker.style.display=i?"inline":"none"}this.markers.redraw()},checkLinesVisibility:function(){if(!this.lines)return;let e=this.lines.features;for(let t=0;t<e.length;t++){let i=e[t],a=this.isLayerVisible(i.ramaddaId);i.style.display=a?"inline":"none"}this.lines.redraw()},checkBoxesVisibility:function(){if(this.boxes){for(let e in this.boxes.markers){e=this.boxes.markers[e];let t=this.isLayerVisible(e.ramaddaId);e.display(t)}this.boxes.redraw()}},checkImageLayerVisibility:function(){this.imageLayersList&&this.imageLayersList.forEach((e=>{let t=this.isLayerVisible(e.id);e.setVisibility(t),t?e.box&&(this.removeBox(e.box),e.box=this.createBox(i,"",e.north,e.west,e.south,e.east,e.text,{})):e.box&&(this.removeBox(e.box),e.box=null)}))},hiliteMarker:function(e){let t=this.findMarker(e);if(t||(t=this.findFeature(e)),!t&&this.imageLayers&&(t=this.imageLayers[e]),!t)return;let i=t.latLonBounds;if(i){let e=this.transformLLBounds(i);this.zoomToExtent(e)}else debugBounds&&console.log("hiliteMarker"),this.setCenter(t.lonlat);this.showMarkerPopup(t)},hideLoadingImage:function(){this.loadingImage&&(this.loadingImage.style.visibility="hidden")},showLoadingImage:function(){if(this.loadingImage)return void(this.loadingImage.style.visibility="inline");let e=new OpenLayers.Size;e.h=120,e.w=120;let t=this.getMap().viewPortDiv.offsetWidth,i=this.getMap().viewPortDiv.offsetHeight,a=new OpenLayers.Pixel(t/2-e.w/2,i/2-e.h/2);this.loadingImage=OpenLayers.Util.createImage("loadingimage",a,e,ramaddaCdn+"/icons/mapprogress.gif"),this.loadingImage.style.zIndex=1010,this.getMap().viewPortDiv.appendChild(this.loadingImage)},centerOnMarkerLayer:function(){this.centerOnMarkers(null,!1,!0)},centerOnMarkersInit:function(){this.hadDefaultBounds||this.centerOnMarkers(null)},getLayerVisbileExtent:function(e){let t=null,i=e.features;if(!i)return e.getDataExtent();if(i.length>0){let e=null;for(let a=0,s=i.length;a<s;a++)i[a].getVisibility()&&(e=i[a].geometry,e&&(null===t&&(t=new OpenLayers.Bounds),t.extend(e.getBounds())))}return t},zoomToLayer:function(e,t){let i=this.getLayerVisbileExtent(e);i||(i=e.extent),i&&(t&&(i=i.scale(parseFloat(t),i.getCenterPixel())),this.zoomToExtent(i,!1))},animateViewToBounds:function(e,t,i){Utils.isDefined(i)||(i=1),t||(t=this.transformProjBounds(this.getMap().getExtent()));if(i>10)return void this.setViewToBounds(e);let a=i/10;i++,newBounds=MapUtils.createBounds(t.left+(e.left-t.left)*a,t.bottom+(e.bottom-t.bottom)*a,t.right+(e.right-t.right)*a,t.top+(e.top-t.top)*a),this.setViewToBounds(newBounds),setTimeout((()=>this.animateViewToBounds(e,t,i)),125)},getPopupText:function(e,t){return null==e?null:(0==e.indexOf("base64:")&&0==(e=window.atob(e.substring(7))).indexOf("{")&&(props=JSON.parse(e),(e=props.text)||(e=""),t&&(t.inputProps=props)),e)},clearSeenMarkers:function(){this.seenMarkers={}},addEntryMarker:function(e,t,i,a,s,r,o){if(marker=this.addMarker(e,t,i,a,s),marker.entryType=r,marker.entryId=e,o&&o.fillColor){let i={pointRadius:o.radius||12,fillColor:o.fillColor,strokeWidth:o.strokeWidth,strokeColor:o.strokeColor};this.addPoint(e,t,i,"")}},createMarker:function(e,t,i,a,s,r,o,l,n,h,d){if("dot"==i)return this.createPoint(e,t,{},s);Utils.isDefined(t.x)&&(t=MapUtils.createLonLat(t.x,t.y)),d||(d={}),Array.isArray(t)&&(t=MapUtils.createLonLat(t[0],t[1]));let u=o||this.params.iconWidth||this.params.iconSize||20,p=o||this.params.iconHeight||this.params.iconSize||20;o=u,null==l&&(l=0),null==n&&(n=0),this.markers||(this.markers=new OpenLayers.Layer.Vector("Markers"),this.addVectorLayer(this.markers,h)),i||(i=ramaddaCdn+"/icons/marker.png");let c=new OpenLayers.Size(u,p),m=new OpenLayers.Icon(i,c,null,(function(e){return new OpenLayers.Pixel(-o.w/2-l,-o.h/2-n)})),f=this.transformLLPoint(t),g=new OpenLayers.Marker(f,m),y=new OpenLayers.Geometry.Point(t.lon,t.lat).transform(this.displayProjection,this.sourceProjection),L={externalGraphic:i,graphicWidth:o,graphicXOffset:l+-o/2,graphicYOffset:-o/2,labelYOffset:-o,label:d.label};Utils.isDefined(d.rotation)&&(L.rotation=d.rotation);let M=new OpenLayers.Feature.Vector(y,{description:""},L);M.ramaddaId=e,M.parentId=r,M.text=this.getPopupText(s,M),M.name=a,M.location=t,g.ramaddaId=e,g.text=this.getPopupText(s,g),g.name=a,g.location=t;let k=t+"";M.locationKey=k;let b=this.seenMarkers[k];null==b&&(b=[],this.seenMarkers[k]=b),b.push(M);let x=this,v=function(e){x.showMarkerPopup(g,!0),null!=g.ramaddaClickHandler&&g.ramaddaClickHandler.call(null,g),OpenLayers.Event.stop(e)};return g.events.register("click",g,v),g.events.register("touchstart",g,v),this.isLayerVisible(g.ramaddaId,g.parentId)||g.display(!1),M.what="marker",M},addMarker:function(e,t,i,a,s,r,o,l,n,h,d,u){let p=this.createMarker(e,t,i,a,s,r,o,0,l,n,h);return p.lonlat=t,u||this.addMarkers([p]),d&&this.addPolygonString(d,{fill:!0,fillColor:"#0000ff",fillOpacity:.1,strokeWidth:1,strokeColor:"blue"},!0,s),p},createPolygonString:function(e,t,i,a){return this.createPolygonFromString(e,t,i,a)},createPolygonFromString:function(e,t,i,a){let s;[";",","].forEach((t=>{e.indexOf(t)>=0&&(s=t)}));let r=e.split(s),o=[];for(let e=2;e<r.length;e+=2){let t=parseFloat(r[e-2]),a=parseFloat(r[e-1]),s=parseFloat(r[e]),l=parseFloat(r[e+1]);if(!i){let e=t;t=a,a=e,e=s,s=l,l=e}o.push(new OpenLayers.Geometry.Point(a,t)),o.push(new OpenLayers.Geometry.Point(l,s))}let l=[];return o.length>0&&l.push(this.createPolygon("polygon","",o,t,a)),l},addPolygonString:function(e,t,i,a){let s=this.createPolygonFromString(e,t,i,a);return this.getLinesLayer().addFeatures(s),s},addMarkers:function(e){this.markers||(this.markers=new OpenLayers.Layer.Vector("Markers"),this.addVectorLayer(this.markers,!0)),this.markers.addFeatures(e)},initBoxes:function(e){this.getMap(),this.addLayer(e),e.getFeatureFromEvent=function(e){return null}},removeBox:function(e){this.boxes&&e&&(this.boxes.removeMarker(e),this.boxes.redraw())},addBox:function(e){this.boxes||(this.boxes=new OpenLayers.Layer.Boxes("Boxes",{wrapDateLine:MapUtils.defaults.wrapDateline}),this.getMap()?this.initBoxes(this.boxes):this.initialBoxes=this.boxes),this.boxes.addMarker(e),this.boxes.redraw()},createBox:function(e,t,i,a,s,r,o,l){0==o.indexOf("base64:")&&(o=window.atob(o.substring(7)));let n={color:"blue",selectable:!0,zoomToExtent:!1,sticky:!1};for(let e in l)n[e]=l[e];n.color||(n.color=this.params.boxColor||"blue");let h=MapUtils.createBounds(a,Math.max(s,-MapUtils.defaults.maxLatValue),r,Math.min(i,MapUtils.defaults.maxLatValue)),d=this.transformLLBounds(h);box=new OpenLayers.Marker.Box(d),box.sticky=n.sticky;let u=this;n.selectable&&box.events.register("click",box,(function(e){u.showMarkerPopup(box,!0),OpenLayers.Event.stop(e)}));let p=new MapUtils.createLonLat(a,i);return box.lonlat=this.transformLLPoint(p),box.text=this.getPopupText(o),box.name=t,box.setBorder(n.color,1),box.defaultBorderColor=n.color,box.ramaddaId=e,n.zoomToExtent&&this.centerOnMarkers(h),this.addBox(box),box},circleMarker:function(e,t){if(marker=this.findMarker(e),!marker)return null;myattrs={pointRadius:12,stroke:!0,strokeColor:"red",strokeWidth:2,fill:!1},t&&$.extend(myattrs,t);return this.showFeatureText(marker),this.addPoint(e+"_circle",marker.location,myattrs)},addFeatureHighlightHandler:function(e){this.featureHighlightHandler=e},addFeatureSelectHandler:function(e){this.featureSelectHandler=e},showFeatureText:function(e){this.featureHighlightHandler&&this.featureHighlightHandler(e,!0);let t=this;if(e.text&&this.params.displayDiv){this.textFeature=e,setTimeout((function(){t.textFeature==e&&t.showText(t.textFeature.text)}),500)}},showText:function(e){$("#"+this.params.displayDiv).html(e)},hideFeatureText:function(e){this.featureHighlightHandler&&this.featureHighlightHandler(e,!1),e&&this.textFeature!=e||this.params.displayDivSticky||this.showText("")},createPoint:function(e,t,i,a,s,r){let o=t;void 0===t.x?t=new OpenLayers.Geometry.Point(t.lon,t.lat):o=MapUtils.createLonLat(t.x,t.y),this.basePointStyle||(this.basePointStyle=OpenLayers.Util.extend({},OpenLayers.Feature.Vector.style.default),$.extend(this.basePointStyle,{pointRadius:5,stroke:!0,strokeColor:"red",strokeWidth:0,strokeOpacity:.75,fill:!0,fillColor:"blue",fillOpacity:.75}));let l=Object.assign({},this.basePointStyle);i&&(l=Object.assign(l,i),l.pointRadius<=0&&(l.pointRadius=1)),""!=l.fillColor&&"none"!=l.fillColor||(l.fillOpacity=0),""!=l.strokeColor&&"none"!=l.strokeColor||(l.strokeOpacity=0);let n=new OpenLayers.Geometry.Point(t.x,t.y);n.transform(this.displayProjection,this.sourceProjection);let h=new OpenLayers.Feature.Vector(n,null,l);return h.center=n,h.ramaddaId=e,a&&(h.text=this.getPopupText(a,h)),h.textGetter=s,h.location=o,this.features[e]=h,h},addPoint:function(e,t,i,a,s){let r=this.createPoint(e,t,i,a,s);return this.getMarkersLayer().addFeatures([r],{silent:!0}),r},addPoints:function(e){this.getMarkersLayer().addFeatures(e,{silent:!0})},getMarkersLayer:function(){return null==this.circles&&(this.circles=new OpenLayers.Layer.Vector("Shapes"),this.circles.layerName="circles",this.circles.setZIndex(1),this.addVectorLayer(this.circles),this.circles.canSelect=!0),this.circles},setPointsVisibility:function(e){this.circles&&this.circles.setVisibility(e)},addRectangle:function(e,t,i,a,s,r,o){let l=[new OpenLayers.Geometry.Point(i,t),new OpenLayers.Geometry.Point(i,a),new OpenLayers.Geometry.Point(s,a),new OpenLayers.Geometry.Point(s,t),new OpenLayers.Geometry.Point(i,t)];return this.addPolygon(e,"",l,r,o)},createLine:function(e,t,i,a,s,r,o,l){let n=[new OpenLayers.Geometry.Point(a,i),new OpenLayers.Geometry.Point(r,s)];return this.createPolygon(e,t,n,o,l)},addLine:function(e,t,i,a,s,r,o,l,n){let h=[new OpenLayers.Geometry.Point(a,i),new OpenLayers.Geometry.Point(r,s)];return this.addPolygon(e,t,h,o,l,n)},addLines:function(e,t,i,a,s){(i=i||{}).strokeWidth||(i.strokeWidth=this.params.strokeWidth),i.strokeColor||(i.strokeColor=this.params.strokeColor);let r=[];for(let e=0;e<a.length;e+=2)r.push(new OpenLayers.Geometry.Point(a[e+1],a[e]));return this.addPolygon(e,t,r,i,s,!1,!0)},removePolygon:function(e){this.lines&&this.lines.removeFeatures([e])},createPolygon:function(e,t,i,a,s,r){let o;o=i.length>1?new OpenLayers.LonLat(i[0].x+(i[1].x-i[0].x)/2,i[0].y+(i[1].y-i[0].y)/2):new OpenLayers.LonLat(i[0].x,i[0].y),i=this.transformPoints(i);let l,n=OpenLayers.Util.extend({},OpenLayers.Feature.Vector.style.default),h=OpenLayers.Util.extend({},n);if(a)for(let e in a)h[e]=a[e];if(r)l=new OpenLayers.Geometry.LineString(i);else{let e=new OpenLayers.Geometry.LinearRing(i);l=new OpenLayers.Geometry.Polygon(e)}let d=new OpenLayers.Feature.Vector(l,null,h);s||(s=t),d.text=s,d.ramaddaId=e,d.location=o,d.name=t;let u=this.isLayerVisible(d.ramaddaId);return d.style.display=u?"inline":"none",d},addPolygon:function(e,t,i,a,s,r,o){let l=this.createPolygon(e,t,i,a,s,o);return r||this.getLinesLayer().addFeatures([l]),l},getLinesLayer:function(){if(!this.lines){let e=OpenLayers.Util.extend({},OpenLayers.Feature.Vector.style.default);this.lines=new OpenLayers.Layer.Vector("Lines",{style:e}),this.addVectorLayer(this.lines),this.lines.isMapLayer=!0}return this.lines},centerOnFeatures:function(e){let t=new OpenLayers.Bounds;e.forEach((e=>{t.extend(e.geometry.getBounds())})),this.zoomToExtent(t)},getHighlightLinesLayer:function(){if(!this.highlightlines){let e=OpenLayers.Util.extend({},OpenLayers.Feature.Vector.style.default);this.highlightlines=new OpenLayers.Layer.Vector("Highlight Lines",{style:e}),this.addVectorLayer(this.highlightlines)}return this.highlightlines},handleMarkerLayer:function(){this.currentPopup&&(this.getMap().removePopup(this.currentPopup),this.currentPopup.destroy(),this.currentPopup=null);let e=this.currentEntryMarker;if(e.entryLayer){let t=this.loadedLayers.indexOf(e.entryLayer);return t>=0&&(this.loadedLayers=this.loadedLayers.slice(t)),this.getMap().removeLayer(e.entryLayer),void(e.entryLayer=null)}let t=this.handleEntrySelect(e.entryId,e.name,e.entryType);t&&(e.entryLayer=t)},showMarkerPopup:function(e,t,i){if(this.entryClickHandler&&window[this.entryClickHandler]&&!window[this.entryClickHandler](this,e))return;if(this.currentPopup&&(this.getMap().removePopup(this.currentPopup),this.currentPopup.destroy()),this.featureSelectHandler&&this.featureSelectHandler(e))return;let a=e.ramaddaId;if(a||(a=e.id),this.shareSelected&&window.ramaddaDisplaySetSelectedEntry&&ramaddaDisplaySetSelectedEntry(a),!this.params.doPopup)return;this.hiliteBox(a);let s;if(e.inputProps&&(e.text=this.getPopupText(e.inputProps.text)),e.textGetter?s=e.textGetter(e):this.textGetter&&(s=this.textGetter(e.layer,e)),s||(s=e.text),!s)return;if(this.params.displayDiv)return void $("#"+this.params.displayDiv).html(s);if(t&&null!=e.locationKey&&(markers=this.seenMarkers[e.locationKey],markers&&markers.length>1)){s="";for(let t=0;t<markers.length;t++){otherMarker=markers[t],t>0&&(s+="<hr>"),otherMarker.inputProps&&(otherMarker.text=otherMarker.textGetter?otherMarker.textGetter(e):this.getPopupText(otherMarker.inputProps.text));let i=otherMarker.text?otherMarker.text:otherMarker.textGetter?otherMarker.textGetter(e):"NA";if(s+=i,t>10)break}}let r=e.location,o=null;if(r){if(void 0===r.lon&&(r=MapUtils.createLonLat(r.x,r.y)),s&&""!=s||r.lat==r.lat&&(s="Lon: "+r.lat+"<br>Lat: "+r.lon),e.entryType){let t=e.entryType;if("geo_kml"==t||"geo_json"==t||"geo_shapefile"==t){this.currentEntryMarker=e;let t="ramaddaMapMap['"+this.mapId+"'].handleMarkerLayer();",i=e.entryLayer?"Remove Layer":"Load Layer";s="<center>"+HtmlUtils.onClick(t,i)+"</center>"+s}}o=this.transformLLPoint(r)}else if(e.geometry){let t=e.geometry.getBounds();t&&(o=t.getCenterLonLat())}if(null!=o){if(this.params.doPopupSlider)return this.doingPopup=!0,e.location&&this.setCenter(e.location),void setTimeout((()=>{let e=$("#"+this.mapDivId+"_slider");this.params.popupSliderRight?e.css("right","0px"):e.css("left","0px"),e.hide();let t=HU.div([STYLE,HU.css("padding","5px")],HU.div([ID,this.mapDivId+"_sliderclose",CLASS,"ramadda-clickable"],HU.getIconImage(icon_close))+s);e.html(t),e.slideDown(800),$("#"+this.mapDivId+"_sliderclose").click((()=>{e.slideUp()})),setTimeout((()=>{this.doingPopup=!1}),1e3)}),10);i||this.simplePopup,popup=this.makePopup(o,s),e.inputProps&&e.inputProps.minSizeX&&(popup.minSize=new OpenLayers.Size(e.inputProps.minSizeX,e.inputProps.minSizeY)),e.popupText=popup,popup.marker=e,this.getMap().addPopup(popup),this.currentPopup=popup,e.inputProps&&e.inputProps.chartType&&this.popupChart(e.inputProps),this.popupHandler&&this.popupHandler(e,popup)}else console.log("No location for feature popup")},popupChart:function(e){let t=getOrCreateDisplayManager(e.divId,{},!0),i={entryId:e.entryId},a=e.title;a||(a="Chart");let s=null==e.fields?null:e.fields.split(","),r={title:a,layoutHere:!0,divid:e.divId,entryId:e.entryId,fields:s,vAxisMinValue:e.vAxisMinValue,vAxisMaxValue:e.vAxisMaxValue,data:new PointData(a,null,null,getRamadda().getRoot()+"/entry/show?entryid="+e.entryId+"&output=points.product&product=points.json&numpoints=10000",i)};if(e.chartArgs){let t=e.chartArgs.split(",");for(let e=0;e<t.length;e+=2)r[t[e]]=t[e+1]}t.createDisplay(e.chartType,r)},uncircleMarker:function(e){feature=this.features[e+"_circle"],feature&&this.circles&&this.circles.removeFeatures([feature]),this.hideFeatureText(feature)},removePoint:function(e){this.removePoints([e])},removePointsLayer:function(){this.circles&&(this.removeLayer(this.circles),this.circles=null)},removeMarkersLayer:function(){this.markers&&(this.removeLayer(this.markers),this.markers=null)},removePoints:function(e){this.circles&&this.circles.removeFeatures(e)},removeMarker:function(e){this.removeMarkers([e])},removeMarkers:function(e){this.markers&&this.markers.removeFeatures(e)},createFeatureLayer:function(e,t,i,a){let s=OpenLayers.Util.extend({},OpenLayers.Feature.Vector.style.default);i&&$.extend(s,i),(a=a||{}).style=s;let r=new OpenLayers.Layer.Vector(e||"Markers",a);return this.externalLayers.push(r),this.addVectorLayer(r,t),r}};
