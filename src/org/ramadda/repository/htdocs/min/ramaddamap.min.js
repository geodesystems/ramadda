function RepositoryMap(t,e){ramaddaMapAdd(this);let i=this;e||(e={}),this.params=e,this.mapId=t||"map",[ARG_MAPCENTER,ARG_ZOOMLEVEL].forEach((t=>{Utils.stringDefined(HU.getUrlArgument(t))&&(e[t]=HU.getUrlArgument(t),debugBounds&&console.log("url arg:"+t+"="+e[t]))})),e.mapCenter&&([lat,lon]=e.mapCenter.replace("%2C",",").split(","),e.initialLocation={lon:lon,lat:lat});let a=!0;e.simple&&(a=!1);let s={pointRadius:3,strokeColor:"blue",strokeWidth:1,fillOpacity:.8,fillColor:"#e6e6e6",layerStrokeColor:"blue",layerStrokeWith:1,layerFillColor:"#ccc",layerFillOpacity:.3,highlightStrokeColor:"blue",highlightFillColor:"match",highlightStrokeWidth:2,highlightFillOpacity:.5,selectStrokeColor:null,selectStrokeOpacity:null,selectFillColor:null,selectStrokeWidth:null,selectFillOpacity:.4,maxZoom:18,singlePointZoom:7,scrollToZoom:!0,selectOnHover:!1,highlightOnHover:!0,showLocationSearch:!1,imageOpacity:1,iconSize:null,iconWidth:null,iconHeight:null,changeSizeOnSelect:!0,tickSelectColor:"red",tickHoverColor:"blue",tickColor:"#888",showDates:!0,defaultMapLayer:map_default_layer,displayDivSticky:!0,showLayerToggle:!1,showLatLonLines:!1,showScaleLine:a,showLayerSwitcher:a,showLatLonPosition:!1,showZoomPanControl:!1,showZoomOnlyControl:!0,enableDragPan:!0,showSearch:!1,showBookmarks:!1,showBounds:!0,showOpacitySlider:!1,doPopup:!0,doPopupSlider:!1,popupWidth:400,popupHeight:250,popupSliderRight:!1,doSelect:!0,addMarkerOnClick:!1,linked:!1,linkGroup:null,linkMouse:!1,addToUrl:!0};Utils.isDefined(e.initialZoom)?debugBounds&&console.log("initial zoom already set:",e.initialZoom):(e.initialZoom=Utils.isDefined(e[ARG_ZOOMLEVEL])?e[ARG_ZOOMLEVEL]:MapUtils.defaults.defaultZoomLevel,debugBounds&&console.log("setting initial zoom:",e.initialZoom)),$.extend(s,e),e=this.params=s,this.getProperty=(t,e)=>Utils.isDefined(this.params[t])?this.params[t]:e,$.extend(this,{name:"map",map:null,sourceProjection:MapUtils.defaults.sourceProjection,displayProjection:MapUtils.defaults.displayProjection,projectionUnits:MapUtils.defaults.units,mapDivId:this.mapId,defaultLocation:null,latlonReadout:null,haveAddedDefaultLayer:!1,defaultCanSelect:!0,layer:null,markers:null,vectors:null,allLayers:[],externalLayers:[],loadedLayers:[],nonSelectLayers:[],shareSelected:!1,boxes:null,kmlLayer:null,kmlLayerName:null,geojsonlLayer:null,geojsonLayerName:null,vectorLayers:[],features:{},lines:null,selectorBox:null,selectorMarker:null,listeners:[],fixedText:!1,initialLayers:[],imageLayers:{},imageLayersList:[]}),this.seenMarkers={},this.startDate=null,this.endDate=null,this.startFeature=null,this.endFeature=null,this.basePointStyle=null,this.defaultStyle={pointRadius:this.params.pointRadius,fillOpacity:this.params.fillOpacity,fillColor:this.params.fillColor,fill:this.params.fill,strokeColor:this.params.strokeColor,strokeWidth:this.params.strokeWidth},this.highlightStyle={strokeColor:this.params.highlightStrokeColor,strokeWidth:this.params.highlightStrokeWidth,fillColor:this.params.highlightFillColor,fillOpacity:this.params.highlightFillOpacity},Utils.isDefined(e.onSelect)?this.onSelect=e.onSelect:this.onSelect=null,e.initialLocation?(Array.isArray(e.initialLocation)?this.defaultLocation=MapUtils.createLonLat(e.initialLocation[1],e.initialLocation[0]):this.defaultLocation=MapUtils.createLonLat(e.initialLocation.lon,e.initialLocation.lat),debugBounds&&console.log("setting default location:"+this.defaultLocation)):Utils.isDefined(e.initialBounds)&&("string"==typeof e.initialBounds&&(e.initialBounds=e.initialBounds.split(",")),this.defaultBounds=MapUtils.createBounds(e.initialBounds[1],e.initialBounds[2],e.initialBounds[3],e.initialBounds[0]),this.defaultLocation=null,debugBounds&&console.log("setting default bounds-1:"+this.defaultBounds));var o={projection:this.sourceProjection,displayProjection:this.displayProjection,units:this.projectionUnits,controls:[],maxResolution:156543.0339,maxExtent:MapUtils.defaults.maxExtent,div:this.mapDivId,zoom:this.params.initialZoom,eventListeners:{featureover:function(t){i.featureOverHandler?i.featureOverHandler(t):i.handleFeatureover(t.feature)},featureout:function(t){i.featureOutHandler?i.featureOutHandler(t):i.handleFeatureout(t.feature)},nofeatureclick:function(t){debugSelect&&console.log("nofeatureclick"),i.handleNofeatureclick(t,t.layer)},featureclick:function(t){if(debugSelect&&console.log("featureclick"),i.featureClickHandler&&!i.featureClickHandler(t))return;if(t.feature&&t.feature.noSelect)return;let e=(new Date).getTime();Utils.isDefined(i.lastClickTime)&&e-i.lastClickTime<500||(i.lastClickTime=e,i.handleFeatureclick(t.layer,t.feature,!1,t))}}};this.mapOptions=o,this.finishMapInit(),jQuery(document).ready((function(t){i.getMap()&&i.getMap().updateSize()}))}OpenLayers.Control.Click=OpenLayers.Class(OpenLayers.Control,{listeners:null,addListener:function(t){null==this.listeners&&(this.listeners=[]),this.listeners.push(t)},defaultHandlerOptions:{single:!0,double:!1,pixelTolerance:0,stopSingle:!1,stopDouble:!1},initialize:function(t){this.handlerOptions=$.extend({},this.defaultHandlerOptions),OpenLayers.Control.prototype.initialize.apply(this,arguments),this.handler=new OpenLayers.Handler.Click(this,{click:this.handleMapClick},this.handlerOptions)},setLatLonZoomFld:function(t,e,i,a,s){this.lonFldId=t,this.latFldId=e,this.zoomFldId=i,this.clickListener=a,this.onAlt=s},setTheMap:function(t){this.theMap=t},handleMapClick:function(t){if(this.onAlt){if(!t.altKey)return;let e=this.theMap;if(!e)return;e.fldSouth?.id&&jqid(e.fldSouth.id).val(""),e.fldEast?.id&&jqid(e.fldEast.id).val(""),this.theMap.selectorBox&&this.theMap.boxes&&(this.theMap.boxes.removeMarker(this.theMap.selectorBox),this.theMap.selectorBox=null)}let e=this.theMap.getMap().getLonLatFromViewPortPx(t.xy),i=this.theMap.transformProjPoint(e);if(null!=this.listeners)for(var a=0;a<this.listeners.length;a++)this.listeners[a](i);this.lonFldId||(this.lonFldId="lonfld",this.latFldId="latfld",this.zoomFldId="zoomfld");let s=this.theMap;if(s.polygonSelectorId)return void s.addPolygonSelectionPoint(i);let o=GuiUtils.getDomObject(this.lonFldId),r=GuiUtils.getDomObject(this.latFldId),l=GuiUtils.getDomObject(this.zoomFldId);r&&o&&(r.obj.value=MapUtils.formatLocationValue(i.lat),o.obj.value=MapUtils.formatLocationValue(i.lon)),l&&(l.obj.value=this.theMap.getMap().getZoom()),(this.theMap.getProperty("addMarkerOnClick")||this.theMap.selectorMarker)&&this.theMap.addSelectionMarker(i),Utils.isDefined(this.clickListener)&&this.clickListener.handleClick(this,t,i.lon,i.lat)}});var markerMap={};function ramaddaFindFeature(t,e){for(var i=0;i<t.features.length;i++){var a=t.features[i],s=a.geometry;if(s&&(bounds=s.getBounds(),bounds.contains(e.x,e.y)))if(s.components){for(var o=0;o<s.components.length;o++)if(comp=s.components[o],bounds=comp.getBounds(),bounds.contains(e.x,e.y)&&comp.containsPoint&&comp.containsPoint(e))return{feature:a,index:i}}else{if(!s.containsPoint){console.log("unknown geometry:"+s.CLASS_NAME);continue}if(s.containsPoint(e))return{feature:a,index:i}}}return null}RepositoryMap.prototype={firstCustomRegion:!0,CUSTOM_MAP:"CUSTOM",validBounds:function(t){return!!t&&!(isNaN(t.bottom)||isNaN(t.left)||isNaN(t.right)||isNaN(t.top))},centerOnMarkers:function(t,e,i){debugBounds&&console.log("centerOnMarkers: force="+e+" dflt:"+t+" justMarkers:"+i),this.centerOnMarkersCalled=!0,this.centerOnMarkersForce=e;Date.now();let a=null;if(t&&(t.left<-180||t.left>180||t.right<-180||t.right>180||t.bottom<-90||t.bottom>90||t.top<-90||t.top>90)&&(t=MapUtils.createBounds(-180,-90,180,90)),this.dfltBounds=t,!e){let t=!1;if(i||this.externalLayers.forEach((e=>{let i=e.getDataExtent();debugBounds&&console.log("centerOnMarkers using external layer"),a=MapUtils.extendBounds(a,this.transformProjBounds(i)),t=!0})),this.markers){let e=this.markers.getDataExtent();debugBounds&&console.log("centerOnMarkers using markers.getDataExtent"),a=MapUtils.extendBounds(a,this.transformProjBounds(e)),t=!0}if(a&&isNaN(a.left)&&(a=null),this.circles){let e=this.circles.getDataExtent(),i=this.transformProjBounds(e);a=MapUtils.extendBounds(a,i),t=!0,debugBounds&&console.log("centerOnMarkers using circles.getDataExtent:"+i)}if(a&&isNaN(a.left)&&(a=null),!a||!t||!i){if(this.lines){let t=this.lines.getDataExtent();a=MapUtils.extendBounds(a,this.transformProjBounds(t)),debugBounds&&console.log("centerOnMarkers using lines.getDataExtent")}for(let t in this.getMap().layers){if(t=this.getMap().layers[t],!t.getDataExtent)continue;if(t.isBaseLayer||!t.getVisibility())continue;let e=t.getDataExtent();if(e){let i=this.transformProjBounds(e);if(!this.validBounds(i))continue;a=MapUtils.extendBounds(a,i),debugBounds&&console.log("centerOnMarkers using layer.getDataExtent: "+i+" layer="+t.name+" "+t.ramaddaId)}}}}if(a||(debugBounds&&console.log("centerOnMarkers using dfltBounds: "+t),a=t),a){if(!this.getMap())return this.defaultBounds=a,void(debugBounds&&console.log("centerOnMarkers: no map"));a.getHeight()>160&&(a.top=80,a.bottom=-80,debugBounds&&console.log("centerOnMarkers resetting height")),debugBounds&&console.log("calling setViewToBounds: ",a),this.setViewToBounds(a)}else debugBounds&&console.log("centerOnMarkers: no bounds")},initRegionSelector:function(t,e,i){this.regionSelector=$("#"+t),this.mapWidgetDiv=$("#"+e),this.mapWidgetDiv.hide(),$(document).ready((()=>{this.regionSelector.val()!=this.CUSTOM_MAP?this.mapWidgetDiv.hide():this.initMap(i),this.regionSelector.change((()=>{this.mapRegionSelected()})),this.mapRegionSelected()}))},mapRegionSelected:function(){let t=this.regionSelector.val();if(null===t)return void console.log("Error: No map region value");if(""==t)return void this.toggleMapWidget(!1);let e=t.split(",");if(1==e.length)return e[0]!=this.CUSTOM_MAP?void 0:(this.firstCustomRegionm||this.setMapRegion("","","","",""),this.firstCustomRegion=!1,void this.toggleMapWidget(!0));5==e.length&&(this.toggleMapWidget(!1),this.setMapRegion(e[0],e[1],e[2],e[3],e[4]))},setMapRegion:function(t,e,i,a,s){let o=this.mapId;$("#"+o+"_regionid").val(t),$("#"+o+"_north").val(e),$("#"+o+"_west").val(i),$("#"+o+"_south").val(a),$("#"+o+"_east").val(s)},toggleMapWidget:function(t){t?(this.inited||this.initMap(!0),this.mapWidgetDiv.show()):this.mapWidgetDiv.hide()},setViewToBounds:function(t){t.left,t.right;let e=this.transformLLBounds(t);0==e.getWidth()?(debugBounds&&console.log("setViewToBounds single point max zoom:"+this.params.singlePointZoom),this.getMap().setCenter(e.getCenterLonLat()),this.zoomTo(this.params.singlePointZoom),this.getMap().setCenter(e.getCenterLonLat())):(this.getMap().setCenter(e.getCenterLonLat()),this.zoomToExtent(e)),this.getMap().getZoom()>this.params.maxZoom&&(debugBounds&&console.log("setViewToBounds- setting to max zoom",this.params.maxZoom),this.zoomTo(this.params.maxZoom))},setCenter:function(t){debugBounds&&console.log("setCenter"),this.getMap().setCenter(this.transformLLPoint(t))},getZoom:function(){return this.getMap().getZoom()},setZoom:function(t){this.zoomTo(t)},zoomTo:function(t,e){t<0&&(t=this.params.singlePointZoom),e&&t<this.getZoom()||(debugBounds&&console.log("zoomTo:",t),this.getMap().zoomTo(parseInt(t)))},zoomToLayer:function(t,e){let i=this.getLayerVisibleExtent(t);i||(i=t.extent),debugBounds&&console.log("zoomToLayer:",i),i&&(e&&(i=i.scale(parseFloat(e),i.getCenterPixel())),this.zoomToExtent(i,!1))},zoomToBounds:function(t){this.getMap().setCenter(t.getCenterLonLat()),this.zoomToExtent(t)},zoomToMarkers:function(){this.zoomToLayer(this.markers)},zoomToExtent:function(t,e){debugBounds&&console.log("zoomToExtent:",t);let i=t=>!isNaN(t)&&Utils.isDefined(t);if(i(t.left)&&i(t.right)&&i(t.top)&&i(t.bottom))if(t.left!=t.right&&t.top!=t.bottom)this.getMap().zoomToExtent(t,e);else{var a=(t=this.transformProjBounds(t)).getCenterLonLat();this.setCenter(a)}else debugBounds&&console.error("zoomToExtent: bounds are bad:",t)},centerToMarkers:function(){this.markers&&(bounds=this.markers.getDataExtent(),debugBounds&&console.log("centerToMarkers"),this.getMap().setCenter(bounds.getCenterLonLat()))},setInitialCenterAndZoom:function(t,e,i){this.defaultLocation=MapUtils.createLonLat(t,e),this.setInitialZoom(i),this.params.initialZoom=i},setInitialZoom:function(t){this.params.initialZoom=t,debugBounds&&console.log("setInitialZoom:",this.params.initialZoom)},setInitialCenter:function(t,e){this.defaultLocation=MapUtils.createLonLat(t,e)},finishMapInit:function(){let t=this;if(this.params.showSearch){this.searchDiv=this.mapDivId+"_search";let e=HtmlUtils.checkbox(this.searchDiv+"_download",[],!1),i="<table width=100%><tr><td>"+('<input placeholder="Search - ? for help" id="'+this.searchDiv+'_input" size=40>')+' <span  id="'+this.searchDiv+'_message"></span></td><td align=right>'+e+" Download</td></tr></table>";$("#"+this.searchDiv).html(i),this.searchMsg=$("#"+this.searchDiv+"_message");let a=$("#"+this.searchDiv+"_input");a.keypress((function(e){13==e.which&&t.searchFor(a.val())}))}let e=t=>this.mapDivId+"_"+t,i=HU.open("table",[STYLE,HU.css("height","100%"),WIDTH,"100%","border","0"]),a=HtmlUtils.div([CLASS,"ramadda-map-inner","style","width:100%;height:100%;position:relative;","id",e("themap")]);i+=HU.tr([STYLE,HU.css("height","100%")],HU.td([WIDTH,"100%"],a)),i+="</table>",$("#"+this.mapDivId).html(a),$("#"+e("themap")).append(HtmlUtils.div(["id",e("progress"),CLASS,"ramadda-map-progess","style","z-index:3000;position:absolute;top:10px;left:40%;"],"")),$("#"+e("themap")).append(HtmlUtils.div(["id",e("label"),"style","z-index:1000;position:absolute;bottom:10px;left:10px;"],"")),$("#"+e("themap")).append(HtmlUtils.div(["id",e("toolbar"),"style","z-index:1000;position:absolute;top:10px;left:50%;    transform: translateX(-50%);"],"")),this.map=new OpenLayers.Map(this.mapDivId+"_themap",this.mapOptions);setTimeout((function(){t.getMap().events.register("changebaselayer","",(function(){t.baseLayerChanged()})),t.getMap().events.register("zoomend","ramaddamap",(function(){t.zoomChanged(),t.locationChanged(),t.setNoPointerEvents(),debugBounds&&console.log("zoomend",t.getMap().getZoom())})),t.getMap().events.register("moveend","ramaddamap",(function(){t.locationChanged()})),t.getMap().events.register("move","ramaddamap",(function(){t.locationChanged()}))}),5e3),this.mapHidden&&(this.getMap().size=MapUtils.createSize(1,1));try{window.initExtraMap&&initExtraMap(this)}catch(t){console.log("Error calling initExtraMap:"+t)}if(this.addBaseLayers(),this.kmlLayer){var s=ramaddaBaseUrl+"/entry/show?output=shapefile.kml&entryid="+this.kmlLayer;this.addKMLLayer(this.kmlLayerName,s,!1,null,null,null,null)}if(this.geojsonLayer){s=getRamadda().getEntryDownloadUrl(this.geojsonLayer);this.addGeoJsonLayer(this.geojsonLayerName,s,!1,null,null,null,null)}setTimeout((()=>{let e="Image Opacity:&nbsp;"+HU.div([ID,this.mapDivId+"_opacity_slider_div",STYLE,HU.css("display","inline-block","width","150px")],"");e=HU.span(["id",this.mapDivId+"_opacity_slider","style",this.params.showOpacitySlider?"display:inline":"display:none"],e),$("#"+this.mapDivId+"_header").append(e),$("#"+this.mapDivId+"_opacity_slider_div").slider({min:0,max:1,step:.05,value:t.params.imageOpacity,slide:function(e,i){t.params.imageOpacity=i.value,t.imageLayersList&&(t.allLayers.forEach((e=>{Utils.isDefined(e.canTakeOpacity)&&e.setOpacity(t.params.imageOpacity)})),t.imageLayersList.forEach((e=>{e.setOpacity(t.params.imageOpacity)})))}})}),200),this.getProperty("addMarkerOnClick")&&this.setSelection(),setTimeout((()=>{let t=document.querySelector("#"+this.mapDivId+"_themap");t&&new ResizeObserver(Utils.throttle((()=>{if(this.getMap()){this.getMap().updateSize(),this.getMap().layers.filter((t=>t.isBaseLayer)).forEach((t=>{t.visibility&&t.redraw()}))}}),1e3)).observe(t)}),1e3)},showOpacitySlider:function(t){this.params.showOpacitySlider=t,t?$("#"+this.mapDivId+"_opacity_slider").css("display","inline"):$("#"+this.mapDivId+"_opacity_slider").css("display","none")},getBounds:function(){return this.transformProjBounds(this.getMap().getExtent())},zoomChanged:function(){},receiveShareState:function(t,e){if(e.center){if(!this.params.linked)return;this.getMap().setCenter(e.center,e.zoom)}else if(e.marker)this.params.addMarkerOnClick&&this.addSelectionMarker(e.marker,!0);else if(e.mouse){if(!this.params.linkMouse)return;this.sharedMouse&&this.getMarkersLayer().removeFeatures([this.sharedMouse],{silent:!0}),this.sharedMouse=this.addPoint("mouse",e.mouse,{},"")}},locationChanged:function(){ramaddaMapShareState(this,{center:this.map.getCenter(),zoom:this.map.getZoom()}),this.pendingLocationChangeTimeout&&clearTimeout(this.pendingLocationChangeTimeout),this.pendingLocationChangeTimeout=setTimeout((()=>{this.locationChangedInner(),this.pendingResizeTimeout=null}),500)},locationChangedInner:function(t){let e=this.getBounds(),i=1e5,a=t=>Math.round(t*i)/i;e.top=a(e.top),e.left=a(e.left),e.bottom=a(e.bottom),e.right=a(e.right);let s=this.transformProjPoint(this.getMap().getCenter());if(t)return console.log(e.top,e.left,e.bottom,e.right),console.log(this.getMap().getZoom()),void console.log(a(s.lat),a(s.lon));this.params.addToUrl&&(HU.addToDocumentUrl("map_bounds",e.top+","+e.left+","+e.bottom+","+e.right),HU.addToDocumentUrl(ARG_ZOOMLEVEL,this.getMap().getZoom()),HU.addToDocumentUrl(ARG_MAPCENTER,a(s.lat)+","+a(s.lon)))},baseLayerChanged:function(){let t=this.getMap().baseLayer;t&&(t=t.ramaddaId,HU.addToDocumentUrl("defaultMapLayer",t),ramaddaMapShareState(this,"baseLayer"))},appendToolbar:function(t){$("#"+this.mapDivId+"_toolbar").append(t)},setMapDiv:function(t){this.mapHidden=!1,this.mapDivId=t,this.getMap().render(this.mapDivId),this.getMap().updateSize(),this.centerOnMarkers(this.dfltBounds)},addPopup:function(t){this.currentPopup=t,this.getMap().addPopup(t)},makePopup:function(t,e,i){debugPopup&&console.log("makePopup:"+e),i=i||{};let a=MapUtils.createSize(i.width||this.params.popupWidth||200,i.height||this.params.popupHeight||200);return new OpenLayers.Popup("popup",t,a,e,!0,i.callback?i.callback:()=>{this.onPopupClose()})},highlightMarkers:function(t,e,i,a){let s=this;e||(e="#ffffcc");let o=$(t).find("[data-mapid]");o.mouseenter((function(t){e&&$(this).css("background",e);let i=$(this).data("mapid");if(!i)return;let a=s.findBox(i);a&&(a.setBorder("red"),s.boxes.drawMarker(a));let o=s.circleMarker(i,MapUtils.circleHiliteAttrs);o?t.shiftKey&&s.centerOnFeatures([o]):null!=i&&(Utils.isDefined($(this).data("latitude"))?(attrs={pointRadius:12,stroke:!0,strokeColor:"blue",strokeWidth:2,fill:!1},point=s.addPoint(i,MapUtils.createLonLat($(this).data("longitude"),$(this).data("latitude")),attrs),markerMap[i]=point):console.log("no lat"))})),o.mouseleave((function(){i?$(this).css("background",i):$(this).css("background","transparent");let t=$(this).data("mapid");if(!t)return;markerMap[t]&&(s.removePoint(markerMap[t]),markerMap[t]=null);let e=s.findBox(t);e&&(e.setBorder(e.defaultBorderColor),s.boxes.drawMarker(e)),s.uncircleMarker($(this).data("mapid"))}))},applyHighlightStyle:function(t){["pointRadius","highlightStrokeColor","highlightStrokeWidth","highlightFillColor","highlightFillOpacity"].forEach((e=>{if(Utils.isDefined(t[e])){let i=t[e];this.params[e]=i;let a=e.replace("highlight","");a=a.substring(0,1).toLowerCase()+a.substring(1),this.highlightStyle[a]=i}}))},getLayerHighlightStyle:function(t){let e=$.extend({},this.highlightStyle);return t.highlightStyle&&$.extend(e,t.highlightStyle),e},checkMatchStyle(t,e){["pointRadius","fillColor","fillOpacity","strokeColor","strokeOpacity","strokeWidth"].forEach((i=>{"match"==e[i]&&(Utils.stringDefined(t[i])?e[i]=t[i]:e[i]="transparent")}))},handleFeatureover:function(t,e){if(this.selectedFeature)return;if(this.doMouseOver||t.highlightText||t.highlightTextGetter){let e=t.location;if(e&&this.highlightFeature!=t){this.closeHighlightPopup();let i=t.highlightTextGetter?t.highlightTextGetter(t):t.highlightText;if(Utils.stringDefined(i)||(i=t.text),Utils.stringDefined(i)){let a=this.transformLLPoint(e);i=HtmlUtils.div(["style","padding:2px;"],i),this.highlightPopup=new OpenLayers.Popup("popup",a,t.highlightSize,i,!1),this.highlightPopup.backgroundColor=this.highlightBackgroundColor||"#ffffcc",this.highlightPopup.autoSize=!0,this.highlightPopup.keepInMap=!0,this.highlightPopup.padding=0,this.addPopup(this.highlightPopup)}}}let i=t.layer;if(!0===i.isMapLayer){if(!1!==i.canSelect&&!i.noHighlight&&!t.isSelected&&(this.highlightFeature(t),this.params.displayDiv&&(this.displayedFeature=t,!e))){this.pendingDisplayTextTimeout&&clearTimeout(this.pendingDisplayTextTimeout);let e=()=>{if(this.displayedFeature==t){let e=this.getFeatureText(i,t);this.showText(e),this.dateFeatureOver(t)}};this.pendingDisplayTextTimeout=setTimeout(e,500)}}else!e&&t.text&&this.showFeatureText(t)},unhighlightFeature:function(t){t.originalStyle&&(t.style=t.originalStyle,t.layer.drawFeature(t))},highlightFeature:function(t,e){let i=t.style;t.originalStyle||(t.originalStyle=$.extend({},t.style??{})),t.style=null;let a=t.layer,s=$.extend({},e??this.getLayerHighlightStyle(a));"transparent"!=s.fillColor&&"match"!=s.fillColor&&t.originalStyle&&(s.fillColor=Utils.brighterColor(t.originalStyle.fillColor||s.fillColor,.4)??s.fillColor),Utils.isDefined(s.fillOpacity)||(s.fillOpacity=.3),i=i??{},this.checkMatchStyle(i,s),i.strokeWidth&&(s.strokeWidth=+i.strokeWidth+1),Utils.stringDefined(i.externalGraphic)&&!Utils.stringDefined(s.externalGraphic)&&(s.externalGraphic=i.externalGraphic,i.graphicWidth&&(s.graphicWidth=1.3*i.graphicWidth),i.graphicHeight&&(s.graphicHeight=1.3*i.graphicHeight)),i.pointRadius&&!s.pointRadius&&(s.pointRadius=1.2*i.pointRadius),i.externalGraphic&&!s.externalGraphic&&(s.externalGraphic=i.externalGraphic,s.fillOpacity=1),t.layer.drawFeature(t,s)},closeHighlightPopup:function(){if(this.highlightPopup){this.getMap().removePopup(this.highlightPopup);try{this.highlightPopup.destroy()}catch(t){}this.highlightPopup=null,this.highlightFeature=null}},handleFeatureout:function(t,e){this.displayedFeature==t&&(this.displayedFeature=null,this.pendingDisplayTextTimeout&&clearTimeout(this.pendingDisplayTextTimeout),this.pendingDisplayTextTimeout=null),this.closeHighlightPopup();let i=t.layer;i&&!0!==i.isMapLayer?e||t.text&&!this.fixedText&&this.hideFeatureText(t):null!=i&&!1!==i.canSelect&&(t.originalStyle&&t.originalStyle.fillColor&&(t.style=t.originalStyle),t.isSelected||i.drawFeature(t,t.style||"default"),this.dateFeatureOut(t),e||this.displayedFeature!=t||this.fixedText||this.params.displayDivSticky||this.showText(""))},getLayerCanSelect:function(t){return!!t&&t.canSelect},handleNofeatureclick:function(t,e){if(Utils.isDefined(this.lastClickTime)){if((new Date).getTime()-this.lastClickTime<2e3)return}this.closePopup(),HtmlUtils.hidePopupObject(),!1!==e.canSelect&&e&&e.selectedFeature&&(this.unselectFeature(e.selectedFeature),this.clearDateFeature())},handleFeatureclick:function(t,e,i,a){if(t||(t=e.layer),debugPopup&&console.log("handleFeatureClick"),this.dateFeatureSelect(e),!1===t.canSelect)return void(debugPopup&&console.log("\tlayer no select"));if(t.selectedFeature&&this.unselectFeature(t.selectedFeature),!this.params.doSelect)return void(debugPopup&&console.log("\tparams no select"));this.selectedFeature=e,t.selectedFeature=e,t.selectedFeature.isSelected=!0;let s=e.style??{},o={};t.style&&$.extend(o,t.style),$.extend({},e.style);let r=e.originalStyle??e.style??{},l=this.getLayerHighlightStyle(t);if($.extend(o,{strokeColor:r.highlightStrokeColor??this.params.selectStrokeColor??l.strokeColor,strokeWidth:r.highlightStrokeWidth??this.params.selectStrokeWidth??l.strokeWidth,strokeOpacity:this.params.selectStrokeOpacity??.75,fillColor:r.highlightFillColor??this.params.selectFillColor??l.fillColor,fillOpacity:r.highlightFillOpacity??this.params.selectFillOpacity??l.fillOpacity,pointRadius:r.highlightPointRadius??this.params.selectPointRadius??l.pointRadius??s.pointRadius,fill:!0}),this.params.changeSizeOnSelect&&Utils.isDefined(o.pointRadius)&&(o.pointRadius=Math.round(1.5*o.pointRadius)),"transparent"!=o.fillColor&&(o.fillColor=this.params.selectFillColor||l.fillColor),"match"==o.fillColor&&(o.fillColor=o.strokeColor),this.checkMatchStyle(s,o),e.style&&e.style.externalGraphic&&(o=$.extend({},e.style),o.fillOpacity=.6,this.params.changeSizeOnSelect&&(Utils.isDefined(o.graphicHeight)&&(o.graphicHeight*=1.5,o.graphicYOffset=-o.graphicHeight/2),Utils.isDefined(o.graphicWidth)&&(o.graphicWidth*=1.5,o.graphicXOffset=-o.graphicWidth/2))),t.drawFeature(t.selectedFeature,o),t.selectCallback?(t.feature=t.selectedFeature,e.originalStyle&&(e.style=e.originalStyle),debugPopup&&console.log("\thave a selectCallback"),t.selectCallback(t.feature,t,a)):(debugPopup&&console.log("\tcalling showMarkerPopup"),this.showMarkerPopup(e,!0)),i){let t=e.geometry;if(t){let e=t.getBounds();e&&(this.zoomToExtent(e),this.getMap().setCenter(e.getCenterLonLat()))}}},unselectFeature:function(t){if(!t)return;t.renderIntent=null,t.isSelected=!1;let e=t.layer;e&&(e.drawFeature(e.selectedFeature,e.selectedFeature.style||"default"),e.selectedFeature.isSelected=!1,e.selectedFeature=null,this.selectedFeature=null,this.onPopupClose())},handleEntrySelect:function(t,e,i){if("geo_kml"!=i&&"geo_json"!=i&&"geo_shapefile"!=i)return null;var a;if("geo_kml"==i){var s=ramaddaBaseUrl+"/entry/get?entryid="+t;a=this.addKMLLayer(e,s,!0,null,null,null,null,!0)}else if("geo_json"==i){s=ramaddaBaseUrl+"/entry/get?entryid="+t;a=this.addGeoJsonLayer(e,s,!0,null,null,null,null,!0)}else{s=ramaddaBaseUrl+"/entry/show?output=shapefile.kml&entryid="+t;a=this.addKMLLayer(e,s,!0,null,null,null,null,!0)}return a},findLayer:function(t){for(var e=0;e<this.getMap().layers.length;e++)if(this.getMap().layers[e].ramaddaId==t)return this.getMap().layers[e];return null},addLayer:function(t,e){this.allLayers.push(t),t.initialVisibility=t.getVisibility(),null!=this.map?(this.getMap().addLayer(t),e?this.nonSelectLayers.push(t):this.loadedLayers.push(t),this.checkLayerOrder()):this.initialLayers.push(t)},toFrontLayer:function(t){Utils.toFront(this.nonSelectLayers,t),this.checkLayerOrder()},toBackLayer:function(t){Utils.toBack(this.nonSelectLayers,t),this.checkLayerOrder()},redraw:function(){this.getMap().layers.forEach((t=>{t.redraw()}))},checkLayerOrder:function(){let t=this.numberOfBaseLayers+100,e=!1;let i=!1,a=e=>{let a;a=e.ramaddaLayerIndex?e.ramaddaLayerIndex:t++,i||(i=e.theIndex!=a),e.theIndex=a,t=Math.max(t,a)};if(this.nonSelectLayers.forEach(a),this.loadedLayers.forEach(a),this.boxes&&a(this.boxes),this.lines&&a(this.lines),this.circles&&a(this.circles),this.markers&&a(this.markers),this.labelLayer&&a(this.labelLayer),i){let t=this.getMap().layers.filter((t=>!t.isBaseLayer)),e=this.getMap().layers.filter((t=>t.isBaseLayer));t.sort(((t,e)=>Utils.isDefined(t.theIndex)?Utils.isDefined(e.theIndex)?t.theIndex-e.theIndex:Utils.isDefined(t.theIndex)?1:-1:Utils.isDefined(e.theIndex)?-1:1)),e.push(...t),this.getMap().layers=e,this.getMap().resetLayersZIndex()}},addImageLayer:function(t,e,i,a,s,o,r,l,n,h,d,u,c){let p=this,g={forSelect:!1,addBox:!0,isBaseLayer:!1,alwaysInRange:!0};u&&$.extend(g,u),o>88&&(o=88),l<-88&&(l=-88);let f=MapUtils.createBounds(r,l,n,o),m=this.transformLLBounds(f),y=MapUtils.createLayerImage(e,a,m,MapUtils.createSize(h,d),{numZoomLevels:3,isBaseLayer:g.isBaseLayer,alwaysInRange:g.alwaysInRange,displayOutsideMaxExtent:!0,resolutions:this.getMap().layers[0]?this.getMap().layers[0].resolutions:null,maxResolution:this.getMap().layers[0]?this.getMap().layers[0].resolutions[0]:null});y.events.on({loadend:function(t){c&&c(p,y)}}),y.id=t,y.latLonBounds=f,g.forSelect&&(this.selectImage=y);let L=MapUtils.createLonLat(r,o);return y.lonlat=this.transformLLPoint(L),y.setVisibility(s),y.id=t,y.text=this.getPopupText(i),y.ramaddaId=t,y.ramaddaName=e,this.addLayer(y,!0),y.north=o,y.west=r,y.south=l,y.east=n,y.opacity=this.params.imageOpacity,this.imageLayers||(this.imageLayers={}),g.isBaseLayer||(this.imageLayers[t]=y,this.imageLayersList.push(y)),this.noPointerEventsLayers||(this.noPointerEventsLayers=[]),this.noPointerEventsLayers.push(y),this.setNoPointerEvents(),y},setNoPointerEvents:function(){this.noPointerEventsLayers&&setTimeout((()=>{this.noPointerEventsLayers.forEach((t=>{if(t.div)for(var e=t.div.childNodes,i=0,a=e.length;i<a;++i){var s=e[i].firstChild||e[i],o=e[i].lastChild;o&&"iframe"===o.nodeName.toLowerCase()&&(s=o.parentNode),s.style["pointer-events"]="none"}}))}),1e3)},addWMSLayer:function(t,e,i,a,s,o){o||(o={});let r={wrapDateLine:MapUtils.defaults.wrapDateline};o.opacity&&(r.opacity=o.opacity);i=MapUtils.createLayerWMS(t,e,{layers:i,format:"image/png",isBaseLayer:!1,srs:"epse:4326",transparent:!0},r);return a?(i.isBaseLayer=!0,i.visibility=!1):(i.isBaseLayer=!1,i.visibility=o.visible),this.addLayer(i,s),i},addMapLayer:function(t,e,i,a,s){(i=/\/tile\//.exec(e)?MapUtils.createLayerXYZ(t,e,{sphericalMercator:MapUtils.defaults.doSphericalMercator,numZoomLevels:MapUtils.defaults.zoomLevels,wrapDateLine:MapUtils.defaults.wrapDateline}):MapUtils.createLayerWMS(t,e,{layers:i,format:"image/png"},{wrapDateLine:MapUtils.defaults.wrapDateline})).isBaseLayer=!!a,i.visibility=!1,i.reproject=!0,this.addLayer(i),s&&(this.haveAddedDefaultLayer=!0,this.getMap().setLayerIndex(i,0),this.getMap().setBaseLayer(i))},getMapLayer:function(t){return RAMADDA_MAP_LAYERS_MAP[t]?.layer},getVectorLayerStyleMap:function(t,e,i){let a={pointRadius:this.params.pointRadius,fillOpacity:this.params.fillOpacity,fillColor:this.params.fillColor,fill:this.params.fill,strokeColor:this.params.strokeColor,strokeWidth:this.params.strokeWidth,select_fillOpacity:this.params.fillOpacity,select_fillColor:"#666",select_strokeColor:"#666",select_strokeWidth:1};e&&$.extend(a,e);let s=$.extend({},MapUtils.getVectorStyle("temporary"));$.extend(s,a);let o=$.extend({},MapUtils.getVectorStyle("select"));$.extend(o,{pointRadius:3,fillOpacity:a.select_fillOpacity,fillColor:a.select_fillColor,strokeColor:a.select_strokeColor,strokeWidth:a.select_strokeWidth,externalGraphic:a.externalGraphic});let r=$.extend({},MapUtils.getVectorStyle("default"));$.extend(r,{pointRadius:a.pointRadius,fillOpacity:a.fillOpacity,fillColor:a.fillColor,fillPattern:a.fillPattern,fill:a.fill,strokeColor:a.strokeColor,strokeWidth:a.strokeWidth,externalGraphic:a.externalGraphic});let l=MapUtils.createStyleMap({temporary:s,default:r,select:o});i=i||this.getProperty("rules");let n=[];if(Utils.isDefined(i)){if(!Array.isArray(i)){let t=[];Utils.split(i,";",!0,!0).forEach((e=>{let i=Utils.split(e,":");if(i.length<3)return void console.log("bad rule:"+e);let a={property:i[0],type:i[1],value:i[2],style:{}};for(let t=3;t<i.length;t+=2)a.style[i[t]]=i[t+1];t.push(a)})),i=t}n=i}if(n.length>0){let t=[];n.forEach((e=>{let i=$.extend({},r),a=e.style;if("string"==typeof a){let t={};Utils.split(a,"\n",!0,!0).forEach((e=>{let i=Utils.split(e,":",!0,!0);2==i.length&&(t[i[0]]=i[1])})),a=t}i=$.extend(i,a),e.value=String(e.value??"");let s=e.value.match(/^\d*\.?\d*$/),o=("~="==e.type||e.type,{property:e.property,type:e.type});if(e.type==OpenLayers.Filter.Comparison.BETWEEN){let t=Utils.split(String(e.value),":",!0,!0);2==t.length&&(o.lowerBoundary=+t[0],o.upperBoundary=+t[1])}else o.value=s?+e.value:e.value;let l=new OpenLayers.Rule({filter:new OpenLayers.Filter.Comparison(o),symbolizer:i});t.push(l)})),t.push(new OpenLayers.Rule({elseFilter:!0,symbolizer:e}));new OpenLayers.Rule({filter:new OpenLayers.Filter.Comparison,symbolizer:e});l.styles.default.addRules(t)}return l},getFeatureName:function(t){var e=t.attributes;for(var i in e){if((""+i).toLowerCase().includes("label"))if(a=this.getAttrValue(e,i))return a}for(var i in e){var a;if((""+i).toLowerCase().includes("name"))if(a=this.getAttrValue(e,i))return a}},getAttrValue:function(t,e){let i="";if("object"==typeof t[e]||"Object"==typeof t[e]){let a=t[e];a&&(i=""+a.value)}else i=""+t[e];return i},searchFor:function(t){t&&(t=t.trim()),""==t&&(t=null),this.searchText=t;let e=null,i=!1,a=$("#"+this.searchDiv+"_download").is(":checked"),s=[],o=!0;if(t){"?"==(t=t.trim())&&(i=!0),e=[];let a=(t=t.toLowerCase()).split("|");1==a.length&&(a=t.split("&"),o=1==a.length);for(let t=0;t<a.length;t++){let i=!1,s=!1,o=a[t],r=o.split(":"),l="",n=o;r.length>1&&(l=r[0],n=r[1]),n.startsWith("!")&&(i=!0,n=n.substring(1)),n.startsWith("=")&&(n=n.substring(1),s=!0),e.push({field:l,value:n,not:i,equals:s})}}else this.searchMsg.html("");for(let r in this.loadedLayers){let l=this.loadedLayers[r];l.selectedFeature&&this.handleNofeatureclick(null,l);for(let a in l.features){let r=l.features[a],n=r.attributes;if(!t){r.featureVisibleSearch=!0,s.push(n);continue}if(i){let t="&nbsp;&nbsp;&nbsp;",e="Enter, e.g.:<br>";e+=t+"<i>&lt;term&gt;</i> (any match)<br>",e+=t+"<i>=&lt;term&gt;</i> (exact match)<br>",e+=t+"<i>!&lt;term&gt;</i> (not match)<br>",e+=t+"<i>&lt;term 1&gt;|&lt;term 2&gt;</i> (match any)<br>",e+=t+"<i>&lt;term 1&gt;&amp;&lt;term 2&gt;</i> (match all)<br>",e+="Or by field:<br>";for(let i in n)e+=t+i.toLowerCase()+":<i>&lt;term&gt;</i><br>";return void this.showText(e)}let h=!1,d=!0,u=!1;for(let t in e){let i=e[t];for(let t in n){if(""!=i.field&&i.field!=t.toLowerCase())continue;let e=this.getAttrValue(n,t);if(e=e.toLowerCase().trim(),h=i.equals?e==i.value:e.includes(i.value),i.not){if(h=!h,!h)break}else if(h)break}h&&(u=!0),h||(d=!1)}o&&u||!o&&d?(r.featureVisibleSearch=!0,this.getFeatureVisible(r)&&s.push(n)):r.featureVisibleSearch=!1}if(this.centerOnMarkers(),a){let t="";for(let e in s){let i=s[e];for(let e in i)""!=t&&(t+=","),t+=e.toLowerCase();t+="\n";break}for(let e in s){let i=s[e],a="";for(let t in i){let e=this.getAttrValue(i,t);e.includes(",")&&(e='"'+e+'"'),""!=a&&(a+=","),a+=e}a+="\n",t+=a}Utils.makeDownloadFile("download.csv",t)}this.setFeatureVisibility(l)}},checkFeatureVisible:function(t,e,i){let a=t.layer,s=this.getFeatureVisible(t);if(t.ramaddaId){this.getVisibilityCheckbox(t.ramaddaId).prop("checked",s)}t.originalStyle&&(t.style=t.originalStyle);let o=t.style;if(!o){o={};let e=a?a.styleMap.styles.default.defaultStyle:{};$.extend(o,e),t.style=o}return o.display=s?"inline":"none",e&&(t.isSelected||(t.renderIntent=null),a&&a.drawFeature(t,t.style||"default")),s},getFeatureVisible:function(t){let e=!0;return Utils.isDefined(t.featureVisibleSearch)&&!t.featureVisibleSearch&&(e=!1),Utils.isDefined(t.featureVisibleDate)&&!t.featureVisibleDate&&(e=!1),Utils.isDefined(t.featureVisible)&&!t.featureVisible&&(e=!1),e},setFeatureVisibility:function(t){if(!t.features)return;let e=this,i=this.searchText||this.startDate&&this.endDate,a=null,s="",o=!1,r=!1,l=0,n=null;for(let e=0;e<t.features.length;e++){let i=t.features[e];if(this.checkFeatureVisible(i,!1)){this.dateFeatureSelect(i),o=!0,l++,n||(n=i),s+=HtmlUtils.div(["class","ramadda-map-feature","feature-index",""+e],this.getFeatureName(i));let t=i.geometry;if(t){let e=t.getBounds();a?a.extend(e):a=e}}else this.clearDateFeature(i),r=!0}if(1==l)this.showText(this.getFeatureText(t,n));else if(i||o&&r){let i=this.mapDivId+"_features";this.showText(HtmlUtils.div(["id",i,"class","ramadda-map-features"],s)),$("#"+i+" .ramadda-map-feature").click((function(i){let a=parseInt($(this).attr("feature-index"));e.handleFeatureclick(t,t.features[a],!0)})),$("#"+i+" .ramadda-map-feature").mouseover((function(){let i=parseInt($(this).attr("feature-index"));e.handleFeatureover(t.features[i],!0)})),$("#"+i+" .ramadda-map-feature").mouseout((function(){let i=parseInt($(this).attr("feature-index"));e.handleFeatureout(t.features[i],!0)}))}else this.clearDateFeature(),this.params.displayDivSticky||this.showText("");this.searchMsg&&(i?this.searchMsg.html(l+" matched"):this.searchMsg.html("")),t.redraw(),a?(this.zoomToExtent(a),this.getMap().setCenter(a.getCenterLonLat())):this.centerOnMarkers(this.dfltBounds,this.centerOnMarkersForce)},getFeatureText:function(t,e){if(e.textGetter){let t=e.textGetter(e);if(t)return debugPopup&&console.log("getFeatureText-feature has textGetter:"),t}if(t.textGetter){let i=t.textGetter(e);if(i)return debugPopup&&console.log("getFeatureText-layer has textGetter"),i}if(this.textGetter){let i=this.textGetter(t,e);if(i)return debugPopup&&console.log("getFeatureText-map has textGetter:"+this.textGetter),i}let i=e.style||e.originalStyle||t.style,a=e.attributes,s=e.popupText??e.text;if(!s)if(i&&(i.balloonStyle||i.popupText)){s=i.balloonStyle||i.popupText;for(let t in a){MapUtils.makeLabel(t);let e="";if("object"==typeof a[t]||"Object"==typeof a[t]){let i=a[t];e=""+(i?i.value:"")}else e=""+a[t];let o=t.toLowerCase();s=s.replace("${"+i.id+"/"+t+"}",e).replace("${"+t+"}",e).replace("${"+o+"}",e)}}else debugPopup&&console.log("getFeatureText-using feature attributes"),s=t.textGetter?t.textGetter(e):MapUtils.makeDefaultFeatureText(a);return s&&s.indexOf("${default}")>=0&&(s=s.replace("${default}",MapUtils.makeDefaultFeatureText(a))),s},onFeatureSelect:function(t,e){debugPopup&&console.log("\tonFeatureSelect");if(this.onSelect)return func=window[this.onSelect],func(this,t),void(debugPopup&&console.log("\thas onSelect"));let i=t.feature;if(this.featureSelectHandler&&this.featureSelectHandler(i))return void(debugPopup&&console.log("\thas featureSelectHandler"));if(!this.getDoPopup())return;let a=this.getFeatureText(t,i);if(!a)return void(debugPopup&&console.log("\tno feature text"));debugPopup&&console.log("\thas feature text"),this.currentPopup&&(this.getMap().removePopup(this.currentPopup),this.currentPopup.destroy(),this.currentPopup=null);let s=null;if(e&&e.event&&e.event.xy&&(s=this.getMap().getLonLatFromPixel(e.event.xy)),null==s&&(s=i.geometry.getBounds().getCenterLonLat()),this.showPopupSlider(s,a))return;let o=this.makePopup(s,a);i.popup=o,o.feature=i,this.addPopup(o)},onFeatureUnselect:function(t){this.onPopupClose()},removeKMLLayer:function(t){this.removeLayer(t)},removeLayer:function(t,e){this.externalLayers=Utils.removeItem(this.externalLayers,t),this.allLayers=Utils.removeItem(this.allLayers,t),this.nonSelectLayers&&(this.nonSelectLayers=Utils.removeItem(this.nonSelectLayers,t)),this.loadedLayers&&(this.loadedLayers=Utils.removeItem(this.loadedLayers,t)),this.imageLayersList&&(this.imageLayersList=Utils.removeItem(this.imageLayersList,t)),e||this.getMap().removeLayer(t)},setDefaultCanSelect:function(t){this.defaultCanSelect=t},getCanSelect:function(t){return void 0===t||null==t?this.defaultCanSelect:t},addSelectCallback:function(t,e,i,a){let s=this;this.getCanSelect(e)&&(null!=i&&Utils.isDefined(i)||(i=function(t,e,i){return s.onFeatureSelect(e,i)}),null!=a&&Utils.isDefined(a)||(a=function(t,e,i){return s.onFeatureUnselect(e,i)}),t.selectCallback=i,t.unselectCallback=i)},initDates:function(t){let e=this,i=t.features,a=!1,s=!1;this.hasDates=!1,this.dates=[],this.dateFeatures=[],this.minDate=null,this.maxDate=null;for(let t=0;t<i.length;t++){let e=i[t],o=e.attributes;for(let t in o){let i=(""+t).toLowerCase(),r=i.includes("year")||i.includes("_yr");if(!i.includes("date")&&!r)continue;let l=this.getAttrValue(o,t);if(l&&"0"!=l)try{let t=Utils.parseDate(l);if(t&&isNaN(t.getTime()))continue;if(r?s=!0:a=!0,null!=this.startDate&&null!=this.endDate&&(t.getTime()<this.startDate.getTime()||t.getTime()>this.endDate.getTime()))continue;this.dates.push(t),this.dateFeatures.push(e),this.minDate=null==this.minDate||this.minDate.getTime()>t.getTime()?t:this.minDate,this.maxDate=null==this.maxDate||this.maxDate.getTime()<t.getTime()?t:this.maxDate,e.featureDate=t,this.hasDates=!0;break}catch(t){console.log("error:"+t)}}}if(this.hasDates&&this.params.showDates){let i=null;s&&(i={year:"numeric"}),$("#"+this.mapDivId+"_footer").html(HtmlUtils.div(["class","ramadda-map-animation","id",this.mapDivId+"_animation"],"")),this.animation=$("#"+this.mapDivId+"_animation");let a=HtmlUtils.div(["class","ramadda-map-animation-ticks","id",this.mapDivId+"_animation_ticks"],""),o=HtmlUtils.div(["class","ramadda-map-animation-info","id",this.mapDivId+"_animation_info"],"");this.animation.html(a+o);let r=Utils.formatDate(this.minDate,i),l=Utils.formatDate(this.maxDate,i);this.animationTicks=$("#"+this.mapDivId+"_animation_ticks"),this.animationInfo=$("#"+this.mapDivId+"_animation_info");let n="";this.startDate&&this.endDate&&(n=HtmlUtils.div(["id",this.mapDivId+"_ticks_reset","class","ramadda-map-animation-tick-reset"],"Reset"));let h="<table width=100%><tr valign=top><td width=40%>"+r+"</td><td align=center width=20%>"+n+"</td><td align=right width=40%>"+l+"</td></tr></table>";if(this.animationInfo.html(h),this.startDate&&this.endDate){$("#"+this.mapDivId+"_ticks_reset").click((function(){e.startDate=null,e.endDate=null,e.startFeature=null,e.endFeature=null,e.setFeatureDateRange(t,"Resetting range...")}))}let d=this.animationTicks.width(),u=d>0?5/d:0,c="",p=this.minDate.getTime(),g=this.maxDate.getTime();null!=this.startDate&&null!=this.endDate&&(p=this.startDate.getTime(),g=this.endDate.getTime());let f=g-p;if(f>0)for(let t=0;t<this.dates.length;t++){let e=this.dates[t],a=e.getTime();if(a<p||a>g)continue;let s=this.dateFeatures[t];s.dateIndex=t;let o=100*(a-p)/f;o-=o*u,i||(i={});let r=e.toLocaleDateString("en-US",i),l=Utils.camelCase(this.getFeatureName(s)),n="";n+=null!=l?l+"<br>":"",n+=r,n+="<br>shift-click: set visible range<br>cmd/ctrl-click:zoom",n+="",c+=HtmlUtils.div(["id",this.mapDivId+"_tick"+t,"feature-index",""+t,"style","left:"+o+"%","class","ramadda-map-animation-tick","title",n],"")}this.animationTicks.html(c);let m=$("#"+this.mapDivId+"_animation .ramadda-map-animation-tick");m.tooltip({content:function(){return $(this).prop("title")},position:{my:"left top",at:"left bottom+2"},classes:{"ui-tooltip":"ramadda-popup"}}),m.mouseover((function(){let t=parseInt($(this).attr("feature-index")),i=e.dateFeatures[t];e.handleFeatureover(i,!0)})),m.mouseout((function(){let t=parseInt($(this).attr("feature-index")),i=e.dateFeatures[t];e.handleFeatureout(i,!0)})),m.click((function(t){let i=parseInt($(this).attr("feature-index")),a=e.dateFeatures[i];if(t.shiftKey){if(null==e.startDate?(e.startDate=a.featureDate,e.startFeature=a,e.dateFeatureSelect(a)):null==e.endDate?(e.endDate=a.featureDate,e.endFeature=a,e.dateFeatureSelect(a)):(e.dateFeatureSelect(null),e.startDate=a.featureDate,e.startFeature=a,e.endDate=null,e.endFeature=null,e.dateFeatureSelect(a)),null!=e.startDate&&null!=e.endDate){if(e.startDate.getTime()==e.endDate.getTime())return e.startDate=null,e.startFeature=null,e.endDate=null,e.endFeature=null,void e.dateFeatureSelect(null);if(e.startDate.getTime()>e.endDate.getTime()){let t=e.startDate;e.startDate=e.endDate,e.endDate=t,t=e.startFeature,e.startFeature=e.endFeature,e.endFeature=t}e.setFeatureDateRange(a.layer)}}else{let i=t.metaKey||t.ctrlKey;null==e.startDate&&null==e.endDate||(e.startDate=null,e.endDate=null),e.clearDateFeature(),e.handleFeatureclick(a.layer,a,i)}}))}},setFeatureDateRange:function(t,e){this.dateFeatureSelect(null),e||(e="Setting range..."),this.animationTicks.html(e),setTimeout((()=>this.setFeatureDateRangeInner(t)),100)},setFeatureDateRangeInner:function(t){let e=t.features;t.selectedFeature&&this.unselectFeature(t.selectedFeature);for(let t=0;t<e.length;t++){let i=e[t];this.startDate&&this.endDate&&i.featureDate?i.featureVisibleDate=this.startDate.getTime()<=i.featureDate.getTime()&&i.featureDate.getTime()<=this.endDate.getTime():i.featureVisibleDate=!0}this.setFeatureVisibility(t),this.initDates(t)},dateFeatureSelect:function(t){let e=this.getFeatureTick(t);e.css("background-color",this.params.tickSelectColor),e.css("zIndex","100")},dateFeatureOver:function(t){this.closeTicks();let e=this.getFeatureTick(t);e.css("background-color",this.params.tickHoverColor),e.css("zIndex","100"),this.tickOpen&&this.tickOpen.tooltip("close"),this.tickOpen=e,e.tooltip("open")},dateFeatureOut:function(t){this.closeTicks();let e=this.getFeatureTick(t);!t||t!=this.startFeature&&t!=this.endFeature?(e.css("background-color",""),e.css("zIndex","0")):(e.css("background-color",this.params.tickSelectColor),e.css("zIndex","0")),this.tickOpen=null},closeTicks:function(){let t=this.getAllTicks();t.tooltip("close"),t.css("background-color","")},getAllTicks:function(){return jqid(this.mapDivId+"_animation_ticks").find(".ramadda-map-animation-tick")},getFeatureTick:function(t){return t?$("#"+this.mapDivId+"_tick"+t.dateIndex):$("#"+this.mapDivId+"_animation_ticks .ramadda-map-animation-tick")},clearDateFeature:function(t){let e=null!=t?$("#"+this.mapDivId+"_tick"+t.dateIndex):$("#"+this.mapDivId+"_animation_ticks .ramadda-map-animation-tick");e.css("background-color",""),e.css("zIndex","0")},initMapVectorLayer:function(t,e,i,a,s,o,r,l){let n=this;t.visibility&&this.showLoadingImage(!0),t.isMapLayer=!0,t.canSelect=i,this.loadedLayers.push(t),t.events.on({loadend:function(i){if(n.hideLoadingImage(!0),i.response&&Utils.isDefined(i.response.code)&&i.response.code==OpenLayers.Protocol.Response.FAILURE)l?l(e,i.response):console.log("An error occurred loading the map:"+e+"\n"+JSON.stringify(i.response,null,2));else{if(r){let e=t.getDataExtent();e&&n.zoomToExtent(e,!0)}else n.centerOnMarkersCalled&&(n.dfltBounds||n.centerOnMarkers(n.dfltBounds,n.centerOnMarkersForce));o&&o(n,t),1==t.features.length&&n.params.displayDiv&&(n.fixedText=!0,n.showText(n.getFeatureText(t,t.features[0]))),n.initDates(t)}}}),this.addLayer(t),this.addSelectCallback(t,i,a,s)},getLayerProperty:function(t,e,i,a,s){let o=Utils.makeId(a);return this.getProperty(e+"_"+o,this.getProperty(e+i,this.getProperty(e,s)))},addMapFileLayer:function(t,e,i,s,o,r,l,n,h,d){let u=this.loadedLayers.length+1,c={strokeColor:this.getLayerProperty(t,"layerStrokeColor",u,i,"blue"),strokeWidth:this.getLayerProperty(t,"layerStrokeWidth",u,i,1),fillColor:this.getLayerProperty(t,"layerFillColor",u,i,"#ccc"),fillOpacity:this.getLayerProperty(t,"layerFillOpacity",u,i,.4)},p={};for(a in $.extend(p,this.highlightStyle),p){let e=String(a);e="highlight"+e.substring(0,1).toUpperCase()+e.substring(1),p[a]=this.getLayerProperty(t,e,u,i,p[a])}return t.highlightStyle=p,this.getLayerProperty(t,"noHighlight",u,i,!1)&&(t.noHighlight=!0),l=l||{},$.extend(c,l),t.styleMap=this.getVectorLayerStyleMap(t,c),this.checkLayerToggle(i,t,u,c),this.initMapVectorLayer(t,e,s,o,r,n,h,d),t},addGpxLayer:function(t,e,i,a,s,o,r,l,n){let h=MapUtils.createLayerGPX(this,t,e);return this.addMapFileLayer(h,e,t,i,a,s,o,r,l,n),h},printLayers:function(t){console.log(t),this.getMap().layers.forEach((t=>{t.name.indexOf("Cb")>=0&&console.log("\t"+t.name)}))},addGeoJsonLayer:function(t,e,i,a,s,o,r,l,n){let h=MapUtils.createLayerGeoJson(this,t,e);return this.addMapFileLayer(h,e,t,i,a,s,o,r,l,n),h},addKMLLayer:function(t,e,i,a,s,o,r,l,n){if(e.match(".kmz")){let t=$("<div  class=ramadda-map-message>Note: KMZ files are not supported</div>")[0];return void this.getMap().viewPortDiv.appendChild(t)}let h=MapUtils.createLayerKML(this,t,e);return this.addMapFileLayer(h,e,t,i,a,s,o,r,l,n),h},checkLayerToggle:function(t,e,i,a){let s=this.getLayerProperty(e,"layerVisible",i,t,!0);if(s||e.setVisibility(!1),this.params.showLayerToggle){let o=Utils.addAlphaToColor(a.fillColor,.4),r=HU.span([],HtmlUtils.checkbox(this.mapDivId+"_layertoggle"+i,["title","Toggle Layer"],s,t))+" ";r=HU.span([STYLE,HU.css("margin-right","5px","padding","5px","background",o)],r),$("#"+this.mapDivId+"_header").append(" "+r),$("#"+this.mapDivId+"_layertoggle"+i).change((function(){$(this).is(":checked")?e.setVisibility(!0):e.setVisibility(!1)}))}},createXYZLayer:function(t,e,i,a,s){s=Utils.getBoolean(s);let o={sphericalMercator:MapUtils.defaults.doSphericalMercator,numZoomLevels:MapUtils.defaults.zoomLevels,wrapDateLine:MapUtils.defaults.wrapDateline,isBaseLayer:!a,visibility:s};return i&&(o.attribution=i),MapUtils.createLayerXYZ(t,e,o)},addBaseLayers:function(){this.mapLayers=Utils.mergeLists([],RAMADDA_MAP_LAYERS);let t=this.params.defaultMapLayer||"osm";if(!this.haveAddedDefaultLayer&&t){let e=-1,i=this.mapLayers.find(((i,a)=>{if(i.id==t)return e=a,!0}));e>=0&&(this.mapLayers.splice(e,1),this.mapLayers.splice(0,0,i))}this.firstLayer=null,this.hybridLayer=null,this.defaultOLMapLayer=null,this.baseLayers={},this.numberOfBaseLayers=0;let e="";for(let t=0;t<this.mapLayers.length;t++){let i=this.mapLayers[t];if(!i.isForMap())continue;let a=this.makeMapLayer(i);null==this.firstLayer&&(this.firstLayer=a),null!=a&&(""!=e&&(e+=","),e+=i.id+":"+a.name,a.ramaddaId=i.id,a.isBaseLayer?(this.baseLayers[i.id]=a,i.id==this.params.defaultMapLayer&&(this.defaultOLMapLayer=a),this.addBaseLayer(a)):this.addLayer(a))}this.graticule=this.createGraticule({strokeColor:"#888",strokeWidth:2,strokeOpacity:.5}),this.getMap().addControl(this.graticule)},createGraticule:function(t){return MapUtils.createGraticule({layerName:"Lat/Lon Lines",lineSymbolizer:t,xautoActivate:!1,numPoints:2,labelled:!0,visible:!0===this.params.showLatLonLines,renderers:["VML","SVG"]})},makeMapLayer:function(t){let e;if(e="string"==typeof t?RAMADDA_MAP_LAYERS_MAP[t]:t,e){let t=e.createMapLayer(this);if(e.opts.alias&&(this.baseLayers[e.opts.alias]=t),e.opts.refresh){let i=()=>{t.getVisibility()&&t.redraw(!0),setTimeout(i,1e3*e.opts.refresh)};setTimeout(i,1e3*e.opts.refresh)}return t}if(/\/tile\//.exec(t)){let e=t;return MapUtils.createLayerXYZ("ESRI China Map",e,{sphericalMercator:MapUtils.defaults.doSphericalMercator,numZoomLevels:MapUtils.defaults.zoomLevels,wrapDateLine:MapUtils.defaults.wrapDateline})}{let e=/wms:(.*),(.*),(.*)/.exec(t);return e?this.addWMSLayer(e[1],e[2],e[3],!0):(console.log("no match for map layer:"+t),null)}},setShowOverviewMap:function(t,e){if(!t)return this.overviewMap&&this.overviewMap.destroy(),void(this.overviewMap=null);if(!this.overviewMap){let t={maximized:!0,autoPan:!0};e&&$.extend(t,e),this.getMap().addControl(this.overviewMap=new OpenLayers.Control.OverviewMap(t))}},setGraticulesVisible:function(t,e){this.params.showLatLonLines=t,this.graticule&&(e&&(this.graticule.gratLayer.visibility=t,this.graticule.deactivate(),this.graticule.gratLayer.redraw(),this.getMap().removeControl(this.graticule),this.graticule=this.createGraticule(e),this.getMap().addControl(this.graticule)),this.graticule.gratLayer.visibility=t,t?this.graticule.activate():this.graticule.deactivate(),this.graticule.gratLayer.redraw())},addBaseLayer:function(t){this.addLayer(t),this.numberOfBaseLayers++},getBaseLayer:function(t){if(this.baseLayers)return this.baseLayers[t]},makeSimpleWms:function(t){let e="/repository/wms?version=1.1.1&request=GetMap&layers="+t+"&FORMAT=image%2Fpng&SRS=EPSG%3A4326&BBOX=-180.0,-80.0,180.0,80.0&width=400&height=400";return this.addWMSLayer(Utils.makeLabel(t)+" background",e,t,!0)},initSearch:function(t){let e=this;$("#"+t).keyup((function(i){13==i.keyCode&&e.searchMarkers($("#"+t).val())}))},getVisibilityCheckbox:function(t){let e=$("#visible_"+this.mapId+"_"+t);return 0==e.length&&(e=$("#visible_"+this.mapId+"_"+t.replace(/-/g,"_"))),e},searchMarkers:function(t){let e=""==(t=(t=t.trim()).toLowerCase());$(':input[id*="visibleall_'+this.mapId+'"]').prop("checked",e);let i=MapUtils.createBounds(),a=0;if(this.markers){let s=this.getMarkers();for(let o=0;o<s.length;o++){marker=s[o];let r=!0,l=this.getVisibilityCheckbox(marker.ramaddaId),n=$("#block_"+this.mapId+"_"+marker.ramaddaId),h=marker.name;r=!!e||!!Utils.isDefined(h)&&h.toLowerCase().includes(t),r?(marker.style.display="inline",marker.location&&i.extend(marker.location),a++):marker.style.display="none",r?n.show():n.hide(),l.prop("checked",r)}this.markers.redraw()}if(this.boxes&&this.boxes.markers){for(let s in this.boxes.markers){s=this.boxes.markers[s],name=s.name;let o=!0;if(o=!!e||!!Utils.isDefined(name)&&name.toLowerCase().includes(t),s.display(o),o){let t=this.transformProjBounds(s.bounds);i.extend(t),a++}}this.boxes.redraw()}if(this.lines){let i=this.lines.features;for(let a=0;a<i.length;a++){let s=i[a];name=s.name;let o=!0;o=!!e||!!Utils.isDefined(name)&&name.toLowerCase().includes(t),s.style.display=o?"inline":"none"}this.lines.redraw()}a>0&&this.centerOnMarkers(i,!0)},setLatLonReadout:function(t){this.latlonReadout=t},getMap:function(){return getMapDebug&&console.trace(),this.map},setDragPanEnabled:function(t){this.dragPanControl&&(t?this.dragPanControl.activate():this.dragPanControl.deactivate())},setZoomPanEnabled:function(t){t?this.panZoomControl||this.getMap().addControl(this.panZoomControl=new OpenLayers.Control.PanZoom):(this.panZoomControl&&this.panZoomControl.destroy(),this.panZoomControl=null)},initMap:function(t){let e=this;if(this.startTime=Date.now(),this.inited)return;if(this.inited=!0,this.dragPanControl=new OpenLayers.Control.Navigation({zoomWheelEnabled:this.params.scrollToZoom,dragPanOptions:{enableKinetic:!0}}),this.getMap().addControl(this.dragPanControl),this.setDragPanEnabled(this.params.enableDragPan),this.params.scrollToZoom){const t=document.querySelector("#"+this.mapDivId+"_themap");this.checkedBaseLayerDiv=!1,t&&(t.onwheel=t=>{if(!this.baseLayerDiv){let t=$("#"+this.mapDivId).find(".layersDiv");t.length>0&&(this.baseLayerDiv=t)}this.baseLayerDiv&&this.baseLayerDiv.is(":visible")||this.currentPopup&&this.currentPopup.div||t.preventDefault()})}this.params.showZoomPanControl&&!this.params.showZoomOnlyControl&&this.setZoomPanEnabled(!0),this.params.showZoomOnlyControl&&!this.params.showZoomPanControl&&this.getMap().addControl(new OpenLayers.Control.Zoom),this.params.showScaleLine&&this.getMap().addControl(new OpenLayers.Control.ScaleLine),this.params.showOverviewMap&&this.setShowOverviewMap(!0);let i=new OpenLayers.Control,a=new OpenLayers.Control,s={keyup:function(t){e.handleKeyUp(t)},keydown:function(t){e.handleKeyDown(t)}};new OpenLayers.Handler.Keyboard(a,s,{}).activate(),this.getMap().addControl(i),this.getMap().addControl(new OpenLayers.Control.KeyboardDefaults),this.params.linkMouse&&this.getMap().events.register("mousemove",this.getMap(),(t=>{if(t.shiftKey){this.sharedMouse&&this.getMarkersLayer().removeFeatures([this.sharedMouse],{silent:!0});let e=this.getMap().getLonLatFromPixel(t.xy);e=this.transformProjPoint(e),ramaddaMapShareState(this,{mouse:e})}})),this.params.showLayerSwitcher&&this.getMap().addControl(new OpenLayers.Control.LayerSwitcher),this.params.showLatLonPosition&&this.initMousePositionReadout(),this.params.showLocationSearch&&this.initLocationSearch(),this.defaultBounds&&(this.hadDefaultBounds=!0),this.applyDefaultLocation();for(let t=0;t<this.initialLayers.length;t++)this.addLayer(this.initialLayers[t]);this.initialLayers=[],t&&this.addRegionSelectorControl();let o=$(':input[id*="visible_'+this.mapId+'"]'),r=()=>{this.checkImageLayerVisibility(),this.checkMarkerVisibility(),this.checkLinesVisibility(),this.checkBoxesVisibility(),this.centerOnMarkerLayer()};o.change((t=>{r()}));let l=$(':input[id*="visibleall_'+this.mapId+'"]');l.change((t=>{o.prop("checked",l.is(":checked")),r()}));for(let t=1;;t++){let e=this.getProperty("marker"+t);if(!e)break;this.addMarkerEmbed(e)}},finishInit:function(){},destroyMousePositionReadout:function(){this.mousePositionReadout&&this.mousePositionReadout.destroy(),this.mousePositionReadout=null},finishMarkers:function(){this.markers},initMousePositionReadout:function(){if(this.mousePositionReadout)return;this.latlonReadout||(this.latlonReadout=this.mapId+"_latlonreadout");let t=GuiUtils.getDomObject(this.latlonReadout);t?this.getMap().addControl(this.mousePositionReadout=new OpenLayers.Control.MousePosition({numDigits:5,element:t.obj,prefix:""})):this.getMap().addControl(this.mousePositionReadout=new OpenLayers.Control.MousePosition({numDigits:5,prefix:""}))},handleKeyUp:function(t){this.keyUpListener&&this.keyUpListener(t)},handleKeyDown:function(t){if(!this.keyDownListener||!this.keyDownListener(t))if(t.ctrlKey&&t.shiftKey)"B"==t.key&&this.locationChangedInner(!0);else{if(79==t.keyCode||"Shift"==t.key){if(!this.imageLayersList)return;if(this.ignoreKeyEvents)return;this.imageLayersList.forEach((e=>{e.getVisibility()&&(Utils.isDefined(e.opacity)||(e.opacity=1),opacity=e.opacity,t.shiftKey?opacity+=.1:opacity-=.1,opacity<0?opacity=0:opacity>1&&(opacity=1),e.setOpacity(opacity))}))}84==t.keyCode&&this.selectImage&&this.selectImage.setVisibility(!this.selectImage.getVisibility())}},addKeyUpListener:function(t){this.keyUpListener=t},addKeyDownListener:function(t){this.keyDownListener=t},applyDefaultLocation:function(){if(debugBounds&&console.log("apply default location:"+this.defaultLocation),this.defaultLocation){let t=this.transformLLPoint(this.defaultLocation);this.getMap().setCenter(t),this.params.initialZoom>=0||(debugBounds&&console.log("zoomTo:",4),this.zoomTo(4)),this.defaultLocation=null}else{if(this.defaultBounds){let t=this.defaultBounds.getCenterLonLat(),e=this.transformLLPoint(t);debugBounds&&console.log("applying default bounds: center:"+t+" b:"+this.defaultBounds+" zoom:"+this.params.initialZoom),this.getMap().setCenter(e);let i=this.transformLLBounds(this.defaultBounds);if(this.zoomToExtent(i),this.params.initialZoom<0){this.defaultBounds.right,this.defaultBounds.left;let t=-1;t=this.map.getZoomForExtent(i)+2,debugBounds&&console.log("overriding initialZoom:",t),this.params.initialZoom=t}return this.defaultBounds=null,void this.getMap().setCenter(e)}{let t=this.allLayers.filter((t=>!!t.ramaddaId&&(!t.isBaseLayer&&this.isLayerVisible(t.ramaddaId)&&t.initialVisibility))),e=null;t.length&&t.forEach((t=>{let i=this.getLayerVisibleExtent(t);i&&(e=MapUtils.extendBounds(e,i))})),e?this.zoomToExtent(e,!1):this.getMap().zoomToMaxExtent()}}if(this.params.initialZoom>=0){let t=this.params.initialZoom;debugBounds&&console.log("initial zoom:"+t),this.params.initialZoom=-1,this.zoomTo(t),this.initialZoomTimeout&&setTimeout((()=>{debugBounds&&console.log("initial zoom time out:"+t),this.zoomTo(t)}),this.initialZoomTimeout??500)}},removeSearchMarkers:function(){if(this.searchMarkerList)for(let t=0;t<this.searchMarkerList.length;t++)this.removeMarker(this.searchMarkerList[t])},addAllLocationResults:function(){if(this.removeSearchMarkers(),this.searchMarkerList=[],!this.locationSearchResults)return;let t,e,i,a;for(let s=0;s<this.locationSearchResults.length;s++){let o=this.locationSearchResults[s],r=MapUtils.createLonLat(o.longitude,o.latitude),l=o.icon;l||(l=ramaddaCdn+"/icons/green-dot.png"),this.searchMarkerList.push(this.addMarker("search",r,l,"",o.name,20,20)),t=0==s?o.longitude:Math.max(t,o.longitude),e=0==s?o.longitude:Math.min(e,o.longitude),i=0==s?o.latitude:Math.max(i,o.latitude),a=0==s?o.latitude:Math.min(a,o.latitude)}let s=this.transformLLBounds(MapUtils.createBounds(e,a,t,i));this.zoomToExtent(s)},initLocationSearch:function(){if(this.selectRegion)return;let t=this,e=HtmlUtils.span(["style","padding-right:4px;","id",this.mapDivId+"_loc_search_wait"],"")+HtmlUtils.checkbox(this.mapDivId+"_loc_bounds",["title","Search in map bounds"],!1)+HtmlUtils.span(["title","Search in map bounds"]," In view ")+HtmlUtils.input("","",["class","ramadda-map-loc-input","title","^string - matches beginning","size","30","placeholder","Search location","id",this.mapDivId+"_loc_search"]);$("#"+this.mapDivId+"_footer2").html(e);let i=$("#"+this.mapDivId+"_loc_search"),a=$("#"+this.mapDivId+"_loc_bounds"),s=$("#"+this.mapDivId+"_loc_popup"),o=$("#"+this.mapDivId+"_loc_search_wait");i.blur((function(t){setTimeout((function(){o.html(""),s.hide()}),250)})),i.on("input",(function(e){s.hide(),""==i.val()&&t.removeSearchMarkers()})),i.keypress((function(e){let r=e.keyCode||e.which;if(27==r)return void s.hide();if(13!=r)return;o.html(HtmlUtils.image(icon_wait));let l=ramaddaBaseUrl+"/geocode?query="+encodeURIComponent(i.val());if(a.is(":checked")){let e=t.transformProjBounds(t.getMap().getExtent());l+="&bounds="+e.top+","+e.left+","+e.bottom+","+e.right}$.getJSON(l,(function(e){o.html("");let a=HtmlUtils.openTag("div",["style","max-height:400px;overflow-y:auto;"]);if(0==e.result.length)return void o.html("Nothing found");t.locationSearchResults=e.result;for(let t=0;t<e.result.length;t++){let i=e.result[t].name.replace('"',"'"),s=e.result[t].icon;s||(s=ramaddaCdn+"/icons/green-dot.png"),a+=HtmlUtils.div(["class","ramadda-map-loc","name",i,"icon",s,"latitude",e.result[t].latitude,"longitude",e.result[t].longitude],"<img width='16' src="+s+"> "+e.result[t].name)}a+=HtmlUtils.div(["class","ramadda-map-loc","name","all"],"Show all");a+=HtmlUtils.closeTag("div"),s.html(a),HtmlUtils.setPopupObject(s),s.show(),s.position({of:i,my:"left bottom",at:"left top",collision:"fit fit"}),s.find(".ramadda-map-loc").click((function(){s.hide();let e=$(this).attr("name");if("all"==e)return void t.addAllLocationResults();let i=parseFloat($(this).attr("latitude")),a=parseFloat($(this).attr("longitude")),o=$(this).attr("icon"),r=.05,l=t.transformLLBounds(MapUtils.createBounds(a-r,i-r,a+r,i+r)),n=MapUtils.createLonLat(a,i);t.removeSearchMarkers(),t.searchMarkerList=[],t.searchMarkerList.push(t.addMarker("search",n,o,"",e,20,20));let h=t.transformProjBounds(t.getMap().getExtent());Math.abs(h.top-h.bottom)>r?t.zoomToExtent(l):t.setCenter(MapUtils.createLonLat(a,i))}))})).fail((function(t,e,i){o.html("Error:"+i)}))}))},addVectorLayer:function(t,e){if(this.addLayer(t),this.vectorLayers.push(t),this.getCanSelect(e)){let e=this;this.getMap().featureSelect?this.getMap().featureSelect.layers.push(t):this.getMap().featureSelect=new OpenLayers.Control.SelectFeature([t],{multiple:!1,hover:this.selectOnHover,onSelect:function(t){e.showMarkerPopup(t,!0)}})}this.checkLayerOrder()},isLayerVisible:function(t,e){if(!t)return!0;let i=this.getVisibilityCheckbox(t);return 0==i.length&&null!=e&&(i=$("#visible_"+this.mapId+"_"+e)),0==i.length||i.is(":checked")},initForDrawing:function(){let t=this;t.drawingLayer||(this.drawingLayer=MapUtils.createLayerVector("Drawing"),this.addLayer(t.drawingLayer)),this.drawControl=new OpenLayers.Control.DrawFeature(t.drawingLayer,OpenLayers.Handler.Point),this.getMap().addControl(t.drawControl)},drawingFeatureAdded:function(t){},addClickHandler:function(t,e,i,a,s){if(this.handleClickSelection=!0,this.lonFldId=t,this.latFldId=e,!this.clickHandler&&(this.clickListener=a,this.map))return this.clickHandler=new OpenLayers.Control.Click,this.clickHandler.setLatLonZoomFld(e,t,i,a,s),this.clickHandler.setTheMap(this),this.getMap().addControl(this.clickHandler),this.clickHandler.activate(),this.clickHandler},setSelection:function(t,e,i,a){if(a&&(this.polygonSelectorId=a.replace(/\./g,"_")),this.selectRegion=e,this.argBase=t??"",!GuiUtils)return;let s=t=>GuiUtils.getDomObject(this.argBase+"_"+t)??GuiUtils.getDomObject(this.argBase+"."+t)??GuiUtils.getDomObject(this.argBase+t)??GuiUtils.getDomObject(this.mapId+"_"+t);this.fldNorth=s("north"),this.fldSouth=s("south"),this.fldEast=s("east"),this.fldWest=s("west"),this.fldLat=s("latitude"),this.fldLon=s("longitude"),this.fldLon||this.params.addMarkerOnClick?(this.addClickHandler(this?.fldLat?.id,this?.fldLon?.id),this.fldLon&&this.setSelectionMarker(this.fldLon.obj.value,this.fldLat.obj.value)):this.fldWest&&this.fldNorth&&this.addClickHandler(this?.fldNorth?.id,this?.fldWest?.id,null,null,!0)},selectionPopupInit:function(){this.selectionDialog=window.ramaddaGlobalDialog,this.inited||(this.initMap(this.selectRegion),this.argBase&&!this.fldNorth&&this.setSelection(this.argBase),this.fldNorth&&this.setSelectionBox(this.fldNorth.obj.value,this.fldWest.obj.value,this.fldSouth.obj.value,this.fldEast.obj.value,!0),this.fldLon&&(this.addClickHandler(this.fldLon.id,this.fldLat.id),this.setSelectionMarker(this.fldLon.obj.value,this.fldLat.obj.value))),this.map.updateSize()},setSelectionBoxFromFields:function(t){if(this.fldNorth&&(this.setSelectionBox(this.fldNorth.obj.value,this.fldWest.obj.value,this.fldSouth.obj.value,this.fldEast.obj.value,!0),this.selectorBox)){let e=this.selectorBox.bounds;this.getMap().setCenter(e.getCenterLonLat()),t&&this.zoomToExtent(e)}},toggleSelectorBox:function(t){this.selectorControl&&(t?(this.selectorControl.activate(),this.selectorControl.box.activate()):(this.selectorControl.deactivate(),this.selectorControl.box.deactivate()))},resetExtent:function(){debugBounds&&console.log("resetExtent"),this.getMap().zoomToMaxExtent()},setSelectionBox:function(t,e,i,a,s){if(""==t||""==e||""==i||""==a)return;let o=MapUtils.createBounds(e,Math.max(i,-MapUtils.defaults.maxLatValue),a,Math.min(t,MapUtils.defaults.maxLatValue));if(this.selectorBox)this.selectorBox.bounds=this.transformLLBounds(o);else{let s={color:"red",selectable:!1};this.selectorBox=this.createBox("","Selector box",t,e,i,a,"",s)}if(s&&(debugBounds&&console.log("calling setViewToBounds-1"),this.setViewToBounds(o)),this.boxes&&this.boxes.redraw(),this.selectImage){let s=MapUtils.createBounds(e,i,a,t);s=this.transformLLBounds(s),this.selectImage.extent=s,this.selectImage.redraw()}},clearSelectionMarker:function(){null!=this.selectorMarker&&(this.removeMarker(this.selectorMarker),this.selectorMarker=null)},clearSelectedFeatures:function(){if(null!=this.getMap().controls){let t=this.getMap().controls;for(i=0;i<t.length;i++)"olControlSelectFeature"==t[i].displayClass&&t[i].unselectAll()}},setSelectionMarker:function(t,e,i,a){if(!t||!e||""==t||""==e)return;null!=this.lonFldId&&($("#"+this.lonFldId).val(MapUtils.formatLocationValue(t)),$("#"+this.latFldId).val(MapUtils.formatLocationValue(e)));let s=MapUtils.createLonLat(t,e);if(null==this.selectorMarker?this.selectorMarker=this.addMarker(MapUtils.POSITIONMARKERID,s,"","","",20,10):this.selectorMarker.lonlat=this.transformLLPoint(s),this.markers&&this.markers.redraw(),i&&(debugBounds&&console.log("setSelectionMarker-1"),this.getMap().setCenter(this.selectorMarker.lonlat)),a){if(debugBounds&&console.log("setSelectionMarker-2"),a.zoomOut){let t=this.getMap().getZoom();return t--,void(this.getMap().isValidZoomLevel(t)&&this.zoomTo(t))}if(a.zoomIn){let t=this.getMap().getZoom();return t++,void(this.getMap().isValidZoomLevel(t)&&this.zoomTo(t))}let i=a.offset;if(i){let a=this.transformLLBounds(MapUtils.createBounds(t-i,e-i,t+i,e+i));this.zoomToExtent(a)}}},transformLLBounds:function(t){if(!t)return;return Utils.isDefined(t.north)&&(t=MapUtils.createBounds(t.west,t.south,t.east,t.north)),t.clone().transform(this.displayProjection,this.sourceProjection)},ensureLonLat:function(t){return t.length>0&&!t[0].transform&&(t=t.map((t=>t=MapUtils.createPoint(t.x,t.y)))),t},transformPoints:function(t){return(t=this.ensureLonLat(t)).forEach((t=>{t.transform(this.displayProjection,this.sourceProjection)})),t},transformLLPoint:function(t){if(!t)return null;return t.clone().transform(this.displayProjection,this.sourceProjection)},transformProjBounds:function(t){if(!t)return;return t.clone().transform(this.sourceProjection,this.displayProjection)},transformProjPoint:function(t){if(!t)return;return t.clone().transform(this.sourceProjection,this.displayProjection)},normalizeBounds:function(t){if(!this.map)return t;let e=t,i=t.left,a=t.right,s=this.getMap().restrictedExtent;return s||(s=this.maxExtent),s?(s.left>=0&&(t.left<0&&(i=t.left+360),t.right<0&&(a=t.right+360)),i>a&&(a=t.right+360),i=Math.max(i,s.left),a=Math.min(a,s.right),e=MapUtils.createBounds(i,t.bottom,a,t.top),e):t},findSelectionFields:function(){!this.argBase||this.fldNorth||this.fldLon||this.setSelection(this.argBase)},removePolygonSelectionLines:function(){this.selectionLines&&(this.selectionLines.forEach((t=>{this.removePolygon(t)})),this.selectionLines=[]),this.polygonSelectorId&&jqid(this.polygonSelectorId).val("")},addPolygonSelectionPoint:function(t){this.polygonSelectionPoints||(this.polygonSelectionPoints=[]),this.polygonSelectionPoints.push(t),this.applyPolygonSelectionPoints()},applyPolygonSelectionPoints:function(){this.removePolygonSelectionLines(),this.selectionLines||(this.selectionLines=[]);for(let t=0;t<this.polygonSelectionPoints.length-1;t++){let e=this.polygonSelectionPoints[t],i=this.polygonSelectionPoints[t+1],a=this.addLine("s","",e.lat,e.lon,i.lat,i.lon,{strokeColor:"red",strokeWidth:2});this.selectionLines.push(a)}let t="";this.polygonSelectionPoints.forEach((e=>{""!=t&&(t+=","),t+=Utils.trimDecimals(e.lat,5)+","+Utils.trimDecimals(e.lon,5)})),jqid(this.polygonSelectorId).val(t)},setFieldValues:function(t,e){this.fldNorth?(this.fldNorth.obj.value=t,this.fldSouth.obj.value=t,this.fldWest.obj.value=e,this.fldEast.obj.value=e):this.fldLat&&(this.fldLon.obj.value=e,this.fldLat.obj.value=t);let i=MapUtils.createLonLat(e,t);this.addSelectionMarker(i)},setLocale:function(){if(!window.navigator||!navigator.geolocation)return;navigator.geolocation.getCurrentPosition((t=>{let e=t.coords.latitude,i=t.coords.longitude;this.setFieldValues(e,i),this.selectionDialog&&this.selectionDialog.hide()}),(t=>{console.error(t)}),{enableHighAccuracy:!0,maximumAge:3e4,timeout:27e3})},selectionClear:function(){this.removePolygonSelectionLines(),this.polygonSelectionPoints=[],this.findSelectionFields(),HU.addToDocumentUrl("map_bounds",""),this.fldNorth?(this.fldNorth.obj.value="",this.fldSouth.obj.value="",this.fldWest.obj.value="",this.fldEast.obj.value=""):this.fldLat&&(this.fldLon.obj.value="",this.fldLat.obj.value=""),this.selectorBox&&this.boxes&&(this.boxes.removeMarker(this.selectorBox),this.selectorBox=null),this.selectorMarker&&this.markers&&(this.removeMarker(this.selectorMarker),this.selectorMarker=null)},clearMarkers:function(){if(!this.markers)return;let t=this.getMarkers();this.markers.removeFeatures(t),this.markers.redraw()},getMarkers:function(){return null==this.markers?[]:this.markers.features},clearRegionSelector:function(t){this.selectorControl&&this.selectorControl.box&&this.selectorControl.box.removeBox()},addRegionSelectorControl:function(t,i){let a=this;a.selectorControl||(a.selectorListener=t,a.selectorControl=new OpenLayers.Control,OpenLayers.Util.extend(a.selectorControl,{draw:function(){this.box=new OpenLayers.Handler.Box(a.selectorControl,{done:this.notice},{keyMask:OpenLayers.Handler.MOD_SHIFT}),i||this.box.activate()},notice:function(e){if(!Utils.isDefined(e.left))return;let i=a.getMap().getLonLatFromPixel(MapUtils.createPixel(e.left,e.bottom)),s=a.getMap().getLonLatFromPixel(MapUtils.createPixel(e.right,e.top));i=a.transformProjPoint(i),s=a.transformProjPoint(s),e=MapUtils.createBounds(i.lon,i.lat,s.lon,s.lat),e=a.normalizeBounds(e),a.setSelectionBox(e.top,e.left,e.bottom,e.right,!1),a.findSelectionFields(),t&&t(e),a.fldNorth&&(a.fldNorth.obj.value=MapUtils.formatLocationValue(e.top),a.fldSouth.obj.value=MapUtils.formatLocationValue(e.bottom),a.fldWest.obj.value=MapUtils.formatLocationValue(e.left),a.fldEast.obj.value=MapUtils.formatLocationValue(e.right),HU.addToDocumentUrl("map_bounds",e.top+","+e.left+","+e.bottom+","+e.right))}}),a.map.addControl(a.selectorControl),a.panControl=new OpenLayers.Control,OpenLayers.Util.extend(a.panControl,{draw:function(){this.box=new OpenLayers.Handler.Drag(a.panControl,{down:this.down,move:this.move},{keyMask:OpenLayers.Handler.MOD_META,boxDivClassName:"map-drag-box"}),this.box.activate()},down:function(t){this.firstPoint=a.getMap().getLonLatFromPixel(MapUtils.createPixel(t.x,t.y)),this.firstPoint=a.transformProjPoint(this.firstPoint),a.findSelectionFields(),a.fldNorth&&(n=this.origNorth=parseFloat(a.fldNorth.obj.value),s=this.origSouth=parseFloat(a.fldSouth.obj.value),w=this.origWest=parseFloat(a.fldWest.obj.value),e=this.origEast=parseFloat(a.fldEast.obj.value),t=this.firstPoint,this.doWest=!1,this.doSouth=!1,this.doEast=!1,this.doNorth=!1,t.lon<=e&&t.lon>=w&&t.lat<=n&&t.lat>=s?(this.doSouth=this.doWest=this.doEast=this.doNorth=!0,this.type="center"):t.lon>e?t.lat>n?(this.type="ne",this.doEast=this.doNorth=!0):t.lat<s?(this.type="se",this.doSouth=this.doEast=!0):(this.type="e",this.doEast=!0):t.lon<w?t.lat>n?(this.type="nw",this.doWest=this.doNorth=!0):t.lat<s?(this.type="sw",this.doSouth=this.doWest=!0):(this.type="w",this.doWest=!0):t.lat>n?(this.type="n",this.doNorth=!0):(this.type="s",this.doSouth=!0))},move:function(t){let e=a.getMap().getLonLatFromPixel(MapUtils.createPixel(t.x,t.y));e=a.transformProjPoint(e),dx=e.lon-this.firstPoint.lon,dy=e.lat-this.firstPoint.lat,newWest=this.origWest,newEast=this.origEast,newSouth=this.origSouth,newNorth=this.origNorth,this.doWest&&(newWest+=dx),this.doSouth&&(newSouth+=dy),this.doEast&&(newEast+=dx),this.doNorth&&(newNorth+=dy);let i=MapUtils.createBounds(newWest,newSouth,newEast,newNorth);i=a.normalizeBounds(i),a.setSelectionBox(i.top,i.left,i.bottom,i.right,!1),a.findSelectionFields(),a.fldNorth&&(a.fldNorth.obj.value=MapUtils.formatLocationValue(i.top),a.fldSouth.obj.value=MapUtils.formatLocationValue(i.bottom),a.fldWest.obj.value=MapUtils.formatLocationValue(i.left),a.fldEast.obj.value=MapUtils.formatLocationValue(i.right))}}),a.map.addControl(a.panControl))},closePopup:function(t){if(this.currentPopup){this.getMap().removePopup(this.currentPopup);try{this.currentPopup.destroy()}catch(t){console.error("Error destroying map popup:"+t)}this.currentPopup=null,this.hiliteBox(""),this.selectedFeature&&this.unselectFeature(this.selectedFeature)}},onPopupClose:function(t){if(this.params.displayDiv&&this.showText(""),this.currentPopup){this.getMap().removePopup(this.currentPopup);try{this.currentPopup.destroy()}catch(t){}this.currentPopup=null,this.hiliteBox(""),this.selectedFeature&&this.unselectFeature(this.selectedFeature)}},findObject:function(t,e){for(i=0;i<e.length;i++){let a=e[i].ramaddaId;if(a||(a=e[i].id),a==t)return e[i]}return null},findMarker:function(t){return this.markers?this.findObject(t,this.getMarkers()):null},findFeature:function(t){let e=this.features[t];return!e&&this.pointsMap&&(e=this.pointsMap[t]),e},findBox:function(t){return this.boxes?this.findObject(t,this.boxes.markers):null},hiliteBox:function(t){this.currentBox&&this.currentBox.setBorder(this.currentBox.defaultBorderColor||"blue",1),this.currentBox=this.findBox(t),this.currentBox&&this.currentBox.setBorder("red")},checkMarkerVisibility:function(){if(!this.markers)return;let t=this.getMarkers();for(let e=0;e<t.length;e++){marker=t[e];let i=this.isLayerVisible(marker.ramaddaId,marker.parentId);marker.style.display=i?"inline":"none"}this.markers.redraw()},checkLinesVisibility:function(){if(!this.lines)return;let t=this.lines.features;for(let e=0;e<t.length;e++){let i=t[e],a=this.isLayerVisible(i.ramaddaId);i.style.display=a?"inline":"none"}this.lines.redraw()},checkBoxesVisibility:function(){if(this.boxes){for(let t in this.boxes.markers){t=this.boxes.markers[t];let e=this.isLayerVisible(t.ramaddaId);t.display(e)}this.boxes.redraw()}},checkImageLayerVisibility:function(){this.imageLayersList&&this.imageLayersList.forEach((t=>{let e=this.isLayerVisible(t.id);t.setVisibility(e),e?t.box&&(this.removeBox(t.box),t.box=this.createBox(i,"",t.north,t.west,t.south,t.east,t.text,{})):t.box&&(this.removeBox(t.box),t.box=null)}))},hiliteMarker:function(t,e){let i=this.findMarker(t);if(i||(i=this.findFeature(t)),!i&&this.imageLayers&&(i=this.imageLayers[t],i||(i=this.imageLayers[t.replace(/_/g,"-")])),!i&&this.polygonMap&&(i=this.polygonMap[t],i))return void this.handleFeatureclick(i.layer,i,!1,{});if(!i)return void console.log("cannot find marker with id:"+t);let a=i.latLonBounds;if(a){let t=this.transformLLBounds(a);this.zoomToExtent(t)}else debugBounds&&console.log("hiliteMarker"),this.setCenter(i.lonlat);this.showMarkerPopup(i),e&&e.shiftKey&&this.setZoom(12)},clearAllProgress:function(){this.clearProgress(),this.hideLoadingImage()},clearProgress:function(t){$("#"+this.mapDivId+"_progress").hide()},setProgress:function(t){$("#"+this.mapDivId+"_progress").html(t),$("#"+this.mapDivId+"_progress").show()},setLabel:function(t){$("#"+this.mapDivId+"_label").html(t)},setCursor:function(t){jqid(this.mapDivId+"_themap").css("cursor",t??"default")},loadingImageCnt:0,hideLoadingImage:function(t){t&&(this.loadingImageCnt=Math.max(0,this.loadingImageCnt-1),this.loadingImageCnt>0)||(this.setCursor(),jqid(this.mapDivId+"_themap").css("cursor","default"),this.loadingImage&&(this.loadingImage.style.visibility="hidden"))},showLoadingImage:function(t){if(t&&(this.loadingImageCnt++,this.loadingImageCnt>1))return;if(this.setCursor("progress"),this.loadingImage)return void(this.loadingImage.style.visibility="visible");let e=MapUtils.createSize(120,120),i=this.getMap().viewPortDiv.offsetWidth,a=this.getMap().viewPortDiv.offsetHeight,s=MapUtils.createPixel(i/2-e.w/2,a/2-e.h/2);this.loadingImage=MapUtils.createImage("loadingimage",s,e,ramaddaCdn+"/icons/mapprogress.gif"),this.loadingImage.style.zIndex=1010,this.getMap().viewPortDiv.appendChild(this.loadingImage)},centerOnMarkerLayer:function(){this.centerOnMarkers(null,!1,!0)},centerOnMarkersInit:function(){this.hadDefaultBounds||this.centerOnMarkers(null)},getLayerVisibleExtent:function(t){let e=null,i=t.features;if(!i||0==i.length)return e=t.getDataExtent(),e||t.maxExtent;let a=null;for(let t=0,s=i.length;t<s;t++){let s=i[t];s.getVisibility()?(a=s.geometry,a&&(null===e&&(e=MapUtils.createBounds()),e.extend(a.getBounds()))):0}return e},animateViewToBounds:function(t,e,i){Utils.isDefined(i)||(i=1),e||(e=this.transformProjBounds(this.getMap().getExtent()));if(i>10)return void this.setViewToBounds(t);let a=i/10;i++,newBounds=MapUtils.createBounds(e.left+(t.left-e.left)*a,e.bottom+(t.bottom-e.bottom)*a,e.right+(t.right-e.right)*a,e.top+(t.top-e.top)*a),this.setViewToBounds(newBounds),setTimeout((()=>this.animateViewToBounds(t,e,i)),125)},getPopupText:function(t,e){return null==t?null:(0==t.indexOf("base64:")&&0==(t=window.atob(t.substring(7)).trim()).indexOf("{")&&(props=JSON.parse(t),(t=props.text)||(t=""),e&&(e.inputProps=props)),t)},clearSeenMarkers:function(){this.seenMarkers={}},addEntryMarker:function(t,e,i,a,s,o,r){if(marker=this.addMarker(t,e,i,a,s),marker.entryType=o,marker.entryId=t,r&&r.fillColor){let i={pointRadius:r.radius||12,fillColor:r.fillColor,strokeWidth:r.strokeWidth,strokeColor:r.strokeColor};this.addPoint(t,e,i,"")}},createMarker:function(t,e,i,a,s,o,r,l,n,h,d){if("dot"==i)return this.createPoint(t,e,{},s);Utils.isDefined(e.x)&&(e=MapUtils.createLonLat(e.x,e.y)),d=d??{},Array.isArray(e)&&(e=MapUtils.createLonLat(e[0],e[1]));let u=r||this.params.iconWidth||this.params.iconSize||20,c=r||this.params.iconHeight||this.params.iconSize||20;r=u,null==l&&(l=0),null==n&&(n=0),this.markers||(this.markers=MapUtils.createLayerVector("Markers"),this.addVectorLayer(this.markers,h)),Utils.stringDefined(i)||(i=ramaddaCdn+"/icons/marker.png");let p=MapUtils.createSize(u,c),g=MapUtils.createIcon(i,p,null,(function(t){return MapUtils.createPixel(-r.w/2-l,-r.h/2-n)})),f=this.transformLLPoint(e),m=MapUtils.createMarker(f,g),y=MapUtils.createPoint(e.lon,e.lat).transform(this.displayProjection,this.sourceProjection),L={externalGraphic:i,graphicWidth:r,graphicXOffset:l+-r/2,graphicYOffset:-r/2,labelYOffset:d.labelYOffset??-r,label:d.label};d.fontSize&&(L.fontSize=d.fontSize),Utils.isDefined(d.rotation)&&(L.rotation=d.rotation);let M=MapUtils.createVector(y,{description:""},L);M.ramaddaId=t,M.parentId=o,M.text=this.getPopupText(s,M),M.name=a,M.location=e,m.ramaddaId=t,m.text=this.getPopupText(s,m),m.name=a,m.location=e;let k=e+"";M.locationKey=k;let x=this.seenMarkers[k];null==x&&(x=[],this.seenMarkers[k]=x),x.push(M);let b=this,v=function(t){b.showMarkerPopup(m,!0),null!=m.ramaddaClickHandler&&m.ramaddaClickHandler.call(null,m),MapUtils.stopEvent(t)};return m.events.register("click",m,v),m.events.register("touchstart",m,v),this.isLayerVisible(m.ramaddaId,m.parentId)||m.display(!1),M.what="marker",M},addMarkerEmbed:function(t){let e={};if(t.startsWith("base64:")&&(t=window.atob(t.substring(7))),0==t.indexOf("{"))e=JSON.parse(t);else{let[i,a,s]=t.split(",");e.lat=i,e.lon=a,e.text=s}let i=MapUtils.createLonLat(parseFloat(e.lon),parseFloat(e.lat));null!=e.size&&""!=e.size||(e.size=16);let a=e.type||"icon",s=e;if(s.pointRadius=e.size||"16",s.labelYOffset=-8-s.pointRadius,"icon"==a){let t=e.icon||"/markers/marker-red.png";this.addMarker("",i,t,e.description,e.description,"",parseFloat(e.size||"16"),null,!0,s)}else s.fillColor=s.fillColor||"blue",s.strokeWidth=s.strokeWidth||"1",s.graphicName=a,"none"==a&&(s.graphicName="circle",s.pointRadius=0,s.fillColor="transparent"),this.addPoint("",i,s,e.description),"circle"!=s.graphicName&&this.addPoint("",i,{pointRadius:s.pointRadius,strokeColor:"transparent",fillColor:"transparent"},e.description);this.setDoPopup(!0)},setDoPopup:function(t){this.params.doPopup=t},getDoPopup:function(t){return this.params.doPopup},createPolygonFromString:function(t,e,i,a,s,o){let r;[";",","].forEach((t=>{e.indexOf(t)>=0&&(r=t)})),i=i??{fill:!0,fillColor:"#0000ff",fillOpacity:.05,strokeWidth:1,strokeColor:"blue"};let l=e.split(r),n=[],h=[],d=[h],u=(t,e,i,s)=>{if(!a){let a=t;t=e,e=a,a=i,i=s,s=a}if(!(isNaN(t)||isNaN(i)||isNaN(e)||isNaN(s)))if(o)n.push(e,t,s,i);else if(MapUtils.crossIDL(e,s)){let a=MapUtils.intercept(t,e,i,s);h.push(MapUtils.createPoint(e,t)),h.push(MapUtils.createPoint(e<0?-180:180,a)),h=[],d.push(h),h.push(MapUtils.createPoint(s<0?-180:180,a)),h.push(MapUtils.createPoint(s,i))}else h.push(MapUtils.createPoint(e,t)),h.push(MapUtils.createPoint(s,i))};if(l.length>0&&l[0].trim().indexOf(" ")>0){a=!1;let t=[];l.forEach((e=>{let i=Utils.split(e.trim()," ",!0,!0);2==i.length&&t.push(parseFloat(i[0]),parseFloat(i[1]))}));for(let e=2;e<t.length;e+=2){u(t[e-2],t[e-1],t[e],t[e+1])}}else for(let t=2;t<l.length;t+=2){u(parseFloat(l[t-2]),parseFloat(l[t-1]),parseFloat(l[t]),parseFloat(l[t+1]))}if(o)return n;let c=[];return d.forEach((e=>{e.length>0&&c.push(this.createPolygon(t,"",e,i,s,!1))})),c},addPolygonString:function(t,e,i,a,s){let o=this.createPolygonFromString(t,e,i,a,s);return this.getLinesLayer().addFeatures(o),o},addMarkers:function(t){this.markers||(this.markers=MapUtils.createLayerVector("Markers"),this.addVectorLayer(this.markers,!0)),this.markers.addFeatures(t)},initBoxes:function(t){this.getMap(),this.addLayer(t),t.getFeatureFromEvent=function(t){return null}},removeBox:function(t){this.boxes&&t&&(this.boxes.removeMarker(t),this.boxes.redraw())},addBox:function(t){this.boxes||(this.boxes=MapUtils.createLayerBoxes("Boxes",{wrapDateLine:MapUtils.defaults.wrapDateline}),this.getMap()?this.initBoxes(this.boxes):this.initialBoxes=this.boxes),this.boxes.addMarker(t),this.boxes.redraw()},createBox:function(t,e,i,a,s,o,r,l){0==r.indexOf("base64:")&&(r=window.atob(r.substring(7)));let n={color:"blue",selectable:!0,zoomToExtent:!1,sticky:!1};for(let t in l)n[t]=l[t];n.color||(n.color=this.params.boxColor||"blue");let h=MapUtils.createBounds(a,Math.max(s,-MapUtils.defaults.maxLatValue),o,Math.min(i,MapUtils.defaults.maxLatValue)),d=this.transformLLBounds(h),u=MapUtils.createBox(d);u.sticky=n.sticky;let c=this;n.selectable&&u.events.register("click",u,(function(t){c.showMarkerPopup(u,!0),MapUtils.stopEvent(t)}));let p=MapUtils.createLonLat(a,i);return u.lonlat=this.transformLLPoint(p),u.text=this.getPopupText(r),u.name=e,u.setBorder(n.color??"blue",1),u.defaultBorderColor=n.color,u.ramaddaId=t,n.zoomToExtent&&this.centerOnMarkers(h),this.addBox(u),u},circleMarker:function(t,e){let i=this.findMarker(t);if(i||(i=this.findFeature(t)),!i)return null;let a={pointRadius:16,stroke:!0,strokeColor:"red",strokeWidth:2,fill:!1};return e&&$.extend(a,e),this.showFeatureText(i),this.addPoint(t+"_circle",i.location,a)},addFeatureHighlightHandler:function(t){this.featureHighlightHandler=t},addFeatureSelectHandler:function(t){this.featureSelectHandler=t},showFeatureText:function(t){this.featureHighlightHandler&&this.featureHighlightHandler(t,!0);let e=this;if(t.text&&this.params.displayDiv){this.textFeature=t,setTimeout((function(){e.textFeature==t&&e.showText(e.textFeature.text)}),1e3)}},showText:function(t){if(t.startsWith("url:")){let e=t.substring("url:".length);$.get(e,(t=>{this.showText(t)})).done((function(){})).fail((function(){console.log("Failed to load marker text url: "+e)}))}else $("#"+this.params.displayDiv).html(t)},hideFeatureText:function(t){this.featureHighlightHandler&&this.featureHighlightHandler(t,!1),t&&this.textFeature!=t||this.params.displayDivSticky||this.showText("")},createPoint:function(t,e,i,a,s,o){let r=e;void 0===e.x?e=MapUtils.createPoint(e.lon,e.lat):r=MapUtils.createLonLat(e.x,e.y),this.basePointStyle||(this.basePointStyle=$.extend({},MapUtils.getVectorStyle("default")),$.extend(this.basePointStyle,{pointRadius:5,stroke:!0,strokeColor:"red",strokeWidth:0,strokeOpacity:.75,fill:!0,fillColor:"blue",fillOpacity:.75}));let l=Object.assign({},this.basePointStyle);i&&(l=Object.assign(l,i),l.pointRadius<=0&&(l.pointRadius=1)),""!=l.fillColor&&"none"!=l.fillColor||(l.fillOpacity=0),""!=l.strokeColor&&"none"!=l.strokeColor||(l.strokeOpacity=0);let n=MapUtils.createPoint(e.x,e.y);n.transform(this.displayProjection,this.sourceProjection);let h=MapUtils.createVector(n,null,l);return h.center=n,h.ramaddaId=t,a&&(h.text=this.getPopupText(a,h)),h.textGetter=s,h.location=r,h.lonlat=r,this.features[t]=h,h},addPoint:function(t,e,i,a,s){let o=this.createPoint(t,e,i,a,s);return this.getMarkersLayer().addFeatures([o],{silent:!0}),this.pointsMap||(this.pointsMap={}),this.pointsMap[t]=o,o},addPoints:function(t){this.getMarkersLayer().addFeatures(t,{silent:!0})},getMarkersLayer:function(){return null==this.circles&&(this.circles=MapUtils.createLayerVector("Shapes"),this.circles.layerName="circles",this.circles.setZIndex(1),this.addVectorLayer(this.circles),this.circles.canSelect=!0),this.circles},setPointsVisibility:function(t){this.circles&&this.circles.setVisibility(t)},addRectangle:function(t,e,i,a,s,o,r){let l=[MapUtils.createPoint(i,e),MapUtils.createPoint(i,a),MapUtils.createPoint(s,a),MapUtils.createPoint(s,e),MapUtils.createPoint(i,e)];return this.addPolygon(t,"",l,o,r)},createLine:function(t,e,i,a,s,o,r,l){let n=[MapUtils.createPoint(a,i),MapUtils.createPoint(o,s)];return this.createPolygon(t,e,n,r,l)},addLine:function(t,e,i,a,s,o,r,l,n){let h=[MapUtils.createPoint(a,i),MapUtils.createPoint(o,s)];return this.addPolygon(t,e,h,r,l,n)},addSelectionMarker:function(t,e){this.selectorMarker&&this.removeMarker(this.selectorMarker),this.selectorMarker=this.addMarker(MapUtils.POSITIONMARKERID,t,this.params.markerIcon??"","","",40,20),this.getProperty("addMarkerOnClick")&&(e||ramaddaMapShareState(this,{marker:t}))},addMarker:function(t,e,i,a,s,o,r,l,n,h,d,u){let c=this.createMarker(t,e,i,a,s,o,r,0,l,n,h);return c.lonlat=e,u||this.addMarkers([c]),d&&this.addPolygonString(t,d,null,!0,s),c},addLines:function(t,e,i,a,s,o){(i=i||{}).strokeWidth||(i.strokeWidth=this.params.strokeWidth),i.strokeColor||(i.strokeColor=this.params.strokeColor);let r=[];for(let t=0;t<a.length;t+=2)r.push(MapUtils.createPoint(a[t+1],a[t]));let l=this.addPolygon(t,e,r,i,s,!1,!0);if(o&&this.getLinesLayer()){let t=this.getLinesLayer().getDataExtent();t&&this.zoomToExtent(t,!0)}return l},removePolygon:function(t){this.lines&&this.lines.removeFeatures([t])},createPolygon:function(t,e,i,a,s,o){let r;i.length>1?r=MapUtils.createLonLat(i[0].x+(i[1].x-i[0].x)/2,i[0].y+(i[1].y-i[0].y)/2):i.length>0&&(r=MapUtils.createLonLat(i[0].x,i[0].y)),i=this.transformPoints(i);let l,n=$.extend({},MapUtils.getVectorStyle("default")),h=$.extend({},n);if(a)for(let t in a)h[t]=a[t];l=o?MapUtils.createLineString(i):MapUtils.createPolygon(MapUtils.createLinearRing(i));let d=MapUtils.createVector(l,null,h);s||(s=e),d.text=s,d.ramaddaId=t,d.location=r,d.name=e,this.polygonMap||(this.polygonMap={}),this.polygonMap[t]=d;let u=this.isLayerVisible(d.ramaddaId);return d.style.display=u?"inline":"none",d},addPolygon:function(t,e,i,a,s,o,r){let l=this.createPolygon(t,e,i,a,s,r);return o||this.getLinesLayer().addFeatures([l]),l},getLinesLayer:function(){if(!this.lines){let t=$.extend({},MapUtils.getVectorStyle("default"));this.lines=MapUtils.createLayerVector("Lines",{style:t}),this.addVectorLayer(this.lines),this.lines.isMapLayer=!0}return this.lines},getFeaturesBounds:function(t,e){if(!t)return null;let i=MapUtils.createBounds();return t.forEach(((t,e)=>{t.geometry&&MapUtils.isFeatureVisible(t)&&(i=MapUtils.extendBounds(i,t.geometry.getBounds()))})),e&&(i=this.transformProjBounds(i)),i},centerOnFeatures:function(t){let e=this.getFeaturesBounds(t);if(e.left!=e.right&&e.top!=e.bottom)this.zoomToExtent(e);else{e=this.transformProjBounds(e);let t=e.getCenterLonLat();this.setCenter(t)}},getHighlightLinesLayer:function(){if(!this.highlightlines){let t=$.extend({},MapUtils.getVectorStyle("default"));this.highlightlines=MapUtils.createLayerVector("Highlight Lines",{style:t}),this.addVectorLayer(this.highlightlines)}return this.highlightlines},handleMarkerLayer:function(){this.currentPopup&&(this.getMap().removePopup(this.currentPopup),this.currentPopup.destroy(),this.currentPopup=null);let t=this.currentEntryMarker;if(t.entryLayer){let e=this.loadedLayers.indexOf(t.entryLayer);return e>=0&&(this.loadedLayers=this.loadedLayers.slice(e)),this.getMap().removeLayer(t.entryLayer),void(t.entryLayer=null)}let e=this.handleEntrySelect(t.entryId,t.name,t.entryType);e&&(t.entryLayer=e)},showPopupSlider:function(t,e){return!(!this.params.doPopupSlider&&!this.params.popupSliderRight)&&(this.doingPopup=!0,setTimeout((()=>{let t=$("#"+this.mapDivId+"_slider");this.params.popupSliderRight?t.css("right","0px"):t.css("left","0px"),t.hide();let i=HU.getDimension(this.params.popupWidth),a=HU.div([STYLE,HU.css("width",i,"padding","5px")],HU.div([ID,this.mapDivId+"_sliderclose",CLASS,"ramadda-clickable"],HU.getIconImage(icon_close))+e);t.html(a),t.slideDown(800),$("#"+this.mapDivId+"_sliderclose").click((()=>{t.slideUp()})),setTimeout((()=>{this.doingPopup=!1}),10)}),500),!0)},showMarkerPopup:function(t,e,i){if(debugPopup&&console.log("showMarkerPopup"),this.entryClickHandler&&window[this.entryClickHandler]&&!window[this.entryClickHandler](this,t))return void(debugPopup&&console.log("\twindowClickHandler"));if(this.currentPopup){this.getMap().removePopup(this.currentPopup);try{this.currentPopup.destroy()}catch(t){}}if(this.featureSelectHandler&&this.featureSelectHandler(t))return void(debugPopup&&console.log("\tfeatureSelectHandler returned true"));let a=t.ramaddaId;if(a||(a=t.id),this.shareSelected&&window.ramaddaDisplaySetSelectedEntry&&ramaddaDisplaySetSelectedEntry(a),!this.getDoPopup())return void(debugPopup&&console.log("\tparams.doPopup=false"));let s=t.inputProps??{};this.hiliteBox(a);let o;if(t.inputProps&&(t.text=this.getPopupText(t.inputProps.text)),t.textGetter?(o=t.textGetter(t),debugPopup&&console.log("\thas textGetter:"+o)):this.textGetter&&(o=this.textGetter(t.layer,t)),o||(o=t.text),o)if(o.startsWith("url:")){let a=o.substring("url:".length);$.get(a,(a=>{this.showMarkerPopupInner(t,e,i,a,s)})).done((function(){})).fail((function(){console.log("Failed to load marker text url: "+a)}))}else this.showMarkerPopupInner(t,e,i,o,s);else debugPopup&&console.log("\tno marker text")},showMarkerPopupInner:function(t,e,i,a,s){if(this.params.displayDiv)return this.showText(a),void(debugPopup&&console.log("\thad displayDiv"));if(e&&null!=t.locationKey&&(markers=this.seenMarkers[t.locationKey],markers&&markers.length>1)){debugPopup&&console.log("showMarkerPopup: seenMarkers:",markers.length),a="";for(let e=0;e<markers.length;e++){if(otherMarker=markers[e],e>0&&(a+="<hr>"),otherMarker.inputProps&&(otherMarker.text=otherMarker.textGetter?otherMarker.textGetter(t):this.getPopupText(otherMarker.inputProps.text)),a+=otherMarker.text?otherMarker.text:otherMarker.textGetter?otherMarker.textGetter(t):"NA",e>10)break}}let o=t.location,r=null;if(o){if(void 0===o.lon&&(o=MapUtils.createLonLat(o.x,o.y)),a&&""!=a||o.lat==o.lat&&(a="Lon: "+o.lat+"<br>Lat: "+o.lon),t.entryType){let e=t.entryType;if("geo_kml"==e||"geo_json"==e||"geo_shapefile"==e){this.currentEntryMarker=t;let e="ramaddaMapMap['"+this.mapId+"'].handleMarkerLayer();",i=t.entryLayer?"Remove Layer":"Load Layer";a="<center>"+HtmlUtils.onClick(e,i)+"</center>"+a}}r=this.transformLLPoint(o)}else if(t.geometry){let e=t.geometry.getBounds();e&&(r=e.getCenterLonLat())}if(null==r)return void(debugPopup&&console.log("\tno projPoint"));if(this.showPopupSlider(t.location,a))return;let l={};s.chartType&&(l.width=400);let n=HU.getUniqueId("div"),h=HU.div(["style","width:100%;","id",n]);l.width=l.width??s.minSizeX??this.params.popupWidth,l.height=l.height??s.minSizeY??this.params.popupHeight;let d=this.makePopup(r,h,l);debugPopup&&console.log("showMarkerPopup:",a),t.popupText=d,d.marker=t,this.addPopup(d),jqid(n).html(a),this.popupListener&&this.popupListener(n,a),debugPopup&&console.log("\tmade popup"),s.chartType&&this.popupChart(t.inputProps),this.popupHandler&&this.popupHandler(t,d)},popupChart:function(t){let e=getOrCreateDisplayManager(t.divId,{},!0),i={entryId:t.entryId},a=t.title;a||(a="Chart");let s=null==t.fields?null:t.fields.split(","),o={title:a,layoutHere:!0,divid:t.divId,entryId:t.entryId,fields:s,vAxisMinValue:t.vAxisMinValue,vAxisMaxValue:t.vAxisMaxValue,data:new PointData(a,null,null,getRamadda().getRoot()+"/entry/show?entryid="+t.entryId+"&output=points.product&product=points.json&numpoints=10000",i)};if(t.chartArgs){let e=t.chartArgs.split(",");for(let t=0;t<e.length;t+=2)o[e[t]]=e[t+1]}e.createDisplay(t.chartType,o)},uncircleMarker:function(t){feature=this.features[t+"_circle"],feature&&this.circles&&this.circles.removeFeatures([feature]),this.hideFeatureText(feature)},removePoint:function(t){this.removePoints([t])},removePointsLayer:function(){this.circles&&(this.removeLayer(this.circles),this.circles=null)},removeMarkersLayer:function(){this.markers&&(this.removeLayer(this.markers),this.markers=null)},removePoints:function(t){this.circles&&this.circles.removeFeatures(t)},removeMarker:function(t){this.removeMarkers([t])},removeMarkers:function(t){this.markers&&this.markers.removeFeatures(t),t.forEach((t=>{if(!t)return;if(!t.locationKey)return;this.seenMarkers[t.locationKey]&&(this.seenMarkers[t.locationKey]=Utils.removeElement(this.seenMarkers[t.locationKey],t))}))},createFeatureLayer:function(t,e,i,a){let s=$.extend({},MapUtils.getVectorStyle("default"));i&&$.extend(s,i),(a=a||{}).style=s;let o=MapUtils.createLayerVector(t||"Markers",a);return this.externalLayers.push(o),this.addVectorLayer(o,e),o}};
