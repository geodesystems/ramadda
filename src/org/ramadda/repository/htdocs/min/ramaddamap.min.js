var map_esri_topo="esri.topo";var map_esri_street="esri.street";var map_esri_worldimagery="esri.worldimagery";var map_opentopo="opentopo";var map_usgs_topo="usgs.topo";var map_usgs_imagery="usgs.imagery";var map_usgs_relief="usgs.relief";var map_watercolor="watercolor";var map_white="white";var map_blue="blue";var map_black="black";var map_gray="gray";var map_usfs_ownership="usfs.ownership";var map_osm="osm";var map_osm_toner="osm.toner";var map_ol_openstreetmap="ol.openstreetmap";var map_ms_shaded="ms.shaded";var map_ms_hybrid="ms.hybrid";var map_ms_aerial="ms.aerial";var map_default_layer=map_osm;var ramaddaCircleHiliteAttrs={strokeColor:"black",strokeWidth:1,fill:true,fillOpacity:0.5,fillColor:"red"};function createLonLat(c,b){c=parseFloat(c);b=parseFloat(b);return new OpenLayers.LonLat(c,b)}function createBounds(g,d,c,b){g=parseFloat(g);d=parseFloat(d);c=parseFloat(c);b=parseFloat(b);return new OpenLayers.Bounds(g,d,c,b)}function createProjection(b){return new OpenLayers.Projection(b)}var positionMarkerID="location";var latlonReadoutID="ramadda-map-latlonreadout";var mapDefaults={maxLatValue:85,zoomLevels:40,defaultZoomLevel:11,maxExtent:createBounds(-20037508,-20037508,20037508,20037508),sourceProjection:createProjection("EPSG:900913"),displayProjection:createProjection("EPSG:4326"),units:"m",doSphericalMercator:true,wrapDateline:true,location:createLonLat(-100,40)};var ramaddaMaps=new Array();var ramaddaMapMap={};function ramaddaAddMap(b){ramaddaMaps.push(b);ramaddaMapMap[b.mapId]=b}function RepositoryMap(c,g){if(!g){g={}}this.mapId=c||"map";ramaddaAddMap(this);let theMap=this;$.extend(this,{name:"map",sourceProjection:mapDefaults.sourceProjection,displayProjection:mapDefaults.displayProjection,projectionUnits:mapDefaults.units,mapDivId:this.mapId,showScaleLine:true,showLayerSwitcher:true,showZoomPanControl:true,showZoomOnlyControl:false,showLatLonPosition:true,enableDragPan:true,defaultLocation:mapDefaults.location,initialZoom:mapDefaults.defaultZoomLevel,latlonReadout:latlonReadoutID,map:null,defaultMapLayer:map_default_layer,defaultCanSelect:true,haveAddedDefaultLayer:false,layer:null,markers:null,vectors:null,loadedLayers:[],boxes:null,kmlLayer:null,kmlLayerName:null,showSearch:false,geojsonlLayer:null,geojsonLayerName:null,vectorLayers:[],features:{},lines:null,selectorBox:null,selectorMarker:null,listeners:[],fixedText:false,initialLayers:[],imageLayers:{},tickSelectColor:"red",tickHoverColor:"blue",tickColor:"#888"});initMapFunctions(this);var d={pointRadius:3,fillOpacity:0.8,fillColor:"#e6e6e6",fill:true,strokeColor:"#999",strokeWidth:1,scrollToZoom:false,selectOnHover:false,highlightOnHover:true};$.extend(this,d);$.extend(this,g);this.defaultStyle={pointRadius:this.pointRadius,fillOpacity:this.fillOpacity,fillColor:this.fillColor,fill:this.fill,strokeColor:this.strokeColor,strokeWidth:this.strokeWidth};this.defaults={};if(Utils.isDefined(g.onSelect)){this.onSelect=g.onSelect}else{this.onSelect=null}if(g.initialLocation){this.defaultLocation=createLonLat(g.initialLocation[1],g.initialLocation[0])}else{if(Utils.isDefined(g.initialBounds)&&g.initialBounds[0]<=90&&g.initialBounds[0]>=-90){this.defaultBounds=createBounds(g.initialBounds[1],g.initialBounds[2],g.initialBounds[3],g.initialBounds[0])}}var b={projection:this.sourceProjection,displayProjection:this.displayProjection,units:this.projectionUnits,controls:[],maxResolution:156543.0339,maxExtent:mapDefaults.maxExtent,div:this.mapDivId,eventListeners:{featureover:function(h){theMap.handleFeatureover(h.feature)},featureout:function(h){theMap.handleFeatureout(h.feature)},nofeatureclick:function(h){theMap.handleNofeatureclick(h.layer)},featureclick:function(h){theMap.handleFeatureclick(h.layer,h.feature)}}};this.mapOptions=b;theMap.finishMapInit();jQuery(document).ready(function(h){if(theMap.getMap()){theMap.getMap().updateSize()}})}function initMapFunctions(b){RamaddaUtil.defineMembers(b,{finishMapInit:function(){let _this=this;if(this.showSearch){this.searchDiv=this.mapDivId+"_search";var k=HtmlUtils.checkbox(this.searchDiv+"_download",[],false);var g='<input placeholder="Search - ? for help" id="'+this.searchDiv+'_input" size=40>';var j="<table width=100%><tr><td>"+g+' <span  id="'+this.searchDiv+'_message"></span></td><td align=right>'+k+" Download</td></tr></table>";$("#"+this.searchDiv).html(j);this.searchMsg=$("#"+this.searchDiv+"_message");var d=$("#"+this.searchDiv+"_input");d.keypress(function(m){if(m.which==13){_this.searchFor(d.val())}})}this.map=new OpenLayers.Map(this.mapDivId,this.mapOptions);var l=function(){_this.map.events.register("changebaselayer","",function(){_this.baseLayerChanged()});_this.map.events.register("zoomend","",function(){_this.locationChanged()});_this.map.events.register("moveend","",function(){_this.locationChanged()})};setTimeout(l,2000);if(this.mapHidden){this.map.size=new OpenLayers.Size(1,1)}this.addBaseLayers();if(this.kmlLayer){var h=ramaddaBaseUrl+"/entry/show?output=shapefile.kml&entryid="+this.kmlLayer;this.addKMLLayer(this.kmlLayerName,h,false,null,null,null,null)}if(this.geojsonLayer){var h=getRamadda().getEntryDownloadUrl(this.geojsonLayer);this.addGeoJsonLayer(this.geojsonLayerName,h,false,null,null,null,null)}},locationChanged:function(){var g=this.transformProjBounds(this.map.getExtent());var h="map_bounds="+g.top+","+g.left+","+g.bottom+","+g.right;var d=""+window.location;d=d.replace(/\&?map_bounds=[-\d\.]+,[-\d\.]+,[-\d\.]+,[-\d\.]+/g,"");if(!d.includes("?")){d+="?"}d+="&"+h;try{if(window.history.replaceState){window.history.replaceState("","",d)}}catch(j){console.log("err:"+j)}},baseLayerChanged:function(){var g=this.map.baseLayer;if(!g){return}g=g.ramaddaId;var j=this.transformProjBounds(this.map.getExtent());var d="map_layer="+g;var h=""+window.location;h=h.replace(/\&?map_layer=[a-z\.]+/g,"");if(!h.includes("?")){h+="?"}h+="&"+d;try{if(window.history.replaceState){window.history.replaceState("","",h)}}catch(k){console.log("err:"+k)}},setMapDiv:function(d){this.mapHidden=false;this.mapDivId=d;b.getMap().render(b.mapDivId);b.getMap().updateSize();b.centerOnMarkers(b.dfltBounds)},handleFeatureover:function(g,h){var d=g.layer;if(!(d.isMapLayer===true)){if(!h&&g.text){this.showFeatureText(g)}return}if(d.canSelect===false||!(d.isMapLayer===true)){return}var k=this;if(!g.isSelected){g.originalStyle=g.style;g.style=null;d.drawFeature(g,"temporary");if(this.displayDiv){this.displayedFeature=g;var j=function(){if(k.displayedFeature==g){k.showText(k.getFeatureText(d,g));k.dateFeatureOver(g)}};if(!h){setTimeout(j,500)}}}},handleFeatureout:function(d,g){layer=d.layer;if(layer&&!(layer.isMapLayer===true)){if(!g){if(d.text&&!this.fixedText){this.hideFeatureText(d)}}return}if(layer==null||layer.canSelect===false){return}d.style=d.originalStyle;if(!d.isSelected){layer.drawFeature(d,d.style||"default")}this.dateFeatureOut(d);if(!g&&this.displayedFeature==d&&!this.fixedText){this.showText("")}},getLayerCanSelect:function(d){if(!d){return false}return d.canSelect},handleNofeatureclick:function(d){if(d.canSelect===false){return}if(d&&d.selectedFeature){this.unselectFeature(d.selectedFeature);this.clearDateFeature()}},handleFeatureclick:function(h,g,d){if(!h){h=g.layer}this.dateFeatureSelect(g);if(h.canSelect===false){return}if(h.selectedFeature){this.unselectFeature(h.selectedFeature)}this.selectedFeature=g;h.selectedFeature=g;h.selectedFeature.isSelected=true;h.drawFeature(h.selectedFeature,"select");if(h.selectCallback){h.feature=h.selectedFeature;if(g.originalStyle){g.style=g.originalStyle}h.selectCallback(h)}else{this.showMarkerPopup(g,true)}if(d){var k=g.geometry;if(k){var j=k.getBounds();if(j){this.getMap().zoomToExtent(j);this.getMap().setCenter(j.getCenterLonLat())}}}},unselectFeature:function(d){if(!d){return}d.renderIntent=null;d.isSelected=false;layer=d.layer;if(!layer){return}layer.drawFeature(layer.selectedFeature,layer.selectedFeature.style||"default");layer.selectedFeature.isSelected=false;layer.selectedFeature=null;this.selectedFeature=null;this.onPopupClose();return;if(!d){return}this.clearDateFeature(d);layer=d.layer;layer.selectedFeature=null;this.onPopupClose();d.isSelected=false;layer.selectedFeature=null;this.selectedFeature=null;this.checkFeatureVisible(d,true)},addLayer:function(d){if(this.map!=null){this.map.addLayer(d);this.checkLayerOrder()}else{this.initialLayers.push(d)}},checkLayerOrder:function(){if(this.circles){this.map.setLayerIndex(this.circles,this.map.layers.length-1);this.map.raiseLayer(this.circles,this.map.layers.length-1);this.circles.redraw()}if(this.markers){this.map.setLayerIndex(this.markers,this.map.layers.length-1);this.map.raiseLayer(this.markers,this.map.layers.length-1)}this.map.resetLayersZIndex()},addImageLayer:function(o,g,r,h,k,m,z,t,y,j,A,x){var q=this;var d={forSelect:false,addBox:true,isBaseLayer:false};if(x){OpenLayers.Util.extend(d,x)}if(m>88){m=88}if(t<-88){t=-88}var u=createBounds(z,t,y,m);u=this.transformLLBounds(u);var l=new OpenLayers.Layer.Image(g,h,u,new OpenLayers.Size(j,A),{numZoomLevels:3,isBaseLayer:d.isBaseLayer,resolutions:this.map.layers[0]?this.map.layers[0].resolutions:null,maxResolution:this.map.layers[0]?this.map.layers[0].resolutions[0]:null});if(d.forSelect){b.selectImage=l}var p=new createLonLat(z,m);l.lonlat=this.transformLLPoint(p);l.setVisibility(k);l.id=o;l.text=this.getPopupText(r);l.ramaddaId=o;l.ramaddaName=g;this.addLayer(l);l.north=m;l.west=z;l.south=t;l.east=y;if(!this.imageLayers){this.imageLayers={}}if(!d.isBaseLayer){this.imageLayers[o]=l}return l},addWMSLayer:function(h,g,j,d){var j=new OpenLayers.Layer.WMS(h,g,{layers:j,format:"image/png",isBaseLayer:false,srs:"epse:4326",transparent:true},{wrapDateLine:mapDefaults.wrapDateline});if(d){j.isBaseLayer=true;j.visibility=false}else{j.isBaseLayer=false;j.visibility=true}this.addLayer(j)},addMapLayer:function(h,g,j,d,k){var j;if(/\/tile\//.exec(g)){j=new OpenLayers.Layer.XYZ(h,g,{sphericalMercator:mapDefaults.doSphericalMercator,numZoomLevels:mapDefaults.zoomLevels,wrapDateLine:mapDefaults.wrapDateline})}else{j=new OpenLayers.Layer.WMS(h,g,{layers:j,format:"image/png"},{wrapDateLine:mapDefaults.wrapDateline})}if(d){j.isBaseLayer=true}else{j.isBaseLayer=false}j.visibility=false;j.reproject=true;this.addLayer(j);if(k){this.haveAddedDefaultLayer=true;this.map.setLayerIndex(j,0);this.map.setBaseLayer(j)}},getVectorLayerStyleMap:function(h,g){var j={pointRadius:this.pointRadius,fillOpacity:this.fillOpacity,fillColor:this.fillColor,fill:this.fill,strokeColor:this.strokeColor,strokeWidth:this.strokeWidth,select_fillOpacity:this.fillOpacity,select_fillColor:"#666",select_strokeColor:"#666",select_strokeWidth:1};if(g){RamaddaUtil.inherit(j,g)}var l=OpenLayers.Util.extend({},OpenLayers.Feature.Vector.style.temporary);$.extend(l,{pointRadius:j.pointRadius,fillOpacity:j.fillOpacity,strokeWidth:j.strokeWidth,strokeColor:j.strokeColor});var d=OpenLayers.Util.extend({},OpenLayers.Feature.Vector.style.select);$.extend(d,{pointRadius:3,fillOpacity:j.select_fillOpacity,fillColor:j.select_fillColor,strokeColor:j.select_strokeColor,strokeWidth:j.select_strokeWidth});var k=OpenLayers.Util.extend({},OpenLayers.Feature.Vector.style["default"]);$.extend(k,{pointRadius:j.pointRadius,fillOpacity:j.fillOpacity,fillColor:j.fillColor,fill:j.fill,strokeColor:j.strokeColor,strokeWidth:j.strokeWidth});map=new OpenLayers.StyleMap({temporary:l,"default":k,select:d});return map},getFeatureName:function(h){var k=h.attributes;for(var d in k){var g=(""+d).toLowerCase();if(!(g.includes("label"))){continue}var j=this.getAttrValue(k,d);if(j){return j}}for(var d in k){var g=(""+d).toLowerCase();if(!(g.includes("name"))){continue}var j=this.getAttrValue(k,d);if(j){return j}}},getAttrValue:function(g,d){value="";if((typeof g[d]=="object")||(typeof g[d]=="Object")){var h=g[d];if(h){value=""+h.value}}else{value=""+g[d]}return value},searchFor:function(z){var E=this;if(z){z=z.trim()}if(z==""){z=null}this.searchText=z;var l=null;var y=null;var D=false;var j=$("#"+this.searchDiv+"_download").is(":checked");var x=[];if(z){z=z.trim();if(z=="?"){D=true}z=z.toLowerCase();y=[];var H=true;tmp=z.split("|");if(tmp.length==1){tmp=z.split("&");H=tmp.length==1}for(var I=0;I<tmp.length;I++){var h=false;var q=false;var B=tmp[I];tmp2=B.split(":");var g="";var C=B;if(tmp2.length>1){g=tmp2[0];C=tmp2[1]}if(C.startsWith("!")){h=true;C=C.substring(1)}if(C.startsWith("=")){C=C.substring(1);q=true}y.push({field:g,value:C,not:h,equals:q})}}else{this.searchMsg.html("")}for(a in this.loadedLayers){var K=this.loadedLayers[a];if(K.selectedFeature){this.handleNofeatureclick(K)}for(f in K.features){var k=K.features[f];var u=k.attributes;if(!z){k.featureVisibleSearch=true;x.push(u);continue}if(D){var J="&nbsp;&nbsp;&nbsp;";var G="Enter, e.g.:<br>";G+=J+"<i>&lt;term&gt;</i> (any match)<br>";G+=J+"<i>=&lt;term&gt;</i> (exact match)<br>";G+=J+"<i>!&lt;term&gt;</i> (not match)<br>";G+=J+"<i>&lt;term 1&gt;|&lt;term 2&gt;</i> (match any)<br>";G+=J+"<i>&lt;term 1&gt;&amp;&lt;term 2&gt;</i> (match all)<br>";G+="Or by field:<br>";for(var A in u){G+=J+A.toLowerCase()+":<i>&lt;term&gt;</i><br>"}this.showText(G);return}var d=false;var t=false;var r=true;var F=false;if(B.not){t=true}for(v in y){var B=y[v];for(var A in u){if(B.field!=""&&B.field!=A.toLowerCase()){continue}var C=this.getAttrValue(u,A);C=C.toLowerCase().trim();if(B.equals){d=(C==B.value)}else{d=C.includes(B.value)}if(B.not){d=!d;if(!d){break}}else{if(d){break}}}if(d){F=true}if(!d){r=false}}if((H&&F)||(!H&&r)){k.featureVisibleSearch=true;if(this.getFeatureVisible(k)){x.push(u)}}else{k.featureVisibleSearch=false}}if(j){var m="";for(var I in x){var u=x[I];for(var A in u){if(m!=""){m+=","}m+=A.toLowerCase()}m+="\n";break}for(var I in x){var u=x[I];var o="";for(var A in u){var C=this.getAttrValue(u,A);if(C.includes(",")){C='"'+C+'"'}if(o!=""){o+=","}o+=C}o+="\n";m+=o}Utils.makeDownloadFile("download.csv",m)}this.setFeatureVisibility(K)}},checkFeatureVisible:function(g,l){var d=g.layer;var j=this.getFeatureVisible(g);if(g.originalStyle){g.style=g.originalStyle}var h=g.style;if(!h){h={};var k=d.styleMap.styles["default"].defaultStyle;$.extend(h,k);g.style=h}else{}if(!j){h.display="none"}else{h.display="inline"}if(l){if(!g.isSelected){g.renderIntent=null}d.drawFeature(g,g.style||"default")}return j},getFeatureVisible:function(d){var g=true;if(Utils.isDefined(d.featureVisibleSearch)&&!d.featureVisibleSearch){g=false}if(Utils.isDefined(d.featureVisibleDate)&&!d.featureVisibleDate){g=false}if(Utils.isDefined(d.featureVisible)&&!d.featureVisible){g=false}return g},setFeatureVisibility:function(p){var q=this;var u=this.searchText||(this.startDate&&this.endDate);var d=null;var o="";var l=false;var t=false;var h=0;var y=null;for(var m=0;m<p.features.length;m++){var x=p.features[m];var j=this.checkFeatureVisible(x,false);if(!j){this.clearDateFeature(x);t=true}else{this.dateFeatureSelect(x);l=true;h++;if(!y){y=x}o+=HtmlUtils.div(["class","ramadda-map-feature","feature-index",""+m],this.getFeatureName(x));var r=x.geometry;if(r){var k=r.getBounds();if(d){d.extend(k)}else{d=k}}}}if(h==1){this.showText(this.getFeatureText(p,y))}else{if(u||(l&&t)){var g=this.mapDivId+"_features";this.showText(HtmlUtils.div(["id",g,"class","ramadda-map-features"],o));$("#"+g+" .ramadda-map-feature").click(function(){var z=parseInt($(this).attr("feature-index"));q.handleFeatureclick(p,p.features[z],true)});$("#"+g+" .ramadda-map-feature").mouseover(function(){var z=parseInt($(this).attr("feature-index"));q.handleFeatureover(p.features[z],true)});$("#"+g+" .ramadda-map-feature").mouseout(function(){var z=parseInt($(this).attr("feature-index"));q.handleFeatureout(p.features[z],true)})}else{this.clearDateFeature();this.showText("")}}if(this.searchMsg){if(u){this.searchMsg.html(h+" matched")}else{this.searchMsg.html("")}}p.redraw();if(d){this.getMap().zoomToExtent(d);this.getMap().setCenter(d.getCenterLonLat())}else{this.centerOnMarkers(b.dfltBounds,this.centerOnMarkersForce)}},getFeatureText:function(k,r){var d=r.style||r.originalStyle||k.style;var g=r.attributes;var j=r.popupText;if(!j){if(d&&d.balloonStyle){j=d.balloonStyle;for(var l in g){var m=l.replace("_"," ");var q="";if(typeof g[l]=="object"||typeof g[l]=="Object"){var h=g[l];q=""+h.value}else{q=""+g[l]}j=j.replace("${"+d.id+"/"+l+"}",q)}}else{j="<table>";for(var l in g){var m=l;lclabel=m.toLowerCase();if(lclabel=="objectid"||lclabel=="feature_type"||lclabel=="shapearea"||lclabel=="styleurl"||lclabel=="shapelen"){continue}if(lclabel=="startdate"){m="Start Date"}else{if(lclabel=="enddate"){m="End Date"}else{if(lclabel=="aland"){m="Land Area"}else{if(lclabel=="awater"){m="Water Area"}}}}m=m.replace(/_/g," ");m=Utils.camelCase(m);j+='<tr valign=top><td align=right><div style="margin-right:5px;margin-bottom:3px;"><b>'+m+':</b></div></td><td><div style="margin-right:5px;margin-bottom:3px;">';var q;if(g[l]!=null&&(typeof g[l]=="object"||typeof g[l]=="Object")){var h=g[l];q=""+h.value}else{q=""+g[l]}if(q.startsWith("http:")||q.startsWith("https:")){q="<a href='"+q+"'>"+q+"</a>"}if(q=="null"){continue}j+=q;j+="</div></td></tr>"}j+="</table>"}}return j},onFeatureSelect:function(h){if(this.onSelect){func=window[this.onSelect];func(this,h);return}feature=h.feature;var g=this.getFeatureText(h,feature);if(this.currentPopup){this.map.removePopup(this.currentPopup);this.currentPopup.destroy()}var d=new OpenLayers.Popup.FramedCloud("popup",feature.geometry.getBounds().getCenterLonLat(),null,g,null,true,function(){b.onPopupClose()});feature.popup=d;d.feature=feature;b.map.addPopup(d);b.currentPopup=d}});b.onFeatureUnselect=function(d){this.onPopupClose()};b.removeKMLLayer=function(d){this.map.removeLayer(d)};b.setDefaultCanSelect=function(d){this.defaultCanSelect=d};b.getCanSelect=function(d){if(((typeof d)=="undefined")||(d==null)){return this.defaultCanSelect}return d};b.addSelectCallback=function(h,j,d,g){var k=this;if(this.getCanSelect(j)){if(d==null||!Utils.isDefined(d)){d=function(l){k.onFeatureSelect(l)}}if(g==null||!Utils.isDefined(g)){g=function(l){k.onFeatureUnselect()}}h.selectCallback=d;h.unselectCallback=d}};b.startDate=null;b.endDate=null;b.startFeature=null;b.endFeature=null;b.initDates=function(R){var F=this;var q=R.features;var G=false;var u=false;this.hasDates=false;this.dates=[];this.dateFeatures=[];this.minDate=null;this.maxDate=null;for(var H=0;H<q.length;H++){var o=q[H];var B=o.attributes;for(var E in B){var S=(""+E).toLowerCase();var y=S.includes("year")||S.includes("_yr");var Q=S.includes("date");if(!(Q||y)){continue}var D=this.getAttrValue(B,E);if(!D){continue}try{var N=Utils.parseDate(D);if(y){u=true}else{G=true}if(this.startDate!=null&&this.endDate!=null){if(N.getTime()<this.startDate.getTime()||N.getTime()>this.endDate.getTime()){continue}}this.dates.push(N);this.dateFeatures.push(o);this.minDate=this.minDate==null?N:this.minDate.getTime()>N.getTime()?N:this.minDate;this.maxDate=this.maxDate==null?N:this.maxDate.getTime()<N.getTime()?N:this.maxDate;o.featureDate=N;this.hasDates=true;break}catch(M){console.log("error:"+M)}}}if(this.hasDates){var j=null;if(u){j={year:"numeric"}}$("#"+this.mapDivId+"_footer").html(HtmlUtils.div(["class","ramadda-map-animation","id",this.mapDivId+"_animation"],""));this.animation=$("#"+this.mapDivId+"_animation");var I=HtmlUtils.div(["class","ramadda-map-animation-ticks","id",this.mapDivId+"_animation_ticks"],"");var A=HtmlUtils.div(["class","ramadda-map-animation-info","id",this.mapDivId+"_animation_info"],"");this.animation.html(I+A);var r=Utils.formatDate(this.minDate,j);var k=Utils.formatDate(this.maxDate,j);this.animationTicks=$("#"+this.mapDivId+"_animation_ticks");this.animationInfo=$("#"+this.mapDivId+"_animation_info");var P="";if(this.startDate&&this.endDate){P=HtmlUtils.div(["id",this.mapDivId+"_ticks_reset","class","ramadda-map-animation-tick-reset"],"Reset")}var L="<table width=100%><tr valign=top><td width=40%>"+r+"</td><td align=center width=20%>"+P+"</td><td align=right width=40%>"+k+"</td></tr></table>";this.animationInfo.html(L);if(this.startDate&&this.endDate){var O=$("#"+this.mapDivId+"_ticks_reset");O.click(function(){F.startDate=null;F.endDate=null;F.startFeature=null;F.endFeature=null;F.setFeatureDateRange(R)})}var C=this.animationTicks.width();var g=C>0?5/C:0;var x="";var m=this.minDate.getTime();var h=this.maxDate.getTime();if(this.startDate!=null&&this.endDate!=null){m=this.startDate.getTime();h=this.endDate.getTime()}var z=h-m;if(z>0){for(var H=0;H<this.dates.length;H++){var N=this.dates[H];var t=N.getTime();if(t<m||t>h){continue}var o=this.dateFeatures[H];o.dateIndex=H;var d=100*(t-m)/z;d=d-d*g;var K=N.toLocaleDateString("en-US",j);var S=Utils.camelCase(this.getFeatureName(o));var l="";l+=S!=null?S+"<br>":"";l+=K;l+="<br>shift-click: set visible range<br>cmd/ctrl-click:zoom";l+="";x+=HtmlUtils.div(["id",this.mapDivId+"_tick"+H,"feature-index",""+H,"style","left:"+d+"%","class","ramadda-map-animation-tick","title",l],"")}}this.animationTicks.html(x);var J=$("#"+this.mapDivId+"_animation .ramadda-map-animation-tick");J.tooltip({content:function(){return $(this).prop("title")},position:{my:"left top",at:"left bottom+2"},classes:{"ui-tooltip":"ramadda-tooltip"}});J.mouseover(function(){var p=parseInt($(this).attr("feature-index"));var T=F.dateFeatures[p];F.handleFeatureover(T,true)});J.mouseout(function(){var p=parseInt($(this).attr("feature-index"));var T=F.dateFeatures[p];F.handleFeatureout(T,true)});J.click(function(T){var U=parseInt($(this).attr("feature-index"));var W=F.dateFeatures[U];if(T.shiftKey){if(F.startDate==null){F.startDate=W.featureDate;F.startFeature=W;F.dateFeatureSelect(W)}else{if(F.endDate==null){F.endDate=W.featureDate;F.endFeature=W;F.dateFeatureSelect(W)}else{F.dateFeatureSelect(null);F.startDate=W.featureDate;F.startFeature=W;F.endDate=null;F.endFeature=null;F.dateFeatureSelect(W)}}console.log("date:"+F.startDate+" "+F.endDate);if(F.startDate!=null&&F.endDate!=null){if(F.startDate.getTime()==F.endDate.getTime()){F.startDate=null;F.startFeature=null;F.endDate=null;F.endFeature=null;F.dateFeatureSelect(null);return}else{if(F.startDate.getTime()>F.endDate.getTime()){var V=F.startDate;F.startDate=F.endDate;F.endDate=V;V=F.startFeature;F.startFeature=F.endFeature;F.endFeature=V}}F.setFeatureDateRange(W.layer)}}else{var p=T.metaKey||T.ctrlKey;if(F.startDate!=null||F.endDate!=null){F.startDate=null;F.endDate=null;F.setFeatureDateRange(W.layer,W.featureDate)}F.clearDateFeature();F.handleFeatureclick(W.layer,W,p)}})}};b.setFeatureDateRange=function(h){this.dateFeatureSelect(null);console.log("set range:"+this.startDate+" "+this.endDate);var j=h.features;if(h.selectedFeature){this.unselectFeature(h.selectedFeature)}for(var g=0;g<j.length;g++){var d=j[g];if(this.startDate&&this.endDate&&d.featureDate){d.featureVisibleDate=this.startDate.getTime()<=d.featureDate.getTime()&&d.featureDate.getTime()<=this.endDate.getTime()}else{d.featureVisibleDate=true}}this.setFeatureVisibility(h);this.initDates(h)};b.dateFeatureSelect=function(g){var d=this.getFeatureTick(g);d.css("background-color",this.tickSelectColor);d.css("zIndex","100")};b.dateFeatureOver=function(g){var d=this.getFeatureTick(g);d.css("background-color",this.tickHoverColor);d.css("zIndex","100");this.getFeatureTick(null).tooltip("close");d.tooltip("open")};b.dateFeatureOut=function(g){var d=this.getFeatureTick(g);if(g&&(g==this.startFeature||g==this.endFeature)){d.css("background-color",this.tickSelectColor);d.css("zIndex","0")}else{d.css("background-color","");d.css("zIndex","0")}d.tooltip("close")};b.getFeatureTick=function(d){if(!d){return $("#"+this.mapDivId+"_animation_ticks .ramadda-map-animation-tick")}return $("#"+this.mapDivId+"_tick"+d.dateIndex)};b.clearDateFeature=function(g){var d=g!=null?$("#"+this.mapDivId+"_tick"+g.dateIndex):$("#"+this.mapDivId+"_animation_ticks .ramadda-map-animation-tick");d.css("background-color","");d.css("zIndex","0")};b.initMapVectorLayer=function(j,k,g,h,d){var l=this;this.showLoadingImage();j.isMapLayer=true;j.canSelect=k;this.loadedLayers.push(j);j.events.on({loadend:function(m){l.hideLoadingImage();if(m.response&&Utils.isDefined(m.response.code)&&m.response.code==OpenLayers.Protocol.Response.FAILURE){console.log("An error occurred loading the map");return}if(l.centerOnMarkersCalled){l.centerOnMarkers(l.dfltBounds,l.centerOnMarkersForce)}if(d){d(l,j)}if(j.features.length==1&&l.displayDiv){l.fixedText=true;l.showText(l.getFeatureText(j,j.features[0]))}l.initDates(j)}});this.addLayer(j);this.addSelectCallback(j,k,g,h)};b.addGeoJsonLayer=function(k,j,o,g,m,h,d){var l=new OpenLayers.Layer.Vector(k,{projection:this.displayProjection,strategies:[new OpenLayers.Strategy.Fixed()],protocol:new OpenLayers.Protocol.HTTP({url:j,format:new OpenLayers.Format.GeoJSON({})})});l.styleMap=this.getVectorLayerStyleMap(l,h);this.initMapVectorLayer(l,o,g,m,d);return l};b.addKMLLayer=function(k,j,o,g,m,h,d){var l=new OpenLayers.Layer.Vector(k,{projection:this.displayProjection,strategies:[new OpenLayers.Strategy.Fixed()],protocol:new OpenLayers.Protocol.HTTP({url:j,format:new OpenLayers.Format.KML({extractStyles:true,extractAttributes:true,maxDepth:2})})});l.styleMap=this.getVectorLayerStyleMap(l,h);this.initMapVectorLayer(l,o,g,m,d);return l};b.createXYZLayer=function(j,h,d){var g={sphericalMercator:mapDefaults.doSphericalMercator,numZoomLevels:mapDefaults.zoomLevels,wrapDateLine:mapDefaults.wrapDateline};if(d){g.attribution=d}return new OpenLayers.Layer.XYZ(j,h,g)};b.addBaseLayers=function(){if(!this.mapLayers){this.mapLayers=[map_osm,map_esri_topo,map_esri_street,map_opentopo,map_usfs_ownership,map_usgs_topo,map_usgs_imagery,map_usgs_relief,map_osm_toner,map_watercolor,map_white,map_gray,map_blue,map_black]}var k=this.defaultMapLayer||map_osm;if(!this.haveAddedDefaultLayer&&k){var g=this.mapLayers.indexOf(k);if(g>=0){this.mapLayers.splice(g,1);this.mapLayers.splice(0,0,k)}}this.firstLayer=null;this.hybridLayer=null;this.defaultOLMapLayer=null;for(i=0;i<this.mapLayers.length;i++){mapLayer=this.mapLayers[i];if(mapLayer==null){continue}var j=null;if(mapLayer==map_osm){urls=["//a.tile.openstreetmap.org/${z}/${x}/${y}.png","//b.tile.openstreetmap.org/${z}/${x}/${y}.png","//c.tile.openstreetmap.org/${z}/${x}/${y}.png"];j=new OpenLayers.Layer.OSM("Open Street Map",urls)}else{if(mapLayer==map_osm_toner){urls=["http://a.tile.stamen.com/toner/${z}/${x}/${y}.png"];j=new OpenLayers.Layer.OSM("OSM-Toner",urls)}else{if(mapLayer==map_watercolor){urls=["http://c.tile.stamen.com/watercolor/${z}/${x}/${y}.jpg"];j=new OpenLayers.Layer.OSM("Watercolor",urls)}else{if(mapLayer==map_opentopo){j=this.createXYZLayer("OpenTopo","//a.tile.opentopomap.org/${z}/${x}/${y}.png}")}else{if(mapLayer==map_esri_worldimagery){j=this.createXYZLayer("ESRI World Imagery","https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}")}else{if(mapLayer==map_white){this.addImageLayer(map_white,"White Background","",ramaddaBaseUrl+"/images/white.png",false,90,-180,-90,180,50,50,{isBaseLayer:true});continue}else{if(mapLayer==map_gray){this.addImageLayer(map_gray,"Gray Background","",ramaddaBaseUrl+"/images/gray.png",false,90,-180,-90,180,50,50,{isBaseLayer:true});continue}else{if(mapLayer==map_blue){this.addImageLayer(map_blue,"Blue Background","",ramaddaBaseUrl+"/images/blue.png",false,90,-180,-90,180,50,50,{isBaseLayer:true});continue}else{if(mapLayer==map_black){this.addImageLayer(map_black,"Black Background","",ramaddaBaseUrl+"/images/black.png",false,90,-180,-90,180,50,50,{isBaseLayer:true});continue}else{if(mapLayer==map_usgs_topo){j=this.createXYZLayer("USGS Topo","https://basemap.nationalmap.gov/ArcGIS/rest/services/USGSTopo/MapServer/tile/${z}/${y}/${x}","USGS - The National Map")}else{if(mapLayer==map_usgs_imagery){j=this.createXYZLayer("USGS Imagery","https://basemap.nationalmap.gov/ArcGIS/rest/services/USGSImageryOnly/MapServer/tile/${z}/${y}/${x}","USGS - The National Map")}else{if(mapLayer==map_usgs_relief){j=this.createXYZLayer("USGS Shaded Relief","https://basemap.nationalmap.gov/ArcGIS/rest/services/USGSShadedReliefOnly/MapServer/tile/${z}/${y}/${x}","USGS - The National Map")}else{if(mapLayer==map_esri_topo){j=this.createXYZLayer("ESRI Topo","https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/${z}/${y}/${x}")}else{if(mapLayer==map_usfs_ownership){j=this.createXYZLayer("USFS Ownership","https://apps.fs.usda.gov/arcx/rest/services/wo_nfs_gstc/GSTC_TravelAccessBasemap_01/MapServer/tile/${z}/${y}/${x}")}else{if(mapLayer==map_esri_street){j=this.createXYZLayer("ESRI Streets","https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/${z}/${y}/${x}")}else{if(/\/tile\//.exec(mapLayer)){var h=mapLayer;j=new OpenLayers.Layer.XYZ("ESRI China Map",h,{sphericalMercator:mapDefaults.doSphericalMercator,numZoomLevels:mapDefaults.zoomLevels,wrapDateLine:mapDefaults.wrapDateline})}else{if(mapLayer==map_ms_shaded){j=new OpenLayers.Layer.VirtualEarth("Virtual Earth - Shaded",{type:VEMapStyle.Shaded,sphericalMercator:mapDefaults.doSphericalMercator,wrapDateLine:mapDefaults.wrapDateline,numZoomLevels:mapDefaults.zoomLevels})}else{if(mapLayer==map_ms_hybrid){j=new OpenLayers.Layer.VirtualEarth("Virtual Earth - Hybrid",{type:VEMapStyle.Hybrid,sphericalMercator:mapDefaults.doSphericalMercator,numZoomLevels:mapDefaults.zoomLevels,wrapDateLine:mapDefaults.wrapDateline})}else{if(mapLayer==map_ms_aerial){j=new OpenLayers.Layer.VirtualEarth("Virtual Earth - Aerial",{type:VEMapStyle.Aerial,sphericalMercator:mapDefaults.doSphericalMercator,numZoomLevels:mapDefaults.zoomLevels,wrapDateLine:mapDefaults.wrapDateline})}else{var d=/wms:(.*),(.*),(.*)/.exec(mapLayer);if(!d){alert("no match for map layer:"+mapLayer);continue}this.addWMSLayer(d[1],d[2],d[3],true)}}}}}}}}}}}}}}}}}}}if(this.firstLayer==null){this.firstLayer=j}if(j!=null){j.ramaddaId=mapLayer;if(mapLayer==this.defaultMapLayer){this.defaultOLMapLayer=j}this.addLayer(j)}}this.graticule=new OpenLayers.Control.Graticule({layerName:"Lat/Lon Lines",numPoints:2,labelled:true,visible:false});this.map.addControl(this.graticule);return};b.initSearch=function(d){$("#"+d).keyup(function(g){if(g.keyCode==13){b.searchMarkers($("#"+d).val())}})};b.searchMarkers=function(r){r=r.trim();r=r.toLowerCase();var p=r=="";var k=$(':input[id*="visibleall_'+this.mapId+'"]');k.prop("checked",p);if(this.markers){var o=this.getMarkers();for(var q=0;q<o.length;q++){m=o[q];var j=true;var h=$("#visible_"+this.mapId+"_"+m.ramaddaId);var d=m.name;if(p){j=true}else{if(!Utils.isDefined(d)){j=false}else{j=d.toLowerCase().includes(r)}}if(j){m.style.display="inline"}else{m.style.display="none"}h.prop("checked",j)}this.markers.redraw()}if(this.boxes&&this.boxes.markers){for(var m in this.boxes.markers){m=this.boxes.markers[m];d=m.name;var j=true;if(p){j=true}else{if(!Utils.isDefined(d)){j=false}else{j=d.toLowerCase().includes(r)}}m.display(j)}this.boxes.redraw()}if(this.lines){var g=this.lines.features;for(var l=0;l<g.length;l++){var t=g[l];d=t.name;var j=true;if(p){j=true}else{if(!Utils.isDefined(d)){j=false}else{j=d.toLowerCase().includes(r)}}if(j){t.style.display="inline"}else{t.style.display="none"}}this.lines.redraw()}};b.setLatLonReadout=function(d){this.latlonReadout=d};b.getMap=function(){return this.map};b.initMap=function(j){this.startTime=Date.now();if(this.inited){return}this.inited=true;let b=this;if(this.enableDragPan){this.map.addControl(new OpenLayers.Control.Navigation({zoomWheelEnabled:this.scrollToZoom,dragPanOptions:{enableKinetic:true}}))}if(this.showZoomPanControl&&!this.showZoomOnlyControl){this.map.addControl(new OpenLayers.Control.PanZoom())}if(this.showZoomOnlyControl&&!this.showZoomPanControl){this.map.addControl(new OpenLayers.Control.Zoom())}if(this.showScaleLine){this.map.addControl(new OpenLayers.Control.ScaleLine())}var u=new OpenLayers.Control();var q=new OpenLayers.Control();var t={keydown:function(y){if(y.keyCode==79){if(!b.imageLayers){return}for(id in b.imageLayers){image=b.imageLayers[id];if(!Utils.isDefined(image.opacity)){image.opacity=1}opacity=image.opacity;if(y.shiftKey){opacity+=0.1}else{opacity-=0.1}if(opacity<0){opacity=0}else{if(opacity>1){opacity=1}}image.setOpacity(opacity)}}if(y.keyCode==84){if(b.selectImage){b.selectImage.setVisibility(!b.selectImage.getVisibility())}}}};var x=new OpenLayers.Handler.Keyboard(q,t,{});x.activate();this.map.addControl(u);this.map.addControl(new OpenLayers.Control.KeyboardDefaults());if(this.showLayerSwitcher){this.map.addControl(new OpenLayers.Control.LayerSwitcher())}if(this.showLatLonPosition){var h=GuiUtils.getDomObject(this.latlonReadout);if(h){this.map.addControl(new OpenLayers.Control.MousePosition({numDigits:3,element:h.obj,prefix:"Position: "}))}else{this.map.addControl(new OpenLayers.Control.MousePosition({numDigits:3,prefix:"Position: "}))}}this.initLocationSearch();if(this.defaultLocation&&!this.defaultBounds){var d=this.defaultLocation;var m=10;this.defaultBounds=createBounds(d.lon-m,d.lat-m,d.lon+m,d.lat+m);this.defaultLocation=null}if(this.defaultBounds){var p=this.defaultBounds.getCenterLonLat();var k=this.transformLLPoint(p);this.map.setCenter(k);this.map.zoomToExtent(this.transformLLBounds(this.defaultBounds));this.defaultBounds=null}else{this.map.zoomToMaxExtent()}for(var o=0;o<this.initialLayers.length;o++){this.addLayer(this.initialLayers[o])}this.initialLayers=[];if(j){this.addRegionSelectorControl()}var g=$(':input[id*="visible_'+this.mapId+'"]');var r=this;g.change(function(y){r.checkImageLayerVisibility();r.checkMarkerVisibility();r.checkLinesVisibility();r.checkBoxesVisibility()});var l=$(':input[id*="visibleall_'+this.mapId+'"]');l.change(function(y){g.prop("checked",l.is(":checked"));r.checkImageLayerVisibility();r.checkMarkerVisibility();r.checkLinesVisibility();r.checkBoxesVisibility()})};b.initLocationSearch=function(){let _this=this;var d=HtmlUtils.span(["style","padding-right:4px;","id",this.mapDivId+"_loc_search_wait"],"")+HtmlUtils.checkbox(this.mapDivId+"_loc_bounds",["title","Search in map bounds"],false)+" In view "+HtmlUtils.input("","",["placeholder","Search location","id",this.mapDivId+"_loc_search"]);$("#"+this.mapDivId+"_footer2").html(d);let searchInput=$("#"+this.mapDivId+"_loc_search");let bounds=$("#"+this.mapDivId+"_loc_bounds");let searchPopup=$("#"+this.mapDivId+"_loc_popup");let wait=$("#"+this.mapDivId+"_loc_search_wait");searchInput.blur(function(g){setTimeout(function(){wait.html("");searchPopup.hide()},500)});searchInput.keypress(function(k){if(searchInput.val()==""&&_this.searchMarker){_this.removeMarker(_this.searchMarker)}var j=k.keyCode||k.which;if(j==27){searchPopup.hide();return}if(j!=13){return}wait.html(HtmlUtils.image(icon_wait));var h=ramaddaBaseUrl+"/geocode?query="+encodeURIComponent(searchInput.val());if(bounds.is(":checked")){var g=_this.transformProjBounds(_this.map.getExtent());h+="&bounds="+g.top+","+g.left+","+g.bottom+","+g.right}var l=$.getJSON(h,function(t){wait.html("");var z=HtmlUtils.openTag("div",["style","max-height:400px;overflow-y:auto;"]);if(t.result.length==0){wait.html("Nothing found");return}else{if(false&&t.result.length==1){var x=t.result[0].latitude;var o=t.result[0].longitude;var r=0.1;var m=_this.transformLLBounds(createBounds(o-r,x-r,o+r,x+r));_this.map.zoomToExtent(m);return}for(var u=0;u<t.result.length;u++){var q=t.result[u].name.replace('"',"'");z+=HtmlUtils.div(["style","padding:4px;","class","ramadda-div-link","name",q,"latitude",t.result[u].latitude,"longitude",t.result[u].longitude],t.result[u].name)}}var y="left bottom";var p="left top";z+=HtmlUtils.closeTag("div");searchPopup.html(z);popupObject=GuiUtils.getDomObject(_this.mapDivId+"_loc_popup");searchPopup.show();searchPopup.position({of:searchInput,my:y,at:p,collision:"fit fit"});searchPopup.find(".ramadda-div-link").click(function(){searchPopup.hide();var A=$(this).attr("name");var D=parseFloat($(this).attr("latitude"));var F=parseFloat($(this).attr("longitude"));var E=0.1;var B=_this.transformLLBounds(createBounds(F-E,D-E,F+E,D+E));var C=new createLonLat(F,D);if(_this.searchMarker){_this.removeMarker(_this.searchMarker)}_this.searchMarker=_this.addMarker("search",C,ramaddaBaseUrl+"/icons/green-dot.png","",A,20,20);_this.map.zoomToExtent(B)})}).fail(function(o,p,m){wait.html("Error:"+m)})})};b.addVectorLayer=function(d,g){this.addLayer(d);if(this.getCanSelect(g)){this.vectorLayers.push(d);var h=this;if(!this.map.featureSelect){this.map.featureSelect=new OpenLayers.Control.SelectFeature(d,{multiple:false,hover:this.selectOnHover,onSelect:function(j){h.showMarkerPopup(j,true)}})}else{this.map.featureSelect.setLayer(this.vectorLayers)}}};b.isLayerVisible=function(h,g){var d=$("#visible_"+this.mapId+"_"+h);if(d.size()==0&&g!=null){d=$("#visible_"+this.mapId+"_"+g)}if(d.size()==0){return true}return d.is(":checked")};b.initForDrawing=function(){var d=this;if(!d.drawingLayer){this.drawingLayer=new OpenLayers.Layer.Vector("Drawing");this.addLayer(d.drawingLayer)}this.drawControl=new OpenLayers.Control.DrawFeature(d.drawingLayer,OpenLayers.Handler.Point);this.map.addControl(d.drawControl)};b.drawingFeatureAdded=function(d){};b.addClickHandler=function(h,d,j,g){this.lonFldId=h;this.latFldId=d;if(this.clickHandler){return}if(!this.map){return}this.clickHandler=new OpenLayers.Control.Click();this.clickHandler.setLatLonZoomFld(h,d,j,g);this.clickHandler.setTheMap(this);this.map.addControl(this.clickHandler);this.clickHandler.activate()};b.setSelection=function(d,g,h){this.selectRegion=g;this.argBase=d;if(!GuiUtils){return}this.fldNorth=GuiUtils.getDomObject(this.argBase+"_north");if(this.fldNorth==null){this.fldNorth=GuiUtils.getDomObject(this.argBase+".north")}if(this.fldNorth==null){this.fldNorth=GuiUtils.getDomObject(this.mapId+"_north")}this.fldSouth=GuiUtils.getDomObject(this.argBase+"_south");if(!this.fldSouth){this.fldSouth=GuiUtils.getDomObject(this.argBase+".south")}if(this.fldSouth==null){this.fldSouth=GuiUtils.getDomObject(this.mapId+"_south")}this.fldEast=GuiUtils.getDomObject(this.argBase+"_east");if(!this.fldEast){this.fldEast=GuiUtils.getDomObject(this.argBase+".east")}if(this.fldEast==null){this.fldEast=GuiUtils.getDomObject(this.mapId+"_east")}this.fldWest=GuiUtils.getDomObject(this.argBase+"_west");if(!this.fldWest){this.fldWest=GuiUtils.getDomObject(this.argBase+".west")}if(this.fldWest==null){this.fldWest=GuiUtils.getDomObject(this.mapId+"_west")}this.fldLat=GuiUtils.getDomObject(this.argBase+"_latitude");if(!this.fldLat){this.fldLat=GuiUtils.getDomObject(this.argBase+".latitude")}if(this.fldLat==null){this.fldLat=GuiUtils.getDomObject(this.mapId+"_latitude")}this.fldLon=GuiUtils.getDomObject(this.argBase+"_longitude");if(!this.fldLon){this.fldLon=GuiUtils.getDomObject(this.argBase+".longitude")}if(this.fldLon==null){this.fldLon=GuiUtils.getDomObject(this.mapId+"_longitude")}if(this.fldLon){this.addClickHandler(this.fldLon.id,this.fldLat.id);this.setSelectionMarker(this.fldLon.obj.value,this.fldLat.obj.value)}};b.selectionPopupInit=function(){if(!this.inited){this.initMap(this.selectRegion);if(this.argBase&&!this.fldNorth){this.setSelection(this.argBase)}if(this.fldNorth){this.setSelectionBox(this.fldNorth.obj.value,this.fldWest.obj.value,this.fldSouth.obj.value,this.fldEast.obj.value,true)}if(this.fldLon){this.addClickHandler(this.fldLon.id,this.fldLat.id);this.setSelectionMarker(this.fldLon.obj.value,this.fldLat.obj.value)}}};b.setSelectionBoxFromFields=function(g){if(this.fldNorth){this.setSelectionBox(this.fldNorth.obj.value,this.fldWest.obj.value,this.fldSouth.obj.value,this.fldEast.obj.value,true);if(this.selectorBox){var d=this.selectorBox.bounds;this.map.setCenter(d.getCenterLonLat());if(g){this.map.zoomToExtent(d)}}}};b.toggleSelectorBox=function(d){if(this.selectorControl){if(d){this.selectorControl.activate();this.selectorControl.box.activate()}else{this.selectorControl.deactivate();this.selectorControl.box.deactivate()}}};b.resetExtent=function(){this.map.zoomToMaxExtent()};b.setSelectionBox=function(o,g,k,j,d){if(o==""||g==""||k==""||j==""){return}var m=createBounds(g,Math.max(k,-mapDefaults.maxLatValue),j,Math.min(o,mapDefaults.maxLatValue));if(!this.selectorBox){var h={color:"red",selectable:false};this.selectorBox=this.createBox("","Selector box",o,g,k,j,"",h)}else{this.selectorBox.bounds=this.transformLLBounds(m)}if(d){this.setViewToBounds(m)}if(this.boxes){this.boxes.redraw()}if(b.selectImage){var l=createBounds(g,k,j,o);l=b.transformLLBounds(l);b.selectImage.extent=l;b.selectImage.redraw()}};b.clearSelectionMarker=function(){if(this.selectorMarker!=null){this.removeMarker(this.selectorMarker);this.selectorMarker=null}};b.clearSelectedFeatures=function(){if(this.map.controls!=null){var d=this.map.controls;for(i=0;i<d.length;i++){if(d[i].displayClass=="olControlSelectFeature"){d[i].unselectAll()}}}};b.setSelectionMarker=function(m,k,j,g){if(!m||!k||m==""||k==""){return}if(this.lonFldId!=null){$("#"+this.lonFldId).val(formatLocationValue(m));$("#"+this.latFldId).val(formatLocationValue(k))}var h=new createLonLat(m,k);if(this.selectorMarker==null){this.selectorMarker=this.addMarker(positionMarkerID,h,"","","",20,10)}else{this.selectorMarker.lonlat=this.transformLLPoint(h)}if(this.markers){this.markers.redraw()}if(j){this.map.setCenter(this.selectorMarker.lonlat)}if(g){if(g.zoomOut){var o=this.map.getZoom();o--;if(this.map.isValidZoomLevel(o)){this.map.zoomTo(o)}return}if(g.zoomIn){var o=this.map.getZoom();o++;if(this.map.isValidZoomLevel(o)){this.map.zoomTo(o)}return}var l=g.offset;if(l){var d=this.transformLLBounds(createBounds(m-l,k-l,m+l,k+l));this.map.zoomToExtent(d)}}};b.transformLLBounds=function(g){if(!g){return}var d=g.clone();return d.transform(this.displayProjection,this.sourceProjection)};b.transformLLPoint=function(d){if(!d){return null}var g=d.clone();return g.transform(this.displayProjection,this.sourceProjection)};b.transformProjBounds=function(g){if(!g){return}var d=g.clone();return d.transform(this.sourceProjection,this.displayProjection)};b.transformProjPoint=function(d){if(!d){return}var g=d.clone();return g.transform(this.sourceProjection,this.displayProjection)};b.normalizeBounds=function(h){if(!this.map){return h}var j=h;var g=h.left;var d=h.right;var k=this.map.restrictedExtent;if(!k){k=this.maxExtent}if(!k){return h}if(k.left>=0){if(h.left<0){g=h.left+360}if(h.right<0){d=h.right+360}}if(g>d){d=h.right+360}g=Math.max(g,k.left);d=Math.min(d,k.right);j=createBounds(g,h.bottom,d,h.top);return j};b.findSelectionFields=function(){if(this.argBase&&!(this.fldNorth||this.fldLon)){this.setSelection(this.argBase)}};b.selectionClear=function(){this.findSelectionFields();if(this.fldNorth){this.fldNorth.obj.value="";this.fldSouth.obj.value="";this.fldWest.obj.value="";this.fldEast.obj.value=""}else{if(this.fldLat){this.fldLon.obj.value="";this.fldLat.obj.value=""}}if(this.selectorBox&&this.boxes){this.boxes.removeMarker(this.selectorBox);this.selectorBox=null}if(this.selectorMarker&&this.markers){this.removeMarker(this.selectorMarker);this.selectorMarker=null}};b.getMarkers=function(){if(this.markers==null){return[]}return this.markers.features},b.clearRegionSelector=function(d){if(!this.selectorControl){return}if(this.selectorControl.box){this.selectorControl.box.removeBox()}},b.addRegionSelectorControl=function(g){var d=this;if(d.selectorControl){return}d.selectorListener=g;d.selectorControl=new OpenLayers.Control();OpenLayers.Util.extend(d.selectorControl,{draw:function(){this.box=new OpenLayers.Handler.Box(d.selectorControl,{done:this.notice},{keyMask:OpenLayers.Handler.MOD_SHIFT,xxxboxDivClassName:"map-drag-box"});this.box.activate()},notice:function(h){var j=this.map.getLonLatFromPixel(new OpenLayers.Pixel(h.left,h.bottom));var k=this.map.getLonLatFromPixel(new OpenLayers.Pixel(h.right,h.top));j=d.transformProjPoint(j);k=d.transformProjPoint(k);var h=createBounds(j.lon,j.lat,k.lon,k.lat);h=d.normalizeBounds(h);d.setSelectionBox(h.top,h.left,h.bottom,h.right,false);d.findSelectionFields();if(g){g(h)}if(d.fldNorth){d.fldNorth.obj.value=formatLocationValue(h.top);d.fldSouth.obj.value=formatLocationValue(h.bottom);d.fldWest.obj.value=formatLocationValue(h.left);d.fldEast.obj.value=formatLocationValue(h.right)}}});d.map.addControl(d.selectorControl);d.panControl=new OpenLayers.Control();OpenLayers.Util.extend(d.panControl,{draw:function(){this.box=new OpenLayers.Handler.Drag(d.panControl,{down:this.down,move:this.move},{keyMask:OpenLayers.Handler.MOD_META,boxDivClassName:"map-drag-box"});this.box.activate()},down:function(h){this.firstPoint=this.map.getLonLatFromPixel(new OpenLayers.Pixel(h.x,h.y));this.firstPoint=d.transformProjPoint(this.firstPoint);d.findSelectionFields();if(d.fldNorth){n=this.origNorth=parseFloat(d.fldNorth.obj.value);s=this.origSouth=parseFloat(d.fldSouth.obj.value);w=this.origWest=parseFloat(d.fldWest.obj.value);e=this.origEast=parseFloat(d.fldEast.obj.value);h=this.firstPoint;this.doWest=false;this.doSouth=false;this.doEast=false;this.doNorth=false;if(h.lon<=e&&h.lon>=w&&h.lat<=n&&h.lat>=s){this.doSouth=this.doWest=this.doEast=this.doNorth=true;this.type="center"}else{if(h.lon>e){if(h.lat>n){this.type="ne";this.doEast=this.doNorth=true}else{if(h.lat<s){this.type="se";this.doSouth=this.doEast=true}else{this.type="e";this.doEast=true}}}else{if(h.lon<w){if(h.lat>n){this.type="nw";this.doWest=this.doNorth=true}else{if(h.lat<s){this.type="sw";this.doSouth=this.doWest=true}else{this.type="w";this.doWest=true}}}else{if(h.lat>n){this.type="n";this.doNorth=true}else{this.type="s";this.doSouth=true}}}}}},move:function(k){var j=this.map.getLonLatFromPixel(new OpenLayers.Pixel(k.x,k.y));j=d.transformProjPoint(j);dx=j.lon-this.firstPoint.lon;dy=j.lat-this.firstPoint.lat;newWest=this.origWest;newEast=this.origEast;newSouth=this.origSouth;newNorth=this.origNorth;if(this.doWest){newWest+=dx}if(this.doSouth){newSouth+=dy}if(this.doEast){newEast+=dx}if(this.doNorth){newNorth+=dy}var h=createBounds(newWest,newSouth,newEast,newNorth);h=d.normalizeBounds(h);d.setSelectionBox(h.top,h.left,h.bottom,h.right,false);d.findSelectionFields();if(!d.fldNorth){return}d.fldNorth.obj.value=h.top;d.fldSouth.obj.value=h.bottom;d.fldWest.obj.value=h.left;d.fldEast.obj.value=h.right}});d.map.addControl(d.panControl)};b.onPopupClose=function(d){if(this.currentPopup){this.map.removePopup(this.currentPopup);this.currentPopup.destroy();this.currentPopup=null;this.hiliteBox("");if(this.selectedFeature){this.unselectFeature(this.selectedFeature)}}};b.findObject=function(h,g){for(i=0;i<g.length;i++){var d=g[i].ramaddaId;if(!d){g[i].id}if(d==h){return g[i]}}return null};b.findMarker=function(d){if(!this.markers){return null}return this.findObject(d,this.getMarkers())};b.findFeature=function(d){return this.features[d]};b.findBox=function(d){if(!this.boxes){return null}return this.findObject(d,this.boxes.markers)};b.hiliteBox=function(d){if(this.currentBox){this.currentBox.setBorder("blue")}this.currentBox=this.findBox(d);if(this.currentBox){this.currentBox.setBorder("red")}};b.checkMarkerVisibility=function(){if(!this.markers){return}var g=this.getMarkers();for(var d=0;d<g.length;d++){marker=g[d];var h=this.isLayerVisible(marker.ramaddaId,marker.parentId);if(h){marker.style.display="inline"}else{marker.style.display="none"}}this.markers.redraw()};b.checkLinesVisibility=function(){if(!this.lines){return}var h=this.lines.features;for(var g=0;g<h.length;g++){var d=h[g];var j=this.isLayerVisible(d.ramaddaId);if(j){d.style.display="inline"}else{d.style.display="none"}}this.lines.redraw()};b.checkBoxesVisibility=function(){if(!this.boxes){return}for(var d in this.boxes.markers){d=this.boxes.markers[d];var g=this.isLayerVisible(d.ramaddaId);d.display(g)}this.boxes.redraw()};b.checkImageLayerVisibility=function(){if(!this.imageLayers){return}for(var d in this.imageLayers){var h=this.isLayerVisible(d);var g=this.imageLayers[d];g.setVisibility(h);if(!h){if(g.box){this.removeBox(g.box);g.box=null}}else{if(g.box){this.removeBox(g.box);g.box=this.createBox(d,"",g.north,g.west,g.south,g.east,g.text,{})}}}};b.hiliteMarker=function(g){var d=this.findMarker(g);if(!d){d=this.findFeature(g)}if(!d&&this.imageLayers){d=this.imageLayers[g]}if(!d){return}this.map.setCenter(d.lonlat);this.showMarkerPopup(d)};b.hideLoadingImage=function(){if(this.loadingImage){this.loadingImage.style.visibility="hidden"}};b.showLoadingImage=function(){if(this.loadingImage){this.loadingImage.style.visibility="inline";return}sz=new OpenLayers.Size();sz.h=120;sz.w=120;width=this.map.viewPortDiv.offsetWidth;height=this.map.viewPortDiv.offsetHeight;position=new OpenLayers.Pixel(width/2-sz.w/2,height/2-sz.h/2);this.loadingImage=OpenLayers.Util.createImage("loadingimage",position,sz,ramaddaBaseUrl+"/icons/mapprogress.gif");this.loadingImage.style.zIndex=1010;this.map.viewPortDiv.appendChild(this.loadingImage)};b.centerOnMarkers=function(k,l){this.centerOnMarkersCalled=true;this.centerOnMarkersForce=l;now=Date.now();var j=null;if(k){if(k.left<-180||k.left>180||k.right<-180||k.right>180||k.bottom<-90||k.bottom>90||k.top<-90||k.top>90){k=createBounds(-180,-90,180,90)}}this.dfltBounds=k;if(!l){if(this.markers){var m=this.markers.getDataExtent();j=this.transformProjBounds(m)}if(this.lines){var m=this.lines.getDataExtent();var d=this.transformProjBounds(m);if(j){j.extend(d)}else{j=d}}for(var g in this.getMap().layers){g=this.getMap().layers[g];if(!g.getDataExtent){continue}if(g.isBaseLayer||!g.getVisibility()){continue}var m=g.getDataExtent();if(m){var h=this.transformProjBounds(m);if(j){j.extend(h)}else{j=h}}}}if(!j){j=k}if(!j){return}if(!this.getMap()){this.defaultBounds=j;return}if(j.getHeight()>160){j.top=80;j.bottom=-80}this.setViewToBounds(j)};b.setViewToBounds=function(d){projBounds=this.transformLLBounds(d);if(projBounds.getWidth()==0){this.getMap().zoomTo(this.initialZoom)}else{this.getMap().zoomToExtent(projBounds)}this.getMap().setCenter(projBounds.getCenterLonLat())};b.setCenter=function(d){var g=this.transformLLPoint(d);this.getMap().setCenter(g)};b.zoomToMarkers=function(){if(!this.markers){return}bounds=this.markers.getDataExtent();if(bounds==null){return}this.getMap().setCenter(bounds.getCenterLonLat());this.getMap().zoomToExtent(bounds)};b.centerToMarkers=function(){if(!this.markers){return}bounds=this.markers.getDataExtent();this.getMap().setCenter(bounds.getCenterLonLat())};b.setInitialCenterAndZoom=function(h,d,g){this.defaultLocation=createLonLat(h,d);this.initialZoom=g};b.getPopupText=function(g,d){if(g==null){return null}if(g.indexOf("base64:")==0){g=window.atob(g.substring(7));if(g.indexOf("{")==0){props=JSON.parse(g);g=props.text;if(!g){g=""}if(d){d.inputProps=props}}}return g};b.seenMarkers={};b.addMarker=function(y,d,l,j,r,A,x,h,D){if(x==null){x=16}if(h==null){h=0}if(!this.markers){this.markers=new OpenLayers.Layer.Vector("Markers");this.addVectorLayer(this.markers,D)}if(!l){l=ramaddaBaseUrl+"/icons/marker.png"}var t=new OpenLayers.Size(x,x);var q=function(E){return new OpenLayers.Pixel(-(E.w/2),-(E.h/2)-h)};var C=new OpenLayers.Icon(l,t,null,q);var u=this.transformLLPoint(d);var p=new OpenLayers.Marker(u,C);var o=new OpenLayers.Feature.Vector(new OpenLayers.Geometry.Point(d.lon,d.lat).transform(this.displayProjection,this.sourceProjection),{description:""},{externalGraphic:l,graphicHeight:x,graphicWidth:x,graphicXOffset:-x/2,graphicYOffset:-x/2});o.ramaddaId=y;o.parentId=A;o.text=this.getPopupText(r,o);o.name=j;o.location=d;p.ramaddaId=y;p.text=this.getPopupText(r,p);p.name=j;p.location=d;var k=d+"";o.locationKey=k;var m=this.seenMarkers[k];if(m==null){m=[];this.seenMarkers[k]=m}else{}m.push(o);var z=this;var B=function(E){z.showMarkerPopup(p,true);if(p.ramaddaClickHandler!=null){p.ramaddaClickHandler.call(null,p)}OpenLayers.Event.stop(E)};p.events.register("click",p,B);p.events.register("touchstart",p,B);var g=this.isLayerVisible(p.ramaddaId,p.parentId);if(!g){p.display(false)}o.what="marker";this.markers.addFeatures([o]);return o};b.initBoxes=function(g){if(!this.getMap()){}this.addLayer(g);g.getFeatureFromEvent=function(h){return null};var d=new OpenLayers.Control.SelectFeature(g);this.getMap().addControl(d);d.activate()};b.removeBox=function(d){if(this.boxes&&d){this.boxes.removeMarker(d);this.boxes.redraw()}};b.addBox=function(d){if(!this.boxes){this.boxes=new OpenLayers.Layer.Boxes("Boxes",{wrapDateLine:mapDefaults.wrapDateline});if(!this.getMap()){this.initialBoxes=this.boxes}else{this.initBoxes(this.boxes)}}this.boxes.addMarker(d);this.boxes.redraw()};b.createBox=function(j,h,m,x,q,t,y,l){if(y.indexOf("base64:")==0){y=window.atob(y.substring(7))}var r={color:"blue",selectable:true,zoomToExtent:false,sticky:false};for(var o in l){r[o]=l[o]}var g=createBounds(x,Math.max(q,-mapDefaults.maxLatValue),t,Math.min(m,mapDefaults.maxLatValue));var d=this.transformLLBounds(g);box=new OpenLayers.Marker.Box(d);box.sticky=r.sticky;var k=this;if(r.selectable){box.events.register("click",box,function(z){k.showMarkerPopup(box,true);OpenLayers.Event.stop(z)})}var p=new createLonLat(x,m);box.lonlat=this.transformLLPoint(p);box.text=this.getPopupText(y);box.name=h;box.setBorder(r.color,1);box.ramaddaId=j;var u={fillColor:"red",fillOpacity:1,pointRadius:5};if(r.zoomToExtent){this.centerOnMarkers(g)}this.addBox(box);return box};b.circleMarker=function(h,d){marker=this.findMarker(h);if(!marker){return null}myattrs={pointRadius:12,stroke:true,strokeColor:"red",strokeWidth:2,fill:false};if(d){$.extend(myattrs,d)}var g=this;this.showFeatureText(marker);return this.addPoint(h+"_circle",marker.location,myattrs)};b.uncircleMarker=function(d){feature=this.features[d+"_circle"];if(feature){this.circles.removeFeatures([feature])}this.hideFeatureText(feature)};b.showFeatureText=function(d){var h=this;if(d.text&&this.displayDiv){this.textFeature=d;var g=function(){if(h.textFeature==d){h.showText(h.textFeature.text)}};setTimeout(g,500)}},b.showText=function(d){$("#"+this.displayDiv).html(d)};b.hideFeatureText=function(d){if(!d||this.textFeature==d){this.showText("")}},b.addPoint=function(g,m,o,p,h){var l=m;if(typeof m.x==="undefined"){m=new OpenLayers.Geometry.Point(m.lon,m.lat)}else{l=createLonLat(l.x,l.y)}var k=this;var j=OpenLayers.Util.extend({},OpenLayers.Feature.Vector.style["default"]);$.extend(j,{pointRadius:5,stroke:true,strokeColor:"red",strokeWidth:0,strokeOpacity:0.75,fill:true,fillColor:"blue",fillOpacity:0.75});if(o){$.extend(j,o);if(j.pointRadius<=0){j.pointRadius=1}}if(j.fillColor==""||j.fillColor=="none"){j.fillOpacity=0}if(j.strokeColor==""||j.strokeColor=="none"){j.strokeOpacity=0}var d=new OpenLayers.Geometry.Point(m.x,m.y);d.transform(this.displayProjection,this.sourceProjection);var q=new OpenLayers.Feature.Vector(d,null,j);q.center=d;q.ramaddaId=g;q.text=this.getPopupText(p,q);q.location=l;this.features[g]=q;if(!h){if(this.circles==null){this.circles=new OpenLayers.Layer.Vector("Circles Layer");this.addVectorLayer(this.circles)}this.circles.addFeatures([q])}return q};b.removePoint=function(d){if(this.circles){this.circles.removeFeatures([d])}};b.addRectangle=function(o,m,d,k,j,g,l){var h=[new OpenLayers.Geometry.Point(d,m),new OpenLayers.Geometry.Point(d,k),new OpenLayers.Geometry.Point(j,k),new OpenLayers.Geometry.Point(j,m),new OpenLayers.Geometry.Point(d,m)];return this.addPolygon(o,"",h,g,l)};b.addLine=function(g,d,k,m,j,l,p,h){var o=[new OpenLayers.Geometry.Point(m,k),new OpenLayers.Geometry.Point(l,j)];return this.addPolygon(g,d,o,p,h)};b.addLines=function(m,h,g,d,l){var k=[];for(var j=0;j<d.length;j+=2){k.push(new OpenLayers.Geometry.Point(d[j+1],d[j]))}return this.addPolygon(m,h,k,g,l)};b.removePolygon=function(d){if(this.lines){this.lines.removeFeatures([d])}};var c=0;b.addPolygon=function(h,g,r,t,m){var p=this;var q;if(r.length>1){q=new OpenLayers.LonLat(r[0].x+(r[1].x-r[0].x)/2,r[0].y+(r[1].y-r[0].y)/2)}else{q=new OpenLayers.LonLat(r[0].x,r[0].y)}for(var l=0;l<r.length;l++){r[l].transform(this.displayProjection,this.sourceProjection)}var o=OpenLayers.Util.extend({},OpenLayers.Feature.Vector.style["default"]);var d=OpenLayers.Util.extend({},o);d.strokeColor="blue";d.strokeWidth=1;if(t){for(key in t){d[key]=t[key]}}if(!this.lines){this.lines=new OpenLayers.Layer.Vector("Lines",{style:o});this.addVectorLayer(this.lines)}var k=new OpenLayers.Geometry.LineString(r);var u=new OpenLayers.Feature.Vector(k,null,d);u.text=m;u.ramaddaId=h;u.location=q;u.name=g;var j=this.isLayerVisible(u.ramaddaId);if(j){u.style.display="inline"}else{u.style.display="none"}this.lines.addFeatures([u]);return u};b.showMarkerPopup=function(g,m){if(this.entryClickHandler&&window[this.entryClickHandler]){if(!window[this.entryClickHandler](this,g)){return}}if(this.currentPopup){this.getMap().removePopup(this.currentPopup);this.currentPopup.destroy()}var o=g.ramaddaId;if(!o){o=g.id}this.hiliteBox(o);var h=this;if(g.inputProps){g.text=this.getPopupText(g.inputProps.text)}var k=g.text;if(m&&g.locationKey!=null){markers=this.seenMarkers[g.locationKey];if(markers.length>1){k="";for(var j=0;j<markers.length;j++){otherMarker=markers[j];if(j>0){k+="<hr>"}if(otherMarker.inputProps){otherMarker.text=this.getPopupText(otherMarker.inputProps.text)}k+=otherMarker.text;if(j>10){break}}}}var d=g.location;if(!d){return}if(typeof d.lon==="undefined"){d=createLonLat(d.x,d.y)}if(!k||k==""){if(d.lat==d.lat){k="Lon: "+d.lat+"<br>Lat: "+d.lon}}var l=this.transformLLPoint(d);popup=new OpenLayers.Popup.FramedCloud("popup",l,null,k,null,true,function(){h.onPopupClose()});if(g.inputProps&&g.inputProps.minSizeX){popup.minSize=new OpenLayers.Size(g.inputProps.minSizeX,g.inputProps.minSizeY)}g.popupText=popup;popup.marker=g;this.getMap().addPopup(popup);this.currentPopup=popup;if(g.inputProps&&g.inputProps.chartType){this.popupChart(g.inputProps)}};b.popupChart=function(g){var k=getOrCreateDisplayManager(g.divId,{},true);var j={entryId:g.entryId};var h=g.title;if(!h){h="Chart"}var d={title:h,layoutHere:true,divid:g.divId,entryId:g.entryId,fields:g.fields,vAxisMinValue:g.vAxisMinValue,vAxisMaxValue:g.vAxisMaxValue,data:new PointData(h,null,null,getRamadda().getRoot()+"/entry/show?entryid="+g.entryId+"&output=points.product&product=points.json&numpoints=1000",j)};k.createDisplay(g.chartType,d)},b.removeMarker=function(d){if(this.markers){this.markers.removeFeatures([d])}}}function formatLocationValue(b){return number_format(b,3,".","")}OpenLayers.Control.Click=OpenLayers.Class(OpenLayers.Control,{listeners:null,addListener:function(b){if(this.listeners==null){this.listeners=[]}this.listeners.push(b)},defaultHandlerOptions:{single:true,"double":false,pixelTolerance:0,stopSingle:false,stopDouble:false},initialize:function(b){this.handlerOptions=OpenLayers.Util.extend({},this.defaultHandlerOptions);OpenLayers.Control.prototype.initialize.apply(this,arguments);this.handler=new OpenLayers.Handler.Click(this,{click:this.trigger},this.handlerOptions)},setLatLonZoomFld:function(g,d,b,c){this.lonFldId=g;this.latFldId=d;this.zoomFldId=b;this.clickListener=c},setTheMap:function(b){this.theMap=b},trigger:function(g){var d=this.theMap.getMap().getLonLatFromViewPortPx(g.xy);var c=this.theMap.transformProjPoint(d);if(this.listeners!=null){for(var b=0;b<this.listeners.length;b++){this.listeners[b](c)}}if(!this.lonFldId){this.lonFldId="lonfld";this.latFldId="latfld";this.zoomFldId="zoomfld"}lonFld=GuiUtils.getDomObject(this.lonFldId);latFld=GuiUtils.getDomObject(this.latFldId);zoomFld=GuiUtils.getDomObject(this.zoomFldId);if(latFld&&lonFld){latFld.obj.value=formatLocationValue(c.lat);lonFld.obj.value=formatLocationValue(c.lon)}if(zoomFld){zoomFld.obj.value=this.theMap.getMap().getZoom()}if(this.clickListener!=null){this.clickListener.handleClick(this,c.lon,c.lat)}}});var CUSTOM_MAP="CUSTOM";var firstCustom=true;var MapUtils={mapRegionSelected:function(c,b){var d=$("#"+c).val();if(d==null){console.log("Error: No map region value");return}if(d==""){this.toggleMapWidget(b,false);return}var g=d.split(",");if(g.length==1){if(g[0]!=CUSTOM_MAP){return}else{if(!firstCustom){this.setMapRegion(b,"","","","","")}firstCustom=false;this.toggleMapWidget(b,true);return}}if(g.length!=5){return}this.toggleMapWidget(b,false);this.setMapRegion(b,g[0],g[1],g[2],g[3],g[4])},setMapRegion:function(c,h,j,b,g,d){$("#"+c+"_regionid").val(h);$("#"+c+"_north").val(j);$("#"+c+"_west").val(b);$("#"+c+"_south").val(g);$("#"+c+"_east").val(d)},toggleMapWidget:function(c,b){if(b){var d=window[c];if(d&&!d.inited){d.initMap(true)}$("#"+c+"_mapToggle").show()}else{$("#"+c+"_mapToggle").hide()}}};var markerMap={};function highlightMarkers(b,g,d,c,h){$(b).mouseenter(function(){if(d){$(this).css("background",d)}if(!$(this).data("mapid")){return}if(g.circleMarker($(this).data("mapid"),ramaddaCircleHiliteAttrs)){return}if(h==null){return}if(!Utils.isDefined($(this).data("latitude"))){console.log("no lat");return}attrs={pointRadius:12,stroke:true,strokeColor:"blue",strokeWidth:2,fill:false};point=g.addPoint(h,new OpenLayers.LonLat($(this).data("longitude"),$(this).data("latitude")),attrs);markerMap[h]=point});$(b).mouseleave(function(){if(c){$(this).css("background",c)}if(!$(this).data("mapid")){return}if(h&&markerMap[h]){g.removePoint(markerMap[h]);markerMap[h]=null}g.uncircleMarker($(this).data("mapid"))})}function ramaddaFindFeature(g,b){for(var c=0;c<g.features.length;c++){var d=g.features[c];var k=d.geometry;if(!k){continue}bounds=k.getBounds();if(!bounds.contains(b.x,b.y)){continue}if(k.components){for(var h=0;h<k.components.length;h++){comp=k.components[h];bounds=comp.getBounds();if(!bounds.contains(b.x,b.y)){continue}if(comp.containsPoint&&comp.containsPoint(b)){return{feature:d,index:c}}}}else{if(!k.containsPoint){console.log("unknown geometry:"+k.CLASS_NAME);continue}if(k.containsPoint(b)){return{feature:d,index:c}}}}return null};