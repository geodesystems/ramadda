var build_date="RAMADDA build date: Wed Nov 26 11:45:54 MST 2025";$.extend(Utils,{makeRGBColortable:function(){let e=[];for(let t=0;t<arguments.length;t+=3)e.push(HU.rgb(arguments[t],arguments[t+1],arguments[t+2]));return e},smoothColorTable:function(e,t){t||(t=100);let i=1/t,s=[];for(let t=0;t<=1;t+=i){getColor(e,t);s.push(s)}return s},interpColors:function(e,t){for(let i=0;i<e.length-1;i++){let s=e[i],l=e[i+1];if(t>=s[0]&&t<=l[0]){let a=e[i][1],r=e[i+1][1],o=(t-s[0])/(l[0]-s[0]),n=a.match(/rgb\((.*) *, *(.*) *, *(.*)\)/),h=r.match(/rgb\((.*) *, *(.*) *, *(.*)\)/);if(n&&h){return"rgb("+Math.round(+n[1]+o*(+h[1]-+n[1]))+","+Math.round(+n[2]+o*(+h[2]-+n[2]))+","+Math.round(+n[3]+o*(+h[3]-+n[3]))+")"}n=a.match(/#(..)(..)(..)/),h=r.match(/#(..)(..)(..)/);let d=e=>1==e.length?"0"+e:e;if(n&&h){n=n.map((e=>parseInt(e,16))),h=h.map((e=>parseInt(e,16)));let e=Math.round(+n[1]+o*(+h[1]-+n[1])),t=Math.round(+n[2]+o*(+h[2]-+n[2])),i=Math.round(+n[3]+o*(+h[3]-+n[3]));return"#"+d(e.toString(16))+d(t.toString(16))+d(i.toString(16))}return null}}},getColorTable:function(e,t){var i=this.ColorTables[e];return i&&t?i.colors:i},displayAllColorTables:function(e){let t=0,i=HU.getUniqueId("find"),s=HU.div([ATTR_ID,i]);s+=HU.open(TAG_TABLE,[ATTR_WIDTH,HU.perc(50)]);let l="",a="";Utils.AllColorTables.forEach((i=>{if(i.category)return a=i.category,void(s+=HU.tr([],HU.td([ATTR_COLSPAN,3],HU.h3(i.category))));let r=i.colors??[];l+="new ColorTable('"+i.id+"','"+i.id+"', new String[]{\n";for(var o=0;o<r.length;o++)l+="'"+r[o]+"',";l+="});\n",s+=HU.tr([ATTR_CLASS,"ramadda-colortable",ATTR_DATA_CORPUS,a],HU.td([ATTR_WIDTH,HU.perc(10)],HU.b(HU.span([ATTR_CLASS,"colortable-id"],i.id)))+HU.td([ATTR_ALIGN,ALIGN_RIGHT],HU.space(2)+r.length+SPACE)+HU.td([],HU.div([ATTR_ID,e+"_"+t,ATTR_STYLE,HU.css(CSS_OVERFLOW_X,OVERFLOW_HIDDEN,CSS_MAX_WIDTH,HU.px(500),CSS_WIDTH,HU.perc(100))],""))),t++,s+="\n"})),s+=HU.close(TAG_TABLE),jqid(e).html(s),t=0,Utils.AllColorTables.forEach((i=>{i.category||(this.displayColorTable(i,e+"_"+t,0,1,{showRange:!1,height:HU.px(20)}),t++)})),Utils.initCopyable(".colortable-id",{title:"Click to copy color table ID",ack:"Color table ID copied to clipboard"}),HU.initPageSearch(HU.dotClass("ramadda-colortable"),null,"Find colortable",!1,{target:jqid(i)})},getColorTablePopup:function(e){let t={wikiEditor:null,itemize:!1,label:null,showToggle:!0,attr:null,value:null,clazz:"wiki-editor-popup-items"};e&&$.extend(t,e);let i,s=HU.open(TAG_DIV,[ATTR_CLASS,t.clazz]),l=[];showToggle=t.showToggle;let a="";return Utils.AllColorTables.forEach((e=>{if(e.category)return""!=a&&(s+=HU.close(TAG_DIV)),a=e.category,i=HU.div([ATTR_STYLE,HU.css(CSS_TEXT_DECORATION,"underline",CSS_FONT_WEIGHT,FONT_BOLD)],e.category),s+=HU.open(TAG_DIV,[ATTR_CLASS,CLASS_COLORTABLE_CATEGORY])+i,void l.push(i);let r=Utils.getColorTableDisplay(e,0,1,{showRange:!1,height:HU.px(20)}),o=[ATTR_STYLE,HU.css(CSS_MARGIN_BOTTOM,HU.px(2),CSS_WIDTH,HU.px(400)),ATTR_TITLE,e.id,ATTR_DATA_CORPUS,e.id+" "+a,ATTR_CLASS,CLASS_COLORTABLE_SELECT,ATTR_COLORTABLE,e.id];if(t.attr&&o.push(t.attr,t.value),r=HU.div(o,r),t.wikiEditor){let a="WikiUtil.insertText("+HU.squote(t.wikiEditor.getId())+","+HU.squote("colorTable="+e.id)+")";i=HU.onClick(a,r),s+=i,l.push(i)}else l.push(r),s+=r})),s+=HU.close(TAG_DIV,TAG_DIV),showToggle&&(s=HU.toggleBlock(HU.div([ATTR_CLASS,"wiki-editor-popup-header"],t.label??"Color Table"),s)),t.itemize?l:s},displayColorTable:function(e,t,i,s,l){if(!e)return;let a=this.getColorTableDisplay(e,i,s,l);jqid(t).html(a)},getColorTableDisplay:function(e,t,i,s){if(!e)return null;let l=e;e.steps&&(l=[],e.steps.forEach((e=>{l.push(e.color)}))),e.colors&&(l=e.colors),(e=l).length&&Array.isArray(e[0])&&(e=e[e.length-1]);let a={height:"15px",showRange:!0,showColorTableDots:!1,decimals:-1,horizontal:!0,colorWidth:"20px",stride:1,dotWidth:null,showLabels:!0};s&&$.extend(a,s);let r={};if(a.stringValues&&a.stringValues.length){a.showRange=!1,e=[];a.stringValues.forEach((t=>{let i="";r[t.color]?i=HU.css(CSS_BORDER_TOP,HU.border(1,"#ccc")):(r[t.color]={label:"",titles:[]},e.push(t.color));let s=r[t.color],l=t.value;""==l&&(l="&lt;blank&gt;"),s.label+=HU.div([ATTR_TITLE,t.value,ATTR_STYLE,i],l),s.titles.push(l)}))}let o=" display-colortable "+(!a.tooltips&&a.showColorTableDots?"display-colortable-dots"+(a.horizontal?"-h":""):"");a.horizontal||(o+=" display-colortable-vertical");let n=[ATTR_CLASS,o];Utils.isDefined(a.width)&&(n.push(ATTR_STYLE),n.push(HU.css(ATTR_WIDTH,HU.getDimension(String(a.width)))));let h=HU.open(TAG_DIV,n);!a.horizontal&&Utils.stringDefined(a.title)&&(h+=HU.div([ATTR_CLASS,"display-colortable-title"],a.title)),a.showColorTableDots||(h+=HU.open(TAG_TABLE,[ATTR_CELLPADDING,0,ATTR_CELLSPACING,0,ATTR_WIDTH,HU.perc(100),ATTR_BORDER,0]),h+=HU.close(TAG_TR));let d=e=>"string"==typeof e?e:(e=parseFloat(e),isNaN(e)?"":a.decimals>=0?number_format(e,a.decimals):this.formatNumberComma(e));a.showRange&&(a.showColorTableDots||(a.horizontal?h+=HU.tag(TAG_TD,[ATTR_WIDTH,HU.perc(1)],d(t)+SPACE):h+=d(t)+HU.br()));let g=(i-t)/e.length,p=[],c=e.length;if(a.tooltips&&a.tooltips.length>0&&a.tooltips.length<e.length&&(c=a.tooltips.length),!a.showColorTableDots||a.horizontal||a.tooltips)for(var u=0;u<c;u+=a.stride)p.push(u);else for(u=c-1;u>=0;u-=a.stride)p.push(u);let T=100/p.length+"%";if(p.forEach(((i,s)=>{let l,o=t+g*i,n=[];if(a.showColorTableDots){let l=t+g*(i+1),r=a.tooltips?a.tooltips[s]:d(o)+"-"+d(l),n=e[i];a.stringValues&&(r=a.stringValues[s]?.value,n=a.stringValues[s]?.color??n);let p=SPACE,c=HU.css(CSS_BACKGROUND,n);if(a.dotWidth&&(c+=HU.css(CSS_WIDTH,HU.getDimension(a.dotWidth),CSS_HEIGHT,HU.getDimension(a.dotWidth))),a.tooltips)h+=HU.div(["label",r,ATTR_DATA_VALUE,o,ATTR_STYLE,HU.css(CSS_WIDTH,HU.perc(100),CSS_DISPLAY,DISPLAY_INLINE_BLOCK),ATTR_CLASS,"display-colortable-dot-item",ATTR_TITLE,r],HU.div([ATTR_DATA_VALUE,o,ATTR_CLASS,"display-colortable-dot",ATTR_STYLE,c])+p+r);else{let e,t=HU.span([ATTR_DATA_VALUE,o,ATTR_CLASS,"display-colortable-dot",ATTR_STYLE,c]);e=a.horizontal?t+p+r:t+SPACE+r,h+=HU.div([ATTR_CLASS,"display-colortable-dot-item",ATTR_TITLE,r],e)}return}let p="",c=r[e[i]];if(a.showRange)n.push(ATTR_TITLE),n.push(p=d(o));else if(a.tooltips){let e=a.tooltips[s];e&&n.push(ATTR_TITLE,e,"data-title",e,"foo",e)}c&&(p=Utils.join(c.titles,"/"),l=c.label),l||(l=a.labels?a.labels[s]:"");let u=Utils.getForegroundColor(e[i]),f=HU.css(CSS_PADDING_LEFT,HU.px(4),CSS_PADDING_RIGHT,HU.px(4),CSS_BACKGROUND,e[i],CSS_WIDTH,HU.perc(100),CSS_MIN_HEIGHT,a.height,CSS_COLOR,u);a.labelStyle&&(f+=a.labelStyle),a.horizontal?h+=HU.td([ATTR_DATA_VALUE,o,p?ATTR_TITLE:"nulltitle",p??"",ATTR_CLASS,"display-colortable-slice",ATTR_STYLE,HU.css(CSS_MIN_WIDTH,HU.px(1),CSS_HEIGHT,HU.em(1.5),CSS_BACKGROUND,e[i],CSS_COLOR,u),ATTR_WIDTH,T],""):(n.push(ATTR_STYLE,f),h+=HU.div([ATTR_DATA_VALUE,o,ATTR_CLASS,"display-colortable-slice",ATTR_STYLE,HU.css(CSS_BACKGROUND,e[i])],HU.div(n,l||"")))})),a.showColorTableDots||(a.showRange&&(a.horizontal?h+=HU.td([ATTR_WIDTH,HU.perc(1)],d(i)+SPACE):h+=d(i)+HU.br()),a.horizontal&&(h+=HU.close(TAG_TR,TAG_TABLE))),h+=HU.close(TAG_DIV),h+=HU.open(TAG_DIV,[ATTR_CLASS,"display-colortable-extra"]),a.showLabels&&Object.keys(r).length&&a.horizontal&&!a.showColorTableDots){let t=HU.perc(100/e.length);h+=HU.open(TAG_DIV,[ATTR_STYLE,HU.css(CSS_WIDTH,HU.perc(100),CSS_VERTICAL_ALIGN,ALIGN_TOP,CSS_TEXT_ALIGN,ALIGN_CENTER)]);e.forEach((e=>{let i=r[e],s=HU.div([ATTR_STYLE,HU.css(CSS_PADDING,HU.px(2),CSS_VERTICAL_ALIGN,"top",CSS_DISPLAY,"inline-block",CSS_WIDTH,t,CSS_MAX_WIDTH,t,CSS_OVERFLOW_X,"auto")],i?i.label:"");h+=s})),h+=HU.close(TAG_DIV)}return h+=HU.close(TAG_DIV),h},addColorTables(e){Utils.AllColorTables.push(...e),e.forEach((e=>{if(e.category)return;if(!e.id)return void console.dir("Bad colorable:",e);let t=e.id;Utils.ColorTables[t]=e}))}}),Utils.ColorTables={},Utils.AllColorTables=[];var defaultColorTables=[{category:"Ramps"},{id:"grayscale",colors:["rgb(0,0,0)","rgb(1,1,1)","rgb(2,2,2)","rgb(3,3,3)","rgb(4,4,4)","rgb(5,5,5)","rgb(6,6,6)","rgb(7,7,7)","rgb(8,8,8)","rgb(9,9,9)","rgb(10,10,10)","rgb(11,11,11)","rgb(12,12,12)","rgb(13,13,13)","rgb(14,14,14)","rgb(15,15,15)","rgb(16,16,16)","rgb(17,17,17)","rgb(18,18,18)","rgb(19,19,19)","rgb(20,20,20)","rgb(21,21,21)","rgb(22,22,22)","rgb(23,23,23)","rgb(24,24,24)","rgb(25,25,25)","rgb(26,26,26)","rgb(27,27,27)","rgb(28,28,28)","rgb(29,29,29)","rgb(30,30,30)","rgb(31,31,31)","rgb(32,32,32)","rgb(33,33,33)","rgb(34,34,34)","rgb(35,35,35)","rgb(36,36,36)","rgb(37,37,37)","rgb(38,38,38)","rgb(39,39,39)","rgb(40,40,40)","rgb(41,41,41)","rgb(42,42,42)","rgb(43,43,43)","rgb(44,44,44)","rgb(45,45,45)","rgb(46,46,46)","rgb(47,47,47)","rgb(48,48,48)","rgb(49,49,49)","rgb(50,50,50)","rgb(51,51,51)","rgb(52,52,52)","rgb(53,53,53)","rgb(54,54,54)","rgb(55,55,55)","rgb(56,56,56)","rgb(57,57,57)","rgb(58,58,58)","rgb(59,59,59)","rgb(60,60,60)","rgb(61,61,61)","rgb(62,62,62)","rgb(63,63,63)","rgb(64,64,64)","rgb(65,65,65)","rgb(66,66,66)","rgb(67,67,67)","rgb(68,68,68)","rgb(69,69,69)","rgb(70,70,70)","rgb(71,71,71)","rgb(72,72,72)","rgb(73,73,73)","rgb(74,74,74)","rgb(75,75,75)","rgb(76,76,76)","rgb(77,77,77)","rgb(78,78,78)","rgb(79,79,79)","rgb(80,80,80)","rgb(81,81,81)","rgb(82,82,82)","rgb(83,83,83)","rgb(84,84,84)","rgb(85,85,85)","rgb(86,86,86)","rgb(87,87,87)","rgb(88,88,88)","rgb(89,89,89)","rgb(90,90,90)","rgb(91,91,91)","rgb(92,92,92)","rgb(93,93,93)","rgb(94,94,94)","rgb(95,95,95)","rgb(96,96,96)","rgb(97,97,97)","rgb(98,98,98)","rgb(99,99,99)","rgb(100,100,100)","rgb(101,101,101)","rgb(102,102,102)","rgb(103,103,103)","rgb(104,104,104)","rgb(105,105,105)","rgb(106,106,106)","rgb(107,107,107)","rgb(108,108,108)","rgb(109,109,109)","rgb(110,110,110)","rgb(111,111,111)","rgb(112,112,112)","rgb(113,113,113)","rgb(114,114,114)","rgb(115,115,115)","rgb(116,116,116)","rgb(117,117,117)","rgb(118,118,118)","rgb(119,119,119)","rgb(120,120,120)","rgb(121,121,121)","rgb(122,122,122)","rgb(123,123,123)","rgb(124,124,124)","rgb(125,125,125)","rgb(126,126,126)","rgb(127,127,127)","rgb(128,128,128)","rgb(129,129,129)","rgb(130,130,130)","rgb(131,131,131)","rgb(132,132,132)","rgb(133,133,133)","rgb(134,134,134)","rgb(135,135,135)","rgb(136,136,136)","rgb(137,137,137)","rgb(138,138,138)","rgb(139,139,139)","rgb(140,140,140)","rgb(141,141,141)","rgb(142,142,142)","rgb(143,143,143)","rgb(144,144,144)","rgb(145,145,145)","rgb(146,146,146)","rgb(147,147,147)","rgb(148,148,148)","rgb(149,149,149)","rgb(150,150,150)","rgb(151,151,151)","rgb(152,152,152)","rgb(153,153,153)","rgb(154,154,154)","rgb(155,155,155)","rgb(156,156,156)","rgb(157,157,157)","rgb(158,158,158)","rgb(159,159,159)","rgb(160,160,160)","rgb(161,161,161)","rgb(162,162,162)","rgb(163,163,163)","rgb(164,164,164)","rgb(165,165,165)","rgb(166,166,166)","rgb(167,167,167)","rgb(168,168,168)","rgb(169,169,169)","rgb(170,170,170)","rgb(171,171,171)","rgb(172,172,172)","rgb(173,173,173)","rgb(174,174,174)","rgb(175,175,175)","rgb(176,176,176)","rgb(177,177,177)","rgb(178,178,178)","rgb(179,179,179)","rgb(180,180,180)","rgb(181,181,181)","rgb(182,182,182)","rgb(183,183,183)","rgb(184,184,184)","rgb(185,185,185)","rgb(186,186,186)","rgb(187,187,187)","rgb(188,188,188)","rgb(189,189,189)","rgb(190,190,190)","rgb(191,191,191)","rgb(192,192,192)","rgb(193,193,193)","rgb(194,194,194)","rgb(195,195,195)","rgb(196,196,196)","rgb(197,197,197)","rgb(198,198,198)","rgb(199,199,199)","rgb(200,200,200)","rgb(201,201,201)","rgb(202,202,202)","rgb(203,203,203)","rgb(204,204,204)","rgb(205,205,205)","rgb(206,206,206)","rgb(207,207,207)","rgb(208,208,208)","rgb(209,209,209)","rgb(210,210,210)","rgb(211,211,211)","rgb(212,212,212)","rgb(213,213,213)","rgb(214,214,214)","rgb(215,215,215)","rgb(216,216,216)","rgb(217,217,217)","rgb(218,218,218)","rgb(219,219,219)","rgb(220,220,220)","rgb(221,221,221)","rgb(222,222,222)","rgb(223,223,223)","rgb(224,224,224)","rgb(225,225,225)","rgb(226,226,226)","rgb(227,227,227)","rgb(228,228,228)","rgb(229,229,229)","rgb(230,230,230)","rgb(231,231,231)","rgb(232,232,232)","rgb(233,233,233)","rgb(234,234,234)","rgb(235,235,235)","rgb(236,236,236)","rgb(237,237,237)","rgb(238,238,238)","rgb(239,239,239)","rgb(240,240,240)","rgb(241,241,241)","rgb(242,242,242)","rgb(243,243,243)","rgb(244,244,244)","rgb(245,245,245)","rgb(246,246,246)","rgb(247,247,247)","rgb(248,248,248)","rgb(249,249,249)","rgb(250,250,250)","rgb(251,251,251)","rgb(252,252,252)","rgb(253,253,253)","rgb(254,254,254)","rgb(255,255,255)"]},{id:"inversegrayscale",colors:["rgb(255,255,255)","rgb(255,255,255)","rgb(254,254,254)","rgb(253,253,253)","rgb(252,252,252)","rgb(251,251,251)","rgb(250,250,250)","rgb(249,249,249)","rgb(248,248,248)","rgb(247,247,247)","rgb(246,246,246)","rgb(245,245,245)","rgb(244,244,244)","rgb(243,243,243)","rgb(242,242,242)","rgb(241,241,241)","rgb(240,240,240)","rgb(239,239,239)","rgb(238,238,238)","rgb(237,237,237)","rgb(236,236,236)","rgb(235,235,235)","rgb(234,234,234)","rgb(233,233,233)","rgb(232,232,232)","rgb(231,231,231)","rgb(230,230,230)","rgb(229,229,229)","rgb(228,228,228)","rgb(227,227,227)","rgb(226,226,226)","rgb(225,225,225)","rgb(224,224,224)","rgb(223,223,223)","rgb(222,222,222)","rgb(221,221,221)","rgb(220,220,220)","rgb(219,219,219)","rgb(218,218,218)","rgb(217,217,217)","rgb(216,216,216)","rgb(215,215,215)","rgb(214,214,214)","rgb(213,213,213)","rgb(212,212,212)","rgb(211,211,211)","rgb(210,210,210)","rgb(209,209,209)","rgb(208,208,208)","rgb(207,207,207)","rgb(206,206,206)","rgb(205,205,205)","rgb(204,204,204)","rgb(203,203,203)","rgb(202,202,202)","rgb(201,201,201)","rgb(200,200,200)","rgb(199,199,199)","rgb(198,198,198)","rgb(197,197,197)","rgb(196,196,196)","rgb(195,195,195)","rgb(194,194,194)","rgb(193,193,193)","rgb(192,192,192)","rgb(191,191,191)","rgb(190,190,190)","rgb(189,189,189)","rgb(188,188,188)","rgb(187,187,187)","rgb(186,186,186)","rgb(185,185,185)","rgb(184,184,184)","rgb(183,183,183)","rgb(182,182,182)","rgb(181,181,181)","rgb(180,180,180)","rgb(179,179,179)","rgb(178,178,178)","rgb(177,177,177)","rgb(176,176,176)","rgb(175,175,175)","rgb(174,174,174)","rgb(173,173,173)","rgb(172,172,172)","rgb(171,171,171)","rgb(170,170,170)","rgb(169,169,169)","rgb(168,168,168)","rgb(167,167,167)","rgb(166,166,166)","rgb(165,165,165)","rgb(164,164,164)","rgb(163,163,163)","rgb(162,162,162)","rgb(161,161,161)","rgb(160,160,160)","rgb(159,159,159)","rgb(158,158,158)","rgb(157,157,157)","rgb(156,156,156)","rgb(155,155,155)","rgb(154,154,154)","rgb(153,153,153)","rgb(152,152,152)","rgb(151,151,151)","rgb(150,150,150)","rgb(149,149,149)","rgb(148,148,148)","rgb(147,147,147)","rgb(146,146,146)","rgb(145,145,145)","rgb(144,144,144)","rgb(143,143,143)","rgb(142,142,142)","rgb(141,141,141)","rgb(140,140,140)","rgb(139,139,139)","rgb(138,138,138)","rgb(137,137,137)","rgb(136,136,136)","rgb(135,135,135)","rgb(134,134,134)","rgb(133,133,133)","rgb(132,132,132)","rgb(131,131,131)","rgb(130,130,130)","rgb(129,129,129)","rgb(128,128,128)","rgb(127,127,127)","rgb(126,126,126)","rgb(125,125,125)","rgb(124,124,124)","rgb(123,123,123)","rgb(122,122,122)","rgb(121,121,121)","rgb(120,120,120)","rgb(119,119,119)","rgb(118,118,118)","rgb(117,117,117)","rgb(116,116,116)","rgb(115,115,115)","rgb(114,114,114)","rgb(113,113,113)","rgb(112,112,112)","rgb(111,111,111)","rgb(110,110,110)","rgb(109,109,109)","rgb(108,108,108)","rgb(107,107,107)","rgb(106,106,106)","rgb(105,105,105)","rgb(104,104,104)","rgb(103,103,103)","rgb(102,102,102)","rgb(101,101,101)","rgb(100,100,100)","rgb(99,99,99)","rgb(98,98,98)","rgb(97,97,97)","rgb(96,96,96)","rgb(95,95,95)","rgb(94,94,94)","rgb(93,93,93)","rgb(92,92,92)","rgb(91,91,91)","rgb(90,90,90)","rgb(89,89,89)","rgb(88,88,88)","rgb(87,87,87)","rgb(86,86,86)","rgb(85,85,85)","rgb(84,84,84)","rgb(83,83,83)","rgb(82,82,82)","rgb(81,81,81)","rgb(80,80,80)","rgb(79,79,79)","rgb(78,78,78)","rgb(77,77,77)","rgb(76,76,76)","rgb(75,75,75)","rgb(74,74,74)","rgb(73,73,73)","rgb(72,72,72)","rgb(71,71,71)","rgb(70,70,70)","rgb(69,69,69)","rgb(68,68,68)","rgb(67,67,67)","rgb(66,66,66)","rgb(65,65,65)","rgb(64,64,64)","rgb(63,63,63)","rgb(62,62,62)","rgb(61,61,61)","rgb(60,60,60)","rgb(59,59,59)","rgb(58,58,58)","rgb(57,57,57)","rgb(56,56,56)","rgb(55,55,55)","rgb(54,54,54)","rgb(53,53,53)","rgb(52,52,52)","rgb(51,51,51)","rgb(50,50,50)","rgb(49,49,49)","rgb(48,48,48)","rgb(47,47,47)","rgb(46,46,46)","rgb(45,45,45)","rgb(44,44,44)","rgb(43,43,43)","rgb(42,42,42)","rgb(41,41,41)","rgb(40,40,40)","rgb(39,39,39)","rgb(38,38,38)","rgb(37,37,37)","rgb(36,36,36)","rgb(35,35,35)","rgb(34,34,34)","rgb(33,33,33)","rgb(32,32,32)","rgb(31,31,31)","rgb(30,30,30)","rgb(29,29,29)","rgb(28,28,28)","rgb(27,27,27)","rgb(26,26,26)","rgb(25,25,25)","rgb(24,24,24)","rgb(23,23,23)","rgb(22,22,22)","rgb(21,21,21)","rgb(20,20,20)","rgb(19,19,19)","rgb(18,18,18)","rgb(17,17,17)","rgb(16,16,16)","rgb(15,15,15)","rgb(14,14,14)","rgb(13,13,13)","rgb(12,12,12)","rgb(11,11,11)","rgb(10,10,10)","rgb(9,9,9)","rgb(8,8,8)","rgb(7,7,7)","rgb(6,6,6)","rgb(5,5,5)","rgb(4,4,4)","rgb(3,3,3)","rgb(2,2,2)","rgb(1,1,1)"]},{id:"lightgrayscale",colors:["rgb(62,62,62)","rgb(69,69,69)","rgb(75,75,75)","rgb(82,82,82)","rgb(88,88,88)","rgb(95,95,95)","rgb(102,102,102)","rgb(108,108,108)","rgb(115,115,115)","rgb(121,121,121)","rgb(128,128,128)","rgb(135,135,135)","rgb(141,141,141)","rgb(148,148,148)","rgb(155,155,155)","rgb(161,161,161)","rgb(168,168,168)","rgb(174,174,174)","rgb(181,181,181)","rgb(188,188,188)","rgb(194,194,194)","rgb(201,201,201)","rgb(207,207,207)","rgb(214,214,214)","rgb(221,221,221)","rgb(227,227,227)","rgb(234,234,234)","rgb(240,240,240)","rgb(247,247,247)","rgb(254,254,254)"]},{id:"blues",colors:["rgb(255,255,255)","rgb(246,246,255)","rgb(237,237,255)","rgb(228,228,255)","rgb(219,219,255)","rgb(211,211,255)","rgb(202,202,255)","rgb(193,193,255)","rgb(184,184,255)","rgb(175,175,255)","rgb(167,167,255)","rgb(158,158,255)","rgb(149,149,255)","rgb(140,140,255)","rgb(131,131,255)","rgb(123,123,255)","rgb(114,114,255)","rgb(105,105,255)","rgb(96,96,255)","rgb(87,87,255)","rgb(79,79,255)","rgb(70,70,255)","rgb(61,61,255)","rgb(52,52,255)","rgb(43,43,255)","rgb(35,35,255)","rgb(26,26,255)","rgb(17,17,255)","rgb(8,8,255)","rgb(0,0,255)"]},{id:"plotly_blues",colors:["rgb(5,10,172)","rgb(6,11,173)","rgb(7,13,173)","rgb(8,14,174)","rgb(9,16,174)","rgb(10,17,175)","rgb(11,19,175)","rgb(12,20,176)","rgb(13,21,176)","rgb(14,23,177)","rgb(15,24,177)","rgb(16,26,178)","rgb(17,27,178)","rgb(18,29,179)","rgb(19,30,179)","rgb(20,31,180)","rgb(21,33,180)","rgb(22,34,181)","rgb(23,36,181)","rgb(24,37,182)","rgb(25,39,182)","rgb(26,40,183)","rgb(27,41,183)","rgb(28,43,184)","rgb(29,44,184)","rgb(30,46,185)","rgb(31,47,185)","rgb(32,49,186)","rgb(33,50,186)","rgb(34,51,187)","rgb(35,53,187)","rgb(36,54,188)","rgb(37,56,188)","rgb(38,57,189)","rgb(39,59,189)","rgb(40,60,190)","rgb(42,63,194)","rgb(44,65,197)","rgb(46,68,201)","rgb(48,71,205)","rgb(50,73,208)","rgb(52,76,212)","rgb(54,79,216)","rgb(56,81,219)","rgb(58,84,223)","rgb(60,87,227)","rgb(62,89,230)","rgb(64,92,234)","rgb(66,95,238)","rgb(68,97,241)","rgb(70,100,245)","rgb(72,102,245)","rgb(74,104,245)","rgb(76,106,245)","rgb(78,108,245)","rgb(80,110,245)","rgb(82,112,245)","rgb(84,114,245)","rgb(86,116,245)","rgb(88,118,245)","rgb(90,120,245)","rgb(92,122,245)","rgb(93,123,245)","rgb(95,125,246)","rgb(96,127,246)","rgb(98,129,246)","rgb(100,130,246)","rgb(101,132,246)","rgb(103,134,247)","rgb(104,135,247)","rgb(106,137,247)","rgb(110,140,246)","rgb(114,143,245)","rgb(117,145,244)","rgb(121,148,243)","rgb(125,151,242)","rgb(129,154,242)","rgb(133,156,241)","rgb(136,159,240)","rgb(140,162,239)","rgb(144,165,238)","rgb(148,167,237)","rgb(152,170,236)","rgb(155,173,235)","rgb(159,176,234)","rgb(163,179,233)","rgb(167,181,233)","rgb(171,184,232)","rgb(174,187,231)","rgb(178,190,230)","rgb(182,192,229)","rgb(186,195,228)","rgb(190,198,227)","rgb(193,201,226)","rgb(197,203,225)","rgb(201,206,224)","rgb(205,209,224)","rgb(209,212,223)","rgb(212,214,222)","rgb(216,217,221)"]},{id:"plotly_greens",colors:["rgb(0,68,27)","rgb(0,71,28)","rgb(0,75,30)","rgb(0,78,31)","rgb(0,81,32)","rgb(0,84,34)","rgb(0,88,35)","rgb(0,91,37)","rgb(0,94,38)","rgb(0,98,39)","rgb(0,101,41)","rgb(0,104,42)","rgb(0,107,43)","rgb(1,110,45)","rgb(4,113,47)","rgb(7,115,49)","rgb(10,117,51)","rgb(13,120,53)","rgb(15,122,55)","rgb(18,125,57)","rgb(21,127,59)","rgb(24,129,61)","rgb(27,132,63)","rgb(29,134,65)","rgb(32,137,67)","rgb(35,139,69)","rgb(37,142,71)","rgb(40,144,73)","rgb(42,147,75)","rgb(45,149,77)","rgb(47,152,79)","rgb(49,154,81)","rgb(52,157,82)","rgb(54,159,84)","rgb(57,162,86)","rgb(59,165,88)","rgb(61,167,90)","rgb(64,170,92)","rgb(67,172,94)","rgb(71,174,96)","rgb(75,176,98)","rgb(79,178,100)","rgb(83,180,102)","rgb(87,182,104)","rgb(92,184,106)","rgb(96,186,108)","rgb(100,188,110)","rgb(104,190,112)","rgb(108,192,114)","rgb(112,194,116)","rgb(116,196,118)","rgb(120,198,121)","rgb(123,199,124)","rgb(127,201,127)","rgb(130,203,130)","rgb(134,204,133)","rgb(138,206,136)","rgb(141,208,139)","rgb(145,209,142)","rgb(148,211,145)","rgb(152,213,148)","rgb(156,214,151)","rgb(159,216,154)","rgb(163,218,156)","rgb(166,219,159)","rgb(169,220,162)","rgb(172,221,165)","rgb(175,223,168)","rgb(178,224,171)","rgb(181,225,174)","rgb(184,227,177)","rgb(187,228,180)","rgb(190,229,183)","rgb(193,230,186)","rgb(196,232,189)","rgb(199,233,192)","rgb(201,234,195)","rgb(204,235,197)","rgb(206,236,200)","rgb(209,237,202)","rgb(211,238,205)","rgb(213,239,207)","rgb(216,240,210)","rgb(218,241,212)","rgb(221,242,215)","rgb(223,243,218)","rgb(225,244,220)","rgb(228,245,223)","rgb(230,245,225)","rgb(231,246,227)","rgb(233,246,228)","rgb(234,247,230)","rgb(235,248,232)","rgb(237,248,233)","rgb(238,249,235)","rgb(240,249,237)","rgb(241,250,238)","rgb(243,250,240)","rgb(244,251,242)","rgb(246,251,243)"]},{id:"plotly_ylorrd",colors:["rgb(128,0,38)","rgb(133,0,38)","rgb(138,0,38)","rgb(143,0,38)","rgb(148,0,38)","rgb(152,0,38)","rgb(157,0,38)","rgb(162,0,38)","rgb(167,0,38)","rgb(172,0,38)","rgb(177,0,38)","rgb(182,0,38)","rgb(187,0,38)","rgb(191,1,38)","rgb(194,3,37)","rgb(197,5,36)","rgb(200,7,35)","rgb(203,9,34)","rgb(206,11,34)","rgb(209,14,33)","rgb(212,16,32)","rgb(215,18,31)","rgb(218,20,30)","rgb(221,22,30)","rgb(224,24,29)","rgb(227,26,28)","rgb(229,30,29)","rgb(231,34,30)","rgb(233,38,31)","rgb(235,43,32)","rgb(237,47,34)","rgb(239,51,35)","rgb(241,55,36)","rgb(243,59,37)","rgb(245,63,38)","rgb(247,68,39)","rgb(249,72,40)","rgb(251,76,41)","rgb(252,81,43)","rgb(252,86,44)","rgb(252,91,46)","rgb(252,96,47)","rgb(252,101,48)","rgb(252,106,50)","rgb(253,111,51)","rgb(253,116,53)","rgb(253,121,54)","rgb(253,126,56)","rgb(253,131,57)","rgb(253,136,59)","rgb(253,141,60)","rgb(253,144,61)","rgb(253,147,63)","rgb(253,150,64)","rgb(253,153,65)","rgb(253,156,66)","rgb(253,159,68)","rgb(254,162,69)","rgb(254,165,70)","rgb(254,168,72)","rgb(254,171,73)","rgb(254,174,74)","rgb(254,177,75)","rgb(254,180,78)","rgb(254,183,81)","rgb(254,186,84)","rgb(254,189,88)","rgb(254,192,91)","rgb(254,195,94)","rgb(254,198,98)","rgb(254,201,101)","rgb(254,205,105)","rgb(254,208,108)","rgb(254,211,111)","rgb(254,214,115)","rgb(254,217,118)","rgb(254,219,121)","rgb(254,220,125)","rgb(254,222,128)","rgb(254,223,131)","rgb(254,225,135)","rgb(254,227,138)","rgb(255,228,142)","rgb(255,230,145)","rgb(255,231,148)","rgb(255,233,152)","rgb(255,235,155)","rgb(255,236,158)","rgb(255,238,162)","rgb(255,239,165)","rgb(255,241,169)","rgb(255,242,172)","rgb(255,243,176)","rgb(255,245,179)","rgb(255,246,183)","rgb(255,248,186)","rgb(255,249,190)","rgb(255,251,193)","rgb(255,252,197)","rgb(255,254,200)"]},{id:"plotly_reds",colors:["rgb(220,220,220)","rgb(221,219,217)","rgb(223,218,214)","rgb(224,216,211)","rgb(225,215,207)","rgb(226,214,204)","rgb(228,213,201)","rgb(229,211,198)","rgb(230,210,195)","rgb(231,209,192)","rgb(233,208,189)","rgb(234,206,185)","rgb(235,205,182)","rgb(236,204,179)","rgb(238,203,176)","rgb(239,201,173)","rgb(240,200,170)","rgb(241,199,166)","rgb(243,198,163)","rgb(244,196,160)","rgb(245,195,157)","rgb(245,193,154)","rgb(245,192,152)","rgb(245,190,149)","rgb(245,188,147)","rgb(245,186,144)","rgb(245,185,141)","rgb(245,183,139)","rgb(245,181,136)","rgb(245,179,134)","rgb(245,178,131)","rgb(245,176,128)","rgb(245,174,126)","rgb(245,172,123)","rgb(245,170,121)","rgb(245,169,118)","rgb(245,167,115)","rgb(245,165,113)","rgb(245,163,110)","rgb(245,162,108)","rgb(245,160,105)","rgb(244,157,104)","rgb(243,155,102)","rgb(242,152,101)","rgb(241,150,100)","rgb(239,147,99)","rgb(238,145,97)","rgb(237,142,96)","rgb(236,140,95)","rgb(235,137,93)","rgb(234,135,92)","rgb(233,132,91)","rgb(232,130,90)","rgb(230,127,88)","rgb(229,125,87)","rgb(228,122,86)","rgb(227,120,84)","rgb(226,117,83)","rgb(225,115,82)","rgb(224,112,81)","rgb(223,110,79)","rgb(222,107,78)","rgb(220,105,77)","rgb(219,102,75)","rgb(218,100,74)","rgb(217,97,73)","rgb(216,95,72)","rgb(215,92,70)","rgb(214,90,69)","rgb(213,87,68)","rgb(211,85,66)","rgb(210,82,65)","rgb(209,80,64)","rgb(208,77,63)","rgb(207,75,61)","rgb(206,72,60)","rgb(205,70,59)","rgb(204,67,58)","rgb(203,65,56)","rgb(201,62,55)","rgb(200,60,54)","rgb(199,57,52)","rgb(198,55,51)","rgb(197,52,50)","rgb(196,50,49)","rgb(195,47,47)","rgb(194,45,46)","rgb(193,42,45)","rgb(191,40,43)","rgb(190,37,42)","rgb(189,35,41)","rgb(188,32,40)","rgb(187,30,38)","rgb(186,27,37)","rgb(185,25,36)","rgb(184,22,34)","rgb(182,20,33)","rgb(181,17,32)","rgb(180,15,31)","rgb(179,12,29)"]},{id:"plotly_bluered",colors:["rgb(0,0,255)","rgb(3,0,252)","rgb(5,0,250)","rgb(8,0,247)","rgb(10,0,245)","rgb(13,0,242)","rgb(15,0,240)","rgb(18,0,237)","rgb(20,0,235)","rgb(23,0,232)","rgb(25,0,230)","rgb(28,0,227)","rgb(31,0,224)","rgb(33,0,222)","rgb(36,0,219)","rgb(38,0,217)","rgb(41,0,214)","rgb(43,0,212)","rgb(46,0,209)","rgb(48,0,207)","rgb(51,0,204)","rgb(54,0,201)","rgb(56,0,199)","rgb(59,0,196)","rgb(61,0,194)","rgb(64,0,191)","rgb(66,0,189)","rgb(69,0,186)","rgb(71,0,184)","rgb(74,0,181)","rgb(77,0,178)","rgb(79,0,176)","rgb(82,0,173)","rgb(84,0,171)","rgb(87,0,168)","rgb(89,0,166)","rgb(92,0,163)","rgb(94,0,161)","rgb(97,0,158)","rgb(99,0,156)","rgb(102,0,153)","rgb(105,0,150)","rgb(107,0,148)","rgb(110,0,145)","rgb(112,0,143)","rgb(115,0,140)","rgb(117,0,138)","rgb(120,0,135)","rgb(122,0,133)","rgb(125,0,130)","rgb(128,0,127)","rgb(130,0,125)","rgb(133,0,122)","rgb(135,0,120)","rgb(138,0,117)","rgb(140,0,115)","rgb(143,0,112)","rgb(145,0,110)","rgb(148,0,107)","rgb(150,0,105)","rgb(153,0,102)","rgb(156,0,99)","rgb(158,0,97)","rgb(161,0,94)","rgb(163,0,92)","rgb(166,0,89)","rgb(168,0,87)","rgb(171,0,84)","rgb(173,0,82)","rgb(176,0,79)","rgb(179,0,76)","rgb(181,0,74)","rgb(184,0,71)","rgb(186,0,69)","rgb(189,0,66)","rgb(191,0,64)","rgb(194,0,61)","rgb(196,0,59)","rgb(199,0,56)","rgb(201,0,54)","rgb(204,0,51)","rgb(207,0,48)","rgb(209,0,46)","rgb(212,0,43)","rgb(214,0,41)","rgb(217,0,38)","rgb(219,0,36)","rgb(222,0,33)","rgb(224,0,31)","rgb(227,0,28)","rgb(230,0,25)","rgb(232,0,23)","rgb(235,0,20)","rgb(237,0,18)","rgb(240,0,15)","rgb(242,0,13)","rgb(245,0,10)","rgb(247,0,8)","rgb(250,0,5)","rgb(252,0,3)"]},{id:"plotly_ylgnbu",colors:["rgb(8,29,88)","rgb(10,31,93)","rgb(13,33,98)","rgb(15,35,102)","rgb(17,36,107)","rgb(20,38,112)","rgb(22,40,117)","rgb(24,42,122)","rgb(27,44,126)","rgb(29,46,131)","rgb(31,47,136)","rgb(34,49,141)","rgb(36,51,146)","rgb(37,54,149)","rgb(37,57,150)","rgb(36,60,152)","rgb(36,64,154)","rgb(36,67,155)","rgb(36,70,157)","rgb(35,74,158)","rgb(35,77,160)","rgb(35,81,162)","rgb(35,84,163)","rgb(34,87,165)","rgb(34,91,166)","rgb(34,94,168)","rgb(34,98,170)","rgb(33,102,172)","rgb(33,106,174)","rgb(32,110,176)","rgb(32,114,178)","rgb(32,118,180)","rgb(31,123,181)","rgb(31,127,183)","rgb(30,131,185)","rgb(30,135,187)","rgb(30,139,189)","rgb(29,143,191)","rgb(30,146,192)","rgb(33,149,192)","rgb(36,152,193)","rgb(39,155,193)","rgb(42,158,193)","rgb(45,161,194)","rgb(48,164,194)","rgb(51,167,194)","rgb(53,170,195)","rgb(56,173,195)","rgb(59,176,195)","rgb(62,179,196)","rgb(65,182,196)","rgb(70,184,195)","rgb(75,186,195)","rgb(80,188,194)","rgb(85,189,193)","rgb(90,191,192)","rgb(95,193,192)","rgb(100,195,191)","rgb(105,197,190)","rgb(110,199,190)","rgb(115,200,189)","rgb(120,202,188)","rgb(125,204,187)","rgb(130,206,187)","rgb(136,208,186)","rgb(141,211,186)","rgb(147,213,185)","rgb(153,215,184)","rgb(159,217,184)","rgb(164,220,183)","rgb(170,222,183)","rgb(176,224,182)","rgb(182,226,182)","rgb(187,229,181)","rgb(193,231,181)","rgb(199,233,180)","rgb(202,234,183)","rgb(205,235,186)","rgb(208,237,189)","rgb(211,238,192)","rgb(214,239,195)","rgb(217,240,198)","rgb(220,241,201)","rgb(223,243,204)","rgb(226,244,207)","rgb(229,245,210)","rgb(232,246,213)","rgb(235,247,216)","rgb(238,248,217)","rgb(239,249,217)","rgb(241,249,217)","rgb(242,250,217)","rgb(243,251,217)","rgb(245,251,217)","rgb(246,252,217)","rgb(248,252,217)","rgb(249,253,217)","rgb(251,253,217)","rgb(252,254,217)","rgb(254,254,217)"]},{id:"plotly_electric",colors:["rgb(0,0,0)","rgb(2,0,7)","rgb(4,0,13)","rgb(6,0,20)","rgb(8,0,27)","rgb(10,0,33)","rgb(12,0,40)","rgb(14,0,47)","rgb(16,0,53)","rgb(18,0,60)","rgb(20,0,67)","rgb(22,0,73)","rgb(24,0,80)","rgb(26,0,87)","rgb(28,0,93)","rgb(30,0,100)","rgb(34,0,100)","rgb(37,0,100)","rgb(41,0,100)","rgb(44,0,100)","rgb(48,0,100)","rgb(52,0,100)","rgb(55,0,100)","rgb(59,0,100)","rgb(62,0,100)","rgb(66,0,100)","rgb(70,0,100)","rgb(73,0,100)","rgb(77,0,100)","rgb(80,0,100)","rgb(84,0,100)","rgb(88,0,100)","rgb(91,0,100)","rgb(95,0,100)","rgb(98,0,100)","rgb(102,0,100)","rgb(106,0,100)","rgb(109,0,100)","rgb(113,0,100)","rgb(116,0,100)","rgb(120,0,100)","rgb(122,5,95)","rgb(124,9,90)","rgb(126,14,85)","rgb(128,18,80)","rgb(130,23,75)","rgb(132,27,70)","rgb(134,32,65)","rgb(136,36,60)","rgb(138,41,55)","rgb(140,45,50)","rgb(142,50,45)","rgb(144,54,40)","rgb(146,59,35)","rgb(148,63,30)","rgb(150,68,25)","rgb(152,72,20)","rgb(154,77,15)","rgb(156,81,10)","rgb(158,86,5)","rgb(160,90,0)","rgb(164,96,0)","rgb(167,101,0)","rgb(171,107,0)","rgb(174,112,0)","rgb(178,118,0)","rgb(181,123,0)","rgb(185,129,0)","rgb(188,134,0)","rgb(192,140,0)","rgb(195,145,0)","rgb(199,151,0)","rgb(202,156,0)","rgb(206,162,0)","rgb(209,167,0)","rgb(213,173,0)","rgb(216,178,0)","rgb(220,184,0)","rgb(223,189,0)","rgb(227,195,0)","rgb(230,200,0)","rgb(231,203,11)","rgb(233,205,22)","rgb(234,208,33)","rgb(235,210,44)","rgb(236,213,55)","rgb(238,215,66)","rgb(239,218,77)","rgb(240,220,88)","rgb(241,223,99)","rgb(243,225,110)","rgb(244,228,121)","rgb(245,230,132)","rgb(246,233,143)","rgb(248,235,154)","rgb(249,238,165)","rgb(250,240,176)","rgb(251,243,187)","rgb(253,245,198)","rgb(254,248,209)"]},{id:"plotly_viridis",colors:["#440154","#450558","#45085b","#460c5f","#471062","#471366","#481769","#481a6c","#481e6f","#482171","#472474","#472877","#472b7a","#472e7c","#46317e","#45347f","#443781","#433a83","#433e85","#424186","#414387","#404688","#3e4989","#3d4c89","#3c4f8a","#3b528b","#3a548b","#39578c","#375a8c","#365d8c","#355f8d","#33628d","#32658d","#31678d","#30698d","#2f6c8e","#2e6e8e","#2d708e","#2c738e","#2b758e","#2a788e","#297b8e","#287d8e","#27808e","#26828e","#25858e","#24878d","#24898d","#238c8d","#228e8c","#21918c","#21938b","#20958b","#20988a","#209a8a","#1f9c89","#1f9f88","#20a187","#21a386","#23a685","#24a883","#25aa82","#27ac81","#29af7f","#2db17d","#30b37b","#34b579","#38b777","#3bba75","#3fbc73","#44be70","#49c06e","#4ec26b","#53c468","#58c666","#5dc863","#62ca5f","#68cc5c","#6ece58","#74cf54","#7bd151","#81d34d","#87d549","#8dd645","#94d741","#9ad83c","#a1da38","#a7db34","#aedc2f","#b5dd2c","#bcde28","#c3df24","#c9e021","#d0e11d","#d7e219","#dee31b","#e4e41d","#eae41f","#f0e521","#f7e623"]},{id:"plotly_cividis",colors:["rgb(0,32,76)","rgb(0,34,80)","rgb(0,35,85)","rgb(0,37,89)","rgb(0,39,94)","rgb(0,40,98)","rgb(0,42,102)","rgb(0,44,104)","rgb(0,46,105)","rgb(0,47,106)","rgb(0,49,108)","rgb(0,51,109)","rgb(2,52,110)","rgb(8,54,110)","rgb(15,56,109)","rgb(21,58,109)","rgb(28,60,109)","rgb(35,62,108)","rgb(40,64,108)","rgb(44,66,108)","rgb(47,67,108)","rgb(51,69,107)","rgb(55,71,107)","rgb(58,73,107)","rgb(61,75,107)","rgb(64,77,107)","rgb(67,79,107)","rgb(69,80,107)","rgb(72,82,107)","rgb(75,84,107)","rgb(77,86,107)","rgb(80,88,108)","rgb(83,89,108)","rgb(85,91,108)","rgb(88,93,109)","rgb(90,95,109)","rgb(93,96,109)","rgb(95,98,110)","rgb(97,100,110)","rgb(99,102,111)","rgb(101,104,111)","rgb(104,106,112)","rgb(106,108,113)","rgb(108,109,114)","rgb(110,111,114)","rgb(112,113,115)","rgb(115,115,116)","rgb(117,117,117)","rgb(119,119,117)","rgb(122,121,118)","rgb(124,123,119)","rgb(126,125,119)","rgb(129,127,120)","rgb(131,129,120)","rgb(134,131,120)","rgb(136,133,120)","rgb(139,135,120)","rgb(141,137,120)","rgb(144,138,120)","rgb(146,140,120)","rgb(149,142,120)","rgb(152,144,119)","rgb(154,146,119)","rgb(157,149,119)","rgb(159,151,118)","rgb(162,153,118)","rgb(164,155,117)","rgb(167,157,116)","rgb(169,159,116)","rgb(172,161,115)","rgb(175,164,114)","rgb(177,166,114)","rgb(180,168,113)","rgb(183,170,112)","rgb(185,172,111)","rgb(188,174,110)","rgb(191,176,109)","rgb(194,178,108)","rgb(196,181,107)","rgb(199,183,106)","rgb(202,185,105)","rgb(205,188,104)","rgb(208,190,102)","rgb(211,192,101)","rgb(213,195,99)","rgb(216,197,97)","rgb(219,199,96)","rgb(222,201,94)","rgb(224,203,92)","rgb(227,206,90)","rgb(230,209,88)","rgb(233,211,86)","rgb(237,214,84)","rgb(240,216,81)","rgb(243,219,79)","rgb(245,221,77)","rgb(247,223,76)","rgb(249,226,74)","rgb(251,228,72)","rgb(253,231,71)"]},{id:"inferno",colors:Utils.makeRGBColortable(0,0,3,0,0,4,0,0,6,1,0,7,1,1,9,1,1,11,2,1,14,2,2,16,3,2,18,4,3,20,4,3,22,5,4,24,6,4,27,7,5,29,8,6,31,9,6,33,10,7,35,11,7,38,13,8,40,14,8,42,15,9,45,16,9,47,18,10,50,19,10,52,20,11,54,22,11,57,23,11,59,25,11,62,26,11,64,28,12,67,29,12,69,31,12,71,32,12,74,34,11,76,36,11,78,38,11,80,39,11,82,41,11,84,43,10,86,45,10,88,46,10,90,48,10,92,50,9,93,52,9,95,53,9,96,55,9,97,57,9,98,59,9,100,60,9,101,62,9,102,64,9,102,65,9,103,67,10,104,69,10,105,70,10,105,72,11,106,74,11,106,75,12,107,77,12,107,79,13,108,80,13,108,82,14,108,83,14,109,85,15,109,87,15,109,88,16,109,90,17,109,91,17,110,93,18,110,95,18,110,96,19,110,98,20,110,99,20,110,101,21,110,102,21,110,104,22,110,106,23,110,107,23,110,109,24,110,110,24,110,112,25,110,114,25,109,115,26,109,117,27,109,118,27,109,120,28,109,122,28,109,123,29,108,125,29,108,126,30,108,128,31,107,129,31,107,131,32,107,133,32,106,134,33,106,136,33,106,137,34,105,139,34,105,141,35,105,142,36,104,144,36,104,145,37,103,147,37,103,149,38,102,150,38,102,152,39,101,153,40,100,155,40,100,156,41,99,158,41,99,160,42,98,161,43,97,163,43,97,164,44,96,166,44,95,167,45,95,169,46,94,171,46,93,172,47,92,174,48,91,175,49,91,177,49,90,178,50,89,180,51,88,181,51,87,183,52,86,184,53,86,186,54,85,187,55,84,189,55,83,190,56,82,191,57,81,193,58,80,194,59,79,196,60,78,197,61,77,199,62,76,200,62,75,201,63,74,203,64,73,204,65,72,205,66,71,207,68,70,208,69,68,209,70,67,210,71,66,212,72,65,213,73,64,214,74,63,215,75,62,217,77,61,218,78,59,219,79,58,220,80,57,221,82,56,222,83,55,223,84,54,224,86,52,226,87,51,227,88,50,228,90,49,229,91,48,230,92,46,230,94,45,231,95,44,232,97,43,233,98,42,234,100,40,235,101,39,236,103,38,237,104,37,237,106,35,238,108,34,239,109,33,240,111,31,240,112,30,241,114,29,242,116,28,242,117,26,243,119,25,243,121,24,244,122,22,245,124,21,245,126,20,246,128,18,246,129,17,247,131,16,247,133,14,248,135,13,248,136,12,248,138,11,249,140,9,249,142,8,249,144,8,250,145,7,250,147,6,250,149,6,250,151,6,251,153,6,251,155,6,251,157,6,251,158,7,251,160,7,251,162,8,251,164,10,251,166,11,251,168,13,251,170,14,251,172,16,251,174,18,251,176,20,251,177,22,251,179,24,251,181,26,251,183,28,251,185,30,250,187,33,250,189,35,250,191,37,250,193,40,249,195,42,249,197,44,249,199,47,248,201,49,248,203,52,248,205,55,247,207,58,247,209,60,246,211,63,246,213,66,245,215,69,245,217,72,244,219,75,244,220,79,243,222,82,243,224,86,243,226,89,242,228,93,242,230,96,241,232,100,241,233,104,241,235,108,241,237,112,241,238,116,241,240,121,241,242,125,242,243,129,242,244,133,243,246,137,244,247,141,245,248,145,246,250,149,247,251,153,249,252,157,250,253,160,252,254,164)},{id:"plasma",colors:Utils.makeRGBColortable(12,7,134,16,7,135,19,6,137,21,6,138,24,6,139,27,6,140,29,6,141,31,5,142,33,5,143,35,5,144,37,5,145,39,5,146,41,5,147,43,5,148,45,4,148,47,4,149,49,4,150,51,4,151,52,4,152,54,4,152,56,4,153,58,4,154,59,3,154,61,3,155,63,3,156,64,3,156,66,3,157,68,3,158,69,3,158,71,2,159,73,2,159,74,2,160,76,2,161,78,2,161,79,2,162,81,1,162,82,1,163,84,1,163,86,1,163,87,1,164,89,1,164,90,0,165,92,0,165,94,0,165,95,0,166,97,0,166,98,0,166,100,0,167,101,0,167,103,0,167,104,0,167,106,0,167,108,0,168,109,0,168,111,0,168,112,0,168,114,0,168,115,0,168,117,0,168,118,1,168,120,1,168,121,1,168,123,2,168,124,2,167,126,3,167,127,3,167,129,4,167,130,4,167,132,5,166,133,6,166,134,7,166,136,7,165,137,8,165,139,9,164,140,10,164,142,12,164,143,13,163,144,14,163,146,15,162,147,16,161,149,17,161,150,18,160,151,19,160,153,20,159,154,21,158,155,23,158,157,24,157,158,25,156,159,26,155,160,27,155,162,28,154,163,29,153,164,30,152,165,31,151,167,33,151,168,34,150,169,35,149,170,36,148,172,37,147,173,38,146,174,39,145,175,40,144,176,42,143,177,43,143,178,44,142,180,45,141,181,46,140,182,47,139,183,48,138,184,50,137,185,51,136,186,52,135,187,53,134,188,54,133,189,55,132,190,56,131,191,57,130,192,59,129,193,60,128,194,61,128,195,62,127,196,63,126,197,64,125,198,65,124,199,66,123,200,68,122,201,69,121,202,70,120,203,71,119,204,72,118,205,73,117,206,74,117,207,75,116,208,77,115,209,78,114,209,79,113,210,80,112,211,81,111,212,82,110,213,83,109,214,85,109,215,86,108,215,87,107,216,88,106,217,89,105,218,90,104,219,91,103,220,93,102,220,94,102,221,95,101,222,96,100,223,97,99,223,98,98,224,100,97,225,101,96,226,102,96,227,103,95,227,104,94,228,106,93,229,107,92,229,108,91,230,109,90,231,110,90,232,112,89,232,113,88,233,114,87,234,115,86,234,116,85,235,118,84,236,119,84,236,120,83,237,121,82,237,123,81,238,124,80,239,125,79,239,126,78,240,128,77,240,129,77,241,130,76,242,132,75,242,133,74,243,134,73,243,135,72,244,137,71,244,138,71,245,139,70,245,141,69,246,142,68,246,143,67,246,145,66,247,146,65,247,147,65,248,149,64,248,150,63,248,152,62,249,153,61,249,154,60,250,156,59,250,157,58,250,159,58,250,160,57,251,162,56,251,163,55,251,164,54,252,166,53,252,167,53,252,169,52,252,170,51,252,172,50,252,173,49,253,175,49,253,176,48,253,178,47,253,179,46,253,181,45,253,182,45,253,184,44,253,185,43,253,187,43,253,188,42,253,190,41,253,192,41,253,193,40,253,195,40,253,196,39,253,198,38,252,199,38,252,201,38,252,203,37,252,204,37,252,206,37,251,208,36,251,209,36,251,211,36,250,213,36,250,214,36,250,216,36,249,217,36,249,219,36,248,221,36,248,223,36,247,224,36,247,226,37,246,228,37,246,229,37,245,231,38,245,233,38,244,234,38,243,236,38,243,238,38,242,240,38,242,241,38,241,243,38,240,245,37,240,246,35,239,248,33)},{category:"Map Ramps"},{id:"white_blue",colors:["rgb(244,252,254)","rgb(101,239,255)","rgb(50,227,255)","rgb(0,169,204)","rgb(0,122,153)"]},{id:"blue_green",colors:["#f7fcfd","#e5f5f9","#ccece6","#99d8c9","#66c2a4","#41ae76","#238b45","#006d2c","#00441b"]},{id:"blue_purple",colors:["#f7fcfd","#e0ecf4","#bfd3e6","#9ebcda","#8c96c6","#8c6bb1","#88419d","#810f7c","#4d004b"]},{id:"green_blue",colors:["#f7fcf0","#e0f3db","#ccebc5","#a8ddb5","#7bccc4","#4eb3d3","#2b8cbe","#0868ac","#084081"]},{id:"orange_red",colors:["#fff7ec","#fee8c8","#fdd49e","#fdbb84","#fc8d59","#ef6548","#d7301f","#b30000","#7f0000"]},{id:"purple_blue",colors:["#fff7fb","#ece7f2","#d0d1e6","#a6bddb","#74a9cf","#3690c0","#0570b0","#045a8d","#023858"]},{id:"purple_blue_green",colors:["#fff7fb","#ece2f0","#d0d1e6","#a6bddb","#67a9cf","#3690c0","#02818a","#016c59","#014636"]},{id:"purple_red",colors:["#f7f4f9","#e7e1ef","#d4b9da","#c994c7","#df65b0","#e7298a","#ce1256","#980043","#67001f"]},{id:"red_purple",colors:["#fff7f3","#fde0dd","#fcc5c0","#fa9fb5","#f768a1","#dd3497","#ae017e","#7a0177","#49006a"]},{id:"yellow_green",colors:["#ffffe5","#f7fcb9","#d9f0a3","#addd8e","#78c679","#41ab5d","#238443","#006837","#004529"]},{id:"yellow_green_blue",colors:["#ffffd9","#edf8b1","#c7e9b4","#7fcdbb","#41b6c4","#1d91c0","#225ea8","#253494","#081d58"]},{id:"yellow_orange_brown",colors:["#ffffe5","#fff7bc","#fee391","#fec44f","#fe9929","#ec7014","#cc4c02","#993404","#662506"]},{id:"yellow_orange_red",colors:["#ffffcc","#ffeda0","#fed976","#feb24c","#fd8d3c","#fc4e2a","#e31a1c","#bd0026","#800026"]},{id:"oranges",colors:["#fdd0a2","#fdae6b","#fd8d3c","#f16913","#d94801","#a63603","#7f2704"]},{id:"purples",colors:["#fcfbfd","#efedf5","#dadaeb","#bcbddc","#9e9ac8","#807dba","#6a51a3","#54278f","#3f007d"]},{id:"reds",colors:["#fff5f0","#fee0d2","#fcbba1","#fc9272","#fb6a4a","#ef3b2c","#cb181d","#a50f15","#67000d"]},{id:"greens",colors:["#c7e9c0","#a1d99b","#74c476","#41ab5d","#238b45","#006d2c","#00441b"]},{id:"map_grays",colors:["#ffffff","#f0f0f0","#d9d9d9","#bdbdbd","#969696","#737373","#525252","#252525","#000000"]},{id:"d3_schemeBuGn",colors:["#f7fcfd","#e5f5f9","#ccece6","#99d8c9","#66c2a4","#41ae76","#238b45","#006d2c","#00441b"]},{id:"d3_schemeBuPu",colors:["#f7fcfd","#e0ecf4","#bfd3e6","#9ebcda","#8c96c6","#8c6bb1","#88419d","#810f7c","#4d004b"]},{id:"d3_schemeGnBu",colors:["#f7fcf0","#e0f3db","#ccebc5","#a8ddb5","#7bccc4","#4eb3d3","#2b8cbe","#0868ac","#084081"]},{id:"d3_schemeGreens",colors:["#f7fcf5","#e5f5e0","#c7e9c0","#a1d99b","#74c476","#41ab5d","#238b45","#006d2c","#00441b"]},{id:"d3_schemeGreys",colors:["#ffffff","#f0f0f0","#d9d9d9","#bdbdbd","#969696","#737373","#525252","#252525","#000000"]},{id:"d3_schemeOrRd",colors:["#fff7ec","#fee8c8","#fdd49e","#fdbb84","#fc8d59","#ef6548","#d7301f","#b30000","#7f0000"]},{id:"d3_schemeOranges",colors:["#fff5eb","#fee6ce","#fdd0a2","#fdae6b","#fd8d3c","#f16913","#d94801","#a63603","#7f2704"]},{id:"d3_schemePuBu",colors:["#fff7fb","#ece7f2","#d0d1e6","#a6bddb","#74a9cf","#3690c0","#0570b0","#045a8d","#023858"]},{id:"d3_schemePuBuGn",colors:["#fff7fb","#ece2f0","#d0d1e6","#a6bddb","#67a9cf","#3690c0","#02818a","#016c59","#014636"]},{id:"d3_schemePuRd",colors:["#f7f4f9","#e7e1ef","#d4b9da","#c994c7","#df65b0","#e7298a","#ce1256","#980043","#67001f"]},{id:"d3_schemePurples",colors:["#fcfbfd","#efedf5","#dadaeb","#bcbddc","#9e9ac8","#807dba","#6a51a3","#54278f","#3f007d"]},{id:"d3_schemeReds",colors:["#fff5f0","#fee0d2","#fcbba1","#fc9272","#fb6a4a","#ef3b2c","#cb181d","#a50f15","#67000d"]},{id:"d3_schemeYlGn",colors:["#ffffe5","#f7fcb9","#d9f0a3","#addd8e","#78c679","#41ab5d","#238443","#006837","#004529"]},{id:"d3_schemeYlGnBu",colors:["#ffffd9","#edf8b1","#c7e9b4","#7fcdbb","#41b6c4","#1d91c0","#225ea8","#253494","#081d58"]},{id:"d3_schemeRdPu",colors:["#fff7f3","#fde0dd","#fcc5c0","#fa9fb5","#f768a1","#dd3497","#ae017e","#7a0177","#49006a"]},{category:"Divergent"},{id:"red_blue",colors:["rgb(234,12,48)","rgb(234,12,48)","rgb(234,12,48)","rgb(26,12,234)","rgb(26,12,234)","rgb(26,12,234)"]},{id:"blue_red",colors:["rgb(26,12,234)","rgb(26,12,234)","rgb(26,12,234)","rgb(234,12,48)","rgb(234,12,48)","rgb(234,12,48)"]},{id:"blue_white_red",colors:["rgb(0,0,255)","rgb(2,2,255)","rgb(4,4,255)","rgb(6,6,255)","rgb(8,8,255)","rgb(10,10,255)","rgb(12,12,255)","rgb(14,14,255)","rgb(16,16,255)","rgb(18,18,255)","rgb(20,20,255)","rgb(22,22,255)","rgb(24,24,255)","rgb(26,26,255)","rgb(28,28,255)","rgb(30,30,255)","rgb(32,32,255)","rgb(34,34,255)","rgb(36,36,255)","rgb(38,38,255)","rgb(40,40,255)","rgb(42,42,255)","rgb(44,44,255)","rgb(46,46,255)","rgb(48,48,255)","rgb(50,50,255)","rgb(52,52,255)","rgb(54,54,255)","rgb(56,56,255)","rgb(58,58,255)","rgb(60,60,255)","rgb(62,62,255)","rgb(64,64,255)","rgb(66,66,255)","rgb(68,68,255)","rgb(70,70,255)","rgb(72,72,255)","rgb(74,74,255)","rgb(76,76,255)","rgb(78,78,255)","rgb(80,80,255)","rgb(82,82,255)","rgb(84,84,255)","rgb(86,86,255)","rgb(88,88,255)","rgb(90,90,255)","rgb(92,92,255)","rgb(94,94,255)","rgb(96,96,255)","rgb(98,98,255)","rgb(100,100,255)","rgb(102,102,255)","rgb(104,104,255)","rgb(106,106,255)","rgb(108,108,255)","rgb(110,110,255)","rgb(112,112,255)","rgb(114,114,255)","rgb(116,116,255)","rgb(118,118,255)","rgb(120,120,255)","rgb(122,122,255)","rgb(124,124,255)","rgb(126,126,255)","rgb(128,128,255)","rgb(130,130,255)","rgb(132,132,255)","rgb(134,134,255)","rgb(136,136,255)","rgb(138,138,255)","rgb(140,140,255)","rgb(142,142,255)","rgb(144,144,255)","rgb(146,146,255)","rgb(148,148,255)","rgb(150,150,255)","rgb(152,152,255)","rgb(154,154,255)","rgb(156,156,255)","rgb(158,158,255)","rgb(160,160,255)","rgb(162,162,255)","rgb(164,164,255)","rgb(166,166,255)","rgb(168,168,255)","rgb(170,170,255)","rgb(172,172,255)","rgb(174,174,255)","rgb(176,176,255)","rgb(178,178,255)","rgb(180,180,255)","rgb(182,182,255)","rgb(184,184,255)","rgb(186,186,255)","rgb(188,188,255)","rgb(190,190,255)","rgb(192,192,255)","rgb(194,194,255)","rgb(196,196,255)","rgb(198,198,255)","rgb(200,200,255)","rgb(202,202,255)","rgb(204,204,255)","rgb(206,206,255)","rgb(208,208,255)","rgb(210,210,255)","rgb(212,212,255)","rgb(214,214,255)","rgb(216,216,255)","rgb(218,218,255)","rgb(220,220,255)","rgb(222,222,255)","rgb(224,224,255)","rgb(226,226,255)","rgb(228,228,255)","rgb(230,230,255)","rgb(232,232,255)","rgb(234,234,255)","rgb(236,236,255)","rgb(238,238,255)","rgb(240,240,255)","rgb(242,242,255)","rgb(244,244,255)","rgb(246,246,255)","rgb(248,248,255)","rgb(250,250,255)","rgb(252,252,255)","rgb(252,251,254)","rgb(252,249,252)","rgb(252,247,250)","rgb(252,245,248)","rgb(252,243,246)","rgb(252,241,244)","rgb(252,239,242)","rgb(252,237,240)","rgb(252,235,238)","rgb(252,233,236)","rgb(252,231,234)","rgb(252,229,232)","rgb(252,227,230)","rgb(252,225,228)","rgb(252,223,226)","rgb(252,221,224)","rgb(252,219,222)","rgb(252,217,220)","rgb(252,215,218)","rgb(252,213,216)","rgb(252,211,214)","rgb(252,209,212)","rgb(252,207,210)","rgb(252,205,208)","rgb(252,203,206)","rgb(252,202,204)","rgb(252,200,202)","rgb(252,198,200)","rgb(252,196,198)","rgb(252,194,196)","rgb(252,192,194)","rgb(252,190,192)","rgb(252,188,190)","rgb(252,186,188)","rgb(252,184,186)","rgb(252,182,184)","rgb(252,180,182)","rgb(252,178,180)","rgb(252,176,178)","rgb(252,174,176)","rgb(252,172,174)","rgb(253,170,172)","rgb(253,168,170)","rgb(253,166,168)","rgb(253,164,166)","rgb(253,162,164)","rgb(253,160,162)","rgb(253,158,160)","rgb(253,156,158)","rgb(253,154,156)","rgb(253,153,154)","rgb(253,151,152)","rgb(253,149,150)","rgb(253,147,148)","rgb(253,145,146)","rgb(253,143,144)","rgb(253,141,142)","rgb(253,139,140)","rgb(253,137,138)","rgb(253,135,136)","rgb(253,133,134)","rgb(253,131,132)","rgb(253,129,131)","rgb(253,127,129)","rgb(253,125,127)","rgb(253,123,125)","rgb(253,121,123)","rgb(253,119,121)","rgb(253,117,119)","rgb(253,115,117)","rgb(253,113,115)","rgb(253,111,113)","rgb(253,109,111)","rgb(253,107,109)","rgb(253,105,107)","rgb(253,104,105)","rgb(253,102,103)","rgb(253,100,101)","rgb(253,98,99)","rgb(253,96,97)","rgb(253,94,95)","rgb(253,92,93)","rgb(253,90,91)","rgb(254,88,89)","rgb(254,86,87)","rgb(254,84,85)","rgb(254,82,83)","rgb(254,80,81)","rgb(254,78,79)","rgb(254,76,77)","rgb(254,74,75)","rgb(254,72,73)","rgb(254,70,71)","rgb(254,68,69)","rgb(254,66,67)","rgb(254,64,65)","rgb(254,62,63)","rgb(254,60,61)","rgb(254,58,59)","rgb(254,56,57)","rgb(254,55,55)","rgb(254,53,53)","rgb(254,51,51)","rgb(254,49,49)","rgb(254,47,47)","rgb(254,45,45)","rgb(254,43,43)","rgb(254,41,41)","rgb(254,39,39)","rgb(254,37,37)","rgb(254,35,35)","rgb(254,33,33)","rgb(254,31,31)","rgb(254,29,29)","rgb(254,27,27)","rgb(254,25,25)","rgb(254,23,23)","rgb(254,21,21)","rgb(254,19,19)","rgb(254,17,17)","rgb(254,15,15)","rgb(254,13,13)","rgb(254,11,11)","rgb(254,9,9)"]},{id:"red_white_blue",colors:["rgb(254,9,9)","rgb(254,11,11)","rgb(254,13,13)","rgb(254,15,15)","rgb(254,17,17)","rgb(254,19,19)","rgb(254,21,21)","rgb(254,23,23)","rgb(254,25,25)","rgb(254,27,27)","rgb(254,29,29)","rgb(254,31,31)","rgb(254,33,33)","rgb(254,35,35)","rgb(254,37,37)","rgb(254,39,39)","rgb(254,41,41)","rgb(254,43,43)","rgb(254,45,45)","rgb(254,47,47)","rgb(254,49,49)","rgb(254,51,51)","rgb(254,53,53)","rgb(254,55,55)","rgb(254,56,57)","rgb(254,58,59)","rgb(254,60,61)","rgb(254,62,63)","rgb(254,64,65)","rgb(254,66,67)","rgb(254,68,69)","rgb(254,70,71)","rgb(254,72,73)","rgb(254,74,75)","rgb(254,76,77)","rgb(254,78,79)","rgb(254,80,81)","rgb(254,82,83)","rgb(254,84,85)","rgb(254,86,87)","rgb(254,88,89)","rgb(253,90,91)","rgb(253,92,93)","rgb(253,94,95)","rgb(253,96,97)","rgb(253,98,99)","rgb(253,100,101)","rgb(253,102,103)","rgb(253,104,105)","rgb(253,105,107)","rgb(253,107,109)","rgb(253,109,111)","rgb(253,111,113)","rgb(253,113,115)","rgb(253,115,117)","rgb(253,117,119)","rgb(253,119,121)","rgb(253,121,123)","rgb(253,123,125)","rgb(253,125,127)","rgb(253,127,129)","rgb(253,129,131)","rgb(253,131,132)","rgb(253,133,134)","rgb(253,135,136)","rgb(253,137,138)","rgb(253,139,140)","rgb(253,141,142)","rgb(253,143,144)","rgb(253,145,146)","rgb(253,147,148)","rgb(253,149,150)","rgb(253,151,152)","rgb(253,153,154)","rgb(253,154,156)","rgb(253,156,158)","rgb(253,158,160)","rgb(253,160,162)","rgb(253,162,164)","rgb(253,164,166)","rgb(253,166,168)","rgb(253,168,170)","rgb(253,170,172)","rgb(252,172,174)","rgb(252,174,176)","rgb(252,176,178)","rgb(252,178,180)","rgb(252,180,182)","rgb(252,182,184)","rgb(252,184,186)","rgb(252,186,188)","rgb(252,188,190)","rgb(252,190,192)","rgb(252,192,194)","rgb(252,194,196)","rgb(252,196,198)","rgb(252,198,200)","rgb(252,200,202)","rgb(252,202,204)","rgb(252,203,206)","rgb(252,205,208)","rgb(252,207,210)","rgb(252,209,212)","rgb(252,211,214)","rgb(252,213,216)","rgb(252,215,218)","rgb(252,217,220)","rgb(252,219,222)","rgb(252,221,224)","rgb(252,223,226)","rgb(252,225,228)","rgb(252,227,230)","rgb(252,229,232)","rgb(252,231,234)","rgb(252,233,236)","rgb(252,235,238)","rgb(252,237,240)","rgb(252,239,242)","rgb(252,241,244)","rgb(252,243,246)","rgb(252,245,248)","rgb(252,247,250)","rgb(252,249,252)","rgb(252,251,254)","rgb(252,252,255)","rgb(250,250,255)","rgb(248,248,255)","rgb(246,246,255)","rgb(244,244,255)","rgb(242,242,255)","rgb(240,240,255)","rgb(238,238,255)","rgb(236,236,255)","rgb(234,234,255)","rgb(232,232,255)","rgb(230,230,255)","rgb(228,228,255)","rgb(226,226,255)","rgb(224,224,255)","rgb(222,222,255)","rgb(220,220,255)","rgb(218,218,255)","rgb(216,216,255)","rgb(214,214,255)","rgb(212,212,255)","rgb(210,210,255)","rgb(208,208,255)","rgb(206,206,255)","rgb(204,204,255)","rgb(202,202,255)","rgb(200,200,255)","rgb(198,198,255)","rgb(196,196,255)","rgb(194,194,255)","rgb(192,192,255)","rgb(190,190,255)","rgb(188,188,255)","rgb(186,186,255)","rgb(184,184,255)","rgb(182,182,255)","rgb(180,180,255)","rgb(178,178,255)","rgb(176,176,255)","rgb(174,174,255)","rgb(172,172,255)","rgb(170,170,255)","rgb(168,168,255)","rgb(166,166,255)","rgb(164,164,255)","rgb(162,162,255)","rgb(160,160,255)","rgb(158,158,255)","rgb(156,156,255)","rgb(154,154,255)","rgb(152,152,255)","rgb(150,150,255)","rgb(148,148,255)","rgb(146,146,255)","rgb(144,144,255)","rgb(142,142,255)","rgb(140,140,255)","rgb(138,138,255)","rgb(136,136,255)","rgb(134,134,255)","rgb(132,132,255)","rgb(130,130,255)","rgb(128,128,255)","rgb(126,126,255)","rgb(124,124,255)","rgb(122,122,255)","rgb(120,120,255)","rgb(118,118,255)","rgb(116,116,255)","rgb(114,114,255)","rgb(112,112,255)","rgb(110,110,255)","rgb(108,108,255)","rgb(106,106,255)","rgb(104,104,255)","rgb(102,102,255)","rgb(100,100,255)","rgb(98,98,255)","rgb(96,96,255)","rgb(94,94,255)","rgb(92,92,255)","rgb(90,90,255)","rgb(88,88,255)","rgb(86,86,255)","rgb(84,84,255)","rgb(82,82,255)","rgb(80,80,255)","rgb(78,78,255)","rgb(76,76,255)","rgb(74,74,255)","rgb(72,72,255)","rgb(70,70,255)","rgb(68,68,255)","rgb(66,66,255)","rgb(64,64,255)","rgb(62,62,255)","rgb(60,60,255)","rgb(58,58,255)","rgb(56,56,255)","rgb(54,54,255)","rgb(52,52,255)","rgb(50,50,255)","rgb(48,48,255)","rgb(46,46,255)","rgb(44,44,255)","rgb(42,42,255)","rgb(40,40,255)","rgb(38,38,255)","rgb(36,36,255)","rgb(34,34,255)","rgb(32,32,255)","rgb(30,30,255)","rgb(28,28,255)","rgb(26,26,255)","rgb(24,24,255)","rgb(22,22,255)","rgb(20,20,255)","rgb(18,18,255)","rgb(16,16,255)","rgb(14,14,255)","rgb(12,12,255)","rgb(10,10,255)","rgb(8,8,255)","rgb(6,6,255)","rgb(4,4,255)","rgb(2,2,255)","rgb(0,0,255)"]},{id:"red_white_green",colors:["rgb(255,0,0)","rgb(255,5,5)","rgb(255,10,10)","rgb(255,15,15)","rgb(255,20,20)","rgb(255,25,25)","rgb(255,30,30)","rgb(255,35,35)","rgb(255,40,40)","rgb(255,45,45)","rgb(255,50,50)","rgb(255,55,55)","rgb(255,60,60)","rgb(255,66,66)","rgb(255,71,71)","rgb(255,76,76)","rgb(255,81,81)","rgb(255,86,86)","rgb(255,91,91)","rgb(255,96,96)","rgb(255,101,101)","rgb(255,106,106)","rgb(255,111,111)","rgb(255,116,116)","rgb(255,121,121)","rgb(255,126,126)","rgb(255,132,132)","rgb(255,137,137)","rgb(255,142,142)","rgb(255,147,147)","rgb(255,152,152)","rgb(255,157,157)","rgb(255,162,162)","rgb(255,167,167)","rgb(255,172,172)","rgb(255,177,177)","rgb(255,182,182)","rgb(255,187,187)","rgb(255,193,193)","rgb(255,198,198)","rgb(255,203,203)","rgb(255,208,208)","rgb(255,213,213)","rgb(255,218,218)","rgb(255,223,223)","rgb(255,228,228)","rgb(255,233,233)","rgb(255,238,238)","rgb(255,243,243)","rgb(255,248,248)","rgb(251,246,245)","rgb(247,244,242)","rgb(243,242,239)","rgb(239,240,236)","rgb(235,238,233)","rgb(231,236,230)","rgb(227,234,226)","rgb(223,231,223)","rgb(219,229,220)","rgb(215,227,217)","rgb(210,225,214)","rgb(206,223,211)","rgb(202,221,207)","rgb(198,219,204)","rgb(194,216,201)","rgb(190,214,198)","rgb(186,212,195)","rgb(182,210,192)","rgb(178,208,189)","rgb(174,206,185)","rgb(169,204,182)","rgb(165,201,179)","rgb(161,199,176)","rgb(157,197,173)","rgb(153,195,170)","rgb(149,193,166)","rgb(145,191,163)","rgb(141,189,160)","rgb(137,187,157)","rgb(133,184,154)","rgb(128,182,151)","rgb(124,180,147)","rgb(120,178,144)","rgb(116,176,141)","rgb(112,174,138)","rgb(108,172,135)","rgb(104,169,132)","rgb(100,167,129)","rgb(96,165,125)","rgb(92,163,122)","rgb(87,161,119)","rgb(83,159,116)","rgb(79,157,113)","rgb(75,154,110)","rgb(71,152,106)","rgb(67,150,103)","rgb(63,148,100)","rgb(59,146,97)","rgb(55,144,94)","rgb(51,142,91)"]},{id:"plotly_rdbu",colors:["rgb(5,10,172)","rgb(8,14,174)","rgb(11,17,176)","rgb(14,21,178)","rgb(17,25,181)","rgb(19,28,183)","rgb(22,32,185)","rgb(25,35,187)","rgb(28,39,189)","rgb(31,43,191)","rgb(34,46,193)","rgb(37,50,196)","rgb(40,54,198)","rgb(43,57,200)","rgb(45,61,202)","rgb(48,64,204)","rgb(51,68,206)","rgb(54,72,208)","rgb(57,75,211)","rgb(60,79,213)","rgb(63,83,215)","rgb(66,86,217)","rgb(68,90,219)","rgb(71,93,221)","rgb(74,97,223)","rgb(77,101,226)","rgb(80,104,228)","rgb(83,108,230)","rgb(86,112,232)","rgb(89,115,234)","rgb(92,119,236)","rgb(94,122,238)","rgb(97,126,241)","rgb(100,130,243)","rgb(103,133,245)","rgb(106,137,247)","rgb(112,141,243)","rgb(117,144,239)","rgb(123,148,236)","rgb(128,151,232)","rgb(134,155,228)","rgb(140,158,224)","rgb(145,162,220)","rgb(151,165,217)","rgb(156,169,213)","rgb(162,172,209)","rgb(168,176,205)","rgb(173,179,201)","rgb(179,183,198)","rgb(184,186,194)","rgb(190,190,190)","rgb(193,188,184)","rgb(196,186,178)","rgb(199,184,173)","rgb(202,182,167)","rgb(205,180,161)","rgb(208,178,155)","rgb(211,176,149)","rgb(214,174,144)","rgb(217,172,138)","rgb(220,170,132)","rgb(221,167,128)","rgb(222,165,124)","rgb(223,162,119)","rgb(224,160,115)","rgb(225,157,111)","rgb(226,155,107)","rgb(227,152,103)","rgb(228,150,98)","rgb(229,147,94)","rgb(230,145,90)","rgb(228,140,88)","rgb(227,136,86)","rgb(225,131,84)","rgb(223,127,82)","rgb(221,122,80)","rgb(220,118,78)","rgb(218,113,76)","rgb(216,109,73)","rgb(214,104,71)","rgb(213,100,69)","rgb(211,95,67)","rgb(209,91,65)","rgb(207,86,63)","rgb(206,82,61)","rgb(204,77,59)","rgb(202,73,57)","rgb(201,68,55)","rgb(199,64,53)","rgb(197,59,51)","rgb(195,55,49)","rgb(194,50,47)","rgb(192,46,45)","rgb(190,41,42)","rgb(188,37,40)","rgb(187,32,38)","rgb(185,28,36)","rgb(183,23,34)","rgb(181,19,32)","rgb(180,14,30)"]},{id:"blue_green_red",colors:["rgb(0,0,255)","rgb(8,17,246)","rgb(17,35,237)","rgb(26,52,228)","rgb(35,70,219)","rgb(43,87,211)","rgb(52,105,202)","rgb(61,123,193)","rgb(70,140,184)","rgb(79,158,175)","rgb(87,175,167)","rgb(96,193,158)","rgb(105,211,149)","rgb(114,228,140)","rgb(123,246,131)","rgb(131,246,123)","rgb(140,228,114)","rgb(149,211,105)","rgb(158,193,96)","rgb(167,175,87)","rgb(175,158,79)","rgb(184,140,70)","rgb(193,123,61)","rgb(202,105,52)","rgb(211,87,43)","rgb(219,70,35)","rgb(228,52,26)","rgb(237,35,17)","rgb(246,17,8)","rgb(255,0,0)"]},{id:"red_green_blue",colors:["rgb(255,0,0)","rgb(246,17,8)","rgb(237,35,17)","rgb(228,52,26)","rgb(219,70,35)","rgb(211,87,43)","rgb(202,105,52)","rgb(193,123,61)","rgb(184,140,70)","rgb(175,158,79)","rgb(167,175,87)","rgb(158,193,96)","rgb(149,211,105)","rgb(140,228,114)","rgb(131,246,123)","rgb(123,246,131)","rgb(114,228,140)","rgb(105,211,149)","rgb(96,193,158)","rgb(87,175,167)","rgb(79,158,175)","rgb(70,140,184)","rgb(61,123,193)","rgb(52,105,202)","rgb(43,87,211)","rgb(35,70,219)","rgb(26,52,228)","rgb(17,35,237)","rgb(8,17,246)","rgb(0,0,255)"]},{id:"d3_schemeBrBG",colors:["#543005","#8c510a","#bf812d","#dfc27d","#f6e8c3","#f5f5f5","#c7eae5","#80cdc1","#35978f","#01665e","#003c30"]},{id:"d3_schemePRGn",colors:["#40004b","#762a83","#9970ab","#c2a5cf","#e7d4e8","#f7f7f7","#d9f0d3","#a6dba0","#5aae61","#1b7837","#00441b"]},{id:"d3_schemePiYG",colors:["#8e0152","#c51b7d","#de77ae","#f1b6da","#fde0ef","#f7f7f7","#e6f5d0","#b8e186","#7fbc41","#4d9221","#276419"]},{id:"d3_schemePuOr",colors:["#2d004b","#542788","#8073ac","#b2abd2","#d8daeb","#f7f7f7","#fee0b6","#fdb863","#e08214","#b35806","#7f3b08"]},{id:"d3_schemeRdYlBu",colors:["#a50026","#d73027","#f46d43","#fdae61","#fee090","#ffffbf","#e0f3f8","#abd9e9","#74add1","#4575b4","#313695"]},{id:"d3_schemeRdBu",colors:["#67001f","#b2182b","#d6604d","#f4a582","#fddbc7","#f7f7f7","#d1e5f0","#92c5de","#4393c3","#2166ac","#053061"]},{id:"d3_schemeRdGy",colors:["#67001f","#b2182b","#d6604d","#f4a582","#fddbc7","#ffffff","#e0e0e0","#bababa","#878787","#4d4d4d","#1a1a1a"]},{id:"d3_schemeRdYlGn",colors:["#a50026","#d73027","#f46d43","#fdae61","#fee08b","#ffffbf","#d9ef8b","#a6d96a","#66bd63","#1a9850","#006837"]},{id:"d3_schemeSpectral",colors:["#9e0142","#d53e4f","#f46d43","#fdae61","#fee08b","#ffffbf","#e6f598","#abdda4","#66c2a5","#3288bd","#5e4fa2"]},{category:"Categorical"},{id:"gpt50",colors:["rgb(31,119,180)","rgb(255,127,14)","rgb(255,187,120)","rgb(174,199,232)","rgb(44,160,44)","rgb(152,223,138)","rgb(214,39,40)","rgb(255,152,150)","rgb(148,103,189)","rgb(197,176,213)","rgb(140,86,75)","rgb(196,156,148)","rgb(227,119,194)","rgb(247,182,210)","rgb(127,127,127)","rgb(199,199,199)","rgb(188,189,34)","rgb(219,219,141)","rgb(23,190,207)","rgb(158,218,229)","rgb(218,60,60)","rgb(230,197,197)","rgb(3,81,0)","rgb(146,143,143)","rgb(140,0,140)","rgb(153,153,153)","rgb(0,80,90)","rgb(230,143,143)","rgb(0,0,0)","rgb(250,215,215)","rgb(0,100,0)","rgb(78,238,148)","rgb(205,0,90)","rgb(255,228,225)","rgb(139,58,98)","rgb(238,238,238)","rgb(205,92,92)","rgb(75,0,130)","rgb(255,235,205)","rgb(0,0,139)","rgb(139,0,139)","rgb(0,0,255)","rgb(238,130,238)","rgb(0,139,139)","rgb(0,100,0)","rgb(189,183,107)","rgb(139,0,0)","rgb(233,150,122)","rgb(143,188,143)","rgb(72,61,139)"]},{id:"gpt100",colors:["#1f77b4","#ff7f0e","#ffbb78","#2ca02c","#98df8a","#aec7e8","#d62728","#ff9896","#9467bd","#c5b0d5","#8c564b","#c49c94","#e377c2","#f7b6d2","#7f7f7f","#c7c7c7","#bcbd22","#dbdb8d","#17becf","#9edae5","#393b79","#5254a3","#6b6ecf","#9c9ede","#637939","#8ca252","#b5cf6b","#cedb9c","#8c6d31","#bd9e39","#e7ba52","#e7cb94","#843c39","#ad494a","#d6616b","#e7969c","#7b4173","#a55194","#ce6dbd","#de9ed6","#3182bd","#6baed6","#9ecae1","#c6dbef","#e6550d","#fd8d3c","#fdae6b","#fdd0a2","#31a354","#74c476","#a1d99b","#c7e9c0","#756bb1","#9e9ac8","#bcbddc","#dadaeb","#636363","#969696","#bdbdbd","#d9d9d9"]},{id:"cats256",colors:["rgb(31,119,179)","rgb(255,126,14)","rgb(43,160,43)","rgb(214,38,40)","rgb(147,103,188)","rgb(140,86,75)","rgb(226,119,193)","rgb(126,126,126)","rgb(188,188,33)","rgb(22,189,207)","rgb(58,1,130)","rgb(0,66,1)","rgb(15,255,168)","rgb(93,0,63)","rgb(188,188,255)","rgb(216,175,161)","rgb(184,0,128)","rgb(0,77,82)","rgb(107,100,0)","rgb(124,1,0)","rgb(96,38,255)","rgb(255,255,154)","rgb(86,73,100)","rgb(140,184,147)","rgb(147,251,255)","rgb(1,130,103)","rgb(144,255,0)","rgb(130,0,160)","rgb(172,137,68)","rgb(91,52,0)","rgb(255,191,242)","rgb(255,110,117)","rgb(121,140,255)","rgb(221,0,255)","rgb(80,86,70)","rgb(0,68,137)","rgb(255,191,96)","rgb(255,1,140)","rgb(189,200,207)","rgb(175,151,181)","rgb(182,86,0)","rgb(1,112,0)","rgb(205,135,255)","rgb(28,214,70)","rgb(191,235,195)","rgb(121,151,181)","rgb(165,96,137)","rgb(110,137,86)","rgb(188,124,117)","rgb(138,40,68)","rgb(0,172,255)","rgb(142,212,255)","rgb(75,109,119)","rgb(0,212,177)","rgb(147,0,242)","rgb(138,149,0)","rgb(93,91,158)","rgb(253,223,186)","rgb(0,147,158)","rgb(255,219,0)","rgb(0,170,121)","rgb(82,0,103)","rgb(0,0,145)","rgb(10,93,61)","rgb(165,226,117)","rgb(98,59,65)","rgb(198,198,137)","rgb(255,158,181)","rgb(205,79,107)","rgb(255,7,214)","rgb(138,58,5)","rgb(126,61,112)","rgb(255,73,1)","rgb(96,43,165)","rgb(28,0,255)","rgb(230,223,255)","rgb(170,59,175)","rgb(216,156,0)","rgb(163,163,158)","rgb(63,105,255)","rgb(70,73,12)","rgb(123,105,133)","rgb(107,151,140)","rgb(255,154,117)","rgb(131,91,255)","rgb(124,107,70)","rgb(128,182,84)","rgb(188,0,73)","rgb(253,147,255)","rgb(93,0,24)","rgb(137,209,209)","rgb(156,140,211)","rgb(218,109,66)","rgb(138,87,0)","rgb(59,80,105)","rgb(75,107,59)","rgb(237,207,216)","rgb(207,237,255)","rgb(170,21,0)","rgb(223,255,79)","rgb(255,42,86)","rgb(209,73,158)","rgb(112,124,184)","rgb(89,128,0)","rgb(0,228,253)","rgb(119,75,149)","rgb(103,212,140)","rgb(61,58,114)","rgb(172,65,63)","rgb(214,161,102)","rgb(193,105,205)","rgb(105,89,93)","rgb(135,172,237)","rgb(160,165,105)","rgb(209,170,230)","rgb(135,0,98)","rgb(0,253,219)","rgb(103,40,24)","rgb(179,66,255)","rgb(14,89,196)","rgb(22,135,66)","rgb(144,211,0)","rgb(205,121,0)","rgb(249,89,255)","rgb(91,116,102)","rgb(142,174,179)","rgb(156,124,140)","rgb(70,0,198)","rgb(107,77,45)","rgb(165,109,70)","rgb(158,137,114)","rgb(168,175,202)","rgb(205,140,167)","rgb(0,253,100)","rgb(145,121,0)","rgb(255,98,161)","rgb(244,255,216)","rgb(1,140,240)","rgb(19,172,160)","rgb(91,45,89)","rgb(137,133,158)","rgb(207,204,186)","rgb(212,175,196)","rgb(219,221,109)","rgb(207,255,244)","rgb(0,100,133)","rgb(0,105,98)","rgb(168,65,103)","rgb(45,151,196)","rgb(168,116,255)","rgb(38,186,93)","rgb(87,182,0)","rgb(202,255,167)","rgb(163,121,170)","rgb(255,188,147)","rgb(137,226,193)","rgb(15,200,255)","rgb(212,0,196)","rgb(98,109,137)","rgb(105,133,142)","rgb(75,77,82)","rgb(170,96,103)","rgb(121,181,212)","rgb(43,89,22)","rgb(154,0,36)","rgb(189,209,242)","rgb(137,110,103)","rgb(105,165,107)","rgb(133,84,103)","rgb(174,205,186)","rgb(135,153,126)","rgb(202,219,0)","rgb(154,3,144)","rgb(235,188,26)","rgb(235,156,209)","rgb(112,0,110)","rgb(177,161,49)","rgb(202,107,147)","rgb(65,70,163)","rgb(228,140,137)","rgb(212,68,0)","rgb(198,138,202)","rgb(182,149,151)","rgb(212,31,117)","rgb(114,75,204)","rgb(103,77,0)","rgb(103,33,56)","rgb(56,86,79)","rgb(110,186,170)","rgb(133,58,49)","rgb(165,211,151)","rgb(184,175,142)","rgb(216,228,223)","rgb(170,0,223)","rgb(202,193,219)","rgb(255,223,140)","rgb(226,82,77)","rgb(102,105,110)","rgb(255,0,28)","rgb(82,45,114)","rgb(77,144,107)","rgb(168,109,17)","rgb(255,158,38)","rgb(94,163,175)","rgb(200,133,86)","rgb(145,89,151)","rgb(163,161,255)","rgb(253,186,186)","rgb(36,42,135)","rgb(219,230,168)","rgb(151,242,167)","rgb(103,147,214)","rgb(186,91,63)","rgb(58,93,145)","rgb(54,79,47)","rgb(38,124,149)","rgb(137,149,154)","rgb(207,179,86)","rgb(0,70,100)","rgb(94,93,47)","rgb(142,142,65)","rgb(172,63,19)","rgb(105,149,59)","rgb(161,61,133)","rgb(191,182,186)","rgb(172,198,103)","rgb(100,105,207)","rgb(145,175,0)"]},{id:"rainbow",colors:["red","orange","yellow","green","blue","indigo","violet"]},{id:"cats",colors:["#1f77b4","#ff7f0e","#2ca02c","#d62728","#9467bd","#8c564b","#e377c2","#7f7f7f","#bcbd22","#17becf","#ffd800","#DFA25A","#4B0082","#7BCCC4","#ADDD8E"]},{id:"nice",colors:["#1f77b4","#ff7f0e","#2ca02c","#d62728","#9467bd","#8c564b","#e377c2","#7f7f7f","#bcbd22","#17becf"]},{id:"nice2",colors:["#1f77b4","#ff7f0e"]},{id:"nice3",colors:["#1f77b4","#ff7f0e","#2ca02c"]},{id:"nice4",colors:["#1f77b4","#ff7f0e","#2ca02c","#d62728"]},{id:"nice5",colors:["#1f77b4","#ff7f0e","#2ca02c","#d62728","#9467bd"]},{id:"nice6",colors:["#1f77b4","#ff7f0e","#2ca02c","#d62728","#9467bd","#8c564b"]},{id:"nice7",colors:["#1f77b4","#ff7f0e","#2ca02c","#d62728","#9467bd","#8c564b","#e377c2"]},{id:"nice8",colors:["#1f77b4","#ff7f0e","#2ca02c","#d62728","#9467bd","#8c564b","#e377c2","#7f7f7f"]},{id:"nice9",colors:["#1f77b4","#ff7f0e","#2ca02c","#d62728","#9467bd","#8c564b","#e377c2","#7f7f7f","#1B1B1B"]},{id:"nice10",colors:["#1f77b4","#ff7f0e","#2ca02c","#d62728","#9467bd","#8c564b","#e377c2","#7f7f7f","#A0CBE8","#4B0082"]},{id:"schemecategory",colors:["rgb(31, 119, 180)","rgb(255, 127, 14)","rgb(44, 160, 44)","rgb(214, 39, 40)","rgb(148, 103, 189)","rgb(140, 86, 75)","rgb(227, 119, 194)","rgb(127, 127, 127)","rgb(188, 189, 34)"]},{id:"schemeaccent",colors:["rgb(127, 201, 127)","rgb(190, 174, 212)","rgb(253, 192, 134)","rgb(255, 255, 153)","rgb(56, 108, 176)","rgb(240, 2, 127)","rgb(191, 91, 23)","rgb(102, 102, 102)"]},{id:"schemedark",colors:["rgb(27, 158, 119)","rgb(217, 95, 2)","rgb(117, 112, 179)","rgb(231, 41, 138)","rgb(102, 166, 30)","rgb(230, 171, 2)","rgb(166, 118, 29)","rgb(102, 102, 102)"]},{id:"schemeset1",colors:["rgb(228, 26, 28)","rgb(55, 126, 184)","rgb(77, 175, 74)","rgb(152, 78, 163)","rgb(255, 127, 0)","rgb(166, 86, 40)","rgb(247, 129, 191)","rgb(153, 153, 153)"]},{id:"schemeset2",colors:["rgb(141, 211, 199)","rgb(255, 255, 179)","rgb(190, 186, 218)","rgb(251, 128, 114)","rgb(128, 177, 211)","rgb(253, 180, 98)","rgb(179, 222, 105)","rgb(252, 205, 229)","rgb(217, 217, 217)","rgb(188, 128, 189)","rgb(204, 235, 197)","rgb(255, 237, 111)"]},{id:"d3_schemeAccent",colors:["#7fc97f","#beaed4","#fdc086","#ffff99","#386cb0","#f0027f","#bf5b17","#666666"]},{id:"d3_schemeCategory10",colors:["#1f77b4","#ff7f0e","#2ca02c","#d62728","#9467bd","#8c564b","#e377c2","#7f7f7f","#bcbd22","#17becf"]},{id:"d3_schemePaired",colors:["#a6cee3","#1f78b4","#b2df8a","#33a02c","#fb9a99","#e31a1c","#fdbf6f","#ff7f00","#cab2d6","#6a3d9a","#ffff99","#b15928"]},{id:"d3_schemePastel1",colors:["#fbb4ae","#b3cde3","#ccebc5","#decbe4","#fed9a6","#ffffcc","#e5d8bd","#fddaec","#f2f2f2"]},{id:"d3_schemePastel2",colors:["#b3e2cd","#fdcdac","#cbd5e8","#f4cae4","#e6f5c9","#fff2ae","#f1e2cc","#cccccc"]},{id:"googlecharts",colors:["#3366CC","#DC3912","#FF9900","#109618","#990099","#3B3EAC","#0099C6","#DD4477","#66AA00","#B82E2E","#316395","#994499","#22AA99","#AAAA11","#6633CC","#E67300","#8B0707","#329262","#5574A6","#3B3EAC"]},{id:"d3_schemeDark2",colors:["#1b9e77","#d95f02","#7570b3","#e7298a","#66a61e","#e6ab02","#a6761d","#666666"]},{id:"d3_schemeTableau10",colors:["#4e79a7","#f28e2c","#e15759","#76b7b2","#59a14f","#edc949","#af7aa1","#ff9da7","#9c755f","#bab0ab"]},{id:"d3_schemeCategory20b",colors:["#393b79","#5254a3","#6b6ecf","#9c9ede","#637939","#8ca252","#b5cf6b","#cedb9c","#8c6d31","#bd9e39","#e7ba52","#e7cb94","#843c39","#ad494a","#d6616b","#e7969c","#7b4173","#a55194","#ce6dbd","#de9ed6"]},{id:"d3_schemeCategory20c",colors:["#3182bd","#6baed6","#9ecae1","#c6dbef","#e6550d","#fd8d3c","#fdae6b","#fdd0a2","#31a354","#74c476","#a1d99b","#c7e9c0","#756bb1","#9e9ac8","#bcbddc","#dadaeb","#636363","#969696","#bdbdbd","#d9d9d9"]},{id:"d3_schemeCategory20",colors:["#1f77b4","#aec7e8","#ff7f0e","#ffbb78","#2ca02c","#98df8a","#d62728","#ff9896","#9467bd","#c5b0d5","#8c564b","#c49c94","#e377c2","#f7b6d2","#7f7f7f","#c7c7c7","#bcbd22","#dbdb8d","#17becf","#9edae5"]},{category:"Mixed"},{id:"plotly_picnic",colors:["rgb(0,0,255)","rgb(5,15,255)","rgb(10,31,255)","rgb(15,46,255)","rgb(20,61,255)","rgb(26,77,255)","rgb(31,92,255)","rgb(36,107,255)","rgb(41,122,255)","rgb(46,138,255)","rgb(51,153,255)","rgb(56,158,255)","rgb(61,163,255)","rgb(66,168,255)","rgb(71,173,255)","rgb(77,179,255)","rgb(82,184,255)","rgb(87,189,255)","rgb(92,194,255)","rgb(97,199,255)","rgb(102,204,255)","rgb(107,204,255)","rgb(112,204,255)","rgb(117,204,255)","rgb(122,204,255)","rgb(128,204,255)","rgb(133,204,255)","rgb(138,204,255)","rgb(143,204,255)","rgb(148,204,255)","rgb(153,204,255)","rgb(158,204,255)","rgb(163,204,255)","rgb(168,204,255)","rgb(173,204,255)","rgb(179,204,255)","rgb(184,204,255)","rgb(189,204,255)","rgb(194,204,255)","rgb(199,204,255)","rgb(204,204,255)","rgb(209,209,255)","rgb(214,214,255)","rgb(219,219,255)","rgb(224,224,255)","rgb(230,230,255)","rgb(235,235,255)","rgb(240,240,255)","rgb(245,245,255)","rgb(250,250,255)","rgb(255,255,255)","rgb(255,250,255)","rgb(255,245,255)","rgb(255,240,255)","rgb(255,235,255)","rgb(255,229,255)","rgb(255,224,255)","rgb(255,219,255)","rgb(255,214,255)","rgb(255,209,255)","rgb(255,204,255)","rgb(255,199,255)","rgb(255,194,255)","rgb(255,189,255)","rgb(255,184,255)","rgb(255,178,255)","rgb(255,173,255)","rgb(255,168,255)","rgb(255,163,255)","rgb(255,158,255)","rgb(255,153,255)","rgb(255,148,250)","rgb(255,143,245)","rgb(255,138,240)","rgb(255,133,235)","rgb(255,127,229)","rgb(255,122,224)","rgb(255,117,219)","rgb(255,112,214)","rgb(255,107,209)","rgb(255,102,204)","rgb(255,102,194)","rgb(255,102,184)","rgb(255,102,173)","rgb(255,102,163)","rgb(255,102,153)","rgb(255,102,143)","rgb(255,102,133)","rgb(255,102,122)","rgb(255,102,112)","rgb(255,102,102)","rgb(255,92,92)","rgb(255,82,82)","rgb(255,71,71)","rgb(255,61,61)","rgb(255,51,51)","rgb(255,41,41)","rgb(255,31,31)","rgb(255,20,20)","rgb(255,10,10)"]},{id:"plotly_rainbow",colors:["rgb(150,0,90)","rgb(138,0,99)","rgb(126,0,108)","rgb(114,0,116)","rgb(102,0,125)","rgb(90,0,134)","rgb(78,0,143)","rgb(66,0,152)","rgb(54,0,160)","rgb(42,0,169)","rgb(30,0,178)","rgb(18,0,187)","rgb(6,0,196)","rgb(0,1,202)","rgb(0,3,207)","rgb(0,5,211)","rgb(0,7,215)","rgb(0,9,220)","rgb(0,11,224)","rgb(0,13,229)","rgb(0,15,233)","rgb(0,17,237)","rgb(0,19,242)","rgb(0,21,246)","rgb(0,23,251)","rgb(0,25,255)","rgb(0,35,255)","rgb(0,45,255)","rgb(0,55,255)","rgb(0,66,255)","rgb(0,76,255)","rgb(0,86,255)","rgb(0,96,255)","rgb(0,106,255)","rgb(0,116,255)","rgb(0,127,255)","rgb(0,137,255)","rgb(0,147,255)","rgb(2,156,251)","rgb(5,164,242)","rgb(9,173,234)","rgb(12,181,226)","rgb(16,189,217)","rgb(19,197,209)","rgb(23,206,200)","rgb(26,214,192)","rgb(30,222,184)","rgb(33,230,175)","rgb(37,239,167)","rgb(40,247,158)","rgb(44,255,150)","rgb(53,255,138)","rgb(61,255,126)","rgb(70,255,114)","rgb(78,255,102)","rgb(87,255,90)","rgb(95,255,78)","rgb(104,255,66)","rgb(112,255,54)","rgb(121,255,42)","rgb(130,255,30)","rgb(138,255,18)","rgb(147,255,6)","rgb(155,254,0)","rgb(163,252,0)","rgb(172,251,0)","rgb(180,249,0)","rgb(188,247,0)","rgb(197,246,0)","rgb(205,244,0)","rgb(213,242,0)","rgb(222,241,0)","rgb(230,239,0)","rgb(238,237,0)","rgb(247,236,0)","rgb(255,234,0)","rgb(255,224,0)","rgb(255,214,0)","rgb(255,204,0)","rgb(255,195,0)","rgb(255,185,0)","rgb(255,175,0)","rgb(255,165,0)","rgb(255,155,0)","rgb(255,145,0)","rgb(255,136,0)","rgb(255,126,0)","rgb(255,116,0)","rgb(255,107,0)","rgb(255,98,0)","rgb(255,89,0)","rgb(255,80,0)","rgb(255,71,0)","rgb(255,62,0)","rgb(255,53,0)","rgb(255,44,0)","rgb(255,36,0)","rgb(255,27,0)","rgb(255,18,0)","rgb(255,9,0)"]},{id:"plotly_portland",colors:["rgb(12,51,131)","rgb(12,54,133)","rgb(12,58,135)","rgb(12,61,138)","rgb(12,65,140)","rgb(12,68,142)","rgb(12,71,144)","rgb(11,75,146)","rgb(11,78,149)","rgb(11,82,151)","rgb(11,85,153)","rgb(11,88,155)","rgb(11,92,157)","rgb(11,95,160)","rgb(11,99,162)","rgb(11,102,164)","rgb(11,105,166)","rgb(11,109,168)","rgb(11,112,171)","rgb(10,116,173)","rgb(10,119,175)","rgb(10,122,177)","rgb(10,126,179)","rgb(10,129,182)","rgb(10,133,184)","rgb(10,136,186)","rgb(19,139,181)","rgb(29,142,176)","rgb(38,145,170)","rgb(47,148,165)","rgb(56,151,160)","rgb(66,154,155)","rgb(75,157,150)","rgb(84,160,144)","rgb(94,163,139)","rgb(103,166,134)","rgb(112,169,129)","rgb(121,172,124)","rgb(131,175,118)","rgb(140,178,113)","rgb(149,181,108)","rgb(158,184,103)","rgb(168,187,98)","rgb(177,190,92)","rgb(186,193,87)","rgb(196,196,82)","rgb(205,199,77)","rgb(214,202,72)","rgb(223,205,66)","rgb(233,208,61)","rgb(242,211,56)","rgb(242,208,56)","rgb(242,206,56)","rgb(242,203,56)","rgb(242,200,56)","rgb(242,197,56)","rgb(242,195,56)","rgb(242,192,56)","rgb(242,189,56)","rgb(242,187,56)","rgb(242,184,56)","rgb(242,181,56)","rgb(242,178,56)","rgb(242,176,56)","rgb(242,173,56)","rgb(242,170,56)","rgb(242,167,56)","rgb(242,165,56)","rgb(242,162,56)","rgb(242,159,56)","rgb(242,157,56)","rgb(242,154,56)","rgb(242,151,56)","rgb(242,148,56)","rgb(242,146,56)","rgb(242,143,56)","rgb(241,138,55)","rgb(240,134,54)","rgb(239,129,53)","rgb(238,125,52)","rgb(237,120,51)","rgb(236,116,50)","rgb(235,111,49)","rgb(234,107,48)","rgb(233,102,47)","rgb(232,98,46)","rgb(231,93,45)","rgb(230,89,44)","rgb(229,84,42)","rgb(228,80,41)","rgb(227,75,40)","rgb(226,71,39)","rgb(225,66,38)","rgb(224,62,37)","rgb(223,57,36)","rgb(222,53,35)","rgb(221,48,34)","rgb(220,44,33)","rgb(219,39,32)","rgb(218,35,31)"]},{id:"plotly_jet",colors:["rgb(0,0,131)","rgb(0,5,134)","rgb(0,10,137)","rgb(0,14,140)","rgb(0,19,143)","rgb(0,24,147)","rgb(0,29,150)","rgb(0,34,153)","rgb(0,38,156)","rgb(0,43,159)","rgb(0,48,162)","rgb(0,53,165)","rgb(0,58,168)","rgb(0,64,172)","rgb(0,72,175)","rgb(0,80,179)","rgb(1,87,182)","rgb(1,95,185)","rgb(1,103,189)","rgb(1,111,192)","rgb(2,119,196)","rgb(2,126,199)","rgb(2,134,202)","rgb(2,142,206)","rgb(2,150,209)","rgb(3,158,213)","rgb(3,165,216)","rgb(3,173,219)","rgb(3,181,223)","rgb(3,189,226)","rgb(4,197,230)","rgb(4,204,233)","rgb(4,212,236)","rgb(4,220,240)","rgb(4,228,243)","rgb(5,236,247)","rgb(5,243,250)","rgb(5,251,253)","rgb(10,255,250)","rgb(20,255,240)","rgb(30,255,229)","rgb(40,255,219)","rgb(50,255,209)","rgb(60,255,199)","rgb(70,255,189)","rgb(80,255,178)","rgb(90,255,168)","rgb(100,255,158)","rgb(110,255,148)","rgb(120,255,138)","rgb(130,255,127)","rgb(140,255,117)","rgb(150,255,107)","rgb(160,255,97)","rgb(170,255,87)","rgb(180,255,76)","rgb(190,255,66)","rgb(200,255,56)","rgb(210,255,46)","rgb(220,255,36)","rgb(230,255,25)","rgb(240,255,15)","rgb(250,255,5)","rgb(255,250,0)","rgb(255,240,0)","rgb(255,229,0)","rgb(254,219,0)","rgb(254,209,0)","rgb(254,199,0)","rgb(254,189,0)","rgb(254,178,0)","rgb(253,168,0)","rgb(253,158,0)","rgb(253,148,0)","rgb(253,138,0)","rgb(253,127,0)","rgb(252,117,0)","rgb(252,107,0)","rgb(252,97,0)","rgb(252,87,0)","rgb(252,76,0)","rgb(251,66,0)","rgb(251,56,0)","rgb(251,46,0)","rgb(251,36,0)","rgb(251,25,0)","rgb(250,15,0)","rgb(250,5,0)","rgb(245,0,0)","rgb(235,0,0)","rgb(226,0,0)","rgb(216,0,0)","rgb(206,0,0)","rgb(196,0,0)","rgb(187,0,0)","rgb(177,0,0)","rgb(167,0,0)","rgb(157,0,0)","rgb(148,0,0)","rgb(138,0,0)"]},{id:"plotly_hot",colors:["rgb(0,0,0)","rgb(8,0,0)","rgb(15,0,0)","rgb(23,0,0)","rgb(31,0,0)","rgb(38,0,0)","rgb(46,0,0)","rgb(54,0,0)","rgb(61,0,0)","rgb(69,0,0)","rgb(77,0,0)","rgb(84,0,0)","rgb(92,0,0)","rgb(100,0,0)","rgb(107,0,0)","rgb(115,0,0)","rgb(123,0,0)","rgb(130,0,0)","rgb(138,0,0)","rgb(146,0,0)","rgb(153,0,0)","rgb(161,0,0)","rgb(169,0,0)","rgb(176,0,0)","rgb(184,0,0)","rgb(192,0,0)","rgb(199,0,0)","rgb(207,0,0)","rgb(215,0,0)","rgb(222,0,0)","rgb(230,0,0)","rgb(231,7,0)","rgb(232,14,0)","rgb(233,21,0)","rgb(233,28,0)","rgb(234,35,0)","rgb(235,42,0)","rgb(236,49,0)","rgb(237,56,0)","rgb(238,63,0)","rgb(238,70,0)","rgb(239,77,0)","rgb(240,84,0)","rgb(241,91,0)","rgb(242,98,0)","rgb(243,105,0)","rgb(243,112,0)","rgb(244,119,0)","rgb(245,126,0)","rgb(246,133,0)","rgb(247,140,0)","rgb(248,147,0)","rgb(248,154,0)","rgb(249,161,0)","rgb(250,168,0)","rgb(251,175,0)","rgb(252,182,0)","rgb(253,189,0)","rgb(253,196,0)","rgb(254,203,0)","rgb(255,210,0)","rgb(255,211,6)","rgb(255,212,13)","rgb(255,213,19)","rgb(255,215,26)","rgb(255,216,32)","rgb(255,217,38)","rgb(255,218,45)","rgb(255,219,51)","rgb(255,220,57)","rgb(255,221,64)","rgb(255,222,70)","rgb(255,224,77)","rgb(255,225,83)","rgb(255,226,89)","rgb(255,227,96)","rgb(255,228,102)","rgb(255,229,108)","rgb(255,230,115)","rgb(255,231,121)","rgb(255,233,128)","rgb(255,234,134)","rgb(255,235,140)","rgb(255,236,147)","rgb(255,237,153)","rgb(255,238,159)","rgb(255,239,166)","rgb(255,240,172)","rgb(255,242,179)","rgb(255,243,185)","rgb(255,244,191)","rgb(255,245,198)","rgb(255,246,204)","rgb(255,247,210)","rgb(255,248,217)","rgb(255,249,223)","rgb(255,251,230)","rgb(255,252,236)","rgb(255,253,242)","rgb(255,254,249)"]},{id:"plotly_blackbody",colors:["rgb(0,0,0)","rgb(11,0,0)","rgb(23,0,0)","rgb(35,0,0)","rgb(46,0,0)","rgb(58,0,0)","rgb(69,0,0)","rgb(81,0,0)","rgb(92,0,0)","rgb(103,0,0)","rgb(115,0,0)","rgb(126,0,0)","rgb(138,0,0)","rgb(149,0,0)","rgb(161,0,0)","rgb(172,0,0)","rgb(184,0,0)","rgb(196,0,0)","rgb(207,0,0)","rgb(219,0,0)","rgb(230,0,0)","rgb(230,11,0)","rgb(230,21,0)","rgb(230,32,0)","rgb(230,42,0)","rgb(230,53,0)","rgb(230,63,0)","rgb(230,74,0)","rgb(230,84,0)","rgb(230,95,0)","rgb(230,105,0)","rgb(230,116,0)","rgb(230,126,0)","rgb(230,137,0)","rgb(230,147,0)","rgb(230,158,0)","rgb(230,168,0)","rgb(230,179,0)","rgb(230,189,0)","rgb(230,200,0)","rgb(230,210,0)","rgb(231,212,9)","rgb(232,213,17)","rgb(233,215,26)","rgb(233,216,34)","rgb(234,218,43)","rgb(235,219,51)","rgb(236,221,60)","rgb(237,222,68)","rgb(238,224,77)","rgb(238,225,85)","rgb(239,227,94)","rgb(240,228,102)","rgb(241,230,111)","rgb(242,231,119)","rgb(243,233,128)","rgb(243,234,136)","rgb(244,236,145)","rgb(245,237,153)","rgb(246,239,162)","rgb(247,240,170)","rgb(248,242,179)","rgb(248,243,187)","rgb(249,245,196)","rgb(250,246,204)","rgb(251,248,213)","rgb(252,249,221)","rgb(253,251,230)","rgb(253,252,238)","rgb(254,254,247)","rgb(255,255,255)","rgb(252,253,255)","rgb(249,251,255)","rgb(245,249,255)","rgb(242,248,255)","rgb(239,246,255)","rgb(236,244,255)","rgb(233,242,255)","rgb(230,240,255)","rgb(226,238,255)","rgb(223,237,255)","rgb(220,235,255)","rgb(217,233,255)","rgb(214,231,255)","rgb(211,229,255)","rgb(207,227,255)","rgb(204,226,255)","rgb(201,224,255)","rgb(198,222,255)","rgb(195,220,255)","rgb(192,218,255)","rgb(188,216,255)","rgb(185,215,255)","rgb(182,213,255)","rgb(179,211,255)","rgb(176,209,255)","rgb(173,207,255)","rgb(169,205,255)","rgb(166,204,255)","rgb(163,202,255)"]},{id:"bright38",colors:["rgb(254,0,225)","rgb(188,0,254)","rgb(165,0,254)","rgb(134,0,254)","rgb(111,0,254)","rgb(81,0,254)","rgb(58,0,254)","rgb(28,0,254)","rgb(0,2,254)","rgb(0,33,254)","rgb(0,56,254)","rgb(0,78,254)","rgb(0,139,254)","rgb(0,169,254)","rgb(0,208,254)","rgb(0,231,254)","rgb(0,254,231)","rgb(0,254,200)","rgb(0,254,169)","rgb(0,254,139)","rgb(0,254,109)","rgb(0,254,79)","rgb(0,254,39)","rgb(0,254,0)","rgb(42,254,0)","rgb(88,254,0)","rgb(126,254,0)","rgb(164,254,0)","rgb(195,254,0)","rgb(226,254,0)","rgb(254,243,0)","rgb(254,199,0)","rgb(254,167,0)","rgb(254,137,0)","rgb(254,106,0)","rgb(254,68,0)","rgb(254,30,0)","rgb(254,0,0)"]},{category:"Earth"},{id:"plotly_earth",colors:["rgb(0,0,130)","rgb(0,18,135)","rgb(0,36,140)","rgb(0,54,145)","rgb(0,72,150)","rgb(0,90,155)","rgb(0,108,160)","rgb(0,126,165)","rgb(0,144,170)","rgb(0,162,175)","rgb(0,180,180)","rgb(4,183,166)","rgb(8,186,152)","rgb(12,189,138)","rgb(16,192,124)","rgb(20,195,110)","rgb(24,198,96)","rgb(28,201,82)","rgb(32,204,68)","rgb(36,207,54)","rgb(40,210,40)","rgb(50,211,41)","rgb(59,212,41)","rgb(69,213,42)","rgb(78,214,42)","rgb(88,215,43)","rgb(97,216,43)","rgb(107,217,44)","rgb(116,218,44)","rgb(126,219,45)","rgb(135,220,45)","rgb(145,221,46)","rgb(154,222,46)","rgb(164,223,47)","rgb(173,224,47)","rgb(183,225,48)","rgb(192,226,48)","rgb(202,227,49)","rgb(211,228,49)","rgb(221,229,50)","rgb(230,230,50)","rgb(224,222,48)","rgb(219,214,47)","rgb(213,206,45)","rgb(208,198,44)","rgb(202,190,42)","rgb(197,182,41)","rgb(191,174,39)","rgb(186,166,38)","rgb(180,158,36)","rgb(175,150,35)","rgb(169,142,33)","rgb(164,134,32)","rgb(158,126,30)","rgb(153,118,29)","rgb(147,110,27)","rgb(142,102,26)","rgb(136,94,24)","rgb(131,86,23)","rgb(125,78,21)","rgb(120,70,20)","rgb(123,75,26)","rgb(127,79,32)","rgb(130,84,38)","rgb(134,89,44)","rgb(137,93,49)","rgb(140,98,55)","rgb(144,102,61)","rgb(147,107,67)","rgb(150,112,73)","rgb(154,116,79)","rgb(157,121,85)","rgb(161,126,91)","rgb(164,130,96)","rgb(167,135,102)","rgb(171,139,108)","rgb(174,144,114)","rgb(177,149,120)","rgb(181,153,126)","rgb(184,158,132)","rgb(188,163,138)","rgb(191,167,143)","rgb(194,172,149)","rgb(198,176,155)","rgb(201,181,161)","rgb(204,186,167)","rgb(208,190,173)","rgb(211,195,179)","rgb(215,200,185)","rgb(218,204,190)","rgb(221,209,196)","rgb(225,213,202)","rgb(228,218,208)","rgb(231,223,214)","rgb(235,227,220)","rgb(238,232,226)","rgb(242,237,232)","rgb(245,241,237)","rgb(248,246,243)","rgb(252,250,249)"]},{id:"topographic",colors:["rgb(20,170,42)","rgb(20,170,42)","rgb(27,174,35)","rgb(35,179,28)","rgb(43,184,22)","rgb(51,188,15)","rgb(59,193,9)","rgb(67,198,2)","rgb(70,200,0)","rgb(71,199,0)","rgb(72,199,1)","rgb(73,198,1)","rgb(74,198,2)","rgb(75,197,2)","rgb(76,197,3)","rgb(78,197,3)","rgb(79,196,4)","rgb(80,196,4)","rgb(81,195,5)","rgb(82,195,5)","rgb(83,194,6)","rgb(85,194,6)","rgb(86,194,7)","rgb(87,193,7)","rgb(88,193,8)","rgb(89,192,8)","rgb(90,192,9)","rgb(92,191,9)","rgb(93,191,10)","rgb(94,191,10)","rgb(95,190,11)","rgb(96,190,11)","rgb(97,189,12)","rgb(98,189,12)","rgb(100,188,13)","rgb(101,188,13)","rgb(102,188,14)","rgb(103,187,14)","rgb(104,187,15)","rgb(105,186,15)","rgb(107,186,16)","rgb(108,185,16)","rgb(109,185,17)","rgb(110,185,17)","rgb(111,184,18)","rgb(112,184,18)","rgb(114,183,19)","rgb(115,183,19)","rgb(116,182,20)","rgb(117,182,21)","rgb(118,182,21)","rgb(119,181,22)","rgb(120,181,22)","rgb(122,180,23)","rgb(123,180,23)","rgb(124,179,24)","rgb(125,179,24)","rgb(126,179,25)","rgb(127,178,25)","rgb(129,178,26)","rgb(130,177,26)","rgb(131,177,27)","rgb(132,176,27)","rgb(133,176,28)","rgb(134,176,28)","rgb(136,175,29)","rgb(137,175,29)","rgb(138,174,30)","rgb(139,174,30)","rgb(140,173,31)","rgb(141,173,31)","rgb(143,173,32)","rgb(144,172,32)","rgb(145,172,33)","rgb(146,171,33)","rgb(147,171,34)","rgb(148,170,34)","rgb(149,170,35)","rgb(151,170,35)","rgb(152,169,36)","rgb(153,169,36)","rgb(154,168,37)","rgb(155,168,37)","rgb(156,167,38)","rgb(158,167,38)","rgb(159,167,39)","rgb(160,166,39)","rgb(161,166,40)","rgb(162,165,40)","rgb(163,165,41)","rgb(165,165,42)","rgb(165,165,42)","rgb(165,165,43)","rgb(165,165,44)","rgb(165,165,45)","rgb(166,166,46)","rgb(166,166,47)","rgb(166,166,48)","rgb(166,166,49)","rgb(166,166,50)","rgb(167,167,51)","rgb(167,167,52)","rgb(167,167,53)","rgb(167,167,54)","rgb(167,167,55)","rgb(168,168,56)","rgb(168,168,57)","rgb(168,168,58)","rgb(168,168,59)","rgb(169,169,60)","rgb(169,169,61)","rgb(169,169,62)","rgb(169,169,63)","rgb(169,169,64)","rgb(170,170,65)","rgb(170,170,66)","rgb(170,170,67)","rgb(170,170,68)","rgb(170,170,68)","rgb(171,171,69)","rgb(171,171,70)","rgb(171,171,71)","rgb(171,171,72)","rgb(172,172,73)","rgb(172,172,74)","rgb(172,172,75)","rgb(172,172,76)","rgb(172,172,77)","rgb(173,173,78)","rgb(173,173,79)","rgb(173,173,80)","rgb(173,173,81)","rgb(173,173,82)","rgb(174,174,83)","rgb(174,174,84)","rgb(174,174,85)","rgb(174,174,86)","rgb(175,175,87)","rgb(175,175,88)","rgb(175,175,89)","rgb(175,175,90)","rgb(175,175,91)","rgb(176,176,92)","rgb(176,176,93)","rgb(176,176,94)","rgb(176,176,95)","rgb(176,176,95)","rgb(177,177,96)","rgb(177,177,97)","rgb(177,177,98)","rgb(177,177,99)","rgb(178,178,100)","rgb(178,178,101)","rgb(178,178,102)","rgb(178,178,103)","rgb(178,178,104)","rgb(179,179,105)","rgb(179,179,106)","rgb(179,179,107)","rgb(179,179,108)","rgb(179,179,109)","rgb(180,180,110)","rgb(180,180,111)","rgb(180,180,112)","rgb(180,180,113)","rgb(181,181,114)","rgb(181,181,115)","rgb(181,181,116)","rgb(181,181,117)","rgb(181,181,118)","rgb(182,182,119)","rgb(182,182,120)","rgb(182,182,121)","rgb(182,182,121)","rgb(182,182,122)","rgb(183,183,123)","rgb(183,183,124)","rgb(183,183,125)","rgb(183,183,126)","rgb(184,184,127)","rgb(184,184,128)","rgb(184,184,129)","rgb(184,184,130)","rgb(184,184,131)","rgb(185,185,132)","rgb(185,185,133)","rgb(185,185,134)","rgb(185,185,135)","rgb(185,185,136)","rgb(186,186,137)","rgb(186,186,138)","rgb(186,186,139)","rgb(186,186,140)","rgb(186,186,141)","rgb(187,187,142)","rgb(187,187,143)","rgb(187,187,144)","rgb(187,187,145)","rgb(188,188,146)","rgb(188,188,147)","rgb(188,188,148)","rgb(188,188,148)","rgb(188,188,149)","rgb(189,189,150)","rgb(189,189,151)","rgb(189,189,152)","rgb(189,189,153)","rgb(189,189,154)","rgb(190,190,155)","rgb(190,190,156)","rgb(190,190,157)","rgb(190,190,158)","rgb(191,191,159)","rgb(191,191,160)","rgb(191,191,161)","rgb(191,191,162)","rgb(191,191,163)","rgb(192,192,164)","rgb(192,192,165)","rgb(192,192,166)","rgb(192,192,167)","rgb(192,192,168)","rgb(193,193,169)","rgb(193,193,170)","rgb(193,193,171)","rgb(193,193,172)","rgb(194,194,173)","rgb(194,194,174)","rgb(194,194,175)","rgb(194,194,175)","rgb(194,194,176)","rgb(195,195,177)","rgb(195,195,178)","rgb(195,195,179)","rgb(195,195,180)","rgb(195,195,181)","rgb(196,196,182)","rgb(196,196,183)","rgb(196,196,184)","rgb(196,196,185)","rgb(197,197,186)","rgb(197,197,187)","rgb(197,197,188)","rgb(197,197,189)","rgb(197,197,190)","rgb(198,198,191)","rgb(198,198,192)","rgb(198,198,193)","rgb(198,198,194)","rgb(198,198,195)","rgb(199,199,196)","rgb(199,199,197)","rgb(199,199,198)","rgb(199,199,199)","rgb(255,255,255)"]},{id:"precipitation",colors:["rgba(255,255,255,0)","rgb(6,13,255)","rgb(13,26,255)","rgb(20,40,255)","rgb(26,53,255)","rgb(33,67,255)","rgb(40,80,255)","rgb(46,93,255)","rgb(53,107,255)","rgb(60,120,255)","rgb(67,134,255)","rgb(73,147,255)","rgb(80,161,255)","rgb(87,174,255)","rgb(93,187,255)","rgb(100,201,255)","rgb(107,214,255)","rgb(114,228,255)","rgb(120,241,255)","rgb(127,255,255)","rgb(127,255,229)","rgb(129,253,223)","rgb(130,251,216)","rgb(132,249,210)","rgb(133,247,203)","rgb(135,245,197)","rgb(137,243,190)","rgb(138,241,184)","rgb(140,239,177)","rgb(142,237,171)","rgb(143,235,164)","rgb(145,233,158)","rgb(146,231,152)","rgb(148,229,145)","rgb(150,227,139)","rgb(151,225,132)","rgb(153,224,126)","rgb(154,222,119)","rgb(156,220,113)","rgb(158,218,106)","rgb(159,216,100)","rgb(161,214,93)","rgb(163,212,87)","rgb(164,210,81)","rgb(166,208,74)","rgb(167,206,68)","rgb(169,204,61)","rgb(171,202,55)","rgb(172,200,48)","rgb(174,198,42)","rgb(175,196,35)","rgb(177,194,29)","rgb(179,193,22)","rgb(180,191,16)","rgb(182,189,10)","rgb(183,187,3)","rgb(185,185,0)","rgb(187,183,0)","rgb(188,181,0)","rgb(190,179,0)","rgb(192,177,0)","rgb(193,175,0)","rgb(195,173,0)","rgb(196,171,0)","rgb(198,169,0)","rgb(200,167,0)","rgb(201,165,0)","rgb(203,163,0)","rgb(204,162,0)","rgb(206,160,0)","rgb(208,158,0)","rgb(209,156,0)","rgb(211,154,0)","rgb(213,152,0)","rgb(214,150,0)","rgb(216,148,0)","rgb(217,146,0)","rgb(219,144,0)","rgb(221,142,0)","rgb(222,140,0)","rgb(224,138,0)","rgb(225,136,0)","rgb(227,134,0)","rgb(229,132,0)","rgb(230,131,0)","rgb(232,129,0)","rgb(234,127,0)","rgb(235,125,0)","rgb(237,123,0)","rgb(238,121,0)","rgb(240,119,0)","rgb(242,117,0)","rgb(243,115,0)","rgb(245,113,0)","rgb(246,111,0)","rgb(248,109,0)","rgb(250,107,0)","rgb(251,105,0)","rgb(253,103,0)","rgb(255,101,0)"]},{id:"humidity",colors:["rgb(255,255,0)","rgb(228,255,0)","rgb(201,255,0)","rgb(174,255,0)","rgb(147,255,0)","rgb(120,255,0)","rgb(93,255,0)","rgb(67,255,0)","rgb(40,255,0)","rgb(13,255,0)","rgb(0,248,13)","rgb(0,234,40)","rgb(0,221,67)","rgb(0,208,93)","rgb(0,194,120)","rgb(0,181,147)","rgb(0,167,174)","rgb(0,154,201)","rgb(0,140,228)","rgb(0,127,255)"]},{id:"airquality",min:0,max:300,colors:["rgb(140,223,91)","rgb(139,224,92)","rgb(141,225,90)","rgb(144,224,90)","rgb(145,226,90)","rgb(146,226,89)","rgb(149,227,90)","rgb(151,226,88)","rgb(153,227,88)","rgb(153,228,88)","rgb(156,228,88)","rgb(157,228,86)","rgb(158,229,87)","rgb(161,230,86)","rgb(162,229,86)","rgb(164,230,85)","rgb(165,231,85)","rgb(167,231,85)","rgb(168,232,85)","rgb(172,233,84)","rgb(173,233,84)","rgb(175,234,83)","rgb(176,234,84)","rgb(179,235,83)","rgb(179,235,83)","rgb(182,235,83)","rgb(183,236,83)","rgb(186,236,83)","rgb(187,237,83)","rgb(189,238,82)","rgb(191,238,83)","rgb(193,238,82)","rgb(196,240,81)","rgb(197,240,82)","rgb(198,241,82)","rgb(202,240,82)","rgb(203,242,82)","rgb(204,242,82)","rgb(208,243,83)","rgb(209,242,81)","rgb(211,244,82)","rgb(213,245,82)","rgb(215,244,82)","rgb(217,245,81)","rgb(218,246,82)","rgb(221,247,82)","rgb(223,245,82)","rgb(224,247,81)","rgb(226,247,82)","rgb(228,248,82)","rgb(230,249,82)","rgb(232,250,82)","rgb(234,250,83)","rgb(237,251,82)","rgb(238,251,83)","rgb(241,252,83)","rgb(241,252,83)","rgb(245,253,84)","rgb(246,253,84)","rgb(249,254,84)","rgb(251,254,85)","rgb(252,255,84)","rgb(255,254,85)","rgb(255,252,83)","rgb(255,250,82)","rgb(254,249,83)","rgb(253,247,81)","rgb(254,244,81)","rgb(253,243,80)","rgb(252,241,80)","rgb(253,239,80)","rgb(253,236,78)","rgb(252,235,78)","rgb(251,234,78)","rgb(252,231,77)","rgb(251,228,76)","rgb(250,227,76)","rgb(251,225,76)","rgb(249,222,75)","rgb(249,221,73)","rgb(250,220,73)","rgb(248,217,73)","rgb(248,216,73)","rgb(248,213,71)","rgb(247,212,71)","rgb(248,209,70)","rgb(247,207,70)","rgb(248,205,69)","rgb(246,203,69)","rgb(247,201,69)","rgb(245,199,68)","rgb(246,197,67)","rgb(245,195,67)","rgb(245,194,66)","rgb(245,191,66)","rgb(245,190,65)","rgb(245,188,64)","rgb(244,187,64)","rgb(243,184,63)","rgb(245,182,63)","rgb(243,181,62)","rgb(243,179,62)","rgb(244,177,62)","rgb(244,174,60)","rgb(243,173,61)","rgb(242,172,60)","rgb(243,169,60)","rgb(242,166,58)","rgb(241,166,59)","rgb(242,164,58)","rgb(241,161,58)","rgb(241,159,56)","rgb(242,158,56)","rgb(240,156,56)","rgb(240,154,56)","rgb(241,153,55)","rgb(240,151,55)","rgb(241,149,53)","rgb(240,147,54)","rgb(240,146,53)","rgb(239,143,52)","rgb(240,141,52)","rgb(238,138,52)","rgb(239,136,51)","rgb(238,135,51)","rgb(238,133,50)","rgb(238,130,50)","rgb(238,128,49)","rgb(239,127,48)","rgb(237,126,49)","rgb(237,124,48)","rgb(238,121,47)","rgb(237,120,47)","rgb(237,119,47)","rgb(238,116,47)","rgb(237,114,45)","rgb(237,113,46)","rgb(236,112,45)","rgb(237,110,45)","rgb(237,107,44)","rgb(236,107,44)","rgb(237,104,44)","rgb(236,102,44)","rgb(236,101,42)","rgb(236,99,43)","rgb(235,97,42)","rgb(235,96,42)","rgb(236,95,42)","rgb(235,94,42)","rgb(236,92,41)","rgb(235,91,41)","rgb(236,89,41)","rgb(235,88,40)","rgb(235,85,41)","rgb(234,84,40)","rgb(235,83,40)","rgb(235,81,40)","rgb(235,81,39)","rgb(235,78,40)","rgb(235,77,39)","rgb(236,76,38)","rgb(234,75,39)","rgb(234,73,38)","rgb(235,71,38)","rgb(234,71,38)","rgb(234,70,38)","rgb(235,68,38)","rgb(235,66,37)","rgb(235,66,37)","rgb(234,65,37)","rgb(235,64,37)","rgb(235,62,36)","rgb(234,62,37)","rgb(235,61,36)","rgb(234,59,37)","rgb(234,58,35)","rgb(234,58,36)","rgb(233,57,36)","rgb(233,57,36)","rgb(234,56,36)","rgb(234,55,36)","rgb(235,55,35)","rgb(233,54,36)","rgb(235,54,35)","rgb(233,54,35)","rgb(234,53,36)","rgb(233,52,36)","rgb(233,51,36)","rgb(231,50,37)","rgb(230,51,36)","rgb(228,50,38)","rgb(227,50,37)","rgb(226,50,37)","rgb(223,51,39)","rgb(221,50,39)","rgb(221,49,40)","rgb(218,50,41)","rgb(217,50,43)","rgb(216,49,44)","rgb(215,48,44)","rgb(213,49,46)","rgb(211,50,47)","rgb(210,49,49)","rgb(208,48,49)","rgb(205,49,51)","rgb(204,49,53)","rgb(203,48,55)","rgb(201,48,56)","rgb(199,49,58)","rgb(197,48,59)","rgb(196,49,62)","rgb(195,49,63)","rgb(192,49,65)","rgb(192,49,67)","rgb(190,50,69)","rgb(189,50,71)","rgb(186,50,73)","rgb(185,50,75)","rgb(183,50,78)","rgb(182,51,79)","rgb(180,51,81)","rgb(178,52,83)","rgb(178,51,86)","rgb(176,52,87)","rgb(174,52,89)","rgb(171,53,92)","rgb(170,54,94)","rgb(170,53,95)","rgb(167,55,97)","rgb(165,55,100)","rgb(166,55,103)","rgb(163,55,104)","rgb(161,56,107)","rgb(159,57,109)","rgb(159,57,111)","rgb(157,57,112)","rgb(155,59,115)","rgb(154,59,117)","rgb(151,59,120)","rgb(150,60,121)","rgb(150,61,124)","rgb(146,61,126)","rgb(144,62,128)","rgb(145,63,130)","rgb(142,64,133)","rgb(142,64,134)","rgb(138,65,137)","rgb(139,66,138)","rgb(136,66,142)","rgb(135,67,144)","rgb(132,67,146)","rgb(133,67,144)","rgb(132,65,143)","rgb(132,66,141)","rgb(132,64,140)","rgb(132,63,137)","rgb(131,62,134)","rgb(130,62,133)","rgb(130,61,132)","rgb(130,59,130)","rgb(129,59,128)","rgb(129,58,127)","rgb(130,57,125)","rgb(129,55,122)","rgb(129,55,122)","rgb(128,55,120)","rgb(129,54,118)","rgb(128,52,115)","rgb(127,52,114)","rgb(128,51,113)","rgb(127,49,111)","rgb(126,49,108)","rgb(127,48,107)","rgb(125,47,106)","rgb(125,47,103)","rgb(125,46,102)","rgb(125,45,101)","rgb(126,44,98)","rgb(124,43,97)","rgb(125,43,95)","rgb(123,42,93)","rgb(124,41,92)","rgb(122,40,90)","rgb(123,39,88)","rgb(123,38,87)","rgb(123,38,84)","rgb(122,37,84)","rgb(122,36,81)","rgb(123,35,79)","rgb(121,36,79)","rgb(120,34,76)","rgb(122,33,74)","rgb(121,33,73)","rgb(119,33,71)","rgb(121,31,70)","rgb(120,30,67)","rgb(120,30,66)","rgb(119,30,65)","rgb(120,29,63)","rgb(119,28,60)","rgb(119,28,59)","rgb(119,27,57)","rgb(118,26,56)","rgb(118,26,54)","rgb(119,26,52)","rgb(116,24,51)","rgb(116,24,49)","rgb(117,24,47)","rgb(116,23,47)","rgb(117,23,44)","rgb(116,22,43)","rgb(117,22,41)","rgb(114,21,39)","rgb(115,20,38)","rgb(114,20,38)","rgb(115,20,38)","rgb(115,20,38)","rgb(115,21,37)","rgb(115,20,38)","rgb(115,20,37)","rgb(116,20,37)","rgb(114,21,38)","rgb(114,20,37)","rgb(116,20,37)","rgb(115,21,37)","rgb(114,21,38)","rgb(116,20,38)","rgb(115,19,37)","rgb(115,20,38)","rgb(115,21,38)","rgb(116,20,38)","rgb(115,20,37)","rgb(115,20,38)","rgb(116,20,37)","rgb(115,19,38)","rgb(115,20,37)","rgb(116,20,37)","rgb(114,20,37)","rgb(114,20,38)","rgb(115,20,37)","rgb(115,20,38)","rgb(116,20,37)","rgb(115,20,38)","rgb(116,20,37)","rgb(114,20,37)","rgb(115,20,38)","rgb(114,20,38)","rgb(115,20,38)","rgb(115,20,38)","rgb(115,21,37)","rgb(115,20,38)","rgb(115,20,37)","rgb(116,20,37)","rgb(114,21,38)","rgb(114,20,37)","rgb(116,20,37)","rgb(115,21,37)","rgb(114,21,38)","rgb(116,20,38)","rgb(115,19,37)","rgb(115,20,38)","rgb(115,21,38)","rgb(116,20,38)","rgb(115,20,37)","rgb(115,20,38)","rgb(116,20,37)","rgb(115,19,38)","rgb(115,20,37)","rgb(116,20,37)","rgb(114,20,37)","rgb(114,20,38)","rgb(115,20,37)","rgb(115,20,38)"]},{id:"airquality_stepped",steps:[{label:"Good",min:0,max:12,color:"rgb(0, 228, 0)"},{label:"Moderate",min:12.1,max:35.4,color:"rgb(255, 255, 0)"},{label:"Unhealthy for sensitive groups",min:35.5,max:55.4,color:"rgb(255, 126, 0)"},{label:"Unhealthy",min:55.5,max:150.4,color:"rgb(255, 0, 0)"},{label:"Very Unhealthy",min:150.5,max:250.4,color:"rgb(143, 63, 151)"},{label:"Hazardous",min:250.5,max:500.4,color:"rgb(126, 0, 35)"}]},{id:"temperature",min:-90,max:45,colors:["rgb(0,0,250)","rgb(0,2,250)","rgb(0,5,250)","rgb(0,8,250)","rgb(0,11,250)","rgb(0,14,250)","rgb(0,16,250)","rgb(0,19,250)","rgb(0,22,250)","rgb(0,25,250)","rgb(0,28,250)","rgb(0,30,250)","rgb(0,33,250)","rgb(0,36,250)","rgb(0,39,250)","rgb(0,42,250)","rgb(0,44,250)","rgb(0,47,250)","rgb(0,50,250)","rgb(0,53,250)","rgb(0,56,250)","rgb(0,58,250)","rgb(0,61,250)","rgb(0,64,250)","rgb(0,67,250)","rgb(0,70,250)","rgb(0,73,250)","rgb(0,75,250)","rgb(0,78,250)","rgb(0,81,250)","rgb(0,84,250)","rgb(0,87,250)","rgb(0,89,250)","rgb(0,92,250)","rgb(0,95,250)","rgb(0,98,250)","rgb(0,101,250)","rgb(0,103,250)","rgb(0,106,250)","rgb(0,109,250)","rgb(0,112,250)","rgb(0,115,250)","rgb(0,117,250)","rgb(0,120,250)","rgb(0,123,250)","rgb(0,126,250)","rgb(0,129,250)","rgb(0,132,250)","rgb(0,134,250)","rgb(0,137,250)","rgb(0,140,250)","rgb(0,143,250)","rgb(0,146,250)","rgb(0,148,250)","rgb(0,151,250)","rgb(0,154,250)","rgb(0,157,250)","rgb(0,160,250)","rgb(0,162,250)","rgb(0,165,250)","rgb(0,168,250)","rgb(0,171,250)","rgb(0,174,250)","rgb(0,176,250)","rgb(0,179,250)","rgb(0,182,250)","rgb(0,185,250)","rgb(0,188,250)","rgb(0,191,250)","rgb(0,193,250)","rgb(0,196,250)","rgb(0,199,250)","rgb(0,202,250)","rgb(0,205,250)","rgb(0,207,250)","rgb(0,210,250)","rgb(0,213,250)","rgb(0,216,250)","rgb(0,219,250)","rgb(0,221,250)","rgb(0,224,250)","rgb(0,227,250)","rgb(0,230,250)","rgb(0,233,250)","rgb(0,235,250)","rgb(0,238,250)","rgb(0,241,250)","rgb(0,244,250)","rgb(0,247,250)","rgb(0,255,255)","rgb(0,255,203)","rgb(0,255,152)","rgb(0,255,101)","rgb(0,255,50)","rgb(0,255,0)","rgb(22,255,0)","rgb(45,255,0)","rgb(68,255,0)","rgb(91,255,0)","rgb(113,255,0)","rgb(136,255,0)","rgb(159,255,0)","rgb(182,255,0)","rgb(205,255,0)","rgb(255,255,0)","rgb(255,247,0)","rgb(255,240,0)","rgb(255,232,0)","rgb(255,225,0)","rgb(255,217,0)","rgb(255,210,0)","rgb(255,202,0)","rgb(255,195,0)","rgb(255,187,0)","rgb(255,180,0)","rgb(255,172,0)","rgb(255,165,0)","rgb(255,157,0)","rgb(255,150,0)","rgb(255,142,0)","rgb(255,135,0)","rgb(255,127,0)","rgb(255,120,0)","rgb(255,112,0)","rgb(255,105,0)","rgb(255,97,0)","rgb(255,90,0)","rgb(255,82,0)","rgb(255,75,0)","rgb(255,67,0)","rgb(255,60,0)","rgb(255,52,0)","rgb(255,45,0)","rgb(255,37,0)","rgb(255,30,0)"]},{id:"wind_comps",colors:["rgb(0,0,179)","rgb(10,24,187)","rgb(20,48,194)","rgb(31,73,202)","rgb(41,97,210)","rgb(52,122,218)","rgb(62,146,226)","rgb(73,170,234)","rgb(83,195,242)","rgb(94,219,249)","rgb(64,207,243)","rgb(64,212,222)","rgb(64,218,201)","rgb(64,223,180)","rgb(64,228,159)","rgb(64,233,138)","rgb(64,238,117)","rgb(64,243,96)","rgb(64,248,75)","rgb(64,254,54)"]},{id:"windspeed",colors:["rgb(0,0,250)","rgb(0,12,250)","rgb(0,25,250)","rgb(0,37,250)","rgb(0,50,250)","rgb(0,62,250)","rgb(0,75,250)","rgb(0,87,250)","rgb(0,100,250)","rgb(0,112,250)","rgb(0,125,250)","rgb(0,137,250)","rgb(0,150,250)","rgb(0,162,250)","rgb(0,175,250)","rgb(0,187,250)","rgb(0,200,250)","rgb(0,212,250)","rgb(0,225,250)","rgb(0,237,250)","rgb(0,255,255)","rgb(0,255,234)","rgb(0,255,214)","rgb(0,255,193)","rgb(0,255,173)","rgb(0,255,152)","rgb(0,255,132)","rgb(0,255,111)","rgb(0,255,91)","rgb(0,255,70)","rgb(0,255,0)","rgb(20,255,0)","rgb(41,255,0)","rgb(61,255,0)","rgb(82,255,0)","rgb(102,255,0)","rgb(123,255,0)","rgb(143,255,0)","rgb(164,255,0)","rgb(184,255,0)","rgb(255,255,0)","rgb(255,247,0)","rgb(255,240,0)","rgb(255,232,0)","rgb(255,225,0)","rgb(255,217,0)","rgb(255,210,0)","rgb(255,202,0)","rgb(255,195,0)","rgb(255,187,0)","rgb(255,180,0)","rgb(255,172,0)","rgb(255,165,0)","rgb(255,157,0)","rgb(255,150,0)","rgb(255,142,0)","rgb(255,135,0)","rgb(255,127,0)","rgb(255,120,0)","rgb(255,112,0)","rgb(255,105,0)","rgb(255,97,0)","rgb(255,90,0)","rgb(255,82,0)","rgb(255,75,0)","rgb(255,67,0)","rgb(255,60,0)","rgb(255,52,0)","rgb(255,45,0)","rgb(255,37,0)"]},{id:"dbz",colors:["rgb(1,57,255)","rgb(0,140,255)","rgb(1,209,255)","rgb(1,255,232)","rgb(1,255,171)","rgb(1,255,79)","rgb(43,255,0)","rgb(166,255,2)","rgb(227,255,1)","rgb(255,198,0)","rgb(255,168,1)","rgb(255,145,1)","rgb(255,130,1)","rgb(255,107,0)","rgb(255,84,0)","rgb(255,7,0)"]},{id:"dbz_nws",colors:["rgb(0,0,0)","rgb(0,255,255)","rgb(135,206,235)","rgb(0,0,255)","rgb(0,255,0)","rgb(50,205,50)","rgb(34,139,34)","rgb(238,238,0)","rgb(238,220,130)","rgb(238,118,33)","rgb(255,48,48)","rgb(176,48,96)","rgb(176,48,96)","rgb(186,85,211)","rgb(255,0,255)","rgb(255,255,255)"]},{category:"Fixed"},{id:"black",colors:["#000"]},{id:"white",colors:["#fff"]},{id:"red",colors:["red"]},{id:"green",colors:["green"]},{id:"blue",colors:["blue"]}];function AreaWidget(e,t){this.arg=t,this.createTime=new Date;const i="mapcontains",s="north",l="south",a="east",r="west",o="mapsettings",n="showmap",h="mappopupwrapper",d="mappopup",g="mapclear",p="mapsetlocation",c="map_contains";let u=this.arg?null:!Utils.stringDefined(HU.getUrlArgument(c))||"true"==HU.getUrlArgument(c);$.extend(this,{areaContains:u,display:e,domId:function(e){return null!=this.arg&&(e=this.arg+"_"+e),this.display.domId(e)},jq:function(e){return jqid(this.domId(e))},initHtml:function(){this.jq(o).click((()=>{this.showSettings()})),this.jq(n).click((()=>{this.showMap()}));this.map=new RepositoryMap(this.domId(d),{}),this.map.setSelection(this.arg?this.domId(""):this.display.getId(),!0,1)},showSettings:function(){let e=this,t="";t+=HU.div([ATTR_CLASS,CLASS_CLICKABLE,ATTR_TITLE,"Use my location",ATTR_ID,this.domId(p)],HU.getIconImage("fas fa-compass")+SPACE+"Use my location"),t+=HU.div([ATTR_CLASS,CLASS_CLICKABLE,ATTR_TITLE,"Clear form",ATTR_ID,this.domId(g)],HU.getIconImage(ICON_ERASER)+SPACE+"Clear form"),t+=HU.div([ATTR_TITLE,"Search mode: checked - contains, unchecked - overlaps"],HU.checkbox("",[ATTR_ID,this.domId(i)],this.areaContains)+HU.tag(TAG_LABEL,[ATTR_CLASS,CLASS_CLICKABLE,ATTR_FOR,this.domId(i)],SPACE+"Contains")),t=HU.div([ATTR_STYLE,HU.css(CSS_MARGIN,HU.px(5))],t),this.settingsDialog=HU.makeDialog({content:t,anchor:this.jq(o),draggable:!1,header:!0}),this.jq(i).change((function(t){e.areaContains=HU.isChecked($(this))})),this.jq(p).click((()=>{this.settingsDialog.remove(),this.useMyLocation()})),this.jq(g).click((()=>{this.settingsDialog.remove(),this.areaClear()}))},getHtml:function(){let e=this.arg?null:HU.getUrlArgument(ARG_MAPBOUNDS),t="",i="",g="",p="";e&&([t,i,g,p]=e.split(","));this.display.getGet();let c=HU.div([ATTR_TITLE,"Settings",ATTR_CLASS,CLASS_CLICKABLE,ATTR_ID,this.domId(o)],HU.getIconImage("fas fa-cog")),u=HU.div([ATTR_CLASS,CLASS_CLICKABLE,ATTR_ID,this.domId(n),ATTR_TITLE,"Show map selector"],HU.getIconImage("fas fa-globe")),T=(e,t,i,s)=>HU.input(e,s,[ATTR_PLACEHOLDER,t,ATTR_CLASS,HU.classes("input","display-area-input"),ATTR_SIZE,5,ATTR_ID,this.domId(e),ATTR_TITLE,i]),f=HU.openTag(TAG_TABLE,[ATTR_CLASS,"display-area"]);return f+=HU.tr([],HU.td([ATTR_ALIGN,ALIGN_CENTER],HU.leftCenterRight("",T(s," N","North",t),u,"20%","60%","20%"))),f+=HU.tr([],HU.td([],T(r," W","West",i)+T(a," E","East",p))),f+=HU.tr([],HU.td([ATTR_ALIGN,ALIGN_CENTER],HU.leftCenterRight("",T(l," S","South",g),c,"20%","60%","20%"))),f+=HU.closeTag(TAG_TABLE),f+=HU.div([ATTR_ID,this.domId(h),ATTR_STYLE,HU.css(CSS_DISPLAY,DISPLAY_NONE)],SPACE+"Shift-drag: select region. Cmd-drag: move region"+HU.div([ATTR_ID,this.domId(d),ATTR_STYLE,HU.css(CSS_WIDTH,HU.px(400),CSS_HEIGHT,HU.px(300))])),f},showMap:function(){let e=this.jq(n);this.dialog=HU.makeDialog({contentId:this.domId(h),anchor:e,draggable:!0,header:!0}),this.map.selectionPopupInit(),this.map.getMap().updateSize()},areaClear:function(){jqid(this.domId(s)).val(""),jqid(this.domId(r)).val(""),jqid(this.domId(l)).val(""),jqid(this.domId(a)).val(""),this.display.areaClear()},useMyLocation:function(){if(navigator.geolocation){let e=this;navigator.geolocation.getCurrentPosition((function(t){e.setUseMyLocation(t)}))}},setUseMyLocation:function(e){let t=e.coords.latitude,i=e.coords.longitude,o=5;this.display.myLocationOffset&&(o=parseFloat(this.display.myLocationOffset)),jqid(this.domId(s)).val(t+o),jqid(this.domId(r)).val(i-o),jqid(this.domId(l)).val(t-o),jqid(this.domId(a)).val(i+o),this.display.submitSearchForm&&this.display.submitSearchForm()},areaLinkClick:function(){this.linkArea=!this.linkArea;let e=root+(this.linkArea?"/icons/link.png":"/icons/link_break.png");if(jqid(this.domId("arealink")).attr(ATTR_SRC,e),this.linkArea&&this.lastBounds){let e=this.lastBounds;jqid(this.domId(s)).val(MapUtils.formatLocationValue(e.top)),jqid(this.domId(r)).val(MapUtils.formatLocationValue(e.left)),jqid(this.domId(l)).val(MapUtils.formatLocationValue(e.bottom)),jqid(this.domId(a)).val(MapUtils.formatLocationValue(e.right))}},linkArea:!1,lastBounds:null,handleEventMapBoundsChanged:function(e,t){bounds=t.bounds,this.lastBounds=bounds,(t.force||this.linkArea)&&(jqid(this.domId(s)).val(MapUtils.formatLocationValue(bounds.top)),jqid(this.domId(r)).val(MapUtils.formatLocationValue(bounds.left)),jqid(this.domId(l)).val(MapUtils.formatLocationValue(bounds.bottom)),jqid(this.domId(a)).val(MapUtils.formatLocationValue(bounds.right)))},getContains:function(){return HU.isChecked(this.jq(i))},getValues:function(e){return{north:this.jq(s).val(),west:this.jq(r).val(),south:this.jq(l).val(),east:this.jq(a).val()}},setSearchSettings:function(e){let t=this.display.getFieldValue(this.domId(s),null),i=this.display.getFieldValue(this.domId(r),null),o=this.display.getFieldValue(this.domId(l),null),n=this.display.getFieldValue(this.domId(a),null);e.setAreaContains(this.areaContains),e.setBounds(t,i,o,n);let h=(new Date).getTime()-this.createTime.getTime()>5e3;h&&HU.addToDocumentUrl(c,this.areaContains),Utils.stringDefined(t,i,o,n)?h&&HU.addToDocumentUrl(ARG_MAPBOUNDS,[t||"",i||"",o||"",n||""].join(",")):HU.removeFromDocumentUrl(ARG_MAPBOUNDS)}})}function DateRangeWidget(e,t,i,s){const l="date_start",a="date_end";this.what=t??"date","createdate"==this.what?(i="Create start",s="Create end"):"changedate"==this.what?(i="Change start",s="Change end"):"date"!=this.what&&null!=i||(i=e.getProperty("date.start.label","Start date"),s=e.getProperty("date.end.label","End date")),this.baseId=this.what,RamaddaUtil.inherit(this,{display:e,initHtml:function(){let e=HU.makeClearDatePickerArgs({dateFormat:"yy-mm-dd",changeMonth:!0,changeYear:!0});jqid(this.baseId+l).datepicker(e),jqid(this.baseId+a).datepicker(e)},getStartEnd:function(){return{start:jqid(this.baseId+l).val(),end:jqid(this.baseId+a).val()}},setSearchSettings:function(e){let t=jqid(this.baseId+l).val(),i=jqid(this.baseId+a).val();HU.addToDocumentUrl(this.baseId+l,Utils.stringDefined(t)?t:null),HU.addToDocumentUrl(this.baseId+a,Utils.stringDefined(i)?i:null),"createdate"==this.what?e.setCreateDateRange(t,i):"changedate"==this.what?e.setChangeDateRange(t,i):"date"==this.what&&e.setDateRange(t,i)},getHtml:function(){let e=HU.getUrlArgument(this.baseId+l),t=HU.getUrlArgument(this.baseId+a);return HU.input(this.baseId+l,e||"",[ATTR_CLASS,"display-date-input",ATTR_PLACEHOLDER," "+i,ATTR_TITLE,i,ATTR_ID,this.baseId+l])+" - "+HU.input(this.baseId+a,t||"",[ATTR_CLASS,"display-date-input",ATTR_PLACEHOLDER," "+s,ATTR_TITLE,s,ATTR_ID,this.baseId+a])}})}function drawSparkline(e,t,i,s,l,a,r,o,n,h){if(i<0||s<0)return;let d={theMargin:{top:0,right:0,bottom:0,left:0},flipYAxis:!1,drawAxis:!0,drawAxisLabels:!1,axisWidth:1,axisColor:COLOR_LIGHT_GRAY};h&&(h.margin&&$.extend(d.theMargin,h.margin),$.extend(d,h));const g=i-d.theMargin.left-d.theMargin.right,p=s-d.theMargin.top-d.theMargin.bottom,c=i/l.length,u=d3.scaleLinear().domain([0,l.length]).range([0,g]);let T=d.flipYAxis?d3.scaleLinear().domain([o,r]).range([p,0]):d3.scaleLinear().domain([r,o]).range([p,0]);d3.scaleLinear().domain([r,o]).range([0,p]);let f=d3.select(TAG_BODY).append(TAG_DIV).attr(ATTR_CLASS,"sparkline-tooltip").style(CSS_OPACITY,0);const y=d3.select(t).append(TAG_SVG).attr(ATTR_WIDTH,i).attr(ATTR_HEIGHT,s).append(TAG_G).attr(ATTR_TRANSFORM,HU.translate(d.theMargin.left,d.theMargin.top));d3.line().x(((e,t)=>u(t))).y((e=>T(e)));let m=d.lineColor||e.getSparklineLineColor(),_=d.barColor||e.getSparklineBarColor(),S=d.circleColor||e.getSparklineCircleColor(),A=d.circleRadius||e.getSparklineCircleRadius(),I=d.lineWidth||e.getSparklineLineWidth(),b=!1,R=(e,t,i)=>n?n.getColorFromRecord(a[t],i):i,D=d.showBars||e.getSparklineShowBars();if(d.drawAxisLabels){let e=d.flipYAxis?Utils.formatNumber(o):Utils.formatNumber(r),t=d.flipYAxis?Utils.formatNumber(r):Utils.formatNumber(o);y.append("text").attr(ATTR_X,5).attr(ATTR_Y,s-5).attr("text-anchor","left").attr("font-size","8pt").text(e),y.append("text").attr(ATTR_X,5).attr(ATTR_Y,10).attr("text-anchor","left").attr("font-size","8pt").text(t)}d.drawAxis&&(y.append("line").attr("x1",0).attr("y1",0).attr("x2",0).attr("y2",s).attr(ATTR_STROKE_WIDTH,d.axisWidth).attr(ATTR_STROKE,d.axisColor),y.append("line").attr("x1",0).attr("y1",s).attr("x2",i).attr("y2",s).attr(ATTR_STROKE_WIDTH,d.axisWidth).attr(ATTR_STROKE,d.axisColor));let L=e=>isNaN(e)?0:e;if(D&&(b=!1,y.selectAll(".bar").data(l).enter().append(TAG_RECT).attr(ATTR_CLASS,"bar").attr("x",((e,t)=>L(u(t)))).attr("y",(e=>L(T(e)))).attr(ATTR_WIDTH,c).attr(ATTR_HEIGHT,(e=>L(s-T(e)))).attr(ATTR_FILL,((e,t)=>R(0,t,_))).style(CSS_CURSOR,CURSOR_POINTER)),(d.showLines||e.getSparklineShowLines())&&y.selectAll("line").data(l).enter().append("line").attr("x1",((e,t)=>u(t))).attr("y1",((e,t)=>T(e))).attr("x2",((e,t)=>u(t+1))).attr("y2",((e,t)=>T(t<l.length-1?l[t+1]:l[t]))).attr(ATTR_STROKE_WIDTH,I).attr(ATTR_STROKE,((e,t)=>isNaN(e)?HU.rgb(0,0,0,0):R(0,t,m))).style(CSS_CURSOR,CURSOR_POINTER),(d.showCircles||e.getSparklineShowCircles())&&y.selectAll("circle").data(l).enter().append("circle").attr("r",((e,t)=>isNaN(e)?0:A)).attr("cx",((e,t)=>L(u(t)))).attr("cy",((e,t)=>L(T(e)))).attr(ATTR_FILL,((e,t)=>R(0,t,S))).style(CSS_CURSOR,CURSOR_POINTER),d.showEndpoints||e.getSparklineShowEndPoints(b)){let t=0;for(;isNaN(l[t])&&t<l.length;)t++;let i=l.length-1;for(;isNaN(l[i])&&i>=0;)i--;y.append("circle").attr("r",d.endPointRadius||e.getSparklineEndPointRadius()).attr("cx",u(t)).attr("cy",T(l[t])).attr(ATTR_FILL,d.endPoint1Color||e.getSparklineEndPoint1Color()||R(l[0],0,e.getSparklineEndPoint1Color())),y.append("circle").attr("r",d.endPointRadius||e.getSparklineEndPointRadius()).attr("cx",u(i)).attr("cy",T(l[i])).attr(ATTR_FILL,d.endPoint2Color||e.getSparklineEndPoint2Color()||R(l[l.length-1],l.length-1,e.getSparklineEndPoint2Color()))}let U=e,C=e.getSparklineDoTooltip()||d.doTooltip;y.on("click",(function(e){let t=d3.pointer(e);if(a){let e=a[Math.round(u.invert(t[0]))];e&&U.propagateEventRecordSelection({select:!0,record:e})}})),C&&y.on("mouseover",(function(e){if(!a)return;let i=d3.pointer(e),s=a[Math.round(u.invert(i[0]))];if(!s)return;let l=U.getRecordHtml(s),r=$(t),o=r.offset().top+r.height(),n=r.offset().left;f.transition().duration(200).style(CSS_OPACITY,.9),f.html(l).style(CSS_LEFT,HU.px(n)).style(CSS_TOP,HU.px(o))})).on("mouseout",(function(e){f.transition().duration(500).style(CSS_OPACITY,0)}))}function drawDots(e,t,i,s,l,a,r,o,n){o=o||{};const h=i-(n=n||{top:0,right:0,bottom:0,left:0}).left-n.right,d=s-n.top-n.bottom,g=d3.scaleLinear().domain([a.minx,a.maxx]).range([0,h]),p=d3.scaleLinear().domain([a.miny,a.maxy]).range([d,0]);let c=d3.select(TAG_BODY).append(TAG_DIV).attr(ATTR_CLASS,"sparkline-tooltip").style(CSS_OPACITY,0);const u=d3.select(t).append(TAG_SVG).attr(ATTR_WIDTH,i).attr(ATTR_HEIGHT,s).append(TAG_G);o.circleColor||e.getProperty("sparklineCircleColor",COLOR_BLACK);let T=o.circleRadius||e.getProperty("sparklineCircleRadius",1);console.log(JSON.stringify(a));let f=e=>isNaN(e)?0:e,y={};u.selectAll("circle").data(l).enter().append("circle").attr("r",((e,t)=>T)).attr("cx",((e,t)=>f(g(e.x)))).attr("cy",((e,t)=>f(p(e.y)))).attr(ATTR_FILL,((e,t)=>COLOR_BLACK)).attr(ATTR_RECORD_ID,((e,t)=>(y[e.record.getId()]=e.record,e.record.getId()))).style(CSS_CURSOR,CURSOR_POINTER);let m=e,_=e.getProperty("sparklineDoTooltip",!0)||o.doTooltip;u.on("click",(function(e){let t=d3.pointer(e);if(records){let e=records[Math.round(g.invert(t[0]))];e&&m.propagateEventRecordSelection({select:!0,record:e})}})),_&&u.on("mouseover",(function(e){d3.select(this).attr("r",10).style(CSS_FILL,"red");let i=$(t);i.attr("r",20)})).on("mouseout",(function(e){c.transition().duration(500).style(CSS_OPACITY,0)}))}function drawPieChart(e,t,i,s,l,a,r,o,n){n||(n={});let h=Utils.isDefined(n.margin)?n.margin:4,d=n.pieColors||Utils.ColorTables.cats.colors,g=n.colorMap;g||(g={},l.forEach(((e,t)=>{let i=e[0];g[i]=d[t%d.length]})));let p=Math.min(i,s)/2-h,c=d3.select(t).append(TAG_SVG).attr(ATTR_WIDTH,i).attr(ATTR_HEIGHT,s).append(TAG_G).attr(ATTR_TRANSFORM,HU.translate(i/2,s/2)),u={};l.forEach((e=>{u[e[0]]=e[1]}));let T=d3.pie().value((function(e){return e.value}))(Utils.makeKeyValueList(u));c.selectAll("whatever").data(T).enter().append("path").attr("d",d3.arc().innerRadius(0).outerRadius(p)).attr(ATTR_FILL,(function(e){return g[e.data.key]})).attr(ATTR_STROKE,COLOR_BLACK).style(CSS_STROKE_WIDTH,HU.px(1)).style(CSS_OPACITY,.7)}function Annotations(e,t){this.display=e,t||(t=this.display.filterData());this.display.getPointData().getRecordFields();this.labelField=this.display.getFieldById(null,this.display.getProperty("annotationLabelField")),this.fields=this.display.getFieldsByIds(null,this.display.getProperty("annotationFields"));let i=this.display.getProperty("annotations");i&&(this.fields=[]),this.map={};let s=(e,t,i)=>{i.record=e,this.map[t]||(this.map[t]=[]),this.map[t].push(i),this.map[e.getId()]||(this.map[e.getId()]=[]),this.map[e.getId()].push(i)};if(!i)return;this.annotations=[],this.legend="";let l=0,a=i.split(";");this.hasRange=!1;for(let e=0;e<a.length;e++){let t=a[e].split(",");if(t.length<2)continue;let i=t[0].trim(),s=t[1];""==s.trim()&&(l++,s=""+l);let r=t.length<2?"":t[2],o=t.length<3?null:t[3],n=!1,h={label:s,description:r,toString:function(){return this.label+" "+this.description}};if(this.annotations.push(h),i.match(/^#[0-9]+$/))i=parseFloat(i);else{let e=null;i.indexOf(":")>=0&&(e=i.split(":")[1],i=i.split(":")[0]);i="today"==i?new Date:Utils.parseDate(i,!1),e?(this.hasRange=!0,e="today"==e?Utils.formatDateYYYYMMDD(new Date):Utils.parseDate(e,!1),r=r||this.display.formatDate(i)+"-"+this.display.formatDate(e),h.index2=e.getTime()):r=r||this.display.formatDate(i),n=!0}h.index=n?i.getTime():i;let d=r;null!=o&&(d=HU.href(o,d,[ATTR_TARGET,"_annotation"])),this.legend+=HU.b(s)+": "+d+" "}for(let e=0;e<this.annotations.length;e++){let i=this.annotations[e],l=null,a=null,r=null;for(let e=0;e<t.length;e++){let o=t[e],n=o.record?o.record:o,h=this.display.getDataValues(t[e])[0];h.v&&(h=h.v),n&&(h=n.getTime());let d=Number.MAX_VALUE;i.index2?(d=h>=i.index&&h<=i.index2?0:Math.min(Math.abs(i.index-h),Math.abs(i.index2-h)),0==d&&s(n,e,i)):d=Math.abs(i.index-h),(null==l||d<r)&&(l=e,r=d,a=n)}null!=l&&s(a,l,i)}}Utils.addColorTables(defaultColorTables),Annotations.prototype={isEnabled:function(){return null!=this.annotations},getAnnotations:function(){return this.annotations},getAnnotationsFor:function(e){return this.map[e]},getAnnotationFromDate:function(e){let t=Number.MAX_VALUE,i=null,s=null,l=e.getTime();for(let e=0;e<this.annotations.length;e++){let a=this.annotations[e];if(a.index2){if(l>=a.index&&l<=a.index2)return a}else t=Math.abs(a.index-l),(null==i||t<s)&&(i=a,s=t)}return i},getLegend:function(){return this.legend},getShowLegend:function(){return this.display.getProperty("showAnnotationsLegend")},hasFields:function(){return this.fields&&this.fields.length>0},getFields:function(){return this.fields}};let Gfx={gridData:function(e,t,i,s){s||(s={}),(isNaN(s.cellSize)||null==s.cellSize)&&(s.cellSize=s.cellSizeX),(isNaN(s.cellSizeX)||null==s.cellSizeX)&&(s.cellSizeX=s.cellSize),(isNaN(s.cellSizeY)||null==s.cellSizeY)&&(s.cellSizeY=s.cellSizeX);let l={shape:"rect",color:"blue",w:800,h:400,scale:1,cellSize:2,cellSizeX:2,cellSizeY:2,operator:"average"};$.extend(l,s);let a=HU.getUniqueId();l.scale=+l.scale;let r=l.scale;l.w*=l.scale,l.h*=l.scale,$(document.body).append(HU.tag(TAG_CANVAS,[ATTR_STYLE,HU.css(CSS_DISPLAY,DISPLAY_NONE),ATTR_ID,a,ATTR_WIDTH,l.w,ATTR_HEIGHT,l.h]));let o=document.getElementById(a),n=o.getContext("2d"),h=s.bounds.east-s.bounds.west,d=s.bounds.north-s.bounds.south;n.font=l.cellFont||"8pt Arial;";let g=n.createLinearGradient(0,0,0,o.height);g.addColorStop(0,"white"),g.addColorStop(1,"red");let p,c=(e,t)=>Math.floor(l.w*(t-s.bounds.west)/h);if(l.display&&l.display.map){l.display.map.transformLLPoint(MapUtils.createLonLat(l.bounds.east,85)),l.display.map.transformLLPoint(MapUtils.createLonLat(l.bounds.east,-85));let e=l.display.map.transformLLPoint(MapUtils.createLonLat(l.bounds.east,l.bounds.north)),t=l.display.map.transformLLPoint(MapUtils.createLonLat(l.bounds.east,l.bounds.south));p=(i,s)=>{let a=l.display.map.transformLLPoint(MapUtils.createLonLat(s,i)),r=(e.lat-a.lat)/(e.lat-t.lat);return Math.floor(r*l.h)}}else p=(e,t)=>Math.floor(l.h*(s.bounds.north-e)/d);if(n.lineStyle=COLOR_BLACK,l.doHeatmap){let a=Math.floor(l.w/l.cellSizeX),h=Math.floor(l.h/l.cellSizeY),d=[];i.forEach(((t,i)=>{let s=t.getLatitude(),r=t.getLongitude(),o=c(0,r),n=p(s,r);t[e+"_coordinates"]={x:o,y:n};let g=0;l.colorBy&&l.colorBy.index>=0&&(g=t.getValue(l.colorBy.index));let u=0;l.lengthBy&&l.lengthBy.index>=0&&(u=t.getValue(l.lengthBy.index)),o=Math.floor(o/l.cellSizeX),n=Math.floor(n/l.cellSizeY),o<0&&(o=0),n<0&&(n=0),o>=a&&(o=a-1),n>=h&&(n=h-1),d.push({x:o,y:n,colorValue:g,r:t})}));let g=Gfx.gridPoints(h,a,d,s);l.cellSizeX=+l.cellSizeX,l.cellSizeY=+l.cellSizeY,this.applyFilter(l,g);let u=this.getMinMaxGrid(g,(e=>e.v));l.colorBy&&(Utils.isDefined(l.display.getProperty("colorByMin"))||l.colorBy.setRange(u.min,u.max),l.colorBy.index=0);let T=l.display.getProperty("hmCountThreshold","count"==l.operator?1:0),f=new Glyph(l.display,r,t,i,{type:l.shape,canvasWidth:o.width,canvasHeight:o.height,colorByInfo:l.colorBy,width:l.cellSizeX,height:l.cellSizeY,stroke:!1,pos:"c",dx:l.cellSizeX/2,dy:l.cellSizeY/2},"");for(let e=0;e<h;e++){let t=g[e];for(let i=0;i<a;i++){let s=t[i],a=s.v;if(isNaN(a))continue;let r=i*l.cellSizeX,h=e*l.cellSizeY;s.count>=T&&f.draw(l,o,n,r,h,{colorValue:s.v,col:i,row:e,cell:s,grid:g})}}}else{i.sort(((e,t)=>t.getLatitude()-e.getLatitude()));let s=[],a=1;for(;a<11;){let e=l.display.getProperty("glyph"+a++);e&&s.push(new Glyph(l.display,r,t,i,{canvasWidth:o.width,canvasHeight:o.height},e))}s.forEach((t=>{i.forEach(((i,s)=>{let a=i.getLatitude(),r=i.getLongitude(),h=c(0,r),d=p(a,r);i[e+"_coordinates"]={x:h,y:d};let g=l.colorBy?i.getData()[l.colorBy.index]:null,u=l.lengthBy?i.getData()[l.lengthBy.index]:null;t.draw(l,o,n,h,d,{colorValue:g,lengthValue:u,record:i},s<10)}))}))}let u=l.display.getProperty("colorTableAlpha",-1);if(u>0){let e=n.getImageData(0,0,l.w,l.h),t=e.data,i=t.length;for(let e=3;e<i;e+=4)t[e]&&(t[e]=255*u);e.data=t,n.putImageData(e,0,0)}let T=o.toDataURL("image/png");return o.parentNode.removeChild(o),T},gridPoints:function(e,t,i,s){let l=displayDebug.gridPoints,a=[];for(let i=0;i<e;i++){let e=[];a.push(e);for(let i=0;i<t;i++)e.push({v:NaN,count:0,total:0,min:NaN,max:NaN,t:""})}i.forEach(((e,t)=>{let i=a[e.y][e.x];i.min=0==i.count?e.colorValue:Math.min(i.min,e.colorValue),i.max=0==i.count?e.colorValue:Math.max(i.max,e.colorValue),i.count++,i.total+=e.colorValue}));let r=NaN,o=NaN,n=0,h=0;for(let i=0;i<e;i++)for(let e=0;e<t;e++){let t,l=a[i][e];0!=l.count&&(t="count"==s.operator?l.count:"min"==s.operator?l.min:"max"==s.operator?l.max:"total"==s.operator?l.total:l.total/l.count,l.v=t,isNaN(t)||(r=isNaN(r)?t:Math.min(r,t),o=isNaN(o)?t:Math.max(o,t)),n=Math.max(n,l.count),h=0==h?l.count:Math.min(h,l.count))}return l&&console.log("operator:"+s.operator+" values:"+r+" - "+o+" counts:"+h+" - "+n),a.minValue=r,a.maxValue=o,a.minCount=h,a.maxCount=n,a},getGridValue:function(e,t,i,s,l,a){return t>=0&&t<e.length&&i>=0&&i<e[t].length?isNaN(e[t][i])?0:(l[0]+=s,a[0]++,e[t][i]*s):0},applyKernel:function(e,t){let i=this.cloneGrid(e,null,0);for(let s=0;s<e.length;s++){let l=i[s];for(let i=0;i<l.length;i++){isNaN(l[i])&&(l[i]=0);let a=[0],r=[0],o=0;t.every((t=>(o+=this.getGridValue(e,s+t[0],i+t[1],t[2],a,r),!0))),r[0]>0?l[i]=o/a[0]:l[i]=NaN}}return i},blurGrid:function(e,t){let i={average5:[[0,1,0],[1,1,1],[0,1,0]],average9:[[1,1,1],[1,1,1],[1,1,1]],average25:[[1,1,1,1,1],[1,1,1,1,1],[1,1,1,1,1],[1,1,1,1,1],[1,1,1,1,1]],average49:[[1,1,1,1,1,1,1],[1,1,1,1,1,1,1],[1,1,1,1,1,1,1],[1,1,1,1,1,1,1],[1,1,1,1,1,1,1],[1,1,1,1,1,1,1],[1,1,1,1,1,1,1]],gauss9:[[.077847,.123317,.077847],[.123317,.195346,.123317],[.077847,.123317,.077847]],gauss25:[[.003765,.015019,.023792,.015019,.003765],[.015019,.059912,.094907,.059912,.015019],[.023792,.094907,.150342,.094907,.023792],[.015019,.059912,.094907,.059912,.015019],[.003765,.015019,.023792,.015019,.003765]],gauss49:[[67e-8,2292e-8,19117e-8,38771e-8,19117e-8,2292e-8,67e-8],[2292e-8,78633e-8,.00655965,.01330373,.00655965,78633e-8,2292e-8],[19117e-8,.00655965,.05472157,.11098164,.05472157,.00655965,19117e-8],[38771e-8,.01330373,.11098164,.22508352,.11098164,.01330373,38771e-8],[19117e-8,.00655965,.05472157,.11098164,.05472157,.00655965,19117e-8],[2292e-8,78633e-8,.00655965,.01330373,.00655965,78633e-8,2292e-8],[67e-8,2292e-8,19117e-8,38771e-8,19117e-8,2292e-8,67e-8]]},s=i[e];return s||(e.startsWith("average")?s=i.average5:e.startsWith("gauss")&&(s=i.gauss9)),s?this.applyKernel(t,this.makeKernel(s)):t},makeKernel:function(e){let t=[],i=(e.length-1)/2;for(let s=0;s<e.length;s++){let l=e[s],a=s-i;for(let r=0;r<l.length;r++){let l=r-i;t.push([a,l,e[s][r]])}}return t},printGrid:function(e){console.log("grid:");for(let t=0;t<e.length;t++){let i=e[t],s="";for(let e=0;e<i.length;e++)Utils.isDefined(i[e].v)?s+=i[e].v+",":s+=i[e]+",";console.log(s)}},applyFilter(e,t){if(!e.filter||""==e.filter||"none"==e.filter)return;let i=this.cloneGrid(t,(e=>e.v)),s=e.display.getProperty("hmFilterPasses",1);for(let t=0;t<s;t++)i=this.blurGrid(e.filter,i);let l=e.display.getProperty("hmFilterThreshold",-999);for(let e=0;e<t.length;e++){let s=t[e];for(let t=0;t<s.length;t++){let a=s[t],r=i[e][t];-999!=l&&r<l&&(r=a.v),a.v=r}}},getMinMaxGrid:function(e,t){let i=NaN,s=NaN;for(let l=0;l<e.length;l++){let a=e[l];for(let e=0;e<a.length;e++){let r=a[e];t&&(r=t(r,l,e)),isNaN(r)||(i=isNaN(i)?r:Math.min(i,r),s=isNaN(s)?r:Math.max(s,r))}}return{min:i,max:s}},cloneGrid:function(e,t,i){let s=[],l=Utils.isDefined(i);for(let a=0;a<e.length;a++){let r=e[a],o=[];s.push(o);for(let e=0;e<r.length;e++){let s=r[e];t&&(s=t(s,a,e)),l?o.push(i):o.push(s)}}return s},convertGeoToPixel:function(e,t,i,s,l){let a=i.west,r=i.east-a,o=i.south*Math.PI/180,n=s/r*(t-a);e=e*Math.PI/180;let h=s/r*360/(2*Math.PI),d=h/2*Math.log((1+Math.sin(o))/(1-Math.sin(o)));return[n,l-(h/2*Math.log((1+Math.sin(e))/(1-Math.sin(e)))-d)]}};function DisplayAnimation(e,t,i){i=i||{},$.extend({},i);const s="animrun",l="animnext",a="animprev",r="animbegin",o="animend",n="slider",h="ticks",d="tooltip",g="showall",p="window",c="step",u="settings",T="faster",f="slower",y="reset",m="animationlabel",_="frame",S="sliding";$.extend(this,{display:e,enabled:t,targetDiv:i.targetDiv,baseDomId:i.baseDomId,labelSize:e.getProperty("animationLabelSize","12pt"),labelStyle:e.getProperty("animationLabelStyle",""),labelTemplate:e.getProperty("animationLabelTemplate"),running:!1,inAnimation:!1,begin:null,end:null,dateMin:null,dateMax:null,dateRange:0,dateFormat:e.getProperty("animationDateFormat",e.getProperty("dateFormat","yyyymmdd")),mode:e.getProperty("animationMode","cumulative"),startAtBeginning:e.getProperty("animationStartAtBeginning",!0),startAtEnd:e.getProperty("animationStartAtEnd",!1),useIndex:e.getProperty("animationUseIndex",!1),speed:parseInt(e.getProperty("animationSpeed",500)),dwell:parseInt(e.getProperty("animationDwell",1e3)),getEnabled:function(){return this.enabled},toggleAnimation:function(){this.running=!this.running,this.btnRun&&this.btnRun.html(HU.getIconImage(this.running?ICON_STOP:ICON_PLAY)),this.running&&this.startAnimation()},getDomId:function(e){return this.domId(e)},domId:function(e){return this.display.getDomId(e+(this.baseDomId?this.baseDomId:""))},jq:function(e){return this.display.jq(e+(this.baseDomId?this.baseDomId:""))},setBeginEnd:function(e){this.setBegin(e),this.setEnd(e)},setBegin:function(e){this.begin=this.makeDate(e)},setEnd:function(e){this.end=this.makeDate(e)},makeIndex:function(e){return{wrapper:!0,isIndex:!0,index:e,getTime:function(){return this.value},value:e}},makeDate:function(e){return e?this.useIndex?this.makeIndex(Utils.isDefined(e.index)?e.index:e.getTime()):(e.wrapper&&(e=e.date),{wrapper:!0,date:e,value:e.getTime(),getTime:function(){return this.value}}):null},init:function(e,t,i){let s=!1;let l=this;this.records=i,this.useIndex?(this.dateMin=this.makeIndex(0),this.dateMax=this.makeIndex(i.length-1)):(this.dateMin=this.makeDate(e),this.dateMax=this.makeDate(t));let a=this.dateMin,r=this.dateMax;if(this.setBegin(a),this.setEnd(r),!this.dateMin)return;this.dates=[];let o={};this.dateToRecordMap={},i.every(((e,t)=>{if(this.useIndex)return this.dates.push(this.makeIndex(t)),this.dateToRecordMap[t]=e,!0;let i=e.getDate();return i?(o[i]||(o[i]=!0,this.dates.push(this.makeDate(i)),this.dateToRecordMap[i]=e),!0):void 0})),this.dates.sort((function(e,t){return e.value-t.value})),this.dateRange=this.dateMax.getTime()-this.dateMin.getTime(),this.steps=parseFloat(this.display.getProperty("animationSteps",60)),this.setWindow(),this.frameIndex=0,this.display.getProperty("animationStartShowAll",!1)||this.resetRange();let d=this.mode!=_?[this.begin.getTime(),this.end.getTime()]:[this.begin.getTime()],g={mouseleave:function(e){l.tooltip&&l.tooltip.hide()},mousemove:function(e){if(l.tooltip&&e.offsetX>=0){let t=l.tooltip.parent().width(),i=l.tooltip.parent().offset().left,s=(e.pageX-i)/t,a=new Date(l.dateMin.getTime()+s*l.dateRange);a=l.formatAnimationDate(a,l.tooltipDateFormat),l.makeSlider||(a+="<br>+/-:zoom"),l.tooltip.html(a),l.tooltip.show(),l.tooltip.position({of:e.target,my:POS_LEFT_TOP,at:"left+"+e.offsetX+" bottom",collision:"fit fit"})}}};if(this.makeSlider){this.slider=this.jq(n).slider({range:l.mode!=_,min:l.dateMin.getTime(),max:l.dateMax.getTime(),values:d,create:function(){l.sliderHandleLeft=$(".ui-slider-handle:eq(0)"),l.sliderHandleRight=$(".ui-slider-handle:eq(1)"),l.sliderHandleLeft.length&&l.sliderHandleRight.length&&(l.sliderHandleLeft.attr(ATTR_TITLE,"Shift-drag to move both"),l.sliderHandleRight.attr(ATTR_TITLE,"Shift-drag to move both"))},slide:function(e,t){l.stopAnimation(),l.checkSliderValues(e,t),l.setSliderValues(t.values),l.updateLabels()},stop:function(e,t){l.checkSliderValues(e,t),l.stopAnimation(),l.setSliderValues(t.values),l.dateRangeChanged(!0)}});this.jq(n).on(g)}else this.jq(h).on(g);this.updateTicks(),this.updateLabels()},checkSliderValues:function(e,t){if(e.shiftKey&&this.lastSliderValues){if(this.sliderHandleLeft[0]==t.handle){let e=t.values[0]-this.lastSliderValues[0];t.values[1]+=e}else{let e=t.values[1]-this.lastSliderValues[1];t.values[0]+=e}this.slider.slider("values",t.values)}this.lastSliderValues=t.values},resetRange:function(){if(this.display.getProperty("animationInitRange")){let e=Utils.split(this.display.getProperty("animationInitRange"),","),t=0;t="begin"==e[0].trim()?0:+e[0],t<0&&(t=this.records.length+t);let i=this.records[t];return i&&this.setBegin(i.getTime()),void(e.length>1&&(t="end"==e[1].trim()?this.records.length-1:+e[1],i=this.records[t],i&&this.setEnd(i.getTime())))}this.startAtEnd?(this.setBegin(this.dateMax),this.setEnd(this.dateMax),this.mode==_&&(this.frameIndex=this.dates.length-1)):this.startAtBeginning&&(this.setBegin(this.dateMin),this.setEnd(new Date(this.begin.getTime()+this.window))),this.mode==_&&this.setEnd(this.begin)},setWindow:function(){let e=this.display.getProperty("animationWindow"),t=this.display.getProperty("animationStep",e);e?this.window=DataUtils.timeToMillis(e):this.steps>0&&(this.useIndex?this.window=1:this.window=this.dateRange/this.steps),this.step=t?DataUtils.timeToMillis(t):this.window},getIndex:function(){return this.frameIndex},getBeginTime:function(){return this.begin},handleEventAnimationChanged(e){this.setBegin(e.begin),this.setEnd(e.end),this.stopAnimation(),this.applyAnimation()},setSliderValues:function(e){if(this.mode!=_)this.setBegin(new Date(e[0])),this.setEnd(new Date(e[1]));else{let t=new Date(e[0]),i=this.dates[0],s=0;this.dates.forEach(((e,l)=>{Math.abs(e.value-t.getTime())<Math.abs(i.getTime()-t.getTime())&&(i=e,s=l)})),this.setBegin(i),this.setEnd(i),this.frameIndex=s}},handleEventRecordHighlight:function(e,t){let i=jqid(this.display.getId()+"-"+t.record.getId());this.ticks&&this.ticks.removeClass("display-animation-tick-highlight"),t.highlight?i.addClass("display-animation-tick-highlight"):i.removeClass("display-animation-tick-highlight")},makeControls:function(){this.tickHeight=this.display.getProperty("animationHeight",HU.px(15)),this.makeSlider=this.display.getProperty("animationMakeSlider",!0);let t="",i=this.display.getProperty("animationShowButtons",!0),A=e.getProperty("animationShowSlider",!0),I=e.getProperty("animationShowLabel",!0);if(i){let i=e.getProperty("animationWidgetShort",!1);t+=HU.span([ATTR_ID,this.getDomId(u),ATTR_TITLE,"Settings"],HU.getIconImage("fas fa-cog")),i||(t+=HU.span([ATTR_ID,this.getDomId(r),ATTR_TITLE,"Go to beginning"],HU.getIconImage("fa-fast-backward"))),t+=HU.span([ATTR_ID,this.getDomId(a),ATTR_TITLE,"Previous"],HU.getIconImage("fa-step-backward")),i||(t+=HU.span([ATTR_ID,this.getDomId(s),ATTR_TITLE,"Run/Stop"],HU.getIconImage(ICON_PLAY))),t+=HU.span([ATTR_ID,this.getDomId(l),ATTR_TITLE,"Next"],HU.getIconImage("fa-step-forward")),i||(t+=HU.span([ATTR_ID,this.getDomId(o),ATTR_TITLE,"Go to end"],HU.getIconImage("fa-fast-forward")))}if(I&&(t+=i?HU.span([ATTR_ID,this.getDomId(m),ATTR_CLASS,"display-animation-label",ATTR_STYLE,this.labelStyle+HU.css(CSS_FONT_SIZE,this.labelSize)]):HU.div([ATTR_ID,this.getDomId(m),ATTR_CLASS,"display-animation-label",ATTR_STYLE,this.labelStyle+HU.css(CSS_TEXT_ALIGN,ALIGN_CENTER,CSS_FONT_SIZE,this.labelSize)])),t=HU.div([ATTR_CLASS,"display-animation-buttons"],t),A){let i=HU.css(CSS_HEIGHT,this.tickHeight)+e.getProperty("animationSliderStyle",""),s=HU.div([ATTR_ID,this.getDomId(d),ATTR_CLASS,"display-animation-tooltip"],""),l=HU.css(CSS_HEIGHT,this.tickHeight);this.makeSlider||(l+=HU.css(CSS_BACKGROUND,"#efefef",CSS_BORDER,HU.border(1,"#aaa"))),this.makeSlider||(i+=HU.css(CSS_CURSOR,CURSOR_MOVE)),t+=HU.div([ATTR_CLASS,"display-animation-slider",ATTR_STYLE,i,ATTR_ID,this.getDomId(n)],s+HU.div([ATTR_STYLE,l,ATTR_CLASS,"display-animation-ticks",ATTR_TABINDEX,0,ATTR_ID,this.getDomId(h)]))}if(this.html=HU.div([ATTR_STYLE,this.display.getProperty("animationStyle")],t),this.display.getProperty("animationShow",!0)&&(this.targetDiv?this.targetDiv.append(this.html):this.jq(ID_TOP_LEFT).append(this.html)),!this.makeSlider){let e=this;this.jq(h).mouseenter((function(e){$(this).focus()})),this.lastKeyTime=0;let t=this.jq(h);t.mousedown((function(t){e.mouseIsDown=!0;let i=$(this).parent().offset();e.mouseX=t.pageX-i.left})),t.mousemove((function(t){if(!e.mouseIsDown)return;var i=$(this).parent().offset(),s=t.pageX-i.left;let l=e.dateMax.getTime()-e.dateMin.getTime(),a=$(this).width(),r=e.mouseX-s;i=$(this).parent().offset();if(e.mouseX=t.pageX-i.left,0==r)return;let o=l*r/a;e.originaDateMin||(e.originaDateMin=e.dateMin,e.originaDateMax=e.dateMax),e.dateMin=e.makeDate(new Date(e.dateMin.getTime()+o)),e.dateMax=e.makeDate(new Date(e.dateMax.getTime()+o)),e.updateTicks(),e.updateLabels()})),t.mouseup((function(t){e.mouseIsDown=!1})),t.keypress((function(t){let i=new Date;i.getTime(),e.lastKeyTime;e.lastKeyTime=i.getTime(),43==t.which?e.zoom(!0):45==t.which?e.zoom(!1):61==t.which&&e.zoomReset()})),this.jq(h).bind("xwheel",(function(t){if($(this).focus(),t.originalEvent.deltaY<0){let t=e.dateMax.getTime()-e.dateMin.getTime(),i=t-.9*t;e.dateMin=e.makeDate(new Date(e.dateMin.getTime()+i)),e.dateMax=e.makeDate(new Date(e.dateMax.getTime()-i)),e.updateTicks(),e.updateLabels()}else t.originalEvent.deltaY;t.stopPropagation(),t.stopImmediatePropagation(),t.preventDefault()}))}this.display.getProperty("animationTooltipShow",!1)&&(this.tooltip=this.jq(d),this.tooltipDateFormat=this.display.getProperty("animationTooltipDateFormat"));let b=this;this.jq(u).button().click((function(){let e=b.display.getProperty("animationWindow"),t=b.display.getProperty("animationStep",e),i=HU.classes(CLASS_HOVERABLE,CLASS_CLICKABLE),s=HU.div([ATTR_ID,b.domId(T),ATTR_TITLE,"Faster",ATTR_CLASS,i],"Faster")+HU.div([ATTR_ID,b.domId(f),ATTR_TITLE,"Slower",ATTR_CLASS,i],"Slower")+HU.div([ATTR_ID,b.domId(y),ATTR_TITLE,"Reset",ATTR_CLASS,i],"Reset")+HU.div([ATTR_ID,b.domId(g),ATTR_TITLE,"Show all",ATTR_CLASS,i],"Show all");e&&(s+=HU.div([ATTR_TITLE,"Window, e.g., 1 week, 2 months, 3 days, 2 weeks, etc"],"Window:"+HU.br()+SPACE2+HU.input("",e,[ATTR_ID,b.domId(p),ATTR_SIZE,10])),s+=HU.div([ATTR_TITLE,"Step, e.g., 1 week, 2 months, 3 days, 2 weeks, etc"],"Step:"+HU.br()+SPACE2+HU.input("",t,[ATTR_ID,b.domId(c),ATTR_SIZE,10]))),s=HU.div([ATTR_STYLE,HU.css(CSS_MARGIN,HU.px(4))],s),b.dialog=HU.makeDialog({content:s,anchor:$(this),draggable:!1,header:!1});let l=e=>{Utils.isReturnKey(e)&&(b.dialog.hide(),b.display.setProperty("animationWindow",b.jq(p).val()),b.display.setProperty("animationStep",b.jq(c).val()),b.setWindow(),b.resetRange(),b.dateRangeChanged())};b.jq(p).keyup(l),b.jq(c).keyup(l),b.jq(T).click((()=>{b.dialog.hide(),b.speed=.75*b.speed})),b.jq(f).click((()=>{b.dialog.hide(),b.speed=1.5*b.speed})),b.jq(y).click((()=>{b.dialog.hide(),b.speed=parseInt(b.display.getProperty("animationSpeed",500)),b.resetRange(),b.inAnimation=!1,b.stopAnimation(),b.dateRangeChanged()})),b.jq(g).click((()=>{b.dialog.hide(),b.setBegin(b.dateMin),b.setEnd(b.dateMax),b.inAnimation=!1,b.stopAnimation(),b.dateRangeChanged()}))})),this.btnRun=this.jq(s),this.btnPrev=this.jq(a),this.btnNext=this.jq(l),this.btnBegin=this.jq(r),this.btnEnd=this.jq(o),this.label=this.jq(m),this.btnRun.button().click((()=>{this.toggleAnimation()})),this.btnBegin.button().click((()=>{let e=this.getDiff(),t=this.fullRange();if(this.setBegin(this.dateMin),this.mode==S)this.end=this.makeDate(new Date(this.begin.getTime()+(t?this.window:e)));else if(this.mode==_){this.frameIndex=0;let e=this.deltaFrame(0);this.setBeginEnd(e)}else this.setEnd(new Date(this.dateMin.getTime()+this.window));this.stopAnimation(),this.dateRangeChanged()})),this.btnEnd.button().click((()=>{let e=this.getDiff(),t=this.fullRange();this.end=this.dateMax,this.mode==S?this.setBegin(new Date(this.end.getTime()-(t?this.window:e))):this.mode==_?(this.frameIndex=this.dates.length+1,this.setBeginEnd(this.deltaFrame(0))):this.setEnd(this.dateMax),this.stopAnimation(),this.dateRangeChanged()})),this.btnPrev.button().click((()=>{this.stopAnimation(),this.doPrev()})),this.btnNext.button().click((()=>{this.stopAnimation(),this.doNext()}))},fullRange:function(){return this.atBegin()&&this.atEnd()},atEnd:function(){return this.end&&this.end.getTime()>=this.dateMax.getTime()},atBegin:function(){return this.begin&&this.begin.getTime()<=this.dateMin.getTime()},getDiff:function(){return this.end&&this.begin?this.end.getTime()-this.begin.getTime():0},doPrev:function(){let e=this.getDiff()||this.window;e=this.window||this.getDiff(),this.mode==S?(this.setBegin(new Date(this.begin.getTime()-e)),this.begin.getTime()<this.dateMin.getTime()&&this.setBegin(this.dateMin),this.setEnd(new Date(this.begin.getTime()+e))):this.mode==_?this.setBeginEnd(this.deltaFrame(-1)):(this.setEnd(new Date(this.end.getTime()-this.window)),this.end.getTime()<=this.begin.getTime()&&this.setEnd(new Date(this.begin.getTime()+this.window))),this.dateRangeChanged()},doNext:function(){let e=this.atEnd();if(this.mode==S){let e=this.window||this.getDiff();this.setBegin(new Date(this.begin.getTime()+this.step)),this.setEnd(new Date(this.end.getTime()+this.step)),this.atEnd()&&(this.end=this.dateMax,this.setBegin(new Date(this.end.getTime()-e)),this.inAnimation=!1,this.stopAnimation())}else if(this.mode==_){if(this.setBeginEnd(this.deltaFrame(1)),this.running&&e){if(this.display.getProperty("animationLoop",!0))return void setTimeout((()=>{this.setBegin(this.dateMin),this.setEnd(this.dateMin),this.frameIndex=0,this.updateUI()}),this.dwell);this.stopAnimation()}}else this.end=this.makeDate(new Date(this.end.getTime()+this.window)),this.atEnd()&&(this.end=this.dateMax,this.inAnimation=!1,this.stopAnimation());this.dateRangeChanged()},setTimes:function(e){this.getEnabled()&&(this.setBeginEnd(e[0],e[e.length-1]),this.dates.every(((t,i)=>t.getTime()!=e[0].getTime()||(this.frameIndex=i,!1))),this.updateUI(),this.dateRangeChanged())},deltaFrame:function(e){if(this.frameIndex+=e,this.dates)return this.frameIndex>=this.dates.length?this.frameIndex=this.dates.length-1:this.frameIndex<0&&(this.frameIndex=0),this.dates[this.frameIndex]},startAnimation:function(){if(this.dateMax){if(!this.inAnimation){if(this.inAnimation=!0,this.label.html(""),this.mode==_)return this.frameIndex=0,this.setBeginEnd(this.deltaFrame(0)),this.display.animationStart(),void this.doNext();this.fullRange()&&(this.end=this.makeDate(new Date(this.begin.value+this.window))),this.display.animationStart()}this.doNext()}},stopAnimation:function(){this.btnRun&&this.btnRun.html(HU.getIconImage(ICON_PLAY)),this.running=!1},setDateRange:function(e,t){this.setBegin(e),this.setEnd(t),this.stopAnimation(),this.updateUI()},dateRangeChanged:function(e){this.applyAnimation(e),this.display.getDisplayManager().notifyEvent(DisplayEvent.animationChanged,this.display,{begin:this.begin,end:this.end});let t=this.dateToRecordMap[this.begin];t&&this.display.getProperty("animationPropagateRecordSelection",!1)&&this.display.getDisplayManager().notifyEvent(DisplayEvent.recordSelection,this,{record:t})},applyAnimation:function(e){this.applyTimeout&&clearTimeout(this.applyTimeout),this.applyTimeout=setTimeout((()=>{this.applyTimeout=null,this.display.animationApply(this),this.updateUI()}),20)},setRecordListHighlight:function(e){this.recordListHighlight=e,this.updateTicks()},zoomReset:function(){this.originaDateMin&&(this.dateMax=this.originaDateMax,this.dateMin=this.originaDateMin,this.updateTicks(),this.updateLabels())},zoom:function(e){let t=this.dateMax.getTime()-this.dateMin.getTime(),i=t-t*(e?.9:1.1);this.originaDateMin||(this.originaDateMin=this.dateMin,this.originaDateMax=this.dateMax),this.dateMin=this.makeDate(new Date(this.dateMin.getTime()+i)),this.dateMax=this.makeDate(new Date(this.dateMax.getTime()-i)),this.updateTicks(),this.updateLabels()},updateTicks:function(){let t=!1;if(this.tickCount=0,!this.records||!this.display.getProperty("animationShowTicks",!0))return;this.highlightRecords={},this.recordListHighlight&&this.recordListHighlight.forEach((e=>{this.highlightRecords[e.getId()]=!0}));let i=this.display.getProperty("animationTickStyle",""),s="",l=this.dateMin.getTime(),a=this.dateMax.getTime(),r={};new Date;for(let e=0;e<this.records.length;e++){let t,o=this.records[e];if(this.useIndex)t=e;else{if(!o.getDate())continue;if(t=o.getDate().getTime(),r[t])continue;r[t]=!0}if(t<l)continue;if(t>a)continue;this.tickCount++;let n=(t-l)/(a-l)*100,h=this.formatAnimationDate(o.getDate()),d="display-animation-tick";this.highlightRecords[o.getId()]&&(d+=" display-animation-tick-highlight-base "),s+=HU.div([ATTR_ID,this.display.getId()+"-"+o.getId(),ATTR_CLASS,d,ATTR_STYLE,HU.css(CSS_HEIGHT,this.tickHeight,CSS_LEFT,HU.perc(n))+i,ATTR_TITLE,h,ATTR_RECORD_ID,o.getId()],"")}new Date;this.jq(h).html(s);new Date;let o=e.getProperty("animationHighlightRecord",!1),n=e.getProperty("animationSelectRecord",!0);this.ticks=this.jq(h).find(".display-animation-tick");let d=this;this.display.makeTooltips(this.ticks,this.records,((e,t)=>{if(d.display.animationLastRecordSelectTime){if((new Date).getTime()-d.display.animationLastRecordSelectTime.getTime()<1500)return!1}return t&&o&&(n&&d.display.propagateEventRecordSelection({select:!1,record:null}),this.display.handleEventRecordHighlight(this,{highlight:e,record:t,skipAnimation:!0})),!0}),null,o),n&&this.display.makeRecordSelect(this.ticks,this.display.makeIdToRecords(this.records),(e=>{d.display.animationLastRecordSelectTime=new Date}));new Date},updateUI:function(e){e||this.makeSlider&&(this.jq(n).slider("values",0,this.begin.getTime()),this.jq(n).slider("values",1,this.end.getTime())),this.updateLabels(),this.end.getTime()<=this.dateMax.getTime()?this.running&&setTimeout((()=>{this.running&&this.doNext()}),this.speed):(this.running=!1,this.inAnimation=!1,this.btnRun&&this.btnRun.html(HU.getIconImage(ICON_PLAY)))},makeLabel:function(e){return HU.span([ATTR_STYLE,HU.css(CSS_FONT_SIZE,this.labelSize)+this.labelStyle],e)},applyLabelTemplate:function(e){if(this.labelTemplate&&e&&e.length){let t=e[0],i=this.display.applyRecordTemplate(t,null,null,this.labelTemplate);this.label.html(this.makeLabel(i))}},updateLabels:function(){if(this.label)if(this.makeSlider){if(this.labelTemplate)return;this.mode==_&&this.begin.getTime()==this.end.getTime()?this.label.html(this.makeLabel(this.formatAnimationDate(this.begin))):this.label.html(this.makeLabel(this.formatAnimationDate(this.begin)+" - "+this.formatAnimationDate(this.end)))}else this.label.html(HU.leftCenterRight(this.makeLabel(this.formatAnimationDate(this.dateMin)),this.makeLabel("# "+this.tickCount),this.makeLabel(this.formatAnimationDate(this.dateMax))))},formatAnimationDate:function(e,t,i){if(Utils.isDefined(e.index))return"#"+(e.index+1);e.date&&(e=e.date);let s=this.display.getTimeZoneOffset(),l=this.display.getTimeZone();s&&(i&&console.log("date before:"+e.toUTCString()),e=Utils.createDate(e,-s),i&&console.log("date after:"+e.toUTCString()));let a=Utils.formatDateWithFormat(e,t||this.dateFormat,!0);return l?a+" "+l:a}})}var debugColorBy=!1;function ColorByInfo(e,t,i,s,l,a,r,o,n,h){this.properties=n||{},s||(s="colorBy"),Utils.isDefined(this.properties.minValue)&&(this.properties.hasMinValue=!0),Utils.isDefined(this.properties.maxValue)&&(this.properties.hasMaxValue=!0),r?Array.isArray(r)||(r=[r]):r=["colorBy",""],$.extend(this,{display:e,fieldProp:s,fieldValue:e.getProperty(s),propPrefix:r,colorHistory:{}});let d=this.getProperty(s||"colorBy",null);if(null==o&&(o=s.getId?s:e.getFieldById(null,d)),o&&(this.field=o,r=[o.getId()+".",""],d=o.getId(),this.propPrefix.unshift(o.getId()+".colorBy"),this.propPrefix.push("colorBy")),$.extend(this,{display:e,id:d,fields:t,field:o,colorThresholdField:e.getFieldById(null,e.getProperty("colorThresholdField")),literal:e.getProperty("colorByLiteral"),aboveColor:e.getProperty("colorThresholdAbove","red"),belowColor:e.getProperty("colorThresholdBelow","blue"),nullColor:e.getProperty("nullColor",null),excludeZero:this.getProperty(PROP_EXCLUDE_ZERO,!1),overrideRange:this.getProperty("overrideColorRange",!1),inverse:this.getProperty("Inverse",!1),origRange:null,origMinValue:0,origMaxValue:0,minValue:0,maxValue:0,toMinValue:0,toMaxValue:100,isString:this.properties.isString,stringMap:null,colorByMap:{},colorByValues:[],colorByMinPerc:this.getProperty("MinPercentile",-1),colorByMaxPerc:this.getProperty("MaxPercentile",-1),colorByOffset:0,pctFields:null,compareFields:e.getFieldsByIds(null,this.getProperty("CompareFields",""))}),h&&h.colorOverflow,"year"==this.fieldValue){let e={};this.dates=[],i.forEach((t=>{if(!t.getDate())return;let i=t.getDate().getUTCFullYear();e[i]||(e[i]=!0,this.dates.push(i))})),this.dates.sort(),this.setRange(this.dates[0],this.dates[this.dates.length-1])}if(this.convertAlpha=this.getProperty("convertColorAlpha",!1),this.alphaMin=this.getProperty("alphaMin"),this.alphaMax=this.getProperty("alphaMax"),this.hasAlphaMin=Utils.isDefined(this.alphaMin),this.hasAlphaMax=Utils.isDefined(this.alphaMax),this.convertAlpha){if(Utils.isDefined(this.getProperty("alphaSourceMin")))this.alphaSourceMin=+this.getProperty("alphaSourceMin",40),this.alphaSourceMax=+this.getProperty("alphaSourceMax",80);else{var g=0,p=0;i.forEach(((e,t)=>{var i=e.getData();if(this.compareFields.length>0)this.compareFields.map(((e,s)=>{var l=i[e.getIndex()];isNaN(l)||(g=0==t&&0==s?l:Math.min(g,l),p=0==t&&0==s?l:Math.max(p,l))}));else if(this.index=0){var s=i[this.index];if(isNaN(s))return;g=0==t?s:Math.min(g,s),p=0==t?s:Math.max(p,s)}})),this.alphaSourceMin=g,this.alphaSourceMax=p}this.alphaTargetMin=+this.getProperty("alphaTargetMin",0),this.alphaTargetMax=+this.getProperty("alphaTargetMax",1)}if(this.convertIntensity=this.getProperty("convertColorIntensity",!1),this.convertIntensity){if(Utils.isDefined(this.getProperty("intensitySourceMin")))this.intensitySourceMin=+this.getProperty("intensitySourceMin",80),this.intensitySourceMax=+this.getProperty("intensitySourceMax",40);else{g=0,p=0;i.forEach(((e,t)=>{var i=e.getData();if(this.compareFields.length>0)this.compareFields.map(((e,s)=>{var l=i[e.getIndex()];isNaN(l)||(g=0==t&&0==s?l:Math.min(g,l),p=0==t&&0==s?l:Math.max(p,l))}));else if(this.index=0){var s=i[this.index];if(isNaN(s))return;g=0==t?s:Math.min(g,s),p=0==t?s:Math.max(p,s)}})),this.intensitySourceMin=g,this.intensitySourceMax=p}this.intensityTargetMin=+this.getProperty("intensityTargetMin",1),this.intensityTargetMax=+this.getProperty("intensityTargetMax",0)}null!=this.display.percentFields&&(this.pctFields=this.display.percentFields.split(","));let c=null;if(d){let e=this.display.getProperty(d+".colors");e&&(c=e.split(","))}if(a&&(this.id=a.id),c||(a?Array.isArray(a)?c=a:a.steps||(c=a.colors):c=this.display.getColorTable(!0,[this.properties.colorTableProperty,d+".colorTable","colorTable"])),!c){let e=a??this.display.getColorTable(!1,[this.properties.colorTableProperty,d+".colorTable","colorTable"]);e&&(this.colorTableSteps=e.steps)}if(!c){var u=this.getProperty(d+".colors");u&&(c=u.split(","))}c||(c=this.display.getColorTable(!0)),this.colors=c,this.hasField();let T=this.display.getColorScale();if(T&&(this.colorScale=[],T.split(";").forEach((e=>{let t=e.split(",");this.colorScale.push({min:+t[0],max:+t[1],color1:t[2],color2:t[3]})})),this.colorScaleInterval=e=>{for(let t=0;t<this.colorScale.length;t++){let i=this.colorScale[t];if(e<=i.max)return d3.scaleLinear().domain([i.min,i.max]).range([i.color1,i.color2])(e)}return isNaN(e)||console.log("color scale miss",e),null}),!this.colors&&this.display.colors&&this.display.colors.length>0&&(this.colors=source.colors,1==this.colors.length&&Utils.ColorTables[this.colors[0]]&&(this.colors=Utils.ColorTables[this.colors[0]].colors)),null==this.colors&&(this.colors=Utils.ColorTables.inversegrayscale.colors),!this.field)for(var f=0;f<t.length;f++){var y=t[f];y.getId()!=this.id&&"#"+(f+1)!=this.id||(this.field=y)}this.field||("hour"==this.id?this.timeField="hour":"day"==this.id&&(this.timeField="day")),this.field&&this.field.isString()&&(this.isString=!0),this.index=null!=this.field?this.field.getIndex():-1,this.stringMap=this.display.getColorByMap(l);let m=[],_={};if(this.index>=0||this.timeField){let e=NaN,t=NaN;i.forEach(((i,s)=>{let l,a=i.getData();l=this.timeField?"hour"==this.timeField?i.getTime().getHours():i.getTime().getTime():a[this.index],this.isString?_[l]||(_[l]=!0,m.push(l)):this.excludeZero&&0===l||(e=Utils.min(e,l),t=Utils.max(t,l))})),this.minValue=e,this.maxValue=t,this.origRange=[e,t]}m.length>0&&(m.sort(((e,t)=>e.toString().localeCompare(t.toString()))),m.forEach((e=>{if(!Utils.isDefined(this.colorByMap[e])){let t,i=this.colorByValues.length;this.lastColorByMap&&this.lastColorByMap[e]?t=this.lastColorByMap[e]:(i>=this.colors.length&&(this.colorOverflow=!0,i%=this.colors.length),t=this.colors[i]),this.colorByValues.push({value:e,color:t}),this.colorByMap[e]=t,this.setRange(1,this.colorByValues.length,!0)}}))),this.display.showPercent&&this.setRange(0,100,!0);var S=this.getProperty("Steps");S&&(this.steps=S.split(",")),this.colorByLog=this.getProperty("Log",!1),this.colorByLog10=this.getProperty("Log10",!1),this.colorByLog2=this.getProperty("Log2",!1),this.colorByLog?this.colorByFunc=Math.log:this.colorByLog10?this.colorByFunc=Math.log10:this.colorByLog2&&(this.colorByFunc=Math.log2),this.setRange(this.getProperty("Min",this.minValue),this.getProperty("Max",this.maxValue),!0),this.range=this.maxValue-this.minValue,this.toMinValue=this.getProperty("ToMin",this.toMinValue),this.toMaxValue=this.getProperty("ToMax",this.toMaxValue),this.enabled=null!=this.timeField||this.getProperty("doColorBy",!0)&&this.index>=0,this.initDisplayCalled=!1}function SizeBy(e,t,i){this.display=e,t||(t=e.filterData());let s=this.display.getPointData(),l=s?s.getRecordFields():[];$.extend(this,{id:this.display.getProperty(i||"sizeBy"),minValue:0,maxValue:0,threshold:parseFloat(this.display.getProperty("sizeByThreshold",NaN)),field:null,index:-1,isString:!1,stringMap:{}});let a=this.display.getProperty("sizeByMap");if(a){let e=a.split(",");for(let t=0;t<e.length;t++){let i=e[t].split(":");i.length>1&&(this.stringMap[i[0]]=i[1])}}for(let e=0;e<l.length;e++){let t=l[e];t.getId()!=this.id&&"#"+(e+1)!=this.id||(this.field=t,t.isString()&&(this.isString=!0))}if(this.index=null!=this.field?this.field.getIndex():-1,!this.isString&&this.field){let e=this.display.getColumnValues(t,this.field);this.minValue=e.min,this.maxValue=e.max,Utils.isDefined(this.display.getProperty("sizeByMin"))&&(this.minValue=+this.display.getProperty("sizeByMin",0)),Utils.isDefined(this.display.getProperty("sizeByMax"))&&(this.maxValue=+this.display.getProperty("sizeByMax",0))}this.display.getProperty("sizeBySteps")&&(this.steps=[],this.display.getProperty("sizeBySteps").split(",").forEach((e=>{let[t,i]=e.split(":");this.steps.push({value:+t,size:+i})}))),this.radiusMin=parseFloat(this.display.getProperty("sizeByRadiusMin",-1)),this.radiusMax=parseFloat(this.display.getProperty("sizeByRadiusMax",-1)),this.offset=0,this.sizeByLog=this.display.getProperty("sizeByLog",!1),this.origMinValue=this.minValue,this.origMaxValue=this.maxValue,this.maxValue=Math.max(this.minValue,this.maxValue),this.sizeByLog&&(this.func=Math.log,this.minValue<1&&(this.offset=1-this.minValue),this.minValue=this.func(this.minValue+this.offset),this.maxValue=this.func(this.maxValue+this.offset))}function Glyph(display,scale,fields,records,args,attrs){var props=this.properties=this.p={};$.extend(this,{display:display,records:records,type:"label",toString:function(){return this.properties.type}}),$.extend(this.properties,{dx:0,dy:0,label:"",baseHeight:0,baseWidth:0,width:8,fill:!0,stroke:!0}),$.extend(this.properties,args??{});let cnt=0;attrs.split(",").forEach((e=>{let t=e.split(":"),i=t[0],s="";if(Utils.stringDefined(i)||Utils.stringDefined(s)){if(0==cnt&&1==t.length)s=i,i="type";else for(let e=1;e<t.length;e++)e>1&&(s+=":"),s+=t[e];cnt++,s=s.replace(/_nl_/g,"\n").replace(/_colon_/g,":").replace(/_comma_/g,",").replace(/\\n/g,"\n"),"true"==s?s=!0:"false"==s&&(s=!1),this.properties[i]=s}})),(props.glyphField||props.defaultField)&&["requiredField","colorBy","label"].forEach((e=>{props[e]&&(props[e]=props[e].replace(/\${_field}/g,props.glyphField??props.defaultField))})),props.labelBy&&(props.labelField=display.getFieldById(fields,props.labelBy),props.labelField||console.log("Could not find label field: "+props.labelBy)),"image"==props.type&&(props.imageField=display.getFieldById(fields,props.imageField),props.myImage=new Image),props.scale=scale,null==props.height&&("3dbar"==props.type?props.height=20:props.height=8),null==props.pos&&("3dbar"==props.type?props.color="blue":"rect"==props.type?props.pos="c":props.pos="nw");let cvrt=this.cvrt=s=>{if(!isNaN(+s))return+s;s=String(s),s=s.replace(/canvasWidth2/g,""+props.canvasWidth/2).replace(/canvasWidth/g,props.canvasWidth),s=s.replace(/cw2/g,""+props.canvasWidth/2).replace(/cw/g,props.canvasWidth),s=s.replace(/canvasHeight2/g,""+props.canvasHeight/2).replace(/canvasHeight/g,props.canvasHeight),s=s.replace(/ch2/g,""+props.canvasHeight/2).replace(/ch/g,props.canvasHeight),s=s.replace(/width2/g,""+props.width/2).replace(/width/g,props.width),s=s.replace(/height2/g,""+props.height/2).replace(/height/g,props.width);try{s=eval(s)}catch(e){console.error("error evaling glyph value:"+s,e)}return s};if(props.width=cvrt(props.width),props.height=cvrt(props.height),props.dx=cvrt(props.dx),props.dy=cvrt(props.dy),props.baseWidth=+props.baseWidth,props.width=+props.width*scale,props.height=+props.height*scale,props.dx=+props.dx*scale,props.dy=+props.dy*scale,props.sizeBy)if(props.sizeByField=display.getFieldById(fields,props.sizeBy),props.sizeByField){let e={Min:props.sizeByMin,Max:props.sizeByMax};props.sizeByInfo=new ColorByInfo(display,fields,records,props.sizeBy,props.sizeBy,null,props.sizeBy,props.sizeByField,e)}else console.log("Could not find sizeBy field:"+props.sizeBy);if(props.wasNaN=!1,props.dontShow=!1,!props.colorByInfo&&props.colorBy){props.colorByField=display.getFieldById(fields,props.colorBy);let e=props.colorTable?display.getColorTableInner(!1,props.colorTable):null;if(props.colorByField){let t={Min:props.colorByMin,Max:props.colorByMax};props.colorByInfo=new ColorByInfo(display,fields,records,props.colorBy,props.colorBy+".colorByMap",e,props.colorBy,props.colorByField,t)}else{let e="Could not find colorBy field:"+props.colorBy;this.properties.mapGlyph&&(e+=" for: "+this.properties.mapGlyph.getName()),console.log(e),console.log("Fields:"+fields),props.dontShow=!0}}props.requiredField&&((this.theRequiredField=display.getFieldById(fields,props.requiredField))||(props.dontShow=!0))}ColorByInfo.prototype={initDisplay:function(){this.filterHighlight=this.display.getFilterHighlight(),this.initDisplayCalled=!0},getId:function(){return this.id},getProperty:function(e,t,i){if(this.properties[e])return this.properties[e];this.debug&&console.log("getProperty:"+e);for(let t=0;t<this.propPrefix.length;t++){this.display.debugGetProperty=i,this.debug&&console.log("\t"+this.propPrefix[t]+e);let s=this.display.getProperty(this.propPrefix[t]+e);if(this.display.debugGetProperty=!1,Utils.isDefined(s))return s}return t},isEnabled:function(){return this.enabled||this.getDoCount()},getField:function(){return this.field},getColors:function(){return this.colors},displayColorTable:function(e,t,i){if(this.getProperty("showColorTable",!0)){if(i=i??ID_COLORTABLE,this.compareFields.length>0){let e="";this.compareFields.forEach(((t,i)=>{e+=HU.div([ATTR_STYLE,HU.css(CSS_DISPLAY,DISPLAY_INLINE_BLOCK,CSS_WIDTH,HU.px(15),CSS_HEIGHT,HU.px(15),CSS_BACKGROUND,this.colors[i])])+" "+t.getLabel()+" "})),this.display.jq(i).html(HU.div([ATTR_STYLE,HU.css(CSS_TEXT_ALIGN,ALIGN_CENTER,CSS_MARGIN_TOP,HU.px(5))],e))}if(t||!(this.index<0)){if(this.colorScale){let e=HU.open(TAG_TABLE,[ATTR_WIDTH,HU.perc(100)])+HU.open(TAG_TR),t=4,s=HU.perc(Math.round(parseFloat(100/(this.colorScale.length*t))));return this.colorScale.forEach((i=>{for(let l=0;l<t;l++){let a=i.min+(i.max-i.min)/t*l,r=this.colorScaleInterval(a),o=SPACE;0==l?o=i.min:l==t-1&&(o=i.max);let n=Utils.getForegroundColor(r);e+=HU.tag(TAG_TD,[ATTR_CLASS,"display-colorscale-item",ATTR_TITLE,a,ATTR_WIDTH,s,ATTR_STYLE,HU.css(CSS_COLOR,n,CSS_BACKGROUND,r)],o)}})),e+=HU.close(TAG_TR,TAG_TABLE),void this.display.displayColorTableHtml(e,i)}if(this.stringMap){let t=[];for(var s in this.colorByValues=[],this.stringMap){let e=this.stringMap[s];this.colorByValues.push({value:s,color:e}),t.push(e)}this.display.displayColorTable(t,i,this.origMinValue,this.origMaxValue,{field:this.field,colorByInfo:this,width:e,stringValues:this.colorByValues})}else{let t=this.colors,a=null;if(this.colorTableSteps&&(t=[],a=[],this.colorTableSteps.forEach((e=>{t.push(e.color),a.push({value:e.label??e.min+" - "+e.max,color:e.color})}))),this.getProperty("clipColorTable",!0)&&this.colorByValues.length){var l=[];for(s=0;s<this.colorByValues.length&&s<t.length;s++)l.push(this.colors[s]);t=l}null==a&&(a=this.colorByValues.map((e=>e)),a.sort(((e,t)=>e.value.toString().localeCompare(t.value.toString()))));let r=e=>this.doingDates?new Date(e):e;this.display.displayColorTable(t,i,r(this.origMinValue),r(this.origMaxValue),{label:this.getDoCount()?"Count":null,field:this.field,colorByInfo:this,width:e,stringValues:a})}}}},resetRange:function(){this.origRange&&this.setRange(this.origRange[0],this.origRange[1])},setRange:function(e,t,i){this.display.getColorByAllRecords()&&!i||(this.display.getProperty("useDataForColorRange")&&this.origRange&&(e=this.origRange[0],t=this.origRange[1]),displayDebug.colorTable&&console.log(" setRange: min:"+e+" max:"+t),!i&&this.overrideRange||(this.origMinValue=e,this.origMaxValue=t,this.colorByFunc&&(e<0?this.colorByOffset=-e:0==e&&(this.colorByOffset=1),e=this.colorByFunc(e+this.colorByOffset),t=this.colorByFunc(t+this.colorByOffset)),this.minValue=e,this.maxValue=t,this.range=this.maxValue-this.minValue,this.origRange||(this.origRange=[e,t])))},getValuePercent:function(e){let t=(e-this.minValue)/this.range;return this.inverse&&(t=1-t),t},scaleToValue:function(e){let t=this.getValuePercent(e);return this.toMinValue+t*(this.toMaxValue-this.toMinValue)},getDoCount:function(){return this.doCount},getDoTotal:function(){return this.doTotalCount},getDoEnum:function(){return this.doEnum},setDoEnum:function(e){this.isString=!0,this.doEnum=e},setDoTotal:function(e){this.doTotalCount=e},setDoCount:function(e,t){this.doCount=!0,this.minValue=e,this.maxValue=t,this.range=this.maxValue-this.minValue,this.origMinValue=e,this.origMaxValue=t},isValueOk:function(e){return!(this.properties.hasMinValue&&e<this.properties.minValue)&&(!(this.properties.hasMaxValue&&e>this.properties.maxValue)&&!isNaN(e))},doAverage:function(e){let t=0,i=0;return e.forEach((e=>{let s=e.getData()[this.index];this.isValueOk(s)&&(t+=s,i++)})),t/i},processEnum:function(e){let t={};e.forEach((e=>{let i=e.getData()[this.index];t[i]||(t[i]=0),t[i]++}));let i=0,s=null;return Object.keys(t).forEach((e=>{t[e]>i&&(s=e,i=t[e])})),s},doTotal:function(e){let t=0;return e.forEach((e=>{let i=e.getData()[this.index];this.isValueOk(i)&&(t+=i)})),t},getColorFromRecord:function(e,t,i,s){if(this.lastValue=NaN,this.initDisplayCalled||this.initDisplay(),this.filterHighlight&&!e.isHighlight(this.display))return this.display.getUnhighlightColor();let l=e;if(Array.isArray(l)?e=l[0]:l=[l],this.colorThresholdField&&this.display.selectedRecord){let e=this.display.selectedRecord.getValue(this.colorThresholdField.getIndex());return l[0].getValue(this.colorThresholdField.getIndex())>e?this.aboveColor:this.belowColor}if(this.index>=0||this.getDoCount()){let t;if(t=this.getDoEnum()?this.processEnum(l):l.length>1?this.getDoTotal()?this.doTotal(l):this.doAverage(l):l[0].getData()[this.index],t?.getTime&&(t=t.getTime(),this.doingDates=!0),t=this.getDoCount()?l.length:t,e.setDisplayProperty(this.display.getId(),"colorByValue",t),this.lastValue=t,isNaN(t)&&this.nullColor)return this.nullColor;let s=this.getColor(t,e,i);return debugColorBy&&console.log(t,s),s}if(this.timeField){let e;return e="hour"==this.timeField?l[0].getTime().getHours():l[0].getTime().getTime(),this.lastValue=e,this.getColor(e,l[0],i)}if("year"==this.fieldValue&&l[0].getDate()){let e=l[0].getDate().getUTCFullYear();return this.lastValue=e,this.getColor(e,l[0])}return t},hasField:function(){return this.index>=0},getColor:function(e,t,i){if(this.literal)return(e=String(e)).indexOf("(")&&(e=e.replace(/\(.*\)/,"")),e;if(this.colorScaleInterval)return this.colorScaleInterval(e);let s=this.getColorInner(e,t);return null==s&&(s=this.nullColor),s},getColorInner:function(e,t,i){if(this.colorTableSteps){for(let t=0;t<this.colorTableSteps.length;t++){let i=this.colorTableSteps[t];if(e>=i.min&&e<=i.max)return i.color}if(e<=this.colorTableSteps[0].min)return this.colorTableSteps[0].color;if(e>=this.colorTableSteps[this.colorTableSteps.length-1].max)return this.colorTableSteps[this.colorTableSteps.length-1].color}if(this.initDisplayCalled||this.initDisplay(),this.filterHighlight&&t&&!t.isHighlight(this.display))return this.display.getUnhighlightColor();let s=.5;if(this.showPercent){let i=0,l=t.getData();for(let e=0;e<l.length;e++){let t=this.fields[e].isNumeric()&&!this.fields[e].isFieldGeo();t&&null!=this.pctFields&&(t=this.pctFields.indexOf(this.fields[e].getId())>=0||this.pctFields.indexOf("#"+(e+1))>=0),t&&(i+=l[e])}0!=i&&(s=e/i*100,s=(s-this.minValue)/(this.maxValue-this.minValue))}else{let t=e;if(this.stringMap){let t=this.stringMap[e];return Utils.isDefined(t)?t:this.stringMap.default}if(this.isString&&(color=this.colorByMap[t],color))return color;if(t+=this.colorByOffset,this.colorByFunc&&t>0&&(t=this.colorByFunc(t)),isNaN(t))return this.nullColor;s=this.range?(t-this.minValue)/this.range:.5}let l=0;if(this.steps)for(;l<this.steps.length&&!(e<=this.steps[l]);l++);else l=parseInt(s*this.colors.length);if(isNaN(l))return debugColorBy&&console.log("v:"+e+" index:"+l+" null color:"+this.nullColor),this.nullColor;if(l>=this.colors.length?l=this.colors.length-1:l<0&&(l=0),this.stringMap){let t=this.stringMap[e];return Utils.isDefined(t)?t:this.stringMap.default}return this.colors[l]},convertColor:function(e,t){return e=this.convertColorIntensity(e,t),e=this.convertColorAlpha(e,t)},convertColorIntensity:function(e,t){if(!this.convertIntensity)return e;return percent=(t-this.intensitySourceMin)/(this.intensitySourceMax-this.intensitySourceMin),intensity=this.intensityTargetMin+percent*(this.intensityTargetMax-this.intensityTargetMin),Utils.pSBC(intensity,e)||e},xcnt:0,convertColorAlpha:function(e,t){if(this.hasAlphaMin&&t<=this.alphaMin){return Utils.addAlphaToColor(e,0)||e}if(this.hasAlphaMax&&t>=this.alphaMax){return Utils.addAlphaToColor(e,0)||e}if(!this.convertAlpha)return e;return percent=(t-this.alphaSourceMin)/(this.alphaSourceMax-this.alphaSourceMin),alpha=this.alphaTargetMin+percent*(this.alphaTargetMax-this.alphaTargetMin),Utils.addAlphaToColor(e,alpha)||e}},SizeBy.prototype={getMaxSize:function(){return this.getSizeFromValue(this.origMaxValue)},getSize:function(e,t,i){if(this.index<=0)return t;let s=e[this.index];return this.getSizeFromValue(s,i,!1)},getSizeFromValue:function(e,t,i){if(this.steps){if(e<=this.steps[0].value)return this.steps[0].size;for(let t=1;t<this.steps.length;t++)if(e>this.steps[t-1].value&&e<=this.steps[t].value)return this.steps[t].size;return this.steps[this.steps.length-1].size}if(this.isString){let i;if(Utils.isDefined(this.stringMap[e])){i=parseInt(this.stringMap[e])}else if(Utils.isDefined(this.stringMap["*"])){i=parseInt(this.stringMap["*"])}return isNaN(i)&&(i=this.radiusMin),t&&t(NaN,i),i}{let s=this.maxValue-this.minValue,l=e+this.offset;this.func&&(l=this.func(l));let a,r=0==s?NaN:(l-this.minValue)/s;return a=this.radiusMax>=0&&this.radiusMin>=0?Math.round(this.radiusMin+r*(this.radiusMax-this.radiusMin)):6+parseInt(15*r),i&&console.log("min:"+this.minValue+" max:"+this.maxValue+" value:"+e+" percent:"+r+" v:"+l+" size:"+a),isNaN(a)&&(a=this.radiusMin),t&&t(r,a),a}},getLegend:function(e,t,i){let s="";if(this.index<0)return"";if(this.steps)this.steps.forEach((e=>{let l=HU.px(2*e.size),a=e.value;s+=HU.div([ATTR_CLASS,"display-size-legend-item"],HU.center(HU.div([ATTR_STYLE,HU.css(CSS_HEIGHT,l,CSS_WIDTH,l,CSS_BACKGROUND_COLOR,t??"#bbb",CSS_BORDER_RADIUS,HU.perc(50))]))+a),i&&(s+=HU.br())}));else for(let l=0;l<=e;l++){let a=this.origMinValue+l/e*(this.origMaxValue-this.origMinValue),r=this.getSizeFromValue(a,null,!1);if(isNaN(r)||0==r)continue;a=this.display.formatNumber(a);let o=HU.px(2*r);s+=HU.div([ATTR_CLASS,"display-size-legend-item"],HU.center(HU.div([ATTR_STYLE,HU.css(CSS_HEIGHT,o,CSS_WIDTH,o,CSS_BACKGROUND_COLOR,t??"#bbb",CSS_BORDER_RADIUS,HU.perc(50))]))+a),i&&(s+=HU.br())}return HU.div([ATTR_CLASS,"display-size-legend"],s)}},Glyph.prototype={okToShow:function(){return!this.properties.dontShow},hadMissingValue:function(){return this.properties.wasNaN},getColorByInfo:function(){return this.properties.colorByInfo},isImage:function(){return"image"==this.properties.type},draw:function(e,t,i,s,l,a,r){let o=this.properties;if(o.dontShow)return;r=o.debug??r;let n=null;if(o.colorByInfo)if(o.colorByField){let e=a.record.getValue(o.colorByField.getIndex());isNaN(e)&&(o.wasNaN=!0),n=o.colorByInfo.getColor(e)}else a.colorValue&&(n=o.colorByInfo.getColor(a.colorValue),n=o.colorByInfo.convertColor(n,a.colorValue));let h=1;if(o.sizeByInfo){let e=a.record.getValue(o.sizeByField.getIndex());isNaN(e)&&(o.wasNaN=!0),h=o.sizeByInfo.getValuePercent(e)}if(a.alphaByCount&&a.cell&&a.grid&&a.grid.maxCount!=a.grid.minCount){let e=(a.cell.count-a.grid.minCount)/(a.grid.maxCount-a.grid.minCount);n=Utils.addAlphaToColor(c,e)}if(i.fillStyle=n||o.fillStyle||o.color||COLOR_TRANSPARENT,i.strokeStyle=o.strokeStyle??o.color??e.strokeStyle??COLOR_BLACK,i.lineWidth=o.lineWidth??o.strokeWidth??e.lineWidth??1,"label"==o.type){let e=o.labelField?a.record.getValue(o.labelField.getIndex()):o.label;if(null===e)return void console.log("No label value");let t=String(e);a.record&&(t=this.display.applyRecordTemplate(a.record,null,null,t,{records:a.records,findNonNan:a.findNonNan,entryname:o.entryname,unit:o.unit}),t.indexOf("NaN")>=0&&(o.wasNaN=!0)),isNaN(parseFloat(t))||(o.valueScale&&(t*=+o.valueScale),Utils.isDefined(o.decimals)&&(t=number_format(t,+o.decimals))),o.template&&(t=o.template.replace("${value}",t)),t=t.replace(/\${.*}/g,""),o.prefix&&(t=o.prefix.replaceAll("_space_"," ")+t),o.suffix&&(t+=o.suffix.replaceAll("_space_"," ")),t=t.replace(/_nl_/g,"\n").replace(/\\n/g,"\n").split("\n"),o.font&&o.font.match(/\d+(px|pt)$/)&&(o.font=o.font+" sans-serif"),i.font=o.font??this.display.getProperty("glyphFont","12pt sans-serif"),i.fillStyle=i.strokeStyle=n||o.color||this.display.getProperty("glyphColor",COLOR_BLACK),r&&console.log("glyph label: font="+i.font+" fill:"+i.fillStyle+" stroke:"+i.strokeStyle);let h=0,d=3,g=0,p=+(o.pady??2);t.forEach(((e,t)=>{let s=i.measureText(e);t>0&&(h+=d),g=Math.max(g,s.width),h+=s.actualBoundingBoxAscent+s.actualBoundingBoxDescent}));let c=Utils.translatePoint(s,l,g,h,o.pos,{dx:o.dx,dy:o.dy});r&&console.log("position:",{point:c,x:s,y:l,text_width:g,text_height:h,pos:o.pos,dx:o.dx,dy:o.dy});let u=o.bg;t.forEach((e=>{let t=i.measureText(e);if(u){i.fillStyle=u;let e=+(o.bgpad??6);r&&console.log("drawing background:"+u+" padding:"+e);let s=t.actualBoundingBoxAscent+t.actualBoundingBoxDescent,l=t.width;i.fillRect(c.x-e,c.y-s-e,l+2*e,s+2*e)}i.fillStyle=i.strokeStyle=n||o.color||this.display.getProperty("glyphColor",COLOR_BLACK),t=i.measureText(e);let s=t.actualBoundingBoxAscent+t.actualBoundingBoxDescent;r&&console.log("draw text:"+e+" x:"+c.x+" y:"+(c.y+s)),i.fillText(e,c.x,c.y+s),c.y+=p+t.actualBoundingBoxAscent+t.actualBoundingBoxDescent+d}))}else if("circle"==o.type){i.beginPath();let e=o.width*h+o.baseWidth,t=Utils.translatePoint(s,l,e,e,o.pos,{dx:o.dx,dy:o.dy}),a=t.x+e/2,n=t.y+e/2;r&&console.log("draw circle",{cx:a,cy:n,w:e}),i.arc(a,n,e/2,0,2*Math.PI),o.fill&&i.fill(),o.stroke&&i.stroke()}else if("rect"==o.type){let e=Utils.translatePoint(s,l,o.width,o.height,o.pos,{dx:o.dx,dy:o.dy});o.fill&&i.fillRect(e.x,e.y,o.width,o.height),o.stroke&&i.strokeRect(e.x,e.y,o.width,o.height)}else if(this.isImage()){let e=o.url;if(!e&&o.imageField&&(e=a.record.getValue(o.imageField.getIndex())),e){e=e.replace("${root}",RamaddaUtil.getBaseUrl()),o.width=+(o.width??50),o.height=+(o.height??50);let t=Utils.translatePoint(s,l,o.width,o.height,o.pos,{dx:o.dx,dy:o.dy});o.debug&&console.log("image glyph:"+e,{pos:o.pos,pt:t,x:s,y:l,dx:o.dx,dy:o.dy,width:o.width,height:o.height});let a=new Image;a.src=e;let r=()=>{let e=i.globalAlpha;Utils.isDefined(this.properties.imageAlpha)&&(i.globalAlpha=this.properties.imageAlpha),i.drawImage(a,t.x,t.y,o.width,o.width),i.globalAlpha=e};if(!a.complete){let e=!1;return a.onload=()=>{r(),e=!0},()=>e}r()}else console.log("No url defined for glyph image")}else if("gauge"==o.type){let e=Utils.translatePoint(s,l,o.width,o.height,o.pos,{dx:o.dx,dy:o.dy});i.fillStyle=o.fillColor||"#F7F7F7",i.beginPath();let t=e.x+o.width/2,a=e.y+o.height;i.arc(t,a,o.width/2,1*Math.PI,0),i.fill(),i.strokeStyle=COLOR_BLACK,i.stroke(),i.beginPath(),i.beginPath();o.width;let r=180*h,n=t-.4*o.width,d=a,g=Utils.rotate(t,a,n,d,r);if(i.strokeStyle=o.color||COLOR_BLACK,i.lineWidth=o.lineWidth||2,i.moveTo(t,a),i.lineTo(g.x,g.y),i.stroke(),i.lineWidth=1,o.showLabel=!0,o.showLabel&&o.sizeByInfo){i.fillStyle=COLOR_BLACK;let e=String(o.sizeByInfo.minValue);i.font=o.font||"9pt arial";let s=i.measureText(e);i.fillText(e,t-o.width/2-s.width-2,a),i.fillText(o.sizeByInfo.maxValue,t+o.width/2+2,a)}}else if("line"==o.type){let e=this.cvrt(o.x1),t=this.cvrt(o.y1),s=this.cvrt(o.x2),l=this.cvrt(o.y2);i.strokeStyle=o.strokeStyle||COLOR_BLACK,i.beginPath(),i.moveTo(e,t),i.lineTo(s,l),i.stroke()}else if("3dbar"==o.type){let e=Utils.translatePoint(s,l,o.width,o.height,o.pos,{dx:o.dx,dy:o.dy}),a=h*o.height+parseFloat(o.baseHeight);i.fillStyle=n||o.color,i.strokeStyle=o.strokeStyle||COLOR_BLACK,this.draw3DRect(t,i,e.x,t.height-e.y-o.height,+o.width,a,+o.width)}else if("axis"==o.type){let e=Utils.translatePoint(s,l,o.width,o.height,o.pos,{dx:o.dx,dy:o.dy});o.height,parseFloat(o.baseHeight);i.strokeStyle=o.strokeStyle||COLOR_BLACK,i.beginPath(),i.moveTo(e.x,e.y),i.lineTo(e.x,e.y+o.height),i.lineTo(e.x+o.width,e.y+o.height),i.stroke()}else if("vector"==o.type){if(!o.sizeByInfo)return void console.log("make Vector: no sizeByInfo");i.strokeStyle=n||o.color;let t=a.record.getValue(o.sizeByField.getIndex());h=o.sizeByInfo.getValuePercent(t);let r=e.cellSizeH;e.lengthBy&&e.lengthBy.index>=0&&(r=e.lengthBy.scaleToValue(t));let d=s+r,g=l,p=e.display.getArrowLength();if(e.colorBy&&e.colorBy.index>=0){let i=180*e.colorBy.getValuePercent(t)+90;i*=Math.PI/360,d=r*Math.cos(i)-0*Math.sin(i),g=0*Math.cos(i)-r*Math.sin(i),d+=s,g+=l}p<=0&&(i.save(),i.fillStyle=COLOR_BLACK,i.beginPath(),i.arc(s,l,1,0,2*Math.PI),i.fill(),i.restore()),i.beginPath(),i.moveTo(s,l),i.lineTo(d,g),i.lineWidth=e.display.getLineWidth(),i.stroke(),p>0&&(i.beginPath(),this.drawArrow(i,s,l,d,g,p),i.stroke())}else if("tile"==o.type){let t=s+e.cellSizeX/2,r=l+e.cellSizeY/2;a.row%2==0&&(t+=e.cellSizeX/2,r-=e.cellSizeY/2);let o=e.cellSizeX/2,n=e.cellSizeY/2;i.beginPath();let h=Math.PI/2;i.moveTo(t+o*Math.cos(h),r+n*Math.sin(h));for(let e=0;e<7;e++)i.lineTo(t+o*Math.cos(h+2*e*Math.PI/6),r+n*Math.sin(h+2*e*Math.PI/6));i.strokeStyle=COLOR_BLACK,i.stroke()}else console.log("Unknown cell shape:"+o.type)},draw3DRect:function(e,t,i,s,l,a,r){let o=function(e,t,i){return function(){let s=Array.prototype.slice.call(arguments,0);e.beginPath();let l=s.pop();for(l&&e.moveTo(t.apply(void 0,l),i.apply(void 0,l));void 0!==(l=s.pop());)e.lineTo(t.apply(void 0,l),i.apply(void 0,l));e.closePath(),e.stroke(),e.fill()}}(t,(function(e,t,i){return e+i/2}),(function(e,t,i){return t+i/4}));t.save(),t.scale(1,-1),t.translate(0,-e.height),t.save(),t.translate(i,s);let n=t.fillStyle;t.fillStyle=Utils.pSBC(-.5,n),o([l,0,0],[l,0,r],[l,a,r],[l,a,0]),t.fillStyle=n,o([0,0,0],[0,a,0],[l,a,0],[l,0,0]),t.fillStyle=Utils.pSBC(.5,n),o([0,a,0],[0,a,r],[l,a,r],[l,a,0]),t.fillStyle=n,t.restore(),t.restore()},drawArrow:function(e,t,i,s,l,a){let r=s-t,o=l-i,n=Math.atan2(o,r);e.moveTo(t,i),e.lineTo(s,l),e.lineTo(s-a*Math.cos(n-Math.PI/6),l-a*Math.sin(n-Math.PI/6)),e.moveTo(s,l),e.lineTo(s-a*Math.cos(n+Math.PI/6),l-a*Math.sin(n+Math.PI/6))}};var displayDebug={getProperty:!1,loadPointJson:!1,pointDataLoaded:!1,notifyEvent:!1,notifyEventAll:!1,handleEventPropertyChanged:!1,getSelectedFields:!1,filterData:!1,getStandardData:!1,makeDataTable:!1,checkSearchBar:!1,handleNoData:!1,displayMapUpdateUI:!1,displayMapCreateMap:!1,displayMapAddPoints:!1,groupBy:!1,gridPoints:!1,setEntry:!1,initMap:!1,colorTable:!1},ATTR_FIELD_ID="field-id",ATTR_FIELD_VALUE="field-value",ATTR_METADATA_VALUE="metadata-value",ATTR_METADATA_TYPE="metadata-type",ATTR_METADATA_INDEX="metadata-index",ATTR_RECORD_INDEX="recordindex",ATTR_RECORD_ID="recordid",ramaddaDoingWiki=0,CATEGORY_CHARTS="Basic Charts",CATEGORY_TABLE="Tables",CATEGORY_MISC="Misc Charts",CATEGORY_MAPS="Maps",CATEGORY_IMAGES="Images",CATEGORY_RADIAL_ETC="Trees, etc",CATEGORY_TEXT="Text",CATEGORY_ENTRIES="Entries",CATEGORY_CONTROLS="Controls",DISPLAY_CATEGORIES=[CATEGORY_CHARTS,CATEGORY_TABLE,CATEGORY_MAPS,CATEGORY_IMAGES,CATEGORY_MISC,CATEGORY_TEXT,CATEGORY_RADIAL_ETC,CATEGORY_CONTROLS,CATEGORY_ENTRIES],ID_BOTTOM="bottom",ID_LEGEND="legend",ID_FIELDS="fields",ID_HEADER="header",ID_HEADER0="header0",ID_HEADER1="header1",ID_HEADER2="header2",ID_HEADER2_PREFIX="header2prefix",ID_HEADER2_PREPREFIX="header2preprefix",ID_HEADER2_PREPREPREFIX="header2prepreprefix",ID_HEADER2_SUFFIX="header2suffix",ID_FILTERBAR="filterbar",ID_TAGBAR="tagbar",ID_TITLE="title",ID_TITLE_EDIT="title_edit",ID_LEFT="left",ID_RIGHT="right",ID_TITLE_FIELD="titlefield",ID_TOP="top",ID_TOP_RIGHT="topright",ID_TOP_LEFT="topleft",ID_DETAILS="details",ID_DETAILS_SNIPPET="snippet",ID_DISPLAY_CONTENTS="contents",ID_DISPLAY_CONTAINER="container",ID_DISPLAY_TOP="top",ID_DISPLAY_BOTTOM="bottom",ID_GROUP_CONTENTS="group_contents",ID_DETAILS_MAIN="detailsmain",ID_GROUPBY_FIELDS="groupdbyfields",ID_TOOLBAR="toolbar",ID_TOOLBAR_INNER="toolbarinner",ID_LIST="list",ID_DISPLAY_MESSAGE="displaymessage",ID_DIALOG="dialog",ID_DIALOG_TABS="dialog_tabs",ID_FOOTER="footer",ID_FOOTER_LEFT="footer_left",ID_FOOTER_RIGHT="footer_right",ID_MENU_BUTTON="menu_button",ID_MENU_OUTER="menu_outer",ID_MENU_INNER="menu_inner",ID_DISPLAY_PROGRESS="display_progress",ID_REPOSITORY="repository",ID_REQUEST_PROPERTIES="request_properties",ID_PAGE_COUNT="pagecount",ID_PAGE_PREV="pageprev",ID_PAGE_NEXT="pagenext",ID_PAGE_LABEL="pagelabel",ID_PAGE_BUTTONS="pagebuttons",ID_FILTER_HIGHLIGHT="filterhighlight",ID_FILTER_DATE="filterdate",ID_FILTER_COUNT="filtercount",ID_ENTRIES_MENU="entries_menu",ID_ENTRIES_PREV="entries_prev",ID_ENTRIES_NEXT="entries_next",ID_NEXT="next",ID_PREV="prev",ID_PREVNEXT_LABEL="prevnext_label",PROP_DISPLAY_FILTER="displayFilter",PROP_EXCLUDE_ZERO="excludeZero",PROP_EXCLUDE_NAN="excludeUndefined",PROP_DIVID="divid",PROP_FIELDS="fields",PROP_LAYOUT_HERE="layoutHere",PROP_HEIGHT="height",PROP_WIDTH="width",TEXT_HIGHLIGHT_COLOR="yellow",HIGHLIGHT_COLOR="#436EEE",VALUE_NONE="--none--",CLASS_DISPLAY_FILTER="display-filter",CLASS_FILTER_INPUT="display-filter-input",CLASS_HEADER_SPAN="display-header-span",CLASS_HEADER_LABEL="display-header-label",CLASS_DISPLAY_BUTTON="display-button",DisplayEvent={};function displayDefineEvent(e,t){!1!==t&&(t=!0),DisplayEvent[e]={name:e,share:e+".share",accept:e+".accept",shareGroup:e+".shareGroup",acceptGroup:e+".acceptGroup",default:t,handler:"handleEvent"+e[0].toUpperCase()+e.substring(1),toString:function(){return this.name}}}displayDefineEvent("setEntry"),displayDefineEvent("filteredTimes",!1),displayDefineEvent("recordSelection"),displayDefineEvent("dateRange"),displayDefineEvent("recordList"),displayDefineEvent("recordHighlight"),displayDefineEvent("propertyChanged"),displayDefineEvent("pointDataLoaded"),displayDefineEvent("dataSelection"),displayDefineEvent("fieldsSelected"),displayDefineEvent("filterFieldsSelected"),displayDefineEvent("fieldsChanged"),displayDefineEvent("fieldValueSelected"),displayDefineEvent("entrySelection"),displayDefineEvent("entriesChanged"),displayDefineEvent("mapBoundsChanged",!1),displayDefineEvent("animationChanged"),displayDefineEvent("entryMouseOver"),displayDefineEvent("entryMouseOut"),displayDefineEvent("removeDisplay"),displayDefineEvent("filterChanged"),displayDefineEvent("filteredDataChanged",!1);var globalDisplayCount=0,DISPLAY_COUNT=0;function addGlobalDisplayProperty(e,t,i){null==window.globalDisplayProperties&&(window.globalDisplayProperties={}),"true"===t?t=!0:"false"===t&&(t=!1),i&&(e=i+"."+e),window.globalDisplayProperties[e]=t}function getGlobalDisplayProperty(e,t){if(null==window.globalDisplayProperties)return null;if(t){let i=t+"."+e;if(Utils.isDefined(window.globalDisplayProperties[i]))return window.globalDisplayProperties[i]}return window.globalDisplayProperties[e]}function addGlobalDisplayType(e,t){null==window.globalDisplayTypes&&(window.globalDisplayTypes=[],window.globalDisplayTypesMap={}),e.preview&&!e.tooltip&&(e.tooltip=makeDisplayTooltip(e.label,e.preview,e.desc)),e.tooltip||(e.tooltip=makeDisplayTooltip(e.label,e.preview,e.desc)),e.type&&(window.globalDisplayTypesMap[e.type]=e),t?window.globalDisplayTypes.unshift(e):window.globalDisplayTypes.push(e)}var RamaddaDisplayUtils={sparklineProps:[{label:"Sparkline"},{p:"showDate",ex:"true"},{p:"showMin",ex:"true"},{p:"showMax",ex:"true"},{p:"sparklineUseAllRecords",ex:"true",tt:"Use all of the records for the min/max.\nUseful for multiples"},{p:"labelStyle",ex:""},{p:"sparklineWidth",d:60,canCache:!0},{p:"sparklineHeight",d:20,canCache:!0},{p:"sparklineLineColor",d:COLOR_BLACK,canCache:!0},{p:"sparklineBarColor",d:"MediumSeaGreen",canCache:!0},{p:"sparklineCircleColor",d:COLOR_BLACK,canCache:!0},{p:"sparklineCircleRadius",d:"1",canCache:!0},{p:"sparklineLineWidth",d:"1",canCache:!0},{p:"sparklineShowLines",d:!0,canCache:!0},{p:"sparklineShowBars",d:!1,canCache:!0},{p:"sparklineShowCircles",d:!0,canCache:!0},{p:"sparklineShowEndPoints",d:!0,canCache:!0},{p:"sparklineEndPointRadius",d:2,canCache:!0},{p:"sparklineEndPoint1Color",d:"steelblue",canCache:!0},{p:"sparklineEndPointRadius",d:"2",canCache:!0},{p:"sparklineEndPoint2Color",d:"",canCache:!0},{p:"sparklineEndPoint2Color",d:"tomato",canCache:!0},{p:"sparklineDoTooltip",d:!0,canCache:!0}],getCanvasProps:function(){return[{p:"canvasWidth",d:100,ex:"100",tt:"Canvas width"},{p:"canvasHeight",d:100,ex:"100",tt:"Canvas height"},{p:"canvasOrigin",d:"sw",ex:"center",tt:"Origin point for drawing glyphs"},{label:"label glyph",p:"glyph1",ex:"type:label,pos:sw,dx:10,dy:-10,label:field_colon_ ${field}_nl_field2_colon_ ${field2}"},{label:"rect glyph",p:"glyph1",ex:"type:rect,pos:sw,dx:10,dy:0,colorBy:field,width:150,height:100"},{label:"circle glyph",p:"glyph1",ex:"type:circle,pos:n,dx:10,dy:-10,fill:true,colorBy:field,width:20,baseWidth:5,sizeBy:field,#sizeByMin:0,#sizeByMax:100"},{label:"3dbar glyph",p:"glyph1",ex:"type:3dbar,pos:sw,dx:10,dy:-10,height:30,width:8,baseHeight:5,sizeBy:field,#sizeByMin:0,#sizeByMax:100"},{label:"gauge glyph",p:"glyph1",ex:"type:gauge,color:#000,pos:sw,width:50,height:50,dx:10,dy:-10,sizeBy:field,sizeByMin:0"}]},getGlyphs:function(e,t,i,s,l){let a=[],r=1;for(Utils.isDefined(s)||(s=e.getProperty("canvasWidth",100),l=e.getProperty("canvasHeight",100));r<11;){let o=e.getProperty("glyph"+r++);o&&a.push(new Glyph(e,1,t,i,{canvasWidth:s,canvasHeight:l},o))}return a}};function makeDisplayTooltip(e,t,i){let s="";if(null!=e&&(s+=HU.b(e)),t){Array.isArray(t)||(t=[t]);let e=t.reduce(((e,t)=>(t.startsWith("/")||(t=RamaddaUtil.getUrl("/help/display/"+t)),e+HU.tag(TAG_IMG,[ATTR_SRC,t,ATTR_WIDTH,HU.px(250)])+HU.br())),"");s+=HU.div([],e)}return Utils.stringDefined(i)&&(s+=HU.div([],i)),s=s.replace(/"/g,"&quot;"),s}let addDisplayListener=null;function addRamaddaDisplay(e){return addDisplayListener&&addDisplayListener(e),Utils.addDisplay(e),e.displayCount=globalDisplayCount++,e}async function ramaddaDisplaySetSelectedEntry(e,t,i){await getGlobalRamadda().getEntry(e,(e=>{(t=t||Utils.displaysList)&&t.forEach((t=>{t!=i&&t.setEntry&&t.setEntry(e)}))}))}function ramaddaDisplayCheckLayout(){Utils.displaysList.forEach((e=>{if(e.checkLayout){new Date;e.checkLayout();new Date}}))}function getRamaddaDisplay(e){let t=Utils.displaysMap[e];return t||(Utils.displaysList.forEach((e=>{e.getId&&(Utils.displaysMap[e.getId()]=e),e.displayId&&(Utils.displaysMap[e.displayId]=e)})),Utils.displaysMap[e])}function removeRamaddaDisplay(e){let t=getRamaddaDisplay(e);t&&(t.removeDisplay(),Utils.removeDisplay(t))}function displayGetFunctionValue(e){return e.getTime?e.getTime():isNaN(e)?"string"==typeof e?e:0:e}function ramaddaDisplayStepAnimation(){Utils.displaysList.forEach((e=>{e.getProperty&&e.getAnimation&&e.getProperty("doAnimation")&&e.getAnimation().doNext()}))}function displayDefineMembers(e,t,i){return RamaddaUtil.defineMembers(e,i),t&&e.defineProperties&&e.defineProperties(t),e}function defineDisplay(e,t,i,s){return RamaddaUtil.inherit(e,t),displayDefineMembers(e,i,s),s.ctor&&e.ctor(),e}function DisplayThing(e,t){this.isDisplayThing=!0,null==t&&(t={});for(let e in t)"string"==typeof t[e]&&("true"==t[e]?t[e]=!0:"false"==t[e]&&(t[e]=!1));for(let e in t){let i=e.split(".");if(i.length<=1)continue;let s={},l=t[e];"true"==l?l=!0:"false"==l&&(l=!1);for(let e=0;e<i.length;e++){let t=i[e];if(e==i.length-1){s[t]=l;break}let a=s[t];null==a?(s[t]={},s=s[t]):s=a}}this.ignoreGlobals=t.ignoreGlobals,this.displayId=null,displayDefineMembers(this,null,{objectId:e,properties:t,displayParent:null,getId:function(){return this.objectId},setId:function(e){this.objectId=e},removeDisplay:function(){this.dialogElement&&this.dialogElement.remove()},setEntry:function(e){},handleEntryMenu:async function(e){await getGlobalRamadda().getEntry(e,(e=>{this.setEntry(e)}))},getEntriesMenu:function(e){if(e&&e.entryCollection){let t=e.entryCollection.split(",");this.changeEntries=[];let i=[];t.forEach((e=>{let t=e.split(":");this.changeEntries.push(t[0]),i.push([t[0],t[1]])}));let s=this.getProperty("noun","Data"),l=HU.span([ATTR_CLASS,"display-changeentries-button",ATTR_TITLE,"Previous "+s,ATTR_ID,this.getDomId(ID_ENTRIES_PREV)],HU.getIconImage("fa-chevron-left")),a=HU.span([ATTR_CLASS,"display-changeentries-button",ATTR_TITLE,"Next "+s,ATTR_ID,this.getDomId(ID_ENTRIES_NEXT)],HU.getIconImage("fa-chevron-right")),r=e.changeEntriesLabel||"Select "+s;return""!=r&&(r+=HU.br()),HU.center(HU.div([ATTR_CLASS,"display-filter"],r+l+" "+HU.select("",[ATTR_ID,this.getDomId(ID_ENTRIES_MENU)],i)+" "+a))}return""},initializeEntriesMenu:function(){this.jq(ID_ENTRIES_PREV).click((e=>{let t=this.jq(ID_ENTRIES_MENU)[0].selectedIndex;t<=0&&(t=this.changeEntries.length);let i=this.changeEntries[t-1];this.jq(ID_ENTRIES_MENU).val(i),this.handleEntryMenu(i)})),this.jq(ID_ENTRIES_NEXT).click((e=>{let t=this.jq(ID_ENTRIES_MENU)[0].selectedIndex;t>=this.changeEntries.length-1&&(t=0);let i=this.changeEntries[t+1];this.jq(ID_ENTRIES_MENU).val(i),this.handleEntryMenu(i)})),this.jq(ID_ENTRIES_MENU).change((e=>{let t=this.jq(ID_ENTRIES_MENU).val();this.handleEntryMenu(t)}))},popup:function(e,t,i,s){s=s||jqid(t);let l=i||jqid(e),a=POS_LEFT_TOP,r=POS_LEFT_BOTTOM;s.show(),s.position({of:l,my:a,at:r,collision:"none none"}),s.position({of:l,my:a,at:r,collision:"none none"}),s.draggable(),s.show()},initDialog:function(){},showDialog:function(e,t,i){this.dialogElement||($(document.body).append(HU.div([ATTR_CLASS,"display-dialog",ATTR_ID,this.getDomId(ID_DIALOG)])),this.dialogElement=this.jq(ID_DIALOG)),this.dialogElement.html(this.makeDialog(e)),this.popup(t||this.getDomId(ID_MENU_BUTTON),null,null,this.dialogElement),i?i():this.initDialog()},getShowMenu:function(){if(this.getProperty("isContained",!1))return!1;if(Utils.isDefined(this.showMenu))return this.showMenu;let e=!1;return null!=this.displayParent&&(e=this.displayParent.getProperty("showChildMenu",e)),this.getProperty(PROP_SHOW_MENU,e)},canEdit:function(){return this.getProperty("canEdit")},getShowTitle:function(){if(this.getProperty("showTitle"))return this.getProperty("showTitle");let e=!1;return null!=this.displayParent&&(e=this.displayParent.getShowChildTitle(e)),this.getProperty("showTitle",e)},formatDate:function(e,t,i){if(!e||!e.getTime)return"";try{return this.formatDateInner(e,t,i)}catch(t){return console.log(t.stack),console.error('Error formatting date:"'+e+'" error:'+t),!e.getTime&&e.v&&(e=e.v),""+e}},dateProps:null,getDateProps:function(){return this.dateProps||(this.dateProps={dateFormat:this.getProperty("dateFormat",this.getProperty("dateFormat2")),dateSuffix:this.getProperty("dateSuffix"),timeZone:this.getTimeZone(),dateFormatDaysAgo:this.getProperty("dateFormatDaysAgo",!1)}),this.dateProps},formatDateInner:function(e,t,i){let s,l=this.getDateProps();if(!l.dateFormat&&i)return String(e);if(!e.getTime&&e.v&&(e=e.v),e.getTime&&isNaN(e.getTime()))return"Invalid date";if(l.dateFormat){let t=Utils.formatDateWithFormat(e,l.dateFormat,!0);if(t)return String(t)}if(!e.toLocaleDateString)return String(e);s=t&&!Utils.isDefined(t.suffix)?t.suffix:l.dateSuffix;let a=this.getTimeZone();return!s&&a&&(s=a),Utils.formatDate(e,t?t.options:null,{timeZone:a,suffix:s})},getUniqueId:function(e){return HU.getUniqueId(e)},toString:function(){return"DisplayThing:"+this.getId()},domId:function(e){return this.getDomId(e)},getDomId:function(e){return this.getId()+"_"+e},gid:function(e){return this.getId()+"_"+e},find:function(e){return this.getContents().find(e)},getContents:function(){return this.jq(ID_DISPLAY_CONTENTS)},getContainer:function(){return this.jq(ID_DISPLAY_CONTAINER)},jq:function(e){return jqid(this.getDomId(e))},selectboxit:function(e,t){let i={showEffect:"fadeIn",showEffectSpeed:400,hideEffect:"fadeOut",hideEffectSpeed:400};t&&$.extend(i,t),HU.initSelect(e,i)},writeHtml:function(e,t){try{jqid(this.getDomId(e)).html(t)}catch(i){console.log("writeHtml error:"+i),console.log("idSuffix:"+e),console.log("html:"+t)}},defaultTemplateProps:null,getDefaultTemplateProps:function(){return this.defaultTemplateProps||(this.defaultTemplateProps={iconField:this.getProperty("iconField"),iconSize:parseFloat(this.getProperty("iconSize",16)),colorBy:this.getProperty("colorBy"),colorByMap:this.getColorByMap(),iconMap:this.getIconMap(),imageWidth:this.getProperty("imageWidth")}),this.defaultTemplateProps},getTemplateProps:function(e){let t=this.getDefaultTemplateProps();return{iconField:this.getFieldById(e,t.iconField),iconSize:t.iconSize,colorBy:t.colorBy,colorByMap:t.colorByMap,iconMap:t.iconMap}},macroHook:function(e,t){return null},fieldFormats:{},formatFieldValue:function(e,t,i){let s=this.fieldFormats[e.getId()];if(s||(s={template:this.getProperty(e.getId()+".template")},this.fieldFormats[e.getId()]=s),s.template){let e=this.applyRecordTemplate(t,this.getDataValues(t),null,s.template);e=e.replace(/\${value}/g,i),i=e}return i},createCommandText:function(e,t){let i="";return Utils.tokenizeMacros(e).tokens.forEach((e=>{if("string"!=e.type)if(t[e.id]=e,"attribute"!=e.tag)console.dir("Unknown command token",e);else{if(!e.attrs.labels)return void console.dir("No labels:",e);let t=e.attrs.labels.split(",");i+=HU.select("",[ATTR_CLASS,"display-command","commandId",e.id],t)}else i+=e.s})),i},initCommandText:function(e,t){let i=this;t.find(".display-command").change((function(){let t=$(this).attr("commandId"),s=e[t];if(!s)return void console.log("Could not find command:"+t);let l=$(this).prop("selectedIndex");Object.keys(s.attrs).forEach((e=>{if("labels"==e)return;let t=s.attrs[e].split(","),a=t[l];a?i.setProperty(e,a):console.log("could not find command value in list:",t)})),i.updateUI()}))},applyRecordTemplate:function(e,t,i,l,a,r,o){t||(t=this.getDataValues(e)),i||(i=e.getFields()),i=this.getFields(i),a||(a=this.getTemplateProps(i)),r||(r=Utils.tokenizeMacros(l,{hook:(t,i)=>this.macroHook(e,t,i),dateFormat:this.getDateProps().dateFormat}));let n={};if(a.iconMap&&a.iconField){let e=t[a.iconField.getIndex()],i=a.iconMap[e];i&&(n[a.iconField.getId()+"_icon"]=HU.image(i,[ATTR_WIDTH,a.iconSize]))}let h=(e,t)=>{let i=r.getAttributes(e.getId()+"_image"),s=[],l=i?i.width:null;return l?(s.push(ATTR_WIDTH),s.push(l)):this.getDefaultTemplateProps().imageWidth?(s.push(ATTR_WIDTH),s.push(this.getDefaultTemplateProps().imageWidth)):(s.push(ATTR_WIDTH),s.push(300)),s.push(ATTR_STYLE),s.push(HU.css(CSS_VERTICAL_ALIGN,POS_TOP)),HU.image(t,s)},d={};i.forEach((e=>d[e.getId()]=e)),r.tokens.forEach((s=>{if(!s.attrs)return;let l,r=s.attrs.debug;if("#"==s.tag){r&&console.log("checking for numeric");for(let e=0;e<i.length;e++){let t=i[e];if(t.isNumeric()){l=t,r&&console.log("found numeric:"+t);break}}}else if("match"==s.tag&&(s.attrs.pattern||s.attrs.numeric)){let e=s.attrs.pattern,t=s.attrs.numeric;r&&console.log("checking for pattern:"+e+" or number:"+t),i.every((i=>t&&i.isNumeric()?(l=i,r&&console.log("found number:"+i),!1):!e||!(i.getId().indexOf(e)>=0||i.getLabel().indexOf(e)>=0||i.getId().match(e)||i.getLabel().match(e))||(l=i,r&&console.log("found pattern:"+i),!1)))}else s.tag&&i.every((e=>!e.getId().match(s.tag)&&!e.getLabel().match(s.tag)||(l=e,r&&console.log("found pattern:"+e),!1)));if(l){s.tag=l.getId(),s.attrs.label=l.getLabel();let e=l.getUnit();e||(e=a.unit),e||(e=""),s.attrs.suffix&&(s.attrs.suffix=String(s.attrs.suffix).replace("${unit}",e).replace("${fieldName}",l.getLabel()).replace("${fieldId}",l.getId())),s.attrs.prefix&&(s.attrs.prefix=String(s.attrs.prefix).replace("${unit}",e).replace("${fieldName}",l.getLabel()+": ").replace("${fieldId}",l.getId()+": "))}else{let e=a.unit??"";s.attrs.suffix&&(s.attrs.suffix=String(s.attrs.suffix).replace("${unit}",e).replace("${fieldName}","").replace("${fieldId}","")),s.attrs.prefix&&(s.attrs.prefix=String(s.attrs.suffix).replace("${unit}",e).replace("${fieldName}","").replace("${fieldId}",""))}if("default"==s.tag)n[s.tag]=this.getRecordHtml(e,i,"${default}",s.attrs);else if("entryname"==s.tag)n[s.tag]=a.entryname;else if("list"==s.attrs.type&&s.attrs.fields){let e=HU.open(TAG_TABLE,[ATTR_CLASS,"display-table"]);s.attrs.fields.split(",").forEach((i=>{let s=d[i],l=t[s.getIndex()];"image"==s.getType()?l=h(s,l):"url"==s.getType()&&""!=l&&(l=HU.href(l,l)),e+=HU.tag(TAG_TR,[],HU.tag(TAG_TD,[ATTR_ALIGN,ALIGN_RIGHT],HU.boldLabel(s.getLabel())+HU.tag(TAG_TD,[],l)))})),e+=HU.close(TAG_TABLE),n[s.tag]=e}}));for(let e=0;e<i.length;e++){let l=i[e],h=r.getAttributes(l.getId());h&&!h.label&&(h.label=l.getLabel());let d,g=t[l.getIndex()];if(l.isNumeric()&&isNaN(g)&&a.findNonNan&&a.records)for(let e=a.records.length-1;e>=0&&(g=l.getValue(a.records[e]),isNaN(g));e--);if(o&&console.log("macro:"+e+" field:"+l.getId()+" type:"+l.getType()+" value:"+g),a.iconMap){let e=a.iconMap[l.getId()+"."+g];e&&(s=s.replace("${"+l.getId()+"_icon}",HU.image(e,[ATTR_SIZE,a.iconSize])))}if("image"==l.getType())if(g&&g.trim().length>1){let e=r.getAttributes(l.getId()+"_image"),t=[],i=e?e.width:null;i?(t.push(ATTR_WIDTH),t.push(i)):this.getDefaultTemplateProps().imageWidth?(t.push(ATTR_WIDTH),t.push(this.getDefaultTemplateProps().imageWidth)):(t.push(ATTR_WIDTH),t.push(HU.perc(100))),t.push(ATTR_STYLE),t.push(HU.css(CSS_VERTICAL_ALIGN,POS_TOP));let s=HU.image(g,t);n[l.getId()+"_image"]=s,n[l.getId()+"_url"]=g}else n[l.getId()+"_url"]=RamaddaUtil.getCdnUrl("/icons/blank.gif"),n[l.getId()+"_image"]="";else if("movie"==l.getType()){if(g&&g.trim().length>0){let e=[];this.getProperty("movieWidth")&&(e.push(ATTR_WIDTH),e.push(this.getProperty("movieWidth")));let t=HU.movie(g,e);n[l.getId()+"_movie"]=t,n[l.getId()+"_url"]=g}}else{if("url"==l.getType()){if(g&&g.trim().length>1){let e=r.getAttributes(l.getId()+"_href"),t=e?e.label:null;n[l.getId()+"_href"]=HU.href(g,t||g),n[l.getId()]=g}else n[l.getId()+"_href"]="",n[l.getId()]="";continue}if(l.isDate){g&&(n[l.getId()]=g);continue}}a.colorByMap&&(d=a.colorBy&&a.colorBy==l.getId()?a.colorByMap[g]:a.colorByMap[l.getId()+"."+g]),d&&(n[l.getId()+"_color"]=d),n[l.getId()]=g,l.isNumeric()&&(n[l.getId()+"_format"]=Utils.formatNumberComma(g))}this.addMacroAttributes(r,t,n);return n.recordIndex=e.rowIndex+1,r.apply(n,o,((e,t)=>{if("tags"==e.attrs.display){let i=e.tag,s=this.filterMap[i],l=Utils.getEnumColor(i),a="";return""==(t=String(t).trim())?"":(t.split(",").forEach((e=>{a+=HU.div([ATTR_METADATA_TYPE,i,ATTR_METADATA_VALUE,e,ATTR_TITLE,e,ATTR_STYLE,HU.css(CSS_BACKGROUND,l),ATTR_CLASS,"display-search-tag"],e)})),s&&(a=s.getLabel()+": "+a+HU.br()),a)}return"Unknown tag handler:"+e.attrs.handle}))},addMacroAttributes:function(e,t,i){},getFields:function(e){if(!e){if(this.convertedFields)return this.convertedFields;{let t=this.pointData||this.getData();if(null==t)return null;e=t.getRecordFields()}}return e},fieldLabelCache:{},getFieldLabel:function(e){if(this.fieldLabelCache[e.getId()])return this.fieldLabelCache[e.getId()].value;let t=this.getProperty(e.getId()+".label",e.getLabel());return this.fieldLabelCache[e.getId()]={value:t},t},getRecordUrlHtml:function(e,t,i){let s=i.getValue(t.getIndex());if(!Utils.stringDefined(s))return"";s.startsWith("http")||(s="https://"+s);let l=s||"Link";l=l.replace(/^https?:\/\//,""),l=l.replace(/\?.*/,""),l=l.replace(/\/$/,"");let a=e[t.getId()+".label"]||e["url.label"]||e.label||l;return HU.href(s,a,[ATTR_TARGET,"_link"])},getSortedFields:function(e){if(!(e.filter((e=>null==e||null!=e.getGroup())).length>0))return e;let t=[],i={};for(let s=0;s<e.length;s++){let l=e[s];null!=l&&(group=l.getGroup(),null==group&&(group=group+"_"+s),i[group]||(i[group]=[],t.push(group)),i[group].push(l))}return e=[],t.forEach((t=>{e=Utils.mergeLists(e,i[t])})),e},dfltRecordHtmlProps:null,getRecordHtmlProps:function(){if(!this.dfltRecordHtmlProps){let e=this.getFieldById(null,this.getProperty("urlField","url"),!1,!0),t=this.getFieldById(null,this.getProperty("linkField"))||e;this.dfltRecordHtmlProps={urlField:e,linkField:t,titleField:this.getFieldById(null,this.getProperty("titleField")),titleTemplate:this.getProperty("titleTemplate"),descField:this.getFieldById(null,this.getProperty("descriptionField")),showDate:this.getProperty("showDate",!0),showImage:this.getProperty("showImage",!0),showMovie:this.getProperty("showMovie",!0),showElevation:this.getProperty("showElevation",!1)}}return this.dfltRecordHtmlProps},getRecordHtml:function(e,t,i,s,l){if((s=s??{}).labelStyle||(s.labelStyle=this.getLabelStyle()),!(t=this.getFields(t)))return"";let a=this.getRecordHtmlProps(),r=a.linkField?e.getValue(a.linkField.getIndex()):null,o=this.getTooltipShowGeo();if(""==i)return"";if(Utils.stringDefined(i)||(i=this.getProperty("recordTemplate")),Utils.stringDefined(i)&&!i.startsWith("${default")&&"${fields}"!=i)return this.applyRecordTemplate(e,this.getDataValues(e),t,i,null,null,l);let n=this.getTooltipFields();"${fields}"==i?t=this.getFieldsByIds(null,n??this.getPropertyFields()):n&&(t=this.getFieldsByIds(null,n));let h=this.getItemsPerColumn(),d={};i&&(d=Utils.tokenizeMacros(i,{hook:(t,i)=>this.macroHook(e,t,i),dateFormat:this.getDateFormat()}).getAttributes("default")||{}),h=d.itemsPerColumn||h;let g=d.maxWidth??d.maxwidth,p="";if(a.titleField||a.titleTemplate){let i="";if(a.titleTemplate){let s=this.applyTitleTemplate(a.titleTemplate);a.titleTemplate.startsWith("${default")||(i=this.getRecordHtml(e,t,s,{},l))}else i=e.getValue(a.titleField.getIndex()),i.getTime&&(i=this.formatDate(i)),i=HU.center(HU.h3(i));r&&(i=HU.href(r,i,[ATTR_TARGET,"_target"])),p+=i,r=null}if(a.descField){let t=e.getValue(a.descField.getIndex());p+=t}let c={};this.getTooltipNotFields().split(",").forEach((e=>{c[e]=!0}));let u=[],T=!1,f=[];f=this.getLabelColumnAttrs()?this.getLabelColumnAttrs().split(","):[ATTR_ALIGN,ALIGN_RIGHT];let y=this.getLabelWidth();t=this.getSortedFields(t);let m=s.excludes?s.excludes.split(","):[],_="true"==s.skipEmpty,S=null,A=this.getIncludeFieldDescriptionInTooltip(),I=this.getTooltipShowUnit();for(let i=0;i<2;i++)for(let l=0;l<t.length;l++){let r=t[l],n=!0;if(m.every((e=>([r.getLabel(),r.getId()].every((t=>(t.toLowerCase().match(e)&&(n=!1),n))),n))),!n)continue;if(c[r.getId()])continue;if(d[r.getId()+".hide"])continue;if(r==a.titleField||r==a.descField)continue;if(0==i&&!r.derived)continue;if(1==i&&r.derived)continue;if(!r.getForDisplay())continue;if(r.isRecordDate()){if(!a.showDate||T)continue;T=!0}if(r.isFieldDate()&&(T=!0),!o&&r.isFieldGeo())continue;S!=r.getGroup()&&(S=r.getGroup(),Utils.isDefined(S)&&u.push(HU.tr([],HU.td([ATTR_COLSPAN,2],HU.div([ATTR_CLASS,"ramadda-header-small"],S)))));let h=e.getValue(r.getIndex()),p=h,b=String(h);if(_&&!Utils.stringDefined(b))continue;let R=p;if(R&&(R=b.replace(/"/g,"'")),"number"==typeof p&&(p=this.formatNumber(p,r.getId())),r.isFieldDate()&&(p=this.formatDate(p)),"image"==r.getType()&&""!=p){if(!a.showImage)continue;let e=[];this.getImageWidth()?(e.push(ATTR_WIDTH),e.push(this.getImageWidth())):(e.push(ATTR_WIDTH),e.push(200)),e.push(ATTR_ALIGN),e.push(POS_TOP),p=HU.image(p,e)}if("movie"==r.getType()&&""!=p){if(!a.showMovie)continue;let e=[];e.push(ATTR_WIDTH),e.push(200),p=HU.movie(p,e)}("url"==r.getType()||b.match(/^http[^ ]+$/))&&(p=this.getRecordUrlHtml(d,r,e));let D,L=r.getLabel();L=this.getProperty("label."+r.getId(),L),I&&(p+=r.getUnitSuffix()),A||(D=r.getDescription(),D&&(D+=HU.getTitleBr())),D=D??"",D+=L+"="+b,D=D.replace(/"/g,"'"),b.indexOf('"')>=0&&(D=""),p.length>100&&(String(p).match("<img")||(p=HU.div([ATTR_STYLE,HU.css(CSS_MAX_HEIGHT,HU.px(100),CSS_OVERFLOW_Y,OVERFLOW_AUTO)],p)));let U=this.formatRecordLabel(L)+":";y&&(U=HU.div([ATTR_STYLE,HU.css(CSS_MAX_WIDTH,HU.getDimension(y),CSS_OVERFLOW_X,OVERFLOW_AUTO)],U)),U=HU.div([ATTR_TITLE,D],U);let C=HU.open(TAG_TR,[ATTR_VALIGN,POS_TOP]),E=[ATTR_CLASS,"display-record-table-label"];s.labelStyle&&E.push(ATTR_STYLE,s.labelStyle);let H=p,P=HU.css(CSS_MARGIN_LEFT,HU.px(5),CSS_MAX_WIDTH,HU.vw(90));g&&(P+=HU.css(CSS_MAX_WIDTH,HU.px(g))),C+=HU.td(f,HU.div(E,U)),C+="\n",C+=HU.td([ATTR_FIELD_ID,r.getId(),ATTR_FIELD_VALUE,R,ATTR_ALIGN,ALIGN_LEFT],HU.div([ATTR_STYLE,P],H)),A&&(C+=HU.td([],r.getDescription()??"")),C+=HU.close(TAG_TR),u.push(C)}if(!T&&a.showDate&&e.hasDate()){let t=HU.open(TR,[ATTR_VALIGN,POS_TOP]),i=this.formatRecordLabel("Date");t+=HU.td([],HU.boldLabel(i)),t+=HU.td([ATTR_ALIGN,ALIGN_LEFT],HU.div([ATTR_STYLE,HU.css(CSS_MARGIN_LEFT,HU.px(5))],this.formatDate(e.getDate()))),t+=HU.close(TR),u.push(t)}a.showElevation&&e.hasElevation()&&u.push(HU.tr([],HU.td([ATTR_ALIGN,ALIGN_RIGHT],HU.boldLabel("Elevation"))+HU.td([ATTR_ALIGN,ALIGN_LEFT],number_format(e.getElevation(),4,".",""))));p+=HU.open(TAG_TABLE)+HU.open(TAG_TR,[ATTR_VALIGN,ALIGN_TOP]);let b=Utils.splitList(u,h),R=b.length>1?HU.css(CSS_MARGIN_RIGHT,HU.px(5)):"";return b.forEach((e=>{p+=HU.tag(TAG_TD,[],HU.div([ATTR_STYLE,R],HU.tag(TAG_TABLE,[],Utils.join(e,""))))})),p+=HU.close(TAG_TR,TAG_TABLE),this.getRecordHtmlStyle()&&(p=HU.div([ATTR_CLASS,"ramadda-shadow-box display-tooltip",ATTR_STYLE,this.getRecordHtmlStyle()],p)),p},formatRecordLabel:function(e){return e=(e=e.replace(/!!/g," -- ")).replace(/ /g,SPACE)},getFormValue:function(e,t){let i=jqid(this.getDomId(e)).val();return null!=i?(i.length>0&&this.setProperty(e,i),"none"==i&&this.setProperty(e,null),i):this.getProperty(e,t)},getName:function(){return this.getFormValue("name",this.getId())},getEventSource:function(){return this.getFormValue("eventSource","")},setDisplayParent:function(e){this.displayParent=e},getDisplayParent:function(){return null==this.displayParent&&this.getLayoutManager&&(this.displayParent=this.getLayoutManager()),this.displayParent},removeProperty:function(e){this.properties[e]=null},setProperty:function(e,t){this.properties[e]=t,this.transientProperties[e]=t,this.propertiesCache[e]=t},getSelfProperty:function(e,t){return null!=this[e]?this[e]:this.getProperty(e,t)},initTooltip:function(){},formatInfo:{},formatNumber:function(e,t,i){t=t??"";let s=this.formatInfo[t];if(s||(s={doFormatNumber:this.getProperty(t?[t+".doFormatNumber","doFormatNumber"]:"doFormatNumber",!0),fmt:this.getProperty(t?[t+".numberTemplate","numberTemplate"]:"numberTemplate"),scale:this.getProperty(t?[t+".formatNumberScale","formatNumberScale"]:"formatNumberScale",1),decimals:this.getProperty(t?[t+".formatNumberDecimals","formatNumberDecimals"]:"formatNumberDecimals",-1),comma:this.getProperty(t?[t+".formatNumberComma","formatNumberComma"]:"formatNumberComma",!1),nanValue:this.getNanValue()},this.formatInfo[t]=s),!s.doFormatNumber)return e;if(isNaN(e))return s.nanValue;let l=this.formatNumberInner(e,t,s,i);return s.fmt&&(l=s.fmt.replace("${number}",l)),l=String(l),l.endsWith(".")&&(l=l.substring(0,l.length-1)),l},formatNumberInner:function(e,t,i,s){return e=+e,e*=i.scale,i.decimals>=0?number_format(e,i.decimals):i.comma?Utils.formatNumberComma(e):Utils.formatNumber(e,!1,s)},propertyDefined:function(e){return Utils.isDefined(this.getProperty(e))},setPropertyOn:function(e,t,i,s){let l=this.getProperty(t,s);Utils.isDefined(l)&&null!=l&&(e[i]=l)},getDisplayProp:function(e,t,i){if(Utils.isDefined(this[t]))return this[t];let s="map-"+t;return Utils.isDefined(e[s])?e[s]:e.getProperty?e.getProperty(t,i):null},getPropertyFromUrl:function(e,t,i){let s=HU.getUrlArgument("d"+this.displayCount+"."+e);return Utils.stringDefined(s)||i&&(s=HU.getUrlArgument(e),s)?s:this.getProperty(e,t)},addToDocumentUrl:function(e,t,i){HU.addToDocumentUrl((i?"":"d"+this.displayCount+".")+e,t)},getPropertyFields:function(e){return this.getPropertyFromUrl(PROP_FIELDS,e)},transientProperties:{},getPropertyCounts:{},priorProps:{},getAliasForField:function(e){this.aliasList||(this.aliasList=[],Object.keys(this.properties).forEach((e=>{if((e=String(e)).startsWith("alias.")){let t=this.properties[e];e=e.substring("alias.".length),this.aliasList.push({alias:e,pattern:t})}})));let t=[];return this.aliasList.forEach((i=>{(e.getId()==i.pattern||e.getId().match(i.pattern))&&t.push(i.alias)})),t},getFieldProperty:function(e,t,i){let s=this.getProperty(e.getId()+"."+t);return Utils.isDefined(s)?s:(this.getAliasForField(e).every((e=>(s=this.getProperty(e+"."+t),!Utils.isDefined(s)))),Utils.isDefined(s)?s:this.getProperty(t,i))},getTooltip:function(e){let t=this.getProperty("tooltip",e);return"none"==t&&(t=null),t},getProperty:function(e,t,i,s){let l=displayDebug.getProperty;this.getPropertyCounts[e]||(this.getPropertyCounts[e]=0),l|=this.debugGetProperty,this.getPropertyCount++,this.getPropertyCounts[e]++;let a=this.getPropertyInner(e,null,i,s,this);if(l&&console.log("getProperty:"+e+"  dflt:"+t+" got:"+a),null!=this.writePropertyDef&&(this.seenWriteProperty||(this.seenWriteProperty={}),!this.seenWriteProperty[e])){let i=e=>e?"'"+e+"'":"null";this.writePropertyDef+="{p:'"+e+"',d:"+i(t)+",wikiValue:"+i(a||t)+"},\n",this.seenWriteProperty[e]=!0}return Utils.isDefined(a)||(a=t),this.getPropertyCounts[e]>10&&(this.transientProperties[e]=Utils.isDefined(a)?a:null),a},getPropertyInner:function(e,t,i,s,l){let a=displayDebug.getProperty;a=this.debugGetProperty,l=l??this,Array.isArray(e)||(e=[e]);for(let i=0;i<e.length;i++){let s=e[i];if(a&&console.log("getProperty:"+s+" dflt:"+t),this.dynamicProperties&&(a&&console.log("key:"+s+" value:"+this.dynamicProperties[s]),Utils.isDefined(this.dynamicProperties[s])))return this.dynamicProperties[s];let l=this.properties[s];if(null!=l)return a&&console.log("\tgot property from this.properties:"+l),l}if(!s){let s=e=>null==e,r=this.displayParent,o=this.getDisplayManager?this.getDisplayManager():null,n=this.type+".";for(let h=0;h<e.length;h++){let d=e[h];a&&console.log(this.type,"looking for:"+d+" has parent:",null!=r," has display manager:",null!=o);let g=null;if(null!=r&&(g=r.getPropertyInner(n+d,t,i,null,l),a&&console.log("\tgetProperty from display parent using type prefix:"+g),s(g)&&(g=r.getPropertyInner("inherit."+d,t,i,null,l),a&&console.log("\tgetProperty from display parent:"+g)),s(g)&&(g=r.getPropertyInner(d,t,i,null,l),a&&console.log("\tgetProperty from display parent using key:"+g))),s(g)&&o&&(g=o.getPropertyInner("inherit."+d),a&&console.log("\tgetProperty from display manager:"+g),s(g)&&(g=o.getPropertyInner(n+d),a&&console.log("\tgetProperty from display parent using type prefix:"+g)),s(g)&&(g=o.getPropertyInner(d),a&&console.log("\tgetProperty from display parent using key:"+g))),!s(g))return a&&console.log("\tgotProperty from parent:"+g),g}}if(!this.ignoreGlobals){if(!s){if(null!=this.displayParent)return a&&console.log("\tgetProperty calling parent"),this.displayParent.getPropertyInner(e,t,i,null,l);if(this.getDisplayManager)return a&&console.log("\tgetProperty-5"),this.getDisplayManager().getPropertyInner(e,null,null,null,l)}for(let t=0;t<e.length;t++){let i=e[t];if(value=getGlobalDisplayProperty(i,l?l.type:this.type),Utils.isDefined(value))return a&&console.log("\tgetProperty-6:"+value),value}}return a&&console.log("\tgetProperty-6 dflt:"+t),t}})}function RamaddaDisplay(e,t,s,l){const r=new DisplayThing(t,l);RamaddaUtil.inherit(this,r),window.globalDisplayTypesMap&&(this.typeDef=window.globalDisplayTypesMap[s]),this._wikiTags=[],this.propertiesCache={},this.defineProperties=function(e){let t=[];e.forEach((e=>{if(t.push(e),e.p){if(e.p.indexOf("&")<0&&(!Utils.isDefined(e.doGetter)||e.doGetter)){let t=(t,i)=>{let s=e.canCache&&!t;if(s&&this.propertiesCache[e.p])return this.propertiesCache[e.p].value;Utils.isDefined(t)||(t=e.d);let l=this.getProperty(e.p,t);return s&&(this.propertiesCache[e.p]={value:l}),l},i="getProperty"+e.p.substring(0,1).toUpperCase()+e.p.substring(1);this[i]||(this[i]=t),i="get"+e.p.substring(0,1).toUpperCase()+e.p.substring(1),this[i]||(this[i]=t)}e.wikiValue=e.wikiValue||e.w}})),this._wikiTags=Utils.mergeLists(t,this._wikiTags)},displayDefineMembers(this,[{label:"Display"},{p:"fields",doGetter:!1,ex:"comma separated list of field ids or indices - e.g. #1,#4-#7,@2,@3 (use @ for numeric fields) or *"},{p:"notFields",ex:"regexp",tt:"regexp to not include fields"},{p:"fieldsPatterns",ex:"comma separated list of regexp patterns to match on fields to display"},{p:"fieldAliases",canCache:!0},{p:"prefixFields",tt:"Field to always add to the beginning of the list"},{p:"showMenu",ex:!0},{p:"showMenuRight",ex:!0},{p:"showTitle",ex:!0},{p:"showChildTitle",canCache:!0},{p:"showEntryIcon",ex:!0},{p:"layoutHere",ex:!0},{p:"headerCenter",ex:"false",tt:"Are the filter widgets centered"},{p:"headerDiv",tt:"div id of an alternate place to display the header"},{p:"footerDiv",tt:"div id of an alternate place to display the footer"},{p:"width",doGetter:!1,ex:"100%"},{p:"height",doGetter:!1,ex:"400px"},{p:"noWrapper",ex:!0,tt:"Don't make the header and footer. Just this core display"},{p:"imageWidth",canCache:!0},{p:"includeFieldDescriptionInTooltip",canCache:!0,d:!1},{p:"recordTemplate",doGetter:!1,ex:"${default}",tt:"Template for popups etc. Can be ${default attrs} or '${field} .. ${fieldn}...'"},{p:"recordHtmlStyle",canCache:!0},{p:"labelStyle",ex:""},{p:"title",ex:""},{p:"titleTemplate",ex:"${title} - ${field1} Date range: ${recordDate_first format=yyyymmdd} - ${recordDate_last format=yyyymmdd}",tt:"Template for title. Use ${title} for the default title. Use ${field} for field values of first record. Use ${field_first} for first record value. Use ${field_ast} for last record value "},{p:"labelColumnAttrs",canCache:!0,ex:"align,right",tt:"Attributes of the label column in the record templates"},{p:"labelWidth",canCache:!0,ex:"10",tt:"Width of labels the record templates"},{p:"displayStyle",ex:"css styles",tt:"Specify styles for display"},{p:"outerDisplayStyle",ex:"css styles",tt:"Specify styles for the entire display"},{p:"displayInline",ex:"true"},{p:"showTopHeader",ex:"true"},{p:"primaryPage",ex:"true",tt:"Set to true if you only want this display to show in the  primary for the entry "},{p:"titleBackground",ex:"color"},{p:"linkField",ex:""},{p:"titleField",ex:""},{p:"descriptionField",ex:""},{p:"textColor",ex:"color"},{p:"backgroundImage",ex:"",tt:"Image url to display in background"},{p:CSS_BACKGROUND,ex:"color"},{p:"showProgress",ex:!0},{p:"loadingMessage",ex:"",tt:"Message to show when loading data"},{p:"inlineDataSrc",tt:"div id that holds the CSV inline"},{p:"showRecordPager",ex:!0,tt:"Show the prev/next pager"},{p:"recordPagerNumber",d:100,tt:"How many records to show"},{p:"noun",ex:"images"},{p:"sortFields",tt:"Comma separated list of fields to sort the data on"},{p:"sortAscending",ex:"true|false",d:!0},{p:"showSortDirection",ex:!0},{p:"sortOnDate",ex:"true"},{p:"sortByFields",ex:"",tt:"Show sort by fields in a menu"},{p:"sortHighlight",ex:!0,tt:"Sort based on highlight from the filters"},{p:"reverse",ex:"true",t:"Reverse the records"},{p:"selectUniqueFields",ex:"",tt:"Show list of fields to make data unique"},{p:"dataUrl",tt:"Fixed URL to the JSON data"},{p:"doEntries",ex:!0,tt:"Make the children entries be data"},{p:"propagateDataReload",ex:"true",tt:"Propagate to other displays when the data is reloaded"},{p:"propagateFilteredTimes",ex:"true",tt:"Propagate to other displays the list of times when we have filtered data. The other displays need to have filteredTimes.accept=true "},{p:"addAttributes",ex:!0,tt:"Include the extra attributes of the children"},{p:"orderby",ex:"date|fromdate|todate|name|number",tt:"When showing entries as data how to sort or order the entries"},{p:"ascending",ex:"true",tt:"When showing entries as data how to sort or order the entries"},{p:"showDisplayFieldsMenu",ex:!0},{p:"displayFieldsMenuMultiple",ex:!0},{p:"displayFieldsMenuSide",ex:"left"},{p:"displayHeaderSide",ex:"left"},{p:"leftSideWidth",ex:"150px"},{label:"Tooltips"},{p:"tooltip",doGetter:!1,ex:'"${default}"'},{p:"tooltipDelay",d:1e3},{p:"tooltipEffect",d:"fadeIn"},{p:"tooltipDuration",d:500},{p:"tooltipImmediate",d:!1,ex:"true",tt:"Show tooltip immediately"},{p:"tooltipPositionMy",ex:POS_LEFT_TOP},{p:"tooltipPositionAt",ex:"left bottom+2"},{p:"tooltipCollision"},{p:"tooltipShowUnit",d:!0,ex:"false"},{p:"tooltipFields",canCache:!0},{p:"tooltipNotFields",d:""},{p:"tooltipShowGeo",tt:"show the record lat/lon in the tooltip",ex:"true"},{p:"itemsPerColumn",canCache:!0,d:50,tt:"How many items to show in each column in a tooltip"},{p:"showMapInTooltip",ex:!0,tt:"Include a map inside the tooltip or map popup"},{p:"tooltipMapLayer",d:"osm",tt:"The map layer to use in the popup"},{p:"selectPopup",ex:"${default}",tt:"Template to use to make a popup when a record is selected"},{p:"selectPopupTitle"},{p:"headerText",ex:'blah blah ${command labels="log scale,linear scale" xAxisType=log,linear} blah',tt:"Text to show above the display. Can contain ${command ...} templates"},{p:"headerTextDiv",tt:"divid to put header text in"},{label:"Formatting"},{p:"dateFormat",canCache:!0,ex:"yyyy|yyyymmdd|yyyymmddhh|yyyymmddhhmm|yyyymm|yearmonth|monthdayyear|monthday|mon_day|mdy|hhmm"},{p:"dateFormatDaysAgo",ex:!0},{p:"timeZone",canCache:!0},{p:"timeZoneOffset",canCache:!0,d:0},{p:"doFormatNumber",ex:!1},{p:"formatNumberDecimals",ex:0},{p:"formatNumberScale",ex:100},{p:"numberTemplate",ex:"${number}%"},{p:"formatNumberComma",ex:!0,tt:"Add commas to number format"},{p:"nanValue",d:"--",canCache:!0},{p:"&lt;field_id&gt;.&lt;format&gt;",ex:"..."},{label:"Data Requests"},{p:"remote",tt:"URL to an external RAMADDA entry",ex:""},{p:"request.startdate",tt:"Start date of data",ex:"yyyy-MM-dd or relative:-1 week|-6 months|-2 years|etc"},{p:"request.enddate",tt:"End date of data",ex:"yyyy-MM-dd or relative:-1 week|-6 months|-2 years|etc"},{p:"requestFields",ex:"date,stride,skip,limit,bounds,db columns...",tt:"Comma separated list of fields for querying server side data"},{p:"requestFieldsDefault",d:!0,tt:"Use the default date,stride,skip,limit fields"},{p:"requestFieldsShow",d:!0,ex:"false",tt:"Show the request fields"},{p:"requestPrefix",ex:"search.",tt:"Prefix to prepend to the url argument"},{p:"requestFieldsLive",d:!0,tt:"Is the request applied when a widget changes"},{p:"requestFieldsToggle",d:!1,tt:"Put the request fields in a toggle"},{p:"requestFieldsToggleOpen",d:!0,tt:"And leave the toggle open"},{p:"extraFields1",tt:"Extra request fields to show before",ex:"bounds"},{p:"extraFields2",tt:"Extra request fields to show after",ex:"bounds"},{p:"request.&lt;field&gt;.multiple",ex:"true",tt:"Support multiple enumerated selections"},{p:"request.&lt;field&gt;.type",tt:"date,number,enumeration"},{p:"request.&lt;field&gt;.values",tt:"Comma separated list of enum values",d:"0:None,1,2,3,4,5,6,7,8,9,10,15,20,30,40,50,75,100"},{p:"request.&lt;field&gt;.visible",d:!0},{p:"request.&lt;field&gt;.default",tt:"Default value"},{p:"request.&lt;field&gt;_from.default",tt:"Default date from"},{p:"request.&lt;field&gt;_to.default",tt:"Default date to"},{p:"request.&lt;field&gt;.multiple",d:!1,tt:"For enums show multiples"},{p:"request.&lt;field&gt;.rows",d:4,tt:"For multiple enums how may rows to show"},{p:"request.&lt;field&gt;.includeNone",d:!0,tt:"For enums include the none value"},{p:"request.&lt;field&gt;.includeAll",d:!0,tt:"For enums include the all value"},{p:"request.&lt;field&gt;.triggerReload",d:!0,tt:""},{p:"request.&lt;field&gt;.title",tt:"Tooltip"},{p:"request.&lt;field&gt;.urlarg",t:"url arg to use"},{label:"Filter Data"},{p:"headerLabel",ex:""},{p:"max",ex:"1000",tt:"Specify the max number of records to fetch from the server"},{p:"lastRecords",ex:"1",tt:"Only get the last N records from the server"},{p:"maxRecords",tt:"only use this number of records"},{p:"fieldsNumeric",ex:!0,tt:"Only get numeric fields"},{p:"filterFields",ex:""},{p:"filterFieldsToPropagate"},{p:"filterSetValueFieldId",tt:"when a record is selected in another display this is the field to set the filter value on the target display"},{p:"hideFilterWidget",ex:!0},{p:"filterHighlight",d:!1,ex:!0,tt:"Highlight the records"},{p:"isMasterFilter",ex:!0,tt:"Does this display provide filters for all the other displays"},{p:"showFilterTags",d:!1,canCache:!0},{p:"tagDiv",tt:"Div id to show tags in"},{p:"showFilterHighlight",ex:!1,tt:"show/hide the filter highlight widget"},{p:"unhighlightColor",d:"#eee",canCache:!0},{p:"headerOrientation",ex:"vertical"},{p:"filterSliderImmediate",ex:!0,tt:"Apply the change while sliding"},{p:"filterLogic",ex:"and|or",tt:"Specify logic to apply filters"},{p:"&lt;field&gt;.type",ex:"enumeration|string|boolean"},{p:"&lt;field&gt;.filterShow",ex:"false"},{p:"&lt;field&gt;.filterLabel"},{p:"&lt;field&gt;.filterValue"},{p:"&lt;field&gt;.filterValueMin"},{p:"&lt;field&gt;.filterValueMax"},{p:"&lt;field&gt;.filterValues"},{p:"&lt;field&gt;.filterMultiple",ex:!0},{p:"&lt;field&gt;.filterMultipleSize",ex:5},{p:"&lt;field&gt;.filterIncludeAll",ex:!0},{p:"&lt;field&gt;.filterShowPopup",tt:"Show the popup dialog button",ex:!0},{p:"&lt;field&gt;.filterDepends",ex:"other_field",tt:"Filter field that this filter depends on"},{p:"filterLive",ex:"true",tt:"Search live as the user presses a key"},{p:"&lt;field&gt;.filterLive",ex:"true",tt:"Search live as the user presses a key"},{p:"&lt;field&gt;.filterDateSelects",ex:"-30 days:Last 30 days,-60 days:Last 60 days,-90 days:Last 90 days,ytd:Year to date,thisyear:This year,year_2022:2022",tt:"Add a menu of select choices for dates"},{p:"&lt;field&gt;.filterDateShowRange",ex:!0},{p:"&lt;field&gt;.filterDateShowRadio",ex:!0},{p:"filterDateSelectRadio",ex:!0},{p:"filterShowCount",ex:!1},{p:"filterShowTotal",ex:!0},{p:"&lt;field&gt;.filterLabel"},{p:"&lt;field&gt;.showFilterLabel"},{p:"&lt;field&gt;.filterLabelVertical",ex:!0},{p:"filterLabelVertical",ex:!0},{p:"&lt;field&gt;.filterByStyle",ex:"background:white;"},{p:"&lt;field&gt;.filterSuggest",tt:"For text input popup a list of matching records",ex:!0},{p:"&lt;field&gt;.includeAll",ex:!0},{p:"&lt;field&gt;.filterSort",ex:!0},{p:"&lt;field&gt;.filterSortCount",ex:!0},{p:"&lt;field&gt;.filterStartsWith",ex:!0},{p:"&lt;field&gt;.filterDisplay",ex:"menu|tab|button|image"},{p:"&lt;field&gt;.filterOps",ex:"<,5000000,label1;>,5000000",tt:"Add menu with fixed filters"},{p:"excludeUndefined",ex:!0,tt:"Exclude any records with an undefined value"},{p:"excludeZero",ex:!0,tt:"Exclude any records with a 0 value"},{p:"filterPaginate",ex:"true",tt:"Show the record pagination"},{p:"pageCount",d:1e3,tt:"How many records to show when paginating"},{p:"recordSelectFilterFields",tt:"Set the value of other displays filter fields"},{p:"selectFields",ex:"prop:label:field1,...fieldN;prop:...."},{p:"dataFilters",canCache:!0},{p:"match value",ex:'dataFilters="match(field=field,value=value,label=,enabled=);"',tt:"Only show records that match"},{p:"not match value",ex:'dataFilters="notmatch(field=field,value=value,label=,enabled=);"',tt:"Only show records that dont match"},{p:"no missing values",ex:'dataFilters="nomissing(field=field,label=,enabled=);"',tt:"Dont show missing values"},{p:"less than",ex:'dataFilters="lessthan(field=field,value=value,label=,enabled=);"'},{p:"greater than",ex:'dataFilters="greaterthan(field=field,value=value,label=,enabled=);"'},{p:"equals",ex:'dataFilters="equals(field=field,value=value,label=,enabled=);"'},{p:"not equals",ex:'dataFilters="notequals(field=field,value=value,label=,enabled=);"'},{p:"filterLatest",ex:"fields",tt:"Only show the latest records grouped by fields"},{p:"filterDate",ex:"year",tt:"Show a simple pull down menu to select a year to display"},{p:"filterDateIncludeAll",ex:!0,tt:"Include all years"},{p:"startDate",ex:"yyyy,MM,dd,hh,mm,ss",tt:"Filter data on date"},{p:"endDate",ex:"yyyy,MM,dd,hh,mm,ss",tt:"Filter data on date"},{label:"Events"},{p:DisplayEvent.filterChanged.share,ex:!0,tt:"Share filter changed"},{p:DisplayEvent.filterChanged.accept,ex:!0,tt:"Accept filter changed"},{p:DisplayEvent.filterChanged.shareGroup,ex:"some group id",tt:"Only share in this group"},{p:DisplayEvent.filterChanged.acceptGroup,ex:"some group id",tt:"Only share in this group"},{p:DisplayEvent.filteredDataChanged.share,ex:!0,tt:"Share filtered data changed"},{p:DisplayEvent.filteredDataChanged.accept,ex:!0,tt:"Accept filtered data changed"},{p:DisplayEvent.filteredDataChanged.shareGroup,tt:"Only share in this group"},{p:DisplayEvent.filteredDataChanged.acceptGroup,tt:"Only share in this group"},{p:DisplayEvent.recordSelection.share,ex:!0,tt:"Share record selection"},{p:DisplayEvent.recordSelection.accept,ex:!0,tt:"Accept record selection"},{p:DisplayEvent.recordSelection.shareGroup,tt:"Only share in this group"},{p:DisplayEvent.recordSelection.acceptGroup,tt:"Only share in this group"},{p:"selectNearestDate",tt:"find the closest record"},{p:"acceptDateRange",tt:"Accept date range changes"},{p:DisplayEvent.recordHighlight.share,ex:!0,tt:"Share record highlight"},{p:DisplayEvent.recordHighlight.accept,ex:!0,tt:"Accept record highlight"},{p:DisplayEvent.recordHighlight.shareGroup,tt:"Only share in this group"},{p:DisplayEvent.recordHighlight.acceptGroup,tt:"Only share in this group"},{p:DisplayEvent.recordList.share,ex:!0,tt:"Share record list"},{p:DisplayEvent.recordList.accept,ex:!0,tt:"Accept record list"},{p:DisplayEvent.recordList.shareGroup,tt:"Only share in this group"},{p:DisplayEvent.recordList.acceptGroup,tt:"Only share in this group"},{p:DisplayEvent.fieldsChanged.share,ex:!0,tt:"Share fields changed"},{p:DisplayEvent.fieldsChanged.accept,ex:!0,tt:"Accept fields changed"},{p:DisplayEvent.fieldsChanged.shareGroup,tt:"Only share in this group"},{p:DisplayEvent.fieldsChanged.acceptGroup,tt:"Only share in this group"},{p:DisplayEvent.fieldsSelected.share,ex:!0,tt:"Share fields selected"},{p:DisplayEvent.fieldsSelected.accept,ex:!0,tt:"Accept fields selected"},{p:DisplayEvent.fieldsSelected.shareGroup,tt:"Only share in this group"},{p:DisplayEvent.fieldsSelected.acceptGroup,tt:"Only share in this group"},{p:DisplayEvent.setEntry.share,ex:!0,tt:"When displaying entries as data this shares the selected entry with other displays"},{p:DisplayEvent.setEntry.accept,ex:!0,tt:"When displaying entries as data this accepts the new entry"},{p:DisplayEvent.setEntry.shareGroup,tt:"When sharing the entry this groups what displays to share with"},{p:DisplayEvent.setEntry.acceptGroup,tt:"When sharing the entry this must match with the shareGroup"},{p:"acceptEventDataSelection",ex:!0,tt:"accept new data coming from other displays"},{p:"recordSelectField",tt:"Field to match selection on instead of date"},{label:"Convert Data"},{p:"applyConvertAfter",ex:!0},{p:"offset1",canCache:!0},{p:"offset2",canCache:!0},{p:"scale",canCache:!0},{p:"unit",canCache:!0},{p:"binDate",ex:"day|month|year",tt:"Bin the dates"},{p:"binType",ex:"count|average|total"},{p:"groupBy",ex:"field",tt:"Group the data"},{p:"aggregateBy",tt:"Add an extra row for the aggregated rows"},{p:"aggregateOperator",ex:"sum|percent",tt:"Operator to apply on the aggregated rows"},{p:"aggregateOperator.fieldName",ex:"sum|percent",tt:"Operator to apply on the aggregated rows for the given field"},{p:"convertData",label:"Derived data",ex:"derived(field=new_field_id, function=foo*bar);",tt:"Add derived field"},{p:"convertData",label:"Convert date",ex:"roundDate(round=hour|day|week|month|year);"},{p:"convertData",label:"Filter date",ex:"filterDate(one of month=0);",tt:"Round the dates"},{p:"convertData",label:"Nominal time",ex:"groupTime(field=field to group time on);",tt:"Round the dates"},{p:"convertData",label:"Replace",ex:"replace(fields=field_ids, pattern=,with=);",tt:"Replace pattern in text field"},{p:"convertData",label:"Merge rows",ex:"mergeRows(keyFields=f1\\\\,f2, operator=count|sum|average, valueFields=);",tt:"Merge rows together"},{p:"convertData",label:"Percent increase",ex:"addPercentIncrease(replaceValues=false);",tt:"Add percent increase"},{p:"convertData",label:"Doubling rate",ex:"doublingRate(fields=f1\\\\,f2, keyFields=f3);",tt:"Calculate # days to double"},{p:"convertData",label:"Add fixed",ex:'"addFixed(id=max_pool_elevation\\\\,value=3700,type=double);"',tt:"add fixed value"},{p:"convertData",label:"Accumulate data",ex:"accum(fields=);",tt:"Accumulate"},{p:"convertData",label:"Add an average field",ex:"mean(fields=);",tt:"Mean"},{p:"convertData",label:"Unique rows",ex:"unique(groupFields=f1\\\\,f2,valueField=);",tt:"Uniquify rows"},{p:"convertData",label:"Count uniques",ex:"count(field=,sort=true);",tt:"Count uniques"},{p:"convertData",label:"Unfurl",ex:"unfurl(headerField=field to get header from,uniqueField=e.g. date,valueFields=);",tt:"Unfurl"},{p:"convertData",label:"Rotate data",ex:"rotateData(includeFields=true,includeDate=true,flipColumns=true);",tt:"Rotate data"},{p:"convertData",label:"Prune where fields are all NaN",ex:"prune(fields=);",tt:"Prune"},{p:"convertData",label:"Scale and offset",ex:"accum(scale=1,offset1=0,offset2=0,unit=,fields=);",tt:"(d + offset1) * scale + offset2"},{p:"convertDataPost",label:"Same as above but after filtering is done",tt:"Same as above but after filtering is done"},{label:"Color"},{p:"colors",ex:"color1,...,colorN",tt:"Comma separated array of colors"},{p:"colorBy",ex:"",tt:"Field id to color by"},{p:"colorByFields",ex:"",tt:"Show color by fields in a menu"},{p:"colorByLog",ex:"true",tt:"Use a log scale for the color by"},{p:"colorByMap",ex:"value1:color1,...,valueN:colorN",tt:"Specify colors for color by text values"},{p:"colorByLiteral",ex:"true",tt:"use the value as a color"},{p:"colorTableAlpha",ex:.5,tt:"Set transparency on color table values"},{p:"colorTableInverse",ex:!0,tt:"Inverse the color table"},{p:"colorTablePruneLeft",ex:"N",tt:"Prune first N colors"},{p:"colorTablePruneRight",ex:"N",tt:"Prune last N colors"},{p:"colorByMin",ex:"value",tt:"Min scale value"},{p:"colorByMax",ex:"value",tt:"Max scale value"},{p:"colorScale",tt:"a semi-colon delimited list of min,max,color1,color2",ex:"9,14.99,palegreen,darkgreen;15,19.99,#ffc966,#ffa500;20, 24.99,red,darkred;25, 27.99,mediumpurple,purple"},{p:"nullColor",ex:COLOR_TRANSPARENT},{p:"showColorTable",ex:"false",tt:"Display the color table"},{p:"colorTableLabel",ex:"Colored by ${field}"},{p:"colorTableDisplayId",tt:"Dom id to where to place the color table"},{p:"colorTableDots",ex:!0,tt:"Show as dots"},{p:"colorTableDotsWidth",ex:"24px"},{p:"colorTableDotsDecimals",ex:"0"},{p:"colorTableSide",ex:"bottom|right|left|top"},{p:"showColorTableStride",ex:1,tt:"How many colors should be shown"},{p:"colorByAllRecords",ex:!0,tt:"use all records for color range"},{p:"convertColorIntensity",ex:!0},{p:"intensitySourceMin",ex:"0"},{p:"intensitySourceMax",ex:100},{p:"intensityTargetMin",ex:1},{p:"intensityTargetMax",ex:0},{p:"convertColorAlpha",ex:!0},{p:"alphaSourceMin",ex:0,tt:"map value into range then map it into transparency"},{p:"alphaSourceMax",ex:100,tt:"map value into range then map it into transparency"},{p:"alphaTargetMin",ex:0,tt:"map value into range then map it into transparency"},{p:"alphaTargetMax",ex:1,tt:"map value into range then map it into transparency"},{p:"alphaMin",ex:1,tt:"set to transparent any value below the alpha min"},{p:"alphaMax",ex:1,tt:"set to transparent any value above the alpha max"},{label:"Animation"},{p:"doAnimation",ex:!0,tt:"Enable animation"},{p:"animationMode",tt:"How to operate the animation, e.g. sliding, frame, cumulative",ex:"sliding|frame|cumulative"},{p:"animationUseIndex",ex:"true",tt:"Instead of animating on time animate on record index"},{p:"animationInitRange",ex:'start idx,end idx  e.g. "-50,end" or "0,10" or "0,end"'},{p:"animationHighlightRecord",ex:!0},{p:"animationHighlightRecordList",ex:!0},{p:"animationPropagateRecordSelection",ex:!0,tt:"If the animation is in frame mode then propagate the date"},{p:"animationAcceptRecordSelection",ex:!0,tt:"change the animation date on record select"},{p:"acceptEventAnimationChange",ex:!1},{p:"acceptDateRangeChange",ex:!0},{p:"animationDateFormat",ex:"yyyy|yyyymmdd|yyyymmddhh|yyyymmddhhmm|yyyymm|yearmonth|monthdayyear|monthday|mon_day|mdy|hhmm"},{p:"animationLabelTemplate"},{p:"animationLabelSize",ex:"12pt"},{p:"animationStyle"},{p:"animationTooltipShow",ex:"true"},{p:"animationTooltipDateFormat",ex:"yyyy|yyyymmdd|yyyymmddhh|yyyymmddhhmm|yyyymm|yearmonth|monthdayyear|monthday|mon_day|mdy|hhmm"},{p:"animationWindow",ex:"1 minute|1 hour|1 day|2 weeks|3 months|1 year|2 decades|etc",tt:"When in sliding mode this is the width of the window"},{p:"animationStep",ex:"1 minute|1 hour|1 day|2 weeks|3 months|1 year|2 decades|etc",tt:"When in sliding or cumulative mode this is the step size"},{p:"animationSpeed",ex:500},{p:"animationLoop",ex:!0},{p:"animationDwell",ex:1e3},{p:"animationStartShowAll",ex:!0,tt:"Show full range at start"},{p:"animationShowButtons",ex:!1},{p:"animationShowLabel",ex:!1},{p:"animationShowSlider",ex:!1},{p:"animationWidgetShort",ex:!0},{p:"selectFirst",ex:!0,tt:"Select the first record when animating so other displays will hilight it"},{p:"selectLast",ex:!0,tt:"Select the last record when animating so other displays will hilight it"}],{displayReady:Utils.getPageLoaded(),type:s,displayManager:e,filters:[],dataCollection:new DataCollection,selectedCbx:[],entries:[],wikiAttrs:["title","showTitle","showDetails","minDate","maxDate"],_properties:[],callHook:function(e,t,i,s,l){return e="hook_"+e,"none"==(e=this.getProperty(e,e))?null:(window[e]||(e=this.type+"_"+e),window[e]?window[e](this,t,i,s,l):void 0)},getWikiEditorTags:function(){return this._wikiTags},getTypeDef:function(){return this.typeDef},getTypeLabel:function(){return this.typeDef?this.typeDef.label:null},getTypeHelpUrl:function(){if(!this.typeDef)return null;let e=this.typeDef.helpUrl;return e?!0===e?"https://ramadda.org/repository/alias/help_"+this.typeDef.type:e:null},defineSizeByProperties:function(){this.defineProperties([{inlineLabel:"Size By"},{p:"sizeBy",ex:"field",tt:"Field to size points by"},{p:"sizeByLog",ex:!0,tt:"Use log scale for size by"},{p:"sizeByMap",ex:"value1:size,...,valueN:size",tt:"Define sizes if sizeBy is text"},{p:"sizeByRadiusMin",ex:"2",tt:"Scale size by"},{p:"sizeByRadiusMax",ex:"20",tt:"Scale size by"},{p:"sizeByLegendSide",ex:"bottom|top|left|right"},,{p:"sizeByLegendStyle"},{p:"sizeByLegendLabel"},{p:"sizeBySteps",ex:"value1:size1,v2:s2,...",tt:"Use steps for sizes"}])},getDisplayManager:function(){return this.displayManager},getLayoutManager:function(){let e=this.getDisplayManager();return e.getLayoutManager?e.getLayoutManager():null},createTagDialog:function(e,t,i,s,l){let a=HU.div([ATTR_STYLE,HU.css(CSS_MARGIN,HU.px(5),CSS_WIDTH,HU.px(600),CSS_MAX_HEIGHT,HU.px(300),CSS_OVERFLOW_Y,OVERFLOW_AUTO)],Utils.wrap(e,"","")),r=HU.getUniqueId("input_"),o=HU.input("","",[ATTR_STYLE,HU.css(CSS_WIDTH,HU.px(300)),ATTR_PLACEHOLDER,"Search for "+l.toLowerCase(),ATTR_ID,r]),n=HU.div([ATTR_STYLE,HU.css(CSS_MARGIN,HU.px(10))],HU.center(o)+a);this.tagDialogs||(this.tagDialogs={}),this.tagDialogs[s]&&this.tagDialogs[s].remove();let h=HU.makeDialog({content:n,anchor:t,title:l,draggable:!0,header:!0});this.tagDialogs[s]=h,h.find(":checkbox").change(i);let d=h.find(".display-search-tag");return jqid("#"+r).keyup((function(e){let t=$(this).val().trim().toLowerCase();d.each((function(){if(""==t)$(this).show();else{let e=$(this).attr("tag");e&&(e=e.toLowerCase(),e.indexOf(t)>=0?$(this).show():$(this).hide())}}))})),h},getAnimationEnabled:function(){return this.getProperty("doAnimation",!1)},getAnimation:function(){return this.animationControl||(this.animationControl=new DisplayAnimation(this,this.getAnimationEnabled())),this.animationControl},propagateEvent:function(e,t,i){this.getDisplayManager().notifyEvent(e,i?null:this,t)},displayError:function(e){this.displayHtml(HU.getErrorDialog(e))},clearHtml:function(){this.displayHtml("")},displayHtml:function(e){this.setContents(e)},getEventHandler:function(e){return this[e.handler]},notifyEvent:function(e,t,i){let s=this.getEventHandler(e);null!=s?(displayDebug.notifyEvent&&console.log(this.getLogLabel()+".notifyEvent calling function:"+s.name),s.apply(this,[t,i])):displayDebug.notifyEventAll&&console.log(this.type+".notifyEvent no event handler function:"+e.name+" "+e.handler)},wikify:function(e,t,i,s,l){l&&(i=e=>{this.addWikiHtml(jqid(l),e)},s=e=>{jqid(l).html(e)}),s=s??(e=>{this.handleError(e)});let a=RamaddaUtil.getUrl("/wikify");ramaddaDoingWiki++;$.post(a,{doImports:"false",entryid:t??this.getProperty("entryId"),wikitext:e},(e=>{i(e),ramaddaDoingWiki--})).fail((e=>{console.log("handle error"),ramaddaDoingWiki--,s(e)}))},myDisplayCount:DISPLAY_COUNT++,logMsg:function(e,t){let i=this.getLogLabel();if(t){let e=new Date;i+=e.getMinutes()+":"+e.getSeconds()+":"+e.getMilliseconds()}i+=": ",console.log(i+e)},getLogLabel:function(){let e=this.type+"#"+this.myDisplayCount,t=this.getProperty("name");return t&&(e+=" ["+t+"]"),e},getColorTableHorizontal:function(){return"bottom"==this.getProperty("colorTableSide","bottom")||"top"==this.getProperty("colorTableSide","bottom")},displayColorTableHtml:function(e,t){t=this.getColorTableDisplayId()??this.domId(t),jqid(t).html(e)},displayColorTable:function(e,t,i,s,l){t=this.getColorTableDisplayId()??this.domId(t),i&&i.getTime&&(i=this.formatDate(i)),s&&s.getTime&&(s=this.formatDate(s)),l||(l={});let a=l.field?l.field.getId()+".":"",r=(e,t)=>this.getProperty(a+e,this.getProperty(e,t));l.field&&(l.title=l.field.getLabel()),l.showColorTableDots=this.getProperty(a+"showColorTableDots",this.getColorTableDots(this.getProperty("showColorTableDots"))),l.dotWidth=r("colorTableDotsWidth"),l.decimals=r("colorTableDotsDecimals",-1),l.showRange=r("colorTableShowRange");let o=r("colorTableLabels");l.labels=o?o.split(","):null,l.labelStyle=r("colorTableLabelStyle"),l.horizontal=this.getColorTableHorizontal(),l.stride=r("showColorTableStride",1),Utils.displayColorTable(e,t,i,s,l);let n=l.label??this.getProperty((l.field?l.field.getId():"")+".colorTableLabel",this.getColorTableLabel()),h=jqid(t);if(n&&(l.field&&(n=n.replace("${field}",l.field.getLabel(!1,!0))),l.showColorTableDots?h.prepend(HU.center(n)):h.append(HU.center(n))),!l||!l.colorByInfo)return;h.find(".display-colortable-slice").css(CSS_CURSOR,CURSOR_POINTER);let d=this;this.originalColorRange||(this.originalColorRange=[i,s]),h.find(".display-colortable-slice").click((function(e){$(this).attr(ATTR_DATA_VALUE);let t="",l=[];l.push(HU.boldLabel("Range")+HU.input("",i,[ATTR_SIZE,4,ATTR_CLASS,"colortable-min"])+" - "+HU.input("",s,[ATTR_SIZE,4,ATTR_CLASS,"colortable-max"])),l.push(HU.div([ATTR_CLASS,HU.classes(CLASS_CLICKABLE,CLASS_MENU_ITEM),ATTR_WHAT,"reset"],"Reset range"),HU.div([ATTR_CLASS,HU.classes(CLASS_CLICKABLE,CLASS_MENU_ITEM),ATTR_WHAT,"ussedata"],"Use data range")),l.push(HU.checkbox("colortableuselog",[ATTR_ID,"colortableuselog"],d.getProperty("colorByLog"),"Use Log Scale")),t=Utils.wrap(l,HU.open(TAG_DIV,[ATTR_STYLE,HU.css(CSS_MARGIN_BOTTOM,HU.px(4))]),HU.close(TAG_DIV)),t=HU.hbox([t,HU.space(3),HU.b("Color Table")+HU.br()+Utils.getColorTablePopup({showToggle:!1})]),t=HU.div([ATTR_STYLE,HU.css(CSS_PADDING,HU.px(8))],t),d.colorTableDialog&&d.colorTableDialog.remove();let a=d.colorTableDialog=HU.makeDialog({content:t,title:"Color Table Settings",anchor:$(this),draggable:!0,header:!0}),r=a.find(".colortable-min"),o=a.find(".colortable-max");r.keypress((function(e){13==(e.keyCode?e.keyCode:e.which)&&(Utils.isDefined(d.getProperty("colorByMinOrig"))||d.setProperty("colorByMinOrig",d.getProperty("colorByMin")),d.setProperty("colorByMin",$(this).val()),d.setProperty("overrideColorRange",!0),d.forceUpdateUI())})),o.keypress((function(e){13==(e.keyCode?e.keyCode:e.which)&&(Utils.isDefined(d.getProperty("colorByMaxOrig"))||d.setProperty("colorByMaxOrig",d.getProperty("colorByMax")),d.setProperty("colorByMax",$(this).val()),d.setProperty("overrideColorRange",!0),d.forceUpdateUI())})),a.find(HU.dotClass(CLASS_COLORTABLE_SELECT)).click((function(){let e=$(this).attr(ATTR_COLORTABLE);e&&(d.setProperty("colorTable",e),d.forceUpdateUI())})),a.find("#colortableuselog").change((function(){d.setProperty("colorByLog",HU.isChecked($(this))),d.forceUpdateUI()})),a.find(HU.dotClass(CLASS_MENU_ITEM)).button().click((function(){let e=$(this).attr(ATTR_WHAT);d.setProperty("useDataForColorRange",!1),"reset"==e?(d.setProperty("colorByMin",d.getProperty("colorByMinOrig")),d.setProperty("colorByMax",d.getProperty("colorByMaxOrig")),d.setProperty("overrideColorRange",!1)):"ussedata"==e&&d.setProperty("useDataForColorRange",!0),d.forceUpdateUI(),r.val(d.getProperty("colorByMinOrig")??i),o.val(d.getProperty("colorByMaxOrig")??s)}))}))},getColorList:function(){if(this.colorList&&this.colorList.length>0)return this.colorList;if(this.getProperty("colors")&&"default"!=this.getProperty("colors")){let e=this.getProperty("colors");Array.isArray(e)||(e=e.split(",")),this.colorList=e}return this.colorList&&0!=this.colorList.length||(this.colorList=["blue","red","green","orange","fuchsia","aqua","navy","brown","cadetblue","blueviolet","coral","cornflowerblue","darkcyan","darkgoldenrod","darkorange","darkseagreen"]),this.colorList},getColorTableName:function(e){e&&!Array.isArray(e)&&(e=[e]);let t=null;if(e)e.every((e=>(t=this.getProperty(e),!t||(displayDebug.colorTable&&this.logMsg("getColorTableName: name:"+e+" ct1:"+t),!1))));else{let e=this.getProperty("colorBy");e&&(t=this.getProperty("colorTable."+e),t&&displayDebug.colorTable&&this.logMsg("getColorTableName: colorTable."+e+" ct2:"+t)),t||(t=this.getProperty("colorBar",this.getProperty("colorTable")),t&&displayDebug.colorTable&&this.logMsg("getColorTableName: ct3:"+t))}return"none"==t?null:(displayDebug.colorTable&&this.logMsg("getColorTableName:"+e+" color table:"+t),t)},getColorTable:function(e,t,i){if(t&&!Array.isArray(t)&&(t=[t]),t&&(t=t.filter((e=>null!=e))),t&&e&&this.dynamicProperties&&t.includes("colorTable")){let e=!1;if(t.every((t=>(this.dynamicProperties[t]&&(e=!0),!e))),!e&&this.dynamicProperties.colors){let e=this.dynamicProperties.colors;if(!Array.isArray(e))return e=e.replace(/\\,/g,"_comma_"),e=e.split(","),e=e.map((e=>e.replace(/_comma_/g,","))),e}}let s=this.getColorTableName(t);return s||(s=i),displayDebug.colorTable&&this.logMsg("CT:"+t+" "+e+" name:"+s),this.getColorTableInner(e,s)},getColorTableInner:function(e,t){let i;if(t){let s=null;return t.startsWith("colors:")?(i=t.substring("colors:".length).split(","),this.convertColors(i)):(s=Utils.ColorTables[t],s&&e?this.convertColors(s.colors):!s&&name?this.convertColors(t.split(",")):s)}if(this.getProperty("colors")&&"default"!=this.getProperty("colors")){let e=this.getProperty("colors");return"object"!=typeof e&&(e=e.split(",")),this.convertColors(e)}return null},addAlpha:function(e,t){if(!e)return null;if(t=Utils.isDefined(t)?t:this.getProperty("colorTableAlpha"),!Utils.isDefined(t))return e;e=Utils.cloneList(e);let i=[];return e.forEach((e=>{i.push(Utils.addAlphaToColor(e,t))})),i},convertColors:function(e){if(e=this.addAlpha(e),this.getColorTableInverse()){let t=[];for(let i=e.length-1;i>=0;i--)t.push(e[i]);e=t}if(this.getProperty("colorTablePruneLeft")){let t=[];for(let i=+this.getProperty("colorTablePruneLeft");i<e.length;i++)t.push(e[i]);e=t}if(this.getProperty("colorTablePruneRight")){let t=[],i=+this.getProperty("colorTablePruneRight");for(let s=0;s<e.length-i;s++)t.push(e[s]);e=t}return e},getColorByColors:function(e,t){let i=this.getProperty("colorBy");if(!i)return null;let s=this.getFieldById(fields,i);if(!s)return null;let l=this.getColumnValues(e,s),a=this.getColorTable();if(a||(a=Utils.getColorTable(t||"blue_white_red")),!a)return null;let r=parseFloat(this.getProperty("colorByMin",l.min)),o=parseFloat(this.getProperty("colorByMax",l.max));a.colors&&(a=a.colors);let n=o-r,h=[];for(let e=0;e<l.values.length;e++){let t=l.values[e],i=parseInt((t-r)/n*a.length);i>=a.length?i=a.length-1:i<0&&(i=0),h.push(a[i])}return{colors:h,min:r,max:o}},getDefaultGridByArgs:function(){let e=this.getProperty("doHeatmap",!1),t={display:this,shape:this.getProperty("cellShape","rect"),color:this.getProperty("cellColor","blue"),stroke:!this.getProperty("cellFilled",!0),cellSize:this.getProperty("cellSize",e?0:4),cellSizeH:this.getProperty("cellSizeH",20),cellSizeHBase:this.getProperty("cellSizeHBase",0),cell3D:this.getProperty("cell3D",!1),cellShowText:this.getProperty("cellShowText",!1),cellLabels:Utils.split(this.getProperty("cellLabels")),cellFonts:Utils.split(this.getProperty("cellFonts")),cellLabelColors:Utils.split(this.getProperty("cellLabelColor")),cellLabelPositions:Utils.split(this.getProperty("cellLabelPositions")),cellLabelOffsetsX:Utils.split(this.getProperty("cellLabelOffsetsX")),cellLabelOffsetsY:Utils.split(this.getProperty("cellLabelOffsetsY")),doHeatmap:e,operator:this.getProperty("hm.operator",this.getProperty("hmOperator","count")),filter:this.getProperty("hm.filter",this.getProperty("hmFilter"))};return t.cellSizeX=+this.getProperty("cellSizeX",t.cellSize),t.cellSizeY=+this.getProperty("cellSizeY",t.cellSize),t},getIconMap:function(){let e,t=this.getProperty("iconMap");if(t){let i=t.split(",");e={};for(let t=0;t<i.length;t++){let s=i[t].split(":");s.length>1&&(e[s[0]]=s[1])}}return e},getColorByInfo:function(e,t,i,s,l,a,r){if(this.getColorByAllRecords()&&(e=this.getRecords()),!e)return null;return new ColorByInfo(this,this.getFields()??[],e,t,i,s,l,null,r,a)},getColorByMap:function(e){return e=this.getProperty(e||"colorByMap"),this.debugGetProperty=!1,Utils.parseMap(e)},toString:function(){return this.type+" - "+this.getId()},getType:function(){return this.type},getClass:function(e){return null==e?this.getBaseClass():this.getBaseClass()+"-"+e},getBaseClass:function(){return"display-"+this.getType()},setDisplayManager:function(e){this.displayManager=e,this.setDisplayParent(e.getLayoutManager())},setContents:function(e,t){this.clearDisplayMessage(),t||(e=HU.div([ATTR_STYLE,this.getProperty("displayInnerStyle",""),ATTR_CLASS,"display-contents-inner display-"+this.getType()+"-inner"],e)),this.writeHtml(ID_DISPLAY_CONTENTS,e)},addEntry:function(e){this.entries.push(e)},clearCachedData:function(){},setEntry:function(e){if(displayDebug.setEntry&&this.logMsg("setEntry:"+e),this.entries=[],this.addEntry(e),this.entry=e,this.entryId=e.getId(),this.clearCachedData(),this.properties.theData){this.cacheUrl=null,this.dataCollection=new DataCollection;let t={entryId:this.entryId,lat:this.getProperty("latitude"),lon:this.getProperty("longitude")},i=this.properties.theData.url;i=i?i.replace(/entryid=.*?&/,"entryid="+e.getId()+"&"):HU.url(this.getRamadda().getRoot()+URL_ENTRY_SHOW,ARG_ENTRYID,e.getId(),ARG_OUTPUT,"points.product","product","points.json","max",5e3),this.properties.theData=this.data=new PointData(e.getName(),null,null,i,t),this.startProgress(),displayDebug.setEntry&&this.logMsg("setEntry: calling loadData:"+i),this.data.loadData(this)}else this.callUpdateUI();this.getShowTitle()&&this.jq(ID_TITLE).html(e.getName())},getTextColor:function(e,t){return e?this.getProperty(e,this.getProperty("textColor",t)):this.getProperty("textColor",COLOR_BLACK)},getTitleHtml:function(e){let t="";if(this.getShowTitle()){let i=HU.css(CSS_COLOR,this.getTextColor("titleColor",COLOR_BLACK)),s=this.getProperty("titleBackground");s&&(i+=HU.css(CSS_BACKGROUND,s,CSS_PADDING,HU.px(2),CSS_PADDING_RIGHT,HU.px(6),CSS_PADDING_LEFT,HU.px(6))),t=this.getShowTitle()?this.getDisplayTitle(e):"";let l=this.getProperty("entryId")||this.entryId;l&&(t=HU.href(this.getRamadda().getEntryUrl(l),t,[ATTR_CLASS,"display-title",ATTR_STYLE,i])),t=HU.span([ATTR_ID,this.domId(ID_TITLE)],t)}if(this.getProperty("showEntryIcon")){let e=this.getProperty("entryIcon");e&&(t=HU.image(e)+" "+t)}return t},handleEventMapClick:function(e,t){if(!this.dataCollection)return;let i=this.dataCollection.getList();for(let s=0;s<i.length;s++)i[s].handleEventMapClick(this,e,t.lon,t.lat)},acceptEvent:function(e,t){return this.getProperty(e.accept,t)},shareEvent:function(e,t){return this.getProperty(e.share,t)},handleEventMapBoundsChanged:function(e,t){this.acceptEvent(DisplayEvent.mapBoundsChanged,this.getProperty("acceptBoundsChange"))&&(this.filterBounds=t.bounds,this.callUpdateUI())},handleEventFilterFieldsSelected:function(e,t){if(t.length>0&&"string"==typeof t[0]){let e=[];t.forEach((t=>{(t=this.getFieldById(null,t))&&e.push(t)})),t=e}let i="";t.forEach((e=>{""!=i&&(i+=","),i+=e.getId()})),this.setProperty("filterFields",i),this.haveCalledUpdateUI=!1,this.checkSearchBar()},handleEventFieldValueSelected:function(e,t){this.setProperty("filterPattern",t.value),this.setProperty("patternFilterField",t.field.getId()),this.callUpdateUI()},setDateRange:function(e,t,i){this.minDateObj=e,this.maxDateObj=t,this.dateRangeDoDay=i},handleDateRangeChanged:function(e,t){this.setDateRange(t.minDate,t.maxDate),this.getAnimation().getEnabled()&&this.getAnimation().setDateRange(t.minDate,t.maxDate),this.haveCalledUpdateUI=!1,this.dataFilterChanged()},displayFieldsChanged:function(e,t){if(this.addToDocumentUrl(PROP_FIELDS,e),this.setProperty(PROP_FIELDS,e),this.callUpdateUI(),this.displayFieldsMenuEnums&&t&&this.getProperty("showDisplayFieldsMenu")){this.jq("displayfields").val(e)}},handleEventFilterChanged:function(e,t){if(!this.acceptEvent(DisplayEvent.filterChanged,this.getProperty("acceptEventFilter",!0)))return;this.haveCalledUpdateUI=!1;let i=t.properties;i||(i=[],i.push(t)),this.settingFilterValue=!0,i.forEach((e=>{let t=this.filterMap?this.filterMap[e.fieldId]:null;if(!t)return;let i=this.getFilterId(e.fieldId);e.id&&e.id.endsWith("date_from")?i+="_date_from":e.id&&e.id.endsWith("date_to")&&(i+="_date_to"),"_highlight"==e.fieldId?(this.jq(ID_FILTER_HIGHLIGHT).val(e.value),this.setProperty("filterHighlight","highlight"==e.value),this.dfltFilterHighlight=null):Utils.isDefined(e.value2)?(jqid(i+"_min").val(e.value),jqid(i+"_min").attr(ATTR_DATA_VALUE,e.value),jqid(i+"_max").val(e.value2),jqid(i+"_max").attr(ATTR_DATA_VALUE,e.value2)):t.handleEventPropertyChanged(e)})),this.settingFilterValue=!1,this.dataFilterChanged()},handleEventPropertyChanged:function(e,t){let i=displayDebug.handleEventPropertyChanged;if("dateRange"!=t.property)if("displayFields"!=t.property){if("macroValue"==t.property){if(t.entryId!=this.entryId)return;if(!this.getProperty("acceptRequestChangeEvent",!0))return;let e=this.getRequestMacros(),s=null;if(e.every((e=>!e.isMacro(t.id)||(s=e,!1))),!s)return;if("date"==s.type)return;if(!this.getProperty("request."+s.name+".acceptChangeEvent",!0))return;return s.setValue(t),i&&console.log(this.getId()+" event-reloading"),void this.reloadData()}this.setProperty(t.property,t.value),this.callUpdateUI()}else{if(!this.acceptEvent(DisplayEvent.fieldsChanged,!this.getProperty("acceptEventDisplayFieldsChange",!1)))return;this.displayFieldsChanged(t.value,!0)}else this.getProperty("acceptDateRangeChange")&&this.handleDateRangeChanged(e,t)},handleEventRecordList:function(e,t){this.getAnimationEnabled()&&this.getProperty("animationHighlightRecordList")&&this.getAnimation().setRecordListHighlight(t.recordList),this.getProperty("acceptEventRecordList",!1)&&(this.recordListOverride=t.recordList,this.haveCalledUpdateUI=!1,this.callUpdateUI())},handleEventRecordHighlight:function(e,t){this.getAnimation().getEnabled()&&!t.skipAnimation&&this.getAnimation().handleEventRecordHighlight(e,t)},handleEventAnimationChanged:function(e,t){this.getProperty("acceptEventAnimationChange",!0)&&this.getAnimation().getEnabled()&&this.getAnimation().handleEventAnimationChanged(t)},handleEventSetEntry:function(e,t){this.acceptEvent(DisplayEvent.setEntry,this.getProperty(DisplayEvent.setEntry.acceptGroup,this.getProperty("acceptShareSelectedEntry",!1)))?(displayDebug.setEntry&&console.log(this.type+".handleEventSetEntry calling setEntry:"+t.entry),this.setEntry(t.entry)):displayDebug.setEntry&&console.log(this.type+".handleEventSetEntry not calling setEntry:"+t.entry)},propagateEventRecordSelection:function(e){if(this.getSelectPopup()&&e.record){let t=this.applyRecordTemplate(e.record,this.getDataValues(e.record),null,this.getSelectPopup());this.showDialog(t,null,null,this.getSelectPopupTitle())}if(displayDebug.notifyEvent&&console.log(this.type+".propagateEventRecordSelection"),this.shareEvent(DisplayEvent.setEntry,this.getProperty(DisplayEvent.setEntry.shareGroup,this.getProperty("shareSelectedEntry")))){let t=e.record.getValueFromField(ATTR_ID);if(displayDebug.setEntry&&console.log(this.type+" sharing entry:"+t),t){let e=this;setTimeout((async function(){await getGlobalRamadda().getEntry(t,(t=>{displayDebug.setEntry&&console.log(e.type+" calling notifyEvent with entry:"+t),e.getDisplayManager().notifyEvent(DisplayEvent.setEntry,e,{entry:t})}))}))}}if(this.shareEvent(DisplayEvent.recordSelection,!0)&&this.getDisplayManager().notifyEvent(DisplayEvent.recordSelection,this,e),this.getProperty("recordSelectFilterFields")){let t=this.getFieldsByIds(null,this.getProperty("recordSelectFilterFields"));if(t&&t.length>0){let i={properties:[]};t.forEach((t=>{i.properties.push({id:t.getId(),fieldId:t.getId(),value:e.record.getValue(t.getIndex())})})),this.propagateEvent(DisplayEvent.filterChanged,i)}}},findRecordIndex:function(e,t){let i=-1;for(let s=0;s<e.length;s++)if(e[s].getId()==t.getId()){i=s;break}if(i<0&&this.getSelectNearestDate()){let s=t.getDate(),l=null,a=0,r=-1;for(let t=0;t<e.length;t++){let i=e[t],o=Math.abs(s.getTime()-i.getDate().getTime());-1!=r?o<a&&(r=t,a=o):(r=0,l=i.getDate(),a=o)}i=r}return i},handleEventRecordSelection:function(e,t){if(this.selectedRecord=t.record,this.selectedRecord){if(this.getProperty("colorThresholdField")&&(this.haveCalledUpdateUI=!1,this.callUpdateUI()),this.getAnimationEnabled()&&e!=this.getAnimation()&&this.getProperty("animationAcceptRecordSelection",!1)){let e=this.selectedRecord.getDate();e&&this.getAnimation().setDateRange(e,e)}let t=this.getFilterSetValueFieldId();if(t){let e=this.getFieldById(null,t);if(e){let t=e.getValue(this.selectedRecord);this.handleEventFilterChanged(this,{id:"",fieldId:e.getId(),value:t})}}}if(!e.getEntries)return;let i=e.getEntries();for(let e=0;e<i.length;e++){let t=i[e];if(this.getEntries().indexOf(t)>=0){this.highlightEntry(t);break}}},areaClear:function(){this.getDisplayManager().notifyEvent("areaClear",this)},handleEventEntryMouseover:function(e,t){},handleEventEntryMouseout:function(e,t){},handleEventFilteredTimes:function(e,t){let i=t.times;i&&this.getAnimation().setTimes(i)},handleEventEntrySelection:function(e,t){this.getEntries().indexOf(t.entry)>=0&&(t.selected?this.jq(ID_TITLE).addClass("display-title-select"):this.jq(ID_TITLE).removeClass("display-title-select"))},highlightEntry:function(e){this.jq(ID_TITLE).addClass("display-title-select")},getEntries:function(){return this.entries},getDisplayEntry:async function(e){let t=this.getEntries();if(null!=t&&t.length>0)return Utils.call(e,t[0]);let i=this.entryId||this.getProperty("entryId");if(i){let t;await this.getRamadda().getEntry(i,(i=>{t=i,Utils.call(e,t)}))}else Utils.call(e,null)},hasEntries:function(){return null!=this.entries&&this.entries.length>0},getWaitImage:function(){return HU.image(RamaddaUtil.getCdnUrl("/icons/progress.gif"))},useDisplayMessage:function(){return!0},setDisplayMessage:function(e){if(this.dataLoadFailed)return;if(!Utils.stringDefined(e))return void this.jq(ID_DISPLAY_MESSAGE).html("").hide();let t=this.jq(ID_DISPLAY_CONTENTS),i=t.css(CSS_MIN_HEIGHT);i&&i!=HU.px(0)||(t.css(CSS_MIN_HEIGHT,HU.px(75)),t.attr("display-set-minheight","true")),this.jq(ID_DISPLAY_MESSAGE).html(e).show()},clearDisplayMessage:function(){let e=this.jq(ID_DISPLAY_CONTENTS);this.jq(ID_DISPLAY_MESSAGE).hide(),null!=e.attr("display-set-minheight")&&e.css(CSS_MIN_HEIGHT,"")},getLoadingMessage:function(e){if(this.getAcceptEventDataSelection())return"";if(e||this.getProperty("theData")||this.getInlineDataSrc()||(e="No data specified"),e||(e=this.getProperty("loadingMessage","icon_progress Loading data...")),""==e)return"";let t="icon_progress"==e;return e=e.replace("icon_progress",HU.image(icon_progress)),t?e:this.useDisplayMessage()?SPACE+e:HU.div([ATTR_STYLE,HU.css(CSS_TEXT_ALIGN,ALIGN_CENTER)],this.getMessage(SPACE+e))},reloadData:function(){if(this.dataLoadFailed=!1,this.startProgress(),this.haveCalledUpdateUI=!1,this.getProperty("okToLoadData",!0)){this.dataCollection.getList()[0].loadData(this,!0)}},getMessage:function(e){return HU.div([ATTR_CLASS,"display-output-message"],e)},getNoDataMessage:function(){return this.getProperty("noDataMessage","No data available")},getFieldValue:function(e,t){let i=jqid(e);return i.length>0?i.val():t},getFieldValues:function(e,t){let i=jqid(e);if(i.length>0){let e=[];return i.each((function(){e.push($(this).val())})),e}return t},getFooter:function(){return HU.div([ATTR_ID,this.getDomId(ID_FOOTER),ATTR_CLASS,"display-footer"],HU.leftRight(HU.div([ATTR_ID,this.getDomId(ID_FOOTER_LEFT),ATTR_CLASS,"display-footer-left"],""),HU.div([ATTR_ID,this.getDomId(ID_FOOTER_RIGHT),ATTR_CLASS,"display-footer-right"],"")))},shouldSkipField:function(e){return this.skipFields&&!this.skipFieldsList&&(this.skipFieldsList=this.skipFields.split(",")),!!this.skipFieldsList&&this.skipFieldsList.indexOf(e.getId())>=0},fieldSelected:function(e){this.selectedFields=null,this.overrideFields=null,this.userHasSelectedAField=!0;let t=[];if(this.fieldCheckboxes.each((function(){if(HU.isChecked($(this))){let e=$(this).attr(ATTR_DATA_FIELDID);e&&t.push(e)}})),this.setProperty(PROP_FIELDS,Utils.join(t,",")),this.fieldSelectionChanged(),e.shiftKey){let e=this.getSelectedFields();this.propagateEvent(DisplayEvent.fieldsSelected,e)}},addFieldsCheckboxes:function(e){if(!this.hasData())return;let t=this.getPropertyFields();null!=t&&0==t.length&&(t=null);let s=null;null!=t&&(Array.isArray(t)||(t=t.split(",")),s={},t.forEach((e=>{if(e.startsWith("@")){let t=parseInt(e.substring(1).trim())-1,i=0;this.getFields().every((e=>!e.isNumeric()||(i==t?(s[e.getId()]=!0,!1):(i++,!0))))}else{if(e.startsWith("#")){let t=e.split("-");if(2==t.length){let e=+t[0].replace("#",""),i=+t[1].replace("#","");for(let t=e;t<=i;t++)s["#"+t]=!0}}s[e]=!0}})));let l=this.showFieldsInDialog(),a="",r=this.getId()+"_checkbox",o=this.getId()+"_groupby",n=this.dataCollection.getList();null!=e&&(this.overrideFields=[]);let h={};for(let t=0;t<n.length;t++){let d=n[t],g=this.getFieldsToSelect(d);if(this.canDoGroupBy()){let e=d.getRecordFields(),s=0;for(i=0;i<e.length;i++){let l=e[i];if("string"!=l.getType())continue;if(0==s){a+=HU.div([ATTR_CLASS,"display-dialog-subheader"],"Group By"),a+=HU.open(TAG_DIV,[ATTR_CLASS,"display-fields"]);let e=null==this.groupBy||""==this.groupBy;a+=HU.tag(TAG_DIV,[ATTR_TITLE,"none"],HU.radio("none",this.getDomId("groupby"),o,"none",!e)+" None")}s++;let r=this.groupBy==l.getId(),n="groupby_"+t+"_"+i;l.radioId=this.getDomId(n),a+=HU.tag(TAG_DIV,[ATTR_TITLE,l.getId()],HU.radio(l.radioId,this.getDomId("groupby"),o,l.getId(),r)+" "+l.getUnitLabel()+" ("+l.getId()+")")}s>0&&(a+=HU.close(TAG_DIV))}let p="";if(g.length>0){let i=this.getSelectedFields([]),o=[];for(let e=0;e<i.length;e++)o.push(i[e].getId());a+=HU.div([ATTR_CLASS,"display-dialog-subheader"],"Displayed Fields"),a+=HU.open(TAG_DIV,[ATTR_CLASS,"display-fields"]);for(let i=0;i<g.length;i++){let n=g[i],d="cbx_"+t+"_"+i;n.checkboxId=this.getDomId(d);let c=!1,u=!0;if(null!=e){for(let t=0;t<e.length;t++)if(e[t].getId()==n.getId()){c=!0,this.overrideFields.push(n.getId());break}}else o.length>0&&(c=o.indexOf(n.getId())>=0);c||(null!=s?(c=s[n.getId()],c||(c=s["#"+(i+1)])):null!=this.overrideFields?(c=this.overrideFields.indexOf(n.getId())>=0,c||(c=this.overrideFields.indexOf("#"+(i+1))>=0)):this.selectedCbx.indexOf(n.getId())>=0?c=!0:0==this.selectedCbx.length&&(c=0==i));let T=n.getUnitLabel();if(h[T]?(T=T+" "+h[T],h[T]++):h[T]=1,u){let e;n.derived&&(T+=" (derived)"),l?this.canDoMultiFields()?(e=HU.checkbox(n.checkboxId,[ATTR_CLASS,r,ATTR_DATA_FIELDID,n.getId(),ATTR_TITLE,n.getId()+" - "+n.getType()],c,T),a+=HU.tag(TAG_DIV,[ATTR_TITLE,n.getId()],e)):(e=HU.radio(n.checkboxId,"field_radio",r,"",c,HU.attrs([ATTR_DATA_FIELDID,n.getId()])),a+=HU.tag(TAG_DIV,[ATTR_TITLE,n.getId()],e+" "+T)):a+=HU.tag(TAG_DIV,[],T+" - "+n.getId())}else p+=HU.div([],T)}}""!=p&&(a+=HU.div([ATTR_STYLE,HU.css(CSS_BORDER_TOP,HU.border(1,"#888"))],HU.b("No Data Available")+p)),a+=HU.close(TAG_DIV)}this.writeHtml(ID_FIELDS,a);let d=this;this.fieldCheckboxes=$("."+r),this.fieldCheckboxes.click((function(e){d.fieldSelected(e)})),$("."+o).change((function(e){d.groupBy=$(this).val(),d.displayData&&d.displayData()}))},fieldSelectionChanged:function(){this.setDisplayTitle(),this.displayData&&(this.clearCachedData(),this.displayData())},defaultSelectedToAll:function(){return!0},setSelectedFields:function(e){this.clearCachedData(),this.selectedFields=e,this.addFieldsCheckboxes(e)},getSelectedFields:function(e){let t=this.getProperty("prefixFields"),i=displayDebug.getSelectedFields||this.getProperty("debugFields");if(i&&console.log(this.type+".getSelectedFields"),this.getBinDate()){let e=this.getBinType("total");if("count"==e){let t=[];return t.push(new RecordField({id:e,label:this.getProperty("binDateLabel",this.getProperty("binCountLabel","Count")),type:"double",chartable:!0})),t}}this.debugSelected=i,this.lastSelectedFields=this.getSelectedFieldsInner(e);let s=this.getProperty("notFields");if(s&&(this.lastSelectedFields=this.lastSelectedFields.filter((e=>!e.getId().match(s)&&!e.getLabel().match(s)))),i&&console.log("\tsetting lastSelectedFields:"+this.lastSelectedFields),this.setDisplayTitle(),this.getBinDate()){let e=this.getProperty("binType","total"),t=[];this.lastSelectedFields.forEach((i=>{if(i.isNumeric()){const s=e;i.getId().startsWith(s)?t.push(i):t.push(new RecordField({id:s+"_"+i.getId(),index:i.getIndex(),label:this.getProperty("binDateLabel",Utils.camelCase(e)+" of "+i.getLabel()),type:"double",chartable:i.isChartable()}))}else t.push(i)})),this.lastSelectedFields=t}let l=Utils.cloneList(this.lastSelectedFields??[]);if(t){let e=this.getFieldsByIds(null,t);e.length&&(l=[...e,...l])}return l},getSelectedFieldsInner:function(e){let t=this.debugSelected;if(t&&(console.log("getSelectedFieldsInner dflt:"+(e||"null")),console.log("\tlast selected = "+this.lastSelectedFields)),this.selectedFields)return t&&console.log("\treturning this.selectedFields:"+this.selectedFields),this.selectedFields;let i=[],s=this.dataCollection.getList(),l=this.getPropertyFields();if(l&&"string"==typeof l&&(l=l.split(",")),l){let e=[];l.forEach((t=>{if(!t.match("-"))return void e.push(t);let i=t.split("-"),s=parseFloat(i[0].trim().substring(1)),l=parseFloat(i[1].trim().substring(1));for(let t=s;t<=l;t++)e.push("#"+t)})),l=e}let a={},r=this.getFieldAliases();r&&r.split(",").forEach((e=>{[name,alias]=e.split(":"),a[alias]=name}));for(let e=0;e<s.length;e++){let a=s[e];this.pointData&&(a=this.pointData);let r=this.getFieldsToSelect(a);if(null!=l&&l.length>0){t&&console.log("\thave fixed fields:"+l);let e=[];for(let t=0;t<l.length;t++){let i=l[t];if("*"==i){e=r;break}let s=this.getFieldById(r,i);s&&e.push(s)}this.getProperty("fieldsNumeric")&&(e=e.filter((e=>e.isNumeric()))),i=e}}if(null!=l&&l.length>0)return t&&console.log("\tfrom fixed:"+i.length),i;t&&console.log("\tuser has selected");let o=null;this.selectedCbx=[];for(let e=0;e<s.length;e++)o=this.getFieldsToSelect(s[e]);return 0==i.length&&this.lastSelectedFields&&this.lastSelectedFields.length>0?(t&&console.log("\tlastSelectedFields:"+this.lastSelectedFields),this.lastSelectedFields):(0==i.length&&(i=this.getDefaultSelectedFields(o,e,this.debugSelected),t&&console.log("\tusing default selected:"+i)),i)},getDefaultSelectedFields:function(e,t,s){let l=s||displayDebug.getDefaultSelectedFields;l&&console.log("getDefaultSelectedFields");let a=this.getProperty("fieldsPatterns");if(a){let e=this.getFields();if(e){let t=!1,i=[];if(t&&console.log("fields:"+e),a.split(",").forEach((s=>{t&&console.log("\tpattern:"+s),e.every((e=>{if(!e.isFieldNumeric())return!0;let l=e.getId().toLowerCase();return t&&console.log("\t\tid:"+l),!(l.match(s)&&(t&&console.log("\t\tmatch"),!i.includes(e)))||(t&&console.log("\t\tadd to matched"),i.push(e),!1)}))})),t&&console.log("returning:"+i),i.length)return i}}if(this.defaultSelectedToAll()){let e=this.getFields(),t=[];if(e)for(i=0;i<e.length;i++){let s=e[i];s.isFieldGeo()||t.push(s)}return l&&console.log("\treturning allFields:"+t),t}if(null!=t)return l&&console.log("\treturning dfltList:"+t),t;for(i=0;i<e.length;i++){let t=e[i];if(t.isNumeric()&&!t.isFieldGeo())return[t]}return[]},sortRecords:function(e,t,i){if((this.getSortOnDate()||i)&&(e=Utils.cloneList(e)).sort((function(e,t){if(e.getDate()&&t.getDate())return e.getDate().getTime()<t.getDate().getTime()?-1:e.getDate().getTime()>t.getDate().getTime()?1:0})),i)return e;if(!t){let e=this.getProperty("sortFields","",!0);"${fields}"==e&&(e=this.getProperty("fields","",!0)),0==(t=this.getFieldsByIds(null,e)).length&&this.sortByFields&&this.sortByFields.length>0&&(t=[this.sortByFields[0]])}if(t.length>0){e=Utils.cloneList(e);let i=this.getSortAscending();e.sort(((e,i)=>{let s=this.getDataValues(e),l=this.getDataValues(i),a=0;for(let e=0;e<t.length;e++){let i=t[e],r=s[i.getIndex()],o=l[i.getIndex()];if(a=i.isNumeric()||i.isFieldDate()?isNaN(r)&&isNaN(o)?0:isNaN(r)?-1:isNaN(o)?1:r<o?-1:r>o?1:0:String(r).localeCompare(String(o)),0!=a)break}return a})),i||e.reverse()}if(this.getProperty("sortHighlight")&&(e=Utils.cloneList(e)).sort(((e,t)=>{let i=e.isHighlight(this),s=t.isHighlight(this);return i&&!s?-1:!i&&s?1:0})),this.getReverse()){let t=[];for(let i=(e=Utils.cloneList(e)).length-1;i>=0;i--)t.push(e[i]);e=t}return e},getFieldById:function(e,t,i,s,l){if(i&&console.log("getFieldById:"+t),null!=e&&null==t){if("string"!=typeof e)return i&&console.log("\tbadfields:"+e),null;t=e,e=null}if(!t)return i&&console.log("\tno id"),null;if(t=String(t).trim(),!e){let t=this.getData();if(null==t)return i&&console.log("\tno data"),null;e=t.getRecordFields(),i&&console.log("\tusing  fields:"+e)}if(!e)return null;let a={},r=this.getFieldAliases();r&&r.split(",").forEach((e=>{[name,alias]=e.split(":"),a[alias]=name}));let o=null;return t.split("|").every((t=>{let s=a[t],l=t.indexOf("*")>=0,r=0;for(let a=0;a<e.length;a++){let n=e[a];if(n.isFieldNumeric()&&r++,i&&console.log("\tField:"+n.getId()),"#"!=t){if(t=="@"+r)return o=n,!1;if(n.getId()==t||t=="#"+(a+1)||n.getId()==s)return o=n,i&&console.log("\tgot it:"+o),!1;if(l&&n.getId().match(t))return o=n,i&&console.log("\tgot it from pattern:"+o),!1}else if(n.isFieldNumeric())return o=n,!1}return!0})),(i||displayDebug.getSelectedFields)&&console.log("\tgot:"+o),o||s||(i||displayDebug.getSelectedFields||this.getProperty("debugFields"))&&(this.logMsg("can't find field field:"+t),console.log(e.reduce(((e,t)=>e+" "+t.getId()),""))),o},getFieldsByIds:function(e,t){if(!e){let t=this.getData();null!=t&&(e=t.getRecordFields())}if(!e)return[];let i=[];if(!t)return i;if("*"==t)return e;if("#"==t)return e.filter((e=>!e.isFieldLongitude()&&!e.isFieldLatitude()&&e.isFieldNumeric()));if("string"==typeof t&&(t=t.split(",")),!e){let t=this.getData();if(null==t)return null;e=t.getRecordFields()}for(let s=0;s<t.length;s++){let l=t[s];if(l.startsWith("#")){let t=l.split("-");if(2==t.length){let s=+t[0].replace("#",""),l=+t[1].replace("#","");for(let t=s;t<=l;t++){let t=this.getFieldById(e,"#"+s);t&&i.push(t)}continue}}let a=this.getFieldById(e,t[s]);a&&i.push(a)}return i},getFieldByType:function(e,t){return 0==(e=this.getFieldsByType(e,t)).length?null:e[0]},getFieldsByType:function(e,t){if(!e){let t=this.getData();if(null==t)return null;e=t.getRecordFields()}let i=[],s="numeric"==t,l="string"==t;for(a in e){let r=e[a];if(!r.isRecordDate()){if(null==t)return r;s?r.isFieldNumeric()&&i.push(r):l?r.isFieldString()&&i.push(r):r.getType()==t&&i.push(r)}}return i},getDateValues:function(e){let t=[];return e.forEach((e=>{t.push(e.getDate())})),t},getColumnValues:function(e,t){let i=[],s=Number.MAX_VALUE,l=Number.MIN_VALUE;for(let a=0;a<e.length;a++){let r=e[a].getData()[t.getIndex()];i.push(r),Utils.isNumber(r)&&!isNaN(r)&&(s=Math.min(s,r),l=Math.max(l,r))}return{values:i,min:s,max:l}},requiresGrouping:function(){return!1},makeTree:function(e){if(null==e&&(e=this.getRecords()),null==e)return;let t=this.getProperty("treeTemplate"),i=this.getProperty("treeTooltip"),s=[],l={},a=[],r={},o=this.getFieldById(null,this.getProperty("labelField")),n=this.getFieldsByIds(null,this.getProperty("nodeFields")),h=this.getProperty("treeRoot"),d=null;if(h&&(d={id:h,label:h,children:[],parent:null},s.push(d)),n.length>0){let t=0;return e.forEach((e=>{let i=null==o?g:e.getValue(o.getIndex()),r=null,h=null;n.forEach((t=>{let i=e.getValue(t.getIndex()),a=r?r+"-"+i:i,o=l[a];o||(o={id:a,label:i,children:[],parent:h},l[a]=o,h||(d?(o.parent=d,d.children.push(o)):s.push(o)),h&&h.children.push(o)),r=a,h=o}));let g="leaf"+t++,p={id:g,label:i,children:[],record:e,parent:h};h.children.push(p),l[g]=p,a.push(p)})),s}let g=this.getFieldById(null,this.getProperty("parentField")),p=this.getFieldById(null,this.getProperty("idField"));if(!g)throw new Error("No parent field specified");if(!p)throw new Error("No id field specified");return e.forEach((e=>{let n=e.getValue(g.getIndex()),h=e.getValue(p.getIndex()),c={id:h,label:null==o?h:e.getValue(o.getIndex()),children:[],record:e,parentId:n,parent:null};t&&(c.display=this.getRecordHtml(e,null,t)),i&&(c.tooltip=this.getRecordHtml(e,null,i)),l[h]=c,a.push(c),""==n&&(r[h]=c,d?(c.parent=d,c.parentId=d.id,d.children.push(c)):s.push(c))})),a.forEach((e=>{let t=l[e.parentId];if(t)e.parent=t,t.children.push(e);else if(!r[e.id])throw new Error("No parent :"+e.parentId+" for node:"+e.label)})),s},getSegments:function(){let e=this.getProperty("timeSegments");if(!e)return null;let t=[];return e.split(",").forEach(((e,i)=>{let s=e.split(";"),l=s[0],a=Utils.parseDate(s[1],!1),r=Utils.parseDate(s[2],!1);t.push({name:l,start:a,end:r})})),t},requiresGeoLocation:function(){return!1},checkDataFilters:function(e,t){if(!e)return!0;for(let i=0;i<e.length;i++)if(!e[i].isRecordOk(t))return!1;return!0},getTheDataFilters:function(e){return DataUtils.getDataFilters(this,e||this.getDataFilters())},dfltFilterHighlight:null,getFilterHighlight:function(){return this.dfltFilterHighlight||(this.dfltFilterHighlight={filterHighlight:this.getProperty("filterHighlight",!1)}),this.dfltFilterHighlight.filterHighlight},getFilterTextMatchers:function(){let e=[];if(this.filters)for(let t=0;t<this.filters.length;t++){let i=this.filters[t],s=jqid(i.getWidgetId());if(0==s.length||!s.val||null==s.val())continue;let l=s.val()??"";if(!Utils.stringDefined(l))continue;let a=i.getId();"_text_"==a&&(a=null),e.push(new TextMatcher(l,a))}return e},getCsv:function(e,t,i,s,l,a){e=e||this.getData().getRecordFields();let r=DataUtils.getCsv(e,t,l,s);i?(Utils.copyToClipboard(r),alert("Copied to clipboard")):Utils.makeDownloadFile(a,r)},filterDataPhase2:function(e){return e},filterData:function(e,t,i){e||(e=this.getRecords());let s=this.filterDataInner(e,t,i);if(s&&this.getPropagateFilteredTimes()&&s.length!=e.length){let e=[],t={};s.forEach((i=>{let s=i.getDate();s&&(t[s]||(t[s]=!0,e.push(s)))})),e.length&&this.propagateEvent(DisplayEvent.filteredTimes,{times:e})}if(this.shareEvent(DisplayEvent.filteredDataChanged,!1)&&this.getDisplayManager().notifyEvent(DisplayEvent.filteredDataChanged,this,{records:s}),this.getApplyConvertAfter()){let e=new PointData("pointdata",this.originalPointData.recordFields,s);e=this.convertPointData(e),this.convertedFields=e.getRecordFields(),s=e.getRecords()}return s},handleEventFilteredDataChanged:function(e,t){this.propagatedFilteredRecords=t.records,t.records&&this.forceUpdateUI()},findUnique:function(e,t){if(!t)return e;let i={},s=[];for(let l=e.length-1;l>=0;l--){let a=e[l],r=a.getValue(t.getIndex());Utils.isDefined(i[r])||(i[r]=!0,s.push(a))}return s},filterDataInner:function(e,t,i){if(this.propagatedFilteredRecords&&this.originalPointData){let t=new PointData("pointdata",this.originalPointData.recordFields,this.propagatedFilteredRecords);t=this.convertPointData(t),e=t.getRecords()}if(this.recordListOverride)return this.recordListOverride;let s={doGroup:!1,skipFirst:!1,applyDateRange:!0,recordOk:null};i&&$.extend(s,i);let l=displayDebug.filterData;l&&this.logMsg("filterData"),this.getAnimationEnabled()&&this.getProperty("animationFilter",!0)&&this.setDateRange(this.getAnimation().begin,this.getAnimation().end);let a=this.getFilterHighlight(),r=this.getProperty("startDate"),o=this.getProperty("endDate");r&&(this.startDateObject=Utils.createDate(r,+this.getTimeZoneOffset()),l&&this.logMsg(this.type+" start date:"+r+" dttm:"+this.startDateObject.toUTCString())),o&&(this.endDateObject=Utils.createDate(o,+this.getTimeZoneOffset()),l&&this.logMsg(this.type+"end date:"+this.endDateObject.toUTCString()));let n=this.getProperty("filterDate");if(n){let e=jqid(this.getFilterId(ID_FILTER_DATE)).val();if(e)if("all"==e)this.setDateRange(null,null);else if(e=new Date(e),"year"==n){let t=e.getFullYear()+1;this.setDateRange(new Date(e.getFullYear()+"-01-01"),new Date(t+"-01-01"))}else if("day"==n){let t=e.getUTCFullYear()+"-"+(e.getUTCMonth()+1)+"-"+e.getUTCDate(),i=new Date(t);this.setDateRange(i,i,!0)}}if(!e)return null;if(t||(t=this.getFields()),s.doGroup||this.requiresGrouping()){let t=this.getData();e=t.extractGroup(this.dataGroup,e)}if(l&&this.logMsg("filter #records:"+e.length),this.getProperty("filterLatest")){let t=this.getFieldsByIds(null,this.getProperty("filterLatest")),i={},s=[],l=[];e.forEach((e=>{if(!e.getTime())return;let s="";t.forEach((t=>{s+="_"+e.getValue(t.getIndex())}));let a=i[s];a?e.getDate().getTime()>a.getDate().getTime()&&(i[s]=e):(i[s]=e,l.push(s))})),l.forEach((e=>{s.push(i[e])})),e=s}if(e.forEach((e=>{e.clearHighlight(this)})),e=e.filter(((e,t)=>{let i=e.getDate();return this.dateInRange(i,t,t<5&&l)})),l&&this.logMsg("filter Fields:"+this.filters.length+" #records:"+e.length),this.filters.length){let t=[],i=this.getProperty("filterLogic","and");this.filters.forEach((e=>e.prepareToFilter(l))),l&&this.logMsg("filter:"+this.filters.length+" #records:"+e.length),e.forEach(((e,r)=>{let o=r<5&&l,n=!0,h=!1;this.filters.forEach((t=>{if(!t.isEnabled())return void(o&&this.logMsg("filter not enabled"));let i=t.isRecordOk(e,o);o&&this.logMsg("Filter ok:"+i),i?h=!0:n=!1}));let d="and"==i?n:h;s.skipFirst&&0==r&&(d=!0),a?(t.push(e),e.setHighlight(this,d)):(e.clearHighlight(this),d&&t.push(e))})),l=!1,e=t}l&&this.logMsg("filterData-2 #records:"+e.length);let h=parseInt(this.getProperty("stride",-1));if(h<0){let t=parseInt(this.getProperty("maxDisplayedPoints",-1));if(t>0&&e.length>0)for(h=1;e.length/h>t;)h++}if(h>0){let t=[];for(let i=0;i<e.length;i+=h+1)t.push(e[i]);e=t,l&&this.logMsg("R-3:"+e.length)}e=this.filterDataPhase2(e);let d=this.getMaxRecords();if(Utils.isDefined(d)){let t=[];e.every(((e,i)=>!(i>=d)&&(t.push(e),!0))),e=t}if(l&&this.logMsg("filterData-3 #records:"+e.length),this.getFilterPaginate()){let t=this.pageSkip||0,i=+this.getPageCount();if(t>0||i<e.length){let s=[],l=t;for(i=Utils.max(i,1e3);!(l<e.length||(l-=i,l<0)););l<0&&(l=0),l!=t&&this.updatePaginateLabel(t,i,e.length),t=l,this.logMsg("skip:"+t+" count:"+i+" "+e.length);for(let l=t;l<e.length&&(s.push(e[l]),!(s.length>=i));l++);e=s}}if(this.getProperty("binDate")){let i=this.getProperty("binDate"),s=this.getProperty("binType","total"),l="count"==s,a=[],r=(e[0],{}),o={};this.binRecordToRecords={};let n={};for(let s=0;s<e.length;s++){let h,d=e[s],g=(this.getDataValues(d),null);if("month"==i)h=d.getDate().getUTCFullYear()+"-"+(d.getDate().getUTCMonth()+1);else if("day"==i)h=d.getDate().getUTCFullYear()+"-"+(d.getDate().getUTCMonth()+1)+"-"+d.getDate().getUTCDate();else if("week"==i){let e=+Utils.formatDateWeek(d.getDate());h=d.getDate().getUTCFullYear()+"-"+e;let t=1+7*(e-1);g=new Date(d.getDate().getUTCFullYear(),0,t)}else h=d.getDate().getUTCFullYear()+"";if(Utils.isDefined(r[h])){let e=n[h];this.binRecordToRecords[e.getId()].records.push(d),o[h]++;let t=r[h];if(l){for(k=0;k<t.length;k++)t[k]++;continue}let i=d.getData();for(let e=0;e<i.length;e++){let s=i[e];"number"==typeof s&&(isNaN(s)||(isNaN(t[e])?t[e]=s:t[e]+=s))}}else{o[h]=1;let e=g;g||(e=Utils.parseDate(h));let i=Utils.cloneList(d.getData());if(l)for(k=0;k<i.length;k++)i[k]=1;let s=new PointRecord(t,d.getLatitude(),d.getLongitude(),d.getElevation(),e,i);n[h]=s,this.binRecordToRecords[s.getId()]={records:[d]},r[h]=i,a.push(s)}}if("average"==s)for(key in o){let e=r[key];for(let t=0;t<e.length;t++){let i=e[t];"number"==typeof i&&(isNaN(i)||(e[t]=i/o[key]))}}e=a}l&&this.logMsg("filterData-4 #records:"+e.length),this.requiresGeoLocation()&&(e=e.filter((e=>e.hasLocation()))),l&&this.logMsg("filterData-5 #records:"+e.length);let g=this.getTheDataFilters();if(g.length&&(l&&this.logMsg("have filters:"+g),e=e.filter(((e,t)=>!!this.checkDataFilters(g,e)))),l&&this.logMsg("filterData-6 #records:"+e.length),this.uniqueFields&&this.uniqueFields.length>0){let t=this.jq("uniquefields").val();if(t.length>0){this.uniqueFields.filter((e=>t.includes(e.getId()))).forEach((t=>{e=this.findUnique(e,t)}))}}if(this.getProperty("uniqueField")){let t=this.getFieldById(null,this.getProperty("uniqueField"));e=this.findUnique(e,t)}e=this.sortRecords(e),this.recordToIndex={},this.indexToRecord={};for(let t=0;t<e.length;t++){let i=e[t];this.recordToIndex[i.getId()]=t,this.indexToRecord[t]=i}let p=this.getProperty("convertDataPost");if(p){let t=this.getData(),i=new PointData("pointdata",t.getRecordFields(),e,null,{parent:t});this.pointData=(new CsvUtil).process(this,i,p),e=this.pointData.getRecords()}if(l&&this.logMsg("filtered:"+e.length),this.jq(ID_FILTER_COUNT).html("Count: "+e.length),this.filteredRecords=e,this.getSelectFirst()?this.propagateEventRecordSelection({record:e[0]}):this.getSelectLast()&&this.propagateEventRecordSelection({record:e[e.length-1]}),s.recordOk&&(e=e.filter((e=>s.recordOk(e)?e:null))),this.getShowRecordPager()){let t=+this.getRecordPagerNumber();this.rowStartIndex>=e.length&&(this.rowStartIndex=Math.max(0,e.length-e.length%t-1));let i,s=[],l=0;for(i=this.rowStartIndex;i<e.length&&l<t;i++){l++;let t=e[i];s.push(t)}let a="";this.rowStartIndex>0&&(a+=HU.span([ATTR_ID,this.domId(ID_PREV)],"Previous")+" "),i<e.length&&(a+=HU.span([ATTR_ID,this.domId(ID_NEXT)],"Next")+" "),a+=HU.span([ATTR_ID,this.domId(ID_PREVNEXT_LABEL)]),""!=a&&(a=HU.div([ATTR_STYLE,HU.css(CSS_MARGIN_RIGHT,HU.px(10),CSS_DISPLAY,DISPLAY_INLINE_BLOCK)],a),this.jq(ID_HEADER2_PREFIX).html(a),this.jq(ID_HEADER2).css(CSS_TEXT_ALIGN,ALIGN_LEFT)),t<e.length&&this.jq(ID_PREVNEXT_LABEL).html("Showing "+(this.rowStartIndex+1)+" - "+(this.rowStartIndex+l)+" of "+e.length+" "+this.getNoun("")),this.jq(ID_PREV).button().click((()=>{this.rowStartIndex-=+this.getRecordPagerNumber(),this.rowStartIndex<0&&(this.rowStartIndex=0),this.forceUpdateUI()})),this.jq(ID_NEXT).button().click((()=>{let e=+this.getRecordPagerNumber();this.rowStartIndex+=e,this.forceUpdateUI()})),e=s}return this.animationControl&&this.animationControl.applyLabelTemplate(e),l&&this.logMsg("filterData-final #records:"+e.length),this.handleResult("filterData",e)},handleResult:function(e,t){return t},getBinnedRecords:function(e){return this.binRecordToRecords?this.binRecordToRecords[e.getId()].records:e.parentRecords},canDoGroupBy:function(){return!1},canDoMultiFields:function(){return!0},useChartableFields:function(){return!1},getFieldsToSelect:function(e){return this.convertedFields?this.convertedFields:this.useChartableFields()?e.getChartableFields(this):e.getRecordFields()},getGet:function(){return"getRamaddaDisplay('"+this.getId()+"')"},assembleWikiText:function(e){let t="";if(window.globalDisplayProperties)for(key in window.globalDisplayProperties)t+='{{displayProperty name="'+key+'" value="'+window.globalDisplayProperties[key]+'"}}\n';t+=this.getWikiText();for(let e=0;e<this.displays.length;e++){let i=this.displays[e];i.getIsLayoutFixed()||(t+=i.getWikiText())}return t},showWikiText:function(e){let t=this.assembleWikiText();HU.setPopupObject(HU.getTooltip()),t=t.replace(/</g,"&lt;").replace(/>/g,"&gt;"),t=HU.pre([ATTR_STYLE,HU.css(CSS_MAX_WIDTH,HU.px(500),CSS_MAX_HEIGHT,HU.px(400),CSS_OVERFLOW_X,OVERFLOW_AUTO,CSS_OVERFLOW_Y,OVERFLOW_AUTO)],t),this.showDialog(t)},copyWikiText:function(e){Utils.copyText(this.assembleWikiText()),alert("Wiki text has been copied to the clipboard")},publish:function(e){null==e&&(e="wikipage");let t=[],i=prompt("Name","");if(null==i)return;t.push("name"),t.push(i),t.push("type"),t.push(e);let s="";"wikipage"==e?s+='+section label="{{name}}"\n${extra}\n':"blogentry"==e&&(s="<wiki>\n"),s+="",s+=this.assembleWikiText(),"wikipage"==e&&(s+="-section\n\n");let l="",a=this.getChildEntries();for(let e=0;e<a.length;e++){l+=a[e].getId()+","}a.length>0&&(t.push("entries"),t.push(l)),"media_photoalbum"==e&&(s=""),t.push("description_encoded"),t.push(window.btoa(s));let r=HU.getUrl(RamaddaUtil.getUrl("/entry/publish"),t);window.open(r,"_blank")},getChildEntries:function(e){let t={},i=[];for(let s=0;s<this.displays.length;s++){let l=this.displays[s];if((e||!l.getIsLayoutFixed())&&l.getEntries){let e=l.getEntries();if(e)for(let s=0;s<e.length;s++)null==t[e[s].getId()]&&(t[e[s].getId()]=!0,i.push(e[s]))}}return i},copyDisplayedEntries:function(){let e=[];for(let t=0;t<this.displays.length;t++){let i=this.displays[t];if(!i.getIsLayoutFixed()&&i.getEntries){let t=i.getEntries();if(t)for(let i=0;i<t.length;i++)e.push(t[i])}}return this.copyEntries(e)},defineWikiAttributes:function(e){for(let t=0;t<e.length;t++)this.wikiAttrs.indexOf(e[t])<0&&this.wikiAttrs.push(e[t])},getWikiAttributes:function(e){for(let t=0;t<this.wikiAttrs.length;t++){let i=this[this.wikiAttrs[t]];Utils.isDefined(i)&&(e.push(this.wikiAttrs[t]),e.push(i))}},getWikiText:function(){let e=["layoutHere","false","type",this.type,"column",this.getColumn(),"row",this.getRow()];this.getProperty("entryId")&&(e.push("entry"),e.push(this.getProperty("entryId"))),this.getWikiAttributes(e);let t=null;if(this.getEntries){let e=this.getEntries();e&&e.length>0&&(t=e[0].getId())}return t||(t=this.entryId),t&&(e.push("entry"),e.push(t)),"{{display "+HU.attrs(e)+"}}\n\n"},copyEntries:function(e){let t=[],i={};for(let s=0;s<e.length;s++){let l=e[s];null==i[l.getId()]&&(i[l.getId()]=l,t.push(l))}let s="";for(let e=0;e<t.length;e++){s+=t[e].getId()+","}let l=HU.url(RamaddaUtil.getUrl("/entry/copy"),"action.force","copy","from",s);window.open(l,"_blank")},entryHtmlHasBeenDisplayed:async function(e){if(e.getIsGroup()){let t=this,i=function(i){let s=HU.open(TAG_OL,[ATTR_CLASS,"display-entrylist-list",ATTR_ID,t.getDomId(ID_LIST)]);s+=t.getEntriesTree(i),s+=HU.close(TAG_OL),t.jq(ID_GROUP_CONTENTS+e.getIdForDom()).html(s),t.addEntrySelect()};await e.getChildrenEntries(i)}},getEntryHtml:function(e,t){let i={showHeader:!0,headerRight:!1,showDetails:this.getShowDetails(),showImage:this.getProperty("showEntryImage")};$.extend(i,t),t=i;let s=this.getEntryMenuButton(e),l="";if(t.showHeader){let i=s+SPACE+e.getLink(null,!0,[ATTR_TARGET,"_entries"]);t.headerRight?l+=HU.leftRight(i,t.headerRight):l+=i}let a=HU.getUniqueId("entry_");l+=HU.div([ATTR_ID,a],"");let r=e.getMetadata();if(i.showImage)if(e.getIsImage()){let t=HU.tag(TAG_IMG,[ATTR_SRC,e.getImageUrl(),ATTR_CLASS,"display-entry-image"]);l+=HU.href(e.getResourceUrl(),t,["download",null])+HU.br()}else for(let t=0;t<r.length;t++)if("content.thumbnail"==r[t].type){let i,s=r[t].value.attr1;i=0==s.indexOf("http")?s:HU.url(RamaddaUtil.getUrl("/metadata/view/"+s),ARG_ELEMENT,1,ARG_ENTRYID,e.getId(),ARG_METADATAID,r[t].id,"thumbnail","false"),l+=HU.image(i,[ATTR_CLASS,"display-entry-thumbnail"])}e.getIsGroup()&&(l+=HU.div([ATTR_ID,this.getDomId(ID_GROUP_CONTENTS+e.getIdForDom())],"")),l+=HU.formTable(),t.showDetails&&(e.url&&(l+=HU.formEntryLabel("URL",HU.href(e.url,e.url))),e.remoteUrl&&(l+=HU.formEntryLabel("URL",HU.href(e.remoteUrl,e.remoteUrl))),e.remoteRepository&&(l+=HU.formEntryLabel("From",HU.href(e.remoteRepository.url,e.remoteRepository.name))));let o=e.getAttributes();if(e.getFilesize()>0){let t=e.getFilename()+" "+HU.getIconImage("fas fa-download");l+=HU.formEntryLabel("File",HU.href(e.getResourceUrl(),t,["download",null])+" "+e.getFormattedFilesize())}for(let e=0;e<o.length;e++){let t=o[e],i=t.value;if((!t.getCanShow||t.getCanShow())&&!Utils.isFalse(t.canshow)){if(t.isUrl&&t.isUrl()){let e="",t=i.split("\n");for(let i=0;i<t.length;i++){let s=t[i].trim();0!=s.length&&(e+=HU.href(s,s),e+=HU.br())}i=e}l+=HU.formEntryLabel(t.label,i)}}return l+=HU.close(TAG_TABLE),l},getEntriesTree:function(e,t){t||(t={});let i=this.getProperty("entryColumns",null),s=this.getProperty("showSnippetInList"),l=RamaddaUtil.makeMetadataDisplay(this.getProperty("metadataDisplay")),a=RamaddaUtil.makeMetadataDisplay(this.getProperty("mainMetadataDisplay")),r=this.getProperty("nameStyle",HU.css(CSS_FONT_SIZE,HU.perc(120),CSS_COLOR,"#2178B5")),o=this.getProperty("showIcon",!0),n=this.getProperty("showToggle",!0),h=this.getProperty("showThumbnail",!1),d=this.getProperty("showEntryType",!1),g=this.getProperty("placeholderImage",RamaddaUtils.getCdnUrl("/images/placeholder.png"));if(null!=i){let t=this.getProperty("columnNames",null);null!=t&&(t=t.split(",")),i=i.split(",");let s=[],l=[];for(let e=0;e<i.length;e++){let t=i[e].split(":"),a=null,r=null;t.length>1?"property"==t[0]?(r="property",a=i[e]):(a=t[0],r=t[1]):(a=i[e],r=a),s.push(a),l.push(r)}return i=s,null==t&&(t=l),this.getEntriesTable(e,i,t)}let p=t.suffix,c="";p?(c=p,p="'"+p+"'"):p="null";let u=getHandler(t.handlerId),T=t.showIndex,f="",y="entryrow_"+this.getId(),m=!0;null==this.entriesMap&&(this.entriesMap={});let _=this.getProperty("doWorkbench");for(let i=0;i<e.length;i++){m=!m;let S=e[i];if(S.displayHtml){f+=S.displayHtml;continue}this.entriesMap[S.getId()]=S;let A=this.makeEntryToolbar(S,u,t.handlerId),I=_?this.getEntryMenuButton(S):"",b=S.getDisplayName(!0);b.length>100&&(b=b.substring(0,99)+"...");let R=o?S.getIconImage([ATTR_TITLE,"View entry"]):"";b=HU.span([ATTR_STYLE,r],b);let D=S.getIdForDom()+c,L=S.getId(),U=HU.image(icon_tree_closed,[ATTR_BORDER,"0","tree-open","false",ATTR_ID,this.getDomId(ID_TREE_LINK+D)]),C=this.getGet()+".toggleEntryDetails(event, '"+L+"',"+p+",'"+t.handlerId+"');",E=n?this.getGet()+".entryHeaderClick(event, '"+L+"',"+p+"); ":"",H=n?HU.onClick(C,U):"",P="";T&&(P="#"+(i+1)+" "),u&&u.getEntryPrefix&&(P+=u.getEntryPrefix(t.handlerId,S)),b=R+" "+b;let x=I+" "+H+" "+P+(n?HU.tag(TAG_A,[ATTR_TARGET,"_entries",ATTR_HREF,S.getEntryUrl()],b):b),v=HU.div([ATTR_CLASS,"display-entrylist-name"],x);if(d&&(v=HU.leftRightTable(v,HU.span([ATTR_STYLE,HU.css(CSS_FONT_STYLE,FONT_ITALIC,CSS_MARGIN_RIGHT,HU.px(4))],S.getTypeName()))),a&&a.length){let e=RamaddaUtil.formatMetadata(S,a,{doBigText:!1,wrapInDiv:!1});Utils.stringDefined(e)&&(v+=HU.div([],e))}if(h){let e=S.getThumbnail();e||(e=g),e&&(e=HU.image(e,[ATTR_WIDTH,HU.px(80),ATTR_STYLE,HU.css(CSS_MARGIN_RIGHT,HU.px(5))]),e=HU.div([ATTR_STYLE,HU.css(CSS_MAX_HEIGHT,HU.px(100),CSS_OVERFLOW_Y,OVERFLOW_AUTO)],e),v=HU.table([ATTR_WIDTH,HU.perc(100)],HU.tr([ATTR_VALIGN,POS_TOP],HU.td([ATTR_WIDTH,HU.px(80)],e+HU.td(v)))))}n||(v=HU.href(S.getEntryUrl(),v));let O=S.getSnippet()??"";s&&Utils.stringDefined(O)&&(O=HU.div([ATTR_CLASS,"display-entrylist-details-snippet",ATTR_ID,this.getDomId(ID_DETAILS_SNIPPET+D)],O),v+=O,O="");let N="";if(l&&l.length){let e=RamaddaUtil.formatMetadata(S,l);Utils.stringDefined(e)&&(N+=HU.div([],e))}let w,M=HU.div([ATTR_CLASS,"display-entrylist-details-inner",ATTR_ID,this.getDomId(ID_DETAILS_INNER+D)],""),F=HU.div([ATTR_ID,this.getDomId(ID_DETAILS+D),ATTR_CLASS,"display-entrylist-details"],HU.div([ATTR_CLASS,"display-entrylist-details-ancestors",ATTR_ID,this.getDomId(ID_DETAILS_ANCESTORS+D)],"")+O+HU.div([ATTR_CLASS,"display-entrylist-details-tags",ATTR_ID,this.getDomId(ID_DETAILS_TAGS+D)],"")+N+M);w=_&&this.getProperty("showToolbar",!0)?HU.leftCenterRight(v,"",A,"80%","1%","19%"):v;let k=HU.div([ATTR_ONCLICK,E,ATTR_ID,this.getDomId(ID_DETAILS_MAIN+D),ATTR_ENTRYID,L],w);k=HU.div([ATTR_CLASS,HU.classes("display-entrylist-entry-main","entry-main-display-entrylist-"+(m?"even":"odd")),ATTR_ENTRYID,L],k),w=HU.div([ATTR_CLASS,m?"ramadda-row-even":"ramadda-row-odd",ATTR_ID,this.getDomId("entryinner_"+D)],k+F),f+=HU.div([ATTR_ID,this.getDomId("entry_"+D),ATTR_ENTRYID,L,ATTR_CLASS,"display-entrylist-entry"+y],w),f+="\n"}return f},addEntrySelect:function(){let e=this,t=jqid(this.getDomId(ID_DISPLAY_CONTENTS)+"  ."+this.getClass("entry-main"));t.unbind(),t.mouseover((async function(t){let i,s=$(this).attr(ATTR_ENTRYID);await e.getEntry(s,(e=>{i=e})),i?e.propagateEvent("entryMouseover",{entry:i}):console.log("no entry:"+s)})),t.mouseout((async function(t){let i,s=$(this).attr(ATTR_ENTRYID);if(await e.getEntry(s,(e=>{i=e})),!i)return;e.propagateEvent("entryMouseout",{entry:i});Utils.cleanId(s);let l=e.getEntryToolbarId(s);jqid(l)})),this.madeList,this.madeList=!0},getEntriesTable:function(e,t,i){null==this.entriesMap&&(this.entriesMap={});let s=this.getProperty("columnWidths",null);null!=s&&(s=s.split(","));let l=HU.open(TAG_TABLE,[ATTR_WIDTH,HU.perc(100),ATTR_CELLPADDING,0,ATTR_CELLSPACING,0]);l+=HU.open(TAG_TR,[ATTR_VALIGN,POS_TOP]);for(let e=0;e<i.length;e++)l+=HU.td([ATTR_ALIGN,ALIGN_CENTER,ATTR_CLASS,"display-entrytable-header"],i[e]);l+=HU.close(TAG_TR);for(let i=0;i<e.length;i++){l+=HU.open(TAG_TR,[ATTR_VALIGN,ALIGN_TOP]);let a=e[i];this.entriesMap[a.getId()]=a;for(let e=0;e<t.length;e++){let i=null;null!=s&&(i=s[e]);let r=t[e],o="";if("name"==r)o=HU.tag(TAG_A,[ATTR_HREF,a.getEntryUrl()],a.getName());else if(r.match(".*property:.*")){let e=r.substring("property:".length),t=a.getMetadata();o="";for(let i=0;i<t.length;i++){let s=t[i];s.type==e&&(""!=o&&(o+=HU.br()),o+=s.value.attr1)}}else"description"==r?o=a.getDescription():"date"==r?(o=a.ymd,null==o&&(o=a.startDate)):o=a.getAttributeValue(r);let n=[ATTR_CLASS,"display-entrytable-cell"];null!=i&&(n.push(ATTR_WIDTH),n.push(i)),l+=HU.td(n,o)}l+=HU.close(TAG_TR)}return l+=HU.close(TAG_TABLE),l},makeEntryToolbar:function(e,t,i){let s=this.getGet(),l=[],a="{showMenu:true,showTitle:true}";"type_wms_layer"==e.getType().getId()&&l.push(HU.tag(TAG_A,[ATTR_ONCLICK,s+".addMapLayer("+HU.sqt(e.getId())+");"],HU.image(RamaddaUtil.getCdnUrl("/icons/map.png"),[ATTR_BORDER,0,ATTR_TITLE,"Add Map Layer"]))),"geo_shapefile"!=e.getType().getId()&&"geo_geojson"!=e.getType().getId()||l.push(HU.tag(TAG_A,[ATTR_ONCLICK,s+".addMapLayer("+HU.sqt(e.getId())+");"],HU.image(RamaddaUtil.getCdnUrl("/icons/map.png"),[ATTR_BORDER,0,ATTR_TITLE,"Add Map Layer"])));let r=this.getPointUrl(e);if(null!=r){let t;r=r.replace(/\'/g,"_"),l.push(HU.tag(TAG_A,[ATTR_ONCLICK,s+".createDisplay("+HU.sqt(e.getFullId())+","+HU.sqt("table")+","+HU.sqt(r)+","+a+");"],HU.getIconImage("fa-table",[ATTR_TITLE,"Create Tabular Display"]))),l.push(t=HU.tag(TAG_A,[ATTR_ONCLICK,s+".createDisplay("+HU.sqt(e.getFullId())+","+HU.sqt("linechart")+","+HU.sqt(r)+","+a+");"],HU.getIconImage("fa-chart-line",[ATTR_TITLE,"Create Chart"])))}l.push(HU.tag(TAG_A,[ATTR_ONCLICK,s+".createDisplay("+HU.sqt(e.getFullId())+","+HU.sqt("entrydisplay")+","+HU.sqt(r)+","+a+");"],HU.getIconImage("fa-file",[ATTR_BORDER,0,ATTR_TITLE,"Show Entry"]))),e.getFilesize()>0&&l.push(HU.tag(TAG_A,[ATTR_HREF,e.getResourceUrl(),"download",null],HU.image(RamaddaUtil.getCdnUrl("/icons/download.png"),[ATTR_BORDER,0,ATTR_TITLE,"Download ("+e.getFormattedFilesize()+")"])));this.getEntryMenuButton(e);let o=[];t&&t.addToToolbar&&t.addToToolbar(i,e,l);for(let e=0;e<l.length;e++)o.push(HU.div([ATTR_CLASS,"display-entry-toolbar-item"],l[e]));return l=o,HU.div([ATTR_CLASS,"display-entry-toolbar",ATTR_ID,this.getEntryToolbarId(e.getIdForDom())],HU.join(l,""))},getEntryToolbarId:function(e){let t=e.replace(/:/g,"_").replace(/\//g,"_").replace(/[\(\)]/g,"_");return t=t.replace(/=/g,"_"),this.getDomId(ID_TOOLBAR+"_"+t)},hideEntryDetails:function(e){},entryHeaderClick:function(e,t,i){let s=e.target;s.outerHTML&&0!=s.outerHTML.indexOf("<div")||this.toggleEntryDetails(e,t)},makeEntryTags:function(e,t,i,s){i=i||"";let l="",a={},r=[];return e.getMetadata().forEach((e=>{if(["content.pagestyle","content.pagetemplate","content.thumbnail","content.attachment"].includes(e.type))return;if(e.type.startsWith("map"))return;if(e.type.startsWith("spatial"))return;let o=e.label+": "+e.value.attr1,n=String(e.value.attr1);"property"==e.type&&(o+=":"+e.value.attr2,n+=":"+e.value.attr2),n.length>20&&(n=n.substring(0,19)+"..."),n=i+n;let h=Utils.getUniqueId("metadata_"),d=HU.div([ATTR_METADATA_TYPE,e.type,ATTR_METADATA_VALUE,e.value.attr1,ATTR_ID,h,ATTR_CLASS,"display-search-tag",ATTR_TITLE,o,ATTR_STYLE,HU.css(CSS_BACKGROUND,getMetadataColor(e.type))],n);t?(a[e.type]||(a[e.type]=[],r.push(e)),a[e.type].push(d)):l+=d,s&&(s[h]=e)})),t&&r.forEach((e=>{l+=e.label+": "+a[e.type].join(" "),l+=HU.br()})),l},addSearchToTags:function(){return!0},typeSearchEnabled:function(){return!0},toggleEntryDetails:async function(e,t,i,s,l){if(!l)return void await this.getEntry(t,(l=>{this.toggleEntryDetails(e,t,i,s,l)}));null==i&&(i="");let a=this.jq(ID_TREE_LINK+l.getIdForDom()+i),r=ID_DETAILS+l.getIdForDom()+i,o=this.jq(r);if(e&&e.shiftKey){let e=Utils.cleanId(t),i=this.jq(ID_DETAILS_MAIN+e);this.selectedEntriesFromTree||(this.selectedEntriesFromTree={});let s="true"==i.attr("ramadda-selected");return s?(i.removeClass("display-entrylist-entry-main-selected"),i.attr("ramadda-selected","false"),this.selectedEntriesFromTree[l.getId()]=null):(i.addClass("display-entrylist-entry-main-selected"),i.attr("ramadda-selected","true"),this.selectedEntriesFromTree[l.getId()]=l),void this.propagateEvent(DisplayEvent.entrySelection,{entry:l,selected:!s})}let n="true"==a.attr("tree-open");n?a.attr(ATTR_SRC,icon_tree_closed):a.attr(ATTR_SRC,icon_tree_open),a.attr("tree-open",n?"false":"true");let h=()=>{n?o.hide():o.show(),e&&e.stopPropagation&&e.stopPropagation()},d=this,g=null!=o.attr("has-content");if(o.attr("has-content","true"),g)return void h();let p=this.jq(ID_DETAILS_INNER+l.getIdForDom()+i),c=l.isRemote?null:l.getEmbedWikiText();if(c||l.isSynth()||!l.getIsGroup()){let e,t=this.getEntryHtml(l,{showHeader:!1});if(Utils.stringDefined(c)&&(e=this.getUniqueId("details"),t+=HU.div([ATTR_ID,e,ATTR_CLASS,HU.classes(CLASS_BUTTON,CLASS_CLICKABLE)],"Details"),t+=HU.div([ATTR_ID,e+"_contents",ATTR_CLASS,"display-entry-embed"])),p.html(t),e){let t=!1,i=!1;jqid(e).button().click((()=>{t=!t;let s=jqid(e+"_contents");t?(s.show(),i||(i=!0,s.html(HU.div([ATTR_CLASS,"ramadda-image-loading"])),this.wikify(c,l.getId(),(e=>{this.addWikiHtml(s,e)}),(e=>{s.html(e)})))):s.hide()}))}}else{p.html(HU.image(icon_progress));let e=function(e){d.displayChildren(l,e,i,s)};l.getChildrenEntries(e)}h();let u={},T=l.isSynth()?"":HU.getIconImage("fas fa-search")+SPACE;this.addSearchToTags()||(T=""),this.typeSearchEnabled()||(T="");let f=this.makeEntryTags(l,!1,T,u),y=this.jq(ID_DETAILS_TAGS+l.getIdForDom()+i),m=$(HU.span([ATTR_CLASS,"display-search-tag"],T+"Type: "+l.getType().getLabel())).appendTo(y);l.isSynth()||m.click((function(){d.typeTagClicked(l.getType())}));let _=$(f).appendTo(y);l.isSynth()||_.click((function(){d.metadataTagClicked(u[$(this).attr(ATTR_ID)])})),!l.isSynth()&&this.getProperty("showEntryBreadcrumbs",!0)&&this.displayEntryBreadcrumbs(l,this.domId(ID_DETAILS_ANCESTORS+l.getIdForDom()+i))},displayEntryBreadcrumbs:function(e,t,i){Utils.isDefined(i)||(i=100);let s="",l=0,a=e=>{if(l++,!e||l>i)jqid(t).html(s);else{let t=e.getLink(null,!1,[ATTR_TARGET,"_entries"]);""!=s&&(t+=HU.div([ATTR_CLASS,"breadcrumb-delimiter"])),s=t+s,e.getParentEntry(a)}};e.getParentEntry(a)},addWikiHtml:function(e,t){let i=[];[...t.matchAll(/<script *src=("|')?([^ "']+)("|')?.*?<\/script>/gs)].forEach((e=>{t=t.replace(e[0],"");let s=e[2];s=s.replace(/'/g,""),i.push(s)}));let s=()=>{if(0==i.length&&null==i[0])return void e.html(t);let l=i[0];i.splice(0,1),Utils.loadScript(l,s)};s()},metadataTagClicked:function(e){},typeTagClicked:function(e){},getSelectedEntriesFromTree:function(){let e=[];if(this.selectedEntriesFromTree)for(let t in this.selectedEntriesFromTree){let i=this.selectedEntriesFromTree[t];null!=i&&e.push(i)}return e},displayChildren:function(e,t,i,s){i||(i="");let l=this.jq(ID_DETAILS_INNER+e.getIdForDom()+i),a=this.getEntryHtml(e,{showHeader:!1,showImage:0==t.length});if(0==t.length)l.html(a);else{let e=a;this.getProperty("showDetailsForGroup")&&(e+=a),e+=this.getEntriesTree(t,{handlerId:s}),l.html(e),this.addEntrySelect()}},getEntryMenuButton:function(e){return HU.onClick(this.getGet()+".showEntryMenu(event, '"+e.getId()+"');",HU.image(RamaddaUtil.getCdnUrl("/icons/menu.png"),[ATTR_CLASS,"display-entry-toolbar-item",ATTR_ID,this.getDomId(ID_MENU_BUTTON+e.getIdForDom())]))},setOriginalRamadda:function(e){this.originalRamadda=e},setRamadda:function(e){this.ramadda=e},getRamadda:function(){return null!=this.ramadda?this.ramadda:null!=this.ramaddaBaseUrl?(this.ramadda=getRamadda(this.ramaddaBaseUrl),this.ramadda):getGlobalRamadda()},getEntry:async function(e,t){if(this.entriesMap&&this.entriesMap[e])return Utils.call(t,this.entriesMap[e]);let i=this.getRamadda(),s=e.split(",");2==s.length&&(e=s[1],i=getRamadda(s[0]));let l=null;return null!=this.entryList&&await this.entryList.getEntry(e,(e=>l=e)),null==l&&await i.getEntry(e,(e=>l=e)),null==l&&await this.getRamadda().getEntry(e,(e=>l=e)),Utils.call(t,l)},addMapLayer:async function(e){let t;await this.getEntry(e,(e=>{t=e})),null!=t?this.getDisplayManager().addMapLayer(this,t):console.log("No entry:"+e)},doit:function(){console.log("doit")},createDisplay:async function(e,t,i,s){let l;if(await this.getEntry(e,(e=>{l=e})),null==l)return console.log("No entry:"+e),null;let a={sourceEntry:l,entryId:l.getId(),showDetails:!0,title:l.getName(),layoutHere:!1};if(s&&$.extend(a,s),t!=DISPLAY_ENTRYLIST){null==i&&(i=this.getPointUrl(l));let e={entry:l,entryId:l.getId()};a.data=new PointData(l.getName(),null,null,i,e)}null!=this.lastDisplay?(a.column=this.lastDisplay.getColumn(),a.row=this.lastDisplay.getRow()):(a.column=this.getProperty("newColumn",this.getColumn()),a.row=this.getProperty("newRow",this.getRow())),this.lastDisplay=this.getDisplayManager().createDisplay(t,a)},getPointUrl:function(e){let t=e.getService("points.json");return null!=t?t.url:(t=e.getService("grid.point.json"),null!=t?t.url:null)},getEntryMenu:async function(e,t){let i;if(await this.getEntry(e,(e=>{i=e})),null==i)return Utils.call(t,"null entry");let s=this.getGet(),l=[],r=[],o=[],n=[];o.push(HU.tag(TAG_LI,[],HU.tag(TAG_A,[ATTR_HREF,i.getEntryUrl(),ATTR_TARGET,"_"],"View Entry"))),i.getFilesize()>0&&r.push(HU.tag(TAG_LI,[],HU.tag(TAG_A,["download",null,ATTR_HREF,i.getResourceUrl()],"Download "+i.getFilename()+" ("+i.getFormattedFilesize()+")"))),null!=this.jsonUrl&&r.push(HU.tag(TAG_LI,[],"Data: "+HU.onClick(s+".fetchUrl('json');","JSON")+HU.onClick(s+".fetchUrl('csv');","CSV")));let h="{showMenu:true,showTitle:true}",d="<a>New</a><ul>";d+=HU.tag(TAG_LI,[],HU.onClick(s+".createDisplay('"+i.getFullId()+"','entrydisplay',null,null,"+h+");","New Entry Display")),n.push(HU.tag(TAG_LI,[],HU.onClick(s+".createDisplay('"+i.getFullId()+"','entrydisplay',null,null,"+h+");","New Entry Display")));let g=this.getPointUrl(i);if(null!=g){let e=window.globalDisplayTypes,t={};if(e)for(let l=0;l<e.length;l++){let a=e[l];if(!a.requiresData||!a.forUser)continue;Utils.isDefined(t[a.category])||(t[a.category]="<li> <a>"+a.category+"</a><ul>\n"),g=g.replace(/\'/g,"_");let r=s+".createDisplay("+HU.sqt(i.getFullId())+","+HU.sqt(a.type)+","+HU.sqt(g)+",null,"+h+");",o=HU.tag(TAG_LI,[],HU.tag(TAG_A,[ATTR_ONCLICK,r],a.label));t[a.category]+=o+"\n",n.push(o)}for(a in t)d+=t[a]+"</li></ul>"}r.length>0&&l.push("<a>File</a>"+HU.tag(TAG_UL,[],HU.join(r))),o.length>0&&l.push("<a>View</a>"+HU.tag(TAG_UL,[],HU.join(o))),n.length>0&&l.push(d);let p="";for(let e=0;e<l.length;e++)p+=HU.tag(TAG_LI,[],l[e]);t(HU.tag(TAG_UL,[ATTR_ID,this.getDomId(ID_MENU_INNER+i.getIdForDom()),ATTR_CLASS,"sf-menu"],p))},showEntryMenu:async function(e,t){let i;await this.getEntryMenu(t,(e=>{i=e})),this.writeHtml(ID_MENU_OUTER,i);let s=this.getDomId(ID_MENU_BUTTON+Utils.cleanId(t));this.dialog=HU.makeDialog({content:i,anchor:s,draggable:!1,header:!1}),jqid(this.getDomId(ID_MENU_INNER+Utils.cleanId(t))).superfish({speed:"fast",delay:300})},fetchUrl:function(e,t){"csv"!=e?(null==t&&(t=this.jsonUrl),null!=(t=this.getDisplayManager().getJsonUrl(t,this))&&(null!=e&&"json"!=e&&(t=t.replace("points.json","points."+e)),console.log(t),window.open(t,"_blank"))):this.getCsv(null,this.filterData(),!1,-1,null,"download.csv")},getMenuItems:function(e){},getDisplayMenuSettings:function(){let e="getRamaddaDisplay('"+this.getId()+"')",t=HU.onClick(e+".moveDisplayRight();","Right"),i=HU.onClick(e+".moveDisplayLeft();","Left"),s=HU.onClick(e+".moveDisplayTop();","Top"),l=HU.onClick(e+".moveDisplayUp();","Up"),a=HU.onClick(e+".moveDisplayDown();","Down"),r=HU.open(TAG_TABLE,[ATTR_CLASS,CLASS_FORMTABLE])+HU.tag(TAG_TR,[],HU.tag(TAG_TD,[ATTR_ALIGN,ALIGN_RIGHT],HU.boldLabel("Move"))+HU.tag(TAG_TD,[],s+" "+l+" "+a+" "+t+" "+i))+HU.tag(TAG_TR,[],HU.tag(TAG_TD,[ATTR_ALIGN,ALIGN_RIGHT],HU.boldLabel("Row"))+HU.tag(TAG_TD,[],HU.input("",this.getProperty("row",""),[ATTR_SIZE,7,ATTR_ID,this.getDomId("row")])+SPACE2+HU.boldLabel("Col")+HU.input("",this.getProperty("column",""),[ATTR_SIZE,7,ATTR_ID,this.getDomId("column")])))+HU.tag(TAG_TR,[],HU.tag(TAG_TD,[],HU.boldLabel("Width"))+HU.tag(TAG_TD,[],HU.input("",this.getProperty("width",""),[ATTR_SIZE,7,ATTR_ID,this.getDomId("width")])+"  "+HU.boldLabel("Height")+HU.input("",this.getProperty("height",""),[ATTR_SIZE,7,ATTR_ID,this.getDomId("height")])))+HU.close(TAG_TABLE),o=HU.checkbox(this.getDomId("showtitle"),[],this.getProperty("showTitle"))+" Title  "+HU.checkbox(this.getDomId("showdetails"),[],this.getProperty("showDetails"))+" Details "+SPACE3+HU.onClick(e+".askSetTitle();","Set Title");return r+=HU.formTable()+HU.formEntryLabel("Show",o)+HU.close(TAG_TABLE),r},loadInitialData:function(){this.getProperty("okToLoadData",!0)&&(this.getInlineDataSrc()?this.getData():this.needsData()&&null!=this.properties.theData&&(this.getProperty("latitude")&&(this.properties.theData.lat=this.getProperty("latitude"),this.properties.theData.lon=this.getProperty("longitude","-105")),this.properties.theData.hasData()?this.addData(this.properties.theData):this.properties.theData.loadData(this)))},getData:function(){if(!this.hasData()){if(this.properties.theData)return this.properties.theData;if(!this.getInlineDataSrc())return null;this.addData(makeInlineData(this,this.getInlineDataSrc())),this.checkSearchBar()}return this.dataCollection.getList()[0]},hasData:function(){return null!=this.dataCollection&&this.dataCollection.hasData()},getCreatedInteractively:function(){return 1==this.createdInteractively},needsData:function(){return!1},askSetTitle:function(){let e=this.getTitle(!1),t=prompt(ATTR_TITLE,e);null!=t&&(this.title=t,this.setProperty(ATTR_TITLE,t),this.setDisplayTitle(this.title))},getShowDetails:function(){return this.getSelfProperty("showDetails",!0)},setShowDetails:function(e){this.showDetails=e,this.showDetails?this.jq(ID_DETAILS).show():this.jq(ID_DETAILS).hide()},setShowTitle:function(e){("true"===e||"false"===e)&&(e=!0),this.setProperty("showTitle",e),e?this.jq(ID_TITLE).show():this.jq(ID_TITLE).hide()},setDisplayProperty:function(e,t){this.setProperty(e,t),jqid(this.getDomId(e)).val(t)},deltaColumn:function(e){let t=parseInt(this.getProperty("column",0));t+=e,t<0&&(t=0),this.setDisplayProperty("column",t),this.getLayoutManager().layoutChanged(this),this.jq("col").val(t)},deltaRow:function(e){let t=parseInt(this.getProperty("row",0));isNaN(t)&&(t=0),t+=e,t<0&&(t=0),this.setDisplayProperty("row",t),this.getLayoutManager().layoutChanged(this),this.jq("row").val(t)},moveDisplayRight:function(){this.getLayoutManager().isLayoutColumns()?this.deltaColumn(1):this.getLayoutManager().moveDisplayDown(this)},moveDisplayLeft:function(){this.getLayoutManager().isLayoutColumns()?this.deltaColumn(-1):this.getLayoutManager().moveDisplayUp(this)},moveDisplayUp:function(){this.getLayoutManager().isLayoutRows()?this.deltaRow(-1):this.getLayoutManager().moveDisplayUp(this)},moveDisplayDown:function(){this.getLayoutManager().isLayoutRows()?this.deltaRow(1):this.getLayoutManager().moveDisplayDown(this)},moveDisplayTop:function(){this.getLayoutManager().moveDisplayTop(this)},getDialogContents:function(e,t){this.getDisplayDialogContents(e,t)},showFieldsInDialog:function(){return!1},getDisplayDialogContents:function(e,t){if(this.hasData()){let i=HU.div([ATTR_ID,this.domId(ID_FIELDS)],"");e.push("Fields"),t.push(i)}this.getGet();let i=[];this.getMenuItems(i);let s="<form>";s+=this.getDisplayMenuSettings();for(let e=0;e<i.length;e++)s+=HU.div([ATTR_CLASS,"display-menu-item"],i[e]);s+="</form>",e.push("Display"),t.push(s)},checkLayout:function(){},isActiveDisplay:function(){return this.getMainDiv().length},handleWindowResize:function(){this.isActiveDisplay()&&this.displayData()},displayData:function(){},setDisplayReady:function(){let e=!this.displayReady;this.displayReady=!0,e&&this.callUpdateUI({force:!0})},getDisplayReady:function(){return this.displayReady},pageHasLoaded:function(){this.displayReady||this.setDisplayReady(!0)},checkFinished:function(){return!1},getIsFinished(){return this.isFinished},setIsFinished(){this.isFinished=!0},isDisplayFinished:function(){return this.checkFinished()?this.getIsFinished():!(!this.hasData()&&this.needsData())},doFinalInitialization:function(){},initDisplay:function(){this.inError||(this.createUI(),this.getAnimation().getEnabled()&&this.getAnimation().makeControls(),this.checkSearchBar(),this.callUpdateUI({force:!0}),this.getProperty("reloadSeconds")&&this.runReload())},runReload:function(){setTimeout((()=>{this.reloadData(),this.runReload()}),1e3*this.getProperty("reloadSeconds"))},getMainDiv:function(){let e=this.getProperty("targetDiv",this.getProperty(PROP_DIVID,null,null,!0),null,!0);return jqid(e)},getGroupDiv:function(){return jqid(this.getProperty("groupDiv"))},createUI:function(){let e=this.getProperty("targetDiv",this.getProperty(PROP_DIVID,null,null,!0),null,!0);if(null!=e){let t=this.getHtml(),i=jqid(e),s=this.getDisplayInline();s&&(i.css(CSS_DISPLAY,DISPLAY_INLINE_BLOCK),i.css(CSS_VERTICAL_ALIGN,POS_BOTTOM));let l=this.getWidth(HU.perc(100));!s&&l&&"-1"!=l&&i.css(CSS_WIDTH,HU.getDimension(l));let a=this.getHeaderText(),r={},o=i;if(a){let e=this.createCommandText(a,r);this.getHeaderTextDiv()?(o=jqid(this.getHeaderTextDiv()),o.html(e)):t=e+t}i.html(t),a&&this.initCommandText(r,o)}else console.log("error: no div defined for display:"+this.getType())},getMenuButton:function(){let e=this.getGet(),t=HU.onClick(e+".showDialog();",HU.image(RamaddaUtil.getCdnUrl("/icons/downdart.png"),[ATTR_TITLE,"Show display menu",ATTR_CLASS,"display-dialog-button",ATTR_ID,this.getDomId(ID_MENU_BUTTON)]));return t+=" ",t},getHtml:function(){let e=this.getContentsDiv();if(this.getNoWrapper())return e;this.getGet();let t="";(this.getShowMenu()||this.getShowMenuRight())&&(t=this.getMenuButton());let i="";this.getShowTitle()&&(i=this.getTitle(!1).trim());let s="";this.getShowMenuRight()&&(s=t,t="");let l="";if(""!=t||""!=i){let e=this.getTitleHtml(i);l=""==t?e:HU.div([ATTR_CLASS,"display-header"],t+SPACE+e)}l=HU.div([ATTR_ID,this.getDomId(ID_TOP_LEFT),ATTR_CLASS,"display-header-block"],l);let a=this.getProperty("headerStyle",""),r=this.getAnimationEnabled(),o=HU.div([ATTR_STYLE,a,ATTR_ID,this.getDomId(ID_HEADER1),ATTR_CLASS,"display-header-block display-header1"],""),n=HU.div([ATTR_STYLE,a,ATTR_ID,this.getDomId(ID_HEADER2),ATTR_CLASS,"display-header-block display-header2"],""),h=HU.div([ATTR_ID,this.getDomId(ID_TOP),ATTR_CLASS,"display-header-block"],r?"":n),d=HU.div([ATTR_ID,this.getDomId(ID_TOP_RIGHT)],s),g=this.getProperty("showHeader",!0)?HU.leftCenterRight(l,h,d,null,null,null,{valign:"bottom"}):"";this.getHeaderDiv()&&(jqid(this.getHeaderDiv()).html(g),g="");let p=o;r&&(p+=n),g=p+g;let c=HU.div([ATTR_ID,this.getDomId(ID_COLORTABLE)]),u="",T="",f="",y=HU.div([ATTR_ID,this.getDomId(ID_LEGEND)]),m=this.getProperty("colorTableSide","bottom");"top"==m?g+=c:"right"==m?u+=c:"left"==m?T+=c:f+=c,f+=HU.div([ATTR_CLASS,"",ATTR_ID,this.getDomId(ID_BOTTOM)]),f+=y;let _="";this.getProperty("leftSideWidth")&&(_=HU.css(CSS_WIDTH,HU.getDimension(this.getProperty("leftSideWidth"))));let S=HU.div([ATTR_ID,this.getDomId(ID_LEFT),ATTR_STYLE,_],T),A=HU.div([ATTR_ID,this.getDomId(ID_RIGHT)],u),I=HU.px(1),b=HU.perc(100),R=HU.div([ATTR_ID,this.getDomId(ID_HEADER0),ATTR_CLASS,"display-header-block display-header0"],"")+HU.open(TAG_TABLE,[ATTR_STYLE,this.isGoogleChart?HU.css(CSS_BORDER,HU.border(1,COLOR_TRANSPARENT)):"",ATTR_CLASS,"display-ui-table",ATTR_WIDTH,HU.perc(100),ATTR_BORDER,0,ATTR_CELLPADDING,0,ATTR_CELLSPACING,0]);this.getShowTopHeader(this.getProperty("showDisplayTop",!0))&&(R+=HU.tr([],HU.td([ATTR_WIDTH,I])+HU.td([ATTR_WIDTH,b],g)+HU.td([ATTR_WIDTH,I]))),R+=HU.tr([ATTR_VALIGN,POS_TOP],HU.td([ATTR_WIDTH,I],S)+HU.td([ATTR_WIDTH,b],e)+HU.td([ATTR_WIDTH,I],A)),this.getProperty("showDisplayBottom",!0)&&(this.getFooterDiv(this.getProperty("bottomDiv"))&&(jqid(this.getFooterDiv(this.getProperty("bottomDiv"))).html(f),f=""),R+=HU.tr([],HU.td([ATTR_WIDTH,I])+HU.td([ATTR_WIDTH,b],f)+HU.td([ATTR_WIDTH,I]))),R+=HU.close(TAG_TABLE);let D=HU.div([ATTR_ID,this.domId(ID_DISPLAY_MESSAGE),ATTR_CLASS,"display-output-message",ATTR_STYLE,HU.css(CSS_DISPLAY,DISPLAY_NONE,CSS_POSITION,POSITION_ABSOLUTE,CSS_TOP,HU.px(10),CSS_LEFT,HU.perc(50),CSS_WEBKIT_TRANSFORM,"translateX(-50%)",CSS_TRANSFORM,"translateX(-50%)")],""),L=HU.div([ATTR_CLASS,CLASS_POPUP,ATTR_STYLE,HU.css(CSS_DISPLAY,DISPLAY_NONE),ATTR_ID,this.getDomId(ID_MENU_OUTER)],""),U=this.getProperty("displayStyle","");return L+=HU.div([ATTR_ID,this.domId(ID_DISPLAY_CONTAINER),"spellcheck","false",ATTR_CLASS,HU.classes("display-contents","display-"+this.type+"-contents"),ATTR_STYLE,HU.css(CSS_POSITION,POSITION_RELATIVE)+U],R+D),L},getWidthForStyle:function(e){let t=this.getProperty("width",-1);return-1==t?e:HU.getDimension(t)},getHeightForStyle:function(e){let t=this.getProperty("height",-1);return-1==t?e:(new String(t).match("^[0-9]+$")&&(t=HU.px(t)),t)},getContentsStyle:function(){let e="",t=this.getHeightForStyle();t&&(e+=HU.css(CSS_HEIGHT,t));let i=this.getProperty("maxHeight");return i&&(e+=HU.css(CSS_MAX_HEIGHT,HU.getDimension(i),CSS_OVERFLOW_Y,OVERFLOW_AUTO)),e},getContentsClass:function(){return"ramadda-expandable-target display-contents-inner display-"+this.type},getContentsDiv:function(){let e=this.getContentsStyle();e+=this.getProperty("contentsStyle","");let t=this.getProperty("backgroundImage");t&&(t=HU.getEntryImage(this.entryId,t),e+=HU.css("background-attachment","auto","background-size","100% auto","background-image","url('"+t+"')"));let i=this.getProperty(CSS_BACKGROUND);i&&(e+=HU.css(CSS_BACKGROUND,i));let s=HU.div([ATTR_STYLE,"",ATTR_ID,this.getDomId(ID_DISPLAY_TOP)],""),l=HU.div([ATTR_STYLE,"",ATTR_ID,this.getDomId(ID_DISPLAY_BOTTOM)],""),a=this.getProperty("expandedHeight");a&&(e+=HU.css(CSS_HEIGHT,a)),this.getProperty("showInnerContents",!0)||(e+="display:none;");let r=[ATTR_CLASS,this.getContentsClass(),ATTR_STYLE,e,ATTR_ID,this.getDomId(ID_DISPLAY_CONTENTS)];this.getProperty("expandableHeight")&&(r.push("expandable-height"),r.push(this.getProperty("expandableHeight")));let o=HU.div(r,"");return this.getNoWrapper()?o:s+"\n"+o+"\n"+l},prepareToLayout:function(){this.getColumn(),this.getWidth(),this.getHeight(),this.getName(),this.getEventSource()},getColumn:function(){return this.getFormValue("column",0)},getRow:function(){return this.getFormValue("row",0)},getWidth:function(e){return this.getFormValue("width",e)},getHeight:function(){return this.getFormValue("height",0)},getDisplayTitle:function(e){e||(e=null!=this.title?this.title:"");let t=e,i=this.lastSelectedFields;return t=i&&i.length>0?t.replace("{field}",i[0].getLabel()):t.replace("{field}",HU.span([ATTR_ID,this.getDomId(ID_TITLE_FIELD)],SPACE)),t},setDisplayTitle:function(e){Utils.stringDefined(e)||(e=this.getTitle(!1).trim());let t=this.getTitleHtml(e);this.getShowTitle()?this.jq(ID_TITLE).show():this.jq(ID_TITLE).hide(),this.writeHtml(ID_TITLE,t)},applyTitleTemplate:function(e){let t=e.replace(/\${title}/g,this.getProperty(ATTR_TITLE)??""),i=this.getPointData();return i&&i.records&&i.records.length&&(t=t.replace(/_first/g,""),t=this.applyRecordTemplate(i.records[0],null,null,t),t=t.replace(/_last/g,""),t=this.applyRecordTemplate(i.records[i.records.length-1],null,null,t)),t=t.replace(/\${.*?}/g,""),t},getTitle:function(e){let t="";e&&this.hasEntries()&&(t=this.getEntryMenuButton(this.getEntries()[0])+" ");let i=this.getProperty(ATTR_TITLE),s=this.getTitleTemplate();if(null!=s)return i=this.applyTitleTemplate(s),t+i;if(Utils.stringDefined(i))return i;if(null==this.dataCollection)return t;let l=this.dataCollection.getList();i="";for(let e=0;e<l.length;e++){e>0&&(i+="/"),i+=l[e].getName()}return t+i},getIsLayoutFixed:function(){return this.getProperty(PROP_LAYOUT_HERE,!0)},makeToolbar:function(e){let t="",i=this.getGet(),s=e.addLabel,l=[],a=[],r=[];this.getIsLayoutFixed()||(a.push("removeRamaddaDisplay('"+this.getId()+"')"),l.push("fa-cut"),r.push("Delete display")),a.push(i+".copyDisplay();"),l.push("fa-copy"),r.push("Copy Display"),null!=this.jsonUrl&&(a.push(i+".fetchUrl('json');"),l.push(RamaddaUtil.getCdnUrl("/icons/json.png")),r.push("Download JSON"),a.push(i+".fetchUrl('csv');"),l.push(RamaddaUtil.getCdnUrl("/icons/csv.png")),r.push("Download CSV"));for(let e=0;e<a.length;e++){let i=HU.getIconImage(l[e],[ATTR_WIDTH,HU.px(18),ATTR_TITLE,r[e],ATTR_CLASS,"display-dialog-header-icon"]);s&&(i+=" "+r[e]+HU.br()),t+=HU.onClick(a[e],i)}return t},getHeader2:function(){return""},initHeader2:function(){},writeHeader:function(e,t){""==t?this.jq(e).css(CSS_DISPLAY,DISPLAY_INLINE_NONE):this.jq(e).css(CSS_DISPLAY,DISPLAY_INLINE_BLOCK),this.jq(e).html(t)},checkLayout:function(){let e=this.jq(ID_DISPLAY_CONTENTS).width();this.lastWidth!=e&&(this.lastWidth=e,this.displayData())},forceUpdateUI:function(){this.haveCalledUpdateUI=!1,this.callUpdateUI()},callUpdateUI:function(e){e=e||{};try{e.force&&(this.haveCalledUpdateUI=!1),this.updateUI(e)}catch(e){this.handleError(""+e,e)}},updateUI:function(e){},getFilterId:function(e){return this.getDomId("filterby_"+e)},getRequestMacros:function(){return this.requestMacros||(this.requestMacros=this.getRequestMacrosInner()),this.requestMacros},getRequestMacrosInner:function(){(this.getProperty("requestFieldsDefault")||this.getProperty("requestFields"))&&(this.requestMacros=null,[["requestFields","date,stride,skip,limit"],["requestFieldsToggleOpen",!0],["request.date.type","daterange"],["request.stride.title","Specify a skip factor"],["request.stride.includeNone",!1],["request.stride.type","enumeration"],["request.stride.values","0:None,1,2,3,4,5,6,7,8,9,10,15,20,30,40,50,75,100"],["request.stride.default",0],["request.limit.label","# Records"],["request.limit.title","Limit how many records to return"],["request.limit.size","4"],["request.skip.size","4"],["request.skip.type","skip"],["request.skip.default",this.getProperty("skip","0")],["request.limit.default",this.getProperty("max","20000")],["requestFieldsLive",!1]].forEach((e=>{Utils.isDefined(this.getProperty(e[0]))||this.setProperty(e[0],e[1])})));let e=[],t=this.getProperty("requestFields",""),i=this.getProperty("extraFields1",""),s=this.getProperty("extraFields2","");return Utils.mergeLists(i.split(","),t.split(","),s.split(",")).forEach((t=>{""!=t&&e.push(new RequestMacro(this,t))})),e.forEach((t=>{t.initMacros(e)})),e},applyRequestProperties:function(e){e&&(this.requestMacros=null,this.dynamicProperties=e,this.createRequestProperties())},createRequestProperties:function(){let e="",t=this.getRequestMacros(),i=[],s=this.getRequestFieldsLive(),l=HU.space(2);if(s||(e+=HU.span([ATTR_CLASS,CLASS_BUTTON_SMALL,ATTR_TITLE,"Reload data",ATTR_STYLE,"",ATTR_CLASS,"",ATTR_ID,this.domId("requestapply")],HU.getIconImage("fa-solid fa-rotate-right"))+l),t.forEach((t=>{e+=t.getWidget(i),t.isVisible()&&(e+=l)})),this.getRequestFieldsToggle()&&(e=HU.toggleBlock(this.getProperty("requestFieldsToggleLabel","Select")+HU.space(3),e,this.getProperty("requestFieldsToggleOpen",!1),{orientation:"horizontal"})),Utils.stringDefined(e)){this.getRequestFieldsShow()||(e=HU.div([ATTR_STYLE,HU.css(CSS_DISPLAY,DISPLAY_NONE)],e)),this.writeHeader(ID_REQUEST_PROPERTIES,HU.div([],e)),this.getRequestFieldsShow()}let a={},r=this.jq("requestapply").button(),o=()=>{r.css(CSS_BACKGROUND,""),r.css(CSS_BORDER_COLOR,""),this.macroChanged(),this.reloadData()},n=(e,t,i,l,n)=>{if(e&&e.notifyChange(),i){if(!l&&t==a[e.urlarg+"_"+i])return;a[e.urlarg+"_"+i]=t}if(this.settingMacroValue)return;let h=!1;if((n||s)&&e.triggerReload?(h=!0,o()):(r.css(CSS_BACKGROUND,"yellow"),r.css(CSS_BORDER_COLOR,COLOR_BLACK)),!e.name)return;this.settingMacroValue=!0;let d={entryId:this.entryId,property:"macroValue",id:e.name,what:i,value:t};this.propagateEvent(DisplayEvent.propertyChanged,d),this.settingMacroValue=!1};r.click((()=>{o()}));i.forEach((e=>{HU.datePickerInit(e)})),this.jq(ID_HEADER2).find(".display-request-reload").click((()=>{n({triggerReload:!0})})),t.every((e=>{e.initWidget(n);let t=function(t,i,s,l){13==(t.keyCode||t.which)&&n(e,s,i,l,!0)};jqid(this.getDomId(e.getId())+",#"+this.getDomId(e.getId()+"_min")+",#"+this.getDomId(e.getId()+"_max")).keyup((function(e){t(e,null,$(this).val())})),"bounds"==e.type&&this.jq(e.getId()).change((function(t){n(e,HU.isChecked($(this)))})),"enumeration"==e.type&&this.jq(e.getId()).change((function(t){n(e,$(this).val())})),this.jq(e.getId()+"_min").change((function(e){})),this.jq(e.getId()+"_max").change((function(e){}));let i=this.jq(e.getId()+"_from"),s=this.jq(e.getId()+"_to");return i.length&&(i.keyup((function(e){t(e,"from",$(this).val(),!0)})),s.keyup((function(e){t(e,"to",$(this).val(),!0)})),a[e.urlarg+"_from"]=i.val(),a[e.urlarg+"_to"]=s.val(),i.change((function(t){n(e,$(this).val(),"from")})),s.change((function(t){n(e,$(this).val(),"to")}))),!0}))},makeFilterWidget:function(e,t,i,s){return t?(t=this.makeFilterLabel(t,s)+(0==t.trim().length?" ":": "),this.getFilterLabelVertical(this.getProperty(e+".filterLabelVertical"))?t=t+HU.br()+i:t+=i,HU.div([ATTR_CLASS,"display-filter-widget"],t)):HU.div([ATTR_CLASS,"display-filter-widget"],i)},makeFilterLabel:function(e,t,i){let s="display-filter-label";i&&(s+=" display-filter-label-vertical ");let l=[ATTR_CLASS,s];return t&&(l.push(ATTR_TITLE),l.push(t)),HU.span(l,e)},stepFilterDateAnimation:function(e,t){let i=jqid(this.getFilterId(ID_FILTER_DATE)),s=i[0].selectedIndex;s+=t,s>=i.find("option").length||s<0||(i[0].selectedIndex=s,e(i),this.filterDatePlayingAnimation&&setTimeout((()=>{this.stepFilterDateAnimation(e,1)}),this.getProperty("filterDateAnimationSleep",1e3)))},addFilters:function(e){},initializeRangeSlider:function(e,t,i){let s=this;e.mousedown((function(){let e=$(this).attr(ID),l=$(this).attr(ATTR_DATA_TYPE);e.endsWith("_min")?e=e.replace(/_min$/,""):e.endsWith("_max")&&(e=e.replace(/_max$/,""));let a=jqid(e+"_min"),r=jqid(e+"_max"),o={min:parseFloat(a.attr(ATTR_DATA_MIN)),max:parseFloat(r.attr(ATTR_DATA_MAX))},n=String(a.attr(ATTR_DATA_MIN)).replace(/.*\./,""),h=String(r.attr(ATTR_DATA_MAX)).replace(/.*\./,""),d=Math.max(2,Math.max(n.length,h.length)),g=parseFloat(a.val()),p=parseFloat(r.val());g==parseInt(g)&&p==parseInt(p)&&(d=0);let c=HU.div([ATTR_ID,"filter-range",ATTR_STYLE,HU.css(CSS_WIDTH,HU.px(200))],""),u=HU.getTooltip();u.html(c),u.show(),u.position({of:a,my:POS_LEFT_TOP,at:"left bottom+2",collision:"fit fit"}),isNaN(g)&&(g=o.min),isNaN(p)&&(p=o.max);let T=1;"double"!=l&&parseInt(o.max)==o.max&&parseInt(o.min)==o.min||(T=(o.max-o.min)/1e5),jqid("filter-range").slider({range:!0,min:o.min,max:o.max,step:T,values:[g,p],slide:function(e,s){let l=String(Utils.roundDecimals(s.values[0],d)),o=String(Utils.roundDecimals(s.values[1],d));l.endsWith(".")&&(l=l.replace(/\./,"")),o.endsWith(".")&&(o=o.replace(/\./,"")),a.val(l),r.val(o),a.attr(ATTR_DATA_VALUE,a.val()),r.attr(ATTR_DATA_VALUE,r.val()),i&&t(a,r)},stop:function(){HU.getTooltip().hide(),s.checkFilterField(r),t(a,r)}})}))},getRecordFilter:function(e){if(this.filters)for(let t=0;t<this.filters.length;t++){let i=this.filters[t];if(i.field&&i.field.getId()==e)return i;if(i.id==e)return i}return null},checkSearchBar:function(){if(!this.hasData())return;let e=this.getProperty("hideFilterWidget",!1,!0),t="vertical"==this.getProperty("headerOrientation","horizontal"),i="display-filter",s=displayDebug.checkSearchBar;s&&console.log("checkSearchBar");let l=this,a=this.getFieldById(null,this.getProperty("colorBy",""));this.colorByFields=this.getFieldsByIds(null,this.getProperty("colorByFields","",!0)),this.sizeByFields=this.getFieldsByIds(null,this.getProperty("sizeByFields","",!0)),this.sortByFields=this.getFieldsByIds(null,this.getProperty("sortByFields","",!0));let r=this.getData();if(null==r)return;this.getFields();let o=this.getRecords();o=this.sortRecords(o);let n="";this.getShowProgress(!1)&&(n+=HU.div([ATTR_ID,this.getDomId(ID_DISPLAY_PROGRESS),ATTR_STYLE,HU.css(CSS_DISPLAY,DISPLAY_INLINE_BLOCK,CSS_MARGIN_RIGHT,HU.px(4),CSS_MIN_WIDTH,HU.px(20))]));let h=this.getHeaderLabel();if(Utils.stringDefined(h)&&(n+=HU.div([ATTR_CLASS,HU.classes(CLASS_HEADER_SPAN,CLASS_HEADER_LABEL)],h)),n+=HU.div([ATTR_ID,this.getDomId(ID_HEADER2_PREPREPREFIX),ATTR_CLASS,CLASS_HEADER_SPAN],""),n+=HU.div([ATTR_ID,this.getDomId(ID_HEADER2_PREPREFIX),ATTR_CLASS,CLASS_HEADER_SPAN],""),n+=HU.div([ATTR_ID,this.getDomId(ID_HEADER2_PREFIX),ATTR_CLASS,CLASS_HEADER_SPAN],""),n+=this.getHeader2(),(this.getProperty("pageRequest",!1)||this.getFilterPaginate())&&(n+=HU.div([ATTR_CLASS,HU.classes(CLASS_HEADER_SPAN,"display-filter"),ATTR_ID,this.getDomId(ID_PAGE_COUNT)])),n+=HU.div([ATTR_ID,this.getDomId(ID_REQUEST_PROPERTIES),ATTR_CLASS,CLASS_HEADER_SPAN],""),this.getProperty("legendFields")||this.getProperty("showFieldLegend",!1)){let e=this.getColorList(),t=this.getFieldsByIds(null,this.getProperty("legendFields",this.getPropertyFields(this.getProperty("sumFields")))),i="",s=0;t.forEach((t=>{s>=e.length&&(s=0);let l=e[s];i+=HU.div([ATTR_STYLE,HU.css(CSS_DISPLAY,DISPLAY_INLINE_BLOCK,CSS_WIDTH,HU.px(8),CSS_HEIGHT,HU.px(8),CSS_BACKGROUND,l)])+" "+t.getLabel()+SPACE2,s++})),n+=HU.div([ATTR_CLASS,"display-field-legend"],i)}if(this.getProperty("showDisplayFieldsMenu",!1)){let e=r.getChartableFields();if(e.length){let t=this.getSelectedFields(),s=[];t.forEach((e=>s.push(e.getId())));let l=[];e.forEach((e=>{e.isFieldGeo()||l.push([e.getId(),e.getLabel()])}));let a=[ATTR_ID,this.getDomId("displayfields")];this.getProperty("displayFieldsMenuMultiple",!1)&&(a.push(ATTR_MULTIPLE,"true"),a.push(ATTR_SIZE,4)),this.displayFieldsMenuEnums=l;let r=HU.span([ATTR_CLASS,i],this.makeFilterLabel("Display: ")+HU.select("",a,l,s))+SPACE;"left"==this.getProperty("displayFieldsMenuSide","top")?this.jq(ID_LEFT).append(r):n+=r}}let d=this.getProperty("selectFields"),g=[];if(d&&d.split(";").forEach((e=>{let[t,s,l]=e.split(":");null==l&&(l=s,s=Utils.makeLabel(t));let a=this.getFieldsByIds(null,l),r=[];a.forEach((e=>{e.isFieldGeo()||r.push([e.getId(),e.getLabel()])})),n+=HU.span([ATTR_CLASS,i],(""==s?"":this.makeFilterLabel(s+": "))+HU.select("",[ATTR_ID,this.getDomId("fieldselect_"+t)],r,this.getProperty(t,"")))+SPACE,g.push(t)})),this.colorByFields.length>0){let e=[];this.colorByFields.forEach((t=>{t.isFieldGeo()||e.push([t.getId(),t.getLabel(this)])}));let t=a?a.getId():"",s=this.makeFilterLabel(this.getProperty("colorByLabel","Color by:"+SPACE));n+=HU.span([ATTR_CLASS,i],s+HU.select("",[ATTR_ID,this.getDomId("colorbyselect")],e,t,20))+SPACE}let p=this.getProperty("sortAscending",!0);if(this.sortByFields.length>0){let e=[];this.sortByFields.forEach((t=>{if(t.isFieldGeo())return;let i=t.getId(),s=t.getLabel();Utils.stringDefined(t.getGroup())&&(s=t.getGroup()+"-"+s);let l=this.getProperty("sortSuffixUp"," _uparrow_").replace("_uparrow_","&uarr;"),a=this.getProperty("sortSuffixDown"," _downarrow_").replace("_downarrow_","&darr;");t.isFieldString()&&(l="A-Z",a="Z-A"),p||t.isFieldString()?(e.push([i+"_up",s+" "+l]),e.push([i+"_down",s+" "+a])):(e.push([i+"_down",s+" "+a]),e.push([i+"_up",s+" "+l]))})),n+=HU.span([ATTR_CLASS,i],this.makeFilterLabel("Order: ")+HU.select("",[ATTR_ID,this.getDomId("sortbyselect")],e,this.getProperty("sortFields","")))+SPACE}if(this.uniqueFields=this.getFieldsByIds(null,this.getSelectUniqueFields()),this.uniqueFields&&this.uniqueFields.length>0){let e=[];this.uniqueFields.forEach((t=>{if(t.isFieldGeo())return;let i=t.getId(),s=t.getLabel();e.push([i,s])})),n+=HU.span([ATTR_CLASS,i],this.makeFilterLabel("Unique: ")+HU.select("",[ATTR_MULTIPLE,!0,ATTR_SIZE,Math.min(this.uniqueFields.length,4),ATTR_ID,this.getDomId("uniquefields")],e,null))+SPACE}if(this.getProperty("showSortDirection")&&(n+=HU.select("",[ATTR_ID,this.getDomId("sortdirection")],[["up","Sort Up"],["down","Sort Down"]],p?"up":"down")+SPACE),this.sizeByFields.length>0){let e=[];this.sizeByFields.forEach((t=>{e.push([t.getId(),t.getLabel()])})),n+=HU.span([ATTR_CLASS,i],this.makeFilterLabel("Size by: ")+HU.select("",[ATTR_ID,this.getDomId("sizebyselect")],e,this.getProperty("sizeBy","")))+SPACE}let c=this.getFilterHighlight();if(this.getShowFilterHighlight()){let t=[["filter","Filter"],["highlight","Highlight"]],i=HU.select("",["fieldId","_highlight",ATTR_ID,this.getDomId(ID_FILTER_HIGHLIGHT)],t,c?"highlight":"filter")+SPACE2;e&&(i=HU.div([ATTR_STYLE,HU.css(CSS_DISPLAY,DISPLAY_NONE)],i)),n+=i}let u=[];if(this.getTheDataFilters().forEach((e=>{if(!e.label)return;let t=this.getDomId("datafilterenabled_"+e.id);u.push(t),n+=HU.checkbox(t,[ATTR_ID,t],e.enabled,e.label+SPACE2)})),this.getProperty("filterDate")){let t=this.getProperty("filterDate"),s=[];this.getProperty("filterDateIncludeAll")&&s.push(["all","All"]);let l=null,a={},r=[];o.forEach((e=>r.push(e.getDate()))),r.sort((function(e,t){return e.getTime()-t.getTime()})),r.forEach((e=>{let i=null;"year"==t?i=e.getFullYear():"day"==t&&(i=Utils.formatDateMonthDayYear(e)),a[i]||(l=String(e),s.push([String(e),i]),a[i]=!0)}));let h="year"==t?"Year":"month"==t?"Month":"day"==t?"Day":t,d="";this.getProperty("filterDateShow",!0)||(d+="display:none;");let g=this.getFilterId(ID_FILTER_DATE);h=this.makeFilterLabel("Select "+h+": ");let p="";p+=HU.div([ATTR_ID,this.getDomId("filterDateStepBackward"),ATTR_STYLE,HU.css(CSS_DISPLAY,DISPLAY_INLINE_BLOCK),ATTR_TITLE,"Step Back"],HU.getIconImage("fa-step-backward",[ATTR_STYLE,HU.css(CSS_CURSOR,CURSOR_POINTER)]))+SPACE1,p+=HU.div([ATTR_ID,this.getDomId("filterDatePlay"),ATTR_STYLE,HU.css(CSS_DISPLAY,DISPLAY_INLINE_BLOCK),ATTR_TITLE,"Play/Stop Animation"],HU.getIconImage(ICON_PLAY,[ATTR_STYLE,HU.css(CSS_CURSOR,CURSOR_POINTER)]))+SPACE1,p+=HU.div([ATTR_ID,this.getDomId("filterDateStepForward"),ATTR_STYLE,HU.css(CSS_DISPLAY,DISPLAY_INLINE_BLOCK),ATTR_TITLE,"Step Forward"],HU.getIconImage("fa-step-forward",[ATTR_STYLE,HU.css(CSS_CURSOR,CURSOR_POINTER)]))+SPACE1;let c=HU.span([ATTR_CLASS,i,ATTR_STYLE,d],p+HU.select("",["fieldId","filterDate",ATTR_ID,g],s,l))+SPACE;e&&(c=HU.div([ATTR_STYLE,HU.css(CSS_DISPLAY,DISPLAY_NONE)],c)),n+=c}let T=this.getProperty("filterFields","").split(",").map((e=>e.trim())),f={};if(this.filters=[],this.filterMap={},this.addFilters(this.filters),T.length>0){let s=null;for(let e=0;e<T.length;e++){if(""==T[e])continue;if(T[e].startsWith("group:")){s=T[e].substring(6),"none"==s&&(s=null);continue}let t=new RecordFilter(this,T[e]);t.group=s,this.filters.push(t),this.filterMap[t.getId()]=t}let l="",a=[""];s=null,groupHtml=null,this.filters.forEach((e=>{if(!e.isEnabled())return;let i=e.getWidget(f,a,o,t);if(t||(i=HU.span([ATTR_CLASS,HU.classes("display-filter-container","display-filter-"+e.displayType),ATTR_ID,this.domId("filtercontainer_"+e.id)],i)),null!=e.group)return e.group!=s&&null!=groupHtml&&(l+=HU.toggleBlock(s,groupHtml,!1),groupHtml=null),s=e.group,null==groupHtml&&(groupHtml=""),void(groupHtml+=i);null!=groupHtml&&(l+=HU.toggleBlock(s,groupHtml,!1),groupHtml=null),l+=i})),null!=groupHtml&&(l+=HU.toggleBlock(s,groupHtml,!1)),style=(e?"display:none;":"")+this.getProperty("filterByStyle",""),this.getProperty("showFilterTotal",!1)&&(l+=HU.span([ATTR_CLASS,"display-filter-label",ATTR_ID,this.getDomId(ID_FILTER_COUNT)],""));let r=l+a[0]+HU.div([ATTR_ID,this.domId(ID_TAGBAR)],"");n+=HU.div([ATTR_CLASS,HU.classes(CLASS_HEADER_SPAN,i),ATTR_STYLE,style,ATTR_ID,this.getDomId(ID_FILTERBAR)],r)}if(t)n=HU.div([ATTR_CLASS,"display-header-vertical"],n);else{let e=HU.css(CSS_LINE_HEIGHT,HU.px(0));this.getHeaderCenter(!0)?e+=HU.css(CSS_TEXT_ALIGN,ALIGN_CENTER):e+=HU.css(CSS_TEXT_ALIGN,ALIGN_LEFT),n=HU.div([ATTR_STYLE,e],n)}n=HU.leftRightTable(n,HU.div([ATTR_ID,this.getDomId(ID_HEADER2_SUFFIX)],""));let y=this.getDisplayHeaderSide();"left"==y?this.jq(ID_LEFT).html(n):"right"==y?this.jq(ID_RIGHT).html(n):this.jq(ID_HEADER2).html(n),this.initHeader2(),this.jq("test").button().click((()=>{this.haveCalledUpdateUI=!1,this.callUpdateUI()})),this.createRequestProperties();let m=(e,t,i)=>{let s=!1;if(this.ignoreFilterChange)return;if(e.attr("ignore"))return;let a,r,o=e.attr(ID);if(!o)return void console.log("No ID attribute for filter");this.filters.every((e=>e.widgetId!=o||(a=e,r=e.id,!1)));let n=[];if(a&&this.filters.forEach((e=>{if(e.depends==a.id){n.push(e);let t=jqid(e.widgetId);this.ignoreFilterChange=!0,e.lastValue=t.val(),t.val(FILTER_ALL),this.ignoreFilterChange=!1}})),!t)if(o.endsWith("_min"))t=jqid(o.replace(/_min$/,"_max"));else if(o.endsWith("_max")){let i=e;e=jqid(o.replace(/_max$/,"_min")),t=i}if(e.attr("isCheckbox")){let t=e.attr("onValue")||!0,s=e.attr("offValue")||!1;HU.isChecked(e)?(i=t,console.log(l.type+" cbx is checked value:"+i+" on:"+t+" off:"+s)):(i=s,console.log(l.type+" cbx is not checked value:"+i+" on:"+t+" off:"+s))}if(i||(i=e.val()),null!==i&&""!==i||(i=e.attr(ATTR_DATA_VALUE)||e.val()),null==i)return void 0;if(!Array.isArray(i)&&e.attr("isButton")){let e=[];i.split(",").forEach((t=>{e.push(t.replace(/_comma_/g,","))})),i=e}let h=e.attr("fieldId");if(l.checkFilterField(e),l.haveCalledUpdateUI=!1,l.settingFilterValue)return;l.settingFilterValue=!0,this.filteredRecords=null,l.dataFilterChanged();n.forEach((e=>{null==this.filteredRecords&&(this.filteredRecords=this.filterRecords());let t=e.getWidget({},[],this.filteredRecords);if(this.jq("filtercontainer_"+e.id).html(t),e.initWidget&&e.initWidget(m),e.widgetId){let t=jqid(e.widgetId);if(!t.length)return void console.log("Could not find dependent widget:"+e.id);if(e.lastValue){if(t[0].options){$.map(t[0].options,(e=>e.value)).includes(e.lastValue)||(e.lastValue=FILTER_ALL)}t.val(e.lastValue)}t.change((function(){m($(this))}))}return!0}));let d=h+".fv",g=i;t&&(o.endsWith("_min")?d+="min":o.endsWith("_max")&&(d+="max",g=t.val())),this.getIsMasterFilter()?this.addToDocumentUrl(d,g,!0):this.addToDocumentUrl(d,g);let p={id:o,fieldId:h,value:i};t&&(p.value2=t.val()),l.propagateEvent(DisplayEvent.filterChanged,p),l.settingFilterValue=!1};u.forEach((e=>{jqid(e).click((function(e){m($(this))}))})),this.filters.forEach((e=>{e.initWidget&&e.initWidget(m)})),this.jq(ID_FILTERBAR).find(".display-filter-items").each((function(){let e=$(this);$(this).find(".display-filter-item").click((function(t){let i=$(this).hasClass("display-filter-item-all"),s="display-filter-item-selected",a=$(this).hasClass(s),r=$(this).attr("fieldId"),o=l.getProperty(r+".filterMultiple",!1);t.metaKey&&!i&&o?e.find(".display-filter-item-all").removeClass(s):e.find(".display-filter-item").removeClass(s),a?$(this).removeClass(s):$(this).addClass(s);let n=[];e.find("."+s).each((function(){n.push($(this).attr(ATTR_DATA_VALUE).replace(/,/g,"_comma_"))})),0==n.length&&(e.find(".display-filter-item-all").addClass(s),n.push(FILTER_ALL));let h=Utils.join(n,",");e.attr(ATTR_DATA_VALUE,h),jqid(e.attr(ID)+"_label").html(n.includes(FILTER_ALL)?SPACE:h),m(e,null,n)}))})),this.jq(ID_FILTERBAR).find(HU.dotClass(CLASS_FILTER_INPUT)).keyup((function(e){if($(this).attr("istext"))return;if(13==(e.keyCode||e.which))return;HU.hidePopupObject();let t=$(this),i=$(this).val().trim();if(""==i)return;let s=$(this).attr("fieldId"),l=(f[s].field,f[s].values),a=[],r=null;try{i=i.replace(/\./g,"\\."),r=new RegExp("("+i+")","i")}catch(e){}for(let e=0;e<l.length;e++){let t=l[e].toString(),s=r?t.match(r):t.indexOf(i)>=0;if(s&&a.push([s[1],l[e]]),a.length>30)break}if(a.length>0){let e="",i=0;if(a.forEach((t=>{let s=t[0],l=(t=t[1]).replace(r,"<span style='background:"+TEXT_HIGHLIGHT_COLOR+";'>"+s+"</span>");t=t.replace(/\'/g,"'"),e+=HU.div([ATTR_TITLE,t,ATTR_CLASS,HU.classes(CLASS_HOVERABLE,CLASS_CLICKABLE,"display-filter-popup-item"),"item",t],l)+"\n",i++})),i>0){let i=HU.setPopupObject(HU.getTooltip());i.html(HU.div([ATTR_STYLE,HU.css(CSS_MARGIN,HU.px(5)),ATTR_CLASS,HU.classes(CLASS_POPUP_INNER,"ramadda-snippet-popup")],e)),i.show(),i.position({of:$(this),my:POS_LEFT_TOP,at:POS_LEFT_BOTTOM}),$(".display-filter-popup-item").click((function(){HU.hidePopupObject(),t.val($(this).attr("item")),m(t)}))}}})),this.initializeRangeSlider(this.jq(ID_FILTERBAR).find(".display-filter-range"),m,this.getProperty("filterSliderImmediate")),this.jq(ID_FILTER_HIGHLIGHT).change((function(){l.setProperty("filterHighlight","highlight"==$(this).val()),l.dfltFilterHighlight=null,l.haveCalledUpdateUI=!1,m($(this))})),jqid(this.getFilterId(ID_FILTER_DATE)).change((function(){m($(this))})),this.jq("filterDatePlay").click((function(){l.filterDatePlayingAnimation=!l.filterDatePlayingAnimation;let e=l.filterDatePlayingAnimation?ICON_STOP:ICON_PLAY;$(this).html(HU.getIconImage(e,[ATTR_STYLE,HU.css(CSS_CURSOR,CURSOR_POINTER)])),l.filterDatePlayingAnimation&&l.stepFilterDateAnimation(m,1)})),this.jq("filterDateStepBackward").click((function(){l.filterDatePlayingAnimation=!1;let e=l.filterDatePlayingAnimation?ICON_STOP:ICON_PLAY;l.jq("filterDatePlay").html(HU.getIconImage(e,[ATTR_STYLE,HU.css(CSS_CURSOR,CURSOR_POINTER)])),l.stepFilterDateAnimation(m,-1)})),this.jq("filterDateStepForward").click((function(){l.filterDatePlayingAnimation=!1;let e=l.filterDatePlayingAnimation?ICON_STOP:ICON_PLAY;l.jq("filterDatePlay").html(HU.getIconImage(e,[ATTR_STYLE,HU.css(CSS_CURSOR,CURSOR_POINTER)])),l.stepFilterDateAnimation(m,1)})),this.jq("displayfields").change((function(){let e=$(this).val();Array.isArray(e)&&(e=e.join(",")),l.displayFieldsChanged(e),l.propagateEvent(DisplayEvent.propertyChanged,{property:"displayFields",value:e})})),g.forEach((e=>{this.jq("fieldselect_"+e).change((function(){l.fieldSelectedChanged(e,$(this).val())}))})),this.jq("colorbyselect").change((function(){l.colorByFieldChanged($(this).val())})),this.jq("uniquefields").change((()=>{this.callUpdateUI()})),this.jq("sortbyselect").change((function(){let e=$(this).val();e.endsWith("_up")?(l.setProperty("sortAscending",!0),e=e.replace(/_up$/,"")):(e=e.replace(/_down$/,""),l.setProperty("sortAscending",!1)),l.sortByFieldChanged(e)})),this.jq("sortdirection").change((function(){let e=$(this).val();l.setProperty("sortAscending","up"==e),l.forceUpdateUI()})),this.jq("sizebyselect").change((function(){l.sizeByFieldChanged($(this).val())})),this.jq(ID_FILTERBAR).find("input").keyup((function(e){13==(e.keyCode||e.which)&&m($(this))})),this.jq(ID_FILTERBAR).find("input:radio,select").change((function(){m($(this))})),this.jq(ID_FILTERBAR).find("input:checkbox").change((function(){m($(this))}));s&&console.log("checkSearchBar-getting filtered data");let _=this.filterData();s&&console.log("checkSearchBar-done getting filtered data"),_&&this.initializeAnimation(_),s&&console.log("checkSearchBar-done")},initializeAnimation:function(e){let t=!1;e||(e=this.getRecords());let i=this.getDateInfo(e);if(i.dateMax){t;let s=this.getAnimation();s.getEnabled()&&(s.init(i.dateMin,i.dateMax,e),this.minDateObj||this.getProperty("animationFilter",!0)&&this.setDateRange(s.begin,s.end))}},getDateInfo:function(e){let t=null,i=null,s=[];return e.every((e=>{if(null==t)t=e.getDate(),i=e.getDate();else{let l=e.getDate();l&&(s.push(l),l.getTime()<t.getTime()&&(t=l),l.getTime()>i.getTime()&&(i=l))}return!0})),{dateMin:t,dateMax:i,dates:s}},getHighlightColor:function(){return this.getProperty("highlightColor",HIGHLIGHT_COLOR)},checkFilterField:function(e){let t=e.attr(ATTR_DATA_MIN),i=e.attr(ATTR_DATA_MIN),s=e.val();Utils.isDefined(t)?s!=t?e.css(CSS_BACKGROUND,TEXT_HIGHLIGHT_COLOR):e.css(CSS_BACKGROUND,"white"):Utils.isDefined(i)&&(s!=i?e.css(CSS_BACKGROUND,TEXT_HIGHLIGHT_COLOR):e.css(CSS_BACKGROUND,"white"))},fieldSelectedChanged:function(e,t){this.setProperty(e,t),this.haveCalledUpdateUI=!1,this.callUpdateUI()},colorByFieldChanged:function(e){this.setProperty("colorBy",e),this.callUpdateUI()},sortByFieldChanged:function(e){this.setProperty("sortFields",e),this.callUpdateUI()},sizeByFieldChanged:function(e){},someFieldChanged:function(e,t){},macroChanged:function(){this.pageSkip=0},rowStartIndex:0,dataFilterChanged:function(e){this.rowStartIndex=0,(e=e||{}).dataFilterChanged=!0,this.callUpdateUI(e)},addFieldClickHandler:function(e,t,i){let s=this;if(t){e||(e=this.jq(ID_DISPLAY_CONTENTS));let l=this.makeIdToRecords(t),a=function(){i&&($(this).parent().find(".display-row-highlight").removeClass("display-row-highlight"),$(this).addClass("display-row-highlight"));let e=t[$(this).attr(ATTR_RECORD_INDEX)];e||(e=l[$(this).attr(ATTR_RECORD_ID)]),e&&s.propagateEventRecordSelection({record:e})},r=e.find("["+ATTR_RECORD_INDEX+"]");r.length||(r=e.find("["+ATTR_RECORD_ID+"]")),r.length||(r=e),r.click(a)}if(this.getProperty("propagateValueClick",!0)){let t=this;e||(e=this.jq(ID_DISPLAY_CONTENTS)),e.find("["+ATTR_FIELD_ID+"]").click((function(){let e=$(this).attr(ATTR_FIELD_ID),i={id:e,fieldId:e,value:$(this).attr(ATTR_FIELD_VALUE)};t.propagateEvent(DisplayEvent.filterChanged,i)}))}},makeIdToRecords:function(e){let t={};return e.forEach((e=>t[e.getId()]=e)),t},makeTooltipClick:function(e,t){let i=this.getProperty("tooltipClick");if(!i)return;e.css(CSS_CURSOR,CURSOR_POINTER);let s=this.makeIdToRecords(t),l=this;e.click((function(){let e=s[$(this).attr(ATTR_RECORD_ID)];if(!e)return;l.tooltipDialog&&(l.tooltipDialog.remove(),l.tooltipDialog=null);let t=l.getRecordHtml(e,null,i);t=HU.div([ATTR_STYLE,HU.css(CSS_WIDTH,HU.px(600))],t),l.tooltipDialog=HU.makeDialog({content:t,anchor:$(this),draggable:!0,header:!0}),l.getProperty("dialogListener")&&l.getProperty("dialogListener")(this,l.tooltipDialog),l.initTemplatePopup(l.tooltipDialog)}))},initTemplatePopup:function(e){let t=this;e.find(".display-search-tag").click((function(){let e=$(this).attr(ATTR_METADATA_TYPE);if(null==e)return;let i=t.filterMap[e];if(null==i)return;let s=$(this).attr(ATTR_METADATA_VALUE);i.toggleTag(s,!0,null,!0)}))},makeTooltips:function(e,t,i,s,l){if(this.getProperty("tooltipClick")&&this.makeTooltipClick(e,t),Utils.isDefined(l)&&null!=l||(l=this.shareEvent(DisplayEvent.recordHighlight,this.getProperty("propagateEventRecordHighlight",!1))),!this.getProperty("showTooltips",!0))return;let a=s??this.getTooltip();if(null==a||"none"==a)return;let r=this,o=this.makeIdToRecords(t),n={content:function(){let e=o[$(this).attr(ATTR_RECORD_ID)];if(e||(e=t[parseFloat($(this).attr(ATTR_RECORD_INDEX))]),!e)return null;let s=!0;if(i&&!1===i(!0,e)&&(s=!1),s&&l&&r.getDisplayManager().notifyEvent(DisplayEvent.recordHighlight,r,{highlight:!0,record:e}),""==a||"none"==a)return null;let n=r.getProperty("tooltipStyle","font-size:10pt;"),h=r.getRecordHtml(e,null,a);return n&&(h=HU.div([ATTR_STYLE,n],h)),h},close:function(e,s){let a=o[$(this).attr(ATTR_RECORD_ID)];a||(a=t[parseFloat($(this).attr(ATTR_RECORD_INDEX))]);let n=!0;i&&!1===i(!1,a)&&(n=!1),n&&l&&r.getDisplayManager().notifyEvent(DisplayEvent.recordHighlight,r,{highlight:!1,record:a})},position:{my:r.getTooltipPositionMy(POS_LEFT_TOP),at:r.getTooltipPositionAt("left bottom+2"),collision:r.getTooltipCollision("flip")},classes:{"ui-tooltip":r.getProperty("tooltipClass","ramadda-shadow-box  display-tooltip display-"+this.getType()+"-tooltip")}};this.getTooltipImmediate()?$.extend(n,{show:!1,hide:!1}):$.extend(n,{show:{delay:parseFloat(r.getTooltipDelay()),effect:this.getTooltipEffect(),duration:parseFloat(r.getTooltipDuration())}}),e.length>500?(e.mouseenter((function(){$(this).tooltip(n).tooltip("open")})),e.mouseleave((function(){$(this).tooltip({}).tooltip("close")}))):e.tooltip(n)},makeRecordSelect:function(e,t,i){let s=this;e.click((function(e){let l=t[$(this).attr(ATTR_RECORD_ID)];l&&(i&&i(l),s.propagateEventRecordSelection({select:!0,record:l}))}))},makePopups:function(e,t,i,s){if(s||(s=this.getProperty("popupTemplate")),!s)return;let l=this;e.click((function(e){let a=t[parseFloat($(this).attr(ATTR_RECORD_INDEX))];a&&(i&&i(a),l.propagateEventRecordSelection({select:!0,record:a}),l.showRecordPopup($(this),a,i,s))}))},showRecordPopup:function(e,t,i){if(!t)return;if(i||(i=this.getProperty("popupTemplate")),!i)return;let s=this;HU.hidePopupObject();let l=s.getRecordHtml(t,null,i);l=HU.div([ATTR_CLASS,HU.classes("display-popup",s.getProperty("popupClass","")),ATTR_STYLE,s.getProperty("popupStyle","")],l);let a=HU.setPopupObject(HU.getTooltip());a.html(l),a.show(),a.position({of:e,my:s.getProperty("popupPositionMy",POS_LEFT_TOP),at:s.getProperty("popupPositionAt","left bottom+2"),collision:s.getProperty("popupCollision","none none")})},animationStart:function(e){},animationApply:function(e,t){this.getProperty("animationFilter",!0)&&this.setDateRange(e.begin,e.end),t||(this.haveCalledUpdateUI=!1,this.dataFilterChanged({source:"animation"})),this.propagateEvent(DisplayEvent.propertyChanged,{property:"dateRange",minDate:e.begin,maxDate:e.end})},makeDialog:function(e){if(!e){let t=[],i=[];this.getDialogContents(t,i),t.push("Edit"),i.push(this.makeToolbar({addLabel:!0}));let s=HU.open(TAG_UL),l="";for(let e=0;e<t.length;e++){let a=this.getDomId("tabs")+e;s+=HU.tag(TAG_LI,[],HU.tag(TAG_A,[ATTR_HREF,"#"+a],t[e])),s+="\n";let r=HU.div([ATTR_CLASS,"display-dialog-tab"],i[e]);l+=HU.div([ATTR_ID,a],r),l+="\n"}s+=HU.close(TAG_UL),e=HU.div([ATTR_ID,this.getDomId(ID_DIALOG_TABS)],s+l)}return e},initDialog:function(){let e=this,t=function(t){if(t&&13!=t.which&&0!=t.which)return;let i=!1;["column","row","width","height"].forEach((t=>{e[t]==e.jq(t).val()||!e[t]&&""==e.jq(t).val().trim()||(i=!0,e[t]=e.jq(t).val())})),i&&e.getLayoutManager().doLayout()};["column","row","width","height"].forEach((e=>{this.jq(e).blur(t),this.jq(e).keypress(t)})),this.jq("showtitle").change((function(){e.setShowTitle(HU.isChecked(e.jq("showtitle")))})),this.jq("showdetails").change((function(){e.setShowDetails(HU.isChecked(e.jq("showdetails")))})),this.jq(ID_DIALOG_TABS).tabs()},showDialog:function(e,t,i,s){this.dialog&&this.dialog.remove(),this.dialogElement;let l=this.makeDialog(e);this.getProperty("dialogHook")&&(l=this.getProperty("dialogHook")("contents",l));let a=POS_LEFT_BOTTOM;return!t&&this.jq(ID_MENU_BUTTON).length&&(t=this.jq(ID_MENU_BUTTON)),t||(t=this.jq(ID_DISPLAY_CONTENTS),a=POS_LEFT_TOP),this.dialog=HU.makeDialog({content:l,title:s||this.getTitle(),anchor:t,at:a,draggable:!0,header:!0}),i?i():this.initDialog(),this.getProperty("dialogHook")&&this.getProperty("dialogHook")("init",this.dialog),this.dialog},copyDisplay:function(){let e={};$.extend(!0,e,this),e.setId(e.getId()+this.getUniqueId("display")),addRamaddaDisplay(e),this.getDisplayManager().addDisplay(e)},removeDisplay:function(){this.getDisplayManager().removeDisplay(this),this.dialogElement&&this.dialogElement.remove()},doingQuickEntrySearch:!1,doQuickEntrySearch:function(e,t){if(this.doingQuickEntrySearch)return;let i=e.term;if(null==i||i.length<=1)return;this.doingQuickEntrySearch=!0;let s=new EntrySearchSettings({name:i,max:10});this.searchSettings&&s.clearAndAddType(this.searchSettings.entryType);let l=this,a=this.getRamadda().getSearchUrl(s,OUTPUT_JSON),r={entryListChanged:function(e){l.doneQuickEntrySearch(e,t)}};new EntryList(this.getRamadda(),a,r,!0)},doneQuickEntrySearch:function(e,t){let i=[],s=e.getEntries();for(let e=0;e<s.length;e++)i.push(s[e].getName());t(i),this.doingQuickEntrySearch=!1},handleWarning:function(e){window.location.hash&&"#fortest"==window.location.hash||console.warn(e)},handleLog:function(e){window.location.hash&&"#fortest"==window.location.hash||this.logMsg(e)},handleError:function(e,t){if(this.setErrorMessage(e),console.error(this.type+" "+e),t&&t.stack){let e="",i=15;t.stack.split("\n").every((t=>i--<0?(e+="...\n",!1):(e+=t+"\n",!0))),console.error(e)}},setErrorMessage:function(e){this.setContents(this.getMessage(e))},clearProgress:function(){this.jq(ID_DISPLAY_PROGRESS).html("")},startProgress:function(){this.jq(ID_DISPLAY_PROGRESS).length>0?this.jq(ID_DISPLAY_PROGRESS).html(HU.image(icon_progress)):this.useDisplayMessage()?this.setDisplayMessage(this.getLoadingMessage()):this.setContents(this.getLoadingMessage())},handleNoData:function(e,t){this.dataLoadFailed=!0;let i=displayDebug.handleNoData;this.jq(ID_PAGE_COUNT).html(""),t?(this.dataCollection||(this.dataCollection=new DataCollection),this.dataCollection.setData(e)):(i&&console.log("\tno reload"),this.addData(e),this.checkSearchBar());let s=this.getNoDataMessage();this.setNoDataMessage(s)},setNoDataMessage:function(e){Utils.stringDefined(e)?this.setContents(this.getMessage(this.getNoDataMessage())):this.setContents("")},pointDataLoadFailed:function(e){if(this.dataLoadFailed=!0,this.clearProgress(),this.inError=!0,errorMessage=this.getProperty("errorMessage",null),null!=errorMessage)return void this.setContents(errorMessage);let t="";if(e&&e.error)t=e.error,t=String(t).replace(/</g,"&lt;").replace(/>/g,"&gt;");else if(e&&e.errorcode&&"warning"==e.errorcode)t=e.error,t=String(t).replace(/</g,"&lt;").replace(/>/g,"&gt;");else{t=HU.b("An error has occurred:"),t+=" "+this.getLogLabel()+HU.br(),e||(e=this.getNoDataMessage());let i=e.error?e.error:e;i=i.replace(/<[^>]*>/g,"");let s="",l=i.split("\n"),a={};for(let e=0;e<l.length;e++){let t=l[e].trim();""!=t&&(a[t]||(a[t]=!0,s+=t+"\n"))}s=s.replace("Error:java.lang.RuntimeException:",""),s=s.replace(/\\n/g,HU.br()),i=s,i=HU.tag(TAG_PRE,[ATTR_STYLE,HU.css(CSS_WHITE_SPACE,WHITE_SPACE_NOWRAP,CSS_MAX_HEIGHT,HU.px(300),CSS_OVERFLOW_Y,OVERFLOW_AUTO,CSS_MAX_WIDTH,HU.px(600),CSS_OVERFLOW_X,OVERFLOW_AUTO)],i),t+=i}t=t.replace(/\n/g,HU.br()),this.setErrorMessage(t)},clearCache:function(){},handleEventDataSelection:function(e,t){this.getAcceptEventDataSelection()&&this.pointDataLoaded(t.data,"",!0)},getRequirement:function(){return null},updatePaginateLabel:function(e,t,i){let s=this.getFilterPaginate(),l=t;null!=e&&e>0?l=String(e+1)+"-"+(t+e):t<i&&(l="1-"+t),l=this.getProperty("pageRequestLabel","Showing: ${count}").replace("${count}",l),this.jq(ID_PAGE_LABEL).html(l);let a="";a+=null!=e&&e>0?HU.getIconImage("fa-step-backward",[ATTR_ID,this.getDomId(ID_PAGE_PREV),ATTR_CLASS,"display-page-button",ATTR_TITLE,"View previous"]):HU.getIconImage("fa-step-backward",[ATTR_CLASS,HU.classes("display-page-button","fa-disabled")]),a+=t<i?HU.getIconImage("fa-step-forward",[ATTR_ID,this.getDomId(ID_PAGE_NEXT),ATTR_CLASS,"display-page-button",ATTR_TITLE,"View next"]):HU.getIconImage("fa-step-forward",[ATTR_CLASS,HU.classes("display-page-button","fa-disabled")]),this.jq(ID_PAGE_BUTTONS).html(a);let r=this;this.jq(ID_PAGE_NEXT).click((()=>{this.pageSkip||(this.pageSkip=0),s?(this.pageSkip+=+this.getPageCount(),r.haveCalledUpdateUI=!1,r.dataFilterChanged(),r.updatePaginateLabel(this.pageSkip,t,i)):(this.pageSkip+=i,this.reloadData())})),this.jq(ID_PAGE_PREV).click((()=>{this.pageSkip||(this.pageSkip=0),s?(this.pageSkip-=+this.getPageCount(),this.pageSkip<0&&(this.pageSkip=0),r.haveCalledUpdateUI=!1,r.updatePaginateLabel(this.pageSkip,t,i),r.dataFilterChanged()):(this.pageSkip-=i,this.pageSkip<0&&(this.pageSkip=0),this.reloadData())}))},addData:async function(e,t){let i=e.getRecords();i&&i.length>0?this.hasElevation=i[0].hasElevation():this.hasElevation=!1,this.originalPointData=e,this.getApplyConvertAfter()||(e=this.convertPointData(e)),this.dataCollection.addData(e);try{t||this.updateUI()}catch(e){}let s=e.entry;null==s&&e.entryId&&await this.getRamadda().getEntry(e.entryId,(e=>{s=e})),s&&(e.entry=s,this.addEntry(s))},convertPointData:function(e){let t=e,i=this.getSegments();if(i){let s=e.getRecords(),l=[],a=[];l.push(a);let r=0;i.forEach(((e,t)=>{let o=e.name;a.push(o);let n=e.start,h=e.end,d=1;for(;r<s.length;r++){let e=s[r];if(e.getTime()<n.getTime())continue;if(e.getTime()>h.getTime())break;let a=e.getValue(1),o=null;if(d>=l.length){o=[];for(let e=0;e<i.length;e++)o.push(NaN);l.push(o)}else o=l[d];o[t]=a,d++}})),(e=convertToPointData(l)).entryId=t.entryId}try{e=(new CsvUtil).process(this,e,this.getProperty("convertData"))}catch(e){return this.handleError(""+e,e),null}return e},pointDataLoaded:function(e,t,i){!this.cacheUrl&&e.cacheUrl&&(this.cacheUrl=e.cacheUrl),this.dataLoadFailed=!1;let s=displayDebug.pointDataLoaded;this.clearProgress(),this.inError=!1,this.clearCache(),s&&this.logMsg("pointDataLoad:"+this.getId()+" "+this.type+" #records:"+e.getRecords().length),s&&console.log("\tclearing last selected fields");e.getRecords();this.lastSelectedFields=null,i?(e=this.convertPointData(e),this.dataCollection||(this.dataCollection=new DataCollection),s&&console.log("\tcalling setData"),this.dataCollection.setData(e)):(s&&console.log("\tcalling addData"),this.addData(e,!0),this.checkSearchBar());let l=this.getFilterPaginate();if(this.getProperty("pageRequest")||l){s&&console.log("\tupdating pageRequest");let i=e.getRecords().length,l=null,a=t?t.match(/skip=([0-9]+)/):null;a&&(l=+a[1]);let r=+this.getProperty("max",5e3),o=i;null!=l&&l>0?o=String(l+1)+"-"+(i+l):i==r&&(o="1-"+i);let n=this.getProperty("pageRequestLabel","Showing: ${count}").replace("${count}",o)+" ",h=!l&&i<r;null!=l&&l>0?n+=HU.getIconImage("fa-step-backward",[ATTR_ID,this.getDomId(ID_PAGE_PREV),ATTR_CLASS,"display-page-button",ATTR_TITLE,"View previous"]):h||(n+=HU.getIconImage("fa-step-backward",[ATTR_CLASS,"display-page-button fa-disabled"])),i==r?n+=HU.getIconImage("fa-step-forward",[ATTR_ID,this.getDomId(ID_PAGE_NEXT),ATTR_CLASS,"display-page-button",ATTR_TITLE,"View next"]):h||(n+=HU.getIconImage("fa-step-forward",[ATTR_CLASS,"display-page-button fa-disabled"])),this.jq(ID_PAGE_COUNT).html(n+SPACE2),this.jq(ID_PAGE_NEXT).click((()=>{this.pageSkip||(this.pageSkip=0),this.pageSkip+=r,this.reloadData()})),this.jq(ID_PAGE_PREV).click((()=>{this.pageSkip||(this.pageSkip=0),this.pageSkip-=r,this.pageSkip<0&&(this.pageSkip=0),this.reloadData()}))}if(this.jsonUrl=null!=t?t:null,this.getDisplayReady()){this.getDateProps().dateFormat||e.getRecordFields().forEach((e=>{e.isFieldDate()&&"year"==e.getId()&&this.setProperty("dateFormat","yyyy")})),this.haveCalledUpdateUI=!1,s&&console.log("\tcalling updateUI"),i&&this.getAnimation().getEnabled()&&this.initializeAnimation();try{let e=this.getRequirement();e?HU.waitForIt(e,(()=>{this.updateUI({reload:i})})):this.updateUI({reload:i})}catch(e){return void this.handleError(HU.div([],HU.boldLabel("Error creating display"))+e,e)}i&&!this.getPropagateDataReload()||(this.lastPointData=e,s&&console.log("\tcalling propagateEvent"),this.propagateEvent(DisplayEvent.pointDataLoaded,e))}else s&&console.log("pointDataLoaded: display not ready")},getHasDate:function(e){let t=null;for(this.hasDate=!1,j=0;j<e.length;j++){let i=e[j].getDate();if(null!=i){if(null!=t&&t.getTime()!=i.getTime()){this.hasDate=!0;break}t=i}}return this.hasDate},dateInRange:function(e,t,i){if(i&&this.logMsg("dateInRange: date:"+e+" minDate:"+this.minDateObj+" maxDate:"+this.maxDateObj),this.minDateObj&&this.minDateObj.isIndex&&(i&&console.dir("min",this.minDateObj.index,t),t<this.minDateObj.index))return!1;if(this.maxDateObj&&this.maxDateObj.isIndex)return i&&console.dir("max",this.maxDateObj.index,t),!(t>this.maxDateObj.index);if(null!=e){if(this.dateRangeDoDay&&this.minDateObj){if(e.getUTCFullYear()!=this.minDateObj.getUTCFullYear()||e.getUTCMonth()!=this.minDateObj.getUTCMonth()||e.getUTCDate()!=this.minDateObj.getUTCDate())return!1}else{if(null!=this.minDateObj&&e.getTime()<this.minDateObj.getTime())return i&&console.log("minDate: "+e+"   "+this.minDateObj),!1;if(null!=this.maxDateObj&&e.getTime()>this.maxDateObj.getTime()){if(i){this.maxDateObj.getTime(),e.getTime()}return!1}}if(null!=this.startDateObject&&e.getTime()<this.startDateObject.getTime())return!1;if(null!=this.endDateObject&&e.getTime()>this.endDateObject.getTime())return i&&console.log("    endDate:\n\t"+e.getTime()+"\n\t"+this.endDateObject.getTime()),!1}return i&&console.log("ok"),!0},getPointData:function(){return this.pointData?this.pointData:0==this.dataCollection.getList().length?null:this.dataCollection.getList()[0]},getRecords:function(){let e=this.getData();return null==e?null:e.getRecords()},getDataValues:function(e){return e.tuple?e.tuple:e.getData?e.getData():e},indexToRecord:{},recordToIndex:{},findMatchingDates:function(e,t,i){Utils.isDefined(i)||(i=0);let s=[],l=e.getTime();return t.forEach((e=>{let t=e.getDate();t&&Math.abs(t.getTime()-l)<=i&&s.push(e)})),s},findMatchingIndex:function(e){let t={index:-1,record:null};if(!e)return t;let i=this.getRecordSelectField();if(i){let s=this.getFieldById(null,i);if(!s)return t;let l=s.getValue(e);if(!Utils.isDefined(l))return t;if(!this.filteredRecords)return t;for(let e=0;e<this.filteredRecords.length;e++)if(l==s.getValue(this.filteredRecords[e]))return{index:e,record:this.filteredRecords[e]};return t}let s=this.recordToIndex[e.getId()];return Utils.isDefined(s)?{index:s,record:this.indexToRecord[s]}:e.hasDate()?this.findClosestDate(e.getDate()):-1},findClosestDate:function(e){let t,s=this.filteredRecords;if(!s)for(i in s=[],this.indexToRecord)s.push(this.indexToRecord[i]);let l=0;return s.forEach(((i,s)=>{if(!i.hasDate())return-1;let a=Math.abs(e.getTime()-i.getDate().getTime());t?a<l&&(l=a,t=i):(l=a,t=i)})),t?{index:this.recordToIndex[t.getId()],record:t}:{index:-1,record:null}},makeDataArray:function(e){if(!e)return null;if(0==e.length)return e;let t=[];if(e[0].getData)for(let i=0;i<e.length;i++)t.push(e[i].getData()[0]);else if(e[0].tuple)for(let i=0;i<e.length;i++)t.push(e[i].tuple);else t=e;return t},printFields:function(e,t){if(console.log(e),t)for(a in t)console.log("   "+t[a].getId());else console.log("   null fields")},makeIndexValue:function(e,t,i){return t+i},getStandardData:function(e,t){let s=this.getProperty("indexName","Index");t||(t={});let l=displayDebug.getStandardData;l&&console.log("getStandardData:"+this.type+"  fields:"+e);let a=this.getProperty("showUnit",this.getProperty("showUnitInSeries",!0));this.recordToIndex={},this.indexToRecord={};let r=this.getPointData(),o=this.getProperty(PROP_EXCLUDE_ZERO,!1),n=this.getProperty(PROP_EXCLUDE_NAN,!1);null==e&&(e=r.getRecordFields(),l&&console.log("\tgetRecordFields: "+e.length)),props={makeObject:!0,includeIndex:!0,includeIndexIfDate:!1,groupByIndex:-1,raw:!1},null!=t&&$.extend(props,t);let h=props.groupByIndex,d=[],g={},p=[],c=this.getProperty("groupByDate"),u=this.getProperty("groupByFill"),T={},f=[],y=[],m=[],_=[];if(this.getProperty("binDate")){if(l&&console.log("binning date"),"count"==this.getProperty("binType","total")){let t=[];e.forEach((e=>{t.push(new RecordField({index:0,id:e.getId(),label:this.getProperty("binDateLabel",this.getProperty("binCountLabel","Count")),type:"double",chartable:!0}))})),e=t}}let S=!1;for(e=e.filter((e=>{if(e.isFieldDate()){if(S&&e.isRecordDate())return null;S=!0}return e})),i=0;i<e.length;i++){let t=e[i];t.isFieldNumeric()&&t.isFieldDate();let s=t.getLabel(this);a&&null!=t.getUnit()&&(s+=" ("+t.getUnit()+")"),s=s.replace(/!!/g," -- "),m.push(s),_.push(t)}props.makeObject?y.push({tuple:m,fields:_,record:null}):y.push(m),d.push(""),p.push(null),this.minDateObj||(this.minDateObj=Utils.parseDate(this.minDate,!1),l&&console.log("getStandardData setting min date:"+this.minDateObj)),this.minDateObj||(this.maxDateObj=Utils.parseDate(this.maxDate,!0,this.minDateObj),l&&console.log("getStandardData setting max date:"+this.maxDateObj)),null==this.minDateObj&&null!=this.maxDateObj&&(this.minDateObj=Utils.parseDate(this.minDate,!1,this.maxDateObj));let A=0;Utils.isDefined(this.offset)&&(A=parseFloat(this.offset));let I=0,b=t.records?t.records:this.filterData();l&&console.log("getStandardData #fields:"+e.length+" #records:"+b.length);r.getRecordFields();this.hasDate=this.getHasDate(b);let R=-1,D=this.getFieldById(null,this.getProperty("indexField"));new Date;for(let t=0;t<b.length;t++){let i=b[t],l=i.getDate();if(!this.dateInRange(l,t))continue;R++,this.recordToIndex[i.getId()]=R,this.indexToRecord[R]=i;let a=[];if(props&&(props.includeIndex||props.includeIndexIfDate)){let e=null;if(D){let s=this.makeIndexValue(D,i.getValue(D.getIndex()),t);a.push(s),e=D.getLabel()}else if(this.hasDate){let t=this.getDateValue(l,null);a.push(t),e="Date"}else props.includeIndexIfDate||(a.push(t),e=s);null!=e&&0==R&&m.unshift(e)}let r=!0,u=!0,T=!1,f=!1;for(let t=0;t<e.length;t++){let s=e[t];s.isFieldNumeric()&&s.isFieldDate();let l=i.getValue(s.getIndex());0!=A&&(l+=A),null!=l&&(r=!1),"number"==typeof l&&(n&&isNaN(l)&&(f=!0),T=!0,0!=l&&(u=!1)),s.isFieldDate()&&(l=this.getDateValue(l,null)),a.push(l)}if(!f&&!(T&&u&&o)){if(h>=0){let e=i.getValue(h);g[e]||(g[e]=!0),c?d.push(i.getDate()+"-"+e):d.push(e),p.push(i)}props.makeObject?y.push({tuple:a,record:i}):y.push(a),r||I++}}new Date;if(0==I)return console.log(this.type+" no nonNull records"),[];if(h>=0){let t={},i=[],s=[],l=[],a=this.getProperty("groupByCount");if(l.push(props.groupByField.getLabel()),a)l.push(this.getProperty("groupByCountLabel","Count"));else for(let t=0;t<e.length;t++){let i=e[t];i.getIndex()!=h&&l.push(i.getLabel())}let r={};for(let l=0;l<y.length;l++){let o=this.getDataValues(y[l]);if(0==l)continue;let n=d[l],g=p[l],u=g.getValue(h),m=t[n];if(null==m){if(m=new Array,i.push(n),c){let e=T[g.getDate()];null==e&&(T[g.getDate()]=e=[],f.push(g.getDate())),e.push(m)}if(r[u]||(r[u]=[]),r[u].push(m),m.record=g,s.push(m),m.push(u),a)m.push(0);else for(let t=0;t<e.length;t++){e[t].getIndex()!=h&&m.push(0)}t[n]=m}let _=0;if(a)m[1]++;else for(let t=0;t<e.length;t++){if(e[t].getIndex()==h)continue;let i=o[t];if(_++,Utils.isNumber(i))"string"==typeof m[_]&&(m[_]=0),m[_]+=parseFloat(i);else{0==m[_]&&(m[_]="");let e=m[_];if(Utils.isDefined(e)||(e=""),e.length<150){Utils.isDefined(i)||(i="");let t=""+i;e.indexOf(t)<0&&(""!=e&&(e+=", "),e+=t,m[_]=e)}}}}if(u&&f.forEach((e=>{let t=T[e],i={};for(v in t.forEach((e=>{i[e[0]]=!0})),g)if(!i[v]){i[v]=!0;let t=[v,0];t.date=e,s.push(t)}})),this.getProperty("groupBySort")&&s.sort((function(e,t){return t[1]-e[1]})),this.getProperty("groupByMaxNumber")){let e=+this.getProperty("groupByMaxNumber");s=s.filter(((t,i)=>i<e))}let o=[];return o.push(l),s.forEach((e=>o.push(e))),o}if(this.getProperty("movingAverageSteps")){this.getProperty("movingAverageSteps");let e=[y[i]],t=y[1].tuple.map(((e,t)=>Utils.isNumber(e)));y.forEach(((i,s)=>{if(0==s)return;let l=Utils.mergeLists(i.tuple);e.push({record:i.record,tuple:l}),l[0]="x",l[1]=5,l.forEach(((e,i)=>{t[i]&&(l[i]=5)}))})),y=e}return y},isGoogleLoaded:function(){return"undefined"!=typeof google&&void 0!==google.visualization&&void 0!==google.visualization.DateFormat},initDateFormats:function(){if(!this.isGoogleLoaded())return!1;if(this.fmt_yyyy)return!0;let e=0;return this.timezone=this.getTimeZone(),Utils.isDefined(this.timezone)&&(e=parseFloat(this.timezone)),this.fmt_yyyymmddhhmm=new google.visualization.DateFormat({pattern:"yyyy-MM-dd HH:mm Z",timeZone:e}),this.fmt_yyyymmdd=new google.visualization.DateFormat({pattern:"yyyy-MM-dd",timeZone:e}),this.fmt_yyyy=new google.visualization.DateFormat({pattern:"yyyy",timeZone:e}),!0},getDateValue:function(e){if(!e)return{v:null,f:"NA"};if(!this.initDateFormats())return e;if(date="object"!=typeof e?new Date(e):e,isNaN(date.getUTCFullYear()))return{v:date,f:"NA"};if(this.getDateProps().dateFormatDaysAgo){let e=new Date,t=Math.round((e.getTime()-date.getTime())/1e3/60/60/24);return{v:date,f:t+" days ago"}}return{v:date,f:this.formatDate(date)}},applyFilters:function(e,t){return this.filters.forEach((t=>{if(!t.isRecordOk(e))return!1})),!0}});let o=this.getProperty(PROP_DISPLAY_FILTER);if(null!=o){let e=o.split(";");for(let t=0;t<e.length;t++){o=e[t];let i=o.split(":"),s=i[0];"month"==s?this.filters.push(new MonthFilter(i[1])):this.handleError("Unknown filter:"+s)}}}function DisplayGroup(e,t,i,s){const l="table",a="htable",r="tabs",o="columns",n="rows",h=new RamaddaDisplay(e,t,s||"group",i);RamaddaUtil.inherit(this,h),displayDefineMembers(this,[{label:"Group Properties"},{p:PROP_LAYOUT_TYPE,ex:Utils.join([l,a,r,o,n],",")},{p:PROP_LAYOUT_COLUMNS,d:1},{p:"targetDiv",tt:"Div id to put the displays in for this group"}],{displays:[],layout:this.getProperty(PROP_LAYOUT_TYPE,l),columns:this.getProperty(PROP_LAYOUT_COLUMNS,1),isLayoutColumns:function(){return this.layout==o},getWikiText:function(){let e=["layoutType",this.layout,"layoutColumns",this.columns,"showMenu","false","groupDiv","$entryid_maindiv"],t="";return t+=HU.div([ATTR_ID,"{{entryid}}_maindiv"]),t+="{{group "+HU.attrs(e)+"}}\n",t},walkTree:function(e,t){for(let i=0;i<this.displays.length;i++){let s=this.displays[i];null!=s.walkTree?s.walkTree(e,t):e.call(t,s)}},collectEntries:function(e){null==e&&(e=[]);for(let t=0;t<this.displays.length;t++){let i=this.displays[t];if(null!=i.collectEntries)i.collectEntries(e);else{let t=i.getEntries();null!=t&&t.length>0&&e.push({source:i,entries:t})}}return e},isLayoutRows:function(){return this.layout==n},getPosition:function(){for(let e=0;e<this.displays.length;e++){let t=this.displays[e];if(t.getPosition)return t.getPosition()}},getDisplays:function(){return this.displays},notifyEvent:function(e,t,i){this.getDisplays();let s=!1;let l=null!=t&&t.getProperty?t.getProperty(e.shareGroup):"";displayDebug.notifyEvent&&console.log("displayManager.notifyEvent:"+e);for(let a=0;a<this.displays.length;a++){let r=this.displays[a];if(r==t){s;continue}let o=null!=r&&r.getProperty?r.getProperty(e.acceptGroup):"";if(l){if(o!=l){displayDebug.notifyEvent&&console.log("\t"+r.type+" not in group:"+l);continue}}else if(o){displayDebug.notifyEvent&&console.log("\t"+r.type+" incoming not in accept group:"+o);continue}if(!r.acceptEvent(e,e.default)){displayDebug.notifyEvent&&console.log("\t"+r.type+" not accepting");continue}let n=r.getEventSource();null!=n&&n.length>0&&n!=t.getId()&&n!=t.getName()||(displayDebug.notifyEvent&&console.log("\t"+r.type+" calling notifyEvent:"+e),r.notifyEvent(e,t,i))}},getDisplaysToLayout:function(){let e=[];for(let t=0;t<this.displays.length;t++)this.displays[t].getIsLayoutFixed()||e.push(this.displays[t]);return e},pageHasLoaded:function(e){this.doLayout()},addDisplay:function(e){this.displays.push(e),e.getIsLayoutFixed()?(e.initDisplay(),e.jq&&HU.handleNewContent(e.jq(ID_DISPLAY_CONTENTS))):Utils.getPageLoaded()&&this.doLayout()},layoutChanged:function(e){this.doLayout()},removeDisplay:function(e){Utils.removeItem(this.displays,e),this.doLayout()},doLayout:function(){let e="",t=100,i=this.getDisplaysToLayout();this.displays.forEach((e=>{null!=e.prepareToLayout&&e.prepareToLayout()}));let s=0,h=null;void 0!==this.weights&&(h=this.weights.split(","));for(let e=0;e<i.length;e++){let t=HU.getUniqueId("divid_"),s=HU.div([ATTR_CLASS," display-wrapper",ATTR_ID,t],"");i[e].setProperty(PROP_DIVID,t),i[e].layoutDiv=s}let d=HU.getUniqueId("tabs_");if(this.layout==l)if(1==i.length)e+=i[0].layoutDiv;else{let l=12/this.columns,a=0,r={};for(;a<i.length;a++){let e=i[a];if(Utils.isDefined(e.column)&&Utils.isDefined(e.row)&&e.columns>=0&&e.row>=0){let t=e.column+"_"+e.row;null==r[t]&&(r[t]=[]),r[t].push(e)}}for(a=0;a<i.length;a++){t++,t>=this.columns&&(a>0&&(e+=HU.close(TAG_DIV)),e+=HU.open(TAG_DIV,[ATTR_CLASS,CLASS_ROW]),t=0);let r=l;null!=h&&(s>=h.length&&(s=0),r=h[s],s++),e+=HU.div([ATTR_CLASS,HU.classes("col-md-"+r,"display-wrapper","display-cell")],i[a].layoutDiv),e+="\n"}a>0&&(e+=HU.close(TAG_DIV))}else if(this.layout==a)if(1==i.length)e+=i[0].layoutDiv;else{let t=HU.perc(Math.round(100/this.columns)),s=0;e+=HU.open(TAG_TABLE,[ATTR_WIDTH,HU.perc(100)]);let l=100;for(let s=0;s<i.length;s++)l++,l>=this.columns&&(s>0&&(e+=HU.close(TAG_TR)),e+=HU.open(TAG_TR,[ATTR_VALIGN,POS_TOP]),e+="\n",l=0),e+=HU.td([ATTR_STYLE,HU.css(CSS_MAX_WIDTH,HU.px(300)),ATTR_WIDTH,t],i[s].layoutDiv),e+="\n";s>0&&(e+=HU.close(TAG_TR))}else if(this.layout==r){e+=HU.open(TAG_DIV,[ATTR_ID,d,ATTR_CLASS,"ui-tabs"]),e+=HU.open(TAG_UL,[]);let t="",s=0;for(let l=0;l<i.length;l++){let a=i[l],r=a.getTitle(!1);r.length>20&&(r=r.substring(0,19)+"..."),e+=HU.tag(TAG_LI,[],HU.tag(TAG_A,[ATTR_HREF,"#"+d+"-"+s],r)),t+=HU.div([ATTR_ID,d+"-"+s,ATTR_CLASS,"ui-tabs-hide"],a.layoutDiv),s++}e+=HU.close(TAG_UL),e+=t,e+=HU.close(TAG_DIV)}else if(this.layout==n){let t=[];for(let e=0;e<i.length;e++){let s=i[e],l=s.getRow();for(0==(""+l).length&&(l=0);t.length<=l;)t.push([]);t[l].push(s.layoutDiv)}for(let i=0;i<t.length;i++){let s=t[i],l=HU.perc(Math.round(100/s.length));e+=HU.open(TAG_TABLE,[ATTR_BORDER,0,ATTR_WIDTH,HU.perc(100),ATTR_CELLPADDING,0,ATTR_CELLSPACING,0]),e+=HU.open(TAG_TR,[ATTR_VALIGN,POS_TOP]);for(let t=0;t<s.length;t++){let i=s[t];i=HU.div([ATTR_CLASS,"display-cell"],i),e+=HU.tag(TAG_TD,[ATTR_WIDTH,l],i)}e+=HU.close(TAG_TR),e+=HU.close(TAG_TABLE)}}else if(this.layout==o){let t=[];for(let e=0;e<i.length;e++){let s=i[e],l=s.getColumn();for(0==(""+l).length&&(l=0);t.length<=l;)t.push([]);t[l].push(s.layoutDiv)}e+=HU.open(TAG_DIV,[ATTR_CLASS,CLASS_ROW]);HU.perc(Math.round(100/t.length));let l=12/t.length;for(let i=0;i<t.length;i++){let a=t[i],r="";for(let e=0;e<a.length;e++)r+=a[e];let o=l;null!=h&&(s>=h.length&&(s=0),o=h[s],s++),e+=HU.div([ATTR_CLASS,"col-md-"+o],r)}e+=HU.close(TAG_DIV)}else e+="Unknown layout:"+this.layout;(this.getShowMenu()||0!=i.length)&&jqid(this.getId()).show();let g=this.getGroupDiv();g.length>0?g.html(e):this.writeHtml(ID_DISPLAYS,e),this.layout==r&&jqid(d).tabs({activate:HU.tabLoaded}),this.initDisplays()},initDisplays:function(){this.getDisplaysToLayout().forEach((e=>{try{e.initDisplay()}catch(t){e.handleError(HU.div([],HU.boldLabel("Error creating display"))+t,t)}}))},displayData:function(){},setLayout:function(e,t){this.layout=e,t&&(this.columns=t),this.doLayout()},askMinZAxis:function(){let e=prompt("Minimum axis value","0");if(null!=e){e=parseFloat(e);for(let t=0;t<this.displays.length;t++){let i=this.displays[t];i.setMinZAxis&&i.setMinZAxis(e)}}},askMaxZAxis:function(){let e=prompt("Maximum axis value","0");if(null!=e){e=parseFloat(e);for(let t=0;t<this.displays.length;t++){let i=this.displays[t];i.setMaxZAxis&&i.setMaxZAxis(e)}}},askMinDate:function(){let e=this.minDate;if(e||(e="1950-0-0"),this.minDate=prompt("Minimum date",e),null!=this.minDate)for(let e=0;e<this.displays.length;e++){let t=this.displays[e];t.setMinDate&&t.setMinDate(this.minDate)}},askMaxDate:function(){let e=this.maxDate;if(e||(e="2020-0-0"),this.maxDate=prompt("Maximum date",e),null!=this.maxDate)for(let e=0;e<this.displays.length;e++){let t=this.displays[e];t.setMaxDate&&t.setMaxDate(this.maxDate)}},titlesOff:function(){for(let e=0;e<this.displays.length;e++)this.displays[e].setShowTitle(!1)},titlesOn:function(){for(let e=0;e<this.displays.length;e++)this.displays[e].setShowTitle(!0)},detailsOff:function(){for(let e=0;e<this.displays.length;e++)this.displays[e].setShowDetails(!1);this.doLayout()},detailsOn:function(){for(let e=0;e<this.displays.length;e++)this.displays[e].setShowDetails(!0);this.doLayout()},deleteAllDisplays:function(){this.displays=[],this.doLayout()},moveDisplayUp:function(e){let t=this.displays.indexOf(e);t<=0||(this.displays.splice(t,1),this.displays.splice(t-1,0,e),this.doLayout())},moveDisplayDown:function(e){let t=this.displays.indexOf(e);t>=this.displays.length||(this.displays.splice(t,1),this.displays.splice(t+1,0,e),this.doLayout())},moveDisplayTop:function(e){let t=this.displays.indexOf(e);t>=this.displays.length||(this.displays.splice(t,1),this.displays.splice(0,0,e),this.doLayout())}})}function RamaddaFieldsDisplay(e,t,i,s){const l=new RamaddaDisplay(e,t,i,s);defineDisplay(this,l,[],{needsData:function(){return!0},initDisplay:function(){l.initDisplay.call(this),this.needsData()&&(this.useDisplayMessage()?this.setDisplayMessage(this.getLoadingMessage()):this.setContents(this.getLoadingMessage())),this.callUpdateUI()},updateUI:function(e){this.addFieldsCheckboxes()},getWikiAttributes:function(e){if(l.getWikiAttributes.call(this,e),this.lastSelectedFields){e.push(PROP_FIELDS);let t="";for(let e=0;e<this.lastSelectedFields.length;e++)t+=this.lastSelectedFields[e].getId(),t+=",";e.push(t)}},initDialog:function(){l.initDialog.call(this),this.addFieldsCheckboxes()},getDialogContents:function(e,t){l.getDialogContents.call(this,e,t)},handleEventFieldsSelected:function(e,t){let i=[];t.forEach((e=>{let t=e.getId?e.getId():e;(e=this.getFieldById(null,t))&&i.push(e)})),t=i,this.overrideFields=null,this.removeProperty(PROP_FIELDS),this.setSelectedFields(t),this.fieldSelectionChanged()},getFieldsToSelect:function(e){return e.getRecordFields()},canDoMultiFields:function(){return!0}})}addGlobalDisplayType({type:"group",label:"Group",requiresData:!1,forUser:!0,category:"Basic Charts",tooltip:makeDisplayTooltip("Group",null,"This allows you to layout displays and share common attributes"),helpUrl:!0},!0);const PROP_LAYOUT_TYPE="layoutType",PROP_LAYOUT_COLUMNS="layoutColumns",PROP_SHOW_MAP="showMap",PROP_SHOW_MENU="showMenu",PROP_FROMDATE="fromDate",PROP_TODATE="toDate",DISPLAY_MULTI="multi";function addDisplayManager(e){null==window.globalDisplayManagers&&(window.globalDisplayManagers={}),window.globalDisplayManagers[e.getId()]=e,window.globalDisplayManager=e}addGlobalDisplayType({type:DISPLAY_MULTI,label:"Multi Chart",requiresData:!0,forUser:!1,category:"Misc"});var CLASS_MENU_BLOCK="ramadda-menu-block";function getOrCreateDisplayManager(e,t,i){if(!i){if(null!=(s=getDisplayManager(e)))return s;if(null!=window.globalDisplayManager)return window.globalDisplayManager}var s=new DisplayManager(e,t);return null==window.globalDisplayManager&&(window.globalDisplayManager=s),s}function getDisplayManager(e){return null==window.globalDisplayManagers?null:window.globalDisplayManagers[e]}var ID_DISPLAYS="displays";function DisplayManager(argId,argProperties){var ID_MENU_BUTTON="menu_button",ID_MENU_CONTAINER="menu_container",ID_MENU_OUTER="menu_outer",ID_MENU_INNER="menu_inner";RamaddaUtil.inherit(this,this.SUPER=new DisplayThing(argId,argProperties)),addRamaddaDisplay(this),RamaddaUtil.initMembers(this,{dataList:[],displayTypes:[],initMapBounds:null}),RamaddaUtil.defineMembers(this,{group:new DisplayGroup(this,argId,argProperties),showmap:this.getProperty(PROP_SHOW_MAP,null),setDisplayReady:function(){SUPER.setDisplayReadyCall(this),this.getLayoutManager().setDisplayReady()},getLayoutManager:function(){return this.group},collectEntries:function(){return this.getLayoutManager().collectEntries()},getData:function(){return this.dataList},handleEventFieldValueSelect:function(e,t){this.notifyEvent(DisplayEvent.fieldValueSelected,e,t)},handleEventFieldsSelected:function(e,t){this.notifyEvent(DisplayEvent.fieldsSelected,e,t)},handleEventPropertyChanged:function(e,t){this.notifyEvent(DisplayEvent.propertyChanged,e,t)},handleEventEntriesChanged:function(e,t){this.notifyEvent(DisplayEvent.entriesChanged,e,t)},handleEventMapBoundsChanged:function(e,t,i){var s={bounds:t,force:i};this.notifyEvent(DisplayEvent.mapBoundsChanged,e,s)},addMapLayer:function(e,t){this.notifyEvent("addMapLayer",e,{entry:t})},propagateEventRecordSelection:function(e,t,i){var s=i.index;null==t&&this.dataList.length>0&&(t=this.dataList[0]);var l=t.getRecordFields(),a=t.getRecords();if(null!=a)if(s<0||s>=a.length)console.log("propagateEventRecordSelection: bad index= "+s);else{var r=a[s];if(null!=r){var o=e?e.getRecordHtml(r,l):"";if(e.recordSelectionCallback){var n=e.recordSelectionCallback;"string"==typeof n&&(n=window[n]),n({display:e,pointData:t,index:s,pointRecord:r})}var h={index:s,record:r,html:o,data:t};this.notifyEvent(DisplayEvent.recordSelection,e,h);var d=e.getEntries();null!=d&&d.length>0&&this.handleEventEntrySelection(e,{entry:d[0],selected:!0})}}},handleEventEntrySelection:function(e,t){this.notifyEvent(DisplayEvent.entrySelection,e,t)},handleEventEntryMouseover:function(e,t){this.notifyEvent(DisplayEvent.entryMouseover,e,t)},handleEventEntryMouseout:function(e,t){this.notifyEvent(DisplayEvent.entryMouseout,e,t)},handleEventPointDataLoaded:function(e,t){this.notifyEvent(DisplayEvent.pointDataLoaded,e,t)},ranges:{},setRange:function(e,t){null==this.ranges[e.getId()]&&(this.ranges[e.getId()]=t)},getRange:function(e){return this.ranges[e.getId()]},makeMainMenu:function(){if(!this.getShowMenu())return"";var e="getDisplayManager('"+this.getId()+"')",t="getDisplayManager('"+this.getId()+"').getLayoutManager()",i="",s={},l=[],a=[];null!=window.globalDisplayTypes&&(a=window.globalDisplayTypes),DISPLAY_CATEGORIES.forEach((e=>{s[e]=[],l.push(e)}));for(var r=0;r<a.length;r++){var o=a[r];if(Utils.isDefined(o.forUser)&&!o.forUser)continue;var n=o.category;n||(n=CATEGORY_MISC),null==s[n]&&(s[n]=[],l.push(n));let t=[ATTR_ONCLICK,e+".userCreateDisplay('"+o.type+"');"];o.desc&&t.push(ATTR_TITLE,o.desc),s[n].push(HU.tag(TAG_LI,[],HU.tag(TAG_A,t,o.label)))}let h="";for(r=0;r<l.length;r++){var d=l[r],g=Utils.join(s[d],""),p=HU.tag(TAG_UL,[],g),c=HU.tag(TAG_A,[],d);h+=HU.tag(TAG_LI,[],c+p)}var u=HU.tag(TAG_LI,[],HU.onClick(t+".publish('media_photoalbum');","New Photo Album"))+"\n"+HU.tag(TAG_LI,[],HU.onClick(t+".publish('wikipage');","New Wiki Page"))+"\n"+HU.tag(TAG_LI,[],HU.onClick(t+".publish('blogentry');","New Blog Post"))+"\n",T=HU.tag(TAG_LI,[],"<a>Publish</a>"+HU.tag(TAG_UL,[],u))+"\n"+HU.tag(TAG_LI,[],HU.onClick(t+".showWikiText();","Show Text"))+"\n"+HU.tag(TAG_LI,[],HU.onClick(t+".copyWikiText();","Copy Text"))+"\n"+HU.tag(TAG_LI,[],HU.onClick(t+".copyDisplayedEntries();","Save entries"))+"\n",f=HU.tag(TAG_DIV,[ATTR_CLASS,CLASS_MENU_BLOCK],"Titles: "+HU.onClick(t+".titlesOn();","On")+"/"+HU.onClick(t+".titlesOff();","Off")),y=HU.tag(TAG_DIV,[ATTR_CLASS,CLASS_MENU_BLOCK],"Set date range: "+HU.onClick(t+".askMinDate();","Min")+"/"+HU.onClick(t+".askMaxDate();","Max")),m=HU.tag(TAG_LI,[],HU.tag(TAG_DIV,[ATTR_CLASS,CLASS_MENU_BLOCK],"Set axis range :"+HU.onClick(t+".askMinZAxis();","Min")+"/"+HU.onClick(t+".askMaxZAxis();","Max")))+HU.tag(TAG_LI,[],y)+HU.tag(TAG_LI,[],f)+"\n"+HU.tag(TAG_LI,[],HU.tag(TAG_DIV,[ATTR_CLASS,CLASS_MENU_BLOCK],"Details: "+HU.onClick(t+".detailsOn();","On",[])+"/"+HU.onClick(t+".detailsOff();","Off",[])))+HU.tag(TAG_LI,[],HU.onClick(t+".deleteAllDisplays();","Delete all displays"))+"\n",_=HU.tag(TAG_DIV,[ATTR_CLASS,CLASS_MENU_BLOCK],"Table: "+HU.onClick(t+".setLayout('table',1);","1 column")+" / "+HU.onClick(t+".setLayout('table',2);","2 column")+" / "+HU.onClick(t+".setLayout('table',3);","3 column")+" / "+HU.onClick(t+".setLayout('table',4);","4 column")),S=HU.tag(TAG_LI,[],_)+HU.tag(TAG_LI,[],HU.onClick(t+".setLayout('rows');","Rows"))+"\n"+HU.tag(TAG_LI,[],HU.onClick(t+".setLayout('columns');","Columns"))+"\n"+HU.tag(TAG_LI,[],HU.onClick(t+".setLayout('tabs');","Tabs")),A=HU.tag(TAG_LI,[],"<a>File</a>"+HU.tag(TAG_UL,[],T));return A+=HU.tag(TAG_LI,[],"<a>Edit</a>"+HU.tag(TAG_UL,[],m))+HU.tag(TAG_LI,[],"<a>New</a>"+HU.tag(TAG_UL,[],h))+HU.tag(TAG_LI,[],"<a>Layout</a>"+HU.tag(TAG_UL,[],S)),i+=g=HU.div([ATTR_STYLE,HU.css(CSS_BACKGROUND,COLOR_WHITE,CSS_Z_INDEX,1e3),ATTR_ID,this.getDomId(ID_MENU_OUTER)],HU.tag(TAG_UL,[ATTR_ID,this.getDomId(ID_MENU_INNER),ATTR_CLASS,"sf-menu"],A))},hasGeoMacro:function(e){return!!e&&null!=e.match(/(\${latitude})/g)},getJsonUrl:function(e,t,i){if(t.getRequestMacros().forEach((t=>{e=t.apply(e)})),t.getAnimationEnabled(),t.getProperty("dbSelect")&&(e+="&dbSelect="+t.getProperty("select")),t.getProperty("requestArgs")){let i=t.getProperty("requestArgs").split(",");for(let t=0;t<i.length;t+=2)e+="&"+i[t]+"="+i[t+1]}t.pageSkip&&(e+="&skip="+t.pageSkip);var s=t.getProperty(PROP_FROMDATE);null!=s&&(e+="&fromdate="+s);var l=t.getProperty(PROP_TODATE);null!=l&&(e+="&todate="+l);let a=new RegExp(/startdate=([^&$]+)(&|$)/);if(match=e.match(a)){match[2]}if(this.hasGeoMacro(e)){var r=i.lon,o=i.lat;if((null==r||null==o)&&null!=this.map){var n=this.getPosition();null!=n&&(o=n[0],r=n[1])}null!=r&&null!=o&&(e=(e=e.replace("${latitude}",o.toString())).replace("${longitude}",r.toString()))}return e=e.replace("${numpoints}",1e3)},getDefaultData:function(){for(var e in this.dataList){var t=this.dataList[e];if(null!=t.getRecords())return t}return this.dataList.length>0?this.dataList[0]:null},writeDisplay:function(){null==this.originalLocation&&(this.originalLocation=document.location);var e=this.originalLocation+"#";for(var t in e+="&display0=linechart",document);document.location=e},userCreateDisplay:function(e,t){if(null==t&&(t={}),t.editMode=!0,t.layoutHere=!1,e==DISPLAY_LABEL&&null==t.text){var i=prompt("Text");if(null==i)return;t.text=i}return this.createDisplay(e,t)},createDisplay:function(type,props){if(null==props&&(props={}),null!=props.data&&(props.theData=props.data,props.data=null),null!=props.theData&&!props.theData.hasData()){let e=!1;for(var i=0;i<this.dataList.length;i++){let t=this.dataList[i];if(t.equals(props.theData)){props.theData=t,e=!0;break}}e||this.dataList.push(props.theData)}if(null==type||0==type.trim().length)return null;for(var proc=type.substring(0,1).toUpperCase()+type.substring(1),classname=null,names=["Ramadda"+proc+"Display",proc+"Display","Display"+proc,proc],func=null,funcName=null,msg="",i=0;i<names.length;i++)if(msg+="trying:"+names[i]+"\n",null!=window[names[i]]){funcName=names[i],func=window[names[i]];break}if(null==func)return console.log("Error: could not find display function:"+type),void alert("Error: could not find display function:"+type+" msg: "+msg);let displayId=props.displayId;displayId||(displayId=this.getUniqueId("display")),null==props.theData&&this.dataList.length>0&&(props.theData=this.dataList[0]),props.createdInteractively=!0,props.entryId||(props.entryId=this.group.entryId);let display=eval(" new "+funcName+"(this,'"+displayId+"', props);");return null==display?(console.log("Error: could not create display using:"+funcName),void alert("Error: could not create display using:"+funcName)):(props.dummy||(this.addDisplay(display),display.doFinalInitialization()),display)},pageHasLoaded:function(e){this.getLayoutManager().pageHasLoaded()},addDisplay:function(e){e.setDisplayManager(this),this.getLayoutManager().addDisplay(e),setTimeout((()=>{e.loadInitialData()}),1)},getDisplays:function(){return this.getLayoutManager().getDisplays()},notifyEvent:function(e,t,i){this.getLayoutManager().notifyEvent(e,t,i)},removeDisplay:function(e){this.getLayoutManager().removeDisplay(e),this.notifyEvent(DisplayEvent.removeDisplay,this,e)},setEntry:function(e){this.getLayoutManager().getDisplays().forEach((t=>{t.setEntry(e)}))}}),addDisplayManager(this);let displaysHtml=HU.div([ATTR_ID,this.getDomId(ID_DISPLAYS),ATTR_CLASS,"display-container",ATTR_STYLE,HU.css(CSS_DISPLAY,DISPLAY_BLOCK)]),html=HU.openTag(TAG_DIV,[ATTR_STYLE,HU.css(CSS_POSITION,POSITION_RELATIVE)]);html+=HU.div([ATTR_ID,this.getDomId(ID_MENU_CONTAINER)]),html+=this.getEntriesMenu(argProperties),this.getShowMenu()&&(html+=HU.tag(TAG_A,[ATTR_CLASS,"display-menu-button",ATTR_ID,this.getDomId(ID_MENU_BUTTON)],SPACE));let targetDiv=this.getProperty(ATTR_TARGET,this.getProperty("targetDiv")),_this=this;null!=targetDiv&&(targetDiv=targetDiv.replace("${entryid}",this.getProperty("entryId"))),null!=targetDiv?$(document).ready((function(){0==jqid(targetDiv).length?console.log("Error: display group could not find targetDiv:"+targetDiv):(jqid(targetDiv).html(displaysHtml),_this.getLayoutManager().doLayout())})):html+=displaysHtml,html+=HU.closeTag(TAG_DIV);let divid=this.getProperty("divId",this.getId());jqid(divid).html(html),this.initializeEntriesMenu(),this.jq(ID_MENU_BUTTON).html(HU.getIconImage("fas fa-cog",[ATTR_TITLE,"Display menu"],[ATTR_STYLE,HU.css(CSS_COLOR,"#aaa")])).button({classes:{"ui-button":"display-manager-button"}}).click((function(e){this.dialog&&this.dialog.remove();let t=_this.makeMainMenu();this.dialog=HU.makeDialog({content:t,title:"Displays",my:POS_LEFT_TOP,at:POS_LEFT_BOTTOM,anchor:_this.jq(ID_MENU_BUTTON)}),_this.jq(ID_MENU_INNER).superfish({speed:"fast",delay:300})}))}function RamaddaMultiDisplay(e,t,s){this.props=s;let l=new DisplayGroup(e,t,s,DISPLAY_MULTI);RamaddaUtil.inherit(this,l),addRamaddaDisplay(this),RamaddaUtil.defineMembers(this,{inInitDisplay:!1,haveInited:!1,needsData:function(){return!0},pointDataLoaded:function(e,t,i){l.pointDataLoaded.call(this,e,t,i),this.initDisplay()},processMacros:function(e,t,s){if("string"!=typeof t)return null;var l=[];if(t.includes("${fieldLabel}"))for(i=0;i<e.length;i++){var a=t.replace("${fieldLabel}",e[i].getLabel());l.push(a)}else if(t.includes("${fieldId}"))for(i=0;i<e.length;i++){a=t.replace("${fieldId}",e[i].getId());l.push(a)}else if(t.includes("${fieldCnt}")){a=t.replace("${fieldCnt}",e.length);l.push(a)}else if(!t.includes("${"))return null;return s?l:Utils.join(l,",")},initDisplay:function(){try{this.initDisplayInner()}catch(e){this.setContents(this.getMessage("An error occurred:"+e)),console.log("An error occurred:"+e),console.log(e.stack)}},useChartableFields:function(){return!1},initDisplayInner:function(){if(l.initDisplay.call(this),!this.filterData())return this.setDisplayMessage(this.getLoadingMessage()),null;var e=this.getData().getRecordFields(),t=this.getSelectedFields(e);if(0!=t.length){if(!this.inInitDisplay&&!this.haveInited){this.haveInited=!0,this.inInitDisplay=!0;var i={},s={},r=[],o=0;for(a in this.props){if(a.startsWith("foreach_")){var n,h=this.props[a];n=(d=this.processMacros(t,h,!0))||h.split(","),a=a.substring(8),n.length>o&&(o=n.length),s[a]=n,r.push({attr:a,toks:n})}if(a.startsWith("sub_")){var d;h=this.props[a];a=a.substring(4),(d=this.processMacros(t,h,!1))&&(h=d),i[a]=h}}var g=HU.div([ATTR_ID,this.getDomId(ID_DISPLAYS),ATTR_CLASS,"display-container"]);this.setContents(g);var p={target:this.getDomId(ID_DISPLAYS)};p[PROP_LAYOUT_TYPE]="table",p[PROP_LAYOUT_COLUMNS]=this.getProperty(PROP_LAYOUT_COLUMNS,"2"),this.displayManager=new DisplayManager(this.getId()+"_manager",p),i.layoutHere=!1,this.props.data&&(i.data=this.props.data);var c=this.getProperty("subType","table");0==o&&(o=1);for(var u=0;u<o;u++){var T={};$.extend(T,i);for(var f=0;f<r.length;f++)u<r[f].toks.length&&(T[r[f].attr]=r[f].toks[u]);T.fields&&(T.fields=T.fields.split(",")),this.displayManager.createDisplay(c,T)}this.inInitDisplay=!1}}else this.setContents(this.getMessage("no fields"))}})}if(null==window.pointDataCache){window.pointDataCache={};let e=()=>{for(key in window.pointDataCache){let e=window.pointDataCache[key],t=!1;e.displays.forEach((e=>{e.isActiveDisplay&&!e.isActiveDisplay()||(t=!0)})),t||delete window.pointDataCache[key]}setTimeout(e,5e3)};setTimeout(e,3e4)}function getPointDataCache(){return window.pointDataCache}function getPointDataCacheObject(e){return getPointDataCache()[e]}function DataCollection(){RamaddaUtil.defineMembers(this,{data:[],hasData:function(){for(var e=0;e<this.data.length;e++)if(this.data[e]&&this.data[e].hasData())return!0;return!1},getList:function(){return this.data},setData:function(e){this.data=[e]},addData:function(e){this.data.push(e)},handleEventMapClick:function(e,t,i,s){let l=!1;for(let a=0;a<this.data.length;a++)this.data[a].handleEventMapClick(e,t,i,s)&&(l=!0);return l}})}function BasePointData(e,t){null==t&&(t={}),RamaddaUtil.defineMembers(this,{records:null,entryId:null,entry:null}),$.extend(this,t),RamaddaUtil.defineMembers(this,{name:e,properties:t,initWith:function(e){return this.recordFields=e.recordFields,this.records=e.records,this.setGroupField(),this},handleEventMapClick:function(e,t,i,s){return!1},hasData:function(){return null!=this.records&&this.records.length>0&&null!=this.recordFields},clear:function(){this.records=null,this.recordFields=null},getProperties:function(){return this.properties},getProperty:function(e,t){let i=this.properties[e];return null==i?t:i},getRecordFields:function(){return this.recordFields},addRecordField:function(e){this.recordFields.push(e)},getRecords:function(){return this.records},getNumericFields:function(){for(var e=this.getRecordFields(),t=[],i=0;i<e.length;i++){var s=e[i];s.isNumeric()&&t.push(s)}return t},getChartableFields:function(e){for(var t=this.getRecordFields(),i=[],s=/(xxxnoskip)/g,l=0;l<t.length;l++){var a=t[l];if(a.isNumeric()&&a.isChartable())a.getId().toUpperCase().match(s)||i.push(a)}return RecordUtil.sort(i)},getNonGeoFields:function(e){for(var t=this.getRecordFields(),i=[],s=!1,l=0;l<t.length;l++){var a=t[l];if(!a.isFieldGeo()){if(a.isFieldDate()){if(s&&"recordDate"==a.getId())continue;s=!0}i.push(a)}}return i},loadData:function(e){},getName:function(){return this.name},getTitle:function(){return null!=this.records&&this.records.length>0?this.name+" - "+this.records.length+" points":this.name}})}function convertToPointData(e){for(var t=[],i=[],s=e[0],l=e[1],a=0;a<s.length;a++){let e,i=String(s[a]),r=i.toLowerCase().replace(/[ ., ]+/g,"_"),o=l[a],n=typeof o;"string"==n?e="string":"number"==n?e="double":o.getTime?e="date":console.log("Unknown type:"+n),t.push(new RecordField({id:r,index:a,label:i,type:e,chartable:!0}))}for(a=1;a<e.length;a++)i.push(new PointRecord(t,NaN,NaN,NaN,null,e[a]));return new PointData("pointdata",t,i,null,null)}function PointData(e,t,i,s,l){RamaddaUtil.inherit(this,new BasePointData(e,l)),this.parentPointData=l?l.parent:null,RamaddaUtil.defineMembers(this,{recordFields:t,records:i,url:s,baseUrl:s,loadingCnt:0,getRootPointData:function(){return this.parentPointData?this.parentPointData.getRootPointData():this},getUrl:function(){return this.url?this.url:this.parentPointData?this.parentPointData.getUrl():null},getCacheUrl:function(){let e=displayDebug.loadPointJson;return!this.cacheUrl&&this.display&&(this.cacheUrl=this.display.cacheUrl,e&&console.log("getCacheUrl from display: "+this.display.type+" "+this.cacheUrl)),this.cacheUrl||(this.baseUrl?this.cacheUrl=this.baseUrl:this.parentPointData&&(this.cacheUrl=this.parentPointData.getCacheUrl()),this.cacheUrl&&(this.display&&this.display.displayManager,this.display&&(this.display.cacheUrl=this.cacheUrl))),this.cacheUrl},equals:function(e){return this.jsonUrl?this.jsonUrl==e.jsonUrl:this.url==e.url},getIsLoading:function(){return this.loadingCnt>0},handleEventMapClick:function(e,t,i,s){let l=this.getUrl();getPointDataCacheObject(l);return this.lon=i,this.lat=s,!!e.getDisplayManager().hasGeoMacro(l)&&(this.loadData(e,!0),!0)},startLoading:function(){this.loadingCnt++},stopLoading:function(){this.loadingCnt--},setGroupField:function(){if(this.recordFields)for(var e=0;e<this.recordFields.length;e++){var t=this.recordFields[e];if(t.isFieldGroup()){this.groupField=t;break}}},extractGroup:function(e,t){if(!this.groupField)return t;var i=this.getDataGroups(t);return 0==i.length||e||(e=i[0]),t},getDataGroups:function(e){if(!this.groupData){if(!e)return[];this.groupData=[];var t=this.getGroupField();if(!t)return this.groupData;for(var i={},s=0;s<e.length;s++){var l,a=e[s];a.tuple?l=a.tuple:a.record&&(l=a.record.getData()),console.log("data:"+l);var r=t.getValue(a);i[r]||(i[r]=!0,this.groupData.push(r))}}return console.log(this.groupData),this.groupData},getGroupField:function(){return this.groupField},isGroup:function(){return null!=this.getGroupField()},loadData:function(e,t,i){let s=this.getRootPointData();if(null!=s.url){if(jsonUrl=s.url,this.display=e,e&&e.displayManager){let t={lat:this.lat,lon:this.lon};jsonUrl=e.displayManager.getJsonUrl(s.url,e,t)}s.jsonUrl=jsonUrl,s.loadPointJson(jsonUrl,e,t,i)}else console.log("No URL")},getCacheObject:function(){let e=getPointDataCacheObject(this.getUrl());if(!e){let t=this.getCacheUrl();t&&(e=getPointDataCacheObject(t))}return e},removeFromCache:function(e){let t=this.getCacheObject();t&&t.removeDisplay(e)},propagateEventDataChanged:function(e){let t=this.getCacheObject();if(t){let i=t.displays;i&&i.forEach((t=>{t!=e&&t.pointDataLoaded(this,this.url,!0)}))}},loadPointJson:function(e,t,i,s){let l=displayDebug.loadPointJson,a=this;this.startLoading();let r=this;l&&console.log("loadPointJson: "+t.type+" "+t.getId()+" url:"+e);let o=this.getCacheUrl();t.getProperty&&!t.getProperty("pointDataCacheOK",!0)&&(o=HU.getUniqueId());let n=getPointDataCacheObject(o);if(null==n)n=new PointDataCacheObject(e),l&&console.log("\t**** created cache object: "+o),getPointDataCache()[o]=n;else{if(n.pending.indexOf(t)>=0)return void(l&&console.log("\tcache hit - display in pending list"));l&&console.log("\tcache hit - display not in pending list")}if(n.displays.indexOf(t)<0&&n.displays.push(t),i)n.pointData=null,n.pending=[],l&&console.log("\treloading adding to pending:"+n.displays),n.displays.forEach((e=>{l&&console.log("\tdisplay:"+e.type+" "+e.getId()),n.pending.push(e)}));else{if(n.displays.indexOf(t)<0&&n.displays.push(t),null!=n.pointData)return l&&console.log("\tdata was in cache:"+n.pointData.getRecords().length+" url:"+e),void(s?s(n.pointData):t.pointDataLoaded(n.pointData,e,i));if(n.pending.push(t),n.pending.length>1)return void(l&&console.log("\tWaiting on callback:"+n.pending.length+" "+e+" d:"+t))}let h=t=>{let a=n.pointData=t,r=n.pending;if(l&&console.log("\tcalling pointDataLoaded on  "+r.length+" pending displays"),n.clearPending(),s)s(a);else for(let t=0;t<r.length;t++)l&&console.log("\t\t"+r[t]+" #:"+a.getRecords().length),r[t].pointDataLoaded(a,e,i);n.pointData.records&&n.pointData.records.length&&n.setSize(n.pointData.records.length*n.pointData.records[0].getData().length);let o=0,h=0;Object.keys(getPointDataCache()).map((e=>{o+=getPointDataCache()[e].getSize(),h++})),l&&console.log("\tcache size:"+o+" #objects:"+h),o>1e6&&(l&&console.log("\tclearing cache"),Object.keys(getPointDataCache()).map((e=>{let t=getPointDataCacheObject(e);0==t.pending.length&&(l&&console.log("\tdeleting from cache:"+e),t.clearData())}))),a.stopLoading()},d=e;if(!d.startsWith("http")){d=window.location.protocol+"//"+window.location.host+d}if(!e.startsWith("/")&&!e.startsWith("http")){let t=String(window.location).replace(/\/[^\/]+$/,"");e=t+"/"+e}t.handleLog("data:"+e),$.getJSON(e,(function(i){if("string"==typeof i)try{l&&console.log("parsing point data"),i=JSON.parse(i)}catch(s){return console.log("Error:"+s),i.length>1e3&&(i=i.substring(0,999)),console.log("data:"+i),void t.displayError("Error loading data:"+s+"<br>URL:"+e)}if(l&&console.log("pointDataLoaded"),GuiUtils.isJsonError(i))return l&&console.log("\tloadPointData failed"),console.log("loadPointData failed:"+e),void t.pointDataLoadFailed(i);if("nodata"==i.errorcode||!i.fields){l&&console.log("\tno data:"+e);let t=new PointData("",[],[]),i=n.pending;return n.pending=[],void i.forEach((e=>{e.handleNoData(t)}))}let a=new Date,o=makePointData(i,r.derived,t,r.url,s),d=new Date;l&&Utils.displayTimes("makePointData #records: "+o.getRecords().length,[a,d],!0),i.properties&&t.applyRequestProperties(i.properties),h(o)})).fail((function(i,s,l){let r=s;if(r?l&&(r+=": "+l):r=l,i.responseText)try{try{let e=makeCsvData(t,i.responseText);if(e)return void h(e)}catch(r){}let e=JSON.parse(i.responseText);e.error&&(r=e.error)}catch(e){let t=i.responseText.match(/"error":"([^"]+)"/);t&&(r=t[1])}console.log("Point data load error:"+e+" "+(r||"")),n.pending.map((e=>{e.pointDataLoadFailed(r)})),n.pending=[],delete getPointDataCache()[e],a.stopLoading()}))}}),this.setGroupField()}function PointDataCacheObject(e){$.extend(this,{pointData:null,pending:[],displays:[],size:0,url:e,toString:function(){return"cache:"+(null==this.pointData?" no data ":" data:"+this.pointData.pdcnt+" "+this.pointData.getRecords().length)+" url:"+this.url}})}function DerivedPointData(e,t,i,s){RamaddaUtil.inherit(this,new BasePointData(t)),RamaddaUtil.defineMembers(this,{displayManager:e,operation:s,pointDataList:i,loadDataCalls:0,display:null,pointDataLoaded:function(e){this.loadDataCalls--,this.loadDataCalls<=0&&this.initData()},equals:function(e){if(null==e.pointDataList)return!1;if(this.pointDataList.length!=e.pointDataList.length)return!1;for(let t in this.pointDataList)if(!this.pointDataList[t].equals(e.pointDataList[t]))return!1;return!0},initData:function(){let e=this.pointDataList[0];if(1==this.pointDataList.length)this.records=e.getRecords(),this.recordFields=e.getRecordFields(),console.log("initData:"+this.recordFields.length);else if(this.pointDataList.length>1){let t=this.combineData(e,this.pointDataList[1]);this.records=t.records,this.recordFields=t.recordFields,console.log("initData 2:"+this.recordFields.length)}this.setGroupField(),this.display.pointDataLoaded(this)},combineData:function(e,t){let i,s=e.getRecords(),l=t.getRecords(),a=[];if(s.length!=l.length&&console.log("bad records:"+s.length+" "+l.length),"average"==this.operation){for(let e=0;e<s.length;e++){let t=s[e],i=l[e];if(t.getDate()!=i.getDate()){console.log("Bad record date:"+t.getDate()+" "+i.getDate());break}let r=$.extend(!0,{},t),o=r.getData(),n=i.getData();for(let e=0;e<o.length;e++)o[e]=(o[e]+n[e])/2;a.push(r)}i=e.getRecordFields()}else this.operation;return null==i&&(a=s,i=e.getRecordFields()),{records:a,recordFields:i}},loadData:function(e){this.display=e,this.loadDataCalls=0;for(let e in this.pointDataList){let t=this.pointDataList[e];t.hasData()||(this.loadDataCalls++,t.loadData(this)),0==this.loadDataCalls&&this.initData()}}})}function RecordField(e,t){$.extend(this,{isDate:"date"==e.type,isLatitude:!1,isLongitude:!1,isElevation:!1,forDisplay:!0}),e.id&&(e.id=e.id.replace(/%/g,"")),$.extend(this,e),$.extend(this,{isGroup:e.group,properties:e}),t&&t.getProperty&&["type","label","unit"].forEach((i=>{let s=t.getProperty(e.id+"."+i);s&&(this[i]=s)})),RamaddaUtil.defineMembers(this,{clone:function(){let e={};return $.extend(e,this),e},toString:function(){return this.getId()+" type:"+this.getType()+" index:"+this.index},getDescription:function(){return this.description},getForDisplay:function(){return this.forDisplay},getIndex:function(){return this.index},getValue:function(e,t){let i;return i=e.getValue?e.getValue(this.index):e[this.index],i||Utils.isDefined(i)?i:t},getGroup:function(){return this.group},getEnumeratedValues:function(e){return this.enumeratedValues},isFieldGroup:function(){return this.isGroup},isRecordDate:function(){return"recordDate"==this.getId()},isFieldGeo:function(){return this.isFieldLatitude()||this.isFieldLongitude()||this.isFieldElevation()},isFieldLatitude:function(){return this.isLatitude||this.id.toLowerCase().startsWith("latitude")},isFieldLongitude:function(){return this.isLongitude||this.id.toLowerCase().startsWith("longitude")},isFieldElevation:function(){return this.isElevation||"elevation"==this.id.toLowerCase()||"altitude"==this.id.toLowerCase()},isFieldNumeric:function(){return this.isNumeric()},isFieldString:function(){return"string"==this.type||"enumeration"==this.type||"multienumeration"==this.type},isFieldAbsoluteString:function(){return"string"==this.type},isFieldBoolean:function(){return"boolean"==this.type},isFieldEnumeration:function(){return"enumeration"==this.type||"multienumeration"==this.type},isFieldMultiEnumeration:function(){return"multienumeration"==this.type},isFieldDate:function(){return this.isDate},isChartable:function(){return this.chartable},getSortOrder:function(){return this.sortorder},getId:function(){return this.id},getTypeLabel:function(){let e="fa-font";this.isFieldGeo()?e="fa-globe":this.isFieldNumeric()?e="fa-hashtag":this.isFieldEnumeration()&&(e="fa-list");let t=this.getType();return HU.span([ATTR_TITLE,t,ATTR_CLASS,"fa "+e,ATTR_STYLE,HU.css(CSS_COLOR,"rgb(169, 169, 169)",CSS_FONT_SIZE,HU.pt(12))])},getUnitLabel:function(){return this.getLabel()+this.getUnitSuffix()},getUnitSuffix:function(e){return this.unit&&""!=this.unit?e?"["+this.unit+"]":"&nbsp;["+this.unit+"]":""},getLabel:function(e,t){let i;return e&&(i=e.getProperty(this.getId()+".label")),i||(i=this.label),i||null!=this.label&&0!=this.label.length||(i=this.id),t&&Utils.stringDefined(this.getUnit())&&(i=i+" ["+this.getUnit()+"]"),i},setLabel:function(e){this.label=e},canEdit:function(){return 1==this.canedit},isBoolean:function(){return"boolean"==this.type},isNumeric:function(){return"double"==this.type||"integer"==this.type},isString:function(){return"string"==this.type||this.isFieldEnumeration()||"url"==this.type||"image"==this.type},getType:function(){return this.type},setType:function(e){this.type=e},getMissing:function(){return this.missing},setUnit:function(e){this.unit=e},getUnit:function(){return this.unit}})}function PointRecord(e,t,i,s,l,a,r,o){this.isPointRecord=!0,$.extend(this,{rowIndex:r,fields:e,latitude:t,longitude:i,elevation:s,recordTime:l,data:a,id:HU.getUniqueId()}),l||!a||o||a.every((e=>!e||!e.getTime||(this.recordTime=e,!1)))}function makePointData(e,t,i,s,l){let a=[],r=-1,o=-1,n=-1,h=-1,d=[],g=[],p=null;for(let t=0;t<e.fields.length;t++){let s=new RecordField(e.fields[t],i);if(s.isFieldNumeric()&&i.getProperty){let e=i.getProperty(s.getId()+".offset1",i.getOffset1()),t=i.getProperty(s.getId()+".offset2",i.getOffset2()),l=i.getProperty(s.getId()+".scale",i.getScale());if(e||t||l){let a=i.getProperty(s.getId()+".unit",i.getUnit());a&&(s.unit=a);let r={offset1:0,offset2:0,scale:1};e&&(r.offset1=parseFloat(e)),t&&(r.offset2=parseFloat(t)),l&&(r.scale=parseFloat(l)),s.offset=r,g.push(s)}}p=s,a.push(s),s.isFieldLatitude()?r=s.getIndex():s.isFieldLongitude()?o=s.getIndex():s.isFieldElevation()?n=s.getIndex():s.isFieldDate()&&(-1==h&&(h=s.getIndex()),d.push(s.getIndex()))}if(t){let e=p.getIndex()+1;for(let i=0;i<t.length;i++){let s=t[i],l=s.label||s.name,r=new RecordField({type:"double",index:e+i,chartable:!0,id:s.name,label:l});r.derived=s,a.push(r)}}let c=[],u=!1,T=!1,f=!1,y=!1;if(e.data.forEach(((e,i)=>{let s;0==i&&(u=Array.isArray(e),T=!(void 0===e.date)),s=u?e:e.values;let l=null;u||!T?h>=0&&(f||(y="string"==typeof s[h],f=!0),y?l=Utils.parseDate(s[h]):(l=new Date(0),l.setUTCMilliseconds(s[h]))):null!=e.date&&0!=e.date&&(l=new Date(0),l.setUTCMilliseconds(e.date)),(u||void 0===e.latitude)&&(e.latitude=r>=0?s[r]:NaN),(u||void 0===e.longitude)&&(e.longitude=o>=0?s[o]:NaN);for(let e=0;e<d.length;e++){let t=d[e],i=s[t];s[t]=Utils.parseDate(i)}for(let e=0;e<s.length;e++)null==s[e]&&(s[e]=NaN);if(t)for(let e=0;e<t.length;e++){let i=t[e];if(!i.isRow)continue;if(!i.compiledFunction){let e=[],t=i.columns.indexOf(";")>=0?i.columns.split(";"):i.columns.split(",");i.fieldsToUse=[];for(let s=0;s<t.length;s++){let l=t[s].trim();e.push("v"+(s+1));let r=null;for(let e=0;e<a.length;e++){let t=a[e];if(t.getId()==l){r=t;break}}i.fieldsToUse.push(r)}let s="";for(let t=0;t<e.length;t++)s+="var v"+(t+1)+"=args["+t+"];\n";let l=i.function;l.indexOf("return")<0&&(l="return "+l),s+=l+"\n",i.compiledFunction=new Function("args",s)}let l=[],r=!1;for(let e=0;e<i.fieldsToUse.length;e++){let t=i.fieldsToUse[e],a=NaN;null!=t&&(a=s[t.getIndex()],null==a&&(a=NaN)),isNaN(a)||(r=!0),l.push(a)}try{let e=NaN;r&&(e=i.compiledFunction(l),i.decimals>=0&&(e=e.toFixed(i.decimals)),e=parseFloat(e)),s.push(e)}catch(e){console.log("Error evaluating function:"+i.function+"\n"+e),s.push(NaN)}}for(let e=0;e<g.length;e++){let t=g[e],i=t.offset,l=s[t.getIndex()];l=(l+i.offset1)*i.scale+i.offset2,s[t.getIndex()]=l}let n=new PointRecord(a,e.latitude,e.longitude,e.elevation,l,s,i,h>=0);c.push(n)})),null!=i)for(let e=0;e<a.length;e++){let t=a[e],s="field."+t.getId()+".";if(Utils.isDefined(i[s+"unit"])&&t.setUnit(i[s+"unit"]),Utils.isDefined(i[s+"label"])&&t.setLabel(i[s+"label"]),Utils.isDefined(i[s+"scale"])||Utils.isDefined(i[s+"offset1"])||Utils.isDefined(i[s+"offset2"])){let e=Utils.isDefined(i[s+"offset1"])?parseFloat(i[s+"offset1"]):0,l=Utils.isDefined(i[s+"offset2"])?parseFloat(i[s+"offset2"]):0,a=Utils.isDefined(i[s+"scale"])?parseFloat(i[s+"scale"]):1,r=t.getIndex();for(let t=0;t<c.length;t++){let i=c[t].getData(),s=i[r];i[r]=(s+e)*a+l}}}let m=e.name;return void 0===m&&(m="Point Data"),new PointData(m,a,c,s)}PointDataCacheObject.prototype={getSize:function(){return this.size},setSize:function(e){this.size=e},removeDisplay:function(e){Utils.removeItem(this.displays,e)},clearPending:function(){this.pending=[]},clearData:function(){this.setSize(0),this.pointData=null}},PointRecord.prototype={clone:function(){let e={};return $.extend(e,this),e.data=[],this.data.map(((t,i)=>{e.data[i]=t})),e},getRowIndex:function(){return this.rowIndex},isHighlight:function(e){return this.highlightForDisplay||(this.highlightForDisplay={}),this.highlightForDisplay[e]},getDisplayProperty:function(e,t,i){this.displayProperties||(this.displayProperties={});let s=this.displayProperties[e];return s||(s=this.displayProperties[e]={}),s[t]||i},setDisplayProperty:function(e,t,i){this.displayProperties||(this.displayProperties={});let s=this.displayProperties[e];s||(s=this.displayProperties[e]={}),s[t]=i},setHighlight:function(e,t){this.highlightForDisplay||(this.highlightForDisplay={}),t&&null!=this.highlightForDisplay[e]||(this.highlightForDisplay[e]=t)},clearHighlight:function(e){this.highlightForDisplay||(this.highlightForDisplay={}),delete this.highlightForDisplay[e]},toString:function(){return"data:"+this.data},getId:function(){return this.id},equals:function(e){return this.id==e.id},getData:function(){return this.data},setData:function(e){this.data=e},getFields:function(){return this.fields},getValueFromField:function(e){let t=null;return this.fields.every((i=>i.getId()!=e||(t=this.getValue(i.getIndex()),!1))),t},allZeros:function(){let e=this.getData(),t=0,i=0;for(let s=0;s<e.length;s++)if("number"==typeof e[s]&&(t++,!isNaN(e[s])&&0!=e[s])){i++;break}return t>0&&0==i},getValue:function(e){return this.data[e]},setValue:function(e,t){this.data[e]=t},push:function(e){this.data.push(e)},hasDate:function(){return null!=this.getDate()},hasLocation:function(){if(""==this.latitude)return!1;return null!=this.latitude&&!isNaN(+this.latitude)},hasElevation:function(){return null!=this.elevation&&!isNaN(this.elevation)},setLocation:function(e,t){this.latitude=e,this.longitude=t},getLatitude:function(){return this.latitude},getLongitude:function(){return this.longitude},getTime:function(){return this.recordTime},setTime:function(e){return this.recordTime=e},getElevation:function(){return this.elevation},getDate:function(){return this.recordTime}};var ArrayUtil={add:function(e,t){return isNaN(e)||isNaN(t)?NaN:e+t},average:function(e){var t=0;if(0==e.length)return 0;for(var i=0;i<e.length;i++)t+=e[i];return t/e.length},percentIncrease:function(e){var t,i=[];if(0==e.length)return 0;for(var s=0;s<e.length;s++){var l=e[s],a=NaN;s>0&&0!=t&&(a=(l-t)/t),t=l,i.push(100*a)}return i},movingAverage:function(e,t){if(t||(t={}),t.step||(t.step=5),0==e.length)return e;var i=[];console.log("STEP:"+t.step);let s=(e[0].tuple?e=>e.tuple:e=>e)(e[0]).map(((e,t)=>Utils.isNumber(e)));dataList.forEach(((e,t)=>{if(0==t)return;let i=Utils.mergeLists(e.tuple);tmp.push({record:e.record,tuple:i}),i[0]="x",i[1]=5,i.forEach(((e,t)=>{s[t]&&(i[t]=5)}))})),dataList=tmp;for(var l=t.step;l<e.length;l++){for(var a=0,r=0,o=l-t.step;o<l;o++)e[o]==e[o]&&(a+=e[o],r++);var n=r>0?a/r:NaN;if(0==i.length)for(var h=0;h<t.step;h++)i.push(n);i.push(n)}return console.log("MovingAverage: values:"+e.length+" new:"+i.length),i},expMovingAverage:function(e,t){t||(t={}),t.step||(t.step=5);ArrayUtil.movingAverage(e,t),t.step;var i=[];console.log("STEP:"+t.step);for(var s=t.step;s<e.length;s++){for(var l=0,a=0,r=s-t.step;r<s;r++)e[r]==e[r]&&(l+=e[r],a++);var o=a>0?l/a:NaN;if(0==i.length)for(var n=0;n<t.step;n++)i.push(o);i.push(o)}return console.log("MovingAverage: values:"+e.length+" new:"+i.length),i},max:function(e){for(var t=NaN,i=0;i<e.length;i++)(0==i||e[i]>t)&&(t=e[i]);return t},min:function(e){for(var t=NaN,i=0;i<e.length;i++)(0==i||e[i]<t)&&(t=e[i]);return t}},RecordUtil={groupBy:function(e,t,i,s){let l=displayDebug.groupBy;l&&console.log("groupBy","date bin:",i," #records:",e.length);let a={max:0,values:[],labels:[],map:{}};return e.forEach(((e,r)=>{let o,n=null,h=e.getDate();if(s)o=n="latlon"==s?e.getLatitude()+"/"+e.getLongitude():e.getValue(s.getIndex());else{if(!h)return;if(o=h,!0===i);else if("day"==i)o=new Date(n=h.getFullYear()+"-"+h.getUTCMonth()+"-"+h.getUTCDay());else if("month"==i)n=h.getFullYear()+"-"+h.getUTCMonth(),o=new Date(n+"-01");else if("year"==i)n=h.getFullYear(),o=new Date(h.getFullYear()+"-01-01");else if("decade"==i){let e=h.getFullYear();e-=e%10,n=e+"s",o=new Date(e+"-01-01")}else i&&(n=String(o))}let d=a.map[o];d||(l&&console.log("\tadding group:"+o),d=a.map[o]=[],a.values.push(o),null==n&&(n=t.formatDate(h,null,!0)),a.labels.push(n)),d.push(e),a.max=Math.max(a.max,d.length)})),a},expandBounds:function(e,t){return new RamaddaBounds(Math.min(90,e.north+(e.north-e.south)*t),Math.max(-180,e.west-(e.east-e.west)*t),Math.max(-90,e.south-(e.north-e.south)*t),Math.min(180,e.east+(e.east-e.west)*t))},convertBounds:function(e){return e?new RamaddaBounds(e):null},subset:function(e,t){t=RecordUtil.convertBounds(t);return e=e.filter(((e,i)=>{let s=e.getLatitude?e.getLatitude():e.r?e.r.getLatitude():e.y,l=e.getLongitude?e.getLongitude():e.r?e.r.getLongitude():e.x;return s<=t.north&&s>=t.south&&l>=t.west&&l<=t.east}))},getRanges:function(e,t){for(var i=[],s=[],l=0;l<e.length;l++)i.push(NaN),s.push(NaN);for(var a=0;a<t.length;a++)for(var r=0;r<e.length;r++){var o=t[a].getValue(r);isNaN(o)||(i[r]=isNaN(i[r])?o:Math.max(o,i[r]),s[r]=isNaN(s[r])?o:Math.min(o,s[r]))}var n=[];for(r=0;r<e.length;r++)n.push([s[r],i[r]]);return n},getElevationRange:function(e,t){for(var i=NaN,s=NaN,l=0;l<t.length;l++)if(t[l].hasElevation()){var a=t[l].getElevation();i=isNaN(i)?a:Math.max(a,i),s=isNaN(s)?a:Math.min(a,s)}return[s,i]},slice:function(e,t){for(var i=[],s=0;s<e.length;s++){var l=e[s];l.getValue?i.push(l.getValue(t)):i.push(l[t])}return i},sort:function(e){return(e=e.slice(0)).sort((function(e,t){return e.getSortOrder()<t.getSortOrder()})),e},getPoints:function(e,t){let i=[];return this.getBounds(e,t,i),i},getBounds:function(e,t,i){if(t=t||{},null==e)return t;var s=NaN,l=NaN,a=NaN,r=NaN;let o=!1;for(j=0;j<e.length;j++){var n=e[j];isNaN(n.getLatitude())||isNaN(n.getLongitude())||(n.getLatitude(),n.getLongitude()>-150&&n.getLongitude()<150&&(o=!0),0==j?(s=n.getLatitude(),a=n.getLatitude(),l=n.getLongitude(),r=n.getLongitude()):(s=Utils.max(s,n.getLatitude()),a=Utils.min(a,n.getLatitude()),l=Utils.min(l,n.getLongitude()),r=Utils.max(r,n.getLongitude())),n.getLongitude()<-180||n.getLatitude(),i&&i.push({x:n.getLongitude(),y:n.getLatitude()}))}t.north=s,t.west=l,t.south=a,t.east=r;let h=new RamaddaBounds(t);return!o&&l<-170&&r>170&&(t.insideDateLine=!0,h.insideDateLine=!0),h},findClosest:function(e,t,i,s){if(null==e)return null;var l=null,a=1e9,r=-1;for(j=0;j<e.length;j++){var o=e[j];if(!isNaN(o.getLatitude())){var n=Math.sqrt((t-o.getLongitude())*(t-o.getLongitude())+(i-o.getLatitude())*(i-o.getLatitude()));n<a&&(a=n,l=o,r=j)}}return null!=s&&(s.index=r),l},clonePoints:function(e){for(var t=[],i=0;i<e.length;i++){var s=e[i];t.push({x:s.x,y:s.y})}return t}};function CsvUtil(){let eg='convertData="derived(field=field_id, function=population*10);\nrotateData(includeFields=true,includeDate=true,flipColumns=true);\naddPercentIncrease(replaceValues=false);"\n';$.extend(this,{process:function(e,t,i){let s;this.display=e;try{DataUtils.parseCommands(i).map((e=>{if(s=e,this[e.command]){let i=t;(t=this[e.command](t,e.args))?t.entryId=i.entryId:t=i}else console.log("unknown command:"+e.command)}))}catch(e){console.log("Error applying derived function:"+s.command),console.log(e),console.log(e.stack)}return t},help:function(e,t){return console.log(eg),null},furlData:function(e,t){},derived:function(pointData,args){let records=pointData.getRecords(),fields=pointData.getRecordFields(),newFields=fields.slice(),newRecords=[],fieldArgs=args.field??args.fields??"field_"+fields.length,units=Utils.split(args.units??args.unit??"",",");Utils.split(fieldArgs,",",!0,!0).forEach(((e,t)=>{newFields.push(new RecordField({id:e,index:newFields.length,label:Utils.makeLabel(e),type:"double",chartable:!0,unit:units[t]}))}));let func=args.function;if(!func)return console.log("No func specified in derived"),null;func=func.replace(/_nl_/g,"\n").replace(/_semi_/g,";"),func.indexOf("return")<0&&(func="return "+func);let setVars="";fields.forEach(((e,t)=>{if(""!=e.getId()){if(func.indexOf(e.getId())<0)return;let t=e.getId().replace(/^([0-9]+)/g,"v$1");setVars+="\tvar "+t+'=displayGetFunctionValue(args.values["'+e.getId()+'"]);\n'}}));let code="function displayDerivedEval(args) {\n"+setVars+func+"\n}";eval(code);let funcState={};return records.forEach(((e,t)=>{let i=e.clone();i.data=e.data.slice(),i.fields=newFields,newRecords.push(i),funcState.values={},funcState.recordIndex=t,funcState.record=e,fields.map(((t,i)=>{""!=t.getId()&&(funcState.values[t.getId()]=e.getValue(t.getIndex()))}));try{let e=displayDerivedEval(funcState);Array.isArray(e)||(e=[e]),e.forEach((e=>{i.data.push(e)}))}catch(e){throw console.log("Error processing derived:"+e),i.data.push(NaN),e}})),new PointData("pointdata",newFields,newRecords,null,{parent:pointData})},groupTrend:function(e,t){let i=e.getRecords(),s=e.getRecordFields(),l=this.display.getFieldById(s,t.field);if(!l)throw new Error("Could not find groupTrend field:"+t.field);let a=s.slice(),r=[],o=t.newField||"field_"+s.length,n=t.type??"int";a.push(new RecordField({id:o,index:s.length,label:Utils.makeLabel(o),type:n,chartable:!0,unit:t.unit}));let h=0,d=-99999999;return i.forEach(((e,t)=>{let i=e.clone(),s=l.getValue(e);s<d&&h++,d=s,i.data=e.data.slice(),i.fields=a,r.push(i),"enumeration"==n?i.data.push(String(h)):i.data.push(h)})),new PointData("pointdata",a,r,null,{parent:e})},groupTime:function(e,t){let i=e.getRecords(),s=e.getRecordFields(),l=this.display.getFieldById(s,t.field);if(!l)throw new Error("Could not find nominal time field:"+t.field);let a,r=s.slice(),o=[],n=-99999999;return i.forEach(((e,t)=>{let i=e.clone(),s=l.getValue(e);s!=n&&(a=e.getTime(),n=s),i.setTime(a),o.push(i)})),new PointData("pointdata",r,o,null,{parent:e})},rotateData:function(e,t){let i=e.getRecords(),s=this.display.getDataValues(i[0]),l=[];for(var a=0;a<s.length;a++)l.push([]);let r="true"==t.includeFields,o=(t.includeDate,"true"==t.flipColumns),n=e.getRecordFields();!o&&r&&n.map(((e,i)=>{e.isRecordDate()||l[i].push(0==i?t.fieldName||"Field":e.getLabel())}));for(var h=0;h<i.length;h++){let e=this.display.getDataValues(i[h]);for(a=0;a<e.length;a++){if(!n[a].isRecordDate()){var d=e[a];d.f&&(d=d.f),d.getTime&&(d=this.display.formatDate(d)),r||0!=h||0!=a||(d=""),o?l[a].unshift(d):l[a].push(d)}}}return o&&r&&n.map(((e,i)=>{e.isRecordDate()||l[i].unshift(0==i?t.fieldName||"Field":e.getLabel())})),convertToPointData(l)},addPercentIncrease:function(e,t){let i=e.getRecords(),s=(this.display.getDataValues(i[0]),e.getRecordFields()),l=[],a=i[0],r="true"==t.replaceValues,o=[],n=e=>!e.isFieldGeo()&&e.isNumeric();s.forEach(((e,t)=>{let i=(e=e.clone()).clone();e.index=o.length,n(i)?(r||o.push(e),i.unit="%",i.index=o.length,i.id=i.id+"_percent",i.label=i.label+" % increase",o.push(i)):o.push(e)}));this.display.getFieldsByIds(s,(t.keyFields||"").replace(/_comma_/g,","));return i.forEach(((e,t)=>{let h=[],d=e.clone();d.data=h,d.fields=o,l.push(d),s.forEach(((s,l)=>{let o=e.data[s.getIndex()];if(!n(s))return i.length,void h.push(o);if(r||h.push(o),0==t)h.push(0);else{let e=a.data[s.getIndex()],t=0==e?0:(o-e)/e;h.push(t),i.length}}))})),new PointData("pointdata",o,l,null,{parent:e})},unique:function(e,t){let i=e.getRecords(),s=(this.display.getDataValues(i[0]),e.getRecordFields()),l=[],a=this.display.getFieldsByIds(s,(t.groupFields||"").replace(/_comma_/g,",")),r=this.display.getFieldById(s,t.valueField),o={};return i.forEach(((e,i)=>{let s="";a.forEach(((t,i)=>{s+=e.data[t.getIndex()],s+="_"}));let n=o[s];null==n&&(n=o[s]={});let h=null!=r?e.data[r.getIndex()]:"_date"==t.valueField?e.getTime().getTime():"";n[h]||(n[h]=!0,l.push(e))})),new PointData("pointdata",s,l,null,{parent:e})},roundDate:function(e,t){let i=e.getRecordFields(),s=e.getRecords(),l=(this.display.getDataValues(s[0]),[]),a=t.round??"day";return s.forEach(((e,t)=>{let i=e.clone();l.push(i);let s=new Date(i.getTime());"hour"==a?s.setMinutes(0,0,0):"day"==a?s.setHours(0,0,0,0):"week"==a?(s.setHours(0,0,0,0),s.setDate(s.getDate()-s.getDay())):"month"==a?(s.setHours(0,0,0,0),s.setDate(1)):"year"==a?(s.setHours(0,0,0,0),s.setMonth(0,1),s.setFullYear(s.getFullYear()+1)):console.log("unknown round date value:"+a),i.setTime(s)})),new PointData("pointdata",i,l,null,{parent:e})},filterDate:function(e,t){let i=Utils.isDefined(t.month),s=Utils.isDefined(t.year),l=Utils.isDefined(t.startyear),a=Utils.isDefined(t.endyear),r=e.getRecords(),o=[];return r.forEach(((e,r)=>{let n=new Date(e.getTime());i&&n.getMonth()!=t.month||s&&n.getFullYear()!=t.year||l&&n.getFullYear()<t.startyear||a&&n.getFullYear()>t.endyear||o.push(e.clone())})),new PointData("pointdata",e.getRecordFields(),o,null,{parent:e})},addFixed:function(e,t){let i=e.getRecords(),s=(this.display.getDataValues(i[0]),e.getRecordFields()),l=[],a=t.value,r=t.type||"double";"double"==r&&(a=parseFloat(a));let o=t[ATTR_ID],n=t.label||Utils.makeLabel(o),h=[];return s.forEach(((e,t)=>{h.push(e.clone())})),h.push(new RecordField({id:o,index:h.length,label:n,type:r,chartable:!0})),i.forEach(((e,t)=>{let i=e.clone();i.data=[],e.data.forEach((e=>{i.data.push(e)})),i.data.push(a),l.push(i)})),new PointData("pointdata",h,l,null,{parent:e})},addBearing:function(e,t){let i=e.getRecords(),s=e.getRecordFields(),l=[],a=[];s.forEach(((e,t)=>{e=e.clone(),a.push(e)}));new RecordField;return a.push(new RecordField({id:"bearing",index:a.length,label:"Bearing",type:"double",chartable:!0})),i.forEach(((e,t)=>{let i=e.clone();i.fields=a,l.push(i);let s=NaN;if(prevPoint){let e={lat:i.getLatitude(),lon:i.getLongitude()};s=Utils.getBearing(prevPoint,e),prevPoint=e}i.data.push(s)})),new PointData("pointdata",a,l,null,{parent:e})},cut:function(e,t){let i=t.fields?t.fields.split(","):[],s=e.getRecords(),l=(this.display.getDataValues(s[0]),e.getRecordFields()),a=[],r=[],o=[];return l.forEach(((e,t)=>{if(i.indexOf(e.getId())>=0)return;let s=(e=e.clone()).clone();o.push(s.index),s.index=a.length,a.push(s)})),s.forEach(((e,t)=>{let i=e.clone();i.fields=a;let s=i.data,l=[];o.forEach((e=>{l.push(s[e])})),i.data=l,r.push(i)})),new PointData("pointdata",a,r,null,{parent:e})},doAverage:function(e,t){let i=e.getRecords(),s=(this.display.getDataValues(i[0]),e.getRecordFields());var l=[],a=[];i[0];s.forEach((e=>{var t=e.clone();a.push(t),t.label=t.label+" (avg)"}));var r,o=[];s.forEach((e=>{o.push(0)}));for(var n=0;n<i.length;n++){var h=i[n];null==r&&(r=h.clone(),l.push(r),r.fields=a,r.parentRecords=[]),r.parentRecords.push(h),s.forEach(((e,t)=>{if(e.isNumeric()){var i=h.data[e.getIndex()];o[t]+=i}})),s.map(((e,t)=>{e.isNumeric()&&(r.data[t]=o[t]/i.length)}))}return new PointData("pointdata",a,l,null,{parent:e})},noop:function(e,t){return e},doublingRate:function(e,t){let i=e.getRecords(),s=e.getRecordFields(),l=this.display.getFieldsByIds(s,(t.fields||"").replace(/_comma_/g,",")),a=this.display.getFieldsByIds(s,(t.keyFields||"").replace(/_comma_/g,",")),r=[],o=Utils.cloneList(s);l.map((e=>{if(!e.isNumeric())return;let t=e.clone();t.id=t.id+"_doubling",t.unit="days",t.label=t.label+" doubling",t.index=o.length,o.push(t)}));let n=[];for(var h=0;h<i.length;h++){let e=i[h],t=(e.clone(),"");a.forEach((i=>{t+="_"+e.getValue(i.getIndex())})),n.push(t)}for(h=0;h<i.length;h++){let e=i[h],t=e.clone(),s=n[h];r.push(t),t.fields=o,l.map(((l,r)=>{if(!l.isNumeric())return;let o=e.getValue(l.getIndex()),d=NaN,g=null;for(let e=h-1;e>=0;e--){if(a.length>0){let t=n[e];if(s!=t)continue}let t=i[e];if(d=t.getValue(l.getIndex()),o>=2*d){g=t.getDate();break}}let p=NaN;g&&(p=(e.getDate().getTime()-g.getTime())/1e3/60/60/24),t.data.push(p)}))}return new PointData("pointdata",o,r,null,{parent:e})},scaleAndOffset:function(e,t){let i,s=e.getRecords(),l=e.getRecordFields();i=t.fields?this.display.getFieldsByIds(l,(t.fields||"").replace(/_comma_/g,",")):l;let a=t.unit,r=t.scale?parseFloat(t.scale):1,o=t.offset1?parseFloat(t.offset1):0,n=t.offset?parseFloat(t.offset):t.offset2?parseFloat(t.offset2):0,h=[],d=[],g={};i.forEach((e=>{g[e.getId()]=!0})),l.map((e=>{let t=e.clone();d.push(t),e.isNumeric()&&g[t.getId()]&&(t.unit=a)}));for(var p=0;p<s.length;p++){let e=s[p],t=e.clone();h.push(t);let l=e.getData(),a=Utils.cloneList(l);i.forEach((e=>{if(!e.isNumeric())return;let t=l[e.getIndex()];isNaN(t)||(t=(t+o)*r+n,a[e.getIndex()]=t)})),t.setData(a)}return new PointData("pointdata",d,h,null,{parent:e})},scaleAndOffset:function(e,t){let i,s=e.getRecords(),l=e.getRecordFields();i=t.fields?this.display.getFieldsByIds(l,(t.fields||"").replace(/_comma_/g,",")):l;let a=t.unit,r=t.scale?parseFloat(t.scale):1,o=t.offset1?parseFloat(t.offset1):0,n=t.offset?parseFloat(t.offset):t.offset2?parseFloat(t.offset2):0,h=[],d=[],g={};i.forEach((e=>{g[e.getId()]=!0})),l.map((e=>{let t=e.clone();d.push(t),e.isNumeric()&&g[t.getId()]&&(t.unit=a)}));for(var p=0;p<s.length;p++){let e=s[p],t=e.clone();h.push(t);let l=e.getData(),a=Utils.cloneList(l);i.forEach((e=>{if(!e.isNumeric())return;let t=l[e.getIndex()];isNaN(t)||(t=(t+o)*r+n,a[e.getIndex()]=t)})),t.setData(a)}return new PointData("pointdata",d,h,null,{parent:e})},replace:function(e,t){let i=e.getRecords(),s=e.getRecordFields(),l=(t.fields??"").replace(/_comma_/g,","),a=this.display.getFieldsByIds(s,l),r=t.pattern??"";r=r.replace(/_quote_/g,'"'),r=new RegExp(r,"g");let o=t.with??"",n=[];0==a.length&&console.log("replace: no field found:"+t.fields);for(var h=0;h<i.length;h++){let e=i[h],t=e.clone();n.push(t);let s=e.getData(),l=Utils.cloneList(s);a.forEach((e=>{let t=String(s[e.getIndex()]);t=t.replace(r,o),l[e.getIndex()]=t})),t.setData(l)}return new PointData("pointdata",s,n,null,{parent:e})},function:function(e,t){},accum:function(e,t){let i,s=e.getRecords(),l=e.getRecordFields(),a=null!=t.suffix?t.suffix:"_accum";i=t.fields?this.display.getFieldsByIds(l,(t.fields||"").replace(/_comma_/g,",")):l;let r=[],o=[],n=[];l.map((e=>{n.push(0);let t=e.clone();o.push(t),e.isNumeric()&&(t.id=t.id+a,t.label=t.label+a)}));for(var h=0;h<s.length;h++){let e=s[h],t=e.clone();r.push(t);let l=e.getData(),a=Utils.cloneList(l);i.forEach((e=>{if(!e.isNumeric())return;let t=l[e.getIndex()];if(!isNaN(t)){n[e.getIndex()]+=t,t=n[e.getIndex()]}a[e.getIndex()]=t})),t.setData(a)}return new PointData("pointdata",o,r,null,{parent:e})},aggregate:function(e,t){let i=e.getRecords(),s=e.getRecordFields(),l=this.display.getFieldById(s,t.groupBy);if(!l)throw new Error("No groupBy defined: "+t.groupBy+" args:"+JSON.stringify(t));let a,r=t.includeRows,o=null!==t.suffix?t.suffix:"_accum";o="",a=t.fields?this.display.getFieldsByIds(s,(t.fields||"").replace(/_comma_/g,",")):s;let n=[],h=[],d={},g=[],p=(e,i)=>{let s=e.getId()+"."+i;return Utils.isDefined(t[s])?t[s]:Utils.isDefined(this.display.getProperty(s))?this.display.getProperty(s):this.display.getProperty(i)};return a.forEach((e=>{let t=e.clone();if(h.push(t),t.id=t.id+"",t.label=t.label+"",t.isNumeric()){t.weightedByField=this.display.getFieldById(s,p(t,"weightedByField"));let e=p(t,"operator");e||"%"!=t.getUnit()||(e="average"),t.operator=e}})),i.forEach((e=>{let t=l.getValue(e),i=d[t];i||(i=d[t]=[],g.push(t)),i.push(e)})),g.forEach((e=>{let t=[],i=d[e];h.forEach((s=>{s.weightedByField&&(s.weight=Utils.sumList(i.map((e=>s.weightedByField.getValue(e))))),s.isFieldNumeric()?t.push(0):s.getId()==l.getId()?t.push(e):t.push("")}));i.forEach(((e,i)=>{h.forEach(((s,a)=>{let r=s.getValue(e);if(s.isFieldNumeric()){if(!isNaN(r)){if("average"==s.operator&&s.weightedByField){r*=s.weightedByField.getValue(e)/s.weight}t[a]+=r}}else 0==i&&(t[a]=r),l.getId()==s.getId()&&(t[a]=l.getValue(e))}))}));let s=i[0].clone();n.push(s),h.forEach((e=>{if(!e.isNumeric())return void(l.getId()!=e.getId()&&(t[e.getIndex()]=""));let s=t[e.getIndex()];if(!isNaN(s)){"average"==e.operator&&(e.weightedByField||(s/=i.length));let l=p(e,"numberFormatDecimals");null!==l&&(s=Utils.roundDecimals(s,l)),t[e.getIndex()]=s}})),s.setData(t),s.isAggregate=!0,s.aggregateValue=e,r&&(n=Utils.mergeLists(n,i))})),new PointData("pointdata",h,n,null,{parent:e})},mean:function(e,t){let i,s=e.getRecords(),l=e.getRecordFields();i=t.fields?this.display.getFieldsByIds(l,(t.fields||"").replace(/_comma_/g,",")):l;let a=[],r=[];l.map((e=>{r.push(e.clone())})),r.push(new RecordField({id:"mean",index:r.length,label:"Mean",type:"double",chartable:!0}));for(var o=0;o<s.length;o++){let e=s[o],t=e.clone();a.push(t);let l=e.getData(),r=Utils.cloneList(l),n=0,h=0;i.forEach((e=>{if(!e.isNumeric())return;h++;let t=l[e.getIndex()];isNaN(t)||(n+=t)})),r.push(n/h),t.setData(r)}return new PointData("pointdata",r,a,null,{parent:e})},count:function(e,t){let i=e.getRecords(),s=e.getRecordFields();if(!t.field)throw new Error("No field specified");let l=this.display.getFieldById(s,t.field),a=[],r=l.clone();r.index=0,a.push(r),a.push(new RecordField({id:"count",index:1,label:"Count",type:"integer",chartable:!0}));let o={},n=[];for(var h=0;h<i.length;h++){let e=i[h],t=l.getValue(e);Utils.isDefined(o[t])||(o[t]={count:0,records:[]},n.push(t)),o[t].count++,o[t].records.push(e)}let d=[];return t.sort&&n.sort(),n.forEach((e=>{let t=[e,o[e].count],i=new PointRecord(a,NaN,NaN,NaN,null,t);i.parentRecords=o[e].records,d.push(i)})),new PointData("pointdata",a,d,null,{parent:e})},prune:function(e,t){let i,s=e.getRecords(),l=e.getRecordFields();i=t.fields?this.display.getFieldsByIds(l,(t.fields||"").replace(/_comma_/g,",")):l;let a=[],r=[];l.map((e=>{r.push(e.clone())}));for(var o=0;o<s.length;o++){let e=s[o],t=e.getData(),l=Utils.cloneList(t),r=!1,n=0;if(i.every((e=>{if(!e.isNumeric())return!0;n++;let i=t[e.getIndex()];return!!isNaN(i)||(r=!0,!1)})),r){let t=e.clone();t.setData(l),a.push(t)}}return new PointData("pointdata",r,a,null,{parent:e})},mergeRows:function(e,t){let i=e.getRecords(),s=e.getRecordFields(),l=t.operator||"count",a={},r=this.display.getFieldsByIds(s,(t.keyFields||"").replace(/_comma_/g,",")),o=this.display.getFieldsByIds(s,(t.altFields||"").replace(/_comma_/g,",")),n=[],h={};r.forEach(((e,t)=>{h[e.getId()]=!0;let i=e.clone();i.index=n.length,n.push(i)}));let d=this.display.getFieldsByIds(s,(t.valueFields||"").replace(/_comma_/g,","));null==t.valueFields&&(d=s);let g=[];d.forEach((e=>{h[e.getId()]||(a[e.getId()]=t[e.getId()+".operator"],g.push(e))})),g.forEach(((e,i)=>{var s=e.clone();if(s.index=n.length,s.isNumeric()){let i=t[s.id+".label"];s.id=s.id+"_"+(a[e.getId()+".operator"]||l),s.label=i||Utils.makeLabel(s.id)}n.push(s)})),"count"==l&&(n.push(new RecordField({id:"count",index:n.length,label:"Count",type:"double",chartable:!0})),n.push(new RecordField({id:"percent",index:n.length,label:"Percent",type:"double",chartable:!0})));let p=[],c={};for(var u=0;u<i.length;u++){var T=i[u];let e="";r.forEach((t=>{let i=T.getValue(t.getIndex());""==i&&o.length>0&&o.forEach((e=>{i+=T.getValue(f1.getIndex())+"-"})),e+=i+"-"}));let t=c[e];t||(p.push(e),t=c[e]={count:0,sums:[],mins:[],maxs:[],records:[]},g.forEach(((e,i)=>{t.sums.push(0),t.mins.push(NaN),t.maxs.push(NaN)}))),g.forEach(((e,i)=>{let s=T.getValue(e.getIndex());e.isNumeric()&&!isNaN(s)&&(t.sums[i]+=s,t.mins[i]=isNaN(t.mins[i])?s:Math.min(t.mins[i],s),t.maxs[i]=isNaN(t.maxs[i])?s:Math.max(t.maxs[i],s))})),t.count++,t.records.push(T)}let f=[],y=0;return p.forEach(((e,t)=>{let s=c[e],a=[],o={},h=s.records[0].getDate(),d=RecordUtil.getBounds(s.records),p=d.south+(d.north-d.south)/2,u=d.west+(d.east-d.west)/2;e.indexOf("US")>=0&&(y++,1==y&&s.records.forEach((e=>{}))),r.forEach((e=>{let t=s.records[0].getValue(e.getIndex());a.push(t),o[e.getId()]=!0})),g.forEach(((e,t)=>{o[e.getId()]||(e.isNumeric()?"sum"==l?a.push(s.sums[t]):"average"==l?a.push(s.sums[t]/s.count):"min"==l?a.push(s.mins[t]):"max"==l&&a.push(s.maxs[t]):a.push(s.records[0].getValue(e.getIndex())))})),"count"==l&&(a.push(s.count),a.push(Utils.trimDecimals(100*s.count/i.length,1)));let T=new PointRecord(n,p,u,NaN,h,a);f.push(T)})),new PointData("pointdata",n,f,null,{parent:e})},maxDate:function(e,t){let i=e.getRecords(),s=e.getRecordFields(),l=this.display.getFieldsByIds(s,(t.keyFields||"").replace(/_comma_/g,",")),a=[],r={};for(var o=0;o<i.length;o++){var n=i[o];let e="";l.forEach((t=>{e+=n.getValue(t.getIndex())+"-"}));let t=r[e];t||(a.push(e),t=r[e]={records:[]}),t.records.push(n)}let h=[];return a.forEach(((e,t)=>{let i=r[e].records,s=null,l=null;i.forEach((e=>{(null==s||e.getDate().getTime()>l)&&(l=e.getDate().getTime(),s=e)})),h.push(s)})),new PointData("pointdata",s,h,null,{parent:e})},unfurl:function(e,t){let i=e.getRecords(),s=e.getRecordFields(),l=this.display.getFieldById(s,t.headerField||""),a=this.display.getFieldById(s,t.uniqueField||""),r=this.display.getFieldsByIds(s,t.valueFields||""),o=this.display.getFieldsByIds(s,t.includeFields||""),n=t.prefix||"";if(!l)throw new Error("No headerField");let h=!1;if(!a){if("date"!=t.uniqueField)throw new Error("No uniqueField");h=!0}if(0==r.length)throw new Error("No value fields");let d=[],g={},p={},c=[],u={};i.forEach((e=>{let t=e.getValue(l.getIndex()),i=h?e.getDate():e.getValue(a.getIndex());g[t]||(g[t]=!0,r.length>1?r.forEach((e=>{let i=t+" - "+e.getLabel();d.push(i)})):d.push(t));let s=p[i];null==s&&(p[i]=s=[],c.push(i)),s.push(e)})),d.sort(((e,t)=>"number"==typeof e&&"number"==typeof t?e-t:(""+e).localeCompare(""+t))),d.forEach(((e,t)=>{u[e]=t}));let T=[],f=[],y="string";return c[0]&&(c[0].getTime?y="date":"number"==typeof c[0]&&(y="double")),d=h?Utils.mergeLists(["date"],d):Utils.mergeLists([a.getId()],d),d.forEach(((e,t)=>{e=t>0?n+""+e:""+e;let i=Utils.makeLabel(e),s=Utils.makeId(e),l=0==t?y:"double";f.push(new RecordField({id:s,index:f.length,label:i,type:l,chartable:!0}))})),c.forEach((e=>{let t=[];d.forEach((e=>{t.push("")})),t[0]=e;let i=0,s=null;cnt=0,p[e].forEach((e=>{null==s&&(s=e);let i=e.getValue(l.getIndex());if(r.length>1)r.forEach((s=>{let l=i+" - "+s.getId(),a=u[l];if(null==a)return;let r=e.getValue(valueIndex);t[1+o.length+a]=r}));else{let s=u[i];if(null==s)return;let l=r[0].getIndex(),a=e.getValue(l);t[1+o.length+s]=a}cnt++})),o.forEach((e=>{t[1+i]=s.getValue(e.getIndex()),i++}));let a=new PointRecord(f,s.getLatitude(),s.getLongitude(),NaN,null,t);T.push(a),cnt++})),new PointData("pointdata",f,T,null,{parent:e})}})}var DataUtils={timeMap:{century:31536e8,centuries:31536e8,decade:31536e7,halfdecade:15768e7,year:31536e6,years:31536e6,month:26784e5,months:26784e5,week:6048e5,weeks:6048e5,day:864e5,days:864e5,hour:36e5,hours:36e5,minute:6e4,minutes:6e4,second:1e3,seconds:1e3},timeToMillis:function(e){let t=1,i="day",s=(e=(""+e).trim()).match("^([0-9]+)(.*)");s?(t=+s[1],i=s[2].trim()):(s=e.match("(^[0-9]+)$"),s?(i="minute",t=+s[1]):i=e);let l=1;return i=i.toLowerCase().trim(),this.timeMap[i]?l=this.timeMap[i]:(i.endsWith("s")&&(i=i.substring(0,i.length-1)),this.timeMap[i]?l=this.timeMap[i]:console.log("Unknown unit:"+i)),t*l},getCsv:function(e,t,i,s){Utils.isDefined(s)||(s=-1);let l="";e.forEach(((e,t)=>{t>0&&(l+=","),l+=e.getId()})),l+="\n";let a=0;return t.every((t=>!(!i||i(t))||!(s>0&&a>=s)&&(a++,e.forEach(((e,i)=>{let s=t.getValue(e.getIndex());s=s&&s.getTime?Utils.formatDateYYYYMMDDHHMM(s):String(s),i>0&&(l+=",");let a=s.indexOf("\n")>=0||s.indexOf(",")>=0;s.indexOf('"')>=0&&(a=!0,s=s.replace(/\"/g,'""')),a&&(s='"'+s+'"'),l+=s})),l+="\n",!0))),l},getJson:function(e,t,i,s,l){Utils.isDefined(l)||(l=-1);let a=[],r=0;t.every((t=>{if(s&&!s(t))return!0;if(l>0&&r>=l)return!1;r++;let i={};return a.push(i),e.forEach(((e,s)=>{let l=t.getValue(e.getIndex());l=l&&l.getTime?Utils.formatDateYYYYMMDDHHMM(l):String(l),i[e.getId()]=l})),!0})),Utils.makeDownloadFile(i,JSON.stringify(a,null,2))},parseCommands:function(e){let t=[];return e?(e.split(";").forEach((e=>{let i=(e=e.trim()).indexOf("("),s={};if(i>=0){let t=e.substring(i+1).trim();e=e.substring(0,i).trim(),t.endsWith(")")&&(t=t.substring(0,t.length-1));let l=[],a=!1,r=!1,o="";for(let e=0;e<t.length;e++){let i=t[e];if("\\"!=i)if(r)o+=i,r=!1;else if("'"!=i)if(","!=i)o+=i;else{if(a){o+=i;continue}l.push(o),o=""}else a=!a,o+=i;else r=!0}l.push(o),l.forEach((e=>{let t="",i=(e=e.trim()).match(/(.*)=(.*)/);i&&(e=i[1],t=i[2]),e=e.trim(),t=t.trim(),t=t.replace(/^'/g,"").replace(/'$/g,""),""!=e&&(s[e]=t)}))}""!=e&&t.push({command:e,args:s})})),t):t},getDataFilters:function(display,prop){let filters=[];if(!prop)return filters;let baseId=display.getId(),cnt=0;return DataUtils.parseCommands(prop).map((cmd=>{let filterId=baseId+"_"+cnt++,[type,fieldId,value,enabled,label,expr]=[cmd.command,cmd.args.field,cmd.args.value,cmd.args.enabled,cmd.args.label,cmd.args.expr];if(enabled=!Utils.isDefined(enabled)||("true"==enabled.trim()||""==enabled.trim()),label){var cbx=display.jq("datafilterenabled_"+filterId);cbx.length&&(enabled=HU.isChecked(cbx))}value="match"==type||"notmatch"==type?new RegExp(value):+value;let fields=null;cmd.args.fields&&(fields=display.getFieldsByIds(null,cmd.args.fields.replace(/:/g,",")));let allFields=display.getData().getRecordFields(),field=display.getFieldById(null,fieldId);filters.push({id:filterId,props:cmd.args,type:type.trim(),field:field,fields:fields||(field?[field]:null),allFields:allFields,value:value,label:label,enabled:enabled,expr:expr,getEnabled:function(){return this.enabled&&null!=this.field},toString:function(){return"filter:"+this.field?.getId()+" "+this.type+" "+this.value},isRecordOk:function(r){if(!this.getEnabled())return!0;let value=this.field?r.getValue(this.field.getIndex()):NaN;if("match"==this.type)return String(value).match(this.value);if("nomissing"==this.type){let e=null;e=this.fields?this.fields:this.field?[this.field]:r.fields;let t=!1;return e.some((e=>{if(field&&!field.isFieldLatitude()&&!e.isFieldLongitude()&&(e.isFieldLatitude()||e.isFieldLongitude()))return!0;if(e.isNumeric()){let i=r.getValue(e.getIndex());t=!isNaN(i)}return t})),t}if("notmatch"==this.type)return!String(value).match(this.value);if("lessthan"==this.type)return value<this.value;if("greaterthan"==this.type)return value>this.value;if("equals"==this.type)return value==this.value;if("notequals"==this.type)return value!=this.value;if("bounds"==this.type){let e=r.getLatitude(),t=r.getLongitude();return!(this.props.north&&e>+this.props.north)&&(!(this.props.south&&e<+this.props.south)&&(!(this.props.west&&t<+this.props.west)&&!(this.props.east&&t>+this.props.east)))}if("eval"==this.type){let code="function dataFilterCall(){\n";this.allFields.every((e=>{let t=r.getValue(e.getIndex());return("string"==typeof t||"number"!=typeof t)&&(t="'"+t+"'"),code+=e.getId()+"="+t+";\n",!0}));let expr=this.expr;if(null==expr)throw"No expr given in data filter";return expr.indexOf("return")<0&&(expr=" return "+expr),code+=expr+"\n}\n",code+="var dataFilterValue = dataFilterCall();\n",eval(code),dataFilterValue}return console.log("Unknown filter:"+this.type),!0}})})),filters}};function RequestMacro(e,t){this.display=e;let i=null,s=this.getProperty("request."+t+".values");if(s){i=[];let e=!1;this.getProperty("request."+t+".includeAll",this.getProperty("request.includeAll",!1))&&(i.push(["","All"]),e=!0),this.getProperty("request."+t+".includeNone",this.getProperty("request.includeNone",!0))&&i.push([VALUE_NONE,"None"]),this.getProperty("request."+t+".includeDefault",this.getProperty("request.includeDefault",!0))&&i.push([VALUE_NONE,"Default"]),Utils.split(s,",").forEach((t=>{let s=t.split(":"),l=s[0],a=Utils.join(s," ",1);(e||"_all_"!=l)&&i.push([l,a||l])}))}let l=this.getProperty("request."+t+".type",null!=i?"enumeration":"bounds"==t?"bounds":"string"),a=this.getProperty("request."+t+".default",null);null==a&&(a=i&&i.length>0&&"enumeration"==l?i[0][0]:"",a=""),a&&"enumeration"==l&&a.split&&(a=a.split(","));let r=this.getProperty("requestPrefix","");$.extend(this,{name:t,values:i,urlarg:this.getProperty("request."+t+".urlarg",r+t),type:l,triggerReload:this.getProperty("request."+t+".triggerReload",!0),dflt:a,dflt_from:this.getProperty("request."+t+"_from.default",""),dflt_to:this.getProperty("request."+t+"_to.default",""),dflt_min:this.getProperty("request."+t+"_min.default",""),dflt_max:this.getProperty("request."+t+"_max.default",""),label:this.getProperty("request."+t+".label",Utils.makeLabel(t)),multiple:this.getProperty("request."+t+".multiple",!1),template:this.getProperty("request."+t+".template"),multitemplate:this.getProperty("request."+t+".multitemplate"),nonetemplate:this.getProperty("request."+t+".nonetemplate"),delimiter:this.getProperty("request."+t+".delimiter"),rows:this.getProperty("request."+t+".rows",3)})}function makeInlineData(e,t){let i=jqid(t);if(0==i.length)throw new Error("No inline data available:"+t);let s=i.html();if(!Utils.stringDefined(s))throw new Error("No inline data available:"+t);return makeCsvData(e,s.trim(),t)}function makeCsvData(e,t,i){i=i??HU.getUniqueId("data");let s=t.split("\n"),l=[],a=s[1]?s[1].split(","):[],r=null,o=null;s[0].split(",").forEach(((t,i)=>{let s,n,h;if((h=(t=t.trim()).indexOf("["))>=0){let e=t.substring(h+1);t=t.substring(0,h),e=e.replace("]","");let i=Utils.parseAttributes(e);n=i.type,s=i.label}s||(s=Utils.makeLabel(t));let d=Utils.makeId(t),g=a[i]??"";e.getProperty(d+".label")&&(s=e.getProperty(d+".label")),e.getProperty(d+".type")?(n=e.getProperty(d+".type"),"enum"==n&&(n="enumeration")):n||("date"==d?n="date":isNaN(parseFloat(g))||(n="double")),n||(n="string");let p=new RecordField({id:d,index:i,label:s,type:n,chartable:!0});l.push(p),p.isFieldLatitude()?r=p:p.isFieldLongitude()&&(o=p)}));let n=[];if(s.forEach(((e,t)=>{if(0==t)return;if(0==(e=e.trim()).length)return;let i=[],s=NaN,a=NaN,h=null;e.split(",").forEach(((e,t)=>{e=e.replace(/_nl_/g,"\n").replace(/_qt_/g,'"').replace(/_comma_/g,",");let n=l[t];r&&r.getIndex()==t?s=e=parseFloat(e):o&&o.getIndex()==t?a=e=parseFloat(e):n.isFieldNumeric()&&(e=parseFloat(e)),i.push(e)})),n.push(new PointRecord(l,s,a,NaN,h,i))})),0==n.length)throw new Error("No data is available");return new PointData(i,l,n,"#"+i)}RequestMacro.prototype={getProperty:function(e,t){return this.display.getProperty(e,t)},isVisible:function(){return this.getProperty("request."+this.name+".visible",this.getProperty("macros.visible",!0))},deltaSkip:function(e,t){if(!this.limitMacro)return;let i=parseInt(this.limitMacro.getValue()),s=parseInt(this.getValue());e?s+=i:s-=i,s<0&&(s=0),jqid(this.display.getDomId(this.getId())).val(s),this.showSkipLabel(),t(this,s,"",!0,!0)},showSkipLabel:function(){if(this.limitMacro){let e,t=this.limitMacro.getValue(),i=parseInt(this.getValue())+1,s=i+(parseFloat(t)-1);e=this.display.getProperty("lastRecords")?"last "+i+" - "+s:i+" - "+s,jqid(this.display.getDomId(this.getId()+"_label")).html(e)}},isSkip:function(){return"skip"==this.type||"skip"==this.name},initWidget:function(e){if(this.selectMenuId&&this.values&&this.values.length>5){let e=this.display.getDomId(this.getId());HU.makeSelectTagPopup(jqid(e),{icon:!0,makeButton:!1,after:!0})}this.isSkip()&&(this.showSkipLabel(),jqid(this.display.getDomId(this.getId()+"_next")).button().click((()=>{this.deltaSkip(!0,e)})),jqid(this.display.getDomId(this.getId()+"_prev")).button().click((()=>{this.deltaSkip(!1,e)})))},initMacros:function(e){this.isSkip()&&e.every((e=>"limit"!=e.name||(this.limitMacro=e,e.addChangeListener(this),!1)))},macroChanged:function(e){this.isSkip()&&this.showSkipLabel()},notifyChange:function(){this.changeListeners&&this.changeListeners.forEach((e=>{e.macroChanged(this)}))},addChangeListener:function(e){this.changeListeners||(this.changeListeners=[]),this.changeListeners.push(e)},getWidget:function(e){let t,i=this.isVisible(),s=i?"":"display:none;",l=this.label,a=this.getProperty("request."+this.name+".title",null);if("bounds"==this.type)t=HU.checkbox(this.display.getDomId(this.getId()),[ATTR_TITLE,a??"Reload with current bounds",ATTR_ID,this.display.getDomId(this.getId())],!1,"In bounds"),l=null;else if(this.isSkip()){t="";let e=HU.css(CSS_PADDING,HU.px(4),CSS_PADDING_TOP,HU.px(2),CSS_PADDING_BOTTOM,HU.px(2),CSS_MARGIN_RIGHT,HU.px(4)),i=HU.span([ATTR_TITLE,"Show previous",ATTR_STYLE,e,ATTR_CLASS,CLASS_CLICKABLE,ATTR_ID,this.display.getDomId(this.getId()+"_prev")],HU.getIconImage("fas fa-angle-left"))+HU.span([ATTR_TITLE,"Show next",ATTR_STYLE,e,ATTR_CLASS,CLASS_CLICKABLE,ATTR_ID,this.display.getDomId(this.getId()+"_next")],HU.getIconImage("fas fa-angle-right"));t+=HU.span([ATTR_STYLE,HU.css(CSS_PADDING_RIGHT,HU.px(8))],i),t+=HU.span([ATTR_ID,this.display.getDomId(this.getId()+"_label")],""),t+=HU.input("",this.dflt,[ATTR_STYLE,HU.css(CSS_DISPLAY,"none"),ATTR_ID,this.display.getDomId(this.getId())]),l=""}else if("enumeration"==this.type){if(this.values&&this.values.length>0){let e=this.display.getDomId(this.getId()),i=[ATTR_TITLE,a??"",ATTR_STYLE,s,ATTR_ID,e,ATTR_CLASS,"display-filter-input"],l=this.values;if(this.dflt){let e=[],t=[];l.forEach((i=>{this.dflt.indexOf(i[0])>=0?e.push(i):t.push(i)})),l=Utils.mergeLists(e,t)}this.multiple&&(i.push(ATTR_MULTIPLE,null),i.push(ATTR_SIZE,Math.min(this.rows,l.length)));let r=this.dflt;Utils.stringDefined(r)||(r=VALUE_NONE),this.selectMenuId=e,t=HU.select("",i,l,r,30)}}else if("numeric"==this.type||"number"==this.type){let e=this.display.getDomId(this.getId()+"_min"),i=this.display.getDomId(this.getId()+"_max");t=HU.input("","",[ATTR_TITLE,a??"",ATTR_DATA_MIN,this.dflt_min,ATTR_STYLE,s,ATTR_ID,e,ATTR_SIZE,4,ATTR_CLASS,"display-filter-input display-filter-range"],this.dflt_min)+" - "+HU.input("","",[ATTR_TITLE,a??"",ATTR_DATA_MAX,this.dflt_max,ATTR_STYLE,s,ATTR_ID,i,ATTR_SIZE,4,ATTR_CLASS,"display-filter-input display-filter-range"],this.dflt_max),l+=" range"}else if("daterange"==this.type){let i=this.display.getDomId(this.getId()+"_from"),r=this.display.getDomId(this.getId()+"_to");e.push(i),e.push(r),t=HU.datePicker("",this.dflt_from,[ATTR_TITLE,a??"",ATTR_CLASS,"display-filter-input",ATTR_STYLE,s,ATTR_NAME,"",ATTR_ID,i])+" - "+HU.datePicker("",this.dflt_to,[ATTR_TITLE,a??"",ATTR_CLASS,"display-filter-input",ATTR_STYLE,s,ATTR_NAME,"",ATTR_ID,r]),l+=" range"}else if("date"==this.type){let i=this.display.getDomId(this.getId()+"_from");e.push(i),t=HU.datePicker("",this.dflt_from,[ATTR_TITLE,a??"",ATTR_CLASS,"display-filter-input",ATTR_STYLE,s,ATTR_NAME,"",ATTR_ID,i])}else{let e="10";"number"==this.type&&(e="4"),e=this.getProperty("request."+this.name+".size",e),t=HU.input("",this.dflt,[ATTR_TITLE,a??"",ATTR_STYLE,s,ATTR_ID,this.display.getDomId(this.getId()),ATTR_SIZE,e,ATTR_CLASS,"display-filter-input"])}return t?i?this.display.makeFilterWidget(this.name,l,t):t:""},isMacro:function(e){return e==this.name},getId:function(){return"macro_"+this.name},getValue:function(){let e=this.display.jq(this.getId()),t=this.dflt;if(0!=e.length)t=e.val();else if("enumeration"==this.type)return VALUE_NONE;return this.display.setProperty("request."+this.name+".default",t),t},setValue:function(e){let t=this.getId();"min"==e.what?this.display.jq(i+"_min").val(e.value):"max"==e.what?this.display.jq(t+"_max").val(e.value):"from"==e.what?this.display.jq(t+"_from").val(e.value):"to"==e.what?this.display.jq(t+"_to").val(e.value):this.display.jq(t).val(e.value)},apply:function(e){if("bounds"==this.type){if(this.display.getBounds&&HU.isChecked(this.display.jq(this.getId()))){let t=this.display.getBounds();t&&(t=RecordUtil.convertBounds(t),["north","south","east","west"].map((i=>{e+="&"+i+"="+t[i]})))}}else if("numeric"==this.type||"number"==this.type){let t=this.display.jq(this.getId()+"_min").val()||"",i=this.display.jq(this.getId()+"_max").val()||"";this.dflt_min=t,this.dflt_max=i,Utils.stringDefined(t)&&(e=e+"&"+HU.urlArg(this.urlarg+"_from",t)),Utils.stringDefined(i)&&(e=e+"&"+HU.urlArg(this.urlarg+"_to",i)),this.display.setProperty("request."+this.name+"_min.default",t),this.display.setProperty("request."+this.name+"_max.default",i)}else if("daterange"==this.type){let t=this.display.jq(this.getId()+"_from").val()||"",i=this.display.jq(this.getId()+"_to").val()||"";this.dflt_from=t,this.dflt_to=i,this.display.setProperty("request."+this.name+"_from.default",t),this.display.setProperty("request."+this.name+"_to.default",i),""!=t&&(e=e+"&"+HU.urlArg(this.urlarg+"_fromdate",t)),""!=i&&(e=e+"&"+HU.urlArg(this.urlarg+"_todate",i))}else if("date"==this.type){let t=this.display.jq(this.getId()+"_from").val()||"";this.dflt_from=t,this.display.setProperty("request."+this.name+"_from.default",t),""!=t&&(e=e+"&"+HU.urlArg(this.urlarg,t))}else if("enumeration"==this.type){let t=this.getValue();if(Array.isArray(t)||(t=[t]),"_all_"==t[0]||"_none_"==t[0]||t[0]==VALUE_NONE)return e;if(t.length>0){let i=new RegExp(this.urlarg+"=[^$&]*","g");e=e.replace(i,"");let s=[];if(t.forEach((e=>{this.template&&(e=this.template.replace(/\${value}/,e)),s.push(e)})),this.delimiter){let t="";s.forEach(((e,i)=>{i>0&&(t+=this.delimiter),t+=e})),this.multitemplate&&s.length>1&&(t=this.multitemplate.replace(/\${value}/,t)),e=e+"&"+HU.urlArg(this.urlarg,t),console.log("URL0:"+e)}else s.forEach((t=>{e=e+"&"+HU.urlArg(this.urlarg,t)}))}}else{let t=this.getValue();if(this.dflt=t,Utils.stringDefined(t)){let i=new RegExp(this.urlarg+"=[^$&]*","g");e=(e=e.replace(i,""))+"&"+HU.urlArg(this.urlarg,t)}}return e}};var FILTER_ALL="-all-",ATTR_FIELDID="fieldId";function BaseFilter(e,t){this.display=e,null==t&&(t={}),RamaddaUtil.defineMembers(this,{properties:t,isEnabled:function(){return!0},prepareToFilter:function(){},isRecordOk:function(e,t,i){return!0},getWidget:function(){return""},initWidget:function(e){}})}function BoundsFilter(e,t){RamaddaUtil.inherit(this,new BaseFilter(e,t)),$.extend(this,{enabled:!0,getWidget:function(){let e=this.display.getDomId("boundsfilter");return HU.span([ATTR_STYLE,HU.css(CSS_MARGIN_LEFT,HU.px(4),CSS_MARGIN_RIGHT,HU.px(4)),ATTR_ID,e,ATTR_CLASS,CLASS_CLICKABLE,ATTR_TITLE,"Filter records on map view. Shift-click to clear"],HU.getIconImage("fas fa-globe-americas"))},initWidget:function(e){this.inputFunc=e;this.display.getDomId("boundsfilter");let t=this;this.display.jq("boundsfilter").click((function(i){if(i.shiftKey){if(!t.bounds)return;t.bounds=null}else t.bounds=t.display.getBounds();e($(this),null,t.bounds)}))},isRecordOk:function(e){if(!this.bounds)return!0;if(e.hasLocation()){let t=this.bounds,i=e.getLatitude(),s=e.getLongitude();if(i>t.top||i<t.bottom||s<t.left||s>t.right)return!1}return!0}})}function RecordFilter(e,t,i){let s;if(this.id=t,this.isText="_text_"==this.id,this.isText){let t=e.getProperty("textFilterFields");s=t?e.getFieldsByIds(null,t):e.getFieldsByType(null,"string")}else{let i=e.getFieldById(null,t);i?s=[i]:(console.warn("Could not find filter field:"+t),this.disabled=!0,s=[])}$.extend(this,new BaseFilter(e,i)),this.getId=function(){return this.id};let l=(t,i)=>{let s=this.getId()+"."+t,l=e.getProperty(s);return Utils.isDefined(l)||(l=e.getProperty(t,i)),l},a="";if(a=this.isText?l("filterLabel","Search"):l("filterLabel",s.length>0?s[0].getLabel():""),$.extend(this,{fields:s,values:[],hideFilterWidget:e.getProperty("hideFilterWidget",!1,!0),displayType:l("filterDisplay","menu"),label:a,depends:l("filterDepends",null),dateIds:[],prefix:e.getProperty(this.getId()+".filterPrefix",""),suffix:e.getProperty(this.getId()+".filterSuffix",""),startsWith:e.getProperty(this.getId()+".filterStartsWith",!1),ops:Utils.split(e.getProperty(this.getId()+".filterOps"),";",!0,!0),labelField:e.getFieldById(null,e.getProperty(this.getId()+".labelField"))}),this.ops){let e=[];this.ops.forEach((t=>{let i=t.split(",");e.push({op:i[0],value:i[1],label:i[2]||this.id+i[0]+i[1]})})),this.ops=e}$.extend(this,{toString:function(){return"filter:"+this.getId()},getField:function(){return this.fields[0]},getFieldId:function(){return 0==this.fields.length?"":this.fields[0].getId()},getLabel:function(){return this.label},getValue:function(e){if(1==this.fields.length)return e.getValue(this.fields[0].getIndex());return this.fields.reduce(((t,i)=>t+" "+e.getValue(i.getIndex())),"")},isFieldNumeric:function(){return!this.isText&&(!this.disabled&&this.getField().isNumeric())},isFieldBoolean:function(){return!this.isText&&(!this.disabled&&this.getField().isFieldBoolean())},isFieldEnumeration:function(){return!this.isText&&(!this.disabled&&this.getField().isFieldEnumeration())},isFieldText:function(){return!!this.isText||!this.disabled&&this.getField().isFieldAbsoluteString()},isFieldDate:function(){return!this.disabled&&"date"==this.getFieldType()},isFieldMultiEnumeration:function(){return!this.disabled&&this.getField().isFieldMultiEnumeration()},fieldType:null,getFieldType:function(){return this.disabled?"":(this.getField()&&!this.fieldType&&(this.fieldType=this.display.getProperty(this.getField().getId()+".type",this.getField().getType())),this.fieldType)},getFilterId:function(e){return this.display.getDomId("filterby_"+(e||this.getId()))},isEnabled:function(){return!this.disabled&&(this.isText||null!=this.getField())},recordOk:function(e,t,i){return!0},propertyCache:{},getProperty:function(e,t,i){if(!i){let t=this.propertyCache[e];if(t)return t.value}let s=this.display.getProperty(e,t);return i||(this.propertyCache[e]={value:s}),s},getPropertyFromUrl:function(e,t){return e=this.getId()+"."+e,this.display.getPropertyFromUrl(e,t,!0)},prepareToFilter:function(){if(this.mySearch=null,this.filterIDependOn&&this.checkDependency(),!this.isEnabled())return;let e=null,t=[],i=null,s=[];if(this.ops){let e=jqid(this.getFilterId(this.getId())).val();return e==FILTER_ALL?void(this.mySearch=null):void(this.mySearch={index:parseFloat(e)})}if(this.isFieldNumeric()){let t=jqid(this.display.getDomId("filterby_"+this.getId()+"_min")),i=jqid(this.display.getDomId("filterby_"+this.getId()+"_max"));if(!t.val()||!i.val())return;let s=parseFloat(t.val().trim()),l=parseFloat(i.val().trim()),a=parseFloat(t.attr(ATTR_DATA_MIN)),r=parseFloat(i.attr(ATTR_DATA_MAX));s==a&&l==r||(e=[s,l])}else if(this.isFieldDate()){let t=jqid(this.display.getDomId("filterby_"+this.getId()+"_date_from")).val(),i=jqid(this.display.getDomId("filterby_"+this.getId()+"_date_to")).val();t=null!=t&&""!=t.trim()?Utils.parseDate(t):null,i=null!=i&&""!=i.trim()?Utils.parseDate(i):null,null==t&&null==i||(e=[t,i])}else{if(i=this.getFieldValues(),!i)return;if(Array.isArray(i)||(i=[i]),0==i.length)return;i=i.map((e=>e.replace(/_comma_/g,","))),i.forEach((e=>{t.push((""+e).toLowerCase());try{s.push(new TextMatcher(e))}catch(e){}}))}let l=null!=e;!l&&i&&i.forEach((e=>{e.length>0&&e!=FILTER_ALL&&(l=!0)})),this.mySearch=l?{value:e,values:i,matchers:s,_values:t,anyValues:l}:null},getFilterValues:function(){return this.mySearch||this.prepareToFilter(),this.mySearch},isRecordOk:function(e,t){let i=!0;if(!this.isEnabled()||!this.mySearch)return t&&(this.isEnabled()||console.log("\t"+this+"  not enabled"),this.mySearch||console.log("\t"+this+"  no mySearch")),i;let s=this.getValue(e);if(this.ops){let e=this.ops[this.mySearch.index];"<"==e.op?i=s<e.value:"<="==e.op?i=s<=e.value:">"==e.op?i=s>e.value:">="==e.op?i=s>=e.value:"=="==e.op&&(i=s==e.value)}else if(this.isFieldBoolean())s=String(s),i=this.mySearch.values.includes(s);else if(this.isFieldEnumeration())if(s=String(s),this.isFieldMultiEnumeration()){i=!1,s.split(",").forEach((e=>{e=e.trim(),this.mySearch.values.includes(e)&&(i=!0)}))}else i=this.mySearch.values.includes(s);else if(this.isFieldNumeric()){if(isNaN(this.mySearch.value[0])&&isNaN(this.mySearch.value[1]))return i;(isNaN(s)||""==s||!isNaN(this.mySearch.value[0])&&s<this.mySearch.value[0]||!isNaN(this.mySearch.value[1])&&s>this.mySearch.value[1])&&(i=!1)}else if(this.isFieldDate()){if(this.mySearch.value&&Array.isArray(this.mySearch.value))if(null==s)i=!1;else{let e=this.mySearch.value[0],t=this.mySearch.value[1];if(s.getTime){let l=s.getTime();(isNaN(l)||e&&l<e.getTime()||t&&l>t.getTime())&&(i=!1)}else i=!1}}else{let e=this.startsWith;i=!1,s=String(s).toLowerCase();for(let t=0;t<this.mySearch._values.length;t++){let l=this.mySearch._values[t];if(e){if(s.toString().startsWith(l)){i=!0;break}}else if(s.toString().indexOf(l)>=0){i=!0;break}}if(!i&&!e)for(let e=0;e<this.mySearch.matchers.length;e++){if(this.mySearch.matchers[e].matches(s.toString())){i=!0;break}}}return i},doTags:function(){if(!this.getProperty(this.getId()+".showFilterTags",!0))return!1;return this.display.getShowFilterTags()},doTagsColor:function(){if(!this.getProperty(this.getId()+".colorFilterTags",!0))return!1;return this.getProperty(this.getId()+".colorFilterTags",!0)||this.getProperty("colorFilterTags")},getFieldValues:function(){if(this.isFieldEnumeration()&&this.doTags())return this.selectedTags||[];let e=jqid(this.display.getDomId("filterby_"+this.getId())),t=null;t=e.attr("isCheckbox")?HU.isChecked(e)?e.attr("onValue"):e.attr("offValue"):e.attr("isButton")?e.attr(ATTR_DATA_VALUE):e.val(),t||(t=this.defaultValue?this.defaultValue:FILTER_ALL),Array.isArray(t)||(t=this.isFieldEnumeration()?[t]:t.split(","));let i=[];return t.forEach((e=>i.push(e.trim()))),t=i,t},toggleTag:function(e,t,i,s){let l=this,a=this.getFilterId(),r=Utils.makeId(a+"_"+e);if(t){if(this.selectedTags.includes(e))return;this.selectedTags=Utils.addUnique(this.selectedTags,e);let t=this.display.jq(ID_TAGBAR).find(".tag-group"+HU.attrSelect("tag-type",this.getFilterId()));if(0==t.length){let e;e=this.display.getProperty("tagDiv")?jqid(this.display.getProperty("tagDiv")):this.display.jq(ID_TAGBAR),t=$(HU.div([ATTR_STYLE,HU.css(CSS_DISPLAY,DISPLAY_INLINE_BLOCK),ATTR_CLASS,"tag-group","tag-type",this.getFilterId()])).appendTo(e)}$(HU.div([ATTR_METADATA_TYPE,a,ATTR_METADATA_VALUE,e,ATTR_TITLE,e,ATTR_STYLE,HU.css(CSS_BACKGROUND,Utils.getEnumColor(this.getFieldId())),ATTR_CLASS,"display-search-tag",ATTR_ID,r],e+SPACE+HU.getIconImage("fas fa-times"))).appendTo(t).click((function(){l.selectedTags=Utils.removeElement(l.selectedTags,e),i&&i.prop("checked",!1),$(this).remove(),l.inputFunc(l.fakeInput,null,l.selectedTags)}))}else this.selectedTags=Utils.removeElement(this.selectedTags,e),jqid(r).remove();s&&this.inputFunc&&this.inputFunc(this.fakeInput,null,this.selectedTags)},initWidget:function(e){let t=this;if(!this.isEnabled())return;if(this.inputFunc=e,this.fakeInput={attr:function(e){return this[e]},val:function(){return null},id:this.getId(),fieldId:this.getFieldId()},!this.hideFilterWidget&&this.getProperty(this.getId()+".filterLive",this.getProperty("filterLive",!1))){let t=this.getFilterId(this.getId()),i=jqid(t);i.length&&i.keyup((function(){e($(this),null,$(this).val())}))}let i=this.getProperty(this.getId()+".filterMultiple",this.getProperty("filterMultiple",!1)),s=i||this.getProperty(this.getId()+".filterShowPopup",this.getProperty("filterShowPopup"));if(this.isFieldEnumeration()&&s){let e=this.getFilterId(this.getId());Utils.isDefined(i)||(i=!1),HU.makeSelectTagPopup(jqid(e),{wrap:HU.span([ATTR_CLASS,CLASS_HOVERABLE,ATTR_STYLE,HU.css(CSS_DISPLAY,DISPLAY_INLINE_BLOCK,CSS_MARGIN_RIGHT,HU.px(4),CSS_MARGIN_BOTTOM,HU.px(0))],"${widget}"),single:!i,makeButtons:i,makeButton:!1,hide:!1,after:!0,buttonLabel:HU.getIconImage("fas fa-list-check")})}if(!this.hideFilterWidget&&this.getProperty(this.getId()+".filterSuggest",!1)){let e=this.getFilterId(this.getId()),i=jqid(e);i.length&&i.keyup((function(e){t.suggestDialog&&t.suggestDialog.remove();let i=$(this),s=i.val().toLowerCase(),l="",a={};t.records.forEach((e=>{let i=e.getValueFromField(t.getId());i&&(i=String(i),a[i]||(a[i]=!0,i.toLowerCase().indexOf(s)>0&&(l+=HU.div([ATTR_CLASS,CLASS_CLICKABLE,ATTR_STYLE,HU.css(CSS_WHITE_SPACE,WHITE_SPACE_NOWRAP,CSS_MAX_WIDTH,HU.px(400),CSS_OVERFLOW_X,OVERFLOW_HIDDEN)],i))))})),""!=l&&(l=HU.div([ATTR_STYLE,HU.css(CSS_MAX_HEIGHT,HU.px(300),CSS_OVERFLOW_Y,OVERFLOW_AUTO,CSS_PADDING,HU.px(5))],l),t.suggestDialog=HU.makeDialog({content:l,my:POS_LEFT_TOP,at:POS_LEFT_BOTTOM,anchor:i}),t.suggestDialog.find(HU.dotClass(CLASS_CLICKABLE)).click((function(){t.suggestDialog.remove(),t.suggestDialog=null,i.val($(this).html()),i.focus()})))}))}this.initDateWidget(e);let l=i=>{let s,l=new Date,a=l,r=t.widgetId;if(""==i)return jqid(r+"_date_from").val(""),jqid(r+"_date_to").val(""),void e(jqid(r+"_date_from"),null,{from:"",to:"",select:""});if("thisyear"==i){let e=l.getFullYear();a=new Date(e,0,1),s=new Date(e,11,31)}else if(i.startsWith("year_")){let e=parseInt(i.substring("year_".length));a=new Date(e,0,1),s=new Date(e,11,31)}else if("ytd"==i){let e=l.getFullYear();a=new Date(e,0,1),s=l}else{let e=Utils.createDateInner(i,l);e.getTime()<l.getTime()?(a=e,s=l):(a=l,s=e)}a=Utils.formatDateYYYYMMDD(a),s=Utils.formatDateYYYYMMDD(s),jqid(r+"_date_from").val(a),jqid(r+"_date_to").val(s),e(jqid(r+"_date_from"),null,{from:a,to:s,select:i})};if(this.dateRadiosId&&jqid(this.dateRadiosId).find("input:radio").change((function(){l($(this).attr("value"))})),this.dateSelectId&&jqid(this.dateSelectId).change((function(){l($(this).val())})),this.tagCbxs){let e=this,t=function(){let t=$(this),i=HU.isChecked(t),s=$(this).attr(ATTR_METADATA_VALUE);e.toggleTag(s,i,t,!0)},i=this.getFilterId()+"_popup";jqid(i).click((()=>{this.display.createTagDialog(this.tagCbxs,jqid(i),t,this.getFilterId(),this.getLabel()).find(".metadata-cbx").each((function(){let t=$(this).attr(ATTR_METADATA_VALUE);$(this).prop("checked",e.selectedTags.includes(t))}))}))}},initDateWidget:function(e){if(!this.hideFilterWidget)for(let t=0;t<this.dateIds.length;t++){let i=this.dateIds[t];HU.datePickerInit(i),jqid(i).change((function(){e($(this))}))}},checkDependency:function(){if(!this.filterIDependOn||!this.records)return;let e=this.getEnums(this.records),t=this.getFilterId(this.getId()),i=[];e.forEach((e=>i.push(e.value))),this.display.ignoreFilterChange=!0;let s=jqid(t),l=s.val();l||(l=s.attr(ATTR_DATA_VALUE)),s.html(HU.makeOptions(i,l)),this.display.ignoreFilterChange=!1},handleEventPropertyChanged:function(e){if(this.isFieldEnumeration()&&this.doTags()){if(this.selectedTags){let e=this.getFilterId();this.selectedTags.forEach((t=>{let i=Utils.makeId(e+"_"+t);jqid(i).remove()}))}this.selectedTags=[];let t=e.values?e.values:null;return t||(e.value?Array.isArray(e.value)?t=e.value:t[e.value]:t=[]),void e.value.forEach((e=>{e&&this.toggleTag(e,!0)}))}let t=this.widgetId;if(this.isFieldDate()&&e?.value?.select)return jqid(t+"_date_from").val(e.value.from),jqid(t+"_date_to").val(e.value.to),void jqid(t+"_date_select").val(e.value.select);e.id&&e.id.endsWith("date_from")?t+="_date_from":e.id&&e.id.endsWith("date_to")&&(t+="_date_to");let i=jqid(t);if(i.attr("isCheckbox")){let t=i.attr("onValue");i.prop("checked",e.value.includes(t))}else i.val(e.value);i.attr(ATTR_DATA_VALUE,e.value),i.attr("isButton")&&(i.find(HU.dotClass("display-filter-button")).removeClass("display-filter-button-selected"),i.find("[value='"+e.value+"']").addClass("display-filter-button-selected"))},getIncludeAll:function(){return this.getProperty(this.getId()+".includeAll",this.getProperty(this.getId()+".filterIncludeAll",this.getProperty("filterIncludeAll",this.getProperty("filter.includeAll",!0))))},getWidget:function(e,t,i,s){let l=this.getProperty("filterLabelVertical",this.getProperty(this.getId()+".filterLabelVertical",s));this.records=i;let a=!1;if(!this.isEnabled())return"";let r="";this.hideFilterWidget&&(r=HU.css(CSS_DISPLAY,DISPLAY_NONE)),e[this.getId()]={field:this.fields[0],values:[]};let o,n=!0,h=this.widgetId=this.getFilterId(this.getId()),d=this.getProperty(this.getId()+".filterLabel",this.getLabel()),g=this.getIncludeAll();if(this.ops){let e=[];this.ops.forEach(((t,i)=>{e.push([String(i),t.label])}));let t=this.getPropertyFromUrl("fv",FILTER_ALL),i=this.getProperty(this.getId()+".showFilterLabel",this.getProperty("showFilterLabel",!0)),s=this.getProperty(this.getId()+".allName",i?"All":this.getLabel()),l=Utils.mergeLists([[FILTER_ALL,s]],e),a=[ATTR_STYLE,r,ATTR_ID,h,ATTR_FIELDID,this.getId()];o=HU.select("",a,l,t)}else if(this.isFieldBoolean()){let e=[ATTR_STYLE,r,ATTR_ID,h,ATTR_FIELDID,this.getId()],t=this.getProperty(this.getId()+".filterValues"),i=[],s=this.getProperty(this.getId()+".allName","-");i.push(["",s]),t?t.split(",").forEach((e=>{let t=e.split(":");i.push(t)})):i.push("true","false"),o=HU.select("",e,i,this.dflt)}else if(this.isFieldEnumeration()){a;let e=this.getProperty(this.getId()+".filterValue"),s=this.defaultValue=e||this.getPropertyFromUrl("fv",FILTER_ALL),l=this.getEnums(i),d=[ATTR_STYLE,r,ATTR_ID,h,ATTR_FIELDID,this.getId()];if(this.getProperty(this.getId()+".filterMultiple",this.getProperty("filterMultiple"))&&(d.push(ATTR_MULTIPLE,""),d.push(ATTR_SIZE),d.push(this.getProperty(this.getId()+".filterMultipleSize",this.getProperty("filterMultipleSize","3"))),s=s.split(",")),"menu"!=this.displayType){a,g||s!=FILTER_ALL||(s=l[0].value);let e="",i=Utils.parseMap(this.getProperty(this.getId()+".filterColorByMap")),r="image"==this.displayType,o="button"==this.displayType,n=[],d=Utils.getNameValue(this.getProperty(this.getId()+".filterImages"));if(r){let e=this.getProperty(this.getId()+".filterImageWidth"),t=this.getProperty(this.getId()+".filterImageHeight");t&&n.push(ATTR_HEIGHT,t),e&&n.push(ATTR_WIDTH,e),t||e||n.push(ATTR_WIDTH,50),n.push(ATTR_STYLE),n.push(this.getProperty(this.getId()+".filterImageStyle",HU.css(CSS_BORDER_RADIUS,HU.perc(50))))}for(let t=0;t<l.length;t++){let a,h="",g=l[t].value,p=i?i[g]:null;Array.isArray(g)?(a=g[1],g=g[0]):a=g;let c=this.getProperty(this.getId()+".filterItemStyle","");c+=p?HU.css(CSS_BACKGROUND_COLOR,p):HU.css(CSS_BORDER,HU.border(1,COLOR_LIGHT_GRAY));let u=HU.classes(CLASS_CLICKABLE,CLASS_HOVERABLE,"display-filter-item display-filter-item-"+this.displayType);if(o&&(u=HU.classes(u,CLASS_BUTTON)),g==s&&(u+=" display-filter-item-"+this.displayType+"-selected "),g==FILTER_ALL&&(h=" display-filter-item-all "),r){let i=null;d&&(i=d[g]),i&&""!=i||(i=l[t].image),e+=i?HU.div([ATTR_FIELDID,this.getId(),ATTR_CLASS,u,ATTR_STYLE,c,ATTR_DATA_VALUE,g,ATTR_TITLE,a],HU.image(i,n)):HU.div([ATTR_FIELDID,this.getId(),ATTR_CLASS,u,ATTR_STYLE,c,ATTR_DATA_VALUE,g,ATTR_TITLE,a],a)}else e+=HU.div([ATTR_FIELDID,this.getId(),ATTR_CLASS,u,ATTR_STYLE,c,ATTR_DATA_VALUE,g],a);e+="\n"}return r&&this.getProperty(this.getId()+".filterShowButtonsLabel")&&(e+=HU.div([ATTR_CLASS,"display-filter-item-label",ATTR_ID,this.display.getDomId("filterby_"+this.getId()+"_label")],SPACE)),t[0]+=this.prefix+HU.div([ATTR_DATA_VALUE,s,ATTR_CLASS,"display-filter-items",ATTR_ID,h,"isButton","true",ATTR_FIELDID,this.getId()],e),""}if(this.getProperty(this.getId()+".filterCheckbox")){a,d.push("isCheckbox"),d.push(!0);let e=[];l.map((t=>e.push(t.value)));let t=e.includes(s);e.length>0&&(d.push("onValue"),d.push(e[0])),e.length>1&&(d.push("offValue"),d.push(e[1])),o=HU.checkbox("",d,t)}else if(this.doTags()){let e=this.doTagsColor();n=!1;let t=[];this.tagToCbx={},this.selectedTags=[],l.map(((e,i)=>{let s=e.count,l=e.value,a=l;Array.isArray(l)&&(l=e.value[0],a=e.value[1],""===l&&(a="-blank-"));s&&(a=a+" ("+s+")");let r=this.getFilterId()+"_cbx_"+i;this.tagToCbx[l]=r;let o=HU.checkbox("",[ATTR_CLASS,"metadata-cbx",ATTR_ID,r,ATTR_METADATA_TYPE,this.getFilterId(),ATTR_METADATA_VALUE,l],!1)+" "+HU.tag(TAG_LABEL,[ATTR_CLASS,HU.classes("ramadda-noselect",CLASS_CLICKABLE),ATTR_FOR,r],a);o=HU.span([ATTR_CLASS,"display-search-tag",ATTR_TAG,a,ATTR_STYLE,HU.css(CSS_BACKGROUND,Utils.getEnumColor(this.getFieldId()))],o),t.push(o)})),this.tagCbxs=t;let i=this.getFilterId()+"_popup",s=" "+this.getLabel()+" ("+t.length+")";s=s.replace(/ /g,SPACE);let a=HU.css(CSS_WHITE_SPACE,WHITE_SPACE_NOWRAP,CSS_LINE_HEIGHT,HU.em(1.5),CSS_MARGIN_TOP,HU.px(6),CSS_PADDING_RIGHT,HU.px(5));e&&(a+=HU.css(CSS_BORDER,HU.border(1,COLOR_LIGHT_GRAY),CSS_BACKGROUND,Utils.getEnumColor(this.getFieldId()))),o=HU.div([ATTR_STYLE,a,ATTR_TITLE,"Click to select tag",ATTR_ID,i,ATTR_CLASS,HU.classes(CLASS_CLICKABLE,"entry-toggleblock-label")],HU.makeToggleImage("fa-solid fa-plus",HU.css(CSS_FONT_SIZE,HU.pt(8)))+s)}else{a;let e=[],t=this.getProperty(this.getId()+".filterShowCount",this.getProperty("filterShowCount",!0));l.map((i=>{let s=i.count,l=i.value,a=l;Array.isArray(l)&&(l=i.value[0],a=i.value[1],""===l&&(a="-blank-")),s&&(a+=t?" ("+s+")":""),e.push({value:l,label:a})})),o=HU.select("",d,e,s)}}else if(this.isFieldNumeric()){a;let e=0,t=0,s=0;i.map((i=>{let l=this.getValue(i);isNaN(l)||(0==s?(e=l,t=l):(e=Math.min(e,l),t=Math.max(t,l)),s++)}));let l=this.getPropertyFromUrl("fvmin",this.getProperty("filterValueMin")),r=this.getPropertyFromUrl("fvmax",this.getProperty("filterValueMax")),n="",d="",g=e,p=t;Utils.isDefined(l)&&(n=HU.css(CSS_BACKGROUND,TEXT_HIGHLIGHT_COLOR),g=parseFloat(l)),Utils.isDefined(r)&&(d=HU.css(CSS_BACKGROUND,TEXT_HIGHLIGHT_COLOR),p=parseFloat(r));let c=this.getProperty(this.getId()+".filterWidgetSize",this.getProperty("filterWidgetSize",HU.px(60)));n+=HU.css(CSS_WIDTH,c),d+=HU.css(CSS_WIDTH,c),o=HU.input("",g,[ATTR_STYLE,n,ATTR_DATA_TYPE,this.getFieldType(),ATTR_DATA_MIN,e,ATTR_CLASS,HU.classes("display-filter-range",CLASS_FILTER_INPUT),ATTR_ID,h+"_min",ATTR_FIELDID,this.getId()]),o+="-",o+=HU.input("",p,[ATTR_STYLE,d,ATTR_DATA_TYPE,this.getFieldType(),ATTR_DATA_MAX,t,ATTR_CLASS,HU.classes("display-filter-range",CLASS_FILTER_INPUT),ATTR_ID,h+"_max",ATTR_FIELDID,this.getId()])}else if("date"==this.getFieldType()){o=HU.datePicker("","",[ATTR_CLASS,CLASS_FILTER_INPUT,ATTR_STYLE,r,ATTR_ID,h+"_date_from",ATTR_FIELDID,this.getId()])+"-"+HU.datePicker("","",[ATTR_CLASS,CLASS_FILTER_INPUT,ATTR_STYLE,r,ATTR_ID,h+"_date_to",ATTR_FIELDID,this.getId()]),this.dateIds.push(h+"_date_from"),this.dateIds.push(h+"_date_to");let e=this.getProperty(this.getId()+".filterDateSelects");if(e){let t;if(this.getProperty(this.getId()+".filterDateShowRange",!0)||(o=HU.span([ATTR_STYLE,HU.css(CSS_DISPLAY,DISPLAY_NONE)],o)),this.dateSelectId=h+"_date_select",e=e.split(",").map((e=>{let t=Utils.split(e,":",!0,!0);return 2==t.length?{value:t[0],label:t[1]}:{value:e,label:e}})),this.getProperty(this.getId()+".filterDateShowRadio",!1)){this.dateRadiosId=h+"_date_radios";let i=HU.getUniqueId("radios_");e=Utils.mergeLists([{value:"",label:"All dates"}],e),t=HU.div([ATTR_ID,this.dateRadiosId,ATTR_STYLE,HU.css(CSS_TEXT_ALIGN,CSS_LEFT)],HU.radioGroup(i,e))}else e=Utils.mergeLists([{value:"",label:"Select date"}],e),t=HU.select("",[ATTR_ID,h+"_date_select","ignore",!0],e);l?o+=t:o=HU.span([],o)+HU.span([ATTR_STYLE,HU.css(CSS_MARGIN_LEFT,HU.px(5))],t)}}else{let t=this.getProperty(this.getId()+".filterValues"),s=this.getPropertyFromUrl("fv",t),l=this.getProperty(this.getId()+".filterWidth",HU.px(150)),a=[ATTR_STYLE,r+HU.css(CSS_WIDTH,HU.getDimension(l)),ATTR_ID,h,ATTR_FIELDID,this.getId(),ATTR_CLASS,CLASS_FILTER_INPUT],g=this.getProperty(this.getId()+".filterPlaceholder");a.push(ATTR_WIDTH),a.push(l),g?a.push(ATTR_PLACEHOLDER,g):(n=!1,a.push(ATTR_PLACEHOLDER,d)),a.push("istext",this.isText),o=HU.input("",s,a);let p=e[this.getId()].values,c={};i.map((e=>{let t=this.getValue(e);c[t]||(c[t]=!0,p.push(t))}))}if(!this.hideFilterWidget){let e=d;Utils.stringDefined(this.getField().getDescription())&&(e=e+HU.getTitleBr()+this.getField().getDescription()),d.length>50&&(d=d.substring(0,49)+"..."),this.getProperty(this.getId()+".showFilterLabel",this.getProperty("showFilterLabel",!0))&&Utils.stringDefined(d)?d+=": ":d="",d=this.display.makeFilterLabel(d,e,l),l&&(d+=HU.br()),o=s?HU.div([],(n?d:"")+o+this.suffix):HU.div([ATTR_STYLE,HU.css(CSS_DISPLAY,DISPLAY_INLINE_BLOCK)],(n?d:"")+o+this.suffix)}return s||(o+=this.hideFilterWidget?"":SPACE2),this.prefix&&(o=this.prefix+o),this.getProperty(this.getId()+".filterShow",this.getProperty("filterShow",!0))||(o=HU.div([ATTR_STYLE,HU.css(CSS_DISPLAY,DISPLAY_NONE)],o)),o},getWidgetId:function(){return this.widgetId},getEnums:function(e){let t={},i=this.isFieldMultiEnumeration();e.forEach(((e,s)=>{let l=this.getValue(e);null!==l&&(l=String(l),(i?l.split(","):[l]).forEach((e=>{e=e.trim(),t[e]?t[e]++:t[e]=1})))}));let s=null,l=this.getProperty(this.getId()+".filterValues"),a=this.getProperty(this.getId()+".showFilterLabel",this.getProperty("showFilterLabel",!0));if(l){let e;"string"==typeof l?(l=Utils.getMacro(l),e=l.split(",")):e=l,s=[],e.map((e=>{let i=e.split(":");if(i.length>1)e=[i[0],i[1]];else if(e==FILTER_ALL){let t=this.getProperty(this.getId()+".allName",a?"All":this.getLabel());e=[i[0],t]}else e=[e,e];let l=t[e[0]];s.push({value:e,count:l})}))}if(null==s){let l=this.getProperty(this.getId()+".depends");this.filterIDependOn=l?this.display.getRecordFilter(l):null;let r=this.getProperty(this.getId()+".allName",a?"All":this.getLabel());r+=" ("+e.length+")",s=[],this.getIncludeAll()&&s.push({value:[FILTER_ALL,r]});let o={},n=this.getField().getEnumeratedValues();if(n)for(let e in n){o[e]=!0;let i=t[e];s.push({value:[e,n[e]],count:i})}let h=[],d=this.display.getFieldByType(null,"image"),g=!0;this.filterIDependOn&&this.filterIDependOn.prepareToFilter(),e.forEach(((e,s)=>{if(this.filterIDependOn&&!this.filterIDependOn.isRecordOk(e))return;let l,a=this.getValue(e);l=i?a.split(",").map((e=>e.trim())):[a],l.forEach((i=>{if(o[i])return;o[i]=!0;let s={};d&&(s.image=this.display.getDataValues(e)[d.getIndex()]),+i+""!=i&&(g=!1);let l=i;l.length>30&&(l=l.substring(0,29)+"..."),this.labelField&&(l+=" - "+this.labelField.getValue(e),console.log("l:"+l)),"string"==typeof i&&(i=i.replace(/\'/g,"&apos;"));let a=[i,l];s.value=a,s.count=t[i],h.push(s)}))}));let p=this.getProperty(this.getId()+".filterSortCount",this.getProperty("filterSortCount"));if(p||this.getProperty(this.getId()+".filterSort",this.getProperty("filterSort",!0))){this.getProperty(this.getId()+".filterSort",this.getProperty("filterSort",!1))||(p=this.getProperty(this.getId()+".filterSortCount",this.getProperty("filterSortCount",!0))),h.forEach((e=>{Utils.isDefined(e.count)||(e.count=0)})),h.sort(((e,t)=>p&&t.count!=e.count?t.count-e.count:(e=e.value,t=t.value,g?+e-+t:(""+e[1]).localeCompare(""+t[1]))))}for(let e=0;e<h.length;e++){let t=h[e];s.push(t)}}return s}})}function MonthFilter(e){RamaddaUtil.inherit(this,new BaseFilter),RamaddaUtil.defineMembers(this,{months:e.split(","),recordOk:function(e,t,s){for(i in this.months){let e=this.months[i],s=t.getDate();if(null==s)return!1;if(null==s.getMonth)return!1;if(s.getMonth()==e)return!0}return!1}})}function TextMatcher(e,t){this.myId=t,this.regexps=[],e&&(e=e.trim()),e&&e.length>0&&((e=e.replace(/\./g,"\\.")).startsWith('"')&&e.endsWith('"')?(e=(e=e.replace(/^"/,"")).replace(/"$/,""),this.regexps.push(new RegExp("("+e+")","ig"))):e.split(" ").map((e=>{e=e.trim();try{e.includes("(")||e.includes(")")||(e="("+e+")",this.regexps.push(new RegExp(e,"ig")))}catch(t){console.log("Error creating pattern matcher:"+t,e)}}))),$.extend(this,{pattern:e,hasPattern:function(){return this.regexps.length>0},highlight:function(e,t){if(t&&this.myId&&t!=this.myId)return e;for(var i=0;i<this.regexps.length;i++)e=e.replace(this.regexps[i],HU.span([ATTR_STYLE,HU.css(CSS_BACKGROUND,TEXT_HIGHLIGHT_COLOR)],"$1"));return e},matches:function(e){if(0==this.regexps.length)return!0;e=e.toLowerCase();for(var t=0;t<this.regexps.length;t++)if(!e.match(this.regexps[t]))return!1;return!0}})}RecordFilter.prototype={toString:function(){return"RecordFilter:"+this.id}};var DISPLAY_LINECHART="linechart",DISPLAY_AREACHART="areachart",DISPLAY_BARCHART="barchart",DISPLAY_BARTABLE="bartable",DISPLAY_BARSTACK="barstack",DISPLAY_PIECHART="piechart",DISPLAY_TIMERANGECHART="timerangechart",DISPLAY_SANKEY="sankey",DISPLAY_CALENDAR="calendar",DISPLAY_SCATTERPLOT="scatterplot",DISPLAY_HISTOGRAM="histogram",DISPLAY_BUBBLE="bubble",DISPLAY_GAUGE="gauge",DISPLAY_TABLE="table",DISPLAY_WORDTREE="wordtree",DISPLAY_TREEMAP="treemap",DISPLAY_ORGCHART="orgchart",ID_CHART="chart",ID_CHARTS="charts",ID_CHARTS_INNER="chartsinner",ramaddaChartInfo={debug:!1,version:"51",loading:!1,chartsHaveLoaded:!1,pending:[],packages:{}};function haveGoogleChartsLoaded(e){if(ramaddaChartInfo.chartsHaveLoaded)return e&&e(),!0;if(e&&ramaddaChartInfo.pending.push(e),!window.google){if(ramaddaChartInfo.debug&&console.log("\tno google"),ramaddaChartInfo.loading)return!1;ramaddaChartInfo.loading=!0,Utils.loadScript("https://www.gstatic.com/charts/loader.js",(()=>{ramaddaChartInfo.debug&&console.log("loader.js loaded calling google.charts.load version:"+ramaddaChartInfo.version),google.charts.load(ramaddaChartInfo.version,{packages:["corechart"]}),google.charts.setOnLoadCallback((()=>{ramaddaChartInfo.debug&&console.log("core chart loaded"),ramaddaChartInfo.chartsHaveLoaded=!0,ramaddaChartInfo.pending.forEach((e=>{ramaddaChartInfo.debug&&console.log("\tcalling callback"),e()})),ramaddaChartInfo.pendingDisplays=[]}))}))}}function ramaddaLoadGoogleChart(e,t){let i=ramaddaChartInfo.packages[e];return i||(i=ramaddaChartInfo.packages[e]={loading:!1,loaded:!1,pending:[]}),!!i.loaded||(t&&i.pending.push(t),i.loading||(i.loading=!0,ramaddaChartInfo.debug&&console.log("calling google.charts.load:"+e),google.charts.load(ramaddaChartInfo.version,{packages:[e],callback:()=>{ramaddaChartInfo.debug&&console.log("google.charts.load callback:"+e+" pending:"+i.pending.length),i.loaded=!0,i.pending.forEach((e=>e()))}})),!1)}addGlobalDisplayType({type:DISPLAY_TABLE,label:"Table",category:CATEGORY_TABLE,desc:"Basic tabular display",preview:"table.png"},!0),addGlobalDisplayType({type:DISPLAY_LINECHART,label:"Line Chart",category:CATEGORY_CHARTS,preview:"linechart.png",desc:"Show time series or other data",helpurl:!0}),addGlobalDisplayType({type:DISPLAY_BARCHART,label:"Bar Chart",category:CATEGORY_CHARTS,preview:"barchart.png"}),addGlobalDisplayType({type:DISPLAY_BARSTACK,label:"Stacked Bar Chart",category:CATEGORY_CHARTS,preview:"barstack.png",helpurl:!0}),addGlobalDisplayType({type:DISPLAY_AREACHART,label:"Area Chart",category:CATEGORY_CHARTS,preview:"areachart.png"}),addGlobalDisplayType({type:DISPLAY_BARTABLE,label:"Bar Table",category:CATEGORY_CHARTS,preview:"bartable.png"}),addGlobalDisplayType({type:DISPLAY_SCATTERPLOT,label:"Scatter Plot",category:CATEGORY_CHARTS,preview:"scatterplot.png"}),addGlobalDisplayType({type:DISPLAY_HISTOGRAM,label:"Histogram",category:CATEGORY_CHARTS,preview:"histogram.png"}),addGlobalDisplayType({type:DISPLAY_BUBBLE,label:"Bubble Chart",category:CATEGORY_CHARTS,preview:"bubblechart.png"}),addGlobalDisplayType({type:DISPLAY_PIECHART,label:"Pie Chart",category:CATEGORY_CHARTS,preview:"piechart.png"}),addGlobalDisplayType({type:DISPLAY_GAUGE,label:"Gauge",requiresData:!0,forUser:!0,category:CATEGORY_MISC,preview:"gauge.png"}),addGlobalDisplayType({type:DISPLAY_TIMERANGECHART,label:"Time Range",requiresData:!0,forUser:!0,category:CATEGORY_MISC,preview:"timerange.png",desc:"Show data with start/end times"}),addGlobalDisplayType({type:DISPLAY_SANKEY,label:"Sankey Chart",requiresData:!0,forUser:!0,category:CATEGORY_RADIAL_ETC,preview:"sankey.png"}),addGlobalDisplayType({type:DISPLAY_CALENDAR,label:"Calendar Chart",requiresData:!0,forUser:!0,category:CATEGORY_MISC,preview:"calendar.png"}),addGlobalDisplayType({type:DISPLAY_WORDTREE,label:"Word Tree",requiresData:!0,forUser:!0,category:CATEGORY_TEXT,preview:"wordtree.png",desc:"Specify a number of fields. Each field value is a level in the tree"}),addGlobalDisplayType({type:DISPLAY_TREEMAP,label:"Tree Map",requiresData:!0,forUser:!0,category:CATEGORY_RADIAL_ETC,preview:"treemap.png"}),addGlobalDisplayType({type:DISPLAY_ORGCHART,label:"Org Chart",requiresData:!0,forUser:!0,category:CATEGORY_RADIAL_ETC,preview:"orgchart.png"});let PROP_CHART_MIN="chartMin",PROP_CHART_MAX="chartMax",DFLT_WIDTH="600px",DFLT_HEIGHT="200px";function RamaddaGoogleChart(e,t,s,l){const a="trends_cbx",r="percent_cbx",o="colors",n="highlightfieldsholder",h="highlightfields";Utils.isDefined(l.sortOnDate)||(l.sortOnDate=!0),$.extend(this,{debugChartOptions:!1,useTestData:!1,indexField:-1,curveType:"none",fontSize:0,showPercent:!1,percentFields:null});const d=new RamaddaFieldsDisplay(e,t,s,l);this.debugTimes=!1,this.isGoogleChart=!0,defineDisplay(this,d,[{label:"Chart Style"},{p:"chartWidth",ex:""},{p:"chartHeight",ex:""},{p:"chartLeft",d:0},{p:"chartRight",d:0},{p:"chartTop",d:10,ex:"0"},{p:"chartBottom",ex:"0",d:0},{p:"textFontSize",ex:12},{p:"textBold",ex:!0},{p:"textItalic",ex:!0},{p:"textColor",ex:"green"},{p:"textFontName",ex:"Times"},{p:"hAxisTitle"},{p:"vAxisTitle"},{p:"hAxisHideTicks"},{p:"vAxisHideTicks"},{p:"vAxisFixedRange"},{p:"lineDashStyle",d:null,ex:"2,2,20,2,20"},{p:"highlight.lineDashStyle",d:"2,2,20,2,20",ex:"2,2,20,2,20"},{p:"nohighlight.lineDashStyle",d:"2,2,20,2,20",ex:"2,2,20,2,20"},{p:"some_field.lineDashStyle",d:"2,2,20,2,20",ex:"2,2,20,2,20"},{p:"labelInLegend",ex:"label"},{p:"highlight.labelInLegend",d:null,ex:"label",canCache:!0},{p:"nohighlight.labelInLegend",d:null,ex:"label",canCache:!0},{p:"some_field.labelInLegend",d:null,ex:"label",canCache:!0},{p:"tooltipStyle",ex:"min-width:600px;"},{p:"tooltipX",tt:"Fix the tooltip position",ex:"0"},{p:"tooltipY",tt:"Fix the tooltip position",ex:"0"},{p:"highlightFields",d:null,ex:"fields"},{p:"highlightShowFields",d:null,ex:"true"},{p:"highlightShowFieldsSize",d:"4",ex:"4"},{p:"acceptHighlightFieldsEvent",d:!0,ex:"true"},{p:"highlightDim",d:"true",ex:"true",tt:"Dim the non highlight lines"},{p:"seriesType",d:null,ex:"line|area|bars",canCache:!0},{p:"highlight.seriesType",d:null,ex:"line|area|bars",canCache:!0},{p:"nohighlight.seriesType",d:null,ex:"line|area|bars",canCache:!0},{p:"some_field.seriesType",d:null,ex:"line|area|bars"},{p:"pointSize",d:0,ex:"0"},{p:"highlight.pointSize",d:0,ex:"4"},{p:"nohighlight.pointSize",d:0,ex:"4"},{p:"some_field.pointSize",d:"4",ex:"4"},{p:"lineWidth",d:null,ex:null},{p:"highlight.lineWidth",d:null,ex:"2"},{p:"nohighlight.lineWidth",d:null,ex:"2"},{p:"some_field.lineWidth",d:"2",ex:"2"},{p:"highlight.color",d:null,ex:null},{p:"nohighlight.color",d:null,ex:null},{p:"some_field.color",d:null,ex:null},{p:"pointShape",d:null,ex:"circle|triangle|square|diamond|star"},{p:"highlight.pointShape",d:null,ex:"circle|triangle|square|diamond|star"},{p:"nohighlight.pointShape",d:null,ex:"circle|triangle|square|diamond|star"},{p:"some_field.pointShape",d:null,ex:"circle|triangle|square|diamond|star"},{p:"fixedLine0",ex:'"value:10,lineWidth:2,color:red,#depends:fieldid,#axisMin:0,#axisMax:100"'},{p:"dragToZoom",d:!0},{p:"dragToPan",d:!1},{p:"showUnit",ex:!1},{p:"dynamicTooltip",ex:"true",d:!0,tt:"Dynamically create the tooltips"},{p:"skipMissing",d:!1,ex:"true",tt:"skip rows  that have any missing values"},{p:"replaceNanWithZero"},{p:"maxColumns",d:-1},{p:"interpolateNulls",d:!0,ex:"true"},{p:"animateChart",ex:!0},{p:"animationDuration",d:500},{p:"animationEasing",d:"linear"},{label:"Trendlines"},{p:"showTrendLines",d:null,ex:"true"},{p:"trendlineType",ex:"exponential"},{p:"trendlineVisibleInLegend",ex:"true"},{p:"trendlineColor",d:"red"},{p:"trendlineLineWidth",ex:"2"},{p:"trendlineOpacity",ex:"0.3"},{label:"Annotations"},{p:"annotations",ex:"date,label,desc;date,label,desc;",tt:"e.g. 2008-09-29,A,Start of housing crash;2008-11-04,B,Obama elected;"},{p:"showAnnotationsLegend",ex:!0},{p:"annotationFields",ex:"",tt:"Set of fields to add an annotation to the line chart"},{p:"annotationStride",ex:10,tt:"Only show every N annotations"},{p:"annotationLabelField",ex:"field",tt:"Field to use for annotation label"},{p:"annotationTemplate",ex:'"${field}',tt:"Template to use"},{p:"annotationLabelTemplate",ex:'"${field}',tt:"Template to use for label"},{p:"annotationStyle",d:"point",ex:"line|point"},{p:"annotationSize",ex:"18"},{p:"annotationColor",d:"black",ex:"red"},{p:"annotationAuraColor",ex:"gray"},{p:"annotationBold",ex:!0},{p:"annotationItalic",ex:!0},{p:"annotationStemColor",d:"red"}],{showFieldsInDialog:function(){return!0},checkFinished:function(){return!0},useDisplayMessage:function(){return!0},getContentsClass:function(){return"display-contents-inner display-"+this.type},useChartableFields:function(){return!0},defaultSelectedToAll:function(){return!1},getRequiredPackages:function(){return[]},chartCallbackPending:!1,updateUI:function(e){let t=this.chartCallbackPending?null:()=>{this.updateUI()};if(this.chartCallbackPending=!0,!haveGoogleChartsLoaded(t))return;let i=this.getRequiredPackages();if(i.length>0){this.packageLoading||(this.packageLoading={});let e=i.length;if(i.forEach((t=>{ramaddaLoadGoogleChart(t,this.packageLoading[t]?null:()=>{this.updateUI()})&&e--})),e>0)return}e=e||{},d.updateUI.call(this,e),this.updateUIInner(e)},updateUIInner:function(e){let t=!1;this.getDisplayReady()&&(e.dataFilterChanged?setTimeout((()=>{this.displayData(e.reload,t)}),1):this.displayData(e.reload,t))},getWikiAttributes:function(e){this.defineWikiAttributes(["vAxisMinValue","vAxisMaxValue","vAxisExplicit"]),d.getWikiAttributes.call(this,e),"blue,red,green"!=this.colorList.join(",")&&(e.push("colors"),e.push(this.getColorList().join(", ")))},initDialog:function(){d.initDialog.call(this);let e=this,t=function(t){t&&13!=t.which&&0!=t.which||(e.vAxisMinValue=Utils.toFloat(e.jq("vaxismin").val()),e.vAxisMaxValue=Utils.toFloat(e.jq("vaxismax").val()),e.minDate=e.jq("mindate").val(),e.maxDate=e.jq("maxdate").val(),e.displayData())};["vaxismin","vaxismax","mindate","maxdate"].map((e=>{this.jq(e).blur(t),this.jq(e).keypress(t)})),this.jq(o).keypress((function(t){if(13!=t.which)return;let i=e.jq(o).val();e.colorList=i.split(","),e.displayData();e.dataCollection.getList();e.getDisplayManager().handleEventPointDataLoaded(e,e.lastPointData)})),this.jq(a).click((function(){e.setProperty("showTrendLines",HU.isChecked(e.jq(a))),e.displayData()})),this.jq(r).click((function(){e.showPercent=HU.isChecked(e.jq(r)),e.displayData()}))},setColor:function(){let e=prompt("Enter comma separated list of colors to use",this.colorList.join(","));if(null!=e){this.colorList=e.split(","),this.displayData();this.dataCollection.getList();this.getDisplayManager().handleEventPointDataLoaded(this,this.lastPointData)}},getVAxisMinValue:function(){return parseFloat(this.getProperty("vAxisMinValue",NaN))},getVAxisMaxValue:function(){return parseFloat(this.getProperty("vAxisMaxValue",NaN))},getHAxisMinValue:function(){return parseFloat(this.getProperty("hAxisMinValue",NaN))},getHAxisMaxValue:function(){return parseFloat(this.getProperty("hAxisMaxValue",NaN))},getMenuItems:function(e){d.getMenuItems.call(this,e);this.getGet();let t="0";isNaN(this.getVAxisMinValue())||(t=""+this.getVAxisMinValue());let i="";isNaN(this.getVAxisMaxValue())||(i=""+this.getVAxisMaxValue());let s=HU.formTable();s+=HU.formEntryLabel("Axis Range",HU.input("",t,[ATTR_SIZE,7,ATTR_ID,this.domId("vaxismin")])+" - "+HU.input("",i,[ATTR_SIZE,7,ATTR_ID,this.domId("vaxismax")])),s+=HU.formEntryLabel("Date Range",HU.input("",this.minDate,[ATTR_SIZE,10,ATTR_ID,this.domId("mindate")])+" - "+HU.input("",this.maxDate,[ATTR_SIZE,10,ATTR_ID,this.domId("maxdate")])),s+=HU.formEntryLabel("Colors",HU.input("",this.getColorList().join(","),[ATTR_SIZE,35,ATTR_ID,this.domId(o)])),s+=HU.close(TAG_TABLE),e.push(s)},getChartType:function(){return this.getType()},askMinZAxis:function(){this.setMinZAxis(prompt("Minimum axis value","0"))},setMinZAxis:function(e){null!=e&&(this.vAxisMinValue=parseFloat(e),this.displayData())},askMaxZAxis:function(){this.setMaxZAxis(prompt("Maximum axis value","100"))},setMaxZAxis:function(e){null!=e&&(this.vAxisMaxValue=parseFloat(e),this.displayData())},askMinDate:function(){let e=this.minDate;null!=e&&""!=e||(e="1800-01-01");let t=prompt("Minimum date",e);null!=t&&this.setMinDate(t)},setMinDate:function(e){this.minDate=e,this.displayData()},askMaxDate:function(){let e=this.maxDate;null!=e&&""!=e||(e="2100-01-01");let t=prompt("Maximum date",e);null!=t&&this.setMaxDate(t)},setMaxDate:function(e){this.maxDate=e,this.displayData()},trendLineEnabled:function(){return!1},getDialogContents:function(e,t){let i=HU.div([ATTR_ID,this.domId(ID_FIELDS),ATTR_STYLE,HU.css(CSS_OVERFLOW_Y,OVERFLOW_AUTO,CSS_MAX_HEIGHT,HU.px("600"))],"  ");this.trendLineEnabled()&&(i+=HU.div([ATTR_CLASS,"display-dialog-subheader"],"Other"),i+=HU.checkbox(this.domId(a),[],this.getShowTrendLines(),"Show trend line"),i+=" ",i+=HU.checkbox(this.domId(r),[],this.showPercent,"Show percent of displayed total"),i+=HU.br()),e.push("Fields"),t.push(i),d.getDialogContents.call(this,e,t)},okToHandleEventRecordSelection:function(){return!0},handleEventRecordHighlight:function(e,t){this.handleEventRecordSelection(e,t)},handleEventRecordSelection:function(e,t){if(d.handleEventRecordSelection.call(this,e,t),e==this)return;if(!this.okToHandleEventRecordSelection())return;let i=this.findMatchingIndex(t.record).index;i<0||!Utils.isDefined(i)||this.setChartSelection(i)},getFieldsToSelect:function(e){return this.convertedFields?this.convertedFields:e.getRecordFields()},canDoGroupBy:function(){return!1},clearCache:function(){},googleChartCallbackPending:!1,includeIndexInData:function(){return!1},getGroupBy:function(){return this.getProperty("groupByField")},getIncludeIndexIfDate:function(){return!1},makeIndexValue:function(e,t,i){return e.isString()?{v:i,f:t}:t&&t.getTime?{v:t,f:this.formatDate(t)}:t},getFieldsToDisplay:function(e){return e},displayData:function(e,t){this.displayDataInner(e,t)},displayDataInner:function(e,t){if(this.dataLoadFailed)return;t&&console.log(this.type+" displayData "+this.getId()+" "+this.type);let i=this.jq(ID_CHART).attr("isexpanded"),s=this.jq(ID_CHART).attr("original-height");if("true"===i?(this.setProperty("expandedHeight",this.jq(ID_CHART).css(CSS_HEIGHT)),this.setProperty("isExpanded",!0),this.setProperty("originalHeight",s)):(this.setProperty("expandedHeight",null),this.setProperty("isExpanded",!1),this.setProperty("originalHeight",null)),!this.getDisplayReady())return void(t&&console.log("\tdisplay not ready"));if(this.inError)return void(t&&console.log("\tin error"));if(!haveGoogleChartsLoaded())return t&&console.log("\tgoogle charts have not loaded callback pending:"+this.googleChartCallbackPending),void(this.googleChartCallbackPending||(this.googleChartCallbackPending=!0,this.setDisplayMessage(this.getLoadingMessage()),setTimeout((()=>{this.googleChartCallbackPending=!1,this.displayData()}),100)));if(this.inError)return;if(!this.hasData())return this.clearChart(),void this.setDisplayMessage(this.getLoadingMessage());this.getAcceptEventDataSelection()||this.setDisplayMessage("Creating display...");let l=this.filterData(),a=this.getSelectedFields();if(t&&console.log("\tpointData #records:"+l.length),t&&console.log("\tselectedFields:"+a),0==a.length&&null!=this.lastSelectedFields&&(a=this.lastSelectedFields,t&&console.log("\tusing last selectedFields:"+a)),null!=a&&0!=a.length||(this.getChartType()==DISPLAY_TABLE||this.getChartType()==DISPLAY_TREEMAP?(a=this.getFields().filter((e=>!e.isFieldGeo())),t&&console.log("\tfields from data collection:"+a)):(a=this.getSelectedFields(),t&&console.log("\tgetSelectedFields again:"+a),0==a.length&&this.getFields().every((e=>!(e.isNumeric()&&!e.isFieldGeo())||(a=[e],!1))))),0==a.length)return void(this.getAcceptEventDataSelection()||this.setDisplayMessage("No fields selected"));let r=[];for(let e=0;e<a.length;e++)this.shouldSkipField(a[e])||r.push(a[e]);a=r,t&&console.log("\tsetting lastSelectedFields:"+a),this.lastSelectedFields=a,this.lastSelectedFields&&this.lastSelectedFields.length>0&&this.jq(ID_TITLE_FIELD).html(this.lastSelectedFields[0].getLabel(this));let o=this.getMaxColumns(-1);if(o>0){let e=[];a.every(((t,i)=>!(i>=o)&&(e.push(t),!0))),a=e}let n={includeIndex:this.includeIndexInData(),groupByIndex:-1},h=this.getGroupBy();h&&this.getFields().every((e=>e.getId()!=h||(n.groupByIndex=e.getIndex(),n.groupByField=e,!1)));let d=a;this.raw&&(d=this.dataCollection.getList()[0].getRecordFields(),n.raw=!0),n.includeIndexIfDate=this.getIncludeIndexIfDate();let g=n.includeIndex,p=new Date;d=this.getFieldsToDisplay(d);let c=this.getStandardData(d,n),u=new Date;if(this.debugTimes&&Utils.displayTimes("chart.getStandardData",[p,u],!0),t&&console.log(this.type+" fields:"+d.length+" dataList:"+c.length),0==c.length&&!this.userHasSelectedAField){let e=this.dataCollection.getList()[0],t=this.getFieldsToSelect(e);for(let e=0;e<t.length;e++){let i=t[e];if(c=this.getStandardData([i],n),c.length>0){this.setSelectedFields([i]);break}}}if(0==c.length)return void this.setContents(this.getMessage(this.getNoDataMessage()));if(this.showPercent){let e=[],t=[],i=null,s=null;null!=this.percentFields&&(s=this.percentFields.split(","));for(let l=0;l<c.length;l++){let a=this.getDataValues(c[l]);if(0==l){i=a;continue}if(1==l){let l=!1;for(let e=0;e<a.length;e++){let i="number"==typeof a[e],r="object"==typeof a[e];i&&g&&!l&&(i=!1,l=!0),r&&(l=!0),i&&null!=s&&(i=s.indexOf(d[e].getId())>=0||s.indexOf("#"+(e+1))>=0),t.push(i)}let r=[];for(let e=0;e<i.length;e++){let s=i[e];t[e]?r.push("% "+s):r.push(s)}e.push(r)}let r=0,o=0;for(let e=0;e<a.length;e++)t[e]&&(r+=parseFloat(a[e]),o++);let n=[];for(let e=0;e<a.length;e++)if(t[e])if(0!=r){let t=parseFloat((a[e]/r*100).toFixed(1));n.push(t)}else n.push(NaN);else n.push(a[e]);e.push(n)}c=e}try{this.clearDisplayMessage();let e=new Date;this.makeGoogleChart(c,n,a);let t=new Date;this.debugTimes&&Utils.displayTimes("chart.makeGoogleChart",[e,t],!0)}catch(e){return this.handleError("Error making chart:"+e,e),void this.setIsFinished()}this.setIsFinished();let T=this.jq(ID_CHART);if(this.jq(ID_CHART).is(":visible")?this.lastWidth=T.width():this.lastWidth=-1,e){let e=this.getData();if(e){let t=e.getRecords();if(t.length>0){let e=t[0];this.propagateEventRecordSelection({record:e})}}}},printDataList:function(e){console.log("data list:"+e.length);for(let t=0;t<e.length;t++){let i=e[t],s="";for(let e=0;e<i.length;e++)e>0&&(s+=", "),s+=i[e];console.log("row: "+t+"  "+s)}},mapCharts:function(e){null!=this.charts&&this.charts.map((t=>{e(t)}))},clearChart:function(){this.chart&&(this.chart.clearChart(),this.chart=null),this.mapCharts((e=>{e.clearChart&&e.clearChart()})),this.charts=[]},setChartSelection:function(e){Array.isArray(e)||(e=[e]);let t=e.map((e=>({row:e,column:null})));this.mapCharts((e=>{e.setSelection&&e.setSelection(t)}))},tableHeaderMouseover:function(e,t){},doAddTooltip:function(){return!0},getAddStyle:function(){return!0},getFormatNumbers:function(){return!1},getDataTableValueGetter:function(){return e=>e},getHighlightFields:function(){this.getPropertyFromUrl("highlightFields");return Utils.split(this.getPropertyFromUrl("highlightFields"),",",!0,!0)||[]},handleEventPropertyChanged:function(e,t){if("dateRange"==t.property){let e=this.findClosestDate(t.minDate).index,i=this.findClosestDate(t.maxDate).index;e>=0&&this.getAcceptDateRange()&&this.setChartSelection([e,i])}else if("highlightFields"==t.property){if(this.getProperty("acceptHighlightFieldsEvent",!0)){this.setProperty("highlightFields",t.value),this.forceUpdateUI();let e=Utils.split(t.value,",",!0,!0);this.jq(h).val(e)}return}d.handleEventPropertyChanged.call(this,e,t)},makeSeriesInfo:function(e){let t=[];for(let i=1;i<e.getNumberOfColumns();i++)""==e.getColumnRole(i)&&t.push(e.getColumnLabel(i));let i=this.getColorList(),s={},l=this.getHighlightFields(),a=this.getProperty("highlightDim",!1);l.forEach((e=>{s[e]=!0}));let r={},o=this.getProperty("useMultipleAxes",!0),d={};if(this.getExtraLines(null,"extraMap").forEach((e=>{let t=Utils.makeId(e.label);d[t]=e})),t.forEach(((e,t)=>{if((e=e.replace(/\(.*\)/g,"")).indexOf("<")>=0)return;let n=Utils.makeId(e),h=s[n],g={};d[n];["labelInLegend","seriesType","lineDashStyle","pointSize","lineWidth","color","pointShape"].forEach((e=>{let t=this.getProperty((h?"highlight.":"nohighlight.")+e,this.getProperty(e));"pointSize"==e&&(t=this.getPointSize());let i=this.getProperty(n+"."+e,null);if(Utils.isDefined(i)||(i=this.getProperty(n.replace(/_/g,"")+"."+e,null)),Utils.isDefined(i)||(i=t),d[n]&&d[n][e]&&(i=d[n][e]),Utils.isDefined(i)&&"lineDashStyle"==e){let e=[],t=",";i.indexOf(";")>=0&&(t=";"),Utils.split(i,t,!0,!0).forEach((t=>{e.push(parseFloat(t))})),i=e}"seriesType"==e&&(e="type"),g[e]=i,"none"==i&&("pointShape"==e&&(g.pointsVisible=!1),delete g[e])})),g.color||(g.color=i[t%i.length]),l.length>0&&!h&&a&&(g.color=Utils.pSBC(.75,g.color)),o&&(g.targetAxisIndex=t%2==0?0:1),r[t]=g})),this.getProperty("highlightShowFields",!1)&&(0==this.jq(n).length&&this.jq(ID_HEADER2).append(HU.span([ATTR_ID,this.domId(n)])),0==this.jq(h).length)){let e=[];t.forEach((t=>{e.push([Utils.makeId(t),t])})),e.sort(((e,t)=>e[1].localeCompare(t[1])));let i=SPACE+HU.vbox(["Highlight",HU.select("",[ATTR_ID,this.domId(h),ATTR_MULTIPLE,!0,ATTR_SIZE,this.getProperty("highlightShowFieldsSize","3")],e,l)]),s=HU.span([ATTR_CLASS,CLASS_DISPLAY_FILTER],i);this.jq(n).html(s),this.jq(h).change((()=>{let e=Utils.makeArray(this.jq(h).val());e=Utils.join(e,","),this.setProperty("highlightFields",e),this.addToDocumentUrl("highlightFields",e),this.forceUpdateUI();let t={property:"highlightFields",value:e};this.propagateEvent(DisplayEvent.propertyChanged,t)}))}return r},makeTrendlinesInfo:function(e){let t=[];for(let i=1;i<e.getNumberOfColumns();i++)""==e.getColumnRole(i)&&t.push(e.getColumnLabel(i));let i={};return t.forEach(((e,t)=>{let s=Utils.makeId(e);if(this.getProperty("showTrendline."+s,this.getShowTrendLines())){let e={};i[t]=e,e.type=this.getProperty("trendlineType."+s,this.getProperty("trendlineType")),e.visibleInLegend=this.getProperty("trendlineVisibleInLegend."+s,this.getProperty("trendlineVisibleInLegend")),e.color=this.getProperty("trendlineColor."+s,this.getProperty("trendlineColor","red")),e.lineWidth=this.getProperty("trendlineLineWidth."+s,this.getProperty("trendlineLineWidth",2)),e.opacity=this.getProperty("trendlineOpacity."+s,this.getProperty("trendlineOpacity"))}})),i},getExtraLines:function(e,t){this.extraLines=[];let i,s=0;for(e&&(i={},e.forEach((e=>{i[e.getId()]=!0})));this.getProperty("fixedLine"+s);){let e={color:this.getProperty("fixedLine.color","blue"),lineWidth:this.getProperty("fixedLine.lineWidth",2),pointShape:this.getProperty("fixedLine.pointShape",null),label:"value "+s,value:0},t=null;Utils.split(this.getProperty("fixedLine"+s),",",!0,!0).forEach((i=>{let s=Utils.split(i,":");if(2!=s.length)return;let l=s[0],a=s[1];"depends"==l&&(t=a),"value"==l?e.value=+a:e[l]=a})),isNaN(e.value)||t&&i&&!i[t]||this.extraLines.push(e),s++}return this.extraLines},makeDataTable:function(e,t,s,l){let a=this.getExtraLines(s,"makeDataTable"),r=this.getProperty("indexIsString",this.getProperty("forceStrings",!1)),o=this.getProperty("useStringInLegend");this.getPropertyCount=0,this.getPropertyCounts={};let n=this.getProperty("dateType","date"),h=displayDebug.makeDataTable,d=1;d=2,h&&this.logMsg(this.type+" makeDataTable #records:"+e.length);let g=this.getReplaceNanWithZero(),p=this.getProperty("maxFieldLength",this.getProperty("maxFieldWidth",-1)),c=this.getProperty("tooltip"),u=Utils.stringDefined(c);this.getProperty("addTooltip",!0)&&this.doAddTooltip()||(u=!1),this.getDoDyamicTooltip()&&(u=!1);let T=this.getAddStyle(),f=this.getAnnotationTemplate(),y=this.getFormatNumbers();if(1==e.length)return google.visualization.arrayToDataTable(this.makeDataArray(e));let m=this.getFieldById(null,this.getProperty("groupBy"));if(m){e=this.filterData();let t=[],i={},a=0,r={},o=[];h&&console.log("\trecord[0]:"+e[0]),e.map(((e,l)=>{if(0==a++)return;let n=this.getDataValues(e),h=n[m.getIndex()];i[h]||(i[h]=!0,i[Utils.makeId(h)]=!0,t.push(h));let d=r[e.getDate()];d||(o.push(e.getDate()),d={},r[e.getDate()]=d),d[h]=n[s[0].getIndex()]}));let n=[],d=[],g=this.getHighlightFields(),p={};g.forEach((e=>{i[e]&&d.push(Utils.makeLabel(e))})),t=Utils.mergeLists(d,t),t=t.filter((e=>!p[e]&&(p[e]=!0,!0))),o.map((e=>{let i=[this.getDateValue(e)];n.push(i);let s=r[e];t.map((e=>{let t=s[e];i.push(t)}))}));let c=Utils.mergeLists(["Date"],t);h&&console.log("\theader:"+c);let u=new google.visualization.DataTable;if(n.length>0){n[0].forEach(((e,t)=>{let i=c[t],s=null==e?"number":typeof e;"number"==s?(h&&console.log("\tadd column:"+i+" type: number"),u.addColumn("number",i)):"string"==s?(h&&console.log("\tadd column:"+i+" type: string"),u.addColumn("string",i)):e.getTime||e.v&&e.v.getTime?(h&&console.log("\tadd column:"+i+" type: date"),u.addColumn("date",i)):(console.log("\tUnknown type:"+e),console.log(JSON.stringify(e,null,2)))}))}return u.addRows(n),l&&(l.series=this.makeSeriesInfo(u),l.trendlines=this.makeTrendlinesInfo(u)),u}let _=[],S=this.getFieldsByIds(null,this.getProperty("tooltipFields","")),A=new google.visualization.DataTable,I=this.getDataValues(e[0]),b=this.getDataValues(e[1]),R=this.getProperty("fixedValue"),D=R?parseFloat(R):NaN,L=0,U=this.getProperty("maxHeaderLength",-1),C=this.getProperty("maxHeaderWidth",-1),E=this.getProperty("chartHeaderStyle");for(let e=0;e<I.length;e++){let i=null;(e>0||!t.includeIndex)&&(i=s[L++]);let l=b[e],a=I[e];if(U>0&&a.length>U){let e=a;a=a.substring(0,U-1)+"...",a=HU.span([ATTR_TITLE,e],a)}if(C>0||E){let e=a,t="";C>0&&(a=a.replace(/ /g,SPACE)),C>0&&(t+=HU.css(CSS_MAX_WIDTH,HU.px(C),CSS_OVERFLOW_X,OVERFLOW_AUTO)),E&&(t+=E),a=HU.div([ATTR_TITLE,e,ATTR_STYLE,t],a)}if(0==e&&t.includeIndex)"object"==typeof l?"number"==typeof l.v?r?(h&&console.log("\tadd column:"+a+" type: string"),o?A.addColumn("string",a):A.addColumn("number",a)):(h&&console.log("\tadd column:"+a+" type: number"),A.addColumn("number",a)):(h&&console.log("\tadd column:"+a+" type: "+n),A.addColumn(n,a)):(h&&console.log("\tadd column:"+a+" type: "+typeof l+" sample:"+l),A.addColumn(typeof l,a));else if(e>0&&R?(h&&console.log("\tadd column: fixedValue type: number"),A.addColumn("number",this.getProperty("fixedValueLabel","Count"))):i.isString()||i.isBoolean()?(h&&console.log("\tadd column: "+a+" type: string"),A.addColumn("string",a)):i.isFieldDate()?(h&&console.log("\tadd column: "+a+" type: "+n),A.addColumn(n,a)):(h&&console.log("\tadd column: "+a+" type: number"),A.addColumn("number",a)),this.extraLines.forEach((e=>{A.addColumn("number",e.label)})),f&&(h&&console.log("\tadd column: annotation"),A.addColumn({type:"string",role:"annotation",id:"annotation",p:{html:!0}})),T&&(h&&console.log("\tadd style column"),A.addColumn({type:"string",role:"style"})),e>0&&R)break;u&&(h&&console.log("\tadd tooltip column"),A.addColumn({type:"string",role:"tooltip",p:{html:!0}}))}if(h){console.log("columns:");for(let e=0;e<A.getNumberOfColumns();e++)console.log("\tcol["+e+"]="+A.getColumnLabel(e)+" role:"+A.getColumnRole(e)+" type:"+A.getColumnType(e))}let H=this.getAnnotationStride(0),P=this.getAnnotationLabelTemplate(),x=0;if(Utils.stringDefined(this.getProperty("annotations"))||Utils.stringDefined(this.getProperty("annotationFields"))){let t=Utils.cloneList(e);t.shift(),this.annotations=new Annotations(this,t),this.annotations.hasFields()&&(A.addColumn({type:"string",role:"annotation",id:"annotation",p:{html:!0}}),A.addColumn({type:"string",role:"annotationText",p:{html:!0}}))}this.annotations?.isEnabled()&&(this.annotations.getShowLegend()&&this.jq(ID_LEGEND).html("<table width=100%><tr valign=top><td width=10%></td><td width=90%>"+HU.div([ATTR_CLASS,"display-chart-legend"],this.annotations.getLegend())+HU.close(TAG_TD,TAG_TR,TAG_TABLE)),A.addColumn({type:"string",role:"annotation",id:"annotation",p:{html:!0}}),A.addColumn({type:"string",role:"annotationText",p:{html:!0}}));let v=[new Date],O=[];for(let t=1;t<e.length;t++)O.push(e[t].record);this.getColorTable(!0);let N=this.getColorByInfo(O),w=this.getDataTableValueGetter(O),M=!1;for(let l=1;l<e.length;l++){let n=e[l],d=this.getDataValues(n),m=n.record,A="";if(N.index>=0){let e=m.getData()[N.index];hasColorByValue=!0,colorByValue=e,M=!0,A=N.getColorFromRecord(m)}d=d.slice(0);let b=[];h&&l<2&&console.log("row["+l+"]:");let L=0,U=!0,C=this.getSkipMissing();for(let e=0;e<d.length;e++){let i=s[L++],n=d[e];if(r&&Utils.isDefined(n.f)){let e=n.f.toString().replace(/\n/g," ");0==e.trim().length&&(e="<blank>"),p>0&&e.length>p&&(e=e.substring(0,p)+"..."),n.f=e}if(e>0&&R)b.push(w(D,e,i,m)),h&&l<2&&console.log("\t fixed:"+D);else{let t=typeof n;if("number"==t){if(C&&isNaN(n)){U=!1;break}y&&(n={v:n,f:String(this.formatNumber(n))},g&&isNaN(n.v)&&(n.v=0))}else"boolean"==t&&(n=String(n));if(h&&l<2){n.f&&(n.f,n.v)}p>0&&"string"==t&&n.length>p&&(n=n.substring(0,p)+"...");let s=w(n,e,i,m);0==e&&o&&Utils.isDefined(s.f)&&(s=s.f),b.push(s)}if(0==e&&t.includeIndex);else{if(a.forEach((e=>{b.push(e.value)})),f){let e=f.replace("${value}",n.f||n);h&&l<2&&console.log("\t annotation"+e),b.push(e)}T&&(b.push(A),h&&l<2&&console.log("\t color:"+A))}if(e>0&&R)break;if(u){let e="";if(c)e=this.getRecordHtml(m,null,c);else{let t="";if(m)for(let e=0;e<S.length;e++)t+=HU.boldLabel(S[e].getLabel(this))+m.getValue(S[e].getIndex())+HU.br();e+=t;for(let i=0;i<d.length;i++)i>0&&(e+=HU.br()),t=I[i].replace(/ /g,SPACE),n=d[i],Utils.isDefined(n)||(n="NA"),n&&n.f&&(n=n.f),Utils.isNumber(n)&&(n=this.formatNumber(n)),n=""+n,n=n.replace(/ /g,SPACE),e+=HU.b(t)+":"+SPACE+n}e=HU.div([ATTR_STYLE,HU.css(CSS_PADDING,HU.px(8))],e),b.push(e),h&&l<2&&console.log("\t added tooltip")}}if(U){if(this.annotations?.hasFields())if(m){let e="";this.annotations.getFields().forEach((t=>{let i=HU.b(t.getLabel())+": "+t.getValue(m);""!=i&&(e+=i+HU.br())})),e=e.trim(),e=e.replace(/ /g,SPACE),x++;let t=null;P?t=this.applyRecordTemplate(m,null,null,P):e.trim().length>0&&(t=""+(this.annotations.labelField?m.getValue(this.annotations.labelField.getIndex()):"#"+x),0==t.trim().length&&(t="#"+x)),h&&l<2&&(console.log("\t label:"+t),console.log("\t desc:"+e)),H<=0||x%H==0?(b.push(t),b.push(e)):(b.push(null),b.push(null))}else i<2&&console.log("No records for annotation");if(this.annotations&&this.annotations.isEnabled()){let e=this.annotations.getAnnotationsFor(l);if(e){h&&l<2&&console.log("\t annotation:"+e);let t="",i="";e.forEach((e=>{""!=t&&(t+="/"),t+=e.label,""!=i?i+=HU.br():e.record&&e.record.getDate()&&(i+=HU.b(this.formatDate(e.record.getDate()))+HU.br()),i+=e.description})),b.push(t),b.push(i)}else h&&l<2&&(console.log("\t annotation:null"),console.log("\t desc:null")),b.push(null),b.push(null);h=!1}_.push(b)}}return h&&console.log("#rows:"+_.length),v.push(new Date),A.addRows(_),M&&N.displayColorTable(),l&&(l.isStacked||(l.series=this.makeSeriesInfo(A)),l.trendlines=this.makeTrendlinesInfo(A)),this.debugTimes&&Utils.displayTimes("makeDataTable",v,!0),A},makeChartOptions:function(e,t,i){let s={annotations:{style:this.getAnnotationStyle(),textStyle:{fontSize:this.getAnnotationSize(16),color:this.getAnnotationColor(),auraColor:this.getAnnotationAuraColor(),bold:this.getAnnotationBold(),italic:this.getAnnotationItalic()},stem:{color:this.getAnnotationStemColor(),length:100}},interpolateNulls:this.getInterpolateNulls(),tooltip:{isHtml:!0,trigger:"focus"}};$.extend(s,{width:"100%",lineWidth:this.getProperty("lineWidth",1),colors:this.getColorList(),curveType:this.curveType,pointShape:this.getProperty("pointShape"),pointSize:this.getProperty("pointSize"),vAxis:{}}),s.backgroundColor={},s.chartArea={},s.chartArea.backgroundColor={},s.legend={textStyle:{}},s.hAxis={gridlines:{},minorGridlines:{},textStyle:{}},s.xannotations={textStyle:{fontSize:this.getProperty("annotationsFontSize",12),color:this.getProperty("annotationsTextColor")},stem:{color:this.getProperty("annotationsStemColor"),length:this.getProperty("annotationsStemLength")},style:this.getProperty("annotationsStyle")},this.getDragToZoom()?s.explorer={actions:["dragToZoom","rightClickToReset"],axis:"horizontal",keepInBounds:!0,maxZoomIn:4}:this.getDragToPan()&&(s.explorer={axis:"horizontal",keepInBounds:!0,maxZoomIn:4}),s.vAxis={gridlines:{},minorGridlines:{},textStyle:{}},this.getProperty("vAxisReverse")&&(s.vAxis.direction=-1),s.hAxis.minValue=this.getProperty("hAxisMinValue"),s.hAxis.maxValue=this.getProperty("hAxisMaxValue"),s.vAxis.minValue=this.getProperty("vAxisMinValue"),s.vAxis.maxValue=this.getProperty("vAxisMaxValue"),this.getProperty("vAxisExplicit")&&(s.vAxis.viewWindowMode="explicit",s.vAxis.viewWindow={max:s.vAxis.maxValue,min:s.vAxis.minValue}),s.vAxis.logScale=this.getProperty("vAxisLogScale",this.getProperty("logScale")),s.hAxis.logScale=this.getProperty("hAxisLogScale"),s.hAxis.titleTextStyle={},s.vAxis.titleTextStyle={},this.getProperty("hAxisDateFormat")&&(s.hAxis.format=this.getProperty("hAxisDateFormat"));let l=this.getProperty("lineColor"),a=this.getProperty("chartBackground");this.setPropertyOn(s.backgroundColor,"chart.fill","fill",a),this.setPropertyOn(s.backgroundColor,"chart.stroke","stroke",this.getProperty("chartArea.fill","")),this.setPropertyOn(s.backgroundColor,"chart.strokeWidth","strokeWidth",null),this.setPropertyOn(s.chartArea.backgroundColor,"chartArea.fill","fill",a),this.setPropertyOn(s.chartArea.backgroundColor,"chartArea.stroke","stroke",null),this.setPropertyOn(s.chartArea.backgroundColor,"chartArea.strokeWidth","strokeWidth",null);let r=this.getProperty("minorGridLines.color",this.getProperty("gridlines.color")||l||COLOR_TRANSPARENT);this.setPropertyOn(s.hAxis.gridlines,"hAxis.gridlines.color","color",this.getProperty("gridlines.color")||l),this.setPropertyOn(s.hAxis.minorGridlines,"hAxis.minorGridlines.color","color",r),this.setPropertyOn(s.hAxis,"hAxis.baselineColor","baselineColor",this.getProperty("baselineColor")||l),this.setPropertyOn(s.vAxis.gridlines,"vAxis.gridlines.color","color",this.getProperty("gridlines.color")||l),this.setPropertyOn(s.vAxis.minorGridlines,"vAxis.minorGridlines.color","color",r),this.setPropertyOn(s.vAxis,"vAxis.baselineColor","baselineColor",this.getProperty("baselineColor")||l);let o,n=this.getTextColor(),h=this.getTextBold(),d=this.getTextItalic(),g=this.getTextFontName(),p=this.getTextFontSize();if(this.setPropertyOn(s.hAxis.textStyle,"hAxis.text.color","color",this.getProperty("axis.text.color",n)),this.setPropertyOn(s.vAxis.textStyle,"vAxis.text.color","color",this.getProperty("axis.text.color",n)),this.setPropertyOn(s.hAxis.textStyle,"hAxis.text.bold","bold",h),this.setPropertyOn(s.vAxis.textStyle,"vAxis.text.bold","bold",h),this.setPropertyOn(s.hAxis.textStyle,"hAxis.text.italic","italic",d),this.setPropertyOn(s.vAxis.textStyle,"vAxis.text.italic","italic",d),this.setPropertyOn(s.hAxis.textStyle,"hAxis.text.fontName","fontName",g),this.setPropertyOn(s.vAxis.textStyle,"vAxis.text.fontName","fontName",g),this.setPropertyOn(s.hAxis.textStyle,"hAxis.text.fontSize","fontSize",p),this.setPropertyOn(s.vAxis.textStyle,"vAxis.text.fontSize","fontSize",p),s.vAxis.title=Utils.decodeText(this.getProperty("vAxis.text",this.getProperty("vAxisText",this.getVAxisTitle()))),s.hAxis.title=Utils.decodeText(this.getProperty("hAxis.text",this.getProperty("hAxisText",this.getHAxisTitle()))),s.hAxis.slantedText=this.getProperty("hAxis.slantedText",this.getProperty("slantedText",!1)),this.setPropertyOn(s.hAxis.titleTextStyle,"hAxis.text.color","color",n),this.setPropertyOn(s.vAxis.titleTextStyle,"vAxis.text.color","color",n),this.setPropertyOn(s.legend.textStyle,"legend.text.color","color",n),s.hAxis.viewWindow={},Utils.isDefined(this.getProperty("hAxisViewMin"))&&(s.hAxis.viewWindow.min=+this.getProperty("hAxisViewMin")),Utils.isDefined(this.getProperty("hAxisViewMax"))&&(s.hAxis.viewWindow.max=+this.getProperty("hAxisViewMax")),o=this.getProperty("hAxis.ticks"),o||""==o){let e=this.getProperty("hAxis.tickTemplate","${value}"),t=Utils.split(this.getProperty("hAxis.ticks"),",",!0,!0);t=t.map((t=>{let i,s=t.split(":");return s.length>1?(t=s[0],i=s[1]):i=e.replace("${value}",t),{v:t,f:i}})),s.hAxis.ticks=t}if(o=this.getProperty("vAxis.ticks"),o||""==o){let e=this.getProperty("vAxis.tickTemplate","${value}"),t=Utils.split(this.getProperty("vAxis.ticks"),",",!0,!0);t=t.map((t=>({v:t,f:e.replace("${value}",t)}))),s.vAxis.ticks=t}this.getHAxisHideTicks()&&(s.hAxis.ticks=[]),this.getVAxisHideTicks()&&(s.vAxis.ticks=[]),p>0&&(s.fontSize=p);let c=[],u=[];e.forEach(((e,t)=>{if(0==t)return;let i=this.getDataValues(e);1==t&&(i.forEach(((e,t)=>{u.push("number"==typeof e)})),u.forEach((e=>c.push([Number.MAX_VALUE,Number.MIN_VALUE]))));let s=0;i.forEach(((e,t)=>{u[t]&&(c[s][0]=Math.min(c[s][0],e),c[s][1]=Math.max(c[s][1],e),s++)}))}));let T=[NaN,NaN];isNaN(this.getVAxisMinValue())?c.length>0&&this.getProperty("vAxisUseDefault")&&(T[0]=c[0][0]):T[0]=this.getVAxisMinValue(),isNaN(this.getVAxisMaxValue())?c.length:T[1]=this.getVAxisMaxValue(),isNaN(T[0])||(s.vAxis.minValue=T[0]),isNaN(T[1])||(s.vAxis.maxValue=T[1]),this.chartDimensions={width:"90%",left:"10%",right:10},useMultipleAxes=this.getProperty("useMultipleAxes",!0),(i.length>1&&useMultipleAxes||!0===this.getProperty("padRight",!1))&&(this.chartDimensions.width="80%"),this.getShowTrendLines()&&(s.trendlines={0:{type:"linear",color:"green"}});let f=this.getProperty("expandedHeight");return f&&(s.height=f),this.getPropertyShow&&(this.getPropertyShow=!1,Utils.makeDownloadFile("props.txt",this.getPropertyOutput)),this.setContents(HU.div([ATTR_ID,this.domId(ID_CHARTS)])),s},getChartHeight:function(e){return this.getProperty("chartHeight",this.getProperty("height",e))},getChartWidth:function(){return this.getProperty("chartWidth",this.getProperty("width"))},getChartDiv:function(e){let t=[ATTR_ID,e],i="";this.getChartWidth();let s=this.getProperty("expandedHeight"),l=this.getChartHeight();i+=s?HU.css(CSS_HEIGHT,s):l?l>0?HU.css(CSS_HEIGHT,HU.px(l)):l<0?HU.css(CSS_HEIGHT,HU.perc(-l)):HU.css(CSS_HEIGHT,l):HU.css(CSS_HEIGHT,HU.perc(100)),t.push(ATTR_STYLE,i,ATTR_CLASS,"ramadda-expandable-target");let a=this.getProperty("isExpanded"),r=this.getProperty("originalHeight");return a&&(t.push("isexpanded","true"),t.push("original-height",r)),this.getProperty("expandableHeight")&&(t.push("expandable-height"),t.push(this.getProperty("expandableHeight"))),HU.div(t,"")},doMakeGoogleChart:function(e,t,i,s,l){throw new Error("doMakeGoogleChart undefined")},makeGoogleChart:function(e,t,i){this.doMakeGoogleChartInner(e,t,i)},setAxisRanges:function(e,t,i){if(this.getProperty("hAxisFixedRange")){let s=this.getColumnValues(i,t[0]);e.hAxis.minValue=s.min,e.hAxis.maxValue=s.max}let s={},l=(e,t,i)=>Utils.getProperty(this.getProperty(e.getId()+"."+t,this.getProperty(t,i))),a={};t.forEach(((e,t)=>{let i=this.getProperty(e.getId()+".vAxisMinValue"),r=this.getProperty(e.getId()+".vAxisMaxValue"),o={};Utils.isDefined(i)&&(o.min=parseFloat(i)),Utils.isDefined(r)&&(o.max=parseFloat(r));let n=s[t]={viewWindow:o};a[e.getId()]=n,n.title=l(e,"vAxisTitle");let h=n.textStyle={};h.color=l(e,"vAxis.text.color"),h.fontSize=l(e,"vAxis.text.fontSize"),h.fontName=l(e,"vAxis.text.fontName"),h.bold=l(e,"vAxis.text.bold"),h.italic=l(e,"vAxis.text.italic")}));let r=t.length;if(this.getExtraLines(t,"minmax").forEach(((e,t)=>{let i={};e.depends&&a[e.depends]&&(i=$.extend(i,a[e.depends].viewWindow)),Utils.isDefined(e.axisMin)&&(i.min=parseFloat(e.axisMin)),Utils.isDefined(e.axisMax)&&(i.max=parseFloat(e.axisMax));s[r+t]={viewWindow:i}})),e.vAxes=s,this.getProperty("vAxisFixedRange")||this.getProperty("vAxisSelectedFields")||this.getProperty("vAxisAllFields")){let s=Number.MAX_VALUE,l=Number.MIN_VALUE;(this.getProperty("vAxisAllFields")?this.getFields():t).forEach((e=>{if(e.isFieldNumeric()){let t=this.getColumnValues(i,e);isNaN(t.min)||(s=Math.min(s,t.min)),isNaN(t.max)||(l=Math.max(l,t.max))}})),s!=Number.MAX_VALUE&&(e.vAxis.minValue=s,e.vAxis.maxValue=l)}},doMultiChartsByField:function(){return this.getProperty("doMultiChartsByField")},makeMultiChart:function(e,t,i,s){let l=HU.css(CSS_WIDTH,HU.px(200))+this.getProperty("multiStyle",""),a=this.getProperty("multiLabelTemplate","${value}"),r=this.getProperty("multiChartsLabelPosition","bottom"),o=this.chartOptions;this.chartOptions=$.extend({},this.chartOptions),e=a.replace("${value}",e);let n=HU.div([ATTR_CLASS,"display-multi-header"],e),h="top"==r?n:"",d="bottom"==r?n:"",g=this.domId(ID_CHART)+"_"+this.chartCount,p=HU.div([ATTR_CLASS,"display-multi-div",ATTR_STYLE,HU.css(CSS_DISPLAY,DISPLAY_INLINE_BLOCK)+l],h+this.getChartDiv(g)+d);this.jq(ID_CHARTS_INNER).append(p);let c=this.makeGoogleChartInner(t,g,s,i);return c&&(this.charts.push(c),c.chartOptions=this.chartOptions),this.chartOptions=o,c},doMakeGoogleChartInner:function(e,t,i){if("undefined"==typeof google)return void this.setDisplayMessage("No google");this.chartOptions=this.makeChartOptions(e,t,i),this.chartOptions.bar={groupWidth:"95%"},Utils.isDefined(this.chartOptions.height)||(this.chartOptions.height="100%"),this.charts=[],this.chartCount=-1;let s=this.getPointData().getRecords();if(this.setAxisRanges(this.chartOptions,i,s),this.clearChart(),this.getProperty("doMultiCharts",this.getProperty("multipleCharts",!1))){if(this.jq(ID_CHARTS).html(HU.div([ATTR_ID,this.domId(ID_CHARTS_INNER),ATTR_STYLE,HU.css(CSS_TEXT_ALIGN,ALIGN_CENTER)])),this.doMultiChartsByField())return this.multiChartData=[],void i.forEach(((e,i)=>{this.chartCount=i;let s=this.getStandardData([e],t),l=this.makeMultiChart(e.getLabel(),s,[e],t);this.multiChartData.push({props:t,fields:[e],dataList:s,field:e,chartOptions:l.chartOptions,chart:l})}));let s=this.getFieldById(null,this.getProperty("multiField")),l={},a=[],r=[];e.forEach(((e,t)=>{t>0&&r.push(e)})),s||r.sort((function(e,t){let i=e.record?e.record.getDate():e.date,s=t.record?t.record.getDate():t.date;return i.getTime()-s.getTime()})),(e=Utils.mergeLists([e[0]],r)).forEach(((e,t)=>{if(0==t)return;let i=e.record,r=i?s?i.getValue(s.getIndex()):i.getDate():e.date,o=null;o=l[r],o||(o=[],l[r]=o,a.push(r)),o.push(e)})),s&&a.sort(),a.forEach(((s,a)=>{this.chartCount=a;let r=[],o=l[s];r.push(e[0]),r=Utils.mergeLists(r,o);let n=s;s.getTime&&(n=this.formatDate(s)),this.makeMultiChart(n,r,i,t)}))}else{this.jq(ID_CHARTS).append(this.getChartDiv(this.domId(ID_CHART)));let s=this.makeGoogleChartInner(e,this.domId(ID_CHART),t,i);s&&this.charts.push(s)}},drawChart:function(e,t,i){e.draw(t,i)},makeGoogleChartInner:function(e,t,i,s){let l=document.getElementById(t);if(!l)return void this.logMsg("makeGoogleChart: no chart div found:"+t);let a=this.makeDataTable(e,i,s,this.chartOptions),r=this.doMakeGoogleChart(e,i,l,s,this.chartOptions);if(null==r)return null;if(!a)return this.setDisplayMessage(this.getNoDataMessage()),null;if(this.getProperty("vAxisSharedRange")){this.getProperty("indexIsString",this.getProperty("forceStrings",!1));let e=NaN,t=NaN;for(let i=0;i<a.getNumberOfColumns();i++){if(0==i)continue;if("number"!=a.getColumnType(i))continue;let s=a.getColumnRange(i);s={min:NaN,max:NaN},a.getDistinctValues(i).forEach((i=>{isNaN(i)||(e=Utils.min(e,i),t=Utils.max(t,i))}))}if(this.getExtraLines(s,"minmax").forEach((i=>{e=Utils.min(e,i.value),t=Utils.max(t,i.value)})),!isNaN(e)&&!isNaN(t)){let i=t-e;e-=.1*i,t+=.1*i,Utils.isDefined(this.getProperty("vAxisMinValue"))&&(e=+this.getProperty("vAxisMinValue")),Utils.isDefined(this.getProperty("vAxisMaxValue"))&&(t=+this.getProperty("vAxisMaxValue")),this.chartOptions.vAxis.minValue=e,this.chartOptions.vAxis.maxValue=t}}if(this.getDoDyamicTooltip()&&(this.chartOptions.tooltip={trigger:"none"}),this.getAnimateChart(this.getProperty("animation",!1,!0)))this.chartOptions.animation={startup:!0,duration:parseFloat(this.getAnimationDuration()),easing:this.getAnimationEasing()},HU.callWhenScrolled(this.domId(ID_CHART),(()=>{this.animationCalled||(this.animationCalled=!0,this.mapCharts((e=>{this.drawChart(e,a,this.chartOptions)})))}));else try{this.debugChartOptions&&console.log(JSON.stringify(this.chartOptions,null,2)),this.chart=r,this.dataTable=a;let e=google.visualization.arrayToDataTable([["Genre","Fantasy & Sci Fi","Western"],["2010",10,24],["2020",16,22],["2030",28,19]]);new Date;this.drawChart(r,this.useTestData?e:a,this.chartOptions)}catch(e){return this.handleError("Error creating chart:"+e,e),null}return this.addEvents(r,a),r},addDynamicTooltip:function(e,t,i){let s=i.row,l=this.indexToRecord[s];if(!l)return;if(!this.tooltipEvent)return;let a=this.tooltipDiv;this.tooltipDiv||(a=this.tooltipDiv=document.createElement(TAG_DIV),a.style.position=POSITION_ABSOLUTE,document.body.appendChild(a));let r=this.getProperty("tooltip"),o=HU.css(CSS_FONT_SIZE,HU.perc(80))+this.getTooltipStyle(""),n=HU.div([ATTR_CLASS,"display-tooltip display-chart-tooltip",ATTR_STYLE,o],this.getRecordHtml(l,null,r));a.innerHTML=n;let h=e.getContainer().getBoundingClientRect(),d=this.tooltipEvent.pageX,g=this.tooltipEvent.pageY;d=+this.getTooltipX(d),g=+this.getTooltipY(g);let p=h.left+h.width;d+400>p&&(d=p-400),a.style.left=HU.px(d),a.style.top=HU.px(g+20),a.style.display=DISPLAY_BLOCK},getDoDyamicTooltip:function(){return this.getDynamicTooltip()},addEvents:function(e,t){let i=this;if(this.getDoDyamicTooltip()){let i=e.getContainer();i&&i.addEventListener("mousemove",(e=>{this.tooltipEvent=e})),google.visualization.events.addListener(e,"onmouseover",(i=>{this.addDynamicTooltip(e,t,i)})),google.visualization.events.addListener(e,"onmouseout",(e=>{this.tooltipDiv&&(this.tooltipDiv.style.display=DISPLAY_NONE)}))}this.getProperty("propagateHighlightEvent")&&google.visualization.events.addListener(e,"onmouseover",(function(e){pointData=i.dataCollection.getList()[0];pointData.getRecordFields();let t=pointData.getRecords()[e.row];t&&i.getDisplayManager().notifyEvent(DisplayEvent.recordHighlight,i,{highlight:!0,record:t})})),google.visualization.events.addListener(e,"select",(function(e){i.mapCharts((e=>{if(e.getSelection){let t=e.getSelection();if(t&&t.length>0){let e=t[0].row,s=i.indexToRecord[e];if(s){let e=i.getBinnedRecords(s);e?1==e.length?i.propagateEventRecordSelection({record:e[0]}):i.propagateEventRecordSelection({record:e[0],records:e}):i.propagateEventRecordSelection({record:s})}}}}))}))}})}function RamaddaAxisChart(e,t,i,s){let l=new RamaddaGoogleChart(e,t,i,s),a=[{label:"Chart Properties"},{p:"indexField",ex:"field",tt:"alternate field to use as index"},{p:"indexIsString",ex:"true",tt:"if index is a string set to true"},{p:"useStringInLegend",ex:"true",tt:"if index is a string then add the string value to the data"},{p:"vAxisMinValue",ex:""},{p:"vAxisMaxValue",ex:""},{p:"vAxisExplicit",ex:!0,tt:"use the min/max values explicitly"},{p:"&lt;field&gt;.vAxisMinValue",ex:"",tt:"Min value for the field"},{p:"&lt;field&gt;.vAxisMaxValue",ex:"",tt:"Max value for the field"},{p:"vAxisSharedRange",ex:"true",tt:"use the same max value across all time series"},{p:"vAxisReverse",ex:"true",tt:"Reverse the v axis"},{p:"vAxisFixedRange",ex:!0},{p:"hAxisFixedRange"},{p:"vAxisSelectedFields",ex:"true",tt:"Use selected fields to find min/max for the range"},{p:"vAxisAllFields",ex:"true",tt:"Use all field values to find min/max for the range"},{p:"vAxisLogScale",ex:"true"},{p:"hAxisLogScale",ex:"true"},{p:"tooltipFields",ex:""},{p:"dateType",ex:"datetime"},{p:"addTooltip",ex:"false",tt:"Set this to false for multi-series charts if you only want the hovered series to show in the tt"},{inlineLabel:"Multiples Charts"},{p:"doMultiCharts",ex:"true"},{p:"multiField",ex:"field"},{p:"multiStyle",ex:""},{p:"multiLabelTemplate",ex:"${value}"},{p:"multiChartsLabelPosition",ex:"bottom|top|none"},{inlineLabel:"Chart Layout"},{p:"lineColor",ex:""},{p:"chartBackground",ex:""},{p:"chart.fill",ex:""},{p:"chartArea.fill",ex:""},{p:"chart.stroke",ex:""},{p:"chart.strokeWidth",ex:""},{p:"chartArea.fill",ex:""},{p:"chartArea.stroke",ex:""},{p:"chartArea.strokeWidth",ex:""},{p:"gridlines.color",ex:COLOR_TRANSPARENT},{p:"minorGridLines.color",ex:COLOR_TRANSPARENT},{p:"gridlines.color",ex:""},{p:"hAxis.gridlines.color",ex:""},{p:"hAxis.minorGridlines.color",ex:COLOR_TRANSPARENT},{p:"baselineColor",ex:""},{p:"hAxis.baselineColor",ex:""},{p:"gridlines.color",ex:""},{p:"vAxis.gridlines.color",ex:""},{p:"vAxis.minorGridlines.color",ex:COLOR_TRANSPARENT},{p:"baselineColor",ex:""},{p:"vAxis.baselineColor",ex:""},{p:"textColor",ex:COLOR_BLACK},{p:"textBold",ex:"true"},{p:"axis.text.color",ex:COLOR_BLACK},{p:"hAxis.text.color",ex:COLOR_BLACK},{p:"vAxis.text.color",ex:COLOR_BLACK},{p:"&lt;field&gt;.vAxis.text.color",ex:COLOR_BLACK},{p:"hAxis.text.fontSize",ex:"16"},{p:"vAxis.text.fontSize",ex:"16"},{p:"&lt;field&gt;.vAxis.text.fontSize",ex:"16"},{p:"hAxis.text.fontName",ex:"Times"},{p:"vAxis.text.fontName",ex:"Times"},{p:"&lt;field&gt;.vAxis.text.fontName",ex:"Times"},{p:"hAxis.text.bold",ex:"true"},{p:"vAxis.text.bold",ex:"true"},{p:"&lt;field&gt;.vAxis.text.bold",ex:"true"},{p:"hAxis.text.italic",ex:"true"},{p:"vAxis.text.italic",ex:"true"},{p:"&lt;field&gt;.vAxis.text.italic",ex:"true"},{p:"vAxisText",ex:""},{p:"vAxis.text",ex:""},{p:"slantedText",ex:"true"},{p:"hAxis.slantedText",ex:""},{p:"hAxis.text.color",ex:COLOR_BLACK},{p:"vAxis.text.color",ex:COLOR_BLACK},{p:"&lt;field&gt;.vAxis.text.color",ex:COLOR_BLACK},{p:"legend.position",ex:"top|bottom|none"},{p:"legend.text.color",ex:COLOR_BLACK},{p:"hAxis.ticks",tt:"Comma separated list of tick marks",ex:""},{p:"hAxis.tickTemplate",ex:"${value}"},{p:"vAxis.ticks",tt:"Comma separated list of tick marks",ex:""},{p:"vAxis.tickTemplate",ex:"${value}"},{p:"useMultipleAxes",ex:"true"}];defineDisplay(this,l,a,{setChartArea:function(e){e.chartArea||(e.chartArea={}),$.extend(e.chartArea,{left:this.getChartLeft(this.chartDimensions.left),right:this.getChartRight(this.chartDimensions.right),top:this.getChartTop(),bottom:this.getChartBottom(50),height:this.getChartHeight("70%"),width:this.getChartWidth(this.chartDimensions.width)}),["left","top","right","bottom"].forEach((t=>{let i=e.chartArea[t];i&&(i=String(i).replace("px","")),e.chartArea[t]=i}))},makeChartOptions:function(e,t,i){chartOptions=l.makeChartOptions.call(this,e,t,i);let s=e[0].fields,a=this.getProperty("expandedHeight");if(chartOptions.height=a??this.getChartHeight(this.getProperty("height","150")),chartOptions.legend||(chartOptions.legend={}),this.setPropertyOn(chartOptions.legend,"legend.position","position",this.getProperty("legendPosition","bottom")),this.setChartArea(chartOptions),this.getProperty("useMultipleAxes",!0)&&(chartOptions.series=[{targetAxisIndex:0},{targetAxisIndex:1}]),"left"==chartOptions.legend.position&&(chartOptions.series=[{targetAxisIndex:1}]),chartOptions.hAxis||(chartOptions.hAxis={}),chartOptions.vAxis||(chartOptions.vAxis={}),chartOptions.hAxis.textPosition=this.getProperty("hAxisTextPosition","top"),chartOptions.vAxis.textPosition=this.getProperty("vAxisTextPosition"),this.getProperty("hAxisTitle")&&(chartOptions.hAxis.title=this.getProperty("hAxisTitle")),this.getProperty("vAxisTitle")&&(chartOptions.vAxis.title=this.getProperty("vAxisTitle"),chartOptions.vAxis.title&&s)){let e=s.reduce(((e,t)=>e+" "+t.getLabel(this)),"");chartOptions.vAxis.title=chartOptions.vAxis.title.replace("${fields}",e)}return Utils.isDefined(this.chartHeight)&&(chartOptions.height=this.chartHeight),chartOptions}})}function RamaddaSeriesChart(e,t,i,s){defineDisplay(this,new RamaddaAxisChart(e,t,i,s),[],{includeIndexInData:function(){return this.getProperty("includeIndex",!0)},trendLineEnabled:function(){return!0}})}function BlankchartDisplay(e,t,i){const s=new RamaddaSeriesChart(e,t,"blankchart",i);defineDisplay(addRamaddaDisplay(this),s,[],{doMakeGoogleChart:function(e,t,i,s,l){return null}})}function LinechartDisplay(e,t,i){const s=new RamaddaSeriesChart(e,t,DISPLAY_LINECHART,i);defineDisplay(addRamaddaDisplay(this),s,[],{doMakeGoogleChart:function(e,t,i,s,l){return new google.visualization.LineChart(i)}})}function AreachartDisplay(e,t,i){const s=new RamaddaSeriesChart(e,t,DISPLAY_AREACHART,i);defineDisplay(addRamaddaDisplay(this),s,[{label:"Area Chart Properties"},{p:"isStacked",ex:"true"}],{doMakeGoogleChart:function(e,t,i,s,l){return this.isStacked&&(l.isStacked=!0),new google.visualization.AreaChart(i)}})}function RamaddaBaseBarchart(e,t,i,s){const l=new RamaddaSeriesChart(e,t,i,s);defineDisplay(this,l,[],{canDoGroupBy:function(){return!0},makeChartOptions:function(e,t,i){if(chartOptions=l.makeChartOptions.call(this,e,t,i),this.getChartType()==DISPLAY_BARSTACK&&(chartOptions.series=null,chartOptions.isStacked=!0),this.getProperty("barWidth")){let t=this.getProperty("barWidth");"flex"==t&&(t=e.length<100?"10":null),t&&(chartOptions.bar={groupWidth:t})}return chartOptions.orientation=this.getProperty("orientation","horizontal"),chartOptions},doMakeGoogleChart:function(e,t,i,s,l){return new google.visualization.BarChart(i)}})}function BarchartDisplay(e,t,i){const s=new RamaddaBaseBarchart(e,t,DISPLAY_BARCHART,i);defineDisplay(addRamaddaDisplay(this),s,[],{})}function BarstackDisplay(e,t,i){i=$.extend({isStacked:!0},i);const s=new RamaddaBaseBarchart(e,t,DISPLAY_BARSTACK,i);defineDisplay(addRamaddaDisplay(this),s,[],{})}function HistogramDisplay(e,t,i){const s=new RamaddaGoogleChart(e,t,DISPLAY_HISTOGRAM,i);defineDisplay(addRamaddaDisplay(this),s,[{label:"Histogram Properties"},{p:"legendPosition",ex:"none|top|right|left|bottom"},{p:"textPosition",ex:"out|in|none"},{p:"isStacked",ex:"false|true|percent|relative"},{p:"logScale",ex:"true|false"},{p:"scaleType",ex:"log|mirrorLog"},{p:"minValue",ex:""},{p:"maxValue",ex:""}],{okToHandleEventRecordSelection:function(){return!1},getDoDyamicTooltip:function(){return!1},makeDataTable:function(e,t,i){return google.visualization.arrayToDataTable(this.makeDataArray(e))},doMakeGoogleChart:function(e,t,i,s,l){this.legendPosition&&(l.legend||(l.legend={}),l.legend.position=this.legendPosition);let a=this.getProperty("isStacked",null);return a&&(l.isStacked="true"==a||"false"!=a&&a),l.vAxis={},l.vAxis.viewWindow={},Utils.isDefined(this.logScale)&&(l.vAxis.logScale=""+this.logScale==1),this.textPosition&&(l.vAxis.textPosition=this.textPosition),Utils.isDefined(this.minValue)&&(l.vAxis.viewWindow.min=parseFloat(this.minValue)),Utils.isDefined(this.maxValue)&&(l.vAxis.viewWindow.max=parseFloat(this.maxValue)),isNaN(this.getVAxisMaxValue())||(l.vAxis.maxValue=this.getVAxisMaxValue()),isNaN(this.getVAxisMinValue())||(l.vAxis.minValue=parseFloat(this.getVAxisMinValue())),isNaN(this.getHAxisMaxValue())||(l.hAxis.maxValue=this.getHAxisMaxValue()),isNaN(this.getHAxisMinValue())||(l.hAxis.minValue=parseFloat(this.getHAxisMinValue())),new google.visualization.Histogram(i)}})}function RamaddaTextChart(e,t,i,s){defineDisplay(this,new RamaddaGoogleChart(e,t,i,s),[],{getFieldsToSelect:function(e){return this.convertedFields?this.convertedFields:e.getNonGeoFields()}})}function PiechartDisplay(e,t,i){let s="pielegend";const l=new RamaddaTextChart(e,t,DISPLAY_PIECHART,i);defineDisplay(addRamaddaDisplay(this),l,[{label:"Pie Chart Properties"},{p:"groupBy",ex:""},{p:"groupByCount",ex:"true"},{p:"groupByCountLabel",ex:""},{p:"showTopLegend"},{p:"binCount",ex:"true"},{p:"pieHole",ex:"0.5"},{p:"is3D",ex:"true"},{p:"bins",ex:""},{p:"binMin",ex:""},{p:"binMax",ex:"max"},{p:"sumFields",ex:"true"},{p:"legendPosition",ex:"none|top|right|left|bottom"},{p:"sliceVisibilityThreshold",ex:"0.01"},{p:"pieSliceText",d:"percentage",ex:"value|percentage|label|none"},{p:"pieSliceTextColor",ex:"black"},{p:"pieSliceBorderColor",d:"white",ex:"black"}],{uniqueValues:[],uniqueValuesMap:{},getDoDyamicTooltip:function(){return!1},canDoGroupBy:function(){return!0},makeGoogleChart:function(e,t,i){this.uniqueValues=[],this.uniqueValuesMap={};try{if(0==e.slice(1).reduce(((e,t)=>e+t[1]),0))return void this.writeHtml(ID_DISPLAY_CONTENTS,"No data available")}catch(e){console.log("pie chart error",e)}if(l.makeGoogleChart.call(this,e,t,i),!this.getShowTopLegend())return;let a="",r=this.getColorList(),o=0;this.uniqueValues.map(((e,t)=>{o>=r.length&&(o=0);let i=r[o];a+=HU.div([ATTR_STYLE,HU.css(CSS_DISPLAY,DISPLAY_INLINE_BLOCK,CSS_WIDTH,HU.px(8),CSS_HEIGHT,HU.px(8),CSS_BACKGROUND,i)])+SPACE+e+SPACE2,o++})),0==this.jq(s).length&&this.jq(ID_HEADER2).append(HU.div([ATTR_ID,this.domId(s)])),this.jq(s).html(a)},setChartSelection:function(e){},getDragToZoom:function(){return!1},getDragToPan:function(){return!1},getGroupBy:function(){let e=this.getProperty("groupBy");if(!Utils.stringDefined(e)){let t=this.getFieldByType(this.getFields(),"string");t&&(e=t.getId())}return e},getChartDiv:function(e){let t=[ATTR_ID,e],i="",s=this.getProperty("chartWidth")||this.getChartWidth(),l=this.getProperty("chartHeight")||this.getChartHeight();return i+=s?s>0?HU.css(CSS_WIDTH,HU.px(s)):s<0?HU.css(CSS_WIDTH,HU.perc(-s)):HU.css(CSS_WIDTH,s):HU.css(CSS_WIDTH,HU.perc(100)),i+=l?l>0?HU.css(CSS_HEIGHT,HU.px(l)):l<0?HU.css(CSS_HEIGHT,HU.perc(-l)):HU.css(CSS_HEIGHT,l):HU.css(CSS_HEIGHT,HU.perc(100)),t.push(ATTR_STYLE,i),HU.div(t,"")},doMakeGoogleChart:function(e,t,i,s,l){return l.tooltip={textStyle:{color:COLOR_BLACK,fontSize:12},showColorCode:!0},this.chartOptions.legend={position:this.getLegendPosition("right"),alignment:"center"},this.getBins()?l.title="Bins: "+this.getDataValues(e[0])[1]:this.getSumFields()?l.title=this.getProperty("chartTitle","Categories/Values"):l.title=this.getDataValues(e[0])[0]+" - "+this.getDataValues(e[0])[1],this.getIs3D()&&(l.is3D=!0),this.getPieHole()&&(l.pieHole=this.pieHole),this.getSliceVisibilityThreshold()&&(l.sliceVisibilityThreshold=this.sliceVisibilityThreshold),l.pieSliceBorderColor=this.getPieSliceBorderColor(),l.pieSliceText=this.getPieSliceText(),l.pieSliceTextStyle={color:this.getPieSliceTextColor()},l.chartArea={},$.extend(l.chartArea,{left:this.getChartLeft(),right:this.getChartRight(),top:this.getChartTop(),bottom:this.getChartBottom(),width:"100%",height:"100%"}),new google.visualization.PieChart(i)},getColorList:function(){if(this.getProperty("colors")&&"default"!=this.getProperty("colors"))return l.getColorList.call(this);if(this.getProperty("colorTable")){return this.getColorTable().colors}return Utils.mergeLists(Utils.getColorTable("schemeset1",!0),Utils.getColorTable("schemecategory",!0))},makeDataTable:function(e,t,i){let s=new google.visualization.DataTable,l=[],a=this.getDataValues(e[0]);if(s.addColumn("string",a[0]),s.addColumn("number",a[1]),this.getBins()){let t=parseInt(this.getProperty("bins",null)),i=Number.MAX_VALUE,s=Number.MIN_VALUE,a=!1,r=!1;this.getBinMin()&&(i=parseFloat(this.getBinMin()),a=!0),this.getBinMax()&&(s=parseFloat(this.getBinMax()),r=!0);let o=[];for(let t=1;t<e.length;t++){let l=this.getDataValues(e[t])[1];Utils.isRealNumber(l)&&(a||(i=Math.min(l,i)),r||(s=Math.max(l,s)),o.push(l))}let n=[],h=(s-i)/t;for(let e=0;e<t;e++)n.push({min:i+e*h,max:i+(e+1)*h,values:[]});for(let e=0;e<o.length;e++){let t=o[e],i=!1;for(let e=0;e<n.length;e++)if(t<n[e].min||t>=n[e].min&&t<=n[e].max){n[e].values.push(t),i=!0;break}i||n[n.length-1].values.push(t)}for(let e=0;e<t;e++){let t=n[e];l.push(["Bin:"+this.formatNumber(t.min)+"-"+this.formatNumber(t.max),t.values.length])}}else if(this.getSumFields()){s=new google.visualization.DataTable,s.addColumn("string","Category"),s.addColumn("number","Value");let e=this.filterData(),t=this.getFieldsByIds(null,this.getSumFields()),i=[];t.map((e=>{i.push(0)})),this.chartCount>=0&&(e=[e[this.chartCount]]),e.map((e=>{t.map(((t,s)=>{let l=e.getValue(t.getIndex());isNaN(l)||(i[s]+=l)}))})),t.map(((e,t)=>{l.push([e.getLabel(this),i[t]>0?i[t]:0])}))}else for(let t=1;t<e.length;t++){let i=this.getDataValues(e[t]),s=""+(1==i.length?"#"+t:i[0]),a=1==i.length?i[0]:i[1];l.push([s,a])}return l.map((e=>{let t=e[0];this.uniqueValuesMap[t]||(this.uniqueValuesMap[t]=!0,this.uniqueValues.push(t))})),s.addRows(l),s}})}function SankeyDisplay(e,t,i){this.tries=0;const s=new RamaddaTextChart(e,t,DISPLAY_SANKEY,i);defineDisplay(addRamaddaDisplay(this),s,[],{getRequiredPackages:function(){return["sankey"]},getDoDyamicTooltip:function(){return!1},doMakeGoogleChart:function(e,t,i,s,l){return l.height=parseInt(this.getProperty("chartHeight",this.getProperty("height","400"))),l.sankey={node:{colors:this.colors,width:5},link:{colorMode:"source",colors:this.colors,color:{}}},new google.visualization.Sankey(i)},defaultSelectedToAll:function(){return!0},makeDataTable:function(e,t,i){if(!this.getProperty("doCategories",!1)){let t=this.makeDataArray(e);return google.visualization.arrayToDataTable(t)}let s=[];for(let e=0;e<i.length;e++){let t=i[e];t.isFieldString()&&s.push(t)}let l=[];l.push(["characteristic 1","characteristic 2","value"]);for(let t=1;t<s.length;t++){s[t-1],s[t];let i={};for(let s=1;s<e.length;s++){let l=this.getDataValues(e[s]),a=l[t-1],r=l[t],o=a+"-"+r;i[o]||(i[o]={v1:a,v2:r,cnt:0}),i[o].cnt++}for(a in i)l.push([i[a].v1,i[a].v2,i[a].cnt])}return google.visualization.arrayToDataTable(l)}})}function WordtreeDisplay(e,t,i){const s=new RamaddaTextChart(e,t,DISPLAY_WORDTREE,i);defineDisplay(addRamaddaDisplay(this),s,[{label:"Word Tree"},{p:"treeRoot",d:"root",tt:"Word to use for root"},{p:"wordColors",ex:"red,green,blue",tt:"Colors to use for tree levels"},{p:"fixedSize",d:"false",tt:""},{p:"buckets",ex:"100,110,115,120,130",tt:"For numeric fields the buckets to put the records in"},{p:"&lt;field&gt;.buckets",ex:"100,110,115,120,130",tt:"Specify buckets for a particular field"},{p:"bucketLabels",ex:"young,middle,old,really_old",tt:"For numeric fields the labels used for the buckets"},{p:"&lt;field&gt;.bucketLabels",ex:"young,middle,old,really_old",tt:"Specify bucket labels for a particular field"}],{handleEventRecordSelection:function(e,t){},getRequiredPackages:function(){return["wordtree"]},doMakeGoogleChart:function(e,t,i,s,l){if(this.getProperty("chartHeight")&&(l.height=parseInt(this.getProperty("chartHeight"))),this.getWordColors()){let e=this.getWordColors().split(","),t=[];for(let i=0;i<3&&i<e.length;i++)t.push(e[i]);3==t.length&&(l.colors=t)}return this.getProperty("chartWidth")&&(l.width=parseInt(this.getProperty("chartWidth"))),l.wordtree={format:"implicit",wordSeparator:"_SEP_",word:this.getTreeRoot()},this.getProperty("maxFontSize")&&(l.maxFontSize=parseInt(this.getProperty("maxFontSize"))),new google.visualization.WordTree(i)},makeDataTable:function(e,t,i){let s=this.getTreeRoot(),l=this.filterData(null,i,{skipFirst:!0}),a=this.getSelectedFields(this.getData().getRecordFields()),r=this.getFieldById(null,this.getProperty("colorBy")),o=[],n=["phrases"];o.push(n);let h=this.getFixedSize();r&&(h=1),h&&n.push("size"),r&&n.push("value");let d={},g="";for(let e=0;e<a.length;e++){let t=a[e];if(""!=g&&(g+=" -&gt;"),g+=t.getLabel(this),!t.isFieldNumeric())continue;let i,s,r=this.getColumnValues(l,t),o=[],n=this.getProperty("buckets."+t.getId(),this.getProperty("buckets",null));if(n){let l,a=this.getProperty("bucketLabels."+t.getId(),this.getProperty("bucketLabels",null));a&&(l=a.split(","));let r=n.split(","),h=0;for(let t=0;t<r.length;t++){let a=parseFloat(r[t]);if(0==t&&(i=a,s=a),i=Math.min(i,a),s=Math.max(s,a),t>0){let i;i=l&&e<=l.length?l[t-1]:this.formatNumber(h)+"-"+this.formatNumber(a),o.push({min:h,max:a,label:i})}h=a}}else{let e=parseInt(this.getProperty("numBuckets."+t.getId(),this.getProperty("numBuckets",10)));i=r.min,s=r.max;let l=(r.max-r.min)/e;for(let t=0;t<e;t++){let e=r.min+t*l,i=r.min+(t+1)*l,s=this.formatNumber(e)+"-"+this.formatNumber(i);o.push({min:e,max:i,label:s})}}d[t.getId()]={min:i,max:s,buckets:o}}for(let e=0;e<l.length;e++){let t=this.getDataValues(l[e]),i=s;for(let e=0;e<a.length;e++){let s=a[e];i+="_SEP_";let l=t[s.getIndex()];if(s.isFieldNumeric()){let e=d[s.getId()];for(let t=0;t<e.buckets.length;t++){let i=e.buckets[t];if(l>=i.min&&l<=i.max){l=i.label;break}}}i+=l}let n=[i.trim()];h&&n.push(parseInt(h)),r&&n.push(t[r.getIndex()]),o.push(n)}return this.getProperty("header")?g=this.getProperty("header",""):(g=HU.boldLabel("Fields")+g,this.getProperty("headerPrefix")&&(g=this.getProperty("headerPrefix")+" "+g)),this.writeHtml(ID_DISPLAY_TOP,g),google.visualization.arrayToDataTable(o)}})}function TableDisplay(e,t,i){const s=new RamaddaTextChart(e,t,DISPLAY_TABLE,i);defineDisplay(addRamaddaDisplay(this),s,[{label:"Table"},{p:"imageField",ex:""},{p:"tableWidth",ex:"100%"},{p:"frozenColumns",ex:"1"},{p:"colorCells",ex:"field1,field2"},{p:"foregroundColor"},{p:"showRowNumber",ex:!0},{p:"field.colorTable",ex:""},{p:"field.colorByMap",ex:"value1:color1,value2:color2"},{p:"maxHeaderLength",ex:"60"},{p:"maxHeaderWidth",ex:"60"},{p:"headerStyle"}],{getRequiredPackages:function(){return["table"]},canDoGroupBy:function(){return!0},defaultSelectedToAll:function(){return!0},getDataTableValueGetter:function(e){let t=this.getProperty("unhighlightColor",COLOR_WHITE),i=this.getProperty("highlightColor","#FFFFCC"),s=this.getProperty("colorCells"),l={},a=this.getFieldById(null,this.getProperty("linkField")),r=this.getFieldById(null,this.getProperty("iconField")),o=this.getProperty("foregroundColor"),n=[];s&&s.split(",").forEach((t=>{let i=this.getFieldById(null,t);i&&(l[t]=new ColorByInfo(this,null,e,null,t+".colorByMap",null,t,i),n.push(l[t]))}));let h=this.jq(ID_COLORTABLE);return n.forEach(((e,t)=>{let i=this.domId(ID_COLORTABLE+t);h.append(HU.div([ATTR_ID,i])),e.displayColorTable(null,!0,ID_COLORTABLE+t)})),(e,s,n,h)=>{if(null===e)return{v:0,f:""};let d=e;if(e&&e.f&&(d=e.f,e=e.v),e&&e.getTime&&(d=this.formatDate(e)),r&&h&&0==s){let e=h.getValue(r.getIndex());d=HU.image(e)+SPACE+d}if(a&&h&&0==s){let e=h.getValue(a.getIndex());d&&(d=d.trim()),Utils.isDefined(d)&&""!=d&&(d=HU.href(e,d))}if(this.getFilterHighlight()&&h){let e=h.isHighlight(this)?i:t;d=HU.div([ATTR_STYLE,HU.css(CSS_PADDING,HU.px(4),CSS_BACKGROUND,e)],d)}else d=HU.div([ATTR_STYLE,HU.css(CSS_PADDING,HU.px(4))],d);if(n){let t=l[n.getId()];if(t&&h){let e=t.getColorFromRecord(h),i=o||Utils.getForegroundColor(e);d=HU.div([ATTR_STYLE,HU.css(CSS_HEIGHT,HU.perc(100),CSS_BACKGROUND,e,CSS_COLOR,HU.important(i))],d)}if("url"==n.getType())return e.startsWith("http")||(e="https://"+e),{v:e,f:HU.href(e,e,[ATTR_TARGET,"_link"])};if("image"==n.getType())return{v:e,f:HU.href(e,HU.image(e,[ATTR_WIDTH,this.getProperty("imageWidth",100)]))}}return{v:e,f:d}}},doMakeGoogleChart:function(e,t,i,s,l){if(!this.getProperty("expandedHeight")){if(l.height=null,this.chartHeight&&(l.height=this.chartHeight),null==l.height){let e=this.getProperty("height",null);e&&(l.height=e)}null==l.height&&(l.height=HU.px(300))}return this.debugChartOptions&&console.log(JSON.stringify(l,null,2)),l.allowHtml=!0,this.getProperty("tableWidth")&&(l.width=this.getProperty("tableWidth")),l.frozenColumns=this.getProperty("frozenColumns",0),l.showRowNumber=this.getProperty("showRowNumber",!1),e.length&&this.getDataValues(e[0]).length>4?l.cssClassNames={headerCell:"display-table-header-max"}:l.cssClassNames={headerCell:"display-table-header"},l.cssClassNames||(l.cssClassNames={}),this.getProperty("fixCellHeight",!0)&&(l.cssClassNames.headerCell="display-table-cell",l.cssClassNames.tableCell="display-table-cell"),new google.visualization.Table(i)},doAddTooltip:function(){return!1},getAddStyle:function(){return!1},getFormatNumbers:function(){return!0},setChartSelection:function(e){s.setChartSelection.call(this,e);var t=this.jq(ID_CHART).find(".google-visualization-table-table:eq(0)").parent(),i=this.jq(ID_CHART).find(".google-visualization-table-tr-sel");$(t).prop("scrollTop",$(i).prop("offsetTop")-60)},xxxxmakeDataTable:function(e,t,i){let s=this.makeDataArray(e),l=[];for(let e=0;e<s.length;e++){let t=s[e];for(let e=0;e<t.length;e++){let i=typeof t[e];"string"==i?(t[e]=t[e].replace(/\n/g,HU.br()),(t[e].startsWith("http:")||t[e].startsWith("https:"))&&(t[e]="<a href='"+t[e]+"'>"+t[e]+"</a>")):"number"==i&&isNaN(t[e])&&(t[e]="--")}l.push(t)}return google.visualization.arrayToDataTable(l)}})}function BubbleDisplay(e,t,i){const s=new RamaddaTextChart(e,t,DISPLAY_BUBBLE,i);defineDisplay(addRamaddaDisplay(this),s,[{label:"Bubble Chart Attibutes"},{p:"xField"},{p:"yField"},{p:"labelField"},{p:"colorBy"},{p:"sizeField"},{p:"legendPosition",ex:"none|top|right|left|bottom"},{p:"hAxisFormat",ex:"none|decimal|scientific|percent|short|long"},{p:"vAxisFormat",ex:"none|decimal|scientific|percent|short|long"},{p:"hAxisTitle",ex:""},{p:"vAxisTitle",ex:""}],{getChartDiv:function(e){let t=[ATTR_ID,e];t.push(ATTR_STYLE);let i="",s=this.getProperty("chartWidth")||this.getChartWidth(),l=this.getProperty("chartHeight")||this.getChartHeight();return i+=s?s>0?HU.css(CSS_WIDTH,HU.px(s)):s<0?HU.css(CSS_WIDTH,HU.perc(-s)):HU.css(CSS_WIDTH,s):HU.css(CSS_WIDTH,HU.perc(100)),i+=l?l>0?HU.css(CSS_HEIGHT,HU.px(l)):l<0?HU.css(CSS_HEIGHT,HU.perc(-l)):HU.css(CSS_HEIGHT,l):HU.css(CSS_HEIGHT,HU.perc(100)),i+=HU.css(CSS_PADDING,HU.px(5)),t.push(i),HU.div(t,"")},getFieldsToDisplay:function(e){if(e.length>=4)return e;let t=this.getFieldById(null,this.getProperty("labelField")),i=this.getFieldById(null,this.getColorBy(this.getProperty("colorField"))),s=this.getFieldById(null,this.getProperty("sizeField")),l=this.getFieldById(null,this.getProperty("xField")),a=this.getFieldById(null,this.getProperty("yField"));if(!t)throw new Error("Need to specify labelField");if(!l)throw new Error("Need to specify xField");if(!a)throw new Error("Need to specify yField");let r=[t,l,a];return i&&r.push(i),s&&r.push(s),r},makeDataTable:function(e,t,i,s){let l=displayDebug.makeDataTable;if(l){this.logMsg(this.type+" makeDataTable #records:"+e.length);let t=this.getSelectedFields();console.log("\tfields:"+t)}let a=[],r=this.makeDataArray(e);for(;r[0].length<5;)r[0].push("");a.push(r[0]),this.didUnhighlight=!1;let o=Number.MAX_SAFE_INTEGER;for(let e=1;e<r.length;e++){let t=r[e];for(;t.length<5;)t.push(1);o=Math.min(o,t[3])}for(let t=1;t<r.length;t++){let i=r[t];for(;i.length<5;)i.push(1);l&&t<5&&console.log("\tdata:"+i);let s=!0;for(j=1;j<i.length&&s;j++)isNaN(i[j])&&(s=!1);if(this.getFilterHighlight()){this.getProperty("unhighlightColor","#eee");e[t].record&&!e[t].record.isHighlight(this)&&(this.didUnhighlight=!0,i[3]=o-.111)}s&&a.push(i)}return google.visualization.arrayToDataTable(a)},doMakeGoogleChart:function(e,t,i,s,l){let a=this.getColorTable(!0);a?l.colors=a:this.colors||(l.colors=this.getColorList()),l.colors&&(l.colors=Utils.getColorTable("rainbow",!0)),$.extend(l.chartArea,{left:this.getChartLeft(this.chartDimensions.left),right:this.getChartRight(this.chartDimensions.right),top:this.getChartTop(10),bottom:this.getChartBottom(40),height:this.getChartHeight(200)}),l.height=HU.px(100),l.sizeAxis={},l.colorAxis={legend:{position:this.getProperty("legendPosition","in")}};let r=this.getColorTable(!0);r&&(l.colorAxis.colors=r,this.didUnhighlight&&(l.colorAxis.colors=[...l.colorAxis.colors],l.colorAxis.colors.unshift(this.getProperty("unhighlightColor","#eee")))),l.bubble={textStyle:{auraColor:"none"},stroke:"#666"},header=this.getDataValues(e[0]),l.hAxis=l.hAxis||{},l.vAxis=l.vAxis||{},l.hAxis.minValue=this.getProperty("hAxisMinValue"),l.hAxis.maxValue=this.getProperty("hAxisMaxValue"),l.vAxis.minValue=this.getProperty("vAxisMinValue"),l.vAxis.maxValue=this.getProperty("vAxisMaxValue");let o=this.getPointData().getRecords();if(this.getProperty("hAxisFixedRange")){let e=this.getColumnValues(o,s[1]);l.hAxis.minValue=e.min,l.hAxis.maxValue=e.max}if(this.getVAxisFixedRange()){let e=this.getColumnValues(o,s[2]);l.vAxis.minValue=e.min,l.vAxis.maxValue=e.max}return l.vAxis.viewWindowMode=this.getProperty("viewWindowMode","pretty"),l.hAxis.viewWindowMode=this.getProperty("viewWindowMode","pretty"),l.hAxis.format=this.getProperty("hAxisFormat",null),l.vAxis.format=this.getProperty("vAxisFormat",null),l.hAxis.title=this.getProperty("hAxisTitle",header.length>1?header[1]:null),l.vAxis.title=this.getProperty("vAxisTitle",header.length>2?header[2]:null),new google.visualization.BubbleChart(i)}})}function BartableDisplay(e,t,s){const l=new RamaddaSeriesChart(e,t,DISPLAY_BARTABLE,s);defineDisplay(addRamaddaDisplay(this),l,[],{getRequiredPackages:function(){return["bar"]},doMakeGoogleChart:function(e,t,i,s,l){let a="";if(Utils.isDefined(this.getChartHeight()))a=this.getChartHeight();else if(e.length>1){let t=e.length;a=this.getProperty("isStacked")?22*t:22*t+14*t*(this.getDataValues(e[0]).length-2)}return $.extend(l,{title:"",bars:"horizontal",colors:this.getColorList(),width:Utils.isDefined(this.getChartWidth())?this.getChartWidth():"100%",chartArea:{left:this.getChartLeft("30%"),top:0,width:"70%",height:"80%"},height:a,bars:"horizontal",tooltip:{showColorCode:!0,isHtml:!0},legend:{position:"none"}}),Utils.isDefined(this.getProperty("isStacked"))&&(l.isStacked=this.getProperty("isStacked")),this.getProperty("hAxisTitle")&&(l.hAxis={title:this.getProperty("hAxisTitle")}),this.getProperty("vAxisTitle")&&(l.vAxis={title:this.getProperty("vAxisTitle")}),new google.visualization.BarChart(i)},getDefaultSelectedFields:function(e,t){let s=[];for(i=0;i<e.length;i++){let t=e[i];if(!t.isNumeric()){s.push(t);break}}for(i=0;i<e.length;i++){let t=e[i];if(t.isNumeric()){s.push(t);break}}return s}})}function TreemapDisplay(e,t,i){const s=new RamaddaTextChart(e,t,DISPLAY_TREEMAP,i);defineDisplay(addRamaddaDisplay(this),s,[],{handleEventRecordSelection:function(e,t){},getRequiredPackages:function(){return["treemap"]},getFieldsToSelect:function(e){return this.convertedFields?this.convertedFields:e.getRecordFields()},tooltips:{},makeChartOptions:function(e,t,i){let l=this,a=s.makeChartOptions.call(this,e,t,i);return $.extend(a,{highlightOnMouseOver:!0,generateTooltip:function(e,t,i){return l.tooltips[e]?l.tooltips[e]:"<div class='display-treemap-tooltip-outer'><div class='display-treemap-tooltip''><i>left-click: go down<br>right-click: go up</i></div></div>"},maxDepth:parseInt(this.getProperty("maxDepth",2)),maxPostDepth:parseInt(this.getProperty("maxPostDepth",3))}),a},defaultSelectedToAll:function(){return!0},doMakeGoogleChart:function(e,t,i,s,l){return this.makeDataTable(e,t,s,l)?new google.visualization.TreeMap(i):null},addTuple:function(e,t,i,s,l,a,r){let o=s,n=0;for(Utils.isDefined(i[s])&&l&&(s=l+":"+s);;){if(!Utils.isDefined(i[s])){i[s]=!0;break}s=o+" "+ ++n}let h=[s,l,a];return t&&h.push(r),e.push(h),s},valueClicked:function(e,t){e=this.getFieldById(this.getFields(),e),this.propagateEvent("fieldValueSelected",{field:e,value:t})},makeDataTable:function(e,t,i){let s=this.filterData(null,null,{skipFirst:!0});if(!s)return null;let l=this.getFields(),a=this.getSelectedFields(l);0==a.length&&(a=l);let r=this.getFieldsByType(a,"string");if(r.length<2)return this.displayError("No string fields specified"),null;let o=this.getProperty("addPrefix",!0),n=this.getFieldById(l,this.getProperty("sizeBy")),h=this.getFieldById(l,this.getProperty("colorBy")),d=this.getFieldsByType(a,"numeric");!n&&d.length>0&&(n=d[0]),!h&&d.length>1&&(h=d[1]);let g=[],p=this.getProperty("tooltipFields","").split(",");for(let e=0;e<p.length;e++){let t=this.getFieldById(null,p[e]);t&&g.push(t)}0==g.length&&(g=l),this.tooltips={};let c=[];for(let e=0;e<r.length;e++){let t=r[e];c.push(this.getColumnValues(s,t).values)}let u=[],T=[],f=[],y={};this.addTuple(u,h,{},"Node","Parent","Value","Color");let m=r[0].getLabel(this);this.addTuple(u,h,y,m,null,0,0);let _={},S=this.getGet();for(let e=0;e<s.length;e++){let t=this.getDataValues(s[e]),i="",l="";for(let t=0;t<r.length-1;t++){let s=c[t];if(""!=i&&(i+=":"),i+=s[e],!Utils.isDefined(_[i])){let a=Utils.isDefined(_[l])?_[l]:m,r=s[e];o&&t>0&&(r=a+":"+r),_[i]=this.addTuple(u,h,y,r,a,0,0)}l=i}let a=Utils.isDefined(_[l])?_[l]:m,d=t[r[r.length-1].getIndex()],p=n?t[n.getIndex()]:1,A=h?t[h.getIndex()]:0;d=this.addTuple(T,h,y,d,a,p,A);let I="<div class='display-treemap-tooltip-outer'><div class='display-treemap-tooltip''>";for(let e=0;e<g.length;e++){let i=t[g[e].getIndex()],s=g[e];i=HU.onClick(S+".valueClicked('"+s.getId()+"','"+i+"')",i,[]),I+=HU.boldLabel(s.getLabel(this))+i+HU.br()}I+=HU.close(TAG_TD,TAG_TD),f.push(I)}for(let e=0;e<T.length;e++)u.push(T[e]),this.tooltips[u.length-2]=f[e];return google.visualization.arrayToDataTable(u)}})}function TimerangechartDisplay(e,t,i){const s=new RamaddaTextChart(e,t,DISPLAY_TIMERANGECHART,i);defineDisplay(addRamaddaDisplay(this),s,[{label:"Time Range"},{p:"startDateField",ex:""},{p:"endDateField",ex:""},{p:"labelFields",ex:""},{p:"showLabel",ex:"false"},{p:"fontSize",d:10},{p:"font",d:"Helvetica"},{p:"alternatingRowStyle",d:"true",ex:"false"}],{getRequiredPackages:function(){return["timeline"]},doMakeGoogleChart:function(e,t,i,s,l){return this.dataColors&&this.dataColors.length&&(l.colors=this.dataColors),l.alternatingRowStyle=this.getAlternatingRowStyle(),l.timeline={rowLabelStyle:{fontName:this.getFont(),fontSize:this.getFontSize()},barLabelStyle:{fontName:this.getFont(),fontSize:this.getFontSize()}},l.tooltip=null,new google.visualization.Timeline(i)},makeDataTable:function(e,t,i){let s=this.getProperty("tooltip"),l=(s||this.getProperty("addTooltip",!1))&&this.doAddTooltip(),a=this.filterData(null,null,{skipFirst:!0}),r=this.getFieldByType(i,"string");r||(r=this.getFieldByType(null,"string"));let o=this.getProperty("showLabel",!0),n=[],h=this.getProperty("labelFieldsTemplate"),d=this.getProperty("labelFields","").split(",");for(let e=0;e<d.length;e++){let t=this.getFieldById(null,d[e]);t&&n.push(t)}let g=this.getFieldById(null,this.getPropertyStartDateField()),p=this.getFieldById(null,this.getPropertyEndDateField()),c=[];c=null==g||null==p?this.getFieldsByType(null,"date"):[g,p];let u=[],T=new google.visualization.DataTable;if(c.length<2)throw new Error("Need to have at least 2 date fields");r?T.addColumn({type:"string",id:r.getLabel(this)}):T.addColumn({type:"string",id:"Index"}),n=[],n.length>0?T.addColumn({type:"string",id:"Label"}):l&&T.addColumn({type:"string",id:"dummy"}),l&&T.addColumn({type:"string",role:"tooltip",p:{html:!0}}),T.addColumn({type:"date",id:c[0].getLabel(this)}),T.addColumn({type:"date",id:c[1].getLabel(this)});let f=this.getColorByInfo(a);f.isEnabled()&&(this.dataColors=[]);for(let e=0;e<a.length;e++){let t=a[e],i=this.getDataValues(a[e]),d=[];if(this.dataColors){let e=f.getColorFromRecord(t,"blue");this.dataColors.push(e)}if(u.push(d),r&&o?d.push(i[r.getIndex()]):d.push("#"+(e+1)),n.length>0){let e="";h&&(e=h);for(let t=0;t<n.length;t++){let s=n[t],l=i[s.getIndex()];h?e=e.replace("{"+s.getId()+"}",l):e+=l+" "}d.push(e)}else l&&d.push(null);if(l){let e=this.getRecordHtml(t,null,s);d.push(e)}d.push(i[c[0].getIndex()]),d.push(i[c[1].getIndex()])}return T.addRows(u),f.isEnabled()&&f.displayColorTable(null,!0),T}})}function CalendarDisplay(e,t,i){const s=new RamaddaGoogleChart(e,t,DISPLAY_CALENDAR,i);defineDisplay(addRamaddaDisplay(this),s,[{label:"Calendar"},{p:"cellSize",d:15,ex:"15"},{p:"missingValue",ex:""},{p:"strokeColor",d:"#76a7fa",ex:"#76a7fa"},{p:"strokeWidth",ex:"1"},{p:"strokeOpacity",d:.5,ex:"0.5"},{p:"noDataBackground",ex:"green"},{p:"noDataColor",ex:"red"},{p:"colorAxis",ex:"red,blue"}],{getDoDyamicTooltip:function(){return!1},getRequiredPackages:function(){return["calendar"]},doMakeGoogleChart:function(e,t,i,s,l){let a={calendar:{cellSize:parseInt(this.getPropertyCellSize()),cellColor:{stroke:this.getPropertyStrokeColor(),strokeOpacity:this.getPropertyStrokeOpacity(),strokeWidth:this.getPropertyStrokeWidth(1)}},height:this.getProperty("height",800),noDataPattern:{backgroundColor:this.getPropertyNoDataBackground(),color:this.getPropertyNoDataColor()}},r=this.getPropertyColorAxis();if(r&&(a.colorAxis={colors:r.split(",")}),$.extend(l,a),0!=this.jq(ID_CHART).width())return new google.visualization.Calendar(i)},defaultSelectedToAll:function(){return!0},getContentsStyle:function(){let e=this.getProperty("height",800);return e>0?HU.css(CSS_HEIGHT,HU.px(e),CSS_MAX_HEIGHT,HU.px(e),CSS_OVERFLOW_Y,OVERFLOW_AUTO):""},canDoMultiFields:function(){return!1},getIncludeIndexIfDate:function(){return!0},makeDataTable:function(e,t,i){let s=new google.visualization.DataTable,l=this.getDataValues(e[0]);if(l.length<2)return null;s.addColumn({type:"date",id:"Date"}),s.addColumn({type:"number",id:l[1]}),s.addColumn({type:"string",role:"tooltip",p:{html:!0}});let a=!1,r=this.getPropertyMissingValue();r&&(a=!0,r=parseFloat(r));let o=[];this.dateToRecords={};for(let t=1;t<e.length;t++){let i=this.getBinnedRecords(e[t].record),s=e[t];!i&&s.record&&(i=[s.record]);let n=this.getDataValues(s)[1];if(NaN==n)continue;if(a&&n==r)continue;0;let h=this.getDataValues(e[t])[0];this.dateToRecords[h.v.getTime()]=i;let d=HU.center(HU.b(h.f))+HU.b(l[1].replace(/ /g,SPACE))+":"+SPACE+this.formatNumber(n);d=HU.div([ATTR_STYLE,HU.css(CSS_PADDING,HU.px(5))],d),o.push([this.getDataValues(e[t])[0],n,d])}return s.addRows(o),s}})}function GaugeDisplay(e,t,i){const s=new RamaddaGoogleChart(e,t,DISPLAY_GAUGE,i);i.multiChartsLabelPosition="none";defineDisplay(addRamaddaDisplay(this),s,[{label:"Gauge"},{p:"minorTicks",d:0},{p:"majorTicks",ex:"10,20,30,40"},{p:"fontSize",ex:"14pt"},{p:"greenFrom",ex:0},{p:"greenTo",ex:10},{p:"yellowFrom",ex:0},{p:"yellowTo",ex:10},{p:"redFrom",ex:0},{p:"redColor",ex:"#ff0000"},{p:"yellowColor",ex:"#ff0000"},{p:"greenColor",ex:"#ff0000"},{p:"redTo",ex:10},{p:"gaugeMin",tt:"min gauge value"},{p:"gaugeMax",tt:"max gauge value"},{p:"field_based_values",tt:"all of the above can have fieldid.propert, e.g., temp.redFrom=..."}],{getRequiredPackages:function(){return["gauge"]},getChartHeight:function(){return this.getProperty("chartHeight",this.getChartWidth())},getChartWidth:function(){return this.getProperty("chartWidth","150")},drawChart(e,t,i){s.drawChart.call(this,e,t,i);let l=$(e.container).find("svg g text");this.getFontSize()&&l.css(CSS_FONT_SIZE,this.getFontSize())},doMultiChartsByField:function(){return!0},doMakeGoogleChart:function(e,t,i,s,l){this.dataList=e;let a=s[0];(e=>{e.forEach((e=>{let t=this.getFieldProperty(a,e);Utils.isDefined(t)&&(l[e]=t)}))})(["redFrom","redTo","yellowFrom","yellowTo","greenFrom","greenTo","greenColor","redColor","yellowColor","min","max"]),$.extend(l,{minorTicks:this.getFieldProperty(a,"minorTicks",0)}),Utils.stringDefined(this.getFieldProperty(a,"majorTicks"))&&(l.majorTicks=Utils.split(this.getFieldProperty(a,"majorTicks")));let r=Number.MAX_VALUE,o=Number.MIN_VALUE,n=!0;for(let t=1;t<e.length;t++){let i=this.getDataValues(e[t]);for(let e=0;e<i.length;e++){if(!Utils.isNumber(i[e]))continue;let t=i[e];r=Utils.min(r,t),o=Utils.max(o,t)}}r=Utils.formatNumber(r,!0),o=Utils.formatNumber(o,!0);let h=this.getFieldProperty(a,"gaugeMin"),d=this.getFieldProperty(a,"gaugeMax");return Utils.isDefined(h)&&(n=!0,r=parseFloat(h)),Utils.isDefined(d)&&(n=!0,o=parseFloat(d)),n&&(l.min=r,l.max=o),new google.visualization.Gauge(i)},makeDataTable:function(e,t,i){if(null==e)return;e=this.makeDataArray(e),Utils.isDefined(this.index)||(this.index=e.length-1);let s=this.index+1,l=[];l.push(["Label","Value"]);let a=this.getDataValues(e[0]);s>=e.length&&(s=e.length-1);let r=this.getDataValues(e[s]);for(let e=0;e<r.length;e++){if(!Utils.isNumber(r[e]))continue;let t=a[e];if(t.length>20){let e=t.indexOf("(");e>0&&(t=t.substring(0,e))}t.length>20&&(t=t.substring(0,19)+"..."),this.getProperty("gaugeLabel")?t=this.getProperty("gaugeLabel"):this["gaugeLabel"+(e+1)]&&(t=this["gaugeLabel"+(e+1)]);let i=r[e];l.push([t,Utils.formatNumber(i,!0)])}return google.visualization.arrayToDataTable(l)},setChartSelection:function(e){if(this.index=e,this.multiChartData)return void this.multiChartData.forEach((e=>{let t=this.makeDataTable(e.dataList,e.props,e.fields);this.drawChart(e.chart,t,e.chartOptions)}));let t=this.makeDataTable(this.dataList);this.mapCharts(((e,i)=>{this.drawChart(e,t,this.chartOptions)}))}})}function ScatterplotDisplay(e,t,s){const l=new RamaddaGoogleChart(e,t,DISPLAY_SCATTERPLOT,s);defineDisplay(addRamaddaDisplay(this),l,[],{trendLineEnabled:function(){return!0},getPointSize:function(){return this.getProperty("pointSize",10)},setAxisRanges:function(e,t,i){if(this.getProperty("hAxisFixedRange")){let s=this.getColumnValues(i,t[0]);e.hAxis&&(e.hAxis={}),e.hAxis.minValue=s.min,e.hAxis.maxValue=s.max}if(this.getProperty("vAxisFixedRange")){e.vAxis&&(e.vAxis={});let s=this.getColumnValues(i,t[1]);e.vAxis.minValue=s.min,e.vAxis.maxValue=s.max}},makeChartOptions:function(e,t,i){let s=l.makeChartOptions.call(this,e,t,i);return s.curveType=null,s.lineWidth=0,$.extend(s,{title:"",tooltip:{isHtml:!0},legend:"none"}),s.chartArea||(s.chartArea={}),$.extend(s.chartArea,{left:"10%",top:10,height:"80%",width:"90%"}),this.getShowTitle()&&(s.title=this.getTitle(!0)),s.hAxis||(s.hAxis={}),s.vAxis||(s.vAxis={}),this.getProperty("hAxisLogScale",!1)&&(s.hAxis.logScale=!0),this.getProperty("vAxisLogScale",!1)&&(s.vAxis.logScale=!0),s.vAxis.viewWindowMode=this.getProperty("viewWindowMode","pretty"),s.hAxis.viewWindowMode=this.getProperty("viewWindowMode","pretty"),e.length>0&&this.getDataValues(e[0]).length>1&&(s.vAxis||(s.vAxis={}),s.hAxis||(s.hAxis={}),this.getProperty("hAxisTitle")&&(s.hAxis.title=this.getProperty("hAxisTitle")),this.getProperty("vAxisTitle")&&(s.vAxis.title=this.getProperty("vAxisTitle")),s.hAxis.title||$.extend(s.hAxis,{title:this.getDataValues(e[0])[0]}),s.vAxis.title||$.extend(s.vAxis,{title:this.getDataValues(e[0])[1]}),isNaN(this.getVAxisMinValue())||(s.vAxis.minValue=this.getVAxisMinValue()),isNaN(this.getVAxisMaxValue())||(s.vAxis.maxValue=this.getVAxisMaxValue())),s},doMakeGoogleChart:function(e,t,i,s,l){if(!i)return;let a=this.getProperty("height",400);Utils.isDefined(this.getProperty("chartHeight"))&&(a=this.getProperty("chartHeight"));let r="100%";return Utils.isDefined(this.getProperty("chartWidth"))&&(r=this.getProperty("chartWidth")),"number"==typeof a&&(a=HU.px(a)),"number"==typeof r&&(r=HU.px(r)),jqid(i.id).css(CSS_WIDTH,r),jqid(i.id).css(CSS_HEIGHT,a),new google.visualization.ScatterChart(i)},getDefaultSelectedFields:function(e,t){let s=[];for(i=0;i<e.length;i++){let t=e[i];if(t.isNumeric()&&(s.push(t),s.length>=2))break}return s}})}function OrgchartDisplay(e,t,i){const s="orgchart",l=new RamaddaGoogleChart(e,t,DISPLAY_ORGCHART,i);defineDisplay(addRamaddaDisplay(this),l,[{label:"Orgchart"},{p:"labelField",ex:""},{p:"parentField",ex:""},{p:"idField",ex:""},{p:"treeRoot",ex:"some label"},{p:"treeTemplate",ex:""},{p:"treeNodeSize",ex:"small|medium|large"}],{handleEventRecordSelection:function(e,t){},needsData:function(){return!0},getRequiredPackages:function(){return["orgchart"]},updateUIInner:function(){if(this.displayHtml(HU.div([ATTR_ID,this.domId(s)],"")),0==this.jq(s).length)return void setTimeout((()=>this.updateUI()),1e3);let e=null;try{e=this.makeTree()}catch(e){return void this.handleError("An error has occurred:"+e,e)}if(null==e)return;let t=new google.visualization.DataTable;t.addColumn("string","Name"),t.addColumn("string","Parent"),t.addColumn("string","ToolTip");let i=[],l=function(e){0;let t=e.label;e.display&&(t={v:e.label,f:e.display});let s=[t,e.parent?e.parent.label:"",e.tooltip||""];i.push(s),e.children.length>0&&e.children.map(l),e.record};e.map(l),t.addRows(i);let a=new google.visualization.OrgChart(document.getElementById(this.domId(s)));this.drawChart(a,t,{allowHtml:!0,allowCollapse:!0,size:this.getProperty("treeNodeSize","medium")})}})}var DISPLAY_SLIDES="slides",DISPLAY_IMAGES="images",DISPLAY_IMAGEZOOM="imagezoom",DISPLAY_CARDS="cards",ID_GALLERY="gallery";function RamaddaCardsDisplay(e,t,i){const s="results",l=new RamaddaFieldsDisplay(e,t,DISPLAY_CARDS,i);Utils.importJS(RamaddaUtil.getCdnUrl("/lib/color-thief.umd.js"),(()=>{}),((e,t,i)=>{console.log("err")}));defineDisplay(addRamaddaDisplay(this),l,[{label:"Cards Attributes"},{p:"groupByFields",ex:""},{p:"initGroupFields",ex:""},{p:"tooltipFields",ex:""},{p:"captionFields"},{p:"captionTemplate",ex:"${name}"},{p:"sortFields",ex:""},{p:"labelField",ex:""},{p:"imageWidth",ex:"100"},{p:"imageMargin",ex:"5"}],{getContentsStyle:function(){return""},updateUI:function(){this.colorAnalysisEnabled=this.getProperty("doColorAnalysis");var e=this.getData();if(null==e)return;var t=e.getRecordFields(),i=this.getSelectedFields(t);null!=i&&0!=i.length||(i=t);var l=this.filterData();if(!l)return;let a=i;if(this.initGrouping=this.getFieldsByIds(i,this.getProperty("initGroupFields","",!0)),this.groupByFields=this.getFieldsByIds(i,this.getProperty("groupByFields","",!0)),this.groupByMenus=+this.getProperty("groupByMenus",this.groupByFields.length),this.imageField=this.getFieldByType(i,"image"),this.urlField=this.getFieldByType(i,"url"),this.tooltipFields=this.getFieldsByIds(i,this.getProperty("tooltipFields","",!0)),this.labelFields=this.getFieldsByIds(i,this.getProperty("labelFields",null,!0)),0==this.labelFields.length){var r=this.getFieldById(i,this.getProperty("labelField",null,!0));r&&this.labelFields.push(r)}if(this.onlyShowImages=this.getProperty("onlyShowImages",!1),this.altLabelField=this.getFieldById(i,this.getProperty("altLabelField",null,!0)),this.captionFields=this.getFieldsByIds(i,this.getProperty("captionFields","",!0)),this.captionTemplate=this.getProperty("captionTemplate",null,!0),0==this.captionFields.length&&(this.captionFields=this.tooltipFields),this.colorByField=this.getFieldById(i,this.getProperty("colorBy",null,!0)),this.colorList=this.getColorTable(!0),this.foregroundList=this.getColorTable(!0,"foreground"),this.getProperty("showImages",!0)||(this.imageField=null),!this.imageField&&0==this.captionFields.length)return void this.displayError("No image or caption fields specified");var o="";if(!this.groupByHtml&&(this.groupByHtml="",this.colorAnalysisEnabled&&(this.groupByHtml+=HU.span([ATTR_CLASS,CLASS_BUTTON,ATTR_ID,this.domId("docolors")],"Do colors")+" "+HU.span([ATTR_CLASS,CLASS_BUTTON,ATTR_ID,this.domId("docolorsreset")],"Reset")),this.groupByFields.length>0)){var n=[["","--"]];this.groupByFields.map((e=>{n.push([e.getId(),e.getLabel()])})),this.groupByHtml+=HU.span([ATTR_CLASS,"display-fitlerby-label"]," Group by: ");for(var h=0;h<this.groupByMenus;h++){var d="";h<this.initGrouping.length&&(d=this.initGrouping[h].getId()),this.groupByHtml+=HU.select("",[ATTR_ID,this.domId(ID_GROUPBY_FIELDS+h)],n,d)+SPACE}this.groupByHtml+=SPACE,this.jq(ID_HEADER1).html(HU.div([ATTR_CLASS,"display-filterby"],this.groupByHtml)),this.jq("docolors").button().click((()=>{this.analyzeColors()})),this.jq("docolorsreset").button().click((()=>{this.updateUI()}))}o+=HU.div([ATTR_ID,this.domId(s)]),this.setContents(o);let g=this;this.jq(ID_HEADER1).find("input, input:radio,select").change((function(){g.updateUI()})),this.displaySearchResults(l,a)},analyzeColors:function(){if(!window.ColorThief)return void setTimeout((()=>this.analyzeColors()),1e3);const e=new ColorThief;for(var t=0;;){var i=document.querySelector("#"+this.domId(ID_GALLERY)+"img"+t),s=jqid(this.domId(ID_GALLERY)+TAG_DIV+t);if(t++,!i)return;i.crossOrigin="Anonymous";for(var l=e.getColor(i),a=e.getPalette(i),r=i.width/a.length,o="",n=0;n<a.length;n++){l=a[n];o+=HU.div([ATTR_STYLE,HU.css(CSS_DISPLAY,DISPLAY_INLINE_BLOCK,CSS_WIDTH,HU.px(r),CSS_HEIGHT,HU.px(i.height),CSS_BACKGROUND,HU.rgb(l[0],l[1],l[2]))],"")}s.css(CSS_WIDTH,i.width),s.css(CSS_HEIGHT,i.height),s.html(o),i.style.display=DISPLAY_NONE}},displaySearchResults:function(e,t){e=this.sortRecords(e);for(var i=this.getProperty("fontSize",null),l=this.getProperty("cardStyle",null),a=this.getProperty("imageWidth","50"),r=this.getProperty("imageMargin","0"),o=[],n=[],h=0;h<this.groupByMenus;h++){var d=this.jq(ID_GROUPBY_FIELDS+h).val();if(!n[d]){n[d]=!0;var g=this.getFieldById(t,d);if(g&&(o.push(g),g.isNumeric()&&!g.range)){var p=Number.MAX_VALUE,c=Number.MIN_VALUE;e.map((e=>{var t=g.getValue(e);isNaN(t)||(t<p&&(p=t),t>c&&(c=t))})),g.range=[p,c];var u=this.getProperty(g.getId()+".bins");if(g.bins=[],u){var T=u.split(",");for(h=0;h<T.length-1;h++)g.bins.push([+T[h],+T[h+1]])}else{var f=+this.getProperty(g.getId()+".binCount",10);g.binSize=(c-p)/f;for(var y=0;y<f;y++)g.bins.push([p+g.binSize*y,p+g.binSize*(y+1)])}}}}function m(e,t){$.extend(this,{id:e,field:t,members:[],isGroup:!0,getCount:function(){if(0==this.members.length)return 0;if(this.members[0].isGroup){var e=0;return this.members.map((t=>e+=t.getCount())),e}return this.members.length},findGroup:function(e){for(var t=0;t<this.members.length;t++)if(this.members[t].isGroup&&this.members[t].id==e)return this.members[t];return null}})}for(var _=new m(""),S={},A=0,I=0,b=0;b<e.length;b++){let t=e[b];var R=this.getDataValues(e[b]),D="";this.tooltipFields.map((e=>{""!=D&&(D+="&#10;"),D+=e.getValue(t)})),D=D.replace(/\"/g,"&quot;");var L="",U="";if(this.captionFields.length>0&&(this.captionTemplate&&(U=this.captionTemplate),this.captionFields.map((e=>{var i=(""+e.getValue(t)).replace(/\"/g,"&quot;");this.captionTemplate?U=U.replace("${"+e.getId()+"}",i):U+=i+HU.br()})),this.urlField)){var C=this.urlField.getValue(t);C&&""!=C&&(U="<a style='color:inherit;'  href='"+C+"' target=_other>"+U+"</a>")}this.labelFields.map((e=>{L+=R[e.getIndex()]+" "})),L=L.trim();var E="",H=null;if(!this.imageField||(H=R[this.imageField.getIndex()],!this.onlyShowImages||Utils.stringDefined(H))){var P=[ATTR_CLASS,"display-cards-popup",ATTR_DATA_FANCYBOX,this.domId(ID_GALLERY),ATTR_DATA_CAPTION,U];if(H&&(H=H.trim()),Utils.stringDefined(H))this.colorAnalysisEnabled&&(H=HU.url(RamaddaUtil.getUrl(URL_PROXY),ARG_URL,H)),H=HU.href(H,HU.div([ATTR_ID,this.domId(ID_GALLERY)+"div"+I],HU.image(H,[ATTR_WIDTH,a,ATTR_ID,this.domId(ID_GALLERY)+"img"+I])),P)+L,I++,E=HU.div([ATTR_CLASS,"display-cards-item",ATTR_TITLE,D,ATTR_STYLE,HU.css(CSS_MARGIN,HU.px(r))],H);else{var x="";if(i&&(x+=HU.css(CSS_FONT_SIZE,i)),this.colorByField&&this.colorList){var v=this.colorByField.getValue(t);Utils.isDefined(S[v])||(S[v]=A++);var O=S[v];O>=this.colorList.length&&(O=this.colorList.length%O),x+=HU.css(CSS_BACKGROUND,this.colorList[O]),this.foregroundList&&(O<this.foregroundList.length?x+=HU.css(CSS_COLOR,HU.important(this.foregroundList[O])):x+=HU.css(CSS_COLOR,HU.important(this.foregroundList[this.foregroundList-1])))}l&&(x+=l);var N=[ATTR_TITLE,D,ATTR_CLASS,"ramadda-gridbox display-cards-card",ATTR_STYLE,x];E=this.altLabelField?HU.div(N,this.altLabelField.getValue(t)):HU.div(N,U),E=HU.href("",E,P)}for(var w=_,M=0;M<o.length;M++){var F=o[M];v=R[F.getIndex()];if(F.isNumeric())for(var k=0;k<F.bins.length;k++){if(v<=(y=F.bins[k])[1]||k==F.bins.length-1){v=Utils.formatNumber(y[0])+" - "+Utils.formatNumber(y[1]);break}}var G=w.findGroup(v);G||w.members.push(G=new m(v,F)),w=G}w.members.push(E)}}let B=_.getCount(),Y=HU.div([ATTR_CLASS,"display-cards-header"],"Total ("+B+")");Y+=this.makeGroupHtml(_,_),this.writeHtml(s,Y),HU.createFancyBox(this.jq(s).find("a.display-cards-popup"),{caption:function(e,t){return $(this).data("caption")||""}})},makeGroupHtml:function(e,t){if(0==e.members.length)return"";var i="";if(e.members[0].isGroup){e.members.sort(((e,t)=>e.id<t.id?-1:e.id>t.id?1:0));var s=0==e.members.length?HU.perc(100):100/e.members.length;i+=HU.open(TAG_TABLE,[ATTR_WIDTH,HU.perc(100),ATTR_BORDER,0])+HU.open(TAG_TR,[ATTR_VALIGN,ALIGN_TOP]);for(var l=0;l<e.members.length;l++){var a=e.members[l],r="";a.field&&(r=a.field.getLabel()+": "),i+=HU.open(TAG_TD,[ATTR_WIDTH,HU.perc(s)]);let o=Math.round(100*a.getCount()/t.getCount());i+=HU.div([ATTR_CLASS,"display-cards-header"],r+a.id+" (#"+a.getCount()+" - "+HU.perc(o)+")"),i+=this.makeGroupHtml(a,t),i+=HU.close(TAG_TD)}i+=HU.close(TAG_TR,TAG_TABLE)}else i+=Utils.join(e.members,"");return i}})}function RamaddaImagesDisplay(e,t,i){const s="images";i.tooltipClick=null,Utils.isDefined(i.showRecordPager)||(i.showRecordPager=!0),Utils.isDefined(i.noun)||(i.noun="images"),Utils.isDefined(i.numberOfImages)&&(i.recordPagerNumber=i.numberOfImages);const l=new RamaddaFieldsDisplay(e,t,DISPLAY_IMAGES,i);defineDisplay(addRamaddaDisplay(this),l,[{label:"Image Gallery Properties"},{p:"imageField",ex:""},{p:"urlPrefix"},{p:"template",ex:""},{p:"labelFields",ex:""},{p:"topLabelTemplate",ex:""},{p:"bottomLabelTemplate",ex:""},{p:"tooltipFields",ex:""},{p:"includeBlanks",ex:"true"},{p:"blockWidth",ex:"150"},{p:"imageWidth",ex:"150"},{p:"imageHeight",ex:"150"},{p:"imageMargin",ex:"10px"},{p:"decorate",ex:"false"},{p:"doPopup",ex:"false"},{p:"imageStyle",ex:""},{p:"minHeightGallery",ex:150},{p:"maxHeightGallery",ex:150},{p:"columns",ex:"5"},{p:"includeNonImages",d:!0},{p:"showPlaceholderImage",d:!0}],{dataFilterChanged:function(){this.updateUI()},handleEventRecordSelection:function(e,t){let i=this.find(HU.dotClass("display-images-block")),l=HU.attrSelect(ATTR_RECORD_ID,t.record.getId()),a=this.find(l);i.css(CSS_BORDER,null),a.css(CSS_BORDER,HU.border(1,this.getHighlightColor())),HU.scrollVisible(this.jq(s),a)},updateUI:function(){this.getPropertyIncludeBlanks(!1);let e=null,t=this.getProperty("showBottomLabel",!0),i=this.filterData(null,null,{recordOk:t=>(null==e&&(e=this.getFieldById(null,this.getProperty("imageField"))),e||(e=this.getFieldByType(null,"image")),!!e)});if(!i)return;if(!e)return this.setDisplayMessage("No image field in data"),!1;let l=this.getUrlPrefix(),a=this.getFieldById(null,this.getProperty("urlField")),r=this.getProperty("tooltipClick"),o=this.getData().getRecordFields(),n=this.getFieldsByIds(null,this.getProperty("labelFields",null,!0)),h=this.getTemplate(),d=this.getTopLabelTemplate(),g=this.getPropertyBottomLabelTemplate(),p=this.getFieldsByIds(null,this.getProperty("tooltipFields",null,!0)),c=this.getPropertyDecorate(!0),u=+this.getPropertyColumns(0),T=this.getColorByInfo(i),f=this.getPropertyImageWidth(),y=this.getBlockWidth(HU.px(200)),m=this.getPropertyImageHeight();f||m||(f=HU.perc(100));let _=this.getPropertyImageStyle(""),S="",A="gallery"+HU.getUniqueId(),I=[],b=this.getPropertyDoPopup(!0),R=0,D=-1,L={},U="display-images-image-outer display-images-block ",C="display-images-image-inner";this.idToRecord={};let E="";i.length<10&&(i.length<2?(f="500px",y="510px"):(f="300px",y="310px")),c||(C="",U="display-images-block",E=HU.css(CSS_MARGIN,this.getPropertyImageMargin(HU.px(10)))),u&&f&&f.endsWith("%")&&(E+=HU.css(ATTR_WIDTH,f)),E+=this.getProperty("blockStyle","");let H=this.getIncludeNonImages(),P=this.getShowPlaceholderImage(!0)?HU.image(RamaddaUtil.getCdnUrl("/images/placeholder.png"),[ATTR_WIDTH,HU.perc(100)]):SPACE,x=!1;if(i.forEach(((i,s)=>{let c=this.getDataValues(i),v=i.getValue(e.getIndex());l&&(v=l+v),I.push(i),this.idToRecord[i.getId()]=i;let O=null;d&&(O=this.getRecordHtml(i,o,d));let N="",w="";Utils.stringDefined(g)&&(N=this.getRecordHtml(i,o,g)),n.forEach((e=>{let t=i.getValue(e.getIndex());t.getTime&&(t=this.formatDate(t)),w+=" "+t})),""==w?w=N:""==N&&(N=w);let M="";p.forEach((e=>{M+="\n"+e.getLabel()+": "+c[e.getIndex()]})),M=M.trim();let F=E,k=[ATTR_STYLE,_,ATTR_TITLE,w,ATTR_ID,A+"image"+s,ATTR_LOADING,LOADING_LAZY];if(f?k.push(ATTR_WIDTH,f):m&&k.push(ATTR_HEIGHT,m),!Utils.stringDefined(v)&&!H)return;let G=Utils.stringDefined(v);if(!G&&(x=!0,this.hideNoImages))return;let B,Y,V=G?HU.div([ATTR_CLASS,"display-images-image-wrapper"],HU.image(v,k)):P,q=null!=O?HU.div([ATTR_CLASS,HU.classes(CLASS_CLICKABLE,"display-images-toplabel")],O):"",W=HU.div([ATTR_CLASS,HU.classes(CLASS_CLICKABLE,"display-images-label")],N.trim());if(a&&(""!=q&&(q=HU.href(a.getValue(i),q,[ATTR_TARGET,"_target"])),W=HU.href(a.getValue(i),W,[ATTR_TARGET,"_target"]),w=HU.href(a.getValue(i),w,[ATTR_TARGET,"_target"]),w=w.replace(/"/g,"'")),t||(W=""),T.isEnabled()){let e=T.getColorFromRecord(i);F+=HU.css(ATTR_BACKGROUND,e)}if(h){let e=this.getDataValues(i);Y=B=this.applyRecordTemplate(i,e,o,h),F+=HU.css(CSS_TEXT_ALIGN,ALIGN_LEFT)}else F+=HU.css(CSS_VERTICAL_ALIGN,ALIGN_TOP,CSS_WIDTH,y),b?V=HU.href(v,V,[ATTR_CLASS,"popup_image",ATTR_DATA_FANCYBOX,A,ATTR_DATA_CAPTION,w]):a&&!r&&(V=HU.href(a.getValue(i),V,[ATTR_TARGET,"_target"])),B=HU.div([ATTR_CLASS,C],q+V+W);Y=HU.div([ATTR_STYLE,F,ATTR_RECORD_ID,i.getId(),ATTR_RECORD_INDEX,R++,ATTR_ID,A+"div"+s,ATTR_CLASS,U,ATTR_TITLE,M],B),u?(++D>=u&&(D=0),L[D]||(L[D]=""),L[D]+=Y):S+=Y})),u){S=HU.open(TAG_TABLE,[ATTR_BORDER,0,ATTR_WIDTH,HU.perc(100)])+HU.open(TAG_TR,[ATTR_VALIGN,ALIGN_TOP]);for(let e=0;L[e];e++)S+=HU.td([ATTR_ALIGN,ALIGN_CENTER],L[e]);S+=HU.close(TAG_TR,TAG_TABLE)}if(this.getPropertyMinHeightGallery()||this.getPropertyMaxHeightGallery()){let e="";this.getPropertyMinHeightGallery()&&(e+=HU.css(CSS_MIN_HEIGHT,HU.getDimension(this.getPropertyMinHeightGallery()))),this.getPropertyMinHeightGallery()&&(e+=HU.css(CSS_MAX_HEIGHT,HU.getDimension(this.getPropertyMaxHeightGallery()))),S=HU.div([ATTR_ID,this.domId(s),ATTR_STYLE,e+HU.css(CSS_OVERFLOW_Y,OVERFLOW_AUTO)],S)}S=HU.div([ATTR_CLASS,"ramadda-grid"],S),this.getShowPlaceholderImage()&&x&&(S=HU.div([ATTR_STYLE,HU.css(CSS_MARGIN_LEFT,HU.px(8),CSS_MARGIN_TOP,HU.px(8))],HU.checkbox("",[ATTR_ID,this.domId("onlyimages")],this.hideNoImages,"Show entries with images"))+S),this.setContents(S),x&&this.jq("onlyimages").change((function(){O.hideNoImages=HU.isChecked($(this)),O.forceUpdateUI()}));let v=this.find(".display-images-block"),O=this;if(v.mouseenter((function(){$(this).attr("oldborder",$(this).css(CSS_BORDER)),$(this).css(CSS_BORDER,HU.border(1,O.getHighlightColor()))})),v.mouseleave((function(){$(this).css(CSS_BORDER,$(this).attr("oldborder"))})),this.makeTooltips(v,I),b)HU.createFancyBox(this.jq(ID_RESULTS).find("a.popup_image"),{caption:function(e,t){return $(this).data(ATTR_DATA_CAPTION)||""}});else{let e=this;r||v.click((function(){let t=e.idToRecord[$(this).attr(ATTR_RECORD_ID)];t&&e.propagateEventRecordSelection({record:t})}))}this.getProperty("propagateEventRecordList",!1)&&this.getDisplayManager().notifyEvent(DisplayEvent.recordList,this,{recordList:I})}})}function RamaddaImagezoomDisplay(e,t,i){const s="thumbs",l="thumb",a="image",r="imageinner",o="imagepopup",n="imagepopupimage",h="imagerect",d=new RamaddaFieldsDisplay(e,t,DISPLAY_IMAGEZOOM,i);defineDisplay(addRamaddaDisplay(this),d,[{label:"Image Zoom Attributes"},{p:"labelFields",d:"name"},{p:"thumbField"},{p:"thumbWidth",ex:"100"},{p:"imageWidth",ex:"150"},{p:"urlField"},{p:"popupWidth"},{p:"popupHeight"},{p:"popupImageWidth",d:2e3}],{dataFilterChanged:function(){this.updateUI()},updateUI:function(){let e=this.getData();if(null==e)return;let t=this.filterData();if(!t)return;let i=e.getRecordFields();if(this.urlField=this.getFieldById(i,this.getUrlField("url")),this.urlField||(this.urlField=this.getFieldById(i,"entry_url")),this.imageField=this.getFieldById(i,"image"),this.imageField||(this.imageField=this.getFieldByType(i,"image")),!this.imageField)return void this.setDisplayMessage("No image field in data");this.labelFields=this.getFieldsByIds(i,this.getPropertyLabelFields());let r=this.getFieldById(i,this.getProperty("thumbField","thumb"))||this.imageField,n=parseFloat(this.getProperty("thumbWidth",100)),d=this.getHeightForStyle(),g=this.getProperty("imageWidth",500);this.popupWidth=+this.getProperty("popupWidth",g),this.popupHeight=+this.getProperty("popupHeight",300);let p=HU.div([ATTR_STYLE,HU.css(CSS_BORDER,HU.border(1,this.getHighlightColor()),CSS_WIDTH,HU.px(20),CSS_HEIGHT,HU.px(20),CSS_LEFT,HU.px(10),CSS_TOP,HU.px(10),CSS_DISPLAY,DISPLAY_NONE,CSS_POSITION,POSITION_ABSOLUTE,CSS_Z_INDEX,1e3,CSS_POINTER_EVENTS,"none"),ATTR_ID,this.domId(h)]),c=HU.div([ATTR_STYLE,HU.css(CSS_POSITION,POSITION_RELATIVE)],p+HU.div([ATTR_ID,this.domId(a),ATTR_STYLE,HU.css(CSS_POSITION,POSITION_RELATIVE)])+HU.div([ATTR_ID,this.domId(o),ATTR_CLASS,"display-imagezoom-popup",ATTR_STYLE,HU.css(CSS_Z_INDEX,100,CSS_DISPLAY,DISPLAY_NONE,CSS_WIDTH,HU.px(this.popupWidth),CSS_HEIGHT,HU.px(this.popupHeight),CSS_OVERFLOW_Y,OVERFLOW_HIDDEN,CSS_OVERFLOW_X,OVERFLOW_HIDDEN,CSS_POSITION,POSITION_ABSOLUTE,CSS_TOP,HU.px(0),CSS_LEFT,HU.px(g))],"")),u=HU.table([ATTR_BORDER,0,ATTR_WIDTH,HU.perc(100)],HU.tr([ATTR_VALIGN,CSS_TOP],HU.td([ATTR_WIDTH,HU.perc(2)],HU.div([ATTR_ID,this.domId(s),ATTR_STYLE,HU.css(CSS_MAX_HEIGHT,d,CSS_OVERFLOW_Y,OVERFLOW_AUTO,CSS_DISPLAY,DISPLAY_INLINE_BLOCK)],""))+HU.td([ATTR_WIDTH,HU.perc(90)],c))),T="",f=null;for(let e=0;e<t.length;e++){let i=this.getDataValues(t[e]);if(""==i[this.imageField.getIndex()])continue;f||(f=t[e]);let s=i[r.getIndex()];T+=HU.image(s,[ATTR_RECORD_INDEX,e,ATTR_ID,this.domId(l)+e,ATTR_WIDTH,n,ATTR_CLASS,"display-imagezoom-thumb"])+HU.br()+"\n"}this.setContents(u),this.jq(s).html(T);let y=this,m=this.jq(s).find(".display-imagezoom-thumb"),_=e=>{m.css(CSS_BORDER,HU.border(1,COLOR_TRANSPARENT)),e.css(CSS_BORDER,HU.border(1,this.getHighlightColor()));let i=parseFloat(e.attr(ATTR_RECORD_INDEX));HU.addToDocumentUrl("imagezoom_thumb",i);let s=t[i];y.handleImage(s),y.propagateEventRecordSelection({record:s})};m.mouseover((function(){_($(this))})),this.jq(s).css(CSS_BORDER,HU.border(1,COLOR_TRANSPARENT));let S=HU.getUrlArgument("imagezoom_thumb"),A=HU.getUrlArgument("imagezoom_x"),I=HU.getUrlArgument("imagezoom_y"),b=this.jq(l+(S||"0"));b.length&&_(b),S&&this.showPopup(),Utils.isDefined(A)&&setTimeout((()=>{this.handleMouseMove({x:parseFloat(A),y:parseFloat(I)})}),250),this.jq(a).click((e=>{let t=+this.getPopupImageWidth();event.shiftKey?this.setProperty("popupImageWidth",Math.max(.9*t,500)):this.setProperty("popupImageWidth",1.2*t),this.showPopup(),this.handleMouseMove()}))},showPopup:function(){if(!this.currentRecord)return;let e=this.getDataValues(this.currentRecord)[this.imageField.getIndex()];this.jq(o).css(CSS_DISPLAY,DISPLAY_BLOCK);let t=[ATTR_ID,this.domId(n)];this.getPopupImageWidth()&&t.push(ATTR_WIDTH,this.getPopupImageWidth()),this.jq(o).html(HU.image(e,t))},handleImage:function(e,t){this.currentRecord=e;let i=this.getDataValues(e),s=i[this.imageField.getIndex()],l=this.getProperty("imageWidth",500),d="";if(this.labelFields.length>0&&(this.labelFields.map((e=>{d+=" "+i[e.getIndex()]})),this.urlField)){var g=this.urlField.getValue(e);g&&""!=g&&(d="<a style='color:inherit;'  href='"+g+"' target=_other>"+d+"</a>")}let p=HU.image(s,["x","+:zoom in/-:zoom out",ATTR_STYLE,HU.css(CSS_Z_INDEX,1e3),ATTR_WIDTH,l,ATTR_ID,this.domId(r)]);""!=d&&(p+=HU.div([ATTR_STYLE,HU.css(CSS_COLOR,COLOR_BLACK)],d)),this.jq(a).html(p),this.jq(o).html(""),this.jq(o).css(CSS_DISPLAY,DISPLAY_NONE),this.jq(r).mouseenter((()=>{this.showPopup()})),this.jq(r).mouseout((()=>{this.jq(o).html(""),this.jq(o).css(CSS_DISPLAY,DISPLAY_NONE),this.jq(h).css(CSS_DISPLAY,DISPLAY_NONE)})),this.jq(r).mousemove((e=>{this.handleMouseMove({event:e})})),t&&this.jq(n).offset(t)},handleMouseMove(e){e||(e={event:this.currentMouseEvent}),this.currentMouseEvent=e.event;let t=this.jq(r),i=t.width(),s=t.height(),l=this.jq(n),a=l.width(),o=l.height();if(0==s||0==o)return!1;let d=i/a,g=s/o,p=d*l.parent().width(),c=g*l.parent().height(),u=p/2,T=c/2,f=t.parent().offset();Utils.isDefined(e.x)||(e.x=e.event.pageX-f.left),Utils.isDefined(e.y)||(e.y=e.event.pageY-f.top),e.x<u&&(e.x=u),e.y<T&&(e.y=T),e.x>i-u&&(e.x=i-u),e.y>s-T&&(e.y=s-T);let y=(e.x-u)/i,m=(e.y-T)/s;if(0==l.parent().length)return;let _=l.parent().offset(),S={left:_.left-y*a,top:_.top-m*o};return this.jq(n).offset(S),this.jq(h).css({display:DISPLAY_BLOCK,top:HU.px(e.y-T),left:HU.px(e.x-u),width:HU.px(p),height:HU.px(c)}),!0}})}function RamaddaSlidesDisplay(e,t,i){const s="slide",l="strip";i.imageField&&i.showStrip&&Utils.isDefined(i.width);const a=new RamaddaFieldsDisplay(e,t,DISPLAY_SLIDES,i);defineDisplay(addRamaddaDisplay(this),a,[{label:"Slides Attributes"},{p:"template",ex:""},{p:"mediaField",ex:"",tt:"Field that contains a URL to an image, youtube, etc"},{p:"showStrip",ex:"true",tt:"Show the navigation strip"},{p:"slideWidth",ex:"100px"},{p:"thumbnailField",ex:""},{p:"thumbnailWidth",ex:"100px"},{p:"urlField",ex:""},{p:"labelField",ex:""},{p:"labelTemplate",ex:"${name} ..."},{p:"topLabelTemplate",ex:"${name} ..."},{p:"tooltipFields",ex:""}],{slideIndex:0,handleEventRecordSelection:function(e,t){if(!this.records)return;let i=this.findRecordIndex(this.records,t.record);i>=0&&(this.slideIndex=i,this.displaySlide())},getContentsStyle:function(){var e="",t=this.getHeightForStyle();t&&(e+=HU.css(CSS_HEIGHT,t));var i=this.getWidthForStyle();return i&&(e+=HU.css(CSS_WIDTH,i)),e},updateUI:function(){if(null==this.getData())return;if(this.records=this.filterData(),!this.records)return;this.fields=this.getData().getRecordFields(),this.records=this.sortRecords(this.records),this.theTemplate=this.getProperty("template",""),this.urlField=this.getFieldById(null,this.getProperty("urlField")),this.labelField=this.getFieldById(null,this.getLabelField()),this.topLabelTemplate=this.getTopLabelTemplate(),this.labelTemplate=this.getLabelTemplate(),this.tooltipFields=this.getFieldsByIds(null,this.getProperty("tooltipFields")),this.mediaField=this.getFieldById(null,this.getProperty("mediaField",this.getProperty("imageField"))),this.thumbnailField=this.getFieldById(null,this.getProperty("thumbnailField"))||this.mediaField;let e=this.getHeightForStyle("400"),t=HU.div([ATTR_ID,this.domId(ID_PREV),ATTR_STYLE,HU.css(CSS_PADDING_RIGHT,HU.px(10),CSS_FONT_SIZE,HU.perc(200)),ATTR_CLASS,HU.classes(CLASS_CLICKABLE,"display-slides-arrow-left fas fa-angle-left")]),i=HU.div([ATTR_ID,this.domId(ID_NEXT),ATTR_STYLE,HU.css(CSS_PADDING_LEFT,HU.px(10),CSS_FONT_SIZE,HU.perc(200)),ATTR_CLASS,HU.classes(CLASS_CLICKABLE,"display-slides-arrow-right fas fa-angle-right")]),a=HU.div([ATTR_CLASS,"display-slides-slide",ATTR_STYLE,HU.css(CSS_OVERFLOW_Y,OVERFLOW_AUTO,CSS_MAX_HEIGHT,e),ATTR_ID,this.domId(s),ATTR_CLASS,"display-slides-slide"]),r="";if(this.showStrip=this.thumbnailField&&this.getProperty("showStrip"),this.showStrip){let e=HU.css(CSS_OVERFLOW_X,OVERFLOW_AUTO,CSS_MAX_WIDTH,HU.perc(100))+this.getProperty("stripStyle","");r=HU.div([ATTR_ID,this.domId(l),ATTR_CLASS,"display-slides-strip",ATTR_TABINDEX,"0",ATTR_STYLE,e])}let o=r+HU.div([ATTR_STYLE,HU.css(CSS_POSITION,POSITION_RELATIVE)],a+t+i);if(this.setContents(o),this.showStrip){let e=HU.getDimension(this.getThumbnailWidth(HU.px(100))),t="";this.records.forEach(((i,s)=>{let l=this.thumbnailField.getValue(i);if(""+l=="NaN"&&(l=null),Utils.stringDefined(l)||this.mediaField&&(l=this.mediaField.getValue(i)),!Utils.stringDefined(l))return;let a="display-slides-strip-image";0==s&&(a+=" display-slides-strip-image-selected");let r=HU.makeMultiline(this.tooltipFields.map((e=>e.getValue(i))));if(Utils.isImage(l))t+=HU.div([],HU.image(l,[ATTR_LOADING,LOADING_LAZY,ATTR_TITLE,r,ATTR_WIDTH,e,ATTR_CLASS,a,ATTR_RECORD_INDEX,s]));else{let o="";if(this.labelField)o=this.labelField.getValue(i);else{o="Record:"+s;let e=Utils.getFileTail(l);e&&(o+=HU.br()+e)}""==r&&(r=o),l.match(/youtube.com\/watch/)&&(o=HU.image(RamaddaUtil.getCdnUrl("/media/youtube.png"))+" "+o),r=r.replace(/<br>/g,HU.BR_ENTITY),t+=HU.div([ATTR_TITLE,r,ATTR_STYLE,HU.css(CSS_DISPLAY,DISPLAY_INLINE_BLOCK,CSS_MIN_WIDTH,e,CSS_WIDTH,e,CSS_OVERFLOW_X,OVERFLOW_HIDDEN),ATTR_CLASS,a,ATTR_RECORD_INDEX,s],o)}}));let i=this.jq(l);i.html(t);let s=this;this.stripImages=i.find(".display-slides-strip-image"),i.mouseenter((function(e){i.focus()})),i.keydown((function(e){39==e.which?(s.slideIndex++,s.displaySlide(!0)):37==e.which&&(s.slideIndex--,s.displaySlide(!0))})),this.stripImages.click((function(){s.stripImages.removeClass("display-slides-strip-image-selected"),$(this).addClass("display-slides-strip-image-selected"),s.slideIndex=$(this).attr(ATTR_RECORD_INDEX),s.displaySlide(!0,!0)}))}this.jq(ID_PREV).click((()=>{this.slideIndex--,this.displaySlide(!0)})),this.jq(ID_NEXT).click((()=>{this.slideIndex++,this.displaySlide(!0)})),setTimeout((()=>{this.displaySlide()}),200)},displaySlide:function(e,t){let i=this,l=this.getSlideWidth(HU.perc(100));this.slideIndex<0&&(this.slideIndex=0),this.slideIndex>=this.records.length&&(this.slideIndex=this.records.length-1),0==this.slideIndex?this.jq(ID_PREV).hide():this.jq(ID_PREV).show(),this.slideIndex==this.records.length-1?this.jq(ID_NEXT).hide():this.jq(ID_NEXT).show(),!t&&this.showStrip&&(this.stripImages.removeClass("display-slides-strip-image-selected"),this.stripImages.find(HU.attrSelect(ATTR_RECORD_INDEX,this.slideIndex)).addClass("display-slides-strip-image-selected"),this.stripImages.each((function(){+$(this).attr(ATTR_RECORD_INDEX)==i.slideIndex&&($(this).addClass("display-slides-strip-image-selected"),$(this).scrollintoview({direction:"x"}))})));let a,r=this.records[this.slideIndex],o=this.getDataValues(r),n="";if(this.urlField&&(a=this.urlField.getValue(r)),Utils.stringDefined(this.theTemplate))n=this.applyRecordTemplate(r,o,this.fields,this.theTemplate);else if(this.mediaField){let e=this.mediaField.getValue(r);if(n=Utils.isImage(e)?HU.image(e,[ATTR_STYLE,HU.css(CSS_WIDTH,l)]):e.match(".mp3")?HU.center(Utils.embedAudio(e)):e.match("soundcloud")?HU.center(HU.open(TAG_IFRAME,["scrolling","no",ATTR_SRC,HU.url("https://w.soundcloud.com/player/","visual","true",ARG_URL,e,"maxwidth",450),ATTR_WIDTH,450,ATTR_HEIGHT,390,"frameborder"])):e.match(/youtube.com\/watch/)||e.match(/youtu.be/)?HU.center(Utils.embedYoutube(e)):HU.center(HU.tag(TAG_IFRAME,[ATTR_SRC,e,ATTR_WIDTH,640,ATTR_HEIGHT,351,"frameborder",0,"webkitallowfullscreen",!0,"mozallowfullscreen","true","allowfullscreen","true"])),n&&a&&!this.topLabelTemplate&&(n=n+HU.br()+HU.href(a,"Link",[ATTR_TARGET,"_link"])),this.tooltipFields){let e=HU.makeMultiline(this.tooltipFields.map((e=>e.getValue(r))));n=HU.div([ATTR_TITLE,e],n)}if(this.labelField&&(n+=HU.div([ATTR_CLASS,"display-slides-label"],this.labelField.getValue(r))),this.topLabelTemplate){let e=this.applyRecordTemplate(r,this.getDataValues(r),null,this.topLabelTemplate);a&&(e=HU.href(a,e)),n=HU.div([ATTR_CLASS,"display-slides-label"],e)+n}if(this.labelTemplate){let e=this.applyRecordTemplate(r,this.getDataValues(r),null,this.labelTemplate);n+=HU.div([ATTR_CLASS,"display-slides-label"],e)}}n=n.replace(/\${recordIndex}/g,this.slideIndex+1),this.jq(s).html(n);let h={highlight:!0,record:r};e&&this.getDisplayManager().notifyEvent(DisplayEvent.recordHighlight,this,h)},handleEventRecordHighlight:function(e,t){}})}addGlobalDisplayType({type:DISPLAY_IMAGES,label:"Images",requiresData:!0,forUser:!0,category:CATEGORY_IMAGES,tooltip:makeDisplayTooltip("Image Gallery","images.png")}),addGlobalDisplayType({type:DISPLAY_IMAGEZOOM,label:"Image Zoom",requiresData:!0,forUser:!0,category:CATEGORY_IMAGES,tooltip:makeDisplayTooltip("Image Zoom","imagezoom.png","Show a set of images and allow for zooming in")}),addGlobalDisplayType({type:DISPLAY_SLIDES,label:"Slides",requiresData:!0,forUser:!0,category:CATEGORY_IMAGES,tooltip:makeDisplayTooltip("Show records in a slide like format","slides.png")}),addGlobalDisplayType({type:DISPLAY_CARDS,label:"Cards",requiresData:!0,forUser:!0,category:CATEGORY_IMAGES,tooltip:makeDisplayTooltip("Group records hierachically showing images","cards.png")});const DISPLAY_ANIMATION="animation",DISPLAY_LABEL="label",DISPLAY_DOWNLOAD="download",DISPLAY_LEGEND="legend",DISPLAY_RELOADER="reloader",DISPLAY_MESSAGE="message",DISPLAY_FIELDSLIST="fieldslist",DISPLAY_TICKS="ticks",DISPLAY_MENU="menu";function RamaddaAnimationDisplay(e,t,i){var s="start",l="time";let a=new RamaddaDisplay(e,t,DISPLAY_ANIMATION,i);defineDisplay(addRamaddaDisplay(this),a,[{label:"Animation Control"},{p:"sleepTime",ex:"100",tt:"sleep in milliseconds"},{p:"startIndex",d:0}],{running:!1,timestamp:0,iconStart:ICON_PLAY,iconStop:ICON_STOP,iconBack:"fa-step-backward",iconForward:"fa-step-forward",iconSlower:"fa-minus",iconFaster:"fa-plus",iconBegin:"fa-fast-backward",iconEnd:"fa-fast-forward",needsData:function(){return!0},deltaIndex:function(e){this.stop(),this.setIndex(this.index+e)},setIndex:function(e){e<0&&(e=0),this.index=e,this.applyStep(!0,!Utils.isDefined(e))},toggle:function(){this.running?this.stop():this.start()},tick:function(){if(this.running){this.index++,this.applyStep();var e=this;setTimeout((function(){e.tick()}),this.sleepTime)}},applyStep:function(e,t){Utils.isDefined(e)||(e=!0);let i=this.currentRecords;if(null!=i){t&&(this.index=i.length-1),this.index>=i.length&&(this.index=0);var s=i[this.index],a="";if(null!=s.getDate()){var r=this.formatDate(s.getDate(),{suffix:this.getTimeZone()});a+=HU.boldLabel("Date")+" "+r}else a+=HU.boldLabel("Index")+" "+this.index;jqid(this.getDomId(l)).html(a),e&&this.propagateEventRecordSelection({record:s})}else jqid(this.getDomId(l)).html("No data")},handleEventRecordSelection:function(e,t){if(!t.record)return;let i=this.currentRecords;i||t.record&&(i=[t.record]),i.every(((e,i)=>e.getId()!=t.record.getId()&&e.getTime()!=t.record.getTime()||(this.index=i,this.applyStep(!1),!1)))},faster:function(){this.sleepTime=this.sleepTime/2,0==this.sleepTime&&(this.sleepTime=10)},slower:function(){this.sleepTime=1.5*this.sleepTime},start:function(){this.running||(this.running=!0,this.timestamp++,jqid(this.getDomId(s)).html(HU.getIconImage(this.iconStop)),this.tick())},stop:function(){this.running&&(this.running=!1,this.timestamp++,jqid(this.getDomId(s)).html(HU.getIconImage(this.iconStart)))},updateUI:function(){let e=this.filterData();if(!e)return;this.currentRecords=e,this.stop();this.getGet();var t="";let i=(e,i,s,l)=>{let a=[ATTR_STYLE,HU.css(CSS_MARGIN_RIGHT,HU.px(6)),ATTR_CLASS,CLASS_CLICKABLE,ATTR_TITLE,i,ATTR_COMMAND,e];l&&a.push(ATTR_ID,this.domId(l)),t+=HU.span(a,HU.getIconImage(s))};i("start","Go to start",this.iconBegin),i("-1","Step back; shift-click step back 10",this.iconBack),i("play","Start/Stop",this.iconStart,s),i("1","Step Forward; shift-click step forward 10",this.iconForward),i("end","Go to end",this.iconEnd),t+=SPACE2,i("-","Slower",this.iconSlower),i("+","Faster",this.iconFaster),t+=HU.div([ATTR_STYLE,HU.css(CSS_DISPLAY,DISPLAY_INLINE_BLOCK,CSS_MIN_HEIGHT,HU.px(24),CSS_MARGIN_LEFT,HU.px(10)),ATTR_ID,this.getDomId(l)],SPACE),this.setDisplayTitle("Animation"),this.setContents(t);let a=this;this.getContents().find("[command]").click((function(e){let t=$(this).attr(ATTR_COMMAND),i=e.shiftKey;switch(t){case"start":a.setIndex(0);break;case"end":a.setIndex();break;case"-1":a.deltaIndex(i?-10:-1);break;case"1":a.deltaIndex(i?10:1);break;case"play":a.toggle();break;case"+":a.faster();break;case"-":a.slower()}})),Utils.isDefined(this.index)||this.setIndex(Math.min(e.length-1,this.getStartIndex(0)))}}),this.sleepTime=+this.getSleepTime(this.getProperty("animationSpeed",500))}function RamaddaMessageDisplay(e,t,i){const s=new RamaddaDisplay(e,t,DISPLAY_MESSAGE,i);defineDisplay(addRamaddaDisplay(this),s,[],{needsData:function(){return!1},updateUI:function(){this.getProperty("decorate",!0)?this.setContents(this.getMessage(this.getProperty("message",this.getNoDataMessage()))):this.setContents(this.getProperty("message",this.getNoDataMessage()))}})}function RamaddaFieldslistDisplay(e,t,i){const s="popup",l="popupbutton",a="clearall",r="pagesearch",o="setall",n=new RamaddaDisplay(e,t,DISPLAY_FIELDSLIST,i);defineDisplay(addRamaddaDisplay(this),n,[{label:"Fields List"},{p:"displayFields",tt:"Fields to display"},{p:"numericOnly",ex:!0},{p:"reverseFields",ex:!0},{p:"decorate",ex:!0},{p:"asList",d:!0},{p:"sortFields",d:!0,ex:!0},{p:"includeLatLon",d:!1,ex:!0},{p:"selectable",ex:!0},{p:"showFieldDetails",ex:!0},{p:"showSelectAll",d:!0,ex:!1},{p:"showPopup",d:!1,ex:!0,tt:"Popup the selector"},{p:"selectOne",ex:!0},{p:"some_field.color",ex:"red",tt:"add a color block"},{p:"selectLabel",tt:"Label to use for the button"},{p:"filterSelect",ex:!0,tt:"Use this display to select filter fields"},{p:"filterSelectLabel",tt:"Label to use for the button"}],{needsData:function(){return!0},fieldsToMap:{},getFieldsKey:function(){let e=this.getFields(),t="";return e.forEach((e=>{t+="_"+e.getId()})),t},setEntry:function(e){if(this.selectedMap){let e=this.getFieldsKey();this.fieldsToMap[e]=this.selectedMap}this.selectedMap=null,this.fields=null,n.setEntry.call(this,e)},updateUI:function(){if(null==this.filterData())return;let e,t="";e=this.getFilterSelect()?this.getFieldsByIds(null,this.getProperty("filterFields","")):this.getSelectedFields();let i=this.getFieldsKey();this.selectedMap=this.selectedMap||this.fieldsToMap[i],null==this.selectedMap?(this.selectedMap={},e&&0!=e.length?e.forEach((e=>{this.selectedMap[e.getId()]=!0})):e=null):e=null;let n=this.fields;if(!n){if(n=this.getDisplayFields()?this.getFieldsByIds(null,this.getDisplayFields(),!0):this.getData().getRecordFields(),this.getNumericOnly()&&(n=n.filter((e=>e.isFieldNumeric()))),this.getReverseFields()){let e=[];n.forEach((t=>{e.unshift(t)})),n=e}this.getIncludeLatLon()||(n=n.filter((e=>!e.isFieldGeo()))),this.getSortFields(!0)&&(n=n.sort(((e,t)=>e.getDescription().localeCompare(t.getDescription()))))}this.fields=n,this.fieldsMap={},this.fields.forEach((e=>{this.fieldsMap[e.getId()]=e}));let h=[],d=HU.classes(CLASS_CLICKABLE,"display-fields-field"),g=this.getAsList();this.getDecorate(!0)&&(d+=HU.classes(d,"display-fields-field-decorated")),g&&(d+=HU.classes(d,"display-fields-list-field"));let p=this.getSelectable(!0),c=this.getShowFieldDetails(!1);n.forEach(((e,t)=>{let i=e.getLabel(),s=this.getProperty(e.getId()+".color");s&&(i+=HU.div([ATTR_CLASS,"display-fields-field-color",ATTR_STYLE,HU.css(CSS_BACKGROUND,s)])),i=HU.div([ATTR_STYLE,HU.css(CSS_POSITION,POSITION_RELATIVE)],i),c&&(i+=HU.br()+e.getId()+e.getUnitSuffix()+HU.br()+e.getType());let l=d,a=this.selectedMap[e.getId()];p&&(l+=" display-fields-field-selectable "),p&&a&&(l+=" display-fields-field-selected ");let r=e.getId();p&&(r+=" - Click to toggle. Shift-click toggle all"),i=HU.div([ATTR_TITLE,r,"field-selected",a,ATTR_FIELD_ID,e.getId(),ATTR_CLASS,l],i),h.push(i)})),t+=Utils.wrap(h,"","");let u=this.getSelectLabel(this.getFilterSelect()?this.getFilterSelectLabel("Select Filter Fields"):"Select fields"),T="";T+=HU.span([ATTR_ID,this.getDomId(a),ATTR_CLASS,CLASS_BUTTON],"Clear all"),T+=HU.space(1),this.getShowSelectAll()&&(T+=HU.span([ATTR_ID,this.getDomId(o),ATTR_CLASS,CLASS_BUTTON],"Set all"));let f=HU.div([ATTR_ID,this.domId(r)],"");T=HU.leftRightTable(T,f),T=HU.div([ATTR_STYLE,HU.css(CSS_MARGIN,HU.px(4))],T),t=HU.div([ATTR_STYLE,HU.css(CSS_MAX_HEIGHT,HU.px(300),CSS_OVERFLOW_Y,OVERFLOW_AUTO,CSS_WIDTH,HU.px(600))],t);let y=HU.getUniqueId("fields");if(t=HU.div([ATTR_ID,y],t),t=T+t,this.getShowPopup()&&(t=HU.div([ATTR_ID,this.domId(l)],u)+HU.div([ATTR_ID,this.domId(s),ATTR_STYLE,HU.css(CSS_DISPLAY,DISPLAY_NONE,CSS_MARGIN,HU.px(4))],t)),this.setContents(t),HU.initPageSearch(".display-fields-field","#"+y,"Search fields",!1,{target:"#"+this.domId(r)}),this.jq(a).button().click((()=>{this.toggleAll(!1),this.handleFieldSelect()})),this.jq(o).button().click((()=>{this.toggleAll(!0),this.handleFieldSelect()})),this.getShowPopup()&&this.jq(l).button().click((()=>{this.fieldsDialog=HU.makeDialog({contentId:this.domId(s),title:u,inPlace:!0,anchor:this.domId(l),draggable:!0,header:!0,sticky:!0})})),p){let e=this,t=this.find(".display-fields-field");t.draggable({stop:function(){},containment:this.domId(ID_DISPLAY_CONTENTS),revert:!0}),t.droppable({hoverClass:"display-fields-droppable",accept:".display-fields-field",drop:function(t,i){let s=i.draggable.attr(ATTR_FIELD_ID),l=$(this).attr(ATTR_FIELD_ID),a=e.fields.find((e=>e.getId()==s?e:null)),r=e.fields.find((e=>e.getId()==l?e:null));a?r?(Utils.moveBefore(e.fields,r,a),e.printFields(),e.updateUI(),e.handleFieldSelect()):console.log("could not find target field:"+l):console.log("could not find dragged field:"+s)}}),this.fieldBoxes=t,t.click((function(t){if(t.metaKey)return void e.printFields();let i,s=t.shiftKey,l="true"==$(this).attr("field-selected");if(e.getSelectOne()){if(l)return;l=!0,i=!1,s=!0}else l=!l,i=l;s&&e.toggleAll(i),$(this).attr("field-selected",l),l?$(this).addClass("display-fields-field-selected"):$(this).removeClass("display-fields-field-selected"),e.handleFieldSelect()}))}},toggleAll:function(e){this.fieldBoxes.attr("field-selected",e),e?this.fieldBoxes.addClass("display-fields-field-selected"):this.fieldBoxes.removeClass("display-fields-field-selected")},printFields:function(){if(!this.canEdit())return;let e=this.fields.reduce(((e,t,i)=>e+(0==i?"":",")+t.getId()),'fields="');e+='"\n\n',e+=this.getActiveFields().reduce(((e,t,i)=>e+(0==i?"":",")+t.getId()),'displayFields="'),e+='"\n',Utils.copyToClipboard(e),console.log(e)},getActiveFields:function(){let e=this,t=this.fieldsDialog&&this.fieldsDialog.length?this.fieldsDialog.find(".display-fields-field"):this.find(".display-fields-field"),i={},s=[];return t.each((function(){if("true"==$(this).attr("field-selected")){let t=$(this).attr(ATTR_FIELD_ID),s=e.fieldsMap[t];s&&(i[s.getId()]=!0)}})),this.fields.forEach((e=>{i[e.getId()]&&s.push(e)})),e.selectedMap={},s.forEach((t=>{e.selectedMap[t.getId()]=!0})),s},handleFieldSelect:function(){let e=this,t=this.getActiveFields();setTimeout((()=>{e.getFilterSelect()?e.propagateEvent(DisplayEvent.filterFieldsSelected,t):e.propagateEvent(DisplayEvent.fieldsSelected,t)}),20)}})}function RamaddaLabelDisplay(e,t,i){var s="text",l="edit";i&&!Utils.isDefined(i.showTitle)&&(i.showTitle=!1),this.text="",this.editMode=i.editMode,i.text?this.text=i.text:i.label?this.text=i.label:i.html&&(this.text=i.html),i[ATTR_CLASS]?this[ATTR_CLASS]=i[ATTR_CLASS]:this[ATTR_CLASS]="display-text";const a=new RamaddaDisplay(e,t,DISPLAY_LABEL,i);defineDisplay(addRamaddaDisplay(this),a,[],{initDisplay:function(){var e=this;this.createUI();var t=this[ATTR_CLASS];this.editMode&&(t+=" display-text-edit ");var i=HU.css(CSS_COLOR,this.getTextColor("contentsColor")),a=HU.div([ATTR_CLASS,t,ATTR_ID,this.getDomId(s),ATTR_STYLE,i],this.text);if(this.editMode&&(a+=HU.textarea(l,this.text,[ATTR_ROWS,5,ATTR_COLS,120,ATTR_SIZE,120,ATTR_CLASS,"display-text-input",ATTR_ID,this.getDomId(l)])),this.setContents(a),this.editMode){var r=this.jq(l);r.blur((function(){e.text=r.val(),r.hide(),e.initDisplay()})),this.jq(s).click((function(){var t=e.jq(s),i=e.jq(l);i.show(),i.css("z-index","9999"),i.position({of:t,my:POS_LEFT_TOP,at:POS_LEFT_TOP,collision:"none none"}),e.jq(s).html("")}))}},getWikiAttributes:function(e){a.getWikiAttributes(e),e.push("text"),e.push(this.text)}})}function RamaddaLegendDisplay(e,t,i){i.width||(i.width="100%");let s=new RamaddaDisplay(e,t,DISPLAY_LEGEND,i);RamaddaUtil.inherit(this,s);let l=[{label:"Legend"},{p:"labels",ex:""},{p:"colors",ex:""},{p:"circles",ex:"true"},{p:"inBox",ex:"true"},{p:"labelColor",ex:COLOR_WHITE},{p:"labelColors",ex:"color1,color2,..."},{p:"labelField",ex:""},{p:"orientation",ex:"vertical"}];defineDisplay(addRamaddaDisplay(this),s,l,{getColorList:function(){if(this.getProperty("colorTable")){return this.getColorTable().colors}return s.getColorList.call(this)},needsData:function(){return null!=this.getProperty("labelField")},updateUI:function(){let e,t=this.getProperty("labels","").split(","),i=this.getFieldById(null,this.getProperty("labelField"));if(i){let e=this.filterData();if(!e)return void this.setDisplayMessage(this.getLoadingMessage());t=[],e.forEach((e=>{t.push(i.getValue(e))}))}this.getProperty("colorTable")&&(e=new ColorByInfo(this,[],[]),t=[]);let s=this.getColorList(),l="",a=this.getProperty("colorWidth",HU.px(20)),r=this.getProperty("labelColor",COLOR_BLACK),o=this.getProperty("labelColors")?this.getProperty("labelColors").split(","):null,n=this.getProperty("inBox",!1),h=this.getProperty("orientation","horizontal"),d="horizontal"==h?" ":HU.br(),g=this.getCircles();for(let e=0;e<t.length;e++){let i=t[e],h=s[e]||COLOR_WHITE;if(e>0&&(l+=d),n){let t=o?o[e]:r||r;l+=HU.div([ATTR_CLASS,"display-legend-color",ATTR_STYLE,HU.css(CSS_MARGIN_LEFT,HU.px(8),CSS_BACKGROUND,h)],HU.div([ATTR_CLASS,"display-legend-label",ATTR_STYLE,HU.css(CSS_MARGIN_LEFT,HU.px(8),CSS_MARGIN_RIGHT,HU.px(8),CSS_COLOR,t)],i))}else l+=HU.div([ATTR_CLASS,"display-legend-item"],HU.div([ATTR_CLASS,HU.classes("display-legend-color",g?"display-colortable-dot":""),ATTR_STYLE,HU.css(CSS_BACKGROUND,h,CSS_WIDTH,a)+(g?HU.css(CSS_HEIGHT,a):HU.css(CSS_HEIGHT,HU.px(15)))])+HU.div([ATTR_CLASS,"display-legend-label"],i))}"vertical"!=h&&(l=HU.center(l)),this.setContents(l),e&&this.displayColorTable(e,ID_COLORTABLE,this.getProperty("colorByMin",10),this.getProperty("colorByMax",100))}})}function RamaddaDownloadDisplay(e,t,i){const s=new RamaddaFieldsDisplay(e,t,DISPLAY_DOWNLOAD,i),l="downloadcsv",a="downloadjson",r="downloadcopy",o="fromdate",n="todate",h="cancel";defineDisplay(addRamaddaDisplay(this),s,[{label:"Download"},{p:"downloadLabel",ex:"Download"},{p:"useIcon",d:"false",ex:"false"},{p:"iconSize",ex:"",d:"16pt"},{p:"fileName",d:"download",ex:"download"},{p:"askFields",d:"false",ex:"true"},{p:"showRecordCount",ex:!0,tt:"Show # records"},{p:"showCsvButton",ex:!1,tt:"Show/hide the CSV button"},{p:"showJsonButton",ex:!1,tt:"Show/hide the JSON button"},{p:"showCopyButton",ex:!1,tt:"Show/hide the Copy button"},{p:"showDateSelect",d:!1,ex:!0,tt:"Show date select"}],{fieldOn:{},needsData:function(){return!0},updateUI:function(){let e=this.filterData(),t=this.getDownloadLabel(this.getProperty("csvLabel","Download Data"));t=t.replace("${title}",this.getProperty("title",""));let i=this.getUseIcon(!0),s=this.getIconSize();t=HU.div([ATTR_STYLE,HU.css(CSS_DISPLAY,DISPLAY_INLINE_BLOCK),ATTR_ID,this.getDomId("csv")],i?HU.getIconImage("fa-download",[ATTR_STYLE,HU.css(CSS_LINE_HEIGHT,HU.px(0),CSS_DISPLAY,DISPLAY_BLOCK)],[ATTR_STYLE,HU.css(CSS_CURSOR,CURSOR_POINTER,CSS_FONT_SIZE,s),ATTR_TITLE,t]):t),this.getShowRecordCount()&&(t=t+HU.space(2)+HU.span([ATTR_ID,this.domId("count")],e?"# "+e.length+" records":"")),this.setContents(HU.div([],t)),i?this.jq("csv").click((()=>{this.doDownload()})):this.jq("csv").button().click((()=>{this.doDownload()}))},getSubsetFunction:function(){let e=Utils.stringDefined(this.selectFromDate)?new Date(this.selectFromDate):null,t=Utils.stringDefined(this.selectToDate)?new Date(this.selectToDate):null;return t&&(t=new Date(t.getTime()+864e5)),e||t?i=>{if(!i.hasDate())return!1;let s=i.getDate();return!(e&&s.getTime()<e.getTime())&&!(t&&s.getTime()>t.getTime())}:null},getJson:function(e,t){e=e||this.getData().getRecordFields();let i=parseInt(this.jq("number_records").val().trim());DataUtils.getJson(e,t,this.getPropertyFileName()+".json",this.getSubsetFunction(),i)},applyFieldSelection:function(){this.getData().getRecordFields().forEach((e=>{let t=this.jq("cbx_"+e.getId()),i=HU.isChecked(t);this.fieldOn[e.getId()]=i}))},getDownloadDialog:function(e){let t=this.getSelectedFields();t&&(this.fieldOn={},this.getData().getRecordFields().forEach((e=>{this.fieldOn[e.getId()]=!1})),t.forEach((e=>{this.fieldOn[e.getId()]=!0})));let i=SPACE,s="";this.getShowCsvButton(!0)&&(s+=HU.div([ATTR_ID,this.getDomId(l)],"CSV")+i),this.getShowJsonButton(!0)&&(s+=HU.div([ATTR_ID,this.getDomId(a)],"JSON")+i),this.getShowCopyButton(!0)&&(s+=HU.div([ATTR_ID,this.getDomId(r)],"Copy")+i),s+=HU.div([ATTR_ID,this.getDomId(h)],LABEL_CANCEL);let d=HU.center("#"+HU.input("",e.length,[ATTR_ID,this.getDomId("number_records"),ATTR_TITLE,"Select # records to download",ATTR_SIZE,4])+" records");d+=HU.center(HU.span([ATTR_STYLE,HU.css(CSS_FONT_SIZE,HU.perc(80))],"Note: this downloads the data currently<br>being shown in the browser")),d+=HU.center(s),this.getShowDateSelect()&&(d+=HU.formTable(),d+=HU.formEntryLabel("From date",HU.tag(TAG_INPUT,[ATTR_ID,this.domId(o),ATTR_PLACEHOLDER,"yyyy-MM-dd",ATTR_SIZE,10,ATTR_VALUE,this.selectFromDate??""])),d+=HU.formEntryLabel("To date",HU.tag(TAG_INPUT,[ATTR_ID,this.domId(n),ATTR_PLACEHOLDER,"yyyy-MM-dd",ATTR_SIZE,10,ATTR_VALUE,this.selectToDate??""])),d+=HU.formTableClose()),d+=HU.boldLabel("Include");let g="";return g+=HU.checkbox(this.getDomId("cbx_toggle_all"),[],!0,"Toggle all")+HU.br(),this.getData().getRecordFields().forEach(((e,t)=>{let i=this.fieldOn[e.getId()];Utils.isDefined(i)||(i=!0),g+=HU.checkbox(this.getDomId("cbx_"+e.getId()),[ATTR_CLASS,"display-downloader-field-cbx"],i,e.getLabel())+HU.br()})),d+=HU.div([ATTR_STYLE,HU.css(CSS_MAX_HEIGHT,HU.px(200),CSS_OVERFLOW_Y,OVERFLOW_AUTO,CSS_MARGIN_LEFT,HU.px(10))],g),d=HU.div([ATTR_STYLE,HU.css(CSS_MARGIN,HU.px(5))],d),d},doDownload:function(){let e=this.filterData(),t=(t,i)=>{this.getShowDateSelect()&&(this.selectFromDate=this.jq(o).val(),this.selectToDate=this.jq(n).val()),this.jq(ID_DIALOG).hide();let s=this.getData().getRecordFields(),l=[];if(this.applyFieldSelection(),s.forEach((e=>{this.fieldOn[e.getId()]&&l.push(e)})),t)this.getJson(l,e);else{let t=parseInt(this.jq("number_records").val().trim());this.getCsv(l,e,i,t,this.getSubsetFunction(),this.getPropertyFileName()+".csv")}this.dialog&&this.dialog.remove(),this.dialog=null};if(this.getPropertyAskFields(!0)){let i,s=this.getDownloadDialog(e),d=()=>{this.jq("cbx_toggle_all").click((function(){let e=HU.isChecked($(this));i.find(".display-downloader-field-cbx").each((function(){$(this).prop("checked",e)}))})),this.jq(h).button().click((()=>{this.applyFieldSelection(),this.jq(ID_DIALOG).hide(),this.dialog&&this.dialog.remove(),this.dialog=null})),this.jq(l).button().click((()=>{t(!1)})),this.jq(a).button().click((()=>{t(!0)})),this.jq(r).button().click((()=>{t(!1,!0)}))};i=this.showDialog(s,this.getDomId(ID_DISPLAY_CONTENTS),d,this.getTitle()),this.getShowDateSelect()&&(this.jq(o).datepicker({dateFormat:"yy-mm-dd",changeMonth:!0,changeYear:!0,constrainInput:!1,yearRange:"1900:2100"}),this.jq(n).datepicker({dateFormat:"yy-mm-dd",changeMonth:!0,changeYear:!0,constrainInput:!1,yearRange:"1900:2100"}))}else{let t=parseInt(this.jq("number_records").val().trim());this.getCsv(null,e,t,this.getSubsetFunction(),this.getPropertyFileName()+".csv")}}})}function RamaddaReloaderDisplay(e,t,i){const s="cbx",l="countdown",a=new RamaddaFieldsDisplay(e,t,DISPLAY_RELOADER,i);defineDisplay(addRamaddaDisplay(this),a,[{label:"Reloader"},{p:"interval",ex:"30",d:30,label:"Interval"},{p:"showCheckbox",ex:"false",d:!0,label:"Show Checkbox"},{p:"showCountdown",ex:"false",d:!0,label:"Show Countdown"},{p:"doPage",ex:"true",tt:"Reload the entire page"}],{needsData:function(){return!0},reloadData:function(){let e=this.dataCollection.getList()[0];e?e.loadData(this,!0):console.log("No data to reload")},updateUI:function(){let e="";this.jq(l).length>0||(this.getPropertyShowCheckbox()&&(e+=HU.checkbox(this.getDomId(s),[],!0)),this.getPropertyShowCountdown()?e+=" "+HU.span([ATTR_CLASS,"display-reloader-label",ATTR_ID,this.getDomId(l)],this.getCountdownLabel(this.getPropertyInterval())):this.getPropertyShowCheckbox()&&(e+=" "+HU.span([ATTR_ID,this.getDomId(l)],"Reload")),this.setContents(e),this.clearDisplayMessage(),this.jq(s).change((()=>{let e=this.jq(s);HU.isChecked(e)&&this.setTimer(this.lastTime)})),this.jq(l).addClass(CLASS_CLICKABLE).css(CSS_CURSOR,CURSOR_POINTER).attr(ATTR_TITLE,"Reload").click((()=>{this.checkReload(-1)})),this.setTimer(this.getPropertyInterval()))},setDisplayMessage:function(e){},okToRun:function(){let e=this.jq(s);return 0==e.length||HU.isChecked(e)},getCountdownLabel:function(e){let t="";if(e<10&&(t=SPACE),e>60){let i=Math.round((e-e%60)/60),s=e%60;return i<10&&(i="0"+String(i)),s<10&&(s="0"+String(s)),"Reload in "+i+":"+s+t}return"Reload in "+e+" seconds"+t},updateCountdown(e){this.getPropertyShowCountdown()?this.jq(l).html(this.getCountdownLabel(e)):this.jq(l).html("Reload")},setTimer(e){this.okToRun()&&(this.lastTime=e,this.updateCountdown(e),this.lastTimeout&&clearTimeout(this.lastTimeout),this.lastTimeout=setTimeout((()=>{this.checkReload(e)}),1e3))},doReload:function(e){this.getDoPage()?location.reload(!0):this.reloadData()},checkReload:function(e){--e<=0?(this.jq(l).html("Reloading..."+HU.span([ATTR_STYLE,HU.css(CSS_COLOR,COLOR_TRANSPARENT)],"")),this.doReload(),e=this.getPropertyInterval(),this.lastTimeout&&clearTimeout(this.lastTimeout),this.lastTimeout=setTimeout((()=>{this.setTimer(e)}),1e3)):this.setTimer(e)}})}function RamaddaTicksDisplay(e,t,i){Utils.isDefined(i.animationHeight)||(i.animationHeight=HU.px(30)),i.doAnimation=!1,i.animationShowButtons=!1,i.animationMakeSlider=!1;const s="animation",l=new RamaddaFieldsDisplay(e,t,DISPLAY_TICKS,i);let a=[{label:"Time Ticks"},{p:"animationHeight",ex:HU.px(30)},{p:"showYears",ex:"true"}];defineDisplay(addRamaddaDisplay(this),l,a,{needsData:function(){return!0},dataFilterChanged:function(){l.dataFilterChanged.call(this)},updateUI:function(){let e=this.filterData();if(!e)return;this.getDateInfo(e);let t={};if(this.getPropertyShowYears(!1)){e.forEach((e=>{if(!e.getDate())return;let i=e.getDate().getUTCFullYear();null==t[i]&&(t[i]={records:[]}),t[i].records.push(e)}))}else t.all={records:e,yearCnt:"all"};let i="";Object.keys(t).sort().forEach((e=>{i+=HU.div([ATTR_CLASS,"display-ticks-ticks",ATTR_ID,this.getDomId(s+e)])})),this.setContents(i),Object.keys(t).sort().forEach(((e,i)=>{let l=t[e],a=this.getDateInfo(l.records),r=new DisplayAnimation(this,!0,{baseDomId:s+e,targetDiv:this.jq(s+e)});r.makeControls(),"all"!=e&&(a.dateMin=new Date(Date.UTC(e,0,1)),a.dateMax=new Date(Date.UTC(e,11,31))),r.init(a.dateMin,a.dateMax,l.records)}))}})}function RamaddaMenuDisplay(e,t,i){const s="menu",l=new RamaddaFieldsDisplay(e,t,DISPLAY_MENU,i);defineDisplay(addRamaddaDisplay(this),l,[{label:"Record Menu"},{p:"labelTemplate",d:"${name}"},{p:"menuLabel",ex:""},{p:"showArrows",d:!1,ex:!0},{p:"showButtons",d:!1,ex:!0},{p:"maxPerRow",tt:"When showing buttons how many buttons per row",ex:6},{p:"buttonStyle",d:""},{p:"buttonStyleOn",d:""},{p:"acceptEntrySelect",ex:!0,tt:"Accept entry select from maps"}],{initDisplay:function(){l.initDisplay.call(this),this.getProperty("acceptEntrySelect")&&RamaddaUtils.addEntryListener(((e,t)=>{if(!this.records||0==this.records.length)return;let i;this.records[0].getFields().every((e=>"id"!=e.getId()||(i=e,!1))),i&&this.records.every(((t,l)=>i.getValue(t)!=e||(this.jq(s).val(l).trigger("change"),!1)))}))},needsData:function(){return!0},handleEventRecordSelection:function(e,t){if(l.handleEventRecordSelection.call(this,e,t),!this.recordToIdx)return;let i=this.recordToIdx[t.record.getId()];Utils.isDefined(i)&&this.jq(s).val(i)},pointDataLoaded:function(e,t,i){l.pointDataLoaded.call(this,e,t,i),this.haveLoadedData&&this.records&&setTimeout((()=>{let e=this.records[+this.jq(s).val()];e&&this.propagateEventRecordSelection({record:e})}),100),this.haveLoadedData=!0},updateUI:function(){let e=this;if(this.records=this.filterData(),!this.records)return;let t=[],i=this.getLabelTemplate();if(this.recordToIdx={},this.getShowButtons()){let t=this.getButtonStyle(),s=this.getButtonStyleOn(),l=[];this.idToRecord={};let a=0,r=this.getProperty("maxPerRow",-1),o="";r>=0&&(o=HU.open(TAG_DIV,[ATTR_STYLE,HU.css(CSS_TEXT_ALIGN,ALIGN_CENTER)])),this.records.forEach(((e,o)=>{r>=0&&(a++,a>r&&(a=1,l.push(HU.vspace(HU.px(4)))));let n=this.getRecordHtml(e,null,i),h=t;0==o&&(h+=s),l.push(HU.span([ATTR_CLASS,HU.classes("display-menu-button-item",CLASS_HOVERABLE,CLASS_CLICKABLE,0==o?"display-menu-button-item-on":""),ATTR_STYLE,h,ATTR_RECORD_ID,e.getId()],n)),this.idToRecord[e.getId()]=e})),o+=Utils.join(l,""),r>=0&&(o+=HU.close(TAG_DIV)),this.setContents(o);let n=this.getContents().find(".display-menu-button-item");return void n.click((function(){if($(this).hasClass("display-menu-button-item-on"))return;let i=e.idToRecord[$(this).attr(ATTR_RECORD_ID)];n.removeClass("display-menu-button-item-on"),n.attr(ATTR_STYLE,t),n.removeClass("display-menu-button-item-on"),$(this).addClass("display-menu-button-button-on"),$(this).attr(ATTR_STYLE,t+s),e.propagateEventRecordSelection({record:i})}))}this.records.forEach(((e,s)=>{let l=this.getRecordHtml(e,null,i);t.push([s,l]),this.recordToIdx[e.getId()]=s}));let l=HU.select("",[ATTR_ID,this.getDomId(s)],t);if(this.getShowArrows(!1)){let e=this.getProperty("noun","Data"),t=HU.span([ATTR_CLASS,HU.classes("display-changeentries-button",CLASS_CLICKABLE),ATTR_TITLE,"Previous "+e,ATTR_ID,this.getDomId(ID_PREV)],HU.getIconImage("fa-chevron-left")),i=HU.span([ATTR_CLASS,HU.classes("display-changeentries-button",CLASS_CLICKABLE),ATTR_TITLE,"Next "+e,ATTR_ID,this.getDomId(ID_NEXT)],HU.getIconImage("fa-chevron-right"));l=l.replace(/\n/g,""),l=t+SPACE+l+SPACE+i}let a=this.getMenuLabel();a&&(l=a+SPACE+l),this.setContents(l),this.getShowArrows(!1)&&(this.jq(ID_PREV).click((e=>{let t=+this.jq(s).val()-1;t<0&&(t=this.records.length-1),this.jq(s).val(t).trigger("change")})),this.jq(ID_NEXT).click((e=>{let t=+this.jq(s).val()+1;t>=this.records.length&&(t=0),this.jq(s).val(t).trigger("change")}))),this.jq(s).change((()=>{let e=this.records[+this.jq(s).val()];this.propagateEventRecordSelection({record:e})}))}})}addGlobalDisplayType({type:DISPLAY_DOWNLOAD,label:"Download",requiresData:!0,forUser:!0,category:CATEGORY_CONTROLS,tooltip:makeDisplayTooltip("Show a download link",null,"Allows user to select fields and<br>download CSV and JSON")}),addGlobalDisplayType({type:DISPLAY_RELOADER,label:"Reloader",requiresData:!0,forUser:!0,category:CATEGORY_CONTROLS,tooltip:makeDisplayTooltip("Reload the displays",null,"Automatically reloads the displays on a set frequency")}),addGlobalDisplayType({type:DISPLAY_ANIMATION,label:"Animation",requiresData:!0,category:CATEGORY_CONTROLS,tooltip:makeDisplayTooltip("Steps through time to drive other displays","animation.png","")}),addGlobalDisplayType({type:DISPLAY_MESSAGE,label:"Message",requiresData:!0,forUser:!0,category:CATEGORY_CONTROLS,tooltip:makeDisplayTooltip("No data, just a formatted message",null,"")}),addGlobalDisplayType({type:DISPLAY_MENU,label:"Menu",requiresData:!0,forUser:!0,category:CATEGORY_CONTROLS,tooltip:makeDisplayTooltip("Shows records in a menu to be selected")}),addGlobalDisplayType({type:DISPLAY_FIELDSLIST,label:"Fields List",requiresData:!0,forUser:!0,category:CATEGORY_CONTROLS}),addGlobalDisplayType({type:DISPLAY_LABEL,label:"Label",requiresData:!1,category:CATEGORY_CONTROLS,tooltip:makeDisplayTooltip("No data, just a text label",null,"Useful to add text to the display layout")}),addGlobalDisplayType({type:DISPLAY_LEGEND,label:"Legend",requiresData:!1,forUser:!0,category:CATEGORY_CONTROLS,tooltip:makeDisplayTooltip("No data, just a configurable legend","legend.png")}),addGlobalDisplayType({type:DISPLAY_TICKS,label:"Ticks",requiresData:!0,forUser:!0,category:CATEGORY_CONTROLS,tooltip:makeDisplayTooltip("Shows records as ticks in a timeline","ticks.png")});const DISPLAY_NOTEBOOK="notebook";addGlobalDisplayType({type:DISPLAY_NOTEBOOK,label:"Notebook",requiresData:!1,category:CATEGORY_CONTROLS});var pluginDefintions={jsx:{languageId:"jsx",displayName:"React JSX",url:"https://raw.githubusercontent.com/hamilton/iodide-jsx/master/docs/evaluate-jsx.js",module:"jsx",evaluator:"evaluateJSX",pluginType:"language"},lisp:{languageId:"lisp",displayName:"Microtalk Lisp",url:"https://ds604.neocities.org/js/microtalk.js",module:"MICROTALK",evaluator:"evaluate",pluginType:"language",outputHandler:"processLispOutput"},sql:{languageId:"sql",displayName:"SqlLite",url:ramaddaBaseHtdocs+"/lib/notebook/sqllite.js",module:"SqlLite",evaluator:"evaluate",pluginType:"language"},plantuml:{languageId:"plantuml",displayName:"PlantUml",codeMirrorMode:"",keybinding:"x",url:"https://raw.githubusercontent.com/six42/iodide-plantuml-plugin/master/src/iodide-plantuml-plugin.js",depends:[{type:"js",url:"https://raw.githubusercontent.com/johan/js-deflate/master/rawdeflate.js"}],module:"plantuml",evaluator:"plantuml_img",pluginType:"language"},ml:{languageId:"ml",displayName:"ocaml",codeMirrorMode:"mllike",keybinding:"o",url:"https://louisabraham.github.io/domical/eval.js",module:"evaluator",evaluator:"execute",pluginType:"language",depends:[{type:"css",url:"https://louisabraham.github.io/domical/style.css"}]}};function RamaddaNotebookDisplay(e,t,i){var s="notebook",l="cells",r="cellsbottom",o="inputs",n="outputs",h="console",d="consoletoolbar",g="consolecontainer",p="consoleout",c="menu";this.properties=i||{};let u=new RamaddaDisplay(e,t,DISPLAY_NOTEBOOK,i);RamaddaUtil.inherit(this,u),addRamaddaDisplay(this),RamaddaUtil.defineMembers(this,{runOnLoad:this.getProperty("runOnLoad",!0),displayMode:this.getProperty("displayMode",!1),showConsole:this.getProperty("showConsole",!0),consoleHidden:this.getProperty("consoleHidden",!1),layout:this.getProperty("layout","horizontal"),columns:this.getProperty("columns",1)}),RamaddaUtil.defineMembers(this,{cells:[],cellCount:0,fetchedNotebook:!1,currentEntries:{},globals:{},baseEntries:{},outputRenderers:[],initDisplay:async function(){this.createUI();var e=(i=HU.div([ATTR_ID,this.getDomId("imports")]))+HU.div([ATTR_CLASS,"display-notebook-cells",ATTR_ID,this.getDomId(l)],SPACE2+"Loading...")+HU.div([ATTR_ID,this.getDomId(r)]),t=HU.div([ATTR_CLASS,CLASS_POPUP,ATTR_ID,this.getDomId(c)]);if(e=HU.div([ATTR_ID,this.getDomId(s)],t+e),this.setContents(e),this.makeCellLayout(),this.jq(s).hover((()=>{}),(()=>{this.jq(c).hide()})),this.fetchedNotebook)this.layoutCells();else if(this.initOutputRenderers(),!this.fetchingNotebook){this.fetchingNotebook=!0,await Utils.importJS(ramaddaBaseHtdocs+"/lib/ace/src-min/ace.js"),await Utils.importJS(RamaddaUtil.getBaseUrl()+"/lib/showdown.min.js");var i="<link rel='preload' href='https://cdn.jsdelivr.net/npm/katex@0.10.1/dist/fonts/KaTeX_Main-Regular.woff2' as='font' type='font/woff2' crossorigin='anonymous'>\n<link rel='preload' href='https://cdn.jsdelivr.net/npm/katex@0.10.1/dist/fonts/KaTeX_Math-Italic.woff2' as='font' type='font/woff2' crossorigin='anonymous'>\n<link rel='preload' href='https://cdn.jsdelivr.net/npm/katex@0.10.1/dist/fonts/KaTeX_Size2-Regular.woff2' as='font' type='font/woff2' crossorigin='anonymous'>\n<link rel='preload' href='https://cdn.jsdelivr.net/npm/katex@0.10.1/dist/fonts/KaTeX_Size4-Regular.woff2' as='font' type='font/woff2' crossorigin='anonymous'/>\n<link rel='stylesheet' href='https://fonts.googleapis.com/css?family=Lato:300,400,700,700i'>\n<link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/katex@0.10.1/dist/katex.min.css' crossorigin='anonymous'>\n<script defer src='https://cdn.jsdelivr.net/npm/katex@0.10.1/dist/katex.min.js' crossorigin='anonymous'><\/script>";$(i).appendTo(TAG_HEAD),setTimeout((()=>this.fetchNotebook(1)),10)}},fetchNotebook:async function(e){if(!window.ace)return e>50?void alert("Could not load ace.js"):void setTimeout((()=>this.fetchNotebook(e+1)),10*e);var t=(new Date).getTime();ace.config.set("basePath",RamaddaUtil.getBaseUrl()+"/htdocs_v"+t+"/lib/ace/src-min");let i=this;this.fetchedNotebook=!0,await this.getEntry(this.getProperty("entryId",""),(e=>{this.baseEntry=e})),await this.baseEntry.getRoot((e=>{this.rootEntry=e}));var s=this.getProperty("entryId",""),l=HU.url(RamaddaUtil.getBaseUrl()+"/getnotebook",ARG_ENTRYID,s);l+="&notebookId="+this.getProperty("notebookId","default_notebook");$.getJSON(l,(function(e){i.loadJson(e)})).fail((function(){this.addCell("init cell",{showInput:!0},!1).run(),this.cells[0].focus()}))},formatObject:function(e){return Utils.formatJson(e)},initOutputRenderers:function(){let e=this;this.outputRenderers=[],this.addOutputRenderer({shouldRender:e=>Array.isArray(e),render:e=>Utils.formatJson(e)}),this.addOutputRenderer({shouldRender:e=>Array.isArray(e)&&e.length>0&&Array.isArray(e[0]),render:e=>{for(var t=HU.open(TAG_TABLE),i=0;i<e.length;i++){var s=e[i];t+=HU.open(TAG_TR);for(var l=0;l<s.length;l++)t+=HU.tag(TAG_TD,[],SPACE+s[l]);t+=HU.close(TAG_TR)}return t+=HU.close(TAG_TABLE)}}),this.addOutputRenderer({shouldRender:e=>"object"==typeof e&&e.getTime,render:t=>e.formatDate(t)}),this.addOutputRenderer({shouldRender:e=>{var t=typeof e;return"string"===t||"number"===t||"boolean"===t},render:e=>"string"==typeof e&&e.split("\n").length>1?HU.div([ATTR_STYLE,HU.css(CSS_WHITE_SPACE,"pre")],e):e}),this.addOutputRenderer({shouldRender:e=>"object"==typeof e&&"lat"in e&&"lon"in e,render:e=>"<img src='"+("http://staticmap.openstreetmap.de/staticmap.php?center="+e.lat+","+e.lon+"&zoom=17&size=400x150&maptype=mapnik")+"'/>"})},addOutputRenderer:function(e){this.outputRenderers.indexOf(e)<0&&this.outputRenderers.push(e)},formatOutput:function(e){if(!e)return null;for(var t=this.outputRenderers.length-1;t>=0;t--){var i=this.outputRenderers[t];if(i.shouldRender&&i.shouldRender(e))return i.render(e)}var s=null;return e.iodideRender?s=e.iodideRender():e.notebookRender&&(s=e.notebookRender()),s&&"string"==typeof s?s:null},getBaseEntry:function(){return this.baseEntry},getRootEntry:function(){return this.rootEntry},getPopup:function(){return this.jq(c)},loadJson:async function(e){if(e.error)this.setContents(_this.getMessage("Failed to load notebook: "+e.error));else{if(!Utils.isDefined(this.properties.runOnLoad)&&Utils.isDefined(e.runOnLoad)&&(this.runOnLoad=e.runOnLoad),!Utils.isDefined(this.properties.displayMode)&&Utils.isDefined(e.displayMode)&&(this.displayMode=e.displayMode),!Utils.isDefined(this.properties.showConsole)&&Utils.isDefined(e.showConsole)&&(this.showConsole=e.showConsole),Utils.isDefined(e.consoleHidden)&&(this.consoleHidden=e.consoleHidden),!Utils.isDefined(this.properties.columns)&&Utils.isDefined(e.columns)&&(this.columns=e.columns),!Utils.isDefined(this.properties.layout)&&Utils.isDefined(e.layout)&&(this.layout=e.layout),Utils.isDefined(e.currentEntries))for(a in e.currentEntries){var t={};if(!this.currentEntries[a]){t.name=a,t.entryId=e.currentEntries[a].entryId;try{await this.getEntry(t.entryId,(e=>t.entry=e)),this.currentEntries[a]=t}catch(e){}}}if(Utils.isDefined(e.cells)&&(this.cells=[],e.cells.forEach((e=>this.addCell(e.outputHtml,e,!0))),this.layoutCells()),0==this.cells.length){this.addCell("%%wiki\n",{showInput:!0},!1),this.layoutCells(),this.cells[0].focus()}this.runOnLoad&&this.runAll()}},addEntry:async function(e,t){var i;await this.getEntry(t,(e=>i=e)),this.currentEntries[e]={entryId:t,entry:i}},getCurrentEntries:function(){return this.currentEntries},clearEntries:function(){for(a in this.currentEntries={},this.baseEntries)this.currentEntries[a]=this.baseEntries[a]},saveNotebook:function(e){var t=this.getJson(e);t=JSON.stringify(t,null,2);var i={entryid:this.getProperty("entryId",""),notebookId:this.getProperty("notebookId","default_notebook"),notebook:t},s=RamaddaUtil.getBaseUrl()+"/savenotebook";$.post(s,i,(e=>{e.error?alert("Error saving notebook: "+e.error):"ok"==e.result?this.getShowConsole()?this.log("Notebook saved","info","nb"):alert("Notebook saved"):alert("Error saving notebook: "+e.result)}))},showInput:function(){return!(this.displayMode&&!this.getProperty("user"))&&0!=this.getProperty("showInput",!0)},getJson:function(e){var t={cells:[],currentEntries:{},runOnLoad:this.runOnLoad,displayMode:this.displayMode,showConsole:this.showConsole,consoleHidden:this.consoleHidden,layout:this.layout,columns:this.columns};for(var i in this.currentEntries){var s=this.currentEntries[i];t.currentEntries[i]={entryId:s.entryId}}return this.cells.forEach((i=>t.cells.push(i.getJson(e)))),t},initConsole:function(){if(!this.showInput())return;let e=this;this.console=this.jq(p),this.consoleHidden&&this.console.hide(),this.jq(h).find(".ramadda-image-link").click((function(t){"clear"==$(this).attr(ATTR_WHAT)&&e.console.html(""),t.stopPropagation()})),this.consoleToolbar=this.jq(d),this.consoleToolbar.click((()=>{HU.isVisible(this.console)?(this.console.hide(400),this.consoleHidden=!0):(this.consoleHidden=!1,this.console.show(400))}))},getShowConsole:function(){return this.showInput()&&this.showConsole},makeConsole:function(){if(this.console=null,!this.getShowConsole())return"";var e=this.jq(p).html(),t=HU.div([ATTR_ID,this.getDomId(d),ATTR_CLASS,"display-notebook-console-toolbar",ATTR_TITLE,"click to hide/show console"],HU.leftRight("",HU.span([ATTR_CLASS,"ramadda-image-link",ATTR_TITLE,"Clear",ATTR_WHAT,"clear"],HU.image(Utils.getIcon("clear.png")))));return HU.div([ATTR_ID,this.getDomId(h),ATTR_CLASS,"display-notebook-console"],t+HU.div([ATTR_CLASS,"display-notebook-console-output",ATTR_ID,this.getDomId(p)],e||""))},makeCellLayout:function(){var e="",t=HU.div([ATTR_ID,this.getDomId(g)]);if(this.jq(r).html(""),this.showInput()&&"horizontal"==this.layout){var i=HU.div([ATTR_ID,this.getDomId(o),ATTR_STYLE,HU.css(CSS_WIDTH,HU.perc(100))]),s=HU.div([ATTR_ID,this.getDomId(n),ATTR_STYLE,HU.css(CSS_WIDTH,HU.perc(100))]);e="<table style='table-layout:fixed;' border=0 width=100%><tr valign=top><td width=50%>"+(i+=t)+"</td><td style='border-left:1px #ccc solid;' width=1>"+HU.div([],"")+"</td><td width=49%>"+s+HU.close(TAG_TD,TAG_TR,TAG_TABLE)}else this.jq(r).html(t);this.jq(l).html(e)},plugins:{},addPlugin:async function(e,t){var i;if(e.depends)for(var s=0;s<e.depends.length;s++){var l=e.depends[s],a=l.type,r=l.url;if("js"==a?await Utils.importJS(r,(()=>{}),((e,t,s)=>{i="Error fetching plugin url:"+r})):"css"==a&&await Utils.importCSS(r,(()=>{}),((e,t,s)=>{i="Error fetching plugin url:"+r})),i)return void this.log(i,"error","nb",t?t.div:null)}r=Utils.replaceRoot(e.url);if(await Utils.importJS(r,(()=>{}),((e,t,s)=>{i="Error fetching plugin url:"+r})),!i){for(var o=e.module,n=200;null==window[o]&&n-- >0;)await new Promise((e=>setTimeout(e,100)));if(window[o]){if(window[o].isPluginReady){for(n=200;!window[o].isPluginReady()&&n-- >0;)await new Promise((e=>setTimeout(e,100)));window[o].isPluginReady()||(i="Could not load plugin module: "+o)}}else i="Could not load plugin module: "+o}i?this.log(i,"error","nb",t?t.div:null):this.plugins[e.languageId]=e},hasPlugin:async function(e,t){this.plugins[e]||window.pluginDefintions[e]&&await this.addPlugin(window.pluginDefintions[e],null),Utils.call(t,null!=this.plugins[e])},processChunkWithPlugin:async function(e,t,i){var s=this.plugins[e].module,l=this.plugins[e].evaluator,a=window[s][l](t.getContent(),t);return Utils.call(i,a)},processPluginOutput:function(e,t,i){if(i){this.plugins[e].module;var s=window[this.plugins[e].outputHandler];s?t.div.append(s(i)):"object"==typeof i||t.div.set(i)}},log:function(e,t,i,s){var l="",a="display-notebook-console-item";if("object"==typeof e&&(e=Utils.formatJson(e)),"error"==t?(a+=" display-notebook-console-item-error",l=HU.image(Utils.getIcon("cross-octagon.png")),s&&s.append(HU.div([ATTR_CLASS,"display-notebook-chunk-error"],e))):"output"==t?(a+=" display-notebook-console-item-output",l=HU.image(Utils.getIcon("arrow-000-small.png"))):"info"==t&&(a+=" display-notebook-console-item-info",l=HU.image(Utils.getIcon("information.png"))),this.console){i=i?HU.div([ATTR_CLASS,"display-notebook-console-from"],i):"";var r="<table width=100%><tr valign=top><td width=10>"+l+"</td><td>"+HU.div([ATTR_STYLE,HU.css(CSS_MARGIN_LEFT,HU.px(5))],e)+"</td><td width=10>"+i+HU.close(TAG_TD,TAG_TR,TAG_TABLE),o=HU.div([ATTR_CLASS,a],r);this.console.append(o);var n=this.console.prop("scrollHeight");n>200&&this.console.scrollTop(n-200)}},clearConsole:function(){this.console.html("")},layoutCells:function(){for(var e=0;e<this.cells.length;e++){(h=this.cells[e]).prepareToLayout()}if(this.makeCellLayout(),this.showInput()&&"horizontal"==this.layout){var t="",i="";for(e=0;e<this.cells.length;e++){(h=this.cells[e]).id,h.index=e+1,t+=HU.div([ATTR_CLASS,"display-notebook-cell",ATTR_ID,h.id+"_cellinput"],""),t+="\n",i+=HU.div([ATTR_CLASS,"display-notebook-cell",ATTR_ID,h.id+"_celloutput"],"")}this.jq(o).html(t),this.jq(n).html(i)}else{var s="<div class=row style='padding:0px;margin:0px;'>",a=HU.getBootstrapClass(this.columns),r=0;for(e=0;e<this.cells.length;e++){(h=this.cells[e]).index=e+1,s+=HU.openTag(TAG_DIV,[ATTR_CLASS,a]),s+=HU.openTag(TAG_DIV,[ATTR_STYLE,HU.css(CSS_MAX_WIDTH,HU.perc(100),CSS_OVERFLOW_X,OVERFLOW_AUTO,CSS_PADDING,HU.px(0),CSS_MARGIN,px)]),s+=HU.div([ATTR_CLASS,"display-notebook-cell",ATTR_ID,h.id+"_cellinput"],""),s+=HU.div([ATTR_CLASS,"display-notebook-cell",ATTR_ID,h.id+"_celloutput"],""),s+=HU.closeTag(TAG_DIV),s+=HU.closeTag(TAG_DIV),s+="\n",++r>=this.columns&&(r=0,s+=HU.closeTag(TAG_DIV),s+="<div class=row style='padding:0px;margin:0px;'>")}s+=HU.closeTag(TAG_DIV),this.jq(l).append(s)}for(e=0;e<this.cells.length;e++){var h;(h=this.cells[e]).createCell()}this.jq(g).html(this.makeConsole()),this.initConsole()},addCell:function(e,t,i){return cell=this.createCell(e,t),this.cells.push(cell),i||(this.showInput()&&"horizontal"==this.layout?(this.jq(o).append(HU.div([ATTR_CLASS,"display-notebook-cell",ATTR_ID,cell.id+"_cellinput"],"")),this.jq(n).append(HU.div([ATTR_CLASS,"display-notebook-cell",ATTR_ID,cell.id+"_celloutput"],""))):(this.jq(l).append(HU.div([ATTR_CLASS,"display-notebook-cell",ATTR_ID,cell.id+"_cellinput"],"")),this.jq(l).append(HU.div([ATTR_CLASS,"display-notebook-cell",ATTR_ID,cell.id+"_celloutput"],""))),cell.createCell()),cell},createCell:function(e,t){t||(t={showInput:!0});var i=this.getId()+"_"+this.cellCount;return t.id=i,this.cellCount++,this.jq(l).append(HU.div([ATTR_CLASS,"display-notebook-cell",ATTR_ID,i],"")),new RamaddaNotebookCell(this,i,e,t)},clearOutput:function(){this.cells.forEach((e=>e.clearOutput()))},getIndex:function(e){for(var t=0,i=0;i<this.cells.length;i++)if(e.id==this.cells[i].id){t=i;break}return t},moveCellUp:function(e){var t=this.getIndex(e);0!=t&&(this.cells.splice(t,1),this.cells.splice(t-1,0,e),this.layoutCells(),e.focus())},moveCellDown:function(e){var t=this.getIndex(e);t!=this.cells.length-1&&(this.cells.splice(t,1),this.cells.splice(t+1,0,e),this.layoutCells(),e.focus())},newCellAbove:function(e){for(var t=[],i=null,s=0;s<this.cells.length;s++)e.id==this.cells[s].id&&(i=this.createCell("%%wiki\n",{showInput:!0,showHeader:!1}),t.push(i)),t.push(this.cells[s]);this.cells=t,this.layoutCells(),i.focus()},newCellBelow:function(e){for(var t=[],i=null,s=0;s<this.cells.length;s++)t.push(this.cells[s]),e.id==this.cells[s].id&&(i=this.createCell("%%wiki\n",{showInput:!0,showHeader:!1}),t.push(i));this.cells=t,this.layoutCells(),i.focus()},deleteCell:function(e){e.jq("cell").remove();var t=[];this.cells.forEach((i=>{e.id!=i.id&&t.push(i)})),this.cells=t,0==this.cells.length&&this.addCell("",null)},cellValues:{},setCellValue:function(e,t){this.cellValues[e]=t},getCellValues:function(){return this.cellValues},convertInput:function(e){for(name in this.cellValues){var t=new RegExp("\\$\\{"+name+"\\}","g");e=e.replace(t,this.cellValues[name])}return e},inGlobalChanged:!1,globalChanged:async function(e,t){var i=this.inGlobalChanged,s=!this.inGlobalChanged;this.inRunAll&&(s=!1),this.inGlobalChanged=!0,s&&this.cells.forEach((e=>e.prepareToRun()));for(var l=0;l<this.cells.length;l++)await this.cells[l].globalChanged(e,t);i||(this.inGlobalChanged=!1)},addGlobal:async function(e,t,i){e=e.trim().replace(/[ -]/g,"_");this.getGlobalValue(e);if(Utils.isDefined(window[e])&&(window[e]=t),this.globals[e]=t,!i)this.getGlobalValue(e)},getGlobalValue:function(e){return this.globals[e]?"function"==typeof this.globals[e]?this.globals[e]():this.globals[e]:null},inRunAll:!1,runAll:async function(){this.inRunAll=!0;var e=!0;this.cellValues={};for(var t=0;t<this.cells.length;t++){(i=this.cells[t]).prepareToRun()}for(t=0;t<this.cells.length;t++){(i=this.cells[t]).runFirst&&await this.runCell(i).then((t=>e=t))}if(e){for(t=0;t<this.cells.length;t++){var i;(i=this.cells[t]).runFirst||await this.runCell(i,!0).then((t=>e=t))}this.inRunAll=!1}},runCell:async function(e,t){if(e.hasRun)return!0;if(await e.run((e=>ok=e),{doingAll:t}),!ok)return!1;var i=e.getRawOutput();return i&&(i=i.trim(),Utils.stringDefined(e.cellName)&&(this.cellValues[e.cellName]=i)),!0},toggleAll:function(e){this.cells.forEach((t=>{t.showInput=e,t.applyStyle()}))}})}var iodide={addOutputRenderer:function(e){notebook.addOutputRenderer(e)},addOutputHandler:function(e){notebook.addOutputHandler(e)},output:{text:function(e){notebook.write(e)},element:function(e){var t=HU.getUniqueId();return notebook.write(HU.tag(e,[ATTR_ID,t])),document.getElementById(t)}}},notebook;function NotebookState(e,t){this.id=HU.getUniqueId(),this.cell=e,this.notebook=e.notebook,$.extend(this,{entries:{},div:t,stopFlag:!1,result:null,log:function(e,t,i){this.getNotebook().log(e,t,i,this.div)},clearConsole:function(){this.getNotebook().clearConsole()},getStop:function(){return this.stopFlag},getCell:function(){return this.cell},addGlobal:async function(e,t){await this.getNotebook().addGlobal(e,t)},globalChanged:async function(e,t){await this.getNotebook().globalChanged(e,t)},setValue:function(e,t){this.notebook.setCellValue(e,t)},makeData:async function(e){e||await this.getCurrentEntry((t=>e=t)),"string"==typeof e&&await this.notebook.getEntry(e,(t=>e=t));var t=this.notebook.getPointUrl(e);if(null==t)return this.writeError("Not a point type:"+e.getName()),null;var i={entry:e,entryId:e.getId()};return new PointData(e.getName(),null,null,t,i)},log:function(e,t){this.getNotebook().log(e,t,"js")},getNotebook:function(){return this.notebook},save:function(e){return this.notebook.saveNotebook(e),"notebook saved"},clearEntries:function(){this.clearEntries()},ls:async function(e){var t=new Div;e||await this.getCurrentEntry((t=>e=t)),this.call.getEntryHeading(e,t),this.write(t.toString())},lsEntries:function(){var e="",t=this.currentEntries;for(var i in t){e+=i+"="+t[i].entry.getName()+HU.br()}this.write(e)},stop:function(){this.stopFlag=!0},setGlobal:async function(e,t){await this.cell.notebook.addGlobal(e,t)},setEntry:function(e,t){this.cell.notebook.addEntry(e,t)},getEntry:async function(e,t){return await this.cell.notebook.getEntry((e=>entry=e)),Utils.call(t,entry)},wiki:async function(e,t,i){if(!i){var s=new Div;this.div.append(s.toString()),i=e=>s.append(e)}null==t&&await this.cell.getCurrentEntry((e=>t=e)),"string"!=typeof t&&(t=t.getId()),await GuiUtils.loadHtml(HU.url(RamaddaUtil.getBaseUrl()+"/wikify","doImports","false",ARG_ENTRYID,t,"wikitext",e),i)},addOutputRenderer:function(e){this.getNotebook().addOutputRenderer(e)},addOutputHandler:function(e){this.getNotebook().addOutputRenderer(e)},output:{text:function(e){notebook.write(e)},element:function(e){var t=HU.getUniqueId();return notebook.write(HU.tag(e,[ATTR_ID,t])),document.getElementById(t)}},clearOutput:function(){this.cell.clearOutput()},clearAllOutput:function(){this.getNotebook().clearOutput()},write:function(e,t){if(e){var i=this.getNotebook().formatOutput(e);null==i&&"object"==typeof e&&(i=this.notebook.formatObject(e)),t?this.div.set(i):this.div.append(i)}},linechart:async function(e,t){e||await this.cell.getCurrentEntry((t=>e=t)),this.cell.createDisplay(this,e,DISPLAY_LINECHART,t)}})}var notebookStates={};function RamaddaNotebookCell(e,t,i,s){this.notebook=e;var l="cell",a="header",r="cellname",o="input",n="inputtoolbar",h="output",d="menubutton",g="runbutton",p="cellnameinput",c="showheader",u="showedit",T="runonload",f="displaymode",y="layouttype",m="showconsole",_="layoutcolumns",S="runfirst",A="showoutput",I="runningicon";let b=new DisplayThing(t,{});RamaddaUtil.inherit(this,b),RamaddaUtil.defineMembers(this,{id:t,inputRows:1,index:0,content:i,outputHtml:"",showInput:!1,showHeader:!1,cellName:"",runFirst:!1,showOutput:!0}),s&&$.extend(this,s),RamaddaUtil.defineMembers(this,{getJson:function(e){var t={id:this.id,inputRows:this.inputRows,content:this.getInputText(),showInput:this.showInput,showHeader:this.showHeader,runFirst:this.runFirst,showOutput:this.showOutput,cellName:this.cellName};return this.currentEntry&&(t.currentEntryId=this.currentEntry.getId()),e&&(t.outputHtml=this.outputHtml),t},createCell:function(){null==this.content&&(this.content="%% wiki"),this.editId=addHandler(this),addHandler(this,this.editId+"_entryid"),addHandler(this,this.editId+"_wikilink");var e=this,t=this.makeButton(d,icon_menu,"Show menu","showmenu")+this.makeButton(g,Utils.getIcon("run.png"),"Run this cell","run")+this.makeButton(g,Utils.getIcon("runall.png"),"Run all","runall"),i=HU.image(icon_blank,[ATTR_ALIGN,"right",ATTR_ID,this.getDomId(I),ATTR_STYLE,HU.css(CSS_PADDING_BOTTOM,HU.px(2),CSS_PADDING_TOP,HU.px(2),CSS_PADDING_RIGHT,HU.px(5))]);t=t+SPACE+HU.span([ATTR_ID,this.getDomId(r)],this.cellName),t+=i;for(var s=HU.div([ATTR_CLASS,"display-notebook-header",ATTR_ID,this.getDomId(a),ATTR_TABINDEX,"0",ATTR_TITLE,"Click to toggle input\nShift-click to clear output"],SPACE+t),p="",c=this.content.split("\n"),u=!1,T=0;T<c.length;T++){var f=c[T],y=f.trim();y.startsWith("%%")&&(u=!!y.match(/^%% *meta/)),u||(p+=f+"\n")}p=p.replace(/</g,"&lt;").replace(/>/g,"&gt;");var m=HU.div([ATTR_CLASS,"display-notebook-input ace_editor",ATTR_ID,this.getDomId(o),ATTR_TITLE,"shift-return: run chunk\nctrl-return: run to end"],p),_=HU.div([ATTR_ID,this.getDomId(n)],"");m=HU.div([ATTR_CLASS,"display-notebook-input-container"],_+m);var S=HU.div([ATTR_CLASS,"display-notebook-output",ATTR_ID,this.getDomId(h)],this.outputHtml);S=HU.div([ATTR_CLASS,"display-notebook-output-container"],S);HU.div([ATTR_ID,this.getDomId("menu"),ATTR_CLASS,CLASS_POPUP],"");var A=s+m;A=HU.div([ATTR_ID,this.getDomId(l)],A),jqid(this.id+"_cellinput").html(A),jqid(this.id+"_celloutput").html(S);var b=HU.url(RamaddaUtil.getBaseUrl()+"/wikitoolbar","doImports","false",ARG_ENTRYID,this.entryId,"handler",this.editId);b+="&extrahelp="+RamaddaUtil.getBaseUrl()+"/userguide/notebook.html|Notebook Help",GuiUtils.loadHtml(b,(e=>{this.inputToolbar=e,this.jq(n).html(e),jqid(this.editId+"_prefix").html(HU.span([ATTR_ID,this.getDomId("toolbar_notebook"),ATTR_STYLE,HU.css(CSS_BORDER_RIGHT,HU.border(1,COLOR_LIGHT_GRAY)),ATTR_CLASS,"ramadda-menubar-button"],"Notebook")),this.jq("toolbar_notebook").click((()=>this.showNotebookMenu()))})),this.header=this.jq(a),this.header.click((e=>{e.shiftKey?this.processCommand("clear"):(this.hidePopup(),this.processCommand("toggle"))}));let R=new WikiEditor("","",this.getDomId(o),!1,{maxLines:30,minLines:5});this.editor=R.getEditor(),this.editor.getSession().on("change",(()=>{this.inputChanged()})),this.menuButton=this.jq(d),this.toggleButton=this.jq("togglebutton"),this.cell=this.jq(l),this.input=this.jq(o),this.output=this.jq(h),this.inputContainer=this.cell.find(".display-notebook-input-container"),this.inputMenu=this.cell.find(".display-notebook-input-container"),this.applyStyle(),this.header.find(".display-notebook-menu-button").click((function(t){e.processCommand($(this).attr(ATTR_WHAT)),t.stopPropagation()})),this.calculateInputHeight(),this.input.focus((()=>this.hidePopup())),this.input.click((()=>this.hidePopup())),this.output.click((()=>this.hidePopup())),this.input.on("input selectionchange propertychange",(()=>this.calculateInputHeight()));var D=t=>{var i=t.key;"v"==i&&t.ctrlKey?this.notebook.moveCellDown(e):6==i&&t.ctrlKey&&this.notebook.moveCellUp(e)};this.input.keydown(D),this.header.keydown(D),this.input.keydown((function(t){var i=t.key;"s"==i&&t.ctrlKey?e.notebook.saveNotebook(!1):"Enter"==i&&(t.shiftKey||t.ctrlKey)&&(t.preventDefault&&t.preventDefault(),t.shiftKey&&t.ctrlKey?e.run(null):(e.run(null,{justCurrent:!0,toEnd:t.ctrlKey}),t.ctrlKey||e.stepToNextChunk()))}))},selectClick(e,t,i,s){"entryid"==e?this.insertText(i):this.insertText("[["+i+"|"+s+"]]"),this.input.focus()},insertTags:function(e,t,i){var s=this.getDomId(o),l=GuiUtils.getDomObject(s);insertTagsInner(s,l.obj,e,t,i),this.calculateInputHeight()},insertText:function(e){var t=this.getDomId(o),i=GuiUtils.getDomObject(t);WikiUtil.insertAtCursor(t,i.obj,e),this.calculateInputHeight()},showNotebookMenu:function(){var e=this.jq("toolbar_notebook");this.makeMenu(e,POS_LEFT_BOTTOM)},makeButton:function(e,t,i,s){return s||(s="noop"),HU.div([ATTR_WHAT,s,ATTR_TITLE,i,ATTR_CLASS,"display-notebook-menu-button",ATTR_ID,this.getDomId(e)],HU.image(t,[]))},makeMenu:function(e,t){e||(e=this.input),HU.isVisible(e)||(e=this.header),HU.isVisible(e)||(e=this.output),t||(t=POS_LEFT_TOP);let i=this,s=SPACE2,l="",a=HU.open(TAG_DIV,[ATTR_CLASS,"display-notebook-menu-block"]),r=HU.close(TAG_DIV);l+=HU.input(p,i.cellName,[ATTR_PLACEHOLDER,"Cell name",ATTR_STYLE,HU.css(CSS_WIDTH,HU.perc(100)),ATTR_ID,i.getDomId(p)]),l+=a,l+=HU.open(TAG_TABLE,[ATTR_WIDTH,HU.perc(100)]),l+="<tr><td align=right><b>New cell:</b>&nbsp;</td><td>",l+=HU.div([ATTR_CLASS,CLASS_LINK,ATTR_WHAT,"newabove"],"Above")+s,l+=HU.div([ATTR_CLASS,CLASS_LINK,ATTR_WHAT,"newbelow"],"Below"),l+=HU.close(TAG_TD,TAG_TR),l+="<tr><td align=right><b>Move:</b>&nbsp;</td><td>",l+=HU.div([ATTR_TITLE,"ctrl-^",ATTR_CLASS,CLASS_LINK,ATTR_WHAT,"moveup"],"Up")+s,l+=HU.div([ATTR_TITLE,"ctrl-v",ATTR_CLASS,CLASS_LINK,ATTR_WHAT,"movedown"],"Down"),l+=HU.close(TAG_TD,TAG_TR,TAG_TABLE),l+=r,l+=a,l+=HU.div([ATTR_TITLE,"ctrl-return",ATTR_CLASS,CLASS_LINK,ATTR_WHAT,"hideall"],"Hide all inputs"),l+=HU.br(),l+=HU.div([ATTR_CLASS,CLASS_LINK,ATTR_WHAT,"clearall"],"Clear all outputs"),l+=HU.br();this.notebook.columns,i.getDomId(_);l+="<b>Layout:</b> ",l+=HU.checkbox(i.getDomId(y),[],"horizontal"==i.notebook.layout,"Horizontal")+HU.br(),l+=r,l+=a,l+=HU.checkbox(i.getDomId(A),[],i.showOutput,"Output enabled")+HU.br(),l+=HU.checkbox(i.getDomId(m),[],i.notebook.showConsole,"Show console")+HU.br(),l+=HU.checkbox(i.getDomId(S),[],i.runFirst,"Run first")+HU.br(),l+=HU.checkbox(i.getDomId(T),[],i.notebook.runOnLoad,"Run on load")+HU.br(),l+=HU.div([ATTR_TITLE,"Don't show the left side and input for anonymous users"],HU.checkbox(i.getDomId(f),[],i.notebook.displayMode)+" Display mode"+HU.br()),l+=r,l+=a,l+=HU.div([ATTR_CLASS,CLASS_LINK,ATTR_WHAT,"savewithout"],"Save notebook")+HU.br(),l+=r,l+=a,l+=HU.div([ATTR_CLASS,CLASS_LINK,ATTR_WHAT,"delete"],"Delete cell")+HU.br(),l+=HU.div([ATTR_CLASS,CLASS_LINK,ATTR_WHAT,"help"],"Help")+HU.br(),l=HU.div([ATTR_CLASS,"display-notebook-menu"],l),l+=r;var o=this.getPopup();this.dialogShown=!0,o.html(HU.div([ATTR_CLASS,CLASS_POPUP_INNER],l)),o.show(),o.position({of:e,my:POS_LEFT_TOP,at:t,collision:"fit fit"}),i.jq(c).focus(),i.jq(m).change((function(e){i.notebook.showConsole=HU.isChecked(i.jq(m)),i.hidePopup(),i.notebook.layoutCells()})),i.jq(c).change((function(e){i.showHeader=HU.isChecked(i.jq(c)),i.applyStyle()})),i.jq(S).change((function(e){i.runFirst=HU.isChecked(i.jq(S))})),i.jq(A).change((function(e){i.showOutput=HU.isChecked(i.jq(A)),i.applyStyle()})),i.jq(T).change((function(e){i.notebook.runOnLoad=HU.isChecked(i.jq(T))})),i.jq(f).change((function(e){i.notebook.displayMode=HU.isChecked(i.jq(f))})),i.jq(u).change((function(e){i.showInput=HU.isChecked(i.jq(u)),i.applyStyle()})),i.jq(y).change((function(e){HU.isChecked(i.jq(y))?i.notebook.layout="horizontal":i.notebook.layout="vertical",i.hidePopup(),i.notebook.layoutCells()})),i.jq(_).keypress((function(e){if(13==(e.keyCode||e.which)){var t=parseInt(i.jq(_).val());isNaN(t)?i.jq(_).val("bad:"+i.jq(_).val()):i.hidePopup()}})),i.jq(p).keypress((function(e){13!=(e.keyCode||e.which)||i.hidePopup()})),o.find(".ramadda-link").click((function(){var e=$(this).attr(ATTR_WHAT);i.processCommand(e)}))},hidePopup:function(){var e=this.getPopup();if(e&&this.dialogShown){var t=parseInt(this.jq(_).val());this.cellName=this.jq(p).val(),this.jq(r).html(this.cellName),e.hide(),this.applyStyle(),isNaN(t)||this.notebook.columns==t||(this.notebook.columns=t,this.notebook.layoutCells())}this.dialogShown=!1},processCommand:function(e){if("showmenu"!=e){if("toggle"==e)this.showInput=!this.showInput,this.applyStyle(!0);else if("showthis"==e)this.showInput=!0,this.applyStyle();else if("hidethis"==e)this.showInput=!1,this.applyStyle();else if("showall"==e)this.notebook.toggleAll(!0);else if("hideall"==e)this.notebook.toggleAll(!1);else if("run"==e)this.notebook.runCell(this);else if("runall"==e)this.notebook.runAll();else if("clear"==e)this.clearOutput();else if("clearall"==e)this.notebook.clearOutput();else if("moveup"==e)this.notebook.moveCellUp(this);else if("movedown"==e)this.notebook.moveCellDown(this);else if("newabove"==e)this.notebook.newCellAbove(this);else if("newbelow"==e)this.notebook.newCellBelow(this);else if("savewith"==e)this.notebook.saveNotebook(!0);else if("savewithout"==e)this.notebook.saveNotebook(!1);else if("help"==e){window.open(RamaddaUtil.getBaseUrl()+"/userguide/notebook.html","_blank").focus()}else{if("delete"==e)return void this.askDelete();console.log("unknown command:"+e)}this.hidePopup()}else this.makeMenu()},shouldShowInput:function(){return this.showInput&&this.notebook.showInput()},applyStyle:function(e){this.shouldShowInput()?(this.jq(n).css(CSS_DISPLAY,DISPLAY_BLOCK),this.inputContainer.show(400,(()=>this.editor.resize())),this.showHeader=!0):(this.jq(n).css(CSS_DISPLAY,DISPLAY_NONE),this.inputContainer.hide(e?200:0),this.showHeader=!1),this.showHeader=this.notebook.showInput(),this.showHeader?this.header.css(CSS_DISPLAY,DISPLAY_BLOCK):this.header.css(CSS_DISPLAY,DISPLAY_NONE),this.showOutput?this.output.css(CSS_DISPLAY,DISPLAY_BLOCK):this.output.css(CSS_DISPLAY,DISPLAY_NONE)},getPopup:function(){return this.notebook.getPopup()},askDelete:function(){let e=this;var t="";t+="Are you sure you want to delete this cell?<br>",t+=HU.span([ATTR_CLASS,CLASS_LINK,ATTR_WHAT,"yes"],"Yes"),t+=HU.span([ATTR_STYLE,HU.css(CSS_MARGIN_LEFT,HU.px(50)),ATTR_CLASS,CLASS_LINK,ATTR_WHAT,"cancel"],"No");var i=this.getPopup();i.html(HU.div([ATTR_CLASS,CLASS_POPUP_INNER],t)),i.show();var s=this.input;HU.isVisible(s)||(s=this.output),HU.isVisible(s)||(s=this.header),i.position({of:s,my:POS_LEFT_TOP,at:POS_LEFT_TOP,collision:"fit fit"}),i.find(".ramadda-link").click((function(){var t=$(this).attr(ATTR_WHAT);e.hidePopup(),"yes"==t&&e.notebook.deleteCell(e)}))},inputChanged:function(){for(var e=this.getInputText(),t=e.split("\n"),i=this.editor.getCursorPosition().row;i>=0;i--){var s=t[i].trim();if(s.startsWith("%%")){var l=s.substring(2).trim();if(l.startsWith("md")||l.startsWith("html")||l.startsWith("css")||l.startsWith("raw")){var a={};a[i]=!0,this.runInner(e,a)}break}}},stepToNextChunk:function(){for(var e=this.getInputText().split("\n"),t=this.editor.getCursorPosition().row+1;t<e.length;t++)if(e[t].trim().startsWith("%%")){var i=e[t].length;this.editor.selection.moveTo(t,i),this.editor.scrollToLine(t,!0,!0,(function(){}));break}},run:async function(e,t){t||(t={});var i=t.justCurrent,s=t.toEnd,l=t.doingAll;if(this.running)return Utils.call(e,!0);this.running=!0;var a=null;try{var r=!0,o=this.getInputText();if(i){a={};var n=this.editor.getCursorPosition().row,h=o.split("\n");if(s){for(i=!1;n>=0&&!h[n].trim().startsWith("%%");)n--;for(n<0&&(n=0);n<h.length;)a[n]=!0,n++}else{for(n++;n<h.length;){if(h[n].trim().startsWith("%%")){n--;break}n++}for(n>=h.length&&(n=h.length-1);n>=0;){var d=h[n].trim();if(a[n]=!0,d.startsWith("%%"))break;n--}}}if(this.jq(I).attr(ATTR_SRC,icon_progress),await this.runInner(o,a,l).then((e=>r=e)),this.jq(I).attr(ATTR_SRC,icon_blank),!r)return this.running=!1,Utils.call(e,!1);this.outputUpdated()}catch(t){return this.jq(I).attr(ATTR_SRC,icon_blank),this.running=!1,this.writeOutput("An error occurred:"+t.toString()+" "+typeof t),console.log("error:"+t.toString()),t.stack&&console.log(t.stack),Utils.call(e,!1)}return this.running=!1,Utils.call(e,!0)},prepareToLayout:function(){this.content=this.getInputText()},getInputText:function(){return this.editor?this.editor.getValue():this.content},globalChanged:async function(e,t){for(var i=0;i<this.chunks.length;i++){var s=this.chunks[i];if(!s.hasRun&&s.depends.includes(e)){var l=!0;if(await this.runChunk(s,(e=>l=e)),!l)break}}},prepareToRun:function(){this.hasRun=!1,this.chunks&&this.chunks.forEach((e=>e.hasRun=!1))},runInner:async function(e,t,i){e=(e=e.trim()).replace(/{cellname}/g,this.cellName),e=this.notebook.convertInput(e),this.chunks||(this.chunks=[]);for(var s=this.chunks,l="wiki",a="",r=e.split("\n"),o=null,n=0,d=(e,t,i,l,a)=>{var r=Utils.parseAttributes(a);r.type=t,r.doChunk=l,r.content=i;var h=n<s.length?s[n]:null;return n++,h&&0==h.div.jq().length&&(h=null),h?h.initChunk(r):(h=new NotebookChunk(e,r),s.push(h),h.skipOutput||(o?o.div.jq().after(h.div.toString()):e.output.html(h.div.toString()))),o=h,h.div.jq().show(),h},g="",p=!0,c=0;c<r.length;c++){var u=r[c],T=u.trim();if(!T.startsWith("//"))if(T.startsWith("%%")){var f,y=T.substring(2).trim(),m=y.indexOf(" ");m<0?(f=y,y=""):(f=y.substring(0,m).trim(),y=y.substring(m)),""!=g&&d(this,l,g,p,a),p=!t||t[c],""!=(g="")&&(g+="\n"),""!=f&&(l=f),a=y}else g=g+u+"\n"}""!=g&&d(this,l,g,p,a),this.chunkMap={};for(var _=0;_<this.chunks.length;_++){var S=this.chunks[_];S.name&&(this.chunkMap[S.name]=S)}for(_=n;_<this.chunks.length;_++)this.chunks[_].div.jq().hide();this.rawOutput="";var A=!0;return await this.runChunks(this.chunks,i,!0,(e=>A=e)),!!A&&(await this.runChunks(this.chunks,i,!1,(e=>A=e)),!!A&&(Utils.initContent("#"+this.getDomId(h)),!0))},runChunks:async function(e,t,i,s){for(var l=0;l<e.length;l++){var a=e[l],r=!0;if((!0!==i||a.props.runfirst)&&((!1!==i||!0!==a.props.runfirst)&&(!t||!0!==a.props.skiprunall)&&a.doChunk&&(await this.runChunk(a,(e=>r=e)),!r)))return Utils.call(s,!1)}return Utils.call(s,!0)},runChunk:async function(e,t){if(e.hasRun)return Utils.call(t,!0);e.ok=!0,e.div.set(""),e.hasRun=!0;for(var i=0;i<e.depends.length;i++){var s=e.depends[i];if(this.chunkMap[s]&&!this.chunkMap[s].hasRun){var l=!0,a=this.chunkMap[s];if(await this.runChunk(a,!1,null,(e=>l=e)),!l||!a.ok)return Utils.call(t,!1)}}if(await this.processChunk(e),e.ok){if(e.name&&"string"==typeof e.name){s=e.name.trim();e.output?""!=s&&await this.notebook.addGlobal(s,e.output):await this.notebook.addGlobal(s,null)}return Utils.call(t,!0)}Utils.call(t,!1)},writeOutput:function(e){if(!this.output)return err=new Error,void console.log("no output:"+err.stack);this.output.html(e),this.outputUpdated()},outputUpdated:function(){this.outputHtml=this.jq(h).html()},getRawOutput:function(){return this.rawOutput},focus:function(){this.input.focus()},clearOutput:function(){this.chunks&&this.chunks.forEach((e=>e.div.set(""))),this.outputHtml=""},processHtml:async function(e){var t=e.getContent();t.match("%\n*$")&&(t=(t=t.trim()).substring(0,t.length-1)),this.rawOutput+=t+"\n",e.output=t,e.div.set(t)},processCss:async function(e){var t=HU.tag(ATTR_STYLE,[ATTR_TYPE,"text/css"],e.getContent());this.rawOutput+=t+"\n",e.output=t,e.div.set(t)},handleError:function(e,t,i){e.ok=!1,console.log("An error occurred:"+t),this.notebook.log(t,"error",i,e.div)},getFetchUrl:async function(e,t,i){return(e=Utils.replaceRoot(e)).match(/^[a-z0-9]+-[a-z0-9].*/)?Utils.call(i,HU.url(RamaddaUtil.getBaseUrl()+URL_ENTRY_GET,ARG_ENTRYID,e)):e.startsWith("http")||!(e.startsWith("/")&&!e.startsWith(RamaddaUtil.getBaseUrl())||e.startsWith(".."))&&e.startsWith("/")?Utils.call(i,e):(await this.getEntryFromPath(e,(e=>s=e)),s?Utils.call(i,HU.url(RamaddaUtil.getBaseUrl()+URL_ENTRY_GET,ARG_ENTRYID,s.getId())):Utils.call(i,null));var s},processFetch:async function(e){for(var t=e.getContent().split("\n"),i=0;i<t.length;i++){var s=t[i].trim();if(""!=s){var l=s,a=null,r="";if((o=s.indexOf(":"))<0)return void this.handleError(e,"Bad fetch line:"+s,"io");var o,n=s.substring(0,o);(o=(s=s.substring(o+1).trim()).indexOf(" //"))>=0&&(s=s.substring(0,o).trim());var h=null,d=null;if(["text","json","blob"].includes(n)){var g=s.match(/^([a-zA-Z0-9_]+) *= *(.*)$/);g&&(d=g[1],s=g[2].trim(),r=" (var "+d+")")}if(await this.getFetchUrl(s,n,(e=>h=e)),!h)return void this.handleError(e,"Unable to get entry url:"+s,"io");if("js"==n){if(h.match("jquery-.*\\.js"))return;await Utils.importJS(h,(()=>{}),((e,t,i)=>{a="Error fetching "+l+" "+(i?i.toString():"")}),!1)}else if("css"==n)await Utils.importCSS(h,null,((e,t,i)=>a="Error fetching "+l+" "+i),!0);else if("html"==n)await Utils.doFetch(h,(t=>e.div.append(t)),((e,t,i)=>a="Error fetching "+l+" "+i));else if("text"==n||"json"==n||"blob"==n){var p="json"==n,c="blob"==n,u=null;await Utils.doFetch(h,(e=>u=e),((e,t,i)=>a="Error fetching "+l+" error:"+(i?i.toString():"")),"blob"==n?"blob":"text"),u&&(p?"string"==typeof u&&(u=JSON.parse(u)):c&&(u=new Blob([u],{})),d?await this.notebook.addGlobal(d,u):p?e.div.append(Utils.formatJson(u)):e.div.append(HU.pre([ATTR_STYLE,HU.css(CSS_MAX_WIDTH,HU.perc(100),CSS_OVERFLOW_X,OVERFLOW_AUTO)],u)))}else a="Unknown fetch:"+l;if(a)return void this.handleError(e,a,"io");this.notebook.log("Loaded: "+h+r,"output","io")}}},processMd:async function(e){var t=e.getContent();this.rawOutput+=t+"\n",t.match("%\n*$")&&(t=(t=t.trim()).substring(0,t.length-1));for(var i="",s=null,l=t.split("\n"),a=[],r=0;r<l.length;r++){var o=l[r];if(o.trim().startsWith("$$"))if(null!=s){try{var n=katex.renderToString(s,{throwOnError:!0});i+="tex:"+a.length+":\n",a.push(n)}catch(e){i+="Error parsing tex:"+e+"<pre>"+s+"</pre>"}s=null}else s="";else null!=s?s+=o+"\n":i+=o+"\n"}for(n=(new showdown.Converter).makeHtml(i),r=0;r<a.length;r++)n=n.replace("tex:"+r+":",a[r]);var h=HU.div([ATTR_CLASS,"display-notebook-md"],n);e.output=n,e.div.set(h)},processPy:async function(e){this.notebook.loadedPyodide||(e.div.set("Loading Python..."),await Utils.importJS(ramaddaBaseHtdocs+"/lib/pyodide/pyodide.js"),await languagePluginLoader.then((()=>{pyodide.runPython("import sys\nsys.version;")}),(e=>console.log("error:"+e))),await pyodide.loadPackage(["numpy","cycler","pytz","matplotlib"]),e.div.set(""),this.notebook.loadedPyodide=!0),pyodide.runPython(e.getContent())},processPlugin:async function(e){var t=JSON.parse(e.getContent());await this.notebook.addPlugin(t,e)},processWiki:async function(e){this.rawOutput+=e.getContent()+"\n";var t=this.notebook.getProperty("entryId","");await this.getCurrentEntry((e=>entry=e)),entry&&(t=entry.getId());let i=HU.getUniqueId();e.getContent();await GuiUtils.loadHtml(HU.url(RamaddaUtil.getBaseUrl()+"/wikify","doImports","false",ARG_ENTRYID,t,"wikitext",e.getContent()),(function(t){var s=HU.div([ATTR_ID,i,ATTR_STYLE,""],t);e.div.set(s),e.output=s}))},processSh:async function(e){for(var t="",i=e.getContent().split("\n"),s=[],l=0;l<i.length;l++){var a=i[l].trim();if(""!=a)for(var r=a.split(";"),o=0;o<r.length;o++){var n=r[o].trim();if(""!=n&&!n.startsWith("#")&&!n.startsWith("//")){var h=n.split(" "),d=h[0].trim(),g=null,p=null;this["processCommand_"+d]?g=this["processCommand_"+d]:(g=this.processCommand_help,p="Unknown command: <i>"+d+"</i>");var c=new Div("");s.push({proc:g,line:n,toks:h,extra:p,div:c}),t+=c.set("")}}}let u=this;e.div.set(t);l=0;for(l=0;l<s.length;l++){var T=s[l];T.extra&&T.div.append(p),await T.proc.call(u,T.line,T.toks,T.div,T.extra)}},processJs:async function(e,t){var i,s=0;if(await this.getCurrentEntry((e=>{current=e})),!notebookStates[t.id])throw new Error("Null NB:"+t.id);try{var l=this.notebook.getCurrentEntries();for(name in l)t.entries[name]=l[name].entry;var a="";t.entries.current=current,t.entries.parent=this.parentEntry,t.entries.base=this.notebook.getBaseEntry(),t.entries.root=this.notebook.getRootEntry();var r="notebookStates['"+t.id+"']";for(name in s++,a+="var notebook= "+r+";\n",s++,t.entries){var o=t.entries[name];s++,a+="var "+name+"= notebook.entries['"+name+"'];\n"}for(name in this.notebook.cellValues){var n=name.replace(/ /g,"_").replace(/[^a-zA-Z0-9_]+/g,"_");s++,a+="var "+n+"= notebook.getNotebook().cellValues['"+name+"'];\n"}for(name in this.notebook.globals)name=name.trim(),""!=name&&(s++,a+="var "+name+"= notebook.getNotebook().getGlobalValue('"+name+"');\n");var h=e.getContent().trim();i=h.split("\n"),h=a+"\n"+h;var d=eval.call(null,h);t.getStop()&&(e.ok=!1);var g="";if(null!=d){e.output=d;var p=this.notebook.formatOutput(d);if(null!=p)g=p,this.rawOutput+=g+"\n";else{var c=typeof d;"object"!=c&&"function"!=c&&(g=d,this.rawOutput+=g+"\n")}}e.div.append(g)}catch(o){e.ok=!1;var u=i[o.lineNumber-s-1];console.log("Error:"+o.stack),this.notebook.log("Error: "+o.message+"<br>&gt;"+(u||""),"error","js",e.div)}},processChunk:async function(e){var t=new NotebookState(this,e.div);if(window.notebook=t,notebookStates[t.id]=t,"html"==e.type)await this.processHtml(e,t);else if("plugin"==e.type)await this.processPlugin(e,t);else if("wiki"==e.type)await this.processWiki(e,t);else if("css"==e.type)await this.processCss(e,t);else if("fetch"==e.type)await this.processFetch(e,t);else if("raw"==e.type){var i=e.getContent();e.output=i,this.rawOutput+=i}else if("js"==e.type)await this.processJs(e,t);else if("sh"==e.type)await this.processSh(e,t);else if("meta"==e.type);else if("md"==e.type)await this.processMd(e,t);else if("py"==e.type)await this.processPy(e,t);else{var s,l;if(await this.notebook.hasPlugin(e.type,(e=>s=e)),s)return e.div.set(""),await this.notebook.processChunkWithPlugin(e.type,e,(e=>l=e)),void(l&&this.notebook.processPluginOutput(e.type,e,l));this.notebook.log("Unknown type:"+e.type,"error",null,e.div),e.ok=!1}delete notebookStates[t.id],t.getStop()&&(e.ok=!1)},calculateInputHeight:function(){if(this.content=this.getInputText(),this.content){var e=this.content.split("\n");e.length!=this.inputRows&&(this.inputRows=e.length,this.input.attr(ATTR_ROWS,Math.max(1,this.inputRows)))}},writeStatusMessage:function(e){var t=this.jq("message");e?(t.show(),t.position({of:this.getOutput(),my:POS_LEFT_TOP,at:"left+4 top+4",collision:"none none"}),t.html(e)):(t.hide(),t.html(""))},handleControlKey:function(e){e.which},getOutput:function(){return this.jq(h)},getInput:function(){return this.jq(o)},writeResult:function(e){this.writeStatusMessage(null),e=HU.div([ATTR_CLASS,"display-notebook-result"],e);var t=this.jq(h);t.append(e),t.animate({scrollTop:t.prop("scrollHeight")},1e3),this.currentOutput=t.html(),this.currentInput=this.getInputText()},writeError:function(e){this.writeStatusMessage(e)},header:function(e){return HU.div([ATTR_CLASS,"display-notebook-header"],e)},processCommand_help:function(e,t,i,s,l){null==i&&(i=new Div);var a="";return null!=l&&(a+=l),a+="<pre>pwd, ls, cd</pre>",i.append(a)},entries:{},selectEntry:function(e){for(var t=1,i=this.notebook.getCurrentEntries();i["entry"+t];)t++;var s=prompt("Set an ID","entry"+t);null!=s&&""!=s.trim()&&this.notebook.addEntry(s,e)},setId:function(e){this.editor.getCursorPosition();this.editor.insert(e)},cdEntry:function(e){var t=new Div("");this.currentEntry=this.entries[e],notebookState.entries.current=this.currentEntry,this.output.html(t.toString()),this.processCommand_pwd("pwd",[],t),this.outputUpdated()},addToToolbar:function(e,t,i){var s="getHandler('"+e+"').setId('"+t.getId()+"')",l=HU.image(RamaddaUtil.getBaseUrl()+"/icons/setid.png",["border",0,ATTR_TITLE,"Set ID in Input"]);i.unshift(HU.tag(TAG_A,[ATTR_ONCLICK,s],l));s="getHandler('"+e+"').selectEntry('"+t.getId()+"')",l=HU.image(RamaddaUtil.getBaseUrl()+"/icons/circle-check.png",["border",0,ATTR_TITLE,"Select Entry"]);i.unshift(HU.tag(TAG_A,[ATTR_ONCLICK,s],l))},getEntryPrefix:function(e,t){this.entries[t.getId()]=t;var i="getHandler('"+e+"').cdEntry('"+t.getId()+"')";return HU.div([ATTR_STYLE,HU.css(CSS_PADDING_RIGHT,HU.px(4)),ATTR_TITLE,"cd to entry",ATTR_ONCLICK,i,ATTR_CLASS,CLASS_LINK],HU.image(RamaddaUtil.getBaseUrl()+"/icons/go.png"))},displayEntries:function(e,t){if(null==t&&(t=new Div),this.currentEntries=e,null==e||0==e.length)return t.msg("No children");var i=addHandler(this),s=this.notebook.getEntriesTree(e,{handlerId:i,showIndex:!1,suffix:Utils.getUniqueId("_shell_")});t.set(HU.div([ATTR_STYLE,HU.css(CSS_MAX_HEIGHT,HU.px(200),CSS_OVERFLOW_Y,OVERFLOW_AUTO)],s)),this.outputUpdated()},getEntryFromArgs:function(e,t){var i=this.currentEntries;if(null==i)return t;for(var s=0;s<e.length;s++){var l=e[s];if(l.match("^d+$")){var a=parseInt(l);break}if("-entry"==l)return s++,(a=parseInt(e[s])-1)<0||a>=i?void this.writeError("Bad entry index:"+a+" should be between 1 and "+i.length):i[a]}return t},setCurrentEntry:async function(e){this.currentEntry=e,this.parentEntry=null,this.currentEntry&&await this.currentEntry.getParentEntry((e=>{this.parentEntry=e}))},getCurrentEntry:async function(e){if(null==this.currentEntry&&await this.setCurrentEntry(this.notebook.getBaseEntry()),null==this.currentEntry){if(Utils.isDefined(dflt))return dflt;this.rootEntry=new Entry({id:ramaddaBaseEntry,name:"Root",type:"group"}),this.currentEntry=this.rootEntry}return Utils.call(e,this.currentEntry)},createDisplay:async function(e,t,i,s){if(t||await this.getCurrentEntry((e=>t=e)),"string"==typeof t&&await this.notebook.getEntry(t,(e=>t=e)),!e.displayManager){var l=HU.getUniqueId();e.div.append(HU.div([ATTR_ID,l],"")),e.displayManager=new DisplayManager(l,{showMap:!1,showMenu:!1,showTitle:!1,layoutType:"table",layoutColumns:1,defaultMapLayer:"osm",entryId:""})}l=HU.getUniqueId();e.div.append(HU.div([ATTR_ID,l],"DIV"));var a={layoutHere:!0,divid:l,showMenu:!0,sourceEntry:t,entryId:t.getId(),showTitle:!0,showDetails:!0,title:t.getName()};if(s&&$.extend(a,s),!a.data&&i!=DISPLAY_ENTRYLIST){var r=this.notebook.getPointUrl(t);if(null==r)return void this.writeError("Not a point type:"+t.getName());null==r&&(r=this.getPointUrl(t));var o={entry:t,entryId:t.getId()};a.data=new PointData(t.getName(),null,null,r,o)}e.displayManager.createDisplay(i,a)},createPointDisplay:async function(e,t){await this.getCurrentEntry((e=>current=e));var i=this.getEntryFromArgs(e,currentEntry),s=this.notebook.getPointUrl(i);null!=s?this.notebook.createDisplay(i.getId(),t,s):this.writeError("Not a point type:"+i.getName())},processCommand_table:function(e,t){this.createPointDisplay(t,DISPLAY_TABLE)},processCommand_linechart:function(e,t){this.createPointDisplay(t,DISPLAY_LINECHART)},processCommand_barchart:function(e,t){this.createPointDisplay(t,DISPLAY_BARCHART)},processCommand_bartable:function(e,t){this.createPointDisplay(t,DISPLAY_BARTABLE)},processCommand_hello:function(e,t){this.writeResult("Hello, how are you?")},processCommand_scatterplot:function(e,t){this.createPointDisplay(t,DISPLAY_SCATTERPLOT)},processCommand_blog:function(e,t){this.getLayoutManager().publish("blogentry")},getEntryHeading:function(e,t){var i=[e],s=addHandler(this),l=this.notebook.getEntriesTree(i,{handlerId:s,showIndex:!1,suffix:Utils.getUniqueId("_shell_")});return t.set(HU.div([ATTR_STYLE,HU.css(CSS_MAX_HEIGHT,HU.px(200),CSS_OVERFLOW_Y,OVERFLOW_AUTO)],l)),t},processCommand_pwd:async function(e,t,i){return null==i&&(i=new Div),await this.getCurrentEntry((e=>entry=e)),this.getEntryHeading(entry,i)},processCommand_set:async function(e,t,i){if(null==i&&(i=new Div),t.length<2)i.append("Error: usage: set &lt;name&gt; &lt;value&gt;");else{var s,l=t[1];if(2==t.length)(s=this.notebook.getGlobalValue(l))?i.append(s):i.append("Unknown: "+l);else s=(s=Utils.join(t," ",2)).replace(/\"/g,""),await this.notebook.addGlobal(l,s)}},processCommand_clearEntries:function(e,t,i){this.notebook.clearEntries(),i.set("Entries cleared")},processCommand_printEntries:async function(e,t,i){var s="";await this.getCurrentEntry((e=>current=e)),s+="current="+current.getName()+HU.br();var l=this.notebook.getCurrentEntries();for(var a in l){s+=a+"="+l[a].entry.getName()+HU.br()}""==s&&(s="No entries"),i.set(s)},processCommand_echo:async function(e,t,i){e=e.replace(/^echo */,""),i.set(e)},processCommand_print:async function(e,t,i){e=e.replace(/^print */,""),i.set(e)},processCommand_info:async function(e,t,i){await this.getCurrentEntry((e=>entry=e)),i.append("current:"+entry.getName()+" id:"+entry.getId()+HU.br())},processCommand_cd:async function(e,t,i){if(null==i&&(i=new Div),t.length<=1)await this.setCurrentEntry(this.notebook.getBaseEntry());else{var s,l=Utils.join(t," ",1).trim();await this.getEntryFromPath(l,(e=>s=e)),s?await this.setCurrentEntry(s):i.msg("Could not get entry:"+l)}},getEntryFromPath:async function(e,t){var i;await this.getCurrentEntry((e=>i=e)),e.startsWith("/")&&await i.getRoot((e=>{i=e}));for(var s=e.split("/"),l=0;l<s.length;l++){var a=s[l];if(""!=a)if(".."==a){if(await i.getParentEntry((e=>{i=e})),!i)break}else{await i.getChildrenEntries((e=>children=e));var r=null,o=!1,n=!1;a.endsWith("*")&&(a=a.substring(0,a.length-1),o=!0),a.startsWith("*")&&(a=a.substring(1),n=!0);for(var h=0;h<children.length;h++){let e=children[h];var d=e.getName();if(o&&n){if(d.includes(a)){r=e;break}}else if(o){if(d.startsWith(a)){r=e;break}}else if(n&&d.endsWith(a)){r=e;break}if(e.getName()==a||e.getFilename()==a){r=e;break}}if(!r)break;i=r}}return Utils.call(t,i)},processCommand_ls:async function(e,t,i){null==i&&(i=new Div),i.set("Listing entries..."),await this.getCurrentEntry((e=>entry=e)),await entry.getChildrenEntries((e=>{this.displayEntries(e,i)}),"")},entryListChanged:function(e){var t=e.getEntries();0==t.length?this.writeStatusMessage("Sorry, nothing found"):this.displayEntries(t)},processCommand_search:async function(e,t,i){for(var s="",l=1;l<t.length;l++)s+=t[l]+" ";s=s.trim();var a=new EntrySearchSettings({text:s}),r=this.notebook.getRamadda().getSearchUrl(a,OUTPUT_JSON);let o=this;var n={entryListChanged:function(e){var t=e.getEntries();i.set(""),0==t.length?i.append("Nothing found"):o.displayEntries(t,i)}},h=new EntryList(this.notebook.getRamadda(),r,n,!1);i.set("Searching..."),await h.doSearch()},processCommand_clear:function(e,t,i){this.clearOutput()},processCommand_save:function(e,t,i){this.notebook.saveNotebook()}})}function processLispOutput(e){return e&&e.val?e.val:Utils.formatJson(e)}function NotebookChunk(e,t){for(name in t)t[name.toLowerCase()]=t[name];this.div=new Div(null,"display-notebook-chunk"),this.cell=e,$.extend(this,{getContent:function(){var e=this.content;for(name in this.cell.notebook.globals){var t=this.cell.notebook.getGlobalValue(name);"object"==typeof t&&(t=Utils.formatJson(t)),e=e.replace("${"+name.trim()+"}",t)}return e},initChunk:function(e){this.skipOutput=!1,!0===e.skipoutput&&(this.skipOutput=!0,this.div.set(""),this.div=new Div);var t=[];e.depends&&"string"==typeof e.depends&&(t=e.depends.split(","));for(var i=e.content||"",s=RegExp(/\${([^ }]+)}/g);null!==(result=s.exec(i));){var l=result[1];t.includes(l)||t.push(l)}$.extend(this,{name:e.name,depends:t,output:null,runFirst:e.runFirst,hasRun:!1,content:i,type:e.type,props:e,doChunk:!!e.doChunk,ok:!0})}}),this.initChunk(t)}const DISPLAY_D3_GLIDER_CROSS_SECTION="GliderCrossSection",DISPLAY_D3_LINECHART="D3LineChart",DISPLAY_D3_PLOT="d3plot",DISPLAY_SKEWT="skewt",DISPLAY_VENN="venn",DISPLAY_CHERNOFF="chernoff",DISPLAY_D3BUBBLE="d3bubble",DISPLAY_MINIDOTS="minidots";addGlobalDisplayType({type:DISPLAY_D3_PLOT,forUser:!0,label:"D3 Plot",requiresData:!0,category:CATEGORY_MISC,tooltip:makeDisplayTooltip("D3 Plot",null,"In development. Uses D3.Plot")}),addGlobalDisplayType({type:DISPLAY_D3_LINECHART,forUser:!1,label:"D3 LineChart",requiresData:!0,category:"Charts"}),addGlobalDisplayType({type:DISPLAY_D3_GLIDER_CROSS_SECTION,forUser:!1,label:"Glider cross section",requiresData:!0,category:CATEGORY_MISC}),addGlobalDisplayType({type:DISPLAY_VENN,forUser:!0,label:"Venn Diagram",requiresData:!0,category:CATEGORY_MISC,tooltip:makeDisplayTooltip("A Venn diagram","venn.png")}),addGlobalDisplayType({type:DISPLAY_MINIDOTS,forUser:!1,label:"Mini Dots",requiresData:!0,category:CATEGORY_MISC}),addGlobalDisplayType({type:DISPLAY_CHERNOFF,forUser:!1,label:"Chernoff Faces",requiresData:!0,category:CATEGORY_MISC}),addGlobalDisplayType({type:DISPLAY_D3BUBBLE,forUser:!0,label:"Bubble Chart",requiresData:!0,category:CATEGORY_IMAGES,tooltip:makeDisplayTooltip("Animated bubbles showing images","d3bubble.png")}),addGlobalDisplayType({type:DISPLAY_SKEWT,forUser:!1,label:"SkewT",requiresData:!0,category:CATEGORY_MISC});const FIELD_TIME="time",FIELD_DEPTH="depth",FIELD_VALUE="value",FIELD_SELECTEDFIELD="selectedfield",TYPE_LATITUDE="latitude",TYPE_LONGITUDE="longitude",TYPE_TIME="time",TYPE_VALUE="value",TYPE_ELEVATION="elevation",FUNC_MOVINGAVERAGE="movingAverage",D3Util={initPlot:function(e,t){return t=t??{},["caption",["plotWidth","width"],["plotHeight","height"],"marginTop","marginRight","marginBottom","marginLeft","grid"].forEach((i=>{Array.isArray(i)||(i=[i,i]),Utils.isDefined(t[i[1]])||(t[i[1]]=e.getProperty(i[0]))})),t},initMarks:function(e,t){e.getProperty("showFrame")&&t.push(Plot.frame()),Utils.split(e.getProperty("rules",""),",").forEach((e=>{t.push(Plot.ruleY([parseFloat(e)]))})),t.push(Plot.axisX({ticks:d3.utcYear.every(50),tickFormat:"%Y"}))},createMarks:function(e,t,i,s){let l=[];return s=s??{},this.initMarks(e,l),t.forEach(((t,a)=>{let r={};$.extend(r,s),l.push(D3Util.createMark(e,t,i,a,r))})),l},getProperty:(e,t,i,s)=>e.getProperty(t+"."+i,e.getProperty(i))??s,createMark:function(e,t,i,s,l){(l=l??l).array||(l.array=this.getD3Data(e,t,i,{includeDate:l.includeDate}));let a,r={x:"Date",y:t.getId()},o=(l.colors??e.getColorList(),l.fill??this.getProperty(e,t.getId(),"fillColor"));r.strokeWidth=parseFloat(l.strokeWidth??this.getProperty(e,t.getId(),"strokeWidth",1)),r.stroke=l.stroke??this.getProperty(e,t.getId(),"strokeColor",COLOR_BLACK);let n=e.getProperty(t.getId()+".markType",e.getProperty("markType","line"));return"bar"==n?(r.fill=o,a=Plot.barY(l.array,r)):"dot"==n?(r.fill=o,r.r=parseFloat(this.getProperty(e,t.getId(),"radius",4)),a=Plot.dot(l.array,r)):("line"==n||console.error("Unknown mark type:"+n),a=Plot.lineY(l.array,r)),a},getD3Data:function(e,t,i,s){Array.isArray(t)||(t=[t]),s=s??{};let l={includeDate:!1};$.extend(l,s);let a=[];return i.forEach(((e,i)=>{let s={};l.includeDate&&(s.Date=e.getDate()),t.forEach((t=>{s[t.getId()]=t.getValue(e)})),a.push(s)})),a},getAxis:function(e,t){return e==FIELD_TIME?d3.time.scale().range(t):d3.scale.linear().range(t)},getDataValue:function(e,t,i){var s;if(e.fieldIdx>=0)s=t.getData()[e.fieldIdx];else switch(e.type){case TYPE_TIME:s=new Date(t.getDate());break;case TYPE_ELEVATION:s=t.getElevation();break;case TYPE_LATITUDE:s=t.getLatitude();case TYPE_LONGITUDE:s=t.getLongitude();default:s=t.getData()[i]}return 1==e.reverse?-1*s:s},getColorFromColorBar:function(e,t){var i=["#00008B","#0000CD","#0000FF","#00FFFF","#7CFC00","#FFFF00","#FFA500","#FF4500","#FF0000","#8B0000"],s=d3.scale.linear().domain([0,i.length-1]).range(t),l=d3.scale.linear().range(i).domain(d3.range(0,i.length).map(s));return color=l(e),color},addColorBar:function(e,t,i,s){var l=e.append(TAG_G).attr({id:"colorBarG",transform:HU.translate(s-40,0)});return l.append(TAG_G).append("defs").append("linearGradient").attr({id:"colorBarGradient",x1:"0%",y1:"100%",x2:"0%",y2:"0%"}).selectAll("stop").data(t).enter().append("stop").attr({offset:function(e,t){return i*t+"%"},"stop-color":function(e,i){return t[i]},"stop-opacity":1}),l}};function RamaddaD3plotDisplay(e,t,i){const s=new RamaddaDisplay(e,t,DISPLAY_D3_PLOT,i);defineDisplay(addRamaddaDisplay(this),s,[{label:"D3 Plot Attributes"},{p:"skewtWidth",ex:"500"}],{needsData:function(){return!0},updateUI:async function(){if(!window.Plot){if(this.awaiting)return;this.awaiting=!0,await Utils.importJS("https://cdn.jsdelivr.net/npm/@observablehq/plot@0.6.9/dist/plot.umd.min.js"),this.awaiting=!1}if(this.awaiting)return;let e=this.filterData();if(!e)return;let t=this.getSelectedFields([]),i=(D3Util.getD3Data(this,t,e,{includeDate:!0}),D3Util.createMarks(this,t,e,{includeDate:!0})),s=D3Util.initPlot(this,{marks:i}),l=Plot.plot(s);this.getContents().html(l)}})}function RamaddaSkewtDisplay(e,t,i){const s="skewtdate",l=new RamaddaDisplay(e,t,DISPLAY_SKEWT,i);defineDisplay(addRamaddaDisplay(this),l,[{label:"Skewt Attributes"},{p:"skewtWidth",ex:"500"},{p:"skewtHeight",ex:"550"},{p:"hodographWidth",ex:"150"},{p:"showHodograph",ex:"false"},{p:"windStride",ex:"1"},{p:"showText",ex:"false"}],{needsData:function(){return!0},initDisplay:function(){l.initDisplay.call(this)},handleEventPointDataLoaded:function(e,t){this.updateUI()},handleEventRecordSelection:function(e,t){this.skewt.highlightRecord(t.record)},updateUI:async function(){if(!this.loadedResources){if(this.loadingSkewt)return;this.loadingSkewt=!0,await Utils.importCSS(RamaddaUtil.getCdnUrl("/lib/skewt/sounding.css")),await Utils.importJS(RamaddaUtil.getCdnUrl("/lib/skewt/d3skewt.js")),this.loadedResources=!0}if(!window.D3Skewt)return void setTimeout((()=>this.updateUI()),100);if(l.updateUI.call(this),!d3.scaleLinear)return void this.setDisplayMessage("Oops, the wrong version of D3 had been loaded");let e=this.filterData();if(!e||0==e.length)return void this.setDisplayMessage(this.getLoadingMessage());let i=this.getDomId("skewt"),r="";r+=HU.div([ATTR_TITLE,"Download skew-t data",ATTR_ID,this.domId("download"),ATTR_CLASS,CLASS_CLICKABLE,ATTR_STYLE,HU.css(CSS_TEXT_ALIGN,"right",CSS_MARGIN_RIGHT,HU.px(20))],HU.getIconImage("fas fa-download")),r+=HU.div([ATTR_ID,i],""),this.setContents(r),this.jq("download").click((()=>{if(!this.dataObject)return void alert("No data available");let e=Object.keys(this.dataObject);e=Utils.removeItem(e,"records");let t="";e.forEach(((e,i)=>{i>0&&(t+=","),t+=e})),t+="\n";let i=this.dataObject[e[0]].length;for(let s=0;s<i;s++)e.forEach(((e,i)=>{i>0&&(t+=",");let l=parseFloat(this.dataObject[e][s]);l=Utils.trimDecimals(l,4),t+=l})),t+="\n";Utils.makeDownloadFile(this.getProperty(ATTR_TITLE,"skewt").replace(/ /g,"_")+".csv",t)}));let o=e[0].getDate();0==this.jq(s).length&&this.jq(ID_TOP_LEFT).append(HU.div([ATTR_ID,this.getDomId(s)])),null!=o?this.jq(s).html("Date: "+this.formatDate(o)):this.jq(s).html("");let n={};this.propertyDefined("showHodograph")&&(n.showHodograph=this.getProperty("showHodograph",!0)),this.propertyDefined("showText")&&(n.showText=this.getProperty("showText",!0)),this.propertyDefined("skewtWidth")&&(n.skewtWidth=parseInt(this.getProperty("skewtWidth"))),this.propertyDefined("skewtHeight")&&(n.skewtHeight=parseInt(this.getProperty("skewtHeight"))),this.propertyDefined("hodographWidth")&&(n.hodographWidth=parseInt(this.getProperty("hodographWidth"))),this.propertyDefined("windStride")&&(n.windStride=parseInt(this.getProperty("windStride"))),n.showText=this.getProperty("showText",!0);let h=this.getData().getRecordFields(),d=[{id:"pressure",aliases:["vertCoord","pressure_mb"]},{id:"height",aliases:["Geopotential_height_isobaric"]},{id:"temperature",aliases:["Temperature_isobaric","temperature_c"]},{id:"dewpoint",aliases:[]},{id:"rh",aliases:["Relative_humidity_isobaric","relative_humidity"]},{id:"wind_direction",aliases:["wind_direction_true_deg"]},{id:"wind_speed",aliases:["wind_speed_m_s"]},{id:"uwind",aliases:["u-component_of_wind_isobaric","u"]},{id:"vwind",aliases:["v-component_of_wind_isobaric","v"]}],g={},p={};for(let t=0;t<d.length;t++){let i=d[t],s=i.id,l=this.getFieldById(h,s,!1,!0);if(null==l)for(let e=0;e<i.aliases.length&&(l=this.getFieldById(h,i.aliases[e],!1,!0),!l);e++);l&&(g[s]=this.getColumnValues(e,l).values,p[s]=l)}let c=()=>h.reduce(((e,t)=>e+t.getId()+HU.br()),HU.div([],HU.boldLabel("Fields")));if(!g.pressure)return void this.displayError("No pressure defined in data."+c());if(!g.temperature)return void this.displayError("No temperature defined in data."+c());if(g.records=e,!g.height){let e=[1013.25,954.61,898.76,845.59,795.01,746.91,701.21,657.8,616.6,577.52,540.48,505.39,472.17,440.75,411.05,382.99,356.51,331.54,303,285.85,264.99,226.99,193.99,165.79,141.7,121.11,103.52,88.497,75.652,64.674,55.293,25.492,11.97,5.746,2.871,1.491,.798,.22,.052,.01],t=[0,500,1e3,1500,2e3,2500,3e3,3500,4e3,4500,5e3,5500,6e3,6500,7e3,7500,8e3,8500,9e3,9500,1e4,11e3,12e3,13e3,14e3,15e3,16e3,17e3,18e3,19e3,2e4,25e3,3e4,35e3,4e4,45e3,5e4,6e4,7e4,8e4];g.height=[];for(let i=0;i<g.pressure.length;i++){let s=g.pressure[i],l=t[t.length-1];for(let i=0;i<e.length;i++)if(s>=e[i]){if(0==i)l=0;else{let a=e[i-1],r=e[i],o=t[i-1];l=(t[i]-o)*(1-(s-r)/(a-r))+o}break}g.height.push(l)}}if(!g.dewpoint){if(!g.rh)return void this.displayError("No dewpoint or rh."+c());g.dewpoint=[];for(let e=0;e<g.rh.length;e++){let t=g.rh[e],i=g.temperature[e]-(100-t)/5;g.dewpoint.push(i)}}if(!g.wind_speed){if(!g.uwind||!g.vwind)return void this.displayError("No wind speed defined in data."+c());g.wind_speed=[],g.wind_direction=[];for(let e=0;e<g.uwind.length;e++){let t=g.uwind[e],i=g.vwind[e],s=Math.sqrt(t*t+i*i),l=180+180/Math.PI*Math.atan2(i,t);g.wind_speed.push(s),g.wind_direction.push(l)}}let u=g;for(a in g={},u)g[a]=[];if(u[d[0].id].map(((e,i)=>{let s=!0;for(t in u)if(isNaN(u[t][i])){s=!1;break}if(s||"records"==t)for(t in u)g[t].push(u[t][i])})),g.height.length>1&&g.height[0]>g.height[1])for(name in g)g[name]=Utils.reverseArray(g[name]);if(0!=g.temperature.length){this.dataObject=g,n.myid=this.getId(),n.mouseDownListener=e=>{e&&this.propagateEventRecordSelection({highlight:!0,record:e})};try{this.skewt=new D3Skewt(i,n,g)}catch(e){return this.displayError("An error occurred: "+e),void console.log("error:"+e.stack)}await this.getDisplayEntry((e=>{if(!e)return;let t=e.getAttribute("variables");t&&(t=t.value,t=t.replace(/\r\n/g,"\n"),t=t.replace(/^ *\n/,""),t=t.replace(/^ *([^:]+):([^\n].*)$/gm,"<div title='$1' class=display-skewt-index-label>$1</div>: <div title='$2'  class=display-skewt-index>$2</div>"),t=t.replace(/[[\r\n]/g,"\n"),t=HU.div([ATTR_CLASS,"display-skewt-text"],t),jqid(this.skewt.textBoxId).html(t))}))}else this.displayError(this.getNoDataMessage())}})}function RamaddaD3Display(e,t,i){const s="svg",l=new RamaddaDisplay(e,t,"d3",i);defineDisplay(addRamaddaDisplay(this),l,[],{initDisplay:function(){this.createUI(),this.setDisplayTitle(i.graph.title);let e=this.getProperty("innerWidth",600),t=this.getProperty("innerHeight",300),l=20,a=50,r=30,o=50,n=HU.css(CSS_HEIGHT,HU.px(t),CSS_WIDTH,HU.px(e)),h=HU.div([ATTR_ID,this.getDomId(s),ATTR_STYLE,n],"");this.setContents(h),this.displayHeight=parseInt(d3.select("#"+this.getDomId(s)).style(CSS_HEIGHT).split("px")[0])-l-r,this.displayWidth=parseInt(d3.select("#"+this.getDomId(s)).style(CSS_WIDTH).split("px")[0])-o-a;let d=this,g=d3.behavior.zoom().on("zoom",(function(){d.zoomBehaviour()}));this.zoom=g,this.svg=d3.select("#"+this.getDomId(s)).append(TAG_SVG).attr(ATTR_WIDTH,this.displayWidth+o+a).attr(ATTR_HEIGHT,this.displayHeight+l+r).attr(ATTR_CLASS,"D3graph").call(g).on("click",(function(e){d.click(e)})).on("dblclick",(function(e){d.dbclick(e)})).append(TAG_G).attr(ATTR_TRANSFORM,HU.translate(o,l)),this.x=D3Util.getAxis(i.graph.axis.x.type,[0,this.displayWidth-100]),this.y=D3Util.getAxis(i.graph.axis.y.type,[this.displayHeight,0]),this.xAxis=d3.svg.axis().scale(this.x).orient("bottom"),this.yAxis=d3.svg.axis().scale(this.y).orient("left"),this.svg.append(TAG_G).attr(ATTR_CLASS,"x axis").attr(ATTR_TRANSFORM,HU.translate(0,this.displayHeight)).call(this.xAxis),this.svg.append(TAG_G).attr(ATTR_CLASS,"y axis").call(this.yAxis);let p=["#00008B","#0000CD","#0000FF","#00FFFF","#7CFC00","#FFFF00","#FFA500","#FF4500","#FF0000","#8B0000"],c=100/(p.length-1);D3Util.addColorBar(this.svg,p,c,this.displayWidth);this.color=d3.scale.category10(),this.updateUI()},needsData:function(){return!0},initDialog:function(){this.addFieldsCheckboxes()},getDialogContents:function(){this.getProperty(PROP_HEIGHT,"400");let e=HU.div([ATTR_ID,this.getDomId(ID_FIELDS),ATTR_CLASS,"display-fields"]);return e+=l.getDialogContents.apply(this),e},fieldSelectionChanged:function(){this.updateUI()},updateUI:function(){if(!this.hasData())return;test=this;let e=this.getSelectedFields();if(0==e.length)return;if(this.addFieldsCheckboxes(),pointData=this.getData(),null==pointData)return void console.log("no data");let t=pointData.getNumericFields(),s=pointData.getRecords(),l=RecordUtil.getRanges(t,s),a=RecordUtil.getElevationRange(t,s),r=(a[1],a[0],this.x),o=this.y,n=this.color,h=i.graph.axis;this.x.domain(d3.extent(s,(function(t){return D3Util.getDataValue(h.x,t,e[0].getIndex())}))),this.y.domain(d3.extent(s,(function(t){return D3Util.getDataValue(h.y,t,e[0].getIndex())}))),this.zoom.x(this.x),this.zoom.y(this.y),this.svg.selectAll(".y.axis").call(this.yAxis),this.svg.selectAll(".x.axis").call(this.xAxis),this.svg.selectAll(".line").remove(),this.svg.selectAll(".legendElement").remove();let d=this;for(let t=0;t<e.length;t++){l[e[t].getIndex()];let a=d3.svg.line().x((function(i){return r(D3Util.getDataValue(h.x,i,e[t].getIndex()))})).y((function(i){return o(D3Util.getDataValue(h.y,i,e[t].getIndex()))}));if(displayLine=this.svg.append("path").datum(s).attr(ATTR_CLASS,"line").attr("d",a).on("mousemove",(function(e){d.mouseover(e)})).attr(ATTR_FILL,"none").attr(ATTR_STROKE,(function(e){return n(t)})).attr(ATTR_STROKE_WIDTH,HU.px(.5)),i.graph.axis.z==FIELD_SELECTEDFIELD&&displayLine.attr(ATTR_STROKE,"url(#colorBarGradient)"),null!=i.graph.derived){let l=i.graph.derived.split(",");for(funcIdx=0;funcIdx<l.length;funcIdx++){let i=l[funcIdx];if(i==FUNC_MOVINGAVERAGE){let i=d3.svg.line().x((function(i){return r(D3Util.getDataValue(h.x,i,e[t].getIndex()))})).y((function(i,s){return 0==s?_movingSum=D3Util.getDataValue(h.y,i,e[t].getIndex()):(_movingSum+=D3Util.getDataValue(h.y,i,e[t].getIndex()),o(_movingSum/s))})).interpolate("basis");this.svg.append("path").attr(ATTR_CLASS,"line").attr("d",i(s)).attr(ATTR_FILL,"none").attr(ATTR_STROKE,(function(e){return n(t)})).attr(ATTR_STROKE_WIDTH,"1.5px").attr("viewBox","50 50 100 100 ").style("stroke-dasharray","3, 3")}else console.log("Error: Unknown derived function:"+i)}}this.svg.append("svg:rect").attr(ATTR_CLASS,"legendElement").attr(ATTR_X,this.displayWidth-100).attr(ATTR_Y,50+50*t).attr(ATTR_STROKE,(function(e){return n(t)})).attr(ATTR_HEIGHT,2).attr(ATTR_WIDTH,40),this.svg.append("svg:text").attr(ATTR_CLASS,"legendElement").attr(ATTR_X,this.displayWidth-100+40+10).attr(ATTR_Y,55+55*t).attr(ATTR_STROKE,(function(e){return n(t)})).attr(ATTR_STYLE,HU.css(CSS_FONT_SIZE,HU.perc(50))).text(e[t].getLabel())}},zoomBehaviour:function(){this.updateUI(!0)},handleEventRecordSelection:function(e,t){},mouseover:function(e){console.log("mouseover")},click:function(e){console.log("click:"+e)},dbclick:function(e){this.zoom(),this.updateUI()},getSVG:function(){return this.svg}})}function RamaddaD3LineChartDisplay(e,t,i){var s={};return s.graph={title:"Line chart",derived:FUNC_MOVINGAVERAGE,axis:{y:{type:TYPE_VALUE,fieldname:FIELD_SELECTEDFIELD},x:{type:TYPE_TIME,fieldname:FIELD_TIME}}},new RamaddaD3Display(e,t,i=$.extend(s,i))}function RamaddaGliderCrossSectionDisplay(e,t,i){var s={};return s.graph={title:"Glider cross section",derived:null,axis:{y:{type:TYPE_ELEVATION,fieldname:FIELD_DEPTH,reverse:!0},x:{type:TYPE_TIME,fieldname:FIELD_TIME},z:FIELD_SELECTEDFIELD}},new RamaddaD3Display(e,t,i=$.extend(s,i))}var loadedVenn=!1;function RamaddaVennDisplay(e,t,i){const s="venn",l=new RamaddaFieldsDisplay(e,t,DISPLAY_VENN,i);defineDisplay(addRamaddaDisplay(this),l,[],{getContentsStyle:function(){return""},checkLayout:function(){this.updateUIInner()},updateUI:function(){if(!loadedVenn){loadedVenn=!0;var e=HU.tag(TAG_SCRIPT,[ATTR_SRC,RamaddaUtil.getCdnUrl("/lib/venn.js")]);this.writeHtml(ID_DISPLAY_TOP,e)}let t=this;var i=function(){window.venn?t.updateUIInner():setTimeout(i,1e3)};i()},updateUIInner:function(){let e=this.filterData();if(e){var t=this.getData().getRecordFields(),i=this.getSelectedFields(t);0==i.length&&(i=t);var l=this.getFieldsByType(i,"string");if(0!=l.length){for(var a={},r=0,o=0;o<e.length;o++){for(var n=this.getDataValues(e[o]),h=[],d="",g=0;g<l.length;g++){var p=l[g],c=n[p.getIndex()],u=p.getId()+"--"+c;h.push(u),d+="--"+u,Utils.isDefined(a[u])||(a[u]={count:0,setIds:[r],label:c},r++),a[u].count++}var T=[];if(!Utils.isDefined(a[d])){for(var f=0;f<h.length;f++)T.push(a[h[f]].setIds[0]);a[d]={count:0,setIds:T,label:null}}a[d].count++}var y=[];for(var m in a){var _=a[m],S={sets:_.setIds,size:_.count};_.label&&(S.label=_.label),y.push(S)}this.setContents(HU.div([ATTR_ID,this.getDomId(s),ATTR_STYLE,HU.css(CSS_HEIGHT,HU.px(300))],""));var A=venn.VennDiagram().width(600).height(400),I="#"+this.getDomId(s),b=this.getColorTable(!0,"strokeColors","nice"),R=this.getColorTable(!0,"fillColors","nice"),D=this.getColorTable(!0,"textColors");D||(D=b),d3.select(I).datum(y).call(A),d3.selectAll(I+" .venn-circle path").style("fill-opacity",parseFloat(this.getProperty("fillOpacity",.5))).style("stroke-width",parseInt(this.getProperty("strokeWidth",1))).style("stroke-opacity",parseFloat(this.getProperty("strokeOpacity",.5))).style(ATTR_STROKE,(function(e,t){return t<b.length?b[t]:b[t%b.length]})).style("fill",(function(e,t){return t<R.length?R[t]:R[t%R.length]})),d3.selectAll(I+" .venn-circle text").style("fill",(function(e,t){return t<D.length?D[t]:D[t%D.length]})).style("font-size",this.getProperty("fontSize","16px")).style("font-weight",this.getProperty("fontWeight","100"))}else this.displayError("No string fields specified")}}})}function RamaddaMinidotsDisplay(e,t,i){const s="minidots",l=new RamaddaFieldsDisplay(e,t,DISPLAY_MINIDOTS,i);defineDisplay(addRamaddaDisplay(this),l,[],{getContentsStyle:function(){return""},checkLayout:function(){this.updateUI()},updateUI:function(){let e=this.filterData();if(!e)return;let t=+this.getProperty("dotsWidth",500),i=+this.getProperty("dotsHeight",200),l=this.getFieldById(null,this.getPropertyValueField()),a=this.getFieldById(null,this.getPropertyDateField()),r=this.getFieldById(null,this.getProperty("groupBy")),o=+this.getProperty("divisor",1);if(!l)return void this.displayError("No value field specified");a||(a=this.getFieldByType(null,"date"));let n=null,h=null,d={};e.forEach((e=>{let t=a?e.getValue(a.getIndex()):e.getDate();n=null!=n?Math.min(n,t.getTime()):t,h=null!=h?Math.max(h,t.getTime()):t})),e.forEach((e=>{let t=r?e.getValue(r.getIndex()):"all",i=a?e.getValue(a.getIndex()):e.getDate();n=null!=n?Math.min(n,i.getTime()):i,h=null!=h?Math.max(h,i.getTime()):i;let s=d[t];s||(d[t]=s={records:[],total:0,list:[],seen:{}}),s.records.push(e);let g=e.getValue(l.getIndex());if(s.total+=g,g/=o,!(s.list.length>5e3))for(let t=0;t<g;t++)s.list.push({x:i.getTime(),y:Math.random(),record:e})}));let g={minx:n,maxx:h,miny:0,maxy:1},p=Object.keys(d).sort();if(r){this.jq(s);let e=HU.open(TAG_TABLE,[ATTR_BORDER,1]);p.forEach(((s,l)=>{let a=d[s];e+=HU.open(TAG_TR),e+=HU.td([],s+" ("+a.total+")");let r=this.getDomId("minidots_"+l);e+=HU.td([],HU.div([ATTR_CLASS,"display-minidots-dots",ATTR_ID,r,ATTR_STYLE,HU.css(CSS_HEIGHT,HU.getDimension(i),CSS_WIDTH,HU.getDimension(t))],"")),e+=HU.close(TAG_TR)})),this.setContents(e),p.forEach(((e,s)=>{let l=d[e];drawDots(this,"#"+this.getDomId("minidots_"+s),t,i,l.list,g,null)}))}else{let e=d.all;this.setContents(HU.div([ATTR_CLASS,"display-minidots-dots",ATTR_ID,this.getDomId(s),ATTR_STYLE,HU.css(ATTR_HEIGHT,HU.getDimension(i),ATTR_WIDTH,HU.getDimension(t))],"")),drawDots(this,"#"+this.getDomId(s),t,i,e.list,g,null)}}})}function RamaddaChernoffDisplay(e,t,i){const s=new RamaddaFieldsDisplay(e,t,DISPLAY_VENN,i);defineDisplay(addRamaddaDisplay(this),s,[],{getContentsStyle:function(){return""},checkLayout:function(){this.updateUIInner()},timeout:100,written:!1,updateUI:function(){if(!this.written){this.written=!0;var e=HU.tag(TAG_SCRIPT,[ATTR_SRC,RamaddaUtil.getCdnUrl("/lib/chernoff.js")]);this.writeHtml(ID_DISPLAY_TOP,e)}this.updateUIInner()},updateUIInner:function(){let e=this;if(!Utils.isDefined(d3.chernoff)){this.timeout=2*this.timeout;return void setTimeout((function(){e.updateUIInner()}),this.timeout)}let t=this.filterData();if(t){var i=this.getData().getRecordFields(),s=this.getSelectedFields(i);if(0!=this.getFieldsByType(s,"numeric").length){0==s.length&&(s=i);var l,r=this.getFieldByType(s,"string"),o="",n=this.getFieldById(i,this.getProperty("colorBy"));if(n){var h=this.getColorTable(!0,null,"blue_white_red"),d=this.getColumnValues(t,n);l=[];for(var g=parseFloat(this.getProperty("colorByMin",d.min)),p=(P=parseFloat(this.getProperty("colorByMax",d.max)))-g,c=0;c<d.values.length;c++){var u=((H=d.values[c])-g)/p,T=Math.round(u*(h.length-1));l.push(h[T])}this.displayColorTable(h,ID_DISPLAY_BOTTOM,g,P),o+=HU.b("Colored by")+n.getLabel()+SPACE2}var f=[{label:"Face width",name:"face",key:"f",min:0,max:1},{label:"Hair",name:"hair",key:"h",min:-1,max:1},{label:"Mouth",name:"mouth",key:"m",min:-1,max:1},{label:"Nose height",name:"noseHeight",key:"nh",min:0,max:1},{label:"Nose width",name:"noseWidth",key:"nw",min:0,max:1},{label:"Eyes height",name:"eyesHeight",key:"eh",min:0,max:1},{label:"Eyes width",name:"eyesWidth",key:"ew",min:0,max:1},{label:"Brow",name:"brow",key:"b",min:-1,max:1}],y="",m=this.getProperty("showHelp",!1);for(a in m&&(y+="Settings:<br><table class=ramadda-table><thead><tr><th>Attribute&nbsp;</th><th>&nbsp;Default range&nbsp;</th><th>&nbsp;Set field&nbsp;</th><th>&nbsp;Set min&nbsp;</th><th>&nbsp;Set max&nbsp;</th></tr></thead><tbody>"),f){var _=f[a];m&&(y+="<tr><td>"+_.label+"</td><td align=center>"+_.min+" - "+_.max+"</td><td>"+_.name+"Field=&lt;field_id&gt;</td><td>"+_.name+"Min=&lt;min_value&gt;</td><td>"+_.name+"Max=&lt;max_value&gt;</td></tr>"),_.field=this.getFieldById(i,this.getProperty(_.name+"Field")),_.field&&(o+=HU.b(_.label)+": "+_.field.getLabel()+SPACE2,Utils.isDefined(this.getProperty(_.name+"Min"))&&(_.min=parseFloat(this.getProperty(_.name+"Min"))),Utils.isDefined(this.getProperty(_.name+"Max"))&&(_.max=parseFloat(this.getProperty(_.name+"Max"))),_.column=this.getColumnValues(t,_.field))}m&&(y+=HU.close(TAG_TBODY,TAG_TABLE));for(var S=this.getFieldById(i,this.getProperty("sortBy")),A=[],I=0;I<t.length;I++){var b={values:this.getDataValues(t[I])};l&&(b.color=l[I]),A.push(b)}S&&A.sort((function(e,t){var i=e.values[S.getIndex()],s=t.values[S.getIndex()];return i<s?1:i>s?-1:0}));var R=[];for(I=0;I<A.length;I++){var D=(b=A[I]).values,L=b.color,U={f:.5,h:0,m:0,nh:.5,nw:.5,eh:.5,ew:.5,b:0};R.push({faceData:U,color:L});var C="";for(a in f){var E=(_=f[a]).field;if(E){var H=D[E.getIndex()],P=(g=_.column.min,_.column.max);if(C+=E.getLabel()+": "+H+" range: "+g+" - "+P+" ("+_.label+")\n",P!=g){u=(H-g)/(P-g);var x=_.min+(_.max-_.min)*u;U[_.key]=x}}else U[_.key]=_.min+(_.max-_.min)/2}var v=r?D[r.getIndex()]:"Row: "+I,O=r?D[r.getIndex()]:"";v=HU.div([ATTR_CLASS,"display-chernoff-label"],v);var N=HU.div([ATTR_ID,this.getDomId("chernoff")+"_"+I,ATTR_CLASS,"display-chernoff-face"],"");y+=HU.div([ATTR_TITLE,C,ATTR_CLASS,"display-chernoff-wrapper ramadda-div-link",ATTR_VALUE,O],N+v)}o=HU.div([ATTR_CLASS,"display-chernoff-legend"],o);var w=this.getProperty("height",HU.px(400));w.endsWith("px")||(w+="px"),this.setContents(o+HU.div([ATTR_STYLE,HU.css(CSS_HEIGHT,w),ATTR_CLASS,"display-chernoff-container",ATTR_ID,this.getDomId("chernoff")],y));for(I=0;I<t.length;I++){N="#"+this.getDomId("chernoff")+"_"+I;this.makeFace(N,R[I].faceData,R[I].color)}r&&this.find(".ramadda-div-link").click((function(){var t=$(this).attr(ATTR_VALUE);e.propagateEvent("fieldValueSelected",{field:r,value:t})}))}else this.displayError("No numeric fields specified")}},makeFace:function(e,t,i){d3.select(e).call(function(){var e=d3.chernoff().face((function(e){return e.f})).hair((function(e){return e.h})).mouth((function(e){return e.m})).nosew((function(e){return e.nw})).noseh((function(e){return e.nh})).eyew((function(e){return e.ew})).eyeh((function(e){return e.eh})).brow((function(e){return e.b}));function s(s){var l=s.append(TAG_SVG).attr(ATTR_WIDTH,400).attr(ATTR_HEIGHT,200).selectAll("g.chernoff").data([t]).enter().append(TAG_G).attr(ATTR_CLASS,"chernoff").call(e);i&&l.attr(ATTR_STYLE,HU.css(CSS_FILL,i))}return function(e){e.call(s)}}())}})}function RamaddaD3bubbleDisplay(e,t,i){const s="bubbles",l=new RamaddaDisplay(e,t,DISPLAY_D3BUBBLE,i);window.BubbleChart||(Utils.importJS(RamaddaUtil.getCdnUrl("/lib/d3/d3-legend.min.js")),Utils.importJS(RamaddaUtil.getCdnUrl("/lib/d3/bubblechart.js")));defineDisplay(addRamaddaDisplay(this),l,[{label:"Bubble Chart"},{p:"labelField",ex:""},{p:"colorBy",ex:""},{p:"valueField",ex:""},{p:"descriptionField",ex:""},{p:"imageField",ex:""},{p:"sizeLabel1",ex:""},{p:"sizeLabel2",ex:""},{p:"showSizeLegend",ex:"false"}],{needsData:function(){return!0},callbackWaiting:!1,displayData:function(){this.updateUI()},updateUI:function(){if(!window.BubbleChart)return void(this.callbackWaiting||(this.callbackWaiting=!0,setTimeout((()=>{this.callbackWaiting=!1,this.updateUI()}),100)));if(0==this.getContents().width())return void this.setContents("...");let e=this.filterData();if(!e)return;let t=this.getFieldById(null,this.getProperty("colorBy","category")),i=this.getFieldById(null,this.getProperty("valueField"));t&&this.setProperty("sortFields",t.getId());let l,a=HU.tag(TAG_SVG,[ATTR_ID,this.getDomId(s),ATTR_WIDTH,HU.perc(100),ATTR_HEIGHT,700,"font-family","sans-serif","font-size","10","text-anchor","middle"]);this.setContents(a);let r=0,o=0;i&&(l=this.getColumnValues(e,i).values,l.map(((e,t)=>{r=0==t?e:Math.min(e,r),o=0==t?e:Math.max(e,o)})));let n=this.getFieldById(null,this.getProperty("labelField","name")),h=this.getFieldById(null,this.getProperty("descriptionField")),d=this.getFieldById(null,this.getProperty("imageField")),g=this.getProperty("template","${default}");if(!n)return void this.setContents(this.getMessage("No label field found"));let p=[];if(e.map((e=>{let s=h?e.getValue(h.getIndex()):this.getRecordHtml(e,null,g),l=e.getValue(n.getIndex()),a={name:l,icon:l,desc:s,cat:"",value:10};t&&(a.cat=e.getValue(t.getIndex())),i&&(a.value=e.getValue(i.getIndex())),d&&(a.icon=e.getValue(d.getIndex())),p.push(a)})),0==p.length)return void this.setContents(this.getMessage(this.getNoDataMessage()));let c=this.getColorTable(!0);new BubbleChart("#"+this.domId(s),p,{label1:this.getProperty("sizeLabel1"),label2:this.getProperty("sizeLabel2"),colors:c,showSizeLegend:this.getProperty("showSizeLegend",null!=i)})}})}const DISPLAY_WORDCLOUD="wordcloud",DISPLAY_TEXTSTATS="textstats",DISPLAY_FREQUENCY="frequency",DISPLAY_TEXTANALYSIS="textanalysis",DISPLAY_TEXTRAW="textraw",DISPLAY_TEXT="text",DISPLAY_BLOCKS="blocks",DISPLAY_TEMPLATE="template",DISPLAY_TOPFIELDS="topfields",DISPLAY_GLOSSARY="glossary";function RamaddaBaseTextDisplay(e,t,i,s){defineDisplay(this,new RamaddaFieldsDisplay(e,t,i,s),[],{processText:function(e,t){let i=this.filterData();if(!i)return null;var s={},l=this.getData().getRecordFields();0==(t=t||this.getSelectedFields(l)).length&&(t=l);var a=this.getFieldsByType(t,"string");if(0==a.length)return this.displayError("No string fields specified"),null;var r=parseInt(this.getProperty("minLength",0)),o=parseInt(this.getProperty("maxLength",100)),n=this.getProperty("stopWords");n&&(n="default"==n?Utils.stopWords:n.split(","));var h=this.getProperty("extraStopWords");h&&(h=h.split(","));var d=this.getProperty("stripTags",!1),g=this.getProperty("tokenize",!1),p=this.getProperty("lowerCase",!1),c=this.getProperty("removeArticles",!1);e&&(e.count=0,e.total=0,e.lengths={});for(var u=0;u<i.length;u++)for(var T=this.getDataValues(i[u]),f=0;f<a.length;f++){var y=a[f];s[y.getId()]||(s[y.getId()]={field:y,words:[],counts:{},divId:this.domId("textblock"+y.getIndex())});var m=s[y.getId()],_=T[y.getIndex()];d&&(_=Utils.stripTags(_));var S=[_];g&&(S[0]=S[0].replace(/\"/g," "),S=Utils.tokenizeWords(S[0],n,h,c));for(var A=0;A<S.length;A++){_=S[A].trim();if(!(S.length>1&&_.length<=1)&&!_.startsWith("&")){var I=_.toLowerCase();if(e&&(e.count++,e.total+=_.length,Utils.isDefined(e.lengths[_.length])||(e.lengths[_.length]=0),e.lengths[_.length]++),!g){if(n&&n.includes(I))continue;if(h&&h.includes(I))continue}_.length>o||_.length<r||(p&&(_=_.toLowerCase()),Utils.isDefined(m.counts[_])||(m.counts[_]=0),m.counts[_]++)}}}return s}})}function RamaddaWordcloudDisplay(e,t,i){const s=new RamaddaBaseTextDisplay(e,t,DISPLAY_WORDCLOUD,i);defineDisplay(addRamaddaDisplay(this),s,[{label:"Wordcloud"},{p:"termField"},{p:"fields"},{p:"tableFields"},{p:"countField"},{p:"tokenize",ex:!0},{p:"handleClick",ex:!0},{p:"showFieldLabel",ex:!0},{p:"showRecords"},{p:"combined"},{p:"shape",ex:"rectangular"},{p:"stopWords",ex:"word1,word2"},{p:"showFieldLabel",ex:"false"}],{getContentsStyle:function(){return""},checkLayout:function(){this.updateUIInner()},hasJq:!1,updateUI:function(){if(this.loadedJq)this.hasJq&&this.updateUIInner();else{this.loadedJq=!0;let e=HU.tag(TAG_LINK,[ATTR_REL,"stylesheet",ATTR_HREF,RamaddaUtil.getCdnUrl("/lib/jqcloud.min.css")]);e+=HU.tag(TAG_SCRIPT,[ATTR_SRC,RamaddaUtil.getCdnUrl("/lib/jqcloud.min.js")]),this.writeHtml(ID_DISPLAY_TOP,e);let t=this,i=$(TAG_BODY),s=function(){i.jQCloud?(t.hasJq=!0,t.updateUIInner()):setTimeout(s,100)};setTimeout(s,100)}},updateUIInner:function(){let e=this.filterData();if(null==e)return;let t=this.getFieldById(null,this.getProperty("countField")),i=this.getFieldById(null,this.getProperty("termField")),s=this.getData().getRecordFields(),l=i?[i]:this.getSelectedFields(s),r=this.processText(null,l);if(null==r)return;0==l.length&&(l=s);let o={autoResize:!0},n=this.getColorTable(!0);if(n&&(o.colors=n,o.classPattern=null,o.fontSize={from:.1,to:.02}),this.getProperty("shape")&&(o.shape=this.getProperty("shape")),t&&i){parseInt(this.getProperty("minLength",0)),parseInt(this.getProperty("maxLength",100));let s=this.getProperty("stopWords");s&&(s="default"==s?Utils.stopWords:s.split(","));let a=[],r={};e.every((e=>{let l=i.getValue(e),a=l.toLowerCase();return s&&s.includes(a)||(r[l]||(r[l]=0),r[l]+=t.getValue(e)),!0}));let n=null,h=this;for(word in this.getProperty("handleClick",!0)&&(n={click:function(t){console.dir(t);let i=t.target.innerText;h.showRows(e,null,i,l)}}),r)a.push({text:word,html:{style:HU.css(CSS_CURSOR,CURSOR_POINTER)},weight:r[word],handlers:n});return this.setContents(HU.div([ATTR_ID,this.domId("words"),ATTR_STYLE,HU.css(CSS_HEIGHT,HU.px(300))])),void jqid(this.domId("words")).jQCloud(a,o)}let h=this.getFieldsByType(l,"string"),d=this,g="",p=[],c=parseInt(this.getProperty("maxWords",-1)),u=parseInt(this.getProperty("minCount",0)),T=HU.perc(100/h.length);for(a in r){let t=r[a],i=t.field,s=null;this.getProperty("handleClick",!0)&&(s={click:function(t){let s=t.target.innerText;d.showRows(e,i,s,l)}});let o=[];for(word in t.counts){let e=t.counts[word];o.push({word:word,count:e})}if(o.sort((function(e,t){return e.count<t.count?-1:e.count>t.count?1:0})),u>0){let e=[];for(let t=0;t<o.length;t++)o[t].count>=u&&e.push(o[t]);o=e}if(c>0){let e=[];for(let t=0;t<=c&&t<o.length;t++)o[t].count>=u&&e.push(o[t]);o=e}for(let e=0;e<o.length;e++){let l=o[e],a={weight:l.count,html:{style:HU.css(CSS_CURSOR,CURSOR_POINTER)},handlers:s,text:l.word},r={weight:l.count,html:{style:HU.css(CSS_CURSOR,CURSOR_POINTER)},handlers:s,text:i.getLabel()+":"+l.word};t.words.push(a),p.push(r)}let n="";this.getProperty("showFieldLabel",!0)&&(n=HU.b(t.field.getLabel())),g+=HU.div([ATTR_STYLE,HU.css(CSS_DISPLAY,DISPLAY_INLINE_BLOCK,CSS_WIDTH,T)],n+HU.div([ATTR_STYLE,HU.css(CSS_BORDER,HU.border(1,COLOR_LIGHT_GRAY),CSS_HEIGHT,HU.px(300)),ATTR_ID,t.divId]))}if(this.setContents(""),this.getProperty("combined",!1))this.setContents(HU.div([ATTR_ID,this.domId("words"),ATTR_STYLE,HU.css(CSS_HEIGHT,HU.px(300))])),jqid(this.domId("words")).jQCloud(p,o);else for(a in this.setContents(g),r){let e=r[a];jqid(e.divId).jQCloud(e.words,o)}},showRows:function(e,t,i,s){t||(t=this.getFieldById(null,this.getProperty("termField")));let l,r=this.getProperty("tokenize",!1);if(s&&i.startsWith(t.getLabel()+":")&&(i=i.replace(t.getLabel()+":","")),this.getProperty("tableFields")){l={};let e=this.getProperty("tableFields").split(",");for(a in e)l[e[a]]=!0}let o=this.getData().getRecordFields(),n="",h=[],d=[];h.push(d);for(let e=0;e<o.length;e++){let t=o[e];l&&!l[t.getId()]||d.push(o[e].getLabel())}let g=this.getProperty("showRecords",!1);g&&(n+=HU.br());let p=new RegExp("(\\b"+i+"\\b)","i");for(let s=0;s<e.length;s++){let a=this.getDataValues(e[s]),d=a[t.getIndex()];if(r){if(!d.match(p))continue}else if(i!=d)continue;let c=[];h.push(c);for(let e=0;e<o.length;e++){let t=o[e];if(l&&!l[t.getId()])continue;let i=a[t.getIndex()];i.getTime?i={v:i,f:this.formatDate(i)}:r&&(i=i.replace(p,HU.span([ATTR_STYLE,HU.css(CSS_BACKGROUND,"yellow")],"$1"))),g?n+=HU.boldLabel(t.getLabel())+i+HU.br():c.push(i)}g&&(n+=HU.p())}if(g)this.writeHtml(ID_DISPLAY_BOTTOM,n);else{let e="";r||(e=(t?t.getLabel():"Word")+"="+i),this.writeHtml(ID_DISPLAY_BOTTOM,HU.center(e+HU.div([ATTR_ID,this.domId("table"),ATTR_STYLE,HU.css(CSS_HEIGHT,HU.px(300))])));let s=()=>{let e=google.visualization.arrayToDataTable(h);this.chart=new google.visualization.Table(document.getElementById(this.domId("table"))),this.chart.draw(e,{allowHtml:!0})};if(!haveGoogleChartsLoaded((()=>{ramaddaLoadGoogleChart("table",s)})))return;s()}}})}function RamaddaTemplateDisplay(e,t,i){Utils.isDefined(i.showTitle)||(i.showTitle=!1),Utils.isDefined(i.showMenu)||(i.showMenu=!1);const s=new RamaddaFieldsDisplay(e,t,DISPLAY_TEMPLATE,i);let l=[{label:"Template"},{p:"template",ex:"${default}"},{p:"toggleTemplate",ex:"",tt:"Used as the toggle label for hiding/showing the main template"},{p:"headerTemplate",ex:"... ${totalCount} ... ${selectedCount} ${filter_field} ..."},{p:"footerTemplate",ex:"... ${totalCount} ... ${selectedCount} ${filter_.field} ... "},{p:"handler",ex:"someGlobalFunction",tt:'Global function to handle the record. takes (display,fields,record); use record.getValueFromField("some field")'},{p:"templateStyle",ex:"display:inline-block;",tt:"Style for the wrapper div"},{p:"emptyMessage",tt:"Text to show when there are no records to show"},{p:"select",ex:"max|min|<|>|=|<=|>=|contains"},{p:"selectField"},{p:"selectValue"},{p:"onlyShowSelected",ex:"true"},{p:"useNearestDate",tt:"Sample on the selected record time",ex:"true"},{p:"showFirst",ex:"true",tt:"Show first record"},{p:"showLast",ex:"true",tt:"Show last record"},{p:"showRecords",tt:"comma separated list of record indices",ex:"0,3,4"},{p:"dontShowRecords",tt:"comma separated list of record indices to not show",ex:"0,3,4"},{p:"selectHighlight",ex:"true"},{p:"handleSelectOnClick",ex:"false",tt:"Don't select the record on a click"},{p:"groupByField"},{p:"groupDelimiter",ex:HU.br()},{p:"groupTemplate",wikivalue:"<b>${group}</b><ul>${contents}</ul>"},{p:"sortGroups",wikivalue:"true"},{p:"${&lt;field&gt;_total}"},{p:"${&lt;field&gt;_max}"},{p:"${&lt;field&gt;_min}"},{p:"${&lt;field&gt;_average}"},{p:"highlightOnScroll",ex:"true"},{p:"scrollOnHighlight",ex:"true",d:"true",tt:"Scroll to the record when it is highlighted"},{p:"highlightFilterText",ex:"true",tt:"Highlight any filter text"},{p:"colorBackground",d:!1,canCache:!0},{p:"addCopyToClipboard",ex:!0,tt:"Add a link to copy the output to the clipboard"},{p:"copyToClipboardDownloadFile",ex:"somefile.txt",tt:"Instead of copying to the clipboard download the file"}];defineDisplay(addRamaddaDisplay(this),s,l,{dataFilterChanged:function(){this.getOnlyShowSelected()&&this.selectedRecord&&(this.selectedRecord=null,this.selectedRecords=null,this.setContents("")),s.dataFilterChanged.call(this)},displayData:function(e,t){this.updateUI()},updateUI:function(){let e=this.myRecords=this.filterData();if(!e)return;let t=this.getFields();if(t=this.getSelectedFields(),!t)return;if(this.getOnlyShowSelected()){if(this.selectedRecord||this.selectedRecords||this.getShowFirst(!0)&&(this.selectedRecord=e[0]),!this.selectedRecord&&!this.selectedRecords)return void this.setContents(this.getEmptyMessage(HU.br()));e=this.selectedRecords||[this.selectedRecord],e=this.sortRecords(e)}else e=this.sortRecords(e),this.getShowFirst(!1)?e=[e[0]]:this.getShowLast(!1)&&(e=[e[e.length-1]]);let i=this.getShowRecords();if(i){let t=[];i.split(",").forEach((i=>{t.push(e[+i])})),e=t}let s=this.getDontShowRecords();if(s){let t={};s.split(",").forEach((e=>{t[+e]=!0}));let i=[];for(let s=0;s<e.length;s++)t[s]||i.push(e[s]);e=i}let l=this.getFieldsByIds(t,this.getProperty("uniqueFields")),a={},r=this.getTemplate(),o=this.getProperty("handler"),n=this.getToggleTemplate(),h=this.getProperty("select","all"),d=[],g={},p=[],c=this.getHighlightFilterText()?this.getFilterTextMatchers():null;e.forEach((e=>{if(l.length>0){var i="";if(l.map((t=>{i+="__"+t.getValue(e)})),Utils.isDefined(a[i]))return;a[i]=!0}p.push(e);for(var s=0;s<t.length;s++){var r=t[s],o=r.getValue(e);g[r.getId()]||(g[r.getId()]={total:0,min:o,max:o,count:0,uniques:{},uniqueCount:0});var n=g[r.getId()];r.isString()?n.uniques[o]||(n.uniqueCount++,n.uniques[o]=!0):r.isDate&&o&&o.getTime?(o.getTime()<n.min.getTime()&&(n.min=o),o.getTime()>n.max.getTime()&&(n.max=o)):isNaN(o)||(n.total+=o,n.min=Math.min(n.min,o),n.max=Math.max(n.max,o),n.count++)}})),e=p;for(var u=0;u<t.length;u++){var T=t[u];if(T.isNumeric()){var f=g[T.getId()];f&&f.count&&(f.average=f.total/f.count)}}if("max"==h||"min"==h||"="==h||"<"==h||">"==h||"<="==h||"?>="==h||"match"==h){var y=this.getProperty("selectField",null);if(y&&(y=this.getFieldById(null,y)),!y)return void this.setContents("No selectField specified");var m,_,S=this.getProperty("selectValue","0"),A=parseFloat(S),I=0,b=0,R=0;e.map((e=>{var t=y.getValue(e);if("match"!=h)if("="!=h){if(!isNaN(t))if("<"!=h)if(">"!=h)if(">="!=h)if("<="!=h){if(0==R++)return b=t,I=t,_=e,void(m=e);t<b&&(b=t,_=e),t>I&&(I=t,m=e)}else t<=A&&d.push(e);else t>=A&&d.push(e);else t>A&&d.push(e);else t<A&&d.push(e)}else t==S&&d.push(e);else t.match(S)&&d.push(e)})),"min"==h?_&&d.push(_):"max"==h&&m&&d.push(m)}else d=e;let D="";0==d.length&&(D=this.getEmptyMessage("Nothing found"));let L=this.getColorByInfo(d),U={};U.selectedCount=d.length,U.totalCount=e.length;for(u=0;u<t.length;u++){let e=t[u],i=g[e.getId()];i&&(e.isDate?(U[e.getId()+"_min"]=i.min,U[e.getId()+"_max"]=i.max):i&&e.isString()?U[e.getId()+"_uniques"]=i.uniqueCount:e.isNumeric()&&i&&(U[e.getId()+"_total"]=i.total,U[e.getId()+"_min"]=i.min,U[e.getId()+"_max"]=i.max,U[e.getId()+"_average"]=i.average))}let C=this.getProperty("headerTemplate",""),E=this.getProperty("footerTemplate","");if(1==d.length){let e=this.getDataValues(d[0]);C=this.applyRecordTemplate(d[0],e,t,C),E=this.applyRecordTemplate(d[0],e,t,E)}let H=(e,t)=>{C=C.replace(e,t),E=E.replace(e,t)};if(t.forEach((e=>{if(!e.isNumeric())return;let t=0,i=0,s=0,l=0;d.forEach((a=>{let r=e.getValue(a);isNaN(r)||(0==i&&(s=r,l=r),s=Math.min(r,s),l=Math.max(r,l),t+=r,i++)})),H("${"+e.getId()+"_average}}",0==i?"NA":Utils.formatNumberComma(t/i)),H("${"+e.getId()+"_min}",Utils.formatNumberComma(s)),H("${"+e.getId()+"_max}",Utils.formatNumberComma(l)),H("${"+e.getId()+"_total}",Utils.formatNumberComma(t))})),this.filters)for(let e=0;e<this.filters.length;e++){let t=this.filters[e];if(!t.isEnabled())continue;let i=t.getField(),s="filter_"+i.getId();if(i.isNumeric()){let e=jqid(this.domId("filterby_"+i.getId()+"_min")).val()?.trim(),t=jqid(this.domId("filterby_"+i.getId()+"_max")).val()?.trim();U[s+"_min"]=e,U[s+"_max"]=t}else{let e=jqid(this.domId("filterby_"+i.getId()));if(!e.val||null==e.val())continue;let t=e.val();if(!t)continue;if(Array.isArray(t)){let e="";t.forEach((t=>{""!=e&&(e+=", "),e+=t})),t=e}if(t=t.trim(),t==FILTER_ALL){let e=new RegExp("\\${filter_"+i.getId()+"[^}]*\\}","g");H(e,"")}else U[s]=t}}let P=Utils.tokenizeMacros(C),x=Utils.tokenizeMacros(E);C=P.apply(U),E=x.apply(U),d.length>0&&(D+=C);let v=this.getPropertyHandleSelectOnClick(!0);if(Utils.stringDefined(r)){let i=this.getFieldById(null,this.getProperty("groupByField")),s=this.getProperty("groupDelimiter"," "),l=this.getProperty("groupTemplate","<b>${group}</b><ul>${contents}</ul>"),a=[],h={};var O,N=this.getTemplateProps(t),w=(I=parseFloat(this.getProperty("maxNumber",-1)),parseFloat(this.getProperty("templateColumns",-1)));w>0&&(O="col-md-"+Math.round(12/w),D+=HU.open(TAG_DIV,[ATTR_CLASS,"row-tight row"]));var M=0,F=this.getTemplateStyle("");let g=this.getNoWrapper();for(var k=0;k<d.length&&!(-1!=I&&k>=I);k++){w>0&&(M>=w&&(M=0,D+=HU.close(TAG_DIV),D+=HU.open(TAG_DIV,[ATTR_CLASS,"row-tight row"])),D+=HU.open(TAG_DIV,[ATTR_CLASS,O]),M++);var G=d[k],B=null;if(L.index>=0){var Y=G.getData()[L.index];B=L.getColor(Y,G)}let l=r,p=this.getDataValues(G);if(l=o?window[o]?window[o](this,t,G):"Error: could not find handler:"+o:"${default}"==l.trim()||l.startsWith("${fields")?this.getRecordHtml(G,t,l):this.applyRecordTemplate(G,p,t,l,N),c){let e=String(l);t.forEach((t=>{c.forEach((i=>{e=i.highlight(e,t.getId())}))})),l=e}let u=Utils.tokenizeMacros(l),T={};T.selectCount=d.length,T.totalCount=e.length,T[ATTR_RECORD_INDEX]=k+1;this.getTheDataFilters();this.filters.forEach((e=>{e.isEnabled()&&e.getField&&(T["filter."+e.getField().getId()]=e.getFieldValues())}));let f=F;B&&(this.getColorBackground()&&(f=HU.css(CSS_BACKGROUND,B)+f),T.color=B),v||(f+=HU.css(CSS_CURSOR,CURSOR_DEFAULT));let y=HU.openTag(TAG_DIV,[ATTR_CLASS,g?"":"display-template-record",ATTR_STYLE,f,ATTR_ID,this.getId()+"-"+G.getId(),ATTR_TITLE,"",ATTR_RECORD_ID,G.getId(),ATTR_RECORD_INDEX,k]);if(l=u.apply(T),l.startsWith("<td")?(l=l.replace(/<td([^>]*)>/,"<td $1>"+y),l=l.replace(/<\/td>$/,"</div></td>")):l.startsWith("<tr")?(l=l.replace(/<td([^>]*)>/g,"<td $1>"+y),l=l.replace(/<\/td>/g,"</div></td>")):l=y+l+HU.close(TAG_DIV),n){let e=this.applyRecordTemplate(G,p,t,n,N);l=HU.toggleBlock(e,l,!1)}if(i){let e=i.getValue(G);e.getTime&&(e=this.formatDate(e)),h[e]?h[e]+=s:(a.push(e),h[e]=""),h[e]+=l}else D+=l;w>0&&(D+=HU.close(TAG_DIV))}i&&(this.getPropertySortGroups(!1)&&(a=a.sort()),a.forEach((e=>{D+=l.replace("${group}",e).replace("${contents}",h[e])}))),w>0&&(D+=HU.close(TAG_DIV))}d.length>0&&(D+=E),this.setContents(D,!0),HU.createFancyBox(this.jq(ID_DISPLAY_CONTENTS).find("a.popup_image"),{caption:function(e,t){let i=$(this).attr(ATTR_DATA_CAPTION);return Utils.stringDefined(i)||(i=$(this).attr(ATTR_TITLE)||""),i}}),this.addFieldClickHandler(null,null,!1);let V=this.find(".display-template-record");this.makeTooltips(V,d),this.makePopups(V,d);let q=this;if(this.getProperty("addCopyToClipboard")&&(this.jq(ID_DISPLAY_CONTENTS).find(".display-template-record").css(CSS_CURSOR,CURSOR_POINTER),Utils.initCopyable(this.jq(ID_DISPLAY_CONTENTS),{addLink:!0,removeTags:!0,removeNL:!0,downloadFileName:this.getProperty("copyToClipboardDownloadFile")})),v&&this.find(".display-template-record").click((function(){var e=d[$(this).attr(ATTR_RECORD_INDEX)];q.handleEventRecordHighlight(this,{record:e,highlight:!0,immediate:!0,skipScroll:!0}),q.propagateEventRecordSelection({highlight:!0,record:e})})),this.getPropertyHighlightOnScroll(!1)){let e=this.find(".display-template-record");this.getContents().css(CSS_OVERFLOW_Y,"scroll"),this.getContents().scroll((()=>{let t=null;if(e.each((function(){$(this).position().top<0&&(t=$(this))})),t){var i=d[t.attr(ATTR_RECORD_INDEX)];i&&this.currentTopRecord&&i!=this.currentTopRecord&&this.propagateEventRecordSelection({highlight:!0,record:i}),this.currentTopRecord=i}}))}},highlightCount:0,handleEventRecordSelection:function(e,t){this.selectedRecords=t.records,this.selectedRecord=t.record,this.selectedRecord&&this.getUseNearestDate()&&this.myRecords&&(this.selectedRecord=this.findClosestDate(this.selectedRecord.getDate()).record),this.getOnlyShowSelected()?this.updateUI():(t.highlight=!0,this.handleEventRecordHighlight(e,t))},handleEventRecordHighlight:function(e,t){if(this.getPropertySelectHighlight())return this.selectedRecord=t.record,void this.callUpdateUI();this.currentTopRecord=null;let i=++this.highlightCount;var s="#"+this.getId()+"-"+t.record.getId();if(this.highlightedElement&&(this.unhighlightElement(this.highlightedElement),this.highlightedElement=null),t.highlight)t.immediate?this.highlightElement(t):setTimeout((()=>{i==this.highlightCount&&this.highlightElement(t)}),100);else{s="#"+this.getId()+"-"+t.record.getId();var l=$(s);this.unhighlightElement(l)}},unhighlightElement:function(e){this.currentTopRecord=null,e.removeClass("display-template-record-highlight");var t=this.getProperty("highlightOffCss","").split(";");t.length>0&&t.map((t=>{var i=t.split(":"),s=i[0],l=i.length>1?i[1]:null;l&&""!=l||(l=e.attr("prev-"+s)),l&&e.css(s,l)}))},highlightElement:function(e){let t="#"+this.getId()+"-"+e.record.getId(),i=$(t);this.highlightedElement=i,i.addClass("display-template-record-highlight");let s=this.getProperty("highlightOnCss","").split(";");s.length>0&&s.map((e=>{let t=e.split(":"),s=t[0],l=t.length>1?t[1]:null;if(l&&""!=l||(l=i.attr("prev-"+s)),l){let e=i.css(s);e&&i.attr("prev-"+s,e),i.css(s,l)}}));try{if(this.getScrollOnHighlight()&&!e.skipScroll){let e=i.offset();if(null==e)return;let t=i.parent();if("vertical"==this.getProperty("orientation","vertical")){let i=t.offset().top,s=t.scrollTop();t.scrollTop(e.top-i+s)}else{let i=t.offset().left,s=t.scrollLeft();t.scrollLeft(e.left-i+s)}}}catch(e){console.log("Error:"+e)}}})}function RamaddaTopfieldsDisplay(e,t,i){const s=new RamaddaFieldsDisplay(e,t,DISPLAY_TOPFIELDS,i);defineDisplay(addRamaddaDisplay(this),s,[{label:"Top Fields"},{p:"fieldCount",tt:""},{p:"labelField",tt:""},{p:"dateFormat",ex:"yyyy"},{p:"labelField"},{p:"scaleFont",ex:"false"}],{needsData:function(){return!0},updateUI:function(){if(null==this.getData())return;let e=this.filterData();if(!e)return;var t=this.getData().getNonGeoFields(),i=this.getFieldById(t,this.getProperty("labelField"));null==i&&(i=this.getFieldById(t,"title")),null==i&&(i=this.getFieldById(t,"name"));var s=this.getFieldsByIds(t,this.getPropertyFields());0==s.length&&(s=t);for(var l="",a=+this.getProperty("fieldCount",10),r=[],o=Number.MAX_VALUE,n=Number.MIN_VALUE,h=this.getProperty("dateFormat"),d=0;d<e.length;d++){for(var g=(y=e[d]).getData(),p=[],c=0;c<s.length;c++){if((I=s[c]).isNumeric()){var u=g[I.getIndex()];isNaN(u)||(o=Math.min(o,u),n=Math.max(n,u)),p.push({value:u,field:I})}}p.sort(((e,t)=>t.value-e.value));var T=i?g[i.getIndex()]:" Record:"+(d+1);(i&&i.isFieldDate()||"date"==typeof T)&&(T=Utils.formatDateWithFormat(T,h)),r.push({data:p,record:y,header:T})}var f=this.getProperty("scaleFont",!0);for(d=0;d<r.length;d++){p=r[d].data;var y=r[d].record,m=(T=r[d].header,g=y.getData(),""),_="";for(c=0;c<p.length&&c<a;c++){u=p[c].value;var S=n==o?1:(u-o)/(n-o),A=HU.pt(6+Math.round(24*S));f||(A=HU.perc(100));var I=p[c].field;_+=HU.div([ATTR_FIELD_ID,I.getId(),ATTR_DATA_VALUE,I.getLabel(),ATTR_TITLE,Utils.msgLabel("Value")+u,ATTR_CLASS,"display-topfields-row",ATTR_STYLE,HU.css(CSS_FONT_SIZE,A)],I.getLabel())}m+=HU.div([ATTR_CLASS,"display-topfields-header",ATTR_RECORD_INDEX,d],T),m+=HU.div([ATTR_CLASS,"display-topfields-values"],_),l+=HU.div([ATTR_CLASS,"display-topfields-record"],m)}this.setContents(l);let b=this;this.find(".display-topfields-header").click((function(){var t=$(this).attr(ATTR_RECORD_INDEX);b.find(".display-topfields-record").removeClass("display-topfields-selected"),$(this).parent().addClass("display-topfields-selected");var i=e[t];i&&b.propagateEventRecordSelection({record:i})}));let R=this.find(".display-topfields-row");R.hover((function(){R.removeClass("display-topfields-highlight");var e=$(this).attr(ATTR_DATA_VALUE);b.find(HU.attrSelect(ATTR_DATA_VALUE,e)).addClass("display-topfields-highlight")})),R.click((function(){var e=$(this).attr(ATTR_FIELD_ID);b.getDisplayManager().notifyEvent(DisplayEvent.fieldsSelected,b,[e])}))},handleEventRecordSelection:function(e,t){if(t.record){var i=this.recordToIndex[t.record.getId()];if(Utils.isDefined(i)){var s=this.getContents();s.find(".display-topfields-record").removeClass("display-topfields-selected");var l=s.find(HU.attrSelect(ATTR_RECORD_INDEX,i)).parent();l.addClass("display-topfields-selected");var a=s.offset().top,r=s.scrollTop(),o=l.offset().top-a+r;s.scrollTop(o)}}}})}function RamaddaBlocksDisplay(e,t,i){const s=new RamaddaFieldsDisplay(e,t,DISPLAY_BLOCKS,i),l="blocks_header",a="blocks",r="blocks_footer";let o=[{label:"Block"},{p:"animStep",d:0,ex:"1000",tt:"Animation delay (ms)"},{p:"doSum",d:!0,ex:"false",tt:""},{p:"numBlocks",d:1e3,ex:"1000",tt:"How many blocks to show"},{p:"header",d:!0,ex:"Each block represents ${blockValue} ... There were a total of ${total} ...",tt:""},{p:"blockIcon",d:null,ex:"fa-male",tt:"Use an icon"},{p:"emptyBlockStyle",d:HU.css(CSS_BACKGROUND,COLOR_TRANSPARENT,CSS_BORDER,HU.border(1,COLOR_LIGHT_GRAY)),tt:"Style for blocks not displayed yet"}];defineDisplay(addRamaddaDisplay(this),s,o,{getContentsStyle:function(){return""},updateUI:function(){let e,t=this.getPropertyFields();if(!t||(e=this.filterData(),e)){if(this.counts=[],this.counts2=[],t){let i=this.getFieldsByIds(null,t);if(!i)return;this.footers=[],this.headers=[];let s=this.getNumBlocks(1e3);this.total=0,i.forEach((t=>{this.footers.push("${count} "+t.getLabel());let i=t.getValue(e[0]);isNaN(i)||(this.total+=i),this.counts.push(i)})),this.total>0&&(this.blockValue=this.total/s,this.counts.forEach((e=>{let t=(isNaN(e)?0:e/this.total)*s;this.counts2.push(t)})))}else{this.blockValue=0;let e=this.getProperty("counts","100",!0).split(";");for(let t=0;t<e.length;t++)this.counts.push(parseFloat(e[t]));if(this.getPropertyDoSum())this.counts2=this.counts;else{this.total=0;for(let e=0;e<this.counts.length;e++){let t=this.counts[e];this.counts2.push(this.counts[e]-this.total),this.total+=t}}this.footers=this.getProperty("footers","",!0).split(";"),this.headers=this.getProperty("headers","",!0).split(";")}for(;this.footers.length<this.counts.length;)this.footers.push("");for(;this.headers.length<this.counts.length;)this.headers.push("");this.setContents(HU.div([ATTR_CLASS,"display-blocks-header",ATTR_STYLE,this.getProperty("headerStyle","",!0),ATTR_ID,this.domId(l)])+HU.div([ATTR_CLASS,"display-blocks-blocks",ATTR_ID,this.domId(a)],"")+HU.div([ATTR_CLASS,"display-blocks-footer",ATTR_STYLE,this.getProperty("footerStyle","",!0),ATTR_ID,this.domId(r)])),this.showBlocks(!0),this.getProperty("displayOnScroll")?HU.callWhenScrolled(this.domId(ID_DISPLAY_CONTENTS),(()=>{this.displayedBlocks||(this.displayedBlocks=!0,this.timeout&&clearTimeout(this.timeout),this.tmeout=setTimeout((()=>{this.showBlocks(!1)}),this.getPropertyAnimStep()))}),500):this.showBlocks(!1)}},showBlocks:function(e,t){Utils.isDefined(t)||(t=e?this.counts.length:0);let i="";i+=HU.openDiv([ATTR_CLASS,"display-blocks"]);let s=this.getProperty("colors","#d73027,#fdae61,#74add1,#423E3B,red,green,blue",!0),o="string"==typeof s?s.split(","):s,n="";for(;o.length<this.counts.length;)o.push(o[o.length-1]);let h=parseFloat(this.getProperty("divider","1",!0)),d=this.getProperty("blockDimensions","8",!0),g=this.getProperty("labelStyle","",!0),p=this.getProperty("blockIcon"),c=p?"display-block-icon":"display-block",u=this.getEmptyBlockStyle();for(let s=0;s<this.counts2.length;s++){let l=this.counts[s];isNaN(l)&&(l=0);let a=this.footers[s].replace("${count}",Utils.formatNumberComma(l)),r=p?"":HU.css(CSS_WIDTH,HU.px(d),CSS_HEIGHT,HU.px(d)),T="";if(e)r+=u;else if(s<t){p?T+=HU.css(CSS_COLOR,o[s]):r+=HU.css(CSS_BACKGROUND,o[s]);let e=p?HU.getIconImage(p,null,[ATTR_STYLE,T]):"";n+=HU.div([ATTR_CLASS,c,ATTR_STYLE,r],e)+" "+HU.span([ATTR_STYLE,g],a)+SPACE2}else r+=p?HU.css(CSS_BACKGROUND,COLOR_TRANSPARENT):HU.css(CSS_BACKGROUND,COLOR_TRANSPARENT,CSS_BORDER,HU.border(1,COLOR_LIGHT_GRAY)),n+=SPACE2;let f=p?HU.getIconImage(p,null,[ATTR_STYLE,T]):"",y=this.counts2[s]/h;for(let e=0;e<1e4&&e<y;e++)i+=HU.div([ATTR_CLASS,c,ATTR_STYLE,r,ATTR_TITLE,a],f);0}i+=HU.closeDiv();let T=this.getProperty("header","");T=T.replace("${divider}",h).replace("${total}",Utils.formatNumberComma(this.total)).replace("${blockValue}",Utils.formatNumberComma(Math.round(this.blockValue))),this.jq(l).html(T),this.jq(a).html(i),this.jq(r).html(n),t<this.counts.length&&(this.getPropertyAnimStep()?(this.timeout&&clearTimeout(this.timeout),this.timeout=setTimeout((()=>{this.showBlocks(!1,t+1)}),this.getPropertyAnimStep())):this.showBlocks(!1,t+1))}})}function RamaddaTextstatsDisplay(e,t,i){const s=new RamaddaBaseTextDisplay(e,t,DISPLAY_TEXTSTATS,i);defineDisplay(addRamaddaDisplay(this),s,[],{updateUI:function(){let e={},t=this.processText(e);if(null==t)return;let i=this.filterData(),s=this.getData().getRecordFields(),l=this.getSelectedFields(s);0==l.length&&(l=s);this.getFieldsByType(l,"string");let r="",o=[],n=parseInt(this.getProperty("maxWords",-1)),h=parseInt(this.getProperty("minCount",0)),d=this.getProperty("showBars",!0),g=(this.getProperty("barsScale",10),this.getProperty("barColor","blue")),p=parseInt(this.getProperty("barWidth","400"));for(a in t){let s=t[a];s.field;for(word in s.counts){let e=s.counts[word];o.push({word:word,count:e})}if(o.sort((function(e,t){return e.count<t.count?-1:e.count>t.count?1:0})),h>0){let e=[];for(let t=0;t<o.length;t++)o[t].count>=h&&e.push(o[t]);o=e}if(n>0){let e=[];for(let t=0;t<=n&&t<o.length;t++)o[t].count>=h&&e.push(o[t]);o=e}let l=0,c=0;o.length>0&&(c=o[0].count,l=o[o.length-1].count);let u=[];for(a in e.lengths)u.push({length:parseInt(a),count:e.lengths[a]});u.sort((function(e,t){return e.length<t.length?-1:e.length>t.length?1:0})),l=0,c=0;for(let e=0;e<u.length;e++)c=0==e?u[e].count:Math.max(c,u[e].count),l=0==e?u[e].count:Math.min(l,u[e].count);this.getProperty("showFieldLabel",!0)&&(r+=HU.b(s.field.getLabel())+HU.br());let T=HU.perc(20),f=HU.perc(10);if(this.getProperty("showSummary",!0)&&(r+=HU.openTag(TAG_TABLE,[ATTR_CLASS,HU.classes(CLASS_TABLE_NOWRAP,CLASS_TABLE),ATTR_ID,this.domId("table_summary")]),r+=HU.openTag(TAG_THEAD,[]),r+=HU.tr([],HU.th([ATTR_WIDTH,T],"Summary")+HU.th([],SPACE)),r+=HU.closeTag(TAG_THEAD),r+=HU.openTag(TAG_TBODY,[]),r+=HU.tr([],HU.td([ATTR_ALIGN,ALIGN_RIGHT],"Total lines:")+HU.td([],i.length)),r+=HU.tr([],HU.td([ATTR_ALIGN,ALIGN_RIGHT],"Total words:")+HU.td([],e.count)),r+=HU.tr([],HU.td([ATTR_ALIGN,ALIGN_RIGHT],"Average word length:")+HU.td([],Math.round(e.total/e.count))),r+=HU.closeTag(TAG_TBODY),r+=HU.closeTag(TAG_TABLE),r+=HU.br()),this.getProperty("showCounts",!0)){r+=HU.openTag(TAG_TABLE,[ATTR_CLASS,HU.classes(CLASS_TABLE_ROWBORDER,CLASS_TABLE_NOWRAP,CLASS_TABLE),ATTR_ID,this.domId("table_counts")]),r+=HU.openTag(TAG_THEAD,[]),r+=HU.tr([],HU.th([ATTR_WIDTH,T],"Word Length")+HU.th([ATTR_WIDTH,f],"Count")+(d?HU.th([],""):"")),r+=HU.closeTag(TAG_THEAD),r+=HU.openTag(TAG_TBODY,[]);for(let e=0;e<u.length;e++){let t=HU.td([],u[e].length)+HU.td([],u[e].count);if(d){let i=2+(u[e].count-l)/c*p,s=g,a=HU.div([ATTR_STYLE,HU.css(CSS_HEIGHT,HU.px(10),CSS_WIDTH,HU.px(i),CSS_BACKGROUND,s)]);t+=HU.td([],a)}r+=HU.tr([],t)}r+=HU.closeTag(TAG_TBODY),r+=HU.closeTag(TAG_TABLE),r+=HU.br()}if(this.getProperty("showFrequency",!0)){r+=HU.openTag(TAG_TABLE,[ATTR_CLASS,HU.classes(CLASS_TABLE_ROWBORDER,CLASS_TABLE),ATTR_ID,this.domId("table_frequency")]),r+=HU.openTag(TAG_THEAD,[]),r+=HU.tr([],HU.th([ATTR_WIDTH,T],"Word")+HU.th([ATTR_WIDTH,f],"Frequency")+(d?HU.th([],""):"")),r+=HU.closeTag(TAG_THEAD),r+=HU.openTag(TAG_TBODY,[]);let e=0,t=0;o.length>0&&(e=o[0].count,t=o[o.length-1].count);let i=0;for(let e=0;e<o.length;e++)i+=o[e].count;for(let s=o.length-1;s>=0;s--){let l=Math.round(o[s].count/i*1e4)/100,a=HU.td([],o[s].word+SPACE2)+HU.td([],o[s].count+SPACE2+"("+HU.perc(l)+")"+SPACE2);if(d){let i=2+(o[s].count-e)/t*p,l=g,r=HU.div([ATTR_STYLE,HU.css(CSS_HEIGHT,HU.px(10),CSS_WIDTH,HU.px(i),CSS_BACKGROUND,l)],"");a+=HU.td([],r)}r+=HU.tr([],a)}r+=HU.closeTag(TAG_TBODY),r+=HU.closeTag(TAG_TABLE)}}this.setContents(r);let c=this.getProperty("tableHeight",200);this.getProperty("showSummary",!0)&&HU.formatTable("#"+this.domId("table_summary"),{scrollY:this.getProperty("tableSummaryHeight",c)}),this.getProperty("showCounts",!0)&&HU.formatTable("#"+this.domId("table_counts"),{scrollY:this.getProperty("tableCountsHeight",c)}),this.getProperty("showFrequency",!0)&&HU.formatTable("#"+this.domId("table_frequency"),{scrollY:this.getProperty("tableFrequenecyHeight",c),searching:this.getProperty("showSearch",!0)},(e=>{this.frequencyTable=e,this.frequencyTable.on("search.dt",(()=>{this.settingSearch||this.propagateEvent(DisplayEvent.propertyChanged,{property:"searchValue",value:this.frequencyTable.search()})}))}))},handleEventPropertyChanged:function(e,t){if("searchValue"==t.property)return this.settingSearch=!0,this.setProperty("searchValue",t.value),this.frequencyTable.search(t.value),this.frequencyTable.draw(),void(this.settingSearch=!1);s.handleEventPropertyChanged.call(this,e,t)}})}function RamaddaFrequencyDisplay(e,t,i){const s=new RamaddaBaseTextDisplay(e,t,DISPLAY_FREQUENCY,i);defineDisplay(addRamaddaDisplay(this),s,[{label:"Frequency"},{p:"orientation",ex:"vertical"},{p:"tableHeight",ex:"300px"},{p:"showPercent",ex:"false"},{p:"showCount",ex:"false"},{p:"showBars",ex:"true"},{p:"showBars",ex:"false"},{p:"showHeader",ex:"false"},{p:"banner",ex:"true"},{p:"barWidth",ex:"200"},{p:"clickFunction",ex:"selectother"}],{updateUI:function(){let e=this.filterData();if(!e)return;let t=this.getData().getRecordFields(),i=this.getSelectedFields(t);0==i.length&&(i=t);let s={};for(let e=0;e<i.length;e++){let t=i[e];Utils.isDefined(s[t.getId()])||(s[t.getId()]={counts:{},values:[],min:null,max:null,total:0,numbers:[],field:t})}let l=this.getProperty("showCount",!0),a=this.getProperty("showPercent",!0),r=this.getProperty("showBars",!1),o=+this.getProperty("barWidth",200);for(let t=0;t<e.length;t++){let l=this.getDataValues(e[t]);for(let e=0;e<i.length;e++){let t=i[e],a=s[t.getId()],r=l[t.getIndex()];if(Utils.isDefined(a.min)||(a.min=r,a.max=r),t.isNumeric())a.numbers.push(r),isNaN(a.max)?a.max=r:isNaN(r)||(a.max=Math.max(r,a.max)),isNaN(a.min)?a.min=r:isNaN(r)||(a.min=Math.min(r,a.min));else{if(!Utils.isDefined(a.counts[r])){let e={value:r,count:0};a.counts[r]=e,a.values.push(e)}a.total++,a.counts[r].count++}}}let n="",h="";for(let e=0;e<i.length;e++){h+=HU.open(TAG_DIV,[ATTR_STYLE,HU.css(CSS_TEXT_ALIGN,ALIGN_CENTER)]);let t=i[e],d=s[t.getId()];if(t.isNumeric()){let e=parseFloat(this.getProperty("numBins",10,!0));d.bins=[];let i=d.max-d.min,s=(d.max-d.min)/e,l="Not defined";d.bins.push(l);let a={value:l,count:0};d.counts[l]=a,d.values.push(a);let r,o=this.getProperty(t.getId()+".bins");if(Utils.stringDefined(o)){let e=o.split(",");r=[],e.map((e=>r.push(+e)));for(let t=0;t<e.length-1;t++){let i=+e[t]+" - "+ +e[t+1];d.bins.push(i);let s={value:i,count:0};d.counts[i]=s,d.values.push(s)}}else for(let t=0;t<e;t++){let e=Utils.formatNumber(d.min+s*t)+" - "+Utils.formatNumber(d.min+s*(t+1));d.bins.push(e);let i={value:e,count:0};d.counts[e]=i,d.values.push(i)}for(let t=0;t<d.numbers.length;t++){let l=d.numbers[t],a=0;if(!isNaN(l))if(r){for(let e=0;e<r.length-1;e++)if(l>=r[e]&&l<r[e+1]){a=e;break}}else if(0!=s){let t=(l-d.min)/i;a=Math.round(t/(1/e))+1,a>e&&(a=e)}let o=d.bins[a];if(!Utils.isDefined(d.counts[o])){let e={value:d.bins[a],count:0};d.counts[o]=e,d.values.push(e)}d.total++,d.counts[o].count++}}let g="vertical"!=this.getProperty("orientation","");if(null!=this.getProperty("floatTable")&&(g=1==this.getProperty("floatTable")),n+=HU.openTag(TAG_DIV,[ATTR_CLASS,"display-frequency-table",ATTR_STYLE,g?"":"display:block;"]),n+=HU.openTag(TAG_TABLE,[ATTR_CELLPADDING,3,ATTR_ID,this.domId("summary"+e),ATTR_TABLE_HEIGHT,this.getProperty("tableHeight","300",!0),ATTR_CLASS,HU.classes(CLASS_TABLE_ROWBORDER,CLASS_TABLE_NOWRAP,CLASS_TABLE,CLASS_TABLE_STRIPE)]),this.getProperty("showHeader",!0)){n+=HU.openTag(TAG_THEAD,[]);let e=HU.span([ATTR_TITLE,"Click to reset",ATTR_CLASS,"display-frequency-label",ATTR_DATA_FIELD,d.field.getId()],t.getLabel());e=HU.div([ATTR_STYLE,HU.css(CSS_MAX_WIDTH,HU.px(500),CSS_OVERFLOW_X,OVERFLOW_AUTO)],e);let i=l?HU.th([ATTR_ALIGN,ALIGN_RIGHT,ATTR_WIDTH,HU.perc(20)],HU.div([ATTR_STYLE,HU.css(CSS_TEXT_ALIGN,ALIGN_RIGHT)],"Count")):"",s=a?HU.th([ATTR_ALIGN,ALIGN_RIGHT,ATTR_WIDTH,HU.perc(20)],HU.div([ATTR_STYLE,HU.css(CSS_TEXT_ALIGN,ALIGN_RIGHT)],"Percent")):"",h=r?HU.th([ATTR_ALIGN,ALIGN_RIGHT,ATTR_WIDTH,o],HU.div([ATTR_STYLE,HU.css(CSS_TEXT_ALIGN,ALIGN_RIGHT)],SPACE)):"";n+=HU.tr([],HU.th([],e+i+s+h)),n+=HU.closeTag(TAG_THEAD)}n+=HU.openTag(TAG_TBODY,[]);let p=this.getColorTable(!0),c=this.getProperty("barColor","blue");if(p)for(let e=0;e<d.values.length;e++){d.values[e].value;e<p.length?d.values[e].color=p[e]:d.values[e].color=p[p.length-1]}t.isNumeric()||d.values.sort(((e,t)=>e.count<t.count?1:e.count>t.count?-1:0));let u=0;for(let e=0;e<d.values.length;e++){let t=d.values[e].count;if(0==t)continue;let i=t/d.total;u=Math.max(u,i)}for(let e=0;e<d.values.length;e++){let t=d.values[e].value,i=t;""==i&&(i="&lt;blank&gt;");let s=d.values[e].count;if(0==s)continue;let g=s/d.total;t=t.replace(/\'/g,"&apos;");let p=s,T=d.values[e].color;T||(T=c),a&&(p+=" ("+HU.perc(Math.round(100*g))+")"),h+=HU.div([ATTR_TITLE,"Click to select",ATTR_CLASS," display-frequency-item",ATTR_DATA_FIELD,d.field.getId(),ATTR_DATA_VALUE,t],t+HU.br()+p);let f=HU.td([],t),y=l?HU.td([ATTR_ALIGN,ALIGN_RIGHT],s):"",m=a?HU.td([ATTR_ALIGN,ALIGN_RIGHT],0==d.total?"0":HU.perc(Math.round(100*g))):"",_=g/u,S=r?HU.td([ATTR_VALIGN,ALIGN_CENTER,ATTR_WIDTH,o],HU.div([ATTR_TITLE,HU.perc(Math.round(100*g)),ATTR_STYLE,HU.css(CSS_BACKGROUND,T,CSS_HEIGHT,HU.px(10),CSS_WIDTH,HU.px(Math.round(_*o)))],"")):"";n+=HU.tr([],f+y+m+S)}n+=HU.close(TAG_TBODY,TAG_TABLE,TAG_DIV),h+=HU.close(TAG_TD)}this.getBanner(!1)&&(n=HU.div([ATTR_CLASS,"display-frequency-banner"],h)),this.setContents(n);let d=this,g=this.find(".display-frequency-item");if(g.click((function(){let e=d.getProperty("clickFunction"),t=$(this).attr(ATTR_DATA_VALUE),i=$(this).attr(ATTR_DATA_FIELD),s=($(this).parent(),$(this).hasClass("display-frequency-item-selected"));g.removeClass("display-frequency-item-selected"),s?t=FILTER_ALL:$(this).addClass("display-frequency-item-selected"),e&&"select"!=e?"selectother"==e&&d.propagateEvent(DisplayEvent.fitlerChanged,{value:t,id:d.getFilterId(i),fieldId:i}):d.handleEventPropertyChanged(d,{property:"pattern",fieldId:i,value:t})})),this.find(".display-frequency-label").click((function(){let e=$(this).attr(ATTR_DATA_FIELD);d.handleEventFilterChanged(d,{id:ATTR_ID,fieldId:e,value:"-all-"})})),this.getProperty("showHeader",!0))for(let e=0;e<i.length;e++)HU.formatTable("#"+this.domId("summary"+e),{})}})}function RamaddaTextanalysisDisplay(e,t,i){const s=new RamaddaBaseTextDisplay(e,t,DISPLAY_TEXTANALYSIS,i);defineDisplay(addRamaddaDisplay(this),s,[],{checkLayout:function(){this.updateUIInner()},updateUI:function(){var e=HU.tag(TAG_SCRIPT,[ATTR_SRC,RamaddaUtil.getCdnUrl("/lib/compromise.min.js")]);this.writeHtml(ID_DISPLAY_TOP,e);let t=this;var i=function(){window.nlp?t.updateUIInner():setTimeout(i,100)};setTimeout(i,100)},updateUIInner:function(){if(!this.filterData())return null;let e=this;this.setDisplayMessage("Processing text...");setTimeout((function(){e.updateUIInnerInner()}),10)},updateUIInnerInner:function(){let e=this.filterData();var t=this.getData().getRecordFields(),i=this.getSelectedFields(t);0==i.length&&(i=t);var s=this.getFieldsByIds(i,"fields");if(0==s.length&&(s=this.getFieldsByType(i,"string")),0==s.length)return this.displayError("No string fields specified"),null;if(!this.lastRecords||this.lastRecords.length!=e.length){this.lastRecords=e;for(var l="",a=0;a<e.length;a++){for(var r=this.getDataValues(e[a]),o="",n=0;n<s.length;n++){o+=" ",o+=r[i[n].getIndex()]}l+=o,l+="\n"}this.nlp=window.nlp(l)}var h=this.nlp,d=[];if(this.getProperty("showPeople",!1)&&d.push(this.printList("People",h.people().out("topk"))),this.getProperty("showPlaces",!1)&&d.push(this.printList("Places",h.places().out("topk"))),this.getProperty("showOrganizations",!1)&&d.push(this.printList("Organizations",h.organizations().out("topk"))),this.getProperty("showTopics",!1)&&d.push(this.printList("Topics",h.topics().out("topk"))),this.getProperty("showNouns",!1)&&d.push(this.printList("Nouns",h.nouns().out("topk"))),this.getProperty("showVerbs",!1)&&d.push(this.printList("Verbs",h.verbs().out("topk"))),this.getProperty("showAdverbs",!1)&&d.push(this.printList("Adverbs",h.adverbs().out("topk"))),this.getProperty("showAdjectives",!1)&&d.push(this.printList("Adjectives",h.adjectives().out("topk"))),this.getProperty("showClauses",!1)&&d.push(this.printList("Clauses",h.clauses().out("topk"))),this.getProperty("showContractions",!1)&&d.push(this.printList("Contractions",h.contractions().out("topk"))),this.getProperty("showPhoneNumbers",!1)&&d.push(this.printList("Phone Numbers",h.phoneNumbers().out("topk"))),this.getProperty("showValues",!1)&&d.push(this.printList("Values",h.values().out("topk"))),this.getProperty("showAcronyms",!1)&&d.push(this.printList("Acronyms",h.acronyms().out("topk"))),this.getProperty("showNGrams",!1)&&d.push(this.printList("NGrams",h.ngrams().out("topk"))),this.getProperty("showDates",!1)&&d.push(this.printList("Dates",h.dates().out("topk"))),this.getProperty("showQuotations",!1)&&d.push(this.printList("Quotations",h.quotations().out("topk"))),this.getProperty("showUrls",!1)&&d.push(this.printList("URLs",h.urls().out("topk"))),this.getProperty("showStatements",!1)&&d.push(this.printList("Statements",h.statements().out("topk"))),this.getProperty("showTerms",!1)&&d.push(this.printList("Terms",h.terms().out("topk"))),this.getProperty("showPossessives",!1)&&d.push(this.printList("Possessives",h.possessives().out("topk"))),0!=d.length){this.getProperty("height","400");for(var g=HU.openTag(TAG_DIV,[ATTR_ID,this.domId("tables")]),p=0;p<d.length;p+=3){var c=d[p],u=p+1<d.length?d[p+1]:null,T=p+2<d.length?d[p+2]:null,f=u?T?"33%":"50%":"100%",y=HU.css(CSS_PADDING,HU.px(5));r="";r+=HU.td([ATTR_WIDTH,f],HU.div([ATTR_STYLE,y],c)),u&&(r+=HU.td([ATTR_WIDTH,f],HU.div([ATTR_STYLE,y],u))),T&&(r+=HU.td([ATTR_WIDTH,f],HU.div([ATTR_STYLE,y],T))),g+=HU.tag(TAG_TABLE,[ATTR_WIDTH,HU.perc(100)],HU.tr(r))}g+=HU.closeTag(TAG_DIV),this.setContents(g),HU.formatTable("#"+this.domId("tables")+" "+HU.dotClass(CLASS_TABLE),{scrollY:this.getProperty("tableHeight","200")})}else this.setDisplayMessage("No text types specified")},printList:function(e,t){var i=parseInt(this.getProperty("maxWords",10)),s=parseInt(this.getProperty("minCount",0)),l=HU.openTag(TAG_TABLE,[ATTR_WIDTH,HU.perc(100),ATTR_CLASS,HU.classes(CLASS_TABLE_ROWBORDER,CLASS_TABLE_HOVER,CLASS_TABLE)])+HU.openTag(TAG_THEAD,[]);l+=HU.tr([],HU.th([],e)+HU.th([],SPACE)),l+=HU.close(TAG_THEAD),l+=HU.open(TAG_TBODY);for(var a=0,r=0;r<t.length;r++)if(!(t[r].count<s)){var o=HU.td([],t[r].normal)+HU.td([],t[r].count+" ("+HU.perc(t[r].percent)+")");if(l+=HU.tr([],o),a++>i)break}return l+=HU.close(TAG_TBODY,TAG_TABLE)}})}function RamaddaTextrawDisplay(e,t,i){const s="text",l="label",a="search",r="shrink",o=new RamaddaBaseTextDisplay(e,t,DISPLAY_TEXTRAW,i);defineDisplay(addRamaddaDisplay(this),o,[{label:"Raw Text"},{p:"doBubble",ex:"true"},{p:"addLineNumbers",ex:"false"},{p:"labelTemplate",ex:"${lineNumber}"},{p:"maxLines",ex:"1000"},{p:"pattern",ex:"initial search pattern"},{p:"fromField",ex:""},{p:"linesDescriptor",ex:""},{p:"asHtml",ex:"false"},{p:"breakLines",ex:"true"},{p:"includeEmptyLines",ex:"false"}],{doShrink:i.initialShrink,checkLayout:function(){this.updateUI()},updateUI:function(){if(!this.filterData())return null;let e=this.getData();this.allRecords=e.getRecords();let t=this.getProperty("pattern");t&&0==t.length&&(t=null),t&&(t=t.replace(/"/g,"&quot;"));let i="";this.filters&&0!=this.filters.length||(i+=" "+HU.input("pattern",t||"",[ATTR_PLACEHOLDER,"Search text",ATTR_ID,this.domId(a)])),this.showShrink=this.getProperty("showShrink",!1),this.showShrink&&(i+=" "+HU.checkbox("shrink",[ATTR_ID,this.domId(r)],this.getProperty("initialShrink",!0),"Shrink")),this.writeHtml(ID_TOP_RIGHT,HU.span([ATTR_ID,this.domId(l)]," ")+i);let o=this;this.jq(r).click((function(){o.doShrink=HU.isChecked(o.jq(r)),o.setProperty("initialShrink",o.doShrink),o.updateUI()})),this.jq(a).keypress((function(e){13==e.which&&(o.setProperty("pattern",$(this).val()),o.propagateEvent(DisplayEvent.propertyChanged,{property:"pattern",value:$(this).val()}),o.updateUI())}));var n=this.getProperty("height","600"),h=this.getProperty("displayInnerStyle",""),d=HU.div([ATTR_ID,this.domId(s),ATTR_STYLE,HU.css(CSS_PADDING,HU.px(4),CSS_BORDER,HU.border(1,COLOR_LIGHT_GRAY),CSS_MAX_HEIGHT,HU.px(n),CSS_OVERFLOW_Y,OVERFLOW_AUTO)+h]);this.setContents(d);new Date;this.showText();new Date},handleEventPropertyChanged:function(e,t){if("pattern"==t.property)return this.setProperty("pattern",t.value),void this.updateUI();o.handleEventPropertyChanged.call(this,e,t)},showText:function(){let e=this,t=this.filterData();if(!t)return null;this.records=t,this.recordToIndex={},this.indexToRecord={};let i=this.getProperty("pattern");i&&0==i.length&&(i=null);let r=this.getProperty("asHtml",!0),o=this.getProperty("addLineNumbers",!0),n=this.getProperty("labelTemplate",""),h=HU.px(10);""==n&&(h=HU.px(1)),""==n&&o&&(n="${lineNumber}"),n&&(r=!0);var d,g,p=parseInt(this.getProperty("maxLines",1e5)),c=(parseInt(this.getProperty("lineLength",1e4)),this.getProperty("breakLines",!0)),u=this.getProperty("includeEmptyLines",!1),T=this.getData().getRecordFields(),f=this.getSelectedFields(T);if(0==f.length&&(f=T),0==this.getFieldsByType(f,"string").length)return this.displayError("No string fields specified"),null;this.getProperty("highlights")&&(d=[],g=this.getProperty("highlightStyles",HU.css(CSS_BACKGROUND,"rgb(250_comma_0_comma_0)")).split(","),this.getProperty("highlights","").split(",").map((e=>{e.indexOf("(")<0&&(e="("+e+")"),d.push(RegExp(e,"ig"))})));let y=HU.div([ATTR_ID,this.domId("overlay"),ATTR_STYLE,HU.css(CSS_POSITION,POSITION_ABSOLUTE,CSS_TOP,0,CSS_LEFT,0)],HU.tag(TAG_TABLE,[ATTR_ID,this.domId("overlaytable")]));var m=this.getFieldById(null,this.getProperty("fromField")),_=this.getProperty("doBubble",!1);n&&(y+=HU.open(TAG_TABLE,[ATTR_WIDTH,HU.perc(100)]));var S=0,A=0,I=new TextMatcher(i),b={},R={};this.filters&&this.filters.map((e=>{e.field&&e.field.isString&&(R[e.field.getId()]=e)}));var D={};f.map((e=>{D[e.getId()]=this.getProperty(e.getId()+".template")}));var L=this.getColorByInfo(t),U=this.getProperty("delimiter",""),C=this.showShrink?this.getProperty("rowScale",.3):null;this.showShrink&&(y+=HU.tr([],HU.td([],HU.getIconImage("fa-caret-down"))));let E=this.getFields(),H=this.getTemplateProps(E),P=Utils.tokenizeMacros(n||"");for(var x=0;x<t.length;x++){var v=t[x];Utils.isDefined(v.lineNumber)||(v.lineNumber=x+1),this.indexToRecord[x]=v,this.recordToIndex[v.getId()]=x;for(var O=this.getDataValues(v),N="",w=0;w<f.length;w++){var M=f[w];if(0==x&&R[M.getId()]){let e=R[M.getId()];if(G=e.getFieldValues()){Array.isArray(G)||(G=[G]);try{b[M.getId()]=[],G.map((e=>{if(""!=e&&e!=FILTER_ALL){var t=new TextMatcher(e);b[M.getId()].push(t)}}))}catch(e){console.log("Error making regexp:"+e)}}}G=(G=""+O[M.getIndex()]).replace(/</g,"&lt;").replace(/>/g,"&gt;"),b[M.getId()]&&b[M.getId()].map((e=>{G=e.highlight(G)})),""!=N&&(N+=U+" "),D[M.getId()]&&(G=D[M.getId()].replace("${value}",G)),N+=G}if(N=N.trim(),!u&&0==N.length)continue;S++;var F=[ATTR_VALIGN,ALIGN_TOP],k="";if(L.index>=0){var G=v.getData()[L.index],B=L.getColor(G,v);B&&(F.push(ATTR_STYLE),k+=HU.css(CSS_BACKGROUND,Utils.addAlphaToColor(B,"0.25")))}F.push(ATTR_CLASS),F.push("display-raw-row");let e=I.matches(N),i=e&&I.hasPattern();if(i&&(F.push("matched"),F.push(!0)),C)i||(k+=HU.css(CSS_WEBKIT_TRANSFORM,'scale(1," + rowScale +")'),k+=HU.css(CSS_LINE_HEIGHT,C),F.push(ATTR_STYLE),F.push(k));else if(!e)continue;if(N=I.highlight(N),++A>p)break;let s=[ATTR_TITLE," ",ATTR_CLASS," display-raw-line ",ATTR_RECORD_INDEX,x];if(_&&(N=HU.div([ATTR_CLASS,"ramadda-bubble"],N)),m&&(N+=HU.div([ATTR_CLASS,"ramadda-bubble-from"],""+O[m.getIndex()])),d)for(var Y=0;Y<d.length;Y++){var V=d[Y],q=Y<g.length?g[Y]:g[g.length-1];q=q.replace(/_comma_/g,","),N=N.replace(V,HU.span([ATTR_STYLE,q],"$1"))}if(N=HU.div(s,N),n){let e=this.getDataValues(v),t=this.applyRecordTemplate(v,e,E,n,H,P);var W=v.lineNumber;Utils.isDefined(W),t=t.replace("${lineNumber}","#"+W),t=t.replace(/ /g,SPACE);var j="";this.showShrink&&(j+=HU.td([ATTR_WIDTH,HU.px(5),ATTR_STYLE,HU.css(CSS_BACKGROUND,COLOR_LIGHT_GRAY)],HU.getIconImage("fa-caret-right",null,[ATTR_STYLE,HU.css(CSS_LINE_HEIGHT,HU.px(0))]))),j+=HU.td([ATTR_WIDTH,h],HU.tag(TAG_A,[ATTR_NAME,"line_"+S]),HU.tag(TAG_A,[ATTR_HREF,"#line_"+S],t)+SPACE)+HU.td([],N),y+=HU.tr(F,j)}else y+=N,r?y+=c?HU.p():HU.br():(y+="\n",c&&(y+="\n"))}o&&(y+=HU.close(TAG_TABLE)),y+=HU.close(TAG_DIV),r||(y=HU.tag(TAG_PRE,[],y)),this.writeHtml(s,y),L.displayColorTable();var z=" "+this.getProperty("linesDescriptor","lines"),K=A+z;if(this.allRecords.length!=A&&(K=A+"/"+this.allRecords.length+z+" ("+HU.perc(Math.round(A/this.allRecords.length*100))+")"),this.jq(l).html(K),this.jq(a).focus(),C){var X=this.jq(s).find(".display-raw-row"),Z=function(){$(this).css(CSS_TRANSFORM,"scaleY(1)"),$(this).css(CSS_LINE_HEIGHT,1.5),$(this).css(CSS_BORDER_BOTTOM,HU.border(1,COLOR_LIGHT_GRAY)),$(this).css(CSS_BORDER_TOP,HU.border(1,COLOR_LIGHT_GRAY))},J=function(){var e=this;$(e).attr("matched")||($(e).css(CSS_TRANSFORM,"scaleY("+C+")"),$(e).css(CSS_LINE_HEIGHT,C),$(e).css(CSS_BORDER_BOTTOM,HU.border(0,COLOR_LIGHT_GRAY)),$(e).css(CSS_BORDER_TOP,HU.border(0,COLOR_LIGHT_GRAY)))};X.each(J),X.mouseenter(Z),X.mousemove(Z),X.mouseout(J)}let Q=this.jq(s).find(".display-raw-line");Q.click((function(){var t=$(this).attr(ATTR_RECORD_INDEX),i=e.indexToRecord[t];i&&(e.showRecordPopup($(this),i),e.propagateEventRecordSelection({record:i}),e.highlightLine(t))})),this.makeTooltips(Q,t)},highlightLine:function(e){var t=this.jq(s);t.find(".display-raw-line").removeClass("display-raw-line-selected");var i=HU.attrSelect(ATTR_RECORD_INDEX,e);t.find(i).addClass("display-raw-line-selected")},handleEventRecordSelection:function(e,t){var i=this.findMatchingIndex(t.record).index;if(!(i<0)&&Utils.isDefined(i)){this.highlightLine(i);var l=this.jq(s),a=HU.attrSelect(ATTR_RECORD_INDEX,i),r=l.find(a),o=l.offset().top,n=l.scrollTop(),h=r.offset().top-o+n;l.scrollTop(h)}}})}function RamaddaTextDisplay(e,t,i){const s=new RamaddaDisplay(e,t,DISPLAY_TEXT,i);i.recordTemplate||(i.recordTemplate="${default}"),defineDisplay(addRamaddaDisplay(this),s,[{label:"Text Display"},{p:"recordTemplate",ex:""},{p:"showDefault",d:!0,ex:"false"},{p:"message",d:null,ex:""}],{needsData:function(){return!0},handleAnnotation:function(){let e=null,t=this.getProperty("template","${date} - ${description}"),i=Utils.tokenizeMacros(t),s={},l=null;if(this.selectedRecord&&(l=this.selectedRecord.getDate(),l&&(e=this.annotations.getAnnotationFromDate(l))),e||(l=this.getAnimation().getBeginTime(),l&&(e=this.annotations.getAnnotationFromDate(l))),s.date=l||"",!e)return;s.description=e.description,s.label=e.label,this.annotations.getShowLegend()?s.legend=this.annotations.getLegend():s.legend="";let a=i.apply(s);this.getProperty("decorate",!0)&&(a=this.getMessage(a)),this.setContents(a)},updateUI:function(){if(s.updateUI.call(this),this.getProperty("annotations")){if(null==this.getPointData())return;this.annotations||(this.annotations=new Annotations(this,this.filterData())),this.annotations.isEnabled()&&this.handleAnnotation()}if(this.selectedRecord)this.setContents(this.getRecordHtml(this.selectedRecord));else if(this.getPropertyShowDefault()){this.recordMap={};let e=this.filterData();e&&e.length>0&&(e.forEach(((e,t)=>{this.recordMap[e.getId()]=e})),this.selectedRecord=e[0],this.setContents(this.getRecordHtml(e[0])))}else this.getPropertyMessage()&&this.setDisplayMessage(this.getPropertyMessage())},pointDataLoaded:function(e,t,i){this.selectedRecord=null,s.pointDataLoaded.call(this,e,t,i)},handleEventRecordSelection:function(e,t){this.recordMap&&!this.recordMap[t.record.getId()]||(this.selectedRecord=t.record,this.updateUI())}})}function RamaddaGlossaryDisplay(e,t,i){const s=new RamaddaFieldsDisplay(e,t,DISPLAY_GLOSSARY,i),l="glossary_header";defineDisplay(addRamaddaDisplay(this),s,[{label:"Glossary"},{p:"wordField",ex:""},{p:"definitionField",ex:""}],{updateUI:function(){let e=this.filterData();if(!e)return;let t=this.getFieldById(null,this.getProperty("wordField")),i=this.getFieldById(null,this.getProperty("definitionField"));if(!t)return void this.displayError("No word field specified");if(!i)return void this.displayError("No definition field specified");let s={};e.forEach((e=>{let l=String(t.getValue(e)).trim(),a=i.getValue(e),r=l.substring(0,1).toUpperCase();(s[r]||(s[r]=[])).push({word:l,definition:a,record:e})}));let a=this.getFilterTextMatchers(),r=HU.div([ATTR_CLASS,"display-glossary-letter"],"All"),o="";Object.keys(s).sort().forEach((e=>{let t=e.trim();t=""==t?"_":t;let i=" display-glossary-letter ";if(this.searchLetter==t&&(i+=" display-glossary-letter-highlight "),r+=HU.div([ATTR_CLASS,i,"letter",t],t),this.searchLetter&&this.searchLetter!=t)return;let l=HU.div([ATTR_CLASS,"display-glossary-group-header"],t)+HU.openTag(TAG_DIV,[ATTR_CLASS,"display-glossary-group-inner"]);s[e].sort(((e,t)=>e.word.localeCompare(t.word))).forEach((e=>{let t=String(e.definition);a.forEach((e=>{t=e.highlight(t)}));let i=HU.div([ATTR_CLASS,"display-glossary-word"],e.word)+HU.div([ATTR_CLASS,"display-glossary-definition"],t);l+=HU.div([ATTR_TITLE,"",ATTR_CLASS,"display-glossary-entry",ATTR_RECORD_ID,e.record.getId()],i)})),l+=HU.closeTag(TAG_DIV),o+=l}));let n=this.getProperty("glossaryHeight",HU.px(600));r=HU.div([ATTR_ID,this.domId(l),ATTR_CLASS,"display-glossary-header"],r),o=HU.div([ATTR_STYLE,HU.css(CSS_MAX_HEIGHT,HU.getDimension(n),CSS_OVERFLOW_Y,OVERFLOW_AUTO)],o),this.setContents(r+o);let h=this;this.jq(l).find(".display-glossary-letter").click((function(){h.searchLetter=$(this).attr("letter"),h.forceUpdateUI()})),this.makeTooltips(this.find(".display-glossary-entry"),e)}})}addGlobalDisplayType({type:DISPLAY_TEXT,label:"Text Readout",requiresData:!0,forUser:!0,category:CATEGORY_TEXT,tooltip:makeDisplayTooltip("Simple text display","text.png")}),addGlobalDisplayType({type:DISPLAY_TEMPLATE,label:"Template",requiresData:!0,forUser:!0,category:CATEGORY_TEXT,tooltip:makeDisplayTooltip("Flexible text template to show records","template.png")}),addGlobalDisplayType({type:DISPLAY_TOPFIELDS,label:"Top Fields",requiresData:!0,forUser:!0,category:CATEGORY_MISC,tooltip:makeDisplayTooltip("List Fields","topfields.png","For every row it sorts the field values and lists the field names")}),addGlobalDisplayType({type:DISPLAY_WORDCLOUD,forUser:!0,label:"Word Cloud",requiresData:!0,category:CATEGORY_TEXT,tooltip:makeDisplayTooltip("Cloud of words","wordcloud.png")}),addGlobalDisplayType({type:DISPLAY_TEXTSTATS,forUser:!0,label:"Text Stats",requiresData:!0,category:CATEGORY_TEXT,tooltip:makeDisplayTooltip("Summary statistics for text","textstats.png","Incudes line/word count, word length and frequency")}),addGlobalDisplayType({type:DISPLAY_FREQUENCY,forUser:!0,label:"Frequency",requiresData:!0,category:CATEGORY_TEXT,tooltip:makeDisplayTooltip("Text field based frequencies","frequency.png")}),addGlobalDisplayType({type:DISPLAY_TEXTRAW,forUser:!0,label:"Text Raw",requiresData:!0,category:CATEGORY_TEXT,tooltip:makeDisplayTooltip("Shows raw text","textraw.png","Provides a search field")}),addGlobalDisplayType({type:DISPLAY_TEXTANALYSIS,forUser:!0,label:"Text Analysis",requiresData:!0,category:CATEGORY_TEXT,tooltip:makeDisplayTooltip("Analyzes text","textanalysis.png")}),addGlobalDisplayType({type:DISPLAY_BLOCKS,forUser:!0,label:"Blocks",requiresData:!0,category:CATEGORY_MISC,tooltip:makeDisplayTooltip("Blocks","blocks.png","Shows a certain number of small blocks or icons color coded from the data")}),addGlobalDisplayType({type:DISPLAY_GLOSSARY,forUser:!0,label:"Glossary",requiresData:!0,category:CATEGORY_TEXT,tooltip:makeDisplayTooltip("Searchable glossary","glossary.png")});var DISPLAY_ENTRYLIST="entrylist",DISPLAY_SEARCH="search",DISPLAY_TESTLIST="testlist",DISPLAY_ENTRYDISPLAY="entrydisplay",DISPLAY_ENTRY_GALLERY="entrygallery",DISPLAY_ENTRY_GRID="entrygrid",DISPLAY_OPERANDS="operands",DISPLAY_METADATA="metadata",DISPLAY_ENTRYTIMELINE="entrytimeline",DISPLAY_REPOSITORIES="repositories",DISPLAY_ENTRYTITLE="entrytitle",DISPLAY_ENTRYWIKI="entrywiki",DISPLAY_SEARCH="search",DISPLAY_SIMPLESEARCH="simplesearch",ID_RESULTS="results",ID_SEARCH_FORM="searchform",ID_SEARCH_HEADER="searchheader",ID_SEARCH_BAR="searchbar",ID_SEARCH_TAG="searchtag",ID_SEARCH_TAG_GROUP="searchtaggroup",ID_SEARCH_FOOTER=ID_FOOTER,ID_ENTRIES="entries",ID_DETAILS_INNER="detailsinner",ID_DETAILS_ANCESTORS="detailsancestors",ID_DETAILS_TAGS="detailstags",ID_DETAILS_TYPE="detailstype",ID_PROVIDERS="providers",ID_SEARCH_ORDERBY="orderby",ID_SEARCH_SETTINGS="searchsettings",ID_SEARCH_AREA="search_area",ID_SEARCH_MAX="search_max",ID_SEARCH_DATE_RANGE="search_date",ID_SEARCH_DATE_CREATE="search_createdate",ID_SEARCH_DATE_CHANGE="search_changedate",ID_SEARCH_TAGS="search_tags",ID_SEARCH_ANCESTOR="search_ancestor",ID_SEARCH_ANCESTORS="search_ancestors",ID_SEARCH_ANCESTORS_MENU="search_ancestors_menu",ID_TREE_LINK="treelink",ID_SEARCH="search",ID_FORM="form",ID_TEXT_FIELD="textfield",ID_NAME_FIELD="namefield",ID_DESCRIPTION_FIELD="descriptionfield",ID_ANCESTOR="ancestor",ID_ANCESTOR_NAME="ancestorname",ID_TYPE_FIELD="typefield",ID_TYPE_DIV="typediv",ID_TYPEFIELDS="typefields",ID_METADATA_FIELD="metadatafield",ID_COLUMN="column",ID_SEARCH_HIDEFORM="searchhideform",ATTR_TEXT_INPUT="data-text-input",CLASS_SEARCH_TAG="display-search-tag",CLASS_SIMPLESEARCH_INPUT="display-simplesearch-input",CLASS_SEARCH_TEXTINPUT="display-search-textinput";function RamaddaEntryDisplay(e,t,i,s){const l=new RamaddaDisplay(e,t,i,s);RamaddaUtil.inherit(this,l),this.entryProps=[{label:"Remote Entry Search"},{p:"showProviders",ex:!0,d:!1},{p:"providers",ex:"this,category:.*",tt:"List of search providers",canCache:!0},{p:"providersMultiple",ex:"true",tt:"Support selecting multiple providers"},{p:"providersMultipleSize",d:"4"},{p:"searchDirect",d:!1,tt:"Directly search remote RAMADDA repositories"}],this.defineProperties(this.entryProps),this.ramaddas=new Array;let a=this.getProperty("repositories",this.getProperty("repos",null));if(null!=a){let e=a.split(",");for(let t=0;t<e.length;t++){let i=e[t];i=i.trim(),this.ramaddas.push(getRamadda(i))}if(this.ramaddas.length>0){let e=new RepositoryContainer("all","All entries");addRepository(e);for(let t=0;t<this.ramaddas.length;t++)e.addRepository(this.ramaddas[t]);this.ramaddas.push(e),this.setOriginalRamadda(this.ramaddas[0]),this.setRamadda(this.ramaddas[0])}}this.searchSettings=new EntrySearchSettings({parent:s.searchEntryParent||s.entryParent,text:s.searchEntryText||s.entryText,entryType:s.searchEntryType,orderBy:s.orderBy,ancestor:s.searchAncestor||s.ancestor}),s.provider&&this.searchSettings.setProvider(s.provider),RamaddaUtil.defineMembers(this,{entryList:s.entryList,entryMap:{},writeEntries:function(e,t){this.jq(ID_ENTRIES).html(e)},writeMessage:function(e){this.jq(ID_RESULTS).html(e)},writeResults:function(e){this.jq(ID_RESULTS).html(e)},getSearchSettings:function(){if(null!=this.getPropertyProviders()){this.searchSettings.clearProviders();let e=this.searchSettings.getProvider(),t=this.jq(ID_PROVIDERS).val();null!=t?e=t:(e=this.getPropertyProviders()[0],e&&(e=e.id));let i=this.getRamadda(),s=!0;i&&i.getId()==e&&(s=!1),s?this.searchSettings.setProvider(e):this.searchSettings.clearProviders()}return this.searchSettings},getEntries:function(){return null==this.entryList?[]:this.entryList.getEntries()},getEntriesMetadata:function(e){let t=[],i={},s={};for(let l=0;l<e.length;l++){let a=e[l].getMetadata();for(let e=0;e<a.length;e++){let l=a[e];null==s[l.type]&&(s[l.type]="",t.push(l.type)),i[a[e].type]=a[e].label}}let l="";l+=HU.openTag(TAG_TABLE,[ATTR_ID,this.getDomId(TAG_TABLE),ATTR_CLASS,HU.classes(CLASS_TABLE_CELLBORDER,CLASS_TABLE_STRIPE,CLASS_TABLE),ATTR_WIDTH,HU.perc(100),ATTR_CELLPADDING,5,ATTR_CELLSPACING,0]),l+=HU.open(TAG_THEAD);let a=this.findEntryType(this.searchSettings.entryType),r="Entry";null!=a&&(r=a.getLabel()),this.writeMessage(this.getResultsHeader(e));let o=null,n=this.getProperty("metadataTypes",null);null!=n?o=n.split(","):(o=t,o.sort());let h={"content.pagestyle":!0,"content.pagetemplate":!0,"content.sort":!0,"spatial.polygon":!0},d=[];d.push(HU.th([],HU.b(r)));for(let e=0;e<o.length;e++){if(h[o[e]])continue;let t=i[o[e]];null==t&&(t=o[e]),d.push(HU.th([],HU.b(t)))}let g=HU.tr([ATTR_VALIGN,ALIGN_BOTTOM],HU.join(d,""));l+=g,l+=HU.close(TAG_THEAD)+HU.open(TAG_TBODY);let p=HU.div([ATTR_CLASS,"display-metadata-divider"]),c=this.missingMessage;(c=null)&&(c=SPACE);for(let t=0;t<e.length;t++){let i=e[t],s=i.getMetadata(),a=[],r=(this.getDomId("entrylink"+i.getIdForDom()),i.getLink(i.getIconImage()+" "+i.getName()));a.push(HU.td([],HU.div([ATTR_CLASS,"display-metadata-entrylink"],r)));for(let e=0;e<o.length;e++){let t=o[e];if(h[t])continue;let l=null;for(let e=0;e<s.length;e++){let a=s[e];if(a.type==t){let e=null;if("content.thumbnail"==a.type||"content.logo"==a.type){let t=HU.url(this.getRamadda().getRoot()+"/metadata/view/"+a.value.attr1,[ARG_ELEMENT,1,ARG_ENTRYID,i.getId(),ARG_METADATAID,a.id]);e=HU.image(t,[ATTR_WIDTH,100])}else if("content.url"==a.type||"dif.related_url"==a.type){let t=a.value.attr2;null!=t&&""!=t||(t=a.value.attr1),e=HU.href(a.value.attr1,t)}else if("content.attachment"==a.type){let t=a.value.attr1.split("_file_")[1],s=HU.url(this.getRamadda().getRoot()+"/metadata/view/"+a.value.attr1,[ARG_ELEMENT,1,ARG_ENTRYID,i.getId(),ARG_METADATAID,a.id]);e=HU.href(s,t)}else e=a.value.attr1,Utils.isDefined(a.value.attr2)&&String(a.value.attr2).trim().length>0&&(e+=" - "+a.value.attr2);null!=e&&(null==l?l="":l+=p,l+=HU.div([ATTR_CLASS,"display-metadata-item"],e))}}null==l&&(l=c),null==l&&(l="");let r=HU.tag(TAG_A,[ATTR_STYLE,HU.css(CSS_COLOR,COLOR_BLACK),ATTR_HREF,HU.url(this.getRamadda().getRoot()+"/metadata/addform",[ARG_ENTRYID,i.getId(),"metadata_type",t]),ATTR_TARGET,"_blank",ATTR_TITLE,"Add metadata"],"+");r=HU.div([ATTR_CLASS,"display-metadata-table-add"],r);let n=r+p;l.length>0&&(n+=l),a.push(HU.td([],HU.div([ATTR_CLASS,"display-metadata-table-cell-contents"],n)))}l+=HU.tr([ATTR_VALIGN,ALIGN_TOP],HU.join(a,"")),(t+1)%10==0&&(l+=g)}return l+=HU.close(TAG_TBODY,TAG_TABLE),l},getEntriesGallery:function(e){let t="",i="",s=0,l=[];for(let a=0;a<e.length;a++){let r=e[a];if(r.getIsImage()){l.push(r);let e=HU.tag(TAG_A,[ATTR_HREF,r.getEntryUrl()],r.getName());s++;let t=r.getImageUrl();i+=HU.tag(TAG_IMG,[ATTR_SRC,t,ATTR_WIDTH,500,ATTR_ID,this.getDomId("entry_"+r.getIdForDom()),ATTR_ENTRYID,r.getId(),ATTR_CLASS,"display-entrygallery-entry"])+HU.br()+e+HU.p()}else{let e=r.getIconImage([ATTR_TITLE,"View entry"]);t+=HU.tag(TAG_A,[ATTR_HREF,r.getEntryUrl()],e+" "+r.getName())+HU.br()}}if(s>1){this.galleryId=HU.getUniqueId("gallery_");let e=HU.open(TAG_DIV,[ATTR_ID,this.galleryId,ATTR_CLASS,"ramadda-grid"]),t=this.getProperty("galleryItemWidth",HU.px(200));for(let i=0;i<l.length;i++){let s=l[i],a=[CSS_WIDTH,t];e+=HU.open(TAG_DIV,[ATTR_CLASS,"display-entrygallery-item",ATTR_STYLE,HU.css(a)]);let r=HU.tag(TAG_A,[ATTR_TARGET,"_entries",ATTR_HREF,s.getEntryUrl()],s.getName());r=r.replace(/"/g,"'");let o=s.getImageUrl(),n=HU.image(o,[ATTR_LOADING,LOADING_LAZY,ATTR_WIDTH,HU.perc(100),ATTR_ID,this.getDomId("entry_"+s.getIdForDom()),ATTR_ENTRYID,s.getId(),ATTR_CLASS,"display-entrygallery-entry"]);n=HU.href(s.getResourceUrl(),n,[ATTR_DATA_FANCYBOX,this.galleryId,ATTR_DATA_CAPTION,r,ATTR_CLASS,"popup_image"]),e+=HU.div([ATTR_CLASS,"image-outer"],HU.div([ATTR_CLASS,"image-inner"],n)+HU.div([ATTR_CLASS,"image-caption"],r)),e+=HU.close(TAG_DIV)}e+=HU.close(TAG_DIV),i=e}return""!=t&&(s>0&&(i+="<hr>"),i+=HU.div([ATTR_STYLE,HU.css(CSS_MARGIN,HU.px(10))],t)),i}}),null!=s.searchEntryType&&this.searchSettings.addType(s.searchEntryType)}function RamaddaSearcherDisplay(e,t,i,s){let l=this.myProps=[{label:"Search Entry Types"},{p:"entryTypes",ex:"comma separated list of type IDs",tt:"Entry types to search for"},{p:"showType",d:!0,tt:"Show the entry type selector"},{p:"excludeTypes",ex:"type1,type2",tt:"Exclude these types"},{p:"excludeEmptyTypes",ex:"true",tt:"Some types in the type list might have zero entry count"},{p:"typesLabel",tt:"Label to use for the type section"},{p:"addAllTypes",d:!1,ex:"true",tt:"Add the All types to the type list"},{p:"addAnyType",d:!0,ex:"true",tt:"Add the Any of these types to the type list"},{p:"startWithAny",d:!0,ex:"true",tt:"Start with the Any of these types"},{label:"Search Context"},{p:"ancestor",ex:"entry ID or this",tt:"Constrain search to this entry"},{p:"showAncestorSelector",d:!0},{p:"ancestors",tt:"Comma separated list of entry ids or type:entry_type"},{p:"ancestorsLabel",tt:"Label to use for the ancestors section"},{p:"mainAncestor",tt:"Entry ID to force the search under"},{label:"Search Settings"},{p:"orderByTypes",tt:"Comma separated list to show in the order by menu",ex:"relevant,name,createdate,date,changedate,size,entryorder",d:"relevant,name,createdate,date,size,entryorder"},{p:"orderBy",ex:"name_ascending|name_descending|fromdate_ascending|fromdate_descending|todate_|createdate_|size_",tt:"Initial sort order"},{p:"showOrderBy",d:!0,ex:"true"},{p:"doSearch",d:!0,tt:"Apply search at initial display"},{p:"showText",d:!0},{p:"showName",d:!0},{p:"showDescription",d:!1},{p:"showDate",d:!0},{p:"showCreateDate",ex:"true",d:!1},{p:"showChangeDate",ex:"true",d:!1},{p:"showArea",d:!0},{p:"textRequired",d:!1},{p:"searchText",d:"",tt:"Initial search text"},{p:"searchPrefix",ex:"name:, contents:, path:",tt:"Prefix to add to the search text"},{p:"showMetadata",d:!1},{p:"metadataTypes",tt:"Comma separated list of metadata types to add to the search form",ex:"enum_tag:Tag,content.keyword:Keyword,thredds.variable:Variable"},{p:"metadataDisplay",ex:"archive_note:attr1=Arrangement:template=<b>{attr1}_colon_</b> {attr2}",tt:"Add metadata in the toggle. e.g.: type1:template={attr1},type2:attr1=Value:template={attr1}_colon_ {attr2}"},{p:"mainMetadataDisplay"},{p:"tagPopupLimit",d:10,tt:"When do we show the tag popup"},{p:"showSearchLabels",d:!0},{p:"inputSize",ex:"15",tt:"Text input size"},{p:"textInputSize",d:"20px",ex:"100%"},{p:"startDateLabel"},{p:"createDateLabel"},{p:"changeDateLabel"},{p:"areaLabel"},{p:"showColumns",tt:"Comma separated list of entry columns to show"},{label:"Search Form Layout"},{p:"searchHeaderLabel",d:LABEL_SEARCH},{p:"formHeight",d:"1000px"},{p:"formWidth",d:"225px"},{p:"entriesWidth",d:0},{p:"entriesHeight",ex:"70vh"},{p:"showFormToggle",d:!0,tt:"Show the hamburger button that hides/shows the form"},{p:"formOpen",d:!0,tt:"Should the form initially be shown"},{p:"toggleClose",ex:!0,tt:"Close the search widget groups"},{p:"typesToggleClose",ex:!0},{p:"textToggleClose",ex:!0},{p:"dateToggleClose",ex:!0},{p:"areaToggleClose",ex:!0},{p:"columnsToggleClose",ex:!0},{p:"showHeader",d:!0},{p:"showFooter",d:!0,tt:"Show the footer below the output"},{p:"showOutputs",ex:"false",d:!0,tt:"Should the output buttons be shown"},{p:"resultButtons",ex:"default.ids,zip.tree,zip.export,extedit,copyurl",tt:"The list of output buttons at the bottom of the form"},{p:"doWorkbench",d:!1,ex:"true",tt:"Show the new, charts, etc links"},{label:"Search Results"},{p:"displayTypes",d:"list,display",ex:'"list,images,timeline,map,display,metadata"'},{p:"showEntryBreadcrumbs",ex:"false"},{p:"showSnippetInList",ex:"true"},{p:"nameStyle",tt:"Css style to apply to the entry name"},{p:"showIcon",tt:"Show the entry icon in the output"},{p:"showThumbnail"},{p:"placeholderImage",ex:"/repository/images/placeholder.png"},{p:"defaultImage",ex:"blank.gif",canCache:!0},{p:"showEntryType",ex:"true",tt:"Show entry type in list"},{p:"showEntryImage",d:!0,tt:"Show the entry thumbnail"},{p:"showDetailsForGroup",d:!1}];const a=new RamaddaEntryDisplay(e,t,i,s);this.currentTime=new Date,defineDisplay(this,a,l,{metadataTypeList:[],haveSearched:!1,haveTypes:!1,metadata:{},metadataLoading:{},getWikiEditorTags:function(){return Utils.mergeLists(this.myProps,a.entryProps)},addToDocumentUrl:function(e,t){(new Date).getTime()-this.currentTime.getTime()>1e3&&HU.addToDocumentUrl(e,t)},ctor:function(){let e=this.getMetadataTypes();if(Utils.stringDefined(e)){let t=e.split(",");for(let e=0;e<t.length;e++){let i=t[e],s=i,l=null,a=i.split(":");a.length>1&&(i=a[0],a.length>=3?(l=a[1],s=a[2]):s=a[1]),"null"==s||this.metadataTypeList.push(new MetadataType(i,s,l))}}},getLoadingMessage:function(e){return e||""},isLayoutHorizontal:function(){return!0},setFormVisible:function(e){this.formShown=e,e?this.jq(ID_SEARCH_FORM).show():this.jq(ID_SEARCH_FORM).hide()},initHtml:function(){if(this.jq(ID_ANCESTOR).click((e=>{let t=this.domId(ID_ANCESTOR),i=this.getRamadda().getRoot();RamaddaUtils.selectInitialClick(e,t,t,!0,null,null,"",i)})),this.jq(ID_ANCESTOR+"_clear").click((()=>{RamaddaUtils.clearSelect(this.domId(ID_ANCESTOR)),this.setProperty("ancestor",null)})),this.setFormVisible(this.getFormOpen()),this.jq(ID_SEARCH_HIDEFORM).click((()=>{this.setFormVisible(!this.formShown)})),this.areaWidgets&&this.areaWidgets.forEach((e=>{e.initHtml()})),this.getShowOrderBy()){let e=this.getSearchSettings(),t=[],i=(e,t,i)=>{let s="orderByLabel_"+e+(t?"_"+t:""),l=this.getProperty(s);return l||(t&&(t=Utils.delimMsg(t)),i||(i=Utils.delimMsg(Utils.makeLabel(e))+(t?" - "+t:"")),i)};Utils.split(this.getOrderByTypes(),",",!0,!0).forEach((e=>{"relevant"==e?t.push([i(e,null),e]):"name"==e?t.push([i(e,"ascending","Name A-Z"),e+"_ascending"],[i(e,"descending","Name Z-A"),e+"_descending"]):"createdate"==e?t.push([Utils.delimMsg("Record create date")+" - "+Utils.delimMsg("newest first"),"createdate_descending"],[Utils.delimMsg("Record create date")+" - "+Utils.delimMsg("oldest first"),"createdate_ascending"]):"changedate"==e?t.push([Utils.delimMsg("Record change date")+" - "+Utils.delimMsg("newest first"),"changedate_descending"],[Utils.delimMsg("Record change date")+" - "+Utils.delimMsg("oldest first"),"changedate_ascending"]):"date"==e?t.push([i(e,"descending",Utils.delimMsg("From date")+" - "+Utils.delimMsg("youngest first")),"fromdate_descending"],[i(e,"ascending",Utils.delimMsg("From date")+" - "+Utils.delimMsg("oldest first")),"fromdate_ascending"]):"size"==e?t.push([Utils.delimMsg("Size")+" - "+Utils.delimMsg("largest first"),"size_descending"],[Utils.delimMsg("Size")+" - "+Utils.delimMsg("smallest first"),"size_ascending"]):"entryorder"==e?t.push([Utils.delimMsg("Entry order")+" - "+Utils.delimMsg("increasing"),"entryorder_ascending"],[Utils.delimMsg("Entry order")+" - "+Utils.delimMsg("decreasing"),"entryorder_descending"]):t.push([i(e,"descending"),"field:"+e+"_descending"],[i(e,"ascending"),"field:"+e+"_ascending"])}));let s="";t.forEach((t=>{let i=t[0],l=t[1],a=e.orderBy==l?" selected ":"";s+="<option title='"+i+"'  "+a+' value="'+l+'">'+i+"</option>\n"}));let l=HU.tag(TAG_SELECT,[ATTR_ID,this.getDomId(ID_SEARCH_ORDERBY),ATTR_CLASS,"display-search-orderby"],s);this.jq(ID_SEARCH_HEADER).append(l)}this.addExtraForm()},toggleAll:function(e){let t=this;this.jq(ID_SEARCH_FORM).find(".display-search-label-toggle").each((function(){t.toggleWidget($(this),e)}))},toggleWidget:function(e,t){let i,s=jqid(e.attr("data-widget-id"));t?(s.show(),i="fa-minus"):(s.hide(),i="fa-plus"),i=HU.getIconImage(i,[],[ATTR_STYLE,HU.css(CSS_COLOR,COLOR_WHITE)]);let l=e.attr("data-image-id");jqid(l).html(i)},addToggle:function(e,t,i){let s=HU.getUniqueId(""),l=s+"_image",a=Utils.delimMsg("click")+": "+Utils.delimMsg("toggle")+"; "+Utils.delimMsg("shift-click")+": "+Utils.delimMsg("toggle all");return e=HU.div([ATTR_CLASS,"display-search-label-toggle",ATTR_ID,s,"data-widget-id",t,"data-image-id",l,ATTR_TITLE,a],HU.span([ATTR_ID,l],HU.getIconImage(i?"fa-plus":"fa-minus",[],[ATTR_STYLE,HU.css(CSS_COLOR,COLOR_WHITE)]))+" "+HU.span([],e)),setTimeout((()=>{jqid(s).click((e=>{let i=jqid(s),l=jqid(t).is(":visible");e.shiftKey?this.toggleAll(!l):this.toggleWidget(i,!l)}))}),100),e},addWidget:function(e,t,i){let s={addToggle:!0,addSimpleToggle:!1,toggleClose:this.getToggleClose()};if(i&&$.extend(s,i),Utils.isDefined(s.toggleClose)&&(s.toggleClose=Utils.getProperty(s.toggleClose)),!Utils.stringDefined(t))return"";if(!Utils.stringDefined(e))return t=HU.div([ATTR_CLASS,"display-search-widget-nolabel"],t);t=HU.div([ATTR_CLASS,"display-search-widget "+(s.searchWidgetClass??"")],t);let l=HU.getUniqueId("");s.addToggle&&(e=this.addToggle(e,l,s.toggleClose));let a=Utils.stringDefined(e)?HU.div([ATTR_CLASS,"display-search-label"],e):"";return t=HU.div([ATTR_CLASS,"display-search-widgets"],t),s.addSimpleToggle?a=HU.toggleBlock(HU.b(e),t):a+=HU.div([ATTR_ID,l,ATTR_STYLE,HU.css(CSS_WIDTH,HU.perc(100),CSS_DISPLAY,s.toggleClose?DISPLAY_NONE:DISPLAY_INLINE_BLOCK)],t),HU.div([ATTR_CLASS,"display-search-block"],a)},getFooter:function(){return HU.div([ATTR_ID,this.getDomId(ID_FOOTER),ATTR_CLASS,"display-footer display-search-footer"])},getDefaultHtml:function(){let e="",t=this.isLayoutHorizontal(),i=[ATTR_ID,this.getDomId(ID_ENTRIES),ATTR_CLASS,this.getClass("content")],s=this.getProperty("innerHeight",null),l=this.getProperty("entriesStyle",""),a="";null==s&&(s=this.getEntriesHeight()),null!=s&&(a=HU.css(CSS_MAX_HEIGHT,HU.getDimension(s),CSS_OVERFLOW_Y,OVERFLOW_AUTO)),a+=l,i.push(ATTR_STYLE,a);let r=HU.div([ATTR_CLASS,t?"display-search-bar":"display-search-bar-vertical",ATTR_ID,this.domId(ID_SEARCH_BAR)],""),o="";this.getShowHeader()&&(o=HU.div([ATTR_CLASS,"display-entries-results",ATTR_ID,this.getDomId(ID_RESULTS)],SPACE)),o=HU.leftRightTable(o,HU.div([ATTR_CLASS,"display-search-header",ATTR_ID,this.domId(ID_SEARCH_HEADER)]),null,null,{valign:POS_BOTTOM});let n="";t&&this.getShowFormToggle()&&(n=HU.div([ATTR_TITLE,"Toggle form",ATTR_ID,this.domId(ID_SEARCH_HIDEFORM),ATTR_CLASS,CLASS_CLICKABLE,ATTR_STYLE,HU.css(CSS_POSITION,POSITION_ABSOLUTE,CSS_LEFT,HU.px(0),CSS_TOP,HU.px(0))],HU.getIconImage("fas fa-bars")));let h=HU.div([ATTR_STYLE,HU.css(CSS_POSITION,POSITION_RELATIVE)],n+r+o+HU.div(i,this.getLoadingMessage()));e+=HU.open(TAG_TABLE,[ATTR_WIDTH,HU.perc(100),ATTR_BORDER,0]),e+=HU.open(TAG_TR,[ATTR_VALIGN,POS_TOP]);ATTR_CLASS;let d=HU.div([ATTR_CLASS,"display-entrylist-form",ATTR_STYLE,HU.css(CSS_WIDTH,HU.getDimension(this.getFormWidth()),CSS_MAX_WIDTH,HU.getDimension(this.getFormWidth()),CSS_OVERFLOW_X,OVERFLOW_AUTO)],this.makeSearchForm());return e+=HU.tag(TAG_TD,[ATTR_ID,this.getDomId(ID_SEARCH_FORM),ATTR_WIDTH,HU.perc(1)],d),this.formShown=!0,this.getShowFooter()&&(h+=this.getFooter()),e+=HU.tag(TAG_TD,[],h),e+=HU.close(TAG_TR,TAG_TABLE),e+=HU.openTag(TAG_DIV,[ATTR_CLASS,"row"]),e+=HU.tag(TAG_DIV,[ATTR_CLASS,"col-md-6"],""),this.getShowFooter(!0),e+=HU.close(TAG_DIV),e+=HU.div([ATTR_CLASS,"display-entry-popup",ATTR_ID,this.getDomId(ID_DETAILS)],SPACE),e},initDisplay:function(){let e=this;this.jq(ID_SEARCH).button().click((function(t){e.submitSearchForm(),t.preventDefault()})),this.jq(ID_TEXT_FIELD).autocomplete({source:function(e,t){}}),this.jq(ID_SEARCH_ORDERBY).change((()=>{this.submitSearchForm()})),HU.initSelect(this.jq(ID_REPOSITORY)),this.jq(ID_REPOSITORY).change((function(){let t=e.jq(ID_REPOSITORY).val(),i=getRamadda(t);e.setRamadda(i),e.addTypes(null),e.typeChanged()})),this.jq(ID_FORM).submit((function(t){e.submitSearchForm(),t.preventDefault()})),this.addTypes(this.entryTypes),this.initMetadata(),this.haveSearched||this.getDoSearch()&&(this.typesPending||this.submitSearchForm())},showEntryDetails:async function(e,t,i,s){},getCloser:function(){return""},initCloser:function(e){this.jq("close").click((()=>{this.jq(e||ID_RESULTS).hide()}))},getResultsHeader:function(e,t){let i=this.getSearchSettings(),s=i.skip+1+"-"+(i.skip+Math.min(i.getMax(),e.length));0==e.length&&(s=SPACE3+SPACE3+SPACE3);let l=[],a=[];i.skip>0&&l.push(HU.onClick(this.getGet()+".loadPrevUrl();",HU.getIconImage("fa-arrow-left",[ATTR_TITLE,"Previous"]),[ATTR_CLASS,"display-link"]));let r=!1;e.length>0&&(l.push(HU.onClick(this.getGet()+".loadNextUrl();",HU.getIconImage("fa-arrow-right",[ATTR_TITLE,"Next"]),[ATTR_CLASS,"display-link"])),r=!0),e.length>0&&(a.push(HU.onClick(this.getGet()+".loadLess();",HU.getIconImage("fa-minus",[ATTR_TITLE,"View less"]),[ATTR_CLASS,"display-link"])),r&&a.push(HU.onClick(this.getGet()+".loadMore();",HU.getIconImage("fa-plus",[ATTR_TITLE,"View more"]),[ATTR_CLASS,"display-link"])));let o="",n=SPACE3;return t&&(o=this.getCloser()),o+=SPACE+s+n,o+=HU.join(l,SPACE)+n+HU.join(a,SPACE),o+HU.br()},makeSearchSettings:function(){let e=this.getSearchSettings();e.text=this.getFieldValue(this.getDomId(ID_TEXT_FIELD),e.text),e.name=this.getFieldValue(this.getDomId(ID_NAME_FIELD),e.name),e.description=this.getFieldValue(this.getDomId(ID_DESCRIPTION_FIELD),e.description),e.text&&(Utils.stringDefined(e.text)&&this.addToDocumentUrl(ID_TEXT_FIELD,e.text),""!=e.text.trim()&&this.getSearchPrefix()&&(e.text=this.getSearchPrefix()+e.text)),e.ancestor=this.getAncestor();let t=this.jq(ID_SEARCH_ORDERBY).val();if(t){let i=t.indexOf("_ascending")>=0;"relevant"==t&&(i=!1),t=t.replace("_ascending","").replace("_descending",""),e.orderBy=t,e.ascending=i}this.haveTypes?(e.entryType=this.getFieldValue(this.getDomId(ID_TYPE_FIELD),e.entryType),e.entryType&&(null==this.typeList||this.typeList.length>1)?this.addToDocumentUrl(ID_TYPE_FIELD,e.entryType):this.addToDocumentUrl(ID_TYPE_FIELD,null)):this.typeList&&1==this.typeList.length&&(e.entryType=this.typeList[0]),!Utils.stringDefined(e.entryType)&&this.getEntryTypes()&&(e.entryType=this.getEntryTypes()),e.clearAndAddType(e.entryType);let i=this.jq(ID_ANCESTOR+"_hidden").val();if(Utils.stringDefined(i)){e.ancestor=i,this.addToDocumentUrl(ID_ANCESTOR,i);let t=this.jq(ID_ANCESTOR).val();t&&this.addToDocumentUrl(ID_ANCESTOR_NAME,t)}else this.addToDocumentUrl(ID_ANCESTOR,null),this.addToDocumentUrl(ID_ANCESTOR_NAME,null);return this.areaWidgets&&this.areaWidgets.forEach((t=>{t.setSearchSettings(e)})),this.dateRangeWidget&&this.dateRangeWidget.setSearchSettings(e),this.createdateRangeWidget&&this.createdateRangeWidget.setSearchSettings(e),this.changedateRangeWidget&&this.changedateRangeWidget.setSearchSettings(e),e.metadata=[],this.metadataList&&this.metadataList.forEach((t=>{t.getElements()&&t.getElements().forEach((t=>{t.addSearchSettings(e)}))})),e},submitSearchForm:function(){if(ramaddaDoingWiki>0)return;if(this.fixedEntries)return;this.haveSearched=!0;let e=this.makeSearchSettings();if(this.getTextRequired()&&!Utils.stringDefined(e.text))return void this.writeEntries("");let t=this.getRamadda();if(this.writeMessage(this.getWaitImage()+" Searching..."),t.children){this.entryList=new EntryListHolder(t,this),this.multiSearch={count:0};for(let e=0;e<t.children.length;e++){let i=t.children[e],s=this.makeSearchUrl(i);this.updateForSearching(s),this.entryList.addEntryList(new EntryList(i,s,null,!1)),this.multiSearch.count++}this.entryList.doSearch(this)}else{this.multiSearch=null;let e=this.makeSearchUrl(this.getRamadda());this.handleLog(e),this.entryList=new EntryList(this.getRamadda(),e,this,!0),this.updateForSearching(e)}},entryListChanged:function(e){},handleSearchError:function(e,t){this.writeEntries(""),this.writeMessage("Error performing search:"+t),console.log("Error performing search:"+t)},updateForSearching:function(e){let t=this.getShowOutputs(!0),i=this.getSearchSettings(),s=this.getResultButtons(this.getProperty("outputs"));s&&(s=Utils.split(s,",",!0,!0));let l=e=>{if(!t)return!1;let i=e.id??e;return!s||(i==OUTPUT_CSV?i="csv":i==OUTPUT_ZIP?i="zip":i==OUTPUT_EXPORT&&(i="export"),s.includes(i))},a=this.getRamadda().getSearchLinks(i,!0,l),r=this.getRamadda().getSearchUrl(i),o=HU.getUniqueId("copy"),n=[];this.getProperty("searchOutputs")&&(n=Utils.mergeLists(n,Utils.split(this.getProperty("searchOutputs"),",",!0,!0))),Utils.isAnonymous()||l("extedit")&&n.push("repository.extedit;Extended Edit"),n.forEach((e=>{let t=Utils.split(e,";");if(t.length<2)return;let s=t[0],l=t[1];a.push(HU.span([ATTR_CLASS,HU.classes("ramadda-search-link",CLASS_CLICKABLE),ATTR_TITLE,Utils.delimMsg("Click to download")+"; "+Utils.delimMsg("Shift-click to copy URL"),"custom-output","true",ATTR_DATA_NAME,l,"data-format",s,ATTR_DATA_URL,this.getRamadda().getSearchUrl(i,s)],l))})),a=HU.join(a,HU.space(2)),l("copyurl")&&(a=a+HU.space(2)+HU.span([ATTR_CLASS,HU.classes("ramadda-search-link",CLASS_CLICKABLE),ATTR_ID,o,"data-copy",r],HU.getIconImage(ICON_CLIPBOARD))),this.getShowOutputs()?this.footerRight=null==a?"":a:this.footerRight="",this.writeHtml(ID_SEARCH_FOOTER,this.footerRight);let h=this;this.jq(ID_SEARCH_FOOTER).find(".ramadda-search-link").button().click((function(e){let t=$(this).attr("custom-output");h.handleSearchLink(e,$(this),t)}));let d=this.searchMessage;null==d&&(d=this.getRamadda().getSearchMessage());let g=this.getSearchSettings().getProvider();null!=g&&(d=null,null!=this.providerMap&&this.providerMap[g]&&(d=this.providerMap[g].name),null==d&&(d=g),d="Searching "+d),this.hideEntryDetails()},prepareToLayout:function(){a.prepareToLayout.apply(this),this.savedValues={};let e=this.getSearchableColumns();for(let t=0;t<e.length;t++){let i=e[t],s=this.getDomId(ID_COLUMN+i.getName()),l=jqid(s).val();null!=l&&0!=l.length&&(this.savedValues[s]=l)}},makeSearchUrl:function(e){let t=this,i="",s=this.getSearchableColumns(),l=this.jq(ID_SEARCH_BAR),a=(e,t,i)=>$(HU.div([ATTR_TITLE,"Click to clear search",ATTR_CLASS,CLASS_SEARCH_TAG,e,t],i)).appendTo(l);this.getContents().find(HU.dotClass(CLASS_SEARCH_TEXTINPUT)).each((function(){let e=$(this).attr(ATTR_TEXT_INPUT);if(!e)return;let i=$(this).val(),s=l.find(HU.attrSelect(ATTR_TEXT_INPUT,e));if(!Utils.stringDefined(i))return void(0!=s.length&&s.remove());let r=e+"="+i;0==s.length?(s=a(ATTR_TEXT_INPUT,e,r),s.click((()=>{console.log("clear"),$(this).val(""),t.submitSearchForm()}))):s.html(r)}));for(let e=0;e<s.length;e++){let t=s[e];if(!t.getCanSearch())continue;let r=ID_COLUMN+t.getName(),o=t.getSearchArg(),n=l.find(HU.attrSelect("column",t.getName()));if(t.isNumeric()){this.jq(r+"_expr").val();let e=this.jq(r+"_from").val(),s=this.jq(r+"_to").val();if(Utils.stringDefined(e)||Utils.stringDefined(s)){let l=(Utils.stringDefined(e)?e+" &lt; ":"")+t.getLabel()+(Utils.stringDefined(s)?" &lt; "+s:"");0==n.length?(n=a("column",t.getName(),l),n.click((()=>{this.jq(r+"_from").val(""),this.jq(r+"_to").val(""),this.submitSearchForm()}))):n.html(l),Utils.stringDefined(e)&&(i+="&"+o+"_from="+encodeURIComponent(e)),Utils.stringDefined(s)&&(i+="&"+o+"_to="+encodeURIComponent(s))}else n.remove()}else if(t.isLatLon()){if(t.areaWidget){let e=t.areaWidget.getValues();["north","west","south","east"].forEach((t=>{Utils.stringDefined(e[t])&&(i+="&"+o+"_"+t+"="+encodeURIComponent(e[t].trim()))})),t.areaWidget.getContains()&&(i+="&"+o+"_areamode=contains")}}else if(t.isEnumeration()&&t.showCheckboxes()){let e=this.getDomId(ID_COLUMN+t.getName()),s=[],l=$("[checkbox-id="+e+"]");l.each((function(){if(HU.isChecked($(this))){let e=$(this).attr(ATTR_DATA_VALUE);i+="&"+o+"="+encodeURIComponent(e),s.push(e)}})),s.length>0?(label=t.getLabel()+"="+Utils.join(s," or "),0==n.length?(n=a("column",t.getName(),label),n.click((()=>{l.prop("checked",!1),this.submitSearchForm()}))):n.html(label)):n.remove()}else if(t.isDate());else if(t.isEntry()){let e=this.jq(r+"_hidden").val(),s=this.jq(r).val();Utils.stringDefined(e)?(i+="&"+o+"="+encodeURIComponent(e),0==n.length?(n=a("column",t.getName(),t.getLabel()+"="+s),n.click((()=>{let e=this.jq(r);e.data&&e.data("selectBox-selectBoxIt")?e.data("selectBox-selectBoxIt").selectOption(VALUE_NONE):e.val(null),this.submitSearchForm()}))):n.remove()):n.remove()}else{let e=this.jq(r).val();if(null==e||e==VALUE_NONE){n.remove();continue}if(Array.isArray(e)||(e=[e]),0==e.length){n.remove();continue}if((t.getType()==COLUMN_TYPE_STRING||t.getType()==COLUMN_TYPE_LIST||t.isDate()||t.isLatLon())&&""==e){n.remove();continue}let s=t.getLabel()+"=";Array.isArray(e)?s+=Utils.join(e,"&nbsp;|&nbsp;"):s+=e,0==n.length?(n=a("column",t.getName(),s),n.click((()=>{let e=this.jq(r);e.data&&e.data("selectBox-selectBoxIt")?e.data("selectBox-selectBoxIt").selectOption(VALUE_NONE):e.val(null),this.submitSearchForm()}))):n.html(s),e.forEach((e=>{i+="&"+o+"="+encodeURIComponent(e)}))}}this.dateWidgets.forEach((e=>{let t=e.column.getSearchArg(),s=e.widget.getStartEnd();Utils.stringDefined(s.start)&&(i+="&"+t+"_from="+encodeURIComponent(s.start)),Utils.stringDefined(s.end)&&(i+="&"+t+"_to="+encodeURIComponent(s.end))}));let r=this.getSearchSettings();l.find(HU.attrSelect("metadata")).remove(),r.metadata&&r.metadata.forEach((e=>{a("metadata",e.value,e.label+"="+e.value).click((()=>{let t=this.getMetadataFieldId(e.type)+"_select_"+e.index,i=jqid(t);i.find('option[value="'+e.value+'"]').prop("selected",!1),i.trigger("change")}))})),r.setMax(this.jq(ID_SEARCH_MAX).val()??r.getMax()),r.setExtra(i);let o=e.getSearchUrl(r,OUTPUT_JSON);if(this.getMainAncestor()){let e=this.getMainAncestor();"this"==e&&(e=this.getProperty("entryId")),o+="&mainancestor="+e}let n=this.jq(ID_SEARCH_ANCESTORS_MENU).val();return n&&n.forEach((e=>{o=HU.url(o,ARG_ANCESTOR,e)})),this.getContents().find(".ramadda-displayentry-ancestor").each((function(){if(HU.isChecked($(this))){let e=$(this).attr("data-entryid");o=HU.url(o,ARG_ANCESTOR,e)}})),o},addAreaWidget(e){this.areaWidgets||(this.areaWidgets=[]),this.areaWidgets.push(e)},getSearchValue:function(e,t){let i=GuiUtils.getUrlArg(this.urlPrefix+e,null);return null==i?t:(i=i.replace(/\+/g," "),i)},loadAncestorsList:function(e){let t=[];e.forEach((e=>{t.push([e.getId(),e.getName()])}));let i=HU.select("",[ATTR_MULTIPLE,!0,ATTR_SIZE,4,ATTR_ID,this.domId(ID_SEARCH_ANCESTORS_MENU)],t);this.jq(ID_SEARCH_ANCESTORS).html(HU.div([ATTR_CLASS,"display-search-ancestors"],i)),HU.makeSelectTagPopup(this.jq(ID_SEARCH_ANCESTORS_MENU),{after:!1,single:!1,hide:!1,label:"Select"}),this.jq(ID_SEARCH_ANCESTORS_MENU).change((()=>{this.submitSearchForm()}))},loadAncestors:function(e){let t=HU.url(RamaddaUtil.getUrl("/wiki/getentries"),"entries",e);new EntryList(this.getRamadda(),t,this,!1).doSearch(null,(e=>{this.loadAncestorsList(e.getEntries())}),(e=>{console.log(e)}))},makeSearchForm:function(){let e=this.getToggleClose(!this.getProperty("searchOpen",!0)),t=HU.openTag(TAG_FORM,[ATTR_ID,this.getDomId(ID_FORM),"action","#"]),i=HU.getIconImage("fa-search",[ATTR_TITLE,LABEL_SEARCH]),s=[];i=LABEL_SEARCH;let l=HU.div([ATTR_STYLE,HU.css(CSS_MARGIN_BOTTOM,HU.px(4),CSS_MAX_WIDTH,HU.perc(80)),ATTR_ID,this.getDomId(ID_SEARCH),ATTR_CLASS,HU.classes(CLASS_BUTTON,"display-search-button",CLASS_CLICKABLE)],i),a="",r=(this.getSearchSettings(),this.isLayoutHorizontal());if(this.ramaddas.length>0){let e=HU.openTag(TAG_SELECT,[ATTR_ID,this.getDomId(ID_REPOSITORY),ATTR_CLASS,"display-repositories-select"]),t=RamaddaUtil.getCdnUrl("/icons/favicon.png");for(let i=0;i<this.ramaddas.length;i++){let s=this.ramaddas[i],l=[ATTR_TITLE,"",ATTR_VALUE,s.getId(),"data-iconurl",t];this.getRamadda().getId()==s.getId()&&(l.push("selected"),l.push(null));e+=HU.tag(TAG_OPTION,l,s.getName())}e+=HU.closeTag(TAG_SELECT),s.push(e)}this.providerMap={};let o=this.getPropertyProviders();if(null!=o)if(1==o.length)this.provider=o[0];else if(this.getShowProviders()){let e="",t=HU.getUrlArgument(ID_PROVIDERS),i={},l=[];if(this.getPropertyProviders().forEach((e=>{this.providerMap[e.id]=e;let s=e.id;Utils.isDefined(t)||(t=s);let a=e.name;a.length>40&&(a=a.substring(0,39)+"...");let r="";s==t&&(r+=" selected ");let o=e.category||"",n=i[o];null==n&&(l.push(o),i[o]="",n="");let h=e.icon;h&&(h=h.replace(/\${urlroot}/g,RamaddaUtil.getBaseUrl()),h=h.replace(/\${root}/g,RamaddaUtil.getBaseUrl()),r+=' data-iconurl="'+h+'" '),n+="<option  title='"+a+"' class=display-search-provider "+r+' value="'+s+'">'+a+"</option>\n",i[o]=n})),1==l.length)e+=i[l[0]];else for(let t=0;t<l.length;t++){let s=l[t];""!=s&&(e+='<optgroup label="'+s+'">\n'),e+=i[s],""!=s&&(e+="</optgroup>")}let a=[ATTR_STYLE,HU.css(),ATTR_ID,this.getDomId(ID_PROVIDERS),ATTR_CLASS,"display-search-providers"];if(this.getProvidersMultiple()){let e=Math.min(8,o.length+1);a.push(ATTR_SIZE,this.getProvidersMultipleSize(e),ATTR_MULTIPLE,"true")}let r=HU.tag(TAG_SELECT,a,e);r=this.addWidget("Providers",r,{toggleClose:!0,addToggle:!0,searchWidgetClass:this.getProvidersMultiple()?"display-search-widget-providers":""}),s.push(r)}else this.provider=o[0];this.typeList=null,this.getEntryTypes()&&(this.typeList=this.getEntryTypes().split(",")),this.urlPrefix="search.",this.typeList&&this.typeList.length>0&&(this.urlPrefix+=this.typeList[0]+"."),this.getShowType()&&(null==this.typeList||0==this.typeList.length?s.push(HU.div([ATTR_STYLE,HU.css(CSS_MARGIN_BOTTOM,HU.px(4)),ATTR_ID,this.getDomId(ID_TYPE_DIV)],HU.span([ATTR_CLASS,"display-loading"],"Loading types..."))):a+=HU.div([ATTR_STYLE,HU.css(CSS_MARGIN_BOTTOM,HU.px(4)),ATTR_ID,this.getDomId(ID_TYPE_DIV)]));let n=this.getFormText();Utils.stringDefined(n)||(n=HU.getUrlArgument(ID_TEXT_FIELD));let h=HU.classes(CLASS_SIMPLESEARCH_INPUT,CLASS_SEARCH_TEXTINPUT),d=[ATTR_PLACEHOLDER,this.getEgText("Search text"),ATTR_TITLE,Utils.noMsg("e.g. name:, contents:,path:"),ATTR_CLASS,h,ATTR_ID,this.domId(ID_TEXT_FIELD)],g=[ATTR_CLASS,h];this.getInputSize()?(g.push(ATTR_SIZE),g.push(this.getInputSize())):(g.push(ATTR_STYLE),g.push(HU.css(CSS_WIDTH,HU.perc(100),CSS_MIN_WIDTH,HU.px(50),CSS_MAX_WIDTH,HU.px(300))));let p="",c="";t+=HU.center(l),s.length>0&&(r?(t+=s[0],c+=HU.join(s.slice(1),"")):(s=s.map((e=>HU.div([ATTR_STYLE,HU.css(CSS_MARGIN_RIGHT,HU.px(8))],e))),t+=HU.br(),t+=HU.hrow(...s)));let u=this.getAncestors();if(u&&(a+=this.addWidget(this.getAncestorsLabel("Search Under"),HU.div([ATTR_ID,this.domId(ID_SEARCH_ANCESTORS)]),{toggleClose:!0}),setTimeout((()=>{this.loadAncestors(u)}),1)),this.getShowAncestorSelector(this.getProperty("showAncestor",!0))){let e=HU.getUrlArgument(ID_ANCESTOR)??this.getProperty("ancestor"),t=HU.getUrlArgument(ID_ANCESTOR_NAME)??this.getProperty("ancestorName"),i=this.domId(ID_ANCESTOR),s=HU.span([ATTR_TITLE,"Clear selection",ATTR_CLASS,CLASS_CLICKABLE,ATTR_ID,this.domId(ID_ANCESTOR+"_clear")],HU.getIconImage(ICON_ERASER)),l=HU.input("",t??"",[ATTR_READONLY,null,ATTR_PLACEHOLDER,"Select",ATTR_STYLE,HU.css(CSS_CURSOR,CURSOR_POINTER,CSS_WIDTH,HU.perc(100)),ATTR_ID,i,ATTR_CLASS,"ramadda-entry-popup-select  disabledinput"]);a+=HU.hidden("",e??"",[ATTR_ID,i+"_hidden"]),l=HU.hbox([l,s]),a+=this.addWidget("Search Under",HU.div([ATTR_ID,this.domId(ID_SEARCH_ANCESTOR)],l),{toggleClose:!Utils.stringDefined(e)})}let T=[],f=HU.input("",n,Utils.mergeLists([ATTR_TEXT_INPUT,"Text"],d,g));this.getShowText()&&T.push(f),this.getShowName()&&T.push(HU.input("","",Utils.mergeLists([ATTR_TEXT_INPUT,"Name",ATTR_ID,this.domId(ID_NAME_FIELD),ATTR_PLACEHOLDER,"Name"],g))),this.getShowDescription()&&T.push(HU.input("","",Utils.mergeLists([ATTR_TEXT_INPUT,"Description",ATTR_ID,this.domId(ID_DESCRIPTION_FIELD),ATTR_PLACEHOLDER,"Description"],g))),T.length&&(a+=this.addWidget("Text",Utils.join(T,HU.br()),{toggleClose:this.getProperty("textToggleClose",e)}));let y="";if(this.getShowDate()){this.dateRangeWidget=new DateRangeWidget(this,"date");let e=this.getLabel(this.getStartDateLabel());Utils.stringDefined(e)?a+=this.addWidget(e,HU.div([ATTR_ID,this.domId(ID_SEARCH_DATE_RANGE)],this.dateRangeWidget.getHtml())):y+=this.dateRangeWidget.getHtml()}if(this.getShowCreateDate()){let e=this.getLabel(this.getCreateDateLabel());this.createdateRangeWidget=new DateRangeWidget(this,"createdate"),Utils.stringDefined(e)?a+=this.addWidget(e,HU.div([ATTR_ID,this.domId(ID_SEARCH_DATE_CREATE)],this.createdateRangeWidget.getHtml())):y+=HU.div([ATTR_STYLE,HU.css(CSS_MARGIN_TOP,HU.px(4))],this.createdateRangeWidget.getHtml())}if(this.getShowChangeDate()){let e=this.getLabel(this.getChangeDateLabel());this.changedateRangeWidget=new DateRangeWidget(this,"changedate"),Utils.stringDefined(e)?a+=this.addWidget(e,HU.div([ATTR_ID,this.domId(ID_SEARCH_DATE_CHANGE)],this.changedateRangeWidget.getHtml())):y+=HU.div([ATTR_STYLE,HU.css(CSS_MARGIN_TOP,HU.px(4))],this.changedateRangeWidget.getHtml())}if(Utils.stringDefined(y)&&(a+=this.addWidget("Date",y,{toggleClose:this.getProperty("dateToggleClose",e)})),this.getShowArea()){let e=this.getLabel(this.getAreaLabel("Geographic Location")),t=new AreaWidget(this);this.addAreaWidget(t),a+=this.addWidget(e,HU.div([ATTR_ID,this.domId(ID_SEARCH_AREA)],t.getHtml()),{toggleClose:this.getProperty("areaToggleClose",!0)})}if(a+=HU.div([ATTR_ID,this.getDomId(ID_TYPEFIELDS)],""),Utils.stringDefined(this.getMetadataTypes())){let t="";for(let i=0;i<this.metadataTypeList.length;i++){let s=this.metadataTypeList[i],l=(s.getValue(),HU.div([ATTR_CLASS,"display-search-metadata-block"],HU.div([ATTR_CLASS,"display-search-metadata-block-inner",ATTR_ID,this.getMetadataFieldId(s)])));t+=this.addWidget(s.getLabel(),l,{toggleClose:e})}a+=HU.div([ATTR_ID,this.domId(ID_SEARCH_TAGS)],t)}let m="#"+Utils.msgLabel("Records");return a+=HU.div([ATTR_STYLE,HU.css(CSS_MARGIN_TOP,HU.em(1),CSS_BORDER_TOP,CSS_BASIC_BORDER),ATTR_CLASS,"display-search-widget"],HU.b(m)+" "+HU.input("",DEFAULT_MAX,[ATTR_CLASS,CLASS_SIMPLESEARCH_INPUT,ATTR_ID,this.domId(ID_SEARCH_MAX),ATTR_SIZE,5])),p+=c,c="",p+=HU.div([ATTR_CLASS,"display-search-extra",ATTR_ID,this.getDomId(ID_SEARCH_SETTINGS)],HU.div([ATTR_CLASS,"display-search-extra-inner"],a)),p+=HU.open(TAG_INPUT,[ATTR_TYPE,"submit",ATTR_STYLE,HU.css(CSS_POSITION,POSITION_ABSOLUTE,CSS_LEFT,HU.px(-9999),CSS_WIDTH,HU.px(1),CSS_HEIGHT,HU.px(1))]),this.getFormHeight()&&(p=HU.div([ATTR_STYLE,HU.css(CSS_OVERFLOW_Y,OVERFLOW_AUTO,CSS_MAX_HEIGHT,HU.getDimension(this.getFormHeight()))],p)),Utils.stringDefined(c)&&(t+=HU.div([ATTR_CLASS,"display-search-extra"],c)),t+=p,t+=HU.closeTag(TAG_FORM),t},getEgText:function(e){return e=this.getProperty(ATTR_PLACEHOLDER,e||LABEL_SEARCH),this.eg&&(e=" "+this.eg),e},getFormText:function(){let e=this.getSearchSettings().text;if(null==e){e=Utils.getUrlArgs(document.location.search).text}return null==e&&(e=this.getSearchText()),e},handleEventMapBoundsChanged:function(e,t){this.areaWidgets&&this.areaWidgets.forEach((i=>{i.handleEventMapBoundsChanged(e,t)}))},typeChanged:function(){this.jq(ID_SEARCH_BAR).find("[column]").remove();let e=this.getSearchSettings();e.skip=0,e.setMax(DEFAULT_MAX);let t=this.getFieldValue(this.getDomId(ID_TYPE_FIELD),e.entryType);e.entryType=t,e.clearAndAddType(e.entryType),this.addExtraForm(),HU.handleNewContent(this.jq(ID_TYPEFIELDS)),this.submitSearchForm()},initMetadata:function(){this.metadata={},this.metadataList=[],this.metadataLoading={};for(let e=0;e<this.metadataTypeList.length;e++){let t=this.metadataTypeList[e];this.addMetadata(t,null)}},makeMetadata:function(e,t){return t.getElements||(t=new DisplayEntryMetadata(this,e,t),this.metadata[e.getType()]=t,this.metadataList.push(t)),t},addMetadata:function(e,t){let i=this;if(null==t&&(t=this.metadata[e.getType()]),null==t&&(this.metadataLoading[e.getType()]||(this.metadataLoading[e.getType()]=!0,t=this.getRamadda().getMetadataCount(e,(function(e,t){t&&!t.undefined&&i.addMetadata(e,t)})))),null==t)return;if(this.metadata=t=this.makeMetadata(e,t),!t.getElements())return;this.metadataBoxes||(this.metadataBoxes={}),this.metadataBoxes[e.getType()]={};let s=jqid(this.getMetadataFieldId(e));s.html(""),this.idToElement={};let l=function(){let t=$(this).attr("metadata-not"),s=$(this).attr(ATTR_METADATA_VALUE),l=($(this).attr(ATTR_METADATA_TYPE),$(this).attr(ATTR_METADATA_INDEX),HU.isChecked($(this))),a=$(this),r=i.idToElement[$(this).attr(ATTR_ID)];if(l){r&&r.setCbxOn((t?"!":"")+s);let l=e.getLabel();i.addMetadataTag(e.getType(),l,s,a,t)}else{r&&r.setCbxOff((t?"!":"")+s);let l=Utils.makeId(i.domId(ID_SEARCH_TAG)+"_"+e.getType()+"_"+s);jqid(l).remove()}i.submitSearchForm()},a=t.getElements().length>1;t.getElements().forEach((t=>{if("string"==t.getType()){let e=function(){i.submitSearchForm()};return void s.append(t.makeInput()).change(e)}if(!t.getValues())return;let r=this.getTagPopupLimit(),o=t.makeCheckboxes(i.idToElement,!a);if(a){if(t.select){let e=s.append(t.select);t.menu=e,e.change((()=>{i.submitSearchForm()}))}}else if(o.length>1||o.length>r)if(t.select){let e=$(t.select).appendTo(s);t.menu=e,HU.makeSelectTagPopup(e,{hide:!1,label:t.getName()}),e.change((()=>{i.submitSearchForm()}))}else s.append(HU.div([],"Select")).button().click((function(){let s=t.makeCheckboxes(i.idToElement);i.createTagDialog(s,$(this),l,e.getType(),e.getLabel())}));else s.append(Utils.wrap(o,"",HU.br()))})),s.find(":checkbox").change(l),HU.handleNewContent(s)},metadataTagSelected:function(e,t){let i=ID_SEARCH_TAG_GROUP+"_"+e;return this.jq(i).find(HU.attrSelect(ATTR_METADATA_TYPE,e)+HU.attrSelect(ATTR_METADATA_VALUE,t)).length>0},addMetadataTag:function(e,t,i,s,l){let a=this,r=s?s.attr(ATTR_ID):"unknowncbx",o=ID_SEARCH_TAG_GROUP+"_"+e,n=a.jq(o);if(this.metadataTagSelected(e,i))return!1;let h=Utils.makeId(a.domId(ID_SEARCH_TAG)+"_"+e+"_"+i);0==n.length&&(n=$(HU.div([ATTR_CLASS,"display-search-tag-group",ATTR_ID,a.domId(o)])).appendTo(a.jq(ID_SEARCH_BAR)));let d=l?"Not ":"";return $(HU.div(["source-id",r,"metadata-not",l,ATTR_METADATA_TYPE,e,ATTR_METADATA_VALUE,i,ATTR_TITLE,t+":"+d+i,ATTR_CLASS,CLASS_SEARCH_TAG,ATTR_ID,h],d+i+SPACE+HU.getIconImage("fas fa-times"))).appendTo(n).click((function(){let e=a.idToElement[$(this).attr("source-id")],t=$(this).attr(ATTR_METADATA_VALUE);e&&t&&e.setCbxOff(t),$(this).remove(),s&&s.prop("checked",!1),a.submitSearchForm()})),!0},addSearchToTags:function(){return!1},typeSearchEnabled:function(){return this.jq(ID_TYPE_FIELD).length>0},typeTagClicked:function(e){HU.initSelect(this.jq(ID_TYPE_FIELD),{selectOption:e.getId()})},metadataTagClicked:function(e){if(!this.metadataBoxes)return;if(!this.metadataBoxes[e.type]||!this.metadataBoxes[e.type][e.value.attr1])return this.addMetadataTag(e.type,e.type,e.value.attr1,null),void this.submitSearchForm();let t=jqid(this.metadataBoxes[e.type][e.value.attr1]);HU.isChecked(t)||t.click()},getMetadataFieldId:function(e){let t=e.getType?e.getType():e;return t=t.replace(".","_"),this.getDomId(ID_METADATA_FIELD+t)},findEntryType:function(e){if(null==this.entryTypes)return null;for(let t=0;t<this.entryTypes.length;t++){let i=this.entryTypes[t];if(i.getId()==e)return i}return null},addTypes:function(e){if(null==e){let t=this.getAncestor(),i=null;t&&(i=HU.urlArg(ARG_ANCESTOR,t)),null==(e=this.getRamadda().getEntryTypes(((e,t)=>{this.addTypes(t)}),this.getEntryTypes(),i))&&(this.typesPending=!0)}if(null==e)return;if(this.entryTypes=e,this.getEntryTypes()){let e={};this.getEntryTypes().split(",").forEach((t=>{e[t]=!0}));let t=[];for(let i=0;i<this.entryTypes.length;i++){let s=this.entryTypes[i];(e[s.getId()]||null!=s.getCategory()&&e[s.getCategory()])&&t.push(s)}this.entryTypes=t}this.haveTypes=!0;let t=this.getProperty("addTypeCategory",!0)&&this.entryTypes.length>1,i=[],s={},l=HU.openTag(TAG_SELECT,[ATTR_ID,this.getDomId(ID_TYPE_FIELD),ATTR_CLASS,"display-typelist",ATTR_ONCHANGE,this.getGet()+".typeChanged();"]);this.getAddAllTypes()&&(l+=HU.tag(TAG_OPTION,[ATTR_TITLE,"",ATTR_VALUE,VALUE_ANY_TYPE],"Any type")),this.getAddAnyType()&&this.entryTypes.length>1&&(l+=HU.tag(TAG_OPTION,[ATTR_TITLE,"",ATTR_VALUE,""],this.getEntryTypes()?"Any of these types":"Any type"));let a=!1,r=!1,o=this.getStartWithAny(),n=HU.getUrlArgument(ID_TYPE_FIELD);this.entryTypes.every((e=>(r=this.getSearchSettings().hasType(e.getId()),n&&(r=e.getId()==n),!r)));let h={},d=this.getExcludeEmptyTypes(),g=this.getExcludeTypes(),p=null;g&&(p={},Utils.split(g,",",!0,!0).forEach((e=>{p[e]=!0})));for(let e=0;e<this.entryTypes.length;e++){let l=this.entryTypes[e];if(h[l.getId()])continue;if(h[l.getId()]=!0,d&&0==l.getEntryCount())continue;if(p&&p[l.getId()])continue;let g=l.getIcon(),c=[ATTR_TITLE,l.getLabel(),ATTR_VALUE,l.getId(),ATTR_CLASS,"display-typelist-type","data-iconurl",g],u=this.getSearchSettings().hasType(l.getId());u||n&&(u=l.getId()==n),u||r||0!=e||o||(u=!0),u&&(a=!0,c.push("selected"),c.push(null));let T=l.getLabel();l.getEntryCount()>0&&(T+=" ("+l.getEntryCount()+")");let f=HU.tag(TAG_OPTION,c,T);null==s[l.getCategory()]&&(t&&(s[l.getCategory()]=HU.tag(TAG_OPTION,[ATTR_CATEGORY,"true",ATTR_CLASS,"display-typelist-category",ATTR_TITLE,"",ATTR_VALUE,""],l.getCategory())),i.push(l.getCategory())),s[l.getCategory()]+=f}for(let e in i)l+=s[i[e]];if(l+=HU.closeTag(TAG_SELECT),0==this.entryTypes.length);else{{let e=this.getProperty("typesToggleClose",this.getToggleClose());this.writeHtml(ID_TYPE_DIV,this.addWidget(this.getProperty("typesLabel","Types"),l,{toggleClose:e}))}}HU.initSelect(this.jq(ID_TYPE_FIELD),{autoWidth:!1,"max-height":HU.px(100)}),HU.makeSelectTagPopup(this.jq(ID_TYPE_FIELD),{showCategories:!0,icon:!0,after:!0,single:!0,hide:!1,label:$(this).attr("data-label")}),this.addExtraForm(),this.typesPending=!1,this.submitSearchForm()},getSelectedType:function(){if(null==this.entryTypes)return null;if(1==this.entryTypes.length)return this.entryTypes[0];for(let e=0;e<this.entryTypes.length;e++){let t=this.entryTypes[e];if(t.getId&&this.getSearchSettings().hasType(t.getId()))return t}let e=this.getFieldValue(this.getDomId(ID_TYPE_FIELD),null);if(e)for(let t=0;t<this.entryTypes.length;t++){let i=this.entryTypes[t];if(i.getId&&e==i.getId())return i}return null},getSearchableColumns:function(){let e=[],t=this.getSelectedType();if(null==t)return e;let i=t.getColumns();if(null==i)return e;let s=null,l=this.getShowColumns();Utils.stringDefined(l)&&Utils.split(this.getShowColumns(),",",!0,!0).forEach((e=>{s||(s={}),s[e]=!0}));for(let t=0;t<i.length;t++){let l=i[t];s&&!s[l.getName()]||l.getCanSearch()&&e.push(l)}return e},makeLabel:function(e){return e=this.getLabel(e),Utils.stringDefined(e)?HU.div([ATTR_CLASS,"display-search-label"],e):""},getLabel:function(e){return e?(e.getSearchLabel&&(e=e.getSearchLabel()),e?e=e.trim():""):""},addExtraForm:function(){this.dateWidgets=[];let e=this.getTagPopupLimit(),t=this.getColumnsToggleClose(this.getToggleClose(!this.getProperty("searchOpen",!0)));null==this.savedValues&&(this.savedValues={});let i="",s=this.getSearchableColumns(),l=null,a=!1;for(let r=0;r<s.length;r++){let o=s[r];if(null!=this.getProperty("fields")&&this.getProperty("fields").indexOf(o.getName())<0)continue;let n=o.getSearchGroup();if(Utils.stringDefined(n)&&n!=l){a&&(i+=HU.close(TAG_DIV)+HU.open(TAG_DIV)),a=!0,l=n;let e=HU.getUniqueId("");i+=HU.open(TAG_DIV,[ATTR_CLASS,"display-search-group"]);let s=this.addToggle(n,e,t);i+=HU.div([ATTR_CLASS,"display-search-group-label"],s),i+=HU.open(TAG_DIV,[ATTR_CLASS,"display-search-widgets",ATTR_ID,e,ATTR_STYLE,HU.css(CSS_DISPLAY,t?DISPLAY_NONE:DISPLAY_BLOCK)])}let h="",d=this.getDomId(ID_COLUMN+o.getName()),g=this.savedValues[d];null==g&&(g=this.jq(ID_COLUMN+o.getName()).val());let p="",c="",u="";if(o.isEnumeration()){let t=o.showCheckboxes(),i=this.getProperty(o.getName()+".showCheckboxes");null!=i&&(t="true"==String(i));let s=this.getShowSearchLabels(),l=o.getValues(),a=this.getSearchValue(o.getName());if(t)for(let e in l){let t=l[e].value||"";""==t&&(t="--blank--");let i=l[e].label.trim();"&lt;blank&gt;"==i&&(i="--blank--"),""==i&&(i="--blank--");let s=d+"_"+e;h+=HU.div([],HU.checkbox(s,[ATTR_CLASS,"display-entrylist-enum-checkbox",ATTR_ID,s,"checkbox-id",d,ATTR_DATA_VALUE,t],t==a,i))}else{let t="display-metadatalist",i=[ATTR_ID,d],r=[ATTR_CLASS,"display-metadatalist-item",ATTR_TITLE,"",ATTR_VALUE,VALUE_NONE];l.length>=e||o.getSearchMultiples()?(i.push(ATTR_MULTIPLE,"true"),i.push(ATTR_SIZE,4)):t="display-searchmenu "+t,i.push(ATTR_CLASS,t),i.push("data-label",o.getLabel()),h=HU.openTag(TAG_SELECT,i),h+="\n",o.getSearchMultiples()||(h+=HU.tag(TAG_OPTION,r,s?"-- Select --":o.getSearchLabel())),h+="\n";for(let e in l){let t=l[e].value||"",i="";t!==g&&t!==a||(i=" selected "),""==t&&(t="--blank--");let s=l[e].label.trim();"&lt;blank&gt;"==s&&(s="--blank--"),""==s&&(s="--blank--"),h+=HU.tag(TAG_OPTION,[ATTR_CLASS,"display-metadatalist-item",ATTR_TITLE,s,ATTR_VALUE,t,i,null],s),h+="\n"}h+=HU.closeTag(TAG_SELECT)}s?(c=this.getLabel(o),p=h+u):p=HU.div([ATTR_CLASS,"display-search-block"],h+u)}else if(o.isNumeric()){let e=HU.input("","",[ATTR_TITLE,"greater than",ATTR_CLASS,HU.classes(CLASS_INPUT,CLASS_SIMPLESEARCH_INPUT),ATTR_STYLE,HU.css(CSS_WIDTH,HU.em(2.5)),ATTR_ID,d+"_from"]),t=HU.input("","",[ATTR_TITLE,"less than",ATTR_CLASS,HU.classes(CLASS_INPUT,CLASS_SIMPLESEARCH_INPUT),ATTR_STYLE,HU.css(CSS_WIDTH,HU.em(2.5)),ATTR_ID,d+"_to"]);c=o.getSearchLabel(),p=e+" - "+t+u}else if(o.isLatLon()){let e=o.areaWidget=new AreaWidget(this,o.getName());c=this.makeLabel(o.getSearchLabel()),p=HU.div([ATTR_ID,this.domId(o.getName())],e.getHtml())}else if(o.getType()==COLUMN_TYPE_STRING||o.getType()==COLUMN_TYPE_LIST)h=HU.input("",g??this.getSearchValue(o.getName()),[ATTR_PLACEHOLDER,o.getSearchLabel(),ATTR_CLASS,HU.classes(CLASS_INPUT,CLASS_SIMPLESEARCH_INPUT),ATTR_SIZE,this.getTextInputSize(),ATTR_ID,d]),c=o.getSearchLabel(),p=h+" "+u;else if(o.isDate()){c=o.getSearchLabel();let e=new DateRangeWidget(this,o.getName(),c+" start",c+" end");this.dateWidgets.push({widget:e,column:o}),p=e.getHtml()}else if(o.isEntry()){o.getName();let e=HU.href("javascript:void(0);",HU.getIconImage(ICON_ERASER),[ATTR_ONCLICK,"RamaddaUtils.clearSelect("+HU.squote(d)+");",ATTR_TITLE,"Clear selection"]),t=HU.input("","",[ATTR_READONLY,null,ATTR_PLACEHOLDER,"Select",ATTR_STYLE,HU.css(CSS_CURSOR,CURSOR_POINTER,CSS_WIDTH,HU.perc(100)),ATTR_ID,d,ATTR_CLASS,"ramadda-entry-popup-select  disabledinput"]);c=o.getSearchLabel(),p=HU.hidden("","",[ATTR_ID,d+"_hidden"]),p+=HU.div([ATTR_ID,this.domId(ID_SEARCH_ANCESTOR)],HU.leftRightTable(e,t,HU.perc(10),HU.perc(90)))}else console.log("unknown column type:",o.getName(),o.getType());let T=!a,f=this.getProperty(o.getName()+".toggleClose",this.getToggleClose());Utils.isDefined(f)&&(T="true"==String(f)),t||(T=!1),i+=this.addWidget(c,p,{addToggle:!a,addSimpleToggle:a,toggleClose:T})}a&&(i+=HU.close(TAG_DIV,TAG_DIV)),this.writeHtml(ID_TYPEFIELDS,i),this.dateWidgets.forEach((e=>{e.widget.initHtml()})),s.forEach((e=>{if(e.isEntry()){let t=this.getDomId(ID_COLUMN+e.getName());jqid(t).click((i=>{let s=this.getRamadda().getRoot();RamaddaUtils.selectInitialClick(i,t,t,!0,null,null,e.entrytype,s,{title:"Select "+e.getLabel()})}))}})),this.jq(ID_TYPEFIELDS).find(".display-metadatalist").each((function(){$(this).find(TAG_OPTION).length<e||HU.makeSelectTagPopup($(this),{hide:!1,label:$(this).attr("data-label")})}));this.jq(ID_TYPEFIELDS).find(".ramadda-expr").change((function(){let e=$(this).attr(ATTR_ID),t=$(this).val();e=e.replace("_expr","_to"),"between"==t?jqid(e).show():jqid(e).hide()})),this.jq(ID_TYPEFIELDS).find(".display-entrylist-enum-checkbox").change((()=>{this.submitSearchForm()}));let r=this.jq(ID_TYPEFIELDS).find(".display-searchmenu");HU.initSelect(r),this.jq(ID_TYPEFIELDS).find(".display-metadatalist").change((()=>{this.submitSearchForm()})),s.forEach((e=>{e.areaWidget&&e.areaWidget.initHtml()}))},getEntries:function(){return null==this.entryList?[]:this.entryList.getEntries()},loadNextUrl:function(){let e=+this.getSearchSettings().skip+parseInt(this.getSearchSettings().getMax());this.getSearchSettings().skip=e,this.submitSearchForm()},loadMore:function(){this.getSearchSettings().setMax(parseInt(this.getSearchSettings().getMax())+DEFAULT_MAX),this.jq(ID_SEARCH_MAX).val(this.getSearchSettings().getMax()),this.submitSearchForm()},loadLess:function(){let e=this.getSearchSettings().getMax();e=parseInt(.75*e),this.getSearchSettings().setMax(Math.max(1,e)),this.jq(ID_SEARCH_MAX).val(this.getSearchSettings().getMax()),this.submitSearchForm()},loadPrevUrl:function(){this.getSearchSettings().skip=Math.max(0,this.getSearchSettings().skip-this.getSearchSettings().getMax()),this.submitSearchForm()},entryListChanged:function(e){this.entryList=e}})}function RamaddaSearchDisplay(e,t,i,s){null==s&&(s=DISPLAY_SEARCH);const l=new RamaddaSearcherDisplay(e,t,s,i);defineDisplay(addRamaddaDisplay(this),l,[],{haveDisplayed:!1,selectedEntries:[],getSelectedEntries:function(){return this.selectedEntries},initDisplay:function(){let e=this;this.getIsLayoutFixed()&&this.haveDisplayed||(this.haveDisplayed=!0,this.createUI(),this.setContents(this.getDefaultHtml()),this.initHtml(),this.providerChanged(!0),this.dateRangeWidget&&this.dateRangeWidget.initHtml(),this.createdateRangeWidget&&this.createdateRangeWidget.initHtml(),this.changedateRangeWidget&&this.changedateRangeWidget.initHtml(),l.initDisplay.apply(this),null!=this.entryList&&this.entryList.haveLoaded&&this.entryListChanged(this.entryList),this.getProvidersMultiple()||HU.initSelect(this.jq(ID_PROVIDERS),{multiple:!0,autoWidth:!1,"max-height":HU.px(100)}),this.jq(ID_PROVIDERS).change((function(){e.providerChanged()})))},providerChanged:function(e){if(0==this.jq(ID_PROVIDERS).length)return;!e&&this.jq(ID_ANCESTOR).val&&(this.jq(ID_ANCESTOR).val(""),this.jq(ID_ANCESTOR+"_hidden").val("")),this.getSearchSettings().skip=0;let t=this.jq(ID_PROVIDERS).val();this.provider=this.providerMap[t],Utils.stringDefined(t)&&"this"!=t&&this.addToDocumentUrl(ID_PROVIDERS,t),this.jq(ID_SEARCH_BAR).html("");let i=[ID_SEARCH_AREA,ID_SEARCH_TAGS,ID_SEARCH_ANCESTOR,ID_SEARCH_DATE_CREATE,ID_SEARCH_DATE_RANGE];if(this.provider&&"ramadda"!=this.provider.type){this.setRamadda(this.originalRamadda),(this.provider.capabilities||"").split(",").forEach((e=>{let t=i.indexOf("search_"+e);t>=0&&i.splice(t,1)})),i.forEach((e=>{this.jq(e).hide()})),this.jq(ID_TYPE_DIV).hide()}else i.forEach((e=>{this.jq(e).show()})),this.jq(ID_TYPE_DIV).show(),this.getSearchDirect()&&(this.provider&&this.setRamadda(getRamadda(this.provider.id+";"+this.provider.name)),this.addTypes(),this.initMetadata())},getMenuItems:function(e){if(l.getMenuItems.apply(this,e),this.getSelectedEntriesFromTree().length>0){let t=this.getGet();e.push(HU.onClick(t+".makeDisplayList();","Make List")),e.push(HU.onClick(t+".makeDisplayGallery();","Make Gallery"))}},makeDisplayList:function(){let e=this.getSelectedEntriesFromTree();if(0==e.length)return;let t={selectedEntries:e,showForm:!1,showMenu:!0,fixedEntries:!0};t.entryList=new EntryList(this.getRamadda(),"",this,!1),t.entryList.setEntries(e),this.getDisplayManager().createDisplay(DISPLAY_ENTRYLIST,t)},makeDisplayGallery:function(){let e=this.getSelectedEntriesFromTree();if(0==e.length)return;let t={selectedEntries:e},i=this.getEgText(),s=this.getFormText();HU.input("",s,[ATTR_PLACEHOLDER,i,ATTR_CLASS,"display-search-input",ATTR_SIZE,"30",ATTR_ID,this.getDomId(ID_TEXT_FIELD)]);this.getDisplayManager().createDisplay(DISPLAY_ENTRY_GALLERY,t)},handleEventEntrySelection:function(e,t){this.selectEntry(t.entry,t.selected)},selectEntry:function(e,t){let i=!1;if(t){this.jq("entry_"+e.getIdForDom()).addClass("ui-selected"),this.selectedEntries.indexOf(e)<0&&(this.selectedEntries.push(e),i=!0)}else{this.jq("entry_"+e.getIdForDom()).removeClass("ui-selected");let t=this.selectedEntries.indexOf(e);t>=0&&(this.selectedEntries.splice(t,1),i=!0)}},makeEntriesDisplay:function(e){this.tabId=null,this.mapId=null,this.myDisplays&&this.myDisplays.forEach((e=>{e.display&&removeRamaddaDisplay(e.display.getId())})),this.myDisplays=[];let t=[],i=[],s=e=>{i.push(HU.div([ATTR_CLASS,"display-entrylist-results"],e))},l=e=>(e=HU.div([ATTR_STYLE,HU.css(CSS_MAX_HEIGHT,HU.px(1e3),CSS_BACKGROUND,COLOR_WHITE,CSS_OVERFLOW_Y,OVERFLOW_AUTO)],e),HU.div([ATTR_CLASS,"ramadda-expandable-wrapper",ATTR_STYLE,HU.css(CSS_POSITION,POSITION_RELATIVE)],e));if(this.getDisplayTypes().split(",").forEach((i=>{if("list"==i)t.push("List"),s(l(this.getEntriesTree(e)));else if("images"==i){let a=this.getDefaultImage();if(e.filter((e=>!!a||e.getIsImage())).length>0){t.push("Images");let e=HU.getUniqueId(i+"_");this.myDisplays.push({id:e,type:i});let a=HU.div([ATTR_ID,e,ATTR_CLASS,"ramadda-expandable display-entrylist-images",ATTR_STYLE,HU.css(CSS_WIDTH,HU.perc(100))]);s(l(a))}}else if("timeline"==i){t.push("Timeline");let e=HU.getUniqueId(i+"_");this.myDisplays.push({id:e,type:i}),s(HU.div([ATTR_ID,e,ATTR_STYLE,HU.css(CSS_WIDTH,HU.perc(100))]))}else if("map"==i){if(this.areaEntries=e.filter((e=>e.hasBounds()||e.hasLocation())),this.areaEntries.length>0){t.push("Map");let e=HU.getUniqueId(i+"_");this.myDisplays.push({id:e,type:i,entries:this.areaEntries}),s(HU.div([ATTR_ID,e,ATTR_STYLE,HU.css(CSS_WIDTH,HU.perc(100))]))}}else if("display"==i){t.push("Details");let l=HU.getUniqueId(i+"_");this.myDisplays.push({id:l,type:"entrywiki",entries:e}),s(HU.div([ATTR_ID,l,ATTR_STYLE,HU.css(CSS_WIDTH,HU.perc(100))]))}else if("metadata"==i){t.push("Metadata");let i=HU.div([ATTR_STYLE,HU.css(CSS_WIDTH,HU.px(800),CSS_MAX_WIDTH,HU.px(800),CSS_OVERFLOW_X,OVERFLOW_AUTO)],this.getEntriesMetadata(e));s(i)}else console.log("unknown display:"+i)})),1==t.length)return HU.div([ATTR_CLASS,"display-entrylist-content-border"],i[0]);let a=HU.getUniqueId("tabs_"),r=HU.open(TAG_DIV,[ATTR_ID,a,ATTR_CLASS,"ui-tabs"]);return r+=HU.open(TAG_UL),t.forEach(((e,t)=>{r+=HU.tag(TAG_LI,[],HU.href("#"+a+"-"+t,e))})),r+=HU.close(TAG_UL),this.tabCount=i.length,i.forEach(((e,t)=>{r+=HU.div([ATTR_ID,a+"-"+t,ATTR_CLASS,"ui-tabs-hide"],e)})),r+=HU.close(TAG_DIV),this.tabId=a,r},handleSearchLink:function(e,t,i){let s=t.attr("data-copy");if(s)return Utils.copyToClipboard(s),void alert("The URL has been copied to the clipboard");let l=t.attr(ATTR_DATA_URL),a=t.attr("data-format"),r=t.attr(ATTR_DATA_NAME),o="100",n=t=>{if(l=l.replace(/max=\d+/,"max="+o),t&&(l+=t),e.shiftKey){let e=window.location.protocol,t=window.location.hostname,i=window.location.port;l=`${e}//${t}${i?`:${i}`:""}`+l,Utils.copyToClipboard(l),alert("The URL has been copied to the clipboard")}else Utils.triggerDownload(l)};if(o=this.jq(ID_SEARCH_MAX).val(),i)n();else if(a==OUTPUT_CHOOSE){let e=HU.formTable();e+=HU.formEntryLabel("Number of Records",HU.input("",o,[ATTR_ID,this.domId("downloadrecords"),ATTR_SIZE,5]));let i=[["xlsx","XLSX"],["csv","CSV"],["json","JSON"],["wget","wget File Download"],["csvapi","wget CSV API"],["ids","IDs"],["wrapper_r","R Wrapper"],["wrapper_python","Python Wrapper"],["wrapper_matlab","Matlab Wrapper"]];e+=HU.formEntryLabel("What to download",HU.select("",[ATTR_ID,this.domId("downloadwhat")],i));let s=HU.buttons([HU.div([ATTR_CLASS,HU.classes(CLASS_BUTTON_OK,CLASS_DISPLAY_BUTTON)],LABEL_OK),HU.div([ATTR_CLASS,HU.classes(CLASS_BUTTON_CANCEL,CLASS_DISPLAY_BUTTON)],LABEL_CANCEL)]);e+=HU.formTableClose(),e+=s,e=HU.div([ATTR_STYLE,HU.css(CSS_MARGIN,HU.px(5))],e);let l=HU.makeDialog({content:e,title:"Download options",anchor:t,draggable:!0,header:!0});l.find(HU.dotClass(CLASS_BUTTON_OK)).button().click((()=>{o=this.jq("downloadrecords").val(),what=this.jq("downloadwhat").val(),n("&what="+what),l.remove()})),l.find(HU.dotClass(CLASS_BUTTON_CANCEL)).button().click((()=>{l.remove()}))}else{if(o=prompt("How many records do you want in the "+r+" download?",o),!o)return;n()}},entryListChanged:function(e){this.multiSearch&&this.multiSearch.count--,l.entryListChanged.apply(this,[e]);let t=this.entryList.getEntries();if(0==t.length){this.getSearchSettings().setMax(DEFAULT_MAX);let e="Nothing found";this.multiSearch&&this.multiSearch.count>0&&(e="Nothing found so far. Still searching "+this.multiSearch.count+" repositories"),this.jq(ID_ENTRIES).html(this.getMessage(e)),this.getDisplayManager().handleEventEntriesChanged(this,[])}if(this.writeMessage(this.getResultsHeader(t)),0==t.length)return;this.getGet();if(null!=this.footerRight){let e=this;this.writeHtml(ID_SEARCH_FOOTER,this.footerRight),this.jq(ID_SEARCH_FOOTER).find(".ramadda-search-link").button().click((function(t){let i=$(this).attr("custom-output");e.handleSearchLink(t,$(this),i)}))}let i=this.makeEntriesDisplay(t);this.writeEntries(i,t),this.jq(ID_ENTRIES).find(".ramadda-metadata-bigtext").each((function(){Utils.initBigText($(this))})),this.addEntrySelect(),this.getDisplayManager().handleEventEntriesChanged(this,t),this.galleryId&&HU.createFancyBox(jqid(this.galleryId).find("a.popup_image"),{helpers:{title:{type:"over"}}});let s=(e,t)=>{this.activeTabIndex=t.newTab.index(),HU.tabLoaded()};if(this.tabId){let e=this.activeTabIndex;e>=this.tabCount&&(e=this.tabCount-1),jqid(this.tabId).tabs({activate:s,active:e})}if(this.myDisplays&&this.myDisplays.length){let e=0,i=[new RecordField({type:"string",index:e++,id:"name",label:"Name"}),new RecordField({type:"string",index:e++,id:"description",label:"Description"}),new RecordField({type:"date",index:e++,id:"date",label:"Date"}),new RecordField({type:"url",index:e++,id:"url",label:"URL"}),new RecordField({type:"image",index:e++,id:"image",label:"Image"}),new RecordField({type:"url",index:e++,id:"iconUrl",label:"Icon"}),new RecordField({type:"string",index:e++,id:"tags",label:"Tags"}),new RecordField({type:"string",index:e++,id:"display_html",label:"Display Html"}),new RecordField({type:"string",index:e++,id:"id",label:"Entry ID"}),new RecordField({index:e++,id:"latitude",label:"Latitude"}),new RecordField({index:e++,id:"longitude",label:"Longitude"})],s=null;this.entryTypes&&this.entryTypes.length&&(s=this.entryTypes[0],s.getColumns().forEach((t=>{i.push(new RecordField({index:e++,id:t.getName(),label:t.getLabel()}))})));let l=this.getDefaultImage();l&&(l.startsWith("http")||(l=RamaddaUtil.getUrl(l)));let a=e=>{let t=[];return e.forEach((e=>{let a=this.makeEntryTags(e,!0,""),r=e.displayHtml??e.getName(),o=[e.getName(!0),e.getSnippet()||"",e.getStartDate(),e.getEntryUrl(),e.getImageUrl()||l||"",e.getIconUrl(),a,r,e.getId(),e.getLatitude(),e.getLongitude()];s&&s.getColumns().forEach((t=>{let i=e.getAttributeValue(t.getName());o.push(i)})),t.push(new PointRecord(i,e.getLatitude(),e.getLongitude(),NaN,e.getStartDate()||e.getCreateDate(),o,0))})),t},r=new PointData("pointdata",i,a(t),null,null),o=this;this.myDisplays.forEach((e=>{let t=e.entries?new PointData("pointdata",i,a(e.entries)):r,l=this.getProperty("tooltip")??"${default}",n=null;"map"==e.type&&s&&s.mapwiki&&(n=(e,t)=>{if(t.length>1)return null;let i=HU.getUniqueId(),l=t[0].data[8];return this.wikify(s.mapwiki,l,null,null,i),HU.div([ATTR_ID,i],HU.center(HU.image(RamaddaUtil.getCdnUrl("/icons/mapprogress.gif"),[ATTR_WIDTH,HU.px(80)])))});let h={centerOnMarkersAfterUpdate:!0,entries:e.entries,dialogListener:(e,t)=>{t.find(HU.dotClass(CLASS_SEARCH_TAG)).click((function(){let e=$(this).attr(ATTR_METADATA_TYPE),t=$(this).attr(ATTR_METADATA_VALUE);o.addMetadataTag(e,e,t)&&o.submitSearchForm()}))},highlightColor:"#436EEE",blockStyle:this.getProperty("blockStyle",""),doPopup:this.getProperty("doPopup",!0),tooltip:l,tooltipClick:l,myTextGetter:n,descriptionField:"description",imageWidth:HU.px(140),blockWidth:HU.px(150),numberOfImages:500,includeNonImages:this.getProperty("includeNonImages",!0),showTableOfContents:!0,showTableOfContentsTooltip:!1,addMapLocationToUrl:!1,canMove:!0,iconField:"iconUrl",iconSize:16,displayEntries:!1,imageField:"image",urlField:"url",titleField:"name",labelField:"name",labelFields:"name",showBottomLabel:!1,bottomLabelTemplate:"",topLabelTemplate:"${name}",textTemplate:"${description}",displayId:e.id,divid:e.id,showMenu:!1,theData:t,displayStyle:"",mapHeight:"400",loadingMessage:""};e.display=this.getDisplayManager().createDisplay(e.type,h)}))}if(this.jq(ID_ENTRIES).find(".ramadda-expandable-wrapper").each((function(){HU.makeExpandable($(this),!1,{right:HU.px(5),top:HU.px(0)})})),this.mapId&&this.areaEntries&&this.areaEntries.length>0){let e=new RepositoryMap(this.mapId);e.initMap(!1),this.areaEntries.forEach((t=>{let i=HU.tag(TAG_A,[ATTR_TARGET,"_entries",ATTR_HREF,t.getEntryUrl()],t.getName()),s=i;t.getIsImage()&&(s=HU.image(t.getResourceUrl(),[ATTR_WIDTH,400,ATTR_ID,this.getDomId("entry_"+t.getIdForDom()),ATTR_ENTRYID,t.getId(),ATTR_CLASS,"display-entrygallery-entry"])+HU.br()+i),e.addMarker("",{x:t.getLongitude(),y:t.getLatitude()},t.getIconUrl(),"",s,null,16,0,!0,{})})),e.centerOnMarkersInit(null)}}})}function RamaddaSimplesearchDisplay(e,t,i){let s=this.simpleSearchProps=[{label:"Simple Search"},{p:"resultsPosition",ex:"absolute|relative"},{p:"maxHeight",ex:300},{p:"maxWidth",ex:200},{p:"maxWidth",ex:200},{p:"autoSearch",ex:!0},{p:"showHeader",ex:!0},{p:"inputSize",d:"200px",ex:"100%"},{p:"placeholder"},{p:"searchEntryType",ex:"",tt:"Constrain search to entries of this type"},{p:"doPageSearch",ex:"true",tt:"Just search in the page"},{p:"autoFocus",d:!1,ex:"false",tt:"auto focus on the search input field"},{p:"doTagSearch",ex:"true"},{p:"tagShowGroup",d:!0},{p:"tagSearchLimit",tt:"Show the inline search box for tags when the #tags exceeds the limit",d:15},{p:"pageSearchSelector",d:".search-component,.entry-list-row-data"},{p:"applyToEntries",ex:!0,tt:"When doing the entry search use the IDs to hide/show components"},{p:"pageSearchParent",ex:".class or #id",tt:"set this to limit the scope of the search"},{p:"showParent",ex:"true",tt:"Show parent entry in search results"}];i.width||(i.width=i.inputSize??HU.px(230));const l=new RamaddaSearcherDisplay(e,t,DISPLAY_SIMPLESEARCH,i);defineDisplay(addRamaddaDisplay(this),l,s,{callNumber:1,haveDisplayed:!1,selectedEntries:[],getWikiEditorTags:function(){return this.simpleSearchProps},getSelectedEntries:function(){return this.selectedEntries},getDoInlineSearch:function(){return this.getDoPageSearch()||this.getDoTagSearch()},initDisplay:function(){$(document).ready((()=>{this.initDisplayInner()}))},initDisplayInner:function(){let e=this;if(this.getIsLayoutFixed()&&this.haveDisplayed)return;this.haveDisplayed=!0,this.createUI();let t="";if(this.getDoTagSearch()){let i=this.getPageSearchSelectors();t+="<div class=metadata-tags>";let s={},l=[];i.find(".metadata-tag").each((function(){$(this).addClass(CLASS_CLICKABLE).click((function(){e.selectTag($(this).attr("metadata-tag"))}));let t=$(this).attr("metadata-tag");s[t]||(s[t]={group:$(this).attr("metadata-group"),tag:t,count:0,elements:[]},l.push(s[t])),s[t].count++,s[t].elements.push($(this))})),l=l.sort(((e,t)=>{if(e.group&&t.group){let i=e.group.localeCompare(t.group);if(0!=i)return i}return t.count-e.count}));let a={},r=[];l.forEach((e=>{let t=e.group??"",i=a[t];i||(i=a[t]={contents:"",cnt:0},r.push(t)),i.cnt++;let s=e.tag,l=e.elements[0];if(l.attr("data-image-url")){let e=l.attr(ATTR_TITLE)+HU.getTitleBr()??"";e+="Click to filter",i.contents+=HU.image(l.attr("data-image-url"),[ATTR_CLASS,HU.classes("metadata-tag",CLASS_CLICKABLE),"metadata-tag",s,ATTR_TITLE,e])}else{let t="#"+e.count+": "+s.replace(/^[^:]+:/,"");style=l.attr(ATTR_STYLE),i.contents+=HU.div(["data-background",l.attr("data-background"),"data-style",style??"",ATTR_STYLE,style??"",ATTR_CLASS,HU.classes("metadata-tag",CLASS_CLICKABLE),"metadata-tag",s],t)}})),r.forEach((e=>{let i=a[e],s="";""!=e&&(this.getTagShowGroup()&&(s+=HU.b(e)+": "),i.contentsid=HU.getUniqueId("taggroup"),i.cnt>this.getTagSearchLimit()&&(i.uid=HU.getUniqueId("taggroup"),s+=HU.span([ATTR_ID,i.uid]))),s+=HU.span([ATTR_ID,i.contentsid],i.contents),t+=HU.div([ATTR_STYLE,HU.css(CSS_TEXT_ALIGN,ALIGN_LEFT)],s)})),t+=HU.open(TAG_DIV),this.getDoPageSearch()&&(t=HU.center(this.getDefaultHtml()+t)),t+=HU.close(TAG_DIV),this.setContents(t),r.forEach((e=>{let t=a[e];t.uid&&HU.initPageSearch("#"+t.contentsid+" .metadata-tag",null,"Find tags",!1,{target:"#"+t.uid,inputSize:"10"})})),this.find(".metadata-tag").click((function(){if($(this).hasClass("metadata-tag-selected")){$(this).removeClass("metadata-tag-selected"),$(this).css(CSS_BACKGROUND,$(this).attr("data-background")??"");let e=$(this).attr("data-style");e&&$(this).attr(ATTR_STYLE,e)}else $(this).addClass("metadata-tag-selected"),$(this).css(CSS_BACKGROUND,"");e.doInlineSearch()}))}else this.setContents(this.getDefaultHtml());this.getDoPageSearch()&&this.getAutoFocus()&&setTimeout((()=>{this.jq(ID_TEXT_FIELD).focus()}),500),this.initHtml();let i=this.jq(ID_TEXT_FIELD);this.getAutoSearch(!0)&&i.keyup((function(t){e.getSearchSettings().skip=0,e.getSearchSettings().setMax(DEFAULT_MAX);let i=$(this).val().trim();if(""==i)return void e.clearSearch();if(!e.getDoPageSearch()&&i.length<4)return;let s=++e.callNumber;setTimeout((()=>{s==e.callNumber&&e.doSearch(!0,s)}),400)})),this.jq(ID_SEARCH).button().click((function(t){e.doSearch(!1,++e.callNumber),t.preventDefault()})),this.jq(ID_FORM).submit((function(t){e.doSearch(!1,++e.callNumber),t.preventDefault()})),this.jq(ID_TEXT_FIELD).autocomplete({source:function(e,t){}})},getDefaultHtml:function(){let e=this.makeSearchForm(),t="";if(!(this.getProperty("resultsPosition",POSITION_ABSOLUTE)==POSITION_ABSOLUTE)){this.getMaxHeight(400)&&(t+=HU.css(CSS_MAX_HEIGHT,HU.getDimension(this.getMaxHeight(400)))),this.getMaxWidth()&&(t+=HU.css(CSS_WIDTH,HU.getDimension(this.getMaxWidth(400))),t+=HU.css(CSS_MAX_WIDTH,HU.getDimension(this.getMaxWidth(200))));let i=HU.div([ATTR_ID,this.domId(ID_ENTRIES),ATTR_CLASS,"display-simplesearch-entries",ATTR_STYLE,t]);this.getShowHeader(!0)&&(e+=HU.div([ATTR_CLASS,"display-entries-results",ATTR_ID,this.getDomId(ID_RESULTS)])),e+=i}return e},makeSearchForm:function(){let e=HU.openTag(TAG_FORM,[ATTR_ID,this.getDomId(ID_FORM),ATTR_ACTION,"#"]),t=this.getEgText(),i=this.getFormText(),s=!1;!Utils.stringDefined(i)&&this.getDoPageSearch()&&(i=HU.getUrlArgument(ARG_PAGESEARCH)??"",Utils.stringDefined(i)&&(s=!0));let l=HU.getDimension(this.getPropertyInputSize());return e+=HU.input("",i,[ATTR_STYLE,HU.css(CSS_WIDTH,l),ATTR_PLACEHOLDER,t,ATTR_CLASS,"display-search-input",ATTR_ID,this.getDomId(ID_TEXT_FIELD)]),e+=HU.tag(TAG_INPUT,[ATTR_TYPE,"submit",ATTR_STYLE,HU.css(CSS_POSITION,POSITION_ABSOLUTE,CSS_LEFT,HU.px(-9999),CSS_WIDTH,HU.px(1),CSS_HEIGHT,HU.px(1))]),e+=HU.closeTag(TAG_FORM),e+=HU.div([ATTR_ID,this.domId(ID_FORM)]),s&&setTimeout((()=>{this.doInlineSearch()}),1),e},handleNoEntries:function(){this.writeEntries("",[]),this.writeMessage("Nothing found"),this.getDisplayManager().handleEventEntriesChanged(this,[])},writeMessage:function(e){this.makeDialog(),l.writeMessage.call(this,e)},makeDialog:function(){if(!this.dialog||null!=this.dialog.parent()&&0!=this.dialog.parent().length||(this.dialog=null),this.dialog)this.dialog.show();else{let e=HU.div([ATTR_CLASS,"display-entries-results",ATTR_ID,this.getDomId(ID_RESULTS)],SPACE),t=HU.div([ATTR_CLASS,"display-entries-entries",ATTR_ID,this.getDomId(ID_ENTRIES)],"");this.dialog=HU.makeDialog({content:e+t,anchor:this.getContents(),draggable:!0,header:!0})}},writeEntries:function(e,t){this.getProperty("resultsPosition",POSITION_ABSOLUTE)==POSITION_ABSOLUTE?(this.makeDialog(),Utils.stringDefined(e)?(this.jq(ID_ENTRIES).html(e),this.writeMessage(this.getResultsHeader(t,!0))):this.jq(ID_ENTRIES).html("")):this.jq(ID_ENTRIES).html(e)},getPageSearchSelectors:function(){let e=this.getPageSearchParent()||TAG_BODY,t=$(e);if(0==t.length&&this.getPageSearchParent()){let e=this.getPageSearchParent();t=e.startsWith(".")?$(e):jqid(e)}let i=t.find(this.getPageSearchSelector());return 0==i.length&&console.log(this.type+" could not find page search components:"+this.getPageSearchSelector()),i},selectTag:function(e){let t=this;this.find(".metadata-tag").each((function(){e==$(this).attr("metadata-tag")&&($(this).addClass("metadata-tag-selected"),t.doInlineSearch())}))},doInlineSearch:function(){let e,t,i;if(this.getDoPageSearch())if(t=(this.jq(ID_TEXT_FIELD).val()||"").trim(),t=t.toLowerCase(),""!=t)try{e=new RegExp(t)}catch(e){console.log("bad regexp:"+e)}else t=null;if(this.getDoTagSearch()){let e=this.find(".metadata-tag-selected");e.length>0&&e.each((function(){let e=$(this).attr("metadata-tag");i||(i={}),i[e]=!0}))}if(!t&&!i)return this.clearPageSearch(),void(this.getDoPageSearch()&&HU.removeFromDocumentUrl(ARG_PAGESEARCH));this.getPageSearchSelectors().each((function(){let s=!0,l=!0;if(i){s=!1,$(this).find(".metadata-tag").each((function(){let e=$(this).attr("metadata-tag");i[e]&&(s=!0)}))}if(t){let i=Utils.split(t,",",!0,!0);l=!1;let s=Utils.stripTags($(this).html()),a=$(this).attr(ATTR_DATA_CORPUS)??" ";s+=a+" ",s+=$(this).attr(ATTR_ENTRYID)??" ",s=s.toLowerCase(),l=!0,i.every((t=>(l=!1,(s.indexOf(t)>=0||e&&s.match(e))&&(l=!0),l)))}s&&l?$(this).show():$(this).fadeOut()})),this.getDoPageSearch()&&HU.addToDocumentUrl(ARG_PAGESEARCH,t)},clearPageSearch:function(){this.getPageSearchSelectors().show()},clearSearch:function(){if(this.getApplyToEntries()){this.getPageSearchSelectors().each((function(){$(this).show()}))}this.writeMessage(""),this.writeEntries(""),this.dialog&&(this.dialog.remove(),this.dialog=null),this.getDoInlineSearch()&&this.doInlineSearch()},doSearch:function(e,t){this.getDoPageSearch()?this.doInlineSearch():this.submitSearchForm(e,t)},submitSearchForm:function(e,t){this.writeMessage(this.getWaitImage()+" Searching..."),null==t&&(t=this.callNumber),this.haveSearched=!0,this.makeSearchSettings().entryType=this.getSearchEntryType();let i=this.makeSearchUrl(this.getRamadda());this.entryList=new EntryList(this.getRamadda(),i);this.entryList.doSearch(null,(()=>{this.callNumber==t&&this.entryListChanged(this.entryList)}),(e=>{this.writeEntries("Error:"+e)})),e||this.updateForSearching(i)},makeDisplayList:function(){let e=this.getSelectedEntriesFromTree();if(0==e.length)return;let t={selectedEntries:e,showForm:!1,showMenu:!0,fixedEntries:!0};t.entryList=new EntryList(this.getRamadda(),"",this,!1),t.entryList.setEntries(e),this.getDisplayManager().createDisplay(DISPLAY_ENTRYLIST,t)},handleEventEntrySelection:function(e,t){this.selectEntry(t.entry,t.selected)},selectEntry:function(e,t){let i=!1;if(t){this.jq("entry_"+e.getIdForDom()).addClass("ui-selected"),this.selectedEntries.indexOf(e)<0&&(this.selectedEntries.push(e),i=!0)}else{this.jq("entry_"+e.getIdForDom()).removeClass("ui-selected");let t=this.selectedEntries.indexOf(e);t>=0&&(this.selectedEntries.splice(t,1),i=!0)}},makeEntriesDisplay:function(e){return this.getEntriesTree(e)},entryListChanged:function(e){this.multiSearch&&this.multiSearch.count--;let t=this.entryList.getEntries();if(this.getApplyToEntries()){this.dialog&&this.dialog.hide();let e=this.getPageSearchSelectors();if(0==t.length)e.each((function(){$(this).show()}));else{let i={};t.forEach((e=>{i[e.getId()]=!0})),e.each((function(){let e=$(this).attr(ATTR_ENTRYID);e&&(i[e]?$(this).show():$(this).fadeOut())}))}}if(l.entryListChanged.apply(this,[e]),0==t.length)return this.getSearchSettings().skip=0,this.getSearchSettings().setMax(DEFAULT_MAX),void this.handleNoEntries();this.writeMessage(this.getResultsHeader(t,!0)),this.initCloser(ID_RESULTS);this.getGet();null!=this.footerRight&&this.writeHtml(ID_SEARCH_FOOTER,this.footerRight);let i="",s={},a=this.getProperty("showParent");t.forEach(((e,t)=>{s[e.getId()]=e;let l=e.getThumbnail(),r=[ATTR_TITLE,e.getName(),ATTR_CLASS,"display-simplesearch-entry",ATTR_ENTRYID,e.getId()];l&&r.push("thumbnail",l);let o=HU.href(this.getRamadda().getEntryUrl(e),e.getIconImage()+"  "+e.getName());if(a&&e.getParentName()){let t=HU.url(RamaddaUtil.getUrl(URL_ENTRY_SHOW),ARG_ENTRYID,e.parent),i=HU.href(t,HU.image(e.parentIcon)+" "+e.parentName);o=HU.hbox([i,HU.span([ATTR_STYLE,HU.css(CSS_MARGIN_RIGHT,HU.px(4),CSS_MARGIN_LEFT,HU.px(4))],"&raquo;"),o])}i+=HU.div(r,o)})),this.writeEntries(i,t);this.jq(ID_ENTRIES).find(".display-simplesearch-entry").tooltip({show:{delay:1e3,duration:300},content:function(){let e=s[$(this).attr(ATTR_ENTRYID)];if(!e)return null;let t=$(this).attr("thumbnail"),i=e.getIconImage()+" "+HU.b(e.getName());i+=HU.div([],"Type: "+e.getTypeName());let l=e.getSnippet();return l&&(i+=HU.div([ATTR_STYLE,HU.css(CSS_BORDER_TOP,CSS_BASIC_BORDER)],l)),t&&(i+=HU.div([ATTR_STYLE,HU.css(CSS_MAX_HEIGHT,HU.px(100),CSS_OVERFLOW_Y,OVERFLOW_HIDDEN,CSS_BORDER_TOP,CSS_BASIC_BORDER)],HU.image(t,[ATTR_WIDTH,HU.px(300)]))),i}}),this.getDisplayManager().handleEventEntriesChanged(this,t)}})}function RamaddaEntrylistDisplay(e,t,i,s){const l=new RamaddaSearchDisplay(e,t,i);defineDisplay(addRamaddaDisplay(this),l,[],{})}function RamaddaEntrygridDisplay(e,t,i){const s="contents",l="grid",a="axis_left",r="axis_bottom",o="canvas",n="links",h="gridsettings",d="yAxisAscending",g="scaleHeight",p="xAxisAscending",c="scaleWidth",u="showIcon",T="showName",f="boxColor";let y=new RamaddaEntryDisplay(e,t,DISPLAY_ENTRY_GRID,i);defineDisplay(addRamaddaDisplay(this),y,[],{entries:i.entries,initDisplay:function(){let e=this;this.createUI();let t=HU.div([ATTR_ID,this.getDomId(s)],this.getLoadingMessage("Loading entries..."));if(this.setContents(t),!this.entryIds)return void e.jq(s).html(this.getLoadingMessage("No entries specified"));let i={entries:this.entryIds},h=new EntrySearchSettings(i),d=this.getRamadda().getSearchUrl(h,OUTPUT_JSON,"BAR"),g={entryListChanged:function(t){if(e.entries=t.getEntries(),0==e.entries.length)return void e.jq(s).html(e.getLoadingMessage("No entries selected"));e.drag=null,e.jq(s).html(e.makeFramework()),e.canvas=jqid(e.getDomId(o)),e.gridPopup=jqid(e.getDomId(l)+" .display-grid-popup");let i=e.jq(r),h=e.jq(a),d=function(t){e.handledClick=!1,e.drag={dragging:!1,x:GuiUtils.getEventX(t),y:GuiUtils.getEventY(t),X:{minDate:e.axis.X.minDate?e.axis.X.minDate:e.minDate,maxDate:e.axis.X.maxDate?e.axis.X.maxDate:e.maxDate},Y:{minDate:e.axis.Y.minDate?e.axis.Y.minDate:e.minDate,maxDate:e.axis.Y.maxDate?e.axis.Y.maxDate:e.maxDate}}},g=function(t){e.drag=null,e.handledClick=!1},p=function(t){e.drag&&(e.drag.dragging&&(e.handledClick=!0),e.drag=null)},c=function(t,i,s){let l=e.drag;if(!l)return;l.dragging=!0;let a=GuiUtils.getEventX(t),r=(l.x,GuiUtils.getEventY(t)),o=(l.y,$(this).width()),n=$(this).height(),h=(a-l.x)/o,d=(r-l.y)/n,g=e.getXAxisAscending(),p=e.getXAxisAscending(),c=(l.X.maxDate.getTime()-l.X.minDate.getTime())*h,u=(l.Y.maxDate.getTime()-l.Y.minDate.getTime())*d;i&&(e.axis.X.minDate=new Date(l.X.minDate.getTime()+(g?-1:1)*c),e.axis.X.maxDate=new Date(l.X.maxDate.getTime()+(g?-1:1)*c)),s&&(e.axis.Y.minDate=new Date(l.Y.minDate.getTime()+(p?1:-1)*u),e.axis.Y.maxDate=new Date(l.Y.maxDate.getTime()+(p?1:-1)*u)),e.makeGrid(e.entries)},u=function(t,i,s){if(e.handledClick)return void(e.handledClick=!1);if(e.drag&&e.drag.dragging)return void(e.drag=null);let l;if(e.drag=null,t.metaKey||t.ctrlKey)l="reset";else{l=t.shiftKey?"zoomout":"zoomin"}e.doZoom(l,i,s)};e.canvas.mousedown(d),e.canvas.mouseleave(g),e.canvas.mouseup(p),e.canvas.mousemove((function(e){c(e,!0,!0)})),e.canvas.click((function(e){u(e,!0,!0)})),i.mousedown(d),i.mouseleave(g),i.mouseup(p),i.mousemove((function(e){c(e,!0,!1)})),i.click((function(e){u(e,!0,!1)})),h.mousedown(d),h.mouseleave(g),h.mouseup(p),h.mousemove((function(e){c(e,!1,!0)})),h.click((function(e){u(e,!1,!0)}));let T=HU.image(icon_zoom,[ATTR_CLASS,"display-grid-action",ATTR_TITLE,"reset zoom","action","reset"])+HU.image(icon_zoom_in,[ATTR_CLASS,"display-grid-action",ATTR_TITLE,"zoom in","action","zoomin"])+HU.image(icon_zoom_out,[ATTR_CLASS,"display-grid-action",ATTR_TITLE,"zoom out","action","zoomout"]);e.jq(n).html(T),jqid(e.getDomId(l)+" .display-grid-action").click((function(){let t=$(this).attr("action");e.doZoom(t)})),e.jq(a).html(""),e.jq(r).html(""),e.makeGrid(e.entries)}};new EntryList(this.getRamadda(),d,g,!0)},initDialog:function(){y.initDialog.call(this);let e=this;this.jq("gridsettings :checkbox").click((function(){e.setProperty($(this).attr("attr"),HU.isChecked($(this))),e.makeGrid(e.entries)}));let t=this.jq("gridsettings :input");t.blur((function(){e.setProperty($(this).attr("attr"),$(this).val()),e.makeGrid(e.entries)})),t.keypress((function(t){13==(t.keyCode?t.keyCode:t.which)&&(e.setProperty($(this).attr("attr"),$(this).val()),e.makeGrid(e.entries))}))},getDialogContents:function(e,t){let i="";i+=HU.openTag(TAG_DIV,[ATTR_ID,this.getDomId(h)]),i+=HU.formTable(),i+=HU.formEntry("",HU.checkbox(this.getDomId(u),["attr",u],this.getProperty(u,"true"))+" Show Icon"+SPACE2+HU.checkbox(this.getDomId(T),["attr",T],this.getProperty(T,"true"))+" Show Name"),i+=HU.formEntryLabel("X-Axis",HU.checkbox(this.getDomId(p),["attr",p],this.getXAxisAscending())+" Ascending"+SPACE2+HU.checkbox(this.getDomId(c),["attr",c],this.getXAxisScale())+" Scale Width"),i+=HU.formEntryLabel("Y-Axis",HU.checkbox(this.getDomId(d),["attr",d],this.getYAxisAscending())+" Ascending"+SPACE2+HU.checkbox(this.getDomId(g),["attr",g],this.getYAxisScale())+" Scale Height"),i+=HU.formEntryLabel("Box Color",HU.input(this.getDomId(f),this.getProperty(f,"lightblue"),["attr",f])),i+=HU.formTableClose(),i+=HU.closeTag(TAG_DIV),e.push("Entry Grid"),t.push(i),y.getDialogContents.call(this,e,t)},doZoom:function(e,t,i){if(Utils.isDefined(t)||(t=!0),Utils.isDefined(i)||(i=!0),"reset"==e)this.axis.Y.minDate=null,this.axis.Y.maxDate=null,this.axis.X.minDate=null,this.axis.X.maxDate=null;else{let s="zoomout"==e;if(t){let e=this.axis.X.minDate.getTime(),t=this.axis.X.maxDate.getTime(),i=(s?1:-1)*(t-e)*.1;this.axis.X.minDate=new Date(e-i),this.axis.X.maxDate=new Date(t+i)}if(i){let e=this.axis.Y.minDate.getTime(),t=this.axis.Y.maxDate.getTime(),i=(s?1:-1)*(t-e)*.1;this.axis.Y.minDate=new Date(e-i),this.axis.Y.maxDate=new Date(t+i)}}this.makeGrid(this.entries)},initGrid:function(e){let t=this,i=this.canvas.find(".display-grid-entry");i.click((function(i){let s=parseInt($(this).attr(ATTR_INDEX));entry=e[s];let l=entry.getEntryUrl();t.urlTemplate&&(l=t.urlTemplate.replace("{url}",l).replace(/{entryid}/g,entry.getId()).replace(/{resource}/g,entry.getResourceUrl())),t.handledClick=!0,t.drag=null,window.open(l,"_entry")})),i.mouseout((function(){let e=$(this).attr(ATTR_ENTRYID);if(e){t.canvas.find("[entryid='"+e+"']").each((function(){"box"==$(this).attr("itemtype")&&($(this).attr("prevcolor",$(this).css(CSS_BACKGROUND)),$(this).css(CSS_BACKGROUND,$(this).attr("prevcolor")))}))}t.gridPopup.hide()})),i.mouseover((function(i){let s=$(this).attr(ATTR_ENTRYID);if(s){t.canvas.find("[entryid='"+s+"']").each((function(){"box"==$(this).attr("itemtype")&&($(this).attr("prevcolor",$(this).css(CSS_BACKGROUND)),$(this).css(CSS_BACKGROUND,"rgba(0,0,255,0.5)"))}))}GuiUtils.getEventX(i);let l=parseInt($(this).attr(ATTR_INDEX));entry=e[l];let a=entry.getThumbnail(),r="";a?r=HU.image(a,[ATTR_WIDTH,300])+HU.br():entry.getIsImage()&&(r+=HU.image(entry.getResourceUrl(),[ATTR_WIDTH,300])+HU.br()),r+=entry.getIconImage()+" "+entry.getName()+HU.br(),r+="Date: "+(entry.getStartDate().getUTCFullYear()+"-"+Utils.padLeft(entry.getStartDate().getUTCMonth()+1,2,"0")+"-"+Utils.padLeft(entry.getStartDate().getUTCDate(),2,"0"))+" - "+(entry.getEndDate().getUTCFullYear()+"-"+Utils.padLeft(entry.getEndDate().getUTCMonth()+1,2,"0")+"-"+Utils.padLeft(entry.getEndDate().getUTCDate(),2,"0"))+" UTC",t.gridPopup.html(r),t.gridPopup.show(),t.gridPopup.position({of:$(this),at:POS_LEFT_BOTTOM,my:POS_LEFT_TOP,collision:"none none"}),t.gridPopup.position({of:$(this),my:POS_LEFT_TOP,at:POS_LEFT_BOTTOM,collision:"none none"})}))},makeFramework:function(e){let t="";return t+=HU.openDiv([ATTR_CLASS,"display-grid",ATTR_ID,this.getDomId(l)]),t+=HU.div([ATTR_CLASS,HU.classes("display-grid-popup",CLASS_POPUP)],""),t+=HU.openTag(TAG_TABLE,[ATTR_BORDER,HU.px(0),ATTR_CLASS,"",ATTR_CELLSPACING,"0",ATTR_WIDTH,HU.perc(100),ATTR_STYLE,HU.css(CSS_HEIGHT,HU.perc(100))]),t+=HU.openTag(TAG_TR,[ATTR_VALIGN,POS_BOTTOM]),t+=HU.tag(TAG_TD),t+=HU.tag(TAG_TD,[],HU.div([ATTR_ID,this.getDomId(n)],"")),t+=HU.closeTag(TAG_TR),t+=HU.openTag(TAG_TR,[ATTR_STYLE,HU.css(CSS_HEIGHT,HU.perc(100))]),t+=HU.openTag(TAG_TD,[ATTR_STYLE,HU.css(CSS_HEIGHT,HU.perc(100))]),t+=HU.openDiv([ATTR_CLASS,"display-grid-axis-left ramadda-noselect",ATTR_ID,this.getDomId(a)]),t+=HU.closeDiv(),t+=HU.closeDiv(),t+=HU.closeTag(TAG_TD),t+=HU.openTag(TAG_TD,[ATTR_STYLE,HU.css(CSS_HEIGHT,HU.px(this.getProperty("height","400")))]),t+=HU.openDiv([ATTR_CLASS,"display-grid-canvas ramadda-noselect",ATTR_ID,this.getDomId(o)]),t+=HU.closeDiv(),t+=HU.closeDiv(),t+=HU.closeTag(TAG_TD),t+=HU.closeTag(TAG_TR),t+=HU.openTag(TAG_TR,[]),t+=HU.tag(TAG_TD,[ATTR_WIDTH,"100"],SPACE),t+=HU.openTag(TAG_TD,[]),t+=HU.div([ATTR_CLASS,"display-grid-axis-bottom ramadda-noselect",ATTR_TITLE,"click:zoom in;shift-click:zoom out;command/ctrl click: reset",ATTR_ID,this.getDomId(r)],""),t+=HU.closeTag(TAG_TABLE),t+=HU.closeTag(TAG_TD),t},getXAxisType:function(){return this.getProperty("xAxisType","date")},getYAxisType:function(){return this.getProperty("yAxisType","month")},getXAxisAscending:function(){return this.getProperty(p,!0)},getYAxisAscending:function(){return this.getProperty(d,!0)},getXAxisScale:function(){return this.getProperty(c,!0)},getYAxisScale:function(){return this.getProperty(g,!1)},makeGrid:function(e){let t=this.getProperty(u,!0),i=this.getProperty(T,!0);if(!this.minDate){let t=null,i=null;for(let s=0;s<e.length;s++){let l=e[s];t=null==t||t.getTime()>l.getStartDate().getTime()?l.getStartDate():t,i=null==i||i.getTime()<l.getEndDate().getTime()?l.getEndDate():i}this.minDate=new Date(Date.UTC(t.getUTCFullYear(),0,1)),this.maxDate=new Date(Date.UTC(i.getUTCFullYear()+1,0,1))}let s={width:this.canvas.width(),height:this.canvas.height(),Y:{vertical:!0,axisType:this.getYAxisType(),ascending:this.getYAxisAscending(),scale:this.getYAxisScale(),skip:1,maxTicks:Math.ceil(this.canvas.height()/80),minDate:this.minDate,maxDate:this.maxDate,ticks:[],lines:"",html:"",minDate:this.minDate,maxDate:this.maxDate},X:{vertical:!1,axisType:this.getXAxisType(),ascending:this.getXAxisAscending(),scale:this.getXAxisScale(),skip:1,maxTicks:Math.ceil(this.canvas.width()/80),minDate:this.minDate,maxDate:this.maxDate,ticks:[],lines:"",html:""}};this.axis?(this.axis.X.minDate?(s.X.minDate=this.axis.X.minDate,s.X.maxDate=this.axis.X.maxDate):(this.axis.X.minDate=s.X.minDate,this.axis.X.maxDate=s.X.maxDate),this.axis.Y.minDate?(s.Y.minDate=this.axis.Y.minDate,s.Y.maxDate=this.axis.Y.maxDate):(this.axis.Y.minDate=s.Y.minDate,this.axis.Y.maxDate=s.Y.maxDate)):this.axis=s,"size"==s.Y.axisType?this.calculateSizeAxis(s.Y):"date"==s.Y.axisType?this.calculateDateAxis(s.Y):this.calculateMonthAxis(s.Y);for(let e=0;e<s.Y.ticks.length;e++){let t=s.Y.ticks[e],i=HU.css(CSS_BOTTOM,HU.perc(t.percent)),l=t.major?"display-grid-hline-major":"display-grid-hline";s.Y.lines+=HU.div([ATTR_STYLE,i,ATTR_CLASS,l]," "),s.Y.html+=HU.div([ATTR_STYLE,i,ATTR_CLASS,"display-grid-axis-left-tick"],t.label+" "+HU.div([ATTR_CLASS,"display-grid-htick"],""))}"size"==s.X.axisType?this.calculateSizeAxis(s.X):"date"==s.X.axisType?this.calculateDateAxis(s.X):this.calculateMonthAxis(s.X);for(let e=0;e<s.X.ticks.length;e++){let t=s.X.ticks[e];if(t.percent>0){let e=t.major?"display-grid-vline-major":"display-grid-vline";s.X.lines+=HU.div([ATTR_STYLE,HU.css(CSS_LEFT,HU.perc(t.percent)),ATTR_CLASS,e]," ")}s.X.html+=HU.div([ATTR_STYLE,HU.css(CSS_LEFT,HU.perc(t.percent)),ATTR_CLASS,"display-grid-axis-bottom-tick"],HU.div([ATTR_CLASS,"display-grid-vtick"],"")+" "+t.label)}let l="",n={};for(let a=0;a<e.length;a++){let r=e[a],o=this[s.Y.calculatePercent].call(this,r,s.Y),h=this[s.X.calculatePercent].call(this,r,s.X);o.p1<0&&(o.p2=o.p2+o.p1,o.p1=0),o.p1+o.p2>100&&(o.p2=100-o.p1);let d="",g="";s.X.ascending?(d+=HU.css(CSS_LEFT,HU.perc(h.p1)),g+=HU.css(CSS_LEFT,HU.perc(h.p1))):(d+=HU.css(CSS_RIGHT,HU.perc(h.p1)),g+=HU.css(CSS_LEFT,HU.perc(100-h.p2))),s.X.scale&&(h.delta>1?d+=HU.css(CSS_WIDTH,HU.perc(h.delta)):d+=HU.css(CSS_WIDTH,HU.px(this.getProperty("fixedWidth","5"))));let p=g;s.Y.ascending?(d+=HU.css(CSS_BOTTOM,HU.perc(o.p2)),g+=HU.css(CSS_BOTTOM,HU.perc(o.p2)),p+=HU.css(CSS_BOTTOM,HU.perc(o.p2))):(d+=HU.css(CSS_TOP,HU.perc(o.p2)),g+=HU.css(CSS_TOP,HU.perc(o.p2)),p+=HU.css(CSS_TOP,HU.perc(o.p2)),p+=HU.css(CSS_MARGIN_TOP,HU.px(-15))),s.Y.scale&&(o.p2>1?d+=HU.css(CSS_HEIGHT,HU.perc(o.delta)):d+=HU.perc(CSS_HEIGHT,HU.px(this.getProperty("fixedHeight","5")))),r.getName().includes("rilsd")&&console.log("pos:"+p),t&&(l+=HU.div([ATTR_CLASS,"display-grid-entry-icon display-grid-entry",ATTR_ENTRYID,r.getId(),ATTR_INDEX,a,ATTR_STYLE,g],r.getIconImage()));let c=Math.round(h.p1)+"---"+Math.round(o.p1);if(i&&!n[c]){n[c]=!0;let e=r.getName().replace(/ /g,SPACE);l+=HU.div([ATTR_CLASS,"display-grid-entry-text display-grid-entry",ATTR_ENTRYID,r.getId(),ATTR_INDEX,a,ATTR_STYLE,p],e)}let u=d+"background:"+this.getProperty(f,"lightblue");l+=HU.div([ATTR_CLASS,"display-grid-entry-box display-grid-entry","itemtype","box",ATTR_ENTRYID,r.getId(),ATTR_STYLE,u,ATTR_INDEX,a],"")}this.jq(a).html(s.Y.html),this.jq(o).html(s.Y.lines+s.X.lines+l),this.jq(r).html(s.X.html),this.initGrid(e)},calculateSizeAxis:function(e){let t=Number.MAX_VALUE,i=Number.MIN_VALUE;for(let e=0;e<this.entries.length;e++){let s=this.entries[e];t=Math.min(t,s.getSize()),i=Math.max(i,s.getSize())}},checkOrder:function(e,t){return{p1:t.p1,p2:t.p2,delta:Math.abs(t.p2-t.p1)}},calculateDatePercent:function(e,t){let i=100*(e.getStartDate().getTime()-t.min)/t.range,s=100*(e.getEndDate().getTime()-t.min)/t.range;return this.checkOrder(t,{p1:i,p2:s,delta:Math.abs(s-i)})},calculateMonthPercent:function(e,t){let i=e.getStartDate(),s=e.getEndDate(),l=new Date(Date.UTC(1,i.getUTCMonth(),i.getUTCDate())),a=new Date(Date.UTC(1,s.getUTCMonth(),s.getUTCDate())),r=(l.getTime()-t.min)/t.range*100,o=(a.getTime()-t.min)/t.range*100;return e.getName().includes("rilsd")&&(console.log("t1:"+l),console.log("t2:"+a),console.log("before:"+r+" "+o)),this.checkOrder(t,{p1:r,p2:o,delta:Math.abs(o-r)})},calculateMonthAxis:function(e){e.calculatePercent="calculateMonthPercent",e.minDate=new Date(Date.UTC(0,11,15)),e.maxDate=new Date(Date.UTC(1,11,31)),e.min=e.minDate.getTime(),e.max=e.maxDate.getTime(),e.range=e.max-e.min;let t=Utils.getMonthShortNames();for(let i=0;i<t.length;i++){let s=new Date(Date.UTC(1,i)),l=(e.maxDate.getTime()-s.getTime())/e.range;e.ascending&&(l=1-l),e.ticks.push({percent:100*l,label:t[i],major:!1})}},calculateDateAxis:function(e){e.calculatePercent="calculateDatePercent";let t=e.maxDate.getUTCFullYear()-e.minDate.getUTCFullYear();if(e.type="year",e.skip=Math.max(1,Math.floor(t/e.maxTicks)),t/e.skip<=e.maxTicks/2){let t=0,i=new Date(e.minDate.getTime());for(;i.getTime()<e.maxDate.getTime();)Utils.incrementMonth(i),t++;if(e.skip=Math.max(1,Math.floor(t/e.maxTicks)),e.type="month",t/e.skip<=e.maxTicks/2){let t=new Date(e.minDate.getTime()),i=0;for(;t.getTime()<e.maxDate.getTime();)Utils.incrementDay(t),i++;e.skip=Math.max(1,Math.floor(i/e.maxTicks)),e.type="day"}}e.min=e.minDate.getTime(),e.max=e.maxDate.getTime(),e.range=e.max-e.min;let i,s=Utils.getMonthShortNames(),l=null,a=null;for(i="year"==e.type?new Date(Date.UTC(e.minDate.getUTCFullYear())):"month"==e.type?new Date(Date.UTC(e.minDate.getUTCFullYear(),e.minDate.getUTCMonth())):new Date(Date.UTC(e.minDate.getUTCFullYear(),e.minDate.getUTCMonth(),e.minDate.getUTCDate()));i.getTime()<e.maxDate.getTime();){let t=(i.getTime()-e.minDate.getTime())/e.range;if(e.ascending||(t=1-t),t*=100,t>=0&&t<100){let r="",o=i.getUTCFullYear(),n=i.getUTCMonth(),h=!1;"year"==e.type?r=o:"month"==e.type?(r=s[i.getUTCMonth()],l!=o&&(r=r+HU.br()+o,l=o,h=!0)):(r=i.getUTCDate(),l==o&&a==n||(r=r+HU.br()+s[n]+" "+o,l=o,a=n,h=!0)),e.ticks.push({percent:t,label:r,major:h})}"year"==e.type?Utils.incrementYear(i,e.skip):"month"==e.type?Utils.incrementMonth(i,e.skip):Utils.incrementDay(i,e.skip)}}})}function RamaddaMetadataDisplay(e,t,i){let s;null==i.formOpen&&(i.formOpen=!1),RamaddaUtil.inherit(this,s=new RamaddaSearcherDisplay(e,t,DISPLAY_METADATA,i)),addRamaddaDisplay(this),RamaddaUtil.defineMembers(this,{haveDisplayed:!1,initDisplay:function(){this.createUI(),this.setContents(this.getDefaultHtml()),this.initHtml(),s.initDisplay.apply(this),this.haveDisplayed&&this.entryList&&this.entryListChanged(this.entryList),this.haveDisplayed=!0},entryListChanged:function(e){this.entryList=e;let t=this.entryList.getEntries();if(0==t.length)return void this.writeMessage("Nothing found");let i=this.getEntriesMetadata(t);this.writeEntries(i,t),HU.formatTable("#"+this.getDomId(TAG_TABLE),{scrollY:400})}})}function RamaddaEntrydisplayDisplay(e,t,i){let s;if($.extend(this,{sourceEntry:i.sourceEntry}),RamaddaUtil.inherit(this,s=new RamaddaDisplay(e,t,DISPLAY_ENTRYDISPLAY,i)),null==i.sourceEntry&&null!=i.entryId){let e=this;(async function(){await e.getEntry(i.entryId,(t=>{e.sourceEntry=t,e.initDisplay()}))})()}addRamaddaDisplay(this),$.extend(this,{selectedEntry:null,initDisplay:function(){this.createUI();let e=this.title;if(null!=this.sourceEntry){this.addEntryHtml(this.sourceEntry);let t=this.sourceEntry.getEntryUrl();null==e&&(e=this.sourceEntry.getName()),e=HU.tag(TAG_A,[ATTR_HREF,t,ATTR_TITLE,this.sourceEntry.getName()],e)}else this.addEntryHtml(this.selectedEntry),null==e&&(e="Entry Display");this.setDisplayTitle(e)},handleEventEntrySelection:function(e,t){if(null!=this.sourceEntry)return;let i=t.selected,s=t.entry;if(!i){if(this.selectedEntry!=s)return;return this.selectedEntry=null,void this.setContents("")}this.selectedEntry=s,this.addEntryHtml(this.selectedEntry)},getEntries:function(){return[this.sourceEntry]},addEntryHtml:function(e){if(null==e)return void this.setContents(SPACE);let t=this.getEntryHtml(e,{showHeader:!1}),i=this.getProperty("height",HU.px(400));i.endsWith("px")||(i+="px"),this.setContents(HU.div([ATTR_CLASS,"display-entry-description",ATTR_STYLE,HU.css(CSS_HEIGHT,i)],t)),this.entryHtmlHasBeenDisplayed(e)}})}function RamaddaEntrytitleDisplay(e,t,i){let s;if($.extend(this,{sourceEntry:i.sourceEntry}),RamaddaUtil.inherit(this,s=new RamaddaDisplay(e,t,DISPLAY_ENTRYDISPLAY,i)),null==i.sourceEntry&&null!=i.entryId){let e=this;(async function(){await e.getEntry(i.entryId,(t=>{e.sourceEntry=t,e.initDisplay()}))})()}defineDisplay(addRamaddaDisplay(this),s,[{label:"Entry Title"},{p:"template",ex:"<b>${icon} ${name} Date: ${date} ${start_date} ${end_date} ${entry_attribute...}</b>"},{p:"showLink",ex:"false"}],{initDisplay:function(){this.createUI();let e="";if(this.sourceEntry){let t=this.sourceEntry;e=this.getProperty("template",HU.b("${icon} ${name} Date: ${date}")),e=e.replace("${name}",t.getDisplayName()),e=e.replace("${icon}",t.getIconImage()),e=e.replace("${date}",this.formatDate(t.getStartDate())),e=e.replace("${start_date}",this.formatDate(t.getStartDate())),e=e.replace("${end_date}",this.formatDate(t.getEndDate())),t.getAttributeNames().map((i=>{e=e.replace("${"+i+"}",t.getAttributeValue(i))})),this.getProperty("showLink",!0)&&(e=HU.href(t.getEntryUrl(),e))}this.displayHtml(e)},setEntry:function(e){this.sourceEntry=e,this.initDisplay()},handleEventEntrySelection:function(e,t){}})}function RamaddaEntrywikiDisplay(e,t,i){const s="wiki";let l;if(i.displayStyle||(i.displayStyle=HU.css(CSS_WIDTH,HU.perc(100))),$.extend(this,{sourceEntry:i.sourceEntry}),RamaddaUtil.inherit(this,l=new RamaddaDisplay(e,t,DISPLAY_ENTRYDISPLAY,i)),null==i.sourceEntry&&null!=i.entryId){let e=this;(async function(){await e.getEntry(i.entryId,(t=>{e.sourceEntry=t,e.initDisplay()}))})()}let a=[{label:"Entry Wiki"},{p:"wiki",d:"{{import macro=forchild}}",ex:"wiki text"},{p:"wikiStyle",d:HU.css(CSS_WIDTH,HU.perc(100),CSS_MAX_WIDTH,"95vw",CSS_MIN_HEIGHT,HU.px(400))}];defineDisplay(addRamaddaDisplay(this),l,a,{initDisplay:function(){this.createUI();let e=HU.div([ATTR_ID,this.domId(s),ATTR_STYLE,this.getWikiStyle()]),t={};if(i.entries){let s=[];s.push(HU.tag(TAG_OPTION,[],"View Entry")),i.entries.forEach((e=>{t[e.getId()]=e;let i=e.getIconUrl(),l=e.getName(),a=l,r=e.getType();r&&(a+=" - "+r.getLabel());let o=[ATTR_TITLE,a,ATTR_VALUE,e.getId(),"data-iconurl",i],n=HU.tag(TAG_OPTION,o,l);s.push(n)}));let l=HU.select("",[ATTR_STYLE,HU.css(CSS_WIDTH,HU.px(400)),ATTR_ID,this.domId("entrymenu")],s);l+=HU.div([ATTR_STYLE,HU.css(CSS_MARGIN_TOP,HU.px(4)),ATTR_ID,this.domId("entry_breadcrumbs"),ATTR_CLASS,"display-entrylist-details-ancestors"]),e=HU.div([ATTR_STYLE,HU.css(CSS_MARGIN_TOP,HU.px(4),CSS_MARGIN_BOTTOM,HU.px(8),CSS_BORDER_BOTTOM,CSS_BASIC_BORDER)],l)+e}if(this.displayHtml(e),i.entries){let e=this,i=this.entryMenu=this.jq("entrymenu");i.change((function(){let i=t[$(this).val()];i&&(e.displayEntryBreadcrumbs(i,e.domId("entry_breadcrumbs"),4),e.loadEntry(i))})),HU.initSelect(i,{autoWidth:!0,"max-height":HU.px(100)}),HU.makeSelectTagPopup(i,{icon:!0,single:!0,makeButtons:!1}),this.sourceEntry&&this.displayEntryBreadcrumbs(this.sourceEntry,this.domId("entry_breadcrumbs"),4)}this.sourceEntry&&this.loadEntry(this.sourceEntry)},loadEntry:function(e){let t=this.getWiki();t=t.replace(/\\n/g,"\n"),this.addedDisplays&&this.addedDisplays.forEach((e=>{e.getId&&removeRamaddaDisplay(e.getId())})),this.addedDisplays=[],this.wikify(t,e.getId(),(e=>{addDisplayListener=e=>{this.addedDisplays.push(e)},this.jq(s).html(e),addDisplayListener=null}))},handleEventRecordSelection:function(e,t){if(l.handleEventRecordSelection.call(this,e,t),!this.entryMenu)return;if(!t.record)return;let i=t.record.getValueFromField(ATTR_ID);i&&this.entryMenu.data("selectBox-selectBoxIt").selectOption(i)},setEntry:function(e){this.sourceEntry=e,this.initDisplay()},handleEventEntrySelection:function(e,t){this.logMsg("entry select")}})}function RamaddaOperandsDisplay(e,t,i){const s=TAG_SELECT,l="newdisplay";$.extend(this,new RamaddaEntryDisplay(e,t,DISPLAY_OPERANDS,i)),addRamaddaDisplay(this),$.extend(this,{baseUrl:null,initDisplay:function(){this.createUI(),this.baseUrl=this.getRamadda().getSearchUrl(this.searchSettings,OUTPUT_JSON),null==this.entryList&&(this.entryList=new EntryList(this.getRamadda(),jsonUrl,this));let e="";e+=HU.div([ATTR_ID,this.domId(ID_ENTRIES),ATTR_CLASS,this.getClass("entries")],""),this.setContents(e)},entryListChanged:function(e){let t="<form>";t+=HU.p(),t+=HU.openTag(TAG_TABLE,[ATTR_CLASS,CLASS_FORMTABLE,ATTR_CELLSPACING,0,ATTR_CELLSPACING,0]);let i=this.entryList.getEntries();this.getGet();for(let e=1;e<=2;e++){let l=HU.openTag(TAG_SELECT,[ATTR_ID,this.getDomId(s+e)]);l+=HU.tag(TAG_OPTION,[ATTR_TITLE,"",ATTR_VALUE,""],"-- Select --");for(let e=0;e<i.length;e++){let t=i[e];t.getIconImage(),t.getName();l+=HU.tag(TAG_OPTION,[ATTR_TITLE,t.getName(),ATTR_VALUE,t.getId()],t.getName())}l+=HU.closeTag(TAG_SELECT),t+=HU.formEntryLabel("Data",l)}let a=HU.openTag(TAG_SELECT,[ATTR_ID,this.getDomId(ID_CHARTTYPE)]);a+=HU.tag(TAG_OPTION,[ATTR_TITLE,"",ATTR_VALUE,"linechart"],"Line chart"),a+=HU.tag(TAG_OPTION,[ATTR_TITLE,"",ATTR_VALUE,"barchart"],"Bar chart"),a+=HU.tag(TAG_OPTION,[ATTR_TITLE,"",ATTR_VALUE,"barstack"],"Stacked bars"),a+=HU.tag(TAG_OPTION,[ATTR_TITLE,"",ATTR_VALUE,"bartable"],"Bar table"),a+=HU.tag(TAG_OPTION,[ATTR_TITLE,"",ATTR_VALUE,"piechart"],"Pie chart"),a+=HU.tag(TAG_OPTION,[ATTR_TITLE,"",ATTR_VALUE,"scatterplot"],"Scatter Plot"),a+=HU.closeTag(TAG_SELECT),t+=HU.formEntryLabel("Chart Type",a),t+=HU.closeTag(TAG_TABLE),t+=HU.p(),t+=HU.tag(TAG_DIV,[ATTR_CLASS,"display-button",ATTR_ID,this.getDomId(l)],"New Chart"),t+=HU.p(),t+=HU.close(TAG_FORM),this.writeEntries(t);let r=this;this.jq(l).button().click((function(e){r.createDisplay()}))},createDisplay:function(){let t=this.getEntry(this.jq("select1").val()),i=this.getEntry(this.jq("select2").val());if(null==t)return void alert("No data selected");let s=[];s.push(new PointData(t.getName(),null,null,HU.url(RamaddaUtil.getUrl(URL_ENTRY_SHOW),ARG_OUTPUT,"points.product","product","points.json","numpoints",1e3,ARG_ENTRYID,t.getId()))),null!=i&&s.push(new PointData(i.getName(),null,null,HU.url(RamaddaUtil.getUrl(URL_ENTRY_SHOW),ARG_OUTPUT,"points.product","product","points.json","numpoints",1e3,ARG_ENTRYID,i.getId())));let l=new DerivedPointData(this.displayManager,"Derived Data",s,"average"),a=this.jq(ID_CHARTTYPE).val();e.createDisplay(a,{layoutFixed:!1,data:l})}})}function RamaddaRepositoriesDisplay(e,t,i){RamaddaUtil.inherit(this,new RamaddaEntryDisplay(e,t,DISPLAY_REPOSITORIES,i)),addRamaddaDisplay(this),RamaddaUtil.defineMembers(this,{initDisplay:function(){let e=this;this.createUI();let t="";0==this.ramaddas.length?t+=this.getMessage("No repositories specified"):t+=this.getMessage("Loading repository listing"),this.numberWithTypes=0,this.finishedInitDisplay=!1,this.ramaddas.length>1&&"all"==this.ramaddas[this.ramaddas.length-1].getRoot()&&this.ramaddas.splice(this.ramaddas.length-1,1);for(let t=0;t<this.ramaddas.length;t++){null!=this.ramaddas[t].getEntryTypes((function(t,i){e.gotTypes(t,i)}))&&this.numberWithTypes++}this.setDisplayTitle("Repositories"),this.setContents(t),this.finishedInitDisplay=!0,this.displayRepositories()},displayRepositories:function(){if(!this.finishedInitDisplay||this.numberWithTypes!=this.ramaddas.length)return;let e={},t=[],i="";i+=HU.openTag(TAG_TABLE,[ATTR_CLASS,"display-repositories-table",ATTR_WIDTH,HU.perc(100),ATTR_BORDER,"1",ATTR_CELLSPACING,"0",ATTR_CELLPADDING,"5"]);for(let i=0;i<this.ramaddas.length;i++){let s=this.ramaddas[i].getEntryTypes();for(let i=0;i<s.length;i++){let l=s[i];null==e[l.getId()]&&(e[l.getId()]=l,t.push(l))}}i+=HU.openTag(TAG_TR,[ATTR_VALIGN,POS_BOTTOM]),i+=HU.th([ATTR_CLASS,"display-repositories-table-header"],"Type");for(let e=0;e<this.ramaddas.length;e++){let t=this.ramaddas[e],s=HU.href(t.getRoot(),t.getName());i+=HU.th([ATTR_CLASS,"display-repositories-table-header"],s)}i+=HU.close(TAG_TR);let s=[];null!=this.categories&&(s=this.categories.split(","));let l={},a=[];for(let e=0;e<t.length;e++){let i=t[e],s="";s+=HU.open(TAG_TR),s+=HU.td([],HU.image(i.getIcon())+" "+i.getLabel());for(let e=0;e<this.ramaddas.length;e++){let t=this.ramaddas[e],l=t.getEntryType(i.getId());if(null==l)s+=HU.td([ATTR_CLASS,"display-repositories-table-type-hasnot"],"");else{let e=HU.tag(TAG_A,[ATTR_HREF,t.getRoot()+"/search/type/"+l.getId(),ATTR_TARGET,"_blank"],l.getEntryCount());s+=HU.td([ATTR_ALIGN,ALIGN_RIGHT,ATTR_CLASS,"display-repositories-table-type-has"],e)}}s+=HU.close(TAG_TR);let r=l[i.getCategory()];null==r&&(r=[],l[i.getCategory()]=r,a.push(i.getCategory())),r.push(s)}for(let e=0;e<a.length;e++){let t=a[e];if(s.length>0){let e=!1;for(let i=0;i<s.length;i++){if(t==s[i]){e=!0;break}if(t.match(s[i])){e=!0;break}}if(!e)continue}let r=l[t];i+=HU.open(TAG_TR),i+=HU.th([ATTR_COLSPAN,""+(1+this.ramaddas.length)],t),i+=HU.close(TAG_TR);for(let e=0;e<r.length;e++)i+=r[e]}i+=HU.closeTag(HU.TAG_TABLE),this.setContents(i)},gotTypes:function(e,t){this.numberWithTypes++,this.displayRepositories()}})}function DisplayEntryMetadata(e,t,i){this.display=e,this.metadata=i,this.metadataType=t,t.addNot=i.addNot,i.elements&&(this.elements=i.elements.map((t=>new DisplayEntryMetadataElement(e,this,t)))),$.extend(this,{getType:function(){return this.metadataType.getType()},getLabel:function(){return this.metadataType.getLabel()},getAddNot:function(){return this.metadataType.getAddNot()},getElements:function(){return this.elements}})}function DisplayEntryMetadataElement(e,t,i){this.display=e,this.metadata=t,this.element=i,$.extend(this,{getMetadataType:function(){return this.metadata.getType()},getType:function(){return this.element.type},getName:function(){return this.element.name},getIndex:function(){return this.element.index},getValues:function(){return this.element.values},getInputText:function(){return jqid(this.inputId).val()},makeInput:function(){return this.inputId=this.display.getMetadataFieldId(this.metadata.getType())+"_element_"+this.getIndex()+"_input",HU.input("","",[ATTR_CLASS,CLASS_SIMPLESEARCH_INPUT,ATTR_ID,this.inputId,ATTR_STYLE,HU.css(CSS_WIDTH,HU.perc(100)),ATTR_PLACEHOLDER,this.getName()])},cbxState:{},setCbxOn:function(e){this.cbxState[e]=!0},setCbxOff:function(e){this.cbxState[e]=!1},addSearchSettings:function(e){let t;if(Object.keys(this.cbxState).forEach((t=>{this.cbxState[t]&&e.metadata.push({type:this.getMetadataType(),label:this.getName(),index:this.getIndex(),value:t})})),this.selectId&&jqid(this.selectId).length?t=jqid(this.selectId).val():"string"==this.getType()&&(t=this.getInputText()),t){let i=t;Array.isArray(i)||(i=[i]),i.forEach((t=>{Utils.stringDefined(t)&&e.metadata.push({type:this.getMetadataType(),label:this.getName(),index:this.getIndex(),value:t})}))}},makeCheckboxes:function(e,t){let i=[];this.selectId=this.display.getMetadataFieldId(this.metadata.getType())+"_select_"+this.getIndex();let s=t?"":HU.tag(TAG_OPTION,[ATTR_TITLE,"",ATTR_VALUE,""]),l=this.display.getTagPopupLimit(),a=this.display.getProperty("metadata."+this.metadata.getType()+".addnot",this.metadata.getAddNot());this.getValues().forEach(((t,r)=>{let o=t.count,n=t.value,h=t.label,d=this.metadata.getType(),g=[ATTR_VALUE,n,ATTR_CLASS,"display-metadatalist-item"],p=this.cbxState[n];p&&(g.push("selected"),g.push(null)),s+=HU.tag(TAG_OPTION,g,h+" ("+o+")");let c=this.display.getMetadataFieldId(this.metadata.getType())+"_checkbox_"+this.getIndex()+"_"+r;e&&(e[c]=this);let u=HU.checkbox("",[ATTR_ID,c,ATTR_METADATA_TYPE,d,ATTR_METADATA_INDEX,this.getIndex(),ATTR_METADATA_VALUE,n],p)+" "+HU.tag(TAG_LABEL,[ATTR_CLASS,HU.classes("ramadda-noselect",CLASS_CLICKABLE),ATTR_FOR,c],h+" ("+o+")");if(this.getValues().length>l&&(u=HU.span([ATTR_CLASS,CLASS_SEARCH_TAG,"tag",h],u)),i.push(u),a){let t=this.display.getMetadataFieldId(this.metadata.getType())+"_notcheckbox_"+this.getIndex()+"_"+r;e&&(e[t]=this);let s=HU.checkbox("",[ATTR_ID,t,"metadata-not",!0,ATTR_METADATA_TYPE,d,ATTR_METADATA_INDEX,this.getIndex(),ATTR_METADATA_VALUE,n],p)+" "+HU.tag(TAG_LABEL,[ATTR_CLASS,HU.classes("ramadda-noselect",CLASS_CLICKABLE),ATTR_FOR,t],HU.b("Not ")+h+" ("+o+")");this.getValues().length>l&&(s=HU.span([ATTR_CLASS,CLASS_SEARCH_TAG,"tag",h],s)),i.push(s)}}));let r=[ATTR_ID,this.selectId];return t&&r.push(ATTR_MULTIPLE,"true",ATTR_SIZE,4),this.select=HU.tag(TAG_SELECT,r,s),i}})}function RamaddaExampleDisplay(e,t,i){var s="click",l="data";RamaddaUtil.inherit(this,new RamaddaDisplay(e,t,"example",i)),addRamaddaDisplay(this),RamaddaUtil.defineMembers(this,{initDisplay:function(){this.createUI();var e=this.getGet(),t=HU.p();t+=HU.onClick(e+".click();",HU.div([ATTR_ID,this.getDomId(s)],"Click me")),t+=HU.p(),t+=HU.div([ATTR_ID,this.getDomId(l)],""),this.setContents(t),this.updateUI()},needsData:function(){return!0},updateUI:function(){var e=this.getData();if(null!=e){e.getRecordFields();var t="";t+="#records:"+e.getRecords().length,this.jq(l).html(t)}},handleEventRecordSelection:function(e,t){},click:function(){this.jq(s).html("Click again")}})}addGlobalDisplayType({type:DISPLAY_SIMPLESEARCH,label:"Simple Search",requiresData:!1,category:CATEGORY_ENTRIES,desc:"Show a search field for entry or in page search"}),addGlobalDisplayType({type:DISPLAY_SEARCH,label:"Entry Search",requiresData:!1,category:CATEGORY_ENTRIES,help:"/userguide/wiki/wikisearch.html",desc:"Show the full search form"}),addGlobalDisplayType({type:DISPLAY_ENTRYDISPLAY,label:"Entry Display",requiresData:!1,category:CATEGORY_ENTRIES}),addGlobalDisplayType({type:DISPLAY_ENTRYTITLE,label:"Entry Title",requiresData:!1,category:CATEGORY_ENTRIES}),addGlobalDisplayType({type:DISPLAY_ENTRYWIKI,label:"Entry Wiki",requiresData:!1,category:CATEGORY_ENTRIES}),addGlobalDisplayType({type:DISPLAY_ENTRY_GALLERY,label:"Entry Gallery",requiresData:!1,category:CATEGORY_ENTRIES}),addGlobalDisplayType({type:DISPLAY_ENTRY_GRID,label:"Entry Date Grid",requiresData:!1,category:CATEGORY_ENTRIES}),addGlobalDisplayType({type:DISPLAY_METADATA,label:"Metadata Table",requiresData:!1,category:CATEGORY_ENTRIES});const DISPLAY_MAP="map";let displayMapMarkers=["marker.png","marker-blue.png","marker-gold.png","marker-green.png"],displayMapCurrentMarker=-1,displayMapUrlToVectorListeners={},displayMapMarkerIcons={};var ID_REGION_SELECTOR="regionselector",ID_LEGENDID="legendid",ID_SHOWMARKERSTOGGLE="showMarkersToggle",debugit=!1,debugMapTime=!1,CLASS_ANIM_BUTTON="display-anim-button";function MapFeature(e,t){RamaddaUtil.defineMembers(this,{source:e,points:t})}addGlobalDisplayType({type:DISPLAY_MAP,label:"Map",category:CATEGORY_MAPS,preview:"map1.png",desc:"Lots of ways to show georeferenced data - dots, heatmaps, plots, etc",help:"/userguide/wiki/wikimaps.html"});var ID_MAP="map",ID_MAP_CONTAINER="mapcontainer",xcnt=1,ycnt=1;function RamaddaBaseMapDisplay(e,t,i,s){$.extend(this,{theMap:null}),this.myycnt=++ycnt,this.myName="map "+this.myycnt;const l=new RamaddaDisplay(e,t,i,s);RamaddaUtil.inherit(this,l),this.defineSizeByProperties();let r=[{label:"Base Map Properties"},{p:"bounds",ex:"north,west,south,east",tt:"initial bounds"},{p:"maxBounds",ex:"n,w,s,e or conus",tt:"max bounds when applying filters"},{p:"gridBounds",ex:"north,west,south,east"},{p:"mapCenter",ex:"lat,lon",tt:"initial position"},{p:"zoomLevel",ex:4,tt:"initial zoom"},{p:"centerOnConus",ex:!0},{p:"centerOnNA",ex:!0},{p:"initBoundsUseAllRecords",ex:!0},{p:"initBoundsPadding",ex:"A percent, e.g.0.05"},{p:"zoomTimeout",ex:500,tt:"initial zoom timeout delay. set this if the map is in tabs, etc, and not going to the initial zoom"},{p:"popupWidth",d:400},{p:"popupHeight",d:200},{p:"linked",ex:!0,tt:"Link location with other maps"},{p:"linkGroup",ex:"some_name",tt:"Map groups to link with"},{p:"initialLocation",ex:"lat,lon",tt:"initial location"},{p:"defaultMapLayer",ex:"osm|google.roads|esri.street|google.hybrid|google.roads|google.terrain|google.satellite|opentopo|esri.topo|usfs|usgs.topo|naip|usgs.imagery|esri.shaded|esri.lightgray|esri.darkgray|esri.terrain|shadedrelief|esri.aeronautical|historic|osm.toner|osm.toner.lite"},{p:"geojsonLayer",ex:"entry ID",tt:"Display the geojson layer file held by give entry"},{p:"geojsonLayerName",d:"Map"},{p:"justShowMapLayer",ex:!0,tt:"If true then just show map layer, don't use it for data display"},{p:"extraLayer1",label:"XYZ Layer",ex:"xyz:name:Some Name:url:https\\\\://server/tiles/${z}/${x}/${y}.png:baseLayer:false:visible:true"},{p:"extraLayer1",label:"WMS Layer",ex:"wms:name:Some Name:url:https://server/tiles/${z}/${x}/${y}.png:baseLayer:false:visible:true"},{p:"extraLayer1",label:"GeoJSON Layer",ex:"geojson:name:Some Name:url:resources/usmap.json:fillColor:transparent"},{p:"extraLayer1",label:"KML Layer",ex:"geojson:name:Some Name:url:resources/usmap.json:fillColor:transparent"},{p:"linkFields",tt:"Comma separated list of fields in the data to match with the map field, e.g., geoid"},{p:"linkFeature",ex:"geoid",tt:"The field in the map to match with the data field, e.g., geoid"},{p:"debugFeatureLinking",tt:"Debug feature linking",ex:!0},{p:"pruneFeatures",ex:!0,tt:"Hide any features in the map that don't have a corresponding record"},{p:"showHighlight",ex:"true",tt:"Show popup when point is moused over"},{p:"highlightTemplate",ex:"Some text ${field1}",tt:"Template for mousing over points"},{p:"highlightWidth",d:200,tt:"Width of highlight popup"},{p:"highlightHeight",ex:200,tt:"Height of highlight popup"},{p:"polygonField",tt:"Field that contains a polygon"},{p:"annotationLayerTop",ex:"true",tt:"If showing the extra annotation layer put it on top"},{p:"showBoundsFilter"},{p:"showBounds",ex:"true",d:!1},{p:"boundsStrokeColor",d:"blue"},{p:"boundsFillColor",d:COLOR_TRANSPARENT},{p:"boundsFillOpacity",d:"0.0"},{p:"showOpacitySlider",ex:"false"},{p:"showLocationSearch",ex:"true"},{p:"showLatLonPosition",ex:"false",d:!0},{p:"singlePointZoom",ex:"12"},{p:"showOverviewMap",ex:!0},{p:"overviewMapWidth",d:180},{p:"overviewMapHeight",d:90},{p:"overviewMapHeight",d:90},{p:"overviewMapResolution",d:1},{p:"overviewMapMinRatio",d:24},{p:"overviewMapMaxRatio",d:64},{p:"overviewMapLayer",ex:"osm|google.roads|esri.street|google.hybrid|google.roads|google.terrain|google.satellite|opentopo|esri.topo|usfs|usgs.topo|naip|usgs.imagery|esri.shaded|esri.lightgray|esri.darkgray|esri.terrain|shadedrelief|esri.aeronautical|historic|osm.toner|osm.toner.lite"},{p:"showGraticules",ex:!0},{p:"showLayerSwitcher",d:!0,ex:"false"},{p:"showScaleLine",ex:"true",d:!0},{p:"showZoomPanControl",ex:"true",d:!0},{p:"showZoomOnlyControl",ex:"false",d:!1},{p:"enableDragPan",ex:"false",d:!0},{p:"showLayers",d:!0,ex:"false",tt:"Connect points with map vectors"},{p:"showBaseLayersSelect",ex:!0,d:!1},{p:"baseLayerSelectLabel",d:null},{p:"locations",ex:"countries.json,usstates.json,uscities.json,usairports.json"},{p:"highlightColor",d:"blue",ex:COLOR_LIGHT_GRAY,tt:""},{p:"highlightFillColor",ex:COLOR_LIGHT_GRAY,tt:'Use "match" to match the features opacity'},{p:"highlightFillOpacity",ex:"0.5",tt:'Use "match" to match the features opacity'},{p:"highlightStrokeWidth",ex:"2",tt:'Use "match" to match the features opacity'},{p:"highlightStrokeColor",tt:'Use "match" to match the features opacity'},{p:"selectFillColor",ex:COLOR_LIGHT_GRAY,tt:'Use "match" to match the features opacity'},{p:"selectFillOpacity",ex:"0.5",tt:'Use "match" to match the features opacity'},{p:"selectStrokeWidth",ex:"2",tt:'Use "match" to match the features opacity'},{p:"selectStrokeColor",tt:'Use "match" to match the features opacity'},{p:"selectStrokeOpacity",tt:'Use "match" to match the features opacity'},{p:"vectorLayerStrokeColor",d:COLOR_BLACK},{p:"vectorLayerFillColor",d:COLOR_LIGHT_GRAY},{p:"vectorLayerFillOpacity",d:.25},{p:"vectorLayerStrokeWidth",d:.3}];this.debugZoom=s.debugZoom,displayDefineMembers(this,r,{mapBoundsSet:!1,extraLayers:[],initDisplay:function(){l.initDisplay.call(this),HU.documentReady||$(document).ready((()=>{this.map&&setTimeout((()=>{this.callingUpdateSize=!0,this.map.getMap().updateSize(),this.callingUpdateSize=!1}),50)}));let e=this,t="",i=this.getProperty("height",this.getProperty("mapHeight",HU.vh(70)));i<0&&(i=HU.perc(-i)),i=HU.getDimension(i),t+=HU.css(ATTR_HEIGHT,i);let s=HU.div([ATTR_TABINDEX,1,ATTR_CLASS,HU.classes("display-map-map","ramadda-expandable-target"),ATTR_STYLE,t,ATTR_ID,this.domId(ID_MAP)]),a=HU.div([ATTR_CLASS,"ramadda-map-container",ATTR_ID,this.domId(ID_MAP_CONTAINER)],s+HU.div([ATTR_CLASS,"ramadda-map-slider",ATTR_STYLE,this.getProperty("popupSliderStyle",HU.css(CSS_MAX_HEIGHT,HU.px(400),CSS_OVERFLOW_Y,OVERFLOW_AUTO,CSS_OVERFLOW_X,OVERFLOW_AUTO)),ATTR_ID,this.domId(ID_MAP)+"_slider"]));if(this.setContents(a),this.map?this.map.setMapDiv(this.domId(ID_MAP)):this.createMap(),!this.haveCalledUpdateUI){let t=function(){e.updateUICallback=null,e.updateUI()};this.updateUICallback=setTimeout(t,1)}},initRegionsSelector:function(e){if(!MapUtils.regions){$.getJSON(RamaddaUtil.getUrl("/regions.json"),(t=>{if(GuiUtils.isJsonError(t))return console.log("Error fetching regions"),void(MapUtils.regions=[]);MapUtils.regions=t,this.initRegionsSelector(e)}));return}let t=this;t.regionsDialog&&t.regionsDialog.remove();let i=t.domId(ID_REGION_SELECTOR),s=t.makeRegionsMenu();s=HU.div([ATTR_CLASS,CLASS_POPUP_INNER,ATTR_ID,i,ATTR_STYLE,HU.css(CSS_MARGIN,HU.em(1),CSS_MIN_WIDTH,HU.px(800))],s),t.regionsDialog=HU.makeDialog({content:s,title:"Regions",draggable:!0,header:!0,my:POS_LEFT_TOP,at:POS_LEFT_BOTTOM,anchor:e}),t.regionsDialog.find(HU.dotClass(CLASS_MENU_ITEM)).click((function(){let e=MapUtils.regions[+$(this).attr(ATTR_IDX)];t.map.setViewToBounds(new RamaddaBounds(e.north,e.west,e.south,e.east))})),this.jq("regionsearch").focus();let l=this.regionsDialog.find(".ramadda-region-item");this.jq("regionsearch").keyup((function(e){let t=$(this).val().trim().toLowerCase();l.each((function(){if(""==t)$(this).show();else{let e=$(this).html();if(!e)return;e=e.toLowerCase(),e.indexOf(t)>=0?$(this).show():$(this).hide()}}))}))},makeRegionsMenu:function(){let e={};MapUtils.regions.forEach(((t,i)=>{if("World"==t.name)return;let s=t.group;"model regions"==s.toLowerCase()&&(s="Regions");let l=t.name.replace(/ /g,SPACE),a=HU.div([ATTR_CLASS,HU.classes(CLASS_MENU_ITEM,"ramadda-region-item"),ATTR_IDX,i],l);e[s]||(e[s]=""),e[s]+=a}));let t="";t+=HU.center(HU.input("","",[ATTR_PLACEHOLDER,"Find Region",ATTR_ID,this.domId("regionsearch"),ATTR_WIDTH,10])),t+=HU.open(TAG_TABLE,[ATTR_WIDTH,HU.perc(100)])+HU.open(TAG_TR,[ATTR_VALIGN,ALIGN_TOP]);let i=Object.keys(e),s=HU.perc(100/i.length);return i.forEach((i=>{t+=HU.td([ATTR_WIDTH,s],HU.div([ATTR_STYLE,HU.css(CSS_FONT_WEIGHT,FONT_BOLD,CSS_BORDER_BOTTOM,HU.border(1,COLOR_LIGHT_GRAY),CSS_MARGIN_RIGHT,HU.px(5))],Utils.camelCase(i))+HU.div([ATTR_STYLE,HU.css(CSS_MAX_HEIGHT,HU.px(200),CSS_OVERFLOW_Y,OVERFLOW_AUTO,CSS_MARGIN_RIGHT,HU.px(10))],e[i]))})),t+=HU.close(TAG_TR,TAG_TABLE),t},getTurfPoints:function(e){let t=[];return e.geometry.coordinates.forEach((e=>{t.push(e[1],e[0])})),t},makeTurfBounds:function(e,t){if(Utils.isDefined(t)){let i=e.east-e.west,s=e.north-e.south;return[e.west-t*i,e.south-t*s,e.east+t*i,e.north+t*s]}return[e.west,e.south,e.east,e.north]},makeFeature:function(e,t,i,s){if(s.length>2){let l=[];for(let e=0;e<s.length;e+=2)l.push(MapUtils.createPoint(s[e+1],s[e]));if("OpenLayers.Geometry.Polygon"==t){e.transformPoints(l);let t=MapUtils.createLinearRing(l),s=MapUtils.createPolygon(t);return MapUtils.createVector(s,null,i)}return e.createPolygon("","",l,i,null,"OpenLayers.Geometry.LineString"==t)}let l=MapUtils.createLonLat(s[1],s[0]);return e.createPoint("",l,i)},createGeoJsonLayer:function(e,t,i,s){i?i.removeFeatures(i.features):(i=MapUtils.createLayerVector(e,{projection:this.getMap().getMap().displayProjection},s),this.getMap().addLayer(i),i.ramaddaLayerIndex=100,Utils.isDefined(this.layerVisible)&&!this.layerVisible&&i.setVisibility(!1));let l=new OpenLayers.Format.GeoJSON({}).read(t),a=new OpenLayers.Strategy.Fixed;return a.layer=i,a.merge({features:l}),this.extraLayers.push(i),i},getBaseLayersSelect:function(){if(this.map.baseLayers){let e=[],t=!1;for(a in this.map.baseLayers){let i=this.map.baseLayers[a];i.isBaseLayer&&(i.getVisibility()&&(t=a),e.push([a,i.name]))}let i=this.getBaseLayerSelectLabel();return i&&(i=HU.boldLabel(i)),HU.span([ATTR_TITLE,"Choose base layer",ATTR_CLASS,"display-filter"],(i??"")+HU.select("",[ATTR_ID,this.domId("baselayers")],e,t))}return""},initBaseLayersSelect:function(){let e=this;this.jq("baselayers").change((function(){let t=$(this).val();for(let i in e.map.baseLayers)if(i==t){e.map.getMap().setBaseLayer(e.map.baseLayers[i]);break}}))},checkLevelRange:function(e,t){e||(e=[this.getMap().getMarkersLayer()]),this.debugZoom&&console.log("features:");let i=this.getMap().getMap().getZoom();e.forEach((e=>{e&&e.features.forEach((s=>{if(!s.levelRange)return void(this.debugZoom&&console.log("\tno level range"));s.style||(s.style={});let l=!1;i>=s.levelRange.min&&i<=s.levelRange.max?(l=s.style.display!=DISPLAY_INLINE,s.style.display=DISPLAY_INLINE):(l=s.style.display!=DISPLAY_NONE,s.style.display=DISPLAY_NONE),t&&l&&e.drawFeature(s)}))}))},getMap:function(){return this.map},setErrorMessage:function(e){this.errorMessageHandler?this.errorMessageHandler(this,e):this.map?this.map.setProgress(HU.div([ATTR_CLASS,"display-map-message"],e)):l.setErrorMessage.call(this,e)},setMessage:function(e){this.map&&(""!=e&&(e=HU.div([ATTR_CLASS,"display-map-message"],e)),this.map.setProgress(e))},setMapLabel:function(e){this.map&&this.map.setLabel(HU.div([ATTR_CLASS,"display-map-message"],e))},startProgress:function(e){this.setMessage(e??this.getProperty("loadingMessage","Creating map..."))},clearProgress:function(){this.errorMessage?this.errorMessage=null:this.map&&(this.map.hideLoadingImage(),this.map.setProgress(""))},checkLayout:function(){if(!this.map)return;let e=this.jq(ID_MAP);e.width()>0&&this.lastWidth!=e.width()&&this.map&&(this.lastWidth=e.width(),this.map.getMap().updateSize())},initMapParams:function(e){e.maxBounds=this.getMaxBounds(),this.getProperty("canMove",!1)&&(e.canMove=!0),this.getProperty("addMapLocationToUrl",!0)||(e.addToUrl=!1),this.getSinglePointZoom()&&(e.singlePointZoom=this.getSinglePointZoom()),this.getShowOpacitySlider()&&(e.showOpacitySlider=!0),["highlightStrokeColor","highlightFillColor","highlightStrokeWidth","highlightFillOpacity","changeSizeOnSelect"].forEach((t=>{let i=this.getProperty(t);Utils.isDefined(i)&&(e[t]=i)}))},initMap:function(e){},doDisplayMap:function(){return!0},createMap:function(){if(this.map=this.getProperty("externalMap",null),this.map)return this.map;let e=this,t={defaultMapLayer:this.getDefaultMapLayer(map_default_layer),showLayerSwitcher:this.getShowLayerSwitcher(),showScaleLine:this.getShowScaleLine(),showLatLonPosition:this.getShowLatLonPosition(),showZoomPanControl:this.getShowZoomPanControl(),showZoomOnlyControl:this.getShowZoomOnlyControl(),enableDragPan:this.getEnableDragPan(),highlightColor:this.getHighlightColor(),highlightFillColor:this.getHighlightFillColor("match"),highlightFillOpacity:this.getHighlightFillOpacity(),highlightStrokeWidth:this.getHighlightStrokeWidth(1),selectFillColor:this.getSelectFillColor("match"),selectFillOpacity:this.getSelectFillOpacity(),selectStrokeWidth:this.getSelectStrokeWidth(),selectStrokeColor:this.getSelectStrokeColor(),selectStrokeOpacity:this.getSelectStrokeOpacity(),showLatLonLines:this.getProperty("showLatLonLines"),popupWidth:this.getPopupWidth(),popupHeight:this.getPopupHeight()};this.mapParams=t;let i=this.getProperty("displayDiv",null);if(i&&(t.displayDiv=i,t.displayDivSticky=this.getProperty("displayDivSticky",!1)),this.getShowLocationSearch(!0)||(t.showLocationSearch=!1),t.addMarkerOnClick=this.getProperty("addMarkerOnClick"),t.linked=this.getLinked(!1),t.linkGroup=this.getLinkGroup(null),this.hadInitialPosition=!1,this.getProperty("latitude")&&(this.hadInitialPosition=!0,t.initialLocation={lon:+this.getProperty("longitude",-105),lat:+this.getProperty("latitude",40)}),this.getCenterOnConus()&&(this.getZoomLevel()||this.setProperty("zoomLevel",3),this.setProperty("mapCenter","39.8333,-98.5855")),this.getCenterOnNA()&&(this.getZoomLevel()||this.setProperty("zoomLevel",3),this.setProperty("mapCenter","46.17983,-92.43896")),this.hadUrlArgumentMapCenter=Utils.stringDefined(HU.getUrlArgument(ARG_MAPCENTER)),this.hadUrlArgumentZoom=Utils.stringDefined(HU.getUrlArgument(ARG_ZOOMLEVEL)),!this.hadUrlArgumentMapCenter&&this.getMapCenter()&&(this.hadInitialPosition=!0,[lat,lon]=this.getMapCenter().replace("%2C",",").split(","),t.initialLocation={lon:lon,lat:lat}),!this.hadUrlArgumentZoom&&this.getZoomLevel()&&(this.hadInitialPosition=!0,t.initialZoom=+this.getZoomLevel(),t.initialZoomTimeout=this.getZoomTimeout(),debugBounds&&console.log("DisplayMap - set initialZoom",t.initialZoom)),this.map=this.getProperty("theMap",null),this.map)this.map.setMapDiv(this.domId(ID_MAP));else{if(this.getInitialLocation()){let e=this.getInitialLocation().split(",");t.initialLocation={lat:+e[0],lon:+e[1]}}if(this.initMapParams(t),this.map=new RepositoryMap(this.domId(ID_MAP),t),this.map.popupListener=(t,i)=>{let s=jqid(t).find("["+ATTR_FIELD_ID+"]");s.addClass(CLASS_CLICKABLE),s.click((function(){let t=$(this).attr(ATTR_FIELD_ID),i=$(this).attr(ATTR_FIELD_VALUE);if(i&&i.toLowerCase().startsWith("http"))return void window.open(i,"_link");let s={id:t,fieldId:t,value:i};e.propagateEvent(DisplayEvent.filterChanged,s,!0)}))},this.getShowOverviewMap()){let e={size:{}},t=this.getOverviewMapLayer();t&&(t=this.getMap().getMapLayer(t),t&&(e.layers=[t.clone()])),e.size.w=this.getOverviewMapWidth(),e.size.h=this.getOverviewMapHeight(),e.resolutionFactor=this.getOverviewMapResolution(),e.minRatio=this.getOverviewMapMinRatio(),e.maxRatio=this.getOverviewMapMaxRatio(),this.map.setShowOverviewMap(!0,e)}this.getShowGraticules()&&this.map.setGraticulesVisible(!0),this.map.myid=this.getLogLabel(),this.map.addKeyUpListener((e=>{this.handleKeyUp(e)})),this.map.addKeyDownListener((e=>{this.handleKeyDown(e)})),this.map.textGetter=(e,t)=>null,this.lastWidth=this.jq(ID_MAP).width()}this.initMap(this.map),this.doDisplayMap()&&this.map.setDefaultCanSelect(!1),this.map.initMap(!1);let s=Utils.isDefined(this.getZoomLevel())||Utils.isDefined(this.getMapCenter())||this.hadInitialPosition;if(this.getPropertyBounds()||this.getPropertyGridBounds()){this.hadInitialPosition=!0;let e=this.getPropertyBounds(this.getGridBounds("")).split(",");if(4==e.length){if(this.getShowBounds()){let t={};this.getBoundsStrokeColor(this.getProperty("boundsColor"))&&(t.strokeColor=this.getBoundsStrokeColor(this.getProperty("boundsColor"))),t.fillColor=this.getBoundsFillColor(),t.fillOpacity=this.getBoundsFillOpacity(),this.map.addRectangle("bounds",parseFloat(e[0]),parseFloat(e[1]),parseFloat(e[2]),parseFloat(e[3]),t,"").noSelect=!0}!s&&this.setInitMapBounds&&this.setInitMapBounds(parseFloat(e[0]),parseFloat(e[1]),parseFloat(e[2]),parseFloat(e[3]))}}if(this.getProperty("annotationLayer")){let e={theMap:this.map,embedded:!0,displayOnly:!0};this.getPropertyAnnotationLayerTop()&&(e.layerIndex=100),this.editableMap=new RamaddaEditablemapDisplay(this.getDisplayManager(),HU.getUniqueId(""),e),this.editableMap.initDisplay(!0),this.editableMap.loadMap(this.getProperty("annotationLayer"))}let l=[];this.getProperty("extraLayers")&&(l=Utils.mergeLists(l,this.getProperty("extraLayers").split(","))),Utils.stringDefined(this.getProperty("extraLayer"))&&l.push(this.getProperty("extraLayer"));for(let e=1;Utils.stringDefined(this.getProperty("extraLayer"+e));e++)l.push(this.getProperty("extraLayer"+e));l.length&&setTimeout((()=>{this.addExtraLayers(l)}),1e3),this.getShowLayers()&&setTimeout((()=>{let e=!0,t=t=>(e=!0,t.startsWith("true:")?(t=t.substring("true:".length),e=!0):t.startsWith("false:")&&(t=t.substring("false:".length),e=!1),t);if(this.getProperty("shapefileLayer")){let i=Utils.split(this.getProperty("shapefileLayer",""),",",!0,!0),s=Utils.split(this.getProperty("shapefileLayerName",""),",",!0,!0);i.forEach(((i,l)=>{i=t(i);let a=HU.url(RamaddaUtil.getUrl(URL_ENTRY_SHOW),ARG_OUTPUT,"shapefile.kml",ARG_ENTRYID,i),r=s[l]??"Map";this.addBaseMapLayer(a,r,!0,e)}))}if(this.getProperty("kmlLayer")){let i=Utils.split(this.getProperty("kmlLayer",""),",",!0,!0),s=Utils.split(this.getProperty("kmlLayerName",""),",",!0,!0);i.forEach(((i,l)=>{i=t(i);let a=this.getRamadda().getEntryDownloadUrl(i),r=s[l]??"Map";this.addBaseMapLayer(a,r,!0,e)}))}let i,s=0;for(;i=this.getProperty("geojsonLayer"+s);)this.addBaseMapLayer(i,"",!1,e),s++;if(this.getProperty("geojsonLayer")){let i=Utils.split(this.getProperty("geojsonLayer",""),",",!0,!0),s=Utils.split(this.getProperty("geojsonLayerName",""),",",!0,!0);i.forEach(((i,l)=>{i=t(i);let a=this.getRamadda().getEntryDownloadUrl(i),r=s[l]??"Map";this.addBaseMapLayer(a,r,!1,e)}))}let l=this.getProperty("mapLayers");if(l&&l.forEach){this.displayingMapLayer=!1;let e=e=>{let t;t="shapefile"==e.type?HU.url(RamaddaUtil.getUrl(URL_ENTRY_SHOW),ARG_OUTPUT,"shapefile.kml",ARG_ENTRYID,e.id):this.getRamadda().getEntryDownloadUrl(e.id),e.match&&(this.displayingMapLayer=!0),this.addBaseMapLayer(t,e.name,"kml"==e.type||"shapefile"==e.type,e.match,e.style)};l.forEach((t=>{t.match&&e(t)})),l.forEach((t=>{t.match||e(t)}))}}),500)},addExtraLayers:function(e){e.forEach((e=>{if(0==e.trim().length)return;let t={},i=(e=(e=e.replace(/https:/g,"https_semicolon_")).replace(/\\:/g,"_semicolon_")).split(":"),s=i[0];for(let s=1;s<i.length;s+=2){let l=i[s+1];l?t[i[s].trim()]=Utils.getProperty(l.replace(/_semicolon_/g,":").replace(/_comma_/g,",")):console.log("Poorly formed extraLayers:"+e)}let l=t.name??s,a=!!Utils.isDefined(t.baseLayer)&&t.baseLayer,r=!Utils.isDefined(t.visible)||t.visible;if("baselayer"==s){if(t.layer||2!=i.length||(t.layer=i[1]),!t.layer)return void this.logMsg("Could not find base layer:",e);let s=this.map.getBaseLayer(t.layer);s?s.setVisibility(!0):this.logMsg("Could not find base layer:",e)}else if("geojson"==s||"kml"==s){let e=(e=>e?(e.startsWith("resources")?e=RamaddaUtil.getUrl("/"+e):e.startsWith("/resources")?e=RamaddaUtil.getUrl(e):e.startsWith("/")||e.startsWith("http")||(e=HU.url(RamaddaUtil.getUrl(URL_ENTRY_GET),ARG_ENTRYID,e)),e):null)(t.url);t.fillColor||(t.fillColor=COLOR_TRANSPARENT),"kml"==s?this.map.addKmlLayer(l,e,!1,null,null,t,null):this.map.addGeoJsonLayer(l,e,!1,null,null,t,null)}else if("wms"==s){let e=t.url;if(!e)return void console.log("no url in wms:",t);let i=t.layer;if(!i)return void console.log("no layer in wms:",t);let s=t.opacity??1;i=this.map.addWMSLayer(l,e,i,a,!0,{visible:r,opacity:s}),a&&(r||this.getDefaultMapLayer()==l)&&this.map.getMap().setBaseLayer(i)}else if("xyz"==s){let e=t.url;if(!e)return void console.log("no url in xyz:",t);let i=this.map.createXYZLayer(l,e,t.attribution,!a,r);this.map.addLayer(i),a&&(r||this.getDefaultMapLayer()==l)&&this.map.getMap().setBaseLayer(i)}else console.log("Unknown map type:"+s)}))},handleKeyUp:function(e){},handleKeyDown:function(e){},addBaseMapLayer:function(e,t,i,s,l){l||(l={});let a=this;if(mapLoadInfo=displayMapUrlToVectorListeners[e],null==mapLoadInfo){mapLoadInfo={otherMaps:[],layer:null};let r=function(e){a.mapFeatureSelected(e)};r=null;let o=null!=this.getProperty("bounds")||Utils.isDefined(this.getProperty("zoomLevel"))||Utils.isDefined(this.getProperty("mapCenter")),n={strokeColor:s?this.getVectorLayerStrokeColor():this.getProperty("extraVectorLayerStrokeColor","blue"),fillColor:this.getVectorLayerFillColor(),fillOpacity:s?this.getVectorLayerFillOpacity():0,strokeWidth:s?this.getVectorLayerStrokeWidth():this.getProperty("extraVectorLayerStrokeWidth",1)};$.extend(n,l);let h,d=(t,l)=>{a.baseMapLoaded(l,e,i?n:null,s)};h=i?this.map.addKMLLayer(t??"Map",e,s&&this.doDisplayMap(),r,null,n,d,!o&&s):this.map.addGeoJsonLayer(t??"Map",e,s&&this.doDisplayMap(),r,null,n,d,!o&&s)}else mapLoadInfo.layer?this.cloneLayer(mapLoadInfo.layer):(this.map.showLoadingImage(),mapLoadInfo.otherMaps.push(this))},baseMapLoaded:function(e,t,i,s){if(i&&e.features&&(e.features.forEach((e=>{e.style?$.extend(e.style,i):e.style=$.extend({},i)})),e.redraw()),!this.getJustShowMapLayer()&&s&&(this.vectorLayer=e,this.applyVectorMap(),mapLoadInfo=displayMapUrlToVectorListeners[t],mapLoadInfo)){mapLoadInfo.layer=e;for(let t=0;t<mapLoadInfo.otherMaps.length;t++)mapLoadInfo.otherMaps[t].cloneLayer(e);mapLoadInfo.otherMaps=[]}},applyVectorMap:function(e,t,i){},getBounds:function(){return this.map?this.map.getBounds():null}})}function RamaddaMapDisplay(e,t,i){const s="latfield",l="lonfield",r="sizebylegend",o="shapes",n="heatmapanimlist",h="heatmapanimplay",d="heatmapanimstepforward",g="heatmapanimstepback",p="heatmaptoggle",c="trackview";$.extend(this,{showBoxes:!0,showPercent:!1,percentFields:null,kmlLayer:null,kmlLayerName:"",geojsonLayer:null,geojsonLayerName:"",theMap:null,layerVisible:!0});const u=new RamaddaBaseMapDisplay(e,t,DISPLAY_MAP,i);RamaddaUtil.inherit(this,u),addRamaddaDisplay(this),this.defineSizeByProperties();let T="square|triangle|downtriangle|circle|plane|star|cross|diamond|x|thinx||lightning|church",f=[{label:"Map Properties"},{p:"strokeWidth",d:1},{p:"strokeColor",d:COLOR_BLACK},{p:"strokeOpacity",d:1},{p:"fillColor",d:"blue"},{p:"fillOpacity",d:.5},{p:"radius",d:5,tt:"Size of the map points"},{p:"scaleRadius",ex:"true",tt:"Scale the radius based on # points shown"},{p:"scaleRadiusMin",d:1},{p:"scaleRadiusMax",d:10},{p:"scaleRadiusMaxPoints",d:5e3},{p:"radiusList",tt:"comma separated list of count:size",ex:"100:15,200:12,300:10"},{p:"maxRadius",ex:"16",d:1e3},{p:"shape",d:"circle",ex:T,tt:"Use shape"},{p:"shapeBy",tt:"field to shape by"},{p:"shapeByMap",ex:"value1:"+T+":label1,value2:..."},{p:"defaultShape",ex:T},{p:"markerIcon",ex:"/icons/..."},{p:"iconSize",ex:16},{p:"hideMissingColor",ex:!0,tt:"hide points when no color by value"},{p:"justOneMarker",ex:"true",tt:"This is for data that is all at one point and you want to support selecting points for other displays"},{p:"showPoints",ex:"true",tt:"Also show the map points when showing heatmap or glyphs or vectors"},{p:"applyPointsToVectors",d:!0,tt:"If false then just show any attached map vectors without coloring them from the points"},{p:"bounds",ex:"north,west,south,east",tt:"initial bounds"},{p:"gridBounds",ex:"north,west,south,east"},{p:"mapCenter",ex:"lat,lon",tt:"initial position"},{p:"zoomLevel",ex:4,tt:"initial zoom"},{p:"zoomTimeout",ex:500,tt:"initial zoom timeout delay. set this if the map is in tabs, etc, and not going to the initial zoom"},{p:"fixedPosition",ex:!0,tt:"Keep the initial position"},{p:"linked",ex:!0,tt:"Link location with other maps"},{p:"linkGroup",ex:"some_name",tt:"Map groups to link with"},{p:"initialLocation",ex:"lat,lon",tt:"initial location"},{p:"defaultMapLayer",ex:"osm|google.roads|esri.street|google.hybrid|google.terrain|google.satellite|opentopo|esri.topo|usfs|usgs.topo|naip|usgs.imagery|esri.shaded|esri.lightgray|esri.darkgray|esri.terrain|shadedrelief|esri.aeronautical|historic|osm.toner|osm.toner.lite"},{p:"extraLayers",tt:"comma separated list of layers to display",ex:"baselayer:goes-visible,baselayer:nexrad,geojson:US States:/resources/usmap.json:fillColor:transparent"},{p:"skipZero",ex:"true",tt:"Skip locations that are at 0,0"},{p:"doPopup",ex:"false",tt:"Do not show popups"},{p:"doPopupSlider",ex:"true",tt:"Do the inline popup that slides down"},{p:"popupSliderRight",ex:"true",tt:"Position the inline slider to the right"},{p:"popupSliderStyle",ex:"max-width:300px;overflow-x:auto;",tt:""},{p:"showRegionSelector",ex:!0},{p:"regionSelectorLabel"},{p:"centerOnFilterChange",d:!0,ex:!1,tt:"Center map when the data filters change"},{p:"centerOnHighlight",ex:!0,tt:"Center map when a record is highlighted"},{p:"centerOnMarkersAfterUpdate",ex:!0,tt:"Always center on the markers"},{p:"zoomLevelOnHighlight",ex:16,tt:"Set the zoom level"},{p:"doInitCenter",tt:"Center the maps on initialization"},{p:"boundsAnimation",ex:!0,tt:"Animate when map is centered"},{p:"iconField",ex:'""',tt:"Field id for the image icon url"},{p:"rotateField",ex:'""',tt:"Field id for degrees rotation"},{p:"rotateScale",d:"1.0",tt:"Scale value to multiply the rotate field value by to get degrees rotation"},{p:"filterBadLocations",ex:"false",d:!0,tt:"Do not show records with bad lat/lon"},{p:"hideNaN",tt:"If doing color by do not show the points with missing values"},{label:"Map GUI"},{p:"showTableOfContents",ex:"true",tt:"Show left table of contents"},{p:"tocTitle"},{p:"tocWidth"},{p:"tocZoom",ex:3,tt:"zoom level when clicking on a table of contents item"},{p:"tocFields",ex:"",tt:"fields to show in TOC"},{p:"tocTemplate",ex:"",tt:"template to show in TOC"},{p:"showMarkersToggle",ex:"true",tt:"Show the toggle checkbox for the marker layer"},{p:"showMarkersToggleLabel",ex:"label",tt:"Label to use for checkbox"},{p:"showClipToBounds",ex:"true",tt:"Show the clip bounds checkbox"},{p:"clipToBounds",ex:"true",tt:"Clip to bounds"},{p:"showMarkers",ex:"false",tt:"Hide the markers"},{p:"acceptEntryMarkers",ex:"true",d:!1,tt:"If other maps can add entry markers and boxes"},{label:"Map Highlight"},{p:"showRecordSelection",ex:"false",d:"true"},{p:"highlight",ex:"true",tt:"Show mouse over highlights"},{p:"displayDiv",tt:"Div id to show highlights in"},{p:"showRecordHighlight",d:!0},{p:"recordHighlightFeature",ex:"true",tt:"If there is a vector map that is being shown then highlight the map feature instead of drawing a point"},{p:"recordHighlightIcon",ex:"/icons/plane.png"},{p:"recordHighlightIconSize",d:30},{p:"recordHighlightShape",ex:T},{p:"recordHighlightRadius",ex:"20",tt:"Radius to use to show other displays highlighted record"},{p:"recordHighlightStrokeWidth",d:3,tt:"Stroke to use to show other displays highlighted record"},{p:"recordHighlightStrokeColor",d:"red",tt:"Color to use to show other displays highlighted record"},{p:"recordHighlightFillColor",ex:"rgba(0,0,0,0)",tt:"Fill color to use to show other displays highlighted record"},{p:"recordHighlightFillOpacity",ex:"0.5",tt:"Fill opacity to use to show other displays highlighted record"},{p:"recordHighlightVerticalLine",tt:"Draw a vertical line at the location of the selected record"},{p:"highlightColor",ex:COLOR_LIGHT_GRAY,tt:""},{p:"highlightFillColor",ex:COLOR_LIGHT_GRAY,tt:""},{p:"highlightStrokeWidth",ex:"2",tt:""},{p:"unhighlightColor",ex:COLOR_LIGHT_GRAY,tt:"Fill color when records are unhighlighted with the filters"},{p:"unhighlightStrokeWidth",ex:"1",tt:"Stroke width for when records are unhighlighted with the filters"},{p:"unhighlightStrokeColor",ex:"#aaa",tt:"Stroke color for when records are unhighlighted with the filters"},{p:"unhighlightRadius",d:-1,ex:"1",tt:"Radius for when records are highlighted with the filters"},{label:"Map Collisions"},{p:"handleCollisions",ex:!0,tt:"Handle point collisions"},{p:"showCollisionToggle",ex:!0,tt:"Show the toggle checkbox"},{p:"collisionFixed",d:!1,ex:!0,tt:"If true, don't show the grouped markers on a click"},{p:"collisionPointSize",d:16,tt:"Size of each point. Higher # is more spread out"},{p:"collisionDotColor",d:COLOR_WHITE,tt:"Color of dot drawn at center"},{p:"collisionDotOpacity",d:"0.9",tt:"Opacity of dot drawn at center"},{p:"collisionRingColor",d:COLOR_BLACK,tt:"Color of ring"},{p:"collisionRingWidth",d:.25,tt:"Width of ring"},{p:"collisionDotColorOn",d:"blue",tt:"color to use when the collision marker is selected"},{p:"collisionDotRadius",d:12,tt:"Radius of dot drawn at center"},{p:"collisionScaleDots",ex:!0,d:!1,tt:"Scale the group dots"},{p:"collisionLineColor",ex:"red",tt:"Color of line drawn at center"},{p:"collisionLabelTemplate",d:"${count}"},{p:"collisionLabelColor",d:COLOR_BLACK},{p:"collisionLabelFontSize",d:"10"},{p:"collisionIcon",ex:"/icons/...",tt:"Use an icon for collisions",canCache:!0},{p:"collisionIconSize",d:16,ex:"16",canCache:!0},{p:"collisionTooltip",ex:"${default}",tt:"Tooltip to use for collision dot",canCache:!0},{label:"Map Lines"},{p:"showSegments",ex:"true",tt:"If data has 2 lat/lon locations draw a line"},{p:"segmentWidth",d:"1",tt:"Segment line width"},{p:"useGreatCircle",d:!1,ex:"true",tt:"use great circle routes for segments"},{p:"sizeSegments",d:!1,ex:"true",tt:"Size the segments based on record value"},{p:"isPath",ex:"true",tt:"Make a path from the points"},{p:"isPathThreshold",ex:"1000",tt:"Make path from the points if # records<threshold"},{p:"groupByField",tt:"Field id to group the paths"},{p:"pathWidth",d:"1"},{p:"pathColor",ex:"red"},{p:"pathWindowTime",tt:"Show leading dots",ex:"1 day"},{p:"pathWindowSize",tt:"Number of records to show as leading dots"},{p:"pathWindowStrokeColor"},{p:"isTrajectory",ex:"true",tt:"Make a path from the points"},{p:"showPathEndPoint",ex:!0},{p:"pathEndPointShape",ex:"arrow"},{p:"latField1",tt:"Field id for segments"},{p:"lonField1",tt:"Field id for segments"},{p:"latField2",tt:"Field id for segments"},{p:"lonField2",tt:"Field id for segments"},{p:"trackUrlField",ex:"field id",tt:"The data can contain a URL that points to data"},{label:"Map Labels"},{p:"labelTemplate",ex:"${field}",tt:"Display labels in the map"},{p:"declutterLabels",d:!0},{p:"labelRecordTemplate",ex:"${field}",tt:"Apply the template to the records. Use ${recordtemplate} for the labelTemplate"},{p:"labelKeyField",ex:"field",tt:"Make a key, e.g., A, B, C, ... based on the value of the key field"},{p:"labelLimit",ex:"1000",tt:"Max number of records to display labels"},{p:"labelFontColor",ex:COLOR_BLACK},{p:"labelFontSize",ex:HU.px(12)},{p:"labelFontFamily",ex:"'Open Sans', Helvetica Neue, Arial, Helvetica, sans-serif"},{p:"labelFontWeight",ex:"plain"},{p:"labelBackground",ex:"green"},{p:"labelStrokeColor",ex:COLOR_BLACK},{p:"labelStrokeWidth",d:1},{p:"labelAlign",ex:"l|c|r t|m|b"},{p:"labelXOffset",ex:"0"},{p:"labelYOffset",ex:"0"},{p:"labelOutlineColor",ex:COLOR_WHITE},{p:"labelOutlineWidth",ex:"0"},{p:"labelDeclutterPadding",d:1},{p:"labelDeclutterGranularity",d:1},{p:"labelDeclutterPixelsPerLine"},{p:"labelDeclutterPixelsPerCharacter"},{label:"Map Glyphs"},{p:"doGridPoints",ex:"true",tt:"Display a image showing shapes or bars",canCache:!0},{p:"gridWidth",ex:"800",tt:"Width of the canvas"},{label:"label glyph",p:"glyph1",ex:"type:label,pos:sw,dx:10,dy:-10,label:field_colon_ ${field}_nl_field2_colon_ ${field2}"},{label:"rect glyph",p:"glyph1",ex:"type:rect,pos:sw,dx:10,dy:0,colorBy:field,width:150,height:100"},{label:"circle glyph",p:"glyph1",ex:"type:circle,pos:n,dx:10,dy:-10,fill:true,colorBy:field,width:20,baseWidth:5,sizeBy:field"},{label:"3dbar glyph",p:"glyph1",ex:"type:3dbar,pos:sw,dx:0,dy:0,height:30,width:6,baseHeight:5,sizeBy:field"},{label:"gauge glyph",p:"glyph1",ex:"type:gauge,color:#000,pos:sw,width:50,height:50,dx:10,dy:-10,sizeBy:field,sizeByMin:0"},{label:"Hex map, Voronoi, etc"},{p:"mapType",ex:"hex or triangle or square or voronoi",tt:"Create a hex or triangle or square or voronoi map"},{p:"doHexmap",ex:"true",tt:"Create a hexmap"},{p:"doTrianglemap",ex:"true",tt:"Create a triangle map"},{p:"doSquaremap",ex:"true",tt:"Create a square map"},{p:"hexmapUseCount",ex:"true",tt:"Use the record count for the color"},{p:"hexmapUseEnum",ex:"true",tt:"Use the value which appears the most"},{p:"hexmapLabelTemplate",ex:"${count} ${colorbyvalue}",tt:"For the label"},{p:"hexmapShowTotal",ex:"true",tt:"Total the values"},{p:"hexmapMinValue",ex:"1",tt:"If doing averages this is the lower cut off to add to a total"},{p:"hexmapMaxValue",ex:"100",tt:"If doing averages this is the upper cut off to add to a total"},{p:"hexmapUseFullBounds",d:!0,tt:"When filtering is the original fill bounds used"},{p:"hexmapPadding",tt:"Percent to bad out the bounding box",d:.05},{p:"hexmapCellSide",tt:"How many on units per side",d:25},{p:"hexmapUnits",tt:"Side units",ex:"miles|kilometers|degrees|radians",d:"miles"},{p:"hexmapStrokeColor",d:"blue"},{p:"hexmapStrokeWidth",d:1},{p:"hexmapStrokeOpacity",d:1},{p:"hexmapStrokeDashstyle",d:"solid"},{p:"hexmapFillColor",d:COLOR_TRANSPARENT},{p:"hexmapFillOpacity",d:1},{p:"hexmapColorBy",tt:"Field id to color the hexmap by"},{p:"hexmapColorTable",tt:"Color table for hexmap"},{p:"hexmapEmptyStrokeColor"},{p:"hexmapEmptyStrokeWidth"},{p:"hexmapEmptyFillColor"},{p:"doVoronoi",ex:"true",tt:"Create  voronoi polygons"},{p:"voronoiColorBy",tt:"Field id to color the hexmap by"},{p:"voronoiStrokeColor",d:"blue"},{p:"voronoiStrokeWidth",d:1},{p:"voronoiStrokeOpacity",d:1},{p:"voronoiStrokeDashstyle",d:"solid"},{p:"voronoiFillColor",d:COLOR_TRANSPARENT},{p:"voronoiFillOpacity",d:1},{p:"voronoiPadding",ex:.1,tt:"% to pad the bounds, 0-1.0"},{label:"Heatmap"},{p:"doHeatmap",ex:"true",tt:"Grid the data into an image",canCache:!0},{p:"hmShowPoints",ex:"true",tt:"Also show the map points"},{p:"hmShowReload",ex:"true",tt:""},{p:"hmShowGroups",ex:"true",tt:""},{p:"hmBounds",ex:"north,west,south,east",tt:""},{p:"htmlLayerField"},{p:"htmlLayerShape",ex:"barchart|piechart"},{p:"htmlLayerWidth",ex:"30"},{p:"htmlLayerHeight",ex:"15"},{p:"htmlLayerStyle",ex:"css style"},{p:"htmlLayerScale",d:"2:0.75,3:1,4:2,5:3,6:4,7:6",tt:"zoomlevel:scale,..."},{p:"htmlLayerPopupLabelField"},{p:"htmlLayerMin",tt:"min value for sparkline"},{p:"htmlLayerMax",tt:"max value for sparkline"},{p:"htmlLayerFlipYAxis",ex:!0},{p:"htmlLayerDrawAxisLabels",ex:!0},{p:"htmlLayerPopupDrawAxisLabels",ex:!0},{p:"htmlLayerScaleWithAll",ex:"false",tt:"Scale data values with all or with just the local data"},{p:"cellShape",ex:"rect|3dbar|circle|vector"},{p:"cellColor",ex:"color"},{p:"cellFilled",ex:!0},{p:"cellSize",ex:"8"},{p:"cellSizeH",ex:"20",tt:"Base value to scale by to get height"},{p:"cellSizeHBase",ex:"0",tt:"Extra height value"},{p:"arrowLength",d:-1,canCache:!0},{p:"lineWidth",d:1,canCache:!0},{p:"angleBy",ex:"field",tt:"field for angle of vectors"},{p:"hmOperator",ex:"count|average|min|max"},{p:"hmAnimationSleep",ex:"1000"},{p:"hmReloadOnZoom",ex:"true"},{p:"reloadOnZoom",ex:"true"},{p:"hmGroupByDate",ex:"true|day|month|year|decade",tt:"Group heatmap images by date"},{p:"hmGroupBy",ex:"field id",tt:"Field to group heatmap images"},{p:"hmLabelPrefix"},{p:"hmShowToggle",ex:!0,tt:"Show the toggle checkbox to turn off/on the heatmap"},{p:"hmToggleLabel"},{p:"boundsScale",ex:"0.1",tt:"Scale up the map bounds"},{p:"hmFilter",ex:"average5|average9|average25|gauss9|gauss25",tt:"Apply filter to image"},{p:"hmFilterPasses",ex:"1"},{p:"hmFilterThreshold",ex:"1"},{p:"hmCountThreshold",ex:"1"}];f.push({label:"Canvas"}),f.push(...RamaddaDisplayUtils.getCanvasProps()),f.push(...RamaddaDisplayUtils.sparklineProps),displayDefineMembers(this,f,{mapBoundsSet:!1,features:[],myMarkers:{},mapEntryInfos:{},tracks:{},checkFinished:function(){return!0},initDisplay:function(){u.initDisplay.call(this);let e=this.getProperty("sizeByLegendSide");if(e){let t=HU.div([ATTR_ID,this.domId(r)]);"top"==e?this.jq(ID_HEADER0).append(t):"left"==e?this.jq(ID_LEFT).append(t):"right"==e?this.jq(ID_RIGHT).append(t):"bottom"==e?this.jq(ID_BOTTOM).append(t):console.log("Unknown legend side:"+e)}this.startProgress()},checkLayout:function(){if(!this.map)return;0!=this.jq(ID_MAP).width()&&setTimeout((()=>{this.checkLayoutInner()}),1e3)},checkLayoutInner:function(){let e=this.jq(ID_MAP);if(this.map.getMap().updateSize(),e.width()>0&&this.lastWidth!=e.width()&&(this.lastWidth=e.width()),!this.setMapLocationAndZoom&&this.mapParams&&(this.setMapLocationAndZoom=!0,this.mapParams.initialZoom>=0&&this.map.zoomTo(this.mapParams.initialZoom),this.mapParams.initialLocation)){let e=MapUtils.createLonLat(this.mapParams.initialLocation.lon,this.mapParams.initialLocation.lat);this.map.setCenter(e)}setTimeout((()=>{this.map.redraw()}),500)},handlePopup:function(e,t){if(!this.trackUrlField)return;let i=()=>{if(e.record)if(this.tracks[e.record.getId()])this.removeTrack(e.record);else{let t=e.record.getValue(this.trackUrlField.getIndex());$.getJSON(t,(t=>{this.loadTrack(e.record,t)})).fail((e=>{console.log("url failed:"+t+"\n"+e)}))}};this.jq(c).click(i),this.jq("trackview_1").click(i)},macroHook:function(e,t,i){if(!this.trackUrlField)return null;if(t.tag!=this.trackUrlField.getId())return null;if(0==String(i).trim().length)return"";this.currentPopupRecord=e;let s=null!=this.tracks[e.getId()]?"Remove track":t.attrs.label||"View track";return SPACE+HU.span([ATTR_CLASS,CLASS_CLICKABLE,ATTR_ID,this.domId(c)],s)},getRecordUrlHtml:function(e,t,i){if(this.currentPopupRecord=i,!this.trackUrlField||this.trackUrlField.getId()!=t.getId())return u.getRecordUrlHtml.call(this,e,t,i);i.getValue(t.getIndex());let s=null!=this.tracks[i.getId()]?"Remove track":e[t.getId()+".label"]||"View track";return HU.span([ATTR_CLASS,CLASS_CLICKABLE,ATTR_ID,this.domId("trackview_1")],s)},removeTrack:function(e){this.tracks[e.getId()]&&(this.map.removePolygon(this.tracks[e.getId()]),this.tracks[e.getId()]=null),this.jq(c).html("View track"),this.jq("trackview_1").html("View track"),this.jq(ID_LEFT).find(HU.attrSelect(ATTR_RECORD_ID,e.getId())).removeClass("display-map-toc-item-on")},loadTrack:function(e,t){let i=makePointData(t,null,this,""),s=RecordUtil.getPoints(i.getRecords(),{}),l=this.markers?this.markers[e.getId()]:null,a=this.jq(ID_LEFT).find(HU.attrSelect(ATTR_RECORD_ID,e.getId()));e.trackData=i,a.addClass("display-map-toc-item-on");try{e.setLocation(s[0].y,s[0].x);let t=MapUtils.createLonLat(s[0].x,s[0].y);t=this.map.transformLLPoint(t),l&&l.move(t)}catch(e){console.log(e)}let r={strokeColor:this.getStrokeColor("blue"),strokeWidth:this.getStrokeWidth(1),fillColor:this.getProperty("fillColor")||COLOR_TRANSPARENT},o=this.map.addPolygon("","",s,r);o.record=e,this.tracks[e.getId()]=o,o.geometry&&this.map.zoomToExtent(o.geometry.getBounds()),this.map.closePopup(),setTimeout((()=>{this.getDisplayManager().notifyEvent(DisplayEvent.dataSelection,this,{data:i})}),100)},applyToFeatureLayers:function(e){this.myFeatureLayer&&e(this.myFeatureLayer),this.myFeatureLayerNoSelect&&e(this.myFeatureLayerNoSelect)},addFeatures:function(e,t){let i=t?this.myFeatureLayerNoSelect:this.myFeatureLayer;i||(debugit&&ycnt!=this.myycnt&&console.trace("addFeatures",this.myName),i=t?this.myFeatureLayerNoSelect=this.map.createFeatureLayer("Map Features NS",!1):this.myFeatureLayer=this.map.createFeatureLayer("Map Features",!0),Utils.isDefined(this.layerVisible)&&i.setVisibility(this.layerVisible),this.getProperty("showMarkersToggle")&&!this.getProperty("markersVisibility",!0)&&this.applyToFeatureLayers((e=>{e.setVisibility(!1)})),this.myFeatures=[]),i.addFeatures(e),e.forEach((e=>{e.layer=i,this.myFeatures.push(e)}))},removeFeature:function(e){e&&this.applyToFeatureLayers((t=>{t.removeFeatures([e])}))},removeExtraLayers:function(){try{this.extraLayers.every((e=>(e.destroy(),this.map.removeLayer(e,!0),!0)))}catch(e){console.log(e)}this.extraLayers=[],this.heatmapLayers=[],this.voronoiLayer=null,this.hexmapLayer=null},getMyMapLayers:function(){return[this.heatmapLayers,this.voronoiLayer,this.hexmapLayer]},toString:function(){return"displaymap"},deleteDisplay:function(){debugit&&console.log("delete:"+this.myName),this.getDisplayManager().removeDisplay(this),this.removeFeatures(),this.displayDeleted=!0,this.map.getMap().events.unregister("updatesize",this,this.updatesizeFunc),this.map.getMap().events.unregister("moveend",this,this.moveendFunc),this.map.getMap().events.unregister("zoomend",this,this.zoomendFunc);let e=this.getPointData();e&&e.removeFromCache(this)},removeFeatures:function(){this.removeFeatureLayer(),this.removeExtraLayers()},setVisible:function(e){this.layerVisible=e;let t=!0;this.jq(ID_SHOWMARKERSTOGGLE).length>0&&(t=HU.isChecked(this.jq(ID_SHOWMARKERSTOGGLE))),t&&(this.myFeatureLayer&&this.myFeatureLayer.setVisibility(e),this.myFeatureLayerNoSelect&&this.myFeatureLayerNoSelect.setVisibility(e)),this.map.labelLayer&&this.map.labelLayer.setVisibility(e),this.extraLayers.forEach((t=>{t.setVisibility(e)}))},removeFeatureLayer:function(){debugMapTime&&(console.log("start removeFeatureLayer"),console.time("removeFeatureLayer")),this.myFeatureLayer&&(this.myFeatureLayer.destroy(),this.map.removeLayer(this.myFeatureLayer,!0),this.myFeatureLayer=null),this.myFeatureLayerNoSelect&&(this.myFeatureLayerNoSelect.destroy(),this.map.removeLayer(this.myFeatureLayerNoSelect,!0),this.myFeatureLayerNoSelect=null),this.labelFeatures&&(this.map.labelLayer.removeFeatures(this.labelFeatures,{silent:!0}),this.labelFeatures=null,this.jq(ID_LEGENDID).html("")),debugMapTime&&console.timeEnd("removeFeatureLayer"),this.myFeatures=null},initMapParams:function(e){u.initMapParams.call(this,e),(this.getDoPopupSlider()||this.getPopupSliderRight())&&(e.doPopupSlider=!0,this.getPopupSliderRight()&&(e.popupSliderRight=!0))},initMap:function(e){this.getShowMarkers(this.getProperty("markersVisibility",!0))||e.getMarkersLayer().setVisibility(!1);let t=this.getProperty("boundsAnimation");if(t){this.didAnimationBounds=!1;let e=t.split(",");if(4==e.length){let t=parseFloat(this.getProperty("animationPause","1000"));HU.callWhenScrolled(this.domId(ID_MAP),(()=>{if(this.didAnimationBounds)return;this.didAnimationBounds=!0;let t=e,i=MapUtils.createBounds(parseFloat(t[1]),parseFloat(t[2]),parseFloat(t[3]),parseFloat(t[0]));this.map.animateViewToBounds(i)}),t)}}},createMap:function(){u.createMap.call(this);let e=this;this.getShowMarkers(this.getProperty("markersVisibility",!0))||this.map.getMarkersLayer().setVisibility(!1),this.doDisplayMap()&&this.map.setDefaultCanSelect(!1),this.map.initMap(!1),this.map.addRegionSelectorControl((function(t){e.propagateEvent(DisplayEvent.mapBoundsChanged,{bounds:t,force:!0})}),!0),this.map.popupHandler=(e,t)=>{this.handlePopup(e,t)},this.map.addFeatureSelectHandler((e=>{debugPopup&&console.log("\tdisplaymap: featureSelectHandler");let t=e.record;if(e.collisionInfo)return debugPopup&&console.log("has collisioninfo"),e.collisionInfo.dotSelected(e);if(t&&(this.propagateEventRecordSelection({record:t}),this.propagateFilterFields(t)),t&&!this.getMap().getDoPopup()&&this.getShowRecordSelection()&&(debugPopup&&console.log("highlighting point"),this.highlightPoint(t.getLatitude(),t.getLongitude(),!0,!1)),t&&this.getProperty("shareSelected")){let e=this.getFieldById(null,ATTR_ID);e&&ramaddaDisplaySetSelectedEntry(t.getValue(e.getIndex()),this.getDisplayManager().getDisplays(),this),debugPopup&&console.log("\tdisplaymap: share selected")}return!1})),this.map.addFeatureHighlightHandler(((e,t)=>{let i=e.record;if(i){if(this.lastHighlightedRecord){let e={highlight:!1,record:this.lastHighlightedRecord};this.getDisplayManager().notifyEvent(DisplayEvent.recordHighlight,this,e),this.getAnimationEnabled()&&this.getAnimation().handleEventRecordHighlight(this,e),this.lastHighlightedRecord=null}t&&(this.lastHighlightedRecord=i);let e={highlight:t,record:i};this.getDisplayManager().notifyEvent(DisplayEvent.recordHighlight,this,e),this.getAnimationEnabled()&&this.getAnimation().handleEventRecordHighlight(this,e)}})),this.map.highlightBackgroundColor=this.getProperty("highlighBackgroundColor","#fffeec"),this.getProperty("addEntryMarkers")?this.map.setDoPopup(!0):this.map.setDoPopup(this.getProperty("doPopup",!0)),this.createTime=new Date,this.map.addClickHandler(this.domId(l),this.domId(s),null,this),this.map.getMap().events.register("updatesize",this,this.updatesizeFunc=()=>{this.callingUpdateSize||e.updateHtmlLayers()}),setTimeout((()=>{this.registerEvents()}),1e3);let t=this.getProperty("boundsAnimation");if(t){this.didAnimationBounds=!1;let i=t.split(",");if(4==i.length){let t=parseFloat(this.getProperty("animationPause","1000"));HU.callWhenScrolled(this.domId(ID_MAP),(()=>{if(e.didAnimationBounds)return;e.didAnimationBounds=!0;let t=i,s=MapUtils.createBounds(parseFloat(t[1]),parseFloat(t[2]),parseFloat(t[3]),parseFloat(t[0]));e.map.animateViewToBounds(s)}),t)}}let i=this.features;this.features=[];for(let e=0;e<i.length;e++)this.addFeature(i[e]);if(this.getProperty("displayEntries",!0)){let e=this.getDisplayManager().collectEntries();for(let t=0;t<e.length;t++){let i=e[t];this.handleEventEntriesChanged(i.source,i.entries)}}if(this.getProperty("addEntryMarkers")&&this.getDisplayEntry((e=>{e?e.getChildrenEntries((e=>{e.forEach((e=>{if(!e.hasLocation())return;let t=MapUtils.createLonLat(e.getWest(),e.getNorth()),i=HU.b(e.getName());e.getIsImage()&&(i+=HU.br()+HU.image(e.getImageUrl(),[ATTR_WIDTH,HU.perc(100)])),this.map.addMarker(e.getId(),t,e.getIconUrl(),"",i,null,16)}))})):console.log("failed to get entry")})),this.layerEntries){let t=function(t,i,s){e.handleLayerSelect(i)},i=function(t,i,s){e.handleLayerUnselect(i)},s=this.layerEntries.split(",");for(let e=0;e<s.length;e++){let l=s[e],a=HU.url(RamaddaUtil.getUrl(URL_ENTRY_SHOW),ARG_OUTPUT,"shapefile.kml",ARG_ENTRYID,l);this.map.addKMLLayer("layer",a,!0,t,i)}}for(let e=1;;e++){let t=this.getProperty("marker"+e);if(!t)break;this.map.addMarkerEmbed(t)}},registerEvents:function(){this.getMap().getMap().events.register("zoomend",this,this.zoomendFunc=()=>{if(!this.callingUpdateUI){if(this.lastUpdateTime){if((new Date).getTime()-this.lastUpdateTime.getTime()<2e3)return}if(this.debugZoom&&console.log("level:"+this.getMap().getMap().getZoom()),(this.pointLevelRange||this.glyphLevelRange)&&this.checkLevelRange([this.myFeatureLayer],!0),this.mapBoundsChanged(),this.checkHeatmapReload(),this.updateHtmlLayers(),this.haveAddPoints&&this.getHandleCollisions()){if(this.lastZoom==this.map.getZoom())return;this.lastCollisionTimeout&&clearTimeout(this.lastCollisionTimeout),this.lastTimeout=setTimeout((()=>{this.haveCalledUpdateUI=!1,this.updateUI(),this.lastCollisionTimeout=null}),1e3)}}}),this.map.getMap().events.register("moveend",this,this.moveendFunc=()=>{this.map.doingPopup||(this.mapBoundsChanged(),this.checkHeatmapReload())})},getBounds:function(){return this.map?this.map.getBounds():null},mapFeatureSelected:function(e){this.getPointData()&&(this.map.onFeatureSelect(e),Utils.isDefined(e.feature.record)&&this.propagateEventRecordSelection({record:e.feature.record}))},showVectorLayer:!0,toggleVectorLayer:function(){this.showVectorLayer=!this.showVectorLayer,null!=this.vectorLayer&&this.vectorLayer.setVisibility(this.showVectorLayer),this.haveCalledUpdateUI=!1,this.updateUI()},doDisplayMap:function(){return!!this.getShowLayers()&&(!!this.getProperty("displayAsMap",!0)&&((this.getProperty("kmlLayer")||this.getProperty("shapefileLayer")||this.getProperty("geojsonLayer")||this.displayingMapLayer)&&this.getShowLayers()?this.showVectorLayer:void 0))},cloneLayer:function(e){let t=this;this.map.hideLoadingImage();let i=(e=e.clone()).features,s=[];for(let t=0;t<i.length;t++){if(feature=i[t],feature=feature.clone(),feature.style){oldStyle=feature.style,feature.style={};for(let e in oldStyle)feature.style[e]=oldStyle[e]}feature.layer=e,s.push(feature)}e.removeAllFeatures(),this.map.getMap().addLayer(e),e.addFeatures(s),this.vectorLayer=e,this.applyVectorMap(),this.map.addSelectCallback(e,this.doDisplayMap(),(function(e,i,s){t.mapFeatureSelected(i)}))},handleEventPointDataLoaded:function(e,t){},handleEventFieldsSelected:function(e,t){this.getProperty("selectedFieldIsColorBy")&&t.length>0&&this.colorByFieldChanged(t[0])},handleLayerSelect:function(e){debugPopup&&this.logMsg("handleLayerSelect");let t=this.layerSelectArgs;if(!this.layerSelectPath){if(!t)return void this.map.onFeatureSelect(e);this.layerSelectPath=URL_SEARCH_DO}let i=RamaddaUtil.getUrl(this.layerSelectPath);if(t){let s=t.split(",");for(let t=0;t<s.length;t++){let l=s[t].split(":"),a=l[0],r=l[1],o=e.feature.attributes;for(let e in o){if(""+e==r){let t=null;if("object"==typeof o[e]||"Object"==typeof o[e]){t=o[e].value}else t=o[e];i=HU.appendArg(i,a,t),i=i.replace("${"+a+"}",t)}}}}i=HU.appendArg(i,"output","json"),new EntryList(this.getRamadda(),i,null,!1).doSearch(this),this.getEntryList().showMessage("Searching",HU.div([ATTR_STYLE,HU.css(CSS_MARGIN,HU.px(20))],this.getWaitImage()))},getEntryList:function(){if(!this.entryListDisplay){let e={showMenu:!0,showTitle:!0,showDetails:!0,layoutHere:!1,showForm:!1,doSearch:!1},t=this.getUniqueId("display");this.entryListDisplay=new RamaddaEntrylistDisplay(this.getDisplayManager(),t,e),this.getDisplayManager().addDisplay(this.entryListDisplay)}return this.entryListDisplay},entryListChanged:function(e){e.getEntries();this.getEntryList().entryListChanged(e)},handleLayerUnselect:function(e){this.map.onFeatureUnselect(e)},addMapLayer:function(e,t){let i=this,s=t.entry;if(this.addedLayers||(this.addedLayers={}),this.addedLayers[s.getId()]){let e=this.addedLayers[s.getId()];return void(e&&(this.map.removeKMLLayer(e),this.addedLayers[s.getId()]=null))}let l=s.getType().getId();if("geo_shapefile"==l||"geo_geojson"==l){let e=MapUtils.createBounds(s.getWest(),s.getSouth(),s.getEast(),s.getNorth());(e.left<-180||e.right>180||e.bottom<-90||e.top>90)&&(e=null);let t,a=function(e,t,s){debugPopup&&this.logMsg("selectCallback"),i.handleLayerSelect(t)},r=function(e,t,s){i.handleLayerUnselect(t)};if("geo_geojson"==l){let e=s.getRamadda().getEntryDownloadUrl(s);t=this.map.addGeoJsonLayer(this.getProperty("geojsonLayerName","Map"),e,this.doDisplayMap(),a,r,null,null,!0)}else{let e=HU.url(RamaddaUtil.getUrl(URL_ENTRY_SHOW),ARG_OUTPUT,"shapefile.kml",ARG_ENTRYID,s.getId());t=this.map.addKMLLayer(s.getName(),e,!0,a,r,null,null,!0)}return void(this.addedLayers[s.getId()]=t)}let a=s.getAttributeValue("base_url");if(!Utils.stringDefined(a))return void console.log("No base url:"+s.getId());let r=s.getAttributeValue("layer_name");null==r&&(r=s.getName()),this.map.addWMSLayer(s.getName(),a,r,!1)},mapBoundsChanged:function(){let e=this.map.getMap().calculateBounds().transform(this.map.sourceProjection,this.map.displayProjection);if(this.propagateEvent(DisplayEvent.mapBoundsChanged,{bounds:e,force:!1}),(this.clipToView||this.getClipToBounds())&&this.lastUpdateTime){(new Date).getTime()-this.lastUpdateTime.getTime()>1e3&&(this.haveCalledUpdateUI=!1,this.clipBounds=!0,this.updatingFromClip=!0,this.updateUI())}},addFeature:function(e){this.features.push(e),e.line=this.map.addPolygon("lines_"+e.source.getId(),RecordUtil.clonePoints(e.points),null)},getContentsDiv:function(){let e="";return this.getProperty("showInnerContents",!0)||(e+=HU.css(CSS_DISPLAY,DISPLAY_NONE)),HU.div([ATTR_STYLE,e,ATTR_CLASS,"display-inner-contents",ATTR_ID,this.domId(ID_DISPLAY_CONTENTS)],"")},addHighlightMarker:function(e){this.highlightMarkers||(this.highlightMarkers=[]),this.highlightMarkers.push(e)},removeHighlight:function(){this.highlightMarkers&&(this.highlightMarkers.forEach((e=>{this.removeFeature(e)})),this.highlightMarkers=null)},highlightPoint:function(e,i,s,l,a,r){if(this.getMap()&&(a||this.removeHighlight(),this.getShowRecordHighlight()&&s)){let s=MapUtils.createLonLat(i,e),a={pointRadius:parseFloat(this.getRecordHighlightRadius(this.getPropertyRadius(6)+8)),stroke:!0,strokeColor:this.getRecordHighlightStrokeColor(),strokeWidth:parseFloat(this.getRecordHighlightStrokeWidth(2)),fillColor:this.getRecordHighlightFillColor(COLOR_LIGHT_GRAY),fillOpacity:parseFloat(this.getRecordHighlightFillOpacity(.5))};if(this.getProperty("recordHighlightUseMarker",!1)){let e=+this.getRecordHighlightRadius(this.getRadius(24));this.addHighlightMarker(this.getMap().createMarker("pt-"+featureCnt,s,null,"pt-"+featureCnt,null,null,e))}else if(this.getRecordHighlightVerticalLine(!1)){let e=[];e.push(MapUtils.createPoint(i,0)),e.push(MapUtils.createPoint(i,80)),this.addHighlightMarker(this.getMap().createPolygon(t,"highlight",e,a,null))}else{a.graphicName=this.getRecordHighlightShape();let e,t=this.getRecordHighlightIcon();if(t){let i=this.getRecordHighlightIconSize();e=this.map.createMarker("highlight",s,t,"highlight",null,null,i,null,null,a)}else e=this.getMap().createPoint("highlight",s,a);this.addHighlightMarker(e)}this.highlightMarkers&&(this.highlightMarkers.forEach((e=>{r&&(e.record=r,e.textGetter=this.getTextGetter())})),this.addFeatures(this.highlightMarkers)),l&&this.getCenterOnHighlight()&&(this.getMap().setCenter(s),this.getZoomLevelOnHighlight()&&this.getMap().setZoom(this.getZoomLevelOnHighlight()))}},handleEventEntryMouseover:function(e,i){this.map&&(t=i.entry.getId()+"_mouseover",attrs={lineColor:"red",fillColor:"red",fillOpacity:.5,lineOpacity:.5,doCircle:!0,lineWidth:1,fill:!0,circle:{lineColor:"black"},polygon:{lineWidth:4}},this.addOrRemoveEntryMarker(t,i.entry,!0,attrs))},handleEventEntryMouseout:function(e,i){this.map&&(t=i.entry.getId()+"_mouseover",this.addOrRemoveEntryMarker(t,i.entry,!1))},handleEventAreaClear:function(){this.map&&this.map.clearRegionSelector()},propagateFilterFields:function(e){this.getFieldsByIds(null,this.getProperty("filterFieldsToPropagate")).map((t=>{let i={fieldId:t.getId(),value:e.getValue(t.getIndex())};this.propagateEvent(DisplayEvent.filterChanged,i)}))},doneLocation:!1,handleClick:function(e,t,i,s){let l=!1;if(t.shiftKey&&t.metaKey){this.doneLocation||(Utils.isAnonymous()?console.log("latitude,longitude"):console.log("latitude,longitude,address,city,state,zip,country"),this.doneLocation=!0);let e=s+","+i;if(Utils.isAnonymous()){this.map.addPoint("",MapUtils.createLonLat(i,s));Utils.copyToClipboard(e+"\n"),console.log(e)}else{let t=HU.url(RamaddaUtil.getUrl("/map/getaddress"),"latitude",s,"longitude",i);$.getJSON(t,(t=>{if(0==t.length)console.log(e+",,,,,");else{let l=t[0];this.map.addPoint("",MapUtils.createLonLat(i,s),null,l.address);console.log(e+","+l.address+","+l.city+","+l.state+","+l.zip+","+l.country)}})).fail((t=>{console.log(e+",,,,,")}))}return}if(this.lastFeatureSelectTime){let e=(new Date).getTime()-this.lastFeatureSelectTime.getTime();if(this.lastFeatureSelectTime=null,e<1e3)return void 0}if(t.shiftKey){if(Utils.isAnonymous())return;let e=prompt("Marker text","");if(!e)return;let t=HU.url(RamaddaUtil.getUrl("/metadata/addform"),AEG_ENTRYID,this.getProperty("entryId"),"metadata_type","map_marker","metadata_attr1",e,"metadata_attr2",s+","+i);return void(window.location=t)}if(!this.map)return void 0;if(this.doDisplayMap())return void 0;if(this.getJustOneMarker(!1)){l;let e=this.getPointData();e&&(e.handleEventMapClick(this,this,i,s)&&(this.startProgress("Reloading data..."),this.getMap().showLoadingImage()),this.getDisplayManager().notifyEvent("mapClick",this,{lat:s,lon:i}))}if(!this.records)return void 0;let a=RecordUtil.findClosest(this.records,i,s,[]);a&&(this.highlightMarkers&&this.highlightPoint(a.getLatitude(),a.getLongitude(),!0,!1),this.propagateFilterFields(a))},getPosition:function(){let e=jqid(this.domId(s)).val(),t=jqid(this.domId(l)).val();return null==e?null:[e,t]},haveInitBounds:!1,setInitMapBounds:function(e,t,i,s){this.map&&(this.haveInitBounds||(this.lastUpdateTime=new Date,this.haveInitBounds=!0,this.getProperty("doInitCenter",!0)&&this.map.centerOnMarkers(MapUtils.createBounds(t,i,s,e),!0)))},sourceToEntries:{},handleEventEntriesChanged:function(e,t){if(!this.map)return;if(e==this.lastSource&&this.map.clearSelectionMarker(),void 0!==e.forMap&&!e.forMap)return;let i=this.sourceToEntries[e.getId()];if(null!=i)for(let t=0;t<i.length;t++){let s=e.getId()+"_"+i[t].getId();this.addOrRemoveEntryMarker(s,i[t],!1)}this.sourceToEntries[e.getId()]=t;MapUtils.createLayerMarkers("Markers",{}),MapUtils.createLayerVector("Lines",{});let s=-90,l=180,a=90,r=-180,o=!1;for(let i=0;i<t.length;i++){let n=t[i],h=e.getId()+"_"+n.getId();this.addOrRemoveEntryMarker(h,t[i],!0);if(n.hasBounds()){if(n.getNorth()>90||n.getSouth()<-90||n.getEast()>180||n.getWest()<-180){console.log("bad bounds on entry:"+n.getName()+" "+n.getNorth()+" "+n.getSouth()+" "+n.getEast()+" "+n.getWest());continue}s=Math.max(s,n.getNorth()),a=Math.min(a,n.getSouth()),r=Math.max(r,n.getEast()),l=Math.min(l,n.getWest()),o=!0}}o&&MapUtils.createBounds(l,a,r,s)},handleEventEntrySelection:function(e,t){if(!this.map)return;let i=t.entry;if(null==i)return void this.map.clearSelectionMarker();t.selected;i.hasLocation()},addOrRemoveEntryMarker:function(e,t,i,s){if(!this.getAcceptEntryMarkers())return;s||(s={});let l={lineColor:t.lineColor,fillColor:t.lineColor,lineWidth:t.lineWidth,doCircle:!1,doRectangle:this.showBoxes,fill:!1,fillOpacity:.75,pointRadius:12,polygon:{},circle:{}};dfltPolygon={},dfltCircle={},$.extend(l,s),l.lineColor||(l.lineColor="blue"),$.extend(dfltPolygon,l),s.polygon&&$.extend(dfltPolygon,s.polygon),$.extend(dfltCircle,l),s.circle&&$.extend(dfltCircle,s.circle);let a=this.mapEntryInfos[e];if(i){if(null==a){if(a=new MapEntryInfo(t),this.mapEntryInfos[e]=a,t.hasBounds()&&l.doRectangle){let i={};a.rectangle=this.map.addRectangle(e,t.getNorth(),t.getWest(),t.getSouth(),t.getEast(),i)}let i=t.getLatitude(),s=t.getLongitude();if(i<-90||i>90||s<-180||s>180)return;let r=MapUtils.createLonLat(s,i);if(l.doCircle?(attrs={pointRadius:dfltCircle.pointRadius,stroke:!0,strokeColor:dfltCircle.lineColor,strokeWidth:dfltCircle.lineWidth,fillColor:dfltCircle.fillColor,fillOpacity:dfltCircle.fillOpacity,fill:dfltCircle.fill},a.circle=this.map.addPoint(e,r,attrs)):a.marker=this.map.addMarker(e,r,t.getIconUrl(),"",this.getEntryHtml(t)),t.polygon){let i=[];for(let e=0;e<t.polygon.length;e+=2)i.push(MapUtils.createPoint(t.polygon[e+1],t.polygon[e]));let s={strokeColor:dfltPolygon.lineColor,strokeWidth:Utils.isDefined(dfltPolygon.lineWidth)?dfltPolygon.lineWidth:2};a.polygon=this.map.addPolygon(e,t.getName(),i,s,a.marker)}let o=this;a.marker&&(a.marker.entry=t,a.marker.ramaddaClickHandler=function(e){o.handleMapClick(e)},null==this.handledMarkers&&(this.map.centerToMarkers(),this.handledMarkers=!0))}return a}null!=a&&(a.removeFromMap(this.map),this.mapEntryInfos[e]=null)},handleMapClick:function(e){null!=this.selectedMarker&&this.getDisplayManager().handleEventEntrySelection(this,{entry:this.selectedMarker.entry,selected:!1}),this.getDisplayManager().handleEventEntrySelection(this,{entry:e.entry,selected:!0}),this.selectedMarker=e},fakeLocations:function(){return this.getTheLinkFields()&&this.getLinkFeature()},getTheLinkFields:function(){let e=this.getFieldById(null,this.getProperty("linkField")),t=this.getFieldsByIds(null,this.getProperty("linkFields"));return 0==t.length&&null!=e&&(t=[e]),0==t.length&&(t=null),t},applyVectorMap:function(e,t,i){let s=!1;if(!e&&this.vectorMapApplied)return;let l=this.myPoints||this.myFeatures;if(!this.doDisplayMap()||!this.vectorLayer||!l)return;if(!this.getApplyPointsToVectors())return;i||(i={}),s&&this.logMsg("applyVectorMap"),t||(t=this.textGetter);let a=this.getTheLinkFields(),r=this.getLinkFeature(),o=this.vectorLayer.features.slice(),n=o.slice();this.recordToFeature={};let h=this.getDebugFeatureLinking();if(s=h,l.forEach((e=>{let t=e.record;if(!t)return;let i=t.getDisplayProperty(this.getId(),"feature");i&&(this.recordToFeature[t.getId()]=i)})),r&&a){r=r.toLowerCase();let e={};if(l.forEach((t=>{let i=t.record;if(i){let t=i.getData(),s="";if(a.forEach((e=>{s+=t[e.getIndex()]})),s=s.toString().trim(),i.linkValue=s,e[s]){let t=e[s],l=i.getDisplayProperty(this.getId(),"colorByValue"),a=t.getDisplayProperty(this.getId(),"colorByValue");Utils.isDefined(l)&&Utils.isDefined(a)&&l>a&&(e[s]=i)}else e[s]=i}})),s){let t=Object.keys(e);console.log("map data/feature linking: data fields:"+a.map((e=>e.getId()))),l.length>0&&console.dir("all fields:"+l[0].record.fields.map((e=>e.getId()))),window.displayMapSamples=t,console.log("to view all record values do: console.log(displayMapSamples)\nvalues 0-10:"+t.slice(0,10)),console.log("looking for map feature:"+r),console.log("#map features:"+o.length+" #records:"+l.length+" #unique record values:"+t.length)}let t=0,i=0;window.displayMapMissingFeatures=[],o.forEach(((s,l)=>{let a=s.attributes,o=!1;for(let l in a){let n=String(l).toLowerCase();if(r!=n)continue;o=!0;let d=this.map.getAttrValue(a,l);if(Utils.isDefined(d))if(d=d.toString().trim(),s.linkValue=d,record=e[d],record){record.getDisplayProperty(this.getId(),"colorByValue");i++,h&&i<3&&console.log("%cfound record:"+d+": "+record.getId(),"color: green;"),this.recordToFeature[record.getId()]=s}else h&&(window.displayMapMissingFeatures.push(a),t++,t<3&&console.log("%ccould not find record with map value:"+d+":","color: red;"),t<2&&console.log("feature:",a));else console.log("\tno map feature attribute value")}o||0!=l||console.log("No map feature found:"+r,"attrs:",a)})),h&&(console.log("features matched: "+i+" not matched:"+t),t>0&&console.log("to view all missing map features do: console.log(displayMapMissingFeatures)"))}let d=0;o.forEach(((e,t)=>{e.wasPruned=e.pruned,e.pruned=!1,e.newStyle=null,e.style&&(e.style.display=DISPLAY_INLINE_BLOCK),e.featureIndex=d++,e.featureMatched=!1,e.pointCount=0,e.circles=[],e.style&&(e.style.balloonStyle=null)})),this.vectorMapApplied=!0;let g=null,p=this.getProperty("colorByCount",!1),c=[],u={},T=-1,f=-1;if(l.forEach(((e,i)=>{if(e.style&&e.style.display==DISPLAY_NONE)return;let s=e.record,l=e.center,a={index:-1,maxExtent:g},r=this.recordToFeature[s.getId()];r?r.geometry&&(null===g&&(g=MapUtils.createBounds()),g.extend(r.geometry.getBounds())):l&&(r=this.findContainingFeature(o,l,a,!1)),r&&(r.featureMatched=!0,s.setDisplayProperty(this.getId(),"feature",r),!e.colorByColor&&e.hasColorByValue&&isNaN(e.colorByValue)||(g=a.maxExtent,u[r.featureIndex]||(u[r.featureIndex]=!0,c.push(r)),r.circles.push(e),r.record=s,r.textGetter=t,p?(r.pointCount++,T=-1==T?r.pointCount:Math.max(T,r.pointCount),f=-1==f?r.pointCount:Math.min(f,r.pointCount)):a.index>=0&&o.splice(a.index,1)))})),!p)for(let e=0;e<c.length;e++){let t=c[e];style=t.style,style||(style={stylename:"from display"}),delete style.display;let i,s={};$.extend(s,style);let l=0;t.circles.forEach(((e,t)=>{(0==t||e.colorByValue>l)&&(l=e.colorByValue,i=e)})),i||(i=t.circles[0]),$.extend(s,i.style),t.newStyle=s,t.popupText=i.text,t.dataIndex=e}let y=this.getVectorLayerStrokeWidth(),m=this.getVectorLayerStrokeColor(),_=this.getVectorLayerFillOpacity(),S=this.getPruneFeatures();if(p){let e=this.getColorTable(!0);null==e&&(e=Utils.ColorTables.grayscale.colors);let t=T-f,i=this.getProperty("doCountLabel","points");for(let s=0;s<o.length;s++){let l=o[s],a=0==t?0:(l.pointCount-f)/t,r=parseInt(a*e.length);r>=e.length?r=e.length-1:r<0&&(r=0);let n=e[r],h=l.style;h||(h={stylename:"from display"});let d={};$.extend(d,h),$.extend(d,{fillColor:n,fillOpacity:_,strokeWidth:y,strokeColor:m}),0==l.pointCount&&!0===S&&(d.display=DISPLAY_NONE),l.newStyle=d,l.dataIndex=s,l.popupText=HU.div([],l.pointCount+SPACE+i)}this.displayColorTable(e,ID_COLORTABLE,f,T,{})}else if(S)for(let e=0;e<o.length;e++){let t=o[e];if(t.featureMatched)continue;let i=t.style;i||(i={stylename:"from display"});let s={};$.extend(s,i),s.display=DISPLAY_NONE,t.pruned=!0,t.newStyle=s}n.forEach(((e,t)=>{e.newStyle||(e.newStyle={}),(e.wasPruned&&!e.pruned||!e.style||e.newStyle.display&&e.newStyle.display==DISPLAY_NONE&&e.newStyle.display!=e.style.display||e.style.fillColor!=e.newStyle.fillColor)&&(e.style=e.newStyle,e.style.strokeWidth=y,e.style.strokeColor=m,e.style.fillOpacity=_,e.style.fillColor||(e.style.fillColor="rgba(230,230,230,0.5)",e.style.strokeColor="rgba(200,200,200,0.5)"),this.vectorLayer.drawFeature(e)),e.newStyle=null})),this.hadInitialPosition||this.applyMapVectorZoom||(this.applyMapVectorZoom=!0,this.hadUrlArgumentMapCenter||this.hadUrlArgumentZoom||!this.getProperty("doInitCenter",!0)||this.map.zoomToLayer(this.vectorLayer))},findContainingFeature:function(e,t,i,s){let l=null;for(let a=0;a<e.length;a++){let r=e[a],o=r.geometry;if(o){if(bounds=o.getBounds(),bounds.contains(t.x,t.y)){if(s&&console.log("\tfindContainingFeature:"+t.x+" "+t.y),o.components&&(s&&console.log("\thas components:"+o.components.length),o.components.every((e=>(bounds=e.getBounds(),bounds.contains(t.x,t.y)?e.containsPoint?(s&&console.log("\t\tcontains:"+e.containsPoint(t)),!e.containsPoint(t)||(l=r,r.geometry&&(null===i.maxExtent&&(i.maxExtent=MapUtils.createBounds()),i.maxExtent.extend(r.geometry.getBounds())),i.index=a,!1)):(s&&console.log("\t\tunknown geometry:"+e.CLASS_NAME),!0):(s&&console.log("\t\tnot contain:"+bounds+" "+e.CLASS_NAME),!0))))),l)return l;if(o.containsPoint){if(o.containsPoint(t)){null===i.maxExtent&&(i.maxExtent=MapUtils.createBounds()),i.maxExtent.extend(o.getBounds()),l=r,i.index=a;break}}else s&&!o.components&&console.log("unknown geometry:"+o.CLASS_NAME)}}else s&&console.log("\tno geometry")}return l},needsData:function(){return!0},animationStart:function(e){if(this.myFeatures)for(let e=0;e<this.myFeatures.length;e++){this.myFeatures[e].style.display=DISPLAY_NONE}this.map.circles&&this.map.circles.redraw()},handleDateRangeChanged:function(e,t){this.getAnimation().setDateRange(t.minDate,t.maxDate),this.applyDateRange()},animationApply:function(e){u.animationApply.call(this,e,!0),this.applyDateRange()},applyDateRange:function(){let e=this.getAnimation(),t=e.begin.getTime(),i=e.end.getTime(),s={};if(this.myFeatures)for(let e=0;e<this.myFeatures.length;e++){let l=this.myFeatures[e];if(l.date<t||l.date>i)l.style.display=DISPLAY_NONE;else if(s[l.location]){let e=s[l.location];e.date<l.date?(s[l.location]=l,e.style.display=DISPLAY_NONE,l.style.display=DISPLAY_INLINE):l.style.display=DISPLAY_NONE}else s[l.location]=l,l.style.display=DISPLAY_INLINE}this.applyToFeatureLayers((e=>{e.redraw()})),this.applyVectorMap(!0,this.textGetter)},showAllPoints:function(){if(this.myFeatures){for(let e=0;e<this.myFeatures.length;e++){this.myFeatures[e].style.display=DISPLAY_INLINE}this.map.lines&&this.map.lines.redraw()}this.applyToFeatureLayers((e=>{e.redraw()})),this.applyVectorMap(!0)},colorByFieldChanged:function(e){this.haveCalledUpdateUI=!1,this.setProperty("colorBy",e),this.vectorMapApplied=!1,this.updateUI({fieldChanged:!0})},sizeByFieldChanged:function(e){this.haveCalledUpdateUI=!1,this.setProperty("sizeBy",e),this.vectorMapApplied=!1,this.updateUI({fieldChanged:!0})},dataFilterChanged:function(e){e||(e={}),this.vectorMapApplied=!1,this.updateUI({source:e.source,dataFilterChanged:!0,dontSetBounds:!0,reload:!0,callback:t=>{if("animation"!=e.source&&this.getCenterOnFilterChange())return this.getShowPoints()&&t&&t.length?this.myFeatureLayer?.features?.length?void this.map.zoomToLayer(this.myFeatureLayer):void this.map.centerOnMarkers(null,!1,!0):void(this.vectorLayer&&this.showVectorLayer?this.map.zoomToLayer(this.vectorLayer,1.2):this.lastImageLayer?this.map.zoomToLayer(this.lastImageLayer):t&&t.length&&this.map.centerOnMarkers(null,!1,!0))}})},requiresGeoLocation:function(){return!this.fakeLocations()&&((!this.shapesField||!this.shapesTypeField)&&(!this.getLinkFields()&&!this.getProperty("linkField")||!this.getLinkFeature()))},addFilters:function(e){u.addFilters.call(this,e),this.getShowBoundsFilter()&&e.push(new BoundsFilter(this))},getHeader2:function(){let e=u.getHeader2.call(this);if(this.getProperty("showClipToBounds")&&(this.clipToView=!1,e=HU.div([ATTR_STYLE,HU.css(CSS_DISPLAY,DISPLAY_INLINE_BLOCK,CSS_CURSOR,CURSOR_POINTER,CSS_PADDING,HU.px(1),CSS_BORDER,HU.border(1,HU.rgba(0,0,0,0))),ATTR_TITLE,"Clip to view",ATTR_ID,this.domId("clip")],HU.getIconImage("fa-map"))+SPACE2+e),this.getProperty("showMarkersToggle")){let t=this.getProperty("markersVisibility",!0);e+=HU.checkbox(this.domId(ID_SHOWMARKERSTOGGLE),[ATTR_ID,this.domId(ID_SHOWMARKERSTOGGLE)],t,this.getProperty("showMarkersToggleLabel","Show Markers"))+SPACE2}return this.getShowBaseLayersSelect()&&(e+=this.getBaseLayersSelect()),this.getProperty("showVectorLayerToggle",!1)&&(e+=HU.checkbox("",[ATTR_ID,this.domId("showVectorLayerToggle")],!this.showVectorLayer)+" "+this.getProperty("showVectorLayerToggleLabel","Show Points")+SPACE4),e+=HU.div([ATTR_CLASS,CLASS_HEADER_SPAN,ATTR_ID,this.domId("locations")]),e},locationMenuCnt:0,addLocationMenu:function(e,t){let i="",s=this.locationMenuCnt++,l=t.label||t.name;l||(l=Utils.makeLabel(e.replace(/^.*[\\\/]/,"").replace(/\.[^\.]+$/,"").replace("_"," "))),i+=HU.div([ATTR_CLASS,HU.classes(CLASS_MENU_BUTTON,CLASS_CLICKABLE,"ramadda-map-button"),ATTR_ID,this.domId("location_"+s)],"View "+l)+SPACE,this.map.appendToolbar(i);let a=this;this.jq("location_"+s).click((function(){let e="",i=[];t.features?t.features.forEach((e=>{let t=e.properties.NAME||e.properties.name;i.push({name:t,geometry:e.geometry})})):i=t.locations,i.sort(((e,t)=>e.name.localeCompare(t.name))),i.forEach(((t,i)=>{console.dir(t),Utils.isDefined(t.latitude)?e+=HU.div([ATTR_CLASS,HU.classes(CLASS_CLICKABLE,CLASS_HOVERABLE,"display-map-location"),ATTR_LATITUDE,t.latitude,ATTR_LONGITUDE,t.longitude],t.name):Utils.isDefined(t.north)?e+=HU.div([ATTR_CLASS,HU.classes(CLASS_CLICKABLE,CLASS_HOVERABLE,"display-map-location"),ATTR_NORTH,t.north,ATTR_WEST,t.west,ATTR_SOUTH,t.south,ATTR_EAST,t.east],t.name):Utils.isDefined(t.geometry)&&(e+=HU.div([ATTR_CLASS,HU.classes(CLASS_CLICKABLE,CLASS_HOVERABLE,"display-map-location"),ATTR_INDEX,i],t.name))})),e=HU.div([ATTR_STYLE,HU.css(CSS_MAX_HEIGHT,HU.px(200),CSS_OVERFLOW_Y,OVERFLOW_AUTO,CSS_PADDING,HU.px(5))],e);let s=HU.getUniqueId(""),r=HU.div([ATTR_STYLE,HU.css(CSS_MIN_WIDTH,HU.px(300),CSS_MARGIN_TOP,HU.px(5))],HU.center(HU.div([ATTR_ID,s]))+e),o=HU.makeDialog({content:r,my:POS_LEFT_TOP,at:POS_LEFT_BOTTOM,anchor:$(this),decorate:!0,draggable:!1,title:l,draggable:!0,header:!0});HU.initPageSearch(o.find(HU.dotClass(CLASS_CLICKABLE)),null,"Search",!1,{target:"#"+s}),o.find(HU.dotClass(CLASS_CLICKABLE)).click((function(){if(a.locationFeatures&&a.locationFeatures.forEach((e=>{a.map.getHighlightLinesLayer().removeFeatures([e])})),a.locationFeatures=[],Utils.isDefined($(this).attr(ATTR_LONGITUDE))){let e=MapUtils.createLonLat(+$(this).attr(ATTR_LONGITUDE),+$(this).attr(ATTR_LATITUDE));a.map.zoomTo(9),a.map.setCenter(e)}else if(Utils.isDefined($(this).attr(ATTR_NORTH)))a.map.setViewToBounds(new RamaddaBounds(+$(this).attr(ATTR_NORTH),+$(this).attr(ATTR_WEST),+$(this).attr(ATTR_SOUTH),+$(this).attr(ATTR_EAST)));else{let e=i[$(this).attr(ATTR_INDEX)].geometry,t=e.type,s=e.coordinates,l={strokeColor:"blue",fillColor:"rgba(0,0,255,0.10)",strokeWidth:2};if("MultiPolygon"==t)for(let e=0;e<s.length;e++){let t=s[e];for(let e=0;e<t.length;e++)a.locationFeatures.push(a.createFeature(t[e],null,null,l))}else if("Polygon"==t)for(let e=0;e<s.length;e++)a.locationFeatures.push(a.createFeature(s[e],null,null,l));else console.log("Unknown geometry:"+t);a.map.centerOnFeatures(a.locationFeatures)}}))}))},initHeader2:function(){u.initHeader2.call(this);let e=this;if(this.initBaseLayersSelect(),this.getProperty("showTogglePath",!1)){let t=HU.checkbox("",[ATTR_ID,this.domId("togglepath")],this.getIsPath(),"Show track");this.jq(ID_HEADER2_PREPREFIX).append(HU.span([ATTR_STYLE,HU.css(CSS_PADDING_RIGHT,HU.px(10))],t)),this.jq("togglepath").click((function(){let t=HU.isChecked($(this));e.setProperty("isPath",t),e.setProperty("showPoints",!t),e.haveCalledUpdateUI=!1,e.updateUI({fieldChanged:!0})}))}this.getProperty("locations","").split(",").forEach((e=>{if(0==(e=e.trim()).length)return;let t=e.startsWith("show:");if(t&&(e=e.substring("show:".length)),e.startsWith("/")||e.startsWith("http")||(e=RamaddaUtil.getCdnUrl("/resources/"+e)),e.endsWith("geojson"))return void this.map.addGeoJsonLayer("location layer",e,!1,null,null,{},null);Utils.doFetch(e,(i=>{if(i=JSON.parse(i),this.addLocationMenu(e,i),t){let e={pointRadius:this.getProperty("locationRadius",4),fillColor:this.getProperty("locationFillColor","blue"),strokeWidth:this.getProperty("locationStrokeWidth",0),strokeColor:this.getProperty("locationStrokeColor","blue")};i.locations.forEach((t=>{let i=MapUtils.createLonLat(t.longitude,t.latitude);this.map.addPoint("",i,e,t.name)}))}}),(t=>{console.log("Error loading location json:"+e+"\n"+t)}),null)})),this.jq(ID_SHOWMARKERSTOGGLE).change((function(){let t=HU.isChecked($(this));e.applyToFeatureLayers((e=>{e.setVisibility(t)}))})),this.jq("showVectorLayerToggle").change((function(){e.toggleVectorLayer()})),this.jq("clip").click((function(t){e.clipToView=!e.clipToView,e.clipToView?$(this).css(CSS_BORDER,HU.border(1,"#aaa")):$(this).css(CSS_BORDER,HU.border(1,HU.rgba(0,0,0,0))),e.haveCalledUpdateUI=!1,e.updateUI()}))},handleNoData:function(e,t){this.jq(ID_PAGE_COUNT).html(""),this.addPoints([],[],[]),this.setMessage(this.getNoDataMessage())},createFeature:function(e,t,i,s){s||(this.baseStyle&&(this.baseStyle=$.extend({},MapUtils.getVectorStyle("default")),$.extend(this.baseStyle,{strokeColor:this.getProperty("vectorLayerStrokeColor",COLOR_BLACK),fillColor:this.getProperty("vectorLayerFillColor",COLOR_LIGHT_GRAY),fillOpacity:this.getProperty("vectorLayerFillOpacity",.1),strokeWidth:this.getProperty("vectorLayerStrokeWidth",1),cursor:CURSOR_POINTER})),s=this.baseStyle);let l=[];e.forEach((e=>{let t=MapUtils.createPoint(e[0],e[1]),i=this.map.transformLLPoint(t);l.push(i)}));let a=MapUtils.createLinearRing(l),r=MapUtils.createPolygon([a]),o=MapUtils.createVector(r,null,s);return this.map.getHighlightLinesLayer().addFeatures([o]),o.record=t,o.textGetter=i,o},loadShapes:function(e){this.coordinateFeatures&&this.map.getHighlightLinesLayer().removeFeatures(this.coordinateFeatures);let t=e=>e.record?this.getRecordHtml(e.record,null,this.getTooltip("${default}")):"NONE";this.coordinateFeatures=[],e.forEach(((e,i)=>{let s=e.getValue(this.shapesTypeField.getIndex()),l=e.getValue(this.shapesField.getIndex()),a=JSON.parse(l);if("MultiPolygon"==s)for(let i=0;i<a.length;i++){let s=a[i];for(let i=0;i<s.length;i++)this.coordinateFeatures.push(this.createFeature(s[i],e,t))}else if("Polygon"==s)for(let i=0;i<a.length;i++)this.coordinateFeatures.push(this.createFeature(a[i],e,t));else console.log("Unknown geometry:"+s)}))},toggleTrack:function(e,t){this.markers&&this.markers[e.getId()];if(this.tracks[e.getId()])t&&t.removeClass("display-map-toc-item-on"),this.map.removePolygon(this.tracks[e.getId()]),this.tracks[e.getId()]=null,t&&t.attr(ATTR_TITLE,"Click to view; Double-click to view track");else{t&&(t.addClass("display-map-toc-item-on"),t.attr(ATTR_TITLE,"Click to view; Double-click to remove track"));let i=e.getValue(this.trackUrlField.getIndex());""!=i&&$.getJSON(i,(t=>{this.loadTrack(e,t)})).fail((e=>{console.log("url failed:"+i+"\n"+e)}))}this.map.setCenter(MapUtils.createLonLat(e.getLongitude(),e.getLatitude()))},makeToc:function(e){let t=this.getFieldById(null,this.getProperty("urlField")),i=this.getFieldsByIds(null,this.getTocFields(this.getProperty("labelField","name")));i&&0!=i.length||(i=this.getFieldsByType(null,"string"));let s=this.getTocTemplate(),l="",a=this.getTocTitle(this.getProperty("tableOfContentsTitle",""));if(s){let t=HU.classes(CLASS_CLICKABLE,"display-map-toc-item ramadda-noselect");e.forEach(((e,i)=>{let a=this.applyRecordTemplate(e,this.getDataValues(e),null,s);l+=HU.div([ATTR_CLASS,t,ATTR_RECORD_INDEX,i],a)}))}else if(i&&i.length>0){let s=this.getFieldById(null,this.getProperty("iconField")),a=this.getProperty("tocTable",!0);a&&(l+=HU.open(TAG_TABLE,[ATTR_WIDTH,HU.perc(100)])+HU.open(TAG_TR),t&&(l+=HU.tag(TAG_TD)),i.forEach((e=>{l+=HU.tag(TAG_TD,[ATTR_STYLE,HU.css(CSS_FONT_WEIGHT,FONT_BOLD)],e.getLabel())})),l+=HU.close(TAG_TR));let r=HU.classes(CLASS_CLICKABLE,"display-map-toc-item ramadda-noselect");e.forEach(((e,o)=>{let n="View record";this.trackUrlField&&(n="Click to view; Double-click to view track");let h,d=[];if(d.push(...i.map((t=>t.getValue(e)))),a){HU.perc(Math.floor(100/d.length));if(h=Utils.wrap(d,HU.open(TAG_TD,[ATTR_CLASS,r,ATTR_RECORD_ID,e.getId(),ATTR_RECORD_INDEX,o]),HU.close(TAG_TD)),t){let i=t.getValue(e);Utils.stringDefined(i)&&(h=HU.td([ATTR_STYLE,HU.css(CSS_WIDTH,HU.px(10))],HU.href(i,HU.getIconImage("fas fa-link",null,[ATTR_STYLE,HU.css(CSS_FONT_SIZE,HU.pt(8))]),[ATTR_TARGET,"_link"]))+h)}l+=HU.tag(TAG_TR,[],h)}else{if(h=Utils.join(d," "),s?h=HU.getIconImage(s.getValue(e,icon_blank16),[ATTR_WIDTH,16])+SPACE+h:r+=" ramadda-nav-list-link ",t){let i=t.getValue(e);Utils.stringDefined(i)&&(h=HU.href(i,HU.getIconImage("fas fa-link",null,[ATTR_STYLE,HU.css(CSS_FONT_SIZE,HU.pt(8))]),[ATTR_TARGET,"_link"])+HU.space(1)+h)}l+=HU.span([ATTR_TITLE,n,ATTR_CLASS,r,ATTR_RECORD_ID,e.getId(),ATTR_RECORD_INDEX,o],h)}})),a&&(l+=HU.close(TAG_TABLE))}if(l){let t=this.getProperty("height",this.getProperty("mapHeight",300));t="calc("+HU.getDimension(t)+" - 1em)";let i=HU.css(CSS_HEIGHT,t,CSS_MAX_HEIGHT,t,CSS_OVERFLOW_Y,OVERFLOW_AUTO);this.getTocWidth()&&(i+=HU.css(CSS_MIN_WIDTH,this.getTocWidth())),l=HU.div([ATTR_CLASS,"display-map-toc",ATTR_STYLE,i,ATTR_ID,this.domId("toc")],l),a&&(l=HU.center(HU.b(a))+l),this.jq(ID_LEFT).html(l);let s=this,r=this.jq(ID_LEFT).find(".display-map-toc-item");this.getProperty("showTableOfContentsTooltip")&&this.makeTooltips(r,e),r.click((function(){let t=$(this).attr(ATTR_RECORD_INDEX),i=e[t];i&&(s.highlightPoint(i.getLatitude(),i.getLongitude(),!0,!1,!1,i),s.map.setCenter(MapUtils.createLonLat(i.getLongitude(),i.getLatitude())),s.propagateEventRecordSelection({record:i}),s.getProperty("tocZoom")&&s.map.setZoom(s.getProperty("tocZoom")),i.trackData&&setTimeout((()=>{s.getDisplayManager().notifyEvent("dataSelection",s,{data:i.trackData})}),100))})),r.dblclick((function(){s.removeHighlight();let t=$(this).attr(ATTR_RECORD_INDEX),i=e[t];if(i){if(s.trackUrlField){let e=i.getValue(s.trackUrlField.getIndex());if(e&&e.length>0)return void s.toggleTrack(i,$(this))}s.map.setCenter(MapUtils.createLonLat(i.getLongitude(),i.getLatitude()))}}))}},updateUI:function(e){e||(e={});let t=!1;if(this.lastUpdateTime=null,u.updateUI.call(this,e),this.haveCalledUpdateUI||!this.getDisplayReady()||!this.hasData()||!this.getProperty("showData",!0))return void 0;this.updateUICallback&&(clearTimeout(this.updateUICallback),this.updateUICallback=null);let i=this.getPointData();this.lastZoom=this.map?this.map.getZoom():null,this.shapesField=this.getFieldById(null,this.getProperty("shapesField")),this.shapesTypeField=this.getFieldById(null,this.getProperty("shapesTypeField")),this.trackUrlField=this.getFieldById(null,this.getProperty("trackUrlField"));let s=this.records=this.filterData();if(this.shapesTypeField&&this.shapesField&&(this.setProperty("tooltipNotFields",this.shapesTypeField.getId()+","+this.shapesField),this.loadShapes(s)),null!=s){this.getSkipZero()&&(s=s.filter((e=>!(0==e.getLatitude()&&0==e.getLongitude())))),this.getShowTableOfContents(!1)&&this.makeToc(s),this.updatingFromClip||"animation"!=e.source&&this.setMessage(e.dataFilterChanged||e.fieldChanged||e.reload?"Reloading map...":"Creating map..."),this.updatingFromClip=!1;try{displayDebug.initMap&&this.logMsg("calling updateUIInner",!0),this.callingUpdateUI=!0,this.updateUIInner(e,i,s,t),this.callingUpdateUI=!1,this.getCenterOnMarkersAfterUpdate()&&this.map.centerOnMarkers(),displayDebug.initMap&&this.logMsg("done calling updateUIInner",!0),e.callback&&e.callback(s),this.clearProgress(),this.layerVisible||setTimeout((()=>{this.setVisible(!1)}),50)}catch(e){this.callingUpdateUI=!1,console.log(e),console.log(e.stack),this.setMessage("Error:"+e)}this.notifyExternalDisplay(),this.setIsFinished()}},notifyExternalDisplay:function(){let e=this.getProperty("externalDisplay");e&&e.externalDisplayReady(this)},filterDataPhase2:function(e){if(e=u.filterDataPhase2.call(this,e),this.clipBounds||this.clipToView){let t=RecordUtil.getBounds(e);this.clipBounds=!1;let i=!1;if((!this.lastPointBounds||this.lastPointBounds&&this.lastPointBounds!=t)&&(i=!0),this.lastPointBounds=t,this.clipToView||i){let t=this.map.getMap().calculateBounds().transform(this.map.sourceProjection,this.map.displayProjection),i=e.filter((e=>t.containsLonLat(MapUtils.createLonLat(e.getLongitude(),e.getLatitude()))));e=i}}return e},updateUIInner:function(e,t,i,s){let l=this,a=new Date;(s=s||displayDebug.displayMapUpdateUI)&&console.log("displaymap.updateUIInner:"+i.length),this.haveCalledUpdateUI=!0;let r="";if(this.getShowCollisionToggle()&&(r+=HU.span([ATTR_TITLE,"Toggle showing collisions",ATTR_CLASS,"display-header-item"],HU.checkbox("",[ATTR_ID,this.domId("collisiontoggle")],!this.getHandleCollisions(),"Show all points"))),this.getShowRegionSelector()){let e=this.getRegionSelectorLabel()??HU.getIconImage("fa-globe-americas");r+=HU.span([ATTR_CLASS,HU.classes(CLASS_CLICKABLE,HU.classes("display-header-span",CLASS_MENU_BUTTON)),ATTR_TITLE,"Select region",ATTR_ID,this.domId("selectregion")],e)+SPACE2}if(Utils.stringDefined(r)&&this.writeHeader(ID_HEADER2_PREFIX,r),this.jq("collisiontoggle").change((function(){let e=HU.isChecked($(this));l.setProperty("handleCollisions",!e),l.haveCalledUpdateUI=!1,l.updateUI()})),this.jq("selectregion").click((function(){l.initRegionsSelector($(this))})),!this.getProperty("makeDisplay",!0))return;this.fullBounds||(this.fullBounds={},RecordUtil.getPoints(this.getRecords(),this.fullBounds));let o={};!(this.getTheLinkFields()&&this.getLinkFeature())&&this.getFilterBadLocations(!0)&&(i=i.filter((e=>e.getLatitude()>=-90&&e.getLatitude()<=90&&e.getLongitude()>=-180&&e.getLongitude()<=180)));let n=RecordUtil.getPoints(i,o),h=t.getRecordFields(),d=!this.getShowSegments(!1)&&!this.hadInitialPosition&&!e.dontSetBounds&&(!e.dataFilterChanged||this.getCenterOnFilterChange()),g=i.length>0;if(this.getInitBoundsUseAllRecords()){o={};let e=this.getData().getRecords();RecordUtil.getPoints(e,o),g=e.length>0}if(g&&!isNaN(o.north)){let e=this.getInitBoundsPadding();if(e){let t=o.east-o.west;o.east-=t*e,o.west-=t*e;let i=o.north-o.south;o.north+=i*e,o.south-=i*e}this.pointBounds=o,this.initBounds=o,d&&(o.insideDateLine?this.setInitMapBounds(o.north,-178,o.south,-170):this.setInitMapBounds(o.north,o.west,o.south,o.east))}if(null==this.map)return;this.highlightMarkers&&(this.highlightMarkers.forEach((e=>{this.map.removePoint(e),this.map.removeMarker(e)})),this.highlightMarkers=null),this.map.clearSeenMarkers();let p=new Date;s&&console.log("displaymap calling addPoints"),0==n.length&&this.records.forEach((e=>{n.push({x:-105,y:40})})),this.addPoints(i,h,n,o,s);let c=new Date;this.addLabels(i,h),this.applyVectorMap(!0,this.textGetter,e);let u=new Date;s&&Utils.displayTimes("time pts="+n.length,[a,p,c,u],!0),this.lastUpdateTime=new Date},xcnt:0,heatmapCnt:0,animationApply:function(e,t){if(!this.heatmapLayers||!this.getHeatmapVisible())return void u.animationApply.call(this,e,t);let i=null,s=null,l=[];this.heatmapLayers.every((t=>!t.date||(t.date.getTime()>=e.begin.getTime()&&t.date.getTime()<=e.end.getTime()?(i=t.date,s=t,t.setVisibility(!0)):t.getVisibility()&&l.push(t),!0))),l.forEach((e=>{e.setVisibility(!1)})),i||u.animationApply.call(this,e,t),null!=s&&this.setMapLabel(s.heatmapLabel)},setDateRange:function(e,t){this.getDoGridPoints(!1)||this.getDoHeatmap(!1),u.setDateRange.call(this,e,t)},showColorTable:function(e){e.displayColorTable(null,!0),this.callingUpdateSize=!0,this.callingUpdateSize=!1},applyHeatmapAnimation:function(e){if(!this.heatmapLayers||!this.getHeatmapVisible())return;this.jq(n)[0].selectedIndex=e;let t=[];this.heatmapLayers.forEach(((i,s)=>{e==s?i.setVisibility(!0):t.push(i)})),t.forEach((e=>{e.setVisibility(!1)})),this.setMapLabel(this.heatmapLayers[e].heatmapLabel)},stepHeatmapAnimation:function(e){if(console.log("step"),!this.heatmapLayers||!this.getHeatmapVisible())return;console.log("step2");let t=this.jq(n)[0].selectedIndex;t+=e,t<0&&(t=0),t>=this.heatmapLayers.length&&(t=0),this.applyHeatmapAnimation(t),this.heatmapPlayingAnimation&&setTimeout((()=>{this.stepHeatmapAnimation(1)}),this.getHmAnimationSleep(1e3))},checkHeatmapReload:function(){if(!this.getHmReloadOnZoom(this.getReloadOnZoom(!1)))return;let e=new Date;if(e.getTime()-this.createTime.getTime()<3e3)return;let t=0;this.checkHeatmapReloadTime&&(t=e.getTime()-this.checkHeatmapReloadTime.getTime()),this.checkHeatmapReloadTime=e,t<1e3?this.checkHeatmapReloadPending||(this.checkHeatmapReloadPending=!0,setTimeout((()=>{this.checkHeatmapReloadPending=!1,this.checkHeatmapReload()}),1100)):(this.checkHeatmapReloadTime=null,this.reloadHeatmap=!0,this.haveCalledUpdateUI=!1,this.updateUI())},createHeatmap(e,t,i){let s=displayDebug.displayMapCreateMap;s&&console.log("createHeatmap");let l=this.getColorByInfo(e,null,null,null,["hmColorBy","colorBy",""]),a=this.getColorByInfo(e,"angleBy",null,null,["hmAngleBy","angleBy",""]),r=this.getColorByInfo(e,"lengthBy",null,null,["hmLengthBy","lengthBy",""]);if(a.isEnabled()||(a=l),r.isEnabled()||(r=null),e=e||this.filterData(),this.getHmBounds()){let e=this.getHmBounds().split(",");i=new RamaddaBounds(+e[0],+e[1],+e[2],+e[3])}let o=this.map.getBounds();if(i=i||RecordUtil.getBounds(e),i=RecordUtil.convertBounds(o),this.pointBounds&&(i=this.pointBounds),s&&console.dir(i.north,i.west,i.south,i.east),this.removeExtraLayers(),this.heatmapLayers=[],this.extraLayers=[],0==e.length)return this.errorMessage=this.getNoDataMessage(),void this.setMessage(this.errorMessage);this.reloadHeatmap&&(this.reloadHeatmap=!1,i=new RamaddaBounds(this.map.getBounds()),e=RecordUtil.subset(e,i)),i=RecordUtil.expandBounds(i,this.getProperty("boundsScale",.05));let c=this.getDefaultGridByArgs(),u=(i.east-i.west)/(i.north-i.south),T=Math.round(this.getProperty("gridWidth",800)),f=Math.round(T/u),y=this.getFieldById(null,this.getHmGroupBy()),m=this.getHmGroupByDate();s&&console.log("calling groupBy group by date:"+m+" group by field:"+y);new Date;let _=y||m?RecordUtil.groupBy(e,this,m,y):null;new Date;s&&console.log("\tdone calling groupBy"),null!=_&&0!=_.max||(doTimes=!1,_={max:e.length,values:["none"],map:{none:e}});let S=_.max;if(0==c.cellSize){let e=Math.sqrt(S),t=Math.round(T/e);c.cellSizeX=c.cellSizeY=c.cellSize=t}else String(c.cellSize).endsWith("%")&&(c.cellSize=c.cellSizeX=c.cellSizeY=Math.floor(parseFloat(c.cellSize.substring(0,c.cellSize.length-1))/100*T));let A=$.extend({colorBy:l,angleBy:a,lengthBy:r,w:T,h:f,bounds:i,forMercator:!0},c);s&&console.log("#records:"+e.length+" dim:"+T+" "+f+" #records:"+e.length+" cell:"+c.cellSizeX+" #records:"+e.length+" bounds:"+i);let I=[],b=this.getHmLabelPrefix("${field}-");if(_.values.forEach(((e,a)=>{let r=_.map[e];s&&a<5&&console.log("group:"+e+" #:"+_.map[e].length);let o=Gfx.gridData(this.getId(),t,r,A),n="none"==e?"Heatmap":b+" "+_.labels[a];n=n.replace("${field}",l.field?l.field.getLabel():""),I.push(n);let h=this.map.addImageLayer("heatmap"+this.heatmapCnt++,n,"",o,0==a,i.north,i.west,i.south,i.east,T,f,{isBaseLayer:!1});h.heatmapLabel=n,m&&e.getTime&&(h.date=e),this.getHeatmapVisible()||h.setVisibility(!1),this.extraLayers.push(h),this.heatmapLayers.push(h)})),this.getHmShowGroups(!0)&&this.heatmapLayers.length>1&&!this.getAnimationEnabled()){this.heatmapPlayingAnimation=!1;let e=[];e.push(HU.div([ATTR_ID,this.domId(g),ATTR_STYLE,HU.css(CSS_DISPLAY,DISPLAY_INLINE_BLOCK),ATTR_TITLE,"Step back"],HU.getIconImage("fa-step-backward",[ATTR_CLASS,CLASS_ANIM_BUTTON]))),y||e.push(HU.div([ATTR_ID,this.domId(h),ATTR_STYLE,HU.css(CSS_DISPLAY,DISPLAY_INLINE_BLOCK),ATTR_TITLE,"Play/Stop Animation"],HU.getIconImage(ICON_PLAY,[ATTR_CLASS,CLASS_ANIM_BUTTON]))),e.push(HU.div([ATTR_ID,this.domId(d),ATTR_STYLE,HU.css(CSS_DISPLAY,DISPLAY_INLINE_BLOCK),ATTR_TITLE,"Step forward"],HU.getIconImage("fa-step-forward",[ATTR_CLASS,CLASS_ANIM_BUTTON]))),e.push(HU.div([ATTR_STYLE,HU.css(CSS_DISPLAY,DISPLAY_INLINE_BLOCK,CSS_MARGIN_LEFT,HU.px(5),CSS_MARGIN_RIGHT,HU.px(5))],HU.select("",[ATTR_ID,this.domId(n)],I))),this.writeHeader(ID_HEADER2_PREPREFIX,Utils.join(e,SPACE2));let t=this;this.jq(n).change((function(){let e=$(this)[0].selectedIndex;t.applyHeatmapAnimation(e)})),this.jq(h).click((function(){t.heatmapPlayingAnimation=!t.heatmapPlayingAnimation;let e=t.heatmapPlayingAnimation?ICON_STOP:ICON_PLAY;$(this).html(HU.getIconImage(e,[ATTR_CLASS,CLASS_ANIM_BUTTON])),t.heatmapPlayingAnimation&&t.stepHeatmapAnimation(1)})),this.jq(d).click((function(){t.heatmapPlayingAnimation=!1;let e=t.heatmapPlayingAnimation?ICON_STOP:ICON_PLAY;t.jq(h).html(HU.getIconImage(e,[ATTR_CLASS,CLASS_ANIM_BUTTON])),t.stepHeatmapAnimation(1)})),this.jq(g).click((function(){t.heatmapPlayingAnimation=!1;let e=t.heatmapPlayingAnimation?ICON_STOP:ICON_PLAY;t.jq(h).html(HU.getIconImage(e,[ATTR_CLASS,CLASS_ANIM_BUTTON])),t.stepHeatmapAnimation(-1)}))}if("none"!=_.values[0]&&this.setMapLabel(I[0]),this.showColorTable(l),this.getHmShowToggle(this.getProperty("hm.showToggle"))||this.getHmShowReload()){let e=this.jq(p),t=HU.getIconImage("fa-sync",[ATTR_CLASS,CLASS_ANIM_BUTTON,ATTR_TITLE,"Reload heatmap",ATTR_ID,this.domId("heatmapreload")])+SPACE2;this.heatmapVisible=0==e.length||HU.isChecked(e);let i=t+HU.checkbox("",[ATTR_ID,this.domId(p)],this.heatmapVisible,this.getHmToggleLabel(this.getProperty("hm.toggleLabel","Heatmap")));this.writeHeader(ID_HEADER2_PREFIX,HU.span([ATTR_STYLE,HU.css(CSS_MARGIN_RIGHT,HU.px(8))],i));let s=this;this.jq("heatmapreload").click((()=>{this.reloadHeatmap=!0,this.removeExtraLayers(),this.haveCalledUpdateUI=!1,this.updateUI()})),this.jq(p).change((()=>{if(s.heatmapLayers){let e=s.getHeatmapVisible();s.heatmapVisible=e,s.heatmapLayers.forEach((t=>t.setVisibility(e))),s.map.setPointsVisibility(!e)}}))}},getHeatmapVisible:function(){let e=this.jq(p);return 0==e.length||HU.isChecked(e)},updateHtmlLayers:function(){this.htmlLayerInfo&&this.createHtmlLayer(this.htmlLayerInfo.records,this.htmlLayerInfo.fields)},updateHtmlLayer:function(){if(this.htmlLayer){if(!this.htmlLayerId){this.htmlLayerId=this.getUniqueId("htmllayer"),this.htmlPopupLayerId=this.getUniqueId("popup"),this.jq(ID_MAP).append(HU.div([ATTR_ID,this.htmlPopupLayerId,ATTR_STYLE,HU.css(CSS_POSITION,POSITION_ABSOLUTE,CSS_WIDTH,HU.perc(100),CSS_LEFT,HU.px(0),CSS_TOP,HU.px(0),CSS_BOTTOM,HU.px(0),CSS_Z_INDEX,0,CSS_POINTER_EVENTS,"none")]));let e=this.map.getMap().getViewport();e=$(e).children()[0],$(e).css(CSS_DISPLAY,DISPLAY_RELATIVE),$(e).append(HU.div([ATTR_STYLE,HU.css(CSS_Z_INDEX,10),ATTR_CLASS,"display-map-htmllayer",ATTR_ID,this.htmlLayerId]))}this.htmlPopupLayerId&&jqid(this.htmlPopupLayerId).html(this.htmlPopup),jqid(this.htmlLayerId).html(HU.div([ATTR_STYLE,HU.css(CSS_POSITION,POSITION_RELATIVE)],this.htmlLayer))}},createHtmlLayer:function(e,t){this.htmlLayerMouseOver=null;let i=this.getFieldById(t,this.getHtmlLayerField());this.htmlLayerInfo={records:e,fields:t},this.htmlLayer="",this.htmlPopup="";let s=this.getFillColor("#619FCA"),l=this.getStrokeColor("#888"),a=this.getFieldById(t,this.getHtmlLayerPopupLabelField()),r=this.getHtmlLayerFlipYAxis(),o=this.getHtmlLayerDrawAxisLabels(),n=this.getHtmlLayerPopupDrawAxisLabels(),h=this.getHtmlLayerScaleWithAll(!0),d=this.getHtmlLayerWidth(30),g=this.getHtmlLayerHeight(15),p=this.getHtmlLayerShape("barchart");if("barchart"==p&&this.setProperty("colorBy",i.getId()),this.getHtmlLayerScale()){let e=[];this.getHtmlLayerScale().split(",").forEach((t=>{e.push(t.split(":"))}));let t=this.map.map.getZoom(),i=1;1==e.length&&1==e[0].length?i=e[0][0]:e.every((e=>(i=e[1],!(e[0]>=t)))),d*=i,g*=i}let c=this.getHtmlLayerStyle(""),u=[],T=this.getColumnValues(e,i),f=RecordUtil.groupBy(e,this,!1,"latlon"),y=$($(this.map.getMap().getViewport()).children()[0]),m=+y.css(CSS_LEFT).replace("px",""),_=+y.css(CSS_TOP).replace("px",""),S=3*d,A=3*g,I=[];f.values.forEach(((e,t)=>{let s=f.map[e],l=[];I.push(s[0]),s.forEach(((e,t)=>{l.push(e.getValue(i.getIndex()))}));let r=s[0],o=this.map.getMap().getPixelFromLonLat(this.map.transformLLPoint(MapUtils.createLonLat(r.getLongitude(),r.getLatitude()))),n=this.getId()+"_sl"+t,h=n+"_hover",p=HU.div([ATTR_ID,n,ATTR_CLASS,"display-map-html-item",ATTR_STYLE,c+HU.css(CSS_LINE_HEIGHT,HU.px(0),CSS_Z_INDEX,1e3,CSS_POSITION,POSITION_ABSOLUTE,CSS_LEFT,HU.px(o.x-d/2-m),CSS_TOP,HU.px(o.y-g/2-_))]),T="";r&&a&&(T=a.getValue(r)),Utils.stringDefined(T)&&(T=HU.div([ATTR_STYLE,HU.css(CSS_WHITE_SPACE,WHITE_SPACE_NOWRAP,CSS_POSITION,POSITION_ABSOLUTE,CSS_FONT_SIZE,HU.pt(8),CSS_TOP,HU.px(25),CSS_LEFT,HU.px(10))],T)),this.htmlPopup+=HU.div([ATTR_ID,h,ATTR_RECORD_INDEX,t,ATTR_TITLE,"",ATTR_CLASS,"display-map-html-hitem",ATTR_STYLE,c+HU.css(CSS_DISPLAY,DISPLAY_NONE,CSS_LINE_HEIGHT,HU.px(0),CSS_Z_INDEX,2001,CSS_POSITION,POSITION_ABSOLUTE,CSS_LEFT,HU.px(0),CSS_TOP,HU.px(0))],T),this.htmlLayer+=p,u.push({id:n,hoverId:h,data:l,min:Utils.getMin(l),max:Utils.getMax(l),records:s})})),this.updateHtmlLayer();let b=this.getColorByInfo(e);u.forEach(((e,t)=>{if("pie"==p||"piechart"==p)[0,1].forEach(((t,i)=>{let a=HU.getUniqueId("pie"),r=0==i?d:S,o=0==i?g:A,n=HU.tag(TAG_CANVAS,[ATTR_STYLE,HU.css(CSS_CURSOR,CURSOR_POINTER),ATTR_ID,a,ATTR_WIDTH,r,ATTR_HEIGHT,o]);0==i?jqid(e.id).html(n):jqid(e.hoverId).html(n);let h=document.getElementById(a),p=b&&b.isEnabled()?b.getColor(e.data[0]):s,c=h.getContext("2d");1==i&&(c.fillStyle=COLOR_WHITE,c.beginPath(),c.moveTo(r/2,o/2),c.arc(r/2,o/2,r/2-2,0-Math.PI/2,2*Math.PI),c.closePath(),c.fill()),c.beginPath(),c.moveTo(r/2,o/2),c.arc(r/2,o/2,r/2-2,0-Math.PI/2,2*e.data[0]*Math.PI-Math.PI/2),c.lineTo(r/2,o/2),c.closePath(),c.strokeStyle=l,c.fillStyle=p,c.fill(),c.stroke(),c.beginPath(),c.arc(r/2,o/2,r/2-2,0,2*Math.PI),c.closePath(),c.stroke()}));else{let t={flipYAxis:r,drawAxisLabels:o},i={flipYAxis:r,drawAxisLabels:o||n},s=T.min,l=T.max;h||(s=e.min,l=e.max),s=this.getHtmlLayerMin(s),l=this.getHtmlLayerMax(l),drawSparkline(this,"#"+e.id,d,g,e.data,e.records,s,l,b,t),jqid(e.hoverId).css(CSS_BACKGROUND,COLOR_WHITE).css(CSS_BORDER,HU.border(1,COLOR_LIGHT_GRAY)),drawSparkline(this,"#"+e.hoverId,S,A,e.data,e.records,s,l,b,i)}}));let R=this.find(".display-map-html-item"),D=this.find(".display-map-html-hitem");this.makeTooltips(D,I),R.mouseenter((function(){D.hide(),jqid($(this).attr(ATTR_ID)+"_hover").show()})),R.mouseleave((function(){D.hide()})),D.mouseleave((function(){jqid($(this).attr(ATTR_ID).replace("_hover","")).css(CSS_DISPLAY,DISPLAY_BLOCK),$(this).css(CSS_DISPLAY,DISPLAY_NONE)})),b.hasField()&&this.showColorTable(b)},makeVoronoi:function(e,t,i,s){if(!MapUtils.loadTurf((()=>{this.makeVoronoi(e,t,i,s)})))return;let l;if(l=this.getVoronoiPadding(0)){let e=s.east-s.west,t=s.north-s.south,i=$.extend({},s);i.west=Math.max(-180,i.west-e*l),i.east=Math.min(180,i.east+e*l),i.north=Math.min(90,i.north+t*l),i.south=Math.max(-90,i.south-t*l),s=i}let a={bbox:this.makeTurfBounds(s)},r=[],o={},n=[];i.forEach(((t,i)=>{let s=e[i],l=t.x+"_"+t.y;o[l]||(o[l]=!0,r.push(turf.point([t.x,t.y])),n.push({point:t,record:s}))}));let h=turf.featureCollection(r),d=turf.voronoi(h,a);this.voronoiLayer=this.createGeoJsonLayer("Voronoi",d,this.voronoiLayer);let g=this.getColorByInfo(e,"voronoiColorBy",null,null,null,this.lastColorBy);this.lastColorBy=g;let p=this.getTextGetter(t),c={strokeColor:this.getVoronoiStrokeColor(),strokeWidth:this.getVoronoiStrokeWidth(),strokeDashstyle:this.getVoronoiStrokeDashstyle(),fillColor:this.getVoronoiFillColor(),fillOpacity:this.getVoronoiFillOpacity()};this.voronoiLayer.features.forEach(((e,t)=>{let i=n[t].record,s=Utils.clone({},c);g.isEnabled()&&(s.fillColor=g.getColorFromRecord(i)),e.style=s,e.record=i,e.textGetter=p})),this.voronoiLayer.redraw(),g.isEnabled()&&g.displayColorTable(),this.notifyExternalDisplay()},makeHexmap:function(e,t,i,s){if(!MapUtils.loadTurf((()=>{this.makeHexmap(e,t,i,s)})))return;let l,a=this.makeTurfBounds(this.getHexmapUseFullBounds()?this.fullBounds:s,this.getHexmapPadding()),r=this.getHexmapCellSide(),o={units:this.getHexmapUnits()},n=this.getProperty("mapType");l=this.getDoTrianglemap()||"triangle"==n?turf.triangleGrid(a,r,o):this.getDoSquaremap()||"square"==n?turf.squareGrid(a,r,o):turf.hexGrid(a,r,o);i.forEach(((t,i)=>{let s=e[i],a=turf.points([[t.x,t.y]]),r=!1;l.features.every(((e,i)=>{if(!e.searchWithin){let t=e.geometry.coordinates[0];e.searchWithin=turf.polygon([t]),e.bbox=turf.bbox(e.searchWithin),e.records=[]}if(t.x>=e.bbox[0]&&t.x<=e.bbox[2]&&t.y>=e.bbox[1]&&t.y<=e.bbox[3]){if(turf.pointsWithinPolygon(a,e.searchWithin).features.length>0)return r=!0,e.records.push(s),!1}return!0})),r?0:0}));let h=-1,d=-1;l.features.forEach(((e,t)=>{e.records&&e.records.length>0&&(h=-1==h?e.records.length:Math.max(h,e.records.length),d=-1==d?e.records.length:Math.min(d,e.records.length))})),this.hexmapLayer=this.createGeoJsonLayer("Hexmap",l,this.hexmapLayer);let g=this.getColorByInfo(e,"hexmapColorBy",null,null,null,this.lastColorBy,{isString:this.getHexmapUseEnum(),colorTableProperty:"hexmapColorTable",minValue:this.getHexmapMinValue(),maxValue:this.getHexmapMaxValue()});if(this.getHexmapUseEnum())g.setDoEnum(!0);else if(this.getHexmapUseCount(this.getProperty("hexmapShowCount")))g.setDoCount(d,h);else{let e=this.getHexmapShowTotal();g.setDoTotal(e);let t=NaN,i=NaN;this.hexmapLayer.features.forEach(((s,a)=>{let r=l.features[a].records;if(!r||0==r.length)return;let o=e?g.doTotal(r):g.doAverage(r);t=Utils.min(t,o),i=Utils.max(i,o)})),g.setRange(t,i,!0)}this.lastColorBy=g;let p=this.getTextGetter(t,!0),c={strokeColor:this.getHexmapStrokeColor(),strokeDashstyle:this.getHexmapStrokeDashstyle(),strokeWidth:this.getHexmapStrokeWidth(),fillColor:this.getHexmapFillColor(COLOR_TRANSPARENT),fillOpacity:this.getHexmapFillOpacity()},u={strokeColor:this.getHexmapEmptyStrokeColor(c.strokeColor),strokeWidth:this.getHexmapEmptyStrokeWidth(c.strokeWidth),fillColor:this.getHexmapEmptyFillColor(c.fillColor),fillOpacity:this.getHexmapFillOpacity()},T={pointRadius:0,fontSize:this.getProperty("hexmapLabelFontSize",6),fontColor:this.getProperty("hexmapLabelFontColor",COLOR_BLACK),fontWeight:this.getProperty("hexmapLabelFontWeight",FONT_BOLD)},f=this.getHexmapLabelTemplate();this.hexmapLayer.features.forEach(((e,t)=>{let i=l.features[t].records,s=i&&i.length>0?c:u;if(s=Utils.clone({},s),i&&i.length>0&&(g.isEnabled()&&(s.fillColor=g.getColorFromRecord(i,null,null,null),e.colorByValue=g.lastValue,isNaN(g.lastValue)&&(s.display=DISPLAY_NONE)),f)){let t=f.replace("${count}",i.length);t=t.replace("${colorbyvalue}",e.colorByValue),s=Utils.clone({},T,s),s.label=t}e.records=i,e.style=s,e.textGetter=p})),this.hexmapLayer.redraw(),g.isEnabled()&&this.displayColorTable(g,ID_COLORTABLE,g.minValue,g.maxValue),this.notifyExternalDisplay()},addPoints:function(e,t,i,s,l){let a=this.getProperty("mapType");if(("voronoi"!=a&&!this.getProperty("doVoronoi",!1)||(this.makeVoronoi(e,t,i,s),this.getShowPoints()))&&(!("hex"==a||"triangle"==a||"square"==a||this.getDoHexmap()||this.getDoTrianglemap()||this.getDoSquaremap())||(this.makeHexmap(e,t,i,s),this.getShowPoints())))if(this.getDoGridPoints()||this.getDoHeatmap(!1)){this.showMarkers;if(this.getHmShowPoints()||this.getShowPoints()){let a=!0;this.jq(ID_SHOWMARKERSTOGGLE).length>0&&(a=HU.isChecked(this.jq(ID_SHOWMARKERSTOGGLE))),a&&(this.createPoints(e,t,i,s,l),this.getHmShowToggle(!1)&&this.map.circles&&this.map.setPointsVisibility(!1))}this.createHeatmap(e,t,s)}else this.getHtmlLayerField()&&(this.createHtmlLayer(e,t),!this.getShowPoints(!1))||(debugMapTime&&console.time("createPoints"),this.createPoints(e,t,i,s,l),debugMapTime&&(console.timeEnd("createPoints"),console.log("#points:"+e.length)))},createPoints:function(e,i,s,l,n){n=n||displayDebug.displayMapAddPoints;let h=this,d=[],g=[],p=[],c=[],u=this.getHideMissingColor(),T=this.getColorByInfo(e,null,null,null,null,this.lastColorBy),f=this.getHideNaN();this.lastColorBy=T;let y=0,m=this.getFieldById(i,this.getPolygonField()),_=this.getColorTable(!0,"polygonColorTable",null),S=this.getProperty("latlon",!0),A=this,I=+this.getPropertyRadius(8),b=this.getFilterHighlight(),R=this.getUnhighlightColor(),D=this.getProperty("unhighlightStrokeWidth",0),L=this.getProperty("unhighlightStrokeColor","#aaa"),U=this.getUnhighlightRadius(),C=this.getStrokeOpacity();if(this.markers={},b){let t=[],i=[];e.forEach(((e,l)=>{e.isHighlight(this)||(t.push(e),i.push(s[l]))})),e.forEach(((e,l)=>{e.isHighlight(this)&&(t.push(e),i.push(s[l]))})),e=t,s=i}let E=this.getRadiusList(),H=0;if(this.getScaleRadius()||E){let e={};s.every((t=>{let i=t.x+"_"+t.y;return e[i]||(H++,e[i]=!0),!0}))}if(this.getScaleRadius()){let e=this.getScaleRadiusMin(),t=this.getScaleRadiusMax(),i=this.getScaleRadiusMaxPoints(),s=Math.min(1,H/i);I=Math.max(1,Math.round(t-(t-e)*s))}E&&Utils.split(E,",",!0,!0).every((e=>{let t=Utils.split(e,":",!0,!0);if(2!=t.length)return!0;let i=+t[0];return!(H<=i)||(I=+t[1],!1)})),I=Math.min(I,this.getMaxRadius());let P=+this.getPropertyStrokeWidth(),x=this.getPropertyStrokeColor();if(this.getDisplayProp(A,"isTrajectory",!1)){let e=s.map((e=>$.extend({},e))),t={strokeWidth:this.getProperty("pathStrokeWidth",this.getProperty("strokeWidth",2)),strokeColor:this.getPathColor(this.getStrokeColor("blue")),fillColor:this.getProperty("fillColor",COLOR_TRANSPARENT)};if(1==e.length)g.push(this.map.createPoint(ATTR_ID,e[0],t,null));else{this.getShowPathEndPoint()&&(g.push(this.map.createMarker("startpoint",e[0],RamaddaUtil.getCdnUrl("/icons/map/marker-green.png"))),g.push(this.map.createMarker("endpoint",e[e.length-1],RamaddaUtil.getCdnUrl("/icons/map/marker-blue.png"))));let i=this.map.createPolygon(ATTR_ID,"",e,t,null,!0);i.noSelect=!0,g.push(i)}if(!this.getProperty("showPoints"))return void this.addFeatures(g)}let O=this.getFieldById(i,this.getProperty("latField1")),N=this.getFieldById(i,this.getProperty("latField2")),w=this.getFieldById(i,this.getProperty("lonField1")),M=this.getFieldById(i,this.getProperty("lonField2")),F=this.getShowSegments(!1),k=this.getUseGreatCircle();if((k&&F&&O&&N&&w&&M||m)&&!MapUtils.loadTurf((()=>{this.createPoints(e,i,s,l,n)})))return;let G=this.getSizeSegments(),B=this.getProperty("sizeEndPoints",!0),Y=this.getProperty("showEndPoints",!1),V=parseInt(this.getProperty("endPointSize","4")),q=V,W=parseInt(this.getSegmentWidth(1)),j=W,z=this.getShowLayers()&&(this.getProperty("geojsonLayer")||this.getProperty("kmlLayer")||this.getProperty("shapefileLayer"));z||this.getProperty("mapLayers")&&this.getProperty("mapLayers").forEach((e=>{e.match&&(z=!0)}));let K=this.getProperty("showPoints",!z),X=this.getProperty("lineColor","green"),Z=this.getProperty("lineCap","round"),J=this.getFieldById(i,this.getProperty("iconField")),Q=e=>{if(!Utils.isDefined(e))return null;let t=e.split(":"),i={min:Utils.stringDefined(t[0])?+t[0]:-1,max:Utils.stringDefined(t[1])?+t[1]:100};return isNaN(i.min)&&(i.min=-1),isNaN(i.max)&&(i.max=100),i};this.glyphLevelRange=Q(this.getProperty("glyphLevelRange")),this.pointLevelRange=Q(this.getProperty("pointLevelRange"));let ee=RamaddaDisplayUtils.getGlyphs(this,i,e),te=this.getProperty("canvasBackground"),ie=this.getProperty("canvasBorder"),se=this.getCanvasWidth(),le=this.getCanvasHeight(),ae=this.getProperty("glyphSize","32"),re=this.getFieldById(i,this.getProperty("rotateField")),oe=this.getRotateScale(),ne=this.getMarkerIcon(this.getProperty("pointIcon")),he=ne||J,de=!he;ee.length>0&&(de=this.getProperty("showPoint",!0));let ge=parseFloat(this.getProperty("iconSize",this.getProperty("radius",32))),pe=this.getIconMap(),ce=this.getProperty("defaultShape",null),ue=["circle","triangle","square","star","downtriangle","rectangle","cross","x","lightning","church"],Te=0,fe={id:this.getDisplayProp(A,"shapeBy",null),field:null,map:{},labels:{},patterns:[]};this.getDisplayProp(A,"shapeByMap",null)&&this.getDisplayProp(A,"shapeByMap",null).split(",").forEach((e=>{let t=e.split(":");fe.map[t[0]]=t[1],t[0].match("(\\*|\\.||\\+)")&&(fe.patterns.push({pattern:t[0],shape:t[1]}),fe.labels[t[0]]=t[2]??t[0])}));let ye=new SizeBy(this,this.getProperty("sizeByAllRecords",!0)?this.getData().getRecords():e);for(let e=0;e<i.length;e++){let t=i[e];t.getId()!=fe.id&&"#"+(e+1)!=fe.id||(fe.field=t,t.isString()&&(fe.isString=!0))}if(fe.index=null!=fe.field?fe.field.getIndex():-1,this.getProperty("showColorByMenu",!1)&&T.field&&!this.madeColorByMenu){this.madeColorByMenu=!0;let e=HU.open(TAG_SELECT,[ATTR_CLASS,CLASS_PULLDOWN,ATTR_ID,this.domId("colorByMenu")]);for(let t=0;t<i.length;t++){let s=i[t];if(!s.isNumeric()||s.isFieldGeo())continue;let l=[];T.field.getId()==s.getId()&&l.push(ATTR_EXTRA,!0),l.push(ATTR_VALUE,s.getId()),e+=HU.tag(TAG_OPTION,l,s.getLabel())}e+=HU.close(TAG_SELECT),this.writeHtml(ID_TOP_RIGHT,"Color by: "+e),this.jq("colorByMenu").change((()=>{let e=this.jq("colorByMenu").val();this.vectorMapApplied=!1,this.haveCalledUpdateUI=!1,this.setProperty("colorBy",e),this.updateUI()}))}let me=null,_e=null,Se=[],Ae=this.getPropertyJustOneMarker();for(let t=0;t<e.length;t++){let i=e[t];if(Se.push(i.getDate()),null==me)me=i.getDate(),_e=i.getDate();else{let e=i.getDate();e&&(e.getTime()<me.getTime()&&(me=e),e.getTime()>_e.getTime()&&(_e=e))}}_e&&this.getAnimationEnabled(),this.removeFeatureLayer();let Ie,be=!1,Re={},De={strokeColor:this.getProperty("pathColor",X),strokeWidth:this.getPathWidth()},Le=this.getFillColor(),Ue=this.getFillOpacity(),Ce=this.getIsPath();this.getIsPathThreshold()>e.length&&(Ce=!0),Ce&&(K=this.getProperty("showPoints",!Ce));let Ee,He=this.getFieldById(null,this.getGroupByField());He&&(Ee=RecordUtil.groupBy(e,this,!1,He));let Pe=this.getTooltip("${default}"),xe=Utils.stringDefined(Pe),ve=this.getShowHighlight(this.getProperty("highlight")),Oe=this.getHighlightTemplate();Oe&&(ve=!0);let Ne=this.getHighlightWidth(300),we=this.getHighlightHeight(-1),Me=null;we>0&&(Me=MapUtils.createSize(Ne,we));let Fe=this.getTextGetter(i),ke=e=>e.record?HU.div([],this.getRecordHtml(e.record,i,Oe||Pe)):null;this.haveAddPoints=!0,this.recordToInfo={};let Ge=this.fakeLocations(),Be=e.map(((e,t)=>{let i={record:e,features:[],visible:!0};return e.point?(i.x=e.point.x,i.y=e.point.y):(i.x=e.getLongitude(),i.y=e.getLatitude(),Ge&&isNaN(i.x)&&(i.x=-105,i.y=40)),this.recordToInfo[e.getId()]=i,i}));if(this.getHandleCollisions()){let e=this.getCollisionTooltip("${default}"),t=null==e?null:t=>{let i="#"+t.length+" records"+HU.thinLine();return t.forEach((t=>{i+=HU.div([ATTR_STYLE,HU.css(CSS_BORDER_BOTTOM,HU.border(1,COLOR_LIGHT_GRAY))],this.getRecordHtml(t,null,e))})),i},i={textGetter:t,fixed:this.getCollisionFixed(),visible:!1,icon:this.getCollisionIcon(),iconSize:this.getCollisionIconSize(),dotColor:this.getCollisionDotColor(),dotOpacity:this.getCollisionDotOpacity(),ringColor:this.getCollisionRingColor(),ringWidth:this.getCollisionRingWidth(),dotColorOn:this.getCollisionDotColorOn(),dotRadius:this.getCollisionDotRadius(),scaleDots:this.getPropertyCollisionScaleDots(),labelTemplate:this.getCollisionLabelTemplate(),labelColor:this.getCollisionLabelColor(),labelFontSize:this.getCollisionLabelFontSize()},s=new CollisionHandler(this.map,{pointSize:this.getCollisionPointSize(),collisionArgs:i,lineWidth:this.getProperty("collisionLineWidth",2),lineColor:this.getProperty("collisionLineColor",COLOR_BLACK),addCollisionLines:function(e,t){h.addFeatures(t,!0)},setCollisionVisible:function(e,t){e.records.forEach((t=>{let i=h.recordToInfo[t.getId()];i&&i.features.forEach((t=>{t.featureVisible=e.visible,h.map.checkFeatureVisible(t,!0)}))}))}});s.initPoints(Be),Be.forEach(((e,t)=>{let l=e.collisionPoint;if(null==l)return;let a=s.countAtPoint[l];if(1==a)return;let r=e.record,o=s.getCollisionInfo(l);if(o.addRecord(r),e.collisionInfo=o,e.visible=o.visible,i.fixed)e.dontShow=!0;else{let i=360/a,r=s.offset,n=a/8;n>1&&(r*=n);let h=Utils.rotate(l.x,l.y,l.x,l.y-r,o.records.length*i-180,!0),d=this.getMap().createLine("line-"+t,"",l.y,l.x,h.y,h.x,{strokeColor:s.lineColor,strokeWidth:s.lineWidth});o.visible||(d.featureVisible=!1,this.map.checkFeatureVisible(d,!0)),o.addLine(d),e.x=h.x,e.y=h.y}})),s.getCollisionInfos().forEach(((e,t)=>{let i=e.createDots(t);g.push(...i)}))}let Ye=0,Ve=function(e,t){B&&!isNaN(e)&&(V=q+parseInt(10*e)),G&&(isNaN(e)?W=j+t:(W=j+parseInt(10*e),W=t,(0==W||isNaN(W))&&(W=1)))};if(Ce&&Ee){let e,t=this.getProperty("pathWindowStrokeColor"),i=this.getProperty("pathWindowSize",0),s=this.getProperty("pathWindowTime");s&&(e=DataUtils.timeToMillis(s));let l=[];Ee.values.forEach((a=>{let r=null,o=null,n=null,h=Ee.map[a],d=h.length,p=-1;if(s){let t=h[h.length-1];if(t&&t.recordTime){let i=t.recordTime.getTime()-e;for(let e=h.length-1;e>=0;e--){let t=h[e];if(t&&t.recordTime){if(t.recordTime.getTime()<i)break;p=e}}}}else i>0&&(p=Math.max(0,d-i));if(Ee.map[a].forEach(((e,i)=>{if(r||(r=e),Ye++,o){let s=$.extend({},De),a=T.getColorFromRecord(e,De.strokeColor,!0);s.strokeColor=a;let r=!1;if(p>=0&&(r=i>=p),t&&(s.strokeColor=t),r){let t=(i-p)/(d-p),s={x:e.getLongitude(),y:e.getLatitude()},r={fillColor:a,strokeWidth:0,fillOpacity:Math.max(.2,t),pointRadius:Math.max(2,Math.floor(t*I))},o=this.map.createPoint("endpoint",s,r,null);o.record=e,o.textGetter=Fe,l.push(o)}else if(s.strokeWidth>0){let t=this.map.createLine("line-"+Ye,"",o.getLatitude(),o.getLongitude(),e.getLatitude(),e.getLongitude(),s);g.push(t),t.record=e,t.textGetter=Fe}}n=o,o=e})),g.push(...l),o){let e=T.getColorFromRecord(o,De.strokeColor);if(n&&this.getShowPathEndPoint(!1)){let t=this.getProperty("pathEndPointShape",null),i=Utils.getBearing({lon:n.getLongitude(),lat:n.getLatitude()},{lon:o.getLongitude(),lat:o.getLatitude()}),s=this.map.createPoint("endpoint",{x:o.getLongitude(),y:o.getLatitude()},{fillColor:e,strokeColor:COLOR_BLACK,pointRadius:6,graphicName:t,rotation:i},null);g.push(s)}if(this.getProperty("showPathStartPoint",!1)){let t=this.map.createPoint("startpoint",{x:r.getLongitude(),y:r.getLatitude()},{fillColor:e,pointRadius:2},null);g.push(t)}}}))}let qe=T.isEnabled(),We=this.getPropertyShape(),je=!1,$e=[new Date];if(Be.forEach(((i,s)=>{if(i.dontShow)return;Ye++;let l=i.record,a=i;if(a){if(!Utils.isDefined(a.x)||!Utils.isDefined(a.y))return}else a=MapUtils.createPoint(l.getLongitude(),l.getLatitude());if(Ae){if(n=!1,je)return void(n&&console.log("didMarker"));if(this.justOneMarker&&this.map.removeMarker(this.justOneMarker),isNaN(a.x)||isNaN(a.y))return;if(je=!0,this.justOneMarker=this.map.createMarker(t,[a.x,a.y],null,"",""),g.push(this.justOneMarker),n&&console.log("\tadding justOneMarker had initial position:"+this.hadInitialPosition),!this.hadInitialPosition){let e=MapUtils.createLonLat(a.x,a.y);n&&console.log("\tsetting center:"+e),this.map.setCenter(e)}return}let r=l.getData(),o={strokeOpacity:C,pointRadius:I,strokeWidth:P,strokeColor:x,fillColor:Le,fillOpacity:Ue};if(fe.field){let e=r[fe.index];if(e){let t=String(e).toLowerCase(),i=null;fe.patterns.every((e=>!t.match(e.pattern)||(i=e.shape,!1))),i||(i=fe.map[t]),i||(ce?(i=ce,fe.labels[t]=e):(Te>=ue.length&&(Te=0),i=fe.map[t]=ue[Te++],fe.labels[t]=e)),i||(i=fe.map[t]),Utils.isDefined(i)&&(o.graphicName=i)}}if(W=j,o.pointRadius=ye.getSize(r,o.pointRadius,Ve),o.pointRadius<0)return;(isNaN(o.pointRadius)||0==o.pointRadius)&&(o.pointRadius=I);let h,A,E=!1,H=null;if(T.compareFields.length>0){let e=null,t=0;T.compareFields.forEach(((i,s)=>{let a=l.getData()[i.getIndex()];(0==s||a>t)&&(e=T.colors[s],t=a)})),h=t,H=e}else if(qe){let e=l.getData()[T.index];if(f&&isNaN(e))return;h=e,H=T.getColorFromRecord(l,H,!1)}if(H&&(be=!0,E=!0,A=o.fillColor=T.convertColor(H,h)),b&&!l.isHighlight(this)&&(o.fillColor=R,o.strokeColor=L,o.strokeWidth=D,U>0&&(o.pointRadius=U)),m){let e=r[m.getIndex()],t={};$.extend(t,o),t.fillColor=COLOR_TRANSPARENT,t.fillColor=o.fillColor,0==t.strokeWidth&&(t.strokeWidth=1),_?(y>=_.length&&(y=0),t.strokeColor=_[y++]):A&&(t.strokeColor=A);let i=this.map.createPolygonFromString("",e,t,S,null);i.forEach((e=>{e.textGetter=Fe,e.record=l;let t=l.getDate();t&&(e.date=t.getTime()),g.push(e)})),i.forEach((e=>{g.push(e)}))}if(F&&O&&N&&w&&M){let e,t=r[O.getIndex()],i=r[N.getIndex()],s=r[w.getIndex()],a=r[M.getIndex()],n={};if(o.fillColor?n.strokeColor=o.fillColor:n.strokeColor=X,n.strokeLinecap=Z,n.strokeColor=T.getColorFromRecord(l,n.strokeColor),n.strokeWidth=W,k){let l=turf.point([s,t]),r=turf.point([a,i]),o=this.getTurfPoints(turf.greatCircle(l,r)),h="OpenLayers.Geometry.LineString";e=this.makeFeature(this.getMap(),h,n,o)}else e=this.map.createLine("line-"+Ye,"",t,s,i,a,n);if(g.push(e),e.record=l,e.textGetter=Fe,ve&&(e.highlightTextGetter=ke,e.highlightSize=Me),e.record=l,g.push(e),Y){let e={};$.extend(e,o),e.fillColor=n.strokeColor,e.strokeColor=n.strokeColor,e.pointRadius=q,e.pointRadius=V;let r=MapUtils.createLonLat(s,t),h=MapUtils.createLonLat(a,i);if(!Utils.isDefined(Re[r])){Re[r]=!0;let t=this.map.createPoint("endpt-"+Ye,r,e);g.push(t),t.record=l,t.textGetter=Fe,g.push(t)}if(!Utils.isDefined(Re[h])){Re[h]=!0;let t=this.map.createPoint("endpt2-"+Ye,h,e);g.push(t),t.record=l,t.textGetter=Fe,g.push(t)}}}let v=null,G=i.features;if(he)if(J){let e=l.getData()[J.getIndex()];pe&&(e=pe[e],e||(e=this.getMarkerIcon(null,!0)));let t=ge;ye.index>=0&&(t=o.pointRadius),v=this.map.createMarker("pt-"+Ye,a,e,"pt-"+Ye,null,null,t),v.isMarker=!0,G.push(v),this.markers[l.getId()]=v,p.push(v)}else{let e={};re&&(e.rotation=oe*l.getValue(re.getIndex())),v=this.map.createMarker("pt-"+Ye,a,ne,"pt-"+Ye,null,null,ge,null,null,e),v.levelRange=this.pointLevelRange,v.textGetter=Fe,p.push(v),v.isMarker=!0,G.push(v),this.markers[l.getId()]=v}if(ee.length>0){let e=HU.getUniqueId("canvas_"),t=HU.tag(TAG_CANVAS,[ATTR_CLASS,"",ATTR_WIDTH,se,ATTR_HEIGHT,le,ATTR_ID,e]);$(document.body).append(t);let i=document.getElementById(e),s=i.getContext("2d");te&&(s.fillStyle=te,s.fillRect(0,0,se,le)),ie&&(s.strokeStyle=ie,s.strokeRect(0,0,se,le)),s.strokeStyle=COLOR_BLACK,s.fillStyle=COLOR_BLACK;let r=[];ee.forEach((e=>{let t=e.draw({},i,s,0,le,{record:l});t&&r.push(t)}));let n=i.toDataURL(),h=ae;ye.index>=0&&(h=o.pointRadius),v=this.map.createMarker("pt-"+Ye,a,n,"pt-"+Ye,null,null,h),v.levelRange=this.glyphLevelRange,v.isMarker=!0,G.push(v),this.markers[l.getId()]=v,p.push(v)}if(de||qe){if(o.graphicName||(o.graphicName=We),re&&(o.rotation=oe*l.getValue(re.getIndex())),o.fillColor=T.getColorFromRecord(l,o.fillColor),null==o.fillColor&&u)return;if(I>0){xe&&(o.cursor=CURSOR_POINTER);let e=o;v=this.map.createPoint("pt-"+Ye,a,e,null),v.levelRange=this.pointLevelRange,p.push(v),this.markers[l.getId()]=v,G.push(v)}}if(Ce&&!Ee&&Ie){De.strokeColor=T.getColorFromRecord(l,De.strokeColor);let e=this.map.createLine("line-"+Ye,"",Ie.y,Ie.x,a.y,a.x,De);c.push(e)}Ie=a,d&&G.forEach((e=>{d.push(e)}));let B=l.getDate();G.forEach((t=>{ve&&(t.highlightTextGetter=ke,t.highlightSize=Me),t.record=l,t.textGetter=Fe,t.hasColorByValue=E,t.colorByValue=h,t.colorByColor=A,B&&(t.date=B.getTime()),i.visible||(t.featureVisible=!1,this.map.checkFeatureVisible(t,!0,e.length<20))})),i.collisionInfo&&i.collisionInfo.addFeatures(G)})),$e.push(new Date),K&&this.addFeatures(p),this.addFeatures(c),this.myPoints=p,this.addFeatures(g),$e.push(new Date),e.length>0&&this.getProperty("selectFirstRecord")&&!this.haveSelectedFirstRecord){this.haveSelectedFirstRecord=!0;let t=e[0];this.propagateEventRecordSelection({record:t});let i=this.getProperty("displayDiv",null);i&&this.textGetter&&jqid(i).html(this.textGetter({record:t}));let s=this.markers[t.getId()];s&&this.map.handleFeatureclick(null,s)}F&&this.map.centerOnMarkers();let ze=this.getSizeByLegendSide();if(ze){let e=ye.getLegend(5,Le,"left"==ze||"right"==ze);if(""!=e){let t=this.getSizeByLegendLabel();t&&(e=HU.div([ATTR_STYLE,HU.css(CSS_TEXT_ALIGN,ALIGN_CENTER,CSS_FONT_WEIGHT,FONT_BOLD)],t)+e);let i=this.getSizeByLegendStyle();i&&(e=HU.div([ATTR_STYLE,i],e)),this.jq(r).html(e),this.callingUpdateSize=!0,this.map.getMap().updateSize(),this.callingUpdateSize=!1}}if($e=[new Date],be&&this.showColorTable(T),this.jq(ID_BOTTOM).append(HU.div([ATTR_ID,this.domId(o)])),$e.push(new Date),J&&pe){let e="";for(a in pe)e+=HU.image(pe[a],[ATTR_WIDTH,32])+" "+a+" ";this.jq(o).html(HU.center(e))}if(fe.field){let e=fe.field.getLabel()+": ";for(v in fe.map){let t=fe.labels[v]??v,i=fe.map[v];"circle"==i?i=HU.getIconImage("fa-circle"):"square"==i||"rectangle"==i?i=HU.getIconImage("fa-square"):"star"==i?i=HU.getIconImage("fa-star"):"diamond"==i?i=HU.getIconImage("fa-diamond"):"triangle"==i?i=HU.getIconImage("/icons/triangle.png",[ATTR_WIDTH,HU.px(16)]):"downtriangle"==i?i=HU.getIconImage("/icons/downtriangle.png",[ATTR_WIDTH,HU.px(16)]):"lightning"==i?i=HU.getIconImage("/icons/lightning.png",[ATTR_WIDTH,HU.px(16)]):"cross"==i?i=HU.getIconImage("/icons/cross.png",[ATTR_WIDTH,HU.px(16)]):"church"==i&&(i=HU.getIconImage("fa-cross")),e+=i+" "+t+SPACE2}this.jq(o).html(HU.center(e))}this.getProperty("animationTakeStep",!1)&&this.getAnimation().doNext(),(this.pointLevelRange||this.glyphLevelRange)&&this.checkLevelRange([this.myFeatureLayer],!0)},getTextGetter:function(e,t){let i=this.getTooltip("${default}");return this.textGetter=s=>{if(!Utils.stringDefined(i))return debugPopup&&console.log("No tooltip"),null;let l;if(l=s.record?[s.record]:s.records,!l||0==l.length)return null;if(this.properties.myTextGetter){let e=this.properties.myTextGetter(this,l);if(e)return e}let a="",r=this.getProperty("tooltipTemplate"),o=this.getProperty("tooltipHeader");if(o?a+=o.replace("${count}",l.length):t&&l.length>0&&(a+=HU.boldLabel("Count")+l.length+HU.br()),l.forEach(((t,s)=>{let l=this.getRecordHtml(t,e,i);r?l=r.replace("${value}",l):s>0&&(a+=HU.thinLine()),a+=l})),debugPopup&&console.log("textGetter: getRecordHtml:"+a),""==a)return null;let n,h,d=[];if(d.push({label:"Properties",contents:a}),l.length>0&&this.getShowMapInTooltip()){h=l[0];h.getLatitude(),h.getLongitude();n=HU.getUniqueId("");let e=HU.div([ATTR_ID,n,ATTR_STYLE,HU.css(CSS_HEIGHT,HU.px(400))]);d.push({label:"Overview Map",contents:e})}if(1==d.length)return a;let g=HU.makeTabs(d),p=g.init;return g.init=()=>{if(p(),!n)return;var e={initialZoom:14,mapCenter:h.getLongitude()+","+h.getLatitude(),defaultMapLayer:this.getTooltipMapLayer("osm")};new RepositoryMap(n,e).initMap(!1)},g}},addLabels:function(e,t){let i=this.getLabelLimit(1e3);if(e.length>i)return;let s,l=this.getLabelTemplate(),a=this.getProperty("labelRecordTemplate");if(this.getLabelKeyField()&&(s=this.getFieldById(t,this.getLabelKeyField())),!l&&!s)return;this.getProperty("doUniqueLabelPosition",!0);let r=this.map.getMap().viewPortDiv.offsetWidth,o=this.map.getMap().viewPortDiv.offsetHeight,n=this.map.getBounds(),h=Math.round(r/10),d=Math.round(o/10);n.right,n.left,n.top,n.bottom;s&&(l="${_key}"),l=l.replace(/_nl_/g,"\n");let g={fontColor:this.getProperty("labelFontColor",COLOR_BLACK),textBackgroundFillColor:this.getLabelBackground(),textBackgroundStrokeColor:this.getLabelStrokeColor(),textBackgroundStrokeWidth:this.getLabelStrokeWidth(),fontSize:this.getProperty("labelFontSize",HU.pt(10)),fontFamily:this.getProperty("labelFontFamily","'Open Sans', Helvetica Neue, Arial, Helvetica, sans-serif"),fontWeight:this.getProperty("labelFontWeight","plain"),labelAlign:this.getProperty("labelAlign","cc"),labelXOffset:this.getProperty("labelXOffset","0"),labelYOffset:this.getProperty("labelYOffset","0"),labelOutlineColor:this.getProperty("labelOutlineColor",COLOR_WHITE),labelOutlineWidth:this.getProperty("labelOutlineWidth","0"),labelSelect:!0};this.map.labelLayer||(this.map.labelLayer=MapUtils.createLayerVector("Labels",{styleMap:MapUtils.createStyleMap({default:g})}),this.map.addVectorLayer(this.map.labelLayer,!0),this.map.labelLayer.setZIndex(100));let p={},c="",u=[],T=(this.getProperty("colorBy"),this.getProperty("sizeBy"),0),f="ABCDEFGHIJKLMNOPQRSTUVWXYZ".split(""),y=[];for(let e=0;e<3;e++)f.forEach((t=>{let i="";for(let s=0;s<=e;s++)i+=t;y.push(i)}));for(let t=0;t<e.length;t++){let i=e[t],r=(i.getLatitude(),i.getLongitude(),{x:i.getLongitude(),y:i.getLatitude()}),o=MapUtils.createPoint(r.x,r.y);o.transform(this.map.displayProjection,this.map.sourceProjection);let n=this.applyRecordTemplate(i,this.getDataValues(i),null,l),h=$.extend({label:n},g),d=MapUtils.createVector(o,null,h);if(d.noSelect=!0,d.attributes={},d.attributes[ATTR_RECORD_INDEX]=t+1,d.attributes.recordIndex=t+1+"",a&&(d.attributes.recordtemplate=n),s){let e=s.getValue(i);p[e]||(T>=y.length&&(T=0),p[e]=y[T++],c+=p[e]+": "+e+HU.br()),d.attributes._key=p[e],h.label=h.label.replace("${_key}",p[e])}u.push(d)}this.haveAddedZoomListener||(this.haveAddedZoomListener=!0,this.getDeclutterLabels()&&(this.getMap().getMap().events.register("zoomend","",(()=>{Utils.bufferedCall(this.getId()+"_checklabels",(()=>{this.declutterLabels()}))}),!0),this.getMap().getMap().events.register("moveend","",(()=>{Utils.bufferedCall(this.getId()+"_checklabels",(()=>{this.declutterLabels()}))}),!0))),c.length>0&&(this.legendId||(this.legendId=this.domId(ID_LEGENDID),this.jq(ID_RIGHT).append(HU.div([ATTR_ID,this.legendId,ATTR_CLASS,"display-map-legend",ATTR_STYLE,HU.css(CSS_MAX_HEIGHT,this.getHeight(HU.px(400)))]))),this.jq(ID_LEGENDID).html(c)),this.labelFeatures&&this.map.labelLayer.removeFeatures(this.labelFeatures),this.map.labelLayer.addFeatures(u),this.labelFeatures=u,this.getDeclutterLabels()&&this.declutterLabels(),jqid(this.map.labelLayer.id).css(CSS_Z_INDEX,900)},declutterLabels:function(){this.labelFeatures&&(MapUtils.declutter(this.getMap(),this.labelFeatures,this.getDeclutterArgs()),this.map.labelLayer.redraw())},getDeclutterArgs:function(){let e=e=>e?+e:null;return{fontSize:this.getProperty("labelFontSize",HU.pt(10)),padding:+this.getProperty("labelDeclutterPadding",1),granularity:+this.getProperty("labelDeclutterGranularity",1),pixelsPerLine:e(this.getProperty("labelDeclutterPixelsPerLine")),pixelsPerCharacter:e(this.getProperty("labelDeclutterPixelsPerCharacter"))}},handleEventRemoveDisplay:function(e,t){if(!this.map)return;let i=this.mapEntryInfos[t];null!=i&&i.removeFromMap(this.map);let s=this.findFeature(t,!0);null!=s&&null!=s.line&&this.map.removePolygon(s.line)},findFeature:function(e,t){for(let i in this.features){let s=this.features[i];if(s.source==e)return t&&this.features.splice(i,1),s}return null},getMarkerIcon:function(e,t){if(this.getProperty("markerIcon")){let e=this.getProperty("markerIcon");return e.startsWith("cdn:")&&(e=markerIcon.replace("cdn:",""),e=RamaddaUtil.getCdnUrl(e)),e}return e||(t?(displayMapCurrentMarker++,displayMapCurrentMarker>=displayMapMarkers.length&&(displayMapCurrentMarker=0),RamaddaUtil.getCdnUrl("/lib/openlayers/v2/img/"+displayMapMarkers[displayMapCurrentMarker])):null)},highlightMarkers:null,handleEventRecordHighlight:function(e,t){if(u.handleEventRecordHighlight.call(this,e,t),displayDebug.handleEventRecordSelect&&this.logMsg("handleEvent"),this.getRecordHighlightFeature()||isNaN(t.record.getLatitude())||isNaN(t.record.getLongitude())){if(this.recordToFeature){let e=this.recordToFeature[t.record.getId()];if(this.highlightedFeature&&this.getMap().unhighlightFeature(this.highlightedFeature),this.highlightedFeature=e,e){let t={};e.style&&(t=$.extend(t,e.style)),t=$.extend(t,{strokeColor:this.getRecordHighlightStrokeColor(),strokeWidth:this.getRecordHighlightStrokeWidth(),fillColor:this.getRecordHighlightFillColor(null),fillOpacity:parseFloat(this.getRecordHighlightFillOpacity(.5))}),this.getMap().highlightFeature(e,t)}}}else{(t.records??[t.record]).forEach(((e,i)=>{this.highlightPoint(e.getLatitude(),e.getLongitude(),t.highlight,0==i,0!=i)}))}},handleEventRecordSelection:function(e,t){u.handleEventRecordSelection.call(this,e,t),this.map&&(t.highlight=!0,this.getShowRecordSelection(!0)&&this.handleEventRecordHighlight(e,t))}})}function MapEntryInfo(e){RamaddaUtil.defineMembers(this,{entry:e,marker:null,rectangle:null,removeFromMap:function(e){null!=this.marker&&e.removeMarker(this.marker),null!=this.rectangle&&e.removePolygon(this.rectangle),null!=this.polygon&&e.removePolygon(this.polygon),null!=this.circle&&e.removePoint(this.circle)}})}const DISPLAY_MAPGRID="mapgrid",DISPLAY_MAPCHART="mapchart",DISPLAY_MAPARRAY="maparray",DISPLAY_MAPSHRINK="mapshrink",DISPLAY_MAPIMAGES="mapimages";addGlobalDisplayType({type:DISPLAY_MAPGRID,label:"Map Grid",category:CATEGORY_MAPS,preview:"mapgrid.png",desc:"Can display US States or World countries"}),addGlobalDisplayType({type:DISPLAY_MAPCHART,label:"Map Chart",requiresData:!0,category:CATEGORY_MAPS,preview:"mapchart.png",desc:"Plot numeric data as heights. Can display US States, European countries or world countries"}),addGlobalDisplayType({type:DISPLAY_MAPSHRINK,label:"Map Shrink",requiresData:!0,category:CATEGORY_MAPS,tooltip:makeDisplayTooltip("Show values as relative size of map regions","mapshrink.png","Can display US States, European countries or world countries")}),addGlobalDisplayType({type:DISPLAY_MAPARRAY,label:"Map Array",requiresData:!0,category:CATEGORY_MAPS,tooltip:makeDisplayTooltip("Colored map regions displayed separately","maparray.png","Can display US States, European countries or world countries")}),addGlobalDisplayType({type:DISPLAY_MAPIMAGES,label:"Map Images",requiresData:!0,category:CATEGORY_MAPS,tooltip:makeDisplayTooltip("Display images in map regions","mapimage.png","Can display US States, European countries or world countries")});let ramaddaGridState={grids:{},loading:{}};function RamaddaMapgridDisplay(e,t,i){const s=new RamaddaFieldsDisplay(e,t,DISPLAY_MAPGRID,i);let l=[{label:"Grid Map Attributes"},{p:"localeField",ex:""},{p:"grid",ex:"countries|us"},{p:"cellSize",ex:"30",tt:"use 0 for flexible width"},{p:"cellHeight",ex:"30"},{p:"showCellLabel",ex:"false"}];l.push(...RamaddaDisplayUtils.sparklineProps),defineDisplay(addRamaddaDisplay(this),s,l,{needsData:function(){return!0},displayData:function(e){this.updateUI()},handleEventFieldsSelected:function(e,t){this.getProperty("selectedFieldIsColorBy")&&t.length>0&&this.colorByFieldChanged(t[0])},colorByFieldChanged:function(e){this.haveCalledUpdateUI=!1,this.setProperty("colorBy",e),this.vectorMapApplied=!1,this.updateUI({colorByFieldChanged:!0})},updateUI:function(){let e=this.getProperty("grid","us"),t=ramaddaGridState.grids[e];if(!t){if(ramaddaGridState.loading[e])return;ramaddaGridState.loading[e]=!0;let t=RamaddaUtil.getCdnUrl("/resources/grid_"+e+".json");return void $.getJSON(t,(t=>{ramaddaGridState.grids[e]=t,this.updateUI()})).fail((function(e){console.log("error loading "+t),console.dir(e)}))}let i=this.filterData();if(!i)return;let s=this.getData().getNonGeoFields(),l=this.getFieldById(s,this.getProperty("localeField","state"));null==l&&(l=this.getFieldById(s,"state"));let a=Number.MAX_VALUE,r=Number.MAX_VALUE,o=Number.MIN_VALUE,n=Number.MIN_VALUE,h={};t.forEach((e=>{a=Math.min(a,e.x),o=Math.max(o,e.x),r=Math.min(r,e.y),n=Math.max(n,e.y),h[this.domId("cell_"+e.x+"_"+e.y)]=e}));let d=this.getColorByInfo(i),g=this.getColorByInfo(i,"sparklineColorBy"),p=this.getColorByInfo(i,"strokeColorBy","strokeColorByMap"),c=this.getFieldById(s,this.getProperty("sparklineField")),u=HU.open(TAG_TABLE,[ATTR_WIDTH,"100%"]),T=this.getProperty("cellWidth",this.getProperty("cellSize",0)),f=this.getProperty("cellHeight",T);0==f&&(f=30);let y=this.getProperty("showCellLabel",!0),m=this.getProperty("cellStyle",""),_={};for(let e=1;e<=n;e++){u+=HU.open(TAG_TR);for(let t=1;t<=o;t++){let i=this.domId("cell_"+t+"_"+e),s=h[i],l=[ATTR_ID,i],a=HU.css(CSS_POSITION,POSITION_RELATIVE,CSS_MARGIN,HU.px(1),CSS_VERTICAL_ALIGN,ALIGN_CENTER,CSS_TEXT_ALIGN,ALIGN_CENTER,CSS_HEIGHT,HU.px(f));T>0&&(a+=HU.css(CSS_WIDTH,HU.px(T)));let r="";s&&(a+=HU.css(CSS_BACKGROUND,COLOR_LIGHT_GRAY)+m,c||l.push(ATTR_TITLE,s.name),l.push(ATTR_CLASS,"display-mapgrid-cell"),r=HU.div([ATTR_STYLE,HU.css(CSS_PADDING_LEFT,HU.px(3))],y?s.codes[0]:""),s.codes.forEach((e=>_[e]=i)),_[s.name]=i),l.push(ATTR_STYLE,a),u+=HU.td([],HU.div(l,r))}u+=HU.close(TAG_TR)}u+=HU.tr([],HU.td([ATTR_COLSPAN,o],HU.br()+HU.div([ATTR_ID,this.domId(ID_COLORTABLE)]))),u+=HU.close(TAG_TABLE),this.setContents(HU.center(u));let S=[],A=this.stateData={},I=0,b=0,R=this.getContents();for(let e=0;e<i.length;e++){let t=i[e],s=t.getData()[l.getIndex()],a=_[s];if(a||(a=_[s.toUpperCase()]),a){if(jqid(a).attr(ATTR_RECORD_INDEX,e),A[s]||(S.push(s),A[s]={cellId:a,data:[],records:[]}),c){let i=t.getValue(c.getIndex());isNaN(i)||(I=0==e?i:Math.min(I,i),b=0==e?i:Math.max(b,i),A[s].data.push(i),A[s].records.push(t))}if(d.isEnabled()){t.getData()[d.index];let i=d.getColorFromRecord(t),s=R.find("#"+a);s.css(CSS_BACKGROUND,i);let l=Utils.getForegroundColor(i);l&&s.css(CSS_COLOR,l),s.attr(ATTR_RECORD_INDEX,e)}if(p.isEnabled()){let e=t.getData()[p.index],i=p.getColor(e,t),s=R.find("#"+a);s.css(CSS_BORDER_COLOR,i),s.css(CSS_BORDER_WIDTH,HU.px(2))}}}if(c){let e=0;S.forEach(((t,i)=>{let s=A[t],l=s.cellId+"_inner",a=T;0==a&&(a=jqid(s.cellId).width());let r=HU.css(CSS_WIDTH,HU.px(a),CSS_HEIGHT,HU.px(f-e),CSS_POSITION,POSITION_ABSOLUTE,CSS_LEFT,HU.px(0),CSS_TOP,HU.px(e)),o=HU.div([ATTR_ID,l,ATTR_STYLE,r]);jqid(s.cellId).append(o),drawSparkline(this,"#"+l,a,f-e,s.data,s.records,I,b,g)}))}this.makePopups(R.find(".display-mapgrid-cell"),i);let D=this;R.find(".display-mapgrid-cell").click((function(){let e=i[$(this).attr(ATTR_RECORD_INDEX)];e&&D.propagateEventRecordSelection({record:e})})),c||this.makeTooltips(R.find(".display-mapgrid-cell"),i,null,"${default}"),d.index>=0&&d.displayColorTable(),g.index>=0&&g.displayColorTable()},handleEventRecordSelection:function(e,t){let i=this.getContents();this.selectedCell&&this.selectedCell.css(CSS_BORDER,this.selectedBorder);let s=this.recordToIndex[t.record.getId()];Utils.isDefined(s)&&(this.selectedCell=i.find(HU.attrSelect(ATTR_RECORD_INDEX,s)),this.selectedBorder=this.selectedCell.css(CSS_BORDER),this.selectedCell.css(CSS_BORDER,HU.border(1,"red")))}})}const ID_BASEMAP="basemap";function RamaddaOtherMapDisplay(e,t,i,s){const l=new RamaddaFieldsDisplay(e,t,i,s);let a=[{label:"Base map properties"},{p:"regionField",ex:""},{p:"mapFile",ex:"usmap.json|countries.json",d:"usmap.json"},{p:"mapEntry",tt:"entry id of geojson map file"},{p:"mapFeature",tt:"feature name to match data with",canCache:!0},{p:"valueField",tt:"Field to get the height of each polygon from",ex:""},{p:"skipRegions",ex:"Alaska,Hawaii"},{p:"pruneMissing",ex:"true"},{p:"mapBackground",ex:COLOR_TRANSPARENT},{p:"transforms",ex:"Alaska,0.4,30,-40;Hawaii,2,50,5;Region,scale,offsetX,offsetY"},{p:"prunes",ex:"Alaska,100;Region,maxCount"},{p:"mapWidth",ex:"600"},{p:"mapHeight",ex:"400"},{p:"maxLon"},{p:"minLon"},{p:"maxLat"},{p:"minLat"},{p:"strokeColor"},{p:"strokeWidth"},{p:"missingFill"}];defineDisplay(addRamaddaDisplay(this),l,a,{checkLayout:function(){this.updateUI()},makeMap:function(){},makePoly:function(e){let t=[];return e.forEach((e=>{let i=e[0],s=e[1];isNaN(i)||isNaN(s)||t.push({x:i,y:s})})),t},findValues:function(e,t){if(t[e])return t[e];let i=null;return this.aliasMap[e]?(this.aliasMap[e].forEach((e=>{t[e]&&(i=t[e])})),i):null},makeValueMap:function(e,t){let i=this.getFieldById(null,this.getPropertyRegionField()),s=this.getFieldById(null,this.getPropertyValueField());if(!i)return this.displayError("No region field specified"),null;if(!s&&t)return this.displayError("No value field specified"),null;s&&(null==this.getProperty("colorBy")&&this.setProperty("colorBy",s.getId()),null==this.getProperty("sizeBy")&&this.setProperty("sizeBy",s.getId()));let l={};return this.valueRange={min:null,max:null},this.idToRecord={},e.forEach((e=>{let t=e.getValue(i.getIndex());this.idToRecord[e.getId()]=e;let a=l[t]={record:e};if(s){let t=e.getValue(s.getIndex());a.value=t,this.valueRange.min=null===this.valueRange.min?t:Math.min(t,this.valueRange.min),this.valueRange.max=null===this.valueRange.max?t:Math.max(t,this.valueRange.max)}})),s&&e.forEach((e=>{let t=e.getValue(i.getIndex()),s=l[t],a=(s.value-this.valueRange.min)/(this.valueRange.max-this.valueRange.min);s.percent=a})),l},writeMap:function(e){let t,i=this.getMapWidth(this.getProperty("width",800)),s=HU.css(CSS_BACKGROUND,this.getMapBackground(COLOR_TRANSPARENT),CSS_WIDTH,HU.getDimension(i));if(!e){t=this.getMapHeight(this.getProperty("height"));let e=this.mapRange.maxLon-this.mapRange.minLon,l=this.mapRange.maxLat-this.mapRange.minLat;t||(t=l/e*i),isNaN(t)&&(t=400),s+=HU.css(CSS_HEIGHT,HU.getDimension(t))}return this.mapRange.maxLon=this.getPropertyMaxLon(this.mapRange.maxLon),this.mapRange.minLon=this.getPropertyMinLon(this.mapRange.minLon),this.mapRange.maxLat=this.getPropertyMaxLat(this.mapRange.maxLat),this.mapRange.minLat=this.getPropertyMinLat(this.mapRange.minLat),this.setContents(HU.div([ATTR_ID,this.domId(ID_BASEMAP),ATTR_STYLE,s])),isNaN(i)&&(i=this.getContents().width()),[i,t]},makeSvg:function(e,t){return[d3.select("#"+this.domId(ID_BASEMAP)).append(TAG_SVG).attr(ATTR_WIDTH,e).attr(ATTR_HEIGHT,t).append(TAG_G),d3.scaleLinear().domain([this.mapRange.minLon,this.mapRange.maxLon]).range([0,e-0]),d3.scaleLinear().domain([this.mapRange.maxLat,this.mapRange.minLat]).range([0,t-0])]},clearTooltip:function(){this.tooltipDiv&&this.tooltipDiv.style("opacity",0)},makeTooltipDiv:function(){return this.tooltipDiv||(this.tooltipDiv=d3.select(TAG_BODY).append(TAG_DIV).attr(ATTR_CLASS,"ramadda-shadow-box  display-tooltip").style("opacity",0).style(CSS_POSITION,POSITION_ABSOLUTE).style(CSS_BACKGROUND,COLOR_WHITE)),this.clearTooltip(),this.tooltipDiv},addEvents:function(e,t,i){let s=this;t=t||this.idToRecord,i=i||this.makeTooltipDiv(),e.on("click",(function(e,i){let l=d3.select(this),a=t[l.attr(ATTR_RECORD_ID)];a&&s.propagateEventRecordSelection({record:a})})),e.on("mouseover",(function(e,i){let l=d3.select(this),a=t[l.attr(ATTR_RECORD_ID)];l.attr("lastStroke",l.attr("stroke")).attr("lastFill",l.attr("fill")),l.attr("stroke",s.getProperty("highlightStrokeColor","blue")).attr("stroke-width",s.getProperty("highlightStrokeWidth",1)).attr("fill",s.getProperty("highlightFillColor","blue"));let r=s.getProperty("tooltip");if(!r)return;let o=l.attr("regionName"),n=null;a?(s.propagateEventRecordSelection({highlight:!0,record:a}),n=s.getRecordHtml(a,null,r)):(n=o,console.log("no record found for region:"+o)),n&&(s.tooltipDiv.html(n).style(CSS_LEFT,HU.px(e.pageX+10)).style(CSS_TOP,HU.px(e.pageY+20)),s.tooltipDiv.style("opacity",1))})),e.on("mouseout",(function(e,t){let i=d3.select(this);i.attr("stroke",i.attr("lastStroke")).attr("fill",i.attr("lastFill")).attr("stroke-width",1),s.tooltipDiv.style("opacity",0)}))},updateUI:function(){if(this.clearTooltip(),this.mapJson)(this.regions||this.makeRegions())&&this.makeMap();else if(!this.gettingFile){this.gettingFile=!0;let e=this.getPropertyMapFile(),t=this.getMapEntry();null!=t?e=HU.url(RamaddaUtil.getUrl(URL_ENTRY_GET),ARG_ENTRYID,t):e.startsWith("/")||e.startsWith("http")||(e=RamaddaUtil.getCdnUrl("/resources/"+e)),$.getJSON(e,(e=>{this.mapJson=e,this.regionNames=[],this.makeRegions(),this.updateUI()}))}},makeRegions:function(){if(!this.mapJson)return!1;let e=this.getProperty("debug"),t=this.getPropertyPruneMissing(!1),i={};if(null==this.getData())return!1;let s=this.getData().getRecords();if(!s)return;let l=this.getFieldById(null,this.getPropertyRegionField());if(null==l)return this.displayError("No region field"),!1;s.forEach((e=>{let t=e.getValue(l.getIndex());i[t]=!0})),this.regions={},this.mapRange={minLon:null,maxLon:null,minLat:null,maxLat:null};let a={},r={};this.getPropertyTransforms("").split(";").map((e=>e.split(","))).forEach((e=>{let t=e[0];a[t]={scale:null!=e[1]?+e[1]:1,dx:null!=e[2]?+e[2]:0,dy:null!=e[3]?+e[3]:0}})),this.getPropertyPrunes("").split(";").map((e=>e.split(","))).forEach((e=>{let t=e[0];r[t]=+e[1]}));let o=(e,t)=>{let i=r[e];if(i>0&&t.length<i)return null;let s=a[e];if(!s)return t;let l=Utils.getBounds(t),o=l.minx+(l.maxx-l.minx)/2,n=l.miny+(l.maxy-l.miny)/2;return t.map((e=>(e[0]=(e[0]-o)*s.scale+o,e[1]=(e[1]-n)*s.scale+n,e[0]+=s.dx,e[1]+=s.dy,e))),t};this.skipRegions=this.getPropertySkipRegions("").split(",").map((e=>e.replace(/_comma_/g,",")));let n=this.mapJson.geojson;n||(n=this.mapJson.features),this.aliasMap={};let h=this.getMapFeature();return n.forEach((s=>{let l;l=h?s.properties[h]:s.properties.name||s.properties.name_long||s.properties.NAME||s.properties.ADMIN;let a=[l];if("United States of America"==l&&a.push("United States"),"United Republic of Tanzania"==l&&a.push("Tanzania"),"Democratic Republic of the Congo"==l&&a.push("Democratic Republic of Congo"),"Czech Rep."==l&&a.push("Czech Republic"),"Bosnia and Herz."==l&&a.push("Bosnia and Herzegovina"),this.aliasMap[l]=a,s.properties.ISO_A3&&a.push(s.properties.ISO_A3),s.properties.STUSPS&&a.push(s.properties.STUSPS),s.properties.STATEFP&&a.push(s.properties.STATEFP),!s.geometry)return void(e&&console.log(l+" no geometry"));e&&console.log("region:"+l);let r=!0;if(a.forEach((e=>{this.skipRegions.includes(e)&&(r=!1)})),!r)return;r=!1,a.forEach((e=>{i[e]&&(r=!0)})),r||this.handleWarning("Missing data for map region:"+l),t&&!r&&e&&console.log("missing data:"+l),this.regionNames.push(l);let n=s.geometry.coordinates,d={name:l,aliases:a,polygons:[],bounds:null};a.forEach((e=>{this.regions[e]=d})),"MultiPolygon"==s.geometry.type?n.forEach((e=>{e.forEach((e=>{(e=o(l,e))&&d.polygons.push(e)}))})):n.forEach((e=>{d.polygons.push(o(l,e))})),d.polygons.forEach((e=>{e.forEach((e=>{let t=e[0],i=e[1];isNaN(t)||isNaN(i)||(this.mapRange.minLon=null===this.mapRange.minLon?t:Math.min(this.mapRange.minLon,t),this.mapRange.maxLon=null===this.mapRange.maxLon?t:Math.max(this.mapRange.maxLon,t),this.mapRange.minLat=null===this.mapRange.minLat?i:Math.min(this.mapRange.minLat,i),this.mapRange.maxLat=null===this.mapRange.maxLat?i:Math.max(this.mapRange.maxLat,i))}))}));let g=null;d.polygons.forEach((e=>{g=Utils.mergeBounds(g,Utils.getBounds(e))})),d.bounds=g})),!0}})}function RamaddaMapchartDisplay(e,t,i){const s=new RamaddaOtherMapDisplay(e,t,DISPLAY_MAPCHART,i);defineDisplay(addRamaddaDisplay(this),s,[{label:"Map chart Properties"},{p:"fixedFillColor",tt:"Use this color for all polygons",ex:"red"},{p:"fixedStrokeColor",tt:"Use this color for all polygons",ex:"red"},{p:"missingLineColor"},{p:"missingFillColor"},{p:"maxLayers",ex:"10"},{p:"translateX",ex:"0"},{p:"translateY",ex:"0"},{p:"skewX",ex:"-10"},{p:"skewY",ex:"0"},{p:"rotate",ex:"10"},{p:"scale",ex:"0"},{p:"fillColor",ex:"red"},{p:"blur",ex:"4"}],{makeMap:function(){let e=this.filterData();if(!e)return;let t=this.makeValueMap(e,!0);if(!t)return;let i=this.getData().getRecords(),s=this.getPropertyPruneMissing(!1),l=+this.getPropertyMaxLayers(20);Object.keys(t).forEach((e=>{let i=t[e];i.layers=Math.round(i.percent*(l-1))+1})),this.colorBy=this.getColorByInfo(i);let[a,r]=this.writeMap(),[o,n,h]=this.makeSvg(a,r);SU.transform(o,SU.translate(a/2,r/2),SU.scale(.9),SU.rotate(this.getPropertyRotate(0)),SU.translate(-a/2,-r/2),SU.translate(this.getPropertyTranslateX(30),this.getPropertyTranslateY(0)),SU.skewX(this.getPropertySkewX(-10)),SU.scale(this.getPropertyScale(1)));o.append("defs");SU.makeBlur(o,"blur",this.getPropertyBlur(3)),s=!1;let d=this.getFixedFillColor(),g=this.getFixedStrokeColor();for(let e=0;e<l;e++)this.regionNames.forEach((i=>{let s=this.findValues(i,t),l=1,a=NaN,r=null==s,p=null;if(r){if(l=1,e>0)return}else l=s.layers,a=s.value,p=s.record;let c=p?p.getId():"";Utils.isDefined(l)||(l=1),e>l||this.regions[i].polygons.forEach((t=>{let s=HU.getUniqueId("selector_"),u=this.makePoly(t),T=COLOR_TRANSPARENT;if(r?(T=this.getMissingFillColor(COLOR_LIGHT_GRAY),lineColor=this.getMissingLineColor(COLOR_BLACK)):(e==l-1?(T=this.colorBy.getColorFromRecord(p),lineColor=Utils.pSBC(.1,T)):lineColor=Utils.pSBC(-.3,this.colorBy.getColor(a)),d&&(T=d),g&&(lineColor=g)),r)return void o.selectAll(s).data([u]).enter().append("polygon").attr("points",(function(t){return t.map((t=>[-e+n(t.x),-e+h(t.y)].join(","))).join(" ")})).attr("regionName",i).attr("fill",T).attr("stroke-width",1).attr("stroke",lineColor);0==e&&o.selectAll(s).data([u]).enter().append("polygon").attr("points",(function(t){return t.map((t=>[-e+n(t.x),-e+h(t.y)].join(","))).join(" ")})).attr("stroke-width",3).attr("stroke","black").style("filter","url(#blur)");let f=o.selectAll(s).data([u]).enter().append("polygon").attr("points",(function(t){return t.map((t=>[-e+n(t.x),-e+h(t.y)].join(","))).join(" ")})).attr("fill",T).attr("opacity",1).attr("stroke",lineColor).attr("stroke-width",1).style(CSS_CURSOR,CURSOR_POINTER).attr(ATTR_RECORD_ID,c);this.addEvents(f)}))}));d||this.colorBy.displayColorTable()}})}function RamaddaMaparrayDisplay(e,t,i){const s=new RamaddaOtherMapDisplay(e,t,DISPLAY_MAPARRAY,i);defineDisplay(addRamaddaDisplay(this),s,[{label:"Map array properties"},{p:"blockWidth",ex:""},{p:"sortByValue",ex:"true"},{p:"fillColor",ex:"red"},{p:"showValue",ex:"true"}],{makeMap:function(){let e=this.filterData();if(!e)return;let t=this.makeValueMap(e,!0);if(!t)return;let i=this.getData().getRecords();this.colorBy=this.getColorByInfo(i);let[s,l]=this.writeMap(!0),a=this.getPropertyBlockWidth(75),r=a,o=this.getPropertyPruneMissing(!0),n=this.regionNames;this.getSortByValue(!0)?n.sort(((e,i)=>t[e]?t[i]?t[e].value-t[i].value:-1:1)):n.sort();let h="";n.forEach(((e,t)=>{h+=HU.div([ATTR_CLASS,"display-maparray-block"],HU.div([ATTR_CLASS,"display-maparray-header"],e)+HU.div([ATTR_ID,this.domId("mapblock_"+t),ATTR_CLASS,"display-maparray-map",ATTR_STYLE,HU.css(CSS_WIDTH,HU.px(a),CSS_HEIGHT,HU.px(r))])+HU.div([ATTR_ID,this.domId("maplabel_"+t),"display-maparray-label"]))})),this.jq(ID_BASEMAP).html(h+HU.p());let d=this.getPropertyShowValue(!0);n.forEach(((e,i)=>{let s,l,n=this.regions[e],h=d3.select("#"+this.domId("mapblock_"+i)).append(TAG_SVG).attr(ATTR_WIDTH,a).attr(ATTR_HEIGHT,r).append(TAG_G),g=n.bounds.getWidth(),p=n.bounds.getHeight();g>p?(s=d3.scaleLinear().domain([n.bounds.minx,n.bounds.maxx]).range([0,a-5]),l=d3.scaleLinear().domain([n.bounds.maxy,n.bounds.miny]).range([0,p/g*r-5])):(s=d3.scaleLinear().domain([n.bounds.minx,n.bounds.maxx]).range([0,g/p*a-5]),l=d3.scaleLinear().domain([n.bounds.maxy,n.bounds.miny]).range([0,r-5]));let c=t[e],u=NaN,T=null==c,f=null;if(T){if(o)return}else u=c.value,f=c.record,d&&this.jq("maplabel_"+i).html(u);let y=f?f.getId():"";n.polygons.forEach((e=>{let t=HU.getUniqueId(),i=this.makePoly(e),a=COLOR_TRANSPARENT;if(T?(a=COLOR_LIGHT_GRAY,lineColor=COLOR_BLACK):(a=this.colorBy.getColor(u),lineColor=COLOR_LIGHT_GRAY),T)return void h.selectAll(t).data([i]).enter().append("polygon").attr("points",(function(e){return e.map((e=>[-layer+s(e.x),-layer+l(e.y)].join(","))).join(" ")})).attr("fill",COLOR_LIGHT_GRAY).attr("stroke-width",1).attr("stroke","black");let r=h.selectAll(t).data([i]).enter().append("polygon").attr("points",(function(e){return e.map((e=>[+s(e.x),+l(e.y)].join(","))).join(" ")})).attr("fill",a).attr("opacity",1).attr("stroke",lineColor).attr("stroke-width",1).style(CSS_CURSOR,CURSOR_POINTER).attr(ATTR_RECORD_ID,y);this.addEvents(r)}))})),this.colorBy.displayColorTable()}})}function RamaddaMapshrinkDisplay(e,t,i){const s=new RamaddaOtherMapDisplay(e,t,DISPLAY_MAPSHRINK,i);defineDisplay(addRamaddaDisplay(this),s,[{label:"Map shrink Properties"}],{makeMap:function(){let e=this.filterData();if(!e)return;let t=this.getData().getRecords(),i=this.getPropertyPruneMissing(!1),s=this.makeValueMap(e,!0);if(!s)return;let l=new SizeBy(this,t);this.colorBy=this.getColorByInfo(t);let[a,r]=this.writeMap(),[o,n,h]=this.makeSvg(a,r);for(let e=0;e<2;e++)this.regionNames.forEach((t=>{let a=this.findValues(t,s),r=NaN,d=null==a,g=null;if(d){if(i)return;if(e>0)return}else r=a.value,g=a.record;let p=g?g.getId():"";this.regions[t].polygons.forEach((t=>{let i=HU.getUniqueId(),s=this.makePoly(t),a="red",g="";if(lineColor=COLOR_BLACK,0==e)a=COLOR_WHITE;else{lineColor=COLOR_TRANSPARENT,a=this.colorBy.getColor(r);let e=Utils.getBounds(t).getCenter(),i=function(e,t){return percent=e,percent};l.getSizeFromValue(r,i),g=SU.translate(n(e.x),h(e.y))+SU.scale(percent)+SU.translate(-n(e.x),-h(e.y))}if(d)return void o.selectAll("base"+i).data([s]).enter().append("polygon").attr("points",(function(t){return t.map((t=>[-e+n(t.x),-e+h(t.y)].join(","))).join(" ")})).attr("fill",COLOR_LIGHT_GRAY).attr("stroke-width",1).attr("stroke","black");0==e&&o.selectAll("base"+i).data([s]).enter().append("polygon").attr("points",(function(t){return t.map((t=>[-e+n(t.x),-e+h(t.y)].join(","))).join(" ")})).attr("stroke-width",1).attr("stroke","black").attr(ATTR_TRANSFORM,g);let c=o.selectAll(i).data([s]).enter().append("polygon").attr("points",(function(t){return t.map((t=>[-e+n(t.x),-e+h(t.y)].join(","))).join(" ")})).attr("fill",a).attr("opacity",1).attr("stroke",lineColor).attr("stroke-width",1).attr(ATTR_TRANSFORM,g).style(ATTR_CURSOR,CURSOR_POINTER).attr(ATTR_RECORD_ID,p);1==e&&this.addEvents(c)}))}));this.colorBy.displayColorTable()}})}function RamaddaMapimagesDisplay(e,t,i){const s=new RamaddaOtherMapDisplay(e,t,DISPLAY_MAPIMAGES,i);defineDisplay(addRamaddaDisplay(this),s,[{label:"Map Images Properties"},{p:"imageField",ex:""}],{getHeightForStyle:function(e){return null},addMacroAttributes:function(e,t,i){if(s.addMacroAttributes.call(this,e,t,i),!this.imageField)return;let l=t[this.imageField.getIndex()],a=[],r=e.getAttributes("imageField_image"),o=r?r.width:null;o?(a.push(ATTR_WIDTH),a.push(o)):this.getProperty("imageWidth")?(a.push(ATTR_WIDTH),a.push(this.getProperty("imageWidth"))):(a.push(ATTR_WIDTH),a.push("100%")),a.push(ATTR_STYLE),a.push("vertical-align:top");let n=HU.image(l,a);i.imageField_image=n,i.imageField_url=l},makeMap:function(){let e=this.filterData();if(!e)return;this.imageField=this.getFieldById(null,this.getPropertyImageField()),null==this.imageField&&(this.imageField=this.getFieldByType(null,"image"));let t=this.getStrokeWidth(1),i=this.getStrokeColor(COLOR_BLACK);if(null==this.imageField)return void this.displayError("No image fields");let s=this.makeValueMap(e);if(!s)return;Object.keys(s).forEach((e=>{let t=s[e];t.image=t.record.getValue(this.imageField.getIndex())}));let[l,a]=this.writeMap(),[r,o,n]=this.makeSvg(l,a),h=r.append("defs");this.regionNames.forEach(((e,l)=>{let a=this.findValues(e,s),d=null!=a?a.record.getId():"",g=Utils.cleanId(e);this.regions[e].polygons.forEach((s=>{let l=HU.getUniqueId();null!=a&&h.append("svg:pattern").attr(ATTR_ID,"bgimage"+l).attr("x","1").attr("y","1").attr(ATTR_WIDTH,HU.perc(100)).attr(ATTR_HEIGHT,HU.perc(100)).attr("patternContentUnits","objectBoundingBox").append("svg:image").attr("xlink:href",a.image).attr("preserveAspectRatio","none").attr(ATTR_WIDTH,1).attr(ATTR_HEIGHT,1).attr("x","0").attr("y","0");let p=r.selectAll(g+"base"+l).data([this.makePoly(s)]).enter().append("polygon").attr("regionName",e).attr("points",(function(e){return e.map((e=>[o(e.x),n(e.y)].join(","))).join(" ")})).attr(ATTR_RECORD_ID,d).attr("stroke-width",t).attr("stroke",i);null!=a?p.style("fill","url(#bgimage"+l+")"):p.style("fill",this.getPropertyMissingFill(COLOR_WHITE)),this.addEvents(p)}))}))}})}var DISPLAY_IMDV="imdv",DISPLAY_EDITABLEMAP="editablemap";addGlobalDisplayType({type:DISPLAY_IMDV,label:"Integrated Map Data",category:CATEGORY_MAPS,tooltip:makeDisplayTooltip("Integrated Map Data","imdv.png","Create interactive maps with points, routes, data, etc")});var GLYPH_FIXED="fixed",GLYPH_GROUP="group",GLYPH_ZOOM="zoom",GLYPH_MARKER="marker",GLYPH_POINT="point",GLYPH_LABEL="label",GLYPH_BOX="box",GLYPH_CIRCLE="circle",GLYPH_TRIANGLE="triangle",GLYPH_HEXAGON="hexagon",GLYPH_LINE="line",GLYPH_RINGS="rings",GLYPH_ROUTE="route",GLYPH_ISOLINE="isoline",GLYPH_POLYLINE="polyline",GLYPH_FREEHAND="freehand",GLYPH_POLYGON="polygon",GLYPH_FREEHAND_CLOSED="freehand_closed",GLYPH_IMAGE="image",GLYPH_ENTRY="entry",GLYPH_MULTIENTRY="multientry",GLYPH_MAP="map",GLYPH_MAPSERVER="mapserver",GLYPH_DATA="data",GLYPH_OSM_LOCATIONS="osmlocations",GLYPH_TYPES_SHAPES=[GLYPH_POINT,GLYPH_BOX,GLYPH_CIRCLE,GLYPH_TRIANGLE,GLYPH_HEXAGON,GLYPH_LINE,GLYPH_POLYLINE,GLYPH_FREEHAND,GLYPH_POLYGON,GLYPH_FREEHAND_CLOSED],GLYPH_TYPES_LINES_OPEN=[GLYPH_LINE,GLYPH_POLYLINE,GLYPH_FREEHAND,GLYPH_ROUTE],GLYPH_TYPES_LINES=[GLYPH_LINE,GLYPH_POLYLINE,GLYPH_FREEHAND,GLYPH_POLYGON,GLYPH_FREEHAND_CLOSED,GLYPH_ROUTE],GLYPH_TYPES_LINES_STRAIGHT=[GLYPH_LINE,GLYPH_POLYLINE],GLYPH_TYPES_CLOSED=[GLYPH_POLYGON,GLYPH_FREEHAND_CLOSED,GLYPH_BOX,GLYPH_TRIANGLE,GLYPH_HEXAGON],MAP_TYPES=["geo_geojson","geo_gpx","geo_shapefile","geo_kml","type_wmts_layer","type_wms_layer"],LEGEND_IMAGE_ATTRS=[ATTR_STYLE,HU.css(CSS_COLOR,COLOR_LIGHT_GRAY,CSS_FONT_SIZE,HU.pt(9))],BUTTON_IMAGE_ATTRS=[ATTR_STYLE,HU.css(CSS_MARGIN_RIGHT,HU.px(4),CSS_COLOR,COLOR_LIGHT_GRAY)],PROP_DONT_SHOW_IN_LEGEND="dontShowInLegend",PROP_SHOW_LAYER_SELECT_IN_LEGEND="showLayerSelectInLegend",PROP_LAYERS_STEP_SHOW="showLayersStep",PROP_LAYERS_SHOW_SEQUENCE="showLayersInSequence",PROP_LAYERS_ANIMATION_SHOW="showLayersAnimation",PROP_LAYERS_ANIMATION_PLAY="layersAnimationPlay",PROP_SHOW_CONTROL_IN_HEADER="showControlInHeader",PROP_LEVELRANGE_SHOWMARKER="showMarkerWhenNotVisible",PROP_LEVELRANGE_RANGE="visibleLevelRange",PROP_SHOWOPACITYSLIDER="showOpacitySlider",PROP_MOVE_TO_LATEST_LOCATION="moveToLatestLocation",PROP_LAYERS_ANIMATION_DELAY="layersAnimationDelay",PROP_LAYERS_ANIMATION_ON="layersAnimatioOn",ATTR_BUTTON_COMMAND="buttoncommand",ATTR_GLYPH_ID="glyphid",ATTR_WIDGET_ID="widget-id",ATTR_SLIDER_ID="slider-id",ATTR_COLOR="color",IMDV_PROPERTY_HINTS=["filter.live=true","filter.show=false","filter.zoomonchange.show=false","filter.toggle.show=false","filter.sortOnCount=true","filter.showRawValues=true","legendTooltip=","showLabelInMap=true",PROP_MOVE_TO_LATEST_LOCATION+"=true","showLabelInMapWhenVisible=true","showViewInLegend=true",PROP_SHOW_LAYER_SELECT_IN_LEGEND+"=true","inMapLabel=","showLegendInMap=true",PROP_DONT_SHOW_IN_LEGEND+"=true","showDisplayHeader=false","showInHeader=true","showIconInHeader=true","mapLegendHeight=300px","showLegendBox=true","showOpacitySlider=true","showRotationSlider=true","showButtons=false","showMeasures=false","showTextSearch=true"],IMDV_GROUP_PROPERTY_HINTS=[PROP_LAYERS_STEP_SHOW+"=true",PROP_LAYERS_SHOW_SEQUENCE+"=true",PROP_LAYERS_ANIMATION_SHOW+"=true",PROP_LAYERS_ANIMATION_DELAY+"=1000",PROP_LAYERS_ANIMATION_PLAY+"=true"],CLASS_IMDV_SIDEHELP="imdv-side-help",CLASS_IMDV_PROPERTY="imdv-property",CLASS_IMDV_STYLEGROUP="imdv-stylegroup",CLASS_IMDV_STYLEGROUP_SELECTED="imdv-stylegroup-selected",CLASS_IMDV_COLOR="ramadda-imdv-color",CLASS_LEGEND_LABEL="imdv-legend-label",CLASS_LEGEND_LABEL_INVISIBLE="imdv-legend-label-invisible",CLASS_LEGEND_LABEL_HIGHLIGHT="imdv-legend-label-highlight",CLASS_LEGEND_ITEM="imdv-legend-item",CLASS_LEGEND_OFFSET="imdv-legend-offset",CLASS_LEGEND_INNER="imdv-legend-inner",CLASS_LEGEND_ITEM_VIEW="imdv-legend-item-view",CLASS_LEGEND_ITEM_DROPPABLE="imdv-legend-item-droppable",CLASS_FILTER_SLIDER="imdv-filter-slider",CLASS_FILTER_SLIDER_LABEL="imdv-filter-slider-label",CLASS_FILTER_PLAY="imdv-filter-play",CLASS_FILTER_STRING="imdv-filter-string",CLASS_FILTER_STRINGS="imdv-filter-strings",ROUTE_CAR="car",ROUTE_BICYCLE="bicycle",ROUTE_PEDESTRIAN="pedestrian",ID_GLYPH_LEGEND="glyphlegend",ID_MAPRESOURCE="mapresource",ID_LEVEL_RANGE_SLIDER="level_range_slider",ID_LEVEL_RANGE_CLEAR="level_range_clear",ID_LEVEL_RANGE_CHANGED="level_range_changed",ID_LEVEL_RANGE_MIN="level_range_min",ID_LEVEL_RANGE_MAX="level_range_max",ID_LEVEL_RANGE_SAMPLE_MIN="level_range_sample_min",ID_LEVEL_RANGE_SAMPLE_MAX="level_range_sample_max",ID_OSM_LABEL="osmlabel",ID_OSM_TEXT="osmtext",ID_STYLE_DIALOG="styledialog",ID_STYLE_DIALOG_ACTIVE="styledialogactive";let ImdvUtils={getImdv:function(e){return Utils.displaysMap[e]},applyFeatureStyle:function(e,t){if(!e.style)return void(e.style=t);let i=e?.geometry?.CLASS_NAME;"OpenLayers.Geometry.Point"==i&&Utils.stringDefined(e.style.externalGraphic)?(t=$.extend({},t),e.originalGraphic||(e.originalGraphic=e.style.externalGraphic),Utils.stringDefined(t.externalGraphic)||(t.externalGraphic=e.originalGraphic),e.style=t):e.style=t},findGlyph:function(e,t){if(!e)return null;for(let i=0;i<e.length;i++){let s=e[i].findGlyph(t);if(s)return s}return null},scheduleRedraw:function(e,t){e&&(e.redrawPending||(e.redrawPending=!0,setTimeout((()=>{e.redraw(),e.redrawPending=!1}),1)))}};function RamaddaImdvDisplay(e,t,i){this.mapProperties={},Utils.importJS(RamaddaUtil.getCdnUrl("/wiki.js")),MapUtils.initMapResources(),ImageHandler=OpenLayers.Class(OpenLayers.Handler.RegularPolygon,{CLASS_NAME:"IMDV Image Handler",initialize:function(e,t,i){OpenLayers.Handler.RegularPolygon.prototype.initialize.apply(this,arguments),this.display=i.display},finalize:function(e){if(e||!this.image)return;let t=this.image;this.theImage=t,this.image=null,this.display.featureChanged(),OpenLayers.Handler.RegularPolygon.prototype.finalize.apply(this,arguments),setTimeout((()=>{let e=this.display.getNewFeature();e.style.strokeColor=COLOR_TRANSPARENT;let i=this.display.handleNewFeature(e,this.style);i.setImage(t),i.setRotation(i.style.rotation),e.mapGlyph=i,this.display.myLayer.redraw(e),this.display.clearCommands()}),250)},move:function(e){if(!this.checkingImageSize){this.checkingImageSize=!0;const e=new Image;e.onload=()=>{this.imageBounds={width:e.width,height:e.height}},e.src=this.style.imageUrl}OpenLayers.Handler.RegularPolygon.prototype.move.apply(this,arguments);let t=this.feature.geometry.getBounds(),i=this.display.map.transformProjBounds(t);if(this.imageBounds&&!e.shiftKey){this.imageBounds.width,this.imageBounds.height;let e=this.imageBounds.height/this.imageBounds.width,t=(i.top,i.bottom,i.right-i.left);i.bottom=i.top-e*t}this.lastBounds=i,isNaN(i.bottom)&&(i.bottom=i.top),isNaN(i.top)&&(i.top=i.bottom),this.image?(i=this.display.map.transformLLBounds(i),this.image.extent=i,this.image.moveTo(i,!0,!0)):this.image=this.display.getMap().addImageLayer("IMDV Image","IMDV Image","",this.style.imageUrl,!0,i.top,i.left,i.bottom,i.right),this.image.setOpacity(this.style.imageOpacity)}}),MyPoint=OpenLayers.Class(OpenLayers.Handler.Point,{finalize:function(e){OpenLayers.Handler.Point.prototype.finalize.apply(this,arguments),e||this.display.handleNewFeature(this.display.getNewFeature())}}),MyEntryPoint=OpenLayers.Class(OpenLayers.Handler.Point,{finalize:function(e){OpenLayers.Handler.Point.prototype.finalize.apply(this,arguments),e||this.display.handleNewFeature(this.display.getNewFeature()),this.display.clearCommands()}}),MyPolygon=OpenLayers.Class(OpenLayers.Handler.Polygon,{finalize:function(e){if(OpenLayers.Handler.Path.prototype.finalize.apply(this,arguments),e)return;let t=this.display.getNewFeature();t&&t.geometry&&this.display.handleNewFeature(t)},move:function(e){OpenLayers.Handler.Path.prototype.move.apply(this,arguments),this.display.showDistances(this.line.geometry,this.glyphType)}}),MyPath=OpenLayers.Class(OpenLayers.Handler.Path,{finalize:function(e){if(OpenLayers.Handler.Path.prototype.finalize.apply(this,arguments),e)return;let t=this.display.getNewFeature();t&&t.geometry&&this.display.handleNewFeature(t)},move:function(e){OpenLayers.Handler.Path.prototype.move.apply(this,arguments),this.display.showDistances(this.line.geometry,this.glyphType)}}),MyRoute=OpenLayers.Class(OpenLayers.Handler.Path,{finalize:function(e){if(this.makingRoute)return;if(OpenLayers.Handler.Path.prototype.finalize.apply(this,arguments),e)return;if(this.finishedWithRoute)return;let t=this.display.getNewFeature();if(!t||!t.geometry)return;let i=this.display.getLatLonPoints(t.geometry);null!=i&&this.display.createRoute(this.display.routeProvider,this.display.routeType,i,{line:t})},move:function(e){this.makingRoute||OpenLayers.Handler.Path.prototype.move.apply(this,arguments)}}),MyRegularPolygon=OpenLayers.Class(OpenLayers.Handler.RegularPolygon,{dragend:function(){OpenLayers.Handler.RegularPolygon.prototype.dragend.apply(this,arguments),this.display.handleNewFeature(this.display.getNewFeature(),this.style)},move:function(e){OpenLayers.Handler.RegularPolygon.prototype.move.apply(this,arguments),this.feature&&this.feature.geometry&&this.display.showDistances(this.feature.geometry,this.glyphType)}});const s="imdv-feature-row",l="imdv-feature-selected",r="mapmenubar",o="message",n="message2",h="message3",d="glyphlabels",g="toggleon",p="toggleoff",c="address",u="address_input",T="address_wait",f="address_clear",y="address_add",m="listdelete",_="listcancel",S="delete",A="select",I="new_file",b="menu_file",R="menu_edit",D="menu_view",L="toback",U="tofront",C="cut",E="copy",H="paste",P="commands",x="clear",O="cmdlist",N="list",w="properties",M="save",F="import",k="download",G="selector",B="selectall",Y="edit",V="mover",q="resize",W="reshape",j="rotate",z="legend",K="legend_left",X="legend_right",Z="legend_map_wrapper",J="legend_map",Q="mapproperties",ee="showregions",te="chooselatlon",ie="viewlayers",se="resetmapview",le="mylocation",ae="dropbeginning",re="dropend";this.ID_LEGEND_MAP=J;const oe=new RamaddaBaseMapDisplay(e,t,DISPLAY_IMDV,i);RamaddaUtil.inherit(this,oe),addRamaddaDisplay(this),this.defineSizeByProperties(),this.map=this.getProperty("theMap");displayDefineMembers(this,[{label:"Editable Map Properties"},{p:"displayOnly",d:!1},{p:"strokeColor",d:"blue"},{p:"strokeWidth",d:2},{p:"pointRadius",d:10},{p:"externalGraphic",d:"/map/blue-dot.png"},{p:"fontSize",d:HU.px(12)},{p:"fontWeight",d:"normal"},{p:"fontStyle",d:"normal"},{p:"fontFamily",d:"'Open Sans', Helvetica Neue, Arial, Helvetica, sans-serif"},{p:"imageOpacity",d:1},{p:"userCanChange",tt:"Set to false to not show menubar, etc for all users"},{p:"showLegendShapes",d:!0,canCache:!0},{p:"showMapLegend",d:!1,canCache:!0},{p:"glyphid.visible",ex:!0,tt:"Get the glyph id from its properties popup"},{p:"glyphid.legendVisible",ex:!0,tt:"Get the glyph id from its properties popup"}],{commands:[],myLayer:[],glyphs:[],markers:{},minLevel:2,maxLevel:20,levels:[["","None"],[2,"2 - Most zoomed out"],3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,[20,"20 - Most zoomed in"]],DOT_STYLE:{zIndex:1e3,fillColor:COLOR_BLACK,fillOpacity:1,strokeWidth:0,pointRadius:4},getGlyphs:function(){return this.glyphs},selected:{},getMap:function(){return this.map},getUsedMarkers:function(){return Object.keys(this.markers)},displayedColorTables:{},applyMapGlyphColorTable:function(e,t){let i=t.getId();i&&!this.displayedColorTables[i]&&(this.displayedColorTables[i]=!0,t.displayColorTable())},makeLabel:function(e){let t=e.toLowerCase(),i=this.getMapProperty(t+".label");return i||MapUtils.makeLabel(e)},setLastDroppedTime:function(e){this.lastDroppedTime=e},showFeatureProperty:function(e){let t=e.toLowerCase();return this.getMapProperty(t+".showFeature",!0)},findGlyph:function(e){return ImdvUtils.findGlyph(this.glyphs,e)},addGlyph:function(e,t){Array.isArray(e)?this.glyphs.push(...e):this.glyphs.push(e),t||this.handleGlyphsChanged()},isRouteEnabled:function(){return this.isHereEnabled()||this.getProperty("googleRoutingEnabled")},isIsolineEnabled:function(){return this.getProperty("isolineEnabled")},isHereEnabled:function(){return this.getProperty("hereRoutingEnabled")},handleNewRoute:function(e,t){let i=this.createRouteForm(),s=HU.div([ATTR_CLASS,HU.classes(CLASS_BUTTON_OK,CLASS_DISPLAY_BUTTON)],LABEL_OK)+SPACE2+HU.div([ATTR_CLASS,HU.classes(CLASS_BUTTON_CANCEL,CLASS_DISPLAY_BUTTON)],LABEL_CANCEL);i+=HU.div([ATTR_STYLE,HU.css(CSS_TEXT_ALIGN,ALIGN_RIGHT,CSS_MARGIN_TOP,HU.px(5))],s),i=HU.div([ATTR_STYLE,HU.css(CSS_MARGIN,HU.px(5))],i);let l=HU.makeDialog({content:i,title:"Select Route Type",header:!0,my:POS_LEFT_TOP,at:POS_LEFT_BOTTOM,anchor:this.jq(I)});l.find(HU.dotClass(CLASS_BUTTON_OK)).button().click((()=>{this.routeProvider=this.jq("routeprovider").val(),this.routeType=this.jq("routetype").val(),l.remove(),t?this.createRoute(this.routeProvider,this.routeType,t,{doSequence:!0}):e&&(e.handler.finishedWithRoute=!1,this.showCommandMessage("New Route: "+Utils.makeLabel(this.routeType)+" - Draw one or more line segments"),e.activate())})),l.find(HU.dotClass(CLASS_BUTTON_CANCEL)).button().click((()=>{l.remove()}))},createRouteForm:function(e){let t="";if(this.isRouteEnabled()){t+=HU.formTable();let i=[];this.getProperty("googleRoutingEnabled")&&i.push("google"),this.getProperty("hereRoutingEnabled")&&i.push("here"),t+=HU.formEntryLabel("Provider",HU.select("",[ATTR_ID,this.domId("routeprovider")],i,this.routeProvider)),t+=HU.formEntryLabel("Route Type",HU.select("",[ATTR_ID,this.domId("routetype")],[ROUTE_CAR,ROUTE_BICYCLE,ROUTE_PEDESTRIAN],this.routeType)),e&&this.getProperty("hereRoutingEnabled")&&(t+=HU.formEntry("",HU.checkbox(this.domId("routedosequence"),[],!1,"Calculate best route from locations"))),t+=HU.close(TAG_TABLE)}else t="Routing is not enabled";return t},createRoute:function(e,t,i,s){s=s??{};let l=[];i.forEach((e=>{l.push(Utils.trimDecimals(e.y,6)),l.push(Utils.trimDecimals(e.x,6))}));let a={mode:t??ROUTE_CAR,points:Utils.join(l,","),provider:e};s.doSequence&&(a.dosequence=!0);let r=HU.url(Ramadda.getUrl("/map/getroute"),ARG_ENTRYID,this.getProperty("entryId")),o=()=>{this.makingRoute=!1,this.finishedWithRoute=!1,this.clearMessage2(),this.getMap().clearAllProgress(),this.setCommandCursor()},n=i=>{if(o(),i.errors&&i.errors.length)return void alert("An error occurred:"+i.errors[0]);if(i.error_description)return void alert("An error occurred:"+i.error_description);if(s.line&&this.myLayer.removeFeatures([s.line]),i.error)return void this.handleError(i.error);let l=[],d=[];if(i.results&&i.results.length>0){let e=i.results[0];e.waypoints&&e.waypoints.forEach((e=>{d.push(MapUtils.createPoint(e.lng,e.lat))}))}else if(i.routes&&i.routes.length>0){let e=i.routes[0];if(e.legs&&e.legs.forEach((e=>{l.push(...e.steps.map((e=>({instr:e.html_instructions,lat:e?.start_location.lat,lon:e?.start_location.lng}))))})),e.overview_polyline){googleDecode(e.overview_polyline.points).forEach((e=>{d.push(MapUtils.createPoint(e[1],e[0]))}))}else e.sections.forEach((e=>{hereDecode(e.polyline).polyline.forEach((e=>{d.push(MapUtils.createPoint(e[1],e[0]))})),e.actions&&l.push(...e.actions.map((e=>({instr:e.instruction,loc:e.start_location}))))}))}if(0==d.length)return alert("No routes found"),void this.clearMessage2();if(a.dosequence){a.dosequence=!1;let e=[];return d.forEach((t=>{e.push(Utils.trimDecimals(t.y,6)),e.push(Utils.trimDecimals(t.x,6))})),void $.post(r,a,(e=>{n(e)})).fail(h)}let g=this.getMap().createPolygon("","",d,{strokeWidth:4},null,!0),p=this.getGlyphType(GLYPH_ROUTE);g.style=Utils.clone(p.getStyle()),this.addFeatures([g]);let c=null,u="&#128663;";t==ROUTE_BICYCLE?u="&#128690;":t==ROUTE_PEDESTRIAN&&(u="&#128694;"),e&&(c="Route: "+e+" - "+u),this.handleNewFeature(g,null,{name:c,type:GLYPH_ROUTE,routeProvider:this.routeProvider,routeType:this.routeType,instructions:l}),this.showDistances(g.geometry,GLYPH_ROUTE,!0)},h=e=>{o(),s.line&&this.myLayer.removeFeatures([s.line]),this.clearCommands(),this.handleError(e)};this.finishedWithRoute=!0,this.showProgress("Creating route..."),this.makingRoute=!0,$.post(r,a,(e=>{n(e)})).fail(h)},addIsolineForCurrentMarker(){this.currentLocationMarker&&this.addIsolineAt(this.currentLocationMarker.location)},addIsolineForMarker:function(e){let t=this.getMap().transformProjPoint(e.getCentroid());this.addIsolineAt(t)},addIsolineAt:function(e,t){Utils.isDefined(t)&&"number"==typeof e&&(e={y:e,x:t}),this.getMap().closePopup();let i=HU.formTable();i+=HU.formEntryLabel("Mode",HU.select("",[ATTR_ID,this.domId("isolinemode")],[ROUTE_CAR,ROUTE_BICYCLE,ROUTE_PEDESTRIAN],this.isolineMode)),i+=HU.formEntryLabel("Range",HU.input("",this.isolineValue??10,[ATTR_ID,this.domId("isolinevalue"),ATTR_SIZE,5])+HU.space(2)+HU.select("",[ATTR_ID,this.domId("isolinetype")],[{label:"Time (minutes)",value:"time"},{label:"Distance (miles)",value:"distance"}],this.isolineType)),i+=HU.formTableClose();let s=HU.div([ATTR_CLASS,HU.classes(CLASS_BUTTON_OK,CLASS_DISPLAY_BUTTON)],LABEL_OK)+SPACE2+HU.div([ATTR_CLASS,HU.classes(CLASS_BUTTON_CANCEL,CLASS_DISPLAY_BUTTON)],LABEL_CANCEL);i+=HU.div([ATTR_STYLE,HU.css(CSS_TEXT_ALIGN,ALIGN_RIGHT,CSS_MARGIN_TOP,HU.px(5))],s),i=HU.div([ATTR_STYLE,HU.css(CSS_MARGIN,HU.px(5))],i);let l=HU.makeDialog({content:i,title:"Select Isoline Type",draggable:!0,header:!0,my:POS_LEFT_TOP,at:POS_LEFT_BOTTOM,anchor:this.jq(I)});l.find(HU.dotClass(CLASS_BUTTON_OK)).button().click((()=>{this.isolineMode=this.jq("isolinemode").val(),this.isolineValue=this.jq("isolinevalue").val(),this.isolineType=this.jq("isolinetype").val(),l.remove(),this.createIsoline(this.isolineMode,this.isolineValue,this.isolineType,Utils.getDefined(e.y,e.lat),Utils.getDefined(e.x,e.lon),{})})),l.find(HU.dotClass(CLASS_BUTTON_CANCEL)).button().click((()=>{l.remove()}))},createIsoline:function(e,t,i,s,l,a){a=a??{};let r,o=t;"time"==i?(t=60*parseFloat(t),r="minutes"):(t=parseInt(1609.34*parseFloat(t)),r="miles");let n=HU.url(Ramadda.getUrl("/map/getisoline"),ARG_ENTRYID,this.getProperty("entryId")),h={mode:e??ROUTE_CAR,latitude:s,longitude:l,rangetype:i,rangevalue:t},d=()=>{this.clearMessage2(),this.getMap().clearAllProgress(),this.setCommandCursor()},g=t=>{if(d(),400==t.status)return void alert("An error occurred:"+t.cause);if(t.errors&&t.errors.length)return void alert("An error occurred:"+t.errors[0]);if(t.error_description)return void alert("An error occurred:"+t.error_description);if(t.error)return void this.handleError(t.error);if(!t.isolines||!t.isolines[0])return void alert("No isolines found");let i=hereDecode(t.isolines[0].polygons[0].outer).polyline;if(!i||0==i.length)return alert("No isolines found"),void this.clearMessage2();let s=[];i.forEach((e=>{s.push(MapUtils.createPoint(e[1],e[0]))}));let l=this.getMap().createPolygon("","",s,{strokeWidth:4},null,!1),a=this.getGlyphType(GLYPH_ISOLINE);l.style=Utils.clone(a.getStyle()),this.addFeatures([l]);let n="Isoline: "+e,h="/icons/"+e+".png";this.handleNewFeature(l,null,{name:n,icon:Ramadda.getUrl(h),type:GLYPH_ISOLINE,legendText:"Mode: "+e+"\nRange: "+o+" "+r}),this.showDistances(l.geometry,GLYPH_ISOLINE,!0)};this.finishedWithRoute=!0,this.showProgress("Creating isoline..."),this.makingRoute=!0,$.post(n,h,(e=>{g(e)})).fail((e=>{d(),a.line&&this.myLayer.removeFeatures([a.line]),this.clearCommands(),this.handleError(e)}))},handleEvent:function(e,t){},handleKeyUp:function(e){return"Shift"==e.key&&(this.getSelected().forEach((e=>{e.isImage()&&e.getImage()&&e.getImage().setOpacity(1)})),!0)},handleKeyDown:function(e){return"Shift"==e.key&&(this.getSelected().forEach((e=>{e.isImage()&&e.getImage()&&e.getImage().setOpacity(.3)})),!0)},handleNewFeature:function(e,t,i,s){t=Utils.clone({},t??e?.style??{}),i=Utils.clone({},i??e?.mapOptions??t?.mapOptions),delete t.mapOptions,e?.style?.mapOptions&&delete e.style.mapOptions;let l=new MapGlyph(this,i.type,i,e,t),a=this.getSelected();if(a.length>0&&a[0].isGroup()?(a[0].addChildGlyph(l),this.makeLegend()):this.addGlyph(l),l.glyphCreated(),this.clearMessage2(1e3),s){let e=()=>{l.panMapToPending=!0};setTimeout((()=>{l.panMapTo(!1,e)}),100)}return l},handleGlyphsChanged:function(){this.makeLegend(),this.addFeatureList(),this.featureChanged()},getLayer:function(){return this.myLayer},redraw:function(e){ImdvUtils.scheduleRedraw(this.myLayer,e)},getNewFeature:function(){return this.myLayer.features[this.myLayer.features.length-1]},clearAddresses:function(){this.addresses&&(this.addresses.forEach((e=>{this.removeFeatures(e.getFeatures())})),this.addresses=null)},gotoAddress:function(e,t){let i=HU.url(Ramadda.getUrl("/geocode"),"query",t),s=(e,t)=>{null==this.addresses&&(this.addresses=[]);MapUtils.createLonLat(e.longitude,e.latitude);let i="",s=-10;if(t)i=e.name;else{let t=Utils.split(e.name,",",!0,!0);for(let e=0;e<t.length;e++)i+=t[e]+"\n",s-=6}s=-12,i=i.trim();let l={label:i,fontSize:"9pt",labelYOffset:s,labelAlign:"ct",pointRadius:12},a=HU.isChecked(this.jq(y)),r=[e.latitude,e.longitude];l.externalGraphic=Ramadda.getCdnUrl(a?"/icons/map/marker-blue.png":"/icons/map/marker.png");let o=this.createMapMarker(GLYPH_MARKER,{type:GLYPH_MARKER,name:e.name},l,r,a);a||this.addresses.push(o),o.panMapTo()};if((t=String(t).trim()).match(/^\s*[+-]?\d+(\.\d+)?\s*,\s*[+-]?\d+(\.\d+)?\s*$/)){let e=t.split(",");if(2==e.length)return void s({latitude:+e[0],longitude:+e[1],name:t},!0)}let l=()=>{e.css(CSS_BACKGROUND,COLOR_WHITE),this.jq(T).html("")};e.css(CSS_BACKGROUND,"#eee"),this.jq(T).html(HU.getIconImage(icon_wait));$.getJSON(i,(t=>{if(l(),0!=t.result.length)if(1==t.result.length)s(t.result[0]);else{let i="";t.result.forEach(((e,t)=>{i+=HU.div([ATTR_INDEX,t,ATTR_CLASS,HU.classes(CLASS_CLICKABLE,CLASS_MENU_ITEM)],e.name)})),i=HU.div([ATTR_STYLE,HU.css(CSS_MAX_HEIGHT,HU.px(200),CSS_OVERFLOW_Y,OVERFLOW_AUTO)],i);let l=HU.makeDialog({content:i,header:!1,anchor:e,my:POS_LEFT_TOP,at:POS_LEFT_BOTTOM});l.find(HU.dotClass(CLASS_MENU_ITEM)).click((function(){let e=t.result[$(this).attr(ATTR_INDEX)];l.remove(),s(e)}))}else wait.html("Nothing found")})).fail((e=>{l(),window.alert("Failed to find address")}))},makeRangeRings:function(e,t,i,s,l,r){""==s&&(s=NaN);let o=[],n={labelAlign:(i=i??{}).labelAlign??"lt",fontSize:i.fontSize??HU.pt(10),fontColor:i.fontColor??COLOR_BLACK};for(a in i)(a.indexOf("label")>=0||a.indexOf("font")>=0||a.indexOf("textBackground")>=0)&&(n[a]=i[a]);for(let a=t.length-1;a>=0;a--){let h=t[a];if(null==h)continue;let d=String(h).trim();d.endsWith(UNIT_MILES)?h=1.60934*parseFloat(d.replace(UNIT_MILES,"")):d.endsWith(UNIT_NM)?h=1.852*parseFloat(d.replace(UNIT_NM,"")):d.endsWith(UNIT_FT)?h=3048e-7*parseFloat(d.replace(UNIT_FT,"")):d.endsWith(UNIT_KM)?h=d.replace(UNIT_KM,""):d.endsWith(UNIT_M)&&(h=parseFloat(d.replace(UNIT_M,""))/1e3);let g=MapUtils.createLonLat(e.lon??e.x,e.lat??e.y),p=Utils.reverseBearing(g,Utils.isDefined(s)&&!isNaN(s)?s:135,h);if(null==p)return console.error("Could not create range rings with center:",e,p,h),null;g=this.getMap().transformLLPoint(g),p=this.getMap().transformLLPoint(p);let c=Utils.distance(g.lon,g.lat,p.lon,p.lat),u=OpenLayers.Geometry.Polygon.createRegularPolygon({x:g.lon,y:g.lat},c,100,0),T=$.extend({},i??{strokeWidth:2,strokeColor:"blue",fillColor:COLOR_TRANSPARENT});l["*"]&&$.extend(T,l["*"]),a==2*parseInt(a/2)?l.even&&$.extend(T,l.even):l.odd&&$.extend(T,l.odd),l&&l[a+1]&&$.extend(T,l[a+1]),a==t.length-1&&l.N&&$.extend(T,l.N),o.push(MapUtils.createVector(u,null,T)),p=MapUtils.createPoint(p.lon,p.lat);let f=$.extend({},n);isNaN(s)||(r&&a<r.length?f.label=r[a].replace("${d}",d):f.label=d);let y=MapUtils.createVector(p,null,f);o.push(y)}return o},showDistances:function(e,t,i){let s=this.getDistances(e,t);Utils.stringDefined(s)&&this.showMessage2(s,i)},getLatLonPoints:function(e){let t=e.components;if(null==t){if(e.x&&e.y){let t=MapUtils.createPoint(e.x,e.y);return t=this.getMap().transformProjPoint(t),[t]}return null}return t.length&&t[0].components&&(t=t[0].components),t.map((e=>this.getMap().transformProjPoint(e)))},getDistances:function(e,t,i,s,l){if(!e)return null;let a=this.getLatLonPoints(e);if(null==a)return null;MapUtils.squareMetersToSquareFeet(e.getArea());let r,o=-1;if(!t)return"";let n="Distance: ";t!=GLYPH_CIRCLE&&t!=GLYPH_BOX&&t!=GLYPH_POLYGON&&t!=GLYPH_TRIANGLE&&t!=GLYPH_FREEHAND_CLOSED&&t!=GLYPH_IMAGE||(o=MapUtils.calculateArea(a),r=o/43560),t!=GLYPH_CIRCLE&&t!=GLYPH_BOX&&t!=GLYPH_TRIANGLE&&t!=GLYPH_IMAGE||(n="Perimeter: ");let h=0,d="Distance: ";if(t==GLYPH_BOX||t==GLYPH_IMAGE){d="";let e=MapUtils.distance(a[0].y,a[0].x,a[1].y,a[1].x),t=MapUtils.distance(a[1].y,a[1].x,a[2].y,a[2].x);h=2*e+2*t;let i=UNIT_FT;(e>5280||t>5280)&&(i=UNIT_MILES,e/=5280,t/=5280),d="W: "+Utils.formatNumberComma(e,1)+" "+i+" H: "+Utils.formatNumberComma(t,1)+" "+i}else{let e="",t=0;for(let i=0;i<a.length-1;i++){let s=a[i],l=a[i+1],r=MapUtils.distance(s.y,s.x,l.y,l.x);isNaN(r)||(h+=r),t+=r;let o=UNIT_FT;r>5280&&(o=UNIT_MILES,r/=5280),r=Utils.formatNumberComma(r),e+=r+" "+o+" "}let i=UNIT_FT;t>3500&&(i=UNIT_MILES,t/=5280),d=n+Utils.formatNumberComma(t)+" "+i,a.length>2&&a.length,a.length<=1&&(d="")}return l?{feet:h,sqfeet:o,sqmiles:o/MapUtils.squareFeetInASquareMile,acres:r}:(!i&&o>0&&(unit=UNIT_FT,o>MapUtils.squareFeetInASquareMile?(unit=UNIT_MILES,o/=MapUtils.squareFeetInASquareMile,d+=HU.br()+"Area: "+Utils.formatNumber(o)+" sq "+unit,s&&(d+=SPACE+Utils.formatNumber(r)+" acres")):d+=HU.br()+"Area: "+Utils.formatNumber(r)+" acres"),d)},setCommandCursor:function(e){this.getMap().setCursor(e??CURSOR_POINTER)},wrapDialog:function(e){return HU.div([ATTR_STYLE,HU.css(CSS_MARGIN,HU.px(5))],e)},setCommand:function(e,t){t=t??{},this.clearCommands(),t.newGlyph||e==G||e==V||this.unselectAll(),this.command=e;let i=this.getGlyphType(e);this.commands.forEach((e=>{e.deactivate()})),e&&(this.jq("new_"+e).addClass("imdv-command-active"),this.commands.every((s=>s.name!=e||(i?(this.initGlyphCommand(i,s,t),!1):(this.showCommandMessage(s.message),s.activate(),!1)))))},initGlyphCommand:function(e,t,i){if(e.isOSM())return void this.initOSMSearch();i=i??{},this.setCommandCursor();let s=MapUtils.createStyleMap({default:{}}),l=Utils.clone({},e.getStyle()),a=l.mapOptions={type:e.type};if(e.isZoom()||e.isFixed()||e.isGroup()){let t=i.text;if(t||(t=prompt(e.isZoom()?"Enter viewpoint label":e.isFixed()?"Text:":"Name:")),!t)return;let s=Utils.clone({},l),r=Utils.clone({},a);s.text=t,e.isGroup()&&(s.externalGraphic=e.getIcon(),r.name=t),this.clearCommands(),e.isZoom()&&(r.name=t,delete s.text,this.setZoomOptions(r));let o=new MapGlyph(this,r.type,r,null,s);return this.addGlyph(o),this.clearMessage2(1e3),this.clearCommands(),e.isFixed()&&o.addFixed(),o}if(e.isMapServer()){if(this.mapServerDialog)return void this.mapServerDialog.show();let e="";e+=HU.br(),e+=HU.br()+"Or enter either a TMS/WMS server URL with a layer name:";let t=(t,i,s)=>{e+=HU.formEntryLabel(t,HU.input("",this.cache[i]??"",[ATTR_ID,this.domId(i),ATTR_SIZE,s??60]))},i=[["Name","servername"],["Server URL","serverurl"],["WMS Layer","wmslayer","20"],["Legend URL","maplegend"]];this.cache=this.cache??{},e+=HU.formTable(),i.forEach((e=>{t(e[0],e[1],e[2])})),e+=HU.close(TAG_TABLE),e+=HU.br()+"Or enter Tile JSON URL:",e+=HU.formTable(),t("Tile JSON","tilejson",60),e+=HU.close(TAG_TABLE);let s=[],r=Utils.mergeLists([{value:"",label:"Select"}],RAMADDA_MAP_LAYERS.map((e=>[e.id,e.name]))),o="Pre-defined layer: "+HU.select("",[ATTR_ID,this.domId("predefined")],r,this.cache.predefined);o+=e,o+=HU.buttons([HU.div([ATTR_CLASS,HU.classes(CLASS_BUTTON_OK,CLASS_DISPLAY_BUTTON)],LABEL_OK),HU.div([ATTR_CLASS,HU.classes(CLASS_BUTTON_CANCEL,CLASS_DISPLAY_BUTTON)],LABEL_CANCEL)]),s.push({label:"WMS/WMTS",contents:o});let n,h=!1;if(h){let e=HU.div([ATTR_ID,this.domId("stac_contents")]);s.push({label:"STAC",contents:e}),n=HU.makeTabs(s),o=HU.div([ATTR_STYLE,HU.css(CSS_MIN_WIDTH,HU.px(600),CSS_MIN_HEIGHT,HU.px(400),CSS_MARGIN,HU.px(10))],n.contents)}else{let e=HU.div([],HU.b(s[0].label))+s[0].contents;o=HU.div([ATTR_STYLE,HU.css(CSS_MIN_WIDTH,HU.px(600),CSS_MIN_HEIGHT,HU.px(400),CSS_MARGIN,HU.px(10))],e)}let d=this.mapServerDialog=HU.makeDialog({remove:!1,content:o,title:"Map Server",header:!0,my:POS_LEFT_TOP,at:POS_LEFT_BOTTOM,draggable:!0,anchor:this.jq(I)});d.remove=()=>{d.hide()},h&&n.init(),this.initStac(d);let g=e=>{e=e??{};let t=Utils.clone({},l),i=Utils.clone({},a);i.bounds=e.bounds,i.name=e.name,i.legendText=e.legendText,this.clearCommands();let s=new MapGlyph(this,i.type,i,null,t);s.setMapServerUrl(e.url,e.layerName,e.legendUrl,this.jq("predefined").val()),s.checkMapServer(),this.addGlyph(s),this.clearMessage2(1e3),d.remove(),s.hasBounds()&&s.panMapTo()},p=()=>{i.forEach((e=>{this.cache[e[1]]=this.jq(e[1]).val().trim()}));let e=this.jq("predefined").val().trim(),t=this.jq("tilejson").val();if(Utils.stringDefined(t))return void $.getJSON(t,(e=>{let t={name:e.name,url:e.tiles[0]};e.attribution&&e.attribution_link&&(t.legendText=HU.href(e.attribution_link,"Courtesy: "+e.attribution,[ATTR_TARGET,"_other"])),e.bounds&&(t.bounds=e.bounds),g(t)})).fail((e=>{window.alert("Failed to find address")}));let s=this.jq("serverurl").val();Utils.stringDefined(s)||Utils.stringDefined(e)?g({name:this.jq("servername").val(),url:s,layerName:this.jq("wmslayer").val(),legendUrl:this.jq("maplegend").val()}):alert("Please enter a map server")};return d.find(HU.dotClass(CLASS_BUTTON_OK)).button().click(p),void d.find(HU.dotClass(CLASS_BUTTON_CANCEL)).button().click((()=>{d.hide()}))}if(e.requiresEntry()){let r=(i,r,o)=>{getGlobalRamadda().getEntry(i,(e=>{}));let n,h={};"string"==typeof r?(n=r,this.lastImageUrl=n):h=r;let d=Utils.clone({},a);h.entryId=i;let g=Utils.clone({},l);if(e.isMultiEntry()&&(g.externalGraphic=h.icon??e.getIcon()),e.isImage()?(g.strokeColor=COLOR_LIGHT_GRAY,g.fillColor=COLOR_TRANSPARENT):$.extend(d,h),d.entryId=i,d.entryType=h.entryType,d.thumbnailUrl=h.thumbnailUrl,h.name=h.name??Utils.makeLabel(h.entryName),delete h.entryName,e.isMap()){if(o){let e=MapUtils.MAP_RESOURCES_MAP[o];h.name=Utils.makeLabel(e.name),h.entryType=e.type,h.resourceUrl=e.url,e.style&&$.extend(g,e.style)}return $.extend(d,h),"type_wmts_layer"==d.entryType?void this.loadWmtsEntry(h):"type_wms_layer"==d.entryType?void this.loadWmsEntry(h):void getRamadda().getEntry(h.entryId,(e=>{let t=e.getSnippet();t&&(d.legendText=t.trim()),this.handleNewFeature(null,g,d,!0).checkMapLayer(!0)}))}if(h.name&&!e.isImage()&&(g.label=h.name),e.isMultiEntry()){return this.clearCommands(),d.name=d.entryName??h.entryName,delete d.icon,delete d.entryName,this.handleNewFeature(null,g,d).addEntries(!0),void this.clearCommands()}if(e.isData())return this.clearCommands(),d.name=d.entryName??h.entryName,delete d.entryName,this.createData(d),void this.clearCommands();let p=e=>Utils.isDefined(e)&&!isNaN(e);if(e.isImage()&&p(h.north)&&p(h.west)&&p(h.south)&&p(h.east)){g.strokeColor=COLOR_TRANSPARENT;let e=this.makeFeature(this.getMap(),"OpenLayers.Geometry.Polygon",g,[h.north,h.west,h.north,h.east,h.south,h.east,h.south,h.west]);h.type=GLYPH_IMAGE;let t=h.entry;if(n=t?t.getIsEntryImage()?HU.url(Ramadda.getUrl(URL_ENTRY_GET),ARG_ENTRYID,t.getId()):t.getThumbnail():h.isImage?HU.url(Ramadda.getUrl(URL_ENTRY_GET),ARG_ENTRYID,i):h.thumbnailUrl,!n)return void alert("Selected entry does not have an image");g.imageUrl=n;let s=new MapGlyph(this,GLYPH_IMAGE,h,e,g);return s.checkImage(e),this.addGlyph(s),void s.panMapTo()}if(e.isEntry()&&(Utils.isDefined(h.latitude)||Utils.isDefined(h.north))&&confirm("Do you want to use this entry's location?")){g=$.extend({},g),g.externalGraphic=h.icon,d.useentrylocation=!0,d.name=h.name;let e=Utils.isDefined(h.latitude)?[h.latitude,h.longitude]:[h.north,h.west],t=this.createMapMarker(GLYPH_ENTRY,d,g,e,!0);return t.applyDataIcon(),this.clearCommands(),void t.panMapTo()}if(e.isImage()){let e=n??h.url;if(!e)if(h.isImage)e=HU.url(Ramadda.getUrl(URL_ENTRY_GET),ARG_ENTRYID,i);else if(e=h.thumbnailUrl,!e)return void alert("Selected entry does not have an image");g.imageUrl=e}else h.icon&&(g.externalGraphic=h.icon);d.entryId=i,d.name=h.name,t.handler.style=g,g.mapOptions=Utils.clone({},d),t.handler.layerOptions.styleMap=s,this.showCommandMessage(e.isImage()?"Click and drag to create image":"New Entry Marker"),t.activate(),this.selector&&this.selector.cancel(!0)};if(i.url)return void(i.entryId?r(i.entryId,i):r(null,i.url));let o=()=>{HU.makeSelectTagPopup("#"+this.domId(ID_MAPRESOURCE),{after:!0,icon:!0,single:!0}),this.jq(ID_MAPRESOURCE).change((()=>{r("",{},this.jq(ID_MAPRESOURCE).val()),this.selector&&this.selector.cancel()})),this.jq("imageurl").keypress((function(e){13==e.keyCode&&r("",$(this).val())}))},n=null;if(e.isImage())n=HU.b("Enter Image URL: ")+HU.input("",this.lastImageUrl??"",[ATTR_ID,this.getDomId("imageurl"),ATTR_SIZE,40]);else if(e.isMap()&&MapUtils.MAP_RESOURCES){let e=MapUtils.MAP_RESOURCES.map(((e,t)=>[t,e.name]));e=Utils.mergeLists([["","Select Resource"]],e),n=HU.b("Load Map: ")+HU.select("",[ATTR_ID,this.domId(ID_MAPRESOURCE)],e)}null!=n&&(n=this.wrapDialog(n)+HU.div([ATTR_STYLE,HU.css(CSS_MARGIN_LEFT,HU.px(5))],HU.boldLabel("Or select entry")));let h={title:e.isImage()?"Select Image":e.isEntry()||e.isMultiEntry()?"Select Entry":e.isData()?"Select Data":"Select Map Entry",extra:n,initCallback:o,callback:r,eventSourceId:this.domId(I)},d=e.isImage()?"type_image,type_document_pdf,geo_gdal,latlonimage":e.isMap()?Utils.join(MAP_TYPES,","):"";return h.typeLabel=e.isImage()?"Images":e.isMap()?"Maps":"",h.showTypeSelector=!0,void(this.selector=RamaddaUtils.selectCreate(null,HU.getUniqueId(""),"",!1,"entryid",this.getProperty("entryId"),d,null,h))}if(e.getType()==GLYPH_MARKER){let e=HU.textarea("",this.lastText??"",[ATTR_ID,this.domId("labeltext"),ATTR_ROWS,3,ATTR_COLS,40]),i=HU.formTable();i+=HU.formEntryTopLabel("Label",e);let r="externalGraphic",o=this.lastIcon||l.externalGraphic,n=this.domId(r+"_image"),h=HU.image(o,[ATTR_ID,n])+HU.hidden("",o,[ATTR_ID,this.domId(r)]);Utils.isDefined(this.lastIncludeIcon)||(this.lastIncludeIcon=!0),i+=HU.formEntry("",HU.checkbox(this.domId("includeicon"),[],this.lastIncludeIcon,"Include Icon")+" "+h),i+=HU.close(TAG_TABLE),i+=HU.div([ATTR_STYLE,HU.css(CSS_TEXT_ALIGN,ALIGN_CENTER,CSS_PADDING_BOTTOM,HU.px(8),CSS_MARGIN_BOTTOM,HU.px(8),CSS_BORDER_BOTTOM,HU.border(1,COLOR_LIGHT_GRAY))],HU.div([ATTR_CLASS,HU.classes(CLASS_BUTTON_OK,CLASS_DISPLAY_BUTTON)],LABEL_OK)+SPACE2+HU.div([ATTR_CLASS,HU.classes(CLASS_BUTTON_CANCEL,CLASS_DISPLAY_BUTTON)],LABEL_CANCEL)),i+=HU.center(HU.b("Select Icon")),i+=HU.div([ATTR_ID,this.domId("recenticons")]),i+=HU.div([ATTR_ID,this.domId("icons"),"icon-property",r]),i=HU.div([ATTR_STYLE,HU.css(CSS_MARGIN,HU.px(5))],i);let d=HU.makeDialog({content:i,title:"Marker",header:!0,my:POS_LEFT_TOP,at:POS_LEFT_BOTTOM,draggable:!0,anchor:this.jq(I)}),g=()=>{d.remove()};this.initIconSelection(this.jq("icons"));let p=()=>{let e=Utils.clone({},l);e.mapOptions=Utils.clone({},a),(this.lastIncludeIcon=HU.isChecked(this.jq("includeicon")))?(this.lastIcon=this.jq("externalGraphic").val(),e.externalGraphic=this.lastIcon,e.labelAlign="cb",e.labelYOffset="12"):e.externalGraphic=icon_blank;let i=this.jq("labeltext").val();g(),this.lastText=i,e.label=i,t.handler.style=e,t.handler.layerOptions.styleMap=s,this.showCommandMessage("New Marker"),t.activate()};return d.find(HU.dotClass(CLASS_BUTTON_OK)).button().click(p),void d.find(HU.dotClass(CLASS_BUTTON_CANCEL)).button().click((()=>{g()}))}t.handler.style=Utils.clone({},l),t.handler.layerOptions.styleMap=s;e?e.getName():t.message;e.isRoute()?this.handleNewRoute(t):(this.showCommandMessage("New "+e.getName()+(e.getNewHelp()?" - "+e.getNewHelp():"")),t.activate())},loadWmtsEntry:function(e){getRamadda().getEntry(e.entryId,(e=>{let t=this.getGlyphType(GLYPH_MAPSERVER),i=Utils.clone({},t.getStyle()),s={name:e.getName(),type:GLYPH_MAPSERVER},l=e.getSnippet();l&&(s.legendText=l.trim());let a=new MapGlyph(this,GLYPH_MAPSERVER,s,null,i);a.setMapServerUrl(e.url,null,e.getThumbnail(),null),a.checkMapServer(),this.addGlyph(a)}))},loadWmsEntry:function(e){getRamadda().getEntry(e.entryId,(e=>{let t=e.getAttribute("base_url"),i=e.getAttribute("layer_name");if(!Utils.stringDefined(t?.value)||!Utils.stringDefined(i?.value))return void alert("No url or layer defined");let s=this.getGlyphType(GLYPH_MAPSERVER),l=Utils.clone({},s.getStyle()),a={name:e.getName(),type:GLYPH_MAPSERVER},r=e.getSnippet();r&&(a.legendText=r.trim());let o=new MapGlyph(this,GLYPH_MAPSERVER,a,null,l);o.setMapServerUrl(t.value,i.value,e.getThumbnail(),null),o.checkMapServer(),this.addGlyph(o)}))},setZoomOptions:function(e){e.zoomLevel=this.getCurrentLevel(),e.mapCenter=this.getMap().getMapCenterLatLon()},setOSMLabel:function(e,t){this.jq(ID_OSM_LABEL).html(e),this.jq(ID_OSM_LABEL).show(),t&&setTimeout((()=>{this.jq(ID_OSM_LABEL).fadeOut(500)}),1500)},initOSMSearch:function(){if(this.osm||(this.osm={markers:[],ids:{}}),this.osm.dialog)return;let e=e=>e.map((e=>[e,Utils.makeLabel(e)])),t=e(["city","town","village","hamlet","island","suburb","locality"]),i=e(["hotel","motel","guest_house","alpine_hut","apartment","artwork","attraction","camp_site","caravan_site","chalet","gallery","heritage","hostel","information","museum","picnic_site","theme_park","viewpoint","wilderness_hut","zoo"]),s=e(["supermarket","convenience","bakery","butcher","clothes","electronics","hardware","books","car","bicycle","sports","shoes"]),l=e(["bar","bbq","bicycle_parking","bicycle_rental","biergarten","bus_station","cafe","car_rental","car_sharing","car_wash","charging_station","cinema","clinic","college","community_centre","courthouse","dentist","doctors","drinking_water","fast_food","ferry_terminal","fire_station","food_court","fountain","fuel","gym","hospital","ice_cream","kindergarten","library","marketplace","monastery","nightclub","nursing_home","park","parking","pharmacy","place_of_worship","police","post_box","post_office","prison","public_bath","pub","recycling","restaurant","school","shelter","taxi","theatre","toilets","townhall","university","veterinary","waste_basket","waste_disposal","water_point"]),a="";a+=HU.formTable();this.getMap().getBounds();a+=HU.formEntryLabel("Text",HU.input("",this.osm.text??"",[ATTR_ID,this.domId(ID_OSM_TEXT)]));let r=[],o=(e,t,i)=>{r.push(HU.boldLabel(t)+HU.br()+HU.select("",[ATTR_STYLE,HU.css(CSS_MIN_WIDTH,HU.px(200)),ATTR_ID,this.domId("osm"+e),ATTR_MULTIPLE,!0,ATTR_SIZE,3],i,null))};o("tourism","Tourism",i),o("place","Place",t),o("shop","Shop",s),o("amenity","Amenity",l),a+=HU.formTableClose(),a+=HU.formTable();for(let e=0;e<r.length;e+=2)a+=HU.tr([],HU.tds([],[r[e],r[e+1]]));a+=HU.formTableClose(),a+=HU.formTable(),a+=HU.formEntryLabel("Limit",HU.input("",this.osm.limit??"100",[ATTR_ID,this.domId("osmlimit"),ATTR_SIZE,10])),a+=HU.formTableClose();let n=Utils.join([HU.div([ATTR_CLASS,HU.classes(CLASS_BUTTON_OK,CLASS_BUTTON)],LABEL_SEARCH),HU.div([ATTR_CLASS,HU.classes("ramadda-button-clear",CLASS_BUTTON)],"Clear Markers"),HU.div([ATTR_CLASS,HU.classes("ramadda-button-add",CLASS_BUTTON),ATTR_TITLE,"Add markers as glyphs"],"Add"),HU.div([ATTR_CLASS,HU.classes(CLASS_BUTTON_CANCEL,CLASS_BUTTON)],"Close")],SPACE1);a+=HU.vspace(),a+=HU.center(n),a+=HU.div([ATTR_STYLE,HU.css(CSS_MIN_WIDTH,HU.px(150))],SPACE+HU.span([ATTR_ID,this.domId(ID_OSM_LABEL)],SPACE)),a=HU.div([ATTR_CLASS,CLASS_DIALOG],a),this.osm.dialog=HU.makeDialog({content:a,anchor:this.jq(I),callback:()=>{this.osm.dialog=null},draggable:!0,title:"OpenStreetMap Query",header:!0});let h=this;this.jq(ID_OSM_TEXT).keydown((e=>{Utils.isReturnKey(e)&&this.doOSMSearch()})),this.osm.dialog.find(HU.dotClass(CLASS_BUTTON_CANCEL)).button().click((function(){h.osm.dialog.remove(),h.osm.dialog=null})),this.osm.dialog.find(".ramadda-button-add").button().click((()=>{this.addOSMMarkers()})),this.osm.dialog.find(".ramadda-button-clear").button().click((()=>{this.clearOSMMarkers()})),this.osm.dialog.find(HU.dotClass(CLASS_BUTTON_OK)).button().click((()=>{this.doOSMSearch()}))},doOSMSearch:function(){let e=this.getMap().getBounds(),t="("+Utils.join([e.bottom,e.left,e.top,e.right],",")+")",i="[out:json];(\n",s=[],l=e=>{let t=this.osm[e]=this.jq("osm"+e).val();"string"==typeof t&&(t=[t]),t.forEach((t=>{"---"!=t&&s.push('["'+e+'"="'+t+'"]')}))};l("tourism"),l("place"),l("shop"),l("amenity");let a=this.osm.text=this.jq(ID_OSM_TEXT).val();if(Utils.stringDefined(a)&&s.push('["name"~"'+a+'", i]'),0==s.length)return void alert("Please select a search criteria");s.forEach((e=>{i+="node"+e+t+";\n"})),i+=");\nout body;",console.log("osm query:",i),this.setOSMLabel(HU.image(icon_progress)+SPACE2+"Searching...");$.post("https://overpass-api.de/api/interpreter",{data:i},(e=>{if(!e.elements?.length)return void this.setOSMLabel("No locations found",!0);let t=this.osm.limit=this.jq("osmlimit").val()??"500";this.handleOSMResults(e,t),this.setOSMLabel("Found "+e.elements.length+" locations",!0)})).fail((e=>{console.error("Error fetching data:",e);let t="An error has occurred.";e.statusText&&(t+=" Error:"+e.statusText),this.setOSMLabel(t)}))},clearOSMMarkers:function(){this.osm.markers.forEach((e=>{this.getMap().removeMarker(e.marker)})),this.osm.markers=[],this.osm.ids={}},addOSMMarkers:function(){let e=this.initGlyphCommand(this.groupGlyphType,null,{text:"OSM Group"});this.osm.markers.forEach((t=>{let i=[t.latitude,t.longitude],s=$.extend({},this.markerGlyphType.glyphStyle);s.label=t.name??"",s.popupText=t.text;let l=this.createMapMarker(GLYPH_MARKER,{type:GLYPH_MARKER,name:t.name,legendText:t.text},s,i,!0);e.addChildGlyph(l)})),this.clearOSMMarkers(),this.makeLegend()},handleOSMResults:function(e,t){t=+t;let i=0,s=new RamaddaBounds;e.elements.every(((e,l)=>{if(l>=t)return!1;if(this.osm.ids[e.id])return!0;this.osm.ids[e.id]=!0;let a=MapUtils.createLonLat(e.lon,e.lat),r=null,o=HU.open(TAG_TABLE);e.tags&&Object.keys(e.tags).forEach((t=>{let i=e.tags[t];if("name"==t)return void(r=i);i=String(i),i.startsWith("http")&&(i=HU.href(i,i));let s=t;s.startsWith("addr:")&&(s=s.substring("addr:".length)),s=Utils.makeLabel(s),o+=HU.formEntryLabel(s,i)})),o+=HU.close(TAG_TABLE),r&&(o=HU.center(HU.b(r))+o);let n=this.getMap().addMarker("location",a,null,"",o,20,20);return i++,s.expand(e.lat,e.lon),this.osm.markers.push({latitude:e.lat,longitude:e.lon,marker:n,name:r??"",text:o,data:e}),!0})),i>0&&this.getMap().setViewToBounds(s)},initStac:function(e){let t,i=HU.div([ATTR_ID,this.domId("stac_top")])+HU.div([ATTR_ID,this.domId("stac_output")]);this.jq("stac_contents").html(i);let s=Ramadda.getUrl("/resources/stac_catalogs.json"),l=[{value:"",label:"Select"},{value:s,label:"Stac Catalogs"},{value:Ramadda.getUrl("/resources/pc_catalog.json"),label:"Planet Earth Catalogs"}],a={};a[s]=!0;let r=e=>{this.jq("stac_input").val();let i=HU.span([ATTR_ID,this.domId("stac_add"),ATTR_CLASS,CLASS_CLICKABLE,ATTR_TITLE,"Add a STAC catalog URL"],HU.getIconImage("fas fa-plus")),s=HU.span([ATTR_ID,this.domId("stac_back"),ATTR_CLASS,CLASS_CLICKABLE,ATTR_TITLE,"Go back"],HU.getIconImage("fas fa-rotate-left"))+" "+i+" "+HU.select("",[ATTR_STYLE,HU.css(CSS_MAX_WIDTH,HU.px(500),CSS_OVERFLOW_X,OVERFLOW_NONE),ATTR_ID,this.domId("stac_url")],l,e,100);s=HU.div([ATTR_STYLE,HU.css(CSS_BORDER_BOTTOM,HU.border(1,"#ddd"),CSS_PADDING_BOTTOM,HU.px(6),CSS_MARGIN_BOTTOM,HU.px(6))],s),this.jq("stac_top").html(s),this.jq("stac_url").change((()=>{let e=this.jq("stac_url").val();Utils.stringDefined(e)&&t(e)})),this.jq("stac_input").keypress((e=>{if(13==e.which){let e=this.jq("stac_input").val();if(!Utils.stringDefined(e))return;t(e)}})),this.jq("stac_back").click((()=>{if(!this.currentStacUrl)return;let e=l.findIndex((e=>e.value==this.currentStacUrl));e>0&&t(l[e-1].value)})),this.jq("stac_add").click((function(){let e=HU.href("https://stacindex.org/catalogs",HU.getIconImage("fas fa-binoculars"),[ATTR_TARGET,"_stacindex",ATTR_TITLE,"Look for catatalogs on stacindex.org"]),i=HU.input("","",[ATTR_ID,o.domId("stac_add_url"),ATTR_STYLE,HU.css(CSS_WIDTH,HU.px(400))])+" "+e,s=HU.b("STAC  Catalog URL: ")+i;s+=HU.buttons([HU.div([ATTR_CLASS,"stac-add-ok display-button"],LABEL_OK),HU.div([ATTR_CLASS,"stac-add-cancel display-button"],LABEL_CANCEL)]),s=HU.div([ATTR_STYLE,HU.css(CSS_MARGIN,HU.px(5),CSS_MARGIN_TOP,HU.px(10))],s);let l=HU.makeDialog({content:s,anchor:$(this),remove:!1,xmodal:!0,sticky:!0});o.jq("stac_add_url").keypress((e=>{if(13==e.which){let e=o.jq("stac_add_url").val();Utils.stringDefined(e)&&t(e),l.remove()}})),l.find(".display-button").button().click((function(){if($(this).hasClass("stac-add-ok")){let e=o.jq("stac_add_url").val();Utils.stringDefined(e)&&t(e)}l.remove()}))})),this.jq("stac_go").button().click((()=>{let e=this.jq("stac_input").val();Utils.stringDefined(e)||(e=this.jq("stac_url").val()),Utils.stringDefined(e)&&t(e)}))};r();let o=this,n=(e,i)=>{Array.isArray(e)&&(e={title:"Stac Catalogs",links:e});let s="",l=(e.title??i)+HU.space(1)+HU.href(i,HU.getIconImage(ICON_LINK,[],[ATTR_STYLE,HU.css(CSS_FONT_SIZE,HU.pt(9))]),[ATTR_TARGET,"_stac"]);if(s+=HU.center(HU.b(l)),e.description){let t=Utils.stripTags(e.description);t=t.replace(/[\n\s*\n]\n+/g,"\n").trim(),t=t.replace(/[\n\n]+/g,"\n").replace(/\n/g,HU.br()),s+=HU.div([ATTR_CLASS,"boxquote",ATTR_STYLE,HU.css(CSS_MAX_WIDTH,HU.px(600),CSS_OVERFLOW_X,OVERFLOW_AUTO,CSS_MAX_HEIGHT,HU.px(100),CSS_OVERFLOW_Y,OVERFLOW_AUTO)],t)}let a="",r="";if(e.links){e.links.forEach((e=>{let t=e.href??e.url??e.link;if(!Utils.stringDefined(t)||"self"==e.rel)return;(i.startsWith("http:")||i.startsWith("https:"))&&(t=new URL(t,i).href);let s=e.title;s||(s=t.replace(/.*\/([^\/]+$)/,"$1"));let l,o=HU.href(t,HU.getIconImage(ICON_LINK,[],[ATTR_TITLE,e.summary??"",ATTR_STYLE,HU.css(CSS_FONT_SIZE,HU.pt(9))])+" "+s+(e.rel?" ("+e.rel+")":""),[ATTR_TARGET,"_stactarget",ATTR_CLASS,CLASS_CLICKABLE]);Utils.isDefined(e.variables)?l=!0:Utils.stringDefined(e.type)?l="application/json"==e.type||"application/geo+json"==e.type:(e.rel&&(l=["next","search","parent","root","child","items","search"].includes(e.rel)),l||(l=t.endsWith("json"))),l?a+=HU.tr(HU.td([ATTR_WIDTH,HU.perc(10),ATTR_NOWRAP,"true"],HU.div([ATTR_TITLE,t,ATTR_CLASS,"imdv-stac-item"],HU.span(["link",t,ATTR_CLASS,"imdv-stac-link"],"Load")))+HU.td(o)):r+=HU.tr(HU.td([ATTR_WIDTH,HU.perc(10),ATTR_NOWRAP,"true"],"")+HU.td(o))}))}let n="";if(e.assets){let t="",s="",l="";Object.keys(e.assets).forEach(((a,r)=>{if(r>200)return;let o=e.assets[a];if(!Utils.stringDefined(o.href))return;""==t&&(t+=HU.b("Assets: ")+"note: the IMDV does not handle all projections. Try the thumbnail"+HU.br(),t+=HU.open(TAG_TABLE,[ATTR_WIDTH,HU.perc(100)]));let n=o.name??o.title??a,h=new URL(o.href,i).href,d=HU.href(h,HU.getIconImage(ICON_LINK,[],[ATTR_STYLE,HU.css(CSS_FONT_SIZE,HU.pt(9))])+" "+n+" ("+o.type+")",[ATTR_TITLE,h,ATTR_TARGET,"_stactarget",ATTR_CLASS,CLASS_CLICKABLE]),g=o.type??o.media_type,p=g&&g.indexOf("image")>=0;o.href.endsWith("ovr")&&(p=!1),p?s+=HU.tr(HU.td([ATTR_WIDTH,HU.perc(10),ATTR_NOWRAP,"true"],HU.div([ATTR_CLASS,"imdv-stac-item"],HU.span(["asset-id",a,ATTR_CLASS,"imdv-stac-asset"],"Add Image")))+HU.td(d)):l+=HU.tr(HU.td("")+HU.td(d))})),t+=s,t+=l,t+=HU.close(TAG_TABLE),n=t}let h=a+r;""!=h&&(s+=HU.b("Links:"),s+=HU.br(),h=HU.table(h),s+=""!=n?HU.div([ATTR_STYLE,HU.css(CSS_MAX_HEIGHT,HU.em(5),CSS_OVERFLOW_Y,OVERFLOW_AUTO)],h):h),s+=n,s=HU.div([ATTR_STYLE,HU.css(CSS_MAX_HEIGHT,HU.px(300),CSS_OVERFLOW_Y,OVERFLOW_AUTO)],s),this.jq("stac_output").html(s),this.jq("stac_output").find(".imdv-stac-link").button().click((function(){t($(this).attr("link"))})),this.jq("stac_output").find(".imdv-stac-asset").button().click((function(){let t=e.bbox;if(e.bbox||(t=e?.extent?.spatial?.bbox,t&&(t=t[0],t&&(t=[t[0],t[3],t[2],t[1]]))),!t)return void alert("No bbox found");let s=e.assets[$(this).attr("asset-id")],l=new URL(s.href,i).href;s.type&&s.type.indexOf("image/tiff")>=0&&(l=HU.url(Ramadda.getUrl("/tifftopng"),ARG_URL,l)),console.log(l);let a={type:GLYPH_MAP,entryType:"stacimage",icon:"/repository/icons/mapfile.png",name:s.name??s.title,bbox:t,resourceUrl:l};o.handleNewFeature(null,{rotation:0,transform:""},a).checkMapLayer(!0)}))};t=e=>{if(!Utils.stringDefined(e))return;this.currentStacUrl=e,this.jq("stac_url").val(e);this.jq("stac_output").html("Loading..."),$.getJSON(e,(t=>{a[e]||(a[e]=!0,l.push({value:e,label:t.title??e}),r(e)),n(t,e)})).fail((t=>{console.dir(t),this.jq("stac_output").html("Load failed. URL: "+e)}))}},createMapMarker:function(e,t,i,s,l){let a=this.makeFeature(this.getMap(),"OpenLayers.Geometry.Point",i,s);a.style=i,this.addFeatures([a]);let r=new MapGlyph(this,e,t,a,i);return r.checkImage(a),l&&this.addGlyph(r),r},clearCommands:function(){this.getMap().closePopup(),this.clearMessage2(),this.getMap().clearAllProgress(),HU.hidePopupObject(),this.showCommandMessage("");let e=this.jq(P).find("."+CLASS_CLICKABLE);e.removeClass("imdv-command-active"),e.each((function(){$(this).attr("selected",!1)})),this.commands.forEach((e=>{e.deactivate()})),this.command=null},getMapOptions:function(e){if(e.mapOptions)return e.mapOptions;let t=e.style?e.style.mapOptions:{};return t?e.style&&delete e.style.mapOptions:(t={},e.style&&(t.type=e.style.type)),e.mapOptions=t,t},initGlyphButtons:function(e){if(!e)return;let t=this;e.find(HU.dotClass(CLASS_BUTTON)).button(),e.find("["+ATTR_BUTTON_COMMAND+"]").click((function(e){e.preventDefault();let i=$(this).attr(ATTR_BUTTON_COMMAND),s=$(this).attr(ATTR_GLYPH_ID),l=t.findGlyph(s);if(l){if("toback"==i)t.changeOrder(!1,l);else if(i==PROP_LAYERS_STEP_SHOW)l.toggleLayersVisibility(e);else if(i==PROP_LAYERS_ANIMATION_PLAY)l.toggleLayersAnimation(e);else if("tofront"==i)t.changeOrder(!0,l);else if("popup"==i)t.handleMapGlyphClick(l);else if("edit"==i)t.editFeatureProperties(l,$(this));else if("addisoline"==i)t.addIsolineForMarker(l);else if(i==A)l.isSelected()?t.unselectGlyph(l):t.selectGlyph(l);else if(i==S)if(t.dontAskDelete)t.removeMapGlyphs([l]);else{let e=HU.checkbox(t.domId("dontask"),[ATTR_ID,t.domId("dontask"),ATTR_CLASS,""],!1,"Don't ask again");HU.makeOkCancelDialog($(this),"Are you sure you want to delete this glyph?",(()=>{t.dontAskDelete=HU.isChecked(t.jq("dontask")),t.removeMapGlyphs([l])}),null,e)}}else console.error("No map glyph from id:"+s)}))},makeGlyphButtons:function(e,t,i){let s=[],l=e=>HU.getIconImage(e,[],BUTTON_IMAGE_ATTRS);if((e.isEntry()||Utils.stringDefined(e.getPopupText()))&&s.push(HU.span([ATTR_CLASS,CLASS_CLICKABLE,ATTR_TITLE,"Map Popup",ATTR_GLYPH_ID,e.getId(),ATTR_BUTTON_COMMAND,"popup"],l("fas fa-arrow-up-from-bracket"))),this.canChange()&&t&&(s.push(HU.span([ATTR_CLASS,CLASS_CLICKABLE,ATTR_TITLE,"Settings",ATTR_GLYPH_ID,e.getId(),ATTR_BUTTON_COMMAND,"edit"],l("fas fa-cog"))),s.push(HU.span([ATTR_CLASS,CLASS_CLICKABLE,ATTR_TITLE,"Select",ATTR_GLYPH_ID,e.getId(),ATTR_BUTTON_COMMAND,A],l("fas fa-hand-pointer"))),s.push(HU.span([ATTR_CLASS,CLASS_CLICKABLE,ATTR_TITLE,"Delete",ATTR_GLYPH_ID,e.getId(),ATTR_BUTTON_COMMAND,S],l(ICON_ERASER))),e.isMarker()&&this.isIsolineEnabled()&&s.push(HU.span([ATTR_CLASS,CLASS_CLICKABLE,ATTR_TITLE,"Add Isoline",ATTR_GLYPH_ID,e.getId(),ATTR_BUTTON_COMMAND,"addisoline"],l("fa-regular fa-circle-dot")))),0==s.length)return"";return Utils.wrap(s,HU.open(TAG_SPAN,""),HU.close(TAG_SPAN))},makeListItem:function(e,t){e.getStyle();let i="",s=(e.getType(),HU.span([ATTR_TITLE,"Click to select",ATTR_STYLE,HU.css(CSS_PADDING_LEFT,HU.px(0),CSS_PADDING_RIGHT,HU.px(5)),ATTR_GLYPH_ID,e.getId(),ATTR_CLASS,HU.classes(CLASS_CLICKABLE,"imdv-feature")],HU.getIconImage("fas fa-arrow-pointer")),HU.checkbox("",[ATTR_STYLE,HU.css(CSS_MARGIN_RIGHT,HU.px(5)),ATTR_TITLE,"Visible",ATTR_GLYPH_ID,e.getId(),ATTR_CLASS,HU.classes(CLASS_CLICKABLE,"imdv-feature-visible")],e.getVisible())),l=e.getLabel();l+=HU.div([],s+e.makeLegendButtons()),i+=HU.td([ATTR_NOWRAP,"",ATTR_STYLE,HU.css(CSS_PADDING,HU.px(5))],l);let a=e.getDecoration(),r=this.getDistances(e.getGeometry(),e.getType());return r&&(a+=""+r.replace(/<br>/g," ")),i+=HU.td([ATTR_GLYPH_ID,e.getId(),ATTR_STYLE,HU.css(CSS_PADDING,HU.px(5))],a),i},createData:function(e){let t=Ramadda.getUrl("/getwiki");$.post(t,{entryid:e.entryId},(t=>{let i=t.match(/"filterFields":\"([^\"]+)"/),s=/createDisplay *\( *\"map\" *(.*?)}\);/;s=/createDisplay\s*\(\s*\"map\"\s*,\s*({[\s\S]+?\})\);/;let l,a=t.match(s),r={},o=null,n="";if(a||(n=HU.div([],"There doesn't seem to be any map displays defined for this entry")),a){l=a[1],l=l.replace(/\n/g," ");let e=/\"data\" *: *new *PointData[^\)]+?\)/g;if(e=/\"data\"\s*:\s*new\s*PointData\s*\((.*?)\)/g,a=l.match(e),a){let e=new RegExp('"('+Ramadda.getBaseUrl()+'[^"]+)"');a=a[0].match(e),a&&(o=a[1])}l=l.replace(e,""),l=l.replace(/,\s*\}/g,"}"),l=l.replace(/,\s*,/g,",");try{r=JSON.parse(l),i&&!r.filterFields&&(r.filterFields=i[1])}catch(e){console.error(e),console.error(l)}}let h=["hereRoutingEnabled","googleRoutingEnabled","canEdit","title","bounds","zoomLevel","mapCenter","width","height","user","entryIcon","entryId","thisEntryType","fileUrl","popupWidth","popupHeight","divid"],d="";for(key in r){if(h.includes(key))continue;let e=r[key];Array.isArray(e)||(d+=key+"="+e+"\n")}let g=n+HU.textarea("",d,[ATTR_ID,this.domId("displayattrs"),ATTR_ROWS,10,ATTR_COLS,60]),p=HU.checkbox(this.domId("andzoom"),[],!0,"Zoom to display"),c=HU.center(HU.div([ATTR_CLASS,HU.classes(CLASS_BUTTON_OK,CLASS_DISPLAY_BUTTON)],LABEL_OK)+SPACE2+HU.div([ATTR_CLASS,HU.classes(CLASS_BUTTON_CANCEL,CLASS_DISPLAY_BUTTON)],LABEL_CANCEL));g=HU.div([ATTR_STYLE,HU.css(CSS_MARGIN,HU.px(4))],g+HU.br()+p+c);let u=HU.makeDialog({content:g,anchor:this.jq(b),title:"Map Display Attributes",header:!0,draggable:!0,remove:!1});u.find(HU.dotClass(CLASS_BUTTON_OK)).button().click((()=>{let t=this.parseDisplayAttrs(this.jq("displayattrs").val());t.pointDataUrl=o,this.handleNewFeature(null,null,e).addData(t,HU.isChecked(this.jq("andzoom"))),u.remove()})),u.find(HU.dotClass(CLASS_BUTTON_CANCEL)).button().click((()=>{u.remove()}))})).fail((e=>{alert("An error occurred:"+e)}))},parseDisplayAttrs:function(e){let t={};return Utils.split(String(e),"\n",!0,!0,[]).forEach((e=>{let i=Utils.splitFirst(e,"=");if(1==i.length)t[i[0]]="";else if(i.length>=2){let e=i[1];"true"==e?e=!0:"false"==e&&(e=!1),t[i[0]]=e}})),t},addFeatureList:function(){let e=HU.open(TAG_TABLE,[ATTR_WIDTH,HU.perc(100)]);this.glyphListMap={},this.glyphs.forEach(((t,i)=>{this.glyphListMap[i]=t;let a="";t.isSelected()&&(a+=" "+l),e+=HU.openTag(TAG_TR,[ATTR_CLASS,s+" "+a,ATTR_VALIGN,ALIGN_TOP,ATTR_STYLE,HU.css(CSS_BORDER_BOTTOM,HU.border(1,COLOR_LIGHT_GRAY)),ATTR_GLYPH_ID,t.getId()]);let r=this.makeListItem(t,i);e+=r,e+=HU.close(TAG_TR)})),e+=HU.close(TAG_TABLE);let t=this;this.jq(N).html(e),this.initGlyphButtons(this.jq(N)),this.jq(N).find(".imdv-feature-visible").change((function(){let e=$(this).attr(ATTR_GLYPH_ID),i=t.findGlyph(e);i?i.setVisible(HU.isChecked($(this)),!0):console.error("No map glyph from id:"+e)})),this.jq(N).find(".imdv-feature").click((function(e){let i=l,a=$(this).attr(ATTR_GLYPH_ID),r=t.findGlyph(a);if(!r)return void console.error("No map glyph from id:"+a);if(e.shiftKey)return void t.editFeatureProperties(r);let o=$(this).closest("."+s);o.hasClass(i)?(o.removeClass(i),t.unselectGlyph(r)):(o.addClass(i),t.selectGlyph(r))}))},listFeatures:function(){this.clearCommands();let e=()=>{this.listDialog&&(this.listDialog.hide(),this.listDialog.remove()),this.listDialog=null};e();let t="";t+=HU.div([ATTR_ID,this.domId(N),ATTR_STYLE,HU.css(CSS_MARGIN_BOTTOM,HU.px(10),CSS_BORDER,HU.border(1,COLOR_LIGHT_GRAY),CSS_MAX_HEIGHT,HU.px(300),CSS_MAX_WIDTH,HU.px(600),CSS_OVERFLOW_X,OVERFLOW_AUTO,CSS_OVERFLOW_Y,OVERFLOW_AUTO)],""),t+=HU.open(TAG_CENTER),t+=HU.div([ATTR_ID,this.domId(m),ATTR_CLASS,CLASS_DISPLAY_BUTTON],"Delete Selected"),t+=SPACE2,t+=HU.div([ATTR_ID,this.domId(_),ATTR_CLASS,CLASS_DISPLAY_BUTTON],"Close"),t+=HU.close(TAG_CENTER),t=HU.div([ATTR_CLASS,"wiki-editor-popup"],t);this.listDialog=HU.makeDialog({content:t,anchor:this.jq(b),title:"Features",header:!0,draggable:!0,remove:!1});this.addFeatureList();let i=this;this.jq(m).button().click((()=>{let e=[];this.jq(N).find(".imdv-feature-selected").each((function(){let t=$(this).attr(ATTR_GLYPH_ID),s=i.findGlyph(t);s?e.push(s):console.error("No map glyph from id:"+t)})),this.removeImages(e),this.setClipboard(e),this.removeMapGlyphs(e)})),this.jq(_).button().click(e)},addFeatures:function(e){let t=this.myLayer;t.addFeatures(e),e.forEach((e=>{e.layer=t}))},removeMapGlyph:function(e){Utils.removeItem(this.glyphs,e)},removeMapGlyphs:function(e){e.forEach((e=>{Utils.removeItem(this.glyphs,e),e.doRemove()})),this.handleGlyphsChanged()},removeFeatures:function(e){e&&this.myLayer.removeFeatures(e)},addControl:function(e,t,i){return i.name=e,i.message=t,this.map.getMap().addControl(i),this.commands.push(i),i},pasteCount:0,doPaste:function(e){if(!this.clipboard)return;let t=this.clipboard;this.unselectAll();let i=t.map((e=>e.clone()));for(let e=0;e<i.length;e++)i[e].type=t[e].type;let s=this.map.getMap().getExtent().getHeight();this.pasteCount++;let l=.05*this.pasteCount*s;i.forEach((e=>{e.move(l,-l),e.checkImage(),e.isMap()?e.checkMapLayer():e.isMapServer()&&e.checkMapServer()})),this.addGlyph(i),i.forEach((e=>{this.selectGlyph(e)}))},initSideHelp:function(e){e.find(HU.dotClass(CLASS_IMDV_PROPERTY)).click((function(){let e=$(this).attr(ATTR_VALUE);if(!e)return;e=e.replace(/\\n/g,"\n");let t=$(this).attr(ATTR_TARGET),i=GuiUtils.getDomObject(t);i&&WikiUtil.insertAtCursor("",i.obj,e)}))},makeSideHelp:function(e,t,i){(i=i??{}).prefix||(i.prefix=""),i.suffix||(i.suffix="");let s="";return e.forEach((e=>{if("<hr>"==e)return void(s+="<thin_hr>");if(e.info)return void(s+=HU.div([ATTR_CLASS,HU.classes(CLASS_CLICKABLE,"imdv-property-popup"),ATTR_TARGET,t,"info-id",e.info],e.title));let l=[ATTR_CLASS,HU.classes(CLASS_CLICKABLE,CLASS_IMDV_PROPERTY),ATTR_TARGET,t];e.title&&l.push(ATTR_TITLE,e.title);let a=e.skip;e.line&&(e=e.line),a?s+=HU.div([],e):(l.push(ATTR_VALUE,i.prefix+e+i.suffix),s+=HU.div(l,e))})),s=HU.div([ATTR_CLASS,CLASS_IMDV_SIDEHELP,ATTR_STYLE,i.style??""],s),s},getFeaturePropertyApply:function(){return(e,t)=>{this.featureChanged();let i={};if(e.isData()){this.parseDisplayAttrs(this.jq("displayattrs").val())}if(t&&t.forEach((e=>{if(e.endsWith("_cleared"))return;let t="glyphedit_"+e;if((e.toLowerCase().indexOf("externalgraphic")>=0||"childIcon"==e)&&(Utils.isTrue(this.jq(e).attr("clearpressed"))?i[e+"_cleared"]=!0:i[e+"_cleared"]=!1,t=e),"labelSelect"==e)return;let s=this.jq(t).val();"label"==e&&(s=s.replace(/\\n/g,"\n")),"showLabels"==e&&(s=HU.isChecked(this.jq(t))),i[e]=s})),i.externalGraphic&&!i.externalGraphic.startsWith("data:")&&(e.attrs.icon=i.externalGraphic),Utils.stringDefined(i.popupText),i.cursor=CURSOR_POINTER,e.isData()){let t=this.parseDisplayAttrs(this.jq("displayattrs").val());e.applyDisplayAttrs(t)}else e.isMultiEntry()&&e.addEntries();e.applyPropertiesComponent(i),e.applyPropertiesDialog(i),e.makeLegend(),e.initLegend(),this.showMapLegend(),e.redraw()}},doEdit:function(e){if(!e){if(0==this.getSelected().length)return;e=this.getSelected()[0]}if(!e)return;e.style,HU.div([ATTR_STYLE,HU.css(CSS_MARGIN,HU.px(8))],"Feature: "+e.type);this.redraw(e),e.image&&Utils.isDefined(e.image.opacity)&&(e.style.imageOpacity=e.image.opacity),this.editFeatureProperties(e)},makeMenu:function(e){return HU.div([ATTR_CLASS,"wiki-editor-popup"],e)},menuItem:function(e,t,i){if(i){let e="";"Esc"!=i&&(e="Ctrl-"),t=HU.leftRightTable(t,HU.div([ATTR_STYLE,HU.css(CSS_MARGIN_LEFT,HU.px(8))],HU.span([ATTR_STYLE,HU.css(CSS_COLOR,COLOR_LIGHT_GRAY)],e+i)))}return HU.div([ATTR_ID,e,ATTR_CLASS,CLASS_CLICKABLE],t)},editFeatureProperties:function(e,t){this.doProperties(e.getStyle(),this.getFeaturePropertyApply(),e,t)},makeColorBar:function(e){let t=Utils.split("transparent,#ff0000,#ffa500,#ffff00,#fffeec,#008000,#0000ff,#4b0082,#ee82ee,#ffffff,#000000,#cd5c5c,#f08080,#fa8072,#e9967a,#ffa07a,#dc143c,#ff0000,#b22222,#8b0000,#ffc0cb,#ffb6c1,#ff69b4,#ff1493,#c71585,#db7093,#ff7f50,#ff6347,#ff4500,#ff8c00,#ffa500,#ffd700,#ffff00,#ffffe0,#fffacd,#fafad2,#ffefd5,#ffe4b5,#ffdab9,#eee8aa,#f0e68c,#bdb76b,#e6e6fa,#d8bfd8,#dda0dd,#ee82ee,#da70d6,#ff00ff,#ff00ff,#ba55d3,#9370db,#663399,#8a2be2,#9400d3,#9932cc,#8b008b,#800080,#4b0082,#6a5acd,#483d8b,#7b68ee,#adff2f,#7fff00,#7cfc00,#00ff00,#32cd32,#98fb98,#90ee90,#00fa9a,#00ff7f,#3cb371,#2e8b57,#228b22,#006400,#9acd32,#6b8e23,#808000,#556b2f,#66cdaa,#8fbc8f,#20b2aa,#008b8b,#008080,#00ffff,#00ffff,#e0ffff,#afeeee,#7fffd4,#40e0d0,#48d1cc,#00ced1,#5f9ea0,#4682b4,#b0c4de,#b0e0e6,#add8e6,#87ceeb,#87cefa,#00bfff,#1e90ff,#6495ed,#7b68ee,#4169e1,#0000ff,#0000cd,#00008b,#000080,#191970,#fff8dc,#ffebcd,#ffe4c4,#ffdead,#f5deb3,#deb887,#d2b48c,#bc8f8f,#f4a460,#daa520,#b8860b,#cd853f,#d2691e,#8b4513,#a0522d,#a52a2a,#800000,#fffafa,#f0fff0,#f5fffa,#f0ffff,#f0f8ff,#f8f8ff,#f5f5f5,#fff5ee,#f5f5dc,#fdf5e6,#fffaf0,#fffff0,#faebd7,#faf0e6,#fff0f5,#ffe4e1,#dcdcdc,#d3d3d3,#c0c0c0,#a9a9a9,#808080,#696969,#778899,#708090,#2f4f4f",","),i="",s=0;return t.forEach((t=>{i+=HU.div([ATTR_TITLE,t,ATTR_COLOR,t,ATTR_WIDGET_ID,e,ATTR_CLASS,HU.classes(CLASS_CLICKABLE,"ramadda-color-select","ramadda-dot"),ATTR_STYLE,HU.css(CSS_BACKGROUND,t)])+SPACE,s++,s>=10&&(s=0,i+=HU.br())})),i=HU.div([ATTR_STYLE,HU.css(CSS_MAX_HEIGHT,HU.px(150),CSS_OVERFLOW_Y,OVERFLOW_AUTO,CSS_BORDER,HU.border(1,COLOR_LIGHT_GRAY))],i),i},getFillPatternSelect:function(e,t){let i=["",...Object.keys(IMDV_PATTERNS).sort()].map((e=>""==e?{value:"",label:"None"}:{value:e,label:e}));return HU.select("",[ATTR_ID,e],i,t)},makeStyleForm:function(e,t,i){i=i??{};let s,l="",r={};l+=HU.formTable(),t&&(l+=t.addToStyleDialog(e)??"");let o=t?t.isGroup():i.isGroup;if(e){t&&(e=t.getStyleForProperties(e)),s=[];e.imageUrl;for(a in e)s.push(a),r[a]=e[a]}else s=["strokeColor","strokeWidth","strokeDashstyle","strokeOpacity","fillColor","fillOpacity","fillPattern","pointRadius","externalGraphic","graphicName","imageOpacity","fontSize","fontWeight","fontStyle","fontFamily","labelAlign","labelXOffset","labelYOffset"];s.includes("entryId")&&!s.includes("wikiText")&&s.push("wikiText"),s.includes("wikiText")||s.includes("text")||s.includes("popupText")||s.push("popupText"),t&&t.isGroup()&&!s.includes("popupText")&&s.push("popupText");let n=["mapOptions","labelSelect","cursor","display"],h=null,d={strokeColor:{label:"Stroke",strip:"stroke"},fillColor:{label:"Fill",strip:"fill"},fontColor:{label:"Font",strip:"font"},dotSize:{label:"Line Dots",strip:"dot"},labelAlign:{label:"Label",strip:"label"},textBackgroundStrokeColor:{label:"Text Background",strip:"textBackground"},transform:{label:"Image Transforms"}};return s.forEach((e=>{let i="glyphedit_"+e,s=this.domId(i);if(n.includes(e))return;let a=d[e];a?(h=a.strip,l+=HU.tr([],HU.td([ATTR_COLSPAN,2],HU.div([ATTR_CLASS,"imdv-form-header"],a.label)))):h&&!e.startsWith(h)&&(l+=HU.tr([],HU.td([ATTR_COLSPAN,2],"")),h=null);let g,p=e;if(h&&(p=p.replace(h,"")),p=Utils.makeLabel(p),e.endsWith("_cleared"))return;"pointRadius"==e&&(p="Size");let c="";if("externalGraphic"==e||e.indexOf("ExternalGraphic")>=0||"childIcon"==e){p="Marker","childIcon"==e&&(p="Child Entry Icon");let t=r[e];Utils.isDefined(t)||(t=this.getExternalGraphic()),s=this.domId(e);let i=HU.div([ATTR_CLASS,"imdv-icons",ATTR_STYLE,HU.css(CSS_MARGIN_LEFT,HU.px(5),CSS_DISPLAY,DISPLAY_INLINE_BLOCK),"icon-property",e,ATTR_ID,this.domId(e+"_icons")],"Loading...");g=HU.hidden("",t,[ATTR_ID,s])+HU.open(TAG_TABLE)+HU.open(TAG_TR,[ATTR_VALIGN,ALIGN_TOP])+HU.open(TAG_TD,[ATTR_WIDTH,HU.perc(1)])+HU.image(t,[ATTR_WIDTH,HU.px(24),ATTR_ID,this.domId(e+"_image")])+HU.close(TAG_TD)+HU.open(TAG_TD)+i+HU.close(TAG_TD,TAG_TR,TAG_TABLE)}else{let a=r[e];if(!Utils.isDefined(a)&&"wikiText"!=e){let t="get"+e[0].toUpperCase()+e.substring(1);a=this[t]?this[t]():this.getProperty(e)}let o="20",n=1;if("label"==e)o="80",t.attrs.labelTemplate&&(a=t.attrs.labelTemplate),g=HU.textarea("",a,[ATTR_ID,s,ATTR_ROWS,3,ATTR_COLS,60]),t.isEntry()&&(g+=HU.br()+HU.checkbox(this.domId("useentrylabel"),[],t.getUseEntryLabel(),"Use label from entry"));else{if("popupText"==e)return;if("wikiText"==e||"text"==e){o="80";let e=this.getUsedMarkers();if(g=HU.textarea("",a||"",[ATTR_ID,s,ATTR_ROWS,5,ATTR_COLS,60]),e.length>0){let t=HU.boldLabel("Add icon");e.forEach((e=>{t+=HU.span([ATTR_CLASS,HU.classes(CLASS_CLICKABLE,"ramadda-icons-recent"),"icon",e,"textarea",s],HU.getIconImage(e,[ATTR_WIDTH,HU.px(16)])),t+=" "})),g=HU.div([],t)+g}}else if("strokeDashstyle"==e)g=HU.select("",[ATTR_ID,s],["solid","dot","dash","dashdot","longdash","longdashdot"],a);else if("strokeLinecap"==e)g=HU.select("",[ATTR_ID,s],["butt","round","square"],a);else if("fontWeight"==e)g=HU.select("",[ATTR_ID,s],["normal","bold","lighter","bolder","100","200","300","400","500","600","700","800","900"],a);else if("fontStyle"==e)g=HU.select("",[ATTR_ID,s],["normal","italic"],a);else if("textBackgroundShape"==e)g=HU.select("",[ATTR_ID,s],["rectangle","circle","ellipse"],a);else if("pointRadius"==e&&(p="Size"),"textBackgroundFillOpacity"==e||"textBackgroundPadding"==e||"strokeWidth"==e||"pointRadius"==e||"fontSize"==e||"imageOpacity"==e||"dotSize"==e?o="4":"fontFamily"==e||e.toLowerCase().indexOf("url")>=0?o="60":"imagecss"==e?(p="Image CSS",o="60",n=5,c=HU.pre([],"property=value...")):"imagefilter"==e?(p="Image Filter",o="60",c=HU.br()+"e.g.:<pre>contrast(200%) grayscale(80%) brightness(0.4)\ninvert(75%) saturate(30%) sepia(60%)</pre>",c+=HU.href("https://developer.mozilla.org/en-US/docs/Web/CSS/filter","Help",[ATTR_TARGET,"_help"])):"clippath"==e?(p="Image Clip Path",o="60",c=HU.br()+HU.span([ATTR_ID,"clippathdraw",ATTR_CLASS,CLASS_CLICKABLE,ATTR_TITLE,"Draw polygon"],HU.getIconImage("fas fa-draw-polygon")+" clip the image")+", e.g.,<pre>polygon(x1 y1,x2 y2,x3 y3,x4 y4)\ne.g., to clip 5% from left, 18% from top and 10% from right do:\npolygon(5% 18%,95% 18%,95% 90%,5% 90%)</pre>",c+=HU.href("https://developer.mozilla.org/en-US/docs/Web/CSS/clip-path","Help",[ATTR_TARGET,"_help"])):"transform"==e&&(p="Image Transform",o="60",c=HU.br()+"Apply CSS transform. e.g., to shrink the lower part of an image do:<pre>perspective(10px) rotateX(-0.05deg)</pre>",c+=HU.href("https://developer.mozilla.org/en-US/docs/Web/CSS/transform","Help",[ATTR_TARGET,"_help"])),e.indexOf("Color")>=0)g=HU.input("",a,[ATTR_CLASS,CLASS_IMDV_COLOR,ATTR_ID,s,ATTR_SIZE,8]),g+=SPACE1,g+=HU.input("",a,[ATTR_STYLE,HU.css(CSS_BORDER_RADIUS,"var(--default-radius)"),ATTR_TYPE,"color","baseid",s,ATTR_CLASS,"ramadda-imdv-color-hidden",ATTR_ID,s+"colorinput",ATTR_SIZE,8]);else if("labelAlign"==e){l+=HU.formTableClose(),l+=HU.formTable();let e=[["lt","Left Top"],["ct","Center Top"],["rt","Right Top"],["lm","Left Middle"],["cm","Center Middle"],["rm","Right Middle"],["lb","Left Bottom"],["cb","Center Bottom"],["rb","Right Bottom"]];g=HU.select("",[ATTR_ID,s],e,a)}else if("showLabels"==e)g=HU.checkbox(s,[],a);else if("graphicName"==e){p="Graphic";let e=["","circle","square","star","x","cross","triangle","lightning","rectangle","church","_x","arrow","plane","arrow"].map((e=>""==e?{value:"",label:"None"}:{value:e,label:e}));g=HU.select("",[ATTR_ID,s],e,a)}else if("fillPattern"==e)g=this.getFillPatternSelect(s,a);else if(e.indexOf("Radius")>=0||e.indexOf("Width")>=0||e.indexOf("Padding")>=0||e.indexOf("Offset")>=0||"rotation"==e){let t="rotation"==e,i=e.indexOf("Offset")>=0;Utils.isDefined(a)?""===a&&(a=t?0:1):a=t?0:1;let l=t?-360:i?-50:0,r=t?360:50,o=4;e.indexOf("Offset")>=0&&(o=8),g=HU.input("",a,[ATTR_ID,s,ATTR_SIZE,o])+HU.space(4)+HU.div([ATTR_SLIDER_MIN,l,ATTR_SLIDER_MAX,r,ATTR_SLIDER_STEP,1,ATTR_SLIDER_VALUE,a,ATTR_SLIDER_ID,s,ATTR_ID,s+"_slider",ATTR_CLASS,CLASS_SLIDER,ATTR_STYLE,HU.css(CSS_DISPLAY,DISPLAY_INLINE_BLOCK,CSS_WIDTH,HU.px(200))],"")}else e.toLowerCase().indexOf("opacity")>=0?(a&&""!=a||(a=1),g=HU.input("",a,[ATTR_ID,s,ATTR_SIZE,4])+HU.space(4)+HU.div([ATTR_SLIDER_MIN,0,ATTR_SLIDER_MAX,1,ATTR_SLIDER_VALUE,a,ATTR_SLIDER_ID,s,ATTR_ID,s+"_slider",ATTR_CLASS,CLASS_SLIDER,ATTR_STYLE,HU.css(CSS_DISPLAY,DISPLAY_INLINE_BLOCK,CSS_WIDTH,HU.px(200))],"")):g=n>1?HU.textarea("",a,[ATTR_ID,this.domId(i),ATTR_ROWS,n,ATTR_COLS,o]):HU.input("",a,[ATTR_ID,this.domId(i),ATTR_SIZE,o])}}let u="";o&&(u=HU.span([ATTR_TITLE,"Apply this style to children glyphs",ATTR_CLASS,HU.classes(CLASS_CLICKABLE,"imdv-style-suffix"),ATTR_WIDGET_ID,s,ATTR_PROPERTY,e],HU.getIconImage("fas fa-folder-tree"))),""==p&&(p="Label"),l+=HU.formEntryLabel(p,g+u+c),l+="\n"})),l+=HU.close(TAG_TABLE),l=HU.div([ATTR_CLASS,"imdv-form",ATTR_STYLE,HU.css(CSS_MAX_HEIGHT,HU.px(350),CSS_OVERFLOW_Y,"scroll",CSS_MARGIN_BOTTOM,HU.px(5))],l),{props:s,html:l}},setLevelRangeTick:function(){let e=this.getCurrentLevel(),t=100*(e-this.minLevel)/(this.maxLevel-this.minLevel);this.jq("level_range_tick").css(CSS_LEFT,HU.perc(t)),this.jq("level_range_tick").attr(ATTR_TITLE,"Current level:"+e)},getLevelRangeWidget:function(e,t){e||(e={});let i=HU.checkbox(this.domId(PROP_LEVELRANGE_SHOWMARKER),[ATTR_ID,this.domId(PROP_LEVELRANGE_SHOWMARKER)],t,"Show marker instead"),s=e.min??this.minLevel,l=e.max??this.maxLevel,a=(this.getCurrentLevel(),this.minLevel,this.maxLevel,this.minLevel,HU.px(400)),r=HU.boldLabel("Visible between levels")+HU.space(3)+i+HU.br();r+=HU.hidden("",e.min??this.minLevel,[ATTR_ID,this.domId(ID_LEVEL_RANGE_MIN)])+HU.hidden("",e.max??this.maxLevel,[ATTR_ID,this.domId(ID_LEVEL_RANGE_MAX)]),r+=HU.hidden("","",[ATTR_ID,this.domId(ID_LEVEL_RANGE_CHANGED)]);let o=HU.div([ATTR_ID,this.domId(ID_LEVEL_RANGE_SLIDER),ATTR_STYLE,HU.css(CSS_MARGIN_BOTTOM,HU.px(110),CSS_MARGIN_TOP,HU.px(10),CSS_POSITION,POSITION_RELATIVE,CSS_WIDTH,a)]),n=HU.span([ATTR_TITLE,"Clear range values",ATTR_STYLE,HU.css(CSS_MARGIN_LEFT,HU.px(10)),ATTR_CLASS,CLASS_CLICKABLE,ATTR_ID,this.domId(ID_LEVEL_RANGE_CLEAR)],HU.getIconImage("fas fa-delete-left"));o=HU.hbox([o,n]);let h=HU.image(icon_downdart,[ATTR_ID,this.domId("level_range_tick"),ATTR_STYLE,HU.css(CSS_POSITION,POSITION_ABSOLUTE,CSS_TOP,HU.px(0))]),d=HU.image(RamaddaUtil.getCdnUrl("/map/zoom/zoom"+s+".png"),[ATTR_ID,this.domId(ID_LEVEL_RANGE_SAMPLE_MIN),ATTR_STYLE,HU.css(CSS_POSITION,POSITION_ABSOLUTE,CSS_LEFT,HU.px(0),CSS_BOTTOM,HU.px(0)),ATTR_WIDTH,HU.px(120)]),g=HU.image(RamaddaUtil.getCdnUrl("/map/zoom/zoom"+l+".png"),[ATTR_ID,this.domId(ID_LEVEL_RANGE_SAMPLE_MAX),ATTR_STYLE,HU.css(CSS_POSITION,POSITION_ABSOLUTE,CSS_RIGHT,HU.px(0),CSS_BOTTOM,HU.px(0)),ATTR_WIDTH,HU.px(120)]);return r+HU.div([ATTR_STYLE,HU.css(CSS_DISPLAY,DISPLAY_INLINE_BLOCK,CSS_POSITION,POSITION_RELATIVE)],o+h+d+g)},doProperties:function(e,t,i,s){let l,a=this;e=e??i?i.getStyle():e;let r="";r+="<center>",r+=HU.div([ATTR_CLASS,"display-button",ATTR_COMMAND,ID_APPLY],LABEL_APPLY),r+=SPACE2,r+=HU.div([ATTR_CLASS,"display-button",ATTR_COMMAND,ID_OK],LABEL_OK),r+=SPACE2,i&&(r+=HU.div([ATTR_CLASS,CLASS_DISPLAY_BUTTON,ATTR_COMMAND,S],LABEL_DELETE),r+=SPACE2),r+=HU.div([ATTR_CLASS,CLASS_DISPLAY_BUTTON,ATTR_COMMAND,ID_CANCEL],LABEL_CANCEL),r+="</center>";let o,n=[];if(i&&i.addToPropertiesDialog(n,e),i&&i.isData()){let e=i?.displayInfo?.display?i.displayInfo.display.getWikiEditorTags():null,t="";if(e){o=getWikiEditorMenuBlocks(e,!0);let i=Utils.getColorTablePopup({itemize:!0});o.push({title:"Color table",items:i});let s=[],l={};o.forEach(((e,t)=>{"string"!=typeof e&&0!=e.items.length&&(l[e.title]||(l[e.title]=!0,s.push(HU.div([ATTR_CLASS,CLASS_CLICKABLE,"blockidx",t],e.title))))})),t=HU.div([],HU.b("Add:"))+HU.div([ATTR_ID,this.domId("displayattrsmenubar"),ATTR_STYLE,HU.css(CSS_MARGIN_LEFT,HU.px(5),CSS_MAX_HEIGHT,HU.px(300),CSS_OVERFLOW_Y,OVERFLOW_AUTO)],Utils.join(s,""))}let s=i.getDisplayAttrs(),l="";Object.keys(s).sort().forEach((e=>{Utils.isDefined(s[e])&&(l+=e+"="+s[e]+"\n")}));let a=HU.textarea("",l,[ATTR_ID,this.domId("displayattrs"),ATTR_ROWS,15,ATTR_COLS,60]);n.push({header:"Display Properties",contents:HU.div([],"One per line")+HU.hbox([a,t])})}let h=this.makeStyleForm(e,i,{isGroup:!0}),d=HU.leftRightTable("",HU.span([ATTR_TITLE,"Apply style actively"],HU.checkbox(this.domId(ID_STYLE_DIALOG_ACTIVE),[ATTR_ID,this.domId(ID_STYLE_DIALOG_ACTIVE)],!1,"Active")))+h.html;n.push({header:"Style",contents:HU.div([ATTR_ID,this.domId(ID_STYLE_DIALOG)],d)}),l=h.props,i&&i.getPropertiesComponent(n);let g,p=r;i?(g=HU.makeTabs(n,{contentsStyle:HU.css(CSS_MIN_HEIGHT,HU.px(400),CSS_MIN_WIDTH,HU.px(750))}),p+=g.contents):p+=HU.center(HU.b("Default Style"))+n[0].contents,p+=r,p=HU.div([ATTR_STYLE,HU.css(CSS_MIN_WIDTH,HU.px(700),CSS_MIN_HEIGHT,HU.px(400)),ATTR_CLASS,"wiki-editor-popup"],p),this.map.ignoreKeyEvents=!0;let c=this.jq(b);0==c.length&&(c=s);let u=HU.makeDialog({content:p,anchor:c,title:"Map Properties"+(i?": "+i.getName():""),header:!0,draggable:!0,resizable:!0});g&&g.init(),i&&i.initSideHelp(u),this.initSideHelp(u),null==t&&(t=()=>{let e={};l.forEach((t=>{let i=this.jq("glyphedit_"+t).val();Utils.stringDefined(i)?(this.setProperty(t,i),"externalGraphic"!=t&&"childIcon"!=t||(i=this.jq(t+"_image").val(),i&&Ramadda.isRamaddaUrl(i)&&(i=Ramadda.getUrl(i))),e[t]=i):this.setProperty(t,null)})),this.glyphTypes.forEach((t=>{t.applyStyle(e,!0)}))});let T=()=>{this.map.ignoreKeyEvents=!1,u.hide(),setTimeout((()=>{u.remove()}),0)},f=!1,y=e=>{f||(f=!0,t(i,l),a.handleGlyphsChanged(),e&&T(),f=!1)},m=()=>{HU.isChecked(this.jq(ID_STYLE_DIALOG_ACTIVE))&&y()};this.jq(ID_STYLE_DIALOG).find(TAG_SELECT).change((function(){m()})),this.jq(ID_STYLE_DIALOG).find(TAG_INPUT).change((function(e){$(this).attr(ATTR_ID)!=a.domId(ID_STYLE_DIALOG_ACTIVE)&&m()})),u.find(HU.dotClass("imdv-style-suffix")).click((function(){let e=$(this).attr(ATTR_PROPERTY),t=$(this).attr(ATTR_WIDGET_ID),s=jqid(t).val();if(s||(s=jqid(t+"_image").val()),e&&s){let t;t=i?[i]:a.glyphs,t.forEach((t=>{t.applyStyleToChildren(e,s,!0)}))}})),u.find(".ramadda-icons-recent").click((function(){let e=$(this).attr("textarea"),t="<img src="+$(this).attr("icon")+">";HU.insertIntoTextarea(e,t)})),this.initLevelRangeSlider(),this.jq("displayattrsmenubar").find("."+CLASS_CLICKABLE).click((function(){let e=o[$(this).attr("blockidx")],t=Utils.join(e.items,"");t=HU.div([ATTR_STYLE,HU.css(CSS_MAX_HEIGHT,HU.px(200),CSS_OVERFLOW_Y,OVERFLOW_AUTO)],t);let i=HU.makeDialog({content:t,anchor:$(this),title:e.title,header:!0,sticky:!1,draggable:!0,modal:!1}),s=e=>{if(!e)return;e=e.trim()+"\n";let t=a.jq("displayattrs").val().trim();""!=t&&(t+="\n"),t+=e,a.jq("displayattrs").val(t)};i.find("[colortable]").click((function(){s("colorTable="+$(this).attr(ATTR_COLORTABLE)),i.remove()})),i.find(HU.dotClass(CLASS_MENU_ITEM)).click((function(){s($(this).attr("data-attribute")),i.remove()}))})),i&&(i.initPropertiesComponent(u),this.initGlyphButtons(u),u.find("#clippathdraw").button().click((function(){let e=a.jq("glyphedit_clippath"),t=HU.div([ATTR_ID,a.domId("clippath_container"),ATTR_STYLE,HU.css(CSS_POSITION,POSITION_RELATIVE,CSS_DISPLAY,DISPLAY_INLINE_BLOCK,CSS_BACKGROUND,COLOR_LIGHT_GRAY)],HU.image(i.style.imageUrl,[ATTR_TITLE,"Click to select point\nshift-click:use previous X\nmeta-click: use previous Y",ATTR_WIDTH,HU.px(600),ATTR_CLASS,"theimage",ATTR_STYLE,HU.css(CSS_CURSOR,CURSOR_POINTER,CSS_BORDER,HU.border(1,COLOR_LIGHT_GRAY))])),s=HU.buttons([HU.div([ATTR_CLASS,HU.classes(CLASS_BUTTON_OK,CLASS_DISPLAY_BUTTON)],LABEL_OK),HU.div([ATTR_CLASS,HU.classes(CLASS_BUTTON_CANCEL,CLASS_DISPLAY_BUTTON)],LABEL_CANCEL)]),l=!0;t=s+HU.div([ATTR_CLASS,"ramadda-button-clear display-button"],"Clear")+HU.space(1)+HU.span([ATTR_CLASS,CLASS_CLICKABLE,ATTR_ID,"pathtry",ATTR_STYLE,HU.css(CSS_WIDTH,HU.em(4))],"Try")+HU.space(1)+HU.input("","",[ATTR_CLASS,"pathoutput",ATTR_SIZE,60,ATTR_STYLE,HU.css(CSS_MARGIN_BOTTOM,HU.em(.5))])+HU.br()+t,t=HU.div([ATTR_STYLE,HU.css(CSS_MARGIN,HU.px(10),CSS_TEXT_ALIGN,ALIGN_CENTER)],t);let r,o,n="",h=HU.makeDialog({content:t,title:"Edit Clip Path",draggable:!0,header:!0,anchor:$(this),my:POS_LEFT_TOP,at:POS_LEFT_BOTTOM}),d=h.find(".pathoutput"),g=h.find(".theimage");g.on("load",(function(){a.jq("clippath_container").append(HU.tag(TAG_CANVAS,[ATTR_ID,a.domId("clippath_canvas"),ATTR_WIDTH,g.width(),ATTR_HEIGHT,g.height(),ATTR_STYLE,HU.css(CSS_POSITION,POSITION_ABSOLUTE,CSS_POINTER_EVENTS,"none",CSS_LEFT,HU.px(0),CSS_TOP,HU.px(0),CSS_BACKGROUND,COLOR_TRANSPARENT)])),r=document.getElementById(a.domId("clippath_canvas")),o=r.getContext("2d"),o.strokeStyle="blue",o.lineWidth=1}));let p=h.find("#pathtry").button();p.click((function(){l?(g.css(CSS_CLIP_PATH,d.val()),$(this).html("Reset")):(g.css(CSS_CLIP_PATH,""),$(this).html("Try")),l=!l})),h.find(".ramadda-button-clear").button().click((()=>{n="",d.val(""),g.css(CSS_CLIP_PATH,""),p.html("Try"),l=!0,o&&o.clearRect(0,0,r.width,r.height)})),h.find(HU.dotClass(CLASS_BUTTON_OK)).button().click((()=>{let t=d.val();h.remove(),e.val(t)})),h.find(HU.dotClass(CLASS_BUTTON_CANCEL)).button().click((()=>{h.remove()}));let c=g.width(),u=g.height(),T=0,f=0;g.mousedown((function(e){let t=$(this).offset(),i=e.pageX-t.left,s=e.pageY-t.top;e.originalEvent.shiftKey&&(i=T),e.originalEvent.metaKey&&(s=f),o&&""!=n&&(o.beginPath(),o.moveTo(T,f),o.lineTo(i,s),o.stroke()),T=i,f=s,""!=n&&(n+=", ");let l=parseInt(i/c*100),a=parseInt(s/u*100);n+=l+"% "+a+"%",d.val("polygon("+n+")")}))})));let _=u.find(".imdv-icons");_.length>0&&this.initIconSelection(_),this.setLevelRangeTick(),u.find(HU.dotClass(CLASS_SLIDER)).each((function(){let e=$(this).attr(ATTR_SLIDER_MIN),t=$(this).attr(ATTR_SLIDER_MAX),i=$(this).attr(ATTR_SLIDER_STEP)??.01;$(this).slider({min:+e,max:+t,step:+i,value:$(this).attr(ATTR_SLIDER_VALUE),slide:function(e,t){let i=$(this).attr(ATTR_SLIDER_ID);jqid(i).val(t.value)},stop:function(e,t){m()}})})),u.find(".ramadda-imdv-color-hidden").on("input",(function(){let e=$(this).attr("baseid"),t=$(this).val();jqid(e).val(t),jqid(e+"_display").css(CSS_BACKGROUND,t),m()})),u.find(".ramadda-imdv-color-select").click((function(){let e=$(this).attr("baseid");jqid(e+"colorinput").click()})),u.find(HU.dotClass(CLASS_IMDV_COLOR)).focus((function(){let e=$(this).attr(ATTR_ID),t=a.makeColorBar(e),i=HU.makeDialog({content:t,header:!1,anchor:$(this),my:POS_LEFT_TOP,at:POS_LEFT_BOTTOM});i.find(".ramadda-color-select").click((function(){let e=$(this).attr(ATTR_COLOR),t=$(this).attr(ATTR_WIDGET_ID);jqid(t).val(e),jqid(t+"_display").css(CSS_BACKGROUND,e),jqid(t+"colorinput").val(e),i.remove(),m()}))})),u.find(HU.dotClass(CLASS_IMDV_COLOR)).change((function(){let e=$(this).val(),t=$(this).attr(ATTR_ID);jqid(t+"_display").css(CSS_BACKGROUND,e),m()})),u.find(".display-button").button().click((function(){let e=$(this).attr(ATTR_COMMAND);switch(e){case ID_OK:y(!0);break;case ID_APPLY:y();break;case ID_CANCEL:T();break;case S:a.removeMapGlyphs([i]),T();break;default:alert("unknown command:"+e)}}))},initLevelRangeSlider:function(){let e=(e,t)=>{this.jq(ID_LEVEL_RANGE_CHANGED).val("changed"),this.jq(ID_LEVEL_RANGE_MIN).val(e),this.jq(ID_LEVEL_RANGE_MAX).val(t),this.jq(ID_LEVEL_RANGE_SAMPLE_MIN).attr(ATTR_SRC,RamaddaUtil.getCdnUrl("/map/zoom/zoom"+e+".png")),this.jq(ID_LEVEL_RANGE_SAMPLE_MAX).attr(ATTR_SRC,RamaddaUtil.getCdnUrl("/map/zoom/zoom"+t+".png"))};this.jq(ID_LEVEL_RANGE_CLEAR).click((()=>{e(this.minLevel,this.maxLevel),this.jq(ID_LEVEL_RANGE_CHANGED).val("cleared"),this.jq(ID_LEVEL_RANGE_SLIDER).slider("values",[this.minLevel,this.maxLevel])})),this.jq(ID_LEVEL_RANGE_SLIDER).slider({range:!0,min:this.minLevel,max:this.maxLevel,values:[parseInt(this.jq(ID_LEVEL_RANGE_MIN).val()??this.minLevel),parseInt(this.jq(ID_LEVEL_RANGE_MAX).val()??this.maxLevel)],slide:(t,i)=>{let s=i.values[0],l=i.values[1];e(s,l)}})},initIconSelection:function(e,t){let i=this;e.each((function(){i.addIconSelection($(this),t)}))},addIconSelection:function(e,t){let i=this.getUsedMarkers(),s=e.attr("icon-property"),l=(e,i)=>{this.jq(s+"_image").attr(ATTR_SRC,e),i?this.jq(s).attr("clearpressed",!0):this.jq(s).attr("clearpressed",!1),this.jq(s).val(e),t&&t(e),Utils.stringDefined(e)&&(Utils.copyToClipboard(e),console.log("icon:"+e+" copied to clipboard"))};if(i.length>0){let e=HU.b("Recent: ");i.forEach((t=>{e+=HU.span([ATTR_CLASS,HU.classes(CLASS_CLICKABLE,"ramadda-icons-recent"),"icon",t],HU.getIconImage(t,[ATTR_WIDTH,HU.px(24)]))})),this.jq("recenticons").html(e),this.jq("recenticons").find(".ramadda-icons-recent").click((function(){l($(this).attr("icon"))}))}HU.getEmojis((t=>{let i=HU.getUniqueId("icons_"),s="";t.forEach((e=>{""!=s&&(s+=HU.close(TAG_DIV)),s+=HU.open(TAG_DIV,[ATTR_CLASS,"ramadda-imdv-image-category"]),s+=HU.div([ATTR_CLASS,"ramadda-imdv-image-category-label"],HU.b(e.name)),e.images.forEach((t=>{s+=HU.image(t.image,[ATTR_CLASS,HU.classes(CLASS_CLICKABLE,"ramadda-imdv-image"),ATTR_WIDTH,HU.px(24),ATTR_STYLE,HU.css(CSS_MARGIN_RIGHT,HU.px(4),CSS_MARGIN_BOTTOM,HU.px(2)),ATTR_DATA_CORPUS,e.name,ATTR_LOADING,LOADING_LAZY,ATTR_TITLE,t.name])}))})),s+=HU.close(TAG_DIV),s=HU.div([ATTR_STYLE,HU.css(CSS_BORDER,CSS_BASIC_BORDER,CSS_MARGIN_TOP,HU.px(5),CSS_PADDING,HU.px(5),CSS_WIDTH,HU.px(400),CSS_MAX_HEIGHT,HU.px(200),CSS_OVERFLOW_Y,OVERFLOW_AUTO)],s),s=HU.input("","",[ATTR_ID,i+"_search",ATTR_PLACEHOLDER,LABEL_SEARCH,ATTR_SIZE,30])+" "+HU.span([ATTR_CLASS,HU.classes(CLASS_CLICKABLE,"ramadda-imdv-image-delete")],"Clear")+HU.space(2)+HU.span([ATTR_CLASS,HU.classes(CLASS_CLICKABLE,"ramadda-imdv-image-add")],"Set URL")+HU.br()+s,e.html(s),e.find(".ramadda-imdv-image-delete").button().click((()=>{l("",!0)})),e.find(".ramadda-imdv-image-add").button().click((()=>{let e=prompt("Image URL:");e&&l(e)}));let a=e.find(".ramadda-imdv-image");a.click((function(){l($(this).attr(ATTR_SRC))}));let r=e.find(".ramadda-imdv-image-category"),o=e=>{a.each((function(){let t=!0;if(e){t=!1,($(this).attr(ATTR_TITLE).toLowerCase()+" "+($(this).attr(ATTR_DATA_CORPUS)??"").toLowerCase()).indexOf(e)>=0&&(t=!0)}$(this).attr("imagevisible",t),t?$(this).show():$(this).fadeOut()})),r.each((function(){let e=!1;$(this).find(".ramadda-imdv-image").each((function(){"true"==$(this).attr("imagevisible")&&(e=!0)}));let t=$(this).find(".ramadda-imdv-image-category-label");e?t.show():t.fadeOut()}))};jqid(i+"_search").keyup((function(){o($(this).val())}))}))},doSaveAs:function(){let e=prompt("New entry name:");if(!e)return;let t={name:e,type:"geo_editable_json",group:this.getProperty("parentEntryId"),authtoken:this.getProperty("authToken"),response:"json"},i=Ramadda.getUrl("/entry/change");$.post(i,t,(e=>{if(e.entries&&e.entries.length)return this.setProperty("entryId",e.entries[0]),this.doSave(),void this.showMessage("Saved");this.clearFeatureChanged(),e.error?this.showMessage(e.error):this.showMessage(e.message)})).fail((function(e,t,i){console.log("fail:"+result),this.showMessage("failed to save map:"+t+" "+i)}))},doSave:function(){let e=this;if("geo_editable_json"!=this.getProperty("thisEntryType")&&"geo_imdv"!=this.getProperty("thisEntryType"))return void this.showMessage("Entry is not the correct type");let t=this.makeJson(),i=Ramadda.getUrl("/entry/setfile"),s=new FormData;s.append(ARG_ENTRYID,this.getProperty("entryId")),s.append(ARG_AUTHTOKEN,this.getProperty("authToken")),s.append(ARG_FILE,t);let l=this.getFullBounds(!0);l&&s.append("bounds",l.top+","+l.left+","+l.bottom+","+l.right),$.ajax({url:i,cache:!1,data:s,processData:!1,contentType:!1,type:"POST",enctype:"multipart/form-data",success:function(t){t.error?e.showMessage(t.error):(e.clearFeatureChanged(),e.showMessage(t.message))}}).fail((function(t,i,s){e.showMessage("failed to save map:"+i+" "+s)}))},loadIMDVUrl:function(e,t,i){$.ajax({url:e,cache:!1,dataType:"text",success:e=>{""==e&&(e="[]");let s=JSON.parse(e);this.loadIMDVJson(s,this.map,i),t&&t()}}).fail((e=>{t&&t(),this.handleError(e)}))},doImport:function(){let e={title:"Select IMDV entry to import",callback:e=>{let t=HU.url(Ramadda.getUrl(URL_ENTRY_GET),ARG_ENTRYID,e);this.showProgress("Importing map...");this.loadIMDVUrl(t,(()=>{this.clearMessage2(),this.getMap().clearAllProgress(),this.featureChanged(!0)}))},eventSourceId:this.domId(b),typeLabel:"IMDV Entries"};this.selector=RamaddaUtils.selectCreate(null,HU.getUniqueId(""),"",!1,ARG_ENTRYID,this.getProperty("entryId"),"geo_imdv",null,e)},doDownload:function(){let e=this.makeJson();Utils.makeDownloadFile("imdvmap.json",e)},makeJson:function(){let e=[];this.getGlyphs().forEach((t=>{let i=t.makeJson();e.push(i)}));let t=this.getMap().getBounds(),i=(this.getMap().transformLLBounds(t),{mapProperties:this.mapProperties||{},glyphs:e,zoomLevel:this.getCurrentLevel(),bounds:{north:t.top,west:t.left,south:t.bottom,east:t.right}}),s=this.getMap().getMap().baseLayer?.ramaddaId;return s&&(i.baseLayer=s),JSON.stringify(i)},makeBox:function(e){e=e??GLYPH_BOX;let t="",i=HU.css(CSS_MARGIN,HU.px(1)),s=this.dialogRectangle??{};t+=HU.center(HU.input("",s.n,[ATTR_STYLE,i,ATTR_ID,this.domId("_north"),ATTR_SIZE,6,ATTR_PLACEHOLDER,"North"])),t+=HU.input("",s.w,[ATTR_STYLE,i,ATTR_ID,this.domId("_west"),ATTR_SIZE,6,ATTR_PLACEHOLDER,"West"]),t+=HU.input("",s.e,[ATTR_STYLE,i,ATTR_ID,this.domId("_east"),ATTR_SIZE,6,ATTR_PLACEHOLDER,"East"]),t+=HU.center(HU.input("",s.s,[ATTR_STYLE,i,ATTR_ID,this.domId("_south"),ATTR_SIZE,6,ATTR_PLACEHOLDER,"South"])),t+=HU.buttons([HU.div([ATTR_CLASS,HU.classes(CLASS_BUTTON_OK,CLASS_DISPLAY_BUTTON)],LABEL_OK),HU.div([ATTR_CLASS,HU.classes(CLASS_BUTTON_CANCEL,CLASS_DISPLAY_BUTTON)],LABEL_CANCEL)]),t=HU.div([ATTR_CLASS,CLASS_DIALOG],t);let l=HU.makeDialog({content:t,anchor:this.domId(I),draggable:!0,title:"Make box",header:!0});l.find(HU.dotClass(CLASS_BUTTON_OK)).button().click((()=>{let t=this.dialogRectangle={n:this.jq("_north").val(),w:this.jq("_west").val(),s:this.jq("_south").val(),e:this.jq("_east").val()};this.createBox(t.n,t.w,t.s,t.e,e),l.remove()})),l.find(HU.dotClass(CLASS_BUTTON_CANCEL)).button().click((()=>{l.remove()}))},createBox:function(e,t,i,s,l,a){let r={geometryType:"OpenLayers.Geometry.Polygon",points:[e,t,e,s,i,s,i,t]},o=Utils.clone(this.boxStyle);a&&(o=Utils.clone(o,a));let n=new MapGlyph(this,l??GLYPH_BOX,{type:l},null,o,!0,r);this.addGlyph(n),n.panMapTo()},loadIMDVJson:function(e,t,i){(e.glyphs||[]).forEach(((e,t)=>{let s=this.makeGlyphFromJson(e);s&&(i?i.addChildGlyph(s):this.addGlyph(s,!0))})),this.getMapProperty("mapLegendPosition")&&this.createMapLegendWrapper(),this.editState=null,this.clearFeatureChanged(),this.checkMapProperties(),this.makeMenuBar(),this.makeControls(),this.makeLegend(),this.showMapLegend(),this.checkVisible()},makeGlyphFromJson:function(e){let t=e.mapOptions;t||(t={type:e.type}),Utils.isDefined(t.showmultidata)&&(t.showdataicons=t.showmultidata,delete t.showmultidata),t.id=e.id;let i=e.type||t.type;"label"==i&&(t.type=i=GLYPH_MARKER);let s=this.getGlyphType(i);if(!s)return console.log("no type:"+i,e),null;let l=$.extend({},s.getStyle());if(e.style&&$.extend(l,e.style),l=$.extend({},l),Utils.stringDefined(l.externalGraphic)&&(this.markers[l.externalGraphic]=!0),Utils.stringDefined(l.popupText),l.cursor=CURSOR_POINTER,s.isData()){let e=new MapGlyph(this,t.type,t,null,l);return e.addData(t.displayAttrs,!1),e}if(s.isMultiEntry()){let e=new MapGlyph(this,t.type,t,null,l);return e.addEntries(),e}if(s.isFixed()){let e=new MapGlyph(this,t.type,t,null,l);return e.addFixed(),e}if(s.isZoom()){return new MapGlyph(this,t.type,t,null,l)}if(s.isGroup()){let i=new MapGlyph(this,t.type,t,null,l);return i.loadJson(e),i}if(s.isMap()){let e=new MapGlyph(this,t.type,t,null,l);return e.checkMapLayer(!1),e}if(s.isMapServer()){let e=new MapGlyph(this,t.type,t,null,l);return e.checkMapServer(!1),e}let a=e.points;if(!a||0==a.length)return console.dir("No points defined for glyph:",s.type),console.dir(e),null;try{return new MapGlyph(this,t.type,t,null,l,!0,e)}catch(e){this.handleError("Error creating glyph",e),console.log(e)}return console.log("Couldn't make feature:"+t.type),null},doMapProperties:function(){this.mapProperties||(this.mapProperties={});let e=[],t=HU.buttons([HU.div([ATTR_CLASS,HU.classes(CLASS_BUTTON_APPLY,CLASS_DISPLAY_BUTTON)],LABEL_APPLY),HU.div([ATTR_CLASS,HU.classes(CLASS_BUTTON_OK,CLASS_DISPLAY_BUTTON)],LABEL_OK),HU.div([ATTR_CLASS,HU.classes(CLASS_BUTTON_CANCEL,CLASS_DISPLAY_BUTTON)],LABEL_CANCEL)]),i=[HU.checkbox(this.domId("showopacityslider"),[],this.getMapProperty(PROP_SHOWOPACITYSLIDER,this.getShowOpacitySlider()),"Show Opacity Slider"),HU.checkbox(this.domId("showgraticules"),[],this.getMapProperty("showGraticules",!1),"Show Graticules"),HU.checkbox(this.domId("showoverviewmap"),[],this.getMapProperty("showOverviewMap",!1),"Show Overview Map"),HU.checkbox(this.domId("showmouseposition"),[],this.getMapProperty("showMousePosition",!1),"Show Mouse Position"),HU.checkbox(this.domId("showaddress"),[],this.getMapProperty("showAddress",!1),"Show Address Search"),HU.checkbox(this.domId("usercanchange"),[ATTR_TITLE,"Non logged in users can add glyphs and change styles but can't save"],this.getMapProperty("userCanChange",!1),"Anon. users can change")],s="";s+=Utils.join(i,HU.br());let l=HU.formTable();l+=HU.formEntryLabel("Legend position",HU.select("",[ATTR_ID,this.domId("legendposition")],[{label:"Left",value:"left"},{label:"Right",value:"right"},{label:"In Map",value:"map"},{label:"Editor",value:"editor"},{label:"None",value:"none"}],this.getMapProperty("legendPosition","left"))),l+=HU.formEntryLabel("Legend width",HU.input("",this.getMapProperty("legendWidth",""),[ATTR_ID,this.domId("legendwidth"),ATTR_SIZE,"4"])),l+=HU.formTableClose(),l+=HU.checkbox(this.domId("showbasemapselect"),[],this.getMapProperty("showBaseMapSelect"),"Show Base Map Select"),s=HU.table([],HU.tr([ATTR_VALIGN,ALIGN_TOP],HU.td([],s)+HU.td([ATTR_WIDTH,HU.perc(50)],l))),s+=HU.p(),s+=this.getLevelRangeWidget(this.getMapProperty(PROP_LEVELRANGE_RANGE),this.getMapProperty(PROP_LEVELRANGE_SHOWMARKER)),e.push({header:"Basic",contents:s}),e.push({header:"Header/Footer",contents:HU.b("Top Wiki Text:")+HU.br()+HU.textarea("",this.getMapProperty("topWikiText",""),[ATTR_ID,this.domId("topwikitext_input"),ATTR_ROWS,4,ATTR_COLS,70])+HU.br()+HU.b("Bottom Wiki Text:")+HU.br()+HU.textarea("",this.getMapProperty("bottomWikiText",""),[ATTR_ID,this.domId("bottomwikitext_input"),ATTR_ROWS,4,ATTR_COLS,70])+HU.br()});let a=this.getMapProperty("otherProperties",""),r=["legendLabel=Some label","showViewInLegend=true",...IMDV_PROPERTY_HINTS,"dragPanEnabled=false","zoomPanEnabled=false","addCurrentLocationMarker=true","centerOnCurrentLocation=true","currentLocationUpdateTime=seconds","showAddress=true","graticuleStyle=strokeColor:#000,strokeWidth:1,strokeDashstyle:dot"],o=HU.b("Add property: ")+HU.span([ATTR_ID,this.domId("propsearch")])+this.makeSideHelp(r,this.domId("otherproperties_input"),{suffix:"\n"});e.push({header:"Other Properties",contents:HU.hbox([HU.textarea("",a,[ATTR_ID,this.domId("otherproperties_input"),ATTR_ROWS,8,ATTR_COLS,40]),HU.space(2),o])});let n=HU.makeTabs(e),h=t+n.contents;h=HU.div([ATTR_STYLE,HU.css(CSS_MIN_WIDTH,HU.px(800),CSS_MIN_HEIGHT,HU.px(350),CSS_MARGIN,HU.px(10))],h);let d=this.jq(b),g=HU.makeDialog({content:h,title:"Properties",header:!0,my:POS_LEFT_TOP,at:POS_LEFT_BOTTOM,draggable:!0,anchor:d});this.initSideHelp(g),this.initLevelRangeSlider(),n.init();let p=()=>{g.hide(),g.remove()},c=()=>{this.setMapProperty("userCanChange",HU.isChecked(this.jq("usercanchange")),PROP_SHOWOPACITYSLIDER,HU.isChecked(this.jq("showopacityslider")),"showGraticules",HU.isChecked(this.jq("showgraticules")),"showOverviewMap",HU.isChecked(this.jq("showoverviewmap")),"showMousePosition",HU.isChecked(this.jq("showmouseposition")),"showAddress",HU.isChecked(this.jq("showaddress")),"legendPosition",this.jq("legendposition").val(),"legendWidth",this.jq("legendwidth").val(),"showBaseMapSelect",HU.isChecked(this.jq("showbasemapselect")),"topWikiText",this.jq("topwikitext_input").val(),"bottomWikiText",this.jq("bottomwikitext_input").val(),"otherProperties",this.jq("otherproperties_input").val()),this.propertyCache={},this.parsedMapProperties=null;let e=null,t=null;"changed"==this.jq(ID_LEVEL_RANGE_CHANGED).val()&&(console.log("changed"),e=this.jq(ID_LEVEL_RANGE_MIN).val(),t=this.jq(ID_LEVEL_RANGE_MAX).val(),""==e&&(e=null),""==t&&(t=null),this.setMapProperty(PROP_LEVELRANGE_RANGE,{min:e,max:t})),"cleared"==this.jq(ID_LEVEL_RANGE_CHANGED).val()&&this.setMapProperty(PROP_LEVELRANGE_RANGE,null),this.setMapProperty(PROP_LEVELRANGE_SHOWMARKER,HU.isChecked(this.jq(PROP_LEVELRANGE_SHOWMARKER))),this.checkMapProperties(),this.makeLegend(),this.featureChanged(!0)};HU.initPageSearch(HU.dotClass(CLASS_IMDV_PROPERTY),this.domId("otherproperties_input"),null,!0,{target:"#"+this.domId("propsearch")}),g.find(HU.dotClass(CLASS_BUTTON_APPLY)).button().click((()=>{c()})),g.find(HU.dotClass(CLASS_BUTTON_OK)).button().click((()=>{c(),p()})),g.find(HU.dotClass(CLASS_BUTTON_CANCEL)).button().click((()=>{p()}))},checkMapProperties:function(){if(this.mapProperties=this.mapProperties??{},this.checkOpacitySlider(),this.checkTopWiki(),!this.getMap())return;this.getMap().applyHighlightStyle(this.getOtherProperties());let e=this.getMapProperty("graticuleStyle");if(Utils.stringDefined(e))try{let t={};e.split(",").forEach((e=>{let i=e.split(":");if(2==i.length){let e=i[0].trim(),s=i[1].trim();"strokeWidth"==e&&(s=parseInt(s)),t[e]=s}})),e=t}catch(t){console.log("Error parsing graticule style:"+e+"\n\terror:"+t)}this.getMap().setGraticulesVisible(this.getMapProperty("showGraticules"),e),this.getMap().setShowOverviewMap(this.getMapProperty("showOverviewMap")),this.getMapProperty("showMousePosition")?this.getMap().initMousePositionReadout():this.getMap().destroyMousePositionReadout(),this.map.setDragPanEnabled(this.getMapProperty("dragPanEnabled",!0)),this.map.setZoomPanEnabled(this.getMapProperty("zoomPanEnabled",!0)),this.checkCurrentLocation()},xcnt:0,geoOptions:{enableHighAccuracy:!0,maximumAge:3e4,timeout:27e3},checkCurrentLocation:function(){this.currentLocationMarker&&(this.getMap().removeMarker(this.currentLocationMarker),this.currentLocationMarker=null),this.getMapProperty("addCurrentLocationMarker",!1)&&(navigator.geolocation?(navigator.geolocation.getCurrentPosition((e=>{let t=e.coords.latitude,i=e.coords.longitude,s=MapUtils.createLonLat(i,t);this.currentLocationMarker&&(this.getMap().removeMarker(this.currentLocationMarker),this.currentLocationMarker=null);let l="<center><h2>Current Location</h2></center>";this.isIsolineEnabled()&&(l+=HU.onClick("ImdvUtils.getImdv('"+this.getId()+"').addIsolineForCurrentMarker()",HU.getIconImage("fa-regular fa-circle-dot")+" Add Isoline")),this.currentLocationMarker=this.getMap().addMarker("location",s,null,"",l,20,20),this.getMapProperty("centerOnCurrentLocation")&&this.getMap().setCenter(s)}),(e=>{console.error(e)}),this.geoOptions),this.checkCurrentLocationTimeout&&clearTimeout(this.checkCurrentLocationTimeout),Utils.isDefined(this.getMapProperty("currentLocationUpdateTime"))&&(this.checkCurrentLocationTimeout=setTimeout((()=>{this.checkCurrentLocation()}),1e3*parseFloat(this.getMapProperty("currentLocationUpdateTime",30))))):console.log("no navigator.geolocation available"))},checkOpacitySlider:function(){let e;e=Utils.isDefined(this.getMapProperty(PROP_SHOWOPACITYSLIDER))?this.getMapProperty(PROP_SHOWOPACITYSLIDER):this.getShowOpacitySlider(!1),this.getMap().showOpacitySlider(e)},showFileMenu:function(e){let t="",i=HU.div([ATTR_CLASS,"ramadda-menu-divider"]);this.canEdit()&&(t+=this.menuItem(this.domId(M),"Save","S")),t+=this.menuItem(this.domId(k),"Download"),t+=i,t+=this.menuItem(this.domId(F),"Import"),t+=i,t+=this.menuItem(this.domId(O),"List Features..."),t+=this.menuItem(this.domId(x),"Clear Commands","Esc"),t+=i,t+=this.menuItem(this.domId(w),"Set Default Style..."),t+=this.menuItem(this.domId(Q),"Properties..."),t+=i,t+=HU.href(Ramadda.getUrl("/userguide/imdv/index.html"),"Help",[ATTR_TARGET,"_help"]),t=this.makeMenu(t),this.dialog=HU.makeDialog({content:t,anchor:e});let s=()=>{this.clearCommands(),HU.hidePopupObject(null,!0)};this.jq("navigate").click((()=>{s(),this.setCommand(null)})),this.jq(Q).click((()=>{s(),this.doMapProperties()})),this.jq(M).click((()=>{s(),this.doSave()})),this.jq("saveas").click((()=>{s(),this.doSaveAs()})),this.jq(k).click((()=>{s(),this.doDownload()})),this.jq(F).click((()=>{s(),this.doImport()})),this.jq(w).click((()=>{s(),this.doProperties()})),this.jq("refresh").click((()=>{s(),ImdvUtils.scheduleRedraw(this.myLayer)})),this.jq(x).click((()=>{s(),this.unselectAll()})),this.jq(O).click((()=>{s(),this.listFeatures()}))},getZoomImage:function(e){return RamaddaUtil.getCdnUrl("/map/zoom/zoom"+e+".png")},makeViewMenu:function(e,t,i){let s="";i||(i=(e,t)=>this.menuItem(e,t));let l=(t,s,l)=>HU.span([ATTR_TITLE,s],i(t,((t,i)=>e?(i?HU.getIconImage(i):HU.div([ATTR_STYLE,HU.css(CSS_DISPLAY,DISPLAY_INLINE_BLOCK,CSS_WIDTH,HU.px(20))]))+HU.space(1)+HU.span([],t):HU.getIconImage(i))(s,l)));return t=t??"",this.initialLocation&&(s+=l(this.domId(se+t),"Initial View","fas fa-house")),s+=l(this.domId(ie+t),"Set View to All","fas fa-eye"),navigator.geolocation&&(s+=l(this.domId(le+t),"Your Location","fas fa-street-view")),s+=l(this.domId(ee+t),"Regions","fas fa-map"),s+=l(this.domId(te+t),"Set Location/Zoom","fas fa-compass"),s+=HU.thinLine(),s+=l(this.domId(p+t),"Toggle all off","fas fa-toggle-off"),s+=l(this.domId(g+t),"Toggle all on","fas fa-toggle-on"),s},initViewMenu:function(e,t){let i=this;e=e??"";let s=()=>{this.clearCommands(),HU.hidePopupObject(null,!0)};this.jq(p+e).click((()=>{this.glyphs.forEach(((e,t)=>{e.setVisible(!1,!0)}))})),this.jq(g+e).click((()=>{this.glyphs.forEach(((e,t)=>{e.setVisible(!0,!0)}))})),this.jq(te+e).click((function(){s();let e=HU.formTable();e+=HU.formEntryLabel("Latitude",HU.input("","",[ATTR_ID,i.domId("choose_latitude")])),e+=HU.formEntryLabel("Longitude",HU.input("","",[ATTR_ID,i.domId("choose_longitude")]));let l=[2,3,4,5,6,7,8,9,10,11,13,14,15,16,17,18].map((e=>({label:e,value:e,image:i.getZoomImage(e)}))),a="";l.forEach((e=>{a+=HU.div([ATTR_STYLE,HU.css(CSS_MARGIN_BOTTOM,HU.px(2))],HU.image(e.image,["data-level",e.value,ATTR_TITLE,"Level:"+e.value,ATTR_WIDTH,HU.px(100),ATTR_CLASS,CLASS_CLICKABLE]))})),a=HU.div([ATTR_STYLE,HU.css(CSS_TEXT_ALIGN,ALIGN_CENTER,CSS_MAX_HEIGHT,HU.px(300),CSS_OVERFLOW_Y,OVERFLOW_AUTO)],a),e+=HU.hidden("",i.getCurrentLevel(),[ATTR_ID,i.domId("choose_zoom_value")]);let r=HU.div([ATTR_ID,i.domId("choose_zoom_button")],HU.image(i.getZoomImage(i.getCurrentLevel()),[ATTR_TITLE,"Click to select level",ATTR_ID,i.domId("choose_zoom_image"),ATTR_WIDTH,HU.px(100),ATTR_CLASS,CLASS_CLICKABLE]));e+=HU.formEntryLabel("Zoom Level",r),e+=HU.formTableClose();let o=HU.div([ATTR_CLASS,HU.classes(CLASS_BUTTON_APPLY,CLASS_DISPLAY_BUTTON)],LABEL_APPLY)+SPACE2+HU.div([ATTR_CLASS,HU.classes(CLASS_BUTTON_OK,CLASS_DISPLAY_BUTTON)],LABEL_OK)+SPACE2+HU.div([ATTR_CLASS,HU.classes(CLASS_BUTTON_CANCEL,CLASS_DISPLAY_BUTTON)],LABEL_CANCEL);e+=HU.center(o),e=HU.div([ATTR_CLASS,CLASS_DIALOG],e);let n,h=HU.makeDialog({content:e,anchor:t??$(this),draggable:!0,title:"Set Location/Zoom",header:!0});i.jq("choose_zoom_button").click((function(){n&&n.remove(),n=HU.makeDialog({content:a,anchor:$(this),header:!0,title:SPACE2+"Select Zoom Level"}),n.find(HU.dotClass(CLASS_CLICKABLE)).click((function(){let e=$(this).attr("data-level");i.jq("choose_zoom_value").val(e),i.jq("choose_zoom_image").attr(ATTR_SRC,$(this).attr(ATTR_SRC)),n.remove(),n=null}))})),h.find(HU.dotClass(CLASS_DISPLAY_BUTTON)).button().click((function(){if($(this).hasClass(CLASS_BUTTON_OK)||$(this).hasClass(CLASS_BUTTON_APPLY)){let e=i.jq("choose_latitude").val().trim(),t=i.jq("choose_longitude").val().trim();if(""!=e&&""!=t){let s=MapUtils.createLonLat(t,e);i.getMap().setCenter(s)}i.getMap().setZoom(parseInt(i.jq("choose_zoom_value").val()))}$(this).hasClass(CLASS_BUTTON_APPLY)||(n&&n.remove(),h.remove())}))})),this.jq(ie+e).click((()=>{s(),this.zoomToLayers()})),this.jq(se+e).click((()=>{s(),this.initialLocation?.zoomLevel>=0&&Utils.isDefined(this.initialLocation?.zoomLevel)&&this.getMap().setZoom(this.initialLocation?.zoomLevel),this.initialLocation?.bounds&&this.map.getMap().setCenter(this.initialLocation?.bounds.getCenterLonLat())})),this.jq(le+e).click((()=>{s(),navigator.geolocation.getCurrentPosition((e=>{let t=e.coords.latitude,i=e.coords.longitude,s=MapUtils.createLonLat(i,t);this.getMap().setCenter(s),this.getMap().setZoom(8)}),(e=>{console.error(e)}),this.geoOptions)})),this.jq(ee+e).click((function(){s(),i.initRegionsSelector(t??$(this))}))},showViewMenu:function(e){let t="";HU.div([ATTR_CLASS,"ramadda-menu-divider"]);t+=this.makeViewMenu(!0),t=this.makeMenu(t),this.dialog=HU.makeDialog({content:t,anchor:e}),this.initViewMenu(null,this.jq(D))},getFullBounds:function(e){let t=null;return this.getGlyphs().forEach(((e,i)=>{t=MapUtils.extendBounds(t,e.getBounds())})),t&&e&&(t=this.getMap().transformProjBounds(t)),t},zoomToLayers:function(){let e=this.getFullBounds();e&&this.getMap().zoomToExtent(e)},handleEditEvent:function(){1!=this.getSelected().length?this.setCommand(Y):this.doEdit(this.getSelected()[0])},getDecoration:function(e){let t=e.strokeColor??"black",i="solid";e.strokeDashstyle&&(["dot","dashdot"].includes(e.strokeDashstyle)?i="dotted":e.strokeDashstyle.indexOf("dash")>=0&&(i="dashed"));let s="";t&&(s=HU.css(CSS_BORDER_BOTTOM,HU.border(3,t,i)));let l=HU.css(CSS_WIDTH,HU.px(30),CSS_HEIGHT,HU.px(6));return HU.div([ATTR_STYLE,HU.css(CSS_MARGIN_BOTTOM,HU.px(5),CSS_MARGIN_RIGHT,HU.px(5),CSS_DISPLAY,DISPLAY_INLINE_BLOCK)+l+s])},showMapLegend:function(){if(!this.getShowMapLegend(!0))return;let e=this,t="",i={};this.getGlyphs().forEach(((e,s)=>{if(e.getType()!=GLYPH_ROUTE&&e.getType()!=GLYPH_FREEHAND)return;let l=e.getFeature();if(!l)return;let a=this.getDistances(e.getGeometry(),e.getType(),!0),r=HU.getUniqueId("feature_");l.legendId=r,i[r]=e;let o=this.getDecoration(l.style)+a;t+=HU.div([ATTR_CLASS,CLASS_CLICKABLE,ATTR_ID,r],o)})),""!=t&&(t=HU.div([ATTR_STYLE,HU.css(CSS_PADDING,HU.px(5),CSS_BORDER,CSS_BASIC_BORDER,CSS_BACKGROUND_COLOR,COLOR_MELLOW_YELLOW)],t)),this.jq(h).html(t),this.jq(h).find("."+CLASS_CLICKABLE).click((function(){let t=$(this).attr(ATTR_ID);e.selectGlyph(i[t])}))},featureChanged:function(e){this.featureHasBeenChanged=!0},clearFeatureChanged:function(){this.featureHasBeenChanged=!1},showNewMenu:function(e){let t=this,i="<table><tr valign=top><td>";Utils.splitList(this.glyphTypes,this.glyphTypes.length/3);this.glyphTypes.forEach((e=>{if("map"!=e.type&&"freehand"!=e.type||(i+=HU.tag(TAG_TD,[],SPACE)+HU.open(TAG_TD)),!e.handler)return;let t=e.options.icon||Ramadda.getCdnUrl("/map/marker-blue.png"),s=HU.image(t,[ATTR_WIDTH,16])+SPACE1+e.getName();e.getTooltip()&&(s=HU.span([ATTR_TITLE,e.getTooltip()],s)),i+=this.menuItem(this.domId("menunew_"+e.type),s+SPACE2)})),i+=HU.close(TAG_TD,TAG_TR,TAG_TABLE),i=this.makeMenu(i),this.dialog=HU.makeDialog({content:i,anchor:e}),this.glyphTypes.forEach((e=>{this.jq("menunew_"+e.type).click((function(){HU.hidePopupObject(null,!0),t.setCommand(e.type,{newGlyph:!0})}))}))},showEditMenu:function(e){let t=[[C,"Cut","X"],[E,"Copy","C"],[H,"Paste","V"],null,[G,"Select"],[B,"Select All","A"],null,[V,"Move",UNIT_M],[W,"Reshape"],[q,"Resize"],[j,"Rotate"],null,[U,"To Front","F"],[L,"To Back","B"],null,[Y,"Edit Properties","P"]].reduce(((e,t)=>(e=e||"",t?e+this.menuItem(this.domId(t[0]),t[1],t[2]):e+HU.div([ATTR_CLASS,"ramadda-menu-divider"]))),"");this.dialog=HU.makeDialog({content:this.makeMenu(t),anchor:e});let i=()=>{HU.hidePopupObject(null,!0)};this.jq(C).click((()=>{i(),this.doCut()})),this.jq(B).click((()=>{i(),this.selectAll()})),this.jq(E).click((()=>{i(),this.doCopy()})),this.jq(H).click((()=>{i(),this.doPaste()})),this.jq(Y).click((()=>{i(),this.handleEditEvent()})),[G,V,W,q,j].forEach((e=>{this.jq(e).click((()=>{i(),this.setCommand(e)}))}))},checkSelected:function(e){e.isSelected()&&(this.unselectGlyph(e),this.selectGlyph(e))},unselectGlyph:function(e){e&&e.unselect()},selectGlyph:function(e,t,i){return e.select(t,i)},toggleSelectGlyph:function(e){e.isSelected()?this.unselectGlyph(e):this.selectGlyph(e)},selectFeatures:function(e,t,i,s){let l=0;if(!t||0==t.length)return l;let a=[];t.forEach((e=>{if(!e.geometry)return;let t=e.geometry.getVertices();a.push(...t)}));let r=0;return a.length>i&&(r=Math.round(a.length/i)),s&&console.log(a.length,r),a.forEach(((t,i)=>{if(r>0&&i>0&&i!=a.length-1&&i%r!=0)return;t=MapUtils.createPoint(t.x,t.y);let s=MapUtils.createVector(t,null,this.DOT_STYLE);e.selectDots.push(s),l++})),l},getSelected:function(){let e=[];return this.getGlyphs().forEach((t=>{t.getSelected(e)})),e},selectAll:function(){this.getGlyphs().forEach((e=>{this.selectGlyph(e,20,!0)}))},unselectAll:function(e){this.getGlyphs().forEach((t=>{e!=t&&this.unselectGlyph(t)}))},setClipboard:function(e){this.clipboard=e?e.map((e=>e)):null,this.pasteCount=0},removeImages:function(e){e&&e.forEach((e=>{e.removeImage()}))},clearBounds:function(e){e.clearBounds&&e.clearBounds(),e.components&&e.components.forEach((e=>{this.clearBounds(e)}))},changeOrder:function(e,t){let i=t?[t]:this.getSelected();i&&0!=i.length&&(i.forEach((t=>{e?Utils.toFront(this.getGlyphs(),t):Utils.toBack(this.getGlyphs(),t),t.changeOrder(e)})),this.featureChanged(),this.redraw())},moveGlyphBefore:function(e,t,i){Utils.moveBefore(i??this.glyphs,e,t),t.changeOrder(!1),this.featureChanged(),this.redraw()},doCut:function(){let e=this.getSelected();if(e.length>0){this.removeImages(e);let t=e.map((e=>e));this.setClipboard(t),this.removeMapGlyphs(t)}this.clearCommands()},doCopy:function(){0!=this.getSelected().length&&this.setClipboard(this.getSelected().map((e=>e)))},addGlyphType:function(e){this.glyphTypes.push(e),this.glyphTypeMap[e.getType()]=e},getGlyphType:function(e){return this.glyphTypeMap[e]},createMapGlyph:function(e,t,i){t=t??{};let s=this.addMapLayer(e,t,i);if(s)return s.style=t,s},createMapLayer:function(e,t,i,s){let l;l=t.resourceUrl?t.resourceUrl.indexOf("ramadda.org")>=0?HU.url(Ramadda.getUrl(URL_PROXY),ARG_URL,t.resourceUrl):t.resourceUrl:HU.url(Ramadda.getUrl(URL_ENTRY_GET),ARG_ENTRYID,t.entryId),l=l.replace(/\${root}/,RamaddaUtil.getBaseUrl()),e.setDownloadUrl(l);let a=(t,i,s)=>{Utils.stringDefined(this.command)||e.featureSelected(t,i,s)},r=(t,i,s)=>{e.featureUnselected(t,i,s)},o=(e,t)=>{this.handleError(t,e)},n=(e,t)=>{t.mapGlyph&&(t.mapGlyph.handleMapLoaded(e,t),t.mapGlyph.panMapToPending&&(t.mapGlyph.panMapToPending=!1,t.mapGlyph.panMapTo(!1))),this.makeLegend()};switch(t.entryType){case"stacimage":let h,d,g,p;4==t.bbox.length?[h,d,g,p]=t.bbox:[h,d,lowest,g,p,highest]=t.bbox;let c=2048,u=1024;p<-90&&([d,h,p,g]=t.bbox);let T=this.getMap().addImageLayer("",t.name,"",l,!0,p,h,d,g,c,u,{},n);return T.mapGlyph=e,e.initImageLayer(T),e.handleMapLoaded(this.getMap(),T),s&&this.getMap().zoomToLayer(T),T;case"latlonimage":let f=2048,y=1024;return this.getMap().addImageLayer(t.entryId,t.name,"",l,!0,t.north,t.west,t.south,t.east,f,y);case"geo_gpx":return this.getMap().addGpxLayer(t.name,l,!0,a,r,i,n,s,o);case"geo_shapefile_fips":case"geo_shapefile":l=HU.url(Ramadda.getUrl(URL_ENTRY_SHOW),ARG_ENTRYID,t.entryId,ARG_OUTPUT,"geojson.geojson","formap",!0);case"geo_geojson":return this.getMap().addGeoJsonLayer(t.name,l,!0,a,r,i,n,s,o);case"geo_kml":let m=(e,t)=>{t.features&&t.features.forEach((e=>{ImdvUtils.applyFeatureStyle(e,i)})),n(e,t)};return l=HU.url(Ramadda.getUrl(URL_ENTRY_SHOW),ARG_ENTRYID,t.entryId,ARG_OUTPUT,"kml.doc","converthref",!0),this.getMap().addKMLLayer(t.name,l,!0,a,r,i,m,s,o);case"type_wmts_layer":return null;default:return this.showMessage("Unknown map type:"+t.entryType,4e3),null}},loadMap:function(e){let t=this,i=this.getProperty("fileUrl",null,!1,!0);if(!i&&e&&(i=HU.url(Ramadda.getUrl(URL_ENTRY_GET),ARG_ENTRYID,e)),!i)return;this.showProgress("Loading map...");let s=()=>{this.showCommandMessage(""),this.getMap().clearAllProgress()};$.ajax({url:i,dataType:"text",cache:!1,success:e=>{s(),""==e&&(e="[]");try{let i=JSON.parse(e),s=null,l=-1;if(i.baseLayer){let e=t.map.baseLayers[i.baseLayer];e&&t.map.getMap().setBaseLayer(e)}t.getProperty("embedded")||t.getProperty("zoomLevel")||(i.bounds?(l=i.zoomLevel,s=MapUtils.createBounds(i.bounds.west,i.bounds.south,i.bounds.east,i.bounds.north),s=t.getMap().transformLLBounds(s),this.initialLocation={zoomLevel:l,bounds:s}):t.getGlyphs().forEach((e=>{let t=e.getFeature();if(t&&(s||(s=MapUtils.createBounds()),s.extend(t.geometry.getBounds()),t.mapLayer)){let e=t.mapLayer.getDataExtent();e&&s.extend(e)}}))),this.mapProperties=i.mapProperties||this.mapProperties||{},this.parsedMapProperties=null,this.mapLegendToggleId&&Utils.isDefined(this.getMapProperty("mapLegendOpen"))&&(this.getMapProperty("mapLegendOpen")||jqid(this.mapLegendToggleId).css(CSS_DISPLAY,DISPLAY_NONE)),this.getMap().applyHighlightStyle(this.getOtherProperties()),Utils.stringDefined(HU.getUrlArgument(ARG_ZOOMLEVEL))&&(l=null),Utils.stringDefined(HU.getUrlArgument(ARG_MAPCENTER))&&(s=null),l>=0&&Utils.isDefined(l)&&t.getMap().setZoom(l),s&&t.map.getMap().setCenter(s.getCenterLonLat());try{this.loadIMDVJson(i,t.map)}catch(e){this.handleError(e)}this.clearFeatureChanged(),this.checkMapProperties(),this.makeLegend(),this.showMapLegend(),this.checkVisible()}catch(t){this.showMessage("Failed to load map:"+t),console.log("error:"+t),console.log(t.stack),console.log("map json:"+e)}}}).fail((e=>{s(),this.handleError(e)}))},handleError:function(e,t){let i;e.message&&console.error(e.message),e.stack&&console.error(e.stack);let s=e.responseText??e?.priv?.responseText;if(s){let e=s.match(/<div\s+class\s*=\s*"ramadda-message-inner">(.*?)<\/div>/);e&&(i=e[1]),i||s.startsWith("{")&&(e=s.match(/error:'(.*)'/),e&&(i=e[1]))}null==i&&"object"==typeof e&&(e.error?i=e.error:e.responseText&&(i=Utils.stripTags(s))),e=i??e,t&&(e="Error loading URL:"+t+HU.br()+e),this.showMessage(e)},doMakeMapGlyphs:function(){let e=this.getExternalGraphic();Ramadda.isRamaddaUrl(e)||(e=Ramadda.getUrl(e));let t={textBackgroundStrokeColor:"",textBackgroundStrokeWidth:1,textBackgroundFillColor:"",textBackgroundFillOpacity:1,textBackgroundPadding:2,textBackgroundShape:"rectangle",textBackgroundRadius:0},i={fontColor:this.getProperty("labelFontColor",COLOR_BLACK),fontSize:this.getFontSize(),fontFamily:this.getFontFamily(),fontWeight:this.getFontWeight(),fontStyle:this.getFontStyle(),labelAlign:this.getProperty("labelAlign","cb"),labelXOffset:this.getProperty("labelXOffset","0"),labelYOffset:this.getProperty("labelYOffset","14"),labelOutlineColor:this.getProperty("labelOutlineColor",COLOR_WHITE),labelOutlineWidth:this.getProperty("labelOutlineWidth","0")},s={strokeColor:this.getStrokeColor(),strokeWidth:this.getStrokeWidth(),strokeOpacity:1,strokeDashstyle:"solid",strokeLinecap:"butt"},l=(this.boxStyle=Utils.clone(s,{fillColor:COLOR_TRANSPARENT,fillOpacity:1,fillPattern:""}),{dotSize:3,dotStrokeColor:"blue",dotStrokeWidth:1,dotFillColor:"blue",dotExternalGraphic:""});this.groupGlyphType=new GlyphType(this,GLYPH_GROUP,"Group",Utils.clone({externalGraphic:e,label:"",pointRadius:this.getPointRadius(10)},{fillColor:COLOR_TRANSPARENT,fillOpacity:1,pointRadius:6,labelSelect:!0},s,i,t,{transform:"",clippath:"",imagefilter:"",imagecss:""}),MyEntryPoint,{isGroup:!0,tooltip:"Add group",icon:Ramadda.getCdnUrl("/icons/chart_organisation.png")}),this.markerGlyphType=new GlyphType(this,GLYPH_MARKER,"Marker",Utils.clone({label:"label",externalGraphic:e,pointRadius:this.getPointRadius(10),rotation:0,label:""},i,{fillColor:COLOR_TRANSPARENT,labelSelect:!0},t),MyPoint,{icon:Ramadda.getCdnUrl("/icons/markerblack.png")}),new GlyphType(this,GLYPH_POINT,"Point",Utils.clone({graphicName:"circle",pointRadius:6},s,{fillColor:"blue",fillOpacity:1,rotation:0,label:""},i,t),MyPoint,{icon:Ramadda.getCdnUrl("/icons/dotblack.png")}),new GlyphType(this,GLYPH_FIXED,"Fixed Text",{text:"",right:HU.perc(50),bottom:HU.px(5),left:"",top:"",borderWidth:1,borderColor:COLOR_LIGHT_GRAY,fillColor:"#fffeec",fontColor:COLOR_BLACK,fontSize:HU.pt(12)},MyEntryPoint,{isFixed:!0,tooltip:"Add fixed text",icon:Ramadda.getCdnUrl("/icons/text2.png")}),new GlyphType(this,GLYPH_LINE,"Line",Utils.clone(s,l),MyPath,{maxVertices:2,newHelp:"Click and drag to create a new line",icon:Ramadda.getCdnUrl("/icons/line.png")}),new GlyphType(this,GLYPH_POLYLINE,"Polyline",Utils.clone(s,l),MyPath,{newHelp:"Click and drag to create a new polyline",icon:Ramadda.getCdnUrl("/icons/polyline.png")}),new GlyphType(this,GLYPH_POLYGON,"Polygon",Utils.clone(s,{fillColor:COLOR_TRANSPARENT,fillOpacity:1,fillPattern:""}),MyPolygon,{newHelp:"Click and drag to create a new polygon",icon:Ramadda.getCdnUrl("/icons/polygon.png")}),new GlyphType(this,GLYPH_FREEHAND,"Freehand",Utils.clone(s),MyPath,{freehand:!0,newHelp:"Click and drag to create a freehand line",icon:Ramadda.getCdnUrl("/icons/freehand.png")}),new GlyphType(this,GLYPH_FREEHAND_CLOSED,"Closed",Utils.clone(s,{fillColor:COLOR_TRANSPARENT,fillOpacity:1,fillPattern:""}),MyPolygon,{freehand:!0,newHelp:"Click and drag to create a new closed freehand line",icon:Ramadda.getCdnUrl("/icons/freehandclosed.png")}),new GlyphType(this,GLYPH_BOX,"Box",Utils.clone(this.boxStyle),MyRegularPolygon,{snapAngle:90,sides:4,irregular:!0,tooltip:"Create box; ctrl-b: to manually enter bounds",newHelp:"Click and drag to create a new box",icon:Ramadda.getCdnUrl("/icons/rectangle.png")}),new GlyphType(this,GLYPH_CIRCLE,"Circle",Utils.clone(this.boxStyle),MyRegularPolygon,{snapAngle:45,sides:40,newHelp:"Click and drag to create a new circle",icon:Ramadda.getCdnUrl("/icons/ellipse.png")}),new GlyphType(this,GLYPH_TRIANGLE,"Triangle",Utils.clone(s,{fillColor:COLOR_TRANSPARENT,fillOpacity:1,fillPattern:""}),MyRegularPolygon,{snapAngle:10,sides:3,newHelp:"Click and drag to create a new triangle",icon:Ramadda.getCdnUrl("/icons/triangle.png")}),new GlyphType(this,GLYPH_HEXAGON,"Hexagon",Utils.clone(s,{fillColor:COLOR_TRANSPARENT,fillOpacity:1,fillPattern:""}),MyRegularPolygon,{snapAngle:90,sides:6,newHelp:"Click and drag to create a new hexagon",icon:Ramadda.getCdnUrl("/icons/hexagon.png")}),new GlyphType(this,GLYPH_RINGS,"Range Rings",Utils.clone(s,{fillColor:COLOR_TRANSPARENT,pointRadius:6,rotation:0},i,t),MyPoint,{newHelp:"Click to create a new range ring",icon:Ramadda.getCdnUrl("/icons/rangerings.png")}),new GlyphType(this,GLYPH_MAP,"Map File",Utils.clone(s,{fillColor:COLOR_TRANSPARENT,fillOpacity:1,fillPattern:"",pointRadius:6,externalGraphic:"",graphicName:""},i,t),MyEntryPoint,{isMap:!0,tooltip:"Select a gpx, geojson or  shapefile map",icon:Ramadda.getCdnUrl("/icons/mapfile.png")}),new GlyphType(this,GLYPH_MAPSERVER,"Map Server",{opacity:1,legendUrl:""},MyEntryPoint,{isMapServer:!0,tooltip:"Provide a Web Map Service URL",icon:Ramadda.getCdnUrl("/icons/maps.png")}),new GlyphType(this,GLYPH_ROUTE,"Route",Utils.clone(s),MyRoute,{icon:Ramadda.getCdnUrl("/icons/route.png")}),new GlyphType(this,GLYPH_ISOLINE,"Isoline",Utils.clone({},s,{fillColor:COLOR_TRANSPARENT,fillOpacity:1}),null,{icon:Ramadda.getCdnUrl("/icons/route.png")}),new GlyphType(this,GLYPH_IMAGE,"Image",Utils.clone({},{imageOpacity:this.getImageOpacity(1)},s,{rotation:0,transform:"",clippath:"",imagefilter:"",imagecss:""}),ImageHandler,{tooltip:"Select an image entry to display",snapAngle:90,sides:4,irregular:!0,isImage:!0,icon:Ramadda.getCdnUrl("/icons/image.png")}),new GlyphType(this,GLYPH_ENTRY,"Entry Marker",Utils.clone({externalGraphic:Ramadda.getCdnUrl("/icons/entry.png"),pointRadius:12,label:"label"},i),MyEntryPoint,{tooltip:"Add an entry as a marker",isEntry:!0,icon:Ramadda.getCdnUrl("/icons/entry.png")}),new GlyphType(this,GLYPH_MULTIENTRY,"Multi Entry",Utils.clone({externalGraphic:e},{childIcon:""},{showLabels:!0,pointRadius:12},i,t),MyEntryPoint,{tooltip:"Display children entries of selected entry",isMultiEntry:!0,icon:Ramadda.getCdnUrl("/icons/folder.png")}),new GlyphType(this,GLYPH_DATA,"Data",{externalGraphic:e},MyEntryPoint,{isData:!0,tooltip:"Select a map data entry to display",icon:Ramadda.getCdnUrl("/icons/chart.png")}),new GlyphType(this,GLYPH_ZOOM,"Viewpoint",{externalGraphic:Ramadda.getCdnUrl("/icons/binoculars.png")},MyEntryPoint,{isZoom:!0,tooltip:"Add a viewpoint location",icon:Ramadda.getCdnUrl("/icons/binoculars.png")}),new GlyphType(this,GLYPH_OSM_LOCATIONS,"Query OSM",{externalGraphic:e},MyEntryPoint,{isOsm:!0,tooltip:"Query OpenStreetMap for locations",icon:Ramadda.getCdnUrl("/icons/osm.png")})},clearMessage2:function(e){this.jq(n).hide(e)},showMessage2:function(e,t){Utils.stringDefined(e)&&(this.jq(n).html(e),this.jq(n).show()),t&&setTimeout((()=>{this.clearMessage2(1e3)}),2e3)},showCommandMessage:function(e){this.showMessage(e,-1)},showMessage:function(e,t){if(""!=e)e=HU.div([ATTR_CLASS,"imdv-message-inner"],e);else if(this.messageIsTimed)return;this.jq(o).html(e),this.jq(o).show(),this.messageErase&&clearTimeout(this.messageErase),this.messageErase=null,(t>0||!Utils.isDefined(t))&&(this.messageIsTimed=!0,this.messageErase=setTimeout((()=>{this.messageIsTimed=!1,this.jq(o).hide(),this.jq(o).html("")}),t??3e3))},showProgress:function(e){this.showMessage(e)},setErrorMessage:function(e){this.showMessage(e,8e3)},getCurrentLevel:function(){return this.getMap().getZoom()},checkVisible:function(){this.getGlyphs().forEach((e=>{e.checkVisible()}))},initMap:function(e){oe.initMap.call(this)},initMapParams:function(e){oe.initMapParams.call(this,e)},getOtherProperties:function(){return this.parsedMapProperties||(this.parsedMapProperties=Utils.parseMap(this.mapProperties.otherProperties,"\n","=")??{}),this.parsedMapProperties},setMapProperty:function(){for(let e=0;e<arguments.length;e+=2)this.mapProperties[arguments[e]]=arguments[e+1]},propertyCache:{},getMapProperty:function(e,t,i){i&&console.log("getProperty:"+e);let s=this.propertyCache[e];return Utils.isDefined(s)?(i&&console.log("\tfrom cache:"+s),s):(s=this.propertyCache[e]=this.getProperty(e,null),Utils.isDefined(s)?(i&&console.log("\tfrom display property:"+s),Utils.getProperty(s)):(s=this.getOtherProperties()[e],i&&console.log("\tfrom other properties:",s),Utils.isDefined(s)||(s=this.mapProperties[e],i&&console.log("\tfrom map properties:",s)),Utils.isDefined(s)||(s=t,i&&console.log("\tusing dflt:",s)),Utils.isDefined(s)&&(s=Utils.getProperty(s)),s))},makeLegendDroppable:function(e,t,i){i=i??(()=>{this.setLastDroppedTime(new Date)}),t.droppable({hoverClass:CLASS_LEGEND_ITEM_DROPPABLE,accept:"."+CLASS_LEGEND_ITEM,tolerance:CURSOR_POINTER,drop:(s,l)=>{i();let a=this.findGlyph(l.draggable.attr(ATTR_GLYPH_ID));a?this.handleDroppedGlyph(a,e,t):console.log("Could not find dragged glyph")}})},handleDroppedGlyph:function(e,t,i){this.handleDropTimeout&&clearTimeout(this.handleDropTimeout),this.handleDropTimeout=setTimeout((()=>{this.handleDropTimeout=null,this.removeMapGlyph(e),e.setParentGlyph(null),t?t.isGroup()?(t.addChildGlyph(e),e.changeOrder(!1)):t.getParentGlyph()&&t.getParentGlyph().isGroup()?(t.getParentGlyph().addChildGlyph(e),this.moveGlyphBefore(t,e,t.getParentGlyph().getChildren())):this.moveGlyphBefore(t,e):i&&(e.setParentGlyph(null),Utils.removeItem(this.getGlyphs(),e),i.attr(ATTR_ID)==this.domId(ae)?this.getGlyphs().unshift(e):this.getGlyphs().push(e),e.changeOrder(!1),this.featureChanged(),this.redraw()),e.glyphHasBeenDropped(),this.handleGlyphsChanged(),this.redraw()}),1)},getShowLegendInMap(){return"map"==this.getMapProperty("legendPosition","left")},checkGlyphLayers:function(){let e=100;this.getGlyphs().forEach(((t,i)=>{e=t.setLayerLevel(e)})),this.getMap().checkLayerOrder()},makeLegend:function(){let e=this,t=this.getMapProperty("legendDivId"),i=this.getMapProperty("legendPosition","left"),s=this.jq(K),l=(this.jq(Z),this.jq(X));this.jq(z).remove(),this.jq(z).remove();this.getMapProperty("showShapes",!0);let a=this.getMapProperty("legendWidth",HU.px(200));Utils.stringDefined(a)||(a=HU.px(200));let r=this.getMapProperty("legendLabel",""),o=this.getMapProperty("showViewInLegend",!1),n={},h=this.getGlyphs(),d="";this.getMapProperty("showBaseMapSelect")&&(d+=HU.div([ATTR_STYLE,HU.css(CSS_MARGIN_BOTTOM,HU.px(4)),ATTR_CLASS,CLASS_LEGEND_OFFSET],HU.b("Base Map: ")+this.getBaseLayersSelect())),this.getMapProperty("showAddress",!1)?this.jq(c).show():this.jq(c).hide(),this.checkGlyphLayers(),this.inMapLegend="",h.length&&(d+=HU.div([ATTR_ID,this.domId(ae),ATTR_STYLE,HU.css(CSS_WIDTH,HU.perc(100),CSS_HEIGHT,HU.px(1))],"")),h.forEach(((e,t)=>{d+=e.makeLegend({idToGlyph:n})})),h.length&&(d+=HU.div([ATTR_ID,this.domId(re),ATTR_CLASS,CLASS_LEGEND_ITEM,ATTR_STYLE,HU.css(CSS_WIDTH,HU.perc(100),CSS_HEIGHT,HU.em(1))],""));let g="";Utils.stringDefined(r)&&(r=r.replace(/\\n/,HU.br()),g=HU.div([],r)),this.getMapProperty(PROP_SHOW_LAYER_SELECT_IN_LEGEND,!1)&&(g+=HU.div([ATTR_STYLE,HU.css(CSS_TEXT_ALIGN,ALIGN_CENTER,CSS_MARGIN_BOTTOM,HU.px(2))],this.getBaseLayersSelect())),o&&(g+=HU.center(this.makeViewMenu(!1,"_legend",((e,t)=>HU.span([ATTR_STYLE,HU.css(CSS_MARGIN_RIGHT,HU.px(6)),ATTR_ID,e,ATTR_CLASS,CLASS_CLICKABLE],t))))),d=g+d;let p,u="map"==i;if(Utils.isMobile()&&("left"!=i&&"right"!=i||(u=!0)),""!=d){let e=this.getProperty("height"),i=this.getProperty("legendHeight",e),s=HU.css(CSS_MAX_WIDTH,HU.getDimension(a),CSS_WIDTH,HU.getDimension(a));if(!e||u||t||(s+=HU.css(CSS_HEIGHT,i)),!t){let e=[ATTR_CLASS,"imdv-legend",ATTR_STYLE,s];d=HU.div(e,d)}}if(u&&(this.inMapLegend=d),this.jq(Z).html(""),""!=this.inMapLegend||u){let e=HU.div([ATTR_ID,this.domId(J)],this.inMapLegend),t={},i=(e,t)=>{this.setMapProperty("mapLegendOpen",t)};e=HU.toggleBlock("Legend"+HU.space(2),e,this.getMapProperty("mapLegendOpen",!0),{animated:300,listener:i},t),u&&(e=HU.div([ATTR_ID,this.domId(z)],e)),this.jq(Z).html(e),this.mapLegendToggleId=t.id}t?p=jqid(t):"left"==i?p=s:"editor"==i?this.canChange()&&(p=s):"right"==i?p=l:"map"==i&&(p=this.jq(Z)),p&&!u&&(p.show(),p.html(HU.div([ATTR_ID,this.domId(z)],"")),this.jq(z).html(d)),this.initViewMenu("_legend"),this.makeLegendDroppable(null,this.jq(ae),null),this.makeLegendDroppable(null,this.jq(re),null),HU.initToggleBlock(this.jq(z),((e,t,i)=>{let s=n[i.attr("map-glyph-id")];s&&s.setLegendVisible(t)})),this.getContainer().find(".imdv-legend-item-edit").click((function(t){t.stopPropagation();let i=$(this).attr(ATTR_GLYPH_ID),s=e.findGlyph(i);s&&e.editFeatureProperties(s)})),this.getContainer().find("."+CLASS_LEGEND_ITEM_VIEW).click((function(t){t.stopPropagation();let i=$(this).attr(ATTR_GLYPH_ID),s=e.findGlyph(i);s&&s.panMapTo(t.shiftKey)})),this.initBaseLayersSelect(),this.getGlyphs().forEach(((e,t)=>{e.initLegend()})),this.initGlyphButtons(this.getContainer());let T=this.getContainer().find("."+CLASS_LEGEND_LABEL);T.tooltip({content:function(){let e=$(this).prop(ATTR_TITLE);return e=HU.div([ATTR_STYLE,HU.css(CSS_FONT_SIZE,HU.pt(10))],e),e},show:{delay:1e3}}),T.click((function(t){if(e.lastDroppedTime){if((new Date).getTime()-e.lastDroppedTime.getTime()<2e3)return}let i=$(this).attr(ATTR_GLYPH_ID),s=e.findGlyph(i);s&&(t.shiftKey?e.toggleSelectGlyph(s):t.altKey||t.metaKey?s.panMapTo():s.setVisible(!s.getVisible(),!0))}))},addToMapLegend:function(e,t){this.inMapLegend+=t},checkTopWiki:function(){let e=(e,t)=>{Utils.stringDefined(t)?this.wikify(t,null,(t=>{this.jq(e).html(t)})):this.jq(e).html("")};e("topwikitext",this.getMapProperty("topWikiText")),e("bottomwikitext",this.getMapProperty("bottomWikiText"))},editState:null,canChange:function(){if(this.canEdit())return!0;if(!this.editState){let e=this.getUserCanChange(null);Utils.isDefined(e)||(e=this.getMapProperty("userCanChange")),this.editState={canchange:e}}return this.editState.canchange},initDisplay:function(e){let t=this;if(oe.initDisplay.call(this),this.myLayer=this.map.createFeatureLayer("IMDV Features",!0,null,{rendererOptions:{zIndexing:!0}}),this.selectionLayer=this.map.createFeatureLayer("Selection",!1,null,{rendererOptions:{zIndexing:!0}}),this.selectionLayer.canSelect=!1,this.selectionLayer.setZIndex(1001),this.myLayer.setZIndex(1e3),this.myLayer.ramaddaLayerIndex=1001,this.icon="/icons/map/marker-blue.png",this.glyphTypes=[],this.glyphTypeMap={},this.doMakeMapGlyphs(),e)return;setTimeout((()=>{this.getMap().getMap().events.register("zoomend","",(()=>{Utils.bufferedCall(this.getId()+"_checkvisible",(()=>{this.checkVisible()})),this.setLevelRangeTick(),$(".imdv-currentlevellabel").html("(current level: "+this.getCurrentLevel()+")")}),!0),this.getMap().getMap().events.register("moveend","",(()=>{Utils.bufferedCall(this.getId()+"_checkvisible",(()=>{this.checkVisible()}))}),!0)}),500),this.getMap().featureClickHandler=e=>{let t=e.feature;if(!t)return;let i=t.mapGlyph||(t.layer?t.layer.mapGlyph:null);return!i||!!i.getCanSelect()&&this.handleMapGlyphClick(i,e.event?e.event.xy:null,e)},this.createMapLegendWrapper();let i=HU.div([ATTR_ID,this.domId(K),ATTR_STYLE,HU.css(CSS_DISPLAY,DISPLAY_NONE)]);this.jq(ID_LEFT).html(i);let s=HU.div([ATTR_ID,this.domId(X),ATTR_STYLE,HU.css(CSS_DISPLAY,DISPLAY_NONE)]);this.jq(ID_RIGHT).html(s),this.jq(ID_HEADER0).append(HU.div([ATTR_ID,this.domId("topwikitext")])),this.jq(ID_BOTTOM).append(HU.div([ATTR_ID,this.domId("bottomwikitext")]));let l=HU.div([ATTR_ID,this.domId(n),ATTR_CLASS,"ramadda-imdv-message2"],"");this.jq(ID_MAP_CONTAINER).append(l);let a=HU.div([ATTR_ID,this.domId(h),ATTR_CLASS,"ramadda-imdv-message3"],"");this.getShowMapLegend()&&this.jq(ID_MAP_CONTAINER).append(a);let r=HU.div([ATTR_ID,this.domId(d),ATTR_CLASS,"imdv-inmap-labels"],"");this.jq(ID_MAP_CONTAINER).append(r),this.makeMenuBar(),this.makeControls(),$(window).bind("beforeunload",(()=>{if(this.canEdit()&&this.featureHasBeenChanged)return"Changes have been made. Are you sure you want to leave?"}));this.jq(P).html(""),this.jq(ID_MAP).keydown((function(e){e.ctrlKey&&(t.getSelected().forEach((t=>{t.handleKeyDown(e)})),e.preventDefault())})),this.jq(ID_MAP).mouseover((function(){$(this).focus()})),"geo_editable_json"!=this.getProperty("thisEntryType")&&"geo_imdv"!=this.getProperty("thisEntryType")||this.loadMap()},handleMapGlyphClick:function(e,t,i){if(null==e)return!1;let s=!1;if(e.isMap())return i&&i.event&&i.feature&&i.event.altKey,!0;if(this.command==Y)return this.doEdit(e),!1;if(null!=this.command)return!1;let l=(i,s)=>{this.getMap().lastClickTime=(new Date).getTime();let l=HU.getUniqueId(TAG_DIV),a=HU.div([ATTR_ID,l]),r=e.getCentroid();this.getMap().currentPopup&&this.getMap().onPopupClose(),r=null!=r?MapUtils.createLonLat(r.x,r.y):this.getMap().getMap().getLonLatFromViewPortPx({x:50,y:10}),t&&(r=this.getMap().getMap().getLonLatFromViewPortPx(t));let o=this.getMap().makePopup(r,a,s);if(this.getMap().currentPopup=o,this.getMap().getMap().addPopup(o),this.isIsolineEnabled()){let e=this.getMap().transformProjPoint(r);i+=HU.p()+HU.onClick("ImdvUtils.getImdv('"+this.getId()+"').addIsolineAt("+e.lat+","+e.lon+")",HU.getIconImage("fa-regular fa-circle-dot")+" Add Isoline")}jqid(l).html(i),jqid(l).find("a").each((function(){$(this).click((function(){let e=$(this).attr(ATTR_HREF);e&&window.open(e,"_blank")}))}))},a=(e,t)=>{let i=[];[...e.matchAll(/<script *src=("|')?([^ "']+)("|')?.*?<\/script>/g)].forEach((t=>{e=e.replace(t[0],"");let s=t[2];s=s.replace(/'/g,""),i.push(s)}));let s=()=>{if(0==i.length&&null==i[0])return void l(e,t);let a=i[0];i.splice(0,1),Utils.loadScript(a,s)};s()},r=HU.div([ATTR_CLASS,"imdv-popup-header"],e.getLabel({})??""),o=e.getEntryLink("View entry");o&&(r=HU.leftRightTable(r,o)),r+=HU.div([],e.getPopupContents()??"");let n=e.getLegendDiv().css(CSS_BACKGROUND);if(e.getLegendDiv().css(CSS_BACKGROUND,"yellow"),"yellow"!=n&&setTimeout((()=>{e.getLegendDiv().css(CSS_BACKGROUND,COLOR_WHITE)}),2e3),e.isEntry()||e.isMultiEntry()||r.startsWith("<wiki>")){s;let t=(r.startsWith("<wiki>")?r:e.getWikiText())??"",i="400",l="300",o=/popupWidth *= *(\d+)/,n=t.match(o);n&&(i=n[1],t=t.replace(o,""));let h=/popupHeight *= *(\d+)/,d=t.match(h);d&&(l=d[1],t=t.replace(h,"")),Utils.stringDefined(t)||(t="{{mappopup}}");let g=t=>{t=e.convertPopupText(t),t=HU.div([ATTR_STYLE,HU.css(CSS_MAX_HEIGHT,HU.px(300),CSS_OVERFLOW_Y,OVERFLOW_AUTO)],t),a(t,{width:this.getProperty("popupWidth",i),height:this.getProperty("popupHeight",l)})};return this.wikify(t,e.getEntryId(),g),!1}return!!Utils.stringDefined(r)&&(r=e.convertPopupText(r).replace(/\n/g,HU.br()),a(r),!1)},getLabels:function(){return this.jq(d)},appendHeader:function(e){this.jq(ID_HEADER0).append(e)},makeMenuBar:function(){if(!this.getMapProperty("showMenuBar",!0))return;let e=this,t="";[[b,"File"],[R,"Edit"],[I,"New"],[D,"View"]].forEach((e=>{t+=HU.div([ATTR_ID,this.domId(e[0]),ATTR_CLASS,"ramadda-menubar-button"],e[1])})),t=HU.div([ATTR_CLASS,"ramadda-menubar"],t);let i=HU.span([ATTR_STYLE,HU.css(CSS_POSITION,POSITION_RELATIVE)],HU.div([ATTR_STYLE,HU.css(CSS_DISPLAY,DISPLAY_INLINE_BLOCK),ATTR_ID,this.domId(f),ATTR_TITLE,"Clear",ATTR_CLASS,CLASS_CLICKABLE],HU.getIconImage(ICON_ERASER,[],[ATTR_STYLE,HU.css(CSS_COLOR,COLOR_LIGHT_GRAY)]))+" "+HU.div([ATTR_ID,this.domId(T),ATTR_STYLE,HU.css(CSS_POSITION,POSITION_ABSOLUTE,CSS_RIGHT,HU.px(0),CSS_DISPLAY,DISPLAY_INLINE_BLOCK,CSS_MARGIN_RIGHT,HU.px(2),CSS_WIDTH,HU.px(20))])+HU.input("","",[ATTR_ID,this.domId(u),ATTR_PLACEHOLDER,"Search for address or lat,lon",ATTR_SIZE,25]));this.canChange()&&(i=i+" "+HU.checkbox(this.domId(y),[ATTR_ID,this.domId(y),ATTR_TITLE,"Add marker to map"],!1)),i=HU.span([ATTR_STYLE,HU.css(CSS_MARGIN_RIGHT,HU.px(5))],i),i=HU.div([ATTR_STYLE,HU.css(CSS_WHITE_SPACE,WHITE_SPACE_NOWRAP,CSS_DISPLAY,DISPLAY_NONE,CSS_POSITION,POSITION_RELATIVE),ATTR_ID,this.domId(c)],i);let s=HU.div([ATTR_ID,this.domId(o),ATTR_CLASS,"imdv-message"]),l=HU.div([ATTR_STYLE,HU.css(CSS_MARGIN_RIGHT,HU.px(10),CSS_MARGIN_LEFT,HU.px(10)),ATTR_ID,this.domId(ID_MAP+"_header")]);t=this.canChange()?HU.table([ATTR_ID,this.domId(r),ATTR_WIDTH,HU.perc(100)],HU.tr([ATTR_VALIGN,ALIGN_BOTTOM],HU.td([],t)+HU.td([ATTR_WIDTH,HU.perc(50)],s)+HU.td([ATTR_ALIGN,ALIGN_RIGHT,ATTR_STYLE,HU.css(CSS_PADDING_RIGHT,HU.px(10)),ATTR_WIDTH,HU.perc(50)],l+i))):HU.table([ATTR_ID,this.domId(r),ATTR_WIDTH,HU.perc(100)],HU.tr([ATTR_VALIGN,ALIGN_BOTTOM],HU.td([],"")+HU.td([ATTR_WIDTH,HU.perc(50)],s)+HU.td([ATTR_ALIGN,ALIGN_RIGHT,ATTR_STYLE,HU.css(CSS_PADDING_RIGHT,HU.px(10)),ATTR_WIDTH,HU.perc(50)],l+i))),this.jq(ID_TOP_LEFT).html(t),this.jq(u).keypress((function(t){if(13==t.which){let t=$(this).val();if(!Utils.stringDefined(t))return;e.gotoAddress($(this),t)}})),this.jq(f).click((()=>{this.clearAddresses()})),this.jq(I).click((function(){e.showNewMenu($(this))})),this.jq(b).click((function(){e.showFileMenu($(this))})),this.jq(D).click((function(){e.showViewMenu($(this))})),this.jq(R).click((function(){e.showEditMenu($(this))}))},createMapLegendWrapper:function(){let e=this;this.jq(Z).remove();let t=this.getMapProperty("mapLegendPosition",{left:HU.px(50),top:HU.px(20)}),i="";["left","top"].forEach((e=>{t[e]&&(String(t[e]).startsWith("-")&&(t[e]=HU.px(5)),i+=HU.css(e,t[e]))})),""==i&&(i=HU.css(CSS_LEFT,HU.px(50),CSS_TOP,HU.px(20))),i+=HU.css(CSS_POSITION,POSITION_ABSOLUTE);let s=HU.div([ATTR_ID,this.domId(Z),ATTR_CLASS,"imdv-legend-map-wrapper",ATTR_STYLE,i]),l=$(s);this.jq(ID_MAP_CONTAINER).append(l);l.draggable({xcontainment:this.jq(ID_MAP_CONTAINER),start:function(){},stop:function(){let t=l.position().top;t<0&&(l.css(CSS_TOP,0),t=0);let i=l.position().left;i<0&&(l.css(CSS_LEFT,0),i=0);l.height(),l.width(),l.parent().width(),l.parent().height();let s=e.mapProperties.mapLegendPosition={};s.left=l.css(CSS_LEFT),s.top=l.css(CSS_TOP)}})},makeControls:function(){let e=this;if(this.haveMadeControls)return;this.haveMadeControls=!0,Utils.initDragAndDrop(this.jq(ID_MAP),(e=>{}),(e=>{}),((e,t,i)=>{let s=this.getProperty("entryId")||this.entryId;Ramadda.handleDropEvent(e,t,i,s,this.getProperty("authToken"),((e,t,i,s)=>{if(i=i??e.name,MAP_TYPES.includes(e.type)){let t=this.getGlyphType(GLYPH_MAP),s=$.extend({},t.getStyle()),l={entryId:e.entryid,type:t.type,name:i,entryType:e.type};this.handleNewFeature(null,s,l).checkMapLayer()}else this.setCommand(GLYPH_IMAGE,{url:e.geturl,entryId:e.entryid,name:i})}))}),(e=>{if(e.type.match("image.*"))return!0;return!!e.name.toLowerCase().match(".*.(json|geojson|gpx|shz|zip|kml|kmz)")})),this.jq(ID_MAP).css("caret-color",COLOR_TRANSPARENT);let t=new OpenLayers.Control,i=new OpenLayers.Control,s={keydown:function(t){if("MediaTrackPrevious"!=t.key){if(HU.hidePopupObject(),"Escape"==t.key)return e.clearCommands(),void e.unselectAll();if(t.ctrlKey){switch(t.key){case"a":e.selectAll();break;case"p":e.handleEditEvent();break;case"x":e.doCut();break;case"b":e.makeBox(GLYPH_BOX);break;case"v":if(!e.clipboard||0==e.clipboard.length)return;e.doPaste(t);break;case"c":e.doCopy();break;case"m":e.setCommand(V);break;case"s":e.doSave();break;case"e":e.doEdit();break;default:return}t.preventDefault()}}}};new OpenLayers.Handler.Keyboard(i,s,{}).activate(),this.getMap().getMap().addControl(t),this.addControl(G,"Click-drag to select",this.featureSelector=new OpenLayers.Control.SelectFeature(this.myLayer,{select:function(t){this.isShiftKey()&&t.mapGlyph.isSelected()?e.unselectGlyph(t.mapGlyph):e.selectGlyph(t.mapGlyph)},selectBox:function(e){this.checkEvent(),OpenLayers.Control.SelectFeature.prototype.selectBox.apply(this,arguments)},isShiftKey:function(){let e=this?.handlers?.feature?.evt;return!!e&&(e.shiftKey||e.metaKey)},checkEvent:function(){this.isShiftKey()||e.unselectAll()},selectStyle:{pointRadius:this.getPointRadius(),strokeWidth:2,fillOpacity:.5,fillColor:"blue",cursor:CURSOR_POINTER},clickout:!0,toggle:!0,multiple:!0,hover:!1,toggleKey:"ctrlKey",multipleKey:"shiftKey",box:!0})),this.addControl(Y,"Click to edit properties",new OpenLayers.Control.SelectFeature(this.myLayer,{onSelect:function(t){e.doEdit(t.mapGlyph)},clickout:!0,toggle:!0,multiple:!1,hover:!1,toggleKey:"ctrlKey",multipleKey:"shiftKey",box:!1}));let l=t=>{t.mapGlyph&&t.mapGlyph.checkImage(t),e.featureChanged()},a=(this.addControl(V,"Click &amp; drag to move",new OpenLayers.Control.DragFeature(this.myLayer,{moveFeature:function(t){let i=this.feature.mapGlyph;if(!i)return void console.log("no map glyph");i.isSelected()||(e.unselectAll(),i.select());let s=e.getSelected(),l=this.map.getResolution(),a=l*(t.x-this.lastPixel.x),r=l*(this.lastPixel.y-t.y);s.forEach((e=>{e.move(a,r)})),this.lastPixel=t,e.featureChanged()},onDrag:function(e,t){}})),OpenLayers.Class(OpenLayers.Control.ModifyFeature,{dragStart:function(t){OpenLayers.Control.ModifyFeature.prototype.dragStart.apply(this,arguments),t&&t.mapGlyph&&(e.unselectAll(t.mapGlyph),t.mapGlyph.isSelected()||e.selectGlyph(t.mapGlyph))},dragComplete:function(){OpenLayers.Control.ModifyFeature.prototype.dragComplete.apply(this,arguments),this.theDisplay.featureChanged(),this.theDisplay.clearMessage2(1e3)},isShiftKey:function(){let e=this?.handlers?.drag?.evt;return!!e&&(e.shiftKey||e.metaKey)},dragVertex:function(t,i){if(Utils.isDefined(this.feature.isDraggable)&&!this.feature.isDraggable)return;let s=this.feature.mapGlyph;if(!s)return;if(s&&(s.isSelected()||s.select()),this.theDisplay.showDistances(this.feature.geometry,this.feature.type),!this.feature.image&&s.getType()!=GLYPH_BOX&&!s.isPolygon()&&!s.isImage())return OpenLayers.Control.ModifyFeature.prototype.dragVertex.apply(this,arguments),void s.vertexDragged(this.feature,t,i);let a=this.feature.geometry.getVertices(),r=t.geometry.getVertices()[0],o=-1;a.every(((e,t)=>e.x!=r.x||e.y!=r.y||(o=t,!1)));let n=this.map.getLonLatFromViewPortPx(i),h=t.geometry,d=n.lon-h.x,g=n.lat-h.y;if(h.move(d,g),r=t.geometry.getVertices()[0],s.isPolygon()?this.isShiftKey()&&a.forEach(((e,t)=>{let i=Math.abs(t-o);if(i<3){let t=(10-i)/10,s=d*t,l=g*t;e.move(s,l)}})):0==o?(a[3].x=r.x,a[1].y=r.y):1==o?(a[2].x=r.x,a[0].y=r.y):2==o?(a[1].x=r.x,a[3].y=r.y):3==o&&(a[0].x=r.x,a[2].y=r.y),this.feature.geometry.clearBounds(),this.layer.drawFeature(this.feature,this.standalone?void 0:"select"),this.layer.drawFeature(t),e.checkSelected(s),this.mode==OpenLayers.Control.ModifyFeature.ROTATE&&s.isImage()){this.feature.style={strokeColor:COLOR_TRANSPARENT,fillColor:COLOR_TRANSPARENT};let e=Utils.getRotation(v);s.style.rotation=e.angle}l(this.feature)}})),r=new a(this.myLayer,{theDisplay:this,onDrag:function(e,t){l(e)},mode:OpenLayers.Control.ModifyFeature.RESIZE|OpenLayers.Control.ModifyFeature.DRAG}),o=new a(this.myLayer,{theDisplay:this,onDrag:function(e,t){l(e)},createVertices:!1,mode:OpenLayers.Control.ModifyFeature.RESHAPE}),n=new a(this.myLayer,{theDisplay:this,createVertices:!1,mode:OpenLayers.Control.ModifyFeature.ROTATE});this.addControl(q,"Click to resize",r),this.addControl(W,"Click to reshape",o),this.addControl(j,"Click to rotate",n),this.glyphTypes.forEach((e=>{this.glyphTypeMap[e.type]=e,e.createDrawer()}))}})}var MapObject=function(e,t,i){this.id=HU.getUniqueId(""),i.objectId=this.id,this.display=e,this.feature=i};MapObject.prototype={getId:function(){return this.id}};var GlyphType=function(e,t,i,s,l,a){this.display=e,this.name=i,this.type=t,this.glyphStyle=s,this.handler=l,this.options=a||{},this.options.glyphType=t,this.options.display=e,this.options.mapGlyph=this,e.addGlyphType(this)};function RamaddaEditablemapDisplay(e,t,i){const s=new RamaddaImdvDisplay(e,t,i);RamaddaUtil.inherit(this,s)}GlyphType.prototype={getName:function(){return this.name},getTooltip:function(){return this.options.tooltip},getNewHelp:function(){return this.options.newHelp},getIcon:function(){return this.options.icon},getStyle:function(){return this.glyphStyle},getType:function(){return this.type},isLabel:function(){return null!=this.getStyle().label},requiresEntry:function(){return this.isImage()||this.isEntry()||this.isMultiEntry()||this.isMap()||this.isData()},isImage:function(){return this.options.isImage},isEntry:function(){return this.options.isEntry},isMultiEntry:function(){return this.options.isMultiEntry},isData:function(){return this.options.isData},isOSM:function(){return this.options.isOsm},isFixed:function(){return this.options.isFixed},isZoom:function(){return this.options.isZoom},isGroup:function(){return this.options.isGroup},isMap:function(){return this.options.isMap},isMapServer:function(){return this.options.isMapServer},isRoute:function(){return this.type==GLYPH_ROUTE},isRings:function(){return this.type==GLYPH_RINGS},isIcon:function(){return null!=this.getStyle().externalGraphic},applyStyle:function(e,t){for(a in e){if(t&&this.type==GLYPH_LABEL){if("strokeColor"==a)continue;if("fillColor"==a)continue}Utils.isDefined(this.getStyle()[a])&&(this.getStyle()[a]=e[a])}},newFeature:function(e){new MapObject(this.display,this.type,e)},createDrawer:function(){let e=this,t=this.display.myLayer,i=OpenLayers.Class(OpenLayers.Control.DrawFeature,{initialize:function(t,i){let s=$.extend({},MapUtils.getVectorStyle("default"));s={},$.extend(s,e.getStyle()),i={handlerOptions:{style:s,layerOptions:{styleMap:MapUtils.createStyleMap({default:s})}}},$.extend(i.handlerOptions,e.options),OpenLayers.Control.DrawFeature.prototype.initialize.apply(this,[t,e.handler||OpenLayers.Handler.Point,i])},drawFeature:function(t){OpenLayers.Control.DrawFeature.prototype.drawFeature.apply(this,arguments);let i,s=this.layer.features[this.layer.features.length-1];if(this.handler.theImage&&(s.image=this.handler.theImage),s.type=e.type,this.handler.style&&(i=this.handler.style),i){for(a in e.getStyle())Utils.isDefined(i[a])||(i[a]=e.getStyle()[a]);s.style&&s.style.label&&(i.label=s.style.label);let t={};$.extend(t,i),s.style=t}ImdvUtils.scheduleRedraw(this.layer),e.newFeature(s)}});return this.drawer=new i(t),this.display.addControl(this.type,"",this.drawer),this.drawer}},window.olGetPatternId=function(e,t,i,s){e.defs||(e.defs=e.createDefs()),e.idToSvgId||(e.idToSvgId={});let l=t+"_"+(i=i||COLOR_BLACK)+"_"+(s=s||COLOR_TRANSPARENT);if(e.idToSvgId[l])return e.idToSvgId[l];t=window.olGetSvgPattern(t,i,s),window.olPatternBaseId||(window.olPatternBaseId=1);let a="pattern_"+window.olPatternBaseId++,r=e.nodeFactory(null,"pattern");r.setAttributeNS(null,ATTR_ID,a),r.setAttributeNS(null,ATTR_WIDTH,t.width),r.setAttributeNS(null,ATTR_HEIGHT,t.height),r.setAttributeNS(null,"patternUnits","userSpaceOnUse");let o=e.nodeFactory(null,"image");return r.appendChild(o),o.setAttributeNS(null,ATTR_X,0),o.setAttributeNS(null,ATTR_Y,0),o.setAttributeNS(null,ATTR_WIDTH,t.width),o.setAttributeNS(null,ATTR_HEIGHT,t.height),o.setAttributeNS(null,ATTR_HREF,t.url),e.defs.appendChild(r),e.idToSvgId[l]=a,a};var IMDV_PATTERNS={};function makeImdvPatterns(){let e=(e,t,i)=>(Utils.isDefined(t)||(t=10),Utils.isDefined(i)||(i=10),HU.tag(TAG_SVG,[ATTR_WIDTH,t,ATTR_HEIGHT,i,ATTR_XMLNS,NAMESPACE_SVG],e)),t=(t,i,s)=>(Utils.isDefined(i)||(i=10),Utils.isDefined(s)||(s=10),{width:i,height:s,svg:e(t,i,s)});IMDV_PATTERNS={"diagonal-stripe-1":t("<rect width='10' height='10' fill='<%= background %>'/><path d='M-1,1 l2,-2 M0,10 l10,-10 M9,11 l2,-2' stroke='<%= foreground %>' stroke-width='1'/>"),"diagonal-stripe-2":t("<rect width='10' height='10' fill='<%= background %>'/><path d='M-1,1 l2,-2 M0,10 l10,-10 M9,11 l2,-2' stroke='<%= foreground %>' stroke-width='2'/>"),"diagonal-stripe-3":t("<rect width='10' height='10' fill='<%= background %>'/><path d='M-1,1 l2,-2 M0,10 l10,-10 M9,11 l2,-2' stroke='<%= foreground %>' stroke-width='3'/>"),"diagonal-stripe-4":t("<rect width='10' height='10' fill='<%= background %>'/><path d='M-1,1 l2,-2 M0,10 l10,-10 M9,11 l2,-2' stroke='<%= foreground %>' stroke-width='4'/>"),"diagonal-stripe-5":t("<rect width='10' height='10' fill='<%= background %>'/><path d='M-1,1 l2,-2 M0,10 l10,-10 M9,11 l2,-2' stroke='<%= foreground %>' stroke-width='5'/>"),"diagonal-stripe-6":t("<rect width='10' height='10' fill='<%= background %>'/><path d='M-1,1 l2,-2 M0,10 l10,-10 M9,11 l2,-2' stroke='<%= foreground %>' stroke-width='6a'/>"),"subtle-patch":t("<rect width='5' height='5' fill='<%= background %>' /><rect x='2' y='2' width='1' height='1' fill='<%= foreground %>' />",5,5),"sparse-rect-1":t("<rect width='2' height='2' fill='<%= foreground %>' />' />",30,30),"sparse-rect-2":{width:40,height:40,svg:e("<rect width='2' height='2' fill='<%= foreground %>' />' />",30,30)},"sparse-rect-3":{width:50,height:50,svg:e("<rect width='2' height='2' fill='<%= foreground %>' />' />",30,30)},"sparse-rect-4":{width:60,height:60,svg:e("<rect width='2' height='2' fill='<%= foreground %>' />' />",30,30)},whitecarbon:{width:6,height:6,svg:"<svg xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink' width='6' height='6'><rect width='6' height='6' fill='<%= background %>'/><g id='c'><rect width='3' height='3' fill='<%= foreground %>'/><rect y='1' width='3' height='2' fill='<%= foreground %>'/></g><use xlink:href='#c' x='3' y='3'/></svg>"},crosshatch:t("<rect width='8' height='8' fill='<%= background %>'/><path d='M0 0L8 8ZM8 0L0 8Z' stroke-width='0.5' stroke='<%= foreground %>'/>",8,8),houndstooth:t("<path d='M0 0L4 4' stroke='#aaa' fill='#aaa' stroke-width='1'/><path d='M2.5 0L5 2.5L5 5L9 9L5 5L10 5L10 0' stroke='<%= foreground %>' fill='<%= foreground %>' stroke-width='1'/><path d='M5 10L5 7.5L7.5 10' stroke='<%= foreground %>' fill='<%= foreground %>' stroke-width='1'/>",10,10),verticalstripe:t("<rect width='3' height='50' fill='<%= foreground %>'/><rect x='3' width='1' height='50' fill='#ccc'/>",6,49),smalldot:t("<rect width='5' height='5' fill='<%= background %>'/><rect width='1' height='1' fill='<%= foreground %>'/>",5,5),lightstripe:t("<rect width='5' height='5' fill='<%= background %>'/><path d='M0 5L5 0ZM6 4L4 6ZM-1 1L1 -1Z' stroke='<%= foreground %>' stroke-width='1'/>",5,5),"vertical-stripe-8":t("<rect width='10' height='10' fill='<%= background %>' /><rect x='0' y='0' width='8' height='10' fill='<%= foreground %>' />"),"vertical-stripe-9":t("<rect width='10' height='10' fill='<%= background %>' /><rect x='0' y='0' width='9' height='10' fill='<%= foreground %>' />"),"vertical-stripe-7":t("<rect width='10' height='10' fill='<%= background %>' /><rect x='0' y='0' width='7' height='10' fill='<%= foreground %>' />"),"vertical-stripe-6":t("<rect width='10' height='10' fill='<%= background %>' /><rect x='0' y='0' width='6' height='10' fill='<%= foreground %>' />"),"vertical-stripe-4":t("<rect width='10' height='10' fill='<%= background %>' /><rect x='0' y='0' width='4' height='10' fill='<%= foreground %>' />"),"vertical-stripe-5":t("<rect width='10' height='10' fill='<%= background %>' /><rect x='0' y='0' width='5' height='10' fill='<%= foreground %>' />"),"vertical-stripe-1":t("<rect width='10' height='10' fill='<%= background %>' /><rect x='0' y='0' width='1' height='10' fill='<%= foreground %>' />"),"vertical-stripe-2":t("<rect width='10' height='10' fill='<%= background %>' /><rect x='0' y='0' width='2' height='10' fill='<%= foreground %>' />"),"vertical-stripe-3":t("<rect width='10' height='10' fill='<%= background %>' /><rect x='0' y='0' width='3' height='10' fill='<%= foreground %>' />"),"circles-6":t("<rect width='10' height='10' fill='<%= background %>' /><circle cx='3.5' cy='3.5' r='3.5' fill='<%= foreground %>'/>"),"circles-7":t("<rect width='10' height='10' fill='<%= background %>' /><circle cx='4' cy='4' r='4' fill='<%= foreground %>'/>"),"circles-5":t("<rect width='10' height='10' fill='<%= background %>' /><circle cx='3' cy='3' r='3' fill='<%= foreground %>'/>"),"circles-4":t("<rect width='10' height='10' fill='<%= background %>' /><circle cx='2.5' cy='2.5' r='2.5' fill='<%= foreground %>'/>"),"circles-1":t("<rect width='10' height='10' fill='<%= background %>' /><circle cx='1' cy='1' r='1' fill='<%= foreground %>'/>"),"circles-3":t("<rect width='10' height='10' fill='<%= background %>' /><circle cx='2' cy='2' r='2' fill='<%= foreground %>'/>"),"circles-2":t("<rect width='10' height='10' fill='<%= background %>' /><circle cx='1.5' cy='1.5' r='1.5' fill='<%= foreground %>'/>"),"circles-9":t("<rect width='10' height='10' fill='<%= background %>' /><circle cx='5' cy='5' r='5' fill='<%= foreground %>'/>"),"circles-8":t("<rect width='10' height='10' fill='<%= background %>' /><circle cx='4.5' cy='4.5' r='4.5' fill='<%= foreground %>'/>"),"horizontal-stripe-6":t("<rect width='10' height='10' fill='<%= background %>' /><rect x='0' y='0' width='10' height='6' fill='<%= foreground %>' />"),"horizontal-stripe-7":t("<rect width='10' height='10' fill='<%= background %>' /><rect x='0' y='0' width='10' height='7' fill='<%= foreground %>' />"),"horizontal-stripe-5":t("<rect width='10' height='10' fill='<%= background %>' /><rect x='0' y='0' width='10' height='5' fill='<%= foreground %>' />"),"horizontal-stripe-4":t("<rect width='10' height='10' fill='<%= background %>' /><rect x='0' y='0' width='10' height='4' fill='<%= foreground %>' />"),"horizontal-stripe-1":t("<rect width='10' height='10' fill='<%= background %>' /><rect x='0' y='0' width='10' height='1' fill='<%= foreground %>' />"),"horizontal-stripe-3":t("<rect width='10' height='10' fill='<%= background %>' /><rect x='0' y='0' width='10' height='3' fill='<%= foreground %>' />"),"horizontal-stripe-2":t("<rect width='10' height='10' fill='<%= background %>' /><rect x='0' y='0' width='10' height='2' fill='<%= foreground %>' />"),"horizontal-stripe-9":t("<rect width='10' height='10' fill='<%= background %>' /><rect x='0' y='0' width='10' height='9' fill='<%= foreground %>' />"),"horizontal-stripe-8":t("<rect width='10' height='10' fill='<%= background %>' /><rect x='0' y='0' width='10' height='8' fill='<%= foreground %>' />"),"dots-8":t("<rect width='10' height='10' fill='<%= background %>' /><rect x='0' y='0' width='8' height='8' fill='<%= foreground %>' />"),"dots-9":t("<rect width='10' height='10' fill='<%= background %>' /><rect x='0' y='0' width='9' height='9' fill='<%= foreground %>' />"),"dots-4":t("<rect width='10' height='10' fill='<%= background %>' /><rect x='0' y='0' width='4' height='4' fill='<%= foreground %>' />"),"dots-5":t("<rect width='10' height='10' fill='<%= background %>' /><rect x='0' y='0' width='5' height='5' fill='<%= foreground %>' />"),"dots-7":t("<rect width='10' height='10' fill='<%= background %>' /><rect x='0' y='0' width='7' height='7' fill='<%= foreground %>' />"),"dots-6":t("<rect width='10' height='10' fill='<%= background %>' /><rect x='0' y='0' width='6' height='6' fill='<%= foreground %>' />"),"dots-2":t("<rect width='10' height='10' fill='<%= background %>' /><rect x='0' y='0' width='2' height='2' fill='<%= foreground %>' />"),"dots-3":t("<rect width='10' height='10' fill='<%= background %>' /><rect x='0' y='0' width='3' height='3' fill='<%= foreground %>' />"),"dots-1":t("<rect width='10' height='10' fill='<%= background %>' /><rect x='0' y='0' width='1' height='1' fill='<%= foreground %>' />")}}function olCheckLabelBackground(e,t,i,s,l){if(""!=t.textBackgroundFillColor||""!=t.textBackgroundStrokeColor){if(0==(l=l??i.getBBox()).width||0==l.height)return!0;let a="rect";"circle"==t.textBackgroundShape?a="circle":"ellipse"==t.textBackgroundShape&&(a="ellipse");let r=e.nodeFactory(s+"_textbackground",a),o=isNaN(t.textBackgroundPadding)?0:t.textBackgroundPadding,n="";n+="fill:"+(""!=t.textBackgroundFillColor&&t.textBackgroundFillColor?t.textBackgroundFillColor:COLOR_TRANSPARENT)+";",""!=t.textBackgroundStrokeColor&&(n+=HU.css(CSS_STROKE,t.textBackgroundStrokeColor)),t.textBackgroundStrokeWidth>=0&&(n+=HU.css(CSS_STROKE_WIDTH,t.textBackgroundStrokeWidth)),isNaN(t.textBackgroundFillOpacity)||(n+=HU.css(CSS_FILL_OPACITY,t.textBackgroundFillOpacity)),"circle"==a?(r.setAttribute("cx",l.x+l.width/2),r.setAttribute("cy",l.y+l.height/2),r.setAttribute("r",l.width/2+ +o)):"ellipse"==a?(r.setAttribute("cx",l.x+l.width/2),r.setAttribute("cy",l.y+l.height/2),r.setAttribute("rx",l.width/2+ +o),r.setAttribute("ry",l.height/2+ +o)):(r.setAttribute(ATTR_X,l.x-o),r.setAttribute(ATTR_Y,l.y-o),r.setAttribute(ATTR_WIDTH,l.width+2*o),r.setAttribute(ATTR_HEIGHT,l.height+2*o),t.textBackgroundRadius&&r.setAttribute("rx",t.textBackgroundRadius)),r.setAttribute(ATTR_STYLE,n),e.vectorRoot.appendChild(r)}return!1}makeImdvPatterns(),window.olGetSvgPattern=function(e,t,i){t=t||COLOR_BLACK,i=i||COLOR_TRANSPARENT;let s=(e=IMDV_PATTERNS[e]??IMDV_PATTERNS["diagonal-stripe-1"]).svg.replace(/<%= *background *%>/g,i).replace(/<%= *foreground *%>/g,t),l="data:image/svg+xml;base64,"+btoa(s);return{width:e.width,height:e.height,url:l}},window.olDrawTextHook=function(e,t,i,s){let l=olCheckLabelBackground(e,t,i,s);if(!i.parentNode&&(e.textRoot.appendChild(i),l)){let l=i.getBBox();e.textRoot.removeChild(i),olCheckLabelBackground(e,t,i,s,l),e.textRoot.appendChild(i)}};var debugDataIcons=!1,DATAICON_PROPERTIES=["externalGraphic","pointRadius","label"],DEFAULT_DATAICON_PROPS="font:50px sans-serif,lineWidth:5,requiredField:${_field},borderColor:#000,fill:#eee",DEFAULT_DATAICONS='label,pos:nw,dx:80,dy:-ch+20,label:${${_field} decimals=1 suffix=" ${unit}"}\nimage,pos:nw,dx:10,dy:10-ch,width:60,height:60,url:${icon}',DEFAULT_DATAICON_FIELD="atmp|temp.*|.*temp",DEFAULT_DATAICON_FIELDS=DEFAULT_DATAICON_FIELD+",label=Temperature,unit=C\ndewpoint,label=Dewpoint,unit=C\n.*rh|relativehumidity,label=Relative Humidity,unit=%",LINETYPE_STRAIGHT="straight",LINETYPE_GREATCIRCLE="greatcircle",LINETYPE_CURVE="curve",LINETYPE_STEPPED="stepped",ATTR_COMMAND="command",ATTR_COLORBAR="colorbar",ID_INMAP_LABEL="inmaplabel",ID_MISCPROPERTIES="miscproperties",ID_CANSELECT="canselect",ATTR_IMAGEID="imageid",ID_FILLCOLORS="fillcolors",ID_STROKECOLORS="strokecolors",ID_ADDDOTS="adddots",ID_LINETYPE="linetype",ID_SHOWDATAICONS="showdataicons",ID_DATAICON_USEENTRY="dataicon_useentry",ID_DATAICON_MARKERS="dataicon_markers",ID_DATAICON_LABEL="dataicon_label",ID_DATAICON_FIELDS="dataicon_fields",ID_DATAICON_INIT_FIELD="dataicon_init_field",ID_DATAICON_SELECTED_FIELD="dataicon_selected_field",ID_DATAICON_WIDTH="dataicon_width",ID_DATAICON_HEIGHT="dataicon_height",ID_DATAICON_SIZE="dataicon_size",ID_DATAICON_PROPS="dataicon_props",CLASS_IMDV_ROUTE_STEP="imdv-route-step",ID_DATAICON_SHOWING="dataIconShowing",ID_DATAICON_ORIGINAL="dataIconOriginal",ID_LEGEND_TEXT="legendText",ID_MAPFILTERS="mapfilters",ID_MAPFILTERS_OUTER="mapfiltersouter",ID_MAPLEGEND="maplegend";function MapGlyph(e,t,i,s,l,a,r){if(!t)return console.log("no type given for MapGlyph"),void console.trace();this.display=e,this.type=t,(l=l??{}).mapOptions&&delete l.mapOptions,this.transientProperties={};let o=this.getGlyphType();i.routeProvider?this.name="Route: "+i.routeProvider+" - "+i.routeType:this.name=i.name||o.getName()||t;let n=i.mapglyphs;i.mapglyphs&&delete i.mapglyphs,n&&this.putTransientProperty("mapglyphs",n),this.features=[],this.attrs=i,this.style=l,this.id=i.id??HU.getUniqueId("glyph_"),this.isEntry()&&(Utils.isDefined(this.attrs.useentryname)||(this.attrs.useentryname=!0),Utils.isDefined(this.attrs.useentrylabel)||(this.attrs.useentrylabel=!0)),l=this.getStyle(!0),Utils.isDefined(i.rotation)&&(l.rotation=i.rotation,delete i.rotation),a&&(this.isStraightLine()?this.checkLineType(r.points):s=this.display.makeFeature(this.display.getMap(),r.geometryType,l,r.points)),s&&(this.addFeature(s),this.attrs.labelTemplate&&(l.label=this.attrs.labelTemplate.replace("${name}",this.getName())),MapUtils.setFeatureStyle(s,l),this.display.addFeatures([s])),a&&(this.isImage()&&this.checkImage(s),this.isEntry()&&this.loadEntry(),this.getBounds()),this.isRings()&&this.checkRings(),this.checkDataIconMenu()}function FeatureInfo(e,t){$.extend(this,{mapGlyph:e,property:t,id:Utils.makeId(t),min:NaN,max:NaN,type:"",seen:{},samples:[]})}MapGlyph.prototype={CLASS_NAME:"MapGlyph",animationInfo:{},domId:function(e){return this.getId()+"_"+this.display.domId(e)},jq:function(e){return jqid(this.domId(e))},getFixedId:function(){return this.domId("_fixed")},initSideHelp:function(e){let t=this;e.find(".imdv-property-popup").click((function(){let e=$(this).attr("info-id"),i=$(this).attr(ATTR_TARGET),s=t.getFeatureInfo(e);if(!s)return;let l=HU.b(s.getLabel()),a=["filter.show=true","filter.rows=5","label=","filter.first=true","type=enum","filter.top=true","filter.showInMap=true"];s.isNumeric()&&a.push("format.decimals=0","filter.min=0","filter.max=100","filter.animate=true","filter.animate.step=1","filter.animate.sleep=100","filter.live=true"),s.isEnumeration()&&a.push("label.feature_value="),a.push("colortable.select=true"),a.forEach((e=>{e.replace("=.*","");l+=HU.div([ATTR_STYLE,HU.css(CSS_MARGIN_LEFT,HU.px(5)),ATTR_CLASS,HU.classes(CLASS_MENU_ITEM,CLASS_CLICKABLE),"item",e],e)})),l=HU.div([ATTR_STYLE,HU.css(CSS_MARGIN_LEFT,HU.px(10),CSS_MARGIN_RIGHT,HU.px(10))],l);let r=HU.makeDialog({content:l,anchor:$(this)});r.find("."+CLASS_CLICKABLE).click((function(){r.remove();let e=$(this).attr("item"),t=s.id+"."+e+"\n",l=GuiUtils.getDomObject(i);l&&WikiUtil.insertAtCursor("",l.obj,t)}))}))},getElevations:async function(e,t,i){let s=e.map((()=>0)),l=!0,a=0;for(let t=0;t<e.length&&l;t++){let r=e[t],o="https://nationalmap.gov/epqs/pqs.php?x="+r.x+"&y="+r.y+"&units=feet&output=json";await $.getJSON(o,(r=>{let o=r?.USGS_Elevation_Point_Query_Service?.Elevation_Query?.Elevation;s[t]=o,a++,i&&(l=i(a,e.length))})).fail((e=>{console.log("Failed to find elevation"),console.dir(e),s.push(NaN)}))}t(s,l)},getIcon:function(){return Utils.stringDefined(this.attrs.icon)?this.attrs.icon:this.attrs[ID_DATAICON_ORIGINAL]&&Utils.stringDefined(this.attrs[ID_DATAICON_ORIGINAL].externalGraphic)?this.attrs[ID_DATAICON_ORIGINAL].externalGraphic:this.style.externalGraphic??this.getGlyphType().getIcon()},getGlyphType:function(){return this.display.getGlyphType(this.getType())},putTransientProperty(e,t){this.transientProperties[e]=t},getTransientProperty(e){return this.transientProperties[e]},clone:function(){let e=Utils.clone(this.style),t=Utils.clone(this.attrs),i=new MapGlyph(this.display,this.type,t,null,e);i.id=HU.getUniqueId("glyph_");let s=this.features.map((t=>((t=t.clone()).style&&(t.style.fixed?t.style=Utils.clone(t.style):t.style=e),t.layer=this.display.myLayer,t.mapGlyph=i,t)));return i.features=s,this.display.addFeatures(s),i},makeJson:function(){let e=this.getAttributes(),t={mapOptions:e,id:this.getId()},i=this.getStyle();if(this.getMapLayer()&&(i=this.getMapLayer().style||i),i&&(i=$.extend({},i),this.getImage()&&Utils.isDefined(this.getImage().opacity)&&(i.imageOpacity=this.getImage().opacity),t.style=i),t.points=this.getPoints(t),this.isMultiEntry()&&this.children){let t=e.childrenLocations??{};e.childrenLocations=t,this.children.forEach((e=>{e.overrideLocation&&(t[e.attrs.entryId]=e.overrideLocation)}))}if(!this.dontSaveChildren&&this.haveChildren()){let e=[];this.getChildren().forEach((t=>{t.isEphemeral||e.push(t.makeJson())})),t.children=e}return t},checkLayersAnimationButton:function(){this.attrs[PROP_LAYERS_ANIMATION_ON]?this.jq(PROP_LAYERS_ANIMATION_PLAY).html(HU.getIconImage(ICON_STOP)):this.jq(PROP_LAYERS_ANIMATION_PLAY).html(HU.getIconImage(ICON_PLAY))},checkLayersAnimation:function(e){if(this.animationTimeout&&clearTimeout(this.animationTimeout),this.animationTimeout=null,this.getProperty(PROP_LAYERS_ANIMATION_SHOW)){if(this.checkLayersAnimationButton(),this.getVisible()&&!e&&this.attrs[PROP_LAYERS_ANIMATION_ON]){let e=this.getProperty(PROP_LAYERS_ANIMATION_DELAY,1e3),t=()=>{this.toggleLayersVisibility(),this.checkLayersAnimation(!0),this.animationTimeout=setTimeout(t,e)};t()}}else this.attrs[PROP_LAYERS_ANIMATION_ON]=!1},toggleLayersAnimation:function(){this.attrs[PROP_LAYERS_ANIMATION_ON]=!this.attrs[PROP_LAYERS_ANIMATION_ON],this.attrs[PROP_LAYERS_ANIMATION_ON]&&!this.getVisible()&&this.setVisible(!0,null,null,!0),this.checkLayersAnimation()},toggleLayersVisibility:function(e){let t=this.getChildren();if(!t||0==t.length)return;if(t.forEach((e=>{e.highlighted=!1})),(e=e??{}).shiftKey)return void t.forEach((e=>{e.setVisible(!0,!0)}));if(e.metaKey)return void t.forEach((e=>{e.setVisible(!1,!0)}));if(this.getProperty(PROP_LAYERS_SHOW_SEQUENCE))return void t.every((e=>!!e.isVisible()||(e.setVisible(!0,!0),!1)));let i=0;this.visibleChild?(i=t.indexOf(this.visibleChild),i<0||i==t.length-1?i=0:i++):i=0,t.forEach(((e,t)=>{t==i?(e.setVisible(!0,!0,!0),this.visibleChild=e):e.setVisible(!1,!0)}))},applyStyleProperty:function(e,t){this.style&&(this.style[e]=t,this.applyStyle(this.style),this.applyStyleToChildren(e,t),this.display.redraw(this))},applyStyleToChildren:function(e,t,i){i&&this.applyStyleProperty(e,t),this.applyChildren((i=>{i.applyStyleProperty(e,t)}))},getPoints:function(e){if(this.attrs.originalPoints)return this.attrs.originalPoints;let t=this.getGeometry();if(!t)return null;e.geometryType=t.CLASS_NAME;let i=e.points=[],s=t.getVertices(),l=e=>Utils.trimDecimals(e,6);return s.forEach((e=>{let t=e.clone().transform(this.getMap().sourceProjection,this.getMap().displayProjection);i.push(l(t.y),l(t.x))})),i},isMultiEntry:function(){return this.type==GLYPH_MULTIENTRY},getRadii:function(){if(!this.attrs.radii){let e=this.display.getCurrentLevel(),t=(e,t)=>{let i=[];for(let s=1;s<=5;s++)i.push(e*s+t);return this.attrs.radii=i,i};return e>=19?t(25,UNIT_FT):e>=18?t(50,UNIT_FT):e>=17?t(75,UNIT_FT):e>=16?t(150,UNIT_FT):e>=15?t(250,UNIT_FT):e>=14?t(500,UNIT_FT):e>=13?t(1500,UNIT_FT):t(e>=12?.5:e>=11?1:e>=10?2:e>=9?2.5:e>=8?5:e>=7?10:e>=6?25:e>=5?50:e>=4?100:e>=3?250:500,UNIT_MILES)}return this.attrs.radii},addToStyleDialog:function(e){if(this.isRings())return HU.formEntryLabel("Rings Radii",HU.input("",Utils.join(this.getRadii(),","),[ATTR_ID,this.domId("radii"),ATTR_SIZE,40])+" e.g., 1km, 2mi (miles), 100ft")+HU.formEntryTopLabel("Rings Labels",HU.hbox([HU.input("",this.attrs.rangeRingLabels??"",[ATTR_ID,this.domId("rangeringlabels"),ATTR_SIZE,40]),"Use ${d} macro for the distance e.g.:<br> Label 1 ${d}, ..., Label N ${d}  "]))+HU.formEntryLabel("Ring label angle",HU.input("",Utils.isDefined(this.attrs.rangeRingAngle)?this.attrs.rangeRingAngle:135,[ATTR_ID,this.domId("rangeringangle"),ATTR_SIZE,4])+" Leave blank to not show labels")+HU.formEntryTopLabel("Ring Styles",HU.hbox([HU.textarea("",this.attrs.rangeRingStyle??"",[ATTR_ID,this.domId("rangeringstyle"),ATTR_ROWS,5,ATTR_COLS,40]),"Format:<br>ring #,style:value,style:value  e.g.:<br>1,fillColor:red,strokeColor:blue<br>2,strokeDashstyle:dot|dash|dashdot|longdash<br>N,strokeColor:black<br>*,strokeWidth:5<br>even,...<br>odd,..."]));if(this.isMapServer()){let e=this.getMapServerUrl();if(Utils.stringDefined(e)){let t=HU.formEntryLabel("Server URL",HU.input("",e,[ATTR_PLACEHOLDER,"e.g. ...${z}/${x}/${y}.png",ATTR_ID,this.domId("serverurl"),ATTR_SIZE,60]));return Utils.stringDefined(this.attrs.wmsLayer)&&(t+=HU.formEntryLabel("WMS Layer",HU.input("",this.attrs.wmsLayer,[ATTR_ID,this.domId("wmslayer"),ATTR_SIZE,20]))),t}}return this.isStraightLine()?HU.formEntryLabel("Line type",HU.select("",[ATTR_ID,this.domId(ID_LINETYPE)],[{value:LINETYPE_STRAIGHT,label:"Straight"},{value:LINETYPE_STEPPED,label:"Stepped"},{value:LINETYPE_CURVE,label:"Curve"},{value:LINETYPE_GREATCIRCLE,label:"Great Circle"}],this.attrs.lineType))+HU.formEntry("",HU.checkbox(this.domId(ID_ADDDOTS),[ATTR_ID,this.domId(ID_ADDDOTS)],this.attrs.addDots,"Add dots")):""},addToPropertiesDialog:function(e,t){let i="",s=HU.input("",this.getName(),[ATTR_ID,this.domId("mapglyphname"),ATTR_SIZE,40]);this.isEntry()&&(s+=HU.br()+HU.checkbox(this.domId("useentryname"),[],this.getUseEntryName(),"Use name from entry"),s+=HU.space(3)+HU.checkbox(this.domId("useentrylocation"),[],this.getUseEntryLocation(),"Use location from entry")),i+=HU.formTable(),i+=HU.formEntryLabel("Name",s),this.isMap()&&(this.attrs.entryId&&(i+=HU.formEntryLabel("Entry ID",HU.input("",this.attrs.entryId,[ATTR_ID,this.domId("entryid"),ATTR_SIZE,60]))),this.attrs.resourceUrl&&(i+=HU.formEntryLabel("Map URL",HU.input("",this.attrs.resourceUrl,[ATTR_ID,this.domId("resourceurl"),ATTR_SIZE,60])))),i+=HU.formTableClose();let l=this.getVisibleLevelRange(!0)??{};i+=HU.checkbox(this.domId("visible"),[],this.getVisible(),"Visible"),(this.getMapLayer()||this.imageLayers||this.isImage())&&(i+=HU.space(4)+HU.checkbox(this.domId(ID_CANSELECT),[],this.getCanSelect(),"Can Select")),i+=HU.br(),i+=this.display.getLevelRangeWidget(l,this.getShowMarkerWhenNotVisible());let a=this.getFeatureInfoList(),r=Utils.mergeLists(["_name","default"],a.map((e=>e.id)));i+=((e,i)=>{let s=this.display.domId("glyphedit_"+e),l=this.display.makeSideHelp(r,s,{prefix:"${",suffix:"}"}),a=this.getHelp("index.html#popuptext");a="";let o=HU.leftRightTable(HU.b(i),""),n="Add macro:"+HU.div([ATTR_CLASS,CLASS_IMDV_SIDEHELP],l);return o+=HU.hbox([HU.textarea("",t[e]??"",[ATTR_ID,s,ATTR_ROWS,4,ATTR_COLS,40]),SPACE2,n]),o})("popupText","Popup Text:"),i+=HU.boldLabel("Legend Text")+HU.br()+HU.textarea("",this.attrs[ID_LEGEND_TEXT]??"",[ATTR_ID,this.domId(ID_LEGEND_TEXT),ATTR_ROWS,4,ATTR_COLS,40]),i+=HU.div([],HU.boldLabel("ID")+HU.span([ATTR_CLASS,CLASS_COPYABLE],this.getId())),e.push({header:"Properties",contents:i}),i="";let o=[...IMDV_PROPERTY_HINTS];this.canHaveChildren()&&o.push(...IMDV_GROUP_PROPERTY_HINTS),this.isMap()&&(o.push("declutter.features=true"),o.push("colortable.select=false"),o.push("colortable.alpha=0.5"),o.push("colortable.showDots=true")),this.getFeatureInfoList().forEach(((e,t)=>{0==t&&o.push({skip:!0,line:"<thin_hr></thin_hr>"+HU.b("Features")}),o.push({info:e.id,title:e.getLabel()})}));let n=this.display.makeSideHelp(o,this.domId(ID_MISCPROPERTIES),{style:HU.css(CSS_HEIGHT,HU.px(350),CSS_MAX_HEIGHT,HU.px(350)),suffix:"\n"}),h=HU.boldLabel("Add property")+HU.span([ATTR_ID,this.domId("propsearch")])+n;if(i+=HU.hbox([HU.textarea("",this.attrs.properties??"",[ATTR_ID,this.domId(ID_MISCPROPERTIES),ATTR_ROWS,16,ATTR_COLS,40]),HU.space(2),h]),e.push({header:"Flags",contents:i}),this.isDataIconCapable()){let t="",i=this.getHelp("dataicons.html"),s=HU.boldLabel("Show data icons")+HU.select("",[ATTR_ID,this.domId(ID_SHOWDATAICONS)],["inherited","yes","no"],this.attrs[ID_SHOWDATAICONS]??"inherited");if(t+=HU.leftRightTable(s,i),t+="<thin_hr></thin_hr>",Utils.stringDefined(this.transientProperties.mapglyphs)){let e=this.getAttribute(ID_DATAICON_USEENTRY),i=this.domId(ID_DATAICON_USEENTRY);t+=HU.radio(i,i,"","true",e)+HU.tag(TAG_LABEL,[ATTR_FOR,i,ATTR_TITLE,""],"Use the default data icon specification for the entry"),t+=HU.br(),t+=HU.radio(i+"_oruse",i,"","false",!e)+HU.tag(TAG_LABEL,[ATTR_FOR,i+"_oruse",ATTR_TITLE,""],"Use parent group's or the below if defined"),t+=HU.br()}let l=[HU.span([ATTR_ID,this.domId("dataicon_add_default"),ATTR_TITLE,"Set example values"],"Apply Defaults")];Utils.stringDefined(this.transientProperties.mapglyphs)&&l.push(HU.span([ATTR_GLYPH_ID,this.getId(),ATTR_CLASS,CLASS_CLICKABLE,ATTR_TITLE,"Apply settings from entry",ATTR_ID,this.domId("applyentrydataicon")],"Apply from Entry")),l.push(HU.span([ATTR_ID,this.domId("dataicon_clear_default"),ATTR_TITLE,"Clear properties"],"Clear"));let a=this.getDataIconInfo();t+=HU.buttons(l,null,HU.css(CSS_TEXT_ALIGN,ALIGN_LEFT));let r=HU.boldLabel("Menu Fields")+HU.br()+HU.textarea("",a[ID_DATAICON_FIELDS]??"",[ATTR_PLACEHOLDER,"field pattern,label=<label>,unit=<unit>\ne.g.:\n"+DEFAULT_DATAICON_FIELDS,ATTR_ID,this.domId(ID_DATAICON_FIELDS),ATTR_ROWS,4,ATTR_COLS,60]),o=HU.boldLabel("Initial field")+HU.br()+HU.input("",a[ID_DATAICON_INIT_FIELD]??"",[ATTR_ID,this.domId(ID_DATAICON_INIT_FIELD),ATTR_SIZE,25,ATTR_PLACEHOLDER,"Initial field"])+HU.br()+HU.boldLabel("Menu Label")+HU.br()+HU.input("",a[ID_DATAICON_LABEL]??"",[ATTR_ID,this.domId(ID_DATAICON_LABEL),ATTR_SIZE,25]);t+=HU.table(HU.tr([ATTR_VALIGN,ALIGN_TOP],HU.td(r)+HU.td(HU.div([ATTR_STYLE,HU.css(CSS_MARGIN_LEFT,HU.px(8))],o)))),t+=HU.p(),t+=HU.boldLabel("Canvas")+"W: "+HU.input("",a[ID_DATAICON_WIDTH]??"",[ATTR_ID,this.domId(ID_DATAICON_WIDTH),ATTR_SIZE,3])+" H: "+HU.input("",a[ID_DATAICON_HEIGHT]??"",[ATTR_ID,this.domId(ID_DATAICON_HEIGHT),ATTR_SIZE,3])+HU.space(2)+HU.boldLabel("Icon Size")+HU.input("",a[ID_DATAICON_SIZE]??"",[ATTR_ID,this.domId(ID_DATAICON_SIZE),ATTR_SIZE,3]),t+=HU.div([ATTR_STYLE,HU.css(CSS_PADDING_BOTTOM,HU.em(.5))],HU.boldLabel("Properties")+HU.space(1)+HU.input("",a[ID_DATAICON_PROPS]??"",[ATTR_ID,this.domId(ID_DATAICON_PROPS),ATTR_SIZE,80])),t+=HU.boldLabel("Icon Specification")+HU.br(),t+=HU.textarea("",a[ID_DATAICON_MARKERS]??"",[ATTR_ID,this.domId(ID_DATAICON_MARKERS),ATTR_ROWS,4,ATTR_COLS,90]),e.push({header:"Data Icons",contents:t})}if(this.isMultiEntry()){let t="Enter entry IDs to exclude. One per line. Note: this will take effect on map reload.";t+=HU.br(),t+=HU.textarea("",this.getAttribute("excludes")??"",[ATTR_ID,this.domId("excludes"),ATTR_ROWS,8,ATTR_COLS,60]),e.push({header:"Exclude Entries",contents:t})}},addElevations:async function(e,t){let i;if(this.mapLayer){i=[],this.mapLayer.features.forEach(((e,t)=>{let s=e.geometry.getCentroid();i.push(this.display.getMap().transformProjPoint(s))}))}else i=this.display.getLatLonPoints(this.getGeometry());await this.getElevations(i,(e=>{this.attrs.elevations=e,this.features[0].elevations=e,t()}),e)},applyPropertiesDialog:function(e){if(this.featureInfo=null,this.setName(this.jq("mapglyphname").val()),this.isMap()){let e=this.jq("entryid").val();e&&this.attrs.entryId!=e&&(this.attrs.entryId=e,setTimeout((()=>{this.checkMapLayer(!1,!0)}),10));let t=this.jq("resourceurl").val();t!=this.attrs.resourceUrl&&(this.attrs.resourceUrl=t,setTimeout((()=>{this.checkMapLayer(!1,!0)}),10))}if(this.isMultiEntry()&&(this.attrs.excludes=this.jq("excludes").val()),this.attrs[ID_LEGEND_TEXT]=this.jq(ID_LEGEND_TEXT).val(),this.isEntry()&&(this.setUseEntryName(HU.isChecked(this.jq("useentryname"))),this.setUseEntryLabel(HU.isChecked(this.jq("useentrylabel"))),this.setUseEntryLocation(HU.isChecked(this.jq("useentrylocation")))),this.setVisible(HU.isChecked(this.jq("visible")),!0,null,!0),this.jq(ID_CANSELECT).length&&(this.attrs.canSelect=HU.isChecked(this.jq(ID_CANSELECT)),this.getMapLayer()&&(this.getMapLayer().canSelect=this.attrs.canSelect),this.image&&(this.image.canSelect=this.attrs.canSelect),this.imageLayers&&this.imageLayers.forEach((e=>{e.canSelect=this.attrs.canSelect}))),this.parsedProperties=null,this.attrs.properties=this.jq(ID_MISCPROPERTIES).val(),"changed"==this.display.jq(ID_LEVEL_RANGE_CHANGED).val()?this.setVisibleLevelRange(this.display.jq(ID_LEVEL_RANGE_MIN).val(),this.display.jq(ID_LEVEL_RANGE_MAX).val()):"cleared"==this.display.jq(ID_LEVEL_RANGE_CHANGED).val()&&(this.attrs.visibleLevelRange=null,this.checkVisible()),this.setShowMarkerWhenNotVisible(HU.isChecked(this.display.jq(PROP_LEVELRANGE_SHOWMARKER))),this.isMapServer()){let e=this.jq("serverurl").val();e&&(e=e.trim(),e=e.replace(/\/(\d+)\/(\d+)\/(\d+)\.png/,"/${z}/${x}/${y}.png"),e=e.replace(/\/(\d+)\/(\d+)\/(\d+)\.jpg/,"/${z}/${x}/${y}.jpg"),e=e.replace(/\/(\d+)\/(\d+)\/(\d+)\.jpeg/,"/${z}/${x}/${y}.jpeg"),this.attrs.mapServerUrl=e)}if(this.isRings()&&(this.attrs.radii=Utils.split(this.jq("radii").val()??"",",",!0,!0),this.attrs.rangeRingLabels=this.jq("rangeringlabels").val(),this.attrs.rangeRingAngle=this.jq("rangeringangle").val(),this.attrs.rangeRingStyle=this.jq("rangeringstyle").val(),this.features.length>0&&(this.features[0].style.strokeColor=COLOR_TRANSPARENT)),this.isMultiEntry()&&this.applyChildren((t=>{let i=$.extend({},e);e.showLabels?i.label=t.style.label:i.label=null,i.externalGraphic=t.style.externalGraphic,t.applyStyle(i)})),this.isDataIconCapable()){this.jq(ID_SHOWDATAICONS).length&&this.setShowDataIcons(this.jq(ID_SHOWDATAICONS).val()),this.setAttribute(ID_DATAICON_USEENTRY,HU.isChecked(this.jq(ID_DATAICON_USEENTRY)));let e=this.getDataIconInfo();[ID_DATAICON_MARKERS,ID_DATAICON_FIELDS,ID_DATAICON_INIT_FIELD,ID_DATAICON_WIDTH,ID_DATAICON_HEIGHT,ID_DATAICON_SIZE,ID_DATAICON_LABEL,ID_DATAICON_PROPS].forEach((t=>{e[t]=this.jq(t).val()}))}e.label&&this.attrs.labelTemplate&&(this.attrs.labelTemplate=e.label),this.applyStyle(e),this.isDataIconCapable()&&(this.applyDataIcon(),this.checkDataIconMenu()),this.getImage()&&(this.getImage().setOpacity(e.imageOpacity),this.checkImage()),this.applyChildren((e=>{e.getImage()&&e.checkImage()}),!0)},featureSelected:function(e,t,i){if(this.selectedStyleGroup){let i=this.selectedStyleGroup.indices;return i.includes(e.featureIndex)?(this.selectedStyleGroup.indices=Utils.removeItem(i,e.featureIndex),MapUtils.setFeatureStyle(e,null,null)):(this.getStyleGroups().forEach(((t,i)=>{t.indices=Utils.removeItem(t.indices,e.featureIndex)})),e.originalStyle=MapUtils.setFeatureStyle(e,$.extend(e.style??{},this.selectedStyleGroup.style)),i.push(e.featureIndex)),ImdvUtils.scheduleRedraw(t,e),void this.display.featureChanged(!0)}this.display.getMap().onFeatureSelect(e.layer,i)},featureUnselected:function(e,t,i){},glyphCreated:function(){this.applyDataIcon()},isDataIconCapable:function(){return this.isEntry()||this.isGroup()||this.isMultiEntry()},getDataIconInfo:function(e){let t="dataIconInfo";this.attrs.glyphInfo&&(this.attrs[t]||(this.attrs[t]=this.attrs.glyphInfo),this.attrs.glyphInfo=null),this.attrs[t]||(this.attrs[t]={});let i=this.attrs[t];return i.glyphs&&(i[ID_DATAICON_MARKERS]||(i[ID_DATAICON_MARKERS]=i.glyphs),i.glyphs=null),i},getDataIconProperty:function(e,t){let i=!1;if(this.getAttribute(ID_DATAICON_USEENTRY))return t;let s=this.getDataIconInfo()[e];if(Utils.stringDefined(s)){if(e==ID_DATAICON_SELECTED_FIELD){let e=this.getDataIconInfo()[ID_DATAICON_FIELDS];(!Utils.stringDefined(e)||e&&e.indexOf(s)<0)&&(s=null)}if(s)return s}return e==ID_DATAICON_INIT_FIELD&&this.dataIconFieldsId&&(glyphField=jqid(this.dataIconFieldsId).val(),glyphField)?glyphField:this.getParentGlyph()?this.getParentGlyph().getDataIconProperty(e,t):t},getDataIconMarkers:function(){if(this.getAttribute(ID_DATAICON_USEENTRY)&&Utils.stringDefined(this.transientProperties.mapglyphs))return this.transientProperties.mapglyphs;let e=this.getDataIconProperty(ID_DATAICON_MARKERS);return Utils.stringDefined(e)?e:this.transientProperties.mapglyphs},checkDataIconMenu:function(){let e=this,t=this.getDataIconInfo();if(this.dataIconContainer&&jqid(this.dataIconContainer).hide(),!this.getProperty("showGlyphMenu",!0,!0))return;if(!Utils.stringDefined(t[ID_DATAICON_FIELDS]))return;this.dataIconFieldsId=HU.getUniqueId("dataiconfields_"),this.dataIconContainer&&0!=jqid(this.dataIconContainer).length||(this.dataIconContainer=HU.getUniqueId("dataiconfieldscontainer_"),this.display.jq(ID_HEADER1).append(HU.div([ATTR_STYLE,HU.css(CSS_DISPLAY,DISPLAY_INLINE_BLOCK,CSS_MARGIN_RIGHT,HU.px(20)),ATTR_ID,this.dataIconContainer]))),jqid(this.dataIconContainer).show();let i=[];Utils.split(t[ID_DATAICON_FIELDS],"\n",!0,!0).forEach((e=>{let t=Utils.split(e,",",!0,!0),s={};for(let e=1;e<t.length;e++){let i=Utils.split(t[e],"=",!0,!0);i.length>1&&(s[i[0]]=i[1])}i.push({value:t[0],label:s.label})}));let s=HU.select("",[ATTR_ID,this.dataIconFieldsId],i,Utils.getStringDefined(t[ID_DATAICON_SELECTED_FIELD],t[ID_DATAICON_INIT_FIELD])),l=Utils.getStringDefined(t[ID_DATAICON_LABEL],"Select field"),a="";this.isVisible()||(a+=" "+CLASS_LEGEND_LABEL_INVISIBLE);let r=HU.div([ATTR_CLASS,a,ATTR_STYLE,HU.css(CSS_PADDING,HU.px(4))],HU.boldLabel(l)+HU.space(1)+s);jqid(this.dataIconContainer).html(r),jqid(this.dataIconFieldsId).change((function(){e.getDataIconInfo()[ID_DATAICON_SELECTED_FIELD]=$(this).val(),e.applyDataIcon()}))},getStyleForProperties:function(e){return this.resetDataIconOriginal(e)},resetDataIconOriginal:function(e){if(e=e??this.style,this.attrs[ID_DATAICON_ORIGINAL]){let t=this.attrs[ID_DATAICON_ORIGINAL];DATAICON_PROPERTIES.forEach((i=>{e[i]=t[i]??this.style[i]}))}return this.isDataIconCapable()&&Utils.stringDefined(this.attrs.icon)&&(e.externalGraphic=this.attrs.icon),e},clearDataIcon:function(){this.getDataIconShowing()&&(this.setDataIconShowing(!1),this.resetDataIconOriginal(),this.attrs[ID_DATAICON_ORIGINAL]=null,this.applyStyle())},glyphHasBeenDropped:function(){this.getShowDataIcons()?this.applyDataIcon():this.clearDataIcon()},applyDataIcon:function(){this.isEntry()&&this.makeDataIcon(),this.applyChildren((e=>{e.applyDataIcon()}))},makeDataIcon:function(e){if(!this.isVisible())return;if(!e&&!this.getShowDataIcons())return void this.clearDataIcon();let t=this.getDataIconMarkers();if(!Utils.stringDefined(t))return;let i={entryId:this.attrs.entryId},s=[];if(t=t.replace(/\\ *\n/g,""),Utils.split(t,"\n",!0,!0).forEach((e=>{(e=e.trim()).startsWith("#")||""==e||s.push(e)})),0==s.length)return void console.log("\tno markers-2");let l=[],a=[],r={};s.forEach((e=>{(e=e.trim()).startsWith("#")||(e.startsWith("props:")?this.parseDataIconProps(r,e.substring("props:".length)):a.push(e))})),this.parseDataIconProps(r,this.getDataIconProperty(ID_DATAICON_PROPS));let o=r.sampleCount??1,n=new PointData("",null,null,HU.url(Ramadda.getUrl("/entry/data"),"record.last",o,"max",o,ARG_ENTRYID,i.entryId),{entryId:i.entryId}),h=e=>{this.makeDataIcons(n,e,l,a,r)},d={display:this.display,type:"map glyph proxy",getId:()=>"ID",pointDataLoaded:function(e,t){h(e)},pointDataLoadFailed:function(e){this.display.pointDataLoadFailed(e)},applyRequestProperties:function(e){},handleLog:function(e){this.display.handleLog(e)},displayError:function(e){console.log("Error:"+e)}};n.loadData(d,null)},parseDataIconProps:function(e,t){Utils.split(t??"",",",!0,!0).forEach((t=>{let i=Utils.split(t,":",!0,!0);2==i.length&&(e[i[0]]=i[1])}))},getDataIconShowing:function(){return this.attrs[ID_DATAICON_SHOWING]},setDataIconShowing:function(e){this.attrs[ID_DATAICON_SHOWING]=e},makeDataIcons:function(e,t,i,s,l){let a=(e,t)=>Utils.stringDefined(e)?e:t,r=a(this.getDataIconProperty(ID_DATAICON_SIZE),l.iconSize??100),o=parseFloat(a(this.getDataIconProperty(ID_DATAICON_WIDTH),l.canvasWidth??100)),n=parseFloat(a(this.getDataIconProperty(ID_DATAICON_HEIGHT),l.canvasHeight??100)),h=this.getDataIconProperty(ID_DATAICON_SELECTED_FIELD);Utils.stringDefined(h)||(h=this.getDataIconProperty(ID_DATAICON_INIT_FIELD));let d=this.getDataIconProperty(ID_DATAICON_FIELDS),g={};debugDataIcons&&console.log({size:r,canvasWidth:o,canvasHeight:n}),h&&d&&Utils.split(d,"\n",!0,!0).every((e=>{let t=Utils.split(e,",",!0,!0);if(t[0]!=h)return!0;for(let e=1;e<t.length;e++){let i=Utils.split(t[e],"=",!0,!0);g[i[0]]=i[1]??""}return!1})),s.forEach((e=>{if((e=e.trim()).startsWith("#"))return;h&&(e=e.replace(/\${_field}/g,h.replace(/ /g,"")));let s="";["scale","offset1","offset2"].forEach((e=>{g[e]&&(s+=" "+e+"="+g[e]+" ")})),e=e.replace(/\${_extra}/g,s);let a="";Object.keys(g).forEach((t=>{"unit"!=t?"label"!=t&&(e=e.replaceAll("${"+t+"}",g[t])):a=g[t]})),e=e.replaceAll(/\${icon}/g,this.getIcon()),l=Utils.clone({},l,{glyphField:h,canvasWidth:o,canvasHeight:n,entryname:this.getName(),unit:a},g),debugDataIcons&&console.log("line:"+e),l.mapGlyph=this,i.push(new Glyph(this.display,1,t.getRecordFields(),t.getRecords(),l,e))}));let p=HU.getUniqueId("canvas_"),c=HU.tag(TAG_CANVAS,[ATTR_WIDTH,o,ATTR_HEIGHT,n,ATTR_ID,p]),u=!0;i.forEach((e=>{e.okToShow()||(u=!1)})),$(document.body).append(c);let T=document.getElementById(p),f=T.getContext("2d");u&&l.fill&&(f.fillStyle=l.fill,f.fillRect(0,0,o,n)),f.strokeStyle=COLOR_BLACK,f.fillStyle=COLOR_BLACK;let y,m=[],_=t.getRecords(),S=0,A=0;if(i.forEach((e=>{y=e.getColorByInfo(),y&&this.display.applyMapGlyphColorTable(this,y);let t=e.draw(l,T,f,0,n,{findNonNan:l.findNonNan,records:_,recordIndex:_.length-1,record:_[_.length-1]});t&&m.push(t),e.isImage()||(S++,e.hadMissingValue()&&A++)})),S>0&&S==A&&(u=!1),u&&l.borderColor){f.strokeStyle=l.borderColor,f.lineWidth=parseFloat(l.borderWidth??1);let e=.5*f.lineWidth;f.strokeRect(0+e,0+e,o-2*e,n-2*e),f.strokeStyle=null,f.lineWidth=1}this.getDataIconShowing()||this.style?.externalGraphic?.startsWith("data")||(this.attrs[ID_DATAICON_ORIGINAL]={},DATAICON_PROPERTIES.forEach((e=>{this.attrs[ID_DATAICON_ORIGINAL][e]=this.style[e]}))),this.setDataIconShowing(!0);let I=()=>{if(this.getDataIconShowing()){try{let e=T.toDataURL();jqid("testimg").length&&jqid("testimg").html(HU.tag(TAG_IMG,[ATTR_SRC,e])),T.remove(),this.style.label=null,this.style.pointRadius=r,u||(this.style.pointRadius=0),this.style.externalGraphic=e}catch(e){console.error("Error",e),String(e).indexOf("insecure")>=0&&alert("There was an error making the data icon.\nPerhaps one of the images is from an external server")}if(_&&_.length>0&&this.features&&this.getProperty(PROP_MOVE_TO_LATEST_LOCATION,null,!0)){let e=_[_.length-1],t=MapUtils.createLonLat(e.getLongitude(),e.getLatitude());t=this.getMap().transformLLPoint(t),t=new OpenLayers.Geometry.Point(t.lon,t.lat),this.features.forEach((e=>{let i=e.geometry;i&&Utils.isDefined(i.x)&&(i.x=t.x,i.y=t.y,i.clearBounds())}))}this.applyStyle(this.style,!0,!0),this.display.redraw()}},b=()=>{let e=!0;m.every((t=>!!t()||(e=!1,!1))),e?I():setTimeout(b,100)};b()},setDownloadUrl:function(e){this.downloadUrl=e},setAttribute:function(e,t){this.attrs[e]=t},getAttribute:function(e,t,i){return Utils.isDefined(this.attrs[e])?Utils.getProperty(this.attrs[e]):i},getUseEntryLocation:function(){return this.attrs.useentrylocation},setUseEntryLocation:function(e){return this.attrs.useentrylocation=e,this},getUseEntryName:function(){return this.attrs.useentryname},setUseEntryName:function(e){return this.attrs.useentryname=e,this},getUseEntryLabel:function(){return this.attrs.useentrylabel},setUseEntryLabel:function(e){return this.attrs.useentrylabel=e,this},getMultiEntries:function(){if(!this.entries)return null;let e={};return this.getAttribute("excludes")&&Utils.split(this.getAttribute("excludes"),"\n",!0,!0).forEach((t=>{e[t]=!0})),this.entries.filter((t=>!e[t.getId()]))},showMultiEntries:function(){let e=this,t=this.getMultiEntries();if(!t)return;let i="",s={};t.forEach((e=>{s[e.getId()]=e;let t=e.getLink(null,!0,[ATTR_TARGET,"_entry"]);t=HU.div([ATTR_STYLE,HU.css(CSS_WHITE_SPACE,WHITE_SPACE_NOWRAP,CSS_MAX_WIDTH,HU.px(180),CSS_OVERFLOW_X,OVERFLOW_HIDDEN),ATTR_TITLE,e.getName()],t);let l="",a=HU.getIconImage("fas fa-plus");MAP_TYPES.includes(e.getType().getId())?l=HU.span([ATTR_CLASS,CLASS_CLICKABLE,ATTR_TITLE,"add map",ATTR_ENTRYID,e.getId(),ATTR_COMMAND,GLYPH_MAP],a):e.isPoint?l=HU.span([ATTR_CLASS,CLASS_CLICKABLE,ATTR_TITLE,"add data",ATTR_ENTRYID,e.getId(),ATTR_COMMAND,GLYPH_DATA],a):e.isGroup&&(l=HU.span([ATTR_CLASS,CLASS_CLICKABLE,ATTR_TITLE,"add multi entry",ATTR_ENTRYID,e.getId(),ATTR_COMMAND,GLYPH_MULTIENTRY],a)),""!=l&&(t=HU.leftRightTable(t,l)),i+=HU.div([ATTR_STYLE,HU.css(CSS_WHITE_SPACE,WHITE_SPACE_NOWRAP)],t)})),""!=i&&(i=HU.div([ATTR_CLASS,"ramadda-cleanscroll",ATTR_STYLE,HU.css(CSS_MAX_HEIGHT,HU.px(200),CSS_OVERFLOW_Y,OVERFLOW_AUTO)],HU.div([ATTR_STYLE,HU.css(CSS_MARGIN_RIGHT,HU.px(10))],i)),this.jq("multientry").html(HU.b("Entries")+i)),this.jq("multientry").find("[command]").click((function(){let t=$(this).attr(ATTR_COMMAND),i=s[$(this).attr(ATTR_ENTRYID)],l=e.display.getGlyphType(t),a=$.extend({},l.getStyle()),r={type:t,entryType:i.getType().getId(),entryId:i.getId(),name:i.getName(),icon:i.getIconUrl()};if(t===GLYPH_MAP){e.display.handleNewFeature(null,a,r).checkMapLayer()}else if(t==GLYPH_DATA)e.display.createData(r);else if(t==GLYPH_MULTIENTRY){e.display.handleNewFeature(null,a,r).addEntries(!0)}}))},getMap:function(){return this.display.getMap()},changeOrder:function(e){this.mapServerLayer?e?this.getMap().toFrontLayer(this.mapServerLayer):this.getMap().toBackLayer(this.mapServerLayer):this.getImage()?e?this.getMap().toFrontLayer(this.getImage()):this.getMap().toBackLayer(this.getImage()):this.features.length&&(e?Utils.toFront(this.display.getLayer().features,this.features,!0):Utils.toBack(this.display.getLayer().features,this.features,!0))},getId:function(){return this.id},getFilterable:function(){return!1},getAllFeatures:function(){let e=[];return this.features&&e.push(...this.features),this.mapLayer&&e.push(...this.mapLayer.features),e},getFeatures:function(){return this.features},redraw:function(){this.getMapLayer()?ImdvUtils.scheduleRedraw(this.getMapLayer(),this):this.display.redraw(this)},checkLineType:function(e){if((this.attrs.lineType==LINETYPE_GREATCIRCLE||this.attrs.lineType==LINETYPE_CURVE)&&!MapUtils.loadTurf((()=>{this.checkLineType(e)})))return;this.attrs.originalPoints||(this.attrs.originalPoints=e??this.getPoints({}));let t=e??this.attrs.originalPoints;if(!t||0==t.length)return;let i=[],s=(e,t)=>[e[t+0],e[t+1]];if(isDraggable=!0,this.attrs.lineType==LINETYPE_STEPPED){isDraggable=!1;let e=(e,t)=>e+(t-e)/2;for(let l=0;l<t.length-2;l+=2){let[a,r]=s(t,l),[o,n]=s(t,l+2);i.push(a,r),i.push(a,e(r,n)),i.push(o,e(r,n)),i.push(o,n)}}else if(this.attrs.lineType==LINETYPE_GREATCIRCLE){isDraggable=!1;for(let e=0;e<t.length-2;e+=2){let[l,a]=s(t,e),[r,o]=s(t,e+2),n=turf.point([a,l]),h=turf.point([o,r]);this.display.getTurfPoints(turf.greatCircle(n,h)).forEach((e=>{Array.isArray(e)?i.push(e[1],e[0]):i.push(e)}))}}else if(this.attrs.lineType==LINETYPE_CURVE){isDraggable=!1;let e=[];for(let i=0;i<t.length;i+=2)e.push([t[i+1],t[i]]);let s=turf.lineString(e);i=(e=>{let t=[];return e.geometry.coordinates.forEach((e=>{t.push(e[1],e[0])})),t})(turf.bezierSpline(s))}else i=t,this.attrs.originalPoints=null;this.addLine(i,isDraggable)},addLine:function(e,t){let i=[],s=2;e.length>20&&(s=parseInt(e.length/10));let l=this.display.makeFeature(this.getMap(),"OpenLayers.Geometry.LineString",this.style,e);if(l.isDraggable=t,i.push(l),this.attrs.addDots){let t={strokeWidth:Utils.isDefined(this.style.dotStrokeWidth)?this.style.dotStrokeWidth:1,pointRadius:this.style.dotSize??3,strokeColor:this.style.dotStrokeColor||this.style.strokeColor,fillColor:this.style.dotFillColor||this.style.strokeColor};Utils.stringDefined(this.style.dotExternalGraphic)&&(t.externalGraphic=this.style.dotExternalGraphic);let l=(e,s)=>{let l=this.display.makeFeature(this.getMap(),"OpenLayers.Geometry.Point",t,[e,s]);i.push(l),l.fixedStyle=!0,MapUtils.setFeatureStyle(l,t),l.isDraggable=!1};l(e[0],e[1]);for(let t=2;t<e.length-2;t+=s)l(e[t],e[t+1]);l(e[e.length-2],e[e.length-1])}this.addFeatures(i,!0,!0)},clearFeatures:function(){this.display.removeFeatures(this.features),this.features=[]},addFeatures:function(e,t,i){t&&this.clearFeatures(),this.features.push(...e),e.forEach((e=>{e.mapGlyph=this})),i&&this.display.addFeatures(e)},addFeature:function(e,t,i){this.addFeatures([e],t,i)},handleKeyDown:function(e){if("o"!=e.key&&"O"!=e.key)if("v"!=e.key){if(("r"==e.key||"l"==e.key||"R"==e.key||"L"==e.key)&&this.isImage()&&this.image){let t=.5;"l"==e.key?t=-.5:"R"==e.key?t=5:"L"==e.key&&(t=-5),this.setRotation(this.style.rotation+t),this.unselect(),this.select()}}else this.setVisible(!this.getVisible(),!0);else if(this.isImage()&&this.image){let t="o"==e.key?-.05:.05,i=parseFloat(Utils.isDefined(this.style.imageOpacity)?this.style.imageOpacity:1);i=Math.max(Math.min(i+t,1),0),this.style.imageOpacity=i,this.image.setOpacity(i)}},getStyleFromTree:function(e,t){return Utils.stringDefined(this.style[e])?this.style[e]:this.getParentGlyph()?this.getParentGlyph().getStyleFromTree(e,t):t},getStyle:function(applyMacros){if(applyMacros){let tmpStyle=this.style??{};if(Utils.stringDefined(tmpStyle.labelYOffset)||Utils.stringDefined(tmpStyle.labelXOffset)){tmpStyle=Utils.clone(tmpStyle);let a=v=>{v=String(v??"");let r=tmpStyle.pointRadius;isNaN(r)&&(r=0),v=v.replace(/\${size}/g,r).replace(/\${size2}/g,r/2);try{v=eval(v)}catch(e){console.log("error applying macro:"+e)}return v};tmpStyle.labelXOffset=a(tmpStyle.labelXOffset),tmpStyle.labelYOffset=a(tmpStyle.labelYOffset)}return tmpStyle}return this.style},panMapTo:function(e,t){if(this.isZoom())return this.attrs.mapCenter&&this.getMap().setCenter(this.attrs.mapCenter),void(e&&Utils.isDefined(this.attrs.zoomLevel)&&this.getMap().setZoom(this.attrs.zoomLevel));let i;if(this.attrs.bounds){let e=this.attrs.bounds;i=MapUtils.createBounds(e[0],e[1],e[2],e[3]),i=this.getMap().transformLLBounds(i)}if(i||(i=this.getBounds()),i){if(!this.getMap().zoomToExtent(i))return void(t&&t(this));0==i.getWidth()&&(e=!0)}e&&this.getMap().zoomTo(-1,!0)},getBounds:function(){let e=null;if(this.haveChildren()&&this.applyChildren((t=>{e=MapUtils.extendBounds(e,t.getBounds())})),this.features&&this.features.length&&(e=MapUtils.extendBounds(e,this.getMap().getFeaturesBounds(this.features))),this.extraFeatures&&(e=MapUtils.extendBounds(e,this.getMap().getFeaturesBounds(this.extraFeatures))),this.isMapServer());else if(this.getMapLayer()){if(this.getMapLayer().getVisibility()&&(e=this.display.getMap().getFeaturesBounds(this.getMapLayer().features),!e&&this.getMapLayer().maxExtent)){let t=this.getMapLayer().maxExtent;e=MapUtils.createBounds(t.left,t.bottom,t.right,t.top)}this.imageLayers&&this.imageLayers.forEach((t=>{t.layer&&t.layer.getVisibility()&&(e=MapUtils.extendBounds(e,this.getMap().getLayerVisibleExtent(t.layer)||t.layer.extent))}))}else this.displayInfo?.display&&(!this.displayInfo.display.myFeatureLayer||Utils.isDefined(this.displayInfo.display.layerVisible)&&!this.displayInfo.display.layerVisible?this.displayInfo.display.pointBounds&&(e=this.display.getMap().transformLLBounds(this.displayInfo.display.pointBounds)):e=this.display.getMap().getFeaturesBounds(this.displayInfo.display.myFeatureLayer.features));let t=this.getMultiEntries();if(!MapUtils.boundsDefined(e)&&this.isMultiEntry()&&t&&(t.forEach((t=>{let i=null;t.hasBounds()?i=MapUtils.createBounds(t.getWest(),t.getSouth(),t.getEast(),t.getNorth()):t.hasLocation()&&(i=MapUtils.createBounds(t.getLongitude(),t.getLatitude(),t.getLongitude(),t.getLatitude())),i&&(e=MapUtils.extendBounds(e,i))})),e&&(e=this.display.getMap().transformLLBounds(e))),MapUtils.boundsDefined(e))this.attrs.lastBounds=e;else if(this.attrs.lastBounds)return MapUtils.createBounds(this.attrs.lastBounds);return e},collectFeatures:function(e){if(this.haveChildren())this.applyChildren((t=>{t.collectFeatures(e)}));else if(this.features.length)e.push(...this.features);else if(this.getMapLayer()){let t=this.getMapLayer().features;t&&e.push(...t)}},getGeometry:function(){return this.features.length>0?this.features[0].geometry:null},setName:function(e){this.attrs.name=e},getName:function(){return this.attrs.name||this.name},setName:function(e){this.attrs.name=e},getFeature:function(){return this.features.length>0?this.features[0]:null},getFeatures:function(){return this.features},getType:function(){return this.type},getWikiText:function(){return this.style.wikiText||this.getPopupText()},getPopupContents:function(){let e=this.getPopupText()??"";return this.isImage()&&Utils.stringDefined(this.style.imageUrl)&&(e+=HU.image(this.style.imageUrl,[ATTR_WIDTH,HU.perc(100)])),e},getPopupText:function(){let e=this.getPopupTextInner();return e&&(e=e.replace(/\${_name}/g,this.getName())),e},getPopupTextInner:function(){return Utils.stringDefined(this.style.popupText)?this.style.popupText:this.getParentGlyph()?this.getParentGlyph().getPopupTextInner():null},getEntryId:function(){return this.attrs.entryId},hasBounds:function(){return this.isMapServer()?!!this.attrs.bounds:!this.isFixed()},getLabel:function(e){e=e??{};let t={forLegend:!1,addDecorator:!1,addIcon:!0,simple:!1};$.extend(t,e);let i,s,l=this.getName();if(Utils.stringDefined(l)?s=l:this.isFixed()?(s=this.style.text,s&&s.length>15&&(s=s.substring(0,14)+"...")):s=this.getType(),t.simple)return s;i=s;let a=this.getGlyphType(),r="";if(a){let e=Utils.getStringDefined(this.getProperty("icon"),this.style.externalGraphic,this.attrs.icon,a.getIcon());e.startsWith("data:")&&(e=this.attrs.icon),e&&e.endsWith("blank.gif")&&(e=a.getIcon()),e=HU.image(e,[ATTR_WIDTH,HU.px(18)]);let s=t.forLegend&&this.hasBounds();if(this.canHaveChildren()&&this.getProperty(PROP_LAYERS_ANIMATION_SHOW)&&(r+=SPACE+HU.span([ATTR_CLASS,CLASS_CLICKABLE,ATTR_TITLE,"Play",ATTR_ID,this.domId(PROP_LAYERS_ANIMATION_PLAY),ATTR_GLYPH_ID,this.getId(),ATTR_BUTTON_COMMAND,PROP_LAYERS_ANIMATION_PLAY],HU.getIconImage(ICON_PLAY,[],BUTTON_IMAGE_ATTRS))),s&&(r+=SPACE+HU.span([ATTR_CLASS,HU.classes(CLASS_CLICKABLE,CLASS_LEGEND_ITEM_VIEW),ATTR_GLYPH_ID,this.getId(),ATTR_TITLE,"Click:Move to; Shift-click:Zoom in"],HU.getIconImage("fas fa-eye",[],LEGEND_IMAGE_ATTRS))),t.addIcon)if(t.forLegend&&this.getProperty("showLegendBox")){let e=this.getLegendStyle(this.style);i=HU.div([ATTR_CLASS,"imdv-legend-box",ATTR_STYLE,e],"")+i}else i=HU.span([ATTR_STYLE,HU.css(CSS_MARGIN_RIGHT,HU.px(5))],e)+i}if(t.forLegend){let e=this.getProperty("legendTooltip",null);e&&(e=HU.div([],e));let t=this.getGlyphType().getName();if(this.entry){let e=this.entry.getType();e&&(t+=HU.div([],"Type:"+e.name))}let l=HU.b(HU.center(s))+HU.div([],t)+(e??"")+HU.div([],"Click to toggle visibility")+HU.div([],"Shift-click to select");i=HU.div([ATTR_TITLE,l,ATTR_STYLE,HU.css(CSS_OVERFLOW_X,OVERFLOW_HIDDEN,CSS_WHITE_SPACE,WHITE_SPACE_NOWRAP)],i)}if(""!=r&&(r=HU.span([ATTR_STYLE,HU.css(CSS_WHITE_SPACE,WHITE_SPACE_NOWRAP)],r)),t.forLegend){let e=CLASS_LEGEND_LABEL;return i=HU.div([ATTR_CLASS,HU.classes(CLASS_CLICKABLE,e),ATTR_GLYPH_ID,this.getId()],i),[i,r]}return i},loadJson:function(e){e.children&&e.children.forEach((e=>{let t=this.display.makeGlyphFromJson(e);t&&this.addChildGlyph(t)}))},removeChild:function(e){this.children&&(this.children=Utils.removeItem(this.children,e))},clearChildren:function(){if(this.children){[...this.children].forEach((e=>{e.doRemove()})),this.children=[]}},applyChildren:function(e,t){this.haveChildren()&&this.getChildren().forEach((i=>{e(i),t&&i.applyChildren(e,t)}))},getChildren:function(){return this.children||(this.children=[]),this.children},haveChildren:function(){return!!(this.children&&this.children.length>0)},findGlyph:function(e){return e==this.getId()?this:ImdvUtils.findGlyph(this.getChildren(),e)},addChildGlyph:function(e){this.getChildren().push(e),e.setParentGlyph(this)},getParentGlyph:function(){return this.parentGlyph},setParentGlyph:function(e){this.parentGlyph&&this.parentGlyph.removeChild(this),this.parentGlyph=e,e&&this.display.removeMapGlyph(this)},getLegendVisible:function(){return this.getGlyphProperty("legendVisible")},setLegendVisible:function(e){this.attrs.legendVisible=e},getFiltersVisible:function(){return this.attrs.filtersVisible},setFiltersVisible:function(e){this.attrs.filtersVisible=e},convertText:function(e){return e=(e=(e=e.replace(/\n *\*/g,"\n &bull;")).replace(/^ *\*/g,"&bull;")).replace(/\"/g,"\\").replace(/\n/g,HU.br())},getLegendDiv:function(){return this.jq(ID_GLYPH_LEGEND)},setLayerLevel:function(e){let t=t=>{t&&(e++,t.ramaddaLayerIndex=e)};return t(this.getMapLayer()),this.imageLayers&&this.imageLayers.forEach((e=>{t(e.layer)})),t(this.mapServerLayer),t(this.image),this.displayInfo?.display?.getMyMapLayers&&this.displayInfo.display.getMyMapLayers().forEach((e=>{t(e)})),this.applyChildren((t=>{e=t.setLayerLevel(e)})),e},findFilter:function(e){return this.getProperty("filter.showInMap",!1)?this.jq(ID_MAPFILTERS).find(e):this.findInLegend(e)},findInLegend:function(e){e.startsWith("imdv-")&&(e="."+e);let t="#"+this.domId(ID_GLYPH_LEGEND)+" "+e;return this.topHeaderId&&(t+=", #"+this.topHeaderId+" "+e),$(t)},checkInMapLabel:function(){let e=this.jq(ID_INMAP_LABEL);this.getProperty("showLabelInMapWhenVisible",!1)&&(this.getVisible()?e.show():e.hide()),this.getVisible()?e.removeClass("imdv-inmap-label-invisible"):e.addClass("imdv-inmap-label-invisible")},addInMapLabel:function(){this.jq(ID_INMAP_LABEL).remove();let e=this.getProperty("showLabelInMap",!1);if(e||this.getProperty("showLabelInMapWhenVisible",!1)){let t=(e?CLASS_CLICKABLE:"")+" imdv-inmap-label";this.display.getLabels().append(HU.div([ATTR_ID,this.domId(ID_INMAP_LABEL),ATTR_CLASS,t],this.getProperty("inMapLabel")??this.getName())),e&&this.jq(ID_INMAP_LABEL).click((()=>{this.setVisible(!this.getVisible(),!0)})),this.checkInMapLabel()}},makeLegend:function(e){if(this.getProperty(PROP_DONT_SHOW_IN_LEGEND))return"";this.addInMapLabel(),e=e??{};let t="";if(!this.display.getShowLegendShapes()&&this.isShape())return"";let i=this.getLabel({forLegend:!0,addDecorator:!0}),s=HU.div([ATTR_CLASS,CLASS_LEGEND_INNER],this.getLegendBody());if(this.imageLayers){let e="";this.getMapLayer()&&this.getMapLayer().features.length&&(e+=HU.div([],HU.checkbox(Utils.getUniqueId(""),[ATTR_IMAGEID,"main",ATTR_CLASS,"imdv-imagelayer-checkbox"],this.isImageLayerVisible({id:"main"}),"Main Layer"))),this.imageLayerMap={},this.imageLayers.forEach((t=>{this.imageLayerMap[t.id]=t,e+=HU.div([],HU.checkbox(Utils.getUniqueId(""),[ATTR_IMAGEID,t.id,ATTR_CLASS,"imdv-imagelayer-checkbox"],this.isImageLayerVisible(t),t.name))})),s+=HU.div([ATTR_CLASS,CLASS_LEGEND_OFFSET],e)}if(this.haveChildren()){if(this.getProperty("showTextSearch",!1)){let e=HU.input("",this.getProperty("searchtext")??"",[ATTR_STYLE,HU.css(CSS_WIDTH,HU.perc(100)),ATTR_PLACEHOLDER,"Search Text",ATTR_ID,this.domId("searchtext")]);s+=HU.div([ATTR_STYLE,HU.css(CSS_MARGIN_BOTTOM,HU.px(4),CSS_MARGIN_LEFT,HU.px(8),CSS_MARGIN_RIGHT,HU.px(8))],e)}let t="";this.applyChildren((i=>{let s=i.makeLegend(e);s&&(t+=s)})),s+=HU.div([ATTR_CLASS,CLASS_LEGEND_OFFSET],t)}let l=HU.toggleBlockNew("",s,this.getLegendVisible(),{separate:!0,headerStyle:HU.css(CSS_DISPLAY,DISPLAY_INLINE_BLOCK),extraAttributes:["map-glyph-id",this.getId()]});e.idToGlyph&&(e.idToGlyph[this.getId()]=this);let a="";return this.getVisible()||(a+=" "+CLASS_LEGEND_LABEL_INVISIBLE),this.highlighted&&(a+=" "+CLASS_LEGEND_LABEL_HIGHLIGHT),t+=HU.open(TAG_DIV,[ATTR_ID,this.domId(ID_GLYPH_LEGEND),ATTR_GLYPH_ID,this.getId(),ATTR_CLASS,HU.classes(CLASS_LEGEND_ITEM,a)]),t+=HU.div([ATTR_STYLE,HU.css(CSS_DISPLAY,DISPLAY_FLEX)],HU.div([ATTR_STYLE,HU.css(CSS_MARGIN_RIGHT,HU.px(4))],l.header)+HU.div([ATTR_STYLE,HU.css(CSS_WIDTH,HU.perc(80))],i[0])+HU.div([],i[1])),t+=HU.div([ATTR_CLASS,"imdv-legend-body"],l.body),t+=HU.close(TAG_DIV),t},getLegendStyle:function(e){e=$.extend($.extend({},this.style),e??{});let t,i,s,l="";if(Utils.stringDefined(e.fillPattern)){let t=window.olGetSvgPattern(e.fillPattern,e.strokeColor,e.fillColor);l+=HU.css(CSS_BACKGROUND_IMAGE,"url('"+t.url+"')",CSS_BACKGROUND_REPEAT,"repeat")}else e.fillColor&&(l+=HU.css(CSS_BACKGROUND,e.fillColor));return Utils.stringDefined(e.strokeColor)&&(t=e.strokeColor),Utils.stringDefined(e.strokeWidth)&&(s=e.strokeWidth),Utils.stringDefined(e.strokeDashstyle)&&(["dot","dashdot"].includes(e.strokeDashstyle)?i="dotted":e.strokeDashstyle.indexOf("dash")>=0&&(i="dashed")),(t||t||s)&&(l+=HU.css(CSS_BORDER,HU.getDimension(s??HU.px(1))+" "+(i??"solid")+" "+(t??"black"))),l},canEdit:function(){return!this.isEphemeral},makeLegendButtons:function(){let e=this.display.makeGlyphButtons(this,this.canEdit());this.isMap()&&this.getProperty("showFeaturesTable",!0)&&(this.showFeatureTableId=HU.getUniqueId("btn"),null!=e&&(e=HU.space(1)+e),e=HU.span([ATTR_ID,this.showFeatureTableId,ATTR_TITLE,"Show features table",ATTR_CLASS,CLASS_CLICKABLE],HU.getIconImage("fas fa-table",[],BUTTON_IMAGE_ATTRS))+e),this.isZoom()&&(null!=e&&(e=HU.space(1)+e),this.setLocationId=HU.getUniqueId("setlocation"),e=HU.span([ATTR_ID,this.setLocationId,ATTR_TITLE,"Set location to current viewpoint",ATTR_CLASS,CLASS_CLICKABLE],HU.image(Ramadda.getCdnUrl("/icons/binoculars.png"),[ATTR_WIDTH,HU.px(16)]))+e);let t=this.getEntryLink();return t&&(e=t+HU.space(1)+e),e},getEntryLink:function(e){if(!this.attrs.entryId)return null;let t=RamaddaUtils.getEntryUrl(this.attrs.entryId);return HU.href(t,HU.getIconImage("fas fa-home",[],BUTTON_IMAGE_ATTRS)+(e?" "+e:""),[ATTR_TARGET,"_entry",ATTR_TITLE,"View entry",ATTR_CLASS,CLASS_CLICKABLE])},getLegendBody:function(){let e=this.getProperty("showLegendInMap",!1)&&!this.display.getShowLegendInMap(),t="",i="",s=(this.getName(),this.makeLegendButtons());if(this.display.canEdit()||this.getProperty("showButtons",!0)||(s=""),""!=s&&(i+=HU.div([ATTR_CLASS,CLASS_LEGEND_OFFSET],s)),this.getProperty(PROP_LAYERS_STEP_SHOW)&&(i+=HU.div([ATTR_CLASS,HU.classes(CLASS_CLICKABLE,CLASS_BUTTON),ATTR_TITLE,"Cycle visibility children. Shift-key: all visible; Meta-key: all hidden",ATTR_GLYPH_ID,this.getId(),ATTR_BUTTON_COMMAND,PROP_LAYERS_STEP_SHOW],HU.getIconImage("fas fa-arrows-spin",[],BUTTON_IMAGE_ATTRS))),Utils.stringDefined(this.attrs[ID_LEGEND_TEXT])){let e=this.attrs[ID_LEGEND_TEXT].replace(/\n/g,HU.br());i+=HU.div([ATTR_CLASS,HU.classes(CLASS_LEGEND_OFFSET,"imdv-legend-text")],e)}let l,a=HU.css(CSS_DISPLAY,DISPLAY_INLINE_BLOCK,CSS_WIDTH,HU.px(14),CSS_HEIGHT,HU.px(14),CSS_MARGIN_RIGHT,HU.px(4)),r="",o="";if(this.isMap()){if(!this.mapLoaded)return this.isVisible()&&(i+=HU.div([ATTR_CLASS,CLASS_LEGEND_INNER],"Loading...")),i;this.getStyleGroups().forEach(((e,t)=>{o+=HU.openTag(TAG_TABLE,[ATTR_WIDTH,HU.perc(100)]),o+=HU.openTag(TAG_TR,[ATTR_TITLE,this.display.canEdit()?"Select style":"",ATTR_CLASS,HU.classes(CLASS_IMDV_STYLEGROUP,this.display.canEdit()?CLASS_CLICKABLE:""),ATTR_INDEX,t]);let i=a+this.getLegendStyle(e.style);o+=HU.tag(TAG_TD,[ATTR_WIDTH,HU.px(18)],HU.div([ATTR_STYLE,i])),o+=HU.tag(TAG_TD,[],e.label),o+=HU.close(TAG_TR,TAG_TABLE)})),""!=o&&(o=HU.div([ATTR_ID,"glyphstyle_"+this.getId()],o),e?t+=o:r+=o)}if((l=this.getMapStyleRules(!0)).length>0){let e="",t="",i=0;l.forEach((s=>{if("use"==s.type)return;if(!Utils.stringDefined(s.property))return;let l=s.property+s.type;if(t!=l){""!=e&&(e+=HU.close(TAG_TABLE));let t=s.type;"=="==t&&(t="="),t=t.replace(/</g,"&lt;").replace(/>/g,"&gt;"),e+=HU.b(this.makeLabel(s.property,!0))+" "+t+HU.br()+HU.open(TAG_TABLE,[ATTR_WIDTH,HU.perc(100)])}t=l;let r=s.value;Utils.stringDefined(s.extvalue)&&(r=s.extvalue);let o=r,n=this.getFeatureInfo(s.property);n&&(o=n.getValueLabel(r)),Utils.stringDefined(s.extvalue)&&(o=o.replace(/[\[\]\(\*\)\*\.]/g,""),o=Utils.makeLabel(o)),o=HU.span([ATTR_STYLE,HU.css(CSS_FONT_SIZE,HU.pt(9))],o);s.style.indexOf("fillPattern");let h={};s.style.split("\n").forEach((e=>{if(""==(e=e.trim()))return;let t=e.split(":");h[t[0]]=t[1]})),i++;let d=a+this.getLegendStyle(h),g=null;Utils.isDefined(h.pointRadius)&&Utils.stringDefined(h.externalGraphic??this.style.externalGraphic)&&(g=HU.image(h.externalGraphic??this.style.externalGraphic,[ATTR_WIDTH,HU.px(14)]));let p=g??HU.div([ATTR_CLASS,"circles-1",ATTR_STYLE,d]),c=HU.tr([],HU.td([ATTR_WIDTH,HU.px(16)],p)+HU.td([],o));e+=HU.div([],c)})),i||(e=null),Utils.stringDefined(e)&&(e+=HU.close(TAG_TABLE),r+=e)}""!=r&&(e?t+=r:i+=HU.toggleBlock(HU.span([ATTR_TITLE,"Legend"],HU.getIconImage("fas fa-list",null,[ATTR_STYLE,HU.css(CSS_FONT_SIZE,HU.pt(8))])),r,!0));if((this.isMapServer()||Utils.stringDefined(this.style.imageUrl)||this.imageLayers||this.image)&&this.getProperty(PROP_SHOWOPACITYSLIDER,!0)){let e=this.imageLayers||this.isImage()?this.style.imageOpacity:this.style.opacity;Utils.isDefined(e)||(e=1),i+=HU.center(HU.div([ATTR_TITLE,"Set image opacity",ATTR_SLIDER_MIN,0,ATTR_SLIDER_MAX,1,ATTR_SLIDER_VALUE,e,ATTR_ID,this.domId("image_opacity_slider"),ATTR_CLASS,CLASS_SLIDER,ATTR_STYLE,HU.css(CSS_DISPLAY,DISPLAY_INLINE_BLOCK,CSS_WIDTH,HU.perc(90))],""))}this.display.canEdit()&&this.getProperty("showRotationSlider",!1)&&(this.image||Utils.stringDefined(this.style.imageUrl))&&(i+="Rotation:",i+=HU.center(HU.div([ATTR_TITLE,"Set image rotation",ATTR_SLIDER_MIN,-360,ATTR_SLIDER_MAX,360,ATTR_SLIDER_VALUE,this.style.rotation??0,ATTR_ID,this.domId("image_rotation_slider"),ATTR_CLASS,CLASS_SLIDER,ATTR_STYLE,HU.css(CSS_DISPLAY,DISPLAY_INLINE_BLOCK,CSS_WIDTH,HU.perc(90))],"")));let n=(s,l,a)=>{l&&e?(a&&Utils.stringDefined(s)&&(s=HU.hbox([this.getDecoration(!0),s])),t+=HU.div([ATTR_STYLE,HU.css(CSS_MAX_WIDTH,HU.px(200))],s)):Utils.stringDefined(s)&&(i+=HU.div([ATTR_CLASS,"imdv-legend-body-item"],s))},h="";if(i+=HU.div([ATTR_ID,this.domId("legendcolortableprops")]),h+=HU.div([ATTR_ID,this.domId("legendcolortable_fill")]),h+=HU.div([ATTR_ID,this.domId("legendcolortable_stroke")]),h+=HU.div([ATTR_ID,this.domId(ID_MAPLEGEND)]),e?t+=h:i+=h,this.getProperty("filter.showInMap",!1)){this.jq(ID_MAPFILTERS_OUTER).remove();let e=HU.b(this.getLabel({simple:!0})),t=HU.div([ATTR_ID,this.domId(ID_MAPFILTERS_OUTER),ATTR_STYLE,HU.css(CSS_BACKGROUND,COLOR_WHITE,CSS_POSITION,POSITION_ABSOLUTE,CSS_TOP,HU.px(10),CSS_LEFT,HU.px(50),CSS_PADDING,HU.px(5)),ATTR_CLASS,CLASS_POPUP],e+HU.div([ATTR_ID,this.domId(ID_MAPFILTERS)]));this.display.jq(ID_MAP_CONTAINER).append(t),this.jq(ID_MAPFILTERS_OUTER).draggable()}else i+=HU.div([ATTR_ID,this.domId(ID_MAPFILTERS)]);if(this.type==GLYPH_LABEL&&this.style.label&&n(this.style.label.replace(/\"/g,"\\")),this.getProperty("showMeasures",!0)&&!this.isIsoline()){n(this.display.getDistances(this.getGeometry(),this.getType()),!0,!0)}if(this.isMultiEntry(),this.isShape()&&n("",!0,!0),Utils.stringDefined(this.style.imageUrl)){let e=this.getStyleFromTree("imagefilter");n(HU.center(HU.href(this.style.imageUrl,HU.image(this.style.imageUrl,[ATTR_STYLE,HU.css(CSS_MARGIN_BOTTOM,HU.px(4),CSS_BORDER,HU.border(1,COLOR_LIGHT_GRAY),CSS_WIDTH,HU.px(150),"filter",e??"")]),[ATTR_TARGET,"_image"])))}if(Utils.stringDefined(this.style.legendUrl)&&n(HU.center(HU.href(this.style.legendUrl,HU.image(this.style.legendUrl,[ATTR_TITLE,"",ATTR_ID,this.domId("legendimage"),ATTR_CLASS,"imdv-legend-image",ATTR_STYLE,HU.css(CSS_MARGIN_BOTTOM,HU.px(4),CSS_BORDER,HU.border(1,COLOR_LIGHT_GRAY),CSS_WIDTH,HU.perc(100))]),[ATTR_TARGET,"_image"]))),this.isRoute()&&this.attrs.instructions&&this.attrs.instructions.length>0){let e="";this.attrs.instructions.forEach((t=>{let i=[];t.lat?i.push(ATTR_TITLE,"Click to view",ATTR_CLASS,HU.classes(CLASS_IMDV_ROUTE_STEP,CLASS_HOVERABLE,CLASS_CLICKABLE),ATTR_LATITUDE,t.lat,ATTR_LONGITUDE,t.lon):i.push(ATTR_CLASS,CLASS_IMDV_ROUTE_STEP),e+=HU.div(i,t.instr)})),i+=HU.center(HU.b("Directions"))+HU.div([ATTR_STYLE,HU.css(CSS_MAX_HEIGHT,HU.px(200),CSS_OVERFLOW_Y,OVERFLOW_AUTO)],e)}return this.jq("maplegend").remove(),""!=t&&(t=HU.div([ATTR_TITLE,this.getName(),ATTR_STYLE,HU.css(CSS_WHITE_SPACE,WHITE_SPACE_NOWRAP,CSS_MAX_WIDTH,HU.px(150),CSS_OVERFLOW_X,OVERFLOW_HIDDEN)],HU.b(this.getName()))+t,t=HU.div([ATTR_STYLE,HU.css(CSS_BORDER_BOTTOM,CSS_BASIC_BORDER,CSS_PADDING,HU.px(4)),ATTR_ID,this.domId("maplegend")],t),this.display.addToMapLegend(this,t)),i},canDrop:function(){return!(this.getParentGlyph()&&!this.isGroup()&&!this.getParentGlyph().isGroup())},canDrag:function(){return!(this.getParentGlyph()&&!this.getParentGlyph().isGroup())},initLegend:function(){let e=this;this.canHaveChildren()&&(this.getProperty(PROP_LAYERS_ANIMATION_SHOW)&&this.jq(PROP_LAYERS_ANIMATION_PLAY).click((()=>{this.checkLayersAnimation()})),this.checkLayersAnimation()),this.jq("legendimage").tooltip({show:{delay:500},position:{my:POS_LEFT_TOP,at:POS_RIGHT_TOP,collision:"flipfit"},content:function(){return HU.image($(this).attr(ATTR_SRC),[ATTR_STYLE,HU.css(CSS_MAX_WIDTH,HU.px(450),CSS_BORDER,CSS_BASIC_BORDER)])}});let t=this.getLegendDiv().find(HU.dotClass(CLASS_IMDV_ROUTE_STEP));if(t.click((function(){let i=$(this).attr(ATTR_LONGITUDE),s=$(this).attr(ATTR_LATITUDE);Utils.isDefined(s)&&(t.removeClass("imdv-route-step-on"),$(this).addClass("imdv-route-step-on"),e.stepMarker&&e.display.removeFeatures([e.stepMarker]),e.getMap().setCenter(MapUtils.createLonLat(i,s)),e.stepMarker=e.display.makeFeature(e.getMap(),"OpenLayers.Geometry.Point",{externalGraphic:"/emojis/1f699.png",pointRadius:12},[s,i]),e.display.addFeatures([e.stepMarker]))})),this.imageLayers&&this.getLegendDiv().find(HU.dotClass("imdv-imagelayer-checkbox")).change((function(){let t=HU.isChecked($(this)),i=$(this).attr(ATTR_IMAGEID),s=e.imageLayerMap[i]??{id:i};e.setImageLayerVisible(s,t)})),this.display.canEdit()){let t=this.getLegendDiv().find(HU.dotClass(CLASS_LEGEND_LABEL)),i=()=>{e.display.setLastDroppedTime(new Date)};this.canDrag()&&this.getLegendDiv().draggable({handle:t,cursor:"crosshair",start:i,drag:i,stop:i,containment:this.display.domId(ID_LEGEND),revert:!0}),this.canDrop()&&this.display.makeLegendDroppable(this,t,i);this.jq(ID_LEGEND).find("."+CLASS_LEGEND_LABEL);let s=jqid("glyphstyle_"+this.getId()).find("."+CLASS_IMDV_STYLEGROUP);s.click((function(){if($(this).hasClass(CLASS_IMDV_STYLEGROUP_SELECTED))return $(this).removeClass(CLASS_IMDV_STYLEGROUP_SELECTED),void(e.selectedStyleGroup=null);s.removeClass(CLASS_IMDV_STYLEGROUP_SELECTED),$(this).addClass(CLASS_IMDV_STYLEGROUP_SELECTED),e.selectedStyleGroup=e.getStyleGroups()[$(this).attr(ATTR_INDEX)]}))}this.isMultiEntry()&&this.entries&&this.showMultiEntries(),this.setLocationId&&jqid(this.setLocationId).click((()=>{this.display.setZoomOptions(this.attrs)})),this.showFeatureTableId&&jqid(this.showFeatureTableId).click((function(){e.showFeaturesTable($(this))}));let i=(e,t)=>{this.setRotation(t.value)},s=(e,t)=>{this.isMapServer()?this.style.opacity=t.value:(this.image||this.imageLayers)&&(this.style.imageOpacity=t.value,this.image&&this.image.setOpacity(this.style.imageOpacity),this.imageLayers&&this.imageLayers.forEach((e=>{e.layer&&e.layer.setOpacity(this.style.imageOpacity)}))),this.applyStyle(this.style)};if(this.jq("image_rotation_slider").slider({min:-360,max:360,step:1,value:this.jq("image_rotation_slider").attr(ATTR_SLIDER_VALUE),slide:function(e,t){i(0,t)},stop:function(e,t){i(0,t)}}),this.jq("image_opacity_slider").slider({min:0,max:1,step:.01,value:this.jq("image_opacity_slider").attr(ATTR_SLIDER_VALUE),slide:function(e,t){s(0,t)},stop:function(e,t){s(0,t)}}),this.haveChildren()&&this.jq("searchtext").change((function(){let t=$(this).val();e.setProperty("searchtext",t),e.applyChildren((e=>{e.applyFeatureFilters()}),!0)})),this.isGroup()||this.makeFeatureFilters(),this.isMap()&&this.mapLoaded){let t=(t,i,s)=>{if(t&&Utils.stringDefined(t.property)){let l=this.getColorTableDisplay(t.colorTable,t.min,t.max,!0,t.isEnumeration,s,t.stringValues),a=HU.b(HU.center(this.makeLabel(t.property,!0)));if(t.isEnumeration){let e=this.getProperty("mapLegendHeight",HU.px(150));a+="\n",a+=HU.div([ATTR_STYLE,HU.css(CSS_MAX_HEIGHT,e,CSS_OVERFLOW_Y,OVERFLOW_AUTO)],l)}else a+=HU.center(l);if(this.jq("legendcolortable_"+i.toLowerCase()).html(a),this.initColorTableDots(t,this.jq("legendcolortable_"+i.toLowerCase())),t.isEnumeration){this.extraFilter||(this.extraFilter={});let l=jqid(this.domId("legendcolortable_"+i.toLowerCase())).find(".display-colortable-slice");l.css(CSS_CURSOR,CURSOR_POINTER),l.click((function(){let i=Utils.ColorTables[t.colorTable],l=HU.getUniqueId(""),a=HU.center(HU.div([ATTR_ID,l]));a+=Utils.getColorTableDisplay(i,0,0,{tooltips:s,showColorTableDots:!0,horizontal:!1,showRange:!1}),a=HU.div([ATTR_STYLE,HU.css(CSS_MIN_WIDTH,HU.px(400),CSS_MAX_WIDTH,HU.px(400),CSS_MAX_HEIGHT,HU.px(200),CSS_OVERFLOW_Y,OVERFLOW_AUTO,CSS_MARGIN,HU.px(2))],a);let r=HU.makeDialog({content:a,title:HU.div([ATTR_STYLE,HU.css(CSS_MARGIN_LEFT,HU.px(20),CSS_MARGIN_RIGHT,HU.px(20))],e.makeLabel(t.property,!0)+" Legend"),header:!0,my:POS_LEFT_TOP,at:POS_LEFT_BOTTOM,draggable:!0,anchor:$(this)});HU.initPageSearch(".display-colortable-dot-item",null,"Search",!1,{target:"#"+l}),e.initColorTableDots(t,r)}))}}},i=[];if(this.getFeatureInfoList().forEach((e=>{e.isColorTableSelect()&&i.push(e)})),i.length>1){let e=HU.select("",[ATTR_ID,this.domId("colortableproperty")],i.map((e=>({value:e.id,label:e.getLabel()}))),this.attrs.fillColorBy.property);this.jq("legendcolortableprops").html(HU.boldLabel("Color by")+e),this.jq("colortableproperty").change((()=>{let e=this.jq("colortableproperty").val(),t=this.getFeatureInfo(e);t&&($.extend(this.attrs.fillColorBy,{property:t.id,min:t.min,max:t.max}),this.applyMapStyle(),this.display.makeLegend())}))}this.getProperty("showColorTableLegend",!0)&&(t(this.attrs.fillColorBy,"Fill",this.fillStrings),t(this.attrs.strokeColorBy,"Stroke",this.strokeStrings))}this.applyChildren((e=>{e.initLegend()}))},convertPopupText:function(e){return this.getImage()&&(e=e.replace(/\${image}/g,HU.image(this.style.imageUrl,[ATTR_WIDTH,HU.px(200)]))),e},canHaveChildren:function(){return this.isGroup()||this.isMultiEntry()},isMarker:function(){return this.getType()==GLYPH_MARKER},isGroup:function(){return this.getType()==GLYPH_GROUP},isZoom:function(){return this.getType()==GLYPH_ZOOM},isEntry:function(){return this.getType()==GLYPH_ENTRY},loadEntry:function(){if(!this.attrs.entryId)return;getRamadda().getEntry(this.attrs.entryId,(e=>{this.setEntry(e)}))},setEntry:function(e){if(this.entry=e,this.isEntry()){if(this.putTransientProperty("mapglyphs",e.mapglyphs),this.getUseEntryName()&&this.setName(e.getName()),this.getUseEntryLabel()&&(this.style.label=e.getName()),this.getUseEntryLocation()&&e.hasLocation()){let t=this.display.makeFeature(this.getMap(),"OpenLayers.Geometry.Point",this.style,[e.getLatitude(),e.getLongitude()]);MapUtils.setFeatureStyle(t,this.style),this.addFeature(t,!0,!0)}this.applyDataIcon(),this.applyMapStyle(),this.display.redraw(this),this.display.makeLegend(),this.getBounds()}},isPolygon:function(){return this.type==GLYPH_POLYLINE||this.type==GLYPH_POLYGON||this.type==GLYPH_FREEHAND_CLOSED||this.type==GLYPH_FREEHAND},isImage:function(){return this.getType()==GLYPH_IMAGE},isMap:function(){return this.getType()==GLYPH_MAP},isIsoline:function(){return this.getType()==GLYPH_ISOLINE},isRoute:function(){return this.getType()==GLYPH_ROUTE},isRings:function(){return this.getType()==GLYPH_RINGS},isMapServer:function(){return this.getType()==GLYPH_MAPSERVER},isMultiEntry:function(){return this.getType()==GLYPH_MULTIENTRY},getShowDataIcons:function(){return!0===this.attrs[ID_SHOWDATAICONS]?this.attrs[ID_SHOWDATAICONS]="yes":!1===this.attrs[ID_SHOWDATAICONS]&&(this.attrs[ID_SHOWDATAICONS]="no"),"yes"===this.attrs[ID_SHOWDATAICONS]||"no"!==this.attrs[ID_SHOWDATAICONS]&&(!!this.getParentGlyph()&&this.getParentGlyph().getShowDataIcons())},setShowDataIcons:function(e){this.attrs[ID_SHOWDATAICONS]=e},setMapServerUrl:function(e,t,i,s,l){if(Utils.stringDefined(e)&&(e=e.replace(/[0-9]+\/[0-9]+\/[0-9]+/,"${z}/${x}/${y}")),this.style.legendUrl=i,this.attrs.mapServerUrl=e,this.attrs.wmsLayer=t,this.attrs.predefinedLayer=s,this.mapServerOptions=l,Utils.stringDefined(s)){if(!Utils.stringDefined(this.attrs.name)){let e=RAMADDA_MAP_LAYERS_MAP[s];e&&(this.attrs.name=e.name,this.style.legendUrl=e.opts.legend,Utils.stringDefined(e.opts.attribution)&&!Utils.stringDefined(this.attrs[ID_LEGEND_TEXT])&&(this.attrs[ID_LEGEND_TEXT]=e.opts.attribution))}}else{if(!Utils.stringDefined(t)&&e.match("&request=GetMap"))try{let i=new URL(e);e=i.protocol+"//"+i.host+i.pathname,t=i.searchParams.get("layers")}catch(e){console.log(e)}if(!Utils.stringDefined(this.attrs.name)){let t=new URL(e);this.attrs.name=t.hostname}}},getAttributes:function(){return this.attrs},getCanSelect:function(){return!Utils.isDefined(this.attrs.canSelect)||this.attrs.canSelect},setMapLayer:function(e){this.mapLayer=e,e&&(e.canSelect=this.getCanSelect(),e.mapGlyph=this,e.textGetter=e=>{let t=this.getPopupText();return"none"==t?null:(Utils.stringDefined(t)||(t="${default}"),e.attributes?this.applyMacros(t,e.attributes):null)})},getMapLayer:function(){return this.mapLayer},setMapServerLayer:function(e){this.mapServerLayer=e,e&&(e.mapGlyph=this)},getMapServerLayer:function(){return this.mapServerLayer},checkMapLayer:function(e,t){if(this.isMap()&&this.isVisible()&&(null!=this.mapLayer&&t&&(this.display.getMap().removeLayer(this.mapLayer),this.mapLayer=null),null==this.mapLayer)){if(Utils.isDefined(e),"geo_imdv"==this.attrs.entryType){if(this.dontSaveChildren=!0,this.mapLoaded)return;let e=HU.url(Ramadda.getUrl(URL_ENTRY_GET),ARG_ENTRYID,this.attrs.entryId,"fileinline",!0),t=e=>{this.mapLoaded=!0,this.makeLegend()};return void this.display.loadIMDVUrl(e,t,this)}this.setMapLayer(this.display.createMapLayer(this,this.attrs,this.style,e)),this.applyMapStyle()}},getMapServerUrl:function(){let e=this.attrs.mapServerUrl;return e=e.replace(/\/{/g,"/${"),e},getCurrentTimeStep:function(){if(Utils.isDefined(this.attrs.currentTimeStep))return this.formatDate(new Date(this.attrs.currentTimeStep))},formatDate:function(e){return e.format("isoDate")},createMapServer:function(){this.mapServerLayer=this.display.getMap().createXYZLayer(this.getName(),this.getMapServerUrl())},checkMapServer:function(e){if(this.isMapServer()&&null==this.mapServerLayer){let t=this.attrs.mapServerUrl,i=this.attrs.wmsLayer;if(Utils.stringDefined(i))this.mapServerLayer=MapUtils.createLayerWMS(this.getName(),t,{layers:i,format:"image/png",isBaseLayer:!1,srs:"epsg:4326",transparent:!0},{opacity:1});else if(Utils.stringDefined(t))this.createMapServer();else{if(!Utils.stringDefined(this.attrs.predefinedLayer))return void console.error("No map server url defined");RAMADDA_MAP_LAYERS_MAP[this.attrs.predefinedLayer]?this.mapServerLayer=this.display.getMap().makeMapLayer(this.attrs.predefinedLayer):console.error("Unknown map layer:"+this.attrs.predefinedLayer)}if(!this.mapServerLayer)return;Utils.isDefined(e)||(e=!0),Utils.isDefined(this.style.opacity)&&(this.mapServerLayer.opacity=+this.style.opacity),this.mapServerLayer.setVisibility(this.isVisible()),this.mapServerLayer.isBaseLayer=!1,this.mapServerLayer.visibility=this.isVisible(),this.mapServerLayer.canTakeOpacity=!0,this.display.getMap().addLayer(this.mapServerLayer,!0)}},getImage:function(){return this.image},setImage:function(e){this.image=e,this.image.mapGlyph=this,this.initImageLayer(this.image)},applyPropertiesComponent:function(e){let t=this.style;if(this.style=e,this.isStraightLine()){let i=!1,s=HU.isChecked(this.jq(ID_ADDDOTS));s!=this.attrs.addDots&&(this.attrs.addDots=s,i=!0),Object.keys(e).forEach((s=>{s.indexOf("dot")>=0&&t[s]!=e[s]&&(i=!0)}));let l=this.jq(ID_LINETYPE).val();l!=this.attrs.lineType&&(i=!0,this.attrs.lineType=l),i&&this.checkLineType()}if(this.isMultiEntry()){let e=this.style.childIcon;Utils.stringDefined(e)&&this.applyChildren((t=>{t.style.externalGraphic=e,t.attrs.icon=e}))}if(this.isMap()){this.attrs.subsetSkip=jqid(this.domId("subsetSkip")).val(),this.attrs.subsetReverse=HU.isChecked(jqid(this.domId("subsetReverse"))),this.attrs.subsetSimplify=HU.isChecked(jqid(this.domId("subsetSimplify"))),this.setMapPointsRange(jqid("mappoints_range").val()),this.setMapLabelsTemplate(jqid("mappoints_template").val()),this.attrs.declutter_labels=HU.isChecked(this.jq("declutter_labels")),["labels_maxlength","labels_maxlinelength","declutter_pixelsperline","declutter_pixelspercharacter","declutter_padding"].forEach((e=>{let t=this.jq(e).val();t&&(t=t.trim()),this.attrs[e]=t}));let e=this.getStyleGroups(),t=[];for(let i=0;i<20;i++){let s,l="mapstylegroups_"+i,a=e[i],r=jqid(l+"_label").val();Utils.stringDefined(r)&&(a||(a={style:{},indices:[]}),a.label=r,a.style={},Utils.stringDefined(s=jqid(l+"_fillcolor").val())&&(a.style.fillColor=s),Utils.stringDefined(s=jqid(l+"_fillopacity").val())&&(a.style.fillOpacity=s),Utils.stringDefined(s=jqid(l+"_strokecolor").val())&&(a.style.strokeColor=s),Utils.stringDefined(s=jqid(l+"_strokewidth").val())&&(a.style.strokeWidth=s),Utils.stringDefined(s=jqid(l+"_fillpattern").val())&&(a.style.fillPattern=s),t.push(a))}this.attrs.styleGroups=t}if(!this.canDoMapStyle())return;this.attrs.fillColors=HU.isChecked(this.jq(ID_FILLCOLORS)),this.attrs.strokeColors=HU.isChecked(this.jq(ID_STROKECOLORS));let i=e=>({property:this.jq(e+"colorby_property").val(),min:parseFloat(this.jq(e+"colorby_min").val()),max:parseFloat(this.jq(e+"colorby_max").val()),colorTable:this.jq(e+"colorby_colortable").val()});this.attrs.fillColorBy=i("fill"),this.attrs.strokeColorBy=i("stroke");let s=[];for(let e=0;e<20;e++){if(!Utils.stringDefined(jqid("mapproperty_"+e).val())&&!Utils.stringDefined(jqid("mapstyle_"+e).val()))continue;let t=jqid("mapvalue_"+e).val(),i=jqid("mapvalueext_"+e).val(),l={property:jqid("mapproperty_"+e).val(),type:jqid("maptype_"+e).val(),value:t,extvalue:i,style:jqid("mapstyle_"+e).val()};s.push(l)}this.attrs.mapStyleRules=s},getColorTableDisplay:function(e,t,i,s,l,a,r){l&&(s=!1);let o=Utils.ColorTables[e];if(!o)return"----";let n=l&&a.length<=30;this.getProperty("colortable.showDots")&&(n=!0);let h=Utils.getColorTableDisplay(o,t??0,i??1,{tooltips:a,stringValues:r,showColorTableDots:n,horizontal:!l||a.length>15,showRange:!1,height:"20px",showRange:s,showLabels:!1}),d=[ATTR_TITLE,e,ATTR_STYLE,HU.css(CSS_MARGIN_RIGHT,HU.px(4)),ATTR_COLORTABLE,e];return HU.div(d,h)},initColorTables:function(e){let t,i="";this.display.colorbars.forEach((s=>{let l=s[0];i+=HU.b(l)+HU.br(),s[2].forEach((s=>{let l=s[0],a="data:image/png;base64,"+s[1];i+=HU.image(a,[ATTR_CLASS,CLASS_CLICKABLE,ATTR_COLORBAR,l,ATTR_HEIGHT,HU.px(20),ATTR_WIDTH,HU.px(256),ATTR_TITLE,l]),i+=HU.br(),l==e&&(t=s[1])}))}));let s=t?"data:image/png;base64,"+t:null;this.jq("colortableproperties").html(HU.div([ATTR_ID,this.domId(ID_COLORTABLE),ATTR_CLASS,CLASS_CLICKABLE,ATTR_TITLE,"Click to select color bar"],s?HU.image(s,[ATTR_HEIGHT,HU.px(20),ATTR_WIDTH,HU.px(256)]):"No image"));let l=this;i=HU.div([ATTR_STYLE,HU.css(CSS_MARGIN,HU.px(8),CSS_MAX_HEIGHT,HU.px(200),CSS_OVERFLOW_Y,OVERFLOW_AUTO)],i),this.jq(ID_COLORTABLE).click((function(){let e=HU.makeDialog({content:i,my:POS_LEFT_TOP,at:POS_LEFT_BOTTOM,anchor:$(this)});e.find(TAG_IMG).click((function(){l.currentColorbar=$(this).attr(ATTR_COLORBAR),e.remove(),l.initColorTables(l.currentColorbar)}))}))},groupMakeGeoJson:function(){let e=!HU.isChecked(this.jq("mergepolygons")),t=[];this.applyChildren((e=>{let i=e.getGeometry();i&&t.push({geometry:i,name:e.name})})),this.makeGeoJson(e,t)},makeGeoJson:function(e,t){let i=[];t.forEach(((e,t)=>{if(!e.geometry)return;let s=this.display.getLatLonPoints(e.geometry);null!=s&&(i=Utils.mergeLists(i,s),e.points=s)}));let s=[];if(e)t.forEach(((e,t)=>{if(!e.points)return;let i,l=e.points.map((e=>[e.x,e.y])),a=e.name??"Polygon "+t;i=e.attributes?e.attributes:{name:a},s.push({type:"Feature",properties:i,geometry:{type:1==l.length?"Point":"LineString",coordinates:1==l.length?l[0]:l}})}));else{let e=i.map((e=>[e.x,e.y])),t="Polygon";s.push({type:"Feature",properties:{name:t},geometry:{type:"Polygon",coordinates:[e]}})}let l={type:"FeatureCollection",features:s},a=Utils.makeID(this.name)+".geojson";Utils.makeDownloadFile(a,JSON.stringify(l))},groupMakeCsv:function(){let e="name,latitude,longitude\n";this.applyChildren((t=>{let i=t.getGeometry();if(!i)return;let s=i.getCentroid(!0);if(!s)return;let l=this.getMap().transformProjPoint(s);e+=t.name+","+l.y+","+l.x+"\n"}));let t=Utils.makeID(this.name)+".csv";Utils.makeDownloadFile(t,e)},initPropertiesComponent:function(e){HU.initPageSearch(HU.dotClass(CLASS_IMDV_PROPERTY),null,null,!0,{target:"#"+this.domId("propsearch")}),this.isGroup()&&(this.jq("makegeojson").button().click((()=>{this.groupMakeGeoJson()})),this.jq("makecsv").button().click((()=>{this.groupMakeCsv()})));let t=[[ID_DATAICON_FIELDS,DEFAULT_DATAICON_FIELDS],[ID_DATAICON_INIT_FIELD,DEFAULT_DATAICON_FIELD],[ID_DATAICON_WIDTH,"300"],[ID_DATAICON_HEIGHT,"100"],[ID_DATAICON_SIZE,"40"],[ID_DATAICON_LABEL,""],[ID_DATAICON_PROPS,DEFAULT_DATAICON_PROPS,""],[ID_DATAICON_MARKERS,DEFAULT_DATAICONS]];this.jq("applyentrydataicon").button().click((()=>{let e="",t="";Utils.split(this.transientProperties.mapglyphs,"\n",!0,!0).forEach((i=>{i.startsWith("#")||(i.startsWith("props:")?e+=i.substring("props:".length):t+=i+"\n")}));let i={};this.parseDataIconProps(i,e),Utils.isDefined(i.canvasWidth)&&(this.jq(ID_DATAICON_WIDTH).val(i.canvasWidth),delete i.canvasWidth),Utils.isDefined(i.canvasHeight)&&(this.jq(ID_DATAICON_HEIGHT).val(i.canvasHeight),delete i.canvasHeight),Utils.isDefined(i.iconSize)&&(this.jq(ID_DATAICON_SIZE).val(i.iconSize),delete i.iconSize);let s="";Object.keys(i).forEach(((e,t)=>{t>0&&(s+=","),s+=e+":"+i[e]})),this.jq(ID_DATAICON_PROPS).val(s),this.jq(ID_DATAICON_MARKERS).val(t)})),this.jq("dataicon_add_default").button().click((()=>{t.forEach((e=>{Utils.stringDefined(this.jq(e[0]).val())||this.jq(e[0]).val(e[1])}))})),this.jq("dataicon_clear_default").button().click((()=>{t.forEach((e=>{this.jq(e[0]).val("")}))})),this.jq("createroute").button().click((()=>{this.makeGroupRoute()}));let i=this,s=this.jq("clearelevations");s.button().click((function(){i.attrs.elevations=null,$(this).attr(ATTR_DISABLED,"disabled"),$(this).addClass(CLASS_BUTTON_DISABLED)})),this.attrs.elevations||this.jq("clearelevations").prop("disabled",!0),this.jq("makeelevations").button().click((function(){$(this).html("Fetching elevations");i.addElevations(((e,t)=>($(this).html("Processed "+e+" of "+t),!0)),(()=>{s.removeClass(CLASS_BUTTON_DISABLED),s.attr(ATTR_DISABLED,null),$(this).html("Done"),setTimeout((()=>{$(this).html("Add elevations")}),3e3)}))}));let l=e=>{let t=this.getColorTableDisplay(this.jq(e+"colorby_colortable").val(),NaN,NaN,!1);this.jq(e+"colorby_colortable_label").html(t)};l("fill"),l("stroke"),e.find(HU.dotClass(CLASS_COLORTABLE_SELECT)).click((function(){let e=$(this).attr("prefix"),t=$(this).attr(ATTR_COLORTABLE);i.jq(e+"colorby_colortable").val(t),l(e)})),Utils.initCopyable(e.find(HU.dotClass(CLASS_COPYABLE)));let a=t=>{e.find("#"+this.domId(t+"colorby_property")).change((function(){let e=$(this).val();i.featureInfo.every((s=>(s.property!=e||(s.isString()||s.isEnumeration()?(i.jq(t+"colorby_min").val(""),i.jq(t+"colorby_max").val("")):(i.jq(t+"colorby_min").val(s.min),i.jq(t+"colorby_max").val(s.max))),!0)))}))};a("fill"),a("stroke"),e.find("[mapproperty_index]").change((function(){let e=i.featureInfoMap[$(this).val()];if(!e)return;let t=$(this).attr("mapproperty_index"),s="",l=jqid("mapvalue_"+t).val(),a=jqid("mapvalueext_"+t).val(),r=jqid("mapvaluewrapper_"+t);if(e.isNumeric())r.html(HU.input("",l,[ATTR_ID,"mapvalue_"+t,ATTR_SIZE,15])),s=e.min+" - "+e.max;else if(e.samples.length)if(s=Utils.join(e.getSamplesLabels(),", "),e.isEnumeration()){let i=HU.select("",[ATTR_ID,"mapvalue_"+t],e.samples,l,20),s=HU.input("",a,[ATTR_ID,"mapvalueext_"+t,ATTR_SIZE,15,ATTR_PLACEHOLDER,"pattern"]);r.html(i+HU.div([],"Or: "+s))}else r.html(HU.input("",l,[ATTR_ID,"mapvalue_"+t,ATTR_SIZE,15]))})),this.jq("dialog_features_top").length&&HU.initPageSearch(e.find(".dialog-feature"),null,null,null,{target:this.jq("dialog_features_top")}),e.find(".feature-name").click((function(){let e=h($(this));e&&i.display.getMap().centerOnFeatures([e])})),e.find(".feature-name").tooltip({show:{delay:1e3},open:function(e,t){t.tooltip.css(CSS_MAX_WIDTH,HU.px(600))},content:function(){let e=h($(this)),t=i.getFeatureText(e.attributes);return t=HU.div([ATTR_STYLE,HU.css(CSS_FONT_SIZE,HU.pt(9),CSS_WIDTH,HU.px(600))],t),t}});let r=e.find(".feature-visible"),o=e.find(".feature-select"),n=e=>{let t=HU.isChecked(e),s=e.attr("feature-index"),l=i.indexToFeature[s];l&&(MapUtils.setFeatureVisible(l,t),l.isVisible=t,l.forceHidden=!t)};this.jq("features_select_all").change((function(){let e=HU.isChecked($(this));o.each((function(){HU.isVisible($(this))&&$(this).prop("checked",e)}))})),this.jq("features_visible_all").change((function(){let e=HU.isChecked($(this));r.each((function(){HU.isVisible($(this))&&($(this).prop("checked",e),n($(this)))})),ImdvUtils.scheduleRedraw(i.mapLayer)})),r.change((function(){n($(this)),ImdvUtils.scheduleRedraw(i.mapLayer)}));let h=e=>{let t=e.attr("feature-index");return i.indexToFeature[t]};e.find(".dialog-features-size").click((function(){let e=h($(this));if(!e)return;let t=$(this).attr("feature-name");i.display.handleNewFeature(e,null,{type:GLYPH_POLYLINE,name:t})})),this.jq("dialog_features_makemap").button().click((()=>{let e=[];r.each((function(){if(!HU.isChecked($(this)))return;let t=h($(this));t&&e.push({geometry:t.geometry,attributes:t.attributes})})),0!=e.length?this.makeGeoJson(!0,e):alert("No features selected")}))},getFeaturesTable:function(e){let t,i=this.getFeatureInfoList().filter((e=>e.showTable()));this.featureTableMap={};this.getFeatureInfoList();let s,l=0;if(this.mapLayer.features.forEach(((a,r)=>{if(Utils.isDefined(a.isVisible)&&!a.isVisible)return;a.attributes;let o=0==l++;o&&(t=HU.openTag(TAG_TABLE,[ATTR_ID,e,"table-ordering","true","table-searching","true",ATTR_TABLE_HEIGHT,HU.px(400),ATTR_CLASS,HU.classes(CLASS_TABLE_ROWBORDER,CLASS_TABLE_STRIPE,CLASS_TABLE)]),t+=HU.open(TAG_THEAD,TAG_TR),s=[],i.forEach(((e,i)=>{t+=HU.tag(TAG_TH,[],e.getLabel(!0)),s.push({total:0,count:0,min:0,max:0})})),t+=HU.close(TAG_TR,TAG_THEAD,TAG_TBODY)),this.featureTableMap[r]=a,t+=HU.openTag(TAG_TR,[ATTR_TITLE,"Click to zoom to","featureidx",r,ATTR_CLASS,HU.classes("imdv-feature-table-row",CLASS_CLICKABLE)]),i.forEach(((e,i)=>{let l=s[i],r=this.getFeatureValue(a,e.property)??"";r&&Utils.isDefined(r.value)&&(r=r.value);let n=+r,h=String(r),d=e.isNumeric();d&&""!=h&&!isNaN(n)&&(l.count++,l.min=o?n:Math.min(n,l.min),l.max=o?n:Math.max(n,l.max),l.total+=n),h.indexOf("<")>=0&&(h=Utils.stripTags(h)),h=e.format(h),t+=HU.tag(TAG_TD,[ATTR_STYLE,d?HU.css(CSS_TEXT_ALIGN,ALIGN_RIGHT):"",ATTR_ALIGN,d?ALIGN_RIGHT:ALIGN_LEFT],h)}))})),s){t+="<tfoot><tr>";let e=(e,t)=>HU.tr(HU.td([ATTR_STYLE,HU.css(CSS_TEXT_ALIGN,ALIGN_RIGHT,CSS_ALIGN,ALIGN_RIGHT)],HU.b(e))+HU.td([ATTR_STYLE,HU.css(CSS_TEXT_ALIGN,ALIGN_RIGHT,CSS_ALIGN,ALIGN_RIGHT)],Utils.formatNumberComma(t)));i.forEach(((i,l)=>{let a=s[l];if(t+="<td align=right>",0!=a.count){let i=HU.open(TAG_TABLE);i+=e("Total:",a.total)+e("Min:",a.min)+e("Max:",a.max)+e("Avg:",a.total/a.count),i+=HU.close(TAG_TABLE),t+=i}t+=HU.close(TAG_TD)})),t+=HU.close(TAG_TR,TAG_TFOOT,TAG_TBODY)}return t},downloadFeaturesTable:function(e){let t,i="";this.mapLayer.features.forEach(((e,s)=>{if(Utils.isDefined(e.isVisible)&&!e.isVisible)return;let l=e.attributes;if(null==t){t=this.getFeatureInfoList().filter((e=>e.showTable()));let e=t.map(((e,t)=>e.getLabel()));i+=Utils.join(e,","),i+="\n"}let a=t.map(((e,t)=>{let i=l[e.property]??"";return Utils.isDefined(i.value)&&(i=i.value),String(i).replace(/\n/g,"_nl_")}));i+=Utils.join(a,","),i+="\n"})),Utils.makeDownloadFile("features.csv",i)},updateFeaturesTable:function(){if(!this.featuresTableDialog)return;let e=HU.getUniqueId("table"),t=this.getFeaturesTable(e),i="";t?(i+=HU.div([ATTR_STYLE,HU.css(CSS_MARGIN,HU.px(5),CSS_MAX_WIDTH,HU.px(1e3),CSS_OVERFLOW_X,"scroll")],t),i=HU.div([ATTR_STYLE,HU.css(CSS_MARGIN,HU.px(5))],i)):i+=HU.div([ATTR_STYLE,HU.css(CSS_WIDTH,HU.px(200),CSS_MARGIN,HU.px(10))],"No data"),this.jq("featurestable").html(i),HU.formatTable("#"+e,{scrollX:!0});let s=this;this.featuresTableDialog.find(".imdv-feature-table-row").click((function(){let e=s.featureTableMap[$(this).attr("featureidx")];s.display.getMap().centerOnFeatures([e])}))},showFeaturesTable:function(e){this.featuresTableDialog&&this.featuresTableDialog.remove();let t=HU.div([ATTR_ID,this.domId("downloadfeatures"),ATTR_CLASS,CLASS_CLICKABLE],"Download Table");t+=HU.div([ATTR_ID,this.domId("featurestable")]),t=HU.div([ATTR_STYLE,HU.css(CSS_MARGIN,HU.px(10))],t),this.featuresTableDialog=HU.makeDialog({content:t,title:this.name,header:!0,draggable:!0,my:POS_LEFT_TOP,at:POS_LEFT_BOTTOM,anchor:e}),this.updateFeaturesTable(),this.jq("downloadfeatures").button().click((()=>{this.downloadFeaturesTable()}))},getHelp:function(e,t){return e.startsWith("#")||(e="/userguide/imdv/"+e),HU.href(Ramadda.getUrl(e),HU.getIconImage(icon_help)+" "+(t??"Help"),[ATTR_TARGET,"_help"])},getCentroid:function(){return this.features&&this.features.length?this.features[0].geometry.getCentroid(!0):this.extraFeatures&&this.extraFeatures.length?this.extraFeatures[0].geometry.getCentroid(!0):null},makeGroupRoute:function(){let e=HU.isChecked(this.display.jq("routedosequence")),t=[];this.applyChildren((e=>{if(!e.isVisible())return;let i=e.getCentroid();if(i){var s=this.getMap().transformProjPoint(i);t.push(s)}})),0!=t.length?this.display.handleNewRoute(null,t,{doSequence:e}):alert("No points to make route from")},applyTemplate:function(e,t){return t&&e?(Object.keys(t).forEach((i=>{let s=i.toLowerCase();e=(e=e.replace("{"+s+"}",t[i])).replace("{"+i+"}",t[i])})),e):null},getFeatureText:function(e){let t=this.getProperty("textTemplate");if(t)return this.applyTemplate(t,e);if(!e)return null;let i="";return Object.keys(e).forEach((t=>{if(!e[t])return;let s=String(e[t]);s.length>100&&(s=s.substring(0,99)+"..."),i+=HU.boldLabel(t)+s+HU.br()})),i},getFeatureName:function(e){let t=this.getProperty("nameTemplate");if(t)return this.applyTemplate(t,e);if(!e)return null;let i=e.name;return i||Object.keys(e).every((t=>!(t.toLowerCase().indexOf("name")>0&&(i=e[t],i)))),i},getPropertiesComponent:function(e){if(this.isGroup()){let t=HU.leftRightTable("",this.getHelp("mapfiles.html#drawing_a_map"));t+=HU.div([ATTR_ID,this.domId("makegeojson")],"Make Map File"),t+=SPACE,t+=HU.checkbox(this.domId("mergepolygons"),[ATTR_ID,this.domId("mergepolygons")],!1,"Merge Polygons"),t+=HU.p(),t+=HU.div([ATTR_ID,this.domId("makecsv")],"Make CSV File"),t+=HU.p(),t+=HU.div([ATTR_ID,this.domId("createroute")],"Create Route"),e.push({header:"Make Map",contents:t})}if(!this.canDoMapStyle())return;let t=this.getExampleMapLayer()?.features[0].attributes??{},i=this.featureInfo=this.getFeatureInfoList(),s=(Object.keys(i),i.filter((e=>e.isNumeric()))),l=(i.filter((e=>e.isEnumeration())),""),r=HU.checkbox(this.domId(ID_FILLCOLORS),[ATTR_ID,this.domId(ID_FILLCOLORS)],this.attrs.fillColors,"Fill Colors")+SPACE+HU.checkbox(this.domId(ID_STROKECOLORS),[ATTR_ID,this.domId(ID_STROKECOLORS)],this.attrs.strokeColors,"Stroke Colors");if(l+=HU.leftRightTable(r,this.getHelp("mapfiles.html#mapstylerules")),s=i,s.length){let e=Utils.mergeLists([["","Select"]],s.map((e=>({value:e.property,label:e.getLabel()})))),t=(t,i)=>{let s="";s+=HU.div([ATTR_CLASS,"formgroupheader"],"Map value to "+i+" color")+HU.formTable(),s+=HU.formEntryLabel("Property",HU.select("",[ATTR_ID,this.domId(i+"colorby_property")],e,t.property)+SPACE2+HU.boldLabel("Range")+HU.input("",t.min??"",[ATTR_ID,this.domId(i+"colorby_min"),ATTR_SIZE,6,ATTR_TITLE,"min value"])+" -- "+HU.input("",t.max??"",[ATTR_ID,this.domId(i+"colorby_max"),ATTR_SIZE,6,ATTR_TITLE,"max value"])),s+=HU.hidden("",t.colorTable||"blues",[ATTR_ID,this.domId(i+"colorby_colortable")]);let l=Utils.getColorTablePopup({label:"Select",showToggle:!0,attr:"prefix",value:i});return s+=HU.formEntryLabel("Color table",HU.div([ATTR_ID,this.domId(i+"colorby_colortable_label")])+l),s+=HU.close(TAG_TABLE),s};l+=t(this.attrs.fillColorBy??{},"fill"),l+=t(this.attrs.strokeColorBy??{},"stroke")}let o=Utils.mergeLists([["","Select"]],i.map((e=>({value:e.property,label:e.getLabel()})))),n="",h=[];i.forEach((e=>{h.push(e.id);let t=HU.b(this.makeLabel(e.property,!0)),i="";i=e.isNumeric()?e.min+" - "+e.max:(e.isEnumeration(),Utils.join(e.getSamplesValues(),", ")),n+=t+": "+i+HU.br()}));let d=OpenLayers.Filter.Comparison,g=[d.EQUAL_TO,d.NOT_EQUAL_TO,d.LESS_THAN,d.GREATER_THAN,d.LESS_THAN_OR_EQUAL_TO,d.GREATER_THAN_OR_EQUAL_TO,[d.BETWEEN,"between"],[d.LIKE,"like"],[d.IS_NULL,"is null"],["use","Use"]],p=HU.formTable(),c="Samples&#013;";for(a in t){let e=t[a]?String(t[a]):"";e=e.replace(/"/g,"").replace(/\n/g," "),c+=a+"="+e+"&#013;"}p+=HU.tr([],HU.tds([ATTR_STYLE,HU.css(CSS_FONT_WEIGHT,FONT_BOLD)],["Property","Operator","Value","Style"]));let u=this.getMapStyleRules(!0);for(let e=0;e<20;e++){let t,i=e<u.length?u[e]:{},s=i.value??"",l=i.extvalue??"",a=this.featureInfoMap[i.property],r=c;a&&(a.isNumeric()?r=a.min+" - "+a.max:a.samples.length&&(r=Utils.join(a.getSamplesLabels(),", "))),a?.isEnumeration()?(t=HU.select("",[ATTR_ID,"mapvalue_"+e],a.getSamplesForMenu(),s,20),t+=HU.div([],HU.input("",l,[ATTR_ID,"mapvalueext_"+e,ATTR_SIZE,15,ATTR_PLACEHOLDER,"pattern"]))):t=HU.input("",s,[ATTR_ID,"mapvalue_"+e,ATTR_SIZE,15]);let n=HU.select("",[ATTR_ID,"mapproperty_"+e,"mapproperty_index",e],o,i.property),h=HU.select("",[ATTR_ID,"maptype_"+e],g,i.type);t=HU.span([ATTR_ID,"mapvaluewrapper_"+e],t);let d=Utils.stringDefined(i.style)?i.style:"",T=HU.textarea("",d,[ATTR_ID,"mapstyle_"+e,ATTR_ROWS,3,ATTR_COLS,30,ATTR_TITLE,"e.g.:&#013;fillColor:red&#013;fillOpacity:0.5&#013;<br>strokeColor:blue&#013;strokeWidth:1&#013;<br>strokeDashstyle:solid|dot|dash|dashdot|longdash|longdashdot<br>fillPattern:dots-1|circles-1|crosshatch|dialog-stripe-1|etc"]);p+=HU.tr([ATTR_VALIGN,ALIGN_TOP],HU.tds([],[n,h,t,T]))}p+=HU.close(TAG_TABLE);let T=HU.div([ATTR_CLASS,"formgroupheader"],"Style Rules")+HU.div([ATTR_CLASS,"imdv-properties-section"],p);e.push({header:"Style Rules",contents:l+T});let f=HU.leftRightTable(HU.boldLabel("Visiblity limit")+HU.select("",[ATTR_ID,"mappoints_range"],this.display.levels,this.getMapPointsRange()??"",null,!0)+" "+HU.span([ATTR_CLASS,"imdv-currentlevellabel"],"(current level: "+this.display.getCurrentLevel()+")"),this.getHelp("mapfiles.html#map_labels")),y=HU.textarea("",this.getMapLabelsTemplate()??"",[ATTR_ID,"mappoints_template",ATTR_ROWS,"6",ATTR_COLS,"40",ATTR_TITLE,"Map points template, e.g., ${code}"]),m=this.display.makeSideHelp(h,"mappoints_template",{prefix:"${",suffix:"}"});y=HU.hbox([y,HU.space(2),"Add property:"+m]);let _=this.getStyleGroups(),S=HU.leftRightTable("",this.getHelp("mapfiles.html#stylegroups"));S+=HU.openTag(TAG_TABLE,[ATTR_WIDTH,HU.perc(100)]),S+=HU.tr([],HU.tds([ATTR_STYLE,HU.css(CSS_FONT_WEIGHT,FONT_BOLD)],["Group","Fill","Opacity","Stroke","Width","Pattern","Features"]));for(let e=0;e<20;e++){let t=_[e],i="mapstylegroups_"+e;S+=HU.tr([],HU.tds([],[HU.input("",t?.label??"",[ATTR_ID,i+"_label",ATTR_SIZE,10]),HU.input("",t?.style.fillColor??"",[ATTR_CLASS,CLASS_IMDV_COLOR,ATTR_ID,i+"_fillcolor",ATTR_SIZE,6]),HU.input("",t?.style.fillOpacity??"",[ATTR_TITLE,"0-1",ATTR_ID,i+"_fillopacity",ATTR_SIZE,2]),HU.input("",t?.style.strokeColor??"",[ATTR_CLASS,CLASS_IMDV_COLOR,ATTR_ID,i+"_strokecolor",ATTR_SIZE,6]),HU.input("",t?.style.strokeWidth??"",[ATTR_ID,i+"_strokewidth",ATTR_SIZE,6]),this.display.getFillPatternSelect(i+"_fillpattern",t?.style.fillPattern??""),Utils.join(t?.indices??[],",")]))}S+=HU.closeTag(TAG_TABLE),S=HU.div([ATTR_STYLE,HU.css(CSS_MAX_HEIGHT,HU.px(300),CSS_OVERFLOW_Y,OVERFLOW_AUTO)],S),this.isGroup()||e.push({header:"Style Groups",contents:S});let A=(e,t,i)=>SPACE2+HU.boldLabel(t)+HU.input("",this.attrs[e]??"",[ATTR_PLACEHOLDER,i,ATTR_ID,this.domId(e),ATTR_SIZE,5]),I=HU.div([ATTR_STYLE,HU.css(CSS_MARGIN_TOP,HU.px(5))]),b="";b+=A("labels_maxlength","Max Length","100"),b+=A("labels_maxlinelength","Max Line Length",15),b+=I,b+=HU.checkbox(this.domId("declutter_labels"),[ATTR_ID,this.domId("declutter_labels")],this.getDeclutterLabels(),"Declutter Labels"),b+=I,b+=A("declutter_padding","Padding",2),b+=A("declutter_pixelsperline","Pixels/Line",10),b+=A("declutter_pixelspercharacter","Pixels/Character",4);let R=f+HU.boldLabel("Label Template")+HU.br()+y+b;if(e.push({header:"Labels",contents:R}),this.isMap()){let t=HU.b("Feature Subset")+HU.br();t+=HU.open(TAG_TABLE),t+=HU.formEntryLabel("Skip",HU.input("",this.attrs.subsetSkip??"0",[ATTR_ID,this.domId("subsetSkip"),ATTR_SIZE,6])+" Prunes features"),t+=HU.formEntry("",HU.checkbox(this.domId("subsetReverse"),[ATTR_ID,this.domId("subsetReverse")],this.attrs.subsetReverse,"Reverse features")),t+=HU.formEntry("",HU.checkbox(this.domId("subsetSimplify"),[ATTR_ID,this.domId("subsetSimplify")],this.attrs.subsetSimplify,"Simplify geometry (for now this sets feature.components.length=1)")),t+=HU.close(TAG_TABLE),e.push({header:"Subset",contents:t})}n=HU.div([ATTR_STYLE,HU.css(CSS_MAX_HEIGHT,HU.px(400),CSS_OVERFLOW_Y,OVERFLOW_AUTO)],n),e.push({header:"Sample Values",contents:n});let D=this.getMapFeatures();if(D&&D.length>0){let t=2e3,i="";i+="Total features: "+D.length,t<D.length&&(i+=" Showing: "+t),i+=SPACE4,i+=HU.div([ATTR_ID,this.domId("dialog_features_makemap")],"Make Map"),i+=HU.br(),i+=HU.div([ATTR_ID,this.domId("dialog_features_top")]),i+=HU.open(TAG_TABLE);let s=this.domId("features_select_all"),l=this.domId("features_visible_all"),a=(HU.checkbox(s,[ATTR_ID,s],!0,"Select"),HU.checkbox(l,[ATTR_ID,l],!0,"Visible"));i+="<tr>"+HU.tds([ATTR_STYLE,HU.css(CSS_PADDING_RIGHT,HU.px(20),CSS_FONT_WEIGHT,FONT_BOLD)],[a,"length miles/mile&sup2;/acres"])+HU.close(TAG_TR),this.indexToFeature={},D.forEach(((e,s)=>{if(this.indexToFeature[s]=e,s>t)return;let l=this.display.getDistances(e.geometry,GLYPH_POLYGON,!1,!0,!0),a=this.getFeatureName(e.attributes);a||(a="Polygon "+(s+1));let r=HU.open(TAG_TR,["feature-index",s,"feature-name",a,ATTR_DATA_CORPUS,e.isVisible?"visible":"hidden",ATTR_CLASS,"dialog-feature","data-feature",s]),o=(HU.getUniqueId("cbx"),HU.getUniqueId("cbx"));a=HU.span([ATTR_CLASS,HU.classes(CLASS_CLICKABLE,"feature-name"),"feature-index",s,ATTR_TITLE,"Click to center",ATTR_STYLE,HU.css(CSS_MARGIN_RIGHT,HU.px(10),CSS_MARGIN_LEFT,HU.px(10))],a),r+=HU.td(HU.checkbox(o,[ATTR_ID,o,ATTR_CLASS,"feature-visible","feature-index",s],!e.forceHidden&&e.isVisible)+a),r+="<td>",l&&(r+=Utils.join([Utils.formatNumberComma(l.feet/5280),Utils.formatNumberComma(l.sqmiles),Utils.formatNumberComma(l.acres)],"/")),r+=HU.close(TAG_TD,TAG_TR),i+=r})),i+=HU.close(TAG_TABLE),i=HU.div([ATTR_STYLE,HU.css(CSS_MAX_HEIGHT,HU.px(400),CSS_OVERFLOW_Y,OVERFLOW_AUTO)],i),e.push({header:"Features",contents:i})}},getStyleGroups:function(){return this.attrs.styleGroups||(this.attrs.styleGroups=[]),this.attrs.styleGroups??[]},numre:/^[\d,\.]+$/,cleanupFeatureValue:function(e){if(null===e)return null;Utils.isDefined(e.value)&&(e=e.value);let t=String(e);return""==t.trim()?"":(t.match(this.numre)&&(t=t.replace(/,/g,"").replace(/^0+/,"")),t)},getFeatureValue:function(e,t){if(!e.attributes)return null;let i=e.attributes[t];return Utils.isDefined(i)?this.cleanupFeatureValue(i):null},hasMapFeatures:function(){return!(!this.isMap()||!this?.getExampleMapLayer()?.features||0==this.getExampleMapLayer()?.features.length)},canDoMapStyle:function(){let e=this.getExampleFeatures();return!(!e||0==e.length)&&!(!e[0].attributes||0==Object.keys(e[0].attributes).length)},getMapStyleRules(e){let t=[];return this.attrs.mapStyleRules&&this.attrs.mapStyleRules.length>0&&(t=Utils.mergeLists(this.attrs.mapStyleRules)),e||this.getParentGlyph()&&(t=Utils.mergeLists(t,this.getParentGlyph().getMapStyleRules())),t},getExampleFeatures:function(){return this.getExampleMapLayer()?.features},getMapFeatures:function(){if(this.mapLayer)return this.mapLayer.features;let e=this.getChildren();if(!e)return null;let t=null;for(let i=0;i<e.length;i++){let s=e[i].getMapFeatures();s&&(t=Utils.mergeLists(t??[],s))}return t},getExampleMapLayer:function(){if(this.mapLayer)return this.mapLayer;let e=this.getChildren();if(!e)return null;for(let t=0;t<e.length;t++){let i=e[t].getExampleMapLayer();if(i)return i}return null},getFeatureInfoList:function(){if(this.featureInfo)return this.featureInfo;let e=this.getMapFeatures();if(!e||0==e.length)return[];let t=e[0].attributes,i=Object.keys(t),s=[],l=[],a=[];i.forEach((e=>{let t=new FeatureInfo(this,e),i=t.property.toLowerCase();i.indexOf("objectid")>=0?a.push(t):i.indexOf("name")>=0?s.push(t):l.push(t)}));let r=Utils.mergeLists(s,l,a),o={};return e.forEach(((e,t)=>{r.forEach((t=>{t.initValues(e)}))})),r.forEach((e=>{e.finishInit(),o[e.property]=e,o[e.id]=e})),this.featureInfoMap=o,this.isGroup()||(this.featureInfo=r),r},getFeatureInfo:function(e){return this.getFeatureInfoList(),this.featureInfoMap?this.featureInfoMap[e]:null},makeLabel:function(e,t){let i=this.getFeatureInfo(e);if(i)return i.getLabel(t);let s=Utils.makeId(e),l=e;return l="shapestlength"==s?"Shape Length":this.getProperty(s+".feature.label")?this.getProperty(s+".feature.label"):this.display.makeLabel(e),t&&(l=HU.span([ATTR_TITLE,"aka:"+s],l)),l},setProperty:function(e,t){let i=e+"="+t;if(this.attrs.properties){let t="",s=!1;Utils.split(this.attrs.properties,"\n",!0,!0).forEach((l=>{l.match("^ *"+e+" *=")&&(s=!0,l=i),t+=l+"\n"})),s||(t+=i+"\n"),this.attrs.properties=t}else this.attrs.properties=i+"\n";this.parsedProperties=null,this.display.featureChanged(!0)},getProperty:function(e,t,i){if(this.attrs.properties){this.parsedProperties||(this.parsedProperties=Utils.parseMap(this.attrs.properties,"\n","=")??{});let t=this.parsedProperties[e];if(Utils.isDefined(t))return Utils.getProperty(t)}return i&&this.getParentGlyph()?this.getParentGlyph().getProperty(e,t,!0):this.display.getMapProperty(e,t)},getTopHeader:function(){return this.topHeaderId||(this.topHeaderId=HU.getUniqueId("topheader"),this.display.appendHeader(HU.div([ATTR_CLASS,"imdv-legend-top",ATTR_STYLE,HU.css(CSS_DISPLAY,DISPLAY_INLINE_BLOCK),ATTR_ID,this.topHeaderId]))),jqid(this.topHeaderId)},makeFeatureFilters:function(){let e,t=this,i={first:"",sliders:"",enums:"",strings:"",top:[]},s=(t,s,l)=>{e?i.top.push(l):t.getProperty("filter.first")?i.first+=l:i[s]+=l},l=this.attrs.featureFilters=this.attrs.featureFilters??{};if(this.filterInfo={},this.getFeatureInfoList().forEach((t=>{if(!t.showFilter())return;e=t.getProperty("filter.top",!1,!0),this.filterInfo[t.property]=t,this.filterInfo[t.getId()]=t,l[t.property]||(l[t.property]={});let i=l[t.property];i.property=t.property;let a=t.getId(),r=HU.span([ATTR_TITLE,t.property],HU.b(t.getLabel()));if(t.isString()){i.type="string";let e,l=["filter-property",t.property,ATTR_ID,this.domId("string_"+a),ATTR_SIZE,20];l.push(ATTR_PLACEHOLDER,this.getProperty(t.property.toLowerCase()+".filterPlaceholder",""));let o=this.getProperty(t.id+".filter.rows");if(Utils.stringDefined(o)){l.push(ATTR_ROWS,o);let t=["textareaid",this.domId("string_"+a),ATTR_CLASS,CLASS_FILTER_STRINGS];e=HU.div(t,LABEL_SEARCH)+HU.textarea("",i.stringValue??"",l)}else l.push(ATTR_CLASS,CLASS_FILTER_STRING),e=HU.input("",i.stringValue??"",l);let n=r+":"+HU.br()+e+HU.br();s(t,"strings",n)}else if(t.isEnumeration()){if(i.type="enum",t.samples.length>1){let l;this.getProperty("filter.sortOnCount",!1)?(l=t.samples.sort(((e,i)=>{let s=t.seen[e.value];return t.seen[i.value]-s})),l=t.samples):l=t.samples.sort(((e,t)=>e.value.localeCompare(t.value)));let o=l.map((e=>{let i=e.label+" ("+t.seen[e.value]+")";return""==e.value&&(i="&lt;blank&gt; ("+t.seen[e.value]+")"),{value:e.value,label:i}})),n=t.filterSize(),h=r+":"+HU.br()+HU.select("",[ATTR_STYLE,HU.css(CSS_WIDTH,HU.perc(90)),"filter-property",t.property,ATTR_CLASS,"imdv-filter-enum",ATTR_ID,this.domId("enum_"+a),ATTR_MULTIPLE,null,ATTR_SIZE,n??Math.min(t.samples.length,e?3:5)],o,i.enumValues,50)+HU.br();s(t,"enums",h)}}else if((t.isNumeric()||t.isInt())&&(t.min,t.max,1)){let l=t.getProperty("filter.min",t.min),o=t.getProperty("filter.max",t.max);i.minValue=l,i.maxValue=o,i.type="range";let n=HU.leftRightTable(HU.div([ATTR_ID,this.domId("slider_min_"+a),ATTR_CLASS,CLASS_FILTER_SLIDER_LABEL],Utils.formatNumber(Utils.getDefined(i.min,l))),HU.div([ATTR_ID,this.domId("slider_max_"+a),ATTR_CLASS,CLASS_FILTER_SLIDER_LABEL],Utils.formatNumber(Utils.getDefined(i.max,o))));e&&(n=HU.div([ATTR_STYLE,HU.css(CSS_WIDTH,HU.px(120))],n));let h=HU.div([ATTR_SLIDER_MIN,l,ATTR_SLIDER_MAX,o,"slider-isint",t.isInt(),"slider-value-min",Utils.getDefined(i.min,t.min),"slider-value-max",Utils.getDefined(i.max,t.max),"filter-property",t.property,"feature-id",t.id,ATTR_CLASS,CLASS_FILTER_SLIDER,ATTR_STYLE,HU.css(CSS_DISPLAY,DISPLAY_INLINE_BLOCK,CSS_WIDTH,HU.perc(100))],"");t.getProperty("filter.animate",!1)?n+=HU.table([ATTR_WIDTH,HU.perc(100)],HU.tr([],HU.td([ATTR_WIDTH,HU.px(18)],HU.span(["feature-id",t.id,ATTR_CLASS,HU.classes(CLASS_FILTER_PLAY,CLASS_CLICKABLE),ATTR_TITLE,"Play"],HU.getIconImage(ICON_PLAY)))+HU.td([],h))):n+=h,r=HU.boldLabel(r),n=e?HU.hbox([r+HU.space(1),n]):r+HU.br()+n,s(t,"sliders",n)}})),""!=i.sliders&&(i.sliders=HU.div([ATTR_STYLE,HU.css(CSS_MARGIN_LEFT,HU.px(10),CSS_MARGIN_RIGHT,HU.px(20))],i.sliders)),""!=i.first&&(i.first=HU.div([ATTR_STYLE,HU.css(CSS_MARGIN_LEFT,HU.px(10),CSS_MARGIN_RIGHT,HU.px(20))],i.first)),this.topHeaderId&&jqid(this.topHeaderId).html(""),this.getProperty("showInHeader",!1)&&0==i.top.length&&i.top.push(""),i.top.length){let e=this.getLabel({addIcon:this.getProperty("showIconInHeader",!1),forLegend:!0})[0],t=HU.div([ATTR_STYLE,HU.css(CSS_FONT_WEIGHT,FONT_BOLD,CSS_TEXT_ALIGN,ALIGN_CENTER)],e)+HU.hbox(i.top.map((e=>HU.div([ATTR_STYLE,HU.css(CSS_MARGIN_RIGHT,HU.px(15))],e))));this.getTopHeader().html(t)}let a=i.first+i.enums+i.sliders+i.strings;if(Utils.stringDefined(a)||i.top.length){let e=()=>{this.display.featureHasBeenChanged=!0,this.applyMapStyle(!0),HU.isChecked(jqid(this.zoomonchangeid))&&this.panMapTo(),this.updateFeaturesTable()},i=HU.span([ATTR_STYLE,HU.css(CSS_MARGIN_RIGHT,HU.px(5)),ATTR_CLASS,HU.classes(CLASS_CLICKABLE,"imdv-legend-clearall"),ATTR_TITLE,"Clear Filters"],HU.getIconImage(ICON_ERASER,null,LEGEND_IMAGE_ATTRS));this.zoomonchangeid=HU.getUniqueId("andzoom");let s=this.getProperty("filters.height");a=HU.div([ATTR_STYLE,HU.css(CSS_PADDING_BOTTOM,HU.px(5),CSS_MAX_HEIGHT,s??HU.px(200),CSS_OVERFLOW_Y,OVERFLOW_AUTO)],a);let r="";this.getProperty("filter.zoomonchange.show",!0)&&(r=HU.checkbox(this.zoomonchangeid,[ATTR_TITLE,"Zoom on change",ATTR_ID,this.zoomonchangeid],this.getZoomOnChange(),HU.span([ATTR_TITLE,"Zoom on change",ATTR_STYLE,HU.css(CSS_MARGIN_LEFT,HU.px(12))],HU.getIconImage("fas fa-binoculars",[],LEGEND_IMAGE_ATTRS))));let o=HU.span([ATTR_ID,this.domId("filters_count")],Utils.isDefined(this.visibleFeatures)?"#"+this.visibleFeatures:"");if(r=HU.leftRightTable(r,i),this.getProperty("filter.toggle.show",!0)){let e=HU.toggleBlockNew("Filters "+o,r+a,this.getFiltersVisible(),{separate:!0,headerStyle:"display:inline-block;",callback:null});this.jq(ID_MAPFILTERS).html(HU.div([ATTR_STYLE,HU.css(CSS_MARGIN_RIGHT,HU.px(5))],e.header+e.body)),HU.initToggleBlock(this.jq(ID_MAPFILTERS),((e,t)=>{this.setFiltersVisible(t)}))}else r+=o,this.jq(ID_MAPFILTERS).html(HU.div([ATTR_STYLE,HU.css(CSS_MARGIN_RIGHT,HU.px(5))],r+a)),this.setFiltersVisible(!0);jqid(this.zoomonchangeid).change((function(){t.setZoomOnChange(HU.isChecked($(this)))})),this.findFilter(".imdv-legend-clearall").click((()=>{this.display.featureChanged(),this.attrs.featureFilters={},this.applyMapStyle(),this.updateFeaturesTable(),HU.isChecked(jqid(this.zoomonchangeid))&&this.panMapTo()})),this.findFilter(CLASS_FILTER_STRINGS).button().click((function(t){let i=jqid($(this).attr("textareaid")),s=i.attr("filter-property"),a=l[s]??{};a.type="string",a.stringValue=(i.val()??"").trim(),a.stringValues=Utils.split(a.stringValue,"\n",!0,!0),a.property=s,e()})),this.findFilter(CLASS_FILTER_STRING).keypress((function(t){if(13==(t.keyCode?t.keyCode:t.which)){let t=$(this).attr("filter-property"),i=l[t]??{};i.type="string",i.stringValue=($(this).val()??"").trim(),i.property=t,e()}})),this.findFilter(".imdv-filter-enum").change((function(t){let i=$(this).attr("filter-property"),s=l[i]??{};s.property=i,s.type="enum",s.enumValues=$(this).val(),e()}));let n={};this.findFilter(CLASS_FILTER_SLIDER).each((function(){let i=$(this).attr("feature-id"),s=t.getFeatureInfo(i),a=function(i,a,r){let o=s.property,n=l[o]??{};a.animValues?(n.min=a.animValues[0],n.max=a.animValues[1]):0==a.handleIndex?n.min=a.value:n.max=a.value,n.property=o,t.jq("slider_min_"+s.getId()).html(Utils.formatNumber(Utils.getDefined(n.min,n.minValue))),t.jq("slider_max_"+s.getId()).html(Utils.formatNumber(Utils.getDefined(n.max,n.maxValue))),r||t.getProperty("filter.live")||t.getProperty(s.getId()+".filter.live")?e():(t.sliderThrottle||(t.sliderThrottle=Utils.throttle((()=>{e()}),500)),t.sliderThrottle())},r=+$(this).attr(ATTR_SLIDER_MIN),o=+$(this).attr(ATTR_SLIDER_MAX),h=1,d=o-r;"true"==$(this).attr("slider-isint")?d>10&&(h=Math.max(1,Math.floor(d/100))):h=d/100,h=s.getStep(h),n[$(this).attr("feature-id")]={slider:$(this),slide:a,min:r,max:o,step:h};let g={range:!0,min:parseFloat(r),max:parseFloat(o),step:h,values:[parseFloat($(this).attr("slider-value-min")),parseFloat($(this).attr("slider-value-max"))],slide:a};$(this).slider(g)})),this.findFilter(CLASS_FILTER_PLAY).click((function(){let e=$(this).attr("playing"),i=t.filterInfo[$(this).attr("feature-id")];if(!i)return;let s=t.animationInfo[i.id];s||(t.animationInfo[i.id]=s={});let l=n[i.id];if(!l)return;let a=l.slider;if(Utils.isDefined(e)&&"true"===e)$(this).html(HU.getIconImage(ICON_PLAY)),$(this).attr("playing",!1),s.timeout&&(clearTimeout(s.timeout),s.timeout=null);else{$(this).html(HU.getIconImage(ICON_STOP)),$(this).attr("playing",!0);let e=t=>{let r=t??a.slider("values");if(r[1]>=l.max)return $(this).html(HU.getIconImage(ICON_PLAY)),void $(this).attr("playing",!1);r=[r[0],r[1]];let o=parseFloat(i.getProperty("filter.animate.step",2*l.step));r[1]=Math.min(l.max,r[1]+o),a.slider("values",r),l.slide({},{animValues:r},!0),s.timeout=setTimeout(e,i.getProperty("filter.animate.sleep",1e3))},t=a.slider("values");t[1]>=l.max?(t[1]=t[0],e(t)):e()}}))}},handleMapLoaded:function(e,t){if(t?.protocol?.format?.groundOverlays){let e=t.protocol.format,i=(t,i)=>{let s=e.getElementsByTagNameNS(t,"*",i);return s.length?s[0].innerHTML:null};this.imageLayers=[];let s=0;e.groundOverlays.forEach((t=>{let l=e.getElementsByTagNameNS(t,"*","Icon"),a=e.getElementsByTagNameNS(t,"*","LatLonBox");if(!l.length||!a.length)return;a=a[0];let r=i(t,"name"),o=i(l[0],ATTR_HREF);if(!o)return;o=o.replace(/&amp;/g,"&");let n=i(a,"north"),h=i(a,"south"),d=i(a,"east"),g=i(a,"west"),p={id:"groundoverlay_"+s++,url:o,name:r,north:n,west:g,south:h,east:d};this.imageLayers.push(p),this.isImageLayerVisible(p,s<=3)}))}this.mapLoaded=!0,this.makeFeatureFilters(),this.applyMapStyle(),this.mapLayer},addBuffer:function(e){if(!e)return;if(!MapUtils.loadTurf((()=>{this.addBuffer(e)})))return;let t=[];if(e.forEach(((e,i)=>{if(i>50)return;let s,l=e.geometry;{let e=l.getCentroid(),t=this.getMap().transformProjPoint(e);s=turf.point([t.x,t.y])}if(s){let e=turf.buffer(s,10,{units:"meters"});t.push(e)}})),t.length>0){let e=turf.featureCollection(t);console.log(e),this.display.createGeoJsonLayer("Buffer",e,null,{color:"red"})}else console.log("Could not find features to buffer")},applyMacros:function(e,t,i){i||(i=Utils.tokenizeMacros(e));let s=this.getFeatureInfoList();if(t){let l={};s.forEach((e=>{let i,s=e.property;if("object"==typeof t[s]||"Object"==typeof t[s]){let e=t[s];i=e?""+e.value:""}else i=""+t[s];i=e.format(i);let a=s.toLowerCase();l[s]=l[a]=i})),e=i.apply(l)}if(e.indexOf("${default}")>=0){let i=[],l={},a={};s.forEach((e=>{a[e.property]=e,e.showPopup()&&(i.push(e.property),l[e.property]=e.getLabel())}));let r=(e,t)=>{let i=a[e];return i&&(t=i.format(t)),t},o=e=>l[e];e=e.replace("${default}",MapUtils.makeDefaultFeatureText(t,i,r,o))}return e},initColorTableDots:function(e,t){let i=t.find(".display-colortable-dot-item");i.css({cursor:CURSOR_POINTER,title:"Click to show legend"}),i.addClass(CLASS_CLICKABLE);let s=jqid(this.domId("enum_"+Utils.makeId(e.property)));s.find("option").each((function(){if($(this).prop("selected")){let e=$(this).prop(ATTR_TITLE);t.find('.display-colortable-dot-item[label="'+e+'"]').addClass("display-colortable-dot-item-selected")}})),i.click((function(e){let t=e.metaKey||e.ctrlKey,l=$(this).attr("label"),a=$(this).hasClass("display-colortable-dot-item-selected"),r=s.find('option[value="'+l+'"]');t||(s.find("option").prop("selected",null),i.removeClass("display-colortable-dot-item-selected")),a?($(this).removeClass("display-colortable-dot-item-selected"),r.prop("selected",null)):($(this).addClass("display-colortable-dot-item-selected"),r.prop("selected","selected")),s.trigger("change")}))},addFillImage:function(e){e.forEach(((e,t)=>{if(!Utils.stringDefined(e?.attributes.fillimage))return;let i=this.getFeaturePoints(e);if(!i||5!=i.length)return;let s=[];i.forEach((e=>{let t=MapUtils.createPoint(e.x,e.y);t=this.getMap().transformProjPoint(t),s.push(t.y,t.x)})),i=s;let l={strokeColor:COLOR_TRANSPARENT,imageUrl:e.attributes.fillimage},a=new MapGlyph(this.display,GLYPH_IMAGE,{type:GLYPH_IMAGE},null,l,!0,{geometryType:"OpenLayers.Geometry.LineString",points:i});this.addChildGlyph(a),a.isEphemeral=!0,a.checkImage(e,!0)}))},getMapFeaturesToGrid:function(){if(!this.mapLayer||!this.mapLoaded)return null;return this.mapLayer.features},applyMapStyle:function(skipLegendUI){let debug=!1;debug&&console.log("applyMapStyle:"+this.getName()),this.applyChildren((e=>{e.applyMapStyle(skipLegendUI)}));let _this=this,features=this.getMapFeatures();if(!features)return;if(this.originalFeatures?features=this.originalFeatures:this.originalFeatures=features,!this.mapLayer)return;let changedFeaturesList=!1;if(this.attrs.subsetSimplify?(this.haveChangedGeometry=!0,this.mapLayer.removeFeatures(features),this.originalFeatures.forEach((e=>{e.geometry.originalComponents||(e.geometry.originalComponents=[...e.geometry.components]),e.geometry.components.length=1})),this.mapLayer.addFeatures(features)):this.haveChangedGeometry&&(this.haveChangedGeometry=!1,this.mapLayer.removeFeatures(features),features.forEach((e=>{e.geometry.originalComponents&&(e.geometry.components=[...e.geometry.originalComponents])})),this.mapLayer.addFeatures(features)),Utils.isNumber(this.attrs.subsetSkip)&&this.attrs.subsetSkip>0){let e=[],t=0;features.forEach(((i,s)=>{t--,t<0&&(e.push(i),t=this.attrs.subsetSkip)})),changedFeaturesList=!0,this.mapLayer.removeFeatures(this.originalFeatures),this.mapLayer.addFeatures(e),features=this.mapLayer.features}if(this.attrs.subsetReverse){let e=[];features.forEach((t=>{e.unshift(t)})),changedFeaturesList=!0,this.mapLayer.removeFeatures(features),this.mapLayer.addFeatures(e),features=e}changedFeaturesList||this.originalFeatures.length==features.length||(this.mapLayer.removeFeatures(this.mapLayer.features),this.mapLayer.addFeatures(this.originalFeatures),features=this.originalFeatures),skipLegendUI||!this.canDoMapStyle()||this.isGroup()||this.makeFeatureFilters(),features.length>0&&features[0].attributes?.fillimage&&this.addFillImage(features);let style=this.style;Utils.isDefined(style.externalGraphic_cleared)&&(Utils.isTrue(style.externalGraphic_cleared)&&features.forEach((e=>{e.style&&(e.style.externalGraphic=null)})),delete style.externalGraphic_cleared);let rules=this.getMapStyleRules(),useRules=[];rules&&(rules=rules.filter((e=>"use"==e.type?(useRules.push(e),!1):Utils.stringDefined(e.property)))),features&&features.forEach(((e,t)=>{e.featureIndex=t})),this.mapLabels&&(this.display.removeFeatures(this.mapLabels),this.mapLabels=null);let fillProperty=this.getProperty("map.property.fillColor"),fillOpacityProperty=this.getProperty("map.property.fillOpacity"),strokeProperty=this.getProperty("map.property.strokeColor"),labelProperty=this.getProperty("map.property.label");this.mapLayer&&(this.mapLayer.style=style),features&&features.forEach(((e,t)=>{let i=Utils.clone(style);if(e.attributes&&(fillProperty&&Utils.stringDefined(e.attributes[fillProperty])&&(i.fillColor=e.attributes[fillProperty]),fillOpacityProperty&&Utils.stringDefined(e.attributes[fillOpacityProperty])&&(i.fillOpacity=e.attributes[fillOpacityProperty]),labelProperty&&Utils.stringDefined(e.attributes[labelProperty]))){let t=e.attributes[labelProperty];if(t.length>20){let e=Utils.splitList(t.split(" "),4);t="",e.forEach((e=>{t+=Utils.join(e," ")+"\n"}))}i=Utils.clone(i,{strokeColor:COLOR_TRANSPARENT,textBackgroundFillColor:i.fillColor,textBackgroundPadding:2,textBackgroundShape:"rectangle",labelXOffset:4,labelYOffset:-8,labelAlign:"lt",fontSize:"6pt",label:t})}debug&&t<3&&console.dir("\tfeature style:",i.fillColor),ImdvUtils.applyFeatureStyle(e,i),e.originalStyle=Utils.clone(style)}));let attrs=features.length>0?features[0].attributes:{},keys=Object.keys(attrs);if(rules&&rules.length>0){this.mapLayer.style=null;let e={},t=rules.filter((t=>{let i=t.value;Utils.stringDefined(t.extvalue)&&(i=t.extvalue);let s=t.property+"__"+i;return!e[s]&&(e[s]=!0,!0)}));t=t.map((e=>(e=$.extend({},e),Utils.stringDefined(e.extvalue)&&(e.value=e.extvalue),e))),debug&&console.dir("\tadding styleMap unique rules",t),this.mapLayer.styleMap=this.display.getMap().getVectorLayerStyleMap(this.mapLayer,style,t),features.forEach(((e,t)=>{e.fidx=t,e.style=null}))}let applyColors=(e,t,i,s)=>{if(!e||!Utils.stringDefined(e?.property))return;if(0==features.length)return;s&&console.log("applyColors","#features:",features.length,t,e.max);let l=[],a=e.property,r=Number.MAX_VALUE,o=Number.MIN_VALUE,n=Utils.getColorTable(e.colorTable,!0),h=n;this.getProperty("colortable.alpha")&&(h=this.display.addAlpha(n,+this.getProperty("colortable.alpha")));let d=!1;features.forEach(((e,t)=>{let i=this.getFeatureValue(e,a);isNaN(parseFloat(i))?l.includes(i)||l.push(i):(d=!0,r=Math.min(r,i),o=Math.max(o,i))})),d?(s&&console.log("\thas numbers - not enumeration"),e.isEnumeration=!1,e.stringValues=null,Utils.isDefined(e.min)||(e.min=r),Utils.isDefined(e.max)||(e.max=o)):(s&&console.log("\tno numbers - is enumeration"),e.min=r=0,e.max=o=l.length-1,e.isEnumeration=!0,e.stringValues=[]),l=l.sort(((e,t)=>e.localeCompare(t))),e.stringValues&&l.forEach(((t,i)=>{let s=i<n.length?n[i]:n[i-1];e.stringValues.push({value:t,color:s})})),d||i.push(...l);let g=e.max-e.min;s&&console.log("applyColors min:"+e.min+" max:"+e.max),features.forEach(((i,r)=>{let o,d=this.getFeatureValue(i,a);if(Utils.isDefined(d)){if(e.isEnumeration)o=l.indexOf(d)%n.length;else{d=+d;let t=(d-e.min)/g;o=Math.max(0,Math.min(n.length-1,Math.round(t*n.length)))}i.style||(i.style=$.extend({},style)),i.style[t]=h[o],i.originalStyle&&(i.originalStyle[t]=n[o]),s&&r<3&&console.log("\t"+t+"="+i.style[t])}}))};this.fillStrings=[],this.strokeStrings=[],applyColors(this.attrs.fillColorBy,"fillColor",this.fillStrings),applyColors(this.attrs.strokeColorBy,"strokeColor",this.strokeStrings),useRules.length>0&&(debug&&console.log("\tuseRules:"+useRules?.length),useRules.forEach((rule=>{let styles=[],styleMap={};Utils.split(rule.style,"\n",!0,!0).forEach((e=>{let t=[],i=e.indexOf(":");i>=0&&(t.push(e.substring(0,i).trim()),t.push(e.substring(i+1).trim())),2==t.length&&(styleMap[t[0].trim()]=t[1].trim(),styles.push(t[0].trim()))})),features.forEach(((f,idx)=>{f.style||(f.style=$.extend({},style)),f.originalStyle||(f.originalStyle=$.extend({},f.style));let value=this.getFeatureValue(f,rule.property);value&&styles.forEach((style=>{let v=styleMap[style];if(v=v.replace("${value}",value),v.startsWith("js:")){v=v.substring(3);try{v=eval(v)}catch(e){console.error("Error evaluating style rule:"+v)}}f.style[style]=v,f.originalStyle[style]=v}))}))})));let needToAddMapLabels=!1;if(Utils.stringDefined(this.getMapLabelsTemplate())){let e=parseInt(this.attrs.labels_maxlength??1e3),t=parseInt(this.attrs.labels_maxlinelength??1e3);needToAddMapLabels=!0,this.mapLabels=[];let i=$.extend({},this.style);i.pointRadius=0,i.externalGraphic=null;let s=this.getMapLabelsTemplate().replace(/\\n/g,"\n"),l=Utils.tokenizeMacros(s);features.forEach(((a,r)=>{let o=a.geometry.getCentroid(!0),n=$.extend({},i),h=this.applyMacros(s,a.attributes,l);if(h.length>e&&(h=h.substring(0,e)+"..."),t>0){let e="",i=0,s="";for(let l=0;l<h.length;l++){let a=h[l];i++>t&&(" "!=s&&" "!=a&&(e+="-"),e+="\n",i=0),s=a,e+=a}h=e.trim()}n.label=h;let d=MapUtils.createVector(o,null,n);d.point=o,a.mapLabel=d,this.mapLabels.push(d)}))}if(this.visibleFeatures=0,this.applyFeatureFilters(features),this.attrs.fillColors){let e=Utils.getColorTable("d3_schemeCategory20",!0),t=0;features.forEach(((i,s)=>{i.style=i.style??{},t++,t>=e.length&&(t=0),i.originalStyle&&(i.originalStyle.fillColor=e[t]),i.style.fillColor=e[t]}))}if(this.attrs.strokeColors){let e=Utils.getColorTable("gpt50",!0),t=0;features.forEach(((i,s)=>{i.style=i.style??{},t++,t>=e.length&&(t=0),i.originalStyle&&(i.originalStyle.strokeColor=e[t]),i.style.strokeColor=e[t]}))}let indexToGroup={};this.getStyleGroups().forEach((e=>{e.indices.forEach((t=>{indexToGroup[t]=e}))})),features.forEach(((e,t)=>{let i=indexToGroup[t];i&&(e.style=$.extend({},e.style),$.extend(e.style,i.style),e.originalStyle||(e.originalStyle={}),$.extend(e.originalStyle,i.style))})),this.mapLayer.features.forEach((e=>{e.style&&e.style.fillPattern&&!Utils.stringDefined(e.style.fillColor)&&(e.style.fillColor=COLOR_TRANSPARENT)})),this.checkVisible(),needToAddMapLabels&&this.display.addFeatures(this.mapLabels),ImdvUtils.scheduleRedraw(this.mapLayer)},applyFeatureFilters:function(e){let t=!1;if(e||(e=this.mapLayer?.features,t=!0),!e)return;let i=this.attrs.featureFilters??{},s=[],l=[],r=[];for(a in i){let e=i[a];if(!e.property)continue;let t=this.getFeatureInfo(e.property);t&&(t&&!t.showFilter()||("string"==e.type?Utils.stringDefined(e.stringValue)&&l.push(e):"enum"==e.type?e.enumValues&&e.enumValues.length>0&&r.push(e):(Utils.isDefined(e.min)||Utils.isDefined(e.max))&&(e.min==e.minValue&&e.max==e.maxValue||s.push(e))))}let o=!1,n=this.getProperty("showTextSearch",null,!0)?this.getProperty("searchtext",null,!0):null;n=Utils.stringDefined(n)?n.toLowerCase():null,e.forEach(((e,t)=>{let i=!0;if(s.every((t=>{let s=this.getFeatureValue(e,t.property);return Utils.isDefined(s)&&(s=+s,Utils.isDefined(t.min)&&s<t.min&&(i=!1),i&&Utils.isDefined(t.max)&&s>t.max&&(i=!1)),i})),i&&l.every((t=>{let s=this.getFeatureValue(e,t.property)??"";if(Utils.isDefined(s)){s=String(s);let e=s.toLowerCase();t.stringValues?(i=!1,t.stringValues.every((t=>!("*"==t||s.indexOf(t)>=0||e.indexOf(t)>=0)||(i=!0,!1)))):i="*"==t.stringValue||s.indexOf(t.stringValue)>=0||e.indexOf(t.stringValue)>=0}return i})),i&&n&&e.attributes){let t=0,s=!1;Object.keys(e.attributes).every((i=>{let l=e.attributes[i];return!l||"string"!=typeof l||(t++,s=l.toLowerCase().indexOf(n)>=0,!s)})),t&&!s&&(i=!1)}i&&r.every((t=>{let s=this.getFeatureValue(e,t.property)??"";return i=t.enumValues.includes(s),i})),i&&this.visibleFeatures++,e.isVisible=i,e.isFiltered=!i,MapUtils.setFeatureVisible(e,i&&!e.forceHidden),e.mapLabel&&(o=!0,e.mapLabel.isFiltered=!i,MapUtils.setFeatureVisible(e.mapLabel,i))})),this.jq("filters_count").html("#"+this.visibleFeatures),t&&ImdvUtils.scheduleRedraw(this.mapLayer),o&&this.display.redraw()},checkRings:function(e){if(!this.features[0])return void console.log("range rings has no features");let t=$.extend({},this.features[0].style);t.strokeColor=COLOR_TRANSPARENT,this.features[0].style=t;let i=this.features[0].geometry.getCentroid(),s=this.display.getMap().transformProjPoint(i);this.extraFeatures&&this.display.removeFeatures(this.extraFeatures);let l={};this.attrs.rangeRingStyle&&Utils.split(this.attrs.rangeRingStyle,"\n",!0,!0).forEach((e=>{let t=e.split(",");l[t[0]]={};for(let e=1;e<t.length;e++){let i=t[e].split(":");l[t[0]][i[0]]=i[1]}}));let a=[];Utils.stringDefined(this.attrs.rangeRingLabels)&&(a=Utils.split(this.attrs.rangeRingLabels)),this.setExtraFeatures(this.display.makeRangeRings(s,this.getRadii(),this.style,this.attrs.rangeRingAngle,l,a))},setExtraFeatures:function(e){this.extraFeatures=e,this.extraFeatures&&(this.extraFeatures.forEach((e=>{e.mapGlyph=this,MapUtils.setFeatureVisible(e,this.isVisible())})),this.display.addFeatures(this.extraFeatures))},applyStyle:function(e,t,i){e&&e.label&&e.label.indexOf("${name}")>=0?(this.attrs.labelTemplate=e.label,e.label=e.label.replace("${name}",this.getName())):this.attrs.labelTemplate=null,e&&(this.style=e),this.isDataIconCapable()&&!i&&this.resetDataIconOriginal(),this.applyMapStyle(),this.getMapServerLayer()&&Utils.isDefined(this.style.opacity)&&(this.getMapServerLayer().opacity=+this.style.opacity,this.getMapServerLayer().setVisibility(!1),this.getMapServerLayer().setVisibility(!0),ImdvUtils.scheduleRedraw(this.getMapServerLayer()));let s=this.getStyle(!0);this.features.forEach((e=>{e.style&&!e.fixedStyle&&$.extend(e.style,s)})),this.isFixed()&&this.addFixed(),this.isRings()&&this.checkRings(),t||this.display.featureChanged(!0)},vertexDragged:function(e,t,i){this.display.checkSelected(this)},move:function(e,t){let i=this.attrs.originalPoints;if(i)for(let s=0;s<i.length;s+=2){let l=MapUtils.createPoint(i[s+1],i[s]);l=this.getMap().transformLLPoint(l),l.x+=e,l.y+=t,l=this.getMap().transformProjPoint(l),i[s]=l.y,i[s+1]=l.x}this.getUseEntryLocation()&&this.setUseEntryLocation(!1),this.extraFeatures&&this.extraFeatures.forEach((i=>{i.geometry.move(e,t),i.layer.drawFeature(i)})),this.features.forEach((i=>{i.geometry.move(e,t),i.layer.drawFeature(i)})),this.image&&(this.image.extent.left+=e,this.image.extent.right+=e,this.image.extent.top+=t,this.image.extent.bottom+=t,this.image.moveTo(this.image.extent,!0,!0)),this.getParentGlyph()?.isMultiEntry()&&(this.overrideLocation=this.getPoints({})),this.display.checkSelected(this)},removeImage:function(){this.image&&(this.display.getMap().removeLayer(this.image),this.image=null)},getMap:function(){return this.display.getMap()},setRotation:function(e){if(this.style.rotation=e,!this.image)return;this.image&&this.image.imageHook&&this.image.imageHook();let t=this.features[0];if(!t)return;let i=this.getFeaturePoints(t);if(!i)return void console.log("MapGlyph.setRotation: no points");let s=this.image.extent,l=s.getCenterPixel();[[s.left,s.top],[s.right,s.top],[s.right,s.bottom],[s.left,s.bottom],[s.left,s.top]].forEach(((e,t)=>{let s=e[0],a=e[1],r=Utils.rotate(l.x,l.y,s,a,this.style.rotation,!0);i[t].x=r.x,i[t].y=r.y})),this.display.redraw(this)},getFeaturePoints:function(e){if(!e||!e.geometry)return null;let t=e.geometry.components;return t[0]&&t[0].components?t[0].components:t},checkImage:function(e,t){if(this.image&&Utils.isDefined(this.image.opacity)&&(this.style.imageOpacity=this.image.opacity),!this.style.imageUrl)return;if(!(e=e??this.features[0]))return;let i=this.getFeaturePoints(e);if(!i)return void console.log("MapGlyph.checkImage: no points");let s=MapUtils.createBoundsFromPoints(i),l=Utils.getRotation(i),a=s.getCenterPixel(),r=i.map((e=>Utils.rotate(a.x,a.y,e.x,e.y,l.angle)));t&&(this.style.rotation=l.angle-180),s=MapUtils.createBoundsFromPoints(r),this.image?(this.image.extent=s,this.image.moveTo(s,!0,!0)):(s=this.getMap().transformProjBounds(s),this.image=this.getMap().addImageLayer(this.getName(),this.getName(),"",this.style.imageUrl,!0,s.top,s.left,s.bottom,s.right),this.image.textGetter=()=>(console.log(0),""),this.initImageLayer(this.image),Utils.isDefined(this.style.imageOpacity)&&this.image.setOpacity(this.style.imageOpacity)),this.setRotation(this.style.rotation)},getImageTransform:function(){let e="";return Utils.stringDefined(this.style.transform)&&(e=this.style.transform),Utils.isDefined(this.style.rotation)&&0!=this.style.rotation&&(e+=" rotate("+this.style.rotation+"deg)"),Utils.stringDefined(e)||(e=null),e},initImageLayer:function(e){this.image=e,e.imageHook=e=>{let t=this.getImageTransform(),i=this.image.div.childNodes;for(let e=0,s=i.length;e<s;++e){let s=i[e].firstChild||i[e],l=i[e].lastChild;l&&"iframe"===l.nodeName.toLowerCase()&&(s=l.parentNode),s.style&&(s.style.transform=t),s.style["clip-path"]=this.style.clippath,this.style.imagecss&&Utils.split(this.style.imagecss,"\n",!0,!0).forEach((e=>{let t=Utils.split(e,"=",!0,!0);s.style[t[0]]=t[1]})),s.style.filter=this.getStyleFromTree("imagefilter")}}},getDisplayAttrs:function(){return this.attrs.displayAttrs},applyDisplayAttrs:function(e){this.displayInfo&&this.displayInfo.display&&(this.displayInfo.display.deleteDisplay(),this.displayInfo.display=null,jqid(this.displayInfo.divId).remove(),jqid(this.displayInfo.bottomDivId).remove()),this.addData(e,!1)},isVisible:function(){return this.attrs.visible??!0},getDeclutterLabels:function(){return Utils.isDefined(this.attrs.declutter_labels)?this.attrs.declutter_labels:this.getProperty("declutter.labels",!0)},setShowMarkerWhenNotVisible:function(e){return this.attrs.showMarkerWhenNotVisible=e,this},getZoomOnChange:function(){return this.attrs.zoomOnChange},setZoomOnChange:function(e){return this.attrs.zoomOnChange=e,this},getMapPointsRange:function(){return this.attrs.mapPointsRange},setMapPointsRange:function(e){return this.attrs.mapPointsRange=e,this},getMapLabelsTemplate:function(){return this.attrs.mapLabelsTemplate},setMapLabelsTemplate:function(e){return this.attrs.mapLabelsTemplate=e,this},getShowMarkerWhenNotVisible:function(){return this.attrs.showMarkerWhenNotVisible},getVisibleLevelRange:function(e){let t=this.attrs.visibleLevelRange;return e||t&&Utils.isDefined(t.min)||!this.getParentGlyph()?this.attrs.visibleLevelRange:this.getParentGlyph().getVisibleLevelRange()},setVisible:function(e,t,i,s){if(this.isZoom())return void this.panMapTo(!0);this.highlighted=i,e||this.stepMarker&&this.display.removeFeatures([this.stepMarker]),this.attrs.visible=e,this.checkInMapLabel(),s||this.applyChildren((i=>{i.setVisible(e,t)})),Utils.forEach(this.extraFeatures,(t=>{MapUtils.setFeatureVisible(t,e)})),this.canHaveChildren()&&(e||(this.attrs[PROP_LAYERS_ANIMATION_ON]=!1),this.checkLayersAnimationButton()),t&&this.checkVisible(),this.checkMapLayer();let l=this.getLegendDiv();l.removeClass(CLASS_LEGEND_LABEL_INVISIBLE),l.removeClass(CLASS_LEGEND_LABEL_HIGHLIGHT),this.getVisible()?this.highlighted&&l.addClass(CLASS_LEGEND_LABEL_HIGHLIGHT):l.addClass(CLASS_LEGEND_LABEL_INVISIBLE),this.topHeaderId&&(this.getVisible()?jqid(this.topHeaderId).removeClass(CLASS_LEGEND_LABEL_INVISIBLE):jqid(this.topHeaderId).addClass(CLASS_LEGEND_LABEL_INVISIBLE)),this.checkDataIconMenu()},getGlyphProperty:function(e,t){let i=this.getId()+"."+e,s=this.display.getProperty(i);return Utils.isDefined(s)?(this.attrs[e]=s,this.display.removeProperty(i),s):this.attrs[e]},getVisible:function(){return Utils.isDefined(this.attrs.visible)||(this.attrs.visible=!0),this.getGlyphProperty("visible")},setVisibleLevelRange:function(e,t){let i=this.getVisibleLevelRange(),s=i?.min,l=i?.max;e===s&&t===l||(""==e&&(e=null),""==t&&(t=null),this.attrs.visibleLevelRange={min:e,max:t},this.checkVisible())},checkVisible:function(){let e=this.display.getCurrentLevel(),t=this.getShowMarkerWhenNotVisible(),i=this.getVisibleLevelRange()??{},s=this.display.getMapProperty(PROP_LEVELRANGE_RANGE);i&&(!s||Utils.stringDefined(i.min)||Utils.stringDefined(i.max))||(i=s,t=this.display.getMapProperty(PROP_LEVELRANGE_SHOWMARKER));let l=Utils.stringDefined(i.min)?+i.min:-1,a=Utils.stringDefined(i.max)?+i.max:1e4,r=this.getVisible()&&e>=l&&e<=a;if(this.getVisible()&&t&&!r&&!this.showMarkerMarker){let e=this.features;e&&0!=e.length||(e=this.mapLayer?.features);let t=this.display.getMap().getFeaturesBounds(e,!0);if(t){let e=MapUtils.getCenter(t);this.showMarkerMarker=this.display.getMap().createMarker("",e,this.getIcon(),"",null,null,16,null,null,{}),this.display.addFeatures([this.showMarkerMarker]),this.showMarkerMarker.mapGlyph=this}}this.features&&this.features.forEach((e=>{MapUtils.setFeatureVisible(e,r)})),this.showMarkerMarker&&(this.getVisible()&&!r||(this.display.removeFeatures([this.showMarkerMarker]),this.showMarkerMarker=null)),this.isFixed()&&(r?jqid(this.getFixedId()).show():jqid(this.getFixedId()).hide()),this.getMapLayer()&&!this.imageLayers&&this.getMapLayer().setVisibility(r),this.imageLayers&&this.imageLayers.forEach((e=>{let t=r&&this.isImageLayerVisible(e);e.layer&&e.layer.setVisibility(t)})),this.getMapServerLayer()&&this.getMapServerLayer().setVisibility(r),this.selectDots&&this.selectDots.length>0&&(this.selectDots.forEach((e=>{MapUtils.setFeatureVisible(e,r)})),ImdvUtils.scheduleRedraw(this.display.selectionLayer)),this.image&&this.image.setVisibility(r),this.isData()&&this.checkDataDisplayVisibility(r),this.checkDeclutter(this.mapLabels,r,!0);let o=this.getMapFeaturesToGrid();return o&&r&&(this.checkDeclutter(o,r,!1),ImdvUtils.scheduleRedraw(this.mapLayer)),this.applyChildren((e=>{e.checkVisible()})),ImdvUtils.scheduleRedraw(this.display.myLayer),r&&this.isMultiEntry()&&!this.haveAddedEntries&&setTimeout((()=>{this.addEntries()}),1),r},checkDeclutter:function(e,t,i){if(!e||!this.mapLoaded)return;if(!t)return void e.forEach((e=>{MapUtils.setFeatureVisible(e,!1)}));let s=[];if(e.forEach((e=>{e.isFiltered||e.forceHidden||(s.push(e),MapUtils.setFeatureVisible(e,!0))})),Utils.stringDefined(this.getMapPointsRange())){return void(this.display.getCurrentLevel()<parseInt(this.getMapPointsRange())&&(t=!1,e.forEach((e=>{MapUtils.setFeatureVisible(e,!1)}))))}if(i){if(!this.getDeclutterLabels())return}else if(!this.getProperty("declutter.features",!1))return;new Date;MapUtils.declutter(this.getMap(),s,this.getDeclutterArgs())},getDeclutterArgs:function(){let e={};return e.fontSize=this.style.fontSize??HU.px(12),Utils.stringDefined(this.attrs.declutter_padding)&&(e.padding=+this.attrs.declutter_padding),this.attrs.declutter_granularity&&(e.granularity=+this.attrs.declutter_granularity),this.attrs.declutter_pixelsperline&&(e.pixelsPerLine=+this.attrs.declutter_pixelsperline),this.attrs.declutter_pixelspercharacter&&(e.pixelsPerCharacter=+this.attrs.declutter_pixelspercharacter),e},setImageLayerVisible:function(e,t){this.isImageLayerVisible(e,!0,t),e.layer&&e.layer.setVisibility(t)},isImageLayerVisible:function(e,t,i){this.attrs.imageLayerState||(this.attrs.imageLayerState={});let s=this.attrs.imageLayerState[e.id];if(s||(s=this.attrs.imageLayerState[e.id]={visible:!0}),Utils.isDefined(i)&&(s.visible=i),"main"!=e.id)return s.visible&&t&&(e.layer=this.getMap().addImageLayer(e.name,e.name,"",e.url,!0,e.north,e.west,e.south,e.east),Utils.isDefined(this.style.imageOpacity)&&e.layer.setOpacity(this.style.imageOpacity),this.display.makeLegend()),s.visible;this.getMapLayer()&&this.getMapLayer().setVisibility(i)},isShape:function(){if(this.getType()==GLYPH_LABEL){if(!Utils.stringDefined(this.style.externalGraphic))return!0;if(this.style.externalGraphic&&this.style.externalGraphic.endsWith("blank.gif"))return!0;if(0==this.style.pointRadius)return!0}return GLYPH_TYPES_SHAPES.includes(this.getType())},isData:function(){return this.type==GLYPH_DATA},isFixed:function(){return this.type==GLYPH_FIXED},addFixed:function(){let e=this.style,t="solid";e.strokeDashstyle&&(["dot","dashdot"].includes(e.strokeDashstyle)?t="dotted":e.strokeDashstyle.indexOf("dash")>=0&&(t="dashed"));let i=HU.css(CSS_PADDING,HU.px(5)),s=Utils.stringDefined(e.borderColor)?e.borderColor:COLOR_LIGHT_GRAY;i+=HU.css(CSS_BORDER,HU.border(HU.px(e.borderWidth),s,t)),Utils.stringDefined(e.fillColor)&&(i+=HU.css(CSS_BACKGROUND,e.fillColor)),i+=HU.css(CSS_COLOR,e.fontColor),Utils.stringDefined(e.fontSize)&&(i+=HU.css(CSS_FONT_SIZE,e.fontSize)),["right","left","bottom","top"].forEach((t=>{Utils.stringDefined(e[t])&&(i+=HU.css(t,HU.getDimension(e[t])))}));let l=this.getFixedId();jqid(l).remove();let a=this.style.text??"",r=HU.div([ATTR_ID,l,ATTR_CLASS,"ramadda-imdv-fixed",ATTR_STYLE,i],"");this.display.jq(ID_MAP_CONTAINER).append(r);let o=null;if(a.startsWith("toggle:")){a=a.trim();let e=/toggle:(.*)\n/,t=a.match(e);t&&(o=t[1],a=a.replace(e,"").trim())}let n=()=>{let e=this,t=jqid(l).height();jqid(l).draggable({containment:this.display.domId(ID_MAP),start:function(e,i){$(this).css({height:HU.px(t+10),right:"auto",top:"auto"})},stop:function(){let t=$(this),i=t.position().top,s=t.position().left,l=i+t.height(),a=s+t.width(),r=t.parent().width(),o=t.parent().height(),n=e.style;["top","bottom","left","right"].forEach((e=>{n[e]=""}));let h=(e,t)=>{t=HU.px(Math.max(0,parseInt(t))),n[e]=t};i<o-l?h("top",i):h("bottom",o-l),s<r-a?h("left",s):h("right",r-a)},revert:!1})};a.startsWith("<wiki>")?this.display.wikify(a,null,(e=>{o&&(e=HU.toggleBlock(o+SPACE2,e,!1)),e=HU.div([ATTR_STYLE,HU.css(CSS_MAX_HEIGHT,HU.px(300),CSS_OVERFLOW_Y,OVERFLOW_AUTO)],e),jqid(l).html(e),n()})):(a=this.convertText(a),a=a.replace(/\n/g,HU.br()),o&&(a=HU.toggleBlock(o+SPACE2,a,!1)),jqid(l).html(a),n())},addData:function(e,t){(e=e??{}).doInitCenter=t??!1,this.attrs.displayAttrs=e;let i=this.getEntryId(),s=e.pointDataUrl||HU.url(Ramadda.getUrl("/entry/data"),"max",5e4,ARG_ENTRYID,i),l=new PointData(this.attrs.name,null,null,s,{entryId:i}),a=HU.getUniqueId("display_"),r=HU.getUniqueId("outerdisplay_"),o=HU.getUniqueId("displaybottom_"),n=HU.div([ATTR_ID,r],HU.div([ATTR_ID,a]));this.display.jq(ID_HEADER1).append(n),this.display.jq(ID_BOTTOM).append(HU.div([ATTR_ID,o]));let h={externalMap:this.display.getMap(),externalDisplay:this,isContained:!0,showRecordSelection:!0,showInnerContents:!1,entryIcon:this.attrs.icon,title:this.attrs.name,max:"5000",thisEntryType:this.attrs.entryType,entryId:i,divid:a,acceptRequestChangeEvent:!1,pointDataCacheOK:!1,bottomDiv:o,data:l,fileUrl:HU.url(Ramadda.getUrl(URL_ENTRY_GET),ARG_ENTRYID,i,"fileinline",!0)};$.extend(h,e),h=$.extend({},h),h.name=this.getName();let d=this.display.getDisplayManager().createDisplay("map",h);d.errorMessageHandler=(e,t)=>{this.display.setErrorMessage(t,5e3)},this.displayInfo={display:d,outerDivId:r,divId:a,bottomDivId:o},this.checkDataDisplayVisibility()},externalDisplayReady:function(e){this.display.checkGlyphLayers()},checkDataDisplayVisibility:function(e){if(!this.displayInfo)return;let t=this.isVisible();Utils.isDefined(e)&&!e&&(t=!1),this.displayInfo.display&&this.displayInfo.display.setVisible(t);jqid(this.displayInfo.divId);let i=jqid(this.displayInfo.outerDivId);this.getProperty("showDisplayHeader",!0)||(t=!1),t?i.show():i.hide()},getDecoration:function(e){let t=this.getType(),i=this.style??{},s=[CSS_DISPLAY,DISPLAY_INLINE_BLOCK],l=e?HU.px(10):HU.px(25);s.push(CSS_WIDTH,e?HU.px(10):HU.px(50));let a="solid";if(i.strokeWidth>0&&(i.strokeDashstyle&&(["dot","dashdot"].includes(i.strokeDashstyle)?a="dotted":i.strokeDashstyle.indexOf("dash")>=0&&(a="dashed")),s.push(CSS_BORDER,(e?Math.min(+i.strokeWidth,1):i.strokeWidth)+"px "+a+" "+i.strokeColor)),i.imageUrl){if(!e)return HU.toggleBlock(i.imageUrl,HU.image(i.imageUrl,[ATTR_WIDTH,HU.px(200)]))}else if(t==GLYPH_LABEL){if(!e)return i.label.replace(/\n/g,HU.br())}else if(t==GLYPH_MARKER){if(!e)return HU.image(i.externalGraphic,[ATTR_WIDTH,HU.px(16)])}else{if(t==GLYPH_BOX)return Utils.stringDefined(i.fillColor)&&s.push(CSS_BACKGROUND,i.fillColor),s.push(CSS_HEIGHT,l),HU.div([ATTR_STYLE,HU.css(s)]);if(t==GLYPH_HEXAGON)return s=[],Utils.stringDefined(i.fillColor)&&s.push(CSS_BACKGROUND,i.fillColor),Utils.stringDefined(i.strokeColor)&&s.push(CSS_COLOR,i.strokeColor),s.push(CSS_FONT_SIZE,e?HU.px(16):HU.px(32),CSS_VERTICAL_ALIGN,ALIGN_CENTER),HU.span([ATTR_STYLE,HU.css(s)],"&#x2B22;");if(t==GLYPH_CIRCLE||t==GLYPH_POINT)return Utils.stringDefined(i.fillColor)&&s.push(CSS_BACKGROUND,i.fillColor),t==GLYPH_POINT?s.push(CSS_MARGIN_TOP,HU.px(10),CSS_HEIGHT,HU.px(10),CSS_WIDTH,HU.px(10)):(s.push(CSS_HEIGHT,l),s.push(CSS_WIDTH,l)),HU.div([ATTR_CLASS,"ramadda-dot",ATTR_STYLE,HU.css(s)]);if(t==GLYPH_LINE||t==GLYPH_POLYLINE||t==GLYPH_POLYGON||t==GLYPH_FREEHAND_CLOSED||t==GLYPH_MAP||t==GLYPH_ROUTE||t==GLYPH_FREEHAND)return this.isClosed()?(t==GLYPH_FREEHAND_CLOSED&&s.push(CSS_BORDER_RADIUS,HU.px(10)),s.push(CSS_HEIGHT,HU.px(10)),s.push(CSS_BACKGROUND,i.fillColor)):s.push(CSS_MARGIN_BOTTOM,HU.px(4),CSS_BORDER_BOTTOM,HU.border(i.borderWidth,i.strokeColor,a)),HU.div([ATTR_STYLE,HU.css(s)])}return HU.div([ATTR_STYLE,HU.css(CSS_DISPLAY,DISPLAY_INLINE_BLOCK,CSS_BORDER,HU.border(1,COLOR_TRANSPARENT),CSS_WIDTH,e?HU.px(10):HU.px(50))])},isClosed:function(){return GLYPH_TYPES_CLOSED.includes(this.type)},isOpenLine:function(){return GLYPH_TYPES_LINES_OPEN.includes(this.type)},isStraightLine:function(){return GLYPH_TYPES_LINES_STRAIGHT.includes(this.type)},addEntries:function(e){if(!this.checkVisible())return;if(this.haveAddedEntries)return;this.haveAddedEntries=!0;let t=this.getEntryId(),i=new Entry({id:t}),s="orderby="+this.getProperty("orderby","name");s+="&ascending="+this.getProperty("ascending","true"),i.getChildrenEntries((t=>{this.clearChildren(),this.children=[],this.entries=t,t=this.getMultiEntries();let i=!1;t.forEach(((e,t)=>{if(!e.hasLocation())return console.log("multi entry has no location:"+e.getName()),void(i=!0);let s,l;this.attrs.childrenLocations&&(s=this.attrs.childrenLocations[e.getId()]),l=s?{latitude:s[0],longitude:s[1]}:{latitude:e.getLatitude(),longitude:e.getLongitude()};let a=MapUtils.createPoint(l.longitude,l.latitude);a=this.display.getMap().transformLLPoint(a);let r=Utils.clone({},this.style);if(r.externalGraphic=e.getIconUrl(),Utils.stringDefined(this.style.childIcon)&&(r.externalGraphic=this.style.childIcon),r.strokeWidth=1,r.strokeColor=COLOR_TRANSPARENT,r.fontSize=HU.px(12),r.showLabels){let t=e.getName(),i=Utils.split(t," ",!0,!0);i.length>1&&(t="",Utils.splitList(i,3).forEach((e=>{t+=Utils.join(e," "),t+="\n"})),t=t.trim()),r.label=t}else r.label=null;let o={name:e.getName(),mapglyphs:e.mapglyphs,entryId:e.getId(),icon:r.externalGraphic},n=[l.latitude,l.longitude],h=this.display.createMapMarker(GLYPH_ENTRY,o,r,n,!1);h.overrideLocation=s,h.isEphemeral=!0,this.addChildGlyph(h),this.getShowDataIcons()&&h.makeDataIcon(!0)})),this.getBounds(),this.display.makeLegend(),this.checkVisible(),e&&this.panMapTo(),this.showMultiEntries()}),s)},isSelected:function(){return this.selected},getSelected:function(e){this.isSelected()&&e.push(this),this.applyChildren((t=>{t.getSelected(e)}))},select:function(e,t){if(Utils.isDefined(e)||(e=20),this.isSelected())return;this.findInLegend(CLASS_LEGEND_LABEL).css(CSS_FONT_WEIGHT,FONT_BOLD),this.selected=!0,this.selectDots=[];let i=0,s=this.getMapLayer();if(s&&s.features){let e={strokeColor:COLOR_BLACK,strokeWidth:2,fillColor:COLOR_TRANSPARENT,pointRadius:5};s.features.forEach((t=>{t.originalStyle=t.style,t.style=e})),ImdvUtils.scheduleRedraw(this.mapLayer)}let l=this.getImage();if(l){let e=l.extent,t=e.getCenterPixel();[[e.left,e.top],[e.right,e.top],[e.left,e.bottom],[e.right,e.bottom]].forEach((e=>{let i=e[0],s=e[1];if(this.style.rotation){let e=Utils.rotate(t.x,t.y,i,s,this.style.rotation,!0);i=e.x,s=e.y}let l=MapUtils.createPoint(i,s),a=MapUtils.createVector(l,null,this.display.DOT_STYLE);this.selectDots.push(a)}))}else i+=this.display.selectFeatures(this,this.getFeatures(),e);return this.display.selectionLayer.addFeatures(this.selectDots,{silent:!0}),this.applyChildren((s=>{i+=s.select(e,t)})),i},unselect:function(){this.findInLegend(CLASS_LEGEND_LABEL).css(CSS_FONT_WEIGHT,"normal"),this.applyChildren((e=>{e.unselect()})),this.isSelected()&&(this.selected=!1,this.selectDots&&(this.display.selectionLayer.removeFeatures(this.selectDots),this.selectDots=null),this.mapLayer&&this.mapLayer.features&&this.applyMapStyle(!0))},doRemove:function(){this.dataIconContainer&&(jqid(this.dataIconContainer).remove(),this.dataIconContainer=null),this.stepMarker&&this.display.removeFeatures([this.stepMarker]),this.isFixed()&&jqid(this.getFixedId()).remove(),this.mapLabels&&this.display.removeFeatures(this.mapLabels),this.features&&this.display.removeFeatures(this.features),this.extraFeatures&&this.display.removeFeatures(this.extraFeatures),this.showMarkerMarker&&(this.display.removeFeatures([this.showMarkerMarker]),this.showMarkerMarker=null),this.selectDots&&(this.display.selectionLayer.removeFeatures(this.selectDots),this.selectDots=null),this.getMapLayer()&&(this.display.getMap().removeLayer(this.getMapLayer()),this.image=null,this.setMapLayer(null)),this.getImage()&&(this.display.getMap().removeLayer(this.getImage()),this.image=null),this.imageLayers&&(this.imageLayers.forEach((e=>{e.layer&&this.display.getMap().removeLayer(e.layer)})),this.imageLayers=[]),this.getMapServerLayer()&&(this.display.getMap().removeLayer(this.getMapServerLayer()),this.setMapServerLayer(null)),this.displayInfo&&(jqid(this.displayInfo.divId).remove(),jqid(this.displayInfo.bottomDivId).remove(),this.displayInfo.display&&this.displayInfo.display.deleteDisplay()),this.setParentGlyph(null),this.clearChildren()}},FeatureInfo.prototype={getId:function(){return this.id},getProperty:function(e,t,i){return i&&(t=this.mapGlyph.getProperty(e,t)),this.mapGlyph.getProperty(this.id+"."+e,t)},show:function(){return this.getProperty("show",this.mapGlyph.getProperty("feature.show",!0))},showFilter:function(){let e=this.mapGlyph.getProperty("filter.show",this.show());return this.getProperty("filter.show",e)},filterSize:function(){let e=this.mapGlyph.getProperty("filter.size");return this.getProperty("filter.size",e)},showTable:function(){return this.getProperty("table.show",this.mapGlyph.getProperty("table.show",this.show()))},showPopup:function(){return this.getProperty("popup.show",this.mapGlyph.getProperty("popup.show",this.show()))},isColorTableSelect:function(){return this.getProperty("colortable.select",this.mapGlyph.getProperty("colortable.select",!1))},getType:function(){return this.getProperty("type",this.type)},getLabel:function(e){let t=this.getProperty("label");return Utils.stringDefined(t)||(t=this.mapGlyph.display.makeLabel(this.property)),e&&(t=HU.span([ATTR_TITLE,this.property],t)),t},getValueLabel:function(e){let t=this.getProperty("label."+e?.toLowerCase(),null);return t||(t=Utils.makeLabel(e)),t},format:function(e){if(this.isNumeric()){let t=this.getProperty("format.decimals",-1,!0);t>=0&&!isNaN(e)&&(e=Utils.trimDecimals(e,t))}return e},isNumeric:function(){return this.isInt()||"numeric"==this.getType()},isInt:function(){return"int"==this.getType()},isString:function(){return"string"==this.getType()},isEnumeration:function(){return"enumeration"==this.getType()||"enum"==this.getType()},getStep:function(e){let t=this.getProperty("step");return Utils.isDefined(t)?parseFloat(t):e},getSamplesLabels:function(){return this.samples.map((e=>e.label))},getSamplesForMenu:function(){return this.samples},getSamplesValues:function(){return this.samples.map((e=>{let t=this.seen[e.value];return e.value+" ("+t+")"}))},initValues:function(e){let t=this.mapGlyph.getFeatureValue(e,this.property);if(!Utils.isDefined(t))return;let i=this.isEnumeration();isNaN(t)||this.samples.length>0||i?this.samples.length<100?(this.type="enumeration",this.seen[t]||(this.seen[t]=0,this.samples.push(t)),this.seen[t]++):this.type="string":isNaN(t)||("numeric"!=this.type&&(this.type="int"),Math.round(t)!=t&&(this.type="numeric"),this.min=isNaN(this.min)?t:Math.min(this.min,t),this.max=isNaN(this.max)?t:Math.max(this.max,t))},finishInit:function(){if(this.samples.length){let e=e=>this.getValueLabel(e);this.mapGlyph.getProperty("filter.showRawValues",!1)&&(e=e=>e);let t=this.samples.map(((t,i)=>({value:t,label:e(t)})));this.samples=t.sort(((e,t)=>e.label.localeCompare(t.label)))}}};const DISPLAY_GRAPH="graph",DISPLAY_TREE="tree",DISPLAY_TIMELINE="timeline",DISPLAY_HOURS="hours",DISPLAY_BLANK="blank",DISPLAY_FILTER="filter",DISPLAY_HOOK="hook",DISPLAY_PRE="pre",DISPLAY_HTMLTABLE="htmltable",DISPLAY_RECORDS="records",DISPLAY_TSNE="tsne",DISPLAY_HEATMAP="heatmap",DISPLAY_WAFFLE="waffle",DISPLAY_CROSSTAB="crosstab",DISPLAY_CORRELATION="correlation",DISPLAY_RANKING="ranking",DISPLAY_STATS="stats",DISPLAY_COOCCURENCE="cooccurence",DISPLAY_BOXTABLE="boxtable",DISPLAY_DATATABLE="datatable",DISPLAY_PERCENTCHANGE="percentchange",DISPLAY_SPARKLINE="sparkline",DISPLAY_POINTIMAGE="pointimage",DISPLAY_CANVAS="canvas",DISPLAY_FIELDTABLE="fieldtable",DISPLAY_SELECTEDRECORDS="selectedrecords",DISPLAY_DATEGRID="dategrid",DISPLAY_STRIPES="stripes";function RamaddaGraphDisplay(e,t,i){const s="graph",l=new RamaddaDisplay(e,t,DISPLAY_GRAPH,i);window.ForceGraph||Utils.importJS("https://unpkg.com/force-graph");let a=[{label:"Graph"},{p:"sourceField",ex:""},{p:"targetField",ex:""},{p:"labelField"},{p:"nodeBackground",ex:COLOR_LIGHT_GRAY},{p:"drawCircle",ex:"true"},{p:"nodeWidth",d:"10"},{p:"linkColor",d:COLOR_LIGHT_GRAY},{p:"linkDash",ex:"5"},{p:"linkWidth",d:"1"},{p:"arrowLength",ex:"6"},{p:"arrowColor",ex:"green"},{p:"directionalParticles",ex:"2"}];defineDisplay(addRamaddaDisplay(this),l,a,{needsData:function(){return!0},callbackWaiting:!1,updateUI:function(){if(!window.ForceGraph)return void(this.callbackWaiting||(this.callbackWaiting=!0,setTimeout((()=>{this.callbackWaiting=!1,this.updateUI()}),100)));let e=null,t=HU.div([ATTR_ID,this.domId(s)]);this.setContents(t);let i=this.filterData();if(!i)return;let l={},a=[],r=[],o=this.getFieldsByIds(null,this.getProperty("valueFields","",!0)),n=this.getFieldById(null,this.getLabelField());if(!n){let e=this.getFieldsByType(null,"string");e.length>0&&(n=e[0])}let h=this.getFieldById(null,this.getProperty("sourceField","source")),d=this.getFieldById(null,this.getProperty("targetField","target")),g=this.getProperty("tooltip","${default}");if(o.length>0){let e={};i.map(((t,i)=>{let s=n?t.getValue(n.getIndex()):i,l=this.getRecordHtml(t,null,g);a.push({id:i,label:s,tooltip:l}),o.map((s=>{let l=t.getValue(s.getIndex());e[l+"_"+s.getId()]||(e[l+"_"+s.getId()]=!0,a.push({id:l,isValue:!0})),r.push({source:l,target:i})}))}))}else{if(null==h||null==d)return void this.setDisplayMessage("No source/target fields specified");i.map((e=>{let t=e.getValue(h.getIndex()),i=e.getValue(d.getIndex()),s=n?e.getValue(n.getIndex()):index;l[t]||(l[t]=!0,a.push({id:t,label:s,tooltip:t})),l[i]||(l[i]=!0,a.push({id:i,label:s,tooltip:i})),r.push({source:t,target:i})}))}e={nodes:a,links:r};const p=this.getNodeBackground("rgba(255, 255, 255, 0.8)"),c=(this.getLinkColor(),this.getDrawCircle()),u=(this.getLinkWidth(),this.getLinkDash(-1),this.getProperty("drawText",!0)),T=this.getNodeWidth(10),f=document.getElementById(this.domId(s)),y=ForceGraph()(f).graphData(e);y.nodeCanvasObject(((e,t,i)=>{let s=e.label;s||(s=e.id);const l=12/i;t.font=l+"px Sans-Serif";let a=t.measureText(s).width;if(u||(a=T),e.isValue){let i=[a,l].map((e=>e+.2*l+2));t.lineWidth=1,t.strokeStyle=COLOR_BLACK,t.fillStyle=COLOR_WHITE,t.fillRect(e.x-i[0]/2,e.y-i[1]/2,...i),t.strokeRect(e.x-i[0]/2,e.y-i[1]/2,...i)}else{let i=[a,l].map((e=>e+.2*l+2));t.fillStyle=p,t.strokeStyle=COLOR_BLACK,c?(t.beginPath(),t.arc(e.x,e.y,i[0]/2,0,2*Math.PI),t.fill()):(t.lineWidth=1,t.fillRect(e.x-i[0]/2,e.y-i[1]/2,...i),t.strokeRect(e.x-i[0]/2,e.y-i[1]/2,...i))}u&&(t.textAlign=ALIGN_CENTER,t.textBaseline="middle",t.fillStyle="black",t.fillText(s,e.x,e.y))})),this.getWidth()&&y.width(this.getWidth()),this.getHeight()&&y.height(this.getHeight()),y.nodeLabel((e=>e.tooltip?e.tooltip:null)),y.linkWidth(+this.getLinkWidth()),y.linkColor(this.getLinkColor()),this.getArrowColor()&&y.linkDirectionalArrowColor(this.getArrowColor()),this.getArrowLength()&&(y.linkDirectionalArrowLength(+this.getArrowLength()),y.linkDirectionalArrowRelPos(+this.getProperty("arrowPosition",.9))),this.getProperty("directionalParticles")&&y.linkDirectionalParticles(+this.getProperty("directionalParticles"))}})}function RamaddaTreeDisplay(e,t,i){const s=new RamaddaDisplay(e,t,DISPLAY_TREE,i);defineDisplay(addRamaddaDisplay(this),s,[{label:"Tree"},{p:"maxDepth",ex:"3"},{p:"showDetails",ex:"false"}],{countToRecord:{},needsData:function(){return!0},updateUI:function(){let e=this.filterData();if(!e)return;let t=null;try{t=this.makeTree(e)}catch(e){return void this.handleError("An error has occurred:"+e,e)}let i="",s=this.domId("node"),l=0,a=0,r=+this.getProperty("maxDepth",10),o=this.getProperty("recordTemplate","${default}"),n=this.getProperty("showDetails",!0),h=this,d=function(e){l++,e.record&&(h.countToRecord[l]=e.record),a++;let t=e.children.length>0&&a<=r,g=null;n&&e.record&&(g=h.getRecordHtml(e.record,null,o),""==g&&(g=null));let p="";(e.children.length>0||g)&&(p=HU.image(t?icon_downdart:icon_rightdart,[ATTR_ID,s+"_toggle_image"+l])+" "),i+=HU.div([ATTR_CLASS,"display-tree-toggle",ATTR_ID,s+"_toggle"+l,"toggle-state",t,"block-count",l],p+e.label),i+=HU.open(TAG_DIV,[ATTR_ID,s+"_block"+l,ATTR_CLASS,"display-tree-block",ATTR_STYLE,HU.css(CSS_DISPLAY,t?DISPLAY_BLOCK:DISPLAY_NONE)]),g&&""!=g&&(e.children.length>0?(i+=HU.div([ATTR_CLASS,"display-tree-toggle-details",ATTR_ID,s+"_toggle_details"+l,"toggle-state",!1,"block-count",l],HU.image(icon_rightdart,[ATTR_ID,s+"_toggle_details_image"+l])+" Details"),i+=HU.div([ATTR_ID,s+"_block_details"+l,ATTR_CLASS,"display-tree-block",ATTR_STYLE,HU.css(CSS_DISPLAY,DISPLAY_NONE)],g)):i+=g),e.children.length>0&&e.children.map(d),a--,i+=HU.close(TAG_DIV)};t.map(d),this.myRecords=[],this.displayHtml(i),this.find(".display-tree-toggle").click((function(){let e=/true/i.test($(this).attr("toggle-state"));e=!e;let t=$(this).attr("block-count"),i=jqid(s+"_block"+t),l=jqid(s+"_toggle_image"+t);$(this).attr("toggle-state",e),e?(i.css(CSS_DISPLAY,DISPLAY_BLOCK),l.attr(ATTR_SRC,icon_downdart)):(i.css(CSS_DISPLAY,DISPLAY_NONE),l.attr(ATTR_SRC,icon_rightdart));let a=h.countToRecord[t];a&&h.propagateEventRecordSelection({record:a})})),this.find(".display-tree-toggle-details").click((function(){let e=/true/i.test($(this).attr("toggle-state"));e=!e;let t=$(this).attr("block-count"),i=jqid(s+"_block_details"+t),l=jqid(s+"_toggle_details_image"+t);$(this).attr("toggle-state",e),e?(i.css(CSS_DISPLAY,DISPLAY_BLOCK),l.attr(ATTR_SRC,icon_downdart)):(i.css(CSS_DISPLAY,DISPLAY_NONE),l.attr(ATTR_SRC,icon_rightdart))}))}})}function RamaddaTimelineDisplay(e,t,i){const s="timeline";i.height||(i.height=400);const l=new RamaddaFieldsDisplay(e,t,DISPLAY_TIMELINE,i);let a=[{label:"Timeline"},{p:"titleField",ex:""},{p:"titleLength",ex:"100"},{p:"imageField",ex:""},{p:"urlField",ex:""},{p:"textTemplate",ex:""},{p:"startDateField",ex:""},{p:"endDateField",ex:""},{p:"startAtSlide",ex:"0"},{p:"startAtEnd",ex:"true"},{p:"scaleFactor",ex:"10"},{p:"initialZoom",ex:"10"},{p:"timelinePosition",ex:"top|bottom",d:"top"},{p:"navHeight",ex:"150"},{p:"backgroundColor",ex:COLOR_LIGHT_GRAY},{p:"groupField",ex:""},{p:"urlField",ex:""},{p:"timeTo",d:"day",ex:"year|day|hour|second",canCache:!0},{p:"hideBanner",ex:"true"}],r="https://cdn.knightlab.com/libs/timeline3/latest/js/timeline.js";r=RamaddaUtil.getCdnUrl("/lib/timeline3/timeline.js"),Utils.importJS(r);$(HU.tag(TAG_LINK,[ATTR_REL,"stylesheet",ATTR_HREF,"https://cdn.knightlab.com/libs/timeline3/latest/css/themes/timeline.theme.contrast.css",ATTR_TYPE,"text/css"])).appendTo(TAG_HEAD),defineDisplay(addRamaddaDisplay(this),l,a,{needsData:function(){return!0},loadCnt:0,timelineLoaded:!1,checkLayout:function(){this.updateUI()},updateUI:function(){if(!this.timelineLoaded)try{TL.Timeline;this.timelineLoaded=!0}catch(e){if(this.loadCnt++<100)return void setTimeout((()=>this.updateUI()),100)}if(!this.timelineLoaded)return void this.setDisplayMessage("Could not load timeline");let e=this.filterData();if(null==e)return;let t=this.domId(s),i=HU.div([ATTR_ID,t]);this.setContents(i),this.timelineReady=!1;let l={timenav_position:this.getTimelinePosition(),start_at_end:this.getPropertyStartAtEnd(!1),start_at_slide:this.getPropertyStartAtSlide(0),timenav_height:this.getPropertyNavHeight(200),height:300,menubar_height:300,gotoCallback:t=>{if(this.timelineReady){let i=e[t];i&&this.propagateEventRecordSelection({record:i})}}};this.getPropertyBackgroundColor()&&(l.default_bg_color=this.getPropertyBackgroundColor()),this.getPropertyScaleFactor(0)&&(l.scale_factor=this.getPropertyScaleFactor()),this.getPropertyInitialZoom(0)&&(l.scale_factor=this.getPropertyInitialZoom());let a={},r=[];a.events=r;let o=this.getFieldById(null,this.getPropertyTitleField());null==o&&(o=this.getFieldById(null,"title")),null==o&&(o=this.getFieldById(null,"name"));let n=this.getTitleLength(),h=this.getFieldById(null,this.getPropertyStartDateField());h||(h=this.getFieldByType(null,"date"));let d=this.getFieldById(null,this.getPropertyEndDateField()),g=this.getFieldById(null,this.getPropertyImageField()),p=this.getFieldById(null,this.getPropertyGroupField()),c=this.getFieldById(null,this.getPropertyUrlField()),u=this.getPropertyTextTemplate("${default}"),T=(this.getTimeTo(),this.getProperty("showYears",!1));this.recordToIndex={},this.idToRecord={};for(let t=0;t<e.length;t++){let i=e[t];this.idToRecord[i.getId()]=i,this.recordToIndex[i.getId()]=t;let s=i.getData(),l={},a=o?s[o.getIndex()]:" record:"+(t+1);n&&a.length>n&&(a=a.substring(0,n)+"...");let f=!1,y=this.getRecordHtml(i,null,u,f);if(c){let e=i.getValue(c.getIndex());a=HU.href(e,a)}if(l.unique_id=i.getId(),l.text={headline:a,text:y},p){let e=i.getValue(p.getIndex());e&&p.isFieldMultiEnumeration()&&(e=String(e).replace(/,.*/g,"")),l.group=e}g&&(l.media={url:i.getValue(g.getIndex())},c&&(l.media.link=i.getValue(c.getIndex()),l.media.link_target="_timelinemedia"));let m=this.getDate(h?s[h.getIndex()]:i.getTime());T?l.start_date={year:m.year}:(l.start_date=m,d&&(l.end_date=s[d.getIndex()])),r.push(l)}0!=jqid(t).length&&(this.timeline=new TL.Timeline(t,a,l),this.getPropertyHideBanner(!1)&&(this.jq(s).find(".tl-storyslider").css(CSS_DISPLAY,DISPLAY_NONE),this.jq(s).find(".tl-menubar").css(CSS_DISPLAY,DISPLAY_NONE)),this.jq(s).find(".tl-text").css(CSS_PADDING,HU.px(0)),this.jq(s).find(".tl-slide-content").css(CSS_PADDING,HU.px(0)),this.jq(s).find(".tl-slidenav-description").css(CSS_DISPLAY,DISPLAY_NONE),this.timelineReady=!0)},handleEventRecordSelection:function(e,t){if(!t.record)return;let i=this.recordToIndex[t.record.getId()];Utils.isDefined(i)&&this.timeline.goTo(i)},getDate:function(e){if(!e)return{year:(e=new Date).getUTCFullYear()};let t={year:e.getUTCFullYear()},i=this.getTimeTo();return"year"!=i&&(t.month=e.getUTCMonth()+1,"month"!=i&&(t.day=e.getUTCDate(),"day"!=i&&(t.hour=e.getHours(),t.minute=e.getMinutes(),"hour"!=i&&(t.second=e.getSeconds())))),t}})}function RamaddaHoursDisplay(e,t,i){const s=new RamaddaFieldsDisplay(e,t,DISPLAY_HOURS,i),l="lightblue",a="multiid";defineDisplay(addRamaddaDisplay(this),s,[{label:"Hours"},{p:"dateField",ex:""},{p:"boxWidth",ex:""},{p:"boxColor",ex:"blue"},{p:"rowBackground",ex:""},{p:"dayLabelStyle",ex:""},{p:"fillHours",ex:"false"}],{needsData:function(){return!0},updateUI:function(){let e=this.filterData();if(null==e)return;let t=this,i="",s=this.getFieldById(null,this.getPropertyDateField()),r=[],o={},n=this.getProperty("dateFormat","mdy");this.recordToIndex={};let h=+this.getProperty("timeZoneOffset",0);e.forEach(((e,t)=>{this.recordToIndex[e.getId()]=t;let i=s?recordtuple[s.getIndex()]:e.getTime(),l=i,a=l.getUTCHours()+h;l=new Date(Date.UTC(l.getUTCFullYear(),l.getUTCMonth(),l.getUTCDate(),a));let n=+l.getUTCHours(),d=new Date(Date.UTC(l.getUTCFullYear(),l.getUTCMonth(),l.getUTCDate())),g=o[d];g||(g=o[d]={dttm:l,hours:[],minutesCount:{},hourToRecords:{},minHour:n,maxHour:n},r.push(d)),g.minHour=Math.min(g.minHour,n),g.maxHour=Math.max(g.maxHour,n);let p=n+"_"+i.getMinutes();g.minutesCount[p]||(g.minutesCount[p]=0),g.minutesCount[p]++,g.hourToRecords[n]||(g.hours.push(n),g.hourToRecords[n]=[]),g.hourToRecords[n].push(e)})),Utils.sortDates(r),i=HU.open(TAG_DIV,[ATTR_STYLE,HU.css(CSS_POSITION,POSITION_RELATIVE)])+HU.open(TAG_TABLE,[ATTR_WIDTH,HU.perc(100)]);let d=this.getPropertyBoxWidth(10),g=this.getPropertyBoxColor(l),p="";r.forEach((e=>{let l=o[e];if(this.getPropertyFillHours(!0))for(let e=l.minHour;e<l.maxHour;e++)l.hourToRecords[e]||(l.hours.push(e),l.hourToRecords[e]=[]);let r=Utils.formatDateWithFormat(e,n,!0);i+=HU.tr([ATTR_STYLE,HU.css(CSS_BORDER_BOTTOM,HU.border(1,COLOR_LIGHT_GRAY))],HU.tds([],["",HU.div([ATTR_CLASS,"display-hours-label"],r),"#"]));let h=0;Utils.sortNumbers(l.hours).forEach((e=>{let r=HU.open(TAG_TR,[ATTR_STYLE,HU.css(CSS_BORDER_TOP,HU.border(1,COLOR_LIGHT_GRAY))]),o=HU.div([ATTR_STYLE,this.getPropertyDayLabelStyle("")],Utils.formatHour(e));r+=HU.td([ATTR_WIDTH,10,ATTR_ALIGN,ALIGN_RIGHT],o),r+=HU.open(TAG_TD,[ATTR_STYLE,HU.css(CSS_BACKGROUND,"#efefef"),ATTR_WIDTH,HU.perc(100)]),r+=HU.open(TAG_DIV,[ATTR_STYLE,HU.css(CSS_HEIGHT,HU.perc(100),CSS_POSITION,POSITION_RELATIVE,CSS_WIDTH,HU.perc(100),CSS_BACKGROUND,this.getPropertyRowBackground("#eee"))]),r+=SPACE;let n={},c=!1;for(minute in l.hourToRecords[e].forEach((i=>{let o=(s?i.getValue(s.getIndex()):i.getTime()).getMinutes(),p=HU.perc(Math.round(o/61*100)),u=e+"_"+o;if(l.minutesCount[u]>1){if(!n[o]){let t=this.domId("multi"+h++);n[o]={multiid:t,contents:""},r+=HU.div([ATTR_ID,t,ATTR_TITLE,"Click to view multiples","dttm",l.dttm.getTime(),"hour",e,"minute",o,ATTR_STYLE,HU.css(CSS_TOP,HU.px(0),CSS_LEFT,p),ATTR_CLASS,"display-hours-box-multi"],l.minutesCount[u])}n[o].contents+=HU.div([a,n[o].multiid,ATTR_RECORD_ID,i.getId(),ATTR_RECORD_INDEX,t.recordToIndex[i.getId()],ATTR_TITLE,"",ATTR_STYLE,HU.css(CSS_WIDTH,HU.px(d),CSS_BACKGROUND,g),ATTR_CLASS,"display-hours-box"],"")}else{let e=HU.css(CSS_POSITION,POSITION_ABSOLUTE,CSS_TOP,HU.px(0),CSS_WIDTH,HU.px(d),CSS_BACKGROUND,g,CSS_LEFT,p);r+=HU.div([ATTR_RECORD_ID,i.getId(),ATTR_RECORD_INDEX,t.recordToIndex[i.getId()],ATTR_TITLE,"",ATTR_STYLE,e,ATTR_CLASS,"display-hours-box"])}c=!0})),n){let t=l.dttm.getTime()+"_"+e+"_"+minute;p+=HU.div([ATTR_ID,this.domId(t),ATTR_CLASS,"display-hours-box-extra"],n[minute].contents)}r+=HU.close(TAG_DIV,TAG_TD),r+=HU.td([],l.hourToRecords[e].length),r+=HU.close(TAG_TR),c&&(i+=r)}))})),i+=HU.close(TAG_TABLE),i+=p,i+=SPACE+HU.close(TAG_DIV),this.setContents(i),this.multis=this.find(".display-hours-box-multi"),this.multis.click((function(){let e=$(this).attr("dttm")+"_"+$(this).attr("hour")+"_"+$(this).attr("minute"),i=t.jq(e);if("true"==$(this).attr("showing"))return i.hide(),$(this).css(CSS_BORDER,HU.border(1,COLOR_LIGHT_GRAY)),void $(this).attr("showing",!1);$(this).css(CSS_BORDER,HU.border(1,HIGHLIGHT_COLOR)),$(this).attr("showing",!0),i.show(),i.position({of:$(this),my:POS_LEFT_TOP,at:"left bottom+2",collision:"none none"})})),this.boxes=this.find(".display-hours-box"),this.boxes.click((function(){let i=/true/i.test($(this).attr("toggle-state"));i=!i,t.boxes.css(CSS_BACKGROUND,l),i&&$(this).css(CSS_BACKGROUND,HIGHLIGHT_COLOR);let s=e[+$(this).attr(ATTR_RECORD_INDEX)];s&&t.propagateEventRecordSelection({record:s})})),this.makeTooltips(this.boxes,e,null,null,!1)},handleEventRecordSelection:function(e,t){if(!t.record)return;let i=".display-hours-box["+ATTR_RECORD_ID+"='"+t.record.getId()+"']",s=this.find(i);if(s.length){this.boxes.css(CSS_BACKGROUND,l),this.multis.css(CSS_BACKGROUND,"#efefef");let e=s.attr(a);if(e){let t=this.find("#"+e);t.length>0&&(s=t,s.css(CSS_BACKGROUND,HIGHLIGHT_COLOR))}s.css(CSS_BACKGROUND,HIGHLIGHT_COLOR),HU.scrollVisible(this.getContents(),s)}}})}function RamaddaBlankDisplay(e,t,i,s){i.width||(i.width=HU.perc(100)),i.showMenu=!1,i.showTitle=!1;const l=new RamaddaFieldsDisplay(e,t,s??DISPLAY_BLANK,i);defineDisplay(null!=s?this:addRamaddaDisplay(this),l,[],{needsData:function(){return!0},setDisplayMessage:function(e){if(this.dataLoadFailed)return;if(!Utils.stringDefined(e))return void this.jq(ID_HEADER2_SUFFIX).html("").hide();let t=this.jq(ID_HEADER2_SUFFIX);0==t.length&&(t=this.jq(ID_HEADER2)),t.show(),t.html(HU.span([ATTR_CLASS,"display-output-message-tight"],e))},setNoDataMessage:function(e){Utils.stringDefined(e)&&(this.jq(ID_HEADER2_SUFFIX).show(),this.jq(ID_HEADER2_SUFFIX).html(HU.span([ATTR_CLASS,"display-output-message-tight"],e)))},clearDisplayMessage:function(){this.jq(ID_HEADER2_SUFFIX).hide()},updateUI:function(){let e=this.filterData();if(this.setContents(""),!e)return;let t=this.getColorByInfo(e);t.index>=0&&(e.forEach((e=>{color=t.getColor(e.getData()[t.index],e)})),t.displayColorTable())}})}function RamaddaFilterDisplay(e,t,i){i.hideFilterWidget=!1;let s=new RamaddaBlankDisplay(e,t,i,DISPLAY_FILTER);defineDisplay(addRamaddaDisplay(this),s,[],{})}function RamaddaHookDisplay(e,t,i){const s=new RamaddaFieldsDisplay(e,t,DISPLAY_HOOK,i);i.hook&&(this.hook=new window[i.hook]),defineDisplay(addRamaddaDisplay(this),s,[],{needsData:function(){return!0},call:function(e,t){return!!this.hook&&(!!this.hook[e]&&(this.hook[e](this,t),!0))},updateUI:function(){if(!this.hook)return void this.setContents("No hook defined");let e=this.filterData();if(!e)return;let t=this.getSelectedFields([]),i=this.getFields();this.clearDisplayMessage(),this.call("updateUI",{allFields:i,fields:t,records:e})||this.setContents("No updateUI defined in hook")}})}function RamaddaPreDisplay(e,t,i){const s=new RamaddaFieldsDisplay(e,t,DISPLAY_PRE,i);defineDisplay(addRamaddaDisplay(this),s,[{label:"Pre"},{p:"numRecords",ex:"100",d:1e3},{p:"includeGeo",ex:"true",d:!0}],{updateUI:function(){let e=this.filterData();if(!e)return void this.setContents("Loading data...");let t=this.dataCollection.getList()[0].getRecordFields(),i=this.getNumRecords(),s=this.getIncludeGeo(),l="Number of records:"+e.length+"<pre>";t.forEach(((e,t)=>{t>0&&(l+=", "),l+=e.getId()+"["+e.getType()+"]"})),s&&(l+=", latitude, longitude"),l+="\n",e.every(((e,t)=>{if(i>-1&&t>i)return!1;let a=e.getData();return a=a.map((e=>e.getTime?this.formatDate(e):e)),l+="#"+t+": ",l+=a.join(", "),s&&(l+=", "+e.getLatitude()+","+e.getLongitude()),l+="\n",!0})),l+="</pre>",this.setContents(l)}})}function RamaddaHtmltableDisplay(e,t,i,s){const l="table",a=new RamaddaFieldsDisplay(e,t,s??DISPLAY_HTMLTABLE,i);let r=[{label:"Html Table"},{p:"numRecords",ex:"5000",d:5e3,tt:"Number of records to show"},{p:"scrollY",ex:HU.px(300)},{p:"includeGeo",ex:"true",d:!1},{p:"includeDate",ex:"true",d:!1},{p:"includeRowIndex",ex:"true",d:!1},{p:"includeFieldDescription"},{p:"includeUnits",d:!0},{p:"fancy",ex:"true",d:!0},{p:"maxCellHeight",tt:"Max cell height",d:HU.px(200)},{p:"maxLength",ex:"500",d:-1,tt:"If string is gt maxLength then scroll it"},{p:"maxColumns"},{p:"colorCells",ex:"field1,field2"},{p:"iconField"},{p:"linkField"},{p:"categoryField"},{p:"colorRowBy"},{p:"colorFullRow",d:!0,tt:"If doing color row by do we color the full row or just the start"},{p:"showColorFooter",d:!0},{p:"colorHeaderLabel",tt:"Label for the color header"},{p:"colorHeaderTemplate",tt:"Template to show in row color header"},{p:"colorHeaderStyle",tt:"CSS for color header. defaults to rotated text"},{p:"showBar",ex:"true",tt:"Default show bar"},{p:"highlightFilterText",ex:"true",tt:"Highlight any filter text"},{p:"&lt;field&gt;.nowrap",ex:"true",tt:"Don't wrap the column"},{p:"&lt;field&gt;.width",ex:"30%",tt:"Column width"},{p:"&lt;field&gt;.template",ex:"foo:${value}",tt:"Record template"},{p:"&lt;field&gt;.showBar",ex:"true",tt:"Show bar"},{p:"&lt;field&gt;.barMin",ex:"0",tt:"Min value"},{p:"&lt;field&gt;.barMax",ex:"100",tt:"Max value"},{p:"showSummary",ex:"true"},{p:"showSummaryTotal",ex:"true"},{p:"showSummaryAverage",ex:"true"},{p:"showSummaryMinMax",ex:"true"},{p:"showGrandSummary",ex:"true"},{p:"barLabelInside",ex:"false"},{p:"barStyle",ex:"background:red;",tt:"Bar style"},{p:"tableStyle",d:HU.css(CSS_BORDER_LEFT,CSS_BASIC_BORDER,CSS_BORDER_RIGHT,CSS_BASIC_BORDER)},{p:"tableHeaderStyle"},{p:"tableCellStyle"},{p:"showAddRow",ex:"true"}];defineDisplay(addRamaddaDisplay(this),a,r,{displayData:function(){this.updateUI()},makeColumn:function(e,t,i,s){return HU.td(i,s)},handleColumn:function(e,t,i,s,l,a,r){this.columnTemplates||(this.columnTemplates={},e.forEach(((e,t)=>{let i=this.getProperty(e.getId()+"_template");i&&(this.columnTemplates[e.getId()]=i)})));let o=this.columnTemplates[i.getId()];if(o)return this.getRecordHtml(s,null,o);if(!t){let e=[...a];if(e.push(ATTR_FIELD_ID,i.getId(),ATTR_RECORD_ID,s.getId(),ATTR_RECORD_INDEX,s.rowIndex),r){let e=String(l);r.forEach((t=>{e=t.highlight(e,i.getId())})),l=e}return this.makeColumn(s,i,e,l)}if(i.getId()!=t.getId())return this.makeColumn(s,i,a,l);if(!s.isAggregate){let e=SPACE4;return HU.td(a,HU.row([[ATTR_WIDTH,HU.perc(1),ATTR_STYLE,HU.css(CSS_PADDING,HU.px(2))],e],[[ATTR_STYLE,HU.css(CSS_PADDING,HU.px(0))],l]))}let n=HU.span([ATTR_ID,aggId+"_toggle","toggleopen","false",ATTR_CLASS,CLASS_CLICKABLE],HU.span([ATTR_ID,aggId+"_toggleimage"],HU.getIconImage("fas fa-chevron-right"))+SPACE+l);return a=Utils.mergeLists(a,[ATTR_NOWRAP,null]),HU.td(a,n)},updateUI:function(){let e=this.filterData();e?this.updateHtmlTable(e):this.setDisplayMessage("Loading data...")},updateHtmlTable:function(e){let t=this.getFancy(),i=this.getPointData().getRecordFields(),s=this.getSelectedFields(),a=this.getFieldById(null,this.getProperty("urlField")),r=this.getFieldById(null,this.getIconField()),o=this.getFieldById(null,this.getProperty("categoryField"));i=s&&s.length>0?s:i;let n=i.filter((e=>null==e||null!=e.getGroup())).length>0,h={};if(n){let e=[],t=null;for(let s=0;s<i.length;s++){let l=i[s];if(null!=l)if(t=l.getGroup(),null!=t){e.push(l),h[t]=1;for(let a=s+1;a<i.length;a++)null!=i[a]&&i[a].getGroup()==l.getGroup()&&(h[t]++,e.push(i[a]),i[a]=null)}else e.push(l)}i=e}let d,g=this.getFieldById(null,this.getProperty("aggregateBy"));if(g){let t=new CsvUtil,s=new PointData("",i,e),l=t.process(this,s,"aggregate(includeRows=true, groupBy="+g.getId()+");");e=l.getRecords(),i=l.getRecordFields()}let p=this.getColorFullRow(),c=this.getColorHeaderStyle("font-weight:bold;margin-right:10px;margin-top:10px;margin-bottom:10px;writing-mode: vertical-lr; -ms-writing-mode: tb-rl; transform: rotate(180deg);font-size:80%;");Utils.stringDefined(this.getProperty("colorRowBy"))&&(d=[],this.getProperty("colorRowBy").split(",").forEach((t=>{let i=this.getFieldById(null,t);if(i){let s=this.getProperty(t+".colorHeaderTemplate",this.getProperty("colorHeaderTemplate")),l=this.getProperty(t+".colorHeaderLabel",this.getProperty("colorHeaderLabel"));d.push({template:s,label:l,colorBy:new ColorByInfo(this,null,e,null,null,null,null,i)})}})));let u={},T=[];this.getColorCells("").split(",").forEach((t=>{let i=this.getFieldById(null,t);i&&(u[t]=new ColorByInfo(this,null,e,null,t+".colorByMap",null,t,i),T.push(u[t]))}));let f=this.getNumRecords(),y=this.getIncludeRowIndex(),m=this.getIncludeGeo(),_=this.getIncludeDate(),S=this.getIncludeUnits(),A="";d||(A+=HU.cssTag(".display-htmltable-row:hover {background:var(--highlight-background) !important;")),this.getProperty("tableCellStyle")&&(A+=HU.cssTag(".display-htmltable-td {"+this.getProperty("tableCellStyle")+"}")),A+=HU.open(TAG_DIV,[ATTR_ID,this.domId("table_wrapper")]),A+=HU.openTag(TAG_TABLE,[ATTR_CLASS,HU.classes(CLASS_TABLE,CLASS_TABLE_STRIPE),ATTR_WIDTH,HU.perc(100),ATTR_ID,this.domId(l),ATTR_STYLE,this.getTableStyle()]),A+="\n";let I=this.getMaxColumns(-1),b=[ATTR_STYLE,HU.css(CSS_WHITE_SPACE,WHITE_SPACE_NOWRAP,CSS_BACKGROUND,"#efefef",CSS_PADDING,HU.px(5),CSS_FONT_WEIGHT,FONT_BOLD)];if(b=[],A+=HU.open(TAG_THEAD),n){let e=[ATTR_STYLE,HU.css(CSS_BACKGROUND,COLOR_WHITE,CSS_WIDTH,HU.perc(100))];A+=HU.open(TAG_TR,[ATTR_STYLE,HU.css(CSS_BACKGROUND,COLOR_TRANSPARENT),ATTR_VALIGN,ALIGN_TOP]);let t=null,s={};i.forEach(((i,l)=>{i.getGroup()?t!=i.getGroup()&&(t=i.getGroup(),s[t]||(s[t]=!0,A+=HU.th([ATTR_CLASS,"display-table-group-header-th",ATTR_STYLE,HU.css(CSS_BORDER_BOTTOM,HU.border(0,COLOR_TRANSPARENT),CSS_BACKGROUND,COLOR_TRANSPARENT),ATTR_COLSPAN,h[t]],HU.div([ATTR_CLASS,"display-table-group-header"],t))+"\n")):A+=HU.th([ATTR_STYLE,HU.css(CSS_BORDER_BOTTOM,HU.border(0,transparent),CSS_BACKGROUND,COLOR_TRANSPARENT)],HU.div(e,SPACE))+"\n"})),A+=HU.close(TAG_TR)}let R=HU.open(TAG_TR,[ATTR_VALIGN,ALIGN_TOP]),D=HU.open(TAG_TR,[ATTR_VALIGN,ALIGN_TOP]);_?(R+=HU.th([],HU.div(b,"Date")),D+=HU.th([],HU.div(b,"Date"))):i=i.filter((e=>!e.isRecordDate())),d&&!p&&d.forEach((e=>{R+=HU.th([ATTR_STYLE,HU.css(CSS_MAX_WIDTH,HU.px(16),CSS_WIDTH,HU.px(16))],HU.div([],e.label)),D+=HU.th([ATTR_STYLE,HU.css(CSS_MAX_WIDTH,HU.px(16),CSS_WIDTH,HU.px(16))],HU.div([],e.label))})),y&&(R+=HU.th(HU.div([],"")),D+=HU.th(HU.div([],"")));let L=this.getTableHeaderStyle("")+HU.css(CSS_TEXT_ALIGN,ALIGN_CENTER),U={},C=this.getProperty("sortFields"),E=this.getSortAscending();if(C){let e={};C.split(",").forEach((t=>{e[t]=!0})),C=e}i.forEach(((e,i)=>{if(I>0&&i>=I)return;U[e.getId()]=e;let s=C&&C[e.getId()],l=e.getDescription();l&&(l+="&#10;"),l=l??"",l+="Click to sort";let a=[ATTR_TITLE,l,ATTR_CLASS,HU.classes(CLASS_CLICKABLE,"display-table-header"),ATTR_FIELD_ID,e.getId(),ATTR_STYLE,L],r=this.getProperty(e.getId()+".width");if(r&&a.push(CSS_WIDTH,r),s&&(a.push("sorted"),a.push("true")),t){let t=this.getFieldLabel(e);s&&(t=HU.getIconImage(E?"fas fa-arrow-down":"fas fa-arrow-up",null,[ATTR_STYLE,HU.css(CSS_FONT_SIZE,HU.important(HU.pt(8)))])+" "+t);let i=S?e.getUnitLabel(this):e.getLabel(this);R+=HU.th(a,HU.div(b,i)),D+=HU.th(a,HU.div(b,e.getDescription()??""))}else R+=HU.th(a,HU.div(b,e.getId()+"["+e.getType()+"]")),D+=HU.th(a,HU.div(b,e.getId()+"["+e.getDescription()??"]"))})),m&&(R+=HU.th([],HU.div(b,"latitude"))+HU.th([],HU.div(b,"longitude"))),m&&(D+=HU.th([],HU.div(b,""))+HU.th([],HU.div(b,""))),R+=HU.close(TAG_TR),D+=HU.close(TAG_TR),A+=R,this.getIncludeFieldDescription()&&(A+=D),A+=HU.close(TAG_THEAD),A+=HU.open(TAG_TBODY,[ATTR_STYLE,HU.css(CSS_MAX_HEIGHT,HU.px(200),CSS_OVERFLOW_Y,OVERFLOW_AUTO)]),this.recordMap={},this.fieldMap={},i.forEach((e=>{this.fieldMap[e.getId()]=e}));let H="",P=[],x={};i.forEach(((e,t)=>{let i=x[e.getId()]=[],s=this.getProperty(e.getId()+".width");s&&i.push(ATTR_WIDTH,s),this.getProperty(e.getId()+".nowrap",!1)&&i.push(ATTR_NOWRAP,"true")}));let v,O=this.getMaxLength(),N=this.getMaxCellHeight(),w={};i.forEach((e=>{if(e.isFieldNumeric()){let t=this.getProperty("showBar",!1);w[e.getId()]={template:this.getProperty(e.getId()+".template"),isNumeric:!0,showBar:this.getProperty(e.getId()+".showBar",t),barMin:this.getProperty(e.getId()+".barMin",0),barMax:this.getProperty(e.getId()+".barMax",100),barStyle:this.getProperty(e.getId()+".barStyle",this.getProperty("barStyle","")),barLabelInside:this.getProperty(e.getId()+".barLabelInside",this.getProperty("barLabelInside")),barLength:this.getProperty("barLength",HU.px(100))}}}));let M,F=[],k=0,G=(e,t,i)=>{if(1==k&&F.push({field:i,total:0,cnt:0,min:NaN,max:NaN}),e&&M.push(e),!isNaN(t)){let e=F[M.length-1];e.total+=t,e.cnt++,e.min=isNaN(e.min)?t:Math.min(e.min,t),e.max=isNaN(e.max)?t:Math.max(e.max,t)}},B=0,Y=!1,V=this.getHighlightFilterText()?this.getFilterTextMatchers():null;e.every(((e,t)=>{if(f>-1&&t>f)return!1;Y=!Y,k++;let s=e.getData();s=s.map((e=>e&&e.getTime?this.formatDate(e):e));let l="";e.isAggregate&&(H=HU.getUniqueId("agg_"),P.push(H));let n="display-htmltable-row";if(M=[],d&&!p&&d.forEach((t=>{let i=t.colorBy.getColorFromRecord(e),s="";if(t.template){let i=t.template.replace(/{fieldname}/g,t.colorBy.getField().getLabel());i=i.replace(/{field/g,"{"+t.colorBy.getField().getId()),s=this.getRecordHtml(e,null,i),s=HU.div([ATTR_STYLE,c],s)}G(HU.td([ATTR_CLASS,"display-td display-htmltable-td",ATTR_STYLE,HU.css(CSS_WIDTH,HU.px(24),CSS_MAX_WIDTH,HU.px(24),CSS_BORDER_RIGHT,HU.border(1,"#444"),CSS_BACKGROUND,i,CSS_WIDTH,HU.px(24))],s))})),y&&G(HU.td([ATTR_WIDTH,HU.px(5)],HU.div([],"#"+(t+1)))),_&&G(HU.td([],this.formatDate(e.getDate()))),this.recordMap[e.rowIndex]=e,this.recordMap[e.getId()]=e,i.forEach(((t,o)=>{if(I>0&&o>=I)return;B++;let n=s[t.getIndex()],h=String(n),d=this.formatFieldValue(t,e,h);if(O>0&&d.length>O&&t.isString()?e.isAggregate||(d=HU.div([ATTR_STYLE,N?HU.css(CSS_MAX_HEIGHT,N,CSS_OVERFLOW_Y,OVERFLOW_AUTO):""],d)):N&&(d=HU.div([ATTR_STYLE,HU.css(CSS_MAX_HEIGHT,N,CSS_OVERFLOW_Y,OVERFLOW_AUTO)],d)),"image"==t.getType()){let i=e.getValue(t.getIndex());d=HU.image(i,[ATTR_LOADING,LOADING_LAZY,ATTR_STYLE,HU.css(CSS_WIDTH,HU.px(150))])}if(0==o&&r){let t=e.getValue(r.getIndex());d=HU.image(t,[ATTR_STYLE,HU.css(CSS_MAX_WIDTH,HU.px(50))])+SPACE+d}if(a&&0==o){let t=e.getValue(a.getIndex());d&&Utils.stringDefined(t)&&(d&&(d=h.trim()),d=HU.href(t,d,[ATTR_TARGET,"_other"]))}let p=u[t.getId()],c=(COLOR_BLACK,[]),T=w[t.getId()]??{};T.isNumeric&&(c=[ATTR_ALIGN,ALIGN_RIGHT]),c.push(ATTR_CLASS,"display-td display-htmltable-td");let f=x[t.getId()];if(f&&(c=Utils.mergeLists(c,f)),0==h.trim().length&&c.push("nullvalue","true"),p){let i=p.getColorFromRecord(e),s=Utils.getForegroundColor(i);G(HU.td(Utils.mergeLists(c,[ATTR_STYLE,HU.css(CSS_BACKGROUND,i,CSS_COLOR,HU.important(s))]),d),null,t)}else if(T.showBar){let e=1-(n-T.barMin)/(T.barMax-T.barMin);e=HU.perc(100*e);let i="";d=HU.perc(Utils.formatNumberComma(n)),T.barLabelInside&&(i=HU.div([ATTR_STYLE,HU.css(CSS_PADDING_LEFT,HU.px(2))],d),d="");let s=HU.div([ATTR_CLASS,"ramadda-bar-inner",ATTR_STYLE,HU.css(CSS_RIGHT,e)+T.barStyle],i),l=T.barLength,a=HU.div([ATTR_CLASS,"ramadda-bar-outer",ATTR_STYLE,(l?HU.css(CSS_WIDTH,HU.getDimension(l)):"")+HU.css(CSS_MIN_WIDTH,HU.px(100))+(T.barLabelInside?HU.css(CSS_HEIGHT,"1.5em"):"")],s);T.barLabelInside?G(HU.td([],a),null,t):G(HU.td([],HU.row([[ATTR_ALIGN,ALIGN_RIGHT],d],a)),null,t)}else if(T.isNumeric)if(T.template){let s=this.handleColumn(i,g,t,e,d,c,V);G(s,n,t)}else{let s=this.handleColumn(i,g,t,e,this.formatNumber(n,t.getId()),c);G(s,n,t)}else G(this.handleColumn(i,g,t,e,d,c,V),null,t);l=""})),m&&M.push(HU.td([],e.getLatitude()),HU.td([],e.getLongitude())),o){let t=o.getValue(e);if(t!=v&&""!=t){v=t;let e="";for(let t=0;t<M.length-1;t++)e+=HU.td([ATTR_STYLE,HU.css(CSS_DISPLAY,DISPLAY_NONE),ATTR_CLASS,"display-htmltable-category-cell"],"");let i=HU.tr([ATTR_CLASS,"display-htmltable-category-row"],HU.td([ATTR_CLASS,"display-htmltable-category-cell",ATTR_COLSPAN,M.length],HU.div([ATTR_CLASS,"display-htmltable-category"],t))+e);A+=i}}let h="";if(d&&d.length&&p){let t=d[0].colorBy.getColorFromRecord(e);t&&(h+=HU.css(CSS_BACKGROUND,t))}if(e.isAggregate?A+=HU.openTag(TAG_TR,[ATTR_STYLE,HU.css(CSS_FONT_WEIGHT,"550")+h,"aggregateRow",H,ATTR_TITLE,"",ATTR_VALIGN,ALIGN_TOP,ATTR_CLASS,n,ATTR_RECORD_ID,e.getId()]):A+=g?HU.openTag(TAG_TR,[ATTR_STYLE,HU.css(CSS_DISPLAY,DISPLAY_NONE),"aggregateId",H,ATTR_TITLE,"",ATTR_VALIGN,ALIGN_TOP,ATTR_CLASS,n,ATTR_RECORD_ID,e.getId()]):HU.openTag(TAG_TR,[ATTR_STYLE,h,"aggregateId",H,ATTR_TITLE,"",ATTR_VALIGN,ALIGN_TOP,ATTR_CLASS,n+" display-htmltable-row-"+(Y?"even":"odd"),ATTR_RECORD_ID,e.getId()]),d&&d.length&&p){let t=d[0].colorBy.getColorFromRecord(e);t&&(h+=HU.css(CSS_BACKGROUND,t))}return A+=Utils.join(M,""),A+=HU.close(TAG_TR),!0})),A+=HU.close(TAG_TBODY),A+=HU.open(TAG_TFOOT),A+=HU.open(TAG_TR);let q=NaN;if(F&&(this.getShowSummaryTotal()||this.getShowSummaryAverage()||this.getShowSummaryMinMax())&&(q=0,F.forEach((e=>{A+=HU.open(TAG_TD,[ATTR_ALIGN,ALIGN_RIGHT,ATTR_STYLE,HU.css(CSS_PADDING,HU.px(0),CSS_PADDING_RIGHT,HU.px(10))]);let t=(t,i)=>e.field?!e.field.isFieldString()&&this.getProperty(e.field.getId()+"."+i,t):t;if(e.cnt){let i=[];if(t(this.getShowSummaryTotal(),"showSummaryTotal")){let t=Utils.formatNumberComma(e.total,2);i.push("Total: "+t)}if(t(this.getShowSummaryAverage(),"showSummaryAverage")){let t=e.total/e.cnt;t=Utils.formatNumberComma(t,2),i.push("Avg: "+t)}t(this.getShowSummaryMinMax(),"showSummaryMinMax")&&(i.push("Min: "+e.min),i.push("Max: "+e.max)),A+=HU.div([ATTR_STYLE,HU.css(CSS_TEXT_ALIGN,ALIGN_RIGHT)],Utils.join(i,HU.br())),q+=e.total}A+=HU.close(TAG_TD)}))),A+=HU.close(TAG_TR,TAG_TFOOT,TAG_TABLE,TAG_DIV),!isNaN(q)&&this.getShowGrandSummary()&&(A+="Total: "+q),this.getShowAddRow()&&(A+=HU.div([ATTR_ID,this.domId("addrow"),ATTR_CLASS,CLASS_CLICKABLE],HU.getIconImage("fas fa-plus"))),0==B)return this.setContents(""),void this.setDisplayMessage("No data available");this.setContents(A),P.forEach((e=>{jqid(e+"_toggle").click((function(){let t="true"==$(this).attr("toggleopen");$(this).attr("toggleopen",!t);let i=z.jq(l).find(HU.attrSelect("aggregateRow",e));t?(i.find(".display-td").css(CSS_FONT_WEIGHT,"plain").css(CSS_BORDER_BOTTOM,HU.px(0)),i.css(CSS_FONT_WEIGHT,"plain").css(CSS_BORDER_BOTTOM,HU.px(0)),z.jq(l).find(HU.attrSelect("aggregateId",e)).hide(),$(this).find("#"+e+"_toggleimage").html(HU.getIconImage("fas fa-chevron-right"))):(i.find(".display-td").css(CSS_FONT_WEIGHT,FONT_BOLD).css(CSS_BORDER_BOTTOM,HU.border(1,"#888")),z.jq(l).find(HU.attrSelect("aggregateId",e)).show(),$(this).find("#"+e+"_toggleimage").html(HU.getIconImage("fas fa-chevron-down")))}))}));let W=this.jq(ID_COLORTABLE),j=0;W.html(""),T.forEach(((e,t)=>{t=j++;let i=this.domId(ID_COLORTABLE+t);W.append(HU.div([ATTR_ID,i])),e.displayColorTable(null,!0,ID_COLORTABLE+t)})),d&&this.getShowColorFooter()&&d.forEach(((e,t)=>{t>0&&W.append(HU.div([ATTR_STYLE,HU.css(CSS_BORDER_BOTTOM,HU.border(1,COLOR_LIGHT_GRAY))])),t=j++;let i=this.domId(ID_COLORTABLE+t);W.append(HU.div([ATTR_ID,i])),e.colorBy.displayColorTable(null,!0,ID_COLORTABLE+t)})),this.find(".display-table-header").click((function(){let e=U[$(this).attr(ATTR_FIELD_ID)];"true"===$(this).attr("sorted")&&z.setProperty("sortAscending",!z.getSortAscending()),z.setProperty("sortFields",e.getId()),z.sortByFieldChanged(e.getId())}));let z=this,K=(this.getProperty("tooltipClick"),this.jq(l).find(".display-htmltable-row"));this.makeTooltips(K,e),K.click((function(){let e=z.recordMap[$(this).attr(ATTR_RECORD_ID)];e&&z.propagateEventRecordSelection({record:e})}));let X=this.getScrollY(HU.px(400)),Z={ordering:!1,scrollY:X,paging:this.getProperty("tablePaging")},J=this.jq("table_wrapper");!Z.paging&&B>3e3?(J.css(CSS_MAX_HEIGHT,X).css(CSS_HEIGHT,X).css(CSS_OVERFLOW_Y,OVERFLOW_AUTO).css(CSS_DISPLAY,DISPLAY_FLEX),J.find(TAG_TH).css(CSS_TOP,HU.px(0)).css(CSS_POSITION,"sticky").css(CSS_Z_INDEX,"900"),this.jq(l).css(CSS_HEIGHT,HU.px(200)).css(CSS_OVERFLOW_Y,OVERFLOW_AUTO).css(CSS_BORDER_COLLAPSE,"collapse")):HU.formatTable("#"+this.domId(l),Z),this.getShowAddRow()&&this.jq("addrow").click((()=>{let e=this.getPointData().getRecords(),t=e[e.length-1].clone();e.push(t),this.updateUI(),this.getPointData().propagateEventDataChanged(this)}));let Q=e=>{let t;t="checkbox"==e.attr("inputtype")?HU.isChecked(e):e.val();let i=e.attr("fieldid"),s=e.attr(ATTR_RECORD_INDEX),l=z.recordMap[s],a=z.fieldMap[i];l.data[a.getIndex()]=t,z.getPointData().propagateEventDataChanged(z)};this.jq(ID_DISPLAY_CONTENTS).find(".display-editable").change((function(){Q($(this))})),this.jq(ID_DISPLAY_CONTENTS).find(".display-editable").keypress((function(e){13==e.which&&Q($(this))}))}})}function RamaddaPolltableDisplay(e,t,i){const s="votesstats",l="showvotes",a="togglecells",r=new RamaddaHtmltableDisplay(e,t,i,"polltable");const o="3em";defineDisplay(addRamaddaDisplay(this),r,[{label:"Poll Table"},{p:"pollFields",tt:"Fields to poll on"}],{isPollField(e){return this.pollFields||(this.pollFields=this.getPollFields("").split(",")),this.pollFields.includes(e)},makeColumn:function(e,t,i,s){return this.isPollField(t.getId())?(s=HU.div([ATTR_STYLE,HU.css(CSS_OVERFLOW_Y,OVERFLOW_AUTO,CSS_MAX_HEIGHT,this.cellsToggled?o:HU.px(500)),ATTR_CLASS,"display-polltable-field","data-record-id",e.getId()],s),HU.td(i,s)):r.makeColumn.call(this,e,t,i,s)},measureCont:function(e,t){if(t>0&&e>0&&e+t>10){return 1-Math.abs(e-t)/(e+t)}return 0},getRecords:function(){let e=r.getRecords.call(this);return e?(this.applyVotesToData(e),e):null},applyVotesToData:function(e){if(!this.votingData)return;let t,i,s,l={};Object.keys(this.votingData).forEach((e=>{[recordIndex,field]=e.split("--"),l[recordIndex]||(l[recordIndex]=[]),l[recordIndex].push(this.votingData[e])})),e.forEach((e=>{t||e.getFields().forEach((e=>{"upvotes"==e.getId()?t=e:"downvotes"==e.getId()?i=e:"controversial"==e.getId()&&(s=e)}));let a=e.getRowIndex();if(l[a]){let r=0,o=0,n=0;l[a].forEach((e=>{r+=e.yes,o+=e.no;let t=this.measureCont(e.yes,e.no);n=Math.max(n,t)})),t&&e.setValue(t.getIndex(),r),i&&e.setValue(i.getIndex(),o),e.setValue(s.getIndex(),n)}}))},updateUI:function(){if(!this.votingData){let e=HU.url(RamaddaUtil.getUrl("/entry/vote"),ARG_ENTRYID,this.getProperty("entryId",""));$.getJSON(e,(e=>{this.votingData=e,this.updateUI()}))}let e=this;r.updateUI.call(this),Utils.isDefined(this.cellsToggled)||(this.cellsToggled=!1);let t=HU.buttons([HU.div([ATTR_STYLE,HU.css(CSS_MIN_WIDTH,HU.px(130)),ATTR_ID,this.domId(a)],this.cellsToggled?"Expand Cells":"Toggle Cells"),HU.div([ATTR_STYLE,HU.css(CSS_MIN_WIDTH,HU.px(130)),ATTR_ID,this.domId(l)],"Show Votes"),HU.span([ATTR_ID,this.domId(s),ATTR_STYLE,HU.css(CSS_DISPLAY,DISPLAY_INLINE_BLOCK,CSS_MIN_WIDTH,HU.px(300))],"")],"");this.jq(ID_HEADER0).html(t);let i=this.getContents().find(".display-polltable-field");this.jq(a).button().click((()=>{e.cellsToggled?(e.jq(a).html("Toggle Cells"),i.css(CSS_MAX_HEIGHT,HU.px(500))):(i.css(CSS_MAX_HEIGHT,o),e.jq(a).html("Expand Cells")),this.cellsToggled=!this.cellsToggled,i.attr("toggled",this.cellsToggled)})),i.click((function(){let e=$(this).attr("toggled")??"false",t=$(this).closest(TAG_TR).find(".display-polltable-field");"false"===e?(t.css(CSS_MAX_HEIGHT,o),t.attr("toggled",!0)):(t.css(CSS_MAX_HEIGHT,HU.px(500)),t.attr("toggled",!1))})),this.jq(l).button().click((()=>{this.showingVotes=!this.showingVotes,this.applyShowVotes()}));this.getProperty("entryId");this.applyShowVotes(),this.addVotes()},addVotes:function(){let e=this;this.jq(ID_DISPLAY_CONTENTS).find(".display-polltable-block").remove(),this.jq(ID_DISPLAY_CONTENTS).find(".display-polltable-padding").remove(),this.jq(ID_DISPLAY_CONTENTS).find(TAG_TD).each((function(){if(!$(this).attr(ATTR_FIELD_ID))return;let t=$(this).attr(ATTR_FIELD_ID);if(!e.isPollField(t))return;if(""==$(this).html().trim()||"true"===$(this).attr("nullvalue"))return;let i=$(this).attr(ATTR_RECORD_INDEX);$(this).append(HU.div([ATTR_STYLE,HU.css(CSS_HEIGHT,HU.em(2)),ATTR_CLASS,"display-polltable-padding"]));let s=HU.leftRightTable(HU.div([ATTR_FIELD_ID,t,ATTR_RECORD_INDEX,i,"vote","yes",ATTR_CLASS,HU.classes("vote",CLASS_CLICKABLE),ATTR_TITLE,"Up vote"],HU.getIconImage("fa-regular fa-thumbs-up")),HU.div([ATTR_FIELD_ID,t,ATTR_RECORD_INDEX,i,"vote","no",ATTR_CLASS,HU.classes("vote",CLASS_CLICKABLE),ATTR_TITLE,"Down vote"],HU.getIconImage("fa-regular fa-thumbs-down")));$(this).append(HU.div([ATTR_FIELD_ID,t,ATTR_RECORD_INDEX,i,ATTR_CLASS,"display-polltable-block",ATTR_STYLE,HU.css(CSS_BORDER_TOP,HU.border(1,COLOR_LIGHT_GRAY),CSS_POSITION,POSITION_ABSOLUTE,CSS_RIGHT,HU.px(0),CSS_LEFT,HU.px(10),CSS_BOTTOM,HU.px(0))],s))})),this.jq(ID_DISPLAY_CONTENTS).find(".vote").click((function(){let t=$(this),i=$(this).attr("vote");if(!Utils.isDefined(i))return;let s=$(this).attr(ATTR_FIELD_ID),l=$(this).attr(ATTR_RECORD_INDEX),a=e.getProperty("entryId",""),r=HU.url(RamaddaUtil.getUrl("/entry/vote"),"xreturnvotes",!0,ARG_ENTRYID,a),o=l+"--"+s;r=HU.url(r,["key",o,"vote",i]),$.getJSON(r,(function(s){if(s.error&&console.log("An error occurred:"+s.error),e.canEdit()||(t.attr("vote",null),t.html("--")),e.votingData){let t=e.votingData[o];t||(e.votingData[o]=t={no:0,yes:0}),"yes"==i?t.yes++:t.no++}})).fail((function(e){alert("An error occurred")}))}))},applyShowVotes:function(){let e=this,t=this.jq(ID_DISPLAY_CONTENTS).find(".display-polltable-padding");if(!this.showingVotes)return t.css(CSS_HEIGHT,"2em"),this.jq(l).html("Show Votes"),this.addVotes(),void this.jq(s).html("");this.jq(l).html("Hide Votes");let i=this.getProperty("entryId",""),a=HU.url(RamaddaUtil.getUrl("/entry/vote"),ARG_ENTRYID,i);$.getJSON(a,(function(t){this.votingData=t;let i,l,a=e.jq(ID_DISPLAY_CONTENTS).find(".display-polltable-block");Object.keys(t).forEach((e=>{let s=t[e];Utils.isDefined(s.yes)&&(i||(i={min:s.yes,max:s.yes,total:0}),i.min=Math.min(i.min,s.yes),i.max=Math.max(i.max,s.yes),i.total+=s.yes),Utils.isDefined(s.no)&&(l||(l={min:s.no,max:s.no,total:0}),l.min=Math.min(l.min,s.no),l.max=Math.max(l.max,s.no),l.total+=s.no)}));let r="";i&&(r+="Total yes votes: "+i.total,i.range=i.max-i.min),l&&(r+=HU.space(2)+"Total no votes: "+l.total,l.range=l.max-l.min),r+=HU.space(2)+"("+HU.span([ATTR_STYLE,HU.css(CSS_FONT_WEIGHT,FONT_BOLD,CSS_COLOR,"#D85F48")],"* controversial")+")",e.jq(s).html(r);let o=Utils.getColorTable("plotly_reds",!0);a.each((function(){let s=$(this).attr(ATTR_FIELD_ID),a=$(this).attr(ATTR_RECORD_INDEX),r=t[a+"--"+s],n=0,h=0;r&&(n=r.yes??n,h=r.no??h);let d=0,g=0;i&&(d=i.total>0?parseInt(n/i.total*100):100),l&&(g=l.total>0?parseInt(h/l.total*100):100);let p=HU.open(TAG_TABLE,[ATTR_CELLPADDING,0,ATTR_CELLSPACING,0,ATTR_BORDER,0,ATTR_WIDTH,HU.perc(100)]),c=HU.css(CSS_PADDING,HU.important(HU.px(0)),CSS_PADDING_RIGHT,HU.important(HU.px(4)),CSS_FONT_SIZE,HU.pt(9)),u=((e,t,i)=>{let s;if(i>.5){let e=Math.min(o.length-1,Math.max(0,parseInt(i*o.length)));s=o[e]}return s})(0,0,e.measureCont(n,h));u&&(c+=HU.css(CSS_COLOR,u,CSS_FONT_WEIGHT,FONT_BOLD));let T=(e,t,i)=>{let s=u?"Controversial":"";p+=HU.tr([ATTR_TITLE,s],HU.td([ATTR_WIDTH,HU.px(5),ATTR_STYLE,c,ATTR_ALIGN,ALIGN_RIGHT],(e=>{let t=[];return u&&t.push(ATTR_STYLE,HU.css(CSS_COLOR,u)),HU.getIconImage(e,[],t)})(i))+HU.td([ATTR_STYLE,c],e+" ("+HU.perc(t)+") "+(u?"*":"")))};T(n,d,"fa-regular fa-thumbs-up"),T(h,g,"fa-regular fa-thumbs-down"),p+=HU.close(TAG_TABLE),$(this).html(p)}))})).fail((function(e){alert("An error occurred")}))}})}function RamaddaTsneDisplay(e,t,i){const s="tsnecanvas",l="tsnedetails",a="tsnerun",r="tsnereset",o="tsnestep",n="tsnesearch";$.extend(this,{colorTable:"red_white_blue",colorByMin:"-1",colorByMax:"1",height:HU.px(500)});const h=new RamaddaFieldsDisplay(e,t,DISPLAY_TSNE,i);defineDisplay(addRamaddaDisplay(this),h,[],{nameToIndex:{},needsData:function(){return!0},handleEventPointDataLoaded:function(e,t){this.needsData()||null==this.dataCollection&&(this.dataCollection=e.dataCollection,this.updateUI())},updateUI:async function(e){if(h.updateUI.call(this,e),!this.hasData())return void this.setDisplayMessage(this.getLoadingMessage());await Utils.importJS(RamaddaUtil.getCdnUrl("/lib/tsne.js"));let t=this.getProperty("height",400);String(t).endsWith("px")&&(t=String(t).replace("px","")),t=parseInt(t);let i=HU.div([ATTR_STYLE,HU.css(CSS_HEIGHT,HU.px(t),CSS_MAX_HEIGHT,HU.px(t)),ATTR_CLASS,"display-tnse-details",ATTR_ID,this.domId(l)],""),d=HU.div([ATTR_CLASS,"display-tnse-canvas-outer",ATTR_STYLE,HU.css(CSS_HEIGHT,HU.px(t))],HU.div([ATTR_CLASS,"display-tnse-canvas",ATTR_ID,this.domId(s)],"")),g=HU.div([ATTR_ID,this.domId(a),ATTR_CLASS,CLASS_BUTTON,ATTR_WHAT,"run"],"Stop")+SPACE+HU.div([ATTR_ID,this.domId(o),ATTR_CLASS,CLASS_BUTTON,ATTR_WHAT,"step"],"Step")+SPACE+HU.div([ATTR_ID,this.domId(r),ATTR_CLASS,CLASS_BUTTON,ATTR_WHAT,"reset"],"Reset")+SPACE+HU.input("","",[ATTR_ID,this.domId(n),ATTR_PLACEHOLDER,"search"]);g=HU.div([ATTR_CLASS,"display-tnse-toolbar"],g),this.jq(ID_TOP_LEFT).append(g),this.setContents(HU.table([ATTR_WIDTH,HU.perc(100)],HU.tr([ATTR_VALIGN,ALIGN_TOP],HU.td([ATTR_WIDTH,HU.perc(80)],d)+HU.td([ATTR_WIDTH,HU.perc(20)],i)))),this.search=this.jq(n),this.search.keyup((e=>{let t=this.search.val().trim();if(this.canvas.find(".display-tnse-mark").removeClass("display-tnse-highlight"),""!=t)for(name in t=t.toLowerCase(),this.nameToIndex)name.toLowerCase().startsWith(t)&&this.jq("element-"+this.nameToIndex[name]).addClass("display-tnse-highlight")})),this.details=this.jq(l),this.reset=this.jq(r),this.step=this.jq(o),this.step.button().click((()=>{this.running=!1,this.run.html(this.running?"Stop":"Run"),this.takeStep()})),this.reset.button().click((()=>{this.start()})),this.run=this.jq(a),this.run.button().click((()=>{this.running=!this.running,this.running&&this.takeStep(),this.run.html(this.running?"Stop":"Run")})),this.canvas=this.jq(s),this.running=!0,this.start()},start:function(){this.canvas.html(""),this.haveStepped=!1,this.dataList=this.getStandardData(null,{includeIndex:!1});let e=this.dataCollection.getList()[0].getRecordFields();if(!this.fields){this.fields=this.getSelectedFields([]),0==this.fields.length&&(this.fields=e);let t=this.getFieldsByType(this.fields,"string");t.length>0&&(this.textField=t[0])}let t=[];for(let e=1;e<this.dataList.length;e++){let i=this.getDataValues(this.dataList[e]),s=[];for(let e=0;e<this.fields.length;e++)if(this.fields[e].isNumeric()){let t=i[this.fields[e].getIndex()];isNaN(t)&&(t=0),s.push(t)}t.push(s)}let i={epsilon:10,perplexity:30,dim:2};this.tsne=new tsnejs.tSNE(i),this.tsne.initDataRaw(t),this.takeStep()},takeStep:function(){for(let e=0;e<10;e++)this.tsne.step();let e,t,i,s,l=this.tsne.getSolution();for(let a=0;a<l.length;a++)0==a?(i=e=l[a][0],s=t=l[a][1]):(i=Math.max(i,l[a][0]),e=Math.min(e,l[a][0]),s=Math.max(s,l[a][1]),t=Math.min(t,l[a][1]));for(let a=0;a<l.length;a++){let r=100*(l[a][0]-e)/(i-e),o=100*(l[a][1]-t)/(s-t);if(this.haveStepped)this.jq("element-"+a).animate({left:HU.perc(r),top:HU.perc(o)},250,"linear");else{let e="";if(this.textField){e=this.getDataValues(this.dataList[a])[this.textField.getIndex()]}e.length>10&&(e.length=10),this.nameToIndex[e]=a,this.canvas.append(HU.div([ATTR_TITLE,e,ATTR_INDEX,a,ATTR_ID,this.domId("element-"+a),ATTR_CLASS,"display-tnse-mark",ATTR_STYLE,HU.css(CSS_LEFT,HU.perc(r),CSS_TOP,HU.perc(o))],e))}}let a=this;this.haveStepped||this.canvas.find(".display-tnse-mark").click((function(e){let t=parseInt($(this).attr("index"));if(t<0||t>=a.dataList.length)return;let i=a.getDataValues(a.dataList[t]),s=HU.open(TAG_TABLE,[ATTR_CLASS,CLASS_FORMTABLE,ATTR_WIDTH,HU.perc(100)]);for(let e=0;e<a.fields.length;e++){let t=a.fields[e];s+=HU.tr([],HU.td([ATTR_ALIGN,ALIGN_RIGHT,ATTR_CLASS,CLASS_FORMLABEL],this.getFieldLabel(t)+":")+HU.td([],i[t.getIndex()]))}s+=HU.close(TAG_TABLE),a.details.html(s)})),this.haveStepped,this.haveStepped=!0,this.running&&setTimeout((()=>this.takeStep()),250)}})}function RamaddaHeatmapDisplay(e,t,i){$.extend(this,{colorTable:"red_white_blue"});const s=new RamaddaFieldsDisplay(e,t,DISPLAY_HEATMAP,i);defineDisplay(addRamaddaDisplay(this),s,[],{"map-display":!1,needsData:function(){return!0},getMenuItems:function(e){s.getMenuItems.call(this,e);this.getGet();let t=HU.formTable(),i=this.getColorTableName(),l=HU.open(TAG_SELECT,[ATTR_ID,this.domId(ID_COLORTABLE)]);for(table in Utils.ColorTable)table==i?l+=HU.tag(TAG_OPTION,[ATTR_SELECTED,null],table):l+=HU.tag(TAG_OPTION,[],table);l+=HU.close(TAG_SELECT),t+=HU.formEntryLabel("Color Table",l),t+=HU.formEntryLabel("Color By Range",HU.input("",this.colorByMin,[ATTR_SIZE,7,ATTR_ID,this.domId("colorbymin")])+" - "+HU.input("",this.colorByMax,[ATTR_SIZE,7,ATTR_ID,this.domId("colorbymax")])),t+=HU.close(TAG_TABLE),e.push(t)},initDialog:function(){s.initDialog.call(this);let e=this,t=function(){e.colorByMin=e.jq("colorbymin").val(),e.colorByMax=e.jq("colorbymax").val(),e.updateUI()};this.jq("colorbymin").blur(t),this.jq("colorbymax").blur(t),this.jq(ID_COLORTABLE).change((function(){e.colorTable=e.jq(ID_COLORTABLE).val(),e.updateUI()}))},handleEventPointDataLoaded:function(e,t){this.needsData()||null==this.dataCollection&&(this.dataCollection=e.dataCollection,this.updateUI())},fieldSelectionChanged:function(){this.updateUI()},getContentsStyle:function(){let e=this.getProperty("height",-1);return e>0?HU.css(CSS_HEIGHT,HU.px(e),CSS_MAX_HEIGHT,HU.px(e),CSS_OVERFLOW_Y,OVERFLOW_AUTO):""},updateUI:function(e){let t=this;if(!haveGoogleChartsLoaded()){let e=function(){t.updateUI()};return this.setDisplayMessage(this.getLoadingMessage()),void setTimeout(e,1e3)}if(s.updateUI.call(this,e),!this.hasData())return void this.setDisplayMessage(this.getLoadingMessage());let i=this.getStandardData(null,{includeIndex:!0}),l=this.getDataValues(i[0]),a=this.getProperty("showIndex",!0),r=this.getProperty("showValue",!0),o=this.getProperty("textColor","black"),n=this.getProperty("cellHeight",null),h="";this.getProperty("showBorder")&&(h=HU.css(CSS_BORDER_BOTTOM,HU.border(1,"#666")));let d="";n&&(d+=HU.css(CSS_HEIGHT,HU.px(n),CSS_MAX_HEIGHT,HU.px(n),CSS_MIN_HEIGHT,HU.px(n)));let g=this.dataCollection.getList()[0].getRecordFields(),p=this.getSelectedFields([]);0==p.length&&(p=g);let c="",u=null,T=null,f=null;if(Utils.stringDefined(this.getProperty("colorByMins"))){T=[];let e=this.getProperty("colorByMins").split(",");for(let t=0;t<e.length;t++)T.push(parseFloat(e[t]))}if(Utils.stringDefined(this.getProperty("colorByMaxes"))){f=[];let e=this.getProperty("colorByMaxes").split(",");for(let t=0;t<e.length;t++)f.push(parseFloat(e[t]))}if(Utils.stringDefined(this.getProperty("colorTables"))){let e=this.getProperty("colorTables").split(",");u=[];for(let t=0;t<e.length;t++){let i=e[t];if("none"==i){u.push(null);continue}let s=Utils.getColorTable(i,!0);u.push(s)}}else u=[this.getColorTable(!0)];let y=null,m=null;for(let e=1;e<i.length;e++){let t=this.getDataValues(i[e]);if(null==y){y=[],m=[];for(let e=1;e<t.length;e++)y.push(Number.MAX_VALUE),m.push(Number.MIN_VALUE)}for(let e=0;e<p.length;e++){let i=p[e],s=i.getIndex()+1;if(!i||!i.isFieldNumeric()||i.isFieldGeo())continue;let l=t[s];l!=Number.POSITIVE_INFINITY&&!isNaN(l)&&Utils.isNumber(l)&&Utils.isDefined(l)&&null!=l&&(y[e]=Math.min(y[e],l),m[e]=Math.max(m[e],l))}}c+=HU.open(TAG_TABLE,[ATTR_BORDER,0,ATTR_CLASS,"display-heatmap"]),c+=HU.open(TAG_TR,[ATTR_VALIGN,ALIGN_BOTTOM]),a&&(c+=HU.td([ATTR_ALIGN,ALIGN_CENTER],HU.div([ATTR_CLASS,"display-heatmap-heading-top"],l[0])));for(let e=0;e<p.length;e++){let t=p[e];t.isFieldNumeric()&&!t.isFieldGeo()&&(c+=HU.td([ATTR_ALIGN,ALIGN_CENTER],HU.div([ATTR_CLASS,"display-heatmap-heading-top"],this.getFieldLabel(t))))}c+=HU.close(TAG_TR);for(let e=1;e<i.length;e++){let t=this.getDataValues(i[e]),s=t[0];s.f&&(s=s.f);let n=s;c+=HU.open(TAG_TR,[ATTR_VALIGN,ALIGN_CENTER]),a&&(c+=HU.td([ATTR_CLASS,"display-heatmap-heading-side",ATTR_STYLE,d+h],n));let g=0;for(let e=0;e<p.length;e++){let i=p[e],s=i.getIndex()+1;if(!i||!i.isFieldNumeric()||i.isFieldGeo())continue;let a="",_=t[s],S=y[e],A=m[e];T&&g<T.length&&(S=T[g]),f&&g<f.length&&(A=f[g]);let I,b=S!=A&&!(_==Number.POSITIVE_INFINITY||isNaN(_)||!Utils.isNumber(_)||!Utils.isDefined(_)||null==_),R=l[0]+": "+n+" - "+this.getFieldLabel(i)+": "+_;if(b&&null!=u){let e=u[Math.min(g,u.length-1)];if(e){let t=parseInt((_-S)/(A-S)*e.length);t>=e.length?t=e.length-1:t<0&&(t=0),a="background-color:"+e[t]+";"}}I=b?Utils.formatNumber(_):"-",r||(I=""),c+=HU.td([ATTR_VALIGN,ALIGN_CENTER,ATTR_ALIGN,ALIGN_RIGHT,ATTR_STYLE,a+d+h,ATTR_CLASS,"display-heatmap-cell"],HU.div([ATTR_TITLE,R,ATTR_STYLE,d+HU.css(CSS_COLOR,o)],I)),g++}c+=HU.close(TAG_TR)}c+=HU.close(TAG_TABLE),this.setContents(c),this.initTooltip()}})}function RamaddaRankingDisplay(e,t,i){const s="rankingtable";$.extend(this,{height:HU.px(500),sortAscending:!1}),i.sortAscending&&(this.sortAscending="true"==i.sortAscending);const l=new RamaddaFieldsDisplay(e,t,DISPLAY_RANKING,i);defineDisplay(addRamaddaDisplay(this),l,[{label:"Ranking"},{p:"sortField",ex:""},{p:"nameFields",ex:""}],{needsData:function(){return!0},handleEventPointDataLoaded:function(e,t){this.needsData()||null==this.dataCollection&&(this.dataCollection=e.dataCollection,this.updateUI())},fieldSelectionChanged:function(){this.updateUI()},updateUI:function(e){l.updateUI.call(this,e);let t=this.records=this.filterData();if(null==t)return void this.setDisplayMessage(this.getLoadingMessage());this.idToRecord={},t.forEach((e=>{this.idToRecord[e.getId()]=e}));let i=this.dataCollection.getList()[0].getRecordFields(),a=this.getSelectedFields([]);0==a.length&&(a=i);let r=this.getFieldsByType(a,"numeric"),o=this.getFieldById(r,this.getProperty("sortField","",!0));if(0==r.length)return void this.setContents("No fields specified");if(o||(o=r[0]),!o)return void this.setDisplayMessage("No fields specified");let n=this.getFieldsByIds(i,this.getProperty("nameFields","",!0));if(0==n.length){let e=this.getFieldById(i,this.getProperty("nameField","",!0));e&&n.push(e)}if(0==n.length){let e=this.getFieldByType(i,"string");e&&n.push(e)}let h=HU.open(TAG_SELECT,[ATTR_CLASS,CLASS_PULLDOWN,ATTR_ID,this.domId("sortfields")]);for(let e=0;e<r.length;e++){let t=r[e],i="";t.getId()==o.getId()&&(i=" selected "),h+=HU.tag(TAG_OPTION,[ATTR_VALUE,t.getId(),i,null],this.getFieldLabel(t))}h+=HU.close(TAG_SELECT);let d="";d+=HU.span([ATTR_ID,this.domId("sort")],HU.getIconImage(this.sortAscending?"fa-sort-up":"fa-sort-down",[ATTR_STYLE,HU.css(CSS_CURSOR,CURSOR_POINTER),ATTR_TITLE,"Change sort order"])),this.getProperty("showRankingMenu",!0)&&(d+=" "+HU.div([ATTR_STYLE,HU.css(CSS_DISPLAY,DISPLAY_INLINE_BLOCK),ATTR_CLASS,"display-filterby"],h)),this.jq(ID_TOP_LEFT).html(d),this.jq("sort").click((()=>{this.sortAscending=!this.sortAscending,this.sortAscending?this.jq("sort").html(HU.getIconImage("fa-sort-up",[ATTR_STYLE,HU.css(CSS_CURSOR,CURSOR_POINTER)])):this.jq("sort").html(HU.getIconImage("fa-sort-down",[ATTR_STYLE,HU.css(CSS_CURSOR,CURSOR_POINTER)])),this.updateUI()}));let g="";g+=HU.open(TAG_DIV,[ATTR_STYLE,HU.css(CSS_MAX_HEIGHT,HU.perc(100),CSS_OVERFLOW_Y,OVERFLOW_AUTO)]),g+=HU.open(TAG_TABLE,[ATTR_ID,this.domId(s)]);let p=t,c=this.getProperty("includeNaN",!1);if(!c){let e=[];p.map((t=>{let i=o.getValue(t);isNaN(i)||e.push(t)})),p=e}let u=this.getFilterHighlight(),T=(e,t)=>{let i=t,s=e.isHighlight(this),l=i.isHighlight(this);if(u){if(s&&!l)return 1;if(!s&&l)return-1}let a=this.getDataValues(e),r=this.getDataValues(t),n=a[o.getIndex()],h=r[o.getIndex()];return n<h?-1:n>h?1:0};p.sort(((e,t)=>{let i=T(e,t);return 0==i?0:this.sortAscending?i:-i}));for(let e=0;e<p.length;e++){let t=p[e],i=(this.getDataValues(t),"");if(n.map((e=>{i+=e.getValue(t)+" "})),i=i.trim(),value=o.getValue(t),isNaN(value)||null===value){if(!c)continue;value="NA"}else value=this.formatNumber(value);g+=HU.tr([ATTR_VALIGN,ALIGN_TOP,ATTR_CLASS,"display-ranking-row",ATTR_WHAT,t.getId()],HU.td([],"#"+(e+1))+HU.td([],SPACE+i)+HU.td([ATTR_ALIGN,ALIGN_RIGHT],SPACE+value))}g+=HU.close(TAG_TABLE,TAG_DIV),this.setContents(g);let f=this;this.jq(s).find(".display-ranking-row").click((function(e){let t=f.idToRecord[$(this).attr(ATTR_WHAT)];f.propagateEventRecordSelection({record:t})})),HU.initSelect(this.jq("sortfields")),this.jq("sortfields").change((function(){f.setProperty("sortField",$(this).val()),f.updateUI()}))}})}function RamaddaWaffleDisplay(e,t,i){const s=new RamaddaFieldsDisplay(e,t,DISPLAY_WAFFLE,i);let l=[{label:"Waffle"},{p:"labelField",ex:""},{p:"boxSize",d:HU.px(15)},{p:"showFieldLabel",d:!0}];defineDisplay(addRamaddaDisplay(this),s,l,{needsData:function(){return!0},updateUI:function(e){s.updateUI.call(this,e);let t=this.records=this.filterData();if(null==t)return void this.setDisplayMessage(this.getLoadingMessage());this.dataCollection.getList()[0].getRecordFields();let i=this.getSelectedFields([]),l=this.getFieldById(null,this.getProperty("labelField"));if(!l){let e=this.getFieldsByType(null,"string");e.length>0&&(l=e[0])}let a="",r=this.getShowFieldLabel(),o=Utils.split(this.getColors("#F7931F,#4CC1EF,#C13018,#A6C68E,#89A7DE"),",",!0,!0);i.forEach(((e,i)=>{i>0&&(a+=HU.p()),r&&(a+=HU.b(e.getLabel())+HU.br()),t.forEach(((t,i)=>{let s=l?t.getValue(l.getIndex()):index,r=parseInt(100*e.getValue(t)),n=HU.open(TAG_TABLE,[ATTR_CELLPADDING,0,ATTR_CELLSPACING,0,ATTR_STYLE,HU.css(CSS_BORDER,HU.border(1,COLOR_LIGHT_GRAY),CSS_BORDER_COLLAPSE,"collapse")]),h=0,d=HU.getDimension(this.getBoxSize()),g=o[i%o.length];for(let e=0;e<10;e++){n+=HU.open(TAG_TR);for(let e=0;e<10;e++){h++;let e=HU.css(CSS_WIDTH,d,CSS_HEIGHT,d,CSS_BORDER_WIDTH,HU.px(1),"border-left-width",HU.px(0));100-h<r&&(e+=HU.css(CSS_BACKGROUND,g)),n+=HU.td(HU.td([ATTR_STYLE,e],""))}n+=HU.close(TAG_TR)}n+=HU.close(TAG_TABLE),a+=HU.div([ATTR_STYLE,HU.css(CSS_DISPLAY,DISPLAY_INLINE_BLOCK,CSS_MARGIN_RIGHT,HU.px(20))],HU.b(s+" "+HU.perc(r))+HU.br()+n)}))})),this.setContents(a)}})}function RamaddaCrosstabDisplay(e,t,i){const s="crosstab",l=new RamaddaFieldsDisplay(e,t,DISPLAY_CROSSTAB,i);defineDisplay(addRamaddaDisplay(this),l,[],{needsData:function(){return!0},handleEventPointDataLoaded:function(e,t){this.needsData()||null==this.dataCollection&&(this.dataCollection=e.dataCollection,this.updateUI())},fieldSelectionChanged:function(){this.updateUI()},updateUI:function(e){if(l.updateUI.call(this,e),!this.hasData())return void this.setDisplayMessage(this.getLoadingMessage());let t=this.dataCollection.getList()[0].getRecordFields(),i=[];t.map((e=>{let t=this.getFieldLabel(e);t.length>30&&(t=t.substring(0,29)),i.push([e.getId(),t])}));let a=HU.span([ATTR_CLASS,"display-filterby"],"Display: "+HU.select("",[ATTR_STYLE,"",ATTR_ID,this.domId("crosstabselect")],i,this.getProperty("column","",!0)));this.setContents(a+HU.div([ATTR_ID,this.domId(s)]));let r=this;this.jq("crosstabselect").change((function(){r.setProperty("column",$(this).val()),r.makeTable()})),this.makeTable()},makeTable:function(){let e=this.getStandardData(null,{includeIndex:!1}),t=this.dataCollection.getList()[0].getRecordFields(),i=this.getFieldById(null,this.getProperty("column","",!0)),l=this.getFieldsByIds(null,this.getProperty(ATTR_ROWS,null,!0));i||(i=t[0]),0==l.length&&(l=t);let a=HU.open(TAG_TABLE,[ATTR_BORDER,HU.px(1),"bordercolor",COLOR_LIGHT_GRAY,ATTR_CLASS,"display-crosstab",ATTR_CELLSPACING,1,ATTR_CELLPADDING,2]),r=e.length-1,o=0;l.map((t=>{if(t.getId()==i.getId())return;o++;let s=[],l=[],n={},h={};for(let a=1;a<e.length;a++){let r=this.getDataValues(e[a]),o=(""+r[i.getIndex()]).trim(),d=(""+r[t.getIndex()]).trim(),g=o+"--"+d;s.indexOf(o)<0&&s.push(o),l.indexOf(d)<0&&l.push(d),d in h||(h[d]=0),h[d]++,g in n||(n[g]=0),n[g]++}s.sort(),l.sort(),1==o&&(a+=HU.tr([],HU.td()+HU.td([ATTR_ALIGN,ALIGN_CENTER,ATTR_CLASS,"display-crosstab-header",ATTR_COLSPAN,s.length],i.getLabel())+HU.td([],SPACE))),a+=HU.open(TAG_TR,[ATTR_VALIGN,ALIGN_BOTTOM,ATTR_CLASS,"display-crosstab-header-row"],HU.td([ATTR_CLASS,"display-crosstab-header"],t.getLabel()));for(let e=0;e<s.length;e++){let t=s[e];a+=HU.td([],""==t?"&lt;blank&gt;":t)}a+=HU.td([],HU.b("Total")),a+=HU.close(TAG_TR);for(let e=0;e<l.length;e++){let t=l[e];a+=HU.open(TAG_TR),a+=HU.td([],""==t?"&lt;blank&gt;":t);for(let e=0;e<s.length;e++){let i=s[e]+"--"+t;if(Utils.isDefined(n[i])){let e=HU.perc(Math.round(n[i]/r*100));a+=HU.td([ATTR_ALIGN,ALIGN_RIGHT],n[i]+SPACE+"("+e+")")}else a+=HU.td([],SPACE)}let i=Math.round(h[t]/r*100)+"%";a+=HU.td([ATTR_ALIGN,ALIGN_RIGHT],h[t]+SPACE+"("+i+")"),a+=HU.close(TAG_TR)}})),a+=HU.close(TAG_TABLE),this.jq(s).html(a)}})}function RamaddaCorrelationDisplay(e,t,i){const s="sliderlow",l="sliderlowmin",a="sliderlowmax",o="sliderhigh",n="sliderhighmin",h="sliderhighmax",d="table",g="lastrow",p="colfield",c="rowfield";$.extend(this,{colorTable:"red_white_blue",colorByMin:"-1",colorByMax:"1"});const u=new RamaddaFieldsDisplay(e,t,DISPLAY_CORRELATION,i);defineDisplay(addRamaddaDisplay(this),u,[{label:"Correlation"},{p:"showSelectSlider",ex:"false",d:!0},{p:"showDownload",ex:!0,d:!1},{p:"range.low.min",ex:"-1"},{p:"range.low.max",ex:"0"},{p:"range.high.min",ex:"0"},{p:"range.high.max",ex:"1"},{p:"short",ex:"true",tt:"Abbreviated display"},{p:"includeGeo",ex:"true",ex:!0},{p:"showValue",ex:"false",tt:"Show the values"},{p:"stringsOk",ex:"true",tt:"Show string values"},{p:"useId ",ex:" true",tt:"Use field id instead of label"},{p:"useIdTop",ex:"true",tt:"Use field id for top header"},{p:"useIdSide ",ex:"true",tt:"Use field id for side header"},{p:"labelStyle",ex:"",tt:"CSS style for labels"},{p:"sideHeadingStyle"}],{"map-display":!1,needsData:function(){return!0},getMenuItems:function(e){u.getMenuItems.call(this,e);this.getGet();let t=HU.formTable(),i=this.getColorTableName(),s=HU.open(TAG_SELECT,[ATTR_ID,this.domId(ID_COLORTABLE)]);for(table in Utils.ColorTables)table==i?s+=HU.tag(TAG_OPTION,[ATTR_SELECTED,null],table):s+=HU.tag(TAG_OPTION,[],table);s+=HU.close(TAG_SELECT),t+=HU.formEntryLabel("Color Bar",s),t+=HU.formEntryLabel("Color By Range",HU.input("",this.colorByMin,[ATTR_SIZE,7,ATTR_ID,this.domId("colorbymin")])+" - "+HU.input("",this.colorByMax,[ATTR_SIZE,7,ATTR_ID,this.domId("colorbymax")])),t+=HU.close(TAG_TABLE),e.push(t)},initDialog:function(){u.initDialog.call(this);let e=this,t=function(){e.colorByMin=e.jq("colorbymin").val(),e.colorByMax=e.jq("colorbymax").val(),e.updateUI()};this.jq("colorbymin").blur(t),this.jq("colorbymax").blur(t),this.jq(ID_COLORTABLE).change((function(){e.colorTable=e.jq(ID_COLORTABLE).val(),e.updateUI()}))},handleEventPointDataLoaded:function(e,t){this.needsData()||null==this.dataCollection&&(this.dataCollection=e.dataCollection,this.updateUI())},fieldSelectionChanged:function(){this.updateUI()},updateUI:function(e){if(u.updateUI.call(this,e),!this.hasData())return void this.setDisplayMessage(this.getLoadingMessage());let t=this,i="";if(this.getProperty("showDownload",!1)&&(i+=HU.div([ATTR_ID,this.domId("download")],"Download Correlation Table")),this.range={low:{min:this.getProperty("range.low.min",-1),max:this.getProperty("range.low.max",0)},high:{min:this.getProperty("range.high.min",0),max:this.getProperty("range.high.max",1)}},this.getShowSelectSlider()){let e=HU.div([ATTR_STYLE,HU.css(CSS_DISPLAY,DISPLAY_INLINE_BLOCK)],HU.div([],"Negative Correlation")+HU.div([ATTR_ID,this.gid(l),ATTR_STYLE,HU.css(ATTR_WIDTH,HU.px(50),CSS_DISPLAY,DISPLAY_INLINE_BLOCK,CSS_TEXT_ALIGN,ALIGN_RIGHT,CSS_MARGIN_RIGHT,HU.px(15))],this.range.low.min)+HU.div([ATTR_STYLE,HU.css(CSS_HEIGHT,HU.px(20),CSS_DISPLAY,DISPLAY_INLINE_BLOCK,CSS_WIDTH,HU.px(200),CSS_BACKGROUND,this.getProperty("lowSliderBackground","#FD9596")),ATTR_ID,this.gid(s)])+HU.div([ATTR_ID,this.gid(a),ATTR_STYLE,HU.css(CSS_TEXT_ALIGN,ALIGN_LEFT,CSS_WIDTH,HU.px(50),CSS_DISPLAY,DISPLAY_INLINE_BLOCK,CSS_MARGIN_LEFT,HU.px(15))],this.range.low.max)),t=HU.div([ATTR_STYLE,HU.css(CSS_DISPLAY,DISPLAY_INLINE_BLOCK)],HU.div([],"Positive Correlation")+HU.div([ATTR_ID,this.gid(n),ATTR_STYLE,HU.css(CSS_WIDTH,HU.px(50),CSS_DISPLAY,DISPLAY_INLINE_BLOCK,CSS_TEXT_ALIGN,ALIGN_RIGHT,CSS_MARGIN_RIGHT,HU.px(15))],this.range.high.min)+HU.div([ATTR_STYLE,HU.css(CSS_HEIGHT,HU.px(20),CSS_DISPLAY,DISPLAY_INLINE_BLOCK,CSS_WIDTH,HU.px(200),CSS_BACKGROUND,this.getProperty("highSliderBackground","#64A982")),ATTR_ID,this.gid(o)])+HU.div([ATTR_ID,this.gid(h),ATTR_STYLE,HU.css(CSS_TEXT_ALIGN,ALIGN_LEFT,CSS_WIDTH,HU.px(50),CSS_DISPLAY,DISPLAY_INLINE_BLOCK,CSS_MARGIN_LEFT,HU.px(15))],this.range.high.max));i+=HU.center(HU.hrow(e,t))}i+=HU.div([ATTR_ID,this.domId(d)]),this.setContents(i),this.jq("download").button().click((()=>{let e="";this.csv.forEach((t=>{e+=Utils.join(t,","),e+="\n"})),Utils.makeDownloadFile(this.getProperty("downloadFile","correlation.csv"),e)})),this.makeTable(),this.getShowSelectSlider()&&(this.jq(s).slider({range:!0,min:0,max:100,values:[100*(this.range.low.min+1),100*(this.range.low.max+1)],slide:function(e,i){let s=i.values[0]/100-1,r=i.values[1]/100-1,o=-1==s?-1:number_format(s,3),n=0==r?0:number_format(r,3);t.jq(l).html(o),t.jq(a).html(n)},stop:function(e,i){t.range.low.min=2*i.values[0]/100-1,t.range.low.max=2*i.values[1]/100-1,t.makeTable()}}),this.jq(o).slider({range:!0,min:0,max:100,values:[100*this.range.high.min,100*this.range.high.max],slide:function(e,i){let s=i.values[0]/100,l=i.values[1]/100;t.jq(n).html(0==s?0:number_format(s,3)),t.jq(h).html(1==l?1:number_format(l,3))},stop:function(e,i){t.range.high.min=i.values[0]/100,t.range.high.max=i.values[1]/100,t.makeTable()}})),this.initTooltip(),this.displayManager.propagateEventRecordSelection(this,this.dataCollection.getList()[0],{index:0})},getCellLabel(e,t){return this.getProperty("label."+e.getId()+"."+t.getId())},makeTable:function(){let e=this.getStandardData(null,{includeIndex:!1}),t=this.dataCollection.getList()[0].getRecordFields(),i=this.getSelectedFields([]);0==i.length&&(i=t);let s=this.getStringsOk();i=i.filter((e=>!(e.isFieldGeo()&&!this.getIncludeGeo())&&!(!s&&!e.isFieldNumeric())));let l=i.length,a="";i.length>8&&(a+=HU.openTag(TAG_DIV,[ATTR_STYLE,HU.css(CSS_FONT_SIZE,HU.perc(75))])),this.csv=[],a+=HU.open(TAG_TABLE,[ATTR_CELLSPACING,0,ATTR_CELLPADDING,0,ATTR_BORDER,0,ATTR_CLASS,"display-correlation",ATTR_WIDTH,"100%"]);let o=90/l+"%";a+=HU.open(TAG_TR,[ATTR_VALIGN,CSS_BOTTOM])+HU.td([ATTR_CLASS,"display-heading",ATTR_WIDTH,"10%"],SPACE);let n,h=this.getProperty("short",!1),u=this.getProperty("showValue",!h),T=this.getProperty("useId",!1),f=this.getProperty("useIdTop",T),y=this.getProperty("useIdSide",T),m=this.getProperty("labelStyle","");this.csv.push(n=[]),i.forEach((e=>{let t=f?e.getId():this.getFieldLabel(e);n.push(t),h&&(t=""),t=t.replace(/\/ +/g,"/").replace(/ +\//g,"/"),t=HU.div([ATTR_CLASS,"display-correlation-header",ATTR_STYLE,m],t),a+=HU.td([p,e.getId(),ATTR_ALIGN,ALIGN_CENTER,ATTR_WIDTH,o],HU.div([ATTR_CLASS,"display-correlation-heading display-correlation-heading-top"],t))})),a+=HU.close(TAG_TR),this.getProperty("colorTable")||this.setProperty("colorTable","red_white_green");let _=this.getColorTable(!0);colorByMin=parseFloat(this.colorByMin),colorByMax=parseFloat(this.colorByMax),_&&(_=this.addAlpha(_,.5));let S=this.getSideHeadingStyle(""),A={};i.forEach((e=>{e.isNumeric()||(A[e.getId()]={count:0,seen:{}})}));let I=(e,t)=>{if(!e.isNumeric()){let i=A[e.getId()];return Utils.isDefined(i.seen[t])||(i.seen[t]=i.count++),i.seen[t]}return t};for(let t=0;t<i.length;t++){this.csv.push(n=[]);let s=i[t],l=y?s.getId():this.getFieldLabel(s);n.push(l),l.replace(/ /g,SPACE),l=HU.div([ATTR_CLASS,"display-correlation-header",ATTR_STYLE,m],l),a+=HU.open(TAG_TR,[ATTR_VALIGN,ALIGN_CENTER]),a+=HU.td([c,s.getId(),ATTR_CLASS,"display-correlation-heading"],HU.div([ATTR_STYLE,S,ATTR_CLASS,"display-correlation-heading-side"],l));let o=this.getFieldLabel(s);for(let l=0;l<i.length;l++){let d=i[l],g=this.getFieldLabel(d),T=0,f=0,y=0;for(let t=1;t<e.length;t++){let i=this.getDataValues(e[t]),l=I(s,i[s.getIndex()]),a=I(d,i[d.getIndex()]);isNaN(l)||isNaN(a)||(T+=l,f+=a,y++)}let m=T/y,S=f/y,A=0,b=0,R=0;for(let t=1;t<e.length;t++){let i=this.getDataValues(e[t]),l=I(s,i[s.getIndex()]),a=I(d,i[d.getIndex()]);isNaN(l)||isNaN(a)||(A+=(l-m)*(a-S),b+=(l-m)*(l-m),R+=(a-S)*(a-S))}r=A/Math.sqrt(b*R);let D=r<0?r>=this.range.low.min&&r<=this.range.low.max:r>=this.range.high.min&&r<=this.range.high.max,L="";if(D&&null!=_)if(t!=l){let e=(r-colorByMin)/(colorByMax-colorByMin),t=parseInt(e*_.length);t>=_.length?t=_.length-1:t<0&&(t=0),L=HU.css(CSS_BACKGROUND_COLOR,_[t])}else{L=HU.css(CSS_BACKGROUND_COLOR,"#eee");let e=HU.tag(TAG_SVG,[ATTR_XMLNS,NAMESPACE_SVG,ATTR_WIDTH,10,ATTR_HEIGHT,10],HU.tag(TAG_RECT,[ATTR_WIDTH,10,ATTR_HEIGHT,10,ATTR_FILL,COLOR_WHITE],HU.tag(TAG_PATH,["d","M-1,1 l2,-2 M0,10 l10,-10 M9,11 l2,-2",ATTR_STROKE,"#ddd",ATTR_STROKE_WIDTH,1])));L=HU.css(CSS_BACKGROUND_IMAGE,"url('data:image/svg+xml;base64,"+btoa(e)+"')",CSS_BACKGROUND_REPEAT,"repeat")}let U=r.toFixed(3),C=U;n.push(U),t==l&&(C=SPACE),u&&!h||(C=SPACE);let E=ALIGN_RIGHT,H=this.getCellLabel(s,d);H&&(C=HU.span([ATTR_CLASS,"display-correlation-celllabel"],H),E=ALIGN_LEFT);let P="";D&&(P=HU.div([ATTR_CLASS,"display-correlation-element",ATTR_TITLE,"&rho;("+o+","+g+") = "+U],C)),a+=HU.td([p,d.getId(),c,s.getId(),ATTR_CLASS,"display-correlation-cell",ATTR_ALIGN,E,ATTR_STYLE,L],P)}a+=HU.close(TAG_TR)}a+=HU.tr([],HU.td([])+HU.td([ATTR_COLSPAN,l+1],HU.div([ATTR_ID,this.domId(g)],""))),a+=HU.close(TAG_TABLE),this.jq(d).html(a);let b,R,D=this;this.jq(d).find(TAG_TD).click((function(e){let t=D.getFieldById(null,$(this).attr(c)),i=D.getFieldById(null,$(this).attr(p));if(e.shiftKey&&D.canEdit()){let e=prompt("Label:",D.getCellLabel(t,i));if(e){let s="label."+t.getId()+"."+i.getId()+'="'+e+'"';console.log("Copied to clipboard:"),console.log(s),Utils.copyToClipboard(s)}}let s=D.jq(d).find(TAG_TD);t&&(s.removeClass("display-correlation-row-cell-highlight"),t!=b?(b=t,D.jq(d).find(".display-correlation-cell[rowfield='"+t.getId()+"']").addClass("display-correlation-row-cell-highlight")):b=null),i&&(s.removeClass("display-correlation-col-cell-highlight"),i!=R?(R=i,D.jq(d).find(".display-correlation-cell[colfield='"+i.getId()+"']").addClass("display-correlation-col-cell-highlight")):R=null)})),this.displayColorTable(_,g,colorByMin,colorByMax)}})}function RamaddaRecordsDisplay(e,t,i,s){const l=new RamaddaFieldsDisplay(e,t,DISPLAY_RECORDS,i);let a=[{label:"Records"},{p:"maxHeight",ex:HU.px(400)},{p:"showCards",ex:"true",d:!0}];defineDisplay(addRamaddaDisplay(this),l,a,{needsData:function(){return!0},handleEventPointDataLoaded:function(e,t){this.needsData()||null==this.dataCollection&&(this.dataCollection=e.dataCollection,this.updateUI())},getFieldsToSelect:function(e){return e.getRecordFields()},defaultSelectedToAll:function(){return!0},fieldSelectionChanged:function(){l.fieldSelectionChanged.call(this),this.updateUI()},updateUI:function(e){l.updateUI.call(this,e);let t=this.filterData();if(!t)return void this.setDisplayMessage(this.getLoadingMessage());this.records=t;let i=this,s=this.getSelectedFields(this.getData().getRecordFields()),a="",r=this.getShowCards();r&&(a+=HU.open(TAG_DIV,[ATTR_CLASS,"display-records-grid"]));for(let e=0;e<t.length;e++){let i="",l=this.getDataValues(t[e]);for(let e=0;e<s.length;e++){let t=s[e],a=l[t.getIndex()];a.getTime&&(a=this.formatDate(a)),i+=HU.boldLabel(this.getFieldLabel(t))+a+HU.br()+"\n"}let o=HU.div([ATTR_CLASS,r?"":"display-records-record",ATTR_RECORD_INDEX,e,ATTR_RECORD_ID,t[e].getId()],i);r&&(o=HU.div([ATTR_CLASS,"display-records-grid-box"],o)),a+=o}r&&(a+=HU.close(TAG_DIV));let o=this.getProperty("maxHeight",HU.px(400));o.endsWith("px")||(o=HU.px(o)),this.setContents(HU.div([ATTR_STYLE,HU.css(CSS_MAX_HEIGHT,o,CSS_OVERFLOW_Y,OVERFLOW_AUTO)],a)),this.find(".display-records-record").click((function(){let e=i.records[$(this).attr(ATTR_RECORD_INDEX)];e&&i.propagateEventRecordSelection({highlight:!0,record:e})}))},handleEventRecordSelection:function(e,t){}})}function RamaddaStatsDisplay(e,t,i,s){const l=new RamaddaFieldsDisplay(e,t,s||DISPLAY_STATS,i);s||addRamaddaDisplay(this);defineDisplay(this,l,[{label:"Summary Statistics"},{p:"showDefault",ex:"false"},{p:"showMin",ex:"false",canCache:!0},{p:"showMax",ex:"false",canCache:!0},{p:"showRange",d:!1,ex:"true",canCache:!0},{p:"showAverage",ex:"false",canCache:!0},{p:"showStd",ex:"false",canCache:!0},{p:"showPercentile",ex:"false",canCache:!0},{p:"showCount",ex:"false",canCache:!0},{p:"showTotal",ex:"false",canCache:!0},{p:"showPercentile",ex:"false",canCache:!0},{p:"showMissing",ex:"false",canCache:!0},{p:"showUnique",ex:"false",canCache:!0},{p:"showType",ex:"false",canCache:!0},{p:"showText",ex:"false",canCache:!0},{p:"showFieldType",d:!0},{p:"showTableHeader",d:!0},{p:"sortStatsBy",ex:"min|max|total|average"},{p:"sortStatsAscending",ex:"false"},{p:"doValueSelection",ex:"false"},{p:"fieldHeaderLabel",ex:""},{p:"statsTableWidth",ex:"100%"}],{"map-display":!1,needsData:function(){return!0},handleEventPointDataLoaded:function(e,t){this.needsData()||null==this.dataCollection&&(this.dataCollection=e.dataCollection,this.updateUI())},getDefaultSelectedFields:function(e,t){if(null!=t&&t.length>0)return t;let i=[];return e.forEach((e=>{(this.getShowText()||e.isNumeric())&&(e.isFieldGeo()||i.push(e))})),i},getFieldsToSelect:function(e){return e.getRecordFields()},defaultSelectedToAll:function(){return!0},fieldSelectionChanged:function(){l.fieldSelectionChanged.call(this),this.updateUI()},updateUI:function(e){l.updateUI.call(this,e);let t=this.filterData();if(!t)return;let i=this.getSelectedFields([]),s=[];i.forEach(((e,t)=>{s.push({field:e,isNumber:!1,count:0,min:NaN,uniqueMap:{},unique:0,std:0,max:NaN,total:0,numMissing:0,numNotMissing:0,type:e.getType(),values:[]})})),t.forEach((e=>{s.forEach((t=>{let i=t.field,s=i.getValue(e);if(s&&(Utils.isDefined(t.uniqueMap[s])?t.uniqueMap[s]++:(t.uniqueMap[s]=1,t.unique++)),t.isNumber=i.isNumeric(),t.count++,null==s||isNaN(s)?t.numMissing++:t.numNotMissing++,!isNaN(s)&&null!==s&&"number"==typeof s){let e=this.getFieldLabel(i).toLowerCase();if(e.indexOf("latitude")>=0||e.indexOf("longitude")>=0)return;t.total+=s,t.max=Utils.max(t.max,s),t.min=Utils.min(t.min,s),t.values.push(s)}}))}));let a=this.getProperty("showDefault",!0);this.getShowUnique(a)&&s.forEach((e=>{e.field;e.uniqueMax=0,e.uniqueValue="";for(let t in e.uniqueMap){let i=e.uniqueMap[t];i>e.uniqueMax&&(e.uniqueMax=i,e.uniqueValue=t)}})),this.getShowStd(a)&&s.forEach((e=>{let t=e.values;if(t.length>0){let i=e.total/t.length,s=0;for(let e=0;e<t.length;e++){let l=t[e]-i;s+=l*l}let l=s/t.length;e.std=Math.sqrt(l)}}));let r=[ATTR_ID,this.getDomId("statstable"),ATTR_CLASS,HU.classes(CLASS_TABLE_ROWBORDER,CLASS_TABLE_STRIPE,"display-stats")],o=this.getStatsTableWidth();o&&(r.push(ATTR_WIDTH),r.push(o));let n=this.getShowTableHeader(),h=HU.open(TAG_TABLE,r);h+=HU.open(TAG_THEAD),header=[this.getFieldHeaderLabel("")],this.getShowCount(a)&&header.push("Count"),this.getShowMin(a)&&header.push("Min"),this.getShowPercentile(a)&&header.push("25%","50%","75%"),this.getShowMax(a)&&header.push("Max"),this.getShowRange()&&header.push("Range"),this.getShowTotal(a)&&header.push("Total"),this.getShowAverage(a)&&header.push("Average"),this.getShowStd(a)&&header.push("Std"),this.getShowUnique(a)&&header.push("# Unique","Top","Freq."),this.getShowMissing(a)&&header.push("Not&nbsp;Missing","Missing"),n&&(h+=HU.tr([ATTR_VALIGN,ALIGN_BOTTOM],HU.ths([ATTR_CLASS,"display-stats-header",ATTR_ALIGN,ALIGN_CENTER],header))),h+=HU.close(TAG_THEAD),h+=HU.open(TAG_TBODY);let d=this.getDoValueSelection(!1);s.forEach((e=>{e.average=0==e.numNotMissing?NaN:e.total/e.numNotMissing}));let g=this.getSortStatsBy(),p=this.getSortStatsAscending(!0);if(g){let e=(e,t)=>{let i=0;return"total"==g?i=e.total-t.total:"min"==g?i=e.min-t.min:"max"==g?i=e.max-t.max:"average"==g&&(i=e.average-t.average),0==i||p?i:-i};s.sort(e)}if(s.forEach((e=>{let t=e.field,i="",s=SPACE,l=this.getFieldLabel(t).toLowerCase(),r=0==e.numNotMissing?"NA":this.formatNumber(e.total/e.numNotMissing);l.indexOf("%")<0&&l.indexOf("percent")<0&&l.indexOf("median")<0&&(s=this.formatNumber(e.total));let o=[],g=(e,t)=>{t&&!n&&(e=HU.b(t)+": "+e),o.push(HU.div([ATTR_STYLE,"white-space:nowrap;"],e))};if(!e.isNumber&&this.getShowText(a))this.getShowCount(a)&&g(e.count,"Count"),this.getShowMin(a)&&o.push("-"),this.getShowPercentile(a)&&o.push("-","-","-"),this.getShowMax(a)&&o.push("-"),this.getShowRange()&&o.push("-"),o.push("-"),this.getShowAverage(a)&&o.push("-"),this.getShowStd(a)&&o.push("-"),this.getShowUnique(a)&&o.push(e.unique,e.uniqueValue,e.uniqueMax),this.getShowMissing(a)&&o.push(e.numNotMissing,e.numMissing);else{if(this.getShowCount(a)&&g(e.count,"Count"),this.getShowMin(a)&&g(this.formatNumber(e.min),"Min"),this.getShowPercentile(a)){let t=e.max-e.min,i=i=>{let s=this.formatNumber(e.min+t*i);d&&(s=HU.span([ATTR_CLASS,"display-stats-value",ATTR_DATA_TYPE,"percentile",ATTR_DATA_VALUE,i],s)),g(s,"Percentile "+i)};[.25,.5,.75].map((e=>i(e)))}this.getShowMax(a)&&g(this.formatNumber(e.max),"Max"),this.getShowRange()&&g(this.formatNumber(e.max-e.min),"Range"),this.getShowTotal(a)&&g(s,"Total"),this.getShowAverage(a)&&g(r,"Average"),this.getShowStd(a)&&g(this.formatNumber(e.std),"Std. Dev."),this.getShowUnique(a)&&(g(e.unique,"Unique"),Utils.isNumber(e.uniqueValue)?g(this.formatNumber(e.uniqueValue),"Unique"):g(e.uniqueValue,"Unique"),g(e.uniqueMax,"Unique max")),this.getShowMissing(a)&&(g(e.numNotMissing,"Not missing"),g(e.numMissing,"Missing"))}i=HU.tds([ATTR_ALIGN,ALIGN_RIGHT],o);let p=ALIGN_LEFT,c=this.getFieldLabel(t),u=c.split("!!"),T="";T+=t.getId(),t.description&&""!=t.description&&(T+="\n"+t.description+"\n"),c=u[u.length-1],Utils.stringDefined(t.unit)&&(c=c+" ["+t.unit+"]"),c=c.replace(/ /g,SPACE);let f=t.getTypeLabel()+SPACE;this.getShowFieldType()||(f=""),n||(c+=":");let y=HU.tr([ATTR_VALIGN,ALIGN_TOP],HU.td([ATTR_NOWRAP,"true",ATTR_ALIGN,p],f+HU.b(HU.span([ATTR_TITLE,T],c)))+i);h+=y})),h+=HU.close(TAG_TBODY,TAG_TABLE),this.setContents(h),n&&HU.formatTable("#"+this.getDomId("statstable"),{ordering:!0,aaSorting:[]}),this.initTooltip(),d){let e=this.find(".display-stats-value");e.each((function(){let e=$(this).attr(ATTR_DATA_TYPE),t=$(this).attr(ATTR_DATA_VALUE),i=SPACE+HU.getIconImage("fa-less-than",[ATTR_TITLE,"Filter other displays",ATTR_CLASS,"display-stats-value-link",ATTR_DATA_TYPE,e,ATTR_DATA_VALUE,t],[ATTR_STYLE,HU.css(CSS_FONT_SIZE,HU.pt(8))]);$(this).append(i)})),e=this.find(".display-stats-value-link"),e.each((function(){}))}}})}function RamaddaCooccurenceDisplay(e,t,i){const s="table",l="sortby",a=new RamaddaDisplay(e,t,DISPLAY_COOCCURENCE,i);let r=[{label:"Cooccurence"},{p:"sourceField",ex:""},{p:"targetField",ex:""},{p:"colorBy",ex:""},{p:"directed",ex:"false"},{p:"missingBackground",ex:"#eee"},{p:"showSortBy",ex:"false"},{p:"sortBy",ex:"weight"},{p:"minWeight",ex:""},{p:"topSpace",ex:HU.px(50)}];defineDisplay(addRamaddaDisplay(this),a,r,{needsData:function(){return!0},getHeader2:function(){let e=a.getHeader2.call(this);if(this.getFieldById(null,this.getProperty("colorBy","weight"))&&this.getProperty("showSortBy",!0)){let t=[["name","Name"],["weight","Weight"]];e+=HU.div([ATTR_STYLE,HU.css(CSS_DISPLAY,DISPLAY_INLINE_BLOCK)],"Sort by: "+HU.select("",[ATTR_ID,this.domId(l)],t,this.getProperty("sortBy","")))+SPACE2}return e},initHeader2:function(){let e=this;this.jq(l).change((function(){e.setProperty("sortBy",$(this).val()),e.updateUI()}))},updateUI:function(){let e=this.filterData();if(!e)return;let t=HU.div([ATTR_ID,this.domId("coocheader")])+HU.div([ATTR_ID,this.domId(s)]);this.setContents(t);let i=this.getFieldById(null,this.getProperty("sourceField","source")),l=this.getFieldById(null,this.getProperty("targetField","target")),a=this.getFieldById(null,this.getProperty("colorBy","weight"));if(null==i||null==l)return void this.setDisplayMessage("No source/target fields specified");let r=this.getColorTable();r||(r=Utils.getColorTable("blues",!0));let o=this.getColorByInfo(e,null,null,r),n=[],h=[],d={},g=0,p=this.getProperty("sortBy","name"),c=this.getProperty("directed",!0),u=-999999;e.map((e=>{let t=e.getValue(i.getIndex()),s=e.getValue(l.getIndex()),r=u;a&&(r=e.getValue(a.getIndex()),g=Math.max(g,r)),n.push({name:t,weight:r}),h.push({name:s,weight:r}),c||(n.push({name:s,weight:r}),h.push({name:t,weight:r})),d[t+"--"+s]=r})),g=this.getProperty("maxWeight",g);let T=(e,t)=>"name"==p||""==p?e.name.localeCompare(t.name):t.weight-e.weight;n.sort(T),h.sort(T);let f=this.getProperty("minWeight",u),y={},m=[],_=e=>{f!=u&&(e.weight==u||e.weight<f)||y[e.name]||(y[e.name]=!0,m.push(e.name))};n.map(_),n=m,y={},m=[],h.map(_),h=m;let S=HU.div([ATTR_STYLE,HU.css(CSS_MARGIN_TOP,this.getProperty("topSpace",HU.px(100)))])+HU.open(TAG_TABLE,[ATTR_STYLE,HU.css(CSS_HEIGHT,"100%"),ATTR_CLASS,"display-cooc-table","order",0]);S+=HU.open(TAG_TR,[ATTR_VALIGN,ALIGN_BOTTOM])+HU.td([ATTR_BORDER,"none"]),h.map((e=>{e=e.replace(/ /g,SPACE).replace(/-/g,SPACE),S+=HU.td([ATTR_STYLE,HU.css(CSS_BORDER,"none"),ATTR_WIDTH,6],HU.div([ATTR_CLASS,"display-cooc-colheader"],e))}));let A=this.getProperty("missingBackground","#eee");n.map((e=>{let t=e.replace(/ /g,SPACE);S+=HU.open(TAG_TR,[ATTR_VALIGN,ALIGN_BOTTOM])+HU.td([ATTR_STYLE,HU.css(CSS_BORDER,"none"),ATTR_ALIGN,ALIGN_RIGHT],HU.div([ATTR_CLASS,"display-cooc-rowheader"],t)),h.map((t=>{let i=d[e+"--"+t];c||Utils.isDefined(i)||(i=d[t+"--"+e]);let s="";i?i==u||0==g?s=HU.css(CSS_BACKGROUND,COLOR_LIGHT_GRAY):o.index>=0&&(color=o.getColor(i),s=HU.css(CSS_BACKGROUND,color)):s=HU.css(CSS_BACKGROUND,A),S+=HU.td([ATTR_TITLE,e+" -> "+t+(i>0?" "+i:""),ATTR_WIDTH,3],HU.div([ATTR_CLASS,"display-cooc-cell",ATTR_STYLE,s+HU.css(CSS_HEIGHT,HU.perc(100))],SPACE))})),S+=HU.close(TAG_TR)})),S+=HU.close(TAG_TR,TAG_TABLE),S+=HU.div([ATTR_STYLE,HU.css(CSS_MARGIN,HU.px(5))]),this.jq(s).html(S),o.displayColorTable()}})}function RamaddaBoxtableDisplay(e,t,i){const s=new RamaddaDisplay(e,t,DISPLAY_BOXTABLE,i);let l=[{label:"Color Boxes"},{p:"categoryField",ex:""},{p:"colorBy",ex:""},{p:"tableWidth",ex:"300"},{p:"labelTemplate"},{p:"labelStyle"},{p:"imageField"},{p:"imageWidth",d:HU.px(30)},{p:"labelColumnWidth",ex:HU.px(300)}];defineDisplay(addRamaddaDisplay(this),s,l,{needsData:function(){return!0},updateUI:function(){let e=this.filterData();if(!e)return;let t=this.getFieldById(null,this.getProperty("categoryField","category"));if(null==t)return void this.setDisplayMessage("No category field field specified");let i=this.getImageWidth(HU.px(30)),s=this.getFieldById(null,this.getImageField()),l=this.getLabelTemplate(),a=this.getLabelStyle(""),r=this.getColorTable();r||(r=Utils.getColorTable("blues",!0));let o=this.getColorByInfo(e,null,null,r),n={},h=[];e.forEach((e=>{let i=e.getValue(t.getIndex()),s=o.index>=0?e.getValue(o.index):0,l=n[i]&&n[i].list;l||(l=[],n[i]={list:l,max:0},h.push(i)),n[i].max=Math.max(n[i].max,s),l.push(e)}));let d=HU.open(TAG_TABLE,[ATTR_CLASS,"display-colorboxes-table",ATTR_CELLPADDING,5]),g=this.getLabelColumnWidth();this.getProperty("tableWidth",300);h.sort(((e,t)=>n[t].max-n[e].max)),h.forEach((e=>{let r=n[e].list.length,h=HU.span([ATTR_FIELD_ID,t.getId(),ATTR_FIELD_VALUE,e],e),p=[ATTR_ALIGN,ALIGN_RIGHT,ATTR_CLASS,"display-colorboxes-header"];g&&p.push(ATTR_WIDTH,g);let c=HU.open(TAG_TR,[ATTR_VALIGN,ALIGN_CENTER],HU.td(p,h+" ("+r+")"));c+=HU.open(TAG_TD),o.index&&n[e].list.sort(((e,t)=>t.getData()[o.index]-e.getData()[o.index])),n[e].list.forEach(((e,t)=>{let r=COLOR_LIGHT_GRAY;o.index&&(r=o.getColor(e.getData()[o.index],e)||r);let n="",h="",d="";if(s){let t=s.getValue(e);h=HU.div([ATTR_STYLE,HU.css(CSS_TEXT_ALIGN,ALIGN_CENTER)],HU.image(t,[ATTR_WIDTH,i])),d="display-colorboxes-image"}else n=HU.css(CSS_BACKGROUND,r),d="display-colorboxes-box";if(l){let t=this.applyRecordTemplate(e,null,null,l);h+=HU.div([ATTR_CLASS,"display-colorboxes-label",ATTR_STYLE,a],t)}c+=HU.div([ATTR_TITLE,"",ATTR_RECORD_ID,e.getId(),ATTR_CLASS,HU.classes(CLASS_CLICKABLE,d),ATTR_STYLE,n],h)})),c+=HU.close(TAG_TD,TAG_TR),d+=c})),d+=HU.close(TAG_TABLE),this.displayHtml(d),o.displayColorTable(500),this.getProperty("tooltip")||this.setProperty("tooltip","${default}"),this.makeTooltips(this.find(".display-colorboxes-box,.display-colorboxes-image"),e),this.addFieldClickHandler(null,e)}})}function RamaddaPercentchangeDisplay(e,t,i){const s=new RamaddaFieldsDisplay(e,t,DISPLAY_PERCENTCHANGE,i);defineDisplay(addRamaddaDisplay(this),s,[{label:"Percent Change"},{p:"template",ex:"${date1} ${date2} ${value1} ${value2} ${percent} ${per_hour} ${per_day} ${per_week} ${per_month} ${per_year}"},{p:"fieldLabel",ex:""},{p:"sortFields",ex:"false"},{p:"highlightPercent",ex:"50"},{p:"highlightPercentPositive",ex:"50"},{p:"highlightPercentNegative",ex:"-50"},{p:"highlightColor",ex:""},{p:"highlightColorPositive",ex:""},{p:"highlightColorNegative",ex:""}],{updateUI:function(){let e=this.filterData();if(!e)return;let t=this.getData().getRecordFields(),i=this.getSelectedFields(t);i=this.getFieldsByType(i,"numeric");let s=e[0],l=e[e.length-1],a=this.getProperty("template",null),r=this.getProperty("headerTemplate",""),o=this.getProperty("footerTemplate",""),n=s.getDate(),h=l.getDate(),d="Start Value",g="End Value",p=1,c=1,u=1,T=1;if(n&&(d=this.formatDate(n)),h&&(g=this.formatDate(h)),n&&h){let e=h.getTime()-n.getTime();c=e/1e3/60/60/24,p=24*c,u=c/365,T=12*u}let f="";a?f=r:(f+=HU.open(TAG_TABLE,[ATTR_CLASS,HU.classes(CLASS_TABLE,CLASS_TABLE_STRIPE,CLASS_TABLE_NOWRAP),ATTR_ID,this.domId("percentchange")]),f+=HU.open(TAG_THEAD,[]),f+=HU.tr([],HU.th([ATTR_STYLE,HU.css(CSS_TEXT_ALIGN,ALIGN_CENTER)],this.getProperty("fieldLabel","Field"))+HU.th([ATTR_STYLE,HU.css(CSS_TEXT_ALIGN,ALIGN_CENTER)],d)+HU.th([ATTR_STYLE,HU.css(CSS_TEXT_ALIGN,ALIGN_CENTER)],g)+HU.th([ATTR_STYLE,HU.css(CSS_TEXT_ALIGN,ALIGN_CENTER)],"Percent Change")),f+=HU.close(TAG_THEAD),f+=HU.open(TAG_TBODY,[]));let y=[];i.map((t=>{let i=0;for(let s=0;s<e.length;s++){let l=e[s].getValue(t.getIndex());if(!isNaN(l)){i=l;break}}let s=0;for(let i=e.length-1;i>=0;i--){let l=e[i].getValue(t.getIndex());if(!isNaN(l)){s=l;break}}let l=parseInt(1e3*(s-i)/i)/10;y.push({field:t,val1:i,val2:s,percent:l})})),this.getProperty("sortFields",!0)&&y.sort(((e,t)=>-(e.percent-t.percent)));let m=this.getProperty("highlightPercent",NaN),_=this.getProperty("highlightPercentPositive",m),S=this.getProperty("highlightPercentNegative",-m),A=this.getProperty("highlightColor",COLOR_LIGHT_GRAY),I=this.getProperty("highlightColorPositive",A),b=this.getProperty("highlightColorNegative",A);y.map((e=>{if(a){let t=a.replace("${field}",this.getFieldLabel(e.field)).replace("${value1}",this.formatNumber(e.val1)).replace("${value2}",this.formatNumber(e.val2)).replace("${percent}",this.formatNumber(e.percent)).replace("${date1}",d).replace("${date2}",g).replace("${difference}",this.formatNumber(e.val2-e.val1));t=t.replace(/\${per_hour}/g,this.formatNumber(e.percent/p)),t=t.replace(/\${per_day}/g,this.formatNumber(e.percent/c)),t=t.replace(/\${per_week}/g,this.formatNumber(e.percent/(c/7))),t=t.replace(/\${per_month}/g,this.formatNumber(e.percent/T)),t=t.replace(/\${per_year}/g,this.formatNumber(e.percent/u)),f+=t}else{let t="";isNaN(_)||e.percent>_&&(t+=HU.css(CSS_BACKGROUND,I)),isNaN(S)||e.percent<S&&(t+=HU.css(CSS_BACKGROUND,b)),f+=HU.tr([ATTR_STYLE,t],HU.td([],this.getFieldLabel(e.field))+HU.td([ATTR_ALIGN,ALIGN_RIGHT],this.formatNumber(e.val1))+HU.td([ATTR_ALIGN,ALIGN_RIGHT],this.formatNumber(e.val2))+HU.td([ATTR_ALIGN,ALIGN_RIGHT],HU.perc(e.percent)))}})),a?f+=o:(f+=HU.close(TAG_TBODY),f+=HU.close(TAG_TABLE)),this.setContents(f),HU.formatTable("#"+this.domId("percentchange"),{ordering:!1})}})}function RamaddaDatatableDisplay(e,t,i){const s=new RamaddaDisplay(e,t,DISPLAY_DATATABLE,i),l="datatable_colortable",r="datatable_piecolors";defineDisplay(addRamaddaDisplay(this),s,[{label:"Data Table"},{p:"columnSelector",ex:"date_day|date_hour|date_dow|date_month|date_year"},{p:"selectors",ex:"date_day,date_hour,date_dow,date_month,date_year,date_fieldid"},{p:"columnSelector",ex:"date_day|date_hour|date_dow|date_month"},{p:"rowSelector",ex:"date_day|date_hour|date_dow|date_month"},{p:"checkedIcon",ex:"fa-checked"},{p:"checkedTooltipHeader",ex:"${numberChecked}"},{p:"dataCheckers",ex:"match|notmatch|lessthan|greaterthan|equals|notequals(field=field,value=value,label=label,enabled=false) "},{p:"showColumnSelector",ex:"false"},{p:"showRowSelector",ex:"false"},{p:"showValues",ex:"false"},{p:"showColors",ex:"true",d:!1},{p:"showPieColors",ex:"true",d:!1},{p:"showRowTotals",ex:"false"},{p:"showColumnTotals",ex:"false"},{p:"slantHeader",ex:"true"}],{needsData:function(){return!0},updateUI:function(){this.setDisplayMessage(this.getLoadingMessage());let e=this.filterData();if(!e)return;let t=this.getColorTable(!0);t||(t=Utils.ColorTables.cats.colors);let i,s=this.getTheDataFilters(this.getProperty("dataCheckers")),o={},n=this.getFieldsByIds(null,this.getProperty("countFields")),h={};if(this.getProperty("selectors")){i=[];let e={date_day:"Day",date_dow:"Day of Week",date_hour:"Hour",date_month:"Month",date_year:"Year"};this.getProperty("selectors").split(",").map((t=>{let s=e[t];if(!s){let e=this.getFieldById(null,t);e&&(s=this.getFieldLabel(e),h[t]=e)}s&&i.push([t,s])}))}else i=[["date_day","Day"],["date_dow","Day of Week"],["date_hour","Hour"],["date_month","Month"],["date_year","Year"]];let d=this.getProperty("columnSelector",i[0][0]),g=this.getProperty("rowSelector",i[1][0]),p=t=>{let i=[];if("date_dow"==t)Utils.dayNamesShortShort.map(((e,t)=>{i.push({id:t,label:e})}));else if("date_hour"==t){let e=["12&nbsp;AM","1","2","3","4","5","6","7","8","9","10","11","12&nbsp;PM","1","2","3","4","5","6","7","8","9","10","11"];for(let t=0;t<24;t++)i.push({id:t,label:e[t]})}else if("date_day"==t)for(let e=1;e<=31;e++)i.push({id:e,label:String(e)});else if("date_month"==t)Utils.monthNames.map(((e,t)=>{i.push({id:t,label:e})}));else if("date_year"==t){let t=[],s={};e.map((e=>{let i=e.getDate().getUTCFullYear();s[i]||(t.push(i),s[i]=!0)})),t.sort(),t.map(((e,t)=>{i.push({id:e,label:String(e)})}))}else{let s=h[t];if(s){let t={},l=!1;this.getColumnValues(e,s).values.map((e=>{l=Utils.isNumber(e),Utils.isDefined(t[e])||(t[e]=!0,i.push({id:e,label:String(e)}))})),i.sort(((e,t)=>l?e.id-t.id:e.label.localeCompare(t.label)))}}return i},c=p(d),u=p(g),T=(e,t,i)=>{if("date_dow"==e)return i[t.getDate().getDay()].id;if("date_hour"==e)return i[t.getDate().getUTCHours()].id;if("date_day"==e)return i[t.getDate().getUTCDate()-1].id;if("date_month"==e)return i[t.getDate().getUTCMonth()].id;if("date_year"==e)return t.getDate().getUTCFullYear();{let i=h[e];if(i)return t.getValue(i.getIndex())}return"null"},f={};e.map(((e,t)=>{let i=T(g,e,u),l=T(d,e,c),a=i+"-"+l,r=o[a];r||(r=o[a]={checked:[],row:i,column:l,count:0,records:[],countFields:{}},n.forEach((e=>{r.countFields[e.getId()]={values:[],counts:{}}}))),s&&s.length>0&&this.checkDataFilters(s,e)&&r.checked.push(e),n.forEach((t=>{let i=e.getValue(t.getIndex()),s=r.countFields[t.getId()];s.counts[i]||(s.counts[i]=0,f[i]=!0,s.values.push(i)),s.counts[i]++})),r.count++,r.records.push(e)}));let y=0,m=0,_=0;for(a in o){let e=o[a];y=0==_?e.count:Math.min(e.count,y),m=0==_?e.count:Math.max(e.count,m),_++,n.forEach((t=>{let i=e.countFields[t.getId()];i.values.sort(),i.values.forEach((e=>{}))}))}let S=this.getProperty("showValues",!0),A=this.getShowColors(),I=this.getShowPieColors(),b=c.length,R=0,D=0,L={},U={};u.map((e=>{let t=0;c.map((i=>{let s=e.id+"-"+i.id;o[s]&&(t+=o[s].count)})),U[e.id]=t,R=Math.max(R,t)})),c.map((e=>{let t=0;u.map((i=>{let s=i.id+"-"+e.id;o[s]&&(t+=o[s].count)})),L[e.id]=t,D=Math.max(D,t)}));let C=this.getProperty("showRowTotals",!0),E=this.getProperty("showColumnTotals",!0),H=Math.round(100/b),P="";P+=HU.open(TAG_TR,[ATTR_VALIGN,ALIGN_BOTTOM])+HU.td([],"");let x=this.getProperty("slantHeader",!1),v=0;c.map((e=>{let t=e.label;t.length>15&&(x=!0,v=Math.max(v,Math.round(3*t.length)),v=80)})),c.map((e=>{let t=e.label;x&&(t.length>20&&(t=t.substring(0,20)+"..."),t=t.replace(/ /g,SPACE).replace("-",SPACE),t=HU.div([ATTR_TITLE,e.label,ATTR_CLASS,"display-datatable-header-slant"],t)),P+=HU.td([ATTR_CLASS,"display-datatable-header",ATTR_ALIGN,ALIGN_CENTER],t)})),P+=HU.close(TAG_TR),u.map((e=>{let i=HU.div([],e.label.replace(/ /g,SPACE));if(P+=HU.open(TAG_TR)+HU.td([ATTR_CLASS,"display-datatable-name",ATTR_ALIGN,ALIGN_RIGHT,ATTR_WIDTH,100],i),c.map((i=>{let s=e.id+"-"+i.id,l="",a="",r=o[s],n="",h="";if(r&&(S&&(l=HU.div([ATTR_CLASS,"display-datatable-value"],r.count)),h=HU.div(["data-key",s,ATTR_CLASS,"display-datatable-counts"]),r.checked.length&&(n=HU.getIconImage(this.getProperty("checkedIcon","fa-check"),[ATTR_TITLE,"","data-key",s,ATTR_CLASS,"display-datatable-checked"])),A)){let e=(r.count-y)/(m-y),i=parseInt(e*t.length);i>=t.length?i=t.length-1:i<0&&(i=0),a=HU.css(CSS_BACKGROUND_COLOR,t[i])}let d=n+h+l;P+=HU.td([ATTR_CLASS,"display-datatable-cell",ATTR_ALIGN,ALIGN_RIGHT,ATTR_STYLE,a,ATTR_WIDTH,HU.perc(H)],d)})),C){let t=U[e.id],i=Math.round(t/R*100),s=HU.div([ATTR_CLASS,"display-datatable-summary-row",ATTR_STYLE,HU.css(CSS_WIDTH,HU.px(i))],t);P+=HU.td([ATTR_WIDTH,100,ATTR_VALIGN,ALIGN_TOP],s)}P+=HU.close(TAG_TR)})),E&&(P+=HU.open(TAG_TR,[ATTR_VALIGN,ALIGN_TOP])+HU.td(),c.map((e=>{let t=L[e.id],i=Math.round(t/D*100),s=HU.div([ATTR_CLASS,"display-datatable-summary-column",ATTR_STYLE,HU.css(CSS_HEIGHT,HU.px(i))],t);P+=HU.td([],s)}))),P+=HU.close(TAG_TR),P+=HU.open(TAG_TR,[],HU.td()),P+=HU.td([ATTR_COLSPAN,b,ATTR_CLASS,"display-datatable-footer",ATTR_ALIGN,ALIGN_CENTER,ATTR_ID,this.domId(l)]),P+=HU.close(TAG_TD),P+=HU.open(TAG_TR,[],HU.td()),P+=HU.td([ATTR_COLSPAN,b,ATTR_CLASS,"display-datatable-footer",ATTR_ALIGN,ALIGN_CENTER,ATTR_ID,this.domId(r)]),P+=HU.close(TAG_TR,TAG_TABLE),v>0&&(P=HU.div([ATTR_STYLE,HU.css(CSS_MARGIN_TOP,HU.px(v))],P));let O="",N=HU.open(TAG_TR);this.getProperty("showRowSelector",!0)&&(N+=HU.td([ATTR_CLASS,"display-datatable-selector",ATTR_ALIGN,ALIGN_CENTER],HU.select("",[ATTR_ID,this.domId("rowSelector")],i,g,15))),this.getProperty("showColumnSelector",!0)&&(N+=HU.td([ATTR_COLSPAN,c.length,ATTR_CLASS,"display-datatable-selector",ATTR_WIDTH,HU.perc(90),ATTR_ALIGN,ALIGN_CENTER],HU.select("",[ATTR_ID,this.domId("columnSelector")],i,d)));let w=HU.open(TAG_TABLE,[ATTR_STYLE,HU.css(CSS_FONT_SIZE,this.getProperty("fontSize","8pt")),ATTR_CLASS,"display-colorboxes-table",ATTR_CELLPADDING,0,ATTR_CELLSPACING,0,ATTR_WIDTH,"100%"]);w+=HU.tr([],N),w+=P,O+=w,this.setContents(O);let M=this;this.jq("rowSelector").change((function(){M.setProperty("rowSelector",$(this).val()),M.updateUI()})),this.jq("columnSelector").change((function(){M.setProperty("columnSelector",$(this).val()),M.updateUI()}));let F=this.getProperty("pieWidth",30),k={};Object.keys(f).forEach(((e,i)=>{k[e]=t[i%t.length]}));if(this.find(".display-datatable-counts").each((function(){let e=$(this).attr("data-key"),t=o[e];n.forEach(((e,i)=>{let s=HU.center(HU.b(M.getFieldLabel(e))),l=t.countFields[e.getId()],a=[];l.values.forEach((e=>{a.push([e,l.counts[e]]),s+=e+":"+l.counts[e]+SPACE+HU.br()}));let r=M.domId(t.row+"-"+t.column+"-"+e.getId());$(this).append(HU.div([ATTR_CLASS,"display-datatable-piechart",ATTR_ID,r,ATTR_TITLE,"",ATTR_STYLE,HU.css(ATTR_WIDTH,HU.px(F),ATTR_HEIGHT,HU.px(F))])),drawPieChart(M,"#"+r,F,F,a,null,null,null,{colorMap:k}),jqid(r).tooltip({content:function(){return s}})}))})),this.find(".display-datatable-checked").tooltip({content:function(){let e=$(this).attr("data-key"),t=o[e].checked;if(t.length){let e=M.getProperty("tooltip","${default}");if(""==e)return null;let i=M.getProperty("checkedTooltipHeader",HU.b("#Items: ${numberChecked}")+HU.close(TAG_BR));return i=i.replace("${numberChecked}",t.length),t.map((t=>{""!=i&&(i+=HU.open(TAG_DIV,[ATTR_CLASS,"ramadda-hline"])),i+=M.getRecordHtml(t,null,e)})),HU.div([ATTR_CLASS,"display-datatable-tooltip"],i)}return null}}),A&&this.displayColorTable(t,l,y,m,{}),I){let e=Object.keys(k).map((e=>({value:e,color:k[e]})));this.jq(r).html("pie colors"),this.displayColorTable(t,r,y,m,{stringValues:e})}}})}function RamaddaSparklineDisplay(e,t,i){const s="inner";i.groupBy||(i.displayInline=!0),Utils.isDefined(i.showDisplayTop)||(i.showDisplayTop=!1),Utils.isDefined(i.showDisplayBottom)||(i.showDisplayBottom=!1);const l=new RamaddaFieldsDisplay(e,t,DISPLAY_SPARKLINE,i);let a=[...RamaddaDisplayUtils.sparklineProps];defineDisplay(addRamaddaDisplay(this),l,a,{getLoadingMessage:function(e){return"Loading..."},updateUI:function(){let e=this.getPropertySparklineWidth(60),t=this.getPropertySparklineHeight(20),i=this.filteredRecords=this.filterData();if(!i)return;let l=this.getFieldById(null,this.getProperty("field"));if(null==l)return void this.setDisplayMessage("No field specified");new Date;let a=this.getPropertyShowDate(),r=this.domId(s),o=this.getColorByInfo(i),n=this.getFieldById(null,this.getProperty("groupBy")),h=n?RecordUtil.groupBy(i,this,null,n):null,d=this.getColumnValues(i,l),g=d.min,p=d.max;if(this.getProperty("useAllRecords")){let e=this.getColumnValues(this.getRecords(),l);g=e.min,p=e.max}if(h){let i=this.getProperty("labelPosition","bottom");html=HU.div([ATTR_ID,this.domId(s)]),this.setContents(html),h.values.forEach(((s,a)=>{let n=h.map[s],d=r+"_"+ +a,c=HU.div([ATTR_CLASS,"display-sparkline-sparkline",ATTR_ID,d,ATTR_STYLE,HU.css(CSS_WIDTH,HU.px(e),CSS_HEIGHT,HU.px(t))]),u=HU.div([ATTR_CLASS,"display-sparkline-header"],s);"top"==i?c=u+HU.tag(TAG_BR)+c:"bottom"==i&&(c=c+HU.tag(TAG_BR)+u),jqid(r).append(HU.div([ATTR_STYLE,HU.css(CSS_DISPLAY,DISPLAY_INLINE_BLOCK,CSS_MARGIN,HU.px(4))],c));let T=this.getColumnValues(n,l);drawSparkline(this,"#"+d,e,t,T.values,n,g,p,o)}))}else{html=HU.div([ATTR_CLASS,"display-sparkline-sparkline",ATTR_ID,this.domId(s),ATTR_STYLE,HU.css(CSS_WIDTH,HU.px(e),CSS_HEIGHT,HU.px(t))]),a&&(html=HU.div([ATTR_CLASS,"display-sparkline-date"],this.formatDate(i[0].getTime()))+html+HU.div([ATTR_CLASS,"display-sparkline-date"],this.formatDate(i[i.length-1].getTime())));let l=this.getProperty("showMin")?HU.div([ATTR_CLASS,"display-sparkline-value",ATTR_STYLE,this.getPropertyLabelStyle("")],this.formatNumber(d.values[0])):"",n=this.getProperty("showMax",!0)?HU.div([ATTR_CLASS,"display-sparkline-value",ATTR_STYLE,this.getPropertyLabelStyle("")],this.formatNumber(d.values[d.values.length-1])):"";""==l&&""==n||(html=HU.leftCenterRight(l,html,n,"1%","99%","1%",null,HU.css(CSS_PADDING,HU.px(2)))),this.setContents(html),drawSparkline(this,"#"+r,e,t,d.values,i,g,p,o)}new Date}})}function RamaddaPointimageDisplay(e,t,i){i.width||(i.width="200"),i.displayInline=!0;const s=new RamaddaFieldsDisplay(e,t,DISPLAY_POINTIMAGE,i);let l=[{label:"Point Image"},{p:"cellShape",ex:"rect|circle"},{p:"cellSize",ex:"4"},{p:"cellFilled",ex:"false"},{p:"cellColor",ex:"false"},{p:"doHeatmap",ex:"true"},{p:"padding",ex:"5"},{p:"borderColor",ex:COLOR_LIGHT_GRAY},{p:"showTooltips",ex:"false"},{p:"colorBy",ex:""}];defineDisplay(addRamaddaDisplay(this),s,l,{needsData:function(){return!0},getLoadingMessage:function(e){return"Loading..."},findClosest:function(e,t){let i=null;return e.map(((e,s)=>{let l=e[this.getId()+"_coordinates"],a=l.x-t.offsetX,r=l.y-t.offsetY,o=Math.sqrt(a*a+r*r);0==s?(i=e,minDistance=o):o<minDistance&&(minDistance=o,i=e)})),i},updateUI:function(){let e=this.filterData();if(!e)return;this.getProperty("borderColor")&&jqid(this.getProperty(PROP_DIVID)).css(CSS_BORDER,HU.border(1,this.getProperty("borderColor")));let t={};RecordUtil.getPoints(e,t);let i=(t.east-t.west)/(t.north-t.south),s=this.getProperty("padding")?HU.css(CSS_PADDING,HU.px(+this.getProperty("padding"))):"",l=HU.div([ATTR_ID,this.domId("inner"),ATTR_STYLE,s]);this.setContents(l);let a=Math.round(this.jq("inner").width()),r=Math.round(a/i);this.getProperty(PROP_DIVID);l=HU.div([ATTR_ID,this.domId("inner"),ATTR_STYLE,HU.css(CSS_WIDTH,a,CSS_HEIGHT,HU.px(r))+s]),l=HU.div([ATTR_ID,this.domId("inner")]),this.setContents(l);let o=this.getColorByInfo(e);t=RecordUtil.expandBounds(t,.1);let n=$.extend({colorBy:o,w:a,h:r,cell3D:this.getProperty("cell3D"),bounds:t},this.getDefaultGridByArgs());n.operator=this.getProperty("hm.operator",this.getProperty("hmOperator","max")),n.doHeatmap=!0;let h=this.getFields(),d=Gfx.gridData(this.getId(),h,e,n);this.jq("inner").html(HU.image(d,[ATTR_TITLE,"",ATTR_ID,this.domId("image")])),this.jq("inner").append(HU.div([ATTR_ID,this.domId("tooltip"),ATTR_STYLE,HU.css(CSS_Z_INDEX,"2000",CSS_DISPLAY,DISPLAY_NONE,CSS_POSITION,POSITION_ABSOLUTE,CSS_BACKGROUND,COLOR_WHITE,CSS_BORDER,HU.border(1,COLOR_LIGHT_GRAY),CSS_PADDING,HU.px(0))]));let g=this;this.getProperty("showTooltips",!0)&&(this.jq("image").mouseout((function(e){g.jq("tooltip").hide()})),this.jq("image").mousemove((function(t){let i=g.findClosest(e,t);if(i){let e=HU.div([ATTR_STYLE,HU.css(CSS_MAX_HEIGHT,HU.px(400),CSS_OVERFLOW_Y,OVERFLOW_AUTO)],g.getRecordHtml(i));g.jq("tooltip").html(e),g.jq("tooltip").show()}}))),this.jq("image").click((t=>{g.mouseEvent=event;let i=this.findClosest(e,t);i&&this.propagateEventRecordSelection({record:i})}))}})}function RamaddaCanvasDisplay(e,t,i){const s=new RamaddaFieldsDisplay(e,t,DISPLAY_CANVAS,i);let l=[{label:"Canvas"},{p:"canvasStyle",d:"",ex:"",tt:"Canvas CSS style"},{p:"titleTemplate",tt:"Template to show as title"},{p:"topTitleTemplate",tt:"Template to show as top title"},{p:"urlField",tt:"Url Field"},{p:"iconField",tt:"Icon Field"},{p:"highlightStyle",tt:"Highlight Style"},{p:"unHighlightStyle",tt:"Unhighlight Style"}];l.push(...RamaddaDisplayUtils.getCanvasProps()),defineDisplay(addRamaddaDisplay(this),s,l,{needsData:function(){return!0},updateUI:function(){let e=this.filterData(),t=this.getFields();if(!e)return;if(0==e.length)return void this.setDisplayMessage(this.getNoDataMessage());let i=this.getCanvasStyle(""),s=this.getHighlightStyle(""),l=this.getUnHighlightStyle(""),a=(this.getProperty("columns"),""),r=this.getPropertyCanvasWidth(),o=this.getPropertyCanvasHeight(),n=this.getPropertyTitleTemplate(),h=this.getPropertyTopTitleTemplate(),d=this.getFieldById(null,this.getPropertyUrlField()),g=this.getFieldById(null,this.getPropertyIconField()),p=this.getFilterHighlight();e.forEach(((e,t)=>{let c=e.isHighlight(this),u=this.domId("canvas_"+t),T="display-canvas-canvas",f=i;p&&(c?(T+=" display-canvas-canvas-highlight ",f+=" "+s):(T+=" display-canvas-canvas-unhighlight ",f+=" "+l));let y=HU.tag(TAG_CANVAS,[ATTR_CLASS,T,ATTR_STYLE,f,ATTR_WIDTH,r,ATTR_HEIGHT,o,ATTR_ID,u]),m=g?HU.image(e.getValue(g.getIndex()))+SPACE:"",_=h?HU.div([ATTR_CLASS,"display-canvas-title"],m+this.getRecordHtml(e,null,h)):m,S=n?HU.div([ATTR_CLASS,"display-canvas-title"],this.getRecordHtml(e,null,n)):"",A=HU.div([ATTR_TITLE,"",ATTR_CLASS,"display-canvas-block",ATTR_RECORD_INDEX,t,ATTR_RECORD_ID,e.getId()],_+y+S);if(d){let t=e.getValue(d.getIndex());Utils.stringDefined(t)&&(A=HU.href(t,A))}a+=A})),this.setContents(a);let c=RamaddaDisplayUtils.getGlyphs(this,t,e,r,o),u={},T="center"==this.getPropertyCanvasOrigin()?o/2:o;e.forEach(((e,t)=>{let i=this.domId("canvas_"+t),s=document.getElementById(i),l=s.getContext("2d");c.forEach((t=>{t.draw(u,s,l,0,T,{record:e})}))}));let f=this.find(".display-canvas-block");this.makeTooltips(f,e,null,"${default}"),this.getShowColorTable()&&c.every((e=>{let t=e.getColorByInfo();return t&&t.displayColorTable(),!0}))}})}function RamaddaFieldtableDisplay(e,t,i){const s="fieldtable",l=new RamaddaFieldsDisplay(e,t,DISPLAY_FIELDTABLE,i);let a=[{label:"Field Table"},{p:"field",ex:""},{p:"labelField",ex:"field"},{p:"columnWidth",ex:"150"},{p:"tableHeight",ex:"300"},{p:"markerShape",ex:"circle|rect|triangle|bar|arrow|dart|bar"},{p:"markerSize",ex:"16"},{p:"markerFill",ex:"#64CDCC"},{p:"markerStroke",ex:COLOR_BLACK}];defineDisplay(addRamaddaDisplay(this),l,a,{needsData:function(){return!0},updateUI:function(){let e=this.filterData();if(!e)return;let t=this.getFieldsByIds(null,this.getPropertyFields());0==t.length&&(t=this.getFieldsByType(null,"numeric"));let i=this.getFieldById(null,this.getProperty("labelField"));i||(i=this.getFieldsByType(null,"string")[0]);let l=HU.open(TAG_TABLE,[ATTR_CLASS,"",ATTR_BORDER,0,ATTR_ID,this.domId(s)]);l+=HU.open(TAG_THEAD);let a=this.getProperty("columnWidth",150);l+=HU.open(TAG_TR,[]),l+=HU.td([ATTR_WIDTH,a],HU.div([ATTR_CLASS,"display-fieldtable-header"],i?this.getFieldLabel(i):""));let r={};t.forEach((t=>{r[t.getId()]=this.getColumnValues(e,t)})),t.forEach((e=>{l+=HU.th([ATTR_WIDTH,a],HU.div([ATTR_CLASS,"display-fieldtable-header"],this.getFieldLabel(e)))})),l+=HU.close(TAG_TR,TAG_THEAD),l+=HU.open(TAG_TBODY);let o=this.getProperty("markerShape","bar"),n=[],h={},d=0,g=this.getProperty("markerSize",16);t.forEach((t=>{h[t.getId()]=this.getColorByInfo(e,t)})),e.forEach(((e,s)=>{let p=i?e.getValue(i.getIndex()):"#"+(s+1),c=[ATTR_CLASS,"display-fieldtable-rowheader"];i&&(c.push(ATTR_FIELD_ID),c.push(i.getId()),c.push(ATTR_FIELD_VALUE),c.push(e.getValue(i.getIndex()))),l+=HU.open(TAG_TR,[ATTR_VALIGN,ALIGN_CENTER,ATTR_RECORD_INDEX,s,ATTR_RECORD_ID,e.getId(),ATTR_CLASS,"display-fieldtable-row"]),l+=HU.td([ATTR_STYLE,HU.css(CSS_VERTICAL_ALIGN,ALIGN_CENTER),ATTR_ALIGN,ALIGN_RIGHT],HU.div(c,p)),t.forEach((t=>{let i=e.getValue(t.getIndex()),s=r[t.getId()],p="";if(isNaN(i)||s.min==s.max)return;let c=100*(i-s.min)/(s.max-s.min),u=this.domId("cid"+d++),T={id:u,v:i,percent:c,field:t,record:e,colorBy:h[t.getId()]};n.push(T);let f=g,y=c+"%";"bar"==o&&(f=c*a,y=0);let m=HU.css(CSS_POSITION,POSITION_ABSOLUTE,CSS_TOP,HU.perc(0),CSS_LEFT,y,CSS_MARGIN_TOP,HU.px("-"+g/2)),_=HU.tag(TAG_CANVAS,[ATTR_TITLE,"Value:"+i+"   Range:"+s.min+" - "+s.max,ATTR_STYLE,m,ATTR_WIDTH,f,ATTR_HEIGHT,g,ATTR_ID,u]);p+=HU.div([ATTR_STYLE,HU.css(CSS_POSITION,POSITION_ABSOLUTE,CSS_LEFT,HU.px(0),CSS_RIGHT,HU.px(g))],_),l+=HU.td(["data-order",i,ATTR_STYLE,HU.css(CSS_VERTICAL_ALIGN,"middle"),ATTR_ALIGN,ALIGN_RIGHT,ATTR_TITLE,"Range:"+s.min+" - "+s.max],HU.div([ATTR_STYLE,HU.css(CSS_POSITION,POSITION_RELATIVE,CSS_WIDTH,HU.px(a),CSS_HEIGHT,HU.px(1),CSS_MARGIN_LEFT,HU.px(10),CSS_MARGIN_RIGHT,HU.px(10),CSS_BORDER,HU.border(1,COLOR_LIGHT_GRAY))],p))})),l+=HU.close(TAG_TR)})),l+=HU.close(TAG_TBODY),l+=HU.open(TAG_TFOOT),l+=HU.open(TAG_TR),l+=HU.td([],""),t.forEach(((e,t)=>{l+=HU.td([],HU.div([ATTR_STYLE,HU.css(CSS_MAX_WIDTH,HU.px(a),CSS_OVERFLOW_X,OVERFLOW_AUTO),ATTR_ID,this.domId("footer-"+t)],""))})),l+=HU.close(TAG_TR),l+=HU.close(TAG_TFOOT),l+=HU.close(TAG_TABLE),this.setContents(l);let p={ordering:!0};this.getProperty("tableHeight")&&(p.scrollY=this.getProperty("tableHeight")),this.getProperty("showColorTable")&&t.forEach(((e,t)=>{let i=h[e.getId()];if(i.index<0)return;let s="footer-"+t;i.displayColorTable(null,!1,s)})),HU.formatTable("#"+this.domId(s),p);this.find(".display-fieldtable-row");this.addFieldClickHandler(null,e,!0);let c=this.getProperty("markerFill","#64CDCC"),u=this.getProperty("markerStroke",COLOR_BLACK);n.forEach((e=>{let t=document.getElementById(e.id).getContext("2d");t.strokeStyle=u,t.fillStyle=e.colorBy.getColorFromRecord(e.record,c),"circle"==o?(t.beginPath(),t.arc(g/2,g/2,g/2,0,2*Math.PI),t.fill(),t.stroke()):"rect"==o?(t.fillRect(0,0,g,g),t.strokeRect(0,0,g,g)):"bar"==o?(t.fillRect(0,0,e.percent/100*a,g),t.strokeRect(0,0,e.percent/100*a,g)):"line"==o?t.fillRect(g/2-2,0,4,g):"triangle"==o?(t.beginPath(),t.moveTo(g/2,0),t.lineTo(g,g),t.lineTo(0,g),t.lineTo(g/2,0),t.fill(),t.stroke()):"dart"==o?(t.beginPath(),t.moveTo(1,0),t.lineTo(g-1,0),t.lineTo(g/2,g/2),t.lineTo(1,0),t.fill(),t.stroke()):"arrow"==o&&(t.beginPath(),t.moveTo(0,0),t.lineTo(g/2,g/2),t.lineTo(g-1,0),t.stroke())}))}})}function RamaddaSelectedrecordsDisplay(e,t,i){const s="selectedrecords",l=new RamaddaFieldsDisplay(e,t,DISPLAY_SELECTEDRECORDS,i);defineDisplay(addRamaddaDisplay(this),l,[{label:"Selected Records"},{p:"labelField",ex:"field"}],{needsData:function(){return!0},updateUI:function(){if(this.recordList||(this.recordList=[]),0==this.recordList.length)return void this.setContents("");let e=this.recordList,t=this.getFieldsByIds(null,this.getPropertyFields());if(null==t)return;if(0==t.length&&(t=this.getFields()),null==t)return;let i=this.getFieldsByIds(null,this.getProperty("notFields"));if(i){let e={};i.forEach((t=>{e[t.getId()]=!0})),t=t.filter((t=>!e[t.getId()]))}let l=this.getFieldById(null,this.getLabelField()),a="";if(a+=HU.div([ATTR_ID,this.domId("download")],"Download Data"),a+=HU.openTag(TAG_TABLE,[ATTR_CLASS,HU.classes(CLASS_TABLE,CLASS_TABLE_STRIPE,CLASS_TABLE_ROWBORDER),ATTR_ID,this.domId(s)]),this.idToRecord={},this.csv=[],l){let t=[];this.csv.push(t),a+=HU.open(TAG_THEAD),t.push("Field"),a+=HU.th([ATTR_ALIGN,ALIGN_CENTER],"Field"),e.forEach((e=>{this.idToRecord[e.getId()]=e;let i=l.getValue(e);t.push(i);let s=HU.div([ATTR_CLASS,HU.classes(CLASS_CLICKABLE,"display-selectedrecords-header"),ATTR_TITLE,"Click to remove","data-record-id",e.getId()],i);a+=HU.th([ATTR_ALIGN,ALIGN_CENTER],s)})),a+=HU.close(TAG_THEAD)}a+=HU.open(TAG_TBODY),t.forEach(((t,i)=>{if(l&&l.getId()==t.getId())return;a+=HU.open(TAG_TR);let s=[];this.csv.push(s),e.forEach(((e,i)=>{0==i&&(s.push(t.getLabel()),a+=HU.td([ATTR_WIDTH,HU.perc(20)],HU.b(t.getLabel())));let l=[],r=t.getValue(e);s.push(r),isNaN(r)?"NaN"===String(r)&&(r="--",l.push(ATTR_ALIGN,ALIGN_RIGHT)):l.push(ATTR_ALIGN,ALIGN_RIGHT),a+=HU.td(l,r)})),a+=HU.close(TAG_TR)})),a+=HU.close(TAG_TBODY,TAG_TABLE),this.setContents(a),this.jq("download").button().click((()=>{let e="";this.csv.forEach((t=>{e+=Utils.join(t,","),e+="\n"})),Utils.makeDownloadFile(this.getProperty("downloadFile","data.csv"),e)}));let r={};this.getProperty("tableHeight")&&(r.scrollY=this.getProperty("tableHeight"));let o=this;HU.formatTable("#"+this.domId(s),r,(()=>{o.getContents().find(".display-selectedrecords-header").click((function(){let e=$(this).parent(),t=e.attr("data-record-id");if(!t){let i=e.html().match(/data-record-id="(.*)"/);i&&(t=i[1])}if(!t)return;let i=o.idToRecord[t];i&&(o.seenRecords&&delete o.seenRecords[i.getId()],o.recordList=Utils.removeItem(o.recordList,i),o.updateUI())}))}))},handleEventRecordSelection:function(e,t){l.handleEventRecordSelection.call(this,e,t),this.seenRecords||(this.seenRecords={}),this.recordList||(this.recordList=[]),this.seenRecords[t.record.getId()]||(this.seenRecords[t.record.getId()]=!0,this.recordList.push(t.record),this.updateUI())}})}function RamaddaDotstackDisplay(e,t,i){const s=new RamaddaFieldsDisplay(e,t,"dotstack",i);defineDisplay(addRamaddaDisplay(this),s,[{label:"Dot Stack"},{p:"categoryField",ex:"field"}],{needsData:function(){return!0},updateUI:function(){let e=this.filterData();if(!e)return;let t={};e.forEach(((e,i)=>{t[e.getId()]=i}));this.getProperty("orientation","horizontal");let i=this.getFieldById(null,this.getProperty("categoryField")),s="",l=RecordUtil.groupBy(e,this,null,i),a=this.getColorByInfo(e),r=this.getProperty("boxWidth",4),o=this.getProperty("boxColumns",10);l.values.sort(((e,t)=>l.map[t].length-l.map[e].length)),l.values.forEach(((e,i)=>{let n=[],h=[];n.push(h);let d=l.map[e];d.forEach((e=>{h.length>o&&(h=[],n.push(h));let i=a.getColorFromRecord(e,"blue"),s=HU.div([ATTR_TITLE,"",ATTR_RECORD_ID,e.getId(),ATTR_RECORD_INDEX,t[e.getId()],ATTR_CLASS,"display-dotstack-dot",ATTR_STYLE,HU.css(CSS_WIDTH,HU.px(r),CSS_HEIGHT,HU.px(r),CSS_BACKGROUND,i)],"");h.push(s)})),s+=HU.open(TAG_DIV,[ATTR_CLASS,"display-dotstack-block"]),s+=HU.div([],this.getProperty("labelTemplate","${count}").replace("${count}",d.length)),s+=HU.open(TAG_TABLE);for(let e=n.length-1;e>=0;e--)s+=HU.tr([],HU.tds([],n[e]));s+=HU.close(TAG_TABLE),s+=e,s+=HU.close(TAG_DIV)})),this.setContents(s);let n=this.find(".display-dotstack-dot");this.addFieldClickHandler(n,e,!1),this.makeTooltips(n,e,null,"${default}"),this.getProperty("tableHeight")&&(opts.scrollY=this.getProperty("tableHeight")),this.getProperty("showColorTable")&&a.displayColorTable(null,!1,domId)}})}function RamaddaDotbarDisplay(e,t,i){const s=new RamaddaFieldsDisplay(e,t,"dotbar",i);$.extend(this,s),addRamaddaDisplay(this);this.defineSizeByProperties(),defineDisplay(this,s,[{label:"Dot Bar"},{p:"keyField"},{p:"dotSize",d:16}],{needsData:function(){return!0},updateUI:function(){let e=this.filterData();if(!e)return;let t=this.getFieldById(null,this.getPropertyKeyField()),i=this.getFieldsByIds(null,this.getPropertyFields());0==i.length&&(i=this.getPointData().getRecordFields());let s,l=this.getPropertyDotSize(),a=new SizeBy(this,this.getProperty("sizeByAllRecords",!0)?this.getData().getRecords():e),r=HU.open(TAG_TABLE,[ATTR_WIDTH,"100%"]),o=(new Date,l);a.field&&(o=2*a.getMaxSize()),i.forEach(((n,h)=>{if(!n.isFieldNumeric())return;let d=new ColorByInfo(this,i,e,null,null,null,null,n),g=(this.domId("dots"+h),this.getColumnValues(e,n));r+=HU.open(TAG_TR,[ATTR_VALIGN,ALIGN_CENTER]),r+=HU.td([ATTR_WIDTH,HU.perc(10),ATTR_ALIGN,ALIGN_RIGHT],HU.div([ATTR_STYLE,HU.css(CSS_MARGIN_RIGHT,HU.px(8))],this.getFieldLabel(n).replace(/ /g,SPACE))),r+=HU.td([ATTR_ALIGN,ALIGN_RIGHT,ATTR_WIDTH,HU.perc(5)],HU.div([ATTR_STYLE,HU.css(CSS_MARGIN_RIGHT,HU.px(10))],this.formatNumber(g.min))),r+=HU.open(TAG_TD),r+=HU.open(TAG_DIV,[ATTR_STYLE,HU.css(CSS_HEIGHT,HU.getDimension(o),CSS_WIDTH,HU.perc(100),CSS_POSITION,POSITION_RELATIVE,CSS_MARGIN_TOP,HU.px(4))]),r+=HU.div([ATTR_STYLE,HU.css(CSS_POSITION,POSITION_ABSOLUTE,CSS_LEFT,HU.px(0),CSS_RIGHT,HU.px(0),CSS_TOP,HU.perc(50),CSS_BORDER_TOP,HU.border(1,COLOR_LIGHT_GRAY))]),r+=SPACE,e.forEach(((e,i)=>{let h=e.getValue(n.getIndex()),p=d.getColor(h,e),c=Utils.pSBC(-.25,p);if(g.min==g.max)return;let u=(h-g.min)/(g.max-g.min),T="display-dotbar-dot",f=!1,y="";t&&this.selectedKey?this.selectedKey==e.getValue(t.getIndex())&&(f=!0):i==this.selectedIndex&&(f=!0);let m=HU.border(2,c);this.selectedIndex>=0&&(f?m=HU.border(1,COLOR_BLACK):(m=HU.border(1,c),p=HU.rgb(200,200,200,.2))),f?(s=e,T+=" display-dotbar-dot-select"):this.getFilterHighlight()&&(e.isHighlight(this)||(y=HU.css(CSS_Z_INDEX,"10",CSS_BORDER,HU.border(1,"#aaa")))),u*=100;let _=l;if(a.field){if(_=2*a.getSize(e.getData(),l),_<0)return;y+=HU.css(CSS_HEIGHT,HU.getDimension(_),CSS_WIDTH,HU.getDimension(_))}let S=o/2-_/2;r+=HU.span([ATTR_RECORD_INDEX,i,ATTR_RECORD_ID,e.getId(),ATTR_CLASS,T,ATTR_STYLE,HU.css(CSS_BORDER,m,CSS_BACKGROUND,p,CSS_POSITION,POSITION_ABSOLUTE,CSS_TOP,HU.getDimension(S),CSS_LEFT,HU.perc(u))+y,ATTR_RECORD_INDEX,i,ATTR_TITLE,""])})),r+=HU.close(TAG_DIV,TAG_TD),r+=HU.td([ATTR_WIDTH,2*l]),r+=HU.td([ATTR_ALIGN,ALIGN_RIGHT,ATTR_WIDTH,HU.perc(5)],HU.div([ATTR_STYLE,HU.css(CSS_MARGIN_LEFT,HU.px(10))],this.formatNumber(g.max))),r+=HU.close(TAG_TR)}));new Date;r+=HU.close(TAG_TABLE),this.setContents(r);new Date;let n=this.find(".display-dotbar-dot"),h=(new Date,this);n.mouseleave((function(){n.removeClass("display-dotbar-dot-highlight")})),n.mouseover((function(){let e=$(this).attr(ATTR_RECORD_INDEX);n.removeClass("display-dotbar-dot-highlight"),h.find("["+ATTR_RECORD_INDEX+'="'+e+'"]').addClass("display-dotbar-dot-highlight")})),n.click((function(){let i=$(this).attr(ATTR_RECORD_INDEX),s=e[i];if(s){if(n.removeClass("display-dotbar-dot-select"),h.selectedIndex==i)return h.selectedIndex=-1,void h.updateUI();h.selectedIndex=i,t&&(h.selectedKey=s.getValue(t.getIndex())),h.find("["+ATTR_RECORD_INDEX+'="'+i+'"]').addClass("display-dotbar-dot-select"),h.hadClick=!0,h.propagateEventRecordSelection({record:s}),h.updateUI()}})),s&&setTimeout((()=>{this.propagateEventRecordSelection({record:s})}),10),this.makeTooltips(n,e,null);new Date}})}function RamaddaDategridDisplay(e,t,i){const s=new RamaddaFieldsDisplay(e,t,DISPLAY_DATEGRID,i);$.extend(this,s),addRamaddaDisplay(this);let l=[{label:"Date Box"},{p:"groupField"},{p:"boxSize",d:16},{p:"showStats",ex:"true",d:!0,tt:"show starts per row"},{p:"showTotal",ex:"true",d:!0,tt:"show the totals"},{p:"showMin",ex:"true",d:!0,tt:"show min"},{p:"showMax",ex:"true",d:!0,tt:"show max"},{p:"showAverage",ex:"true",d:!1,tt:"show average"},{p:"leftWidth",tt:"width of left column",d:HU.px(100)},{p:"rightWidth",tt:"width of right column",d:HU.px(100)},{p:"leftLabel",tt:"Label for the left column"},{p:"rightLabel",tt:"Label for the left column",d:"Total/Min/Max"},{p:"dateHeaderStyle",tt:"Style to use for the date header"},{p:"dateStride",d:-1,tt:"The stride in hours to display the date label"},{p:"numLabels",d:8,tt:"Hour many date labels to show if no dateStride given"},{p:"boxStyle",tt:"Style to use for color boxes"},{p:"leftStyle",tt:"Style to use for left column"},{p:"rightStyle",tt:"Style to use for right column"}];this.defineSizeByProperties(),defineDisplay(this,s,l,{updateUI:function(){let e=this.filterData();if(!e)return;let t=this.getFieldById(null,this.getPropertyGroupField()),i=(this.getBoxSize(),[]),s=this.getColorByInfo(e),l=null,a=null;e.forEach((e=>{if(l){let t=e.getDate();l=t.getTime()<l.getTime()?t:l,a=t.getTime()>a.getTime()?t:a}else l=a=e.getDate();let s=e.getValue(t.getIndex()),r=i[s];null==r&&(r={records:[]},i[s]=r),r.records.push(e)})),this.dateFormat||(this.dateFormat=this.getProperty("dateFormat","ddd mm/dd"));let r=this.getShowStats(),o=HU.getDimension(this.getLeftWidth()),n=HU.getDimension(this.getRightWidth()),h="",d=a.getTime()-l.getTime(),g=e=>(e.getTime()-l.getTime())/d,p=HU.em(1.5);h=HU.open(TAG_DIV,[ATTR_CLASS,"display-dategrid-table"])+HU.open(TAG_TABLE,[ATTR_WIDTH,HU.perc(100),ATTR_BORDER,0,ATTR_CELLPADDING,0,ATTR_CELLSPACING,0]),h+=HU.open(TAG_TR)+HU.tag(TAG_TD,[ATTR_WIDTH,o],HU.div([ATTR_CLASS,"display-dategrid-header"],this.getLeftLabel(this.getFieldLabel(t))));let c,u=this.getDateHeaderStyle(HU.css(CSS_BACKGROUND,"#eee",CSS_BORDER_BOTTOM,HU.border(1,"#888"))),T=this.getBoxStyle(""),f=this.getLeftStyle(""),y=this.getRightStyle(""),m=HU.open(TAG_DIV,[ATTR_CLASS,"display-dategrid-dateheader",ATTR_STYLE,u])+SPACE,_=l,S=this.getDateStride(-1);if(S>0)c=1e3*S*60*60;else{let e=Math.round((a.getTime()-l.getTime())/1e3/60/60),t=this.getNumLabels();c=1e3*Math.round(e/t)*60*60}let A=l.getTime()%c;for(_=new Date(l.getTime()-A+c);_.getTime()<=a.getTime();){let e=HU.perc(100*g(_)),t=HU.css(CSS_LEFT,e,CSS_TOP,HU.perc(0),CSS_TRANSFORM,HU.translate(HU.perc(-50),HU.perc(0)));m+=HU.div([ATTR_CLASS,HU.classes("display-dategrid-header","display-dategrid-date"),ATTR_STYLE,t],this.formatDate(_))+"\n",_=new Date(_.getTime()+c)}if(m+=HU.close(TAG_DIV),h+=HU.td([],m),r){let e=[];this.getShowTotal()&&e.push("Total"),this.getShowMin()&&e.push("Min"),this.getShowMax()&&e.push("Max"),this.getShowAverage()&&e.push("Avg"),h+=HU.tag(TAG_TD,[ATTR_WIDTH,n],HU.div([ATTR_CLASS,HU.classes("display-dategrid-header","display-dategrid-stats")],this.getRightLabel(Utils.join(e,"/"))))}h+=HU.close(TAG_TR),Object.keys(i).sort((e=>{let t=i[e],l=HU.open(TAG_DIV,[ATTR_CLASS,"display-dategrid-row",ATTR_STYLE,HU.css(CSS_HEIGHT,p)]),a=t.records.sort(((e,t)=>e.getTime()-t.getTime())),n=0,d=NaN,c=NaN;for(let e=0;e<a.length;e++){let t=a[e],i=g(t.getDate()),r=a[e+1],o=i+.05;if(r){let e=g(r.getDate());o=1-e}i=100*i+"%",o=100*o+"%";let h=s.getColorFromRecord(t),u=t.getValue(s.index);isNaN(u)||(n+=u,d=Utils.min(d,u),c=Utils.max(c,u)),l+=HU.div(["foo","bar",ATTR_RECORD_ID,t.getId(),ATTR_CLASS,"display-dategrid-box",ATTR_TITLE,u,ATTR_STYLE,HU.css(CSS_LEFT,i,CSS_RIGHT,o,CSS_HEIGHT,p,CSS_BACKGROUND,h)+T],SPACE)}if(l+=HU.close(TAG_DIV),h+=HU.open(TAG_TR)+HU.tag(TAG_TD,[ATTR_WIDTH,o],HU.div([ATTR_STYLE,f,ATTR_CLASS,"display-dategrid-rowlabel"],e))+HU.tag(TAG_TD,[],l),r){let e=[];this.getShowTotal()&&e.push(this.formatNumber(n)),this.getShowMin()&&e.push(this.formatNumber(d,null)),this.getShowMax()&&e.push(this.formatNumber(c)),this.getShowAverage()&&e.push(this.formatNumber(n/a.length)),h+=HU.td([ATTR_NOWRAP,"true"],HU.div([ATTR_STYLE,y,ATTR_CLASS,"display-dategrid-stats"],Utils.join(e,SPACE)))}h+=HU.close(TAG_TR)})),h+=HU.close(TAG_TABLE,TAG_DIV),this.setContents(h),this.boxes=this.find(".display-dategrid-box"),this.addFieldClickHandler(this.boxes,e,!1),this.makeTooltips(this.boxes,e,null),this.recordMap=this.makeIdToRecords(e),this.records=e,s.displayColorTable()},handleEventRecordSelection:function(e,t){if(s.handleEventRecordSelection.call(this,e,t),!this.boxes)return;let i=[],l=this.recordMap[t.record.getId()];if(l?i.push(l):i=this.findMatchingDates(t.record.getDate(),this.filteredRecords),0==i.length)return;this.boxes.removeClass("display-dategrid-box-highlight");let a={};this.boxes.each((function(){a[$(this).attr(ATTR_RECORD_ID)]=$(this)})),i.forEach((e=>{let t=a[e.getId()];t&&t.addClass("display-dategrid-box-highlight")}))}})}function RamaddaStripesDisplay(e,t,i){const s=new RamaddaFieldsDisplay(e,t,DISPLAY_STRIPES,i);let l=[{label:"Stripes"},{p:"colorBy",ex:"",tt:"Field id to color by"},{p:"stripeHeight",d:HU.px(100)},{p:"stripeWidth",d:3,tt:"Make sure this is a whole number"},{p:"showLabel",d:!1,ex:"true"},{p:"showLegend",d:!1,ex:"true"},{p:"showColorTable",d:!1,ex:"true"},{p:"showColorTableBottom",d:!1,ex:"true"},{p:"groupBy",tt:"Field id to group by"},{p:"showSparkline",ex:"true"}];l.push(...RamaddaDisplayUtils.sparklineProps),defineDisplay(addRamaddaDisplay(this),s,l,{checkLayout:function(){this.getShowSparkline()&&this.updateUI()},updateUI:function(){let e=this.filterData();if(!e)return;let t=this.getFieldsByIds(null,this.getPropertyFields());if(0==t.length)return void this.handleError("No field specified");let i=this.getFieldById(null,this.getGroupBy()),s={};i?e.forEach(((e,t)=>{let l=i.getValue(e);s[l]||(s[l]=[]),s[l].push(e)})):s.all=e;let l=this.getFields(),a=this.getStripeHeight(),r={};e.forEach((e=>{r[e.getId()]=e}));let o=HU.open(TAG_CENTER)+HU.open(TAG_DIV,[ATTR_STYLE,HU.css(CSS_DISPLAY,DISPLAY_INLINE_BLOCK)]),n=[],h=this.getStripeWidth(),d=Object.keys(s),g=()=>{let t=this.formatDate(e[0].getDate());this.getShowLabel()&&(t=HU.div([ATTR_STYLE,HU.css(CSS_MARGIN_LEFT,HU.em(2))],t));let i=HU.div([ATTR_STYLE,HU.css(CSS_TEXT_ALIGN,ALIGN_CENTER)],this.formatDate(e[parseInt(e.length/2)].getDate()));o+=HU.leftCenterRight(t,i,this.formatDate(e[e.length-1].getDate()),"20%","60%","20%")};this.getShowLegend()&&g();let p=[],c="2em";d.forEach(((e,r)=>{i&&(o+=e);let g=s[e];t.forEach(((e,i)=>{let s=HU.getUniqueId("table_");o+=HU.open(TAG_TABLE,[ATTR_ID,s,ATTR_STYLE,HU.css(CSS_POSITION,POSITION_RELATIVE)]),p.push({domId:s,records:g,field:e});let u=r==d.length-1&&i==t.length-1,T=new ColorByInfo(this,l,g,"",null,null,null,e);n.push(T),t.length>1?o+=HU.open(TAG_TR,[ATTR_STYLE,HU.css(CSS_BORDER_BOTTOM,HU.border(1,"#efefef"))]):o+=HU.open(TAG_TR),this.getShowLabel()&&(o+=HU.td([ATTR_WIDTH,c,ATTR_CLASS,"display-stripes-stripe-label",ATTR_STYLE,HU.css(CSS_MAX_WIDTH,HU.em(2),CSS_WIDTH,HU.em(2))],HU.div([ATTR_WIDTH,c,ATTR_STYLE,HU.css(CSS_MAX_WIDTH,c,CSS_WIDTH,c,CSS_MAX_HEIGHT,HU.getDimension(a)),ATTR_CLASS,"display-stripes-vertical-label"],e.getLabel()))),g.forEach(((t,i)=>{let s=T.getColorFromRecord(t),l=e.getValue(t),r=t.getDate(),n=e.getLabel()+": "+l;r&&(n=this.formatDate(r)+" - "+n);let d=[ATTR_RECORD_ID,t.getId(),ATTR_CLASS,"display-stripes-stripe",ATTR_STYLE,HU.css(CSS_HEIGHT,HU.getDimension(a),CSS_BACKGROUND,s),ATTR_TITLE,n,ATTR_WIDTH,h];o+=HU.td(d,"")})),o+=HU.close(TAG_TR,TAG_TABLE),(u&&this.getShowColorTableBottom()||this.getShowColorTable())&&(o+=HU.div([ATTR_ID,this.domId("colortable_"+i),ATTR_STYLE,HU.css(CSS_WIDTH,HU.px(h*g.length),CSS_MARGIN_BOTTOM,HU.px(5),CSS_HEIGHT,HU.em(1))],""))}))})),this.getShowLegend()&&g(),o+=HU.close(TAG_DIV,TAG_CENTER),this.setContents(o),n.forEach(((e,t)=>{e.displayColorTable(null,null,"colortable_"+t)})),this.getShowSparkline()&&p.forEach((t=>{let i=jqid(t.domId),s=i.find(".display-stripes-stripe-label"),l=i.width(),a=i.height();s.length>0&&(l-=s.width());let r=HU.getUniqueId("div_");i.append(HU.div([ATTR_ID,r,ATTR_STYLE,HU.css(CSS_POSITION,POSITION_ABSOLUTE,CSS_POINTER_EVENTS,"none",CSS_MARGIN_LEFT,this.getShowLabel()?c:HU.px(0),CSS_LEFT,HU.px(0),CSS_TOP,HU.px(0),CSS_WIDTH,HU.px(l),CSS_HEIGHT,HU.px(a))],""));let o=this.getColumnValues(t.records,t.field),n=this.getColumnValues(this.getSparklineUseAllRecords()?e:t.records,t.field);drawSparkline(this,"#"+r,l,a,o.values,t.records,n.min,n.max,null,{margin:{top:5,bottom:5}})}));let u=this,T=this.getContents().find(".display-stripes-stripe");this.makeTooltips(T,e),T.click((function(){let e=r[$(this).attr(ATTR_RECORD_ID)];u.propagateEventRecordSelection({record:e})}))}})}addGlobalDisplayType({type:DISPLAY_RANKING,label:"Ranking",requiresData:!0,forUser:!0,category:CATEGORY_TABLE,tooltip:makeDisplayTooltip("Show fields ordered by values","ranking.png")}),addGlobalDisplayType({type:DISPLAY_STRIPES,label:"Stripes",requiresData:!0,forUser:!0,category:CATEGORY_MISC,tooltip:makeDisplayTooltip("Show color stripes","stripes.png")}),addGlobalDisplayType({type:DISPLAY_CORRELATION,label:"Correlation",requiresData:!0,forUser:!0,category:CATEGORY_TABLE,tooltip:makeDisplayTooltip("Correlation","correlation.png")}),addGlobalDisplayType({type:DISPLAY_CROSSTAB,label:"Crosstab",requiresData:!0,forUser:!0,category:CATEGORY_TABLE,tooltip:makeDisplayTooltip("Cross Tabulation","crosstab.png")}),addGlobalDisplayType({type:DISPLAY_STATS,label:"Stats Table",requiresData:!1,forUser:!0,category:CATEGORY_TABLE,tooltip:makeDisplayTooltip("Statistical Summary","stats.png")}),addGlobalDisplayType({type:DISPLAY_RECORDS,label:"Records",requiresData:!0,forUser:!0,category:CATEGORY_TEXT,tooltip:makeDisplayTooltip("Displays records as text","records.png")}),addGlobalDisplayType({type:DISPLAY_TSNE,label:"TSNE",requiresData:!0,forUser:!1,category:CATEGORY_MISC}),addGlobalDisplayType({type:DISPLAY_HEATMAP,label:"Heatmap",requiresData:!0,forUser:!0,category:CATEGORY_MISC,tooltip:makeDisplayTooltip("Table showing colored fields","heatmap.png")}),addGlobalDisplayType({type:DISPLAY_WAFFLE,label:"Waffle",requiresData:!0,forUser:!0,category:CATEGORY_MISC,tooltip:makeDisplayTooltip("Waffle Chart","waffle.png")}),addGlobalDisplayType({type:DISPLAY_GRAPH,label:"Graph",requiresData:!0,forUser:!0,category:CATEGORY_MISC,tooltip:makeDisplayTooltip("Display a force-directed graph","graph.png")}),addGlobalDisplayType({type:DISPLAY_PERCENTCHANGE,label:"Percent Change",requiresData:!0,forUser:!0,category:CATEGORY_TEXT,tooltip:makeDisplayTooltip("Percent Change","percentchange.png","Show percent change over a given time in a text template")}),addGlobalDisplayType({type:DISPLAY_SPARKLINE,label:"Sparkline",requiresData:!0,forUser:!0,category:CATEGORY_IMAGES,tooltip:makeDisplayTooltip("Embed little sparkline plots in text","sparkline.png")}),addGlobalDisplayType({type:DISPLAY_CANVAS,label:"Canvas",requiresData:!0,forUser:!0,category:CATEGORY_IMAGES,tooltip:makeDisplayTooltip("Draw records into a canvas","canvas.png")}),addGlobalDisplayType({type:DISPLAY_POINTIMAGE,label:"Point Image",requiresData:!0,forUser:!0,category:CATEGORY_IMAGES,tooltip:makeDisplayTooltip("Embed 2D images into text","pointimage.png")}),addGlobalDisplayType({type:DISPLAY_FIELDTABLE,label:"Field Table",requiresData:!0,forUser:!0,category:CATEGORY_TABLE,tooltip:makeDisplayTooltip("Field Table","fieldtable.png")}),addGlobalDisplayType({type:DISPLAY_SELECTEDRECORDS,label:"Selected Records",requiresData:!0,forUser:!0,category:CATEGORY_TABLE,tooltip:makeDisplayTooltip("Display selected records in a table")}),addGlobalDisplayType({type:DISPLAY_TREE,forUser:!0,label:"Tree",requiresData:!1,category:CATEGORY_RADIAL_ETC,tooltip:makeDisplayTooltip("Tree","tree.png")}),addGlobalDisplayType({type:DISPLAY_TIMELINE,label:"Timeline",requiresData:!0,forUser:!0,category:CATEGORY_MISC,tooltip:makeDisplayTooltip("Timeline showing text and images","timeline.png")}),addGlobalDisplayType({type:DISPLAY_HOURS,label:"Hours",requiresData:!0,forUser:!0,category:CATEGORY_MISC,tooltip:makeDisplayTooltip("Hourly timeline","timeline.png","Show data by the day and hour")}),addGlobalDisplayType({type:DISPLAY_BLANK,label:"Blank",requiresData:!0,forUser:!0,category:CATEGORY_CONTROLS,tooltip:makeDisplayTooltip("Shows no data",null,"Useful for just showing filters, etc")}),addGlobalDisplayType({type:DISPLAY_FILTER,label:"Filter",requiresData:!1,category:CATEGORY_CONTROLS,tooltip:makeDisplayTooltip("No data, just provides data filtering")}),addGlobalDisplayType({type:DISPLAY_HOOK,label:"Hook",requiresData:!0,forUser:!0,category:CATEGORY_CONTROLS,tooltip:makeDisplayTooltip("Add your own Javascript",null,"Integrate your own Javascript")}),addGlobalDisplayType({type:DISPLAY_PRE,label:"Preformat",requiresData:!0,forUser:!0,category:CATEGORY_TABLE,tooltip:makeDisplayTooltip("Shows records in an HTML PRE tag",null,"Useful for looking at the data")}),addGlobalDisplayType({type:DISPLAY_HTMLTABLE,label:"HTML Table",requiresData:!0,forUser:!0,category:CATEGORY_TABLE,tooltip:makeDisplayTooltip("Shows records in an HTML table",null,"Useful for looking at the data")}),addGlobalDisplayType({type:DISPLAY_COOCCURENCE,label:"Cooccurence",requiresData:!0,forUser:!0,category:CATEGORY_TABLE,tooltip:makeDisplayTooltip("Cooccurence Table","cooccurrence.png","Tabular plot showing number of records that share values from two fields")}),addGlobalDisplayType({type:DISPLAY_BOXTABLE,label:"Box Table",requiresData:!0,forUser:!0,category:CATEGORY_TABLE,tooltip:makeDisplayTooltip("Box Table","boxtable.png","Shows number of records that share the same category field value")}),addGlobalDisplayType({type:DISPLAY_DATATABLE,label:"Data Table",requiresData:!0,forUser:!0,category:CATEGORY_TABLE,tooltip:makeDisplayTooltip("Data Table",["datatable1.png","datatable2.png"],"Selectable record grouping. Can be colored or show pie charts")}),addGlobalDisplayType({type:DISPLAY_DATEGRID,label:"Date Grid",requiresData:!0,forUser:!0,category:CATEGORY_TABLE,tooltip:makeDisplayTooltip("Date Grid",["dategrid.png"],"Show records grouped by category and date")});const DISPLAY_PLOTLY_RADAR="radar",DISPLAY_PLOTLY_WINDROSE="windrose",DISPLAY_PLOTLY_DENSITY="density",DISPLAY_PLOTLY_DOTPLOT="dotplot",DISPLAY_PLOTLY_SPLOM="splom",DISPLAY_PLOTLY_PROFILE="profile",DISPLAY_PLOTLY_3DSCATTER="3dscatter",DISPLAY_PLOTLY_3DMESH="3dmesh",DISPLAY_PLOTLY_TREEMAP="ptreemap",DISPLAY_PLOTLY_TERNARY="ternary",DISPLAY_PLOTLY_SUNBURST="sunburst",DISPLAY_PLOTLY_TEXTCOUNT="textcount",DISPLAY_PLOTLY_COMBOCHART="combochart",DISPLAY_PLOTLY_PARCOORDS="parcoords";addGlobalDisplayType({type:DISPLAY_PLOTLY_RADAR,label:"Radar",category:CATEGORY_RADIAL_ETC,tooltip:makeDisplayTooltip("Radar Plot","radar.png")}),addGlobalDisplayType({type:DISPLAY_PLOTLY_WINDROSE,label:"Wind Rose",category:CATEGORY_RADIAL_ETC,tooltip:makeDisplayTooltip("Wind Rose Plot","windrose.png")}),addGlobalDisplayType({type:DISPLAY_PLOTLY_SUNBURST,label:"Sunburst",category:CATEGORY_RADIAL_ETC,tooltip:makeDisplayTooltip("Sunburst Plot","sunburst.png")}),addGlobalDisplayType({type:DISPLAY_PLOTLY_DENSITY,label:"Density",category:CATEGORY_RADIAL_ETC,tooltip:makeDisplayTooltip("Density Plot","density.png",null)}),addGlobalDisplayType({type:DISPLAY_PLOTLY_COMBOCHART,label:"Combo Chart",category:CATEGORY_CHARTS,tooltip:makeDisplayTooltip("Combo Chart","combochart.png","Display line and bar chart")}),addGlobalDisplayType({type:DISPLAY_PLOTLY_PARCOORDS,label:"Parallel Coords",category:CATEGORY_RADIAL_ETC,tooltip:makeDisplayTooltip("Parallel Coordinates","parallel.png",null)}),addGlobalDisplayType({type:DISPLAY_PLOTLY_DOTPLOT,label:"Dot Plot",category:CATEGORY_CHARTS,tooltip:makeDisplayTooltip("Dot Plot","dotplot.png")}),addGlobalDisplayType({type:DISPLAY_PLOTLY_SPLOM,label:"Splom",category:CATEGORY_RADIAL_ETC,tooltip:makeDisplayTooltip("Splom","splom.png")}),addGlobalDisplayType({type:DISPLAY_PLOTLY_3DSCATTER,label:"3D Scatter",category:CATEGORY_RADIAL_ETC,tooltip:makeDisplayTooltip("3D Scatter","3dscatter.png")}),addGlobalDisplayType({type:DISPLAY_PLOTLY_PROFILE,label:"Profile",category:CATEGORY_CHARTS,tooltip:makeDisplayTooltip("Profile","profile.png")}),addGlobalDisplayType({type:DISPLAY_PLOTLY_3DMESH,label:"3D Mesh",requiresData:!1,forUser:!1,category:CATEGORY_RADIAL_ETC,tooltip:makeDisplayTooltip("3D Mesh","3dmesh.png")}),addGlobalDisplayType({type:DISPLAY_PLOTLY_TEXTCOUNT,label:"Text Count",category:CATEGORY_TEXT,tooltip:makeDisplayTooltip("Text Count","textcount.png","Given a text field show the number of <br>times certain word patterns occur")});var ID_PLOT="plot",ID_PLOTY="plotly";function RamaddaPlotlyDisplay(e,t,i,s){let l=new RamaddaFieldsDisplay(e,t,i,s),a=[{label:"Plotly Properties"},{p:"plotTitle"},{p:"font"},{p:"fontSize",d:12},{p:"fontColor",d:COLOR_BLACK}];defineDisplay(this,l,a,{getRequirement:function(){return"Plotly"},needsData:function(){return!0},showFieldsInDialog:function(){return!0},updateUI:function(e){if(window.Plotly)this.updateUIInner(e);else{if(this.callbackPending)return;this.callbackPending=!0;let t=RamaddaUtil.getCdnUrl("/lib/plotly/plotly-2.24.1.min.js"),i=this.loadingJS?null:()=>{this.updateUI(e),this.callbackPending=!1};Utils.loadScript(t,i)}},updateUIInner:function(e){},setDimensions:function(e,t,i){i=i??{};var s=parseInt(this.getProperty("height","400").replace("px","").replace("%",""));e.height=s,e.margin||(e.margin={}),[["l","marginLeft"],["r","marginRight"],["t","marginTop"],["b","marginBottom"]].map((t=>{let s=t[1];Utils.isDefined(this.getProperty(s))?e.margin[t[0]]=this.getProperty(s):Utils.isDefined(i[s])&&(e.margin[t[0]]=i[s])}))},pointDataLoaded:function(e,t,i){l.pointDataLoaded.call(this,e,t,i)},displayData:function(){this.updateUI()},pageHasLoaded:function(){l.pageHasLoaded.call(this),this.updateUI()},fieldSelectionChanged:function(){l.fieldSelectionChanged.call(this),this.updateUI()},makeAxis:function(e,t){return{title:e,titlefont:{size:20},tickangle:t,tickfont:{size:15},tickcolor:"rgba(0,0,0,0)",ticklen:5,showline:!0,showgrid:!0}},getDisplayStyle:function(){return""},makePlot:function(e,t){this.clearHtml();let i=HU.div([ATTR_ID,this.getDomId(ID_HEADER)],"")+HU.div([ATTR_ID,this.getDomId(ID_PLOT),ATTR_STYLE,HU.css(CSS_WIDTH,HU.perc(100))+this.getDisplayStyle()],"")+HU.div([ATTR_ID,this.getDomId(ID_FOOTER)],"");this.setContents(i),setTimeout((()=>{let i=Plotly.newPlot(this.getDomId(ID_PLOT),e,t,{displayModeBar:!1}),s=document.getElementById(this.getDomId(ID_PLOT));s&&this.initPlot(i,s)}),1)},makeLayout:function(e){let t={title:this.getPlotTitle(""),font:{family:this.getFont(),size:this.getFontSize(),color:this.getFontColor()}};return e?$.extend(e,t):t},handleClickEvent:function(e){if(e.points&&e.points.length>0){let t=e.points[0].record;if(!t){let i=e.points[0].pointIndex;t=this.indexToRecord[i]}t&&this.propagateEventRecordSelection({record:t})}},initPlot:function(e,t){let i=this;t.on("plotly_click",(function(e){i.handleClickEvent(e)}))}})}function RamaddaRadialDisplay(e,t,i,s){Utils.isDefined(s.width)||(s.width=HU.px(400)),Utils.isDefined(s.height)||(s.height=HU.px(400)),RamaddaUtil.inherit(this,new RamaddaPlotlyDisplay(e,t,i,s)),RamaddaUtil.defineMembers(this,{getPlotType:function(){return"barpolar"},updateUIInner:function(){var e=this.filterData();if(e){var t=this.getSelectedFields(this.getData().getRecordFields()),i=this.getFieldsByType(t,"numeric");if(0!=i.length){var s,l;if(this.getProperty("useDates")){var a=this.getDateValues(e);s=[];var r=this.getProperty("dateFormat","yyyyMMdd");l="category",a.map((e=>{s.push(Utils.formatDateWithFormat(e,r))}))}else{var o=this.getFieldById(null,this.getProperty("thetaField"));o&&(s=this.getColumnValues(e,o).values)}for(var n=[],h=Number.MAX_VALUE,d=Number.MIN_VALUE,g=[],p=0;p<i.length;p++){var c=i[p],u=this.getColumnValues(e,c);if(!s){s=[];var T=0;for(T=0;T<u.values.length;T++)s.push(360*T/u.values.length)}h=Math.min(h,u.min),d=Math.max(d,u.max);n=u.values;g.push({type:this.getPlotType(),r:n,theta:s,fill:"toself",name:c.getLabel()})}layout={polar:{angularaxis:{type:"category"},radialaxis:{visible:!0,range:[h,d]}}},l&&(layout.polar.angularaxis={type:l}),this.setDimensions(layout,2),this.makePlot(g,layout)}else this.displayError("No numeric fields specified")}}})}function RamaddaRadarDisplay(e,t,i){RamaddaUtil.inherit(this,new RamaddaRadialDisplay(e,t,DISPLAY_PLOTLY_RADAR,i)),RamaddaUtil.defineMembers(this,{getPlotType:function(){return"scatterpolar"}}),addRamaddaDisplay(this)}function RamaddaWindroseDisplay(e,t,i){RamaddaUtil.inherit(this,new RamaddaRadialDisplay(e,t,DISPLAY_PLOTLY_WINDROSE,i)),RamaddaUtil.defineMembers(this,{getPlotType:function(){return"barpolar"}}),addRamaddaDisplay(this)}function RamaddaDensityDisplay(e,t,i){Utils.isDefined(i.width)||(i.width=HU.px(600)),Utils.isDefined(i.height)||(i.height=HU.px(400)),RamaddaUtil.inherit(this,new RamaddaPlotlyDisplay(e,t,DISPLAY_PLOTLY_DENSITY,i)),addRamaddaDisplay(this),RamaddaUtil.defineMembers(this,{updateUIInner:function(){var e=this.filterData();if(e){var t=this.getSelectedFields(this.getData().getRecordFields()),i=this.getFieldsByType(t,"numeric");if(i.length<2)this.displayError("No numeric fields specified");else{var s=this.getColumnValues(e,i[0]),l=this.getColumnValues(e,i[1]),a={x:s.values,y:l.values,mode:"markers",name:"",marker:{color:this.getProperty("pointColor","rgb(102,0,0)"),size:parseInt(this.getProperty("markerSize","4")),opacity:.4},type:"scatter"},r={x:s.values,y:l.values,name:"density",ncontours:20,colorscale:"Hot",reversescale:!0,type:"histogram2dcontour"},o=[];this.getProperty("showDensity",!0)&&o.push(r),this.getProperty("showPoints",!0)&&o.push(a);var n={showlegend:!0,autosize:!0,margin:{t:50},hovermode:"closest",bargap:0,xaxis:{domain:[s.min,s.max],showline:this.getProperty("showLines",!0),showgrid:this.getProperty("showLines",!0),title:t[0].getLabel()},yaxis:{domain:[l.min,l.max],showline:this.getProperty("showLines",!0),showgrid:this.getProperty("showLines",!0),title:t[1].getLabel()}};this.setDimensions(n,2),this.makePlot(o,n)}}}})}function RamaddaPlotly3DDisplay(e,t,i,s){let l=new RamaddaPlotlyDisplay(e,t,i,s),a=[{label:"3D Plot"},{p:"markerSize",d:6},{p:"axisLineColor",d:"rgb(255,255,255)"},{p:"xaxisBackground",d:"rgb(200, 200, 230)"},{p:"yaxisBackground",d:COLOR_LIGHT_GRAY},{p:"zaxisBackground",d:"rgb(230, 230,200)"},{p:"chartBackground",d:"rgb(255,255,255,0)"}];defineDisplay(this,l,a,{initPlot:function(e,t){l.initPlot.call(this,e,t),t.on("plotly_click",(function(){}))},getDisplayStyle:function(){return HU.css(CSS_BORDER,HU.border(1,COLOR_LIGHT_GRAY))},get3DType:function(){return"scatter3d"},updateUIInner:function(){let e=this.filterData();if(!e)return;let t=this.getSelectedFields(this.getData().getRecordFields()),i=this.getFieldsByType(t,"numeric");if(0==i.length)return void this.displayError("No numeric fields specified");if(i.length<3)return void this.displayError("Don't have 3 numeric fields specified");this.records=e,this.xField=i[0],this.yField=i[1],this.zField=i[2];let s=this.getColumnValues(e,this.xField),l=this.getColumnValues(e,this.yField),a=this.getColumnValues(e,this.zField),r={size:+this.getMarkerSize(),color:COLOR_WHITE,opacity:.8,line:{color:"blue",width:2}},o=this.getColorByInfo(e);if(o.isEnabled()){let t=this.getColumnValues(e,o.getField());r.line.color=Utils.normalize(t.values);let i=[],s=o.getColors();s.forEach(((e,t)=>{i.push([t/s.length,e])})),i.push([1,i[i.length-1][1]]),r.line.colorscale=i,r.colorscale=i}this.trace1={name:o.isEnabled()?o.getField().getLabel():"",x:s.values,y:l.values,z:a.values,mode:"markers",marker:r,type:this.get3DType()};let n=this.getAxisLineColor(),h={scene:{xaxis:{backgroundcolor:this.getXaxisBackground(),gridcolor:n,showbackground:!0,zerolinecolor:n,title:this.xField.getLabel()},yaxis:{backgroundcolor:this.getYaxisBackground(),gridcolor:n,showbackground:!0,zerolinecolor:n,title:this.yField.getLabel()},zaxis:{backgroundcolor:this.getZaxisBackground(),gridcolor:n,showbackground:!0,zerolinecolor:n,title:this.zField.getLabel()}},margin:{l:0,r:0,b:0,t:0,pad:4},legend:{yanchor:"top",y:1,xanchor:"center",x:.5,orientation:"h"},paper_bgcolor:this.getChartBackground()};this.setDimensions(h,2),h.showLegend=!1;let d={name:"Selected",showLegend:!1,mode:"markers",type:this.get3DType(),x:[],y:[],z:[],marker:{size:this.getMarkerSize()+6,color:"red",opacity:.8,line:{color:"red",width:2}}},g=[this.trace1,d];this.makePlot(g,h),o.isEnabled()&&o.displayColorTable()},initPlot:function(e,t){l.initPlot.call(this,e,t),t.on("plotly_click",(e=>{if(e.points&&e.points.length){let t=this.records[e.points[0].pointNumber];t&&this.propagateEventRecordSelection({record:t})}}))},handleEventRecordSelection:function(e,t){l.handleEventRecordSelection.call(this,e,t);let i=t.record;if(!i)return;let s={x:[[this.xField.getValue(i)]],y:[[this.yField.getValue(i)]],z:[[this.zField.getValue(i)]]};Plotly.update(this.domId(ID_PLOT),s,{},[1])}})}function Ramadda3dmeshDisplay(e,t,i){let s;Utils.isDefined(i.width)||(i.width=HU.perc(100)),RamaddaUtil.inherit(this,s=new RamaddaPlotly3DDisplay(e,t,DISPLAY_PLOTLY_3DMESH,i)),addRamaddaDisplay(this),RamaddaUtil.defineMembers(this,{get3DType:function(){return"mesh3d"}})}function Ramadda3dscatterDisplay(e,t,i){let s;Utils.isDefined(i.width)||(i.width=HU.perc(100)),RamaddaUtil.inherit(this,s=new RamaddaPlotly3DDisplay(e,t,DISPLAY_PLOTLY_3DSCATTER,i)),addRamaddaDisplay(this),RamaddaUtil.defineMembers(this,{get3DType:function(){return"scatter3d"}})}function RamaddaSunburstDisplay(e,t,i){Utils.isDefined(i.width)||(i.width=500),Utils.isDefined(i.height)||(i.height=500);let s=new RamaddaPlotlyDisplay(e,t,DISPLAY_PLOTLY_SUNBURST,i);defineDisplay(addRamaddaDisplay(this),s,[{label:"Sunburst Display"},{p:"parentField",ex:""},{p:"labelField",ex:""},{p:"idField",ex:""},{p:"valueField",ex:""},{p:"nodeFields",ex:""},{p:"treeRoot",ex:"some label"},{p:"doTopColors",d:!0,ex:"true"},{p:"colorMap",ex:"value1:color1,value2:color2"}],{getDisplayStyle:function(){return""},updateUIInner:function(){if(!this.filterData())return;this.getFieldById(null,this.getParentField());let e=this.getFieldById(null,this.getValueField()),t=(this.getFieldById(null,this.getLabelField()),null);try{t=this.makeTree()}catch(e){return void this.setContents(this.getMessage(e.toString()))}let i=[],s=[],l=[],a=[],r=[],o=function(t){if(0==t.children.length){if(t.record){let i=t.record.getValue(e.getIndex());return t.value=i,i}return 0}let i=0;return t.children.map((e=>{i+=o(e)})),t.value=i,t.record&&t.record.setValue(e.getIndex(),i),i};e&&t.map(o),this.myRecords=[];let n=this.myRecords,h=function(t){n.push(t.record),e&&r.push(t.value),l.push(t.parent),i.push(t.id),s.push(t.label),a.push(null==t.parent?"":t.parent.id),t.children.map(h)};t.map(h);let d=this.getColorTable(!0),g=this.getDoTopColors();if(!d){let e=Utils.parseMap(this.getColorMap("Bitter-Harsh:black"));if(e){d=[];let t=0,a=["#1f77b4","#ff7f0e","#2ca02c","#d62728","#9467bd","#8c564b","#e377c2","#7f7f7f","#bcbd22","#17becf"];i.map(((i,r)=>{if(g&&null!=l[r])return;let o=e[i];o||(o=e[s[r]]),o||(t>=a.length&&(t=0),o=a[t],t++),d.push(o)}))}}let p=[{type:"sunburst",ids:i,labels:s,parents:a,outsidetextfont:{size:20,color:"#377eb8"},leaf:{opacity:.4},marker:{line:{width:1}},branchvalues:"total"}];e&&(p[0].values=r);let c={margin:{l:0,r:0,b:0,t:0},width:+this.getProperty("width"),height:+this.getProperty("height")};d&&(g?(c.sunburstcolorway=d,c.extendsunburstcolors=!0,c.extendsunburstcolorway=!0):p[0].marker.colors=d),this.makePlot(p,c)},initPlot:function(e,t){s.initPlot.call(this,e,t),t.on("plotly_sunburstclick",(e=>{this.handleSunburstClickEvent(e)}))},handleSunburstClickEvent:function(e){if(!e.points||e.points.length<=0)return;let t=e.points[0].pointNumber,i=this.myRecords[t];i&&this.propagateEventRecordSelection({record:i})}})}function RamaddaTernaryDisplay(e,t,i){let s;Utils.isDefined(i.width)||(i.width=HU.px(400)),Utils.isDefined(i.height)||(i.height=HU.px(400)),RamaddaUtil.inherit(this,s=new RamaddaPlotlyDisplay(e,t,DISPLAY_PLOTLY_TERNARY,i)),addRamaddaDisplay(this),RamaddaUtil.defineMembers(this,{updateUIInner:function(){var e=this.filterData();if(e){var t=this.getSelectedFields(this.getData().getRecordFields()),i=this.getFieldByType(t,"string");if(0!=(t=this.getFieldsByType(t,"numeric")).length)if(t.length<3)this.displayError("Don't have 3 numeric fields specified");else{for(var s=[],l=this.getColumnValues(e,t[0]),a=this.getColumnValues(e,t[1]),r=this.getColumnValues(e,t[2]),o=0;o<l.length;o++)s.push({a:100*l[o]/l.max,b:100*a[o]/a.max,c:100*r[o]/r.max,label:i?i.getLabel():"Point "+(o+1)});var n=[{type:"scatterternary",mode:"markers",a:s.map((function(e){return e.a})),b:s.map((function(e){return e.b})),c:s.map((function(e){return e.c})),text:s.map((function(e){return e.label})),marker:{symbol:100,color:"#DB7365",size:14,line:{width:2}}}],h={ternary:{sum:100,aaxis:this.makeAxis(t[0].getLabel(),0),baxis:this.makeAxis(t[1].getLabel(),45),caxis:this.makeAxis(t[2].getLabel(),-45),bgcolor:"#fff1e0"},annotations:[{showarrow:!1,text:this.getProperty("chartTitle",""),x:1,y:1.3,font:{size:15}}],paper_bgcolor:"#fff1e0"};this.setDimensions(h,2),this.makePlot(n,h)}else this.displayError("No numeric fields specified")}}})}function RamaddaDotplotDisplay(e,t,s){Utils.isDefined(s.width)||(s.width=HU.px(600)),Utils.isDefined(s.height)||(s.height=HU.px(400));let l=new RamaddaPlotlyDisplay(e,t,DISPLAY_PLOTLY_DOTPLOT,s);defineDisplay(addRamaddaDisplay(this),l,[{label:"Dotplot Display"},{p:"fields",ex:""},{p:"labelField",ex:""},{p:"lineColor",d:"rgba(156, 165, 196, 1.0)"},{p:"symbol",d:"circle",ex:"circle|circle-open|circle-dot|circle-open-dot|square|square-open|square-dot|square-open-dot|diamond|diamond-open|diamond-dot|diamond-open-dot|cross|cross-open|cross-dot|cross-open-dot|x|x-open|x-dot|x-open-dot|triangle-up|triangle-up-open|triangle-up-dot|triangle-up-open-dot|triangle-down|triangle-down-open|triangle-down-dot|triangle-down-open-dot|triangle-left|triangle-left-open|triangle-left-dot|triangle-left-open-dot|triangle-right|triangle-right-open|triangle-right-dot|triangle-right-open-dot|triangle-ne|triangle-ne-open|triangle-ne-dot|triangle-ne-open-dot|triangle-se|triangle-se-open|triangle-se-dot|triangle-se-open-dot|triangle-sw|triangle-sw-open|triangle-sw-dot|triangle-sw-open-dot|triangle-nw|triangle-nw-open|triangle-nw-dot|triangle-nw-open-dot|pentagon|pentagon-open|pentagon-dot|pentagon-open-dot|hexagon|hexagon-open|hexagon-dot|hexagon-open-dot|hexagon2|hexagon2-open|hexagon2-dot|hexagon2-open-dot|octagon|octagon-open|octagon-dot|octagon-open-dot|star|star-open|star-dot|star-open-dot|hexagram|hexagram-open|hexagram-dot|hexagram-open-dot|star-triangle-up|star-triangle-up-open|star-triangle-up-dot|star-triangle-up-open-dot|star-triangle-down|star-triangle-down-open|star-triangle-down-dot|star-triangle-down-open-dot|star-square|star-square-open|star-square-dot|star-square-open-dot|star-diamond|star-diamond-open|star-diamond-dot|star-diamond-open-dot|diamond-tall|diamond-tall-open|diamond-tall-dot|diamond-tall-open-dot|diamond-wide|diamond-wide-open|diamond-wide-dot|diamond-wide-open-dot|hourglass|hourglass-open|bowtie|bowtie-open|circle-cross|circle-cross-open|circle-x|circle-x-open|square-cross|square-cross-open|square-x|square-x-open|diamond-cross|diamond-cross-open|diamond-x|diamond-x-open|cross-thin|cross-thin-open|x-thin|x-thin-open|asterisk|asterisk-open|hash|hash-open|hash-dot|hash-open-dot|y-up|y-up-open|y-down|y-down-open|y-left|y-left-open|y-right|y-right-open|line-ew|line-ew-open|line-ns|line-ns-open|line-ne|line-ne-open|line-nw|line-nw-open|arrow-up|arrow-up-open|arrow-down|arrow-down-open|arrow-left|arrow-left-open|arrow-right|arrow-right-open|arrow-bar-up|arrow-bar-up-open|arrow-bar-down|arrow-bar-down-open|arrow-bar-left|arrow-bar-left-open|arrow-bar-right|arrow-bar-right-open|arrow|arrow-open|arrow-wide|arrow-wide-open"},{p:"dotSize",d:16},{p:"&lt;field&gt;.dotSize",ex:16},{p:"yAxisTitle"},{p:"yAxisType",ex:"log"},{p:"yAxisShowLine",d:!0},{p:"yAxisShowGrid",d:!1},{p:"xAxisTitle"},{p:"xAxisType",ex:"log"},{p:"xAxisShowGrid",d:!1},{p:"xAxisShowLine",d:!0},{p:"marginLeft",d:140},{p:"marginRight",d:40},{p:"marginBottom",d:50},{p:"marginTop",d:20},{p:"chartFill"},{p:"chartAreaFill"}],{getDisplayStyle:function(){return""},updateUIInner:function(){let e=this.filterData();if(!e)return;let t=this.getData();if(null==t)return;let s=t.getRecordFields(),l=this.getFieldById(s,this.getLabelField());l||(l=this.getFieldByType(s,"string")),l||(l=s[0]);let a=this.getFieldsByIds(null,this.getPropertyFields("",!0));if(0==a.length&&(a=this.getFieldsByType(s,"numeric")),0==a.length&&(a=this.getFieldsByType(s,"date")),0==a.length)return void this.displayError("No numeric fields specified");let r=null,o="";l&&(r=this.getColumnValues(e,l).values,o=l.getLabel());let n=this.getColorTable(!0);n||(n=["rgba(156, 165, 196, 0.95)","rgba(204,204,204,0.95)","rgba(255,255,255,0.85)","rgba(150,150,150,0.95)"]);let h=[],d=this.getColorByInfo(e),g=!1;for(i in a){let t=a[i],s=this.getDotSize(this.getProperty(t.getId()+".dotSize")),l=this.getSymbol(this.getProperty(t.getId()+".symbol")),o=this.getLineColor(this.getProperty(t.getId()+".lineColor")),p=this.getProperty(t.getId()+".color");p||(p=i>=n.length?n[0]:n[i]);let c=this.getColumnValues(e,t).values,u=null,T=null;if(this.getTooltip(null)){let t=this.getTooltipFields();t||(t=this.getFields()),T="%{text}<extra></extra>",u=e.map(((e,i)=>{let s="";return t.forEach((t=>{s+=HU.b(t.getLabel()+": ")+t.getValue(e)+HU.br()})),s}))}if(d.index>=0&&(p=[],e.map((e=>{let t=e.getData()[d.index];g=!0,p.push(d.getColor(t,e))}))),!r){r=[];for(let e=0;e<c.length;e++)r.push("Point "+(e+1))}h.push({type:"scatter",x:c,y:r,mode:"markers",name:t.getLabel(),text:u,hovertemplate:T,marker:{color:p,line:{color:o,width:1},symbol:l,size:s}})}let p=this.makeLayout({categoryorder:"array",categoryarray:r,yaxis:{autorange:"reversed",title:this.getYAxisTitle(o),type:this.getYAxisType(),showline:this.getYAxisShowLine(),showgrid:this.getYAxisShowGrid(),tickfont:{font:{color:"rgb(102, 102, 102)"}}},xaxis:{title:this.getXAxisTitle(a[i].getLabel()),type:this.getXAxisType(),showgrid:this.getXAxisShowGrid(!1),showline:this.getXAxisShowLine(!0),linecolor:"rgb(102, 102, 102)",titlefont:{font:{color:"rgb(204, 204, 204)"}},tickfont:{font:{color:"rgb(102, 102, 102)"}},autotick:!0,ticks:"outside",tickcolor:"rgb(102, 102, 102)"},margin:{l:this.getMarginLeft(),r:this.getMarginRight(40),b:this.getMarginBottom(),t:this.getMarginTop()},legend:{font:{size:10},yanchor:"middle",xanchor:"right"},paper_bgcolor:this.getChartFill(this.getProperty("chart.fill","rgb(254, 247, 234)")),plot_bgcolor:this.getChartAreaFill(this.getProperty("chartArea.fill","rgb(254, 247, 234)")),hovermode:"closest"});this.setDimensions(p,2),this.makePlot(h,p),g&&d.displayColorTable()}})}function RamaddaProfileDisplay(e,t,i){let s=new RamaddaPlotlyDisplay(e,t,DISPLAY_PLOTLY_PROFILE,i);RamaddaUtil.inherit(this,s),addRamaddaDisplay(this),this.defineProperties([{label:"Profile Properties"},{p:"indexField",d:null,ex:""},{p:"fields",d:null,ex:""},{p:"profileMode",d:"lines",ex:"lines|markers|lines+markers"},{p:"yAxisTitle",d:"Pressure- Digiquartz",ex:""},{p:"yAxisShowLine",d:"true",ex:"false"},{p:"yAxisShowGrid",d:"true",ex:"false"},{p:"xAxisTitle",d:"",ex:""},{p:"xAxisShowGrid",d:"true",ex:"false"},{p:"xAxisShowLine",d:"true",ex:"false"},{p:"yAxisReverse",d:!1,ex:"true"},{p:"setRangeFromAllValues",ex:!0},{p:"marginLeft",d:"60",ex:"60"},{p:"marginRight",d:"100",ex:"100"},{p:"marginBottom",d:"50",ex:"50"},{p:"marginTop",d:"100",ex:"100"},{p:"showLegend",d:"true",ex:"false"},{p:"legendYAnchor",d:null,ex:"top|middle|bottom"},{p:"legendXAnchor",d:null,ex:"right|center|left"},{p:"chart.fill",d:"rgb(254, 247, 234)",ex:"color"},{p:"chartArea.fill",d:"rgb(254, 247, 234)",ex:"color"},{p:"xAxis2Title",d:"Conductivity",ex:""},{p:"lineColor",d:"blue"},{p:"lineWidth",d:1},{p:"markerLineColor",d:"rgba(0,0,0,0.2)"},{p:"markerLineWidth",d:1},{p:"markerSize",d:16},{p:"symbol",d:"circle",ex:"circle|square|diamond|cross|x|triangle-up|triangle-down|pentagon|hexagon|hexagram|star|hash"},{p:"yAxisReverse",ex:!0},{p:"yAxisTitle"},{p:"yAxisShowLine",ex:!0},{p:"yAxisShowGrid",ex:!0},{p:"xAxisTitle"},{p:"xAxisShowGrid",ex:!0},{p:"xAxisShowLine",ex:!0}]),RamaddaUtil.defineMembers(this,{getDisplayStyle:function(){return""},showFieldsInDialog:function(){return!0},updateUIInner:function(){let e=this.filterData();if(!e)return;let t=this.getFieldById(null,this.getIndexField());if(null==t)return void this.setContents(this.getMessage("No indexField specified"));let i=this.getSelectedFields(this.getData().getRecordFields());if(0==i.length){let e=this.getFieldsByType(null,"numeric");e.length>0&&i.push(e[0])}if(0==i.length)return void this.setContents(this.getMessage("No fields found"));let s,l=this.getColumnValues(e,t).values,a=[];if(this.getSetRangeFromAllValues()){let e,t;this.getData().getRecords().forEach(((s,l)=>{let a=i[0].getValue(s);(0==l||a<e)&&(e=a),(0==l||a>t)&&(t=a)})),s=[e,t]}let r=NaN,o=NaN;i.forEach(((t,s)=>{let n=this.getColumnValues(e,t);r=Utils.min(n.min,r),o=Utils.max(n.max,o);let h=n.values;if(1==i.length){let e=this.indexToRecord;this.indexToRecord={};let t=[],i=[];h.forEach(((s,a)=>{isNaN(s)||(this.indexToRecord[t.length]=e[a],t.push(l[a]),i.push(s))})),l=t,h=i}let d=null,g=this.getProperty(t.getId()+".colorTable",this.getProperty("colorTable"));if(g){let s=Utils.ColorTables[g];if(s){let l=new ColorByInfo(this,i,e,null,null,s.colors,null,t);d=[],e.forEach((e=>{let t=l.getColorFromRecord(e);d.push(t)}))}}let p={y:l,x:h,type:"scatter",mode:this.getProfileMode(),name:t.getUnitLabel(),line:{color:this.getProperty("lineColor"+(s+1)),width:this.getLineWidth()},marker:{color:d,line:{color:this.getMarkerLineColor(),width:this.getMarkerLineWidth()},symbol:this.getProperty("symbol"+(s+1),this.getSymbol()),size:this.getMarkerSize()}};s>0&&(p.xaxis="x2"),a.push(p)}));let n=t.getLabel(),h={yaxis:{autorange:this.getYAxisReverse()?"reversed":null,title:this.getYAxisTitle(n),showline:this.getYAxisShowLine(!0),showgrid:this.getYAxisShowGrid(!0)},xaxis:{range:s,title:this.getXAxisTitle(i[0].getUnitLabel()),showgrid:this.getXAxisShowGrid(!0),showline:this.getXAxisShowLine(!0),linecolor:"rgb(102, 102, 102)",titlefont:{font:{color:"rgb(204, 204, 204)"}},tickfont:{font:{color:"rgb(102, 102, 102)"}},autotick:!0,ticks:"outside",tickcolor:"rgb(102, 102, 102)"},margin:{l:+this.getMarginLeft(60),r:+this.getMarginRight(100),b:+this.getMarginBottom(50),t:+this.getMarginTop(100)},legend:{font:{size:10},yanchor:this.getLegendYAnchor(),xanchor:this.getLegendXAnchor()},showlegend:this.getShowLegend(!0),paper_bgcolor:this.getProperty("chart.fill",COLOR_TRANSPARENT),plot_bgcolor:this.getProperty("chartArea.fill",COLOR_WHITE),hovermode:"closest"};if(i.length>1&&(h.xaxis2={overlaying:"x",side:"top",title:this.getProperty("xAxis2Title",i[1].getLabel()),showgrid:this.getProperty("xAxisShowGrid",!0),showline:this.getProperty("xAxisShowLine",!0),linecolor:"rgb(102, 102, 102)",titlefont:{font:{color:"rgb(204, 204, 204)"}},tickfont:{font:{color:"rgb(102, 102, 102)"}},autotick:!0,ticks:"outside",tickcolor:"rgb(102, 102, 102)"}),this.annotations){let e=h.shapes=[];this.annotations.forEach((t=>{let i=t.value,s=t.color??"red";e.push({type:"line",x0:r,x1:o,y0:i,y1:i,line:{color:s,width:2,dash:"solid"}})}))}this.setDimensions(h,2),this.makePlot(a,h),this.writePropertyDef&&console.log(this.writePropertyDef),this.writePropertyDef=null},addAnnotation:function(e){this.annotations=[e],this.updateUI(!0)},clearAnnotations:function(){this.annotations=null,this.updateUI(!0)}})}function RamaddaSplomDisplay(e,t,i){let s;Utils.isDefined(i.width)||(i.width=HU.px(600)),Utils.isDefined(i.height)||(i.height=HU.px(600)),RamaddaUtil.inherit(this,s=new RamaddaPlotlyDisplay(e,t,DISPLAY_PLOTLY_SPLOM,i)),addRamaddaDisplay(this),RamaddaUtil.defineMembers(this,{setDimensions:function(e,t){var i=parseInt(this.getProperty("width","400").replace("px","").replace("%","")),s=parseInt(this.getProperty("height","400").replace("px","").replace("%",""));e.width=i-t,e.height=s},makeAxis:function(){return{showline:!1,zeroline:!1,gridcolor:this.getProperty("gridColor","white"),ticklen:2,tickfont:{size:this.getProperty("tickFontSize",12)},titlefont:{size:this.getProperty("titleFontSize",12)}}},updateUIInner:function(){var e=this.filterData();if(e){var t,i=this.getSelectedFields(this.getData().getRecordFields());0==i.length&&(i=this.getData().getRecordFields()),this.getProperty("labels")&&(t=this.getProperty("labels").split(","));var s={type:"splom",dimensions:[],marker:{size:parseInt(this.getProperty("markerSize",5)),line:{color:this.getProperty("lineColor","white"),width:.5}}},l=this.getFieldById(i,this.getProperty("colorBy")),a=this.getProperty("colorBy");if(a){if(l=this.getFieldById(i,a)){var r=this.getColumnValues(e,l),o=this.getColorTable();o||(o=Utils.getColorTable("blue_white_red"));var n=[],h=parseFloat(this.getProperty("colorByMin",r.min)),d=parseFloat(this.getProperty("colorByMax",r.max));if(Utils.isDefined(o.min)){for(var g=[],p=0;p<o.colors.length;p++){var c=p/o.colors.length;(f=o.min+(o.max-o.min)*c)>=h&&f<=d&&g.push(o.colors[p])}o=g}o.colors&&(o=o.colors);var u=d-h,T=[];for(p=0;p<r.values.length;p++){c=((f=r.values[p])-h)/u;T.push(c)}for(p=0;p<o.length;p++){var f=p/o.length,y=(p+1)/o.length;n.push([f,o[p]]),n.push([y,o[p]])}s.marker.color=T,s.marker.colorscale=n}this.displayColorTable(o,ID_DISPLAY_BOTTOM,h,d)}var m=this.getFieldByType(i,"string");if(m){var _=this.getColumnValues(e,m).values;s.text=[];for(p=0;p<_.length;p++)s.text.push(m.getLabel()+": "+_[p])}var S=[s],A={autosize:!1,hovermode:"closest",dragmode:"select",plot_bgcolor:this.getProperty("bgColor","rgba(240,240,240, 0.95)"),margin:{l:this.getProperty("marginLeft",140),r:this.getProperty("marginRight",40),b:this.getProperty("marginBottom",50),t:this.getProperty("marginTop",20)}},I=0;for(p=0;p<i.length;p++){var b=i[p];if(b.isFieldNumeric()){var R,D=this.getColumnValues(e,b).values;R=t&&p<t.length?t[p]:b.getUnitLabel(),s.dimensions.push({label:R,values:D});var L="axis"+(0==I?"":""+(I+1));A["x"+L]=this.makeAxis(),A["y"+L]=this.makeAxis(),I++}}this.setDimensions(A,2),this.makePlot(S,A)}}})}function RamaddaPTreemapDisplay(e,t,i){Utils.isDefined(i.width)||(i.width=HU.px(400)),Utils.isDefined(i.height)||(i.height=HU.px(400)),RamaddaUtil.inherit(this,new RamaddaPlotlyDisplay(e,t,DISPLAY_PLOTLY_TREEMAP,i)),addRamaddaDisplay(this),RamaddaUtil.defineMembers(this,{updateUIInner:function(){var e=this.filterData();if(e){var t=this.getSelectedFields(this.getData().getRecordFields()),i=this.getFieldByType(t,"numeric");if(i){var s=this.getColumnValues(e,i).values,l=[],a=[],r=0,o=[],n=[],h=[],d=this.getColorTable();d.colors&&(d=d.colors);var g=Treemap.generate(s,100,100);for(var p in g){var c={type:"rect",x0:g[p][0],y0:g[p][1],x1:g[p][2],y1:g[p][3],line:{width:2},fillcolor:d[r]};l.push(c);var u={x:(g[p][0]+g[p][2])/2,y:(g[p][1]+g[p][3])/2,text:String(s[r]),showarrow:!1};a.push(u),o.push((g[p][0]+g[p][2])/2),n.push((g[p][1]+g[p][3])/2),h.push(String(s[r])),r++}var T={x:o,y:n,text:h,mode:"text",type:"scatter"},f={height:700,width:700,shapes:l,hovermode:"closest",annotations:a,xaxis:{showgrid:!1,zeroline:!1},yaxis:{showgrid:!1,zeroline:!1}};this.setDimensions(f,2),this.makePlot([T],f)}else this.displayError("No numeric field specified")}}})}function TextcountDisplay(e,t,i){let s=new RamaddaPlotlyDisplay(e,t,DISPLAY_PLOTLY_TEXTCOUNT,i);defineDisplay(addRamaddaDisplay(this),s,[{label:"Text Count Display"},{p:"patterns",ex:"foo,bar"},{p:"labels",ex:"Foo,Bar"},{p:"textField",ex:""}],{getDialogContents:function(e,t){let i=HU.div([ATTR_ID,this.getDomId("dialog_set_pattern")],"Change patterns")+HU.br()+HU.textarea("",Utils.join(this.patternList||[],"\n"),[ATTR_ID,this.getDomId("dialog_patterns"),ATTR_ROWS,"10"]);e.push("Patterns"),t.push(i),s.getDisplayDialogContents.call(this,e,t)},initDialog:function(){s.initDialog.call(this);let e=this;this.jq("dialog_set_pattern").button().click((function(){e.patterns=e.jq("dialog_patterns").val().trim().replace(/\n/g,","),e.updateUI()}))},updateUIInner:function(){let e=this.filterData();if(!e)return;let t=this.getProperty("patterns");if(null==t)return void this.setContents(this.getMessage("No patterns specified"));this.patternList=t.split(",");let i=this.getProperty("labels");if(i&&(i=i.split(",")),this.textField=this.getFieldById(null,this.getProperty("textField")),this.textField||(this.textField=this.getFieldByType(null,"string")),!this.textField)return void this.setContents(this.getMessage("No text field in data"));let s=[],l=[];this.patternList.map((e=>{s.push(0),l.push(new TextMatcher(e))}));for(var a=0;a<e.length;a++){var r=e[a],o=(r.getData(),r.getValue(this.textField.getIndex()));l.map(((e,t)=>{e.matches(o)&&s[t]++}))}let n=[{type:"bar",x:s,y:i||this.patternList,orientation:"h"}],h={margin:{l:100,r:50,b:50,t:10,padding:4}};Utils.isDefined(this.properties.height)&&(h.height=+this.properties.height),this.makePlot(n,h)},handleClickEvent:function(e){if(!e.points||e.points.length<=0)return;let t=e.points[0].pointNumber,i=this.patternList[t],s={fieldId:this.textField.getId(),value:i};this.propagateEvent(DisplayEvent.filterChanged,s)}})}function CombochartDisplay(e,t,i){let s=new RamaddaPlotlyDisplay(e,t,DISPLAY_PLOTLY_COMBOCHART,i),l=[{label:"Combo Chart"},{p:"fields",ex:""},{p:"&lt;field&gt;.axisSide",ex:"right|left"},{p:"&lt;field&gt;.axisTitle",ex:""},{p:"&lt;field&gt;.chartType",ex:"scatter|bar"},{p:"chartType",ex:"scatter|bar"},{p:"&lt;field&gt;.chartColor",ex:""},{p:"chartType",ex:""},{p:"xAxisTitle",ex:""},{p:"xAxisShowGrid",ex:""},{p:"xAxisShowLine",ex:""},{p:"legendBackground",ex:""},{p:"legendBorder",ex:""},{p:"chartBackground",ex:COLOR_LIGHT_GRAY},{p:"plotBackground",ex:""},{p:"marginLeft",ex:""},{p:"marginRight",ex:""},{p:"marginBottom",ex:""},{p:"marginTop",ex:""},{p:"chartPad",ex:""}];defineDisplay(addRamaddaDisplay(this),s,l,{updateUIInner:function(){let e=this.filterData();if(!e)return;var t={xaxis:{title:this.getProperty("xAxisTitle","Time"),showgrid:this.getProperty("xAxisShowGrid",!1),showline:this.getProperty("xAxisShowLine",!0),linecolor:"rgb(102, 102, 102)",titlefont:{font:{color:"rgb(204, 204, 204)"}},tickfont:{font:{color:"rgb(102, 102, 102)"}},autotick:!0,ticks:"outside",tickcolor:"rgb(102, 102, 102)"},legend:{font:{size:10},bgcolor:this.getProperty("legendBackground","rgba(255,255,255,0)"),bordercolor:this.getProperty("legendBorder","rgba(255,255,255,0)"),x:0,y:1},margin:{l:this.getProperty("marginLeft",50),r:this.getProperty("marginRight",50),b:this.getProperty("marginBottom",50),t:this.getProperty("marginTop",0),pad:this.getProperty("chartPad",4)},paper_bgcolor:this.getProperty("chartBackground","rgb(255,255,255,0)"),plot_bgcolor:this.getProperty("plottBackground","rgb(255,255,255,0)")};let i=this.getFieldsByIds(null,this.getPropertyFields("",!0));var s=[],l=[];e.map(((e,t)=>{l.push(e.getTime())}));let a=!0;i.map(((i,r)=>{let o=this.getColumnValues(e,i).values;var n={x:l,y:o,name:i.getLabel(),type:this.getProperty(i.getId()+".chartType",this.getProperty("chartType","scatter")),marker:{color:this.getProperty(i.getId()+".chartColor",this.getProperty("chartColor"))}};r>0&&(n.yaxis="y"+(r+1)),s.push(n);var h=r>0?"yaxis"+(r+1):"yaxis",d={title:this.getProperty(i.getId()+".axisTitle",i.getLabel()),titlefont:{color:"rgb(0,0,0)"},tickfont:{color:"rgb(0,0,0,)"},side:this.getProperty(i.getId()+".axisSide",this.getProperty("axisSide",a?"right":"left"))};r>0&&(d.overlaying="y"),t[h]=d,a=!a})),this.setDimensions(t),this.makePlot(s,t)}})}function RamaddaParcoordsDisplay(e,t,i){let s=new RamaddaPlotlyDisplay(e,t,DISPLAY_PLOTLY_PARCOORDS,i);RamaddaUtil.inherit(this,s),addRamaddaDisplay(this),RamaddaUtil.defineMembers(this,{updateUIInner:function(){var e=this.filterData();if(!e)return;let t=this.getFieldsByIds(null,this.getPropertyFields(""));if(0==t.length)return void this.displayError("No fields specified");let i=[],s=this.getProperty("maxLabelLength",200/t.length);t.map((t=>{let l=this.getColumnValues(e,t).values,a=null,r=null;if(t.isString()){let e=[],t={};a=[],r=[];let i=1;l.map((s=>{t[s]||(t[s]=i++,a.push(s),r.push(t[s])),e.push(t[s])})),l=e}let o=this.getProperty(t.getId()+".label",t.getLabel());o.length>s&&(o=o.substring(0,s-1)+"...");let n={label:o,values:l};this.getProperty(t.getId()+".constraintrange")&&(n.constraintrange=this.getProperty(t.getId()+".constraintrange").split(",")),this.getProperty(t.getId()+".tickvals")&&(n.tickvals=this.getProperty(t.getId()+".tickvals").split(",")),this.getProperty(t.getId()+".ticktext")?n.ticktext=this.getProperty(t.getId()+".ticktext").split(","):(n.ticktext=a,n.tickvals=r),i.push(n)}));this.getProperty("color","blue");let l=this.getFieldById(null,this.getProperty("colorBy")),a={},r=null,o=0,n=0;if(l){let t=this.getColumnValues(e,l);if(o=t.min,n=t.max,a.color=t.values,r=this.getColorTable(!0,null,null),r){let e=[],t=1/(r.length-1);r.map(((i,s)=>{let l=s*t;e.push([l,i])})),a.colorscale=e}}var h=[{type:"parcoords",line:a,dimensions:i}];let d={margin:{l:175,t:50,b:25}};this.setDimensions(d,2),this.makePlot(h,d),r&&this.displayColorTable(r,ID_COLORTABLE,o,n)}})}const DISPLAY_THREE_GLOBE="three_globe";addGlobalDisplayType({type:DISPLAY_THREE_GLOBE,forUser:!0,label:"3D Globe",requiresData:!0,category:CATEGORY_MAPS,tooltip:makeDisplayTooltip("3D Globe","3dglobe.png","Create interactive 3D globes")});const DISPLAY_THREE_GRID="three_grid";addGlobalDisplayType({type:DISPLAY_THREE_GRID,forUser:!1,label:"3D Grid",requiresData:!0,category:CATEGORY_CHARTS,tooltip:makeDisplayTooltip("3D Grid",null,"In development")});var ramaddaLoadedThree=!1,ramaddaLoadedThreeGlobe=!1;function RamaddaThree_Base(e,t,i,s){defineDisplay(this,new RamaddaDisplay(e,t,i,s),[],{parseInt:function(e,t){return"number"==typeof e?e:e?(e.match("rgb")&&(e=Utils.rgbToHex(e)),e.startsWith("#")&&(e=e.substring(1)),e.startsWith("0x")||(e="0x"+e),parseInt(Number(e),10)):t},getScene(){return this.scene},getControls(){return this.controls}})}function RamaddaThree_globeDisplay(e,t,i){const s="globe",l="popup",r="positionbutton",o="rotatebutton";!i.width&&i.globeWidth&&(i.width=i.globeWidth);let n={Base:{position:{x:6048899205465489e-36,y:1.832130202344028e-20,z:250},up:{x:1546799663044268e-37,y:1,z:-7328520809376114e-38}},"North America":{position:{x:-185.0051316412852,y:166.36750886777244,z:-24.391663730099083},up:{x:.6540380289233074,y:.7458336330441189,z:.12635841302550785}},"South America":{position:{x:-220.53665870332205,y:-71.90185405284046,z:93.24004264123046},up:{x:-.2051500901346411,y:.9474654144116881,z:.24540319682399764}},Europe:{position:{x:76.01040670390248,y:193.37167151814756,z:139.03170403539133},up:{x:-.286288586763548,y:.6309644429890481,z:-.7210566668247681}},Asia:{position:{x:215.9418144948879,y:118.22041784669743,z:-43.50937320632211},up:{x:-.4872587496088534,y:.8718613869731202,z:-.04936226124191964}},Africa:{position:{x:82.50264441171257,y:6.133419606337622,z:235.91459223415376},up:{x:-.005217856566188513,y:.9996943480371796,z:-.024165770738191875}},Australia:{position:{x:166.64046097372514,y:-104.10022198889281,z:-154.57716696953614},up:{x:.32825699830271454,y:.9086541300046129,z:-.25806009976525474}},Pacific:{position:{x:-50.02109926067879,y:70.1629622786457,z:-293.1352563989274},up:{x:.578136747554258,y:.8103545388010297,z:.09530699120186392}},"North Atlantic":{position:{x:-137.7219663374266,y:134.93931772927482,z:159.1352899859414},up:{x:.3485760134063413,y:.8418048847668705,z:-.4121399020482765}},"South Pole":{position:{x:0,y:-249.99925472592855,z:-.6104395794518828},up:{x:.9999999999999998,y:0,z:0}},"North Pole":{position:{x:12.435991378990524,y:249.68975620440986,z:.6097253513751638},up:{x:-.9987620026286266,y:.049743817204226284,z:.00012147100820090829}}},h=[{label:"3D Globe Attributes"},{p:"globeWidth",d:800},{p:"globeHeight",d:400},{p:"globeStyle",d:"",tt:"css for globe"},{p:"baseImage",d:"earth-blue-marble.jpg",ex:"earth-blue-marble.jpg|earth-day.jpg|earth-dark.jpg|world-boundaries.png|caida.jpg|white.png|lightblue.png|black.png"},{p:"globeBackgroundImage",ex:"night-sky.png|white.png|lightblue.png|black.png"},{p:"backgroundColor",d:"#CAE1FF",ex:"#ffffff"},{p:"initialPosition",ex:"North America|South America|Europe|Asia|Africa|Australia|South Pole|North Pole"},{p:"initialZoom",ex:"1",tt:"lower number more zoomed"},{p:"linked",ex:!0,tt:"Link location with other globes"},{p:"linkGroup",ex:"some_name",tt:"Globe groups to link with"},{p:"mapColor",d:"blue"},{p:"showGraticules",ex:!0},{p:"showAtmosphere",d:!0,ex:"false"},{p:"atmosphereColor",d:COLOR_WHITE,ex:"red"},{p:"atmosphereAltitude",d:.25,ex:.5},{p:"ambientLight",d:"ffffff",ex:"ffffff"},{p:"ambientIntensity",d:1,ex:"1"},{p:"directionalIntensity",d:1},{p:"directionalLight1",ex:"ffffff"},{p:"directionalIntensity1",ex:"0.5"},{p:"directionalPosition1",ex:"0,1,0"},{p:"directionalLight2",ex:"ffffff"},{p:"directionalIntensity2",ex:"0.5"},{p:"directionalPosition2",ex:"0,1,0"},{p:"initialAltitude",d:250,ex:500},{p:"color",d:"blue",ex:"red"},{p:"showPoints",d:!0,ex:"false"},{p:"showSpheres",ex:!0},{p:"pointRadius",d:1,ex:"1",canCache:!0},{p:"pointResolution",d:12},{p:"heightField",tt:"field to map height to"},{p:"heightMin",d:0,tt:"min height range that heightField value percent is mapped to"},{p:"heightMax",d:.5},{p:"radiusField",tt:"field to map radius to"},{p:"radiusMin",d:1},{p:"radiusMax",d:5},{p:"labelFields",tt:"fields for the label"},{p:"labelColor",d:"red",ex:"red"},{p:"labelSize",d:.5},{p:"labelDotRadius",d:.1},{p:"labelResolution",d:3},{p:"labelIncludeDot",d:!0},{p:"labelAltitude",d:.01},{p:"imageField",tt:"Field id image overlay"},{p:"latField1",tt:"Field id for segments"},{p:"lonField1",tt:"Field id for segments"},{p:"latField2",tt:"Field id for segments"},{p:"lonField2",tt:"Field id for segments"},{p:"lineWidth",d:.1},{p:"lineAltitude",d:.05},{p:"showEndPoints",d:!0},{p:"polygonField",tt:"field that holds polygons"},{p:"geojson",tt:"base layer map or used for chloropleth display",ex:"us_states.geojson|us_counties.geojson|countries.geojson|entryid|url"},{p:"polygonNameField",tt:"Field to match with the name field in the geojson map, e.g., state"},{p:"polygonAltitude",d:.01},{p:"autoRotate",ex:"true"},{p:"selectedDiv",ex:"div id to show selected record"},{p:"doPopup",d:!0,ex:"",tt:""},{p:"centerOnFilterChange",d:!0,ex:!1,tt:"Center map when the data filters change"}];const d=new RamaddaThree_Base(e,t,DISPLAY_THREE_GLOBE,i);defineDisplay(addRamaddaDisplay(this),d,h,{needsData:function(){return!0},initDisplay:function(){d.initDisplay.call(this)},dataFilterChanged:function(e){d.dataFilterChanged.call(this,e),this.getCenterOnFilterChange()&&this.filteredRecords&&0!=this.filteredRecords.length&&this.viewRecords(this.filteredRecords)},viewRecords:function(e){let t=RecordUtil.getBounds(e),i=t.south+(t.north-t.south)/2,s=t.west+(t.east-t.west)/2;isNaN(i)||isNaN(s)||this.globe.pointOfView({lat:i,lng:s,alt:1e4})},updateUI:async function(){if(!window.THREE)return ramaddaLoadedThree||(ramaddaLoadedThree=!0,Utils.importJS("//unpkg.com/three@0.160")),void setTimeout((()=>{this.updateUI()}),100);if(!window.Globe)return ramaddaLoadedThreeGlobe||(ramaddaLoadedThreeGlobe=!0,Utils.importJS("//unpkg.com/globe.gl")),void setTimeout((()=>{this.updateUI()}),100);d.updateUI.call(this),this.jq(l).hide();let e=this.filterData();if(!e)return;if(this.filteredRecords=e,this.globe||this.createGlobe(),this.imageField&&e.length>0){let t=this.imageField.getValue(e[0]);this.globe.globeImageUrl(t)}let t,i=this.getColorByInfo(e),s=this.getColor(),a=[],r=this.getFieldById(null,this.getHeightField());r&&(t=this.getColumnValues(e,r));let o,n=this.getHeightMin(),h=this.getHeightMax(),g=e=>{if(!t)return 0;let i=(r.getValue(e)-t.min)/(t.max-t.min);return n+i*(h-n)},p=this.getFieldById(null,this.getProperty("radiusField"));p&&(o=this.getColumnValues(e,p));let c=this.getRadiusMin(),u=this.getRadiusMax(),T=e=>{if(!o||!e)return this.getPointRadius();let t=(p.getValue(e)-o.min)/(o.max-o.min);return c+t*(u-c)},f=this.getProperty("labelFields");"{colorby}"==f&&(f=this.getProperty("colorBy"));let y=this.getFieldsByIds(null,f);if(y&&y.length){let t=+this.getLabelSize(1),i=[],s=this.getLabelColor();e.forEach(((e,l)=>{let a="";y.forEach(((t,i)=>{i>0&&(a+=" ");let s=String(t.getValue(e));"NaN"==s&&(s="--"),a+=s}));let r={record:e,label:a,lat:e.getLatitude(),lng:e.getLongitude(),color:s};r.labelSize=t,i.push(r)})),this.globe.labelsData(i).labelLat((e=>e.lat)).labelLng((e=>e.lng)).labelAltitude(this.getLabelAltitude()).labelText((e=>e.label)).labelColor((e=>e.color)).labelIncludeDot(this.getLabelIncludeDot()).labelDotRadius(this.getLabelDotRadius()).labelSize("labelSize").labelResolution(this.getLabelResolution())}let m=this.getFieldById(null,this.getProperty("polygonField")),_=this.getFieldById(null,this.getProperty("latField1")),S=this.getFieldById(null,this.getProperty("lonField1")),A=this.getFieldById(null,this.getProperty("latField2")),I=this.getFieldById(null,this.getProperty("lonField2"));if(_&&S&&A&&I){let t=[],l=this.getShowEndPoints();e.forEach(((e,r)=>{let o=i.getColorFromRecord(e,s);t.push({startLat:_.getValue(e),startLng:S.getValue(e),endLat:A.getValue(e),endLng:I.getValue(e),color:o,record:e}),l&&(a.push({height:0,lat:_.getValue(e),lng:S.getValue(e),color:o,radius:this.getPointRadius(),record:e}),a.push({height:0,lat:A.getValue(e),lng:I.getValue(e),color:o,radius:this.getPointRadius(),record:e}))})),this.globe.arcsData(t).arcStroke(+this.getLineWidth()).arcAltitude(this.getLineAltitude()).arcColor("color").arcDashGap(0)}else if(m){let t,i=this.getColorTable(!0,"polygonColorTable",null);this.didit;this.didit||(this.didit=!0);let l=this.getProperty("latlon",!0),r=[],o=0;e.forEach(((e,n)=>{let h=s;i&&(o>=i.length&&(o=0),h=i[o++]);let d=[],p={points:d,record:e,color:h};r.push(p);let c=m.getValue(e);t||[";",","].forEach((e=>{c.indexOf(e)>=0&&(t=e)}));let u=c.split(t);for(let t=0;t<u.length;t+=2){let i=parseFloat(u[t]),s=parseFloat(u[t+1]);if(!l){let e=i;i=s,s=e}if(d.push([i,s,1]),0==t||t==u.length-2){let t={lat:i,lng:s,color:h,height:g(e),radius:this.getPointRadius(),record:e};a.push(t)}}})),this.globe.pathsData(r).pathPoints((e=>e.points)).pathColor((e=>[e.color,e.color])).pathDashLength(.01).pathDashGap(0).pathPointAlt((e=>0))}else e.forEach(((e,t)=>{let l={lat:e.getLatitude(),lng:e.getLongitude(),color:i.getColorFromRecord(e,s),height:g(e),radius:T(e),record:e};a.push(l)}));let b=!1;if(a.every((e=>!Utils.isDefined(e.lat)||(b=!0,!1))),b&&a.length>0&&(this.getShowSpheres()?this.globe.customLayerData(a).customThreeObject((e=>new THREE.Mesh(new THREE.SphereBufferGeometry(e.radius),new THREE.MeshLambertMaterial({color:e.color})))).customThreeObjectUpdate(((e,t)=>{Object.assign(e.position,this.globe.getCoords(t.lat,t.lng,t.height+.01))})):this.getShowPoints()&&this.globe.pointsData(a).pointAltitude("height").pointColor("color").pointRadius("radius").pointResolution(this.getPointResolution())),this.getProperty("geojson")){this.getFieldById(null,this.getPolygonNameField())&&this.addGeojsonLayer(e)}i.isEnabled()&&i.displayColorTable(),this.getInitialPosition()||this.viewRecords(e),this.callHook("updateUI")},getScene(){return this.globe.scene()},getControls(){return this.globe.controls()},setPosition:function(e){"string"==typeof e&&e.trim().startsWith("{")&&(e=this.parsePosition(e));let t=this.getControls();e.target&&t.target.copy(e.target),e.position&&t.object.position.copy(e.position),e.up&&t.object.up.copy(e.up),e.zoom&&(t.object.zoom=e.zoom),t.object.updateProjectionMatrix(),t.object.lookAt(t.target)},getDataObjects:function(e){let t=[],i=(s,l)=>{if(s.__data&&s.__data.record){if(e){let t=s.__data.record.getId();e[t]||(e[t]=[]),e[t].push(s)}t.push(s)}s.children&&s.children.length&&s.children.forEach(i)};return this.getScene().children.forEach(i),t},listScene:function(){this.getScene().children.forEach((e=>{console.log(e.type),console.dir(e)}))},addLights:function(){if(this.addedLight)return;this.addedLight=!0,this.getScene().children.filter((e=>"DirectionalLight"==e.type||"AmbientLight"==e.type)).forEach((e=>{this.getScene().remove(e)}));let e=this.getAmbientLight();e&&"none"!=e&&this.getScene().add(new THREE.AmbientLight(this.parseInt(e),this.getAmbientIntensity()));for(let e=1;e<10;e++){let t=this.getProperty("directionalLight"+e);if(!Utils.isDefined(t)||"none"==t)continue;let i=new THREE.DirectionalLight(this.parseInt(t),this.getProperty("directionalIntensity"+e,this.getDirectionalIntensity())),s=this.getProperty("directionalPosition"+e,"0,1,0").split(",");i.position.set(+s[0],+s[1],+s[2]),this.getScene().add(i)}},createGlobe:function(){this.imageField=this.getFieldById(null,this.getImageField());let e=this,t=HU.div([ATTR_CLASS,"display-three-globe-popup",ATTR_ID,this.domId(l),ATTR_STYLE,HU.css(CSS_DISPLAY,DISPLAY_NONE,CSS_POSITION,POSITION_ABSOLUTE,CSS_LEFT,HU.perc(60),CSS_TOP,HU.px(0))],""),i=HU.div([ATTR_TITLE,"Select Position",ATTR_CLASS,CLASS_CLICKABLE,ATTR_ID,this.domId(r),ATTR_STYLE,HU.css(CSS_POSITION,POSITION_ABSOLUTE,CSS_LEFT,HU.px(10),CSS_TOP,HU.px(10),CSS_Z_INDEX,1e3)],HU.getIconImage("fa-globe")),h=HU.div([ATTR_TITLE,"Toggle rotate",ATTR_CLASS,CLASS_CLICKABLE,ATTR_ID,this.domId(o),ATTR_STYLE,HU.css(CSS_POSITION,POSITION_ABSOLUTE,CSS_LEFT,HU.px(10),CSS_TOP,HU.px(30),CSS_Z_INDEX,1e3)],HU.getIconImage("fa-rotate")),d=parseInt(this.getGlobeWidth()),g=parseInt(this.getGlobeHeight()),p=HU.div([ATTR_STYLE,HU.css(CSS_POSITION,POSITION_RELATIVE)],i+h+t+HU.div([ATTR_STYLE,HU.css(CSS_WIDTH,HU.px(d+2))+this.getGlobeStyle(""),ATTR_ID,this.domId(s)])),c=HU.center(p);c=p,this.setContents(c),this.jq(l).click((()=>{this.jq(l).hide()})),this.jq(o).click((()=>{let e=this.getControls();e.autoRotate=!e.autoRotate})),this.jq(r).click((()=>{let t="";for(a in n)t+=HU.div([ATTR_CLASS,CLASS_CLICKABLE,"place",a],a);t=HU.div([ATTR_STYLE,HU.css(CSS_MARGIN,HU.px(5))],t);let i=HU.makeDialog({content:t,anchor:this.jq(r)});i.find(HU.dotClass(CLASS_CLICKABLE)).click((function(){e.setPosition(n[$(this).attr("place")]),i.remove()}))}));let u=document.getElementById(this.domId(s));this.globe=Globe()(u),Utils.isDefined(this.getInitialZoom())&&this.globe.pointOfView({lat:0,lng:0,altitude:this.getInitialZoom()}),this.globe.onGlobeReady((()=>this.addLights())),this.globe.width(d),this.globe.height(g),this.globe.showGraticules(this.getShowGraticules()).showAtmosphere(this.getShowAtmosphere()).atmosphereColor(this.getAtmosphereColor()).atmosphereAltitude(this.getAtmosphereAltitude());let T=this.getImageUrl(this.getBaseImage());T&&this.globe.globeImageUrl(T);let f=this.getImageUrl(this.getGlobeBackgroundImage());f&&this.globe.backgroundImageUrl(f);let y=this.getBackgroundColor();y&&this.globe.backgroundColor(y);try{let e=this.jq(s).find(TAG_CANVAS);e.attr(ATTR_TABINDEX,"1"),e.mouseover((()=>{this.mouseOver=!0})),e.mouseout((()=>{this.mouseOver=!1})),u.addEventListener("keydown",(e=>{if("KeyD"!=e.code){if("KeyP"==e.code){let e=prompt("Name:");if(!e)return;let t=["x","y","z"],i="{position: {";t.forEach(((e,t)=>i+=(t>0?",":"")+e+":"+this.getControls().object.position[e])),i+="},\nup: {",t.forEach(((e,t)=>i+=(t>0?",":"")+e+":"+this.getControls().object.up[e])),i+="}}";let s='"'+e+'":'+i;console.log(s),Utils.copyToClipboard(i.replace(/\n/g,""))}if("KeyR"==e.code){let e=n[this.getInitialPosition()||"North America"]||this.getInitialPosition();e&&this.setPosition(e)}}else this.listScene()}))}catch(e){console.error("Error creating trackball control:"+e),console.log("ctor:"),console.log(THREE.TrackballControls),console.error(e.stack)}let m=this.handleMouseEvent=e=>{this.jq(l).hide();let t=e.record;t&&(this.propagateEventRecordSelection({record:t}),this.showRecord(t))};if(this.getProperty("geojson")){this.getFieldById(null,this.getPolygonNameField())||this.addGeojsonLayer()}this.globe.onPointClick(m),this.globe.onArcClick(m),this.globe.onPathClick(m),this.globe.onLabelClick(m),this.globe.onGlobeClick((()=>{this.jq(l).hide()}));this.getLinked(),this.getLinkGroup();if(this.globe.onZoom((()=>{if(!this.mouseOver)return;if(this.zooming)return;let e=Utils.displaysList.filter((e=>e.getId?e.getId()!=this.getId()&&(e.type==DISPLAY_THREE_GLOBE&&(!!e.getLinked()&&(!!e.globe&&((!e.getLinkGroup()||!this.getLinkGroup()||e.getLinkGroup()==this.getLinkGroup())&&!e.zooming)))):(console.dir(e),!1)));this.zooming=!0,e.forEach((e=>{let t=this.getControls().object.position;e.zooming=!0,e.getControls().object.position.set(t.x,t.y,t.z),e.zooming=!1})),this.zooming=!1})),this.getInitialPosition()){let e=this.getInitialPosition(),t=n[e];if(!t&&e.startsWith("{")&&(t=this.parsePosition(e)),!t)return void console.error("Unknown initial position:"+this.getInitialPosition());this.setPosition(t)}this.getAutoRotate()&&(this.getControls().autoRotate=!0),this.callHook("createGlobe")},parsePosition:function(e){if(e&&"string"==typeof e&&e.startsWith("{")){e=e.replace("position",'"position"').replace("up",'"up"').replace(/x/g,'"x"').replace(/y/g,'"y"').replace(/z/g,'"z"');try{return JSON.parse(e)}catch(t){console.err("Error parsing position:"+t+"\n"+e)}}return null},showRecord:function(e){if(this.getDoPopup()){let t=this.getRecordHtml(e,null,this.getProperty("tooltip"));return this.jq(l).html(t),void this.jq(l).show(1e3)}if(this.getSelectedDiv()){let t=this.getRecordHtml(e,null,this.getProperty("tooltip"));jqid(this.getSelectedDiv()).html(t)}},addGeojsonLayer:function(e){let t=this.getFieldById(null,this.getPolygonNameField()),i=null;e&&(i=this.getColorByInfo(e));let s=this.getMapUrl(this.getProperty("geojson")),l=this.getMapColor();$.getJSON(s,(s=>{let a={"united states of america":"united states",czechia:"czech republic",swaziland:"eswatini","south korea":"korea (rep.)","north korea":"korea (dem. people s rep.)","eq. guinea":"guinea",gambia:"gambia the",congo:"congo (rep.)","democratic republic of the congo":"congo (dem. rep.)","ivory coast":"cote d'ivoire"},r={};t&&e.forEach((e=>{let i=t.getValue(e);r[i]=e,r[i.toLowerCase()]=e,r[i.toUpperCase()]=e}));let o=0;s.features.forEach((e=>{if(!e.properties)return void(o++<50&&console.error("No properties in feature"));let t={},s=[e.properties.SOVEREIGNT,e.properties.name,e.properties.NAME,e.properties.ADMIN].filter((e=>!t[e]&&(t[e]=!0,e)));if(0==s.length)return void(o++<50&&console.log("Could not find name in feature:"+JSON.stringify(e.properties)));let l=null;s.every((e=>(l=r[e],!l))),l||s.every((e=>{let t=a[e.toLowerCase()];return!t||(l=r[t],!l)})),l&&(e.record=l,i&&i.isEnabled()&&(e.color=i.getColorFromRecord(l,null)))}));let n=this.getPolygonAltitude();if(this.globe.polygonsData(s.features).polygonStrokeColor((()=>l)).polygonCapColor((e=>e.color||COLOR_TRANSPARENT)).polygonSideColor((e=>e.color||COLOR_TRANSPARENT)).polygonAltitude(n),t){let e=this.getProperty("tooltip");Utils.stringDefined(e)&&this.globe.polygonLabel((e=>{if(!e.record)return null;let t=this.getRecordHtml(e.record,null,this.getProperty("tooltip"));return t=HU.div([ATTR_CLASS,"display-three-globe-popup",ATTR_STYLE,this.getProperty("popupStyle","")],t),t})),this.globe.onPolygonHover((e=>{this.globe.polygonAltitude((t=>t===e?.08:n))})).polygonsTransitionDuration(300)}})).fail((e=>{console.error("failed to load json:"+s)})),t&&this.globe.onPolygonClick(this.handleMouseEvent)},getImageUrl:function(e){return e?(e.startsWith("http")||e.startsWith("/")||(e=RamaddaUtil.getCdnUrl("/images/maps/")+e),e):null},getMapUrl:function(e){return e?(e.startsWith("http")||e.startsWith("/")||(e=e.trim().match(/.*[0-9a-z]+-[0-9a-z]+-[0-9a-z]+-[0-9a-z]+-[0-9a-z]+.*/)?HU.url(RamaddaUtil.getUrl(URL_ENTRY_GET),ARG_ENTRYID,e):RamaddaUtil.getCdnUrl("/resources/")+e),e):null},handleEventRecordSelection:function(e,t){d.handleEventRecordSelection.call(this,e,t);let i=t.record;this.globe.pointOfView({lat:i.getLatitude(),lng:i.getLongitude(),alt:1e4});this.globe.getCoords(t.record.getLatitude(),t.record.getLongitude());this.selectedObjects&&this.selectedObjects.forEach((e=>{e.material&&e.material.color.setHex(e.__oldcolor)}));let s={};this.getDataObjects(s);let l=s[t.record.getId()];this.selectedObjects=l,l&&l.forEach((e=>{e.material&&(e.__oldcolor=e.material.color.getHex(),e.material.color.setRGB(1,0,0))}))}})}function RamaddaThree_gridDisplay(e,t,i){const s="grid",l="popup";let a=[{label:"3D Grid Attributes"},{p:"gridWidth",d:400},{p:"gridHeight",d:400},{p:"backgroundColor",d:"#CAE1FF",ex:"#ffffff"},{p:"canvasBorder",d:HU.border(1,COLOR_LIGHT_GRAY)},{p:"shape",d:"box",ex:"box|cylinder"},{p:"heightField",tt:"field to scale height by"},{p:"heightScale",d:10,tt:"scale factor"},{p:"doPopup",d:!0,ex:"",tt:""},{p:"doImages",ex:!0}];const r=new RamaddaThree_Base(e,t,DISPLAY_THREE_GRID,i);defineDisplay(addRamaddaDisplay(this),r,a,{needsData:function(){return!0},initDisplay:function(){r.initDisplay.call(this)},dataFilterChanged:function(e){r.dataFilterChanged.call(this,e)},updateUI:async function(){if(ramaddaLoadedThree||(ramaddaLoadedThree=!0,await Utils.importJS(RamaddaUtil.getCdnUrl("/lib/three/three.min.js")),await Utils.importJS(RamaddaUtil.getCdnUrl("/lib/three/controls/OrbitControls.js"))),!window.THREE)return void setTimeout((()=>{this.updateUI()}),100);if(!THREE.OrbitControls)return void setTimeout((()=>{this.updateUI()}),100);r.updateUI.call(this),this.jq(l).hide(),this.shapes||this.createScene(),this.shapes.forEach((e=>{this.scene.remove(e)}));let e=this.filterData();if(!e)return;this.filteredRecords=e;let t=Math.ceil(Math.sqrt(e.length)),i=1.5*t;if(!this.initCamera){this.initCamera=!0;let e=i/2/Math.tan(Utils.toRadians(22.5));this.camera.position.set(0,0,2*e)}let s=1.5*-t/2,a=-s,o=s,n=a,h=this.getColorByInfo(e),d=[];if(this.colorByFields){let t=this.getFields();this.colorByFields.forEach((i=>{let s=new ColorByInfo(this,t,e,null,null,null,null,i);d.push(s)}))}RecordUtil.getBounds(e);let g,p=this.getHeightScale();this.getProperty("heightField")&&(g=new SizeBy(this,this.getProperty("sizeByAllRecords",!0)?this.getData().getRecords():e,"heightField")),0==d.length&&(d=[h]),d=[h];let c=this.getDoImages(),u=this.getFieldsByType(null,"image");const T=new THREE.TextureLoader;let f=this.getShape();shapeWidth=.5;e.forEach(((e,t)=>{if(o>-s&&(n-=1.5,o=s),c){let t=new THREE.BoxGeometry(1,1,1);const i=[];u.forEach((t=>{let s=t.getValue(e);Utils.stringDefined(s)&&i.push(new THREE.MeshBasicMaterial({map:T.load(s)}))}));let s=new THREE.Mesh(t,i);s.position.x=o,s.position.y=n,this.scene.add(s),this.shapes.push(s)}else{let t,i=h.getColorFromRecord(e,null),s=new THREE.MeshLambertMaterial({color:this.parseInt(i,16711680)}),l=1;if(g){let t,i=e=>{t=e};g.getSize(e.getData(),0,i);isNaN(t)||(l+=t*l*p)}t="box"==f?new THREE.BoxGeometry(shapeWidth,shapeWidth,l):new THREE.CylinderGeometry(1,1,l,32);let a=new THREE.Mesh(t,s);"box"==f||(a.rotation.x=Utils.toRadians(90)),a.position.x=o,a.position.y=n,a.position.z=l/2,this.scene.add(a),a.__record=e,this.shapes.push(a)}o+=1.5})),h.isEnabled()&&h.displayColorTable(),this.callHook("updateUI")},addChecker:function(e){const t=1.1*e,i=(new THREE.TextureLoader).load("https://threejsfundamentals.org/threejs/resources/images/checker.png");i.wrapS=THREE.RepeatWrapping,i.wrapT=THREE.RepeatWrapping,i.magFilter=THREE.NearestFilter;const s=t/2;i.repeat.set(s,s);const l=new THREE.PlaneGeometry(t,t),a=new THREE.MeshPhongMaterial({map:i,side:THREE.DoubleSide}),r=new THREE.Mesh(l,a);this.scene.add(r)},createScene:function(){let e=HU.div([ATTR_CLASS,"display-three-globe-popup",ATTR_ID,this.domId(l),ATTR_STYLE,HU.css(CSS_DISPLAY,DISPLAY_NONE,CSS_POSITION,POSITION_ABSOLUTE,CSS_LEFT,HU.perc(60),CSS_TOP,HU.px(0))],""),t=HU.div([ATTR_STYLE,HU.css(CSS_POSITION,POSITION_RELATIVE)],e+HU.div([ATTR_STYLE,HU.css(CSS_MIN_WIDTH,HU.px(200),CSS_MIN_HEIGHT,HU.px(200)),ATTR_ID,this.domId(s)])),i=HU.center(t);this.setContents(i),this.scene=new THREE.Scene;let a=this.getGridWidth(),r=this.getGridHeight();this.aspectRatio=a/r;window.devicePixelRatio,window.devicePixelRatio;this.camera=new THREE.PerspectiveCamera(45,a/r,.1,1e3),this.camera=new THREE.OrthographicCamera(-100,100,100,-100,.1,1e3),this.camera.position.set(0,0,100);var o=new THREE.AxisHelper(1e3);this.scene.add(o),this.renderer=new THREE.WebGLRenderer({antialias:!0,alpha:!0}),this.renderer.setClearColor(this.getBackgroundColor()),this.renderer.setSize(a,r),this.controls=new THREE.OrbitControls(this.camera,this.renderer.domElement),this.controls.minDistance=0,this.controls.maxDistance=1e3,this.controls.target.set(0,0,5),this.controls.update(),this.jq(s).append(this.renderer.domElement);((e,t,i,s,l)=>{l=.01,Utils.isDefined(l)||(l=1);let a=new THREE.DirectionalLight(this.parseInt(e));a.position.set(t,i,s),this.getScene().add(a)})(16777215,-1,1,1);var n=new THREE.AmbientLight(16777215,.5);this.scene.add(n),n=new THREE.HemisphereLight(16777215,16777147,1);let h=this,d=this.jq(s).find(TAG_CANVAS);d.attr(ATTR_TABINDEX,"1"),d.css(CSS_BORDER,this.getCanvasBorder()),this.renderer.domElement.addEventListener("keydown",(e=>{if("KeyP"==e.code){let e=prompt("Name:");if(!e)return;let t=["x","y","z"],i="{position: {";t.forEach(((e,t)=>i+=(t>0?",":"")+e+":"+this.getControls().object.position[e])),i+="},\nup: {",t.forEach(((e,t)=>i+=(t>0?",":"")+e+":"+this.getControls().object.up[e])),i+="}}";Utils.copyToClipboard(i.replace(/\n/g,""))}"KeyR"==e.code&&h.controls.reset()}));if(this.renderer.domElement.addEventListener("mouseup",(e=>{if(this.jq(l).hide(),e.preventDefault(),!e.shiftKey||1!=e.which)return;let t=new THREE.Raycaster,i={x:e.offsetX/a*2-1,y:-e.offsetY/r*2+1};t.setFromCamera(i,this.camera);let s=t.intersectObjects(this.shapes,!0);if(0==s.length)return void console.log("nothing found");let o=NaN,n=null;s.forEach((e=>{(null==n||o>e.distance)&&(n=e.object,o=e.distance)}));let h=e=>e.__record?e.__record:e.parent?h(e.parent):null,d=h(n);if(d){if(this.propagateEventRecordSelection({record:d}),this.getDoPopup()){let e=this.getRecordHtml(d);return this.jq(l).html(e),void this.jq(l).show(1e3)}if(this.getSelectedDiv()){let e=this.getRecordHtml(d);jqid(this.getSelectedDiv()).html(e)}}else console.log("Could not find record")}),!1),h.renderer.render(h.scene,h.camera),this.shapes=[],!this.animating){this.animating=!0,function e(){requestAnimationFrame(e),h.controls.update(),h.shapes.forEach(((e,t)=>{})),h.renderer.render(h.scene,h.camera)}()}}})}function RamaddaXlsDisplay(e,t,i){var s="xaxis",l="yaxis",a="group",r="searchextra",o="searchheader",n="results",h="downloadurl",d="searchdiv",g="searchform",p="searchtext",c="tableholder",u="table",T="charttoolbar",f="chart";RamaddaUtil.inherit(this,new RamaddaDisplay(e,t,"xls",i)),addRamaddaDisplay(this),this.url=i.url,this.tableProps={fixedRowsTop:0,fixedColumnsLeft:0,rowHeaders:!0,colHeaders:!0,headers:null,skipRows:0,skipColumns:0},null!=i&&$.extend(this.tableProps,i),RamaddaUtil.defineMembers(this,{initDisplay:function(){this.createUI(),this.setDisplayTitle("Table Data");var e=HU.div([ATTR_ID,this.getDomId(o)])+HU.div([ATTR_ID,this.getDomId(c)])+HU.div([ATTR_ID,this.getDomId(T)])+HU.div([ATTR_ID,this.getDomId(f)]);this.setContents(e),this.loadTableData(this.url)}}),RamaddaUtil.defineMembers(this,{currentSheet:0,currentData:null,columnLabels:null,startRow:0,groupIndex:-1,xAxisIndex:-1,yAxisIndex:-1,header:null,cellSelected:function(e,t){this.startRow=e,this.jq("params-xaxis-select").attr("checked")?this.xAxisIndex=t:this.jq("params-group-select").attr("checked")?this.groupIndex=t:this.yAxisIndex=t;this.setAxisLabel(s,this.getHeading(this.xAxisIndex,!0)),this.setAxisLabel(a,this.getHeading(this.groupIndex,!0)),this.setAxisLabel(l,this.getHeading(this.yAxisIndex,!0))},getAxisLabelId:function(e){return"params-"+e+"-label"},setAxisLabel:function(e,t){e=this.getAxisLabelId(e);var i=HU.getUniqueId();t.length>25&&(t=t.substring(0,25)+"..."),""!=t.trim()&&(t=HU.span([ATTR_ID,i,ATTR_CLASS,"ramadda-tag-box"],SPACE2+t+SPACE2)),this.jq(e).html(t)},loadSheet:function(e){var t=$("[id^="+this.getDomId("sheet_")+"]"),i=jqid(this.getDomId("sheet_")+e);t.css(CSS_FONT_WEIGHT,"normal"),i.css(CSS_FONT_WEIGHT,FONT_BOLD),t.css(CSS_BORDER,HU.border(1,COLOR_LIGHT_GRAY)),i.css(CSS_BORDER,HU.border(1,"#666")),this.currentSheet=e;var s=this.sheets[e];let l;if(s&&(l=s.rows.slice(0),l.length>0&&(this.header=l[0])),l){var a=this,r={contextMenu:!0,stretchH:"all",colHeaders:!0,rowHeaders:!0,minSpareRows:1,afterSelection:function(){if(arguments.length>2){for(var e=0;e<arguments.length;e++);var t=arguments[0],i=arguments[1];a.cellSelected(t,i)}}};if($.extend(r,this.tableProps),this.tableProps.useFirstRowAsHeader){var o=l[0];r.colHeaders=o,l=l.splice(1)}for(var h=0;h<this.tableProps.skipRows;h++)l=l.splice(1);if(0==l.length)return this.displayMessage("No data found"),void this.jq(n).html("");this.jq(n).html("Found: "+l.length),r.data=l,this.currentData=l,null!=this.tableProps.headers&&(r.colHeaders=this.tableProps.headers),this.getProperty("showTable",!0)&&this.jq(u).handsontable(r)}else this.displayHtml(this.getMessage("No data"))},getDataForSheet:function(e,t){var i=this.sheets[e].rows.slice(0);if(i.length>0&&(this.header=i[0]),this.tableProps.useFirstRowAsHeader){var s=i[0];t&&(t.colHeaders=s),i=i.splice(1)}for(var l=0;l<this.tableProps.skipRows;l++)i=i.splice(1);return i},makeChart:function(e,t){if("undefined"!=typeof google){null==t&&(t={});var i=Utils.getDefined(t.xAxisIndex,this.xAxisIndex),s=Utils.getDefined(t.groupIndex,this.groupIndex),l=Utils.getDefined(t.yAxisIndex,this.yAxisIndex);if(l<0)alert("You must select a y-axis field.\n\nSelect the desired axis with the radio button.\n\nClick the column in the table to chart.");else{var a=this.currentSheet;if(void 0!==t.sheet&&(a=t.sheet),null!=(r=this.getDataForSheet(a))){for(var r=r.slice(1),o=0;o<this.startRow-1;o++)r=r.slice(1);var n=[];console.log("x:"+i+"  y:"+l+" group:"+s);for(var h=0;h<r.length;h++){var d=[];i>=0?d.push(r[h][i]):d.push(h),l>=0&&d.push(r[h][l]),n.push(d),h<2&&console.log("row:"+d)}r=n;for(h=0;h<r.length;h++)for(var g=r[h],p=0;p<g.length;p++){var c=g[p]+"";g[p]=parseFloat(c.trim())}var u=this.getHeading(i,!0),T=this.getHeading(l,!0);this.getHeading(s,!0);this.columnLabels=[u,T];var y=null!=this.columnLabels?this.columnLabels:["Field 1","Field 2"];r.splice(0,0,y);var m=google.visualization.arrayToDataTable(r),_={};$.extend(_,{legend:{position:"top"}}),null!=this.header&&(i>=0&&(_.hAxis={title:this.header[i]}),l>=0&&(_.vAxis={title:this.header[l]}));var S=HU.getUniqueId(),A=[ATTR_ID,S];"scatterplot"==e&&(A.push(ATTR_STYLE),A.push(HU.css(CSS_WIDTH,HU.px(450),CSS_HEIGHT,HU.px(450)))),this.jq(f).append(HU.div(A)),"barchart"==e?(_.chartArea={left:75,top:10,height:"60%",width:"95%"},_.orientation="horizontal",this.chart=new google.visualization.BarChart(document.getElementById(S))):"table"==e?this.chart=new google.visualization.Table(document.getElementById(S)):"motion"==e?this.chart=new google.visualization.MotionChart(document.getElementById(S)):"scatterplot"==e?(_.chartArea={left:50,top:30,height:400,width:400},_.legend="none",_.axisTitlesPosition="in",this.chart=new google.visualization.ScatterChart(document.getElementById(S))):($.extend(_,{lineWidth:1}),_.chartArea={left:75,top:10,height:"60%",width:"95%"},this.chart=new google.visualization.LineChart(document.getElementById(S))),null!=this.chart&&this.chart.draw(m,_)}else this.jq(f).html("There is no data")}}else this.jq(f).html("No google chart available")},addNewChartListener:function(e,t){var i=this;jqid(e+"-"+t).button().click((function(e){console.log("make chart:"+t),i.makeChart(t)}))},makeSheetButton:function(e,t){var i=this;jqid(e).button().click((function(e){i.loadSheet(t)}))},clear:function(){this.jq(f).html(""),this.startRow=0,this.groupIndex=-1,this.xAxisIndex=-1,this.yAxisIndex=-1,this.setAxisLabel(a,""),this.setAxisLabel(s,""),this.setAxisLabel(l,"")},getHeading:function(e,t){if(e<0)return"";if(null!=this.header&&e>=0&&e<this.header.length){var i=this.header[e];if((i=i.trim()).length>0)return i}return t?"Field "+(e+1):""},showTableData:function(e){var t=this;this.data=e,this.sheets=this.data.sheets,this.columns=e.columns;for(var i="",s=0;s<this.sheets.length;s++){var l=this.getDomId("sheet_"+s);i+=HU.div([ATTR_ID,l,ATTR_CLASS,"ramadda-xls-button-sheet"],this.sheets[s].name),i+="\n"}var a='<table width=100% style="max-width:1000px;" > ';this.sheets.length,a+="<tr valign=top>",this.sheets.length>1&&(a+=HU.td([ATTR_WIDTH,140],HU.div([ATTR_CLASS,"ramadda-xls-buttons"],i)));var f=HU.getUniqueId(),y=this.getProperty("tableWidth",""),m=this.getProperty("tableHeight","500px"),_="";""!=y&&(_+=HU.css(CSS_WIDTH,y)),_+=HU.css(CSS_HEIGHT,m),_+=HU.css(CSS_OVERFLOW,OVERFLOW_AUTO),a+=HU.td([],HU.div([ATTR_ID,this.getDomId(u),ATTR_CLASS,"ramadda-xls-table",ATTR_STYLE,_])),a+=HU.close(TAG_TR,TAG_TABLE);for(var S="",A=["barchart","linechart","scatterplot"],I=0;I<A.length;I++)S+=HU.div([ATTR_ID,f+"-"+A[I],ATTR_CLASS,"ramadda-xls-button"],"Make "+A[I]),S+=SPACE;if(S+=SPACE,S+=HU.div([ATTR_ID,this.getDomId("removechart"),ATTR_CLASS,"ramadda-xls-button"],"Clear Charts"),S+=HU.p(),S+=HU.open(TAG_FORM),S+="Fields: ",S+='<input type=radio checked name="param" id="'+this.getDomId("params-yaxis-select")+'"> y-axis:&nbsp;'+HU.div([ATTR_ID,this.getDomId("params-yaxis-label"),ATTR_STYLE,HU.css(CSS_BORDER_BOTTOM,HU.border(1,COLOR_LIGHT_GRAY,"dotted"),CSS_MIN_WIDTH,HU.em(10),CSS_DISPLAY,DISPLAY_INLINE_BLOCK)],""),S+=SPACE3,S+='<input type=radio  name="param" id="'+this.getDomId("params-xaxis-select")+'"> x-axis:&nbsp;'+HU.div([ATTR_ID,this.getDomId("params-xaxis-label"),ATTR_STYLE,HU.css(CSS_BORDER_BOTTOM,HU.border(1,COLOR_LIGHT_GRAY,"dotted"),CSS_MIN_WIDTH,HU.em(10),CSS_DISPLAY,DISPLAY_INLINE_BLOCK)],""),S+=SPACE3,S+='<input type=radio  name="param" id="'+this.getDomId("params-group-select")+'"> group:&nbsp;'+HU.div([ATTR_ID,this.getDomId("params-group-label"),ATTR_STYLE,HU.css(CSS_BORDER_BOTTOM,HU.border(1,COLOR_LIGHT_GRAY,"dotted"),CSS_MIN_WIDTH,HU.em(10),CSS_DISPLAY,DISPLAY_INLINE_BLOCK)],""),S+=HU.close(TAG_FORM),this.getProperty("showSearch",!0)){var b=HU.div([ATTR_STYLE,HU.css(CSS_DISPLAY,DISPLAY_INLINE_BLOCK),ATTR_ID,this.getDomId(n)],""),R=HU.div([ATTR_STYLE,HU.css(CSS_DISPLAY,DISPLAY_INLINE_BLOCK),ATTR_ID,this.getDomId(h)]),D=HU.div([ATTR_ID,this.getDomId(d),ATTR_CLASS,"ramadda-xls-search-form"]),L="";if(L+=HU.openTag(TAG_FORM,["action","#",ATTR_ID,this.getDomId(g)]),L+=HU.image(icon_tree_closed,[ATTR_ID,this.getDomId("search_open")]),L+="\n",L+=HU.input(p,this.jq(p).val(),[ATTR_SIZE,60,ATTR_ID,this.getDomId(p),ATTR_PLACEHOLDER,"Search"]),L+="<input type=submit name='' style='display:none;'>",L+=HU.openTag(TAG_DIV,[ATTR_ID,this.getDomId(r),ATTR_CLASS,"ramadda-xls-search-extra"],""),this.columns){var U=HU.openTag(TAG_TABLE,[ATTR_CLASS,CLASS_FORMTABLE]);for(I=0;I<this.columns.length;I++){l="table_"+(E=this.columns[I]).name;var C=HU.input(l,this.jq(l).val(),[ATTR_ID,this.getDomId(l),ATTR_PLACEHOLDER,"Search"]);U+=HU.formEntry(E.name.replace("_"," ")+":",C)}L+=U+=HU.closeTag(TAG_TABLE)}if(this.searchFields){for(U=HU.openTag(TAG_TABLE,[ATTR_CLASS,CLASS_FORMTABLE]),I=0;I<this.searchFields.length;I++){var E;l="table_"+(E=this.searchFields[I]).name,C=HU.input(l,this.jq(l).val(),[ATTR_ID,this.getDomId(l),ATTR_PLACEHOLDER,"Search"]);U+=HU.formEntry(E.label+":",C)}L+=U+=HU.closeTag(TAG_TABLE)}L+=HU.closeTag(TAG_DIV),L+=HU.closeTag(TAG_FORM),this.jq(o).html(HU.leftRight(D,b+" "+R)),this.jq(d).html(L),this.extraOpen||this.jq(r).hide(),this.jq("search_open").button().click((function(e){t.jq(r).toggle(),t.extraOpen=!t.extraOpen,t.extraOpen?t.jq("search_open").attr(ATTR_SRC,icon_tree_open):t.jq("search_open").attr(ATTR_SRC,icon_tree_closed)}))}this.getProperty("showTable",!0)&&(this.jq(c).html(a),S+=HU.br(),this.getProperty("showChart",!0)&&this.jq(T).html(S)),this.getProperty("showSearch",!0)&&(this.jq(g).submit((function(e){e.preventDefault(),t.loadTableData(t.url,"Searching...")})),this.jq(p).focus(),this.jq(p).select());for(I=0;I<A.length;I++)this.addNewChartListener(f,A[I]);this.jq("removechart").button().click((function(e){t.clear()}));for(s=0;s<this.sheets.length;s++){l=this.getDomId("sheet_"+s);this.makeSheetButton(l,s)}s=0;var H=/sheet=([^&]+)/g.exec(window.location.search);if(H&&(s=H[1]),this.loadSheet(s),this.defaultCharts)for(I=0;I<this.defaultCharts.length;I++){var P=this.defaultCharts[I];this.makeChart(P.type,P)}this.setAxisLabel("params-yaxis-label",this.getHeading(this.yAxisIndex,!0)),this.displayDownloadUrl()},displayMessage:function(e,t){t||(t=icon_information);var i=HU.hbox([HU.image(t,[ATTR_ALIGN,ALIGN_LEFT]),HU.inset(e,10,10,5,10)]);i=HU.div([ATTR_CLASS,"note"],i),this.jq(c).html(i)},displayDownloadUrl:function(){var e=this.lastUrl;if(null==e)return void this.jq(h).html("");e=e.replace("xls_json","media_tabular_extractsheet"),e=HU.url(e,["execute","true"]);let t=HU.span([ATTR_TITLE,"Download"],HU.getIconImage("fa-download"));this.jq(h).html(HU.href(e,t))},loadTableData:function(e,t){this.url=e,t||(t=this.getLoadingMessage()),this.displayMessage(t,icon_progress);var i=this;if((r=this.jq(p).val())&&""!=r&&(e=HU.url(e,["table.text",r])),this.columns)for(var s=0;s<this.columns.length;s++){var l="table_"+(a=this.columns[s]).name;(r=this.jq(l).val())&&(e=e+"&table."+a.name+"="+encodeURIComponent(r))}if(this.searchFields)for(s=0;s<this.searchFields.length;s++){var a,r;l="table_"+(a=this.searchFields[s]).name;(r=this.jq(l).val())&&(e=e+"&table."+a.name+"="+encodeURIComponent(r))}this.lastUrl=e;!async function(){this.loadedJS||(await Utils.importJS(RamaddaUtil.getCdnUrl("/lib/jquery.handsontable.full.min.js")),await Utils.importCSS(RamaddaUtil.getCdnUrl("/lib/jquery.handsontable.full.min.css")),this.loadedJS=!0);$.getJSON(e,(function(e){if(GuiUtils.isJsonError(e))i.displayMessage("Error: "+e.error);else try{i.showTableData(e)}catch(e){i.displayMessage("Error: "+e),this.handleError("Error:"+e,e)}})).fail((function(e,t,s){var l=t+", "+s;i.displayMessage("An error occurred: "+s),console.log("JSON error:"+l)}))}()}})}
