function AreaWidget(display){const ID_CONTAINS="mapcontains";const ID_NORTH="north";const ID_SOUTH="south";const ID_EAST="east";const ID_WEST="west";const ID_SETTINGS="mapsettings";const ID_AREA_LINK="arealink";const ID_MAP_SHOW="showmap";const ID_MAP_POPUP_WRAPPER="mappopupwrapper";const ID_MAP_POPUP="mappopup";const ID_CLEAR="mapclear";const ID_SET_LOCATION="mapsetlocation";$.extend(this,{areaContains:HU.getUrlArgument("map_contains")=="true",display:display,initHtml:function(){this.display.jq(ID_SETTINGS).click(()=>{this.showSettings();});this.display.jq(ID_MAP_SHOW).click(()=>{this.showMap();});let params={};this.map=new RepositoryMap(this.display.domId(ID_MAP_POPUP),params);this.map.setSelection(this.display.getId(),true,1);},showSettings:function(){let _this=this;let html="";html+=HU.div([CLASS,"ramadda-clickable",TITLE,"Use my location",ID,this.display.domId(ID_SET_LOCATION)],HU.getIconImage("fas fa-compass")+SPACE+"Use my location");html+=HU.div([CLASS,"ramadda-clickable",TITLE,"Clear form",ID,this.display.domId(ID_CLEAR)],HU.getIconImage("fas fa-eraser")+SPACE+"Clear form");html+=HU.div([TITLE,"Search mode: checked - contains, unchecked - overlaps"],HtmlUtils.checkbox("",[ID,this.display.getDomId(ID_CONTAINS)],this.areaContains)+HU.tag("label",[CLASS,"ramadda-clickable","for",this.display.getDomId(ID_CONTAINS)],SPACE+"Contains"));html=HU.div([STYLE,"margin:5px;"],html);this.settingsDialog=HU.makeDialog({content:html,anchor:this.display.jq(ID_SETTINGS),draggable:false,header:true});this.display.jq(ID_CONTAINS).change(function(e){_this.areaContains=$(this).is(':checked');});this.display.jq(ID_SET_LOCATION).click(()=>{this.settingsDialog.remove();this.useMyLocation();});this.display.jq(ID_CLEAR).click(()=>{this.settingsDialog.remove();this.areaClear();});},getHtml:function(){let bounds=HU.getUrlArgument("map_bounds");let n="",w="",s="",e="";if(bounds){[n,w,s,e]=bounds.split(",");}
let callback=this.display.getGet();let settings=HU.div([TITLE,"Settings",CLASS,"ramadda-clickable",ID,this.display.domId(ID_SETTINGS)],HU.getIconImage("fas fa-cog"));let showMap=HU.div([CLASS,"ramadda-clickable",ID,this.display.domId(ID_MAP_SHOW),TITLE,"Show map selector"],HtmlUtils.getIconImage("fas fa-globe"));let input=(id,place,title,v)=>{return HtmlUtils.input(id,v,["placeholder",place,ATTR_CLASS,"input display-area-input","size","5",ATTR_ID,this.display.getDomId(id),ATTR_TITLE,title]);};let areaForm=HtmlUtils.openTag(TAG_TABLE,[ATTR_CLASS,"display-area"]);areaForm+=HtmlUtils.tr([],HtmlUtils.td(["align","center"],HtmlUtils.leftCenterRight("",input(ID_NORTH," N","North",n),showMap,"20%","60%","20%")));areaForm+=HtmlUtils.tr([],HtmlUtils.td([],input(ID_WEST," W","West",w)+
input(ID_EAST," E","East",e)));areaForm+=HtmlUtils.tr([],HtmlUtils.td(["align","center"],HtmlUtils.leftCenterRight("",input(ID_SOUTH," S","South",s),settings,"20%","60%","20%")));areaForm+=HtmlUtils.closeTag(TAG_TABLE);areaForm+=HU.div([ID,this.display.domId(ID_MAP_POPUP_WRAPPER),STYLE,HU.css("display","none")],SPACE+"Shift-drag: select region. Cmd-drag: move region"+
HU.div([ID,this.display.domId(ID_MAP_POPUP),STYLE,HU.css("width","400px","height","300px")]));return areaForm;},showMap:function(){let anchor=this.display.jq(ID_MAP_SHOW);this.dialog=HU.makeDialog({contentId:this.display.domId(ID_MAP_POPUP_WRAPPER),anchor:anchor,draggable:true,header:true});this.map.selectionPopupInit();this.map.getMap().updateSize();},areaClear:function(){$("#"+this.display.getDomId(ID_NORTH)).val("");$("#"+this.display.getDomId(ID_WEST)).val("");$("#"+this.display.getDomId(ID_SOUTH)).val("");$("#"+this.display.getDomId(ID_EAST)).val("");this.display.areaClear();},useMyLocation:function(){if(navigator.geolocation){let _this=this;navigator.geolocation.getCurrentPosition(function(position){_this.setUseMyLocation(position);});}else{}},setUseMyLocation:function(position){let lat=position.coords.latitude;let lon=position.coords.longitude;let offset=5.0;if(this.display.myLocationOffset)
offset=parseFloat(this.display.myLocationOffset);$("#"+this.display.getDomId(ID_NORTH)).val(lat+offset);$("#"+this.display.getDomId(ID_WEST)).val(lon-offset);$("#"+this.display.getDomId(ID_SOUTH)).val(lat-offset);$("#"+this.display.getDomId(ID_EAST)).val(lon+offset);if(this.display.submitSearchForm)
this.display.submitSearchForm();},areaLinkClick:function(){this.linkArea=!this.linkArea;let image=root+(this.linkArea?"/icons/link.png":"/icons/link_break.png");$("#"+this.display.getDomId(ID_AREA_LINK)).attr("src",image);if(this.linkArea&&this.lastBounds){let b=this.lastBounds;$("#"+this.display.getDomId(ID_NORTH)).val(MapUtils.formatLocationValue(b.top));$("#"+this.display.getDomId(ID_WEST)).val(MapUtils.formatLocationValue(b.left));$("#"+this.display.getDomId(ID_SOUTH)).val(MapUtils.formatLocationValue(b.bottom));$("#"+this.display.getDomId(ID_EAST)).val(MapUtils.formatLocationValue(b.right));}},linkArea:false,lastBounds:null,handleEventMapBoundsChanged:function(source,args){bounds=args.bounds;this.lastBounds=bounds;if(!args.force&&!this.linkArea)return;$("#"+this.display.getDomId(ID_NORTH)).val(MapUtils.formatLocationValue(bounds.top));$("#"+this.display.getDomId(ID_WEST)).val(MapUtils.formatLocationValue(bounds.left));$("#"+this.display.getDomId(ID_SOUTH)).val(MapUtils.formatLocationValue(bounds.bottom));$("#"+this.display.getDomId(ID_EAST)).val(MapUtils.formatLocationValue(bounds.right));},setSearchSettings:function(settings){let n=this.display.getFieldValue(this.display.getDomId(ID_NORTH),null);let w=this.display.getFieldValue(this.display.getDomId(ID_WEST),null);let s=this.display.getFieldValue(this.display.getDomId(ID_SOUTH),null);let e=this.display.getFieldValue(this.display.getDomId(ID_EAST),null);settings.setAreaContains(this.areaContains);HU.addToDocumentUrl("map_contains",this.areaContains);settings.setBounds(n,w,s,e);HU.addToDocumentUrl("map_bounds",[n||"",w||"",s||"",e||""].join(","));},});}
function DateRangeWidget(display,what){const ID_DATE_START="date_start";const ID_DATE_END="date_end";let startLabel,endLabel;this.what=what||"date";if(what=="createdate"){startLabel="Create start";endLabel="Create end";}else{startLabel="Start date";endLabel="End date";}
this.baseId=this.what;RamaddaUtil.inherit(this,{display:display,initHtml:function(){$("#"+this.baseId+ID_DATE_START).datepicker({dateFormat:"yy-mm-dd"});$("#"+this.baseId+ID_DATE_END).datepicker({dateFormat:"yy-mm-dd"});},setSearchSettings:function(settings){let start=$("#"+this.baseId+ID_DATE_START).val();let end=$("#"+this.baseId+ID_DATE_END).val();HU.addToDocumentUrl(this.baseId+ID_DATE_START,Utils.stringDefined(start)?start:null);HU.addToDocumentUrl(this.baseId+ID_DATE_END,Utils.stringDefined(end)?end:null);if(this.what=="createdate")
settings.setCreateDateRange(start,end);else
settings.setDateRange(start,end);},getHtml:function(){let start=HU.getUrlArgument(this.baseId+ID_DATE_START);let end=HU.getUrlArgument(this.baseId+ID_DATE_END);let html=HtmlUtils.input(this.baseId+ID_DATE_START,start||"",[CLASS,"display-date-input","placeholder"," "+startLabel,TITLE,startLabel,ATTR_ID,this.baseId+ID_DATE_START,])+" - "+
HtmlUtils.input(this.baseId+ID_DATE_END,end||"",[CLASS,"display-date-input","placeholder"," "+endLabel,TITLE,endLabel,ATTR_ID,this.baseId+ID_DATE_END,]);return html;}});}
function DisplayAnimation(display,enabled,attrs){let dflt={};attrs=attrs||{};$.extend(dflt,attrs);const ID_RUN="animrun";const ID_NEXT="animnext";const ID_PREV="animprev";const ID_BEGIN="animbegin";const ID_END="animend";const ID_SLIDER="slider";const ID_TICKS="ticks";const ID_TOOLTIP="tooltip";const ID_SHOWALL="showall";const ID_WINDOW="window";const ID_STEP="step";const ID_SETTINGS="settings";const ID_FASTER="faster";const ID_SLOWER="slower";const ID_RESET="reset";const ID_ANIMATION_LABEL="animationlabel";const MODE_FRAME="frame";const MODE_SLIDING="sliding";$.extend(this,{display:display,enabled:enabled,targetDiv:attrs.targetDiv,baseDomId:attrs.baseDomId,labelSize:display.getProperty("animationLabelSize","12pt"),labelStyle:display.getProperty("animationLabelStyle",""),running:false,inAnimation:false,begin:null,end:null,dateMin:null,dateMax:null,dateRange:0,dateFormat:display.getProperty("animationDateFormat",display.getProperty("dateFormat","yyyymmdd")),mode:display.getProperty("animationMode","cumulative"),startAtBeginning:display.getProperty("animationStartAtBeginning",true),startAtEnd:display.getProperty("animationStartAtEnd",false),speed:parseInt(display.getProperty("animationSpeed",500)),dwell:parseInt(display.getProperty("animationDwell",1000)),getEnabled:function(){return this.enabled;},toggleAnimation:function(){this.running=!this.running;if(this.btnRun)
this.btnRun.html(HtmlUtils.getIconImage(this.running?"fa-stop":"fa-play"));if(this.running)
this.startAnimation();},getDomId:function(id){return this.domId(id);},domId:function(id){return this.display.getDomId(id+(this.baseDomId?this.baseDomId:""));},jq:function(id){return this.display.jq(id+(this.baseDomId?this.baseDomId:""));},init:function(dateMin,dateMax,records){let debug=false;if(debug)
console.log("animation.init:"+dateMin+" "+dateMax+" "+(records?"#records:"+records.length:"no records"));let _this=this;this.records=records;this.dateMin=dateMin;this.dateMax=dateMax;this.begin=this.dateMin;this.end=this.dateMax;if(!this.dateMin)return;this.dates=[];let seen={};records.every(r=>{if(!seen[r.getDate()]){seen[r.getDate()]=true;this.dates.push(r.getDate());}
return true;});this.dates.sort(function(a,b){return a.getTime()-b.getTime();});this.dateRange=this.dateMax.getTime()-this.dateMin.getTime();this.steps=parseFloat(this.display.getProperty("animationSteps",60));this.setWindow();this.frameIndex=0;if(!this.display.getProperty("animationStartShowAll",false)){this.resetRange();}
let sliderValues=this.mode!=MODE_FRAME?[this.begin.getTime(),this.end.getTime()]:[this.begin.getTime()];let tooltipFunc={mouseleave:function(e){if(_this.tooltip)
_this.tooltip.hide();},mousemove:function(e){if(!_this.tooltip)return;if(e.offsetX>=0){let parentWidth=_this.tooltip.parent().width();let parentLeft=_this.tooltip.parent().offset().left;let percent=(e.pageX-parentLeft)/parentWidth;let dttm=new Date(_this.dateMin.getTime()+percent*_this.dateRange);dttm=_this.formatAnimationDate(dttm,_this.tooltipDateFormat);if(!_this.makeSlider){dttm+="<br>+/-:zoom";}
_this.tooltip.html(dttm);_this.tooltip.show();_this.tooltip.position({of:e.target,my:"left top",at:"left+"+e.offsetX+" bottom",collision:"fit fit"});}}};if(this.makeSlider){let slider=this.jq(ID_SLIDER).slider({range:_this.mode!=MODE_FRAME,min:_this.dateMin.getTime(),max:_this.dateMax.getTime(),values:sliderValues,slide:function(event,ui){_this.stopAnimation();_this.setSliderValues(ui.values);_this.updateLabels();},stop:function(event,ui){_this.stopAnimation();_this.setSliderValues(ui.values);_this.dateRangeChanged(true);}});this.jq(ID_SLIDER).on(tooltipFunc);}else{this.jq(ID_TICKS).on(tooltipFunc);}
this.updateTicks();if(debug)console.log("animation.init-3");this.updateLabels();if(debug)console.log("animation.init-done");},resetRange:function(){if(this.startAtEnd){this.begin=this.dateMax;this.end=this.dateMax;if(this.mode==MODE_FRAME){this.frameIndex=this.dates.length-1;}}else if(this.startAtBeginning){this.begin=this.dateMin;this.end=new Date(this.begin.getTime()+this.window);}
if(this.mode==MODE_FRAME){this.end=this.begin;}},setWindow:function(){let window=this.display.getProperty("animationWindow");let step=this.display.getProperty("animationStep",window);if(window){this.window=this.getMillis(window);}else if(this.steps>0){this.window=this.dateRange/this.steps;}
if(step){this.step=this.getMillis(step);}else{this.step=this.window;}},timeMap:{century:1000*60*60*24*365*100,centuries:1000*60*60*24*365*100,decade:1000*60*60*24*365*10,halfdecade:1000*60*60*24*365*5,year:1000*60*60*24*365*1,month:1000*60*60*24*31,week:1000*60*60*24*7,day:1000*60*60*24*1,hour:1000*60*60,hour:1000*60,second:1000},getMillis:function(window){window=window.trim();let cnt=1;let unit="day";let toks=window.match("^([0-9]+)(.*)");if(toks){cnt=+toks[1];unit=toks[2].trim();}else{toks=window.match("(^[0-9]+)$");if(toks){unit="minute";cnt=+toks[1];}else{unit=window;}}
let scale=1;unit=unit.toLowerCase().trim();if(this.timeMap[unit]){scale=this.timeMap[unit];}else{if(unit.endsWith("s"))
unit=unit.substring(0,unit.length-1);if(this.timeMap[unit]){scale=this.timeMap[unit];}else{console.log("Unknown unit:"+unit);}}
return cnt*scale;},getIndex:function(){return this.frameIndex;},getBeginTime:function(){return this.begin;},handleEventAnimationChanged(args){this.begin=args.begin;this.end=args.end;this.stopAnimation();this.applyAnimation();},setSliderValues:function(v){let debug=false;if(debug)
console.log(this.display.type+" animation.setSliderValues");if(this.mode!=MODE_FRAME){this.begin=new Date(v[0]);this.end=new Date(v[1]);}else{let sliderDate=new Date(v[0]);let closest=this.dates[0];let dist=0;let closestIdx=0;this.dates.forEach((d,idx)=>{if(Math.abs(d.getTime()-sliderDate.getTime())<Math.abs(closest.getTime()-sliderDate.getTime())){closest=d;closestIdx=idx;}});this.begin=this.end=closest;this.frameIndex=closestIdx;}},handleEventRecordHighlight:function(source,args){let element=$("#"+this.display.getId()+"-"+args.record.getId());if(this.ticks)
this.ticks.removeClass("display-animation-tick-highlight");if(args.highlight){element.addClass("display-animation-tick-highlight");}else{element.removeClass("display-animation-tick-highlight");}},makeControls:function(){this.tickHeight=this.display.getProperty("animationHeight","15px");this.makeSlider=this.display.getProperty("animationMakeSlider",true);let buttons="";let showButtons=this.display.getProperty("animationShowButtons",true);let showSlider=display.getProperty("animationShowSlider",true);if(showButtons){let short=display.getProperty("animationWidgetShort",false);buttons+=HtmlUtils.span([ID,this.getDomId(ID_SETTINGS),TITLE,"Settings"],HtmlUtils.getIconImage("fas fa-cog"));if(!short)
buttons+=HtmlUtils.span([ID,this.getDomId(ID_BEGIN),TITLE,"Go to beginning"],HtmlUtils.getIconImage("fa-fast-backward"));buttons+=HtmlUtils.span([ID,this.getDomId(ID_PREV),TITLE,"Previous"],HtmlUtils.getIconImage("fa-step-backward"));if(!short)
buttons+=HtmlUtils.span([ID,this.getDomId(ID_RUN),TITLE,"Run/Stop"],HtmlUtils.getIconImage("fa-play"));buttons+=HtmlUtils.span([ID,this.getDomId(ID_NEXT),TITLE,"Next"],HtmlUtils.getIconImage("fa-step-forward"));if(!short)
buttons+=HtmlUtils.span([ID,this.getDomId(ID_END),TITLE,"Go to end"],HtmlUtils.getIconImage("fa-fast-forward"));}
if(showButtons){buttons+=HtmlUtils.span([ID,this.getDomId(ID_ANIMATION_LABEL),CLASS,"display-animation-label",STYLE,this.labelStyle+HU.css("font-size",this.labelSize)]);}else{buttons+=HtmlUtils.div([ID,this.getDomId(ID_ANIMATION_LABEL),CLASS,"display-animation-label",STYLE,this.labelStyle+HU.css("text-align","center","font-size",this.labelSize)]);}
buttons=HtmlUtils.div([CLASS,"display-animation-buttons"],buttons);if(showSlider){let style=HU.css("height",this.tickHeight)+display.getProperty("animationSliderStyle","");let tooltip=HU.div([ID,this.getDomId(ID_TOOLTIP),CLASS,"display-animation-tooltip"],"");let tickContainerStyle=HU.css("height",this.tickHeight);if(!this.makeSlider){tickContainerStyle+=HU.css("background","efefef","border","1px solid #aaa");}
if(!this.makeSlider){style+=HU.css("cursor","move");}
buttons+=HtmlUtils.div([CLASS,"display-animation-slider",STYLE,style,ID,this.getDomId(ID_SLIDER)],tooltip+HtmlUtils.div([STYLE,tickContainerStyle,CLASS,"display-animation-ticks","tabindex","0",ID,this.getDomId(ID_TICKS)]));}
this.html=HtmlUtils.div([STYLE,this.display.getProperty("animationStyle")],buttons);if(this.display.getProperty("animationShow",true)){if(this.targetDiv)this.targetDiv.append(this.html);else this.jq(ID_TOP_LEFT).append(this.html);}
if(!this.makeSlider){let _this=this;this.jq(ID_TICKS).mouseenter(function(event){$(this).focus();});this.lastKeyTime=0;let ticks=this.jq(ID_TICKS);ticks.mousedown(function(e){_this.mouseIsDown=true;let parentOffset=$(this).parent().offset();_this.mouseX=e.pageX-parentOffset.left;});ticks.mousemove(function(e){if(!_this.mouseIsDown)return;var parentOffset=$(this).parent().offset();var relX=e.pageX-parentOffset.left;let range=_this.dateMax.getTime()-_this.dateMin.getTime();let width=$(this).width();let dx=(_this.mouseX-relX);var parentOffset=$(this).parent().offset();_this.mouseX=e.pageX-parentOffset.left;if(dx==0)return;let dt=range*dx/width
if(!_this.originaDateMin){_this.originaDateMin=_this.dateMin;_this.originaDateMax=_this.dateMax;}
_this.dateMin=new Date(_this.dateMin.getTime()+dt);_this.dateMax=new Date(_this.dateMax.getTime()+dt);let t1=new Date();_this.updateTicks();let t2=new Date();_this.updateLabels();});ticks.mouseup(function(e){_this.mouseIsDown=false;});ticks.keypress(function(event){let now=new Date();let diff=now.getTime()-_this.lastKeyTime;_this.lastKeyTime=now.getTime();if(event.which==43)
_this.zoom(true);else if(event.which==45)
_this.zoom(false);else if(event.which==61)
_this.zoomReset();});this.jq(ID_TICKS).bind('xwheel',function(e){$(this).focus();if(e.originalEvent.deltaY<0){let range=_this.dateMax.getTime()-_this.dateMin.getTime();let newRange=range*0.9;let diff=range-newRange;_this.dateMin=new Date(_this.dateMin.getTime()+diff);_this.dateMax=new Date(_this.dateMax.getTime()-diff);_this.updateTicks();_this.updateLabels();}else if(e.originalEvent.deltaY>0){}else{}
e.stopPropagation();e.stopImmediatePropagation();e.preventDefault();});}
if(this.display.getProperty("animationTooltipShow",false)){this.tooltip=this.jq(ID_TOOLTIP);this.tooltipDateFormat=this.display.getProperty("animationTooltipDateFormat");}
let _this=this;this.jq(ID_SETTINGS).button().click(function(){let window=_this.display.getProperty("animationWindow");let step=_this.display.getProperty("animationStep",window);let clazz="ramadda-hoverable ramadda-clickable";let html=HU.div([ID,_this.domId(ID_FASTER),TITLE,"Faster",CLASS,clazz],"Faster")+
HU.div([ID,_this.domId(ID_SLOWER),TITLE,"Slower",CLASS,clazz],"Slower")+
HU.div([ID,_this.domId(ID_RESET),TITLE,"Reset",CLASS,clazz],"Reset")+
HU.div([ID,_this.domId(ID_SHOWALL),TITLE,"Show all",CLASS,clazz],"Show all");if(window){html+=HU.div([TITLE,"Window, e.g., 1 week, 2 months, 3 days, 2 weeks, etc"],"Window:<br>"+SPACE2+HU.input("",window,[ID,_this.domId(ID_WINDOW),"size","10"]));html+=HU.div([TITLE,"Step, e.g., 1 week, 2 months, 3 days, 2 weeks, etc"],"Step:<br>"+SPACE2+HU.input("",step,[ID,_this.domId(ID_STEP),"size","10"]));}
html=HU.div([STYLE,HU.css("margin","4px")],html);_this.dialog=HU.makeDialog({content:html,anchor:$(this),draggable:false,header:false});let key=(e)=>{if(Utils.isReturnKey(e)){_this.dialog.hide();_this.display.setProperty("animationWindow",_this.jq(ID_WINDOW).val());_this.display.setProperty("animationStep",_this.jq(ID_STEP).val());_this.setWindow();_this.resetRange();_this.dateRangeChanged();}};_this.jq(ID_WINDOW).keyup(key);_this.jq(ID_STEP).keyup(key);_this.jq(ID_FASTER).click(()=>{_this.dialog.hide();_this.speed=_this.speed*0.75;});_this.jq(ID_SLOWER).click(()=>{_this.dialog.hide();_this.speed=_this.speed*1.5;});_this.jq(ID_RESET).click(()=>{_this.dialog.hide();_this.speed=parseInt(_this.display.getProperty("animationSpeed",500));_this.resetRange();_this.inAnimation=false;_this.stopAnimation();_this.dateRangeChanged();});_this.jq(ID_SHOWALL).click(()=>{_this.dialog.hide();_this.begin=_this.dateMin;_this.end=_this.dateMax;_this.inAnimation=false;_this.stopAnimation();_this.dateRangeChanged();});});this.btnRun=this.jq(ID_RUN);this.btnPrev=this.jq(ID_PREV);this.btnNext=this.jq(ID_NEXT);this.btnBegin=this.jq(ID_BEGIN);this.btnEnd=this.jq(ID_END);this.label=this.jq(ID_ANIMATION_LABEL);this.btnRun.button().click(()=>{this.toggleAnimation();});this.btnBegin.button().click(()=>{let diff=this.getDiff();let fullRange=this.fullRange();this.begin=this.dateMin;if(this.mode==MODE_SLIDING){this.end=new Date(this.begin.getTime()+(fullRange?this.window:diff));}else if(this.mode==MODE_FRAME){this.frameIndex=0;this.begin=this.end=this.deltaFrame(0);}else{this.end=new Date(this.dateMin.getTime()+this.window);}
this.stopAnimation();this.dateRangeChanged();});this.btnEnd.button().click(()=>{let diff=this.getDiff();let fullRange=this.fullRange();this.end=this.dateMax;if(this.mode==MODE_SLIDING){this.begin=new Date(this.end.getTime()-(fullRange?this.window:diff));}else if(this.mode==MODE_FRAME){this.frameIndex=this.dates.length+1;this.begin=this.end=this.deltaFrame(0);}else{this.end=this.dateMax;}
this.stopAnimation();this.dateRangeChanged();});this.btnPrev.button().click(()=>{this.stopAnimation();this.doPrev();});this.btnNext.button().click(()=>{this.stopAnimation();this.doNext();});},fullRange:function(){return this.atBegin()&&this.atEnd();},atEnd:function(){return this.end.getTime()>=this.dateMax.getTime();},atBegin:function(){return this.begin.getTime()<=this.dateMin.getTime();},getDiff:function(){return this.end.getTime()-this.begin.getTime();},doPrev:function(){let diff=this.getDiff()||this.window;diff=this.window||this.getDiff();if(this.mode==MODE_SLIDING){this.begin=new Date(this.begin.getTime()-diff);if(this.begin.getTime()<this.dateMin.getTime())
this.begin=this.dateMin;this.end=new Date(this.begin.getTime()+diff);}else if(this.mode==MODE_FRAME){this.begin=this.end=this.deltaFrame(-1);}else{this.end=new Date(this.end.getTime()-this.window);if(this.end.getTime()<=this.begin.getTime()){this.end=new Date(this.begin.getTime()+this.window);}}
this.dateRangeChanged();},doNext:function(){let debug=false;let wasAtEnd=this.atEnd();if(debug)console.log("animation.doNext:"+this.mode+" atEnd="+wasAtEnd);if(this.mode==MODE_SLIDING){let window=this.window||this.getDiff();this.begin=new Date(this.begin.getTime()+this.step);this.end=new Date(this.end.getTime()+this.step);if(this.atEnd()){this.end=this.dateMax;this.begin=new Date(this.end.getTime()-window);this.inAnimation=false;this.stopAnimation();}}else if(this.mode==MODE_FRAME){this.begin=this.end=this.deltaFrame(1);if(this.running){if(wasAtEnd){if(this.display.getProperty("animationLoop",true)){setTimeout(()=>{this.begin=this.end=this.dateMin;this.frameIndex=0;this.updateUI();},this.dwell);return;}else{this.stopAnimation();}}}}else{this.end=new Date(this.end.getTime()+this.window);if(this.atEnd()){this.end=this.dateMax;this.inAnimation=false;this.stopAnimation();}}
this.dateRangeChanged();},deltaFrame:function(delta){this.frameIndex+=delta;if(!this.dates)return;if(this.frameIndex>=this.dates.length)
this.frameIndex=this.dates.length-1;else if(this.frameIndex<0)
this.frameIndex=0;return this.dates[this.frameIndex];},startAnimation:function(){if(!this.dateMax)return;if(!this.inAnimation){this.inAnimation=true;this.label.html("");if(this.mode==MODE_FRAME){this.frameIndex=0;this.begin=this.end=this.deltaFrame(0);this.display.animationStart();this.doNext();return;}
if(this.fullRange()){this.end=new Date(this.begin.getTime()+this.window);}
this.display.animationStart();}
this.doNext();},stopAnimation:function(){if(this.btnRun)
this.btnRun.html(HtmlUtils.getIconImage("fa-play"));this.running=false;},setDateRange:function(begin,end){this.begin=begin;this.end=end;this.stopAnimation();this.updateUI();},dateRangeChanged:function(skipSlider){this.applyAnimation(skipSlider);this.display.getDisplayManager().notifyEvent(DisplayEvent.animationChanged,this.display,{begin:this.begin,end:this.end});},applyAnimation:function(skipSlider){this.display.animationApply(this);this.updateUI();},setRecordListHighlight:function(recordList){this.recordListHighlight=recordList;this.updateTicks();},zoomReset:function(){if(this.originaDateMin){this.dateMax=this.originaDateMax;this.dateMin=this.originaDateMin;this.updateTicks();this.updateLabels();}},zoom:function(zoomin){let range=this.dateMax.getTime()-this.dateMin.getTime();let newRange=range*(zoomin?0.9:1.1);let diff=range-newRange;if(!this.originaDateMin){this.originaDateMin=this.dateMin;this.originaDateMax=this.dateMax;}
this.dateMin=new Date(this.dateMin.getTime()+diff);this.dateMax=new Date(this.dateMax.getTime()-diff);this.updateTicks();this.updateLabels();},updateTicks:function(){let debug=false;this.tickCount=0;if(!this.records||!this.display.getProperty("animationShowTicks",true))return;this.highlightRecords={};if(this.recordListHighlight){this.recordListHighlight.forEach(r=>{this.highlightRecords[r.getId()]=true;});}
if(debug)console.log("animation.init making ticks: #records="+records.length+" date:"+this.dateMin+" "+this.dateMax);let tickStyle=this.display.getProperty("animationTickStyle","");let ticks="";let min=this.dateMin.getTime();let max=this.dateMax.getTime();let p=0;let seenDate={};let t1=new Date();for(let i=0;i<this.records.length;i++){let record=this.records[i];let date=record.getDate().getTime();if(seenDate[date])continue;seenDate[date]=true;if(debug)console.log("\ttick:"+record.getDate());if(date<min)continue;if(date>max)continue;this.tickCount++;let perc=(date-min)/(max-min)*100;let tt=this.formatAnimationDate(record.getDate());let clazz="display-animation-tick";if(this.highlightRecords[record.getId()]){clazz+=" display-animation-tick-highlight-base ";}
ticks+=HtmlUtils.div([TITLE,"",ID,this.display.getId()+"-"+record.getId(),CLASS,clazz,STYLE,HU.css("height",this.tickHeight,'left',perc+'%')+tickStyle,TITLE,tt,RECORD_ID,record.getId()],"");}
let t2=new Date();this.jq(ID_TICKS).html(ticks);let t3=new Date();if(debug)console.log("animation.init done making ticks");let propagateHighlight=display.getProperty("animationHighlightRecord",false);let propagateSelect=display.getProperty("animationSelectRecord",true);this.ticks=this.jq(ID_TICKS).find(".display-animation-tick");let _this=this;this.display.makeTooltips(this.ticks,this.records,(open,record)=>{if(_this.display.animationLastRecordSelectTime){let now=new Date();if(now.getTime()-_this.display.animationLastRecordSelectTime.getTime()<1500){return false;}}
if(record&&propagateHighlight){if(propagateSelect){_this.display.propagateEventRecordSelection({select:false,record:null});}
this.display.handleEventRecordHighlight(this,{highlight:open,record:record,skipAnimation:true});}
return true;},null,propagateHighlight);if(propagateSelect){this.display.makeRecordSelect(this.ticks,this.display.makeIdToRecords(this.records),record=>{_this.display.animationLastRecordSelectTime=new Date();});}
let t4=new Date();},updateUI:function(skipSlider){if(!skipSlider){if(this.makeSlider){this.jq(ID_SLIDER).slider('values',0,this.begin.getTime());this.jq(ID_SLIDER).slider('values',1,this.end.getTime());}}
this.updateLabels();let windowEnd=this.end.getTime();if(windowEnd<=this.dateMax.getTime()){if(this.running){setTimeout(()=>{if(!this.running)return;this.doNext();},this.speed);}}else{this.running=false;this.inAnimation=false;if(this.btnRun)
this.btnRun.html(HtmlUtils.getIconImage("fa-play"));}},makeLabel:function(label){return HU.span([STYLE,HU.css("font-size",this.labelSize)+this.labelStyle],label);},updateLabels:function(){if(this.label){if(!this.makeSlider){this.label.html(HU.leftCenterRight(this.makeLabel(this.formatAnimationDate(this.dateMin)),this.makeLabel("# "+this.tickCount),this.makeLabel(this.formatAnimationDate(this.dateMax))));}else{if(this.mode==MODE_FRAME&&this.begin==this.end){this.label.html(this.makeLabel(this.formatAnimationDate(this.begin)));}else{this.label.html(this.makeLabel(this.formatAnimationDate(this.begin)+" - "+this.formatAnimationDate(this.end)));}}}},formatAnimationDate:function(date,format,debug){let timeZoneOffset=this.display.getProperty("timeZoneOffset");let timeZone=this.display.getProperty("timeZone");if(timeZoneOffset){if(debug)console.log("date before:"+date.toUTCString());date=Utils.createDate(date,-timeZoneOffset);if(debug)console.log("date after:"+date.toUTCString());}
let fmt=Utils.formatDateWithFormat(date,format||this.dateFormat,true);if(timeZone)return fmt+" "+timeZone;return fmt;},});}
function ColorByInfo(display,fields,records,prop,colorByMapProp,defaultColorTable,propPrefix,theField,props,lastColorBy){this.properties=props||{};if(!prop)prop="colorBy";if(!propPrefix){propPrefix=["colorBy",""];}else if(!Array.isArray(propPrefix)){propPrefix=[propPrefix];}
$.extend(this,{display:display,fieldProp:prop,fieldValue:display.getProperty(prop),propPrefix:propPrefix,colorHistory:{}});let colorByAttr=this.getProperty(prop||"colorBy",null);if(theField==null){if(prop.getId){theField=prop;}else{theField=display.getFieldById(null,colorByAttr);}}
if(theField){this.field=theField;propPrefix=[theField.getId()+".",""];colorByAttr=theField.getId();this.propPrefix.unshift(theField.getId()+".colorBy");this.propPrefix.push("colorBy");}
$.extend(this,{display:display,id:colorByAttr,fields:fields,field:theField,colorThresholdField:display.getFieldById(null,display.getProperty("colorThresholdField")),aboveColor:display.getProperty("colorThresholdAbove","red"),belowColor:display.getProperty("colorThresholdAbove","blue"),excludeZero:this.getProperty(PROP_EXCLUDE_ZERO,false),overrideRange:this.getProperty("overrideColorRange",false),inverse:this.getProperty("Inverse",false),origRange:null,origMinValue:0,origMaxValue:0,minValue:0,maxValue:0,toMinValue:0,toMaxValue:100,isString:false,stringMap:null,colorByMap:{},colorByValues:[],colorByMinPerc:this.getProperty("MinPercentile",-1),colorByMaxPerc:this.getProperty("MaxPercentile",-1),colorByOffset:0,pctFields:null,compareFields:display.getFieldsByIds(null,this.getProperty("CompareFields","")),});if(lastColorBy&&!lastColorBy.colorOverflow){}
if(this.fieldValue=="year"){let seen={};this.dates=[];records.forEach(r=>{let year=r.getDate().getUTCFullYear();if(!seen[year]){seen[year]=true;this.dates.push(year);}});this.dates.sort();this.setRange(this.dates[0],this.dates[this.dates.length-1]);}
this.convertAlpha=this.getProperty("convertColorAlpha",false);if(this.convertAlpha){if(!Utils.isDefined(this.getProperty("alphaSourceMin"))){var min=0,max=0;records.forEach((record,idx)=>{var tuple=record.getData();if(this.compareFields.length>0){this.compareFields.map((f,idx2)=>{var v=tuple[f.getIndex()];if(isNaN(v))return;min=idx==0&&idx2==0?v:Math.min(min,v);max=idx==0&&idx2==0?v:Math.max(max,v);});}else if(this.index=0){var v=tuple[this.index];if(isNaN(v))return;min=idx==0?v:Math.min(min,v);max=idx==0?v:Math.max(max,v);}});this.alphaSourceMin=min;this.alphaSourceMax=max;}else{this.alphaSourceMin=+this.getProperty("alphaSourceMin",40);this.alphaSourceMax=+this.getProperty("alphaSourceMax",80);}
this.alphaTargetMin=+this.getProperty("alphaTargetMin",0);this.alphaTargetMax=+this.getProperty("alphaTargetMax",1);}
this.convertIntensity=this.getProperty("convertColorIntensity",false);if(this.convertIntensity){if(!Utils.isDefined(this.getProperty("intensitySourceMin"))){var min=0,max=0;records.forEach((record,idx)=>{var tuple=record.getData();if(this.compareFields.length>0){this.compareFields.map((f,idx2)=>{var v=tuple[f.getIndex()];if(isNaN(v))return;min=idx==0&&idx2==0?v:Math.min(min,v);max=idx==0&&idx2==0?v:Math.max(max,v);});}else if(this.index=0){var v=tuple[this.index];if(isNaN(v))return;min=idx==0?v:Math.min(min,v);max=idx==0?v:Math.max(max,v);}});this.intensitySourceMin=min;this.intensitySourceMax=max;}else{this.intensitySourceMin=+this.getProperty("intensitySourceMin",80);this.intensitySourceMax=+this.getProperty("intensitySourceMax",40);}
this.intensityTargetMin=+this.getProperty("intensityTargetMin",1);this.intensityTargetMax=+this.getProperty("intensityTargetMax",0);}
if(this.display.percentFields!=null){this.pctFields=this.display.percentFields.split(",");}
let colors=defaultColorTable||this.display.getColorTable(true,[colorByAttr+".colorTable","colorTable"]);if(!colors&&colorByAttr){let c=this.display.getProperty(colorByAttr+".colors");if(c)colors=c.split(",");}
if(!colors){var c=this.getProperty(colorByAttr+".colors");if(c)
colors=c.split(",");}
if(!colors)
colors=this.display.getColorTable(true);this.colors=colors;if(this.hasField()&&!colors){}
if(!this.colors&&this.display.colors&&this.display.colors.length>0){this.colors=source.colors;if(this.colors.length==1&&Utils.ColorTables[this.colors[0]]){this.colors=Utils.ColorTables[this.colors[0]].colors;}}
if(this.colors==null){this.colors=Utils.ColorTables.grayscale.colors;}
if(!this.field){for(var i=0;i<fields.length;i++){var field=fields[i];if(field.getId()==this.id||("#"+(i+1))==this.id){this.field=field;}}}
if(!this.field){if(this.id=="hour")
this.timeField="hour";else if(this.id=="day")
this.timeField="day";}
if(this.field&&this.field.isString())this.isString=true;this.index=this.field!=null?this.field.getIndex():-1;this.stringMap=this.display.getColorByMap(colorByMapProp);let uniqueValues=[];let seenValue={};if(this.index>=0||this.timeField){let min=NaN;let max=NaN;records.forEach((record,idx)=>{let tuple=record.getData();let v;if(this.timeField){if(this.timeField=="hour")
v=record.getTime().getHours();else
v=record.getTime().getTime();}else{v=tuple[this.index];}
if(this.isString){if(!seenValue[v]){seenValue[v]=true;uniqueValues.push(v);}
return;}
if(this.excludeZero&&v===0){return;}
min=Utils.min(min,v);max=Utils.max(max,v);});this.minValue=min;this.maxValue=max;this.origRange=[min,max];}
if(uniqueValues.length>0){uniqueValues.sort((a,b)=>{return a.toString().localeCompare(b.toString());});uniqueValues.forEach(v=>{if(!Utils.isDefined(this.colorByMap[v])){let index=this.colorByValues.length;let color;if(this.lastColorByMap&&this.lastColorByMap[v]){color=this.lastColorByMap[v];}else{if(index>=this.colors.length){this.colorOverflow=true;index=index%this.colors.length;}
color=this.colors[index];}
this.colorByValues.push({value:v,color:color});this.colorByMap[v]=color;this.setRange(1,this.colorByValues.length,true);}});}
if(this.display.showPercent){this.setRange(0,100,true);}
var steps=this.getProperty("Steps");if(steps){this.steps=steps.split(",");}
this.colorByLog=this.getProperty("Log",false);this.colorByLog10=this.getProperty("Log10",false);this.colorByLog2=this.getProperty("Log2",false);if(this.colorByLog){this.colorByFunc=Math.log;}else if(this.colorByLog10){this.colorByFunc=Math.log10;}else if(this.colorByLog2){this.colorByFunc=Math.log2;}
this.setRange(this.getProperty("Min",this.minValue),this.getProperty("Max",this.maxValue),true);this.range=this.maxValue-this.minValue;this.toMinValue=this.getProperty("ToMin",this.toMinValue);this.toMaxValue=this.getProperty("ToMax",this.toMaxValue);this.enabled=this.timeField!=null||(this.getProperty("doColorBy",true)&&this.index>=0);this.initDisplayCalled=false;}
ColorByInfo.prototype={initDisplay:function(){this.filterHighlight=this.display.getFilterHighlight();this.initDisplayCalled=true;},getProperty:function(prop,dflt,debug){if(this.properties[prop])return this.properties[prop];if(this.debug)console.log("getProperty:"+prop);for(let i=0;i<this.propPrefix.length;i++){this.display.debugGetProperty=debug;if(this.debug)console.log("\t"+this.propPrefix[i]+prop);let v=this.display.getProperty(this.propPrefix[i]+prop);this.display.debugGetProperty=false;if(Utils.isDefined(v))return v;}
return dflt;},isEnabled:function(){return this.enabled;},displayColorTable:function(width,force,domId){if(!this.getProperty("showColorTable",true))return;if(this.compareFields.length>0){var legend="";this.compareFields.map((f,idx)=>{legend+=HtmlUtils.div([STYLE,HU.css('display','inline-block','width','15px','height','15px','background',this.colors[idx])])+" "+
f.getLabel()+" ";});let dom=this.display.jq(domId||ID_COLORTABLE);dom.html(HtmlUtils.div([STYLE,HU.css('text-align','center','margin-top','5px')],legend));}
if(!force&&this.index<0)return;if(this.stringMap){let colors=[];this.colorByValues=[];for(var i in this.stringMap){let color=this.stringMap[i];this.colorByValues.push({value:i,color:color});colors.push(color);}
this.display.displayColorTable(colors,domId||ID_COLORTABLE,this.origMinValue,this.origMaxValue,{colorByInfo:this,width:width,stringValues:this.colorByValues});}else{let colors=this.colors;if(this.getProperty("clipColorTable",true)&&this.colorByValues.length){var tmp=[];for(var i=0;i<this.colorByValues.length&&i<colors.length;i++)
tmp.push(this.colors[i]);colors=tmp;}
let cbs=this.colorByValues.map(v=>{return v;});cbs.sort((a,b)=>{return a.value.toString().localeCompare(b.value.toString());});this.display.displayColorTable(colors,domId||ID_COLORTABLE,this.origMinValue,this.origMaxValue,{colorByInfo:this,width:width,stringValues:cbs});}},resetRange:function(){if(this.origRange){this.setRange(this.origRange[0],this.origRange[1]);}},setRange:function(minValue,maxValue,force){if(!force&&this.overrideRange)return;this.origMinValue=minValue;this.origMaxValue=maxValue;if(this.colorByFunc){if(minValue<0){this.colorByOffset=-minValue;}else if(minValue==0){this.colorByOffset=1;}
minValue=this.colorByFunc(minValue+this.colorByOffset);maxValue=this.colorByFunc(maxValue+this.colorByOffset);}
this.minValue=minValue;this.maxValue=maxValue;this.range=maxValue-minValue;if(!this.origRange){this.origRange=[minValue,maxValue];}
},getValuePercent:function(v){let perc=(v-this.minValue)/this.range;if(this.inverse)perc=1-perc;return perc;},scaleToValue:function(v){let perc=this.getValuePercent(v);return this.toMinValue+(perc*(this.toMaxValue-this.toMinValue));},getColorFromRecord:function(record,dflt,checkHistory){if(!this.initDisplayCalled)this.initDisplay();if(this.filterHighlight&&!record.isHighlight(this.display)){return this.display.getProperty("unhighlightColor","#eee");}
if(this.colorThresholdField&&this.display.selectedRecord){let v=this.display.selectedRecord.getValue(this.colorThresholdField.getIndex());let v2=record.getValue(this.colorThresholdField.getIndex());if(v2>v)return this.aboveColor;else return this.belowColor;}
if(this.index>=0){let value=record.getData()[this.index];return this.getColor(value,record,checkHistory);}else if(this.timeField){let value;if(this.timeField=="hour"){value=record.getTime().getHours();}else{value=record.getTime().getTime();}
return this.getColor(value,record,checkHistory);}
if(this.fieldValue=="year"){let value=record.getDate().getUTCFullYear();return this.getColor(value,record);}
return dflt;},hasField:function(){return this.index>=0;},getColor:function(value,pointRecord,checkHistory){let c=this.getColorInner(value,pointRecord);return c;},getColorInner:function(value,pointRecord){if(!this.initDisplayCalled)this.initDisplay();if(this.filterHighlight&&pointRecord&&!pointRecord.isHighlight(this.display)){return this.display.getUnhighlightColor();}
let percent=0.5;if(this.showPercent){let total=0;let data=pointRecord.getData();for(let j=0;j<data.length;j++){let ok=this.fields[j].isNumeric()&&!this.fields[j].isFieldGeo();if(ok&&this.pctFields!=null){ok=this.pctFields.indexOf(this.fields[j].getId())>=0||this.pctFields.indexOf("#"+(j+1))>=0;}
if(ok){total+=data[j];}}
if(total!=0){percent=value/total*100;percent=(percent-this.minValue)/(this.maxValue-this.minValue);}}else{let v=value;if(this.stringMap){let color=this.stringMap[value];if(!Utils.isDefined(color)){return this.stringMap["default"];}
return color;}
if(this.isString){color=this.colorByMap[v];if(color)return color;}
let tmp=v;v+=this.colorByOffset;if(this.colorByFunc&&v>0){v=this.colorByFunc(v);}
percent=this.range?(v-this.minValue)/this.range:0.5;}
let index=0;if(this.steps){for(;index<this.steps.length;index++){if(v<=this.steps[index]){break;}}}else{index=parseInt(percent*this.colors.length);}
if(index>=this.colors.length)index=this.colors.length-1;else if(index<0)index=0;if(this.stringMap){let color=this.stringMap[value];if(!Utils.isDefined(color)){return this.stringMap["default"];}
return color;}else{return this.colors[index];}
return null;},convertColor:function(color,colorByValue){color=this.convertColorIntensity(color,colorByValue);color=this.convertColorAlpha(color,colorByValue);return color;},convertColorIntensity:function(color,colorByValue){if(!this.convertIntensity)return color;percent=(colorByValue-this.intensitySourceMin)/(this.intensitySourceMax-this.intensitySourceMin);intensity=this.intensityTargetMin+percent*(this.intensityTargetMax-this.intensityTargetMin);let result=Utils.pSBC(intensity,color);return result||color;},convertColorAlpha:function(color,colorByValue){if(!this.convertAlpha)return color;percent=(colorByValue-this.alphaSourceMin)/(this.alphaSourceMax-this.alphaSourceMin);alpha=this.alphaTargetMin+percent*(this.alphaTargetMax-this.alphaTargetMin);let result=Utils.addAlphaToColor(color,alpha);return result||color;}}
function drawSparkLine(display,dom,w,h,data,records,min,max,colorBy,attrs,margin){if(!attrs)attrs={};if(!margin)
margin={top:0,right:0,bottom:0,left:0};const INNER_WIDTH=w-margin.left-margin.right;const INNER_HEIGHT=h-margin.top-margin.bottom;const BAR_WIDTH=w/data.length;const x=d3.scaleLinear().domain([0,data.length]).range([0,INNER_WIDTH]);const y=d3.scaleLinear().domain([min,max]).range([INNER_HEIGHT,0]);const recty=d3.scaleLinear().domain([min,max]).range([0,INNER_HEIGHT]);let tt=d3.select("body").append("div").attr(CLASS,"sparkline-tooltip").style("opacity",0);const svg=d3.select(dom).append('svg').attr('width',w).attr('height',h).append('g').attr('transform','translate('+margin.left+','+margin.top+')');const line=d3.line().x((d,i)=>x(i)).y(d=>y(d));let lineColor=attrs.lineColor||display.getProperty("sparklineLineColor","#000");let barColor=attrs.barColor||display.getProperty("sparklineBarColor","MediumSeaGreen");let circleColor=attrs.circleColor||display.getProperty("sparklineCircleColor","#000");let circleRadius=attrs.circleRadius||display.getProperty("sparklineCircleRadius",1);let lineWidth=attrs.lineWidth||display.getProperty("sparklineLineWidth",1);let defaultShowEndPoints=true;let getColor=(d,i,dflt)=>{return colorBy?colorBy.getColorFromRecord(records[i],dflt):dflt;};let showBars=attrs.showBars||display.getProperty("sparklineShowBars",false);svg.append('line').attr('x1',0).attr('y1',0).attr('x2',0).attr('y2',h).attr("stroke-width",1).attr("stroke",'#ccc');svg.append('line').attr('x1',0).attr('y1',h).attr('x2',w).attr('y2',h).attr("stroke-width",1).attr("stroke",'#ccc');let getNum=n=>{if(isNaN(n))return 0;return n;};if(showBars){defaultShowEndPoints=false;svg.selectAll('.bar').data(data).enter().append('rect').attr('class','bar').attr('x',(d,i)=>getNum(x(i))).attr('y',d=>getNum(y(d))).attr('width',BAR_WIDTH).attr('height',d=>getNum(h-y(d))).attr('fill',(d,i)=>getColor(d,i,barColor)).style("cursor","pointer")}
if(attrs.showLines||display.getProperty("sparklineShowLines",true)){svg.selectAll('line').data(data).enter().append("line").attr('x1',(d,i)=>{return x(i)}).attr('y1',(d,i)=>{return y(d)}).attr('x2',(d,i)=>{return x(i+1)}).attr('y2',(d,i)=>{return y(i<data.length-1?data[i+1]:data[i])}).attr("stroke-width",lineWidth).attr("stroke",(d,i)=>{if(isNaN(d))return"rgba(0,0,0,0)";return getColor(d,i,lineColor)}).style("cursor","pointer");}
if(attrs.showCircles||display.getProperty("sparklineShowCircles",false)){svg.selectAll('circle').data(data).enter().append("circle").attr('r',(d,i)=>{return isNaN(d)?0:circleRadius}).attr('cx',(d,i)=>{return getNum(x(i))}).attr('cy',(d,i)=>{return getNum(y(d))}).attr('fill',(d,i)=>getColor(d,i,circleColor)).style("cursor","pointer");}
if(attrs.showEndpoints||display.getProperty("sparklineShowEndPoints",defaultShowEndPoints)){let fidx=0;while(isNaN(data[fidx])&&fidx<data.length)fidx++;let lidx=data.length-1;while(isNaN(data[lidx])&&lidx>=0)lidx--;svg.append('circle').attr('r',attrs.endPointRadius||display.getProperty("sparklineEndPointRadius",2)).attr('cx',x(fidx)).attr('cy',y(data[fidx])).attr('fill',attrs.endPoint1Color||display.getProperty("sparklineEndPoint1Color")||getColor(data[0],0,display.getProperty("sparklineEndPoint1Color",'steelblue')));svg.append('circle').attr('r',attrs.endPointRadius||display.getProperty("sparklineEndPointRadius",2)).attr('cx',x(lidx)).attr('cy',y(data[lidx])).attr('fill',attrs.endPoint2Color||display.getProperty("sparklineEndPoint2Color")||getColor(data[data.length-1],data.length-1,display.getProperty("sparklineEndPoint2Color",'tomato')));}
let _display=display;let doTooltip=display.getProperty("sparklineDoTooltip",true)||attrs.doTooltip;svg.on("click",function(){let coords=d3.mouse(this);if(records){let record=records[Math.round(x.invert(coords[0]))]
if(record)
_display.propagateEventRecordSelection({select:true,record:record});}});if(doTooltip){svg.on("mouseover",function(){if(!records)return;let coords=d3.mouse(this);let record=records[Math.round(x.invert(coords[0]))]
if(!record)return;let html=_display.getRecordHtml(record);let ele=$(dom);let offset=ele.offset().top+ele.height();let left=ele.offset().left;tt.transition().duration(200).style("opacity",.9);tt.html(html).style("left",left+"px").style("top",offset+"px");}).on("mouseout",function(d){tt.transition().duration(500).style("opacity",0);});}}
function drawDots(display,dom,w,h,data,range,colorBy,attrs,margin){attrs=attrs||{};margin=margin||{top:0,right:0,bottom:0,left:0};const INNER_WIDTH=w-margin.left-margin.right;const INNER_HEIGHT=h-margin.top-margin.bottom;const x=d3.scaleLinear().domain([range.minx,range.maxx]).range([0,INNER_WIDTH]);const y=d3.scaleLinear().domain([range.miny,range.maxy]).range([INNER_HEIGHT,0]);let tt=d3.select("body").append("div").attr(CLASS,"sparkline-tooltip").style("opacity",0);const svg=d3.select(dom).append('svg').attr('width',w).attr('height',h).append('g')
let circleColor=attrs.circleColor||display.getProperty("sparklineCircleColor","#000");let circleRadius=attrs.circleRadius||display.getProperty("sparklineCircleRadius",1);let getColor=(d,i,dflt)=>{return"#000"
};console.log(JSON.stringify(range));let getNum=n=>{if(isNaN(n))return 0;return n;};let recordMap={};svg.selectAll('circle').data(data).enter().append("circle").attr('r',(d,i)=>{return circleRadius}).attr('cx',(d,i)=>{return getNum(x(d.x))}).attr('cy',(d,i)=>{return getNum(y(d.y))}).attr('fill',(d,i)=>{return getColor(d,i,circleColor)}).attr(RECORD_ID,(d,i)=>{return"XX";recordMap[d.record.getId()]=d.record;return d.record.getId()}).style("cursor","pointer");let _display=display;let doTooltip=display.getProperty("sparklineDoTooltip",true)||attrs.doTooltip;svg.on("click",function(){let coords=d3.mouse(this);if(records){let record=records[Math.round(x.invert(coords[0]))]
if(record)
_display.propagateEventRecordSelection({select:true,record:record});}});if(doTooltip){svg.on("mouseover",function(){d3.select(this).attr("r",10).style("fill","red");let ele=$(dom);ele.attr('r',20);console.log("mouse over:"+d3.select(this).attr(RECORD_ID));return
let record=recordMap[ele.attr(RECORD_ID)];console.log(ele.attr(RECORD_ID)+" "+record);let coords=d3.mouse(this);if(!record)return;let html=_display.getRecordHtml(record);let offset=ele.offset().top+ele.height();let left=ele.offset().left;tt.transition().duration(200).style("opacity",.9);tt.html(html).style("left",left+"px").style("top",offset+"px");}).on("mouseout",function(d){tt.transition().duration(500).style("opacity",0);});}}
function drawPieChart(display,dom,width,height,array,min,max,colorBy,attrs){if(!attrs)attrs={};let margin=Utils.isDefined(attrs.margin)?attrs.margin:4;let colors=attrs.pieColors||Utils.ColorTables.cats.colors;let radius=Math.min(width,height)/2-margin
let svg=d3.select(dom).append("svg").attr("width",width).attr("height",height).append("g").attr("transform","translate("+width/2+","+height/2+")");let data={};array.forEach(tuple=>{data[tuple[0]]=tuple[1];})
let color=d3.scaleOrdinal().domain(data).range(colors)
let pie=d3.pie().value(function(d){return d.value;})
let data_ready=pie(d3.entries(data))
svg.selectAll('whatever').data(data_ready).enter().append('path').attr('d',d3.arc().innerRadius(0).outerRadius(radius)).attr('fill',function(d){return(color(d.data.key))}).attr("stroke","black").style("stroke-width","1px").style("opacity",0.7)}
function SizeBy(display,records){this.display=display;if(!records)records=display.filterData();let pointData=this.display.getPointData();let fields=pointData.getRecordFields();$.extend(this,{id:this.display.getProperty("sizeBy"),minValue:0,maxValue:0,field:null,index:-1,isString:false,stringMap:{},});let sizeByMap=this.display.getProperty("sizeByMap");if(sizeByMap){let toks=sizeByMap.split(",");for(let i=0;i<toks.length;i++){let toks2=toks[i].split(":");if(toks2.length>1){this.stringMap[toks2[0]]=toks2[1];}}}
for(let i=0;i<fields.length;i++){let field=fields[i];if(field.getId()==this.id||("#"+(i+1))==this.id){this.field=field;if(field.isString())this.isString=true;}}
this.index=this.field!=null?this.field.getIndex():-1;if(!this.isString&&this.field){let col=this.display.getColumnValues(records,this.field);this.minValue=col.min;this.maxValue=col.max;if(Utils.isDefined(this.display.getProperty("sizeByMin"))){this.minValue=+this.display.getProperty("sizeByMin",0)}
if(Utils.isDefined(this.display.getProperty("sizeByMax"))){this.maxValue=+this.display.getProperty("sizeByMax",0)}}
if(this.display.getProperty("sizeBySteps")){this.steps=[];this.display.getProperty("sizeBySteps").split(",").forEach(tuple=>{let[value,size]=tuple.split(":");this.steps.push({value:+value,size:+size});});}
this.radiusMin=parseFloat(this.display.getProperty("sizeByRadiusMin",-1));this.radiusMax=parseFloat(this.display.getProperty("sizeByRadiusMax",-1));this.offset=0;this.sizeByLog=this.display.getProperty("sizeByLog",false);this.origMinValue=this.minValue;this.origMaxValue=this.maxValue;this.maxValue=Math.max(this.minValue,this.maxValue);if(this.sizeByLog){this.func=Math.log;if(this.minValue<1){this.offset=1-this.minValue;}
this.minValue=this.func(this.minValue+this.offset);this.maxValue=this.func(this.maxValue+this.offset);}}
SizeBy.prototype={getMaxSize:function(){return this.getSizeFromValue(this.origMaxValue);},getSize:function(values,dflt,func){if(this.index<=0){return dflt;}
let value=values[this.index];let size=this.getSizeFromValue(value,func,false);return size;},getSizeFromValue:function(value,func,debug){if(this.steps){if(value<=this.steps[0].value)return this.steps[0].size;for(let i=1;i<this.steps.length;i++){if(value>this.steps[i-1].value&&value<=this.steps[i].value)return this.steps[i].size;}
return this.steps[this.steps.length-1].size;}
if(this.isString){let size;if(Utils.isDefined(this.stringMap[value])){let v=parseInt(this.stringMap[value]);size=v;}else if(Utils.isDefined(this.stringMap["*"])){let v=parseInt(this.stringMap["*"]);size=v;}
if(isNaN(size))size=this.radiusMin;if(func)func(NaN,size);return size;}else{let denom=this.maxValue-this.minValue;let v=value+this.offset;if(this.func)v=this.func(v);let percent=(denom==0?NaN:(v-this.minValue)/denom);let size;if(this.radiusMax>=0&&this.radiusMin>=0){size=Math.round(this.radiusMin+percent*(this.radiusMax-this.radiusMin));}else{size=6+parseInt(15*percent);}
if(debug)console.log("min:"+this.minValue+" max:"+this.maxValue+" value:"+value+" v:"+v+" size:"+size);if(isNaN(size))size=this.radiusMin;if(func)func(percent,size);return size;}},getLegend:function(cnt,bg,vert){let html="";if(this.index<0)return"";if(this.steps){this.steps.forEach(step=>{let dim=step.size*2+"px";let v=step.value;html+=HU.div([CLASS,"display-size-legend-item"],HU.center(HU.div([STYLE,HU.css("height",dim,"width",dim,"background-color",bg||"#bbb","border-radius","50%")]))+v);if(vert)html+="<br>";});}else{for(let i=0;i<=cnt;i++){let v=this.origMinValue+i/cnt*(this.origMaxValue-this.origMinValue);let size=this.getSizeFromValue(v,null,false);if(isNaN(size)||size==0)continue;v=this.display.formatNumber(v);let dim=size*2+"px";html+=HU.div([CLASS,"display-size-legend-item"],HU.center(HU.div([STYLE,HU.css("height",dim,"width",dim,"background-color",bg||"#bbb","border-radius","50%")]))+v);if(vert)html+="<br>";}}
return HU.div([CLASS,"display-size-legend"],html);}}
function Annotations(display,records){this.display=display;if(!records)records=this.display.filterData();let pointData=this.display.getPointData();let fields=pointData.getRecordFields();this.labelField=this.display.getFieldById(null,this.display.getProperty("annotationLabelField"));this.fields=this.display.getFieldsByIds(null,this.display.getProperty("annotationFields"));let prop=this.display.getProperty("annotations");if(prop)this.fields=[];this.map={}
let add=(record,index,annotation)=>{annotation.record=record;if(!this.map[index])
this.map[index]=[];this.map[index].push(annotation);if(!this.map[record.getId()])
this.map[record.getId()]=[];this.map[record.getId()].push(annotation);}
if(prop){this.annotations=[];this.legend="";let labelCnt=0;let toks=prop.split(";");this.hasRange=false;for(let i=0;i<toks.length;i++){let toks2=toks[i].split(",");if(toks2.length<2)continue;let index=toks2[0].trim();let label=toks2[1];if(label.trim()==""){labelCnt++;label=""+labelCnt;}
let desc=toks2.length<2?"":toks2[2];let url=toks2.length<3?null:toks2[3];let isDate=false;let annotation={label:label,description:desc,toString:function(){return this.label+" "+this.description;}};this.annotations.push(annotation);if(index.match(/^[0-9]+$/)){index=parseFloat(index);}else{let index2=null;if(index.indexOf(":")>=0){index2=index.split(":")[1];index=index.split(":")[0];}
if(index=="today"){index=new Date();}else{index=Utils.parseDate(index,false);}
if(index2){this.hasRange=true;if(index2=="today"){index2=Utils.formatDateYYYYMMDD(new Date());}else{index2=Utils.parseDate(index2,false);}
annotation.index2=index2.getTime();}
isDate=true;}
annotation.index=isDate?index.getTime():index;let legendLabel=desc;if(url!=null){legendLabel=HU.href(url,legendLabel,["target","_annotation"]);}
this.legend+=HU.b(label)+":"+legendLabel+" ";}
for(let aidx=0;aidx<this.annotations.length;aidx++){let annotation=this.annotations[aidx];let minIndex=null;let minRecord=null;let minDistance=null;for(let rowIdx=0;rowIdx<records.length;rowIdx++){let ele=records[rowIdx];let record=ele.record?ele.record:ele;let row=this.display.getDataValues(records[rowIdx]);let index=row[0];if(index.v)index=index.v;if(record)index=record.getTime();let distance=Number.MAX_VALUE;if(annotation.index2){if(index>=annotation.index&&index<=annotation.index2){distance=0;}else{distance=Math.min(Math.abs(annotation.index-index),Math.abs(annotation.index2-index));}
if(distance==0){add(record,rowIdx,annotation);}}else{distance=Math.abs(annotation.index-index);}
if(minIndex==null){minIndex=rowIdx;minDistance=distance;minRecord=record;}else{if(distance<minDistance){minIndex=rowIdx;minDistance=distance;minRecord=record;}}}
if(minIndex!=null){add(minRecord,minIndex,annotation);}}}}
Annotations.prototype={isEnabled:function(){return this.annotations!=null;},getAnnotations:function(){return this.annotations;},getAnnotationsFor:function(rowIdx){return this.map[rowIdx];},getAnnotationFromDate:function(date){let distance=Number.MAX_VALUE;let minAnnotation=null;let minDistance=null;let time=date.getTime();for(let aidx=0;aidx<this.annotations.length;aidx++){let annotation=this.annotations[aidx];if(annotation.index2){if(time>=annotation.index&&time<=annotation.index2){return annotation;}}else{distance=Math.abs(annotation.index-time);if(minAnnotation==null){minAnnotation=annotation;minDistance=distance;}else{if(distance<minDistance){minAnnotation=annotation;minDistance=distance;}}}}
return minAnnotation;},getLegend:function(){return this.legend;},getShowLegend:function(){return this.display.getProperty("showAnnotationsLegend");},hasFields:function(){return this.fields&&this.fields.length>0;},getFields:function(){return this.fields;}}
let Gfx={gridData:function(gridId,fields,records,args){if(!args)args={};if(isNaN(args.cellSize)||args.cellSize==null)
args.cellSize=args.cellSizeX;if(isNaN(args.cellSizeX)||args.cellSizeX==null)
args.cellSizeX=args.cellSize;if(isNaN(args.cellSizeY)||args.cellSizeY==null)
args.cellSizeY=args.cellSizeX;let opts={shape:"circle",color:"blue",w:800,h:400,scale:1,cellSize:2,cellSizeX:2,cellSizeY:2,operator:"average"}
$.extend(opts,args);let id=HtmlUtils.getUniqueId();opts.scale=+opts.scale;let scale=opts.scale;opts.w*=opts.scale;opts.h*=opts.scale;$(document.body).append('<canvas style="display:none;" id="'+id+'" width="'+opts.w+'" height="'+opts.h+'"></canvas>');let canvas=document.getElementById(id);let ctx=canvas.getContext("2d");let cnt=0;let earthWidth=args.bounds.east-args.bounds.west;let earthHeight=args.bounds.north-args.bounds.south;ctx.font=opts.cellFont||"8pt Arial;"
let gradient=ctx.createLinearGradient(0,0,0,canvas.height);gradient.addColorStop(0,'white');gradient.addColorStop(1,'red');let scaleX=(lat,lon)=>{return Math.floor(opts.w*(lon-args.bounds.west)/earthWidth);};let scaleY;if(opts.display&&opts.display.map){let n1=opts.display.map.transformLLPoint(MapUtils.createLonLat(opts.bounds.east,85));let s1=opts.display.map.transformLLPoint(MapUtils.createLonLat(opts.bounds.east,-85));let n2=opts.display.map.transformLLPoint(MapUtils.createLonLat(opts.bounds.east,opts.bounds.north));let s2=opts.display.map.transformLLPoint(MapUtils.createLonLat(opts.bounds.east,opts.bounds.south));scaleY=(lat,lon)=>{let pt=opts.display.map.transformLLPoint(MapUtils.createLonLat(lon,lat));let dy=n2.lat-pt.lat;let perc=dy/(n2.lat-s2.lat)
return Math.floor(perc*opts.h);};}else{scaleY=(lat,lon)=>{return Math.floor(opts.h*(args.bounds.north-lat)/earthHeight);}}
ctx.lineStyle="#000";if(opts.doHeatmap){let cols=Math.floor(opts.w/opts.cellSizeX);let rows=Math.floor(opts.h/opts.cellSizeY);let points=[];records.forEach((record,idx)=>{let lat=record.getLatitude();let lon=record.getLongitude();let x=scaleX(lat,lon);let y=scaleY(lat,lon);record[gridId+"_coordinates"]={x:x,y:y};let colorValue=0;if(opts.colorBy&&opts.colorBy.index>=0){colorValue=record.getValue(opts.colorBy.index);}
let lengthValue=0;if(opts.lengthBy&&opts.lengthBy.index>=0){lengthValue=record.getValue(opts.lengthBy.index);}
x=Math.floor(x/opts.cellSizeX);y=Math.floor(y/opts.cellSizeY);if(x<0)x=0;if(y<0)y=0;if(x>=cols)x=cols-1;if(y>=rows)y=rows-1;points.push({x:x,y:y,colorValue:colorValue,r:record});});let grid=Gfx.gridPoints(rows,cols,points,args);opts.cellSizeX=+opts.cellSizeX;opts.cellSizeY=+opts.cellSizeY;this.applyFilter(opts,grid);let mm=this.getMinMaxGrid(grid,v=>v.v);if(opts.colorBy){if(!Utils.isDefined(opts.display.getProperty("colorByMin"))){opts.colorBy.setRange(mm.min,mm.max);}
opts.colorBy.index=0;}
let countThreshold=opts.display.getProperty("hmCountThreshold",opts.operator=="count"?1:0);let glyph=new Glyph(opts.display,scale,fields,records,{type:"rect",canvasWidth:canvas.width,canvasHeight:canvas.height,colorByInfo:opts.colorBy,width:opts.cellSizeX,height:opts.cellSizeY,stroke:false,pos:"c",dx:opts.cellSizeX/2,dy:opts.cellSizeY/2,},"");opts.shape="rect";for(let rowIdx=0;rowIdx<rows;rowIdx++){let row=grid[rowIdx];for(let colIdx=0;colIdx<cols;colIdx++){let cell=row[colIdx];let v=cell.v;if(isNaN(v))continue;let x=colIdx*opts.cellSizeX;let y=rowIdx*opts.cellSizeY;if(cell.count>=countThreshold)
glyph.draw(opts,canvas,ctx,x,y,{colorValue:cell.v,col:colIdx,row:rowIdx,cell:cell,grid:grid});}}}else{records.sort((a,b)=>{return b.getLatitude()-a.getLatitude()});let glyphs=[];let cnt=1;while(cnt<11){let attr=opts.display.getProperty("glyph"+(cnt++));if(!attr)
continue;glyphs.push(new Glyph(opts.display,scale,fields,records,{canvasWidth:canvas.width,canvasHeight:canvas.height},attr));}
glyphs.forEach(glyph=>{records.forEach((record,idx)=>{let lat=record.getLatitude();let lon=record.getLongitude();let x=scaleX(lat,lon);let y=scaleY(lat,lon);record[gridId+"_coordinates"]={x:x,y:y};let colorValue=opts.colorBy?record.getData()[opts.colorBy.index]:null;let lengthValue=opts.lengthBy?record.getData()[opts.lengthBy.index]:null;glyph.draw(opts,canvas,ctx,x,y,{colorValue:colorValue,lengthValue:lengthValue,record:record},idx<10);});});}
let alpha=opts.display.getProperty("colorTableAlpha",-1);if(alpha>0){let image=ctx.getImageData(0,0,opts.w,opts.h);let imageData=image.data,length=imageData.length;for(let i=3;i<length;i+=4){if(imageData[i]){imageData[i]=alpha*255;}}
image.data=imageData;ctx.putImageData(image,0,0);}
let img=canvas.toDataURL("image/png");canvas.parentNode.removeChild(canvas);return img;},gridPoints:function(rows,cols,points,args){let debug=displayDebug.gridPoints;let values=[];for(let rowIdx=0;rowIdx<rows;rowIdx++){let row=[];values.push(row);for(let colIdx=0;colIdx<cols;colIdx++){row.push({v:NaN,count:0,total:0,min:NaN,max:NaN,t:""});}}
points.forEach((p,idx)=>{let cell=values[p.y][p.x];cell.min=cell.count==0?p.colorValue:Math.min(cell.min,p.colorValue);cell.max=cell.count==0?p.colorValue:Math.max(cell.max,p.colorValue);cell.count++;cell.total+=p.colorValue;});let minValue=NaN;let maxValue=NaN;let maxCount=0;let minCount=0;for(let rowIdx=0;rowIdx<rows;rowIdx++){for(let colIdx=0;colIdx<cols;colIdx++){let cell=values[rowIdx][colIdx];if(cell.count==0)continue;let v;if(args.operator=="count")
v=cell.count;else if(args.operator=="min")
v=cell.min;else if(args.operator=="max")
v=cell.max;else if(args.operator=="total")
v=cell.total;else
v=cell.total/cell.count;cell.v=v;if(!isNaN(v)){minValue=isNaN(minValue)?v:Math.min(minValue,v);maxValue=isNaN(maxValue)?v:Math.max(maxValue,v);}
maxCount=Math.max(maxCount,cell.count);minCount=minCount==0?cell.count:Math.min(minCount,cell.count);}}
if(debug)
console.log("operator:"+args.operator+" values:"+minValue+" - "+maxValue+" counts:"+minCount+" - "+maxCount);values.minValue=minValue;values.maxValue=maxValue;values.minCount=minCount;values.maxCount=maxCount;return values;},getGridValue:function(src,row,col,mult,total,goodones){if(row>=0&&row<src.length&&col>=0&&col<src[row].length){if(isNaN(src[row][col]))return 0;total[0]+=mult;goodones[0]++;return src[row][col]*mult;}
return 0;},applyKernel:function(src,kernel){let result=this.cloneGrid(src,null,0);for(let rowIdx=0;rowIdx<src.length;rowIdx++){let row=result[rowIdx];for(let colIdx=0;colIdx<row.length;colIdx++){if(isNaN(row[colIdx]))row[colIdx]=0;let total=[0];let goodones=[0];let sum=0;kernel.every(t=>{sum+=this.getGridValue(src,rowIdx+t[0],colIdx+t[1],t[2],total,goodones);return true;});if(goodones[0]>0)
row[colIdx]=sum/total[0];else
row[colIdx]=NaN;}}
return result;},blurGrid:function(type,src){let kernels={average5:[[0,1,0],[1,1,1],[0,1,0],],average9:[[1,1,1],[1,1,1],[1,1,1],],average25:[[1,1,1,1,1],[1,1,1,1,1],[1,1,1,1,1],[1,1,1,1,1],[1,1,1,1,1],],average49:[[1,1,1,1,1,1,1],[1,1,1,1,1,1,1],[1,1,1,1,1,1,1],[1,1,1,1,1,1,1],[1,1,1,1,1,1,1],[1,1,1,1,1,1,1],[1,1,1,1,1,1,1],],gauss9:[[0.077847,0.123317,0.077847],[0.123317,0.195346,0.123317],[0.077847,0.123317,0.077847]],gauss25:[[0.003765,0.015019,0.023792,0.015019,0.003765],[0.015019,0.059912,0.094907,0.059912,0.015019],[0.023792,0.094907,0.150342,0.094907,0.023792],[0.015019,0.059912,0.094907,0.059912,0.015019],[0.003765,0.015019,0.023792,0.015019,0.003765],],gauss49:[[0.00000067,0.00002292,0.00019117,0.00038771,0.00019117,0.00002292,0.00000067],[0.00002292,0.00078633,0.00655965,0.01330373,0.00655965,0.00078633,0.00002292],[0.00019117,0.00655965,0.05472157,0.11098164,0.05472157,0.00655965,0.00019117],[0.00038771,0.01330373,0.11098164,0.22508352,0.11098164,0.01330373,0.00038771],[0.00019117,0.00655965,0.05472157,0.11098164,0.05472157,0.00655965,0.00019117],[0.00002292,0.00078633,0.00655965,0.01330373,0.00655965,0.00078633,0.00002292],[0.00000067,0.00002292,0.00019117,0.00038771,0.00019117,0.00002292,0.00000067]]}
let a=kernels[type];if(!a){if(type.startsWith("average"))
a=kernels.average5;else if(type.startsWith("gauss"))
a=kernels.gauss9;}
if(!a)return src;return this.applyKernel(src,this.makeKernel(a));},makeKernel:function(kernel){let a=[];let mid=(kernel.length-1)/2;for(let rowIdx=0;rowIdx<kernel.length;rowIdx++){let row=kernel[rowIdx];let rowOffset=rowIdx-mid;for(let colIdx=0;colIdx<row.length;colIdx++){let colOffset=colIdx-mid;a.push([rowOffset,colOffset,kernel[rowIdx][colIdx]]);}}
return a;},printGrid:function(grid){console.log("grid:");for(let rowIdx=0;rowIdx<grid.length;rowIdx++){let row=grid[rowIdx];let h="";for(let colIdx=0;colIdx<row.length;colIdx++){if(Utils.isDefined(row[colIdx].v))
h+=row[colIdx].v+",";else
h+=row[colIdx]+",";}
console.log(h);}},applyFilter(opts,grid){if(!opts.filter||opts.filter==""||opts.filter=="none"){return;}
let copy=this.cloneGrid(grid,v=>v.v);let filtered=copy;let filterPasses=opts.display.getProperty("hmFilterPasses",1);for(let i=0;i<filterPasses;i++){filtered=this.blurGrid(opts.filter,filtered);}
let filterThreshold=opts.display.getProperty("hmFilterThreshold",-999);for(let rowIdx=0;rowIdx<grid.length;rowIdx++){let row=grid[rowIdx];for(let colIdx=0;colIdx<row.length;colIdx++){let cell=row[colIdx];let filterValue=filtered[rowIdx][colIdx];if(filterThreshold!=-999){if(filterValue<filterThreshold)
filterValue=cell.v;}
cell.v=filterValue;}}},getMinMaxGrid:function(src,valueGetter){let min=NaN;let max=NaN;for(let rowIdx=0;rowIdx<src.length;rowIdx++){let row=src[rowIdx];for(let colIdx=0;colIdx<row.length;colIdx++){let v=row[colIdx]
if(valueGetter)v=valueGetter(v,rowIdx,colIdx);if(isNaN(v))continue;min=isNaN(min)?v:Math.min(min,v);max=isNaN(max)?v:Math.max(max,v);}}
return{min:min,max:max};},cloneGrid:function(src,valueGetter,dflt){let dest=[];let hasDflt=Utils.isDefined(dflt);for(let rowIdx=0;rowIdx<src.length;rowIdx++){let row=src[rowIdx];let nrow=[];dest.push(nrow);for(let colIdx=0;colIdx<row.length;colIdx++){let v=row[colIdx]
if(valueGetter)v=valueGetter(v,rowIdx,colIdx);if(hasDflt)
nrow.push(dflt);else
nrow.push(v);}}
return dest;},convertGeoToPixel:function(lat,lon,bounds,mapWidth,mapHeight){let mapLonLeft=bounds.west;let mapLonRight=bounds.east;let mapLonDelta=mapLonRight-mapLonLeft;let mapLatBottom=bounds.south;let mapLatBottomDegree=mapLatBottom*Math.PI/180;let x=(lon-mapLonLeft)*(mapWidth/mapLonDelta);lat=lat*Math.PI/180;let worldMapWidth=((mapWidth/mapLonDelta)*360)/(2*Math.PI);let mapOffsetY=(worldMapWidth/2*Math.log((1+Math.sin(mapLatBottomDegree))/(1-Math.sin(mapLatBottomDegree))));let y=mapHeight-((worldMapWidth/2*Math.log((1+Math.sin(lat))/(1-Math.sin(lat))))-mapOffsetY);return[x,y];},}
function Glyph(display,scale,fields,records,args,attrs){args=args||{};$.extend(this,{display:display,type:"label",dx:0,dy:0,label:"",baseHeight:0,baseWidth:0,width:8,fill:true,stroke:true,toString:function(){return this.type;}});$.extend(this,args);attrs.split(",").forEach(attr=>{let toks=attr.split(":");let name=toks[0];let value="";for(let i=1;i<toks.length;i++){if(i>1)value+=":";value+=toks[i];}
value=value.replace(/_nl_/g,"\n").replace(/_colon_/g,":").replace(/_comma_/g,",");if(value=="true")value=true;else if(value=="false")value=false;this[name]=value;});if(this.labelBy){this.labelField=display.getFieldById(fields,this.labelBy);if(!this.labelField){console.log("Could not find label field: "+this.labelBy);}}
if(this.type=="image"){this.imageField=display.getFieldById(fields,this.imageField);this.myImage=new Image();}
this.scale=scale;if(this.height==null){if(this.type=="3dbar")
this.height=20;else
this.height=8;}
if(this.pos==null){if(this.type=="3dbar")
this.color="blue";else if(this.type=="rect"){this.pos="c";}
else
this.pos="nw";}
this.width=(+this.width);this.height=(+this.height);if(this.dx=="canvasWidth")this.dx=this.canvasWidth;else if(this.dx=="-canvasWidth")this.dx=-this.canvasWidth;else if(this.dx=="canvasWidth2")this.dx=this.canvasWidth/2;else if(this.dx=="-canvasWidth2")this.dx=-this.canvasWidth/2;else if(this.dx=="width")this.dx=this.width;else if(this.dx=="-width")this.dx=-this.width;else if(this.dx=="width2")this.dx=this.width/2;else if(this.dx=="-width2")this.dx=-this.width/2;if(this.dy=="canvasHeight")this.dy=this.canvasHeight;else if(this.dy=="-canvasHeight")this.dy=-this.canvasHeight;else if(this.dy=="canvasHeight2")this.dy=this.canvasHeight/2;else if(this.dy=="-canvasHeight2")this.dy=-this.canvasHeight/2;else if(this.dy=="height")this.dy=this.height;else if(this.dy=="-height")this.dy=-this.height;else if(this.dy=="height2")this.dy=this.height/2;else if(this.dy=="-height2")this.dy=-this.height/2;this.baseWidth=+this.baseWidth;this.width=(+this.width)*scale;this.height=(+this.height)*scale;this.dx=(+this.dx)*scale;this.dy=(+this.dy)*scale;if(this.sizeBy){this.sizeByField=display.getFieldById(fields,this.sizeBy);if(!this.sizeByField){console.log("Could not find sizeBy field:"+this.sizeBy);}else{let props={Min:this.sizeByMin,Max:this.sizeByMax,};this.sizeByInfo=new ColorByInfo(display,fields,records,this.sizeBy,this.sizeBy,null,this.sizeBy,this.sizeByField,props);}}
if(!this.colorByInfo&&this.colorBy){this.colorByField=display.getFieldById(fields,this.colorBy);let ct=this.colorTable?display.getColorTableInner(true,this.colorTable):null;if(!this.colorByField){console.log("Could not find colorBy field:"+this.colorBy);}else{let props={Min:this.colorByMin,Max:this.colorByMax,};this.colorByInfo=new ColorByInfo(display,fields,records,this.colorBy,this.colorBy+".colorByMap",ct,this.colorBy,this.colorByField,props);}}}
Glyph.prototype={draw:function(opts,canvas,ctx,x,y,args,debug){let color=null;if(this.colorByInfo){if(this.colorByField){let v=args.record.getValue(this.colorByField.getIndex());color=this.colorByInfo.getColor(v);}else if(args.colorValue){color=this.colorByInfo.getColor(args.colorValue);}}
let lengthPercent=1.0;if(this.sizeByInfo){let v=args.record.getValue(this.sizeByField.getIndex());lengthPercent=this.sizeByInfo.getValuePercent(v);}
if(args.alphaByCount&&args.cell&&args.grid){if(args.grid.maxCount!=args.grid.minCount){let countPerc=(args.cell.count-args.grid.minCount)/(args.grid.maxCount-args.grid.minCount);color=Utils.addAlphaToColor(c,countPerc);}}
ctx.fillStyle=color||this.fillStyle||this.color||"blue";ctx.strokeStyle=this.strokeStyle||this.color||"#000";ctx.lineWidth=this.lineWidth||1;if(this.type=="label"||this.label){let label=this.labelField?args.record.getValue(this.labelField.getIndex()):this.label;if(label===null){console.log("No label value");return;}
if(typeof label=="number"){if(this.valueScale){label=label*+this.valueScale;}
if(this.decimals)
label=number_format(label,+this.decimals);}
if(this.template){label=this.template.replace("${value}",label);}
ctx.font=this.font||"12pt arial"
ctx.fillStyle=ctx.strokeStyle=color||this.color||"#000";let text=String(label);if(args.record){args.record.fields.forEach(f=>{text=text.replace("\${"+f.getId()+"}",args.record.getValue(f.getIndex()));});}
text=text.split("\n");let h=0;let hgap=3;let maxw=0;text.forEach((t,idx)=>{let dim=ctx.measureText(t);if(idx>0)h+=hgap;maxw=Math.max(maxw,dim.width);h+=dim.actualBoundingBoxAscent+dim.actualBoundingBoxDescent;});let pt=Utils.translatePoint(x,y,maxw,h,this.pos,{dx:this.dx,dy:this.dy});text.forEach(t=>{let dim=ctx.measureText(t);ctx.fillText(t,pt.x,pt.y);pt.y+=dim.actualBoundingBoxAscent+dim.actualBoundingBoxDescent+hgap;});}else if(this.type=="circle"){ctx.beginPath();let w=this.width*lengthPercent+this.baseWidth;let pt=Utils.translatePoint(x,y,w,w,this.pos,{dx:this.dx,dy:this.dy});let cx=pt.x+w/2;let cy=pt.y+w/2;ctx.arc(cx,cy,w/2,0,2*Math.PI);if(this.fill){ctx.fill();}
if(this.stroke)
ctx.stroke();}else if(this.type=="rect"){let pt=Utils.translatePoint(x,y,this.width,this.height,this.pos,{dx:this.dx,dy:this.dy});if(this.fill)
ctx.fillRect(pt.x,pt.y,this.width,this.height);if(this.stroke)
ctx.strokeRect(pt.x,pt.y,this.width,this.height);}else if(this.type=="image"){if(this.imageField){let img=args.record.getValue(this.imageField.getIndex());let pt=Utils.translatePoint(x,y,this.width,this.height,this.pos,{dx:this.dx,dy:this.dy});let i=new Image();i.src=img;setTimeout(()=>{ctx.drawImage(i,pt.x,pt.y,40,40);},1000);}}else if(this.type=="gauge"){let pt=Utils.translatePoint(x,y,this.width,this.height,this.pos,{dx:this.dx,dy:this.dy});ctx.fillStyle=this.fillColor||"#F7F7F7";ctx.beginPath();let cx=pt.x+this.width/2;let cy=pt.y+this.height;ctx.arc(cx,cy,this.width/2,1*Math.PI,0);ctx.fill();ctx.strokeStyle="#000";ctx.stroke();ctx.beginPath();ctx.beginPath();let length=this.width/2*0.75;let degrees=(180*lengthPercent);let ex=cx-this.width*0.4;let ey=cy;let ep=Utils.rotate(cx,cy,ex,ey,degrees);ctx.strokeStyle=this.color||"#000";ctx.lineWidth=this.lineWidth||2;ctx.moveTo(cx,cy);ctx.lineTo(ep.x,ep.y);ctx.stroke();ctx.lineWidth=1;this.showLabel=true;if(this.showLabel&&this.sizeByInfo){ctx.fillStyle="#000";let label=String(this.sizeByInfo.minValue);ctx.font=this.font||"9pt arial"
let dim=ctx.measureText(label);ctx.fillText(label,cx-this.width/2-dim.width-2,cy);ctx.fillText(this.sizeByInfo.maxValue,cx+this.width/2+2,cy);}}else if(this.type=="3dbar"){let pt=Utils.translatePoint(x,y,this.width,this.height,this.pos,{dx:this.dx,dy:this.dy});let height=lengthPercent*(this.height)+parseFloat(this.baseHeight);ctx.fillStyle=color||this.color;ctx.strokeStyle=this.strokeStyle||"#000";this.draw3DRect(canvas,ctx,pt.x,canvas.height-pt.y-this.height,+this.width,height,+this.width);}else if(this.type=="axis"){let pt=Utils.translatePoint(x,y,this.width,this.height,this.pos,{dx:this.dx,dy:this.dy});let height=lengthPercent*(this.height)+parseFloat(this.baseHeight);ctx.strokeStyle=this.strokeStyle||"#000";ctx.beginPath();ctx.moveTo(pt.x,pt.y);ctx.lineTo(pt.x,pt.y+this.height);ctx.lineTo(pt.x+this.width,pt.y+this.height);ctx.stroke();}else if(this.type=="vector"){if(!this.sizeByInfo){console.log("make Vector: no sizeByInfo");return;}
ctx.strokeStyle=color||this.color;let v=args.record.getValue(this.sizeByField.getIndex());lengthPercent=this.sizeByInfo.getValuePercent(v);let length=opts.cellSizeH;if(opts.lengthBy&&opts.lengthBy.index>=0){length=opts.lengthBy.scaleToValue(v);}
let x2=x+length;let y2=y;let arrowLength=opts.display.getProperty("arrowLength",-1);if(opts.colorBy&&opts.colorBy.index>=0){let perc=opts.colorBy.getValuePercent(v);let degrees=(180*perc)+90;degrees=degrees*(Math.PI/360)
x2=length*Math.cos(degrees)-0*Math.sin(degrees);y2=0*Math.cos(degrees)-length*Math.sin(degrees);x2+=x;y2+=y;}
if(arrowLength<=0){ctx.save();ctx.fillStyle="#000";ctx.beginPath();ctx.arc(x,y,1,0,2*Math.PI);ctx.fill();ctx.restore();}
ctx.beginPath();ctx.moveTo(x,y);ctx.lineTo(x2,y2);ctx.lineWidth=opts.display.getProperty("lineWidth",1);ctx.stroke();if(arrowLength>0){ctx.beginPath();this.drawArrow(ctx,x,y,x2,y2,arrowLength);ctx.stroke();}}else if(this.type=="tile"){let crx=x+opts.cellSizeX/2;let cry=y+opts.cellSizeY/2;if((args.row%2)==0){crx=crx+opts.cellSizeX/2;cry=cry-opts.cellSizeY/2;}
let sizex=opts.cellSizeX/2;let sizey=opts.cellSizeY/2;ctx.beginPath();let quarter=Math.PI/2;ctx.moveTo(crx+sizex*Math.cos(quarter),cry+sizey*Math.sin(quarter));for(let side=0;side<7;side++){ctx.lineTo(crx+sizex*Math.cos(quarter+side*2*Math.PI/6),cry+sizey*Math.sin(quarter+side*2*Math.PI/6));}
ctx.strokeStyle="#000";ctx.stroke();}else{console.log("Unknwon cell shape:"+this.type);}},draw3DRect:function(canvas,ctx,x,y,width,height,depth){let dimetricTx=function(x,y,z){return x+z/2;};let dimetricTy=function(x,y,z){return y+z/4;};let isometricTx=function(x,y,z){return(x-z)*Math.cos(Math.PI/6);};let isometricTy=function(x,y,z){return y+(x+z)*Math.sin(Math.PI/6);};let drawPoly=(function(ctx,tx,ty){return function(){let args=Array.prototype.slice.call(arguments,0);ctx.beginPath();let p=args.pop();if(p){ctx.moveTo(tx.apply(undefined,p),ty.apply(undefined,p));}
while((p=args.pop())!==undefined){ctx.lineTo(tx.apply(undefined,p),ty.apply(undefined,p));}
ctx.closePath();ctx.stroke();ctx.fill();};})(ctx,dimetricTx,dimetricTy);ctx.save();ctx.scale(1,-1);ctx.translate(0,-canvas.height);ctx.save();ctx.translate(x,y);let baseColor=ctx.fillStyle;ctx.fillStyle=Utils.pSBC(-0.5,baseColor);drawPoly([width,0,0],[width,0,depth],[width,height,depth],[width,height,0]);ctx.fillStyle=baseColor;drawPoly([0,0,0],[0,height,0],[width,height,0],[width,0,0]);ctx.fillStyle=Utils.pSBC(0.5,baseColor);drawPoly([0,height,0],[0,height,depth],[width,height,depth],[width,height,0]);ctx.fillStyle=baseColor;ctx.restore();ctx.restore();},drawArrow:function(context,fromx,fromy,tox,toy,headlen){let dx=tox-fromx;let dy=toy-fromy;let angle=Math.atan2(dy,dx);context.moveTo(fromx,fromy);context.lineTo(tox,toy);context.lineTo(tox-headlen*Math.cos(angle-Math.PI/6),toy-headlen*Math.sin(angle-Math.PI/6));context.moveTo(tox,toy);context.lineTo(tox-headlen*Math.cos(angle+Math.PI/6),toy-headlen*Math.sin(angle+Math.PI/6));},}
var xcnt=0;const displayDebug={getProperty:false,notifyEvent:false,handleEventPropertyChanged:false,getSelectedFields:false,filterData:false,getStandardData:false,makeDataTable:false,checkSearchBar:false,handleNoData:false,pointDataLoaded:false,displayMapUpdateUI:false,displayMapCreateMap:false,displayMapAddPoints:false,loadPointJson:false,groupBy:false,gridPoints:false,setEntry:true}
const CATEGORY_CHARTS="Basic Charts";const CATEGORY_TABLE="Tables";const CATEGORY_MISC="Misc Charts";const CATEGORY_MAPS="Maps";const CATEGORY_IMAGES="Images";const CATEGORY_RADIAL_ETC="Trees, etc";const CATEGORY_TEXT="Text";const CATEGORY_ENTRIES="Entries";const CATEGORY_CONTROLS="Controls";const DISPLAY_CATEGORIES=[CATEGORY_CHARTS,CATEGORY_TABLE,CATEGORY_MAPS,CATEGORY_IMAGES,CATEGORY_MISC,CATEGORY_TEXT,CATEGORY_RADIAL_ETC,CATEGORY_CONTROLS,CATEGORY_ENTRIES];const ID_BOTTOM="bottom";const ID_COLORTABLE="colortable";const ID_LEGEND="legend";const ID_FIELDS="fields";const ID_HEADER="header";const ID_HEADER1="header1";const ID_HEADER2="header2";const ID_HEADER2_PREFIX="header2prefix";const ID_HEADER2_PREPREFIX="header2preprefix";const ID_HEADER2_PREPREPREFIX="header2prepreprefix";const ID_HEADER2_SUFFIX="header2suffix";const ID_FILTERBAR="filterbar";const ID_TAGBAR="tagbar";const ID_TITLE=ATTR_TITLE;const ID_TITLE_EDIT="title_edit";const ID_LEFT="left";const ID_RIGHT="right";const ID_TITLE_FIELD="titlefield";const ID_TOP="top";const ID_TOP_RIGHT="topright";const ID_TOP_LEFT="topleft";const ID_DETAILS="details";const ID_DETAILS_SNIPPET="snippet";const ID_DISPLAY_CONTENTS="contents";const ID_DISPLAY_TOP="top";const ID_DISPLAY_BOTTOM="bottom";const ID_GROUP_CONTENTS="group_contents";const ID_DETAILS_MAIN="detailsmain";const ID_GROUPBY_FIELDS="groupdbyfields";const ID_TOOLBAR="toolbar";const ID_TOOLBAR_INNER="toolbarinner";const ID_LIST="list";const ID_DISPLAY_MESSAGE="displaymessage";const ID_DIALOG="dialog";const ID_DIALOG_TABS="dialog_tabs";const ID_FOOTER="footer";const ID_FOOTER_LEFT="footer_left";const ID_FOOTER_RIGHT="footer_right";const ID_MENU_BUTTON="menu_button";const ID_MENU_OUTER="menu_outer";const ID_MENU_INNER="menu_inner";const ID_DISPLAY_PROGRESS="display_progress";const ID_REPOSITORY="repository";const ID_REQUEST_PROPERTIES="request_properties";const ID_PAGE_COUNT="pagecount";const ID_PAGE_PREV="pageprev";const ID_PAGE_NEXT="pagenext";const ID_PAGE_LABEL="pagelabel";const ID_PAGE_BUTTONS="pagebuttons";const ID_FILTER_HIGHLIGHT="filterhighlight";const ID_FILTER_DATE="filterdate";const ID_FILTER_COUNT="filtercount";const ID_ENTRIES_MENU="entries_menu";const ID_ENTRIES_PREV="entries_prev";const ID_ENTRIES_NEXT="entries_next";const PROP_DISPLAY_FILTER="displayFilter";const PROP_EXCLUDE_ZERO="excludeZero";const PROP_EXCLUDE_NAN="excludeUndefined";const PROP_DIVID="divid";const PROP_FIELDS="fields";const PROP_LAYOUT_HERE="layoutHere";const PROP_HEIGHT="height";const PROP_WIDTH="width";const RECORD_INDEX="recordindex";const RECORD_ID="recordid";const TEXT_HIGHLIGHT_COLOR="yellow";const HIGHLIGHT_COLOR="#436EEE";const VALUE_NONE="--none--";const DisplayEvent={};function displayDefineEvent(event){DisplayEvent[event]={name:event,share:event+".share",accept:event+".accept",shareGroup:event+".shareGroup",acceptGroup:event+".acceptGroup",handler:"handleEvent"+event[0].toUpperCase()+event.substring(1),toString:function(){return this.name;}}}
displayDefineEvent("setEntry");displayDefineEvent("recordSelection");displayDefineEvent("recordList");displayDefineEvent("recordHighlight");displayDefineEvent("propertyChanged");displayDefineEvent("pointDataLoaded");displayDefineEvent("fieldsSelected");displayDefineEvent("filterFieldsSelected");displayDefineEvent("fieldsChanged");displayDefineEvent("fieldValueSelected");displayDefineEvent("entrySelection");displayDefineEvent("entriesChanged");displayDefineEvent("mapBoundsChanged");displayDefineEvent("animationChanged");displayDefineEvent("entryMouseOver");displayDefineEvent("entryMouseOut");displayDefineEvent("removeDisplay");displayDefineEvent("filterChanged");let globalDisplayCount=0;function addGlobalDisplayProperty(name,value){if(window.globalDisplayProperties==null){window.globalDisplayProperties={};}
if(value==="true")value=true;else if(value==="false")value=false;window.globalDisplayProperties[name]=value;}
function addGlobalDisplayType(type,front){if(window.globalDisplayTypes==null){window.globalDisplayTypes=[];window.globalDisplayTypesMap={};}
if(type.type){window.globalDisplayTypesMap[type.type]=type;}
if(front){window.globalDisplayTypes.unshift(type);}else{window.globalDisplayTypes.push(type);}}
function makeDisplayTooltip(header,imgs,text){let h="";if(header!=null)h+=HU.b(header);if(imgs){if(!Array.isArray(imgs)){imgs=[imgs];}
let imgHtml=imgs.reduce((acc,img)=>{if(!img.startsWith("/")){img=ramaddaBaseUrl+"/help/display/"+img;}
return acc+"<td><img src="+img+" width=250px></td>";},"<table><tr valign=top>");imgHtml+="</tr></table>";if(h!="")h+="<br>";h+=imgHtml;}
if(text)h+="<br>"+text;h=h.replace(/"/g,"&quot;");return h;}
function getGlobalDisplayProperty(name){if(window.globalDisplayProperties==null){return null;}
return window.globalDisplayProperties[name];}
function addRamaddaDisplay(display){Utils.addDisplay(display);display.displayCount=globalDisplayCount++;return display;}
async function ramaddaDisplaySetSelectedEntry(entryId,displays){await getGlobalRamadda().getEntry(entryId,e=>{displays=displays||Utils.displaysList;if(displays){displays.forEach(d=>{if(d.setEntry)d.setEntry(e);});}});}
function ramaddaDisplayCheckLayout(){Utils.displaysList.forEach(d=>{if(d.checkLayout){let t1=new Date();d.checkLayout();let t2=new Date();}});}
function getRamaddaDisplay(id){let display=Utils.displaysMap[id];if(display)return display;Utils.displaysList.forEach(display=>{if(display.getId){Utils.displaysMap[display.getId()]=display;}
if(display.displayId){Utils.displaysMap[display.displayId]=display;}});return Utils.displaysMap[id];}
function removeRamaddaDisplay(id){var display=getRamaddaDisplay(id);if(display){display.removeDisplay();Utils.removeDisplay(display);}}
function displayGetFunctionValue(v){if(v.getTime){return v.getTime();}
if(isNaN(v)){if((typeof v)=="string")return v;return 0;}
return v;}
function ramaddaDisplayStepAnimation(){Utils.displaysList.forEach(d=>{if(d.getProperty&&d.getAnimation){if(d.getProperty("doAnimation")){d.getAnimation().doNext();}}});}
function displayDefineMembers(display,props,members){RamaddaUtil.defineMembers(display,members);if(props&&display.defineProperties)display.defineProperties(props);return display;}
function defineDisplay(display,SUPER,props,members){RamaddaUtil.inherit(display,SUPER);displayDefineMembers(display,props,members);if(members.ctor){display.ctor();}
return display;}
addGlobalDisplayType({type:"group",label:"Group",requiresData:false,forUser:true,category:"Basic Charts",tooltip:makeDisplayTooltip("Create a collection of displays",null,"This allows you to layout displays and share common attributes"),helpUrl:true},true);function DisplayThing(argId,argProperties){if(argProperties==null){argProperties={};}
for(var i in argProperties){if(typeof argProperties[i]=="string"){if(argProperties[i]=="true")argProperties[i]=true;else if(argProperties[i]=="false")argProperties[i]=false;}}
for(var key in argProperties){var toks=key.split(".");if(toks.length<=1){continue;}
let map={};var v=argProperties[key];if(v=="true")v=true;else if(v=="false")v=false;for(var i=0;i<toks.length;i++){var tok=toks[i];if(i==toks.length-1){map[tok]=v;break;}
var nextMap=map[tok];if(nextMap==null){map[tok]={};map=map[tok];}else{map=nextMap;}}}
this.ignoreGlobals=argProperties.ignoreGlobals;this.displayId=null;displayDefineMembers(this,null,{objectId:argId,properties:argProperties,displayParent:null,getId:function(){return this.objectId;},setId:function(id){this.objectId=id;},removeDisplay:function(){if(this.dialogElement)this.dialogElement.remove();},setEntry:function(entry){},handleEntryMenu:async function(entryId){await getGlobalRamadda().getEntry(entryId,e=>{this.setEntry(e);});},getEntriesMenu:function(argProperties){if(argProperties&&argProperties.entryCollection){let entries=argProperties.entryCollection.split(",");this.changeEntries=[];let enums=[];entries.forEach(t=>{var toks=t.split(":");this.changeEntries.push(toks[0]);enums.push([toks[0],toks[1]]);});let noun=this.getProperty("noun","Data");let prev=HU.span([CLASS,"display-changeentries-button",TITLE,"Previous "+noun,ID,this.getDomId(ID_ENTRIES_PREV),TITLE,"Previous"],HU.getIconImage("fa-chevron-left"));let next=HU.span([CLASS,"display-changeentries-button",TITLE,"Next "+noun,ID,this.getDomId(ID_ENTRIES_NEXT),TITLE,"Next"],HU.getIconImage("fa-chevron-right"));let label=argProperties.changeEntriesLabel||"Select "+noun;if(label!="")label=label+"<br>";return HU.center(HU.div([CLASS,"display-filter"],label+prev+" "+HU.select("",[ATTR_ID,this.getDomId(ID_ENTRIES_MENU)],enums)+" "+next));}
return"";},initializeEntriesMenu:function(){this.jq(ID_ENTRIES_PREV).click(e=>{let index=this.jq(ID_ENTRIES_MENU)[0].selectedIndex;if(index<=0){index=this.changeEntries.length;}
let entry=this.changeEntries[index-1];this.jq(ID_ENTRIES_MENU).val(entry);this.handleEntryMenu(entry);});this.jq(ID_ENTRIES_NEXT).click(e=>{let index=this.jq(ID_ENTRIES_MENU)[0].selectedIndex;if(index>=this.changeEntries.length-1){index=0;}
let entry=this.changeEntries[index+1];this.jq(ID_ENTRIES_MENU).val(entry);this.handleEntryMenu(entry);});this.jq(ID_ENTRIES_MENU).change(e=>{let entry=this.jq(ID_ENTRIES_MENU).val();this.handleEntryMenu(entry);});},popup:function(srcId,popupId,srcObj,popup){popup=popup||$("#"+popupId);var src=srcObj||$("#"+srcId);var myalign='left top';var atalign='left bottom';popup.show();popup.position({of:src,my:myalign,at:atalign,collision:"none none"});popup.position({of:src,my:myalign,at:atalign,collision:"none none"});popup.draggable();popup.show();},initDialog:function(){},showDialog:function(text,from,initDialog){if(!this.dialogElement){$(document.body).append(HU.div([ATTR_CLASS,"display-dialog",ID,this.getDomId(ID_DIALOG)]));this.dialogElement=this.jq(ID_DIALOG);}
this.dialogElement.html(this.makeDialog(text));this.popup(from||this.getDomId(ID_MENU_BUTTON),null,null,this.dialogElement);if(initDialog)initDialog();else this.initDialog();},getShowMenu:function(){if(Utils.isDefined(this.showMenu)){return this.showMenu;}
var dflt=false;if(this.displayParent!=null){dflt=this.displayParent.getProperty("showChildMenu",dflt);}
var v=this.getProperty(PROP_SHOW_MENU,dflt);return v;},getShowTitle:function(){if(this.getProperty("showTitle")){return this.getProperty("showTitle");}
var dflt=false;if(this.displayParent!=null){dflt=this.displayParent.getProperty("showChildTitle",dflt);}
return this.getProperty("showTitle",dflt);},getTimeZone:function(){return this.getProperty("timeZone");},formatDate:function(date,args,useToStringIfNeeded){if(!date||!date.getTime)return"";try{return this.formatDateInner(date,args,useToStringIfNeeded);}catch(e){console.log("Error formatting date:"+date+" error:"+e);if(!date.getTime&&date.v)date=date.v;return""+date;}},dateFormat:null,formatDateInner:function(date,args,useToStringIfNeeded){if(!this.dateFormat)
this.dateFormat=this.getProperty("dateFormat",this.getProperty("dateFormat2"));if(!this.dateFormat&&useToStringIfNeeded){return String(date);}
if(!date.getTime&&date.v)date=date.v;if(this.dateFormat){let dttm=Utils.formatDateWithFormat(date,this.dateFormat,true);if(dttm){return String(dttm);}}
if(!date.toLocaleDateString){return String(date);}
var suffix;if(args&&!Utils.isDefined(args.suffix))
suffix=args.suffix;else
suffix=this.getProperty("dateSuffix");var timeZone=this.getTimeZone();if(!suffix&&timeZone)suffix=timeZone;return Utils.formatDate(date,args?args.options:null,{timeZone:timeZone,suffix:suffix});},getUniqueId:function(base){return HU.getUniqueId(base);},handleError:function(code,message){GuiUtils.handleError("An error has occurred:"+message,true,true);},toString:function(){return"DisplayThing:"+this.getId();},domId:function(suffix){return this.getDomId(suffix);},getDomId:function(suffix){return this.getId()+"_"+suffix;},gid:function(suffix){return this.getId()+"_"+suffix;},find:function(selector){return this.getContents().find(selector);},getContents:function(){return this.jq(ID_DISPLAY_CONTENTS);},jq:function(componentId){return $("#"+this.getDomId(componentId));},selectboxit:function(selector,args){let opts={showEffect:"fadeIn",showEffectSpeed:400,hideEffect:"fadeOut",hideEffectSpeed:400,};if(args)$.extend(opts,args);selector.selectBoxIt(opts);},writeHtml:function(idSuffix,html){$("#"+this.getDomId(idSuffix)).html(html);},getTemplateProps:function(fields){return{iconField:this.getFieldById(fields,this.getProperty("iconField")),iconSize:parseFloat(this.getProperty("iconSize",16)),iconMap:this.getIconMap(),colorBy:this.getProperty("colorBy"),colorByMap:this.getColorByMap()}},macroHook:function(token,value){return null;},applyRecordTemplate:function(record,row,fields,template,props,macros,debug){fields=this.getFields(fields);if(!props){props=this.getTemplateProps(fields);}
if(!macros)macros=Utils.tokenizeMacros(template,{hook:(token,value)=>{return this.macroHook(record,token,value)},dateFormat:this.getProperty("dateFormat")});let attrs={};if(props.iconMap&&props.iconField){var value=row[props.iconField.getIndex()];var icon=props.iconMap[value];if(icon){attrs[props.iconField.getId()+"_icon"]=HU.image(icon,["width",props.iconSize]);}}
let makeImage=(f,value)=>{let tokenAttrs=macros.getAttributes(f.getId()+"_image");let imageAttrs=[];let width=tokenAttrs?tokenAttrs["width"]:null;if(width){imageAttrs.push("width");imageAttrs.push(width);}else if(this.getProperty("imageWidth")){imageAttrs.push("width");imageAttrs.push(this.getProperty("imageWidth"));}else{imageAttrs.push("width");imageAttrs.push("300");}
imageAttrs.push("style");imageAttrs.push("vertical-align:top");return HU.image(value,imageAttrs);};let idToField={}
fields.forEach(f=>idToField[f.getId()]=f);macros.tokens.forEach(t=>{if(!t.attrs)return;if(t.tag=="default"){attrs[t.tag]=this.getRecordHtml(record,fields,"${default}");}else if(t.attrs["type"]=="list"&&t.attrs["fields"]){let html="<table class=display-table>";t.attrs.fields.split(",").forEach(fieldName=>{let f=idToField[fieldName];let value=row[f.getIndex()];if(f.getType()=="image"){value=makeImage(f,value);}else if(f.getType()=="url"){if(value!="")
value=HU.href(value,value);}
html+="<tr><td align=right><b>"+f.getLabel()+"</b>:</td><td>  "+value+"</td></tr>";});html+="</table>";attrs[t.tag]=html;}});for(let col=0;col<fields.length;col++){let f=fields[col];let value=row[f.getIndex()];if(debug)console.log("macro:"+col+" field:"+f.getId()+" type:"+f.getType()+" value:"+value);if(props.iconMap){var icon=props.iconMap[f.getId()+"."+value];if(icon){s=s.replace("${"+f.getId()+"_icon}",HU.image(icon,["size",props.iconSize]));}}
if(f.getType()=="image"){if(value&&value.trim().length>1){let tokenAttrs=macros.getAttributes(f.getId()+"_image");let imageAttrs=[];let width=tokenAttrs?tokenAttrs["width"]:null;if(width){imageAttrs.push("width");imageAttrs.push(width);}else if(this.getProperty("imageWidth")){imageAttrs.push("width");imageAttrs.push(this.getProperty("imageWidth"));}else{imageAttrs.push("width");imageAttrs.push("100%");}
imageAttrs.push("style");imageAttrs.push("vertical-align:top");var img=HU.image(value,imageAttrs);attrs[f.getId()+"_image"]=img;attrs[f.getId()+"_url"]=value;}else{attrs[f.getId()+"_url"]=ramaddaBaseUrl+"/icons/blank.gif";attrs[f.getId()+"_image"]="";}}else if(f.getType()=="movie"){if(value&&value.trim().length>0){let movieAttrs=[];if(this.getProperty("movieWidth")){movieAttrs.push("width");movieAttrs.push(this.getProperty("movieWidth"));}
let movie=HU.movie(value,movieAttrs);attrs[f.getId()+"_movie"]=movie;attrs[f.getId()+"_url"]=value;}}else if(f.getType()=="url"){if(value&&value.trim().length>1){let tokenAttrs=macros.getAttributes(f.getId()+"_href");let label=tokenAttrs?tokenAttrs["label"]:null;attrs[f.getId()+"_href"]=HU.href(value,label||value);attrs[f.getId()]=value;}else{attrs[f.getId()+"_href"]="";attrs[f.getId()]="";}
continue;}else if(f.isDate){if(value){attrs[f.getId()]=value;}
continue;}
var color;if(props.colorByMap){if(props.colorBy&&props.colorBy==f.getId()){color=props.colorByMap[value];}else{color=props.colorByMap[f.getId()+"."+value];}}
if(color){attrs[f.getId()+"_color"]=color;}
attrs[f.getId()]=value;if(f.isNumeric()){attrs[f.getId()+"_format"]=Utils.formatNumberComma(value);}}
this.addMacroAttributes(macros,row,attrs);let handler=(tag,value)=>{if(tag.attrs["display"]=="tags"){let type=tag.tag;let filter=this.filterMap[type];let color=Utils.getEnumColor(type);let result="";value=String(value).trim();if(value=="")return"";value.split(",").forEach(tagValue=>{result+=HU.div(["metadata-type",type,"metadata-value",tagValue,TITLE,tagValue,STYLE,HU.css("background",color),CLASS,"display-search-tag"],tagValue);});if(filter)result=filter.getLabel()+": "+result+"<br>";return result;}
return"Unknown tag handler:"+tag.attrs["handle"];};attrs.recordIndex=record.rowIndex+1;return macros.apply(attrs,debug,handler);},addMacroAttributes:function(macros,row,attrs){},getFields:function(fields){if(!fields){var pointData=this.getData();if(pointData==null){return null;}
fields=pointData.getRecordFields();}
return fields;},getFieldLabel:function(field){return this.getProperty(field.getId()+".label",field.getLabel());},getRecordUrlHtml:function(attrs,field,record){let value=record.getValue(field.getIndex());let label=attrs[field.getId()+".label"]||attrs["url.label"]||attrs["label"]||"Link";return HU.href(value,label,["target","_link"]);},getSortedFields:function(fields){let anyGroups=fields.filter(f=>{if(f==null)return true;return f.getGroup()!=null;}).length>0;if(!anyGroups)return fields;let groups=[];let map={};for(let i=0;i<fields.length;i++){let field=fields[i];if(field==null)continue;group=field.getGroup();if(group==null){group=group+"_"+i;}
if(!map[group]){map[group]=[];groups.push(group);}
map[group].push(field);}
fields=[];groups.forEach(group=>{fields=Utils.mergeLists(fields,map[group]);});return fields;},getRecordHtml:function(record,fields,template,debug){fields=this.getFields(fields);if(!fields)return"";let urlField=this.getFieldById(null,this.getProperty("urlField","url"));let linkField=this.getFieldById(null,this.getProperty("linkField"))||urlField;let titleField=this.getFieldById(null,this.getProperty("titleField"));let titleTemplate=this.getProperty("titleTemplate");let descField=this.getFieldById(null,this.getProperty("descriptionField"));let link=linkField?record.getValue(linkField.getIndex()):null;let showDate=this.getProperty("showDate",true);let showImage=this.getProperty("showImage",true);let showMovie=this.getProperty("showMovie",true);let showGeo=false;let showElevation=this.getProperty("showElevation",false);if(Utils.isDefined(this.showGeo)){showGeo=(""+this.showGeo)=="true";}
if(template=="")return"";if(!Utils.stringDefined(template))
template=this.getProperty("recordTemplate");if(Utils.stringDefined(template)){if(!template.startsWith("${default")&&template!="${fields}"){return this.applyRecordTemplate(record,this.getDataValues(record),fields,template,null,null,debug);}}
if(template=="${fields}"){fields=this.getFieldsByIds(null,this.getProperty("tooltipFields",this.getPropertyFields()));}else{let ttf=this.getProperty("tooltipFields");if(ttf){fields=this.getFieldsByIds(null,ttf);}}
let templateProps={};let itemsPerColumn=this.getProperty("itemsPerColumn",50);let attrs={};if(template){attrs=Utils.tokenizeMacros(template,{hook:(token,value)=>{return this.macroHook(record,token,value)},dateFormat:this.getProperty("dateFormat")}).getAttributes("default")||{};}
itemsPerColumn=attrs["itemsPerColumn"]||itemsPerColumn;let values="";if(titleField||titleTemplate){let title="";if(titleTemplate){if(!titleTemplate.startsWith("${default")){title=this.getRecordHtml(record,fields,titleTemplate,debug);}}else{title=record.getValue(titleField.getIndex());if(title.getTime)
title=this.formatDate(title);title=HU.center(HU.h3(title));}
if(link)
title=HU.href(link,title,["target","_target"]);values+=title;link=null;}
if(descField){let desc=record.getValue(descField.getIndex());values+=desc;}
let tooltipNots={};this.getProperty("tooltipNotFields","").split(",").forEach(f=>{tooltipNots[f]=true;});let rows=[];let hadDate=false;let labelColAttrs=[];if(this.getProperty("labelColumnAttrs")){labelColAttrs=this.getProperty("labelColumnAttrs").split(",");}else{labelColAttrs=["align","right"];}
let labelWidth=this.getProperty("labelWidth");fields=this.getSortedFields(fields);let group=null;for(let doDerived=0;doDerived<2;doDerived++){for(let i=0;i<fields.length;i++){let field=fields[i];if(tooltipNots[field.getId()])continue;if(attrs[field.getId()+".hide"]){continue;}
if(field==titleField||field==descField)continue;if(doDerived==0&&!field.derived)continue;else if(doDerived==1&&field.derived)continue;if(!field.getForDisplay()){continue;}
if(field.isRecordDate()){if(!showDate){continue;}
hadDate=true;}
if(!showGeo){if(field.isFieldGeo()){continue;}}
if(group!=field.getGroup()){group=field.getGroup();if(Utils.isDefined(group)){rows.push(HU.tr([],HU.td(["colspan","2"],HU.div([CLASS,"ramadda-header-small"],group))));}}
let initValue=record.getValue(field.getIndex());let value=initValue;let fieldValue=value;if(typeof value=="number"){value=this.formatNumber(value,field.getId());}
if(field.isFieldDate()){value=this.formatDate(value);}
if(field.getType()=="image"&&value!=""){if(!showImage)continue;let imageAttrs=[];if(this.getProperty("imageWidth")){imageAttrs.push("width");imageAttrs.push(this.getProperty("imageWidth"));}else{imageAttrs.push("width");imageAttrs.push("200");}
imageAttrs.push("align");imageAttrs.push("top");value=HU.image(value,imageAttrs);}
if(field.getType()=="movie"&&value!=""){if(!showMovie)continue;var movieAttrs=[];movieAttrs.push("width");movieAttrs.push("200");value=HU.movie(value,movieAttrs);}
if(field.getType()=="url"){value=this.getRecordUrlHtml(attrs,field,record);}
let labelValue=field.getLabel();value=value+field.getUnitSuffix();let tt=labelValue+"="+initValue;if(value.length>100){value=HU.div([STYLE,HU.css("max-height","100px","overflow-y","auto")],value);}
let label=this.formatRecordLabel(labelValue)+":";if(labelWidth){label=HU.div([STYLE,HU.css("max-width",HU.getDimension(labelWidth),"overflow-x","auto")],label);}
label=HU.div([TITLE,tt],label);let row=HU.open(TR,['valign','top']);row+=HU.td(labelColAttrs,HU.b(label));row+=HU.td(["field-id",field.getId(),"field-value",fieldValue,"align","left"],HU.div([STYLE,HU.css('margin-left','5px')],value));row+=HU.close(TR);rows.push(row);}}
if(!hadDate&&showDate){if(record.hasDate()){let row=HU.open(TR,['valign','top']);let label=this.formatRecordLabel("Date");row+=HU.td([],HU.b(label+":"));row+=HU.td(["align","left"],HU.div([STYLE,HU.css('margin-left','5px')],this.formatDate(record.getDate())));row+=HU.close(TR);rows.push(row);}}
if(showElevation&&record.hasElevation()){rows.push(HU.tr([],HU.td([ALIGN,'right'],HU.b('Elevation:'))+
HU.td([ALIGN,'left'],number_format(record.getElevation(),4,'.',''))));}
let rowCnt=0;values+="<table><tr valign=top>";let lists=Utils.splitList(rows,itemsPerColumn);let tdStyle=lists.length>1?"margin-right:5px;":"";lists.forEach(list=>{values+="<td><div style='"+tdStyle+"'><table>"+Utils.join(list,"")+"</table></div></td>";});values+="</tr><table>";if(this.getProperty("recordHtmlStyle")){values=HU.div([CLASS,"ramadda-shadow-box display-tooltip",STYLE,this.getProperty("recordHtmlStyle")],values);}
return values;},formatRecordLabel:function(label){label=label.replace(/!!/g," -- ");label=label.replace(/ /g,"&nbsp;");return label;},getFormValue:function(what,dflt){var fromForm=$("#"+this.getDomId(what)).val();if(fromForm!=null){if(fromForm.length>0){this.setProperty(what,fromForm);}
if(fromForm=="none"){this.setProperty(what,null);}
return fromForm;}
return this.getProperty(what,dflt);},getName:function(){return this.getFormValue("name",this.getId());},getEventSource:function(){return this.getFormValue("eventSource","");},setDisplayParent:function(parent){this.displayParent=parent;},getDisplayParent:function(){if(this.displayParent==null){this.displayParent=this.getLayoutManager();}
return this.displayParent;},removeProperty:function(key){this.properties[key]=null;},setProperty:function(key,value){this.properties[key]=value;this.transientProperties[key]=value;},getSelfProperty:function(key,dflt){if(this[key]!=null){return this[key];}
return this.getProperty(key,dflt);},initTooltip:function(){},formatNumber:function(number,propPrefix,debug){if(!this.getProperty([propPrefix+".doFormatNumber","doFormatNumber"],true)){return number;}
if(isNaN(number)){return"--";}
let f=this.formatNumberInner(number,propPrefix,debug);let fmt=this.getProperty([propPrefix+".numberTemplate","numberTemplate"]);if(fmt)f=fmt.replace("${number}",f);f=String(f);if(f.endsWith("."))f=f.substring(0,f.length-1);return f;},formatNumberInner:function(number,propPrefix,debug){number=+number;let scale=this.getProperty([propPrefix+".formatNumberScale","formatNumberScale"]);if(Utils.isDefined(scale))
number=number*scale;let decimals=this.getProperty([propPrefix+".formatNumberDecimals","formatNumberDecimals"]);if(Utils.isDefined(decimals)){return number_format(number,decimals);}
if(this.getProperty([propPrefix+".formatNumberComma","formatNumberComma"],false)){return Utils.formatNumberComma(number);}
return Utils.formatNumber(number,false,debug);},propertyDefined:function(key){return Utils.isDefined(this.getProperty(key));},setPropertyOn:function(object,myProperty,objectProperty,dflt){var prop=this.getProperty(myProperty,dflt);if(Utils.isDefined(prop)&&prop!=null){object[objectProperty]=prop;}},getDisplayProp:function(source,prop,dflt){if(Utils.isDefined(this[prop])){return this[prop];}
let prop2="map-"+prop;if(Utils.isDefined(source[prop2])){return source[prop2];}
if(source.getProperty){return source.getProperty(prop,dflt);}
return null;},getPropertyFromUrl:function(key,dflt){let fromUrl=HU.getUrlArgument("display"+this.displayCount+"."+key);if(fromUrl)return fromUrl;return this.getProperty(key,dflt);},getPropertyFields:function(dflt){return this.getPropertyFromUrl(PROP_FIELDS,dflt);},transientProperties:{},xxcnt:0,getProperty:function(key,dflt,skipThis,skipParent){let debug=false;if(typeof this.transientProperties[key]!='undefined'){if(debug)
console.log("transient:"+key);return this.transientProperties[key];}
if(debug)
console.log("getProperty:"+key+" dflt:"+dflt);if(this.debugGetProperty)
console.log("\tgetProperty:"+key);let value=this.getPropertyInner(key,null,skipThis,skipParent);if(this.debugGetProperty)
console.log("\tgot:"+value);if(this.writePropertyDef!=null){if(!this.seenWriteProperty)this.seenWriteProperty={};if(!this.seenWriteProperty[key]){let f=(v)=>{return v?"'"+v+"'":"null";};this.writePropertyDef+="{p:'"+key+"',d:"+f(dflt)+",wikiValue:"+f(value||dflt)+"},\n"
this.seenWriteProperty[key]=true;}}
if(debug)
console.log(key+":"+value+" dflt:"+dflt);if(!Utils.isDefined(value)){if(this.debugGetProperty)
console.log("\treturning dflt:"+dflt);return dflt;}
if(this.debugGetProperty)
console.log("\treturning value:"+value);this.transientProperties[key]=value;return value;},getPropertyInner:function(keys,dflt,skipThis,skipParent){let debug=displayDebug.getProperty;debug=this.debugGetProperty;if(!Array.isArray(keys))keys=[keys];for(let i=0;i<keys.length;i++){let key=keys[i];if(debug)console.log("getProperty:"+key+" dflt:"+dflt);if(this.dynamicProperties){if(Utils.isDefined(this.dynamicProperties[key])){return this.dynamicProperties[key];}}
var value=this.properties[key];if(value!=null){if(debug)console.log("\tgot property from this.properties:"+value);return value;}}
if(!skipParent){for(let i=0;i<keys.length;i++){let key=keys[i];var fromParent=null;if(this.displayParent!=null){fromParent=this.displayParent.getPropertyInner("inherit."+key,skipThis);}
if(!fromParent&&this.getDisplayManager){fromParent=this.getDisplayManager().getPropertyInner("inherit."+key);}
if(fromParent){if(debug)console.log("\tgetProperty-3");return fromParent;}}}
if(!this.ignoreGlobals){if(!skipParent){if(this.displayParent!=null){if(debug)console.log("\tgetProperty calling parent");return this.displayParent.getPropertyInner(keys,skipThis);}
if(this.getDisplayManager){if(debug)console.log("\tgetProperty-5");return this.getDisplayManager().getPropertyInner(keys);}}
for(let i=0;i<keys.length;i++){let key=keys[i];value=getGlobalDisplayProperty(key);if(Utils.isDefined(value)){if(debug)console.log("\tgetProperty-6:"+value);return value;}}}
if(debug)console.log("\tgetProperty-6 dflt:"+dflt);return dflt;},});}
function RamaddaDisplay(argDisplayManager,argId,argType,argProperties){const SUPER=new DisplayThing(argId,argProperties);RamaddaUtil.inherit(this,SUPER);if(window.globalDisplayTypesMap){this.typeDef=window.globalDisplayTypesMap[argType];}
this._wikiTags=[];this.defineProperties=function(props){let tagList=[];props.forEach(prop=>{tagList.push(prop);if(!prop.p){return;}
if(prop.p.indexOf("&")<0){if(!Utils.isDefined(prop.doGetter)||prop.doGetter){let getFunc=(dflt,debug)=>{if(!Utils.isDefined(dflt))dflt=prop.d;return this.getProperty(prop.p,dflt);};let funcName='getProperty'+prop.p.substring(0,1).toUpperCase()+prop.p.substring(1);if(!this[funcName])
this[funcName]=getFunc;funcName='get'+prop.p.substring(0,1).toUpperCase()+prop.p.substring(1);if(!this[funcName])
this[funcName]=getFunc;}}
prop.wikiValue=prop.wikiValue||prop.w;});this._wikiTags=Utils.mergeLists(tagList,this._wikiTags);}
let myProps=[{label:'Display'},{p:'fields',doGetter:false,ex:'comma separated list of field ids or indices - e.g. #1,#2,#4-#7,etc or *'},{p:'notFields',ex:'regexp',tt:'regexp to not include fields'},{p:'showMenu',ex:true},{p:'showTitle',ex:true},{p:'showEntryIcon',ex:true},{p:'layoutHere',ex:true},{p:'width',doGetter:false,ex:'100%'},{p:'height',doGetter:false,ex:'400'},{p:'tooltip',doGetter:false,ex:'${default}'},{p:'tooltipPositionMy',ex:'left top'},{p:'tooltipPositionAt',ex:'left bottom+2'},{p:'recordTemplate',doGetter:false,ex:'${default}',tt:'Template for popups etc. Can be ${default attrs} or \'${field} .. ${fieldn}...\''},{p:'titleTemplate',doGetter:false,ex:'${field1}',tt:'Template for title in ${default} template display'},{p:'itemsPerColumn',ex:10,tt:'How many items to show in each column in a tooltip'},{p:'labelColumnAttrs',ex:'align,right',tt:'Attributes of the label column in the record templates'},{p:'labelWidth',ex:'10',tt:'Width of labels the record templates'},{p:'displayStyle',ex:'css styles',tt:'Specify styles for display'},{p:'title',ex:''},{p:'titleBackground',ex:'color'},{p:'linkField',ex:''},{p:'titleField',ex:''},{p:'descriptionField',ex:''},{p:'textColor',ex:'color'},{p:'backgroundImage',ex:'',tt:'Image url to display in background'},{p:'background',ex:'color'},{p:'showProgress',ex:true},{p:'loadingMessage',ex:'',tt:'Message to show when loading data'},{p:'doEntries',ex:true,tt:'Make the children entries be data'},{p:'addAttributes',ex:true,tt:'Include the extra attributes of the children'},{p:'sortFields',tt:'Comma separated list of fields to sort the data on'},{p:'sortAscending',ex:'true|false'},{p:'showSortDirection',ex:true},{p:'sortByFields',ex:'',tt:'Show sort by fields in a menu'},{p:'sortHighlight',ex:true,tt:'Sort based on highlight from the filters'},{p:'showDisplayFieldsMenu',ex:true},{p:'displayFieldsMenuMultiple',ex:true},{p:'displayFieldsMenuSide',ex:'left'},{p:'displayHeaderSide',ex:'left'},{p:'leftSideWidth',ex:'150px'},{label:'Formatting'},{p:'dateFormat',ex:'yyyy|yyyymmdd|yyyymmddhh|yyyymmddhhmm|yyyymm|yearmonth|monthdayyear|monthday|mon_day|mdy|hhmm'},{p:'dateFormatDaysAgo',ex:true},{p:'doFormatNumber',ex:false},{p:'formatNumberDecimals',ex:0},{p:'formatNumberScale',ex:100},{p:'numberTemplate',ex:'${number}%'},{p:'&lt;field_id&gt;.&lt;format&gt;',ex:'...'},{label:'Data Requests'},{p:'requestFields',tt:'Comma separated list of fields for querying server side data'},{p:'requestPrefix',ex:'search.',tt:'Prefix to prepend to the url argument'},{p:'request.&lt;request field&gt;.multiple',ex:'true',tt:'Support multiple enumerated selections'},{label:'Filter Data'},{p:'fieldsNumeric',ex:true,tt:'Only get numeric fields'},{p:'filterFields',ex:''},{p:'filterFieldsToPropagate'},{p:'hideFilterWidget',ex:true},{p:'filterHighlight',d:false,ex:true,tt:'Highlight the records'},{p:'showFilterTags',d:false},{p:'tagDiv',tt:'Div id to show tags in'},{p:'showFilterHighlight',ex:false,tt:'show/hide the filter highlight widget'},{p:'headerOrientation',ex:'vertical'},{p:'filterSliderImmediate',ex:true,tt:'Apply the change while sliding'},{p:'filterLogic',ex:'and|or',tt:'Specify logic to apply filters'},{p:'&lt;field&gt;.filterValue'},{p:'&lt;field&gt;.filterValueMin'},{p:'&lt;field&gt;.filterValueMax'},{p:'&lt;field&gt;.filterValues'},{p:'&lt;field&gt;.filterMultiple',ex:true},{p:'&lt;field&gt;.filterMultipleSize',ex:5},{p:'filterShowCount',ex:false},{p:'filterShowTotal',ex:true},{p:'&lt;field&gt;.filterLabel'},{p:'&lt;field&gt;.showFilterLabel'},{p:'&lt;field&gt;.filterLabelVertical',ex:true},{p:'filterLabelVertical',ex:true},{p:'&lt;field&gt;.filterByStyle',ex:'background:white;'},{p:'&lt;field&gt;.includeAll',ex:false},{p:'&lt;field&gt;.filterSort',ex:false},{p:'&lt;field&gt;.filterSortCount',ex:false},{p:'&lt;field&gt;.filterStartsWith',ex:true},{p:'&lt;field&gt;.filterDisplay',ex:'menu|tab|button|image'},{p:'&lt;field&gt;.filterOps',ex:'<,5000000,label1;>,5000000',tt:'Add menu with fixed filters'},{p:'excludeUndefined',ex:true,tt:'Exclude any records with an undefined value'},{p:'excludeZero',ex:true,tt:'Exclude any records with a 0 value'},{p:'filterPaginate',ex:'true',tt:'Show the record pagination'},{p:'recordSelectFilterFields',tt:'Set the value of other displays filter fields'},{p:'selectFields',ex:'prop:label:field1,...fieldN;prop:....'},{p:'match value',ex:"dataFilters=\"match(field=field,value=value,label=,enabled=);\"",tt:"Only show records that match"},{p:"not match value",ex:"dataFilters=\"notmatch(field=field,value=value,label=,enabled=);\"",tt:"Only show records that dont match"},{p:'no missing values',ex:'dataFilters=\"nomissing(field=field,label=,enabled=);\"',tt:'Dont show missing values'},{p:'less than',ex:'dataFilters=\"lessthan(field=field,value=value,label=,enabled=);\"'},{p:'greater than',ex:'dataFilters=\"greaterthan(field=field,value=value,label=,enabled=);\"'},{p:'equals',ex:'dataFilters=\"equals(field=field,value=value,label=,enabled=);\"'},{p:'not equals',ex:'dataFilters=\"notequals(field=field,value=value,label=,enabled=);\"'},{p:'filterLatest',ex:'fields',tt:'Only show the latest records grouped by fields'},{p:'filterDate',ex:'year',tt:'Show a simple pull down menu to select a year to display'},{p:'filterDateIncludeAll',ex:true,tt:'Include all years'},{p:'startDate',ex:'yyyy,MM,dd,hh,mm,ss',tt:'Filter data on date'},{p:'endDate',ex:'yyyy,MM,dd,hh,mm,ss',tt:'Filter data on date'},{label:'Events'},{p:DisplayEvent.filterChanged.share,ex:true,tt:'Share filter changed'},{p:DisplayEvent.filterChanged.accept,ex:true,tt:'Accept filter changed'},{p:DisplayEvent.filterChanged.shareGroup,tt:'Only share in this group'},{p:DisplayEvent.filterChanged.acceptGroup,tt:'Only share in this group'},{p:DisplayEvent.recordSelection.share,ex:true,tt:'Share record selection'},{p:DisplayEvent.recordSelection.accept,ex:true,tt:'Accept record selection'},{p:DisplayEvent.recordSelection.shareGroup,tt:'Only share in this group'},{p:DisplayEvent.recordSelection.acceptGroup,tt:'Only share in this group'},{p:DisplayEvent.recordHighlight.share,ex:true,tt:'Share record highlight'},{p:DisplayEvent.recordHighlight.accept,ex:true,tt:'Accept record highlight'},{p:DisplayEvent.recordHighlight.shareGroup,tt:'Only share in this group'},{p:DisplayEvent.recordHighlight.acceptGroup,tt:'Only share in this group'},{p:DisplayEvent.recordList.share,ex:true,tt:'Share record list'},{p:DisplayEvent.recordList.accept,ex:true,tt:'Accept record list'},{p:DisplayEvent.recordList.shareGroup,tt:'Only share in this group'},{p:DisplayEvent.recordList.acceptGroup,tt:'Only share in this group'},{p:DisplayEvent.fieldsChanged.share,ex:true,tt:'Share fields changed'},{p:DisplayEvent.fieldsChanged.accept,ex:true,tt:'Accept fields changed'},{p:DisplayEvent.fieldsChanged.shareGroup,tt:'Only share in this group'},{p:DisplayEvent.fieldsChanged.acceptGroup,tt:'Only share in this group'},{p:DisplayEvent.setEntry.share,ex:true,tt:'When displaying entries as data this shares the selected entry with other displays'},{p:DisplayEvent.setEntry.accept,ex:true,tt:'When displaying entries as data this accepts the new entry'},{p:DisplayEvent.setEntry.shareGroup,tt:'When sharing the entry this groups what displays to share with'},{p:DisplayEvent.setEntry.acceptGroup,tt:'When sharing the entry this must match with the shareGroup'},{p:'acceptEventDataSelection',ex:true,tt:'accept new data coming from other displays'},{label:'Convert Data'},{p:'binDate',ex:'day|month|year',tt:'Bin the dates'},{p:'binType',ex:'count|average|total'},{p:'groupBy',ex:'field',tt:'Group the data'},{p:'aggregateBy',tt:'Add an extra row for the aggregated rows'},{p:'aggregateOperator',ex:'sum|percent',tt:'Operator to apply on the aggregated rows'},{p:'aggregateOperator.fieldName',ex:'sum|percent',tt:'Operator to apply on the aggregated rows for the given field'},{p:'convertData',label:'derived data',ex:'derived(field=new_field_id, function=foo*bar);',tt:'Add derived field'},{p:'convertData',label:'merge rows',ex:'mergeRows(keyFields=f1\\\\,f2, operator=count|sum|average, valueFields=);',tt:'Merge rows together'},{p:'convertData',label:'rotate data',ex:'rotateData(includeFields=true,includeDate=true,flipColumns=true);',tt:'Rotate data'},{p:'convertData',label:'percent increase',ex:'addPercentIncrease(replaceValues=false);',tt:'Add percent increase'},{p:'convertData',label:'doubling rate',ex:'doublingRate(fields=f1\\\\,f2, keyFields=f3);',tt:'Calculate # days to double'},{p:'convertData',label:'add fixed',ex:'addFixed(id=max_pool_elevation\\\\,value=3700,type=double);"',tt:'add fixed value'},{p:'convertData',label:'unfurl',ex:'unfurl(headerField=field to get header from,uniqueField=e.g. date,valueFields=);',tt:'Unfurl'},{p:'convertData',label:'Accumulate data',ex:'accum(fields=);',tt:'Accumulate'},{p:'convertData',label:'Add an average field',ex:'mean(fields=);',tt:'Mean'},{p:'convertData',label:'Prune where fields are all NaN',ex:'prune(fields=);',tt:'Prune'},{p:'convertData',label:'Scale and offset',ex:'accum(scale=1,offset1=0,offset2=0,unit=,fields=);',tt:'(d + offset1) * scale + offset2'},{label:'Color'},{p:'colors',ex:'color1,...,colorN',tt:'Comma separated array of colors'},{p:'colorBy',ex:'',tt:'Field id to color by'},{p:'colorByFields',ex:'',tt:'Show color by fields in a menu'},{p:'colorByLog',ex:'true',tt:'Use a log scale for the color by'},{p:'colorByMap',ex:'value1:color1,...,valueN:colorN',tt:'Specify colors for color by text values'},{p:'colorTableAlpha',ex:0.5,tt:'Set transparency on color table values'},{p:'colorTableInverse',ex:true,tt:'Inverse the color table'},{p:'colorTablePruneLeft',ex:'N',tt:'Prune first N colors'},{p:'colorTablePruneRight',ex:'N',tt:'Prune last N colors'},{p:'colorByMin',ex:'value',tt:'Min scale value'},{p:'colorByMax',ex:'value',tt:'Max scale value'},{p:'showColorTable',ex:'false',tt:'Display the color table'},{p:'showColorTableDots',ex:true},{p:'colorTableDotsDecimals',ex:'0'},{p:'colorTableSide',ex:'bottom|right|left|top'},{p:'showColorTableStride',ex:1,tt:'How many colors should be shown'},{p:'colorByAllRecords',ex:true,tt:'use all records for color range'},{p:'convertColorIntensity',ex:true},{p:'intensitySourceMin',ex:'0'},{p:'intensitySourceMax',ex:100},{p:'intensityTargetMin',ex:1},{p:'intensityTargetMax',ex:0},{p:'convertColorAlpha',ex:true},{p:'alphaSourceMin',ex:0},{p:'alphaSourceMax',ex:100},{p:'alphaTargetMin',ex:0},{p:'alphaTargetMax',ex:1},{label:'Animation'},{p:'doAnimation',ex:true},{p:'animationHighlightRecord',ex:true},{p:'animationHighlightRecordList',ex:true},{p:'acceptEventAnimationChange',ex:false},{p:'acceptDateRangeChange',ex:true},{p:'animationDateFormat',ex:'yyyy'},{p:'animationLabelSize',ex:'12pt'},{p:'animationStyle'},{p:'animationTooltipShow',ex:'true'},{p:'animationTooltipDateFormat',ex:'yyyymmddhhmm'},{p:'animationMode',ex:'sliding|frame|cumulative'},{p:'animationWindow',ex:'1 day|2 weeks|3 months|1 year|2 decades|etc'},{p:'animationStep',ex:'1 day|2 weeks|3 months|1 year|2 decades|etc'},{p:'animationSpeed',ex:500},{p:'animationLoop',ex:true},{p:'animationDwell',ex:1000},{p:'animationStartShowAll',ex:true,tt:'Show full range at start'},{p:'animationShowButtons',ex:false},{p:'animationShowSlider',ex:false},{p:'animationWidgetShort',ex:true}];displayDefineMembers(this,myProps,{displayReady:Utils.getPageLoaded(),type:argType,displayManager:argDisplayManager,filters:[],dataCollection:new DataCollection(),selectedCbx:[],entries:[],wikiAttrs:[TITLE,"showTitle","showDetails","minDate","maxDate"],_properties:[],getWikiEditorTags:function(){return this._wikiTags;},getTypeDef:function(){return this.typeDef;},getTypeLabel:function(){if(!this.typeDef)return null;return this.typeDef.label;},getTypeHelpUrl:function(){if(!this.typeDef)return null;let helpUrl=this.typeDef.helpUrl;if(!helpUrl)return null;if(helpUrl===true){return"https://ramadda.org/repository/alias/help_"+this.typeDef.type;}
return helpUrl;},defineSizeByProperties:function(){this.defineProperties([{inlineLabel:'Size By'},{p:'sizeBy',ex:'field',tt:'Field to size points by'},{p:'sizeByLog',ex:true,tt:'Use log scale for size by'},{p:'sizeByMap',ex:'value1:size,...,valueN:size',tt:'Define sizes if sizeBy is text'},{p:'sizeByRadiusMin',ex:'2',tt:'Scale size by'},{p:'sizeByRadiusMax',ex:'20',tt:'Scale size by'},{p:'sizeByLegendSide',ex:'bottom|top|left|right'},,{p:'sizeByLegendStyle'},{p:'sizeBySteps',ex:'value1:size1,v2:s2,...',tt:'Use steps for sizes'},]);},getDisplayManager:function(){return this.displayManager;},getLayoutManager:function(){return this.getDisplayManager().getLayoutManager();},addToDocumentUrl:function(key,value){HU.addToDocumentUrl("display"+this.displayCount+"."+key,value);},createTagDialog:function(cbxs,anchor,cbxChange,type,label){let cbxInner=HU.div([STYLE,HU.css("margin","5px","width","600px;","max-height","300px","overflow-y","auto")],Utils.wrap(cbxs,"",""));let inputId=HU.getUniqueId("input_");let input=HU.input("","",[STYLE,HU.css("width","300px;"),'placeholder','Search for '+label.toLowerCase(),ID,inputId]);let contents=HU.div([STYLE,HU.css("margin","10px")],HU.center(input)+cbxInner);if(!this.tagDialogs)this.tagDialogs={};if(this.tagDialogs[type])this.tagDialogs[type].remove();let dialog=HU.makeDialog({content:contents,anchor:anchor,title:label,draggable:true,header:true});this.tagDialogs[type]=dialog;dialog.find(":checkbox").change(cbxChange);let tags=dialog.find(".display-search-tag");$("#"+inputId).keyup(function(event){let text=$(this).val().trim().toLowerCase();tags.each(function(){if(text=="")
$(this).show();else{let tag=$(this).attr("tag");if(tag){tag=tag.toLowerCase();if(tag.indexOf(text)>=0)
$(this).show();else
$(this).hide();}}});});return dialog;},getAnimationEnabled:function(){return this.getProperty("doAnimation",false);},getAnimation:function(){if(!this.animationControl){this.animationControl=new DisplayAnimation(this,this.getAnimationEnabled());}
return this.animationControl;},propagateEvent:function(event,data){this.getDisplayManager().notifyEvent(event,this,data);},displayError:function(msg){this.displayHtml(HU.getErrorDialog(msg));},clearHtml:function(){this.displayHtml("");},displayHtml:function(html){this.setContents(html);},getEventHandler:function(event){return this[event.handler];},notifyEvent:function(event,source,data){let func=this.getEventHandler(event);if(func==null){if(displayDebug.notifyEvent)
console.log(this.type+".notifyEvent no event handler function:"+event.name+" "+event.handler);return;}
if(displayDebug.notifyEvent)
console.log(this.type+".notifyEvent calling function:"+func.name);func.apply(this,[source,data]);},getColorTableHorizontal:function(){return this.getProperty("colorTableSide","bottom")=="bottom"||this.getProperty("colorTableSide","bottom")=="top";},displayColorTable:function(ct,domId,min,max,args){if(!args)args={};args.showColorTableDots=this.getProperty("showColorTableDots");args.decimals=this.getProperty("colorTableDotsDecimals",-1);args.showRange=this.getProperty("colorTableShowRange");let labels=this.getProperty("colorTableLabels");args.labels=labels?labels.split(","):null;args.labelStyle=this.getProperty("colorTableLabelStyle","font-size:12pt;");args.horizontal=this.getColorTableHorizontal();args.stride=this.getProperty("showColorTableStride",1);Utils.displayColorTable(ct,this.getDomId(domId),min,max,args);if(!args||!args.colorByInfo)return;this.jq(domId).find(".display-colortable-slice").css("cursor","pointer");let _this=this;if(!this.originalColorRange){this.originalColorRange=[min,max];}
this.jq(domId).find(".display-colortable-slice").click(function(e){let val=$(this).attr("data-value");let popup=HtmlUtils.getTooltip();HtmlUtils.setPopupObject(popup);let html="";html+=HU.div([CLASS,"ramadda-menu-item","what","setmin"],"Set range min to "+Utils.formatNumber(val));html+=HU.div([CLASS,"ramadda-menu-item","what","setmax"],"Set range max to "+Utils.formatNumber(val));html+=HU.div([CLASS,"ramadda-menu-item","what","reset"],"Reset range");if(_this.getProperty("colorByLog")){html+=HU.div([CLASS,"ramadda-menu-item","what","togglelog"],"Use linear scale");}else{html+=HU.div([CLASS,"ramadda-menu-item","what","togglelog"],"Use log scale");}
html+=Utils.getColorTablePopup();popup.html(html);$(popup).find(".ramadda-colortable-select").click(function(){let ct=$(this).attr("colortable");if(ct){console.log("color table:"+ct);_this.setProperty("colorTable",ct);_this.forceUpdateUI();}});popup.show();popup.position({of:$(this),my:'left top',at:'left bottom',collision:"none none"});popup.find(".ramadda-menu-item").click(function(){let what=$(this).attr("what");if(what=="reset"){_this.setProperty("colorByMin",_this.getProperty("colorByMinOrig"));_this.setProperty("colorByMax",_this.getProperty("colorByMaxOrig"));_this.setProperty("overrideColorRange",false);}else if(what=="togglelog"){if(!_this.getProperty("colorByLog"))
_this.setProperty("colorByLog",true);else
_this.setProperty("colorByLog",false);}else if(what=="setmin"){if(!Utils.isDefined(_this.getProperty("colorByMinOrig"))){_this.setProperty("colorByMinOrig",_this.getProperty("colorByMin"));}
_this.setProperty("colorByMin",val);_this.setProperty("overrideColorRange",true);}else{if(!Utils.isDefined(_this.getProperty("colorByMaxOrig"))){_this.setProperty("colorByMaxOrig",_this.getProperty("colorByMax"));}
_this.setProperty("colorByMax",val);_this.setProperty("overrideColorRange",true);}
_this.forceUpdateUI();});});},getUnhighlightColor:function(){return this.getProperty("unhighlightColor","#eee");},getColorList:function(){if(this.colorList&&this.colorList.length>0){return this.colorList;}
if(this.getProperty("colors")&&this.getProperty("colors")!="default"){var v=this.getProperty("colors");if(!Array.isArray(v)){v=v.split(",");}
this.colorList=v;}
if(!this.colorList||this.colorList.length==0){this.colorList=['blue','red','green','orange','fuchsia','aqua','navy','brown','cadetblue','blueviolet','coral','cornflowerblue','darkcyan','darkgoldenrod','darkorange','darkseagreen'];}
return this.colorList;},getColorTableName:function(names){if(names&&!Array.isArray(names)){names=[names];}
let ct=null;if(names){names.every(name=>{ct=this.getProperty(name);if(ct)return false;return true;});}else{var colorBy=this.getProperty("colorBy");if(colorBy){ct=this.getProperty("colorTable."+colorBy);}
if(!ct){ct=this.getProperty("colorBar",this.getProperty("colorTable"));}}
if(ct=="none")return null;return ct;},getColorTable:function(justColors,name,dflt){let colorTable=this.getColorTableName(name);if(!colorTable){colorTable=dflt;}
return this.getColorTableInner(justColors,colorTable);},getColorTableInner:function(justColors,colorTable){let list;if(colorTable){let ct=null;if(colorTable.startsWith("colors:")){list=colorTable.substring("colors:".length).split(",");return this.convertColors(list);}
ct=Utils.ColorTables[colorTable];if(ct&&justColors){return this.convertColors(ct.colors);}
if(!ct&&name){return this.convertColors(colorTable.split(","));}
return ct;}
if(this.getProperty("colors")&&this.getProperty("colors")!="default"){var colors=this.getProperty("colors");if((typeof colors)!="object")colors=colors.split(",");return this.convertColors(colors);}
return null;},addAlpha:function(colors,alpha){if(!colors)return null;alpha=Utils.isDefined(alpha)?alpha:this.getProperty("colorTableAlpha");if(!alpha)return colors;colors=Utils.cloneList(colors);var ac=[];colors.forEach((c)=>{ac.push(Utils.addAlphaToColor(c,alpha));});return ac;},convertColors:function(colors){colors=this.addAlpha(colors);if(this.getColorTableInverse()){let tmp=[];for(let i=colors.length-1;i>=0;i--)
tmp.push(colors[i]);colors=tmp;}
if(this.getProperty("colorTablePruneLeft")){let tmp=[];for(let i=+this.getProperty("colorTablePruneLeft");i<colors.length;i++){tmp.push(colors[i]);}
colors=tmp;}
if(this.getProperty("colorTablePruneRight")){let tmp=[];let d=+this.getProperty("colorTablePruneRight");for(let i=0;i<colors.length-d;i++){tmp.push(colors[i]);}
colors=tmp;}
return colors;},getColorByColors:function(records,dfltColorTable){var colorBy=this.getProperty("colorBy");if(!colorBy){return null;}
var colorByField=this.getFieldById(fields,colorBy);if(!colorByField){return null;}
var obj=this.getColumnValues(records,colorByField);var colors=this.getColorTable();if(!colors)colors=Utils.getColorTable(dfltColorTable||"blue_white_red");if(!colors)return null;var min=parseFloat(this.getProperty("colorByMin",obj.min));var max=parseFloat(this.getProperty("colorByMax",obj.max));if(colors.colors)colors=colors.colors;var range=max-min;var colorValues=[];for(var i=0;i<obj.values.length;i++){var value=obj.values[i];var percent=(value-min)/range;var index=parseInt(percent*colors.length);if(index>=colors.length)index=colors.length-1;else if(index<0)index=0;colorValues.push(colors[index]);}
return{colors:colorValues,min:min,max:max};},getDefaultGridByArgs:function(){let doHeatmap=this.getProperty("doHeatmap",false);let args={display:this,shape:this.getProperty("cellShape","rect"),color:this.getProperty("cellColor","blue"),stroke:!this.getProperty("cellFilled",true),cellSize:this.getProperty("cellSize",doHeatmap?0:4),cellSizeH:this.getProperty("cellSizeH",20),cellSizeHBase:this.getProperty("cellSizeHBase",0),cell3D:this.getProperty("cell3D",false),cellShowText:this.getProperty("cellShowText",false),cellLabels:Utils.split(this.getProperty("cellLabels")),cellFonts:Utils.split(this.getProperty("cellFonts")),cellLabelColors:Utils.split(this.getProperty("cellLabelColor")),cellLabelPositions:Utils.split(this.getProperty("cellLabelPositions")),cellLabelOffsetsX:Utils.split(this.getProperty("cellLabelOffsetsX")),cellLabelOffsetsY:Utils.split(this.getProperty("cellLabelOffsetsY")),doHeatmap:doHeatmap,operator:this.getProperty("hm.operator","count"),filter:this.getProperty("hm.filter")};args.cellSizeX=+this.getProperty("cellSizeX",args.cellSize);args.cellSizeY=+this.getProperty("cellSizeY",args.cellSize);return args;},getIconMap:function(){var iconMap;var iconMapProp=this.getProperty("iconMap");if(iconMapProp){var toks=iconMapProp.split(",");iconMap={};for(var i=0;i<toks.length;i++){var toks2=toks[i].split(":");if(toks2.length>1){iconMap[toks2[0]]=toks2[1];}}}
return iconMap;},getColorByInfo:function(records,prop,colorByMapProp,defaultColorTable,propPrefix,lastColorBy){let pointData=this.getData();if(pointData==null)return null;if(this.getProperty("colorByAllRecords")){records=pointData.getRecords();}
let fields=pointData.getRecordFields();return new ColorByInfo(this,fields,records,prop,colorByMapProp,defaultColorTable,propPrefix,null,null,lastColorBy);},getColorByMap:function(prop){prop=this.getProperty(prop||"colorByMap");this.debugGetProperty=false;return Utils.parseMap(prop);},toString:function(){return this.type+" - "+this.getId();},getType:function(){return this.type;},getClass:function(suffix){if(suffix==null){return this.getBaseClass();}
return this.getBaseClass()+"-"+suffix;},getBaseClass:function(){return"display-"+this.getType();},setDisplayManager:function(cm){this.displayManager=cm;this.setDisplayParent(cm.getLayoutManager());},setContents:function(contents,dontWrap){this.clearDisplayMessage();if(!dontWrap)
contents=HU.div([ATTR_CLASS,"display-contents-inner display-"+this.getType()+"-inner"],contents);this.writeHtml(ID_DISPLAY_CONTENTS,contents);},addEntry:function(entry){this.entries.push(entry);},clearCachedData:function(){},setEntry:function(entry){if(displayDebug.setEntry)
console.log(this.type+".setEntry:"+entry);this.entries=[];this.addEntry(entry);this.entry=entry;this.entryId=entry.getId();this.clearCachedData();if(this.properties.theData){this.dataCollection=new DataCollection();let attrs={entryId:this.entryId,lat:this.getProperty("latitude"),lon:this.getProperty("longitude"),};let oldUrl=this.properties.theData.url;if(!oldUrl){oldUrl=this.getRamadda().getRoot()+"/entry/show?entryid="+entry.getId()+"&output=points.product&product=points.json&max=5000";}else{oldUrl=oldUrl.replace(/entryid=.*?&/,"entryid="+entry.getId()+"&");}
this.properties.theData=this.data=new PointData(entry.getName(),null,null,oldUrl,attrs);this.startProgress();this.data.loadData(this);}else{this.callUpdateUI();}
var title="";if(this.getShowTitle()){this.jq(ID_TITLE).html(entry.getName());}},getTextColor:function(property,dflt){if(property)return this.getProperty(property,this.getProperty("textColor",dflt));return this.getProperty("textColor","#000");},getTitleHtml:function(title){var titleToShow="";if(this.getShowTitle()){var titleStyle=HU.css("color",this.getTextColor("titleColor","#000"));var bg=this.getProperty("titleBackground");if(bg)titleStyle+=HU.css('background',bg,'padding','2px','padding-right','6px','padding-left','6px');titleToShow=this.getShowTitle()?this.getDisplayTitle(title):"";let entryId=this.getProperty("entryId")||this.entryId;if(entryId){titleToShow=HU.href(this.getRamadda().getEntryUrl(entryId),titleToShow,[ATTR_CLASS,"display-title",STYLE,titleStyle]);}
titleToShow=HU.span([ID,this.domId(ID_TITLE)],titleToShow);}
if(this.getProperty("showEntryIcon")){let icon=this.getProperty("entryIcon");if(icon)titleToShow=HU.image(icon)+" "+titleToShow;}
return titleToShow;},handleEventMapClick:function(source,args){if(!this.dataCollection)return;var pointData=this.dataCollection.getList();for(var i=0;i<pointData.length;i++){pointData[i].handleEventMapClick(this,source,args.lon,args.lat);}},acceptEvent:function(event,dflt){return this.getProperty(event.accept,dflt);},shareEvent:function(event,dflt){return this.getProperty(event.share,dflt);},handleEventMapBoundsChanged:function(source,args){if(this.acceptEvent(DisplayEvent.mapBoundsChanged,this.getProperty("acceptBoundsChange"))){this.filterBounds=args.bounds;this.callUpdateUI();}},handleEventFilterFieldsSelected:function(source,fields){if(fields.length>0&&(typeof fields[0]=="string")){var tmp=[];fields.forEach(f=>{f=this.getFieldById(null,f);if(f)tmp.push(f);});fields=tmp;}
let prop="";fields.forEach(f=>{if(prop!="")prop+=",";prop+=f.getId();});this.setProperty("filterFields",prop);this.haveCalledUpdateUI=false;this.checkSearchBar();},handleEventFieldValueSelected:function(source,args){this.setProperty("filterPattern",args.value);this.setProperty("patternFilterField",args.field.getId());this.callUpdateUI();},setDateRange:function(min,max,doDay){this.minDateObj=min;this.maxDateObj=max;this.dateRangeDoDay=doDay;},handleDateRangeChanged:function(source,prop){this.setDateRange(prop.minDate,prop.maxDate);if(this.getAnimation().getEnabled()){this.getAnimation().setDateRange(prop.minDate,prop.maxDate);}
this.haveCalledUpdateUI=false;this.dataFilterChanged();},displayFieldsChanged:function(val,fromElsewhere){this.addToDocumentUrl(PROP_FIELDS,val);this.setProperty(PROP_FIELDS,val);this.callUpdateUI();if(this.displayFieldsMenuEnums&&fromElsewhere&&this.getProperty("showDisplayFieldsMenu")){let selected=[];this.jq("displayfields").val(val);}},handleEventFilterChanged:function(source,prop){if(!this.acceptEvent(DisplayEvent.filterChanged,this.getProperty("acceptEventFilter",true))){return;}
this.haveCalledUpdateUI=false;let properties=prop.properties;if(!properties){properties=[];properties.push(prop);}
this.settingFilterValue=true;properties.forEach(prop=>{let filter=this.filterMap?this.filterMap[prop.fieldId]:null;if(!filter)return;let widgetId=this.getFilterId(prop.fieldId);if(prop.id&&prop.id.endsWith("date1")){widgetId+="_date1";}else if(prop.id&&prop.id.endsWith("date2")){widgetId+="_date2";}
if(prop.fieldId=="_highlight"){this.jq(ID_FILTER_HIGHLIGHT).val(prop.value);this.setProperty("filterHighlight",prop.value=="highlight");}else if(Utils.isDefined(prop.value2)){$("#"+widgetId+"_min").val(prop.value);$("#"+widgetId+"_min").attr("data-value",prop.value);$("#"+widgetId+"_max").val(prop.value2);$("#"+widgetId+"_max").attr("data-value",prop.value2);}else{filter.handleEventPropertyChanged(prop);}});this.settingFilterValue=false;this.dataFilterChanged();},handleEventPropertyChanged:function(source,prop){let debug=displayDebug.handleEventPropertyChanged;if(prop.property=="dateRange"){if(this.getProperty("acceptDateRangeChange")){this.handleDateRangeChanged(source,prop);}
return;}
if(prop.property=="displayFields"){if(!this.acceptEvent(DisplayEvent.fieldsChanged,!this.getProperty("acceptEventDisplayFieldsChange",false))){return;}
this.displayFieldsChanged(prop.value,true);return}
if(prop.property=="macroValue"){if(prop.entryId!=this.entryId)return;if(!this.getProperty("acceptRequestChangeEvent",true)){return;}
let macros=this.getRequestMacros();let macro=null;macros.every(m=>{if(m.isMacro(prop.id)){macro=m;return false;}
return true;});if(!macro){return;}
if(!this.getProperty("request."+macro.name+".acceptChangeEvent",true)){return;}
macro.setValue(prop);if(debug)
console.log(this.getId()+" event-reloading");this.reloadData();return;}
this.setProperty(prop.property,prop.value);this.callUpdateUI();},handleEventRecordList:function(source,args){if(this.getAnimationEnabled()&&this.getProperty("animationHighlightRecordList")){this.getAnimation().setRecordListHighlight(args.recordList);}
if(this.getProperty("acceptEventRecordList",false)){this.recordListOverride=args.recordList;this.haveCalledUpdateUI=false;this.callUpdateUI();}},handleEventRecordHighlight:function(source,args){if(this.getAnimation().getEnabled()&&!args.skipAnimation){this.getAnimation().handleEventRecordHighlight(source,args);}},handleEventAnimationChanged:function(source,args){if(!this.getProperty("acceptEventAnimationChange",true))return;if(this.getAnimation().getEnabled()){this.getAnimation().handleEventAnimationChanged(args);}},handleEventSetEntry:function(source,args){if(this.acceptEvent(DisplayEvent.setEntry,this.getProperty(DisplayEvent.setEntry.acceptGroup,this.getProperty("acceptShareSelectedEntry",false)))){if(displayDebug.setEntry)
console.log(this.type+".handleEventSetEntry calling setEntry:"+args.entry);this.setEntry(args.entry);}else{if(displayDebug.setEntry)
console.log(this.type+".handleEventSetEntry not calling setEntry:"+args.entry);}},propagateEventRecordSelection:function(args){if(displayDebug.notifyEvent)
console.log(this.type+".propagateEventRecordSelection");if(this.shareEvent(DisplayEvent.setEntry,this.getProperty(DisplayEvent.setEntry.shareGroup,this.getProperty("shareSelectedEntry")))){let entryId=args.record.getValueFromField("id");if(displayDebug.setEntry)
console.log(this.type+" sharing entry:"+entryId);if(entryId){let _this=this;setTimeout(async function(){await getGlobalRamadda().getEntry(entryId,entry=>{if(displayDebug.setEntry)
console.log(_this.type+" calling notifyEvent with entry:"+entry);_this.getDisplayManager().notifyEvent(DisplayEvent.setEntry,_this,{entry:entry});});});}}
if(this.shareEvent(DisplayEvent.recordSelection,true)){this.getDisplayManager().notifyEvent(DisplayEvent.recordSelection,this,args);}
if(this.getProperty("recordSelectFilterFields")){let fields=this.getFieldsByIds(null,this.getProperty("recordSelectFilterFields"));if(fields&&fields.length>0){let props={properties:[]};fields.forEach(field=>{props.properties.push({id:field.getId(),fieldId:field.getId(),value:args.record.getValue(field.getIndex())});})
this.propagateEvent(DisplayEvent.filterChanged,props);}}},handleEventRecordSelection:function(source,args){this.selectedRecord=args.record;if(this.selectedRecord){if(this.getProperty("colorThresholdField")){this.haveCalledUpdateUI=false;this.callUpdateUI();}}
if(!source.getEntries){return;}
let entries=source.getEntries();for(let i=0;i<entries.length;i++){let entry=entries[i];let containsEntry=this.getEntries().indexOf(entry)>=0;if(containsEntry){this.highlightEntry(entry);break;}}},areaClear:function(){this.getDisplayManager().notifyEvent("areaClear",this);},handleEventEntryMouseover:function(source,args){},handleEventEntryMouseout:function(source,args){},handleEventEntrySelection:function(source,args){var containsEntry=this.getEntries().indexOf(args.entry)>=0;if(!containsEntry){return;}
if(args.selected){this.jq(ID_TITLE).addClass("display-title-select");}else{this.jq(ID_TITLE).removeClass("display-title-select");}},highlightEntry:function(entry){this.jq(ID_TITLE).addClass("display-title-select");},getEntries:function(){return this.entries;},getDisplayEntry:async function(callback){var entries=this.getEntries();if(entries!=null&&entries.length>0){return Utils.call(callback,entries[0]);}
let entryId=this.entryId||this.getProperty("entryId");if(entryId){var entry;await this.getRamadda().getEntry(entryId,e=>{entry=e
Utils.call(callback,entry);});}else{Utils.call(callback,null);}},hasEntries:function(){return this.entries!=null&&this.entries.length>0;},getWaitImage:function(){return HU.image(ramaddaBaseUrl+"/icons/progress.gif");},useDisplayMessage:function(){return true;},setDisplayMessage:function(msg){let contents=this.jq(ID_DISPLAY_CONTENTS);let minHeight=contents.css("min-height");if(!minHeight||minHeight=="0px"){contents.css("min-height","75px");contents.attr("display-set-minheight","true");}
this.jq(ID_DISPLAY_MESSAGE).html(msg).show();},clearDisplayMessage:function(){let contents=this.jq(ID_DISPLAY_CONTENTS);this.jq(ID_DISPLAY_MESSAGE).hide();if(contents.attr("display-set-minheight")!=null){contents.css("min-height","");}},getLoadingMessage:function(msg){if(this.getAcceptEventDataSelection()){return"";}
if(!msg&&!this.getProperty("theData")){msg="No data specified"}
if(!msg)msg=this.getProperty("loadingMessage","icon_progress Loading data...");if(msg=="")return"";msg=msg.replace("icon_progress",HU.image(icon_progress));if(this.useDisplayMessage()){return SPACE+msg;}
return HU.div([STYLE,HU.css("text-align","center")],this.getMessage(SPACE+msg));},reloadData:function(){this.startProgress();this.haveCalledUpdateUI=false;if(this.getProperty("okToLoadData",true)){let pointData=this.dataCollection.getList()[0];pointData.loadData(this,true);}},getMessage:function(msg){return HU.div([ATTR_CLASS,"display-output-message"],msg);},getNoDataMessage:function(){return this.getProperty("noDataMessage","No data available");},getFieldValue:function(id,dflt){var jq=$("#"+id);if(jq.length>0){return jq.val();}
return dflt;},getFieldValues:function(id,dflt){var jq=$("#"+id);if(jq.length>0){let v=[];jq.each(function(){v.push($(this).val());});return v;}
return dflt;},getFooter:function(){return HU.div([ATTR_ID,this.getDomId(ID_FOOTER),ATTR_CLASS,"display-footer"],HU.leftRight(HU.div([ATTR_ID,this.getDomId(ID_FOOTER_LEFT),ATTR_CLASS,"display-footer-left"],""),HU.div([ATTR_ID,this.getDomId(ID_FOOTER_RIGHT),ATTR_CLASS,"display-footer-right"],"")));},shouldSkipField:function(field){if(this.skipFields&&!this.skipFieldsList){this.skipFieldsList=this.skipFields.split(",");}
if(this.skipFieldsList){return this.skipFieldsList.indexOf(field.getId())>=0;}
return false;},fieldSelected:function(event){this.userHasSelectedAField=true;this.selectedFields=null;this.overrideFields=null;this.removeProperty(PROP_FIELDS);this.fieldSelectionChanged();if(event.shiftKey){let fields=this.getSelectedFields();this.propagateEvent(DisplayEvent.fieldsSelected,fields);}},addFieldsCheckboxes:function(argFields){if(!this.hasData()){return;}
var fixedFields=this.getPropertyFields()
if(fixedFields!=null){if(fixedFields.length==0){fixedFields=null;}}
let fieldsMap=null;if(fixedFields!=null){if(!Array.isArray(fixedFields))fixedFields=fixedFields.split(",");fieldsMap={};fixedFields.forEach(id=>{if(id.startsWith("#")){let toks=id.split("-");if(toks.length==2){let idx1=+toks[0].replace("#","");let idx2=+toks[1].replace("#","");for(let i=idx1;i<=idx2;i++){fieldsMap["#"+i]=true;}}}
fieldsMap[id]=true;});}
var html="";var checkboxClass=this.getId()+"_checkbox";var groupByClass=this.getId()+"_groupby";var dataList=this.dataCollection.getList();if(argFields!=null){this.overrideFields=[];}
var seenLabels={};let badFields={};let flags=null;for(var collectionIdx=0;collectionIdx<dataList.length;collectionIdx++){let pointData=dataList[collectionIdx];let fields=this.getFieldsToSelect(pointData);if(this.canDoGroupBy()){let allFields=pointData.getRecordFields();let cnt=0;for(i=0;i<allFields.length;i++){let field=allFields[i];if(field.getType()!="string")continue;if(cnt==0){html+=HU.div([ATTR_CLASS,"display-dialog-subheader"],"Group By");html+=HU.open(TAG_DIV,[ATTR_CLASS,"display-fields"]);var on=this.groupBy==null||this.groupBy=="";html+=HU.tag(TAG_DIV,[ATTR_TITLE,"none"],HU.radio("none",this.getDomId("groupby"),groupByClass,"none",!on)+" None");}
cnt++;var on=this.groupBy==field.getId();var idBase="groupby_"+collectionIdx+"_"+i;field.radioId=this.getDomId(idBase);html+=HU.tag(TAG_DIV,[ATTR_TITLE,field.getId()],HU.radio(field.radioId,this.getDomId("groupby"),groupByClass,field.getId(),on)+" "+field.getUnitLabel()+" ("+field.getId()+")");}
if(cnt>0){html+=HU.close(TAG_DIV);}}
let disabledFields="";if(fields.length>0){let selected=this.getSelectedFields([]);let selectedIds=[];for(let i=0;i<selected.length;i++){selectedIds.push(selected[i].getId());}
html+=HU.div([ATTR_CLASS,"display-dialog-subheader"],"Displayed Fields");html+=HU.open(TAG_DIV,[ATTR_CLASS,"display-fields"]);for(let tupleIdx=0;tupleIdx<fields.length;tupleIdx++){let field=fields[tupleIdx];let idBase="cbx_"+collectionIdx+"_"+tupleIdx;field.checkboxId=this.getDomId(idBase);let on=false;let hasValues=(flags?flags[field.getIndex()]:true);if(argFields!=null){for(var fIdx=0;fIdx<argFields.length;fIdx++){if(argFields[fIdx].getId()==field.getId()){on=true;this.overrideFields.push(field.getId());break;}}}else if(selectedIds.length>0){on=selectedIds.indexOf(field.getId())>=0;}else if(fieldsMap!=null){on=fixedFields[field.getId()];if(!on){on=fixedFields["#"+(tupleIdx+1)];}
}else if(this.overrideFields!=null){on=this.overrideFields.indexOf(field.getId())>=0;if(!on){on=(this.overrideFields.indexOf("#"+(tupleIdx+1))>=0);}
}else{if(this.selectedCbx.indexOf(field.getId())>=0){on=true;}else if(this.selectedCbx.length==0){on=(i==0);}
}
let label=field.getUnitLabel();if(seenLabels[label]){label=label+" "+seenLabels[label];seenLabels[label]++;}else{seenLabels[label]=1;}
if(!hasValues){disabledFields+=HU.div([],label);}else{if(field.derived){label+=" (derived)";}
var widget;if(this.canDoMultiFields()){widget=HU.checkbox(field.checkboxId,[CLASS,checkboxClass],on);}else{widget=HU.radio(field.checkboxId,"field_radio",checkboxClass,"",on);}
html+=HU.tag(TAG_DIV,[ATTR_TITLE,field.getId()],widget+" "+label);}
}}
if(disabledFields!=""){html+=HU.div([STYLE,HU.css("border-top","1px #888  solid")],"<b>No Data Available</b>"+disabledFields);}
html+=HU.close(TAG_DIV);}
this.writeHtml(ID_FIELDS,html);this.userHasSelectedAField=false;let theDisplay=this;$("."+checkboxClass).click(function(event){theDisplay.fieldSelected(event);});$("."+groupByClass).change(function(event){theDisplay.groupBy=$(this).val();if(theDisplay.displayData){theDisplay.displayData();}});},fieldSelectionChanged:function(){var name="the display";this.setDisplayTitle();if(this.displayData){this.clearCachedData();this.displayData();}},defaultSelectedToAll:function(){return true;},setSelectedFields:function(fields){this.clearCachedData();this.selectedFields=fields;this.addFieldsCheckboxes(fields);},getSelectedFields:function(dfltList){let debug=displayDebug.getSelectedFields;if(debug)
console.log(this.type+".getSelectedFields");if(this.getBinDate()){var binType=this.getBinType("total");var binCount=binType=="count";if(binCount){var fields=[];fields.push(new RecordField({id:binType,label:this.getProperty("binDateLabel",this.getProperty("binCountLabel","Count")),type:"double",chartable:true}));return fields;}}
this.debugSelected=debug;this.lastSelectedFields=this.getSelectedFieldsInner(dfltList);let notFields=this.getProperty("notFields");if(notFields){let tmp=[];this.lastSelectedFields.forEach(f=>{if(f.getId().match(notFields)||f.getLabel().match(notFields))return;tmp.push(f);});this.lastSelectedFields=tmp;}
if(debug)
console.log("\tsetting lastSelectedFields:"+this.lastSelectedFields);let fixedFields=this.getPropertyFields();this.setDisplayTitle();if(this.getBinDate()){var binType=this.getProperty("binType","total");let fields=[];this.lastSelectedFields.forEach(field=>{if(!field.isNumeric()){fields.push(field);}else{const prefix=binType;if(field.getId().startsWith(prefix)){fields.push(field);}else{fields.push(new RecordField({id:prefix+"_"+field.getId(),index:field.getIndex(),label:this.getProperty("binDateLabel",Utils.camelCase(binType)+" of "+field.getLabel()),type:"double",chartable:field.isChartable()}));}}});this.lastSelectedFields=fields;console.log("BIN DATE:"+this.lastSelectedFields);}
return Utils.cloneList(this.lastSelectedFields);},getSelectedFieldsInner:function(dfltList){if(this.debugSelected){console.log("getSelectedFieldsInner dflt:"+(dfltList?dfltList:"null"));console.log("\tlast selected = "+this.lastSelectedFields);}
if(this.selectedFields){if(this.debugSelected)
console.log("\treturning this.selectedFields:"+this.selectedFields);return this.selectedFields;}
var df=[];var dataList=this.dataCollection.getList();var fixedFields=this.getPropertyFields();if(fixedFields&&(typeof fixedFields)=="string"){fixedFields=fixedFields.split(",");}
if(fixedFields){let tmpFields=[];fixedFields.forEach(tok=>{if(!tok.match("-")){tmpFields.push(tok);return;}
let pair=tok.split("-");let i1=parseFloat(pair[0].trim().substring(1));let i2=parseFloat(pair[1].trim().substring(1));for(let i=i1;i<=i2;i++)tmpFields.push("#"+i);});fixedFields=tmpFields;}
let aliases={};var tmp=this.getProperty("fieldAliases");if(tmp){tmp.split(",").forEach(tok=>{[name,alias]=tok.split(":");aliases[alias]=name;});}
for(var collectionIdx=0;collectionIdx<dataList.length;collectionIdx++){var pointData=dataList[collectionIdx];var fields=this.getFieldsToSelect(pointData);if(fixedFields!=null&&fixedFields.length>0){if(this.debugSelected)
console.log("\thave fixed fields:"+fixedFields.length);let selected=[];for(var i=0;i<fixedFields.length;i++){var sfield=fixedFields[i];if(sfield=="*"){selected=fields;break;}
var field=this.getFieldById(fields,sfield);if(field){selected.push(field);}}
if(this.getProperty("fieldsNumeric")){selected=selected.filter(f=>f.isNumeric());}
df=selected;}}
if(fixedFields!=null&&fixedFields.length>0){if(this.debugSelected)
console.log("\tfrom fixed:"+df.length);return df;}
var fieldsToSelect=null;var firstField=null;this.selectedCbx=[];var cbxExists=false;for(var collectionIdx=0;collectionIdx<dataList.length;collectionIdx++){var pointData=dataList[collectionIdx];fieldsToSelect=this.getFieldsToSelect(pointData);for(i=0;i<fieldsToSelect.length;i++){var field=fieldsToSelect[i];if(firstField==null&&field.isNumeric())firstField=field;var idBase="cbx_"+collectionIdx+"_"+i;var cbxId=this.getDomId(idBase);var cbx=$("#"+cbxId);if(cbx.length>0){cbxExists=true;}else{continue;}
if(cbx.is(':checked')){this.selectedCbx.push(field.getId());df.push(field);}}}
if(df.length==0&&!cbxExists){if(this.lastSelectedFields&&this.lastSelectedFields.length>0){if(this.debugSelected)
console.log("\tlastSelectedFields:"+this.lastSelectedFields);return this.lastSelectedFields;}}
if(df.length==0){df=this.getDefaultSelectedFields(fieldsToSelect,dfltList);if(this.debugSelected)
console.log("\tusing default selected:"+df);}
return df;},getDefaultSelectedFields:function(fields,dfltList){let debug=displayDebug.getDefaultSelectedFields;if(debug)
console.log("getDefaultSelectedFields");if(this.defaultSelectedToAll()){let allFields=this.getFields();if(allFields){var tmp=[];for(i=0;i<allFields.length;i++){var field=allFields[i];if(!field.isFieldGeo()){tmp.push(field);}}}
if(debug)
console.log("\treturning allFields:"+tmp);return tmp;}
if(dfltList!=null){if(debug)
console.log("\treturning dfltList:"+dfltList);return dfltList;}
for(i=0;i<fields.length;i++){var field=fields[i];if(field.isNumeric()&&!field.isFieldGeo())return[field];}
return[];},sortRecords:function(records,sortFields){if(!sortFields){let f=this.getProperty("sortFields","",true);if(f=="${fields}")f=this.getProperty("fields","",true);sortFields=this.getFieldsByIds(null,f);if(sortFields.length==0&&this.sortByFields&&this.sortByFields.length>0){sortFields=[this.sortByFields[0]];}}
if(sortFields.length>0){records=Utils.cloneList(records);let sortAscending=this.getProperty("sortAscending",true);let cnt=0;records.sort((a,b)=>{let row1=this.getDataValues(a);let row2=this.getDataValues(b);let result=0;for(let i=0;i<sortFields.length;i++){let sortField=sortFields[i];let v1=row1[sortField.getIndex()];let v2=row2[sortField.getIndex()];if(sortField.isNumeric()||sortField.isFieldDate()){if(isNaN(v1)&&isNaN(v2)){result=0;}else if(isNaN(v1)){result=sortAscending?-1:1;}else if(isNaN(v2)){result=sortAscending?1:-1;}else{if(v1<v2)result=sortAscending?-1:1;else if(v1>v2)result=sortAscending?1:-1;else result=0;}}else{result=String(v1).localeCompare(String(v2));if(!sortAscending)result=-result;}
if(result!=0)break;}
return result;});}
if(this.getProperty("sortHighlight")){records=Utils.cloneList(records);records.sort((a,b)=>{let h1=a.isHighlight(this);let h2=b.isHighlight(this);if(h1&&!h2)
return-1;if(!h1&&h2)
return 1;return 0;});}
if(this.getProperty("reverse",false)){records=Utils.cloneList(records);let tmp=[];for(let i=records.length-1;i>=0;i--)
tmp.push(records[i]);records=tmp;}
return records;},getFieldById:function(fields,id,debug){if(debug)
console.log("getFieldById:"+id);if(fields!=null&&id==null){if(typeof fields!="string"){if(debug)
console.log("\tbadfields:"+fields);return null;}
id=fields;fields=null;}
if(!id){if(debug)
console.log("\tno id");return null;}
id=String(id).trim();if(!fields){let pointData=this.getData();if(pointData==null){if(debug)
console.log("\tno data");return null;}
fields=pointData.getRecordFields();}
let aliases={};let tmp=this.getProperty("fieldAliases");if(tmp){tmp.split(",").forEach(tok=>{[name,alias]=tok.split(":");aliases[alias]=name;});}
let theField=null;id.split("|").every(fieldId=>{let alias=aliases[fieldId];let hasRegexp=fieldId.indexOf("*")>=0;for(let i=0;i<fields.length;i++){let field=fields[i];if(debug)
console.log("\tField:"+field.getId());if(field.getId()==fieldId||fieldId==("#"+(i+1))||field.getId()==alias){theField=field;if(debug)
console.log("\tgot it:"+theField);return false;}
if(hasRegexp){if(field.getId().match(fieldId)){theField=field;if(debug)
console.log("\tgot it from pattern:"+theField);return false;}}}
return true;});if(debug)
console.log("\tgot:"+theField);return theField;},getFieldsByIds:function(fields,ids){if(!fields){let pointData=this.getData();if(pointData!=null)
fields=pointData.getRecordFields();}
let result=[];if(!ids){return result;}
if(ids=="*")return fields;if((typeof ids)=="string")
ids=ids.split(",");if(!fields){var pointData=this.getData();if(pointData==null){return null;}
fields=pointData.getRecordFields();}
for(let i=0;i<ids.length;i++){let id=ids[i];if(id.startsWith("#")){let toks=id.split("-");if(toks.length==2){let idx1=+toks[0].replace("#","");let idx2=+toks[1].replace("#","");console.log(idx1+" "+idx2);for(let j=idx1;j<=idx2;j++){let f=this.getFieldById(fields,"#"+idx1);if(f)result.push(f);}
continue;}}
let f=this.getFieldById(fields,ids[i]);if(f)result.push(f);}
return result;},getFieldByType:function(fields,type){fields=this.getFieldsByType(fields,type);if(fields.length==0)return null;return fields[0];},getFieldsByType:function(fields,type){if(!fields){let pointData=this.getData();if(pointData==null)return null;fields=pointData.getRecordFields();}
let list=[];let numeric=(type=="numeric");let isString=(type=="string");for(a in fields){let field=fields[a];if(field.isRecordDate())continue;if(type==null)return field;if(numeric){if(field.isFieldNumeric()){list.push(field);}}else if(isString){if(field.isFieldString()){list.push(field);}}else if(field.getType()==type){list.push(field);}}
return list;},getDateValues:function(records){let dates=[];records.forEach(r=>{dates.push(r.getDate());});return dates;},getColumnValues:function(records,field){var values=[];var min=Number.MAX_VALUE;var max=Number.MIN_VALUE;for(var rowIdx=0;rowIdx<records.length;rowIdx++){var record=records[rowIdx];var row=record.getData();var value=row[field.getIndex()];values.push(value);if(Utils.isNumber(value)&&!isNaN(value)){min=Math.min(min,value);max=Math.max(max,value);}}
return{values:values,min:min,max:max};},requiresGrouping:function(){return false;},makeTree:function(records){if(records==null){let pointData=this.getData();if(pointData==null)return null;records=pointData.getRecords();}
let treeTemplate=this.getProperty("treeTemplate");let treeTooltip=this.getProperty("treeTooltip");let roots=[];let idToNode={};let nodes=[];let idToRoot={};var labelField=this.getFieldById(null,this.getProperty("labelField"));var nodeFields=this.getFieldsByIds(null,this.getProperty("nodeFields"));let treeRootLabel=this.getProperty("treeRoot");let treeRoot=null;if(treeRootLabel){treeRoot={id:treeRootLabel,label:treeRootLabel,children:[],parent:null};roots.push(treeRoot);}
if(nodeFields.length>0){let cnt=0;let valueToNode={};let parentId="";records.forEach(r=>{var label=labelField==null?id:r.getValue(labelField.getIndex());let parentId=null;let parentNode=null;nodeFields.forEach(nodeField=>{let id=r.getValue(nodeField.getIndex());let nodeId=parentId?parentId+"-"+id:id;let tmpNode=idToNode[nodeId];if(!tmpNode){tmpNode={id:nodeId,label:id,children:[],parent:parentNode};idToNode[nodeId]=tmpNode;if(!parentNode){if(treeRoot){tmpNode.parent=treeRoot;treeRoot.children.push(tmpNode);}else{roots.push(tmpNode);}}
if(parentNode){parentNode.children.push(tmpNode);}}
parentId=nodeId;parentNode=tmpNode;});var id="leaf"+(cnt++);var node={id:id,label:label,children:[],record:r,parent:parentNode};parentNode.children.push(node);idToNode[id]=node;nodes.push(node);});return roots;}
let parentField=this.getFieldById(null,this.getProperty("parentField"));let idField=this.getFieldById(null,this.getProperty("idField"));if(!parentField){throw new Error("No parent field specified");}
if(!idField){throw new Error("No id field specified");}
records.forEach(r=>{var parent=r.getValue(parentField.getIndex());var id=r.getValue(idField.getIndex());var label=labelField==null?id:r.getValue(labelField.getIndex());var node={id:id,label:label,children:[],record:r,parentId:parent,parent:null};if(treeTemplate){node.display=this.getRecordHtml(r,null,treeTemplate);}
if(treeTooltip){node.tooltip=this.getRecordHtml(r,null,treeTooltip);}
idToNode[id]=node;nodes.push(node);if(parent==""){idToRoot[id]=node;if(treeRoot){node.parent=treeRoot;node.parentId=treeRoot.id;treeRoot.children.push(node);}else{roots.push(node);}}});nodes.forEach(node=>{let parentNode=idToNode[node.parentId];if(!parentNode){if(!idToRoot[node.id]){throw new Error("No parent :"+node.parentId+" for node:"+node.label);}
return;}
node.parent=parentNode;parentNode.children.push(node);});return roots;},getSegments:function(){var segments=this.getProperty("timeSegments");if(!segments)return null;var result=[];var segmentList=segments.split(",");segmentList.forEach((tok,segmentIdx)=>{var toks=tok.split(";");var name=toks[0];var start=Utils.parseDate(toks[1],false);var end=Utils.parseDate(toks[2],false);result.push({name:name,start:start,end:end});});return result;},convertPointData:function(pointData){let originalPointData=pointData;let segments=this.getSegments();if(segments){let dataList=pointData.getRecords();let newData=[];let header=[];newData.push(header);var rowIdx=0;segments.forEach((segment,segmentIdx)=>{var name=segment.name;header.push(name);var start=segment.start;var end=segment.end;var cnt=1;for(;rowIdx<dataList.length;rowIdx++){var record=dataList[rowIdx];if(record.getTime()<start.getTime()){continue;}
if(record.getTime()>end.getTime()){break;}
var value=record.getValue(1);let row=null;if(cnt>=newData.length){row=[];for(let sidx=0;sidx<segments.length;sidx++)row.push(NaN);newData.push(row);}else{row=newData[cnt];}
row[segmentIdx]=value;cnt++;}});pointData=convertToPointData(newData);pointData.entryId=originalPointData.entryId;}
try{pointData=new CsvUtil().process(this,pointData,this.getProperty("convertData"));}catch(exc){this.setErrorMessage(exc);return null;}
return pointData;},requiresGeoLocation:function(){return false;},checkDataFilters:function(dataFilters,record){if(!dataFilters){return true;}
for(let i=0;i<dataFilters.length;i++){if(!dataFilters[i].isRecordOk(record))return false;}
return true;},getDataFilters:function(v){return DataUtils.getDataFilters(this,v||this.getProperty("dataFilters"));},getFilterHighlight:function(){return this.getProperty("filterHighlight",false);},getFilterTextMatchers:function(){let highlight=[];if(this.filters){for(var filterIdx=0;filterIdx<this.filters.length;filterIdx++){let filter=this.filters[filterIdx];if(!filter.field)continue;var widget=$("#"+this.getDomId("filterby_"+filter.field.getId()));if(!widget.val||widget.val()==null)continue;var value=widget.val()||"";if(value.trim()=="")continue;highlight.push(new TextMatcher(value));}}
return highlight;},filterDataPhase2:function(records){return records;},filterData:function(records,fields,args){if(this.recordListOverride)return this.recordListOverride;let opts={doGroup:false,skipFirst:false,applyDateRange:true}
if(args)
$.extend(opts,args);let debug=displayDebug.filterData;if(this.getAnimationEnabled()){if(this.getProperty("animationFilter",true)){this.setDateRange(this.getAnimation().begin,this.getAnimation().end);}}
let highlight=this.getFilterHighlight();let startDate=this.getProperty("startDate");let endDate=this.getProperty("endDate");if(startDate){this.startDateObject=Utils.createDate(startDate,+this.getProperty("timeZoneOffset",0));if(debug)
console.log(this.type+" start date:"+startDate+" dttm:"+this.startDateObject.toUTCString());}
if(endDate){this.endDateObject=Utils.createDate(endDate,+this.getProperty("timeZoneOffset",0));if(debug)
console.log(this.type+"end date:"+this.endDateObject.toUTCString());}
let filterDate=this.getProperty("filterDate");if(filterDate){let date=$("#"+this.getFilterId(ID_FILTER_DATE)).val();if(date){if(date=="all"){this.setDateRange(null,null);}else{date=new Date(date);if(filterDate=="year"){this.setDateRange(new Date(date.getFullYear()+"-01-01"),new Date(date.getFullYear()+"-12-31"));}else if(filterDate=="day"){let f=date.getUTCFullYear()+"-"+(date.getUTCMonth()+1)+"-"+date.getUTCDate();let dttm=new Date(f);this.setDateRange(dttm,dttm,true);}else{}}}}
let pointData=this.getData();if(!records){if(pointData==null)return null;records=pointData.getRecords();}
if(!fields){fields=pointData.getRecordFields();}
if(opts.doGroup||this.requiresGrouping()){records=pointData.extractGroup(this.dataGroup,records);}
if(debug)console.log("fitler #records:"+records.length);if(this.getProperty("filterLatest")){let fields=this.getFieldsByIds(null,this.getProperty("filterLatest"));let max={};let keyToRecord={};let tmp=[];let keys=[];records.forEach(record=>{if(!record.getTime())return;let key="";fields.forEach(f=>{key+="_"+record.getValue(f.getIndex());});let maxRecord=keyToRecord[key];if(!maxRecord){keyToRecord[key]=record;keys.push(key);}else{if(record.getDate().getTime()>maxRecord.getDate().getTime())keyToRecord[key]=record;}});keys.forEach(key=>{tmp.push(keyToRecord[key]);});records=tmp;}
records.forEach(r=>{r.clearHighlight(this);});records=records.filter((record,idx)=>{let date=record.getDate();if(!date)return true;return this.dateInRange(date,idx<5&&debug);});if(debug)console.log("filter Fields:"+this.filters.length+" #records:"+records.length);if(this.filters.length){let newData=[];let logic=this.getProperty("filterLogic","and");this.filters.forEach(f=>f.prepareToFilter());if(debug)
console.log("filter:"+this.filters.length);records.forEach((record,rowIdx)=>{let allOk=true;let anyOk=false;this.filters.forEach(filter=>{if(!filter.isEnabled())return;let filterOk=filter.isRecordOk(record,rowIdx<5&&debug);if(!filterOk)allOk=false;else anyOk=true;});let ok=logic=="and"?allOk:anyOk;if(opts.skipFirst&&rowIdx==0){ok=true;}
if(highlight){newData.push(record);record.setHighlight(this,ok);}else{record.clearHighlight(this);if(ok){newData.push(record);}}});debug=false;records=newData;}
if(debug)console.log("filterData-2 #records:"+records.length);var stride=parseInt(this.getProperty("stride",-1));if(stride<0){var maxSize=parseInt(this.getProperty("maxDisplayedPoints",-1));if(maxSize>0&&records.length>0){stride=1;while(records.length/stride>maxSize){stride++;}}}
if(stride>0){var list=[];var cnt=0;for(var i=0;i<records.length;i+=(stride+1)){list.push(records[i]);}
records=list;if(debug)console.log("R-3:"+records.length);}
records=this.filterDataPhase2(records);let filterPaginate=this.getProperty("filterPaginate");if(filterPaginate){let skip=this.pageSkip||0;let count=+this.getProperty("pageCount",1000);if(skip>0||count<records.length){let tmp=[];let newSkip=skip;count=Utils.max(count,1000);while(true){if(newSkip<records.length)break;newSkip-=count;if(newSkip<0){break;}}
if(newSkip<0)newSkip=0;if(newSkip!=skip)
this.updatePaginateLabel(skip,count,records.length);skip=newSkip;console.log("skip:"+skip+" count:"+count+" "+records.length);for(let i=skip;i<records.length;i++){tmp.push(records[i]);if(tmp.length>=count)break;}
records=tmp;}}
if(this.getProperty("binDate")){let what=this.getProperty("binDate");let binType=this.getProperty("binType","total");let binCount=binType=="count";let binned=[];let record=records[0];let map={};let counts={};this.binRecordToRecords={};let keyToRecord={};for(var i=0;i<records.length;i++){let record=records[i];var tuple=this.getDataValues(record);var key;var baseDate=null
if(what=="month"){key=record.getDate().getUTCFullYear()+"-"+(record.getDate().getUTCMonth()+1);}else if(what=="day"){key=record.getDate().getUTCFullYear()+"-"+(record.getDate().getUTCMonth()+1)+"-"+record.getDate().getUTCDate();}else if(what=="week"){var week=+Utils.formatDateWeek(record.getDate());key=record.getDate().getUTCFullYear()+"-"+week;var d=(1+(week-1)*7);baseDate=new Date(record.getDate().getUTCFullYear(),0,d);}else{key=record.getDate().getUTCFullYear()+"";}
if(!Utils.isDefined(map[key])){counts[key]=1;var date=baseDate;if(!baseDate){date=Utils.parseDate(key);}
var data=Utils.cloneList(record.getData());if(binCount){for(k=0;k<data.length;k++)data[k]=1;}
var newRecord=new PointRecord(fields,record.getLatitude(),record.getLongitude(),record.getElevation(),date,data);keyToRecord[key]=newRecord;this.binRecordToRecords[newRecord.getId()]={records:[record],}
map[key]=data;binned.push(newRecord);}else{let newRecord=keyToRecord[key];this.binRecordToRecords[newRecord.getId()].records.push(record);counts[key]++;var tuple1=map[key];if(binCount){for(k=0;k<tuple1.length;k++)tuple1[k]++;continue;}
var tuple2=record.getData();for(var j=0;j<tuple2.length;j++){var v=tuple2[j];if((typeof v)!="number")continue;if(isNaN(v))continue;if(isNaN(tuple1[j]))tuple1[j]=v;else tuple1[j]+=v;}}}
if(binType=="average"){for(key in counts){var tuple=map[key];for(var j=0;j<tuple.length;j++){var v=tuple[j];if((typeof v)!="number")continue;if(isNaN(v))continue;tuple[j]=v/counts[key];}}}
records=binned;}
if(this.requiresGeoLocation()){records=records.filter(r=>{return r.hasLocation();});}
let dataFilters=this.getDataFilters();if(dataFilters.length){records=records.filter((r,idx)=>{if(!this.checkDataFilters(dataFilters,r)){return false;}
return true;});}
records=this.sortRecords(records);if(this.getProperty("uniqueField")){let ufield=this.getFieldById(null,this.getProperty("uniqueField"));let umap={};let ulist=[];for(var i=records.length-1;i>=0;i--){var record=records[i];var v=record.getValue(ufield.getIndex());if(!Utils.isDefined(umap[v])){umap[v]=true;ulist.push(record);}}
records=ulist;}
this.recordToIndex={};this.indexToRecord={};for(var i=0;i<records.length;i++){var record=records[i];this.recordToIndex[record.getId()]=i;this.indexToRecord[i]=record;}
let convertPost=this.getProperty("convertDataPost");if(convertPost){let newPointData=new PointData("pointdata",pointData.getRecordFields(),records,null,{parent:pointData});this.pointData=new CsvUtil().process(this,newPointData,convertPost);records=this.pointData.getRecords();}
if(debug)
console.log("filtered:"+records.length);this.jq(ID_FILTER_COUNT).html("Count: "+records.length);this.filteredRecords=records;return this.handleResult("filterData",records);},handleResult:function(type,data){return data;},getBinnedRecords:function(record){if(this.binRecordToRecords)
return this.binRecordToRecords[record.getId()].records;return record.parentRecords;},canDoGroupBy:function(){return false;},canDoMultiFields:function(){return true;},useChartableFields:function(){return false;},getFieldsToSelect:function(pointData){if(this.useChartableFields())
return pointData.getChartableFields(this);return pointData.getRecordFields();},getGet:function(){return"getRamaddaDisplay('"+this.getId()+"')";},assembleWikiText:function(type){var wiki="";if(window.globalDisplayProperties){for(key in window.globalDisplayProperties){wiki+='{{displayProperty name="'+key+'" value="'+window.globalDisplayProperties[key]+'"}}\n';}}
wiki+=this.getWikiText();for(var i=0;i<this.displays.length;i++){var display=this.displays[i];if(display.getIsLayoutFixed()){continue;}
wiki+=display.getWikiText();}
return wiki;},showWikiText:function(type){var wiki=this.assembleWikiText();HtmlUtils.setPopupObject(HtmlUtils.getTooltip());wiki=wiki.replace(/</g,"&lt;").replace(/>/g,"&gt;");wiki=HU.pre([STYLE,HU.css("max-width","500px","max-height","400px","overflow-x","auto","overflow-y","auto")],wiki);this.showDialog(wiki);},copyWikiText:function(type){Utils.copyText(this.assembleWikiText());alert("Wiki text has been copied to the clipboard");},publish:function(type){if(type==null)type="wikipage";var args=[];var name=prompt("Name","");if(name==null)return;args.push("name");args.push(name);args.push("type");args.push(type);var desc="";var wiki="";if(type=="wikipage"){wiki+="+section label=\"{{name}}\"\n${extra}\n";}else if(type=="blogentry"){wiki="<wiki>\n";}
wiki+=desc;wiki+=this.assembleWikiText();if(type=="wikipage"){wiki+="-section\n\n";}else if(type=="blogentry"){}
var from="";var entries=this.getChildEntries();for(var i=0;i<entries.length;i++){var entry=entries[i];from+=entry.getId()+",";}
if(entries.length>0){args.push("entries");args.push(from);}
if(type=="media_photoalbum"){wiki="";}
args.push("description_encoded");console.log(wiki);args.push(window.btoa(wiki));var url=HU.getUrl(ramaddaBaseUrl+"/entry/publish",args);window.open(url,'_blank');},getChildEntries:function(includeFixed){var seen={};var allEntries=[];for(var i=0;i<this.displays.length;i++){var display=this.displays[i];if(!includeFixed&&display.getIsLayoutFixed()){continue;}
if(display.getEntries){var entries=display.getEntries();if(entries){for(var entryIdx=0;entryIdx<entries.length;entryIdx++){if(seen[entries[entryIdx].getId()]!=null){continue;}
seen[entries[entryIdx].getId()]=true;allEntries.push(entries[entryIdx]);}}}}
return allEntries;},copyDisplayedEntries:function(){var allEntries=[];for(var i=0;i<this.displays.length;i++){var display=this.displays[i];if(display.getIsLayoutFixed()){continue;}
if(display.getEntries){var entries=display.getEntries();if(entries){for(var entryIdx=0;entryIdx<entries.length;entryIdx++){allEntries.push(entries[entryIdx]);}}}}
return this.copyEntries(allEntries);},defineWikiAttributes:function(list){for(var i=0;i<list.length;i++){if(this.wikiAttrs.indexOf(list[i])<0){this.wikiAttrs.push(list[i]);}}},getWikiAttributes:function(attrs){for(var i=0;i<this.wikiAttrs.length;i++){var v=this[this.wikiAttrs[i]];if(Utils.isDefined(v)){attrs.push(this.wikiAttrs[i]);attrs.push(v);}}},getWikiText:function(){var attrs=["layoutHere","false","type",this.type,"column",this.getColumn(),"row",this.getRow()];if(this.getProperty("entryId")){attrs.push("entry");attrs.push(this.getProperty("entryId"));}
this.getWikiAttributes(attrs);var entryId=null;if(this.getEntries){var entries=this.getEntries();if(entries&&entries.length>0){entryId=entries[0].getId();}}
if(!entryId){entryId=this.entryId;}
if(entryId){attrs.push("entry");attrs.push(entryId);}
var wiki="{{display "+HU.attrs(attrs)+"}}\n\n"
return wiki;},copyEntries:function(entries){var allEntries=[];var seen={};for(var entryIdx=0;entryIdx<entries.length;entryIdx++){var entry=entries[entryIdx];if(seen[entry.getId()]!=null)continue;seen[entry.getId()]=entry;allEntries.push(entry);}
var from="";for(var i=0;i<allEntries.length;i++){var entry=allEntries[i];from+=entry.getId()+",";}
var url=ramaddaBaseUrl+"/entry/copy?action.force=copy&from="+from;window.open(url,'_blank');},entryHtmlHasBeenDisplayed:async function(entry){if(entry.getIsGroup()){var theDisplay=this;var callback=function(entries){var html=HU.open(TAG_OL,[ATTR_CLASS,"display-entrylist-list",ATTR_ID,theDisplay.getDomId(ID_LIST)]);html+=theDisplay.getEntriesTree(entries);html+=HU.close(TAG_OL);theDisplay.jq(ID_GROUP_CONTENTS+entry.getIdForDom()).html(html);theDisplay.addEntrySelect();};await entry.getChildrenEntries(callback);}},getEntryHtml:function(entry,props){let dfltProps={showHeader:true,headerRight:false,showDetails:this.getShowDetails(),showImage:true,};$.extend(dfltProps,props);props=dfltProps;let menu=this.getEntryMenuButton(entry);let html="";if(props.showHeader){let left=menu+SPACE+entry.getLink(null,true,["target","_entries"]);if(props.headerRight)html+=HU.leftRight(left,props.headerRight);else html+=left;}
let divid=HU.getUniqueId("entry_");html+=HU.div([ID,divid],"");let metadata=entry.getMetadata();if(dfltProps.showImage){if(entry.isImage()){let img=HU.tag(TAG_IMG,["src",entry.getImageUrl(),ATTR_CLASS,"display-entry-image"]);html+=HU.href(entry.getResourceUrl(),img,["download",null])+"<br>";}else{for(var i=0;i<metadata.length;i++){if(metadata[i].type=="content.thumbnail"){let image=metadata[i].value.attr1;let url;if(image.indexOf("http")==0){url=image;}else{url=ramaddaBaseUrl+"/metadata/view/"+image+"?element=1&entryid="+entry.getId()+"&metadata_id="+metadata[i].id+"&thumbnail=false";}
html+=HU.image(url,[ATTR_CLASS,"display-entry-thumbnail"]);}}}}
if(entry.getIsGroup()){html+=HU.div([ATTR_ID,this.getDomId(ID_GROUP_CONTENTS+entry.getIdForDom())],"");}
html+=HU.formTable();if(props.showDetails){if(entry.url){html+=HU.formEntry("URL:",HU.href(entry.url,entry.url));}
if(entry.remoteUrl){html+=HU.formEntry("URL:",HU.href(entry.remoteUrl,entry.remoteUrl));}
if(entry.remoteRepository){html+=HU.formEntry("From:",HU.href(entry.remoteRepository.url,entry.remoteRepository.name));}}
var columns=entry.getAttributes();if(entry.getFilesize()>0){html+=HU.formEntry("File:",entry.getFilename()+" "+
HU.href(entry.getResourceUrl(),HU.image(ramaddaBaseUrl+"/icons/download.png"),["download",null])+" "+
entry.getFormattedFilesize());}
for(var colIdx=0;colIdx<columns.length;colIdx++){var column=columns[colIdx];var columnValue=column.value;if(column.getCanShow&&!column.getCanShow()){continue;}
if(Utils.isFalse(column.canshow)){continue;}
if(column.isUrl&&column.isUrl()){var tmp="";var toks=columnValue.split("\n");for(var i=0;i<toks.length;i++){var url=toks[i].trim();if(url.length==0)continue;tmp+=HU.href(url,url);tmp+="<br>";}
columnValue=tmp;}
html+=HU.formEntry(column.label+":",columnValue);}
html+=HU.close(TAG_TABLE);return html;},getEntriesTree:function(entries,props){if(!props)props={};let columns=this.getProperty("entryColumns",null);if(columns!=null){let columnNames=this.getProperty("columnNames",null);if(columnNames!=null){columnNames=columnNames.split(",");}
columns=columns.split(",");let ids=[];let names=[];for(let i=0;i<columns.length;i++){let toks=columns[i].split(":");let id=null,name=null;if(toks.length>1){if(toks[0]=="property"){name="property";id=columns[i];}else{id=toks[0];name=toks[1];}}else{id=columns[i];name=id;}
ids.push(id);names.push(name);}
columns=ids;if(columnNames==null){columnNames=names;}
return this.getEntriesTable(entries,columns,columnNames);}
let suffix=props.suffix;let domIdSuffix="";if(!suffix){suffix="null";}else{domIdSuffix=suffix;suffix="'"+suffix+"'";}
let handler=getHandler(props.handlerId);let showIndex=props.showIndex;let html="";let rowClass="entryrow_"+this.getId();let even=true;if(this.entriesMap==null)
this.entriesMap={};let doWorkbench=this.getProperty("doWorkbench");for(let i=0;i<entries.length;i++){even=!even;let entry=entries[i];this.entriesMap[entry.getId()]=entry;let toolbar=this.makeEntryToolbar(entry,handler,props.handlerId);let entryMenuButton=doWorkbench?this.getEntryMenuButton(entry):"";let entryName=entry.getDisplayName();if(entryName.length>100){entryName=entryName.substring(0,99)+"...";}
let icon=entry.getIconImage([ATTR_TITLE,"View entry"]);let link=HU.tag(TAG_A,["target","_entries",ATTR_HREF,entry.getEntryUrl()],icon+" "+entryName);entryName="";let entryIdForDom=entry.getIdForDom()+domIdSuffix;let entryId=entry.getId();let arrow=HU.image(icon_tree_closed,[ATTR_BORDER,"0","tree-open","false",ATTR_ID,this.getDomId(ID_TREE_LINK+entryIdForDom)]);let toggleCall=this.getGet()+".toggleEntryDetails(event, '"+entryId+"',"+suffix+",'"+props.handlerId+"');";let toggleCall2=this.getGet()+".entryHeaderClick(event, '"+entryId+"',"+suffix+"); ";let open=HU.onClick(toggleCall,arrow);let extra="";if(showIndex){extra="#"+(i+1)+" ";}
if(handler&&handler.getEntryPrefix){extra+=handler.getEntryPrefix(props.handlerId,entry);}
let left=HU.div([ATTR_CLASS,"display-entrylist-name"],entryMenuButton+" "+open+" "+extra+link+" "+entryName);let snippet="";snippet=HU.div([ATTR_CLASS,"display-entrylist-details-snippet",ATTR_ID,this.getDomId(ID_DETAILS_SNIPPET+entryIdForDom)],entry.getSnippet()||"");if(this.getProperty("showSnippetInList")){left+=snippet;snippet="";}
let inner=HU.div([ATTR_CLASS,"display-entrylist-details-inner",ATTR_ID,this.getDomId(ID_DETAILS_INNER+entryIdForDom)],"");let details=HU.div([ATTR_ID,this.getDomId(ID_DETAILS+entryIdForDom),ATTR_CLASS,"display-entrylist-details"],HU.div([ATTR_CLASS,"display-entrylist-details-ancestors",ATTR_ID,this.getDomId(ID_DETAILS_ANCESTORS+entryIdForDom)],"")+
snippet+
HU.div([ATTR_CLASS,"display-entrylist-details-tags",ATTR_ID,this.getDomId(ID_DETAILS_TAGS+entryIdForDom)],"")+
inner);let line;if(doWorkbench&&this.getProperty("showToolbar",true)){line=HU.leftCenterRight(left,"",toolbar,"80%","1%","19%");}else{line=left;}
let mainLine=HU.div(["onclick",toggleCall2,ATTR_ID,this.getDomId(ID_DETAILS_MAIN+entryIdForDom),ATTR_CLASS,"display-entrylist-entry-main"+" "+"entry-main-display-entrylist-"+(even?"even":"odd"),ATTR_ENTRYID,entryId],line);line=HU.div([CLASS,(even?"ramadda-row-even":"ramadda-row-odd"),ATTR_ID,this.getDomId("entryinner_"+entryIdForDom)],mainLine+details);html+=HU.div([ATTR_ID,this.getDomId("entry_"+entryIdForDom),ATTR_ENTRYID,entryId,ATTR_CLASS,"display-entrylist-entry"+rowClass],line);html+="\n";}
return html;},addEntrySelect:function(){var theDisplay=this;var entryRows=$("#"+this.getDomId(ID_DISPLAY_CONTENTS)+"  ."+this.getClass("entry-main"));entryRows.unbind();entryRows.mouseover(async function(event){var entryId=$(this).attr(ATTR_ENTRYID);var entry;await theDisplay.getEntry(entryId,e=>{entry=e});if(!entry){console.log("no entry:"+entryId);return;}
theDisplay.propagateEvent("entryMouseover",{entry:entry});if(true)return;var domEntryId=Utils.cleanId(entryId);var toolbarId=theDisplay.getEntryToolbarId(domEntryId);var toolbar=$("#"+toolbarId);toolbar.show();var myalign='right top+1';var atalign='right top';var srcId=theDisplay.getDomId(ID_DETAILS_MAIN+domEntryId);toolbar.position({of:$("#"+srcId),my:myalign,at:atalign,collision:"none none"});});entryRows.mouseout(async function(event){let entryId=$(this).attr(ATTR_ENTRYID);let entry;await theDisplay.getEntry(entryId,e=>{entry=e});if(!entry)return;theDisplay.propagateEvent("entryMouseout",{entry:entry});let domEntryId=Utils.cleanId(entryId);let toolbarId=theDisplay.getEntryToolbarId(entryId);let toolbar=$("#"+toolbarId);});if(this.madeList){}
this.madeList=true;if(false){this.jq(ID_LIST).selectable({cancel:'a',selected:async function(event,ui){var entryId=ui.selected.getAttribute(ATTR_ENTRYID);theDisplay.toggleEntryDetails(event,entryId);if(true)return;theDisplay.hideEntryDetails(entryId);var entry;await this.getEntry(entryId,e=>{entry=e});if(entry==null)return;var zoom=null;if(event.shiftKey){zoom={zoomIn:true};}
theDisplay.selectedEntries.push(entry);theDisplay.propagateEvent(DisplayEvent.entrySelection,{entry:entry,selected:true,zoom:zoom});theDisplay.lastSelectedEntry=entry;},unselected:async function(event,ui){if(true)return;var entryId=ui.unselected.getAttribute(ATTR_ENTRYID);var entry;await this.getEntry(entryId,e=>{entry=e});var index=theDisplay.selectedEntries.indexOf(entry);if(index>-1){theDisplay.selectedEntries.splice(index,1);theDisplay.propagateEvent(DisplayEvent.entrySelection,{entry:entry,selected:false});}},});}},getEntriesTable:function(entries,columns,columnNames){if(this.entriesMap==null)
this.entriesMap={};var columnWidths=this.getProperty("columnWidths",null);if(columnWidths!=null){columnWidths=columnWidths.split(",");}
var html=HU.open(TAG_TABLE,[ATTR_WIDTH,"100%","cellpadding","0","cellspacing","0"]);html+=HU.open(TAG_TR,["valign","top"]);for(var i=0;i<columnNames.length;i++){html+=HU.td([ATTR_ALIGN,"center",ATTR_CLASS,"display-entrytable-header"],columnNames[i]);}
html+=HU.close(TAG_TR);for(var i=0;i<entries.length;i++){html+=HU.open(TAG_TR,["valign","top"]);var entry=entries[i];this.entriesMap[entry.getId()]=entry;for(var j=0;j<columns.length;j++){var columnWidth=null;if(columnWidths!=null){columnWidth=columnWidths[j];}
var column=columns[j];var value="";if(column=="name"){value=HU.tag(TAG_A,[ATTR_HREF,entry.getEntryUrl()],entry.getName());}else if(column.match(".*property:.*")){var type=column.substring("property:".length);var metadata=entry.getMetadata();value="";for(var j=0;j<metadata.length;j++){var m=metadata[j];if(m.type==type){if(value!=""){value+="<br>";}
value+=m.value.attr1;}}}else if(column=="description"){value=entry.getDescription();}else if(column=="date"){value=entry.ymd;if(value==null){value=entry.startDate;}}else{value=entry.getAttributeValue(column);}
var attrs=[ATTR_CLASS,"display-entrytable-cell"];if(columnWidth!=null){attrs.push(ATTR_WIDTH);attrs.push(columnWidth);}
html+=HU.td(attrs,value);}
html+=HU.close(TAG_TR);}
html+=HU.close(TAG_TABLE);return html;},makeEntryToolbar:function(entry,handler,handlerId){var get=this.getGet();var toolbarItems=[];var props="{showMenu:true,showTitle:true}";if(entry.getType().getId()=="type_wms_layer"){toolbarItems.push(HU.tag(TAG_A,["onclick",get+".addMapLayer("+HU.sqt(entry.getId())+");"],HU.image(ramaddaBaseUrl+"/icons/map.png",["border",0,ATTR_TITLE,"Add Map Layer"])));}
if(entry.getType().getId()=="geo_shapefile"||entry.getType().getId()=="geo_geojson"){toolbarItems.push(HU.tag(TAG_A,["onclick",get+".addMapLayer("+HU.sqt(entry.getId())+");"],HU.image(ramaddaBaseUrl+"/icons/map.png",["border",0,ATTR_TITLE,"Add Map Layer"])));}
var jsonUrl=this.getPointUrl(entry);if(jsonUrl!=null){jsonUrl=jsonUrl.replace(/\'/g,"_");toolbarItems.push(HU.tag(TAG_A,["onclick",get+".createDisplay("+HU.sqt(entry.getFullId())+","+
HU.sqt("table")+","+HU.sqt(jsonUrl)+","+props+");"],HU.getIconImage("fa-table",[ATTR_TITLE,"Create Tabular Display"])));var x;toolbarItems.push(x=HU.tag(TAG_A,["onclick",get+".createDisplay("+HU.sqt(entry.getFullId())+","+
HU.sqt("linechart")+","+HU.sqt(jsonUrl)+","+props+");"],HU.getIconImage("fa-chart-line",[ATTR_TITLE,"Create Chart"])));}
toolbarItems.push(HU.tag(TAG_A,["onclick",get+".createDisplay("+HU.sqt(entry.getFullId())+","+
HU.sqt("entrydisplay")+","+HU.sqt(jsonUrl)+","+props+");"],HU.getIconImage("fa-file",["border",0,ATTR_TITLE,"Show Entry"])));if(entry.getFilesize()>0){toolbarItems.push(HU.tag(TAG_A,[ATTR_HREF,entry.getResourceUrl(),"download",null],HU.image(ramaddaBaseUrl+"/icons/download.png",["border",0,ATTR_TITLE,"Download ("+entry.getFormattedFilesize()+")"])));}
var entryMenuButton=this.getEntryMenuButton(entry);var tmp=[];if(handler&&handler.addToToolbar){handler.addToToolbar(handlerId,entry,toolbarItems);}
for(var i=0;i<toolbarItems.length;i++){tmp.push(HU.div([ATTR_CLASS,"display-entry-toolbar-item"],toolbarItems[i]));}
toolbarItems=tmp;return HU.div([ATTR_CLASS,"display-entry-toolbar",ATTR_ID,this.getEntryToolbarId(entry.getIdForDom())],HU.join(toolbarItems,""));},getEntryToolbarId:function(entryId){var id=entryId.replace(/:/g,"_").replace(/\//g,"_").replace(/[\(\)]/g,"_");id=id.replace(/=/g,"_");return this.getDomId(ID_TOOLBAR+"_"+id);},hideEntryDetails:function(entryId){},entryHeaderClick:function(event,entryId,suffix){var target=event.target;if(target.outerHTML){if(target.outerHTML.indexOf("<div")!=0){return;}}
this.toggleEntryDetails(event,entryId);},makeEntryTags:function(entry,groupThem,prefix,metadataMap){prefix=prefix||"";let metadata="";let map={};let list=[];entry.getMetadata().forEach(m=>{if(["content.pagestyle","content.pagetemplate","content.thumbnail","content.attachment"].includes(m.type))return;if(m.type.startsWith("map"))return;if(m.type.startsWith("spatial"))return;let tt=m.label+": "+m.value.attr1;let label=String(m.value.attr1);if(m.type=="property"){tt+=":"+m.value.attr2;label+=":"+m.value.attr2;}
if(label.length>20)label=label.substring(0,19)+"...";label=prefix+label;let id=Utils.getUniqueId("metadata_");let tag=HU.div(["metadata-type",m.type,"metadata-value",m.value.attr1,ID,id,CLASS,"display-search-tag",TITLE,tt,STYLE,HU.css("background",getMetadataColor(m.type))],label);if(!groupThem)
metadata+=tag;else{if(!map[m.type]){map[m.type]=[];list.push(m);}
map[m.type].push(tag);}
if(metadataMap)
metadataMap[id]=m;});if(groupThem){list.forEach(m=>{metadata+=m.label+": "+map[m.type].join(" ");metadata+="<br>";});}
return metadata;},toggleEntryDetails:async function(event,entryId,suffix,handlerId,entry){if(!entry){await this.getEntry(entryId,e=>{this.toggleEntryDetails(event,entryId,suffix,handlerId,e);});return;}
if(suffix==null)suffix="";let link=this.jq(ID_TREE_LINK+entry.getIdForDom()+suffix);let id=ID_DETAILS+entry.getIdForDom()+suffix;let details=this.jq(id);if(event&&event.shiftKey){let id=Utils.cleanId(entryId);let line=this.jq(ID_DETAILS_MAIN+id);if(!this.selectedEntriesFromTree){this.selectedEntriesFromTree={};}
let selected=line.attr("ramadda-selected")=="true";if(selected){line.removeClass("display-entrylist-entry-main-selected");line.attr("ramadda-selected","false");this.selectedEntriesFromTree[entry.getId()]=null;}else{line.addClass("display-entrylist-entry-main-selected");line.attr("ramadda-selected","true");this.selectedEntriesFromTree[entry.getId()]=entry;}
this.propagateEvent(DisplayEvent.entrySelection,{"entry":entry,"selected":!selected});return;}
let open=link.attr("tree-open")=="true";if(open){link.attr("src",icon_tree_closed);}else{link.attr("src",icon_tree_open);}
link.attr("tree-open",open?"false":"true");let handleContent=()=>{if(open){details.hide();}else{details.show();}
if(event&&event.stopPropagation){event.stopPropagation();}}
let _this=this;let hereBefore=details.attr("has-content")!=null;details.attr("has-content","true");if(hereBefore){handleContent();return;}
let detailsInner=this.jq(ID_DETAILS_INNER+entry.getIdForDom()+suffix);if(!entry.isSynth()&&entry.getIsGroup()){detailsInner.html(HU.image(icon_progress));let callback=function(entries){_this.displayChildren(entry,entries,suffix,handlerId);};let entries=entry.getChildrenEntries(callback);}else{detailsInner.html(this.getEntryHtml(entry,{showHeader:false}));}
handleContent();let metadataMap={};let prefix=entry.isSynth()?"":HU.getIconImage("fas fa-search")+SPACE;let metadata=this.makeEntryTags(entry,false,prefix,metadataMap);let bar=this.jq(ID_DETAILS_TAGS+entry.getIdForDom()+suffix);let typeTag=$(HU.span([CLASS,"display-search-tag"],prefix+"Type: "+entry.getType().getLabel())).appendTo(bar);if(!entry.isSynth()){typeTag.click(function(){_this.typeTagClicked(entry.getType());});}
let tags=$(metadata).appendTo(bar);if(!entry.isSynth()){tags.click(function(){_this.metadataTagClicked(metadataMap[$(this).attr("id")]);});}
if(!entry.isSynth()&&this.getProperty("showEntryBreadcrumbs",true)){let ancestorContent="";let handleAncestor=ancestor=>{if(!ancestor){this.jq(ID_DETAILS_ANCESTORS+entry.getIdForDom()+suffix).html(ancestorContent);}else{let href=ancestor.getLink(null,false,["target","_entries"]);if(ancestorContent!="")
href=href+HU.div([CLASS,"breadcrumb-delimiter"]);ancestorContent=href+ancestorContent;ancestor.getParentEntry(handleAncestor);}};entry.getParentEntry(handleAncestor);}},metadataTagClicked:function(metadata){},typeTagClicked:function(metadata){},getSelectedEntriesFromTree:function(){var selected=[];if(this.selectedEntriesFromTree){for(var id in this.selectedEntriesFromTree){var entry=this.selectedEntriesFromTree[id];if(entry!=null){selected.push(entry);}}}
return selected;},displayChildren:function(entry,entries,suffix,handlerId){if(!suffix)suffix="";let detailsInner=this.jq(ID_DETAILS_INNER+entry.getIdForDom()+suffix);let details=this.getEntryHtml(entry,{showHeader:false,showImage:entries.length==0});if(entries.length==0){detailsInner.html(details);}else{let entriesHtml=details;if(this.showDetailsForGroup){entriesHtml+=details;}
entriesHtml+=this.getEntriesTree(entries,{handlerId:handlerId});detailsInner.html(entriesHtml);this.addEntrySelect();}},getEntryMenuButton:function(entry){var menuButton=HU.onClick(this.getGet()+".showEntryMenu(event, '"+entry.getId()+"');",HU.image(ramaddaBaseUrl+"/icons/menu.png",[ATTR_CLASS,"display-entry-toolbar-item",ATTR_ID,this.getDomId(ID_MENU_BUTTON+entry.getIdForDom())]));return menuButton;},setOriginalRamadda:function(e){this.originalRamadda=e;},setRamadda:function(e){this.ramadda=e;},getRamadda:function(){if(this.ramadda!=null){return this.ramadda;}
if(this.ramaddaBaseUrl!=null){this.ramadda=getRamadda(this.ramaddaBaseUrl);return this.ramadda;}
return getGlobalRamadda();},getEntry:async function(entryId,callback){if(this.entriesMap&&this.entriesMap[entryId]){return Utils.call(callback,this.entriesMap[entryId]);}
var ramadda=this.getRamadda();var toks=entryId.split(",");if(toks.length==2){entryId=toks[1];ramadda=getRamadda(toks[0]);}
var entry=null;if(this.entryList!=null){await this.entryList.getEntry(entryId,e=>entry=e);}
if(entry==null){await ramadda.getEntry(entryId,e=>entry=e);}
if(entry==null){await this.getRamadda().getEntry(entryId,e=>entry=e);}
return Utils.call(callback,entry);},addMapLayer:async function(entryId){var entry;await this.getEntry(entryId,e=>{entry=e});if(entry==null){console.log("No entry:"+entryId);return;}
this.getDisplayManager().addMapLayer(this,entry);},doit:function(){console.log("doit");},createDisplay:async function(entryId,displayType,jsonUrl,displayProps){var entry;await this.getEntry(entryId,e=>{entry=e});if(entry==null){console.log("No entry:"+entryId);return null;}
var props={sourceEntry:entry,entryId:entry.getId(),showDetails:true,title:entry.getName(),layoutHere:false,};if(displayProps){$.extend(props,displayProps);}
if(displayType!=DISPLAY_ENTRYLIST){if(jsonUrl==null){jsonUrl=this.getPointUrl(entry);}
var pointDataProps={entry:entry,entryId:entry.getId()};props.data=new PointData(entry.getName(),null,null,jsonUrl,pointDataProps);}
if(this.lastDisplay!=null){props.column=this.lastDisplay.getColumn();props.row=this.lastDisplay.getRow();}else{props.column=this.getProperty("newColumn",this.getColumn());props.row=this.getProperty("newRow",this.getRow());}
this.lastDisplay=this.getDisplayManager().createDisplay(displayType,props);},getPointUrl:function(entry){let service=entry.getService("points.json");if(service!=null){return service.url;}
service=entry.getService("grid.point.json");if(service!=null){return service.url;}
return null;},getEntryMenu:async function(entryId,callback){var entry;await this.getEntry(entryId,e=>{entry=e});if(entry==null){return Utils.call(callback,"null entry");}
var get=this.getGet();var menus=[];var fileMenuItems=[];var viewMenuItems=[];var newMenuItems=[];viewMenuItems.push(HU.tag(TAG_LI,[],HU.tag(TAG_A,["href",entry.getEntryUrl(),"target","_"],"View Entry")));if(entry.getFilesize()>0){fileMenuItems.push(HU.tag(TAG_LI,[],HU.tag(TAG_A,["download",null,"href",entry.getResourceUrl()],"Download "+entry.getFilename()+" ("+entry.getFormattedFilesize()+")")));}
if(this.jsonUrl!=null){fileMenuItems.push(HU.tag(TAG_LI,[],"Data: "+HU.onClick(get+".fetchUrl('json');","JSON")+
HU.onClick(get+".fetchUrl('csv');","CSV")));}
var props="{showMenu:true,showTitle:true}";var newMenu="<a>New</a><ul>";newMenu+=HU.tag(TAG_LI,[],HU.onClick(get+".createDisplay('"+entry.getFullId()+"','entrydisplay',null,null,"+props+");","New Entry Display"));newMenuItems.push(HU.tag(TAG_LI,[],HU.onClick(get+".createDisplay('"+entry.getFullId()+"','entrydisplay',null,null,"+props+");","New Entry Display")));var pointUrl=this.getPointUrl(entry);if(pointUrl!=null){var types=window.globalDisplayTypes;var catMap={};if(types){for(var i=0;i<types.length;i++){var type=types[i];if(!type.requiresData||!type.forUser)continue;if(!Utils.isDefined(catMap[type.category])){catMap[type.category]="<li> <a>"+type.category+"</a><ul>\n";}
pointUrl=pointUrl.replace(/\'/g,"_");var call=get+".createDisplay("+HU.sqt(entry.getFullId())+","+HU.sqt(type.type)+","+HU.sqt(pointUrl)+",null,"+props+");";var li=HU.tag(TAG_LI,[],HU.tag(TAG_A,["onclick",call],type.label));catMap[type.category]+=li+"\n";newMenuItems.push(li);}}
for(a in catMap){newMenu+=catMap[a]+"</li></ul>";}}
if(fileMenuItems.length>0)
menus.push("<a>File</a>"+HU.tag(TAG_UL,[],HU.join(fileMenuItems)));if(viewMenuItems.length>0)
menus.push("<a>View</a>"+HU.tag(TAG_UL,[],HU.join(viewMenuItems)));if(newMenuItems.length>0)
menus.push(newMenu);var topMenus="";for(var i=0;i<menus.length;i++){topMenus+=HU.tag(TAG_LI,[],menus[i]);}
var menu=HU.tag(TAG_UL,[ATTR_ID,this.getDomId(ID_MENU_INNER+entry.getIdForDom()),ATTR_CLASS,"sf-menu"],topMenus);callback(menu);},showEntryMenu:async function(event,entryId){var menu;await this.getEntryMenu(entryId,m=>{menu=m});this.writeHtml(ID_MENU_OUTER,menu);var srcId=this.getDomId(ID_MENU_BUTTON+Utils.cleanId(entryId));this.dialog=HU.makeDialog({content:menu,anchor:srcId,draggable:false,header:false});$("#"+this.getDomId(ID_MENU_INNER+Utils.cleanId(entryId))).superfish({speed:'fast',delay:300});},fetchUrl:function(as,url){if(url==null){url=this.jsonUrl;}
url=this.getDisplayManager().getJsonUrl(url,this);if(url==null)return;if(as!=null&&as!="json"){url=url.replace("points.json","points."+as);}
window.open(url,'_blank');},getMenuItems:function(menuItems){},getDisplayMenuSettings:function(){var get="getRamaddaDisplay('"+this.getId()+"')";var moveRight=HU.onClick(get+".moveDisplayRight();","Right");var moveLeft=HU.onClick(get+".moveDisplayLeft();","Left");var moveTop=HU.onClick(get+".moveDisplayTop();","Top");var moveUp=HU.onClick(get+".moveDisplayUp();","Up");var moveDown=HU.onClick(get+".moveDisplayDown();","Down");var menu=HU.open(TABLE,[CLASS,'formtable'])+
"<tr><td align=right><b>Move:</b></td><td>"+moveTop+" "+moveUp+" "+moveDown+" "+moveRight+" "+moveLeft+"</td></tr>"+
"<tr><td align=right><b>Row:</b></td><td> "+HU.input("",this.getProperty("row",""),["size","7",ATTR_ID,this.getDomId("row")])+" &nbsp;&nbsp;<b>Col:</b> "+HU.input("",this.getProperty("column",""),["size","7",ATTR_ID,this.getDomId("column")])+"</td></tr>"+
"<tr><td align=right><b>Width:</b></td><td> "+HU.input("",this.getProperty("width",""),["size","7",ATTR_ID,this.getDomId("width")])+"  "+"<b>Height:</b> "+HU.input("",this.getProperty("height",""),["size","7",ATTR_ID,this.getDomId("height")])+"</td></tr>"+
"</table>";var tmp=HU.checkbox(this.getDomId("showtitle"),[],this.getProperty("showTitle"))+" Title  "+
HU.checkbox(this.getDomId("showdetails"),[],this.getProperty("showDetails"))+" Details "+
"&nbsp;&nbsp;&nbsp;"+
HU.onClick(get+".askSetTitle();","Set Title");menu+=HU.formTable()+HU.formEntry("Show:",tmp)+HU.close(TABLE);return menu;},loadInitialData:function(){if(!this.getProperty("okToLoadData",true))return;if(!this.needsData()||this.properties.theData==null){return;}
if(this.getProperty("latitude")){this.properties.theData.lat=this.getProperty("latitude");this.properties.theData.lon=this.getProperty("longitude","-105");}
if(this.properties.theData.hasData()){this.addData(this.properties.theData);return;}
this.properties.theData.loadData(this);},getData:function(){if(!this.hasData()){if(this.properties.dataSrc){this.addData(makeInlineData(this,this.properties.dataSrc));}else{return null;}}
var dataList=this.dataCollection.getList();return dataList[0];},hasData:function(){if(this.dataCollection==null)return false;return this.dataCollection.hasData();},getCreatedInteractively:function(){return this.createdInteractively==true;},needsData:function(){return false;},askSetTitle:function(){var t=this.getTitle(false);var v=prompt(TITLE,t);if(v!=null){this.title=v;this.setProperty(ATTR_TITLE,v);this.setDisplayTitle(this.title);}},getShowDetails:function(){return this.getSelfProperty("showDetails",true);},setShowDetails:function(v){this.showDetails=v;if(this.showDetails){this.jq(ID_DETAILS).show();}else{this.jq(ID_DETAILS).hide();}},setShowTitle:function(v){if(v==="true")v=true;else if(v==="false")v=true;this.setProperty("showTitle",v);if(v){this.jq(ID_TITLE).show();}else{this.jq(ID_TITLE).hide();}},setDisplayProperty:function(key,value){this.setProperty(key,value);$("#"+this.getDomId(key)).val(value);},deltaColumn:function(delta){var column=parseInt(this.getProperty("column",0));column+=delta;if(column<0)column=0;this.setDisplayProperty("column",column);this.getLayoutManager().layoutChanged(this);this.jq("col").val(column);},deltaRow:function(delta){var row=parseInt(this.getProperty("row",0));if(isNaN(row))row=0;row+=delta;if(row<0)row=0;this.setDisplayProperty("row",row);this.getLayoutManager().layoutChanged(this);this.jq("row").val(row);},moveDisplayRight:function(){if(this.getLayoutManager().isLayoutColumns()){this.deltaColumn(1);}else{this.getLayoutManager().moveDisplayDown(this);}},moveDisplayLeft:function(){if(this.getLayoutManager().isLayoutColumns()){this.deltaColumn(-1);}else{this.getLayoutManager().moveDisplayUp(this);}},moveDisplayUp:function(){if(this.getLayoutManager().isLayoutRows()){this.deltaRow(-1);}else{this.getLayoutManager().moveDisplayUp(this);}},moveDisplayDown:function(){if(this.getLayoutManager().isLayoutRows()){this.deltaRow(1);}else{this.getLayoutManager().moveDisplayDown(this);}},moveDisplayTop:function(){this.getLayoutManager().moveDisplayTop(this);},getDialogContents:function(tabTitles,tabContents){this.getDisplayDialogContents(tabTitles,tabContents);},getDisplayDialogContents:function(tabTitles,tabContents){var get=this.getGet();var menuItems=[];this.getMenuItems(menuItems);var form="<form>";form+=this.getDisplayMenuSettings();for(var i=0;i<menuItems.length;i++){form+=HU.div([ATTR_CLASS,"display-menu-item"],menuItems[i]);}
form+="</form>";tabTitles.push("Display");tabContents.push(form);},checkLayout:function(){},displayData:function(){},setDisplayReady:function(){var callUpdate=!this.displayReady;this.displayReady=true;if(callUpdate){this.callUpdateUI({force:true});}},getDisplayReady:function(){return this.displayReady;},pageHasLoaded:function(){if(!this.displayReady){this.setDisplayReady(true);}},doFinalInitialization:function(){},initDisplay:function(){if(this.inError)return
this.createUI();if(this.getAnimation().getEnabled()){this.getAnimation().makeControls();}
this.checkSearchBar();this.callUpdateUI({force:true});if(this.getProperty("reloadSeconds")){this.runReload();}},runReload:function(){setTimeout(()=>{this.reloadData();this.runReload();},this.getProperty("reloadSeconds")*1000);},getMainDiv:function(){let divId=this.getProperty("targetDiv",this.getProperty(PROP_DIVID,null,null,true),null,true);return $("#"+divid);},getGroupDiv:function(){return $("#"+this.getProperty("groupDiv"));},createUI:function(){let divId=this.getProperty("targetDiv",this.getProperty(PROP_DIVID,null,null,true),null,true);if(divId!=null){var html=this.getHtml();let div=$("#"+divId);let inline=this.getProperty("displayInline");if(inline){div.css("display","inline-block");div.css("vertical-align","bottom");}
let width=this.getWidth("100%");if(width&&width!="-1"){div.css("width",HU.getDimension(width));}
div.html(html);}else{console.log("error: no div defined for display:"+this.getType());}},getHtml:function(){let get=this.getGet();let button="";if(this.getShowMenu()){button=HU.onClick(get+".showDialog();",HU.image(ramaddaBaseUrl+"/icons/downdart.png",[ATTR_CLASS,"display-dialog-button",ATTR_ID,this.getDomId(ID_MENU_BUTTON)]));button+=" ";}
if(this.getShowProgress(false)){}
let title="";if(this.getShowTitle()){title=this.getTitle(false).trim();}
let topLeft="";if(button!=""||title!=""){let titleDiv=this.getTitleHtml(title);if(button==""){topLeft=titleDiv;}else{topLeft=HU.div(["class","display-header"],button+SPACE+titleDiv);}}
topLeft=HU.div([ID,this.getDomId(ID_TOP_LEFT),CLASS,"display-header-block"],topLeft);let h2Separate=this.getAnimationEnabled();let h1=HU.div([ID,this.getDomId(ID_HEADER1),CLASS,"display-header-block display-header1"],"");let h2=HU.div([ID,this.getDomId(ID_HEADER2),CLASS,"display-header-block display-header2"],"");let topCenter=HU.div([ID,this.getDomId(ID_TOP),CLASS,"display-header-block"],h2Separate?"":h2);let topRight=HU.div([ID,this.getDomId(ID_TOP_RIGHT)],"");let top=this.getProperty("showHeader",true)?HU.leftCenterRight(topLeft,topCenter,topRight,null,null,null,{valign:"bottom"}):"";let header=h1;if(h2Separate)header+=h2;top=header+top;let colorTable=HU.div([ID,this.getDomId(ID_COLORTABLE)]);let rightInner="";let leftInner="";let bottom=HU.div([ATTR_CLASS,"",ATTR_ID,this.getDomId(ID_BOTTOM)]);let legend=HU.div([ID,this.getDomId(ID_LEGEND)]);let ctSide=this.getProperty("colorTableSide","bottom");if(ctSide=="top"){top+=colorTable;}else if(ctSide=="right"){rightInner+=colorTable;}else if(ctSide=="left"){leftInner+=colorTable;}else{bottom+=colorTable;}
bottom+=legend;let leftStyle="";if(this.getProperty("leftSideWidth"))
leftStyle=HU.css("width",HU.getDimension(this.getProperty("leftSideWidth")));let left=HU.div([ATTR_ID,this.getDomId(ID_LEFT),STYLE,leftStyle],leftInner);let right=HU.div([ATTR_ID,this.getDomId(ID_RIGHT)],rightInner);let sideWidth="1%";let contents=this.getContentsDiv();let table=HU.open('table',[STYLE,"border:1px solid transparent;",CLASS,'display-ui-table','width','100%','border','0','cellpadding','0','cellspacing','0']);if(this.getProperty('showDisplayTop',true)){table+=HU.tr([],HU.td(['width',sideWidth])+HU.td(['width','99%'],top)+HU.td(['width',sideWidth]));}
table+=HU.tr(["valign","top"],HU.td(['width',sideWidth],left)+HU.td(['width','99%'],contents)+HU.td(['width',sideWidth],right));if(this.getProperty('showDisplayBottom',true)){table+=HU.tr([],HU.td(['width',sideWidth])+HU.td(['width','99%'],bottom)+HU.td(['width',sideWidth]));}
table+=HU.close('table');let message=HU.div([ID,this.domId(ID_DISPLAY_MESSAGE),CLASS,"display-output-message",STYLE,HU.css("display","none","position","absolute","top","10px","left","50%","-webkit-transform","translateX(-50%)","transform","translateX(-50%)")],"message");let html=HU.div([ATTR_CLASS,'ramadda-popup',STYLE,"display:none;",ATTR_ID,this.getDomId(ID_MENU_OUTER)],'');let style=this.getProperty('displayStyle','');html+=HU.div([CLASS,'display-contents',STYLE,HU.css('position','relative')+style],table+message);return html;},getWidthForStyle:function(dflt){var width=this.getProperty("width",-1);if(width==-1)return dflt;return HU.getDimension(width);},getHeightForStyle:function(dflt){let height=this.getProperty("height",-1);if(height==-1)return dflt;if(new String(height).match("^[0-9]+$")){height=height+"px";}
return height;},getContentsStyle:function(){let style="";let height=this.getHeightForStyle();if(height){style+=HU.css(HEIGHT,height);}
let maxheight=this.getProperty("maxHeight");if(maxheight){style+=HU.css("max-height",HU.getDimension(maxheight),"overflow-y","auto");}
return style;},getContentsClass:function(){return"ramadda-expandable-target display-contents-inner display-"+this.type;},getContentsDiv:function(){let style=this.getContentsStyle();style+=this.getProperty("contentsStyle","");let image=this.getProperty("backgroundImage");if(image){image=HU.getEntryImage(this.entryId,image);style+=HU.css("background-attachment","auto","background-size","100% auto","background-image","url('"+image+"')");}
let background=this.getProperty("background");if(background)
style+=HU.css("background",background);let topBottomStyle="";let top=HU.div([STYLE,topBottomStyle,ATTR_ID,this.getDomId(ID_DISPLAY_TOP)],"");let bottom=HU.div([STYLE,topBottomStyle,ATTR_ID,this.getDomId(ID_DISPLAY_BOTTOM)],"");let expandedHeight=this.getProperty("expandedHeight");if(expandedHeight)
style+=HU.css(HEIGHT,expandedHeight);let contentsAttrs=[ATTR_CLASS,this.getContentsClass(),STYLE,style,ATTR_ID,this.getDomId(ID_DISPLAY_CONTENTS)];if(this.getProperty("expandableHeight")){contentsAttrs.push("expandable-height");contentsAttrs.push(this.getProperty("expandableHeight"));}
let contents=top+"\n"+HU.div(contentsAttrs,"")+"\n"+bottom;return contents;},prepareToLayout:function(){this.getColumn();this.getWidth();this.getHeight();this.getName();this.getEventSource();},getColumn:function(){return this.getFormValue("column",0);},getRow:function(){return this.getFormValue("row",0);},getWidth:function(dflt){return this.getFormValue("width",dflt);},getHeight:function(){return this.getFormValue("height",0);},getDisplayTitle:function(title){if(!title)title=this.title!=null?this.title:"";var text=title;var fields=this.lastSelectedFields;if(fields&&fields.length>0)
text=text.replace("{field}",fields[0].getLabel());else
text=text.replace("{field}",HU.span([ID,this.getDomId(ID_TITLE_FIELD)],"&nbsp;"));return text;},setDisplayTitle:function(title){if(!Utils.stringDefined(title)){title=this.getTitle(false).trim();}
var text=this.getTitleHtml(title);if(this.getShowTitle()){this.jq(ID_TITLE).show();}else{this.jq(ID_TITLE).hide();}
this.writeHtml(ID_TITLE,text);},getTitle:function(showMenuButton){var prefix="";if(showMenuButton&&this.hasEntries()){prefix=this.getEntryMenuButton(this.getEntries()[0])+" ";}
var title=this.getProperty(ATTR_TITLE);if(title!=null){return prefix+title;}
if(this.dataCollection==null){return prefix;}
var dataList=this.dataCollection.getList();title="";for(var collectionIdx=0;collectionIdx<dataList.length;collectionIdx++){var pointData=dataList[collectionIdx];if(collectionIdx>0)title+="/";title+=pointData.getName();}
return prefix+title;},getIsLayoutFixed:function(){return this.getProperty(PROP_LAYOUT_HERE,true);},makeToolbar:function(props){var toolbar="";var get=this.getGet();var addLabel=props.addLabel;var images=[];var calls=[];var labels=[];if(!this.getIsLayoutFixed()){calls.push("removeRamaddaDisplay('"+this.getId()+"')");images.push("fa-cut");labels.push("Delete display");}
calls.push(get+".copyDisplay();");images.push("fa-copy");labels.push("Copy Display");if(this.jsonUrl!=null){calls.push(get+".fetchUrl('json');");images.push(ramaddaBaseUrl+"/icons/json.png");labels.push("Download JSON");calls.push(get+".fetchUrl('csv');");images.push(ramaddaBaseUrl+"/icons/csv.png");labels.push("Download CSV");}
for(var i=0;i<calls.length;i++){var inner=HU.getIconImage(images[i],[ATTR_TITLE,labels[i],ATTR_CLASS,"display-dialog-header-icon"]);if(addLabel)inner+=" "+labels[i]+"<br>";toolbar+=HU.onClick(calls[i],inner);}
return toolbar;},getHeader2:function(){return"";},initHeader2:function(){},writeHeader:function(header,html){if(html==""){this.jq(header).css("display","none");}else{this.jq(header).css("display","inline-block");}
this.jq(header).html(html);},checkLayout:function(){let d=this.jq(ID_DISPLAY_CONTENTS);let w=d.width();if(this.lastWidth!=w){this.lastWidth=w;this.displayData();}},forceUpdateUI:function(){this.haveCalledUpdateUI=false;this.callUpdateUI();},callUpdateUI:function(args){args=args||{};try{if(args.force)
this.haveCalledUpdateUI=false;this.updateUI(args);}catch(err){this.setContents(this.getMessage(err));console.log("Error:"+err);console.log(err.stack);}},updateUI:function(args){},getFilterId:function(id){return this.getDomId("filterby_"+id);},getRequestMacros:function(){if(!this.requestMacros){this.requestMacros=this.getRequestMacrosInner();}
return this.requestMacros;},getRequestMacrosInner:function(){let macros=[];let p=this.getProperty("requestFields","");let e1=this.getProperty("extraFields1","");let e2=this.getProperty("extraFields2","");let list=Utils.mergeLists(e1.split(","),p.split(","),e2.split(","));if(p!="")
console.log("requestFields="+p);list.forEach(macro=>{if(macro=="")return;macros.push(new RequestMacro(this,macro));});return macros;},applyRequestProperties:function(props){if(!props)return;this.requestMacros=null;this.dynamicProperties=props;this.createRequestProperties();},createRequestProperties:function(){let requestProps="";let macros=this.getRequestMacros();let macroDateIds=[];macros.forEach(macro=>{requestProps+=macro.getWidget(macroDateIds)+"&nbsp;&nbsp;";if(macro.isVisible()){requestProps+=SPACE2;}});this.writeHeader(ID_REQUEST_PROPERTIES,requestProps);let macroChange=(macro,value,what)=>{if(this.settingMacroValue)return;if(macro.triggerReload){this.macroChanged();this.reloadData();}
if(!macro.name)return;this.settingMacroValue=true;let args={entryId:this.entryId,property:"macroValue",id:macro.name,what:what,value:value};this.propagateEvent(DisplayEvent.propertyChanged,args);this.settingMacroValue=false;};let sliderFunc=function(){};macroDateIds.forEach(id=>{HU.datePickerInit(id);});this.jq(ID_HEADER2).find(".display-request-reload").click(()=>{macroChange({triggerReload:true});});macros.every(macro=>{$("#"+this.getDomId(macro.getId())+","+
"#"+this.getDomId(macro.getId()+"_min")+","+
"#"+this.getDomId(macro.getId()+"_max")+","+
"#"+this.getDomId(macro.getId()+"_from")+","+
"#"+this.getDomId(macro.getId()+"_to")).keyup(function(e){var keyCode=e.keyCode||e.which;if(keyCode==13){macroChange(macro,$(this).val());}});if(macro.type=="bounds"){this.jq(macro.getId()).change(function(e){macroChange(macro,$(this).is(':checked'));});}
if(macro.type=="enumeration"){this.jq(macro.getId()).change(function(e){macroChange(macro,$(this).val());});}
this.jq(macro.getId()+"_min").change(function(e){});this.jq(macro.getId()+"_max").change(function(e){});this.jq(macro.getId()+"_from").change(function(e){macroChange(macro,$(this).val(),"from");});this.jq(macro.getId()+"_to").change(function(e){macroChange(macro,$(this).val(),"to");});return true;});},makeFilterWidget:function(label,widget,title){if(!label)
return HU.div([CLASS,"display-filter-widget"],widget);return HU.div([CLASS,"display-filter-widget"],this.makeFilterLabel(label,title)+(label.trim().length==0?" ":": ")+
widget);},makeFilterLabel:function(label,tt,vertical){let clazz="display-filter-label";if(vertical)
clazz+=" display-filter-label-vertical ";let attrs=[CLASS,clazz];if(tt){attrs.push(TITLE);attrs.push(tt);}
return HU.span(attrs,label);},stepFilterDateAnimation:function(inputFunc,dir){let select=$("#"+this.getFilterId(ID_FILTER_DATE));let index=select[0].selectedIndex;let length=select.find('option').length;index+=dir;if(index>=length){return;index=0;}else if(index<0){return;index=length-1;}
select[0].selectedIndex=index;inputFunc(select);if(this.filterDatePlayingAnimation){setTimeout(()=>{this.stepFilterDateAnimation(inputFunc,1);},this.getProperty("filterDateAnimationSleep",1000));}},addFilters:function(filters){},initializeRangeSlider:function(jq,inputFunc,immediate){let _this=this;jq.mousedown(function(){let id=$(this).attr(ID);id=id.replace(/_min$/,"").replace(/_max$/,"");let min=$("#"+id+"_min");let max=$("#"+id+"_max");let range={min:parseFloat(min.attr("data-min")),max:parseFloat(max.attr("data-max"))};let smin=String(min.attr("data-min")).replace(/.*\./,"");let smax=String(max.attr("data-max")).replace(/.*\./,"");let numDecimals=Math.max(smin.length,smax.length);let minValue=parseFloat(min.val());let maxValue=parseFloat(max.val());let html=HU.div([ID,"filter-range",STYLE,HU.css("width","200px")],"");let popup=HtmlUtils.getTooltip();popup.html(html);popup.show();popup.position({of:min,my:"left top",at:"left bottom+2",collision:"fit fit"});if(isNaN(minValue))minValue=range.min;if(isNaN(maxValue))maxValue=range.max;var step=1;if(parseInt(range.max)!=range.max||parseInt(range.min)!=range.min)
step=(range.max-range.min)/100000;$("#filter-range").slider({range:true,min:range.min,max:range.max,step:step,values:[minValue,maxValue],slide:function(event,ui){let minv=String(Utils.roundDecimals(ui.values[0],numDecimals));let maxv=String(Utils.roundDecimals(ui.values[1],numDecimals));if(minv.endsWith("."))minv=minv.replace(/\./,"");if(maxv.endsWith("."))maxv=maxv.replace(/\./,"");min.val(minv);max.val(maxv);min.attr("data-value",min.val());max.attr("data-value",max.val());if(immediate){inputFunc(min,max);}},stop:function(){var popup=HtmlUtils.getTooltip();popup.hide();_this.checkFilterField(max);inputFunc(min,max);}});});},getRecordFilter:function(fieldId){if(this.filters){for(let i=0;i<this.filters.length;i++){let filter=this.filters[i];if(filter.field&&filter.field.getId()==fieldId)return this.filters[i];}}
return null;},checkSearchBar:function(){let hideFilterWidget=this.getProperty("hideFilterWidget",false,true);let vertical=this.getProperty("headerOrientation","horizontal")=="vertical";let filterClass="display-filter";let debug=displayDebug.checkSearchBar;if(debug)console.log("checkSearchBar");let _this=this;let colorBy=this.getFieldById(null,this.getProperty("colorBy",""));this.colorByFields=this.getFieldsByIds(null,this.getProperty("colorByFields","",true));this.sizeByFields=this.getFieldsByIds(null,this.getProperty("sizeByFields","",true));this.sortByFields=this.getFieldsByIds(null,this.getProperty("sortByFields","",true));let pointData=this.getData();if(pointData==null)return;let fields=pointData.getRecordFields();let records=pointData.getRecords();records=this.sortRecords(records);let header2="";if(this.getShowProgress(false)){header2+=HU.div([ID,this.getDomId(ID_DISPLAY_PROGRESS),STYLE,HU.css("display","inline-block","margin-right","4px","min-width","20px")]);}
header2+=HU.div([CLASS,"display-header-span"],"");header2+=HU.div([ID,this.getDomId(ID_HEADER2_PREPREPREFIX),CLASS,"display-header-span"],"");header2+=HU.div([ID,this.getDomId(ID_HEADER2_PREPREFIX),CLASS,"display-header-span"],"");header2+=HU.div([ID,this.getDomId(ID_HEADER2_PREFIX),CLASS,"display-header-span"],"");header2+=this.getHeader2();if(this.getProperty("pageRequest",false)||this.getProperty("filterPaginate")){header2+=HU.div([CLASS,"display-header-span display-filter",ID,this.getDomId(ID_PAGE_COUNT)]);}
header2+=HU.div([ID,this.getDomId(ID_REQUEST_PROPERTIES),CLASS,"display-header-span"],"");if(this.getProperty("legendFields")||this.getProperty("showFieldLegend",false)){let colors=this.getColorList();let fields=this.getFieldsByIds(null,this.getProperty("legendFields",this.getPropertyFields(this.getProperty("sumFields"))));let html="";let colorCnt=0;fields.forEach((f)=>{if(colorCnt>=colors.length)colorCnt=0;let color=colors[colorCnt];html+=HU.div([STYLE,HU.css("display","inline-block","width","8px","height","8px","background",color)])+" "+f.getLabel()+"&nbsp;&nbsp; ";colorCnt++;});header2+=html;}
if(this.getProperty("showDisplayFieldsMenu",false)){let displayFields=pointData.getChartableFields();if(displayFields.length){let fields=this.getSelectedFields();let selected=[];fields.forEach(f=>selected.push(f.getId()));let enums=[];displayFields.forEach(field=>{if(field.isFieldGeo())return;enums.push([field.getId(),field.getLabel()]);});let attrs=[ID,this.getDomId("displayfields")];if(this.getProperty("displayFieldsMenuMultiple",false)){attrs.push("multiple");attrs.push("true");attrs.push("size");attrs.push("4");}
this.displayFieldsMenuEnums=enums;let html=HU.span([CLASS,filterClass],this.makeFilterLabel("Display: ")+HU.select("",attrs,enums,selected))+SPACE;let side=this.getProperty("displayFieldsMenuSide","top");if(side=="left"){this.jq(ID_LEFT).append(html);}else{header2+=html;}}}
let selectFields=this.getProperty("selectFields");let selectFieldProps=[];if(selectFields){selectFields.split(";").forEach(t=>{let[prop,label,fields]=t.split(":");if(fields==null){fields=label;label=Utils.makeLabel(prop);}
let selectFields=this.getFieldsByIds(null,fields);let enums=[];selectFields.forEach(field=>{if(field.isFieldGeo())return;enums.push([field.getId(),field.getLabel()]);});header2+=HU.span([CLASS,filterClass],(label==""?"":this.makeFilterLabel(label+": "))+
HU.select("",[ID,this.getDomId("fieldselect_"+prop)],enums,this.getProperty(prop,"")))+SPACE;selectFieldProps.push(prop);});}
if(this.colorByFields.length>0){let enums=[];this.colorByFields.forEach(field=>{if(field.isFieldGeo())return;enums.push([field.getId(),field.getLabel()]);});let selected=colorBy?colorBy.getId():"";header2+=HU.span([CLASS,filterClass],this.makeFilterLabel("Color by: ")+HU.select("",[ID,this.getDomId("colorbyselect")],enums,selected))+SPACE;}
let sortAscending=this.getProperty("sortAscending",true);if(this.sortByFields.length>0){let enums=[];this.sortByFields.forEach(field=>{if(field.isFieldGeo())return;let id=field.getId();let label=field.getLabel();let suffix1=" &uarr;";let suffix2=" &darr;";if(field.isFieldString()){suffix1="A-Z";suffix2="Z-A";}
if(sortAscending||field.isFieldString()){enums.push([id+"_up",label+" "+suffix1]);enums.push([id+"_down",label+" "+suffix2]);}else{enums.push([id+"_down",label+" "+suffix2]);enums.push([id+"_up",label+" "+suffix1]);}});header2+=HU.span([CLASS,filterClass],this.makeFilterLabel("Order: ")+HU.select("",[ID,this.getDomId("sortbyselect")],enums,this.getProperty("sortFields","")))+SPACE;}
if(this.getProperty("showSortDirection")){header2+=HU.select("",[ID,this.getDomId("sortdirection")],[["up","Sort Up"],["down","Sort Down"]],sortAscending?"up":"down")+SPACE;}
if(this.sizeByFields.length>0){let enums=[];this.sizeByFields.forEach(field=>{enums.push([field.getId(),field.getLabel()]);});header2+=HU.span([CLASS,filterClass],this.makeFilterLabel("Size by: ")+HU.select("",[ID,this.getDomId("sizebyselect")],enums,this.getProperty("sizeBy","")))+SPACE;}
let highlight=this.getFilterHighlight();if(this.getProperty("showFilterHighlight")){let enums=[["filter","Filter"],["highlight","Highlight"]];let select=HU.select("",["fieldId","_highlight",ID,this.getDomId(ID_FILTER_HIGHLIGHT)],enums,!highlight?"filter":"highlight")+SPACE2;if(hideFilterWidget){select=HU.div([STYLE,HU.css("display","none")],select);}
header2+=select;}
let dataFilterIds=[];this.getDataFilters().forEach(f=>{if(!f.label)return;let cbxid=this.getDomId("datafilterenabled_"+f.id);dataFilterIds.push(cbxid);header2+=HU.checkbox("",[ID,cbxid],f.enabled)+" "+
this.makeFilterLabel(f.label+"&nbsp;&nbsp;")});if(this.getProperty("filterDate")){let type=this.getProperty("filterDate");let enums=[];if(this.getProperty("filterDateIncludeAll")){enums.push(["all","All"]);}
let selected=null;let seen={};let dates=[];records.forEach(record=>dates.push(record.getDate()));dates.sort(function(a,b){return a.getTime()-b.getTime();});dates.forEach(dttm=>{let value=null;if(type=="year"){value=dttm.getFullYear();}else if(type=="day"){value=Utils.formatDateMonthDayYear(dttm);}
if(!seen[value]){selected=String(dttm);enums.push([String(dttm),value]);seen[value]=true;}});let label=type=="year"?"Year":type=="month"?"Month":type=="day"?"Day":type;let style="";if(!this.getProperty("filterDateShow",true))
style+="display:none;";let selectId=this.getFilterId(ID_FILTER_DATE);label=this.makeFilterLabel("Select "+label+": ");let prefix="";prefix+=HU.div([ID,this.getDomId("filterDateStepBackward"),STYLE,HU.css("display","inline-block"),TITLE,"Step Back"],HU.getIconImage("fa-step-backward",[STYLE,HU.css("cursor","pointer")]))+SPACE1;prefix+=HU.div([ID,this.getDomId("filterDatePlay"),STYLE,HU.css("display","inline-block"),TITLE,"Play/Stop Animation"],HU.getIconImage("fa-play",[STYLE,HU.css("cursor","pointer")]))+SPACE1;prefix+=HU.div([ID,this.getDomId("filterDateStepForward"),STYLE,HU.css("display","inline-block"),TITLE,"Step Forward"],HU.getIconImage("fa-step-forward",[STYLE,HU.css("cursor","pointer")]))+SPACE1;let widget=HU.span([CLASS,filterClass,STYLE,style],prefix+
HU.select("",["fieldId","filterDate",ATTR_ID,selectId],enums,selected))+SPACE;if(hideFilterWidget){widget=HU.div([STYLE,HU.css("display","none")],widget);}
header2+=widget;}
let filterBy=this.getProperty("filterFields","").split(",").map(tok=>{return tok.trim();});let fieldMap={};let displayType="";this.filters=[];this.filterMap={};this.addFilters(this.filters);if(filterBy.length>0){let group=null;for(let i=0;i<filterBy.length;i++){if(filterBy[i]=="")continue;if(filterBy[i].startsWith("group:")){group=filterBy[i].substring(6);if(group=="none")group=null;continue;}
let filter=new RecordFilter(this,filterBy[i]);filter.group=group;this.filters.push(filter);this.filterMap[filter.getId()]=filter;}
let searchBar="";let bottom=[""];group=null;groupHtml=null;this.filters.forEach(filter=>{let widget=filter.getWidget(fieldMap,bottom,records,vertical);if(!vertical)
widget=HU.span([ID,this.domId("filtercontainer_"+filter.id)],widget);if(filter.group!=null){if(filter.group!=group&&groupHtml!=null){searchBar+=HU.toggleBlock(group,groupHtml,false);groupHtml=null;}
group=filter.group;if(groupHtml==null){groupHtml="";}
groupHtml+=widget;return;}
if(groupHtml!=null){searchBar+=HU.toggleBlock(group,groupHtml,false);groupHtml=null;}
searchBar+=widget;});if(groupHtml!=null)searchBar+=HU.toggleBlock(group,groupHtml,false);style=(hideFilterWidget?"display:none;":"")+this.getProperty("filterByStyle","");if(this.getProperty("showFilterTotal",false)){searchBar+=HU.span([CLASS,"display-filter-label",ID,this.getDomId(ID_FILTER_COUNT)],"");}
let filterBar=searchBar+bottom[0]+HU.div([ID,this.domId(ID_TAGBAR)],"");header2+=HU.div([CLASS,"display-header-span "+filterClass,STYLE,style,ID,this.getDomId(ID_FILTERBAR)],filterBar);}
if(vertical){header2=HU.div([CLASS,"display-header-vertical"],header2);}else{header2=HU.div([STYLE,"line-height:0;"],header2);}
let headerSide=this.getDisplayHeaderSide();if(headerSide=="left")
this.jq(ID_LEFT).html(header2);else if(headerSide=="right")
this.jq(ID_RIGHT).html(header2);else
this.jq(ID_HEADER2).html(header2);this.initHeader2();this.jq("test").button().click(()=>{this.haveCalledUpdateUI=false;this.callUpdateUI();});this.createRequestProperties();let inputFunc=(input,input2,value)=>{let debug=false;if(this.ignoreFilterChange)return;let id=input.attr(ID);if(!id){console.log("No ID attribute");return;}
if(debug)
console.log(this.type+" filter change");let changedFilter;let changedFilterId;this.filters.every(filter=>{if(filter.widgetId==id){changedFilter=filter;changedFilterId=filter.id;return false;}
return true;});if(debug)
console.log("changed filter:"+changedFilter)
let dependentFilters=[];if(changedFilter){this.filters.forEach(filter=>{if(filter.depends==changedFilter.id){dependentFilters.push(filter);let widget=$("#"+filter.widgetId);this.ignoreFilterChange=true;filter.lastValue=widget.val();widget.val(FILTER_ALL);this.ignoreFilterChange=false;}});}
if(!input2){if(id.endsWith("_min")){input2=$("#"+id.replace(/_min$/,"_max"));}else if(id.endsWith("_max")){let tmp=input;input=$("#"+id.replace(/_max$/,"_min"));input2=tmp;}}
if(input.attr("isCheckbox")){let on=input.attr("onValue")||true;let off=input.attr("offValue")||false;if(input.is(':checked')){value=on;console.log(_this.type+" cbx is checked value:"+value+" on:"+on+" off:"+off);}else{value=off;console.log(_this.type+" cbx is not checked value:"+value+" on:"+on+" off:"+off);}}
if(!value){value=input.val();}
if(value===null||value===""){value=input.attr("data-value")||input.val();}
if(value==null){if(debug)
console.log("no value:"+value);return;}
if(!Array.isArray(value)&&input.attr("isButton")){var tmp=[];value.split(",").forEach(v=>{tmp.push(v.replace(/_comma_/g,","));});value=tmp;}
let fieldId=input.attr("fieldId");_this.checkFilterField(input);_this.haveCalledUpdateUI=false;if(_this.settingFilterValue){return;}
_this.settingFilterValue=true;this.filteredRecords=null;if(debug)
console.log("calling dataFilterChanged");_this.dataFilterChanged();let records=[];let predecessorChanged=false;dependentFilters.forEach(filter=>{if(this.filteredRecords==null)
this.filteredRecords=this.filterRecords();let widget=filter.getWidget({},[],this.filteredRecords);this.jq("filtercontainer_"+filter.id).html(widget);if(filter.initWidget)
filter.initWidget(inputFunc);if(filter.widgetId){let widget=$("#"+filter.widgetId);if(!widget.length){console.log("Could not find dependent widget:"+filter.id);return;}
if(filter.lastValue){if(widget[0].options){let values=$.map(widget[0].options,(option)=>{return option.value});if(!values.includes(filter.lastValue))filter.lastValue=FILTER_ALL;}
widget.val(filter.lastValue);}
widget.change(function(){inputFunc($(this));});}
return true;});this.addToDocumentUrl(fieldId+".filterValue",value);let args={id:id,fieldId:fieldId,value:value};if(input2){args.value2=input2.val();}
_this.propagateEvent(DisplayEvent.filterChanged,args);_this.settingFilterValue=false;};dataFilterIds.forEach(id=>{$("#"+id).click(function(e){inputFunc($(this));});});this.filters.forEach(f=>{if(f.initWidget)
f.initWidget(inputFunc);});this.jq(ID_FILTERBAR).find(".display-filter-items").each(function(){let parent=$(this);$(this).find(".display-filter-item").click(function(event){var isAll=$(this).hasClass("display-filter-item-all");var selectClazz="display-filter-item-"+displayType+"-selected"
var wasSelected=$(this).hasClass(selectClazz);var fieldId=$(this).attr("fieldId");var multiples=_this.getProperty(fieldId+".filterMultiple",false);if(!event.metaKey||isAll||!multiples){parent.find(".display-filter-item").removeClass(selectClazz);}else{parent.find(".display-filter-item-all").removeClass(selectClazz);}
if(wasSelected&&event.metaKey){$(this).removeClass(selectClazz);}else{$(this).addClass(selectClazz);}
var values=[];parent.find("."+selectClazz).each(function(){values.push($(this).attr("data-value").replace(/,/g,"_comma_"));});if(values.length==0){parent.find(".display-filter-item-all").addClass(selectClazz);values.push(FILTER_ALL);}
var value=Utils.join(values,",");parent.attr("data-value",value);$("#"+parent.attr(ID)+"_label").html(values.includes(FILTER_ALL)?SPACE:value);inputFunc(parent,null,values);});});this.jq(ID_FILTERBAR).find(".display-filter-input").keyup(function(e){let keyCode=e.keyCode||e.which;if(keyCode==13){return;}
HtmlUtils.hidePopupObject();let input=$(this);let val=$(this).val().trim();if(val=="")return;let fieldId=$(this).attr("fieldId");let field=fieldMap[fieldId].field;let values=fieldMap[fieldId].values;let items=[];let regexp=null;try{val=val.replace(/\./g,"\\.");regexp=new RegExp("("+val+")",'i');}catch(ignore){}
for(let i=0;i<values.length;i++){let text=values[i].toString();let match=regexp?text.match(regexp):text.indexOf(val)>=0;if(match){items.push([match[1],values[i]]);}
if(items.length>30)break;}
if(items.length>0){let html="";let itemCnt=0;items.forEach(item=>{let match=item[0];item=item[1];let label=item.replace(regexp,"<span style='background:"+TEXT_HIGHLIGHT_COLOR+";'>"+match+"</span>");item=item.replace(/\'/g,"\'");html+=HU.div([TITLE,item,CLASS,"ramadda-hoverable ramadda-clickable display-filter-popup-item","item",item],label)+"\n";itemCnt++;});if(itemCnt>0){let popup=HtmlUtils.setPopupObject(HtmlUtils.getTooltip());popup.html(HU.div([STYLE,HU.css("margin","5px"),CLASS,"ramadda-popup-inner ramadda-snippet-popup"],html));popup.show();popup.position({of:$(this),my:"left top",at:"left bottom",});$(".display-filter-popup-item").click(function(){HtmlUtils.hidePopupObject();input.val($(this).attr("item"));inputFunc(input);});}}});this.initializeRangeSlider(this.jq(ID_FILTERBAR).find(".display-filter-range"),inputFunc,this.getProperty("filterSliderImmediate"));this.jq(ID_FILTER_HIGHLIGHT).change(function(){_this.setProperty("filterHighlight",$(this).val()=="highlight");_this.haveCalledUpdateUI=false;inputFunc($(this));});$("#"+this.getFilterId(ID_FILTER_DATE)).change(function(){inputFunc($(this));});this.jq("filterDatePlay").click(function(){_this.filterDatePlayingAnimation=!_this.filterDatePlayingAnimation;let icon=_this.filterDatePlayingAnimation?"fa-stop":"fa-play";$(this).html(HU.getIconImage(icon,[STYLE,HU.css("cursor","pointer")]));if(_this.filterDatePlayingAnimation){_this.stepFilterDateAnimation(inputFunc,1);}});this.jq("filterDateStepBackward").click(function(){_this.filterDatePlayingAnimation=false;let icon=_this.filterDatePlayingAnimation?"fa-stop":"fa-play";_this.jq("filterDatePlay").html(HU.getIconImage(icon,[STYLE,HU.css("cursor","pointer")]));_this.stepFilterDateAnimation(inputFunc,-1);});this.jq("filterDateStepForward").click(function(){_this.filterDatePlayingAnimation=false;let icon=_this.filterDatePlayingAnimation?"fa-stop":"fa-play";_this.jq("filterDatePlay").html(HU.getIconImage(icon,[STYLE,HU.css("cursor","pointer")]));_this.stepFilterDateAnimation(inputFunc,1);});this.jq("displayfields").change(function(){let val=$(this).val();if(Array.isArray(val)){val=val.join(",");}
_this.displayFieldsChanged(val);_this.propagateEvent(DisplayEvent.propertyChanged,{property:'displayFields',value:val});});selectFieldProps.forEach(prop=>{this.jq("fieldselect_"+prop).change(function(){_this.fieldSelectedChanged(prop,$(this).val());});});this.jq("colorbyselect").change(function(){_this.colorByFieldChanged($(this).val());});this.jq("sortbyselect").change(function(){let val=$(this).val();if(val.endsWith("_up")){_this.setProperty("sortAscending",true);val=val.replace(/_up$/,"");}else{val=val.replace(/_down$/,"");_this.setProperty("sortAscending",false);}
_this.sortByFieldChanged(val);});this.jq("sortdirection").change(function(){let val=$(this).val();_this.setProperty("sortAscending",val=="up");_this.forceUpdateUI();});this.jq("sizebyselect").change(function(){_this.sizeByFieldChanged($(this).val());});this.jq(ID_FILTERBAR).find("input").keyup(function(e){let keyCode=e.keyCode||e.which;if(keyCode==13){inputFunc($(this));}});this.jq(ID_FILTERBAR).find("input:radio,select").change(function(){inputFunc($(this));});this.jq(ID_FILTERBAR).find("input:checkbox").change(function(){inputFunc($(this));});let dates=[];if(debug)console.log("checkSearchBar-getting filtered data");let filteredRecords=this.filterData();if(debug)console.log("checkSearchBar-done getting filtered data");let dateInfo=this.getDateInfo(filteredRecords);if(debug)console.log("checkSearchBar-11");if(dateInfo.dateMax){if(debug)console.log("checkSearchBar-getAnimation");let animation=this.getAnimation();if(animation.getEnabled()){if(debug)console.log("checkSearchBar-calling animation.init");animation.init(dateInfo.dateMin,dateInfo.dateMax,filteredRecords);if(debug)console.log("checkSearchBar-done calling animation.init");if(!this.minDateObj){if(debug)console.log("checkSearchBar-calling setDateRange");if(this.getProperty("animationFilter",true)){this.setDateRange(animation.begin,animation.end);}
if(debug)console.log("checkSearchBar-done calling setDateRange");}}}
if(debug)console.log("checkSearchBar-done");},getDateInfo:function(records){let dateMin=null;let dateMax=null;let dates=[];records.every(record=>{if(dateMin==null){dateMin=record.getDate();dateMax=record.getDate();}else{let date=record.getDate();if(date){dates.push(date);if(date.getTime()<dateMin.getTime())
dateMin=date;if(date.getTime()>dateMax.getTime())
dateMax=date;}}
return true;});return{dateMin:dateMin,dateMax:dateMax,dates:dates};},getHighlightColor:function(){return this.getProperty("highlightColor",HIGHLIGHT_COLOR);},checkFilterField:function(f){let min=f.attr("data-min");let max=f.attr("data-max");let value=f.val();if(Utils.isDefined(min)){if(value!=min){f.css("background",TEXT_HIGHLIGHT_COLOR);}else{f.css("background","white");}}else if(Utils.isDefined(max)){if(value!=max){f.css("background",TEXT_HIGHLIGHT_COLOR);}else{f.css("background","white");}}},fieldSelectedChanged:function(prop,val){this.setProperty(prop,val);this.haveCalledUpdateUI=false;this.callUpdateUI();},colorByFieldChanged:function(field){this.setProperty("colorBy",field);this.callUpdateUI();},sortByFieldChanged:function(field){this.setProperty("sortFields",field);this.callUpdateUI();},sizeByFieldChanged:function(field){},someFieldChanged:function(type,field){},macroChanged:function(){this.pageSkip=0;},dataFilterChanged:function(args){args=args||{};args.dataFilterChanged=true;console.log("DF");this.callUpdateUI(args);},addFieldClickHandler:function(jq,records,addHighlight){let _this=this;if(records){if(!jq)jq=this.jq(ID_DISPLAY_CONTENTS);let map=this.makeIdToRecords(records);let func=function(){if(addHighlight){$(this).parent().find(".display-row-highlight").removeClass("display-row-highlight");$(this).addClass("display-row-highlight");}
let record=records[$(this).attr(RECORD_INDEX)];if(!record)record=map[$(this).attr(RECORD_ID)];if(record)
_this.propagateEventRecordSelection({record:record});};let children=jq.find("["+RECORD_INDEX+"]");if(!children.length)children=jq.find("["+RECORD_ID+"]");if(!children.length)children=jq;children.click(func);}
if(this.getProperty("propagateValueClick",true)){let _this=this;if(!jq)jq=this.jq(ID_DISPLAY_CONTENTS);jq.find("[field-id]").click(function(){let args={id:$(this).attr("field-id"),fieldId:fieldId,value:$(this).attr("field-value")};_this.propagateEvent(DisplayEvent.filterChanged,args);});}},makeIdToRecords:function(records){let idToRecord={};records.forEach(r=>idToRecord[r.getId()]=r);return idToRecord;},makeTooltipClick:function(selector,records){let tooltipClick=this.getProperty("tooltipClick");if(!tooltipClick)return;selector.css("cursor","pointer");let idToRecord=this.makeIdToRecords(records);let _this=this;selector.click(function(){let record=idToRecord[$(this).attr(RECORD_ID)];if(!record)return;if(_this.tooltipDialog){_this.tooltipDialog.remove();_this.tooltipDialog=null;}
let tt=_this.getRecordHtml(record,null,tooltipClick);tt=HU.div([STYLE,HU.css("width","600px")],tt);_this.tooltipDialog=HU.makeDialog({content:tt,anchor:$(this),draggable:true,header:true});if(_this.getProperty("dialogListener"))
_this.getProperty("dialogListener")(this,_this.tooltipDialog);_this.initTemplatePopup(_this.tooltipDialog);});},initTemplatePopup:function(dialog){let _this=this;dialog.find(".display-search-tag").click(function(){let type=$(this).attr("metadata-type");if(type==null)return;let filter=_this.filterMap[type];if(filter==null)return;let value=$(this).attr("metadata-value");filter.toggleTag(value,true,null,true);});},makeTooltips:function(selector,records,callback,tooltipArg,propagateHighlight){let tooltipClick=this.getProperty("tooltipClick");if(tooltipClick){this.makeTooltipClick(selector,records);}
if(!Utils.isDefined(propagateHighlight)||propagateHighlight==null)
propagateHighlight=this.shareEvent(DisplayEvent.recordHighlight,this.getProperty("propagateEventRecordHighlight",false));if(!this.getProperty("showTooltips",true)){return;}
let tooltip=tooltipArg||this.getProperty("tooltip");if(tooltip==null){return;}
let _this=this;let idToRecord=this.makeIdToRecords(records);let tooltipFunc={content:function(){let record=idToRecord[$(this).attr(RECORD_ID)];if(!record)record=records[parseFloat($(this).attr(RECORD_INDEX))];if(!record)return null;let propagateOk=true;if(callback&&callback(true,record)===false){propagateOk=false;}
if(propagateOk&&propagateHighlight){_this.getDisplayManager().notifyEvent(DisplayEvent.recordHighlight,_this,{highlight:true,record:record});}
if(tooltip==""||tooltip=="none")return null;let style=_this.getProperty("tooltipStyle");let tt=_this.getRecordHtml(record,null,tooltip);if(style)tt=HU.div([STYLE,style],tt);return tt;},close:function(event,ui){let record=idToRecord[$(this).attr(RECORD_ID)];if(!record)
record=records[parseFloat($(this).attr(RECORD_INDEX))];let propagateOk=true;if(callback&&callback(false,record)===false){propagateOk=false;}
if(propagateOk&&propagateHighlight)
_this.getDisplayManager().notifyEvent(DisplayEvent.recordHighlight,_this,{highlight:false,record:record});},position:{my:_this.getProperty("tooltipPositionMy","left top"),at:_this.getProperty("tooltipPositionAt","left bottom+2"),collision:_this.getProperty("tooltipCollision","flip")},show:{delay:parseFloat(_this.getProperty("tooltipDelay",1000)),duration:parseFloat(_this.getProperty("tooltipDuration",500)),},classes:{"ui-tooltip":_this.getProperty("tooltipClass","ramadda-shadow-box  display-tooltip")}};if(selector.length>500){selector.mouseenter(function(){let tooltip=$(this).tooltip(tooltipFunc);tooltip.tooltip('open');});selector.mouseleave(function(){let tooltip=$(this).tooltip({});tooltip.tooltip('close');});}else{selector.tooltip(tooltipFunc);}},makeRecordSelect:function(selector,idToRecords,callback){let _this=this;selector.click(function(event){let record=idToRecords[$(this).attr(RECORD_ID)];if(!record)return;if(callback)callback(record);_this.propagateEventRecordSelection({select:true,record:record});});},makePopups:function(selector,records,callback,popupTemplate){if(!popupTemplate)
popupTemplate=this.getProperty("popupTemplate");if(!popupTemplate)return;let _this=this;selector.click(function(event){let record=records[parseFloat($(this).attr(RECORD_INDEX))];if(!record)return;if(callback)callback(record);_this.propagateEventRecordSelection({select:true,record:record});_this.showRecordPopup($(this),record,callback,popupTemplate);});},showRecordPopup:function(element,record,popupTemplate){if(!record)return;if(!popupTemplate)
popupTemplate=this.getProperty("popupTemplate");if(!popupTemplate)return;let _this=this;HtmlUtils.hidePopupObject();let html=_this.getRecordHtml(record,null,popupTemplate);html=HU.div([CLASS,"display-popup "+_this.getProperty("popupClass",""),STYLE,_this.getProperty("popupStyle","")],html);let popup=HtmlUtils.setPopupObject(HtmlUtils.getTooltip());popup.html(html);popup.show();popup.position({of:element,my:_this.getProperty("popupPositionMy","left top"),at:_this.getProperty("popupPositionAt","left bottom+2"),collision:_this.getProperty("popupCollision","none none")});},animationStart:function(animation){},animationApply:function(animation,skipUpdateUI){if(this.getProperty("animationFilter",true))
this.setDateRange(animation.begin,animation.end);if(!skipUpdateUI){this.haveCalledUpdateUI=false;this.dataFilterChanged({source:"animation"});}
this.propagateEvent(DisplayEvent.propertyChanged,{property:"dateRange",minDate:animation.begin,maxDate:animation.end});},makeDialog:function(text){var html="";if(!text){var tabTitles=[];var tabContents=[];this.getDialogContents(tabTitles,tabContents);tabTitles.push("Edit");tabContents.push(this.makeToolbar({addLabel:true}));var tabLinks="<ul>";var tabs="";for(var i=0;i<tabTitles.length;i++){var id=this.getDomId("tabs")+i;tabLinks+=HU.tag("li",[],HU.tag("a",["href","#"+id],tabTitles[i]));tabLinks+="\n";var contents=HU.div([ATTR_CLASS,"display-dialog-tab"],tabContents[i]);tabs+=HU.div([ID,id],contents);tabs+="\n";}
tabLinks+="</ul>\n";text=HU.div([ID,this.getDomId(ID_DIALOG_TABS)],tabLinks+tabs);}
return text;},initDialog:function(){var _this=this;var updateFunc=function(e){if(e&&e.which!=13&&e.which!=0){return;}
var changed=false;["column","row","width","height"].forEach(f=>{if(_this[f]!=_this.jq(f).val()&&(_this[f]||_this.jq(f).val().trim()!="")){changed=true;_this[f]=_this.jq(f).val();}});if(changed){_this.getLayoutManager().doLayout();}};["column","row","width","height"].forEach(f=>{this.jq(f).blur(updateFunc);this.jq(f).keypress(updateFunc);});this.jq("showtitle").change(function(){_this.setShowTitle(_this.jq("showtitle").is(':checked'));});this.jq("showdetails").change(function(){_this.setShowDetails(_this.jq("showdetails").is(':checked'));});this.jq(ID_DIALOG_TABS).tabs();},showDialog:function(text,from,initDialog,title){if(this.dialog)this.dialog.remove();if(!this.dialogElement){}
let html=this.makeDialog(text);this.dialog=HU.makeDialog({content:html,title:title||this.getTitle(),anchor:from||this.jq(ID_MENU_BUTTON),draggable:true,header:true});if(initDialog)initDialog();else this.initDialog();return this.dialog;},copyDisplay:function(){let newOne={};$.extend(true,newOne,this);newOne.setId(newOne.getId()+this.getUniqueId("display"));addRamaddaDisplay(newOne);this.getDisplayManager().addDisplay(newOne);},removeDisplay:function(){this.getDisplayManager().removeDisplay(this);if(this.dialogElement)this.dialogElement.remove();},doingQuickEntrySearch:false,doQuickEntrySearch:function(request,callback){if(this.doingQuickEntrySearch)return;var text=request.term;if(text==null||text.length<=1)return;this.doingQuickEntrySearch=true;var searchSettings=new EntrySearchSettings({name:text,max:10,});if(this.searchSettings){searchSettings.clearAndAddType(this.searchSettings.entryType);}
let _this=this;var jsonUrl=this.getRamadda().getSearchUrl(searchSettings,OUTPUT_JSON);var handler={entryListChanged:function(entryList){_this.doneQuickEntrySearch(entryList,callback);}};var entryList=new EntryList(this.getRamadda(),jsonUrl,handler,true);},doneQuickEntrySearch:function(entryList,callback){var names=[];var entries=entryList.getEntries();for(var i=0;i<entries.length;i++){names.push(entries[i].getName());}
callback(names);this.doingQuickEntrySearch=false;},addData:async function(pointData){var records=pointData.getRecords();if(records&&records.length>0){this.hasElevation=records[0].hasElevation();}else{this.hasElevation=false;}
pointData=this.convertPointData(pointData);this.dataCollection.addData(pointData);var entry=pointData.entry;if(entry==null&&pointData.entryId){await this.getRamadda().getEntry(pointData.entryId,e=>{entry=e});}
if(entry){pointData.entry=entry;this.addEntry(entry);}},setErrorMessage:function(msg){this.setContents(this.getMessage(msg));},clearProgress:function(){this.jq(ID_DISPLAY_PROGRESS).html("");},startProgress:function(){if(this.jq(ID_DISPLAY_PROGRESS).length>0)
this.jq(ID_DISPLAY_PROGRESS).html(HU.image(icon_progress));else{if(this.useDisplayMessage()){this.setDisplayMessage(this.getLoadingMessage());}else{this.setContents(this.getLoadingMessage());}}},handleNoData:function(pointData,reload){let debug=displayDebug.handleNoData;this.jq(ID_PAGE_COUNT).html("");if(!reload){if(debug)console.log("\tno reload");this.addData(pointData);this.checkSearchBar();}else{if(!this.dataCollection)
this.dataCollection=new DataCollection();this.dataCollection.setData(pointData);}
this.setContents(this.getMessage(this.getNoDataMessage()));},pointDataLoadFailed:function(data){this.clearProgress();this.inError=true;errorMessage=this.getProperty("errorMessage",null);if(errorMessage!=null){this.setContents(errorMessage);return;}
var msg="";if(data&&data.error){msg=data.error;}else if(data&&data.errorcode&&data.errorcode=="warning"){msg=data.error;}else{msg="<b>An error has occurred:</b>";if(!data)data=this.getNoDataMessage();var error=data.error?data.error:data;error=error.replace(/<[^>]*>/g,"");var tmp="";var lines=error.split("\n");var seen={};for(var i=0;i<lines.length;i++){var line=lines[i].trim();if(line=="")continue;if(seen[line])continue;seen[line]=true;tmp+=line+"\n";}
error=tmp;error=HU.tag("pre",[STYLE,HU.css("max-height","300px","overflow-y","auto","max-width","100%","overflow-x","auto")],error);msg+=error;}
this.setErrorMessage(msg);},clearCache:function(){},handleEventDataSelection:function(source,args){if(this.getAcceptEventDataSelection()){this.pointDataLoaded(args.data,"",true);}},getRequirement:function(){return null;},updatePaginateLabel:function(skip,count,max){let paginate=this.getProperty("filterPaginate");let label=count;if(skip!=null&&skip>0)
label=String(skip+1)+"-"+(count+skip);else if(count<max)
label="1"+"-"+count;label=this.getProperty("pageRequestLabel","Showing: ${count}").replace("${count}",label);this.jq(ID_PAGE_LABEL).html(label);let gotAll=false;if(paginate){}else{}
let buttons="";if(skip!=null&&skip>0){buttons+=HU.getIconImage("fa-step-backward",[ID,this.getDomId(ID_PAGE_PREV),CLASS,"display-page-button",TITLE,"View previous"])}else if(!gotAll){buttons+=HU.getIconImage("fa-step-backward",[CLASS,"display-page-button fa-disabled"])}
if(count<max){buttons+=HU.getIconImage("fa-step-forward",[ID,this.getDomId(ID_PAGE_NEXT),CLASS,"display-page-button",TITLE,"View next"])}else if(!gotAll){buttons+=HU.getIconImage("fa-step-forward",[CLASS,"display-page-button fa-disabled"])}
this.jq(ID_PAGE_BUTTONS).html(buttons);let _this=this;this.jq(ID_PAGE_NEXT).click(()=>{if(!this.pageSkip)
this.pageSkip=0;if(paginate){this.pageSkip+=+this.getProperty("pageCount",1000);_this.haveCalledUpdateUI=false;_this.dataFilterChanged();_this.updatePaginateLabel(this.pageSkip,count,max);}else{this.pageSkip+=max;this.reloadData();}});this.jq(ID_PAGE_PREV).click(()=>{if(!this.pageSkip)
this.pageSkip=0;if(paginate){this.pageSkip-=+this.getProperty("pageCount",1000);if(this.pageSkip<0)this.pageSkip=0;_this.haveCalledUpdateUI=false;_this.updatePaginateLabel(this.pageSkip,count,max);_this.dataFilterChanged();}else{this.pageSkip-=max;if(this.pageSkip<0)this.pageSkip=0;this.reloadData();}});},pointDataLoaded:function(pointData,url,reload){let debug=displayDebug.pointDataLoaded;this.clearProgress();this.inError=false;this.clearCache();if(debug)console.log(this.type+" pointDataLoad:"+this.getId()+" "+this.type+" #records:"+pointData.getRecords().length);if(debug)
console.log("\tclearing last selected fields");let records=pointData.getRecords();this.lastSelectedFields=null;if(!reload){if(debug)console.log("\tcalling addData");this.addData(pointData);this.checkSearchBar();}else{pointData=this.convertPointData(pointData);if(!this.dataCollection)
this.dataCollection=new DataCollection();if(debug)console.log("\tcalling setData");this.dataCollection.setData(pointData);}
let paginate=this.getProperty("filterPaginate");if(this.getProperty("pageRequest")||paginate){if(debug)console.log("\tupdating pageRequest");let count;let skip;let max;if(paginate){skip=this.pageSkip||0;count=+this.getProperty("pageCount",1000);max=records.length;}else{count=records.length;let skipToks=url?url.match(/skip=([0-9]+)/):null;if(skipToks)skip=+skipToks[1];max=+this.getProperty("max",5000);}
let pageInfo=HU.span([ID,this.domId(ID_PAGE_LABEL)])+" "+
HU.span([ID,this.domId(ID_PAGE_BUTTONS)]);this.jq(ID_PAGE_COUNT).html(pageInfo);this.updatePaginateLabel(skip,count,max);}
if(url!=null){this.jsonUrl=url;}else{this.jsonUrl=null;}
if(!this.getDisplayReady()){if(debug)console.log("pointDataLoaded: display not ready");return;}
if(!this.getProperty("dateFormat")){pointData.getRecordFields().forEach(f=>{if(f.isFieldDate()&&f.getId()=="year"){this.setProperty("dateFormat","yyyy");}});}
this.haveCalledUpdateUI=false;if(debug)console.log("\tcalling updateUI");try{let requirement=this.getRequirement();if(requirement){HU.waitForIt(requirement,()=>{this.updateUI({reload:reload});});}else{this.updateUI({reload:reload});}}catch(err){this.displayError("Error creating display:<br>"+err);console.log(err);return;}
if(!reload){this.lastPointData=pointData;this.propagateEvent(DisplayEvent.pointDataLoaded,pointData);}},getHasDate:function(records){var lastDate=null;this.hasDate=false;for(j=0;j<records.length;j++){var record=records[j];var date=record.getDate();if(date==null){continue;}
if(lastDate!=null&&lastDate.getTime()!=date.getTime()){this.hasDate=true;break}
lastDate=date;}
return this.hasDate;},dateInRange:function(date,debug){if(debug){console.log("dateInRange: date:"+date+" minDate:"+this.minDateObj+" maxDate:"+this.maxDateObj);}
if(date!=null){if(this.dateRangeDoDay&&this.minDateObj){if(date.getUTCFullYear()!=this.minDateObj.getUTCFullYear()||date.getUTCMonth()!=this.minDateObj.getUTCMonth()||date.getUTCDate()!=this.minDateObj.getUTCDate()){return false;}}else{if(this.minDateObj!=null&&date.getTime()<this.minDateObj.getTime()){if(debug){console.log("    minDate:\n\t"+date.getTime()+"\n\t"+this.minDateObj.getTime());}
return false;}
if(this.maxDateObj!=null&&date.getTime()>this.maxDateObj.getTime()){if(debug){console.log("    maxDate:\n\t"+date.getTime()+"\n\t"+this.minDateObj.getTime());}
return false;}}
if(this.startDateObject!=null&&date.getTime()<this.startDateObject.getTime()){if(debug){}
return false;}
if(this.endDateObject!=null&&date.getTime()>this.endDateObject.getTime()){if(debug){console.log("    endDate:\n\t"+date.getTime()+"\n\t"+this.endDateObject.getTime());}
return false;}}
return true;},getPointData:function(){if(this.dataCollection.getList().length==0)return null;return this.dataCollection.getList()[0];},getRecords:function(){let pointData=this.getData();if(pointData==null)return null;return pointData.getRecords();},getDataValues:function(obj){if(obj.tuple)return obj.tuple;else if(obj.getData)return obj.getData();return obj;},indexToRecord:{},recordToIndex:{},findMatchingDates:function(date,records,within){if(!Utils.isDefined(within))within=0;let good=[];let millis=date.getTime();records.forEach(r=>{let rd=r.getDate();if(!rd)return;let diff=Math.abs(rd.getTime()-millis);if(diff<=within){good.push(r);}});return good;},findMatchingIndex:function(record){if(!record)return{index:-1,record:null};var index=this.recordToIndex[record.getId()];if(Utils.isDefined(index)){return{index:index,record:this.indexToRecord[index]}}
if(!record.hasDate())return-1;let records=this.filteredRecords;if(!records){records=[];for(i in this.indexToRecord){records.push(this.indexToRecord[i]);}}
var closest;var min=0;records.forEach(r=>{if(!r.hasDate()){return-1;}
var diff=Math.abs(record.getDate().getTime()-r.getDate().getTime());if(!closest){min=diff;closest=r;}else{if(diff<min){min=diff;closest=r;}}});if(!closest)
return{index:-1,record:null}
return{index:this.recordToIndex[closest.getId()],record:closest};},makeDataArray:function(dataList){if(dataList.length==0)return dataList;var data=[];if(dataList[0].getData){for(var i=0;i<dataList.length;i++){data.push(dataList[i].getData()[0]);}}else if(dataList[0].tuple){for(var i=0;i<dataList.length;i++){data.push(dataList[i].tuple);}}else{data=dataList;}
return data;},printFields:function(label,fields){console.log(label);if(!fields){console.log("   null fields");return;}
for(a in fields)
console.log("   "+fields[a].getId());},makeIndexValue:function(indexField,value,offset){return value+offset;},getStandardData:function(fields,args){if(!args)args={};let debug=displayDebug.getStandardData;if(debug)console.log("getStandardData:"+this.type+"  fields:"+fields);let showUnit=this.getProperty("showUnit",this.getProperty("showUnitInSeries",true));this.recordToIndex={};this.indexToRecord={};var pointData=this.getPointData();var excludeZero=this.getProperty(PROP_EXCLUDE_ZERO,false);var excludeNan=this.getProperty(PROP_EXCLUDE_NAN,false);if(fields==null){fields=pointData.getRecordFields();if(debug)console.log("\tgetRecordFields: "+fields.length);}else{}
props={makeObject:true,includeIndex:true,includeIndexIfDate:false,groupByIndex:-1,raw:false,};if(args!=null){$.extend(props,args);}
let groupByIndex=props.groupByIndex;let groupByList=[];let groupByValues={};let groupByRecords=[];let groupByDate=this.getProperty("groupByDate");let groupByFill=this.getProperty("groupByFill");let groupByDateMap={};let groupByDates=[];var dataList=[];var fieldNames=[];var fieldsForTuple=[];if(this.getProperty("binDate")){if(debug)
console.log("binning date");var binType=this.getProperty("binType","total");var binCount=binType=="count";if(binCount){var f=[];fields.forEach((field)=>{f.push(new RecordField({index:0,id:field.getId(),label:this.getProperty("binDateLabel",this.getProperty("binCountLabel","Count")),type:"double",chartable:true}));});fields=f;}}
let seenDate=false;fields=fields.filter(f=>{if(f.isFieldDate()){if(seenDate&&f.isRecordDate())return null;seenDate=true;}
return f;});for(i=0;i<fields.length;i++){var field=fields[i];if(field.isFieldNumeric()&&field.isFieldDate()){}
var name=field.getLabel();if(showUnit&&field.getUnit()!=null){name+=" ("+field.getUnit()+")";}
name=name.replace(/!!/g," -- ")
fieldNames.push(name);fieldsForTuple.push(field);}
if(props.makeObject){dataList.push({tuple:fieldNames,fields:fieldsForTuple,record:null});}else{dataList.push(fieldNames);}
groupByList.push("");groupByRecords.push(null);if(!this.minDateObj){this.minDateObj=Utils.parseDate(this.minDate,false);if(debug)
console.log("getStandardData setting min date:"+this.minDateObj);}
if(!this.minDateObj){this.maxDateObj=Utils.parseDate(this.maxDate,true,this.minDateObj);if(debug)
console.log("getStandardData setting max date:"+this.maxDateObj);}
if(this.minDateObj==null&&this.maxDateObj!=null){this.minDateObj=Utils.parseDate(this.minDate,false,this.maxDateObj);}
let offset=0;if(Utils.isDefined(this.offset)){offset=parseFloat(this.offset);}
let nonNullRecords=0;let records=args.records?args.records:this.filterData();if(debug)
console.log("getStandardData #fields:"+fields.length+" #records:"+records.length);let allFields=pointData.getRecordFields();this.hasDate=this.getHasDate(records);let date_formatter=null;let rowCnt=-1;let indexField=this.getFieldById(null,this.getProperty("indexField"));var t1=new Date();for(let rowIdx=0;rowIdx<records.length;rowIdx++){let record=records[rowIdx];let date=record.getDate();if(!this.dateInRange(date)){continue;}
rowCnt++;this.recordToIndex[record.getId()]=rowCnt;this.indexToRecord[rowCnt]=record;let values=[];if(props&&(props.includeIndex||props.includeIndexIfDate)){var indexName=null;if(indexField){let value=this.makeIndexValue(indexField,record.getValue(indexField.getIndex()),rowIdx);values.push(value);indexName=indexField.getLabel();}else{if(this.hasDate){let dttm=this.getDateValue(date,date_formatter);values.push(dttm);indexName="Date";}else{if(!props.includeIndexIfDate){values.push(rowIdx);indexName=this.getProperty("indexName","Index");}}}
if(indexName!=null&&rowCnt==0){fieldNames.unshift(indexName);}}
let allNull=true;let allZero=true;let hasNumber=false;let hasNan=false;for(let fieldIdx=0;fieldIdx<fields.length;fieldIdx++){let field=fields[fieldIdx];if(field.isFieldNumeric()&&field.isFieldDate()){}
var value=record.getValue(field.getIndex());if(offset!=0){value+=offset;}
if(value!=null){allNull=false;}
if(typeof value=='number'){if(excludeNan&&isNaN(value)){hasNan=true;}
hasNumber=true;if(value!=0){allZero=false;}}
if(field.isFieldDate()){value=this.getDateValue(value,date_formatter);}
values.push(value);}
if(hasNan){continue;}
if(hasNumber&&allZero&&excludeZero){continue;}
if(groupByIndex>=0){var value=record.getValue(groupByIndex);if(!groupByValues[value])groupByValues[value]=true;if(groupByDate)
groupByList.push(record.getDate()+"-"+value);else
groupByList.push(value);groupByRecords.push(record);}
if(props.makeObject)
dataList.push({tuple:values,record:record});else
dataList.push(values);if(!allNull){nonNullRecords++;}}
var t2=new Date();if(nonNullRecords==0){console.log("no nonNull records");return[];}
if(groupByIndex>=0){var groupToTuple={};var groups=[];var agg=[];var title=[];let groupByCount=this.getProperty("groupByCount");title.push(props.groupByField.getLabel());if(groupByCount){title.push(this.getProperty("groupByCountLabel","Count"));}else{for(var fieldIdx=0;fieldIdx<fields.length;fieldIdx++){var field=fields[fieldIdx];if(field.getIndex()!=groupByIndex){title.push(field.getLabel());}}}
let groupByValueTuples={};for(var rowIdx=0;rowIdx<dataList.length;rowIdx++){var data=this.getDataValues(dataList[rowIdx]);if(rowIdx==0){continue;}
var groupBy=groupByList[rowIdx];var record=groupByRecords[rowIdx];var groupByValue=record.getValue(groupByIndex);var tuple=groupToTuple[groupBy];if(tuple==null){tuple=new Array();groups.push(groupBy);if(groupByDate){let dateList=groupByDateMap[record.getDate()];if(dateList==null){groupByDateMap[record.getDate()]=dateList=[];groupByDates.push(record.getDate());}
dateList.push(tuple);}
if(!groupByValueTuples[groupByValue])groupByValueTuples[groupByValue]=[];groupByValueTuples[groupByValue].push(tuple)
tuple.record=record;agg.push(tuple);tuple.push(groupByValue);if(groupByCount){tuple.push(0);}else{for(var fieldIdx=0;fieldIdx<fields.length;fieldIdx++){var field=fields[fieldIdx];if(field.getIndex()==groupByIndex){continue;}
tuple.push(0);}}
groupToTuple[groupBy]=tuple;}
var index=0;if(groupByCount){tuple[1]++;continue;}
for(var fieldIdx=0;fieldIdx<fields.length;fieldIdx++){var field=fields[fieldIdx];if(field.getIndex()==groupByIndex){continue;}
var dataValue=data[fieldIdx];index++;if(Utils.isNumber(dataValue)){if(typeof tuple[index]=="string"){tuple[index]=0;}
tuple[index]+=parseFloat(dataValue);}else{if(tuple[index]==0){tuple[index]="";}
var s=tuple[index];if(!Utils.isDefined(s)){s="";}
if(s.length<150){if(!Utils.isDefined(dataValue)){dataValue="";}
var sv=(""+dataValue);if(s.indexOf(sv)<0){if(s!=""){s+=", ";}
s+=sv;tuple[index]=s;}}}}}
if(groupByFill){groupByDates.forEach(date=>{let dateList=groupByDateMap[date];let seen={};dateList.forEach(tuple=>{seen[tuple[0]]=true;});for(v in groupByValues){if(!seen[v]){seen[v]=true;let tuple=[v,0];tuple.date=date;agg.push(tuple);}}});}
if(this.getProperty("groupBySort")){agg.sort(function(a,b){return b[1]-a[1]});}
if(this.getProperty("groupByMaxNumber")){let cnt=+this.getProperty("groupByMaxNumber");agg=agg.filter((t,idx)=>{return idx<cnt;});}
let tmp=[];tmp.push(title);agg.forEach(t=>tmp.push(t));return tmp;}
if(this.getProperty("movingAverageSteps")){let steps=+this.getProperty("movingAverageSteps");let tmp=[dataList[i]];let isNumeric=dataList[1].tuple.map((v,idx)=>{return Utils.isNumber(v);});dataList.forEach((o,rowIdx)=>{if(rowIdx==0)return;let tuple=Utils.mergeLists(o.tuple);tmp.push({record:o.record,tuple:tuple});tuple[0]="x";tuple[1]=5;tuple.forEach((v,colIdx)=>{if(!isNumeric[colIdx])return;tuple[colIdx]=5;});});dataList=tmp;}
return dataList;},isGoogleLoaded:function(){if((typeof google==='undefined')||(typeof google.visualization==='undefined')||(typeof google.visualization.DateFormat==='undefined')){return false;}
return true;},initDateFormats:function(){if(!this.isGoogleLoaded()){return false;}
if(this.fmt_yyyy)return true;var tz=0;this.timezone=this.getProperty("timezone");if(Utils.isDefined(this.timezone)){tz=parseFloat(this.timezone);}
this.fmt_yyyymmddhhmm=new google.visualization.DateFormat({pattern:"yyyy-MM-dd HH:mm Z",timeZone:tz});this.fmt_yyyymmdd=new google.visualization.DateFormat({pattern:"yyyy-MM-dd",timeZone:tz});this.fmt_yyyy=new google.visualization.DateFormat({pattern:"yyyy",timeZone:tz});return true;},getDateValue:function(arg){if(!this.initDateFormats()){return arg;}
if(!(typeof arg=="object")){date=new Date(arg);}else{date=arg;}
if(isNaN(date.getUTCFullYear()))return{v:date,f:"NA"};if(this.getProperty("dateFormatDaysAgo",false)){let now=new Date();let diff=Math.round((now.getTime()-date.getTime())/1000/60/60/24);return{v:date,f:diff+" days ago"};}
return{v:date,f:this.formatDate(date)};},applyFilters:function(record,values){for(var i=0;i<this.filters.length;i++){if(!this.filters[i].isRecordOk(record)){return false;}}
return true;}});let filter=this.getProperty(PROP_DISPLAY_FILTER);if(filter!=null){var filters=filter.split(";");for(var i=0;i<filters.length;i++){filter=filters[i];var toks=filter.split(":");var type=toks[0];if(type=="month"){this.filters.push(new MonthFilter(toks[1]));}else{console.log("unknown filter:"+type);}}}}
function DisplayGroup(argDisplayManager,argId,argProperties,type){const LAYOUT_TABLE="table";const LAYOUT_HTABLE="htable";const LAYOUT_TABS="tabs";const LAYOUT_COLUMNS="columns";const LAYOUT_ROWS="rows";const SUPER=new RamaddaDisplay(argDisplayManager,argId,type||"group",argProperties);RamaddaUtil.inherit(this,SUPER);RamaddaUtil.defineMembers(this,{displays:[],layout:this.getProperty(PROP_LAYOUT_TYPE,LAYOUT_TABLE),columns:this.getProperty(PROP_LAYOUT_COLUMNS,1),isLayoutColumns:function(){return this.layout==LAYOUT_COLUMNS;},getWikiText:function(){var attrs=["layoutType",this.layout,"layoutColumns",this.columns,"showMenu","false","groupDiv","$entryid_maindiv"];let wiki="";wiki+="<div id=\"{{entryid}}_maindiv\"></div>\n";wiki+="{{group "+HU.attrs(attrs)+"}}\n"
return wiki;},walkTree:function(func,data){for(var i=0;i<this.displays.length;i++){let display=this.displays[i];if(display.walkTree!=null){display.walkTree(func,data);}else{func.call(data,display);}}},collectEntries:function(entries){if(entries==null)entries=[];for(let i=0;i<this.displays.length;i++){let display=this.displays[i];if(display.collectEntries!=null){display.collectEntries(entries);}else{let displayEntries=display.getEntries();if(displayEntries!=null&&displayEntries.length>0){entries.push({source:display,entries:displayEntries});}}}
return entries;},isLayoutRows:function(){return this.layout==LAYOUT_ROWS;},getPosition:function(){for(let i=0;i<this.displays.length;i++){let display=this.displays[i];if(display.getPosition){return display.getPosition();}}},getDisplays:function(){return this.displays;},notifyEvent:function(event,source,data){let displays=this.getDisplays();let group=(source!=null&&source.getProperty?source.getProperty(event+".shareGroup"):"");if(displayDebug.notifyEvent)
console.log("displayManager.notifyEvent:"+event);for(let i=0;i<this.displays.length;i++){let display=this.displays[i];if(display==source){continue;}
let acceptGroup=(display!=null&&display.getProperty?display.getProperty(event.acceptGroup):"");if(group){if(acceptGroup!=group){if(displayDebug.notifyEvent)
console.log("\t"+display.type+" not in group:"+group);continue;}}else if(acceptGroup){if(displayDebug.notifyEvent)
console.log("\t"+display.type+" incoming not in accept group:"+acceptGroup);continue;}
if(!display.acceptEvent(event,true)){if(displayDebug.notifyEvent)
console.log("\t"+display.type+" not accepting");continue;}
let eventSource=display.getEventSource();if(eventSource!=null&&eventSource.length>0){if(eventSource!=source.getId()&&eventSource!=source.getName()){continue;}}
display.notifyEvent(event,source,data);}},getDisplaysToLayout:function(){let result=[];for(let i=0;i<this.displays.length;i++){if(this.displays[i].getIsLayoutFixed()){continue;}
result.push(this.displays[i]);}
return result;},pageHasLoaded:function(display){this.doLayout();},addDisplay:function(display){this.displays.push(display);if(display.getIsLayoutFixed()){display.initDisplay();}else{if(Utils.getPageLoaded()){this.doLayout();}}},layoutChanged:function(display){this.doLayout();},removeDisplay:function(display){let index=this.displays.indexOf(display);if(index>=0){this.displays.splice(index,1);}
this.doLayout();},doLayout:function(){let html="";let colCnt=100;let displaysToLayout=this.getDisplaysToLayout();let displaysToPrepare=this.displays;displaysToPrepare.forEach(display=>{if(display.prepareToLayout!=null){display.prepareToLayout();}});let weightIdx=0;let weights=null;if(typeof this.weights!="undefined"){weights=this.weights.split(",");}
for(let i=0;i<displaysToLayout.length;i++){let divId=HU.getUniqueId("divid_");let div=HU.div([CLASS," display-wrapper",ID,divId],"");displaysToLayout[i].setProperty(PROP_DIVID,divId);displaysToLayout[i].layoutDiv=div;}
let tabId=HU.getUniqueId("tabs_");if(this.layout==LAYOUT_TABLE){if(displaysToLayout.length==1){html+=displaysToLayout[0].layoutDiv;}else{let weight=12/this.columns;let i=0;let map={};for(;i<displaysToLayout.length;i++){let d=displaysToLayout[i];if(Utils.isDefined(d.column)&&Utils.isDefined(d.row)&&d.columns>=0&&d.row>=0){let key=d.column+"_"+d.row;if(map[key]==null)map[key]=[];map[key].push(d);}}
i=0;for(;i<displaysToLayout.length;i++){colCnt++;if(colCnt>=this.columns){if(i>0){html+=HU.close(TAG_DIV);}
html+=HU.open("div",[CLASS,"row"]);colCnt=0;}
let weightToUse=weight;if(weights!=null){if(weightIdx>=weights.length){weightIdx=0;}
weightToUse=weights[weightIdx];weightIdx++;}
html+=HU.div([CLASS,"col-md-"+weightToUse+" display-wrapper display-cell"],displaysToLayout[i].layoutDiv);html+="\n";}
if(i>0){html+=HU.close(TAG_DIV);}}}else if(this.layout==LAYOUT_HTABLE){if(displaysToLayout.length==1){html+=displaysToLayout[0].layoutDiv;}else{let percent=Math.round((100/this.columns))+"%";let i=0;html+=HU.open(TABLE,[WIDTH,'100%']);let colCnt=100;for(let i=0;i<displaysToLayout.length;i++){colCnt++;if(colCnt>=this.columns){if(i>0){html+=HU.close(TAG_TR);}
html+=HU.open("tr",["valign","top"]);html+="\n";colCnt=0;}
html+=HU.td(["width",percent],displaysToLayout[i].layoutDiv);html+="\n";}
if(i>0){html+=HU.close(TAG_TR);}}}else if(this.layout==LAYOUT_TABS){html+=HU.open(TAG_DIV,[ID,tabId,CLASS,"ui-tabs"]);html+=HU.open(TAG_UL,[]);let hidden="";let cnt=0;for(let i=0;i<displaysToLayout.length;i++){let display=displaysToLayout[i];let label=display.getTitle(false);if(label.length>20){label=label.substring(0,19)+"...";}
html+=HU.tag(TAG_LI,[],HU.tag(TAG_A,["href","#"+tabId+"-"+cnt],label));hidden+=HU.div([ID,tabId+"-"+cnt,CLASS,"ui-tabs-hide"],display.layoutDiv);cnt++;}
html+=HU.close(TAG_UL);html+=hidden;html+=HU.close(TAG_DIV);}else if(this.layout==LAYOUT_ROWS){let rows=[];for(let i=0;i<displaysToLayout.length;i++){let display=displaysToLayout[i];let row=display.getRow();if((""+row).length==0)row=0;while(rows.length<=row){rows.push([]);}
rows[row].push(display.layoutDiv);}
for(let i=0;i<rows.length;i++){let cols=rows[i];let width=Math.round(100/cols.length)+"%";html+=HU.open(TAG_TABLE,["border","0","width","100%","cellpadding","0","cellspacing","0"]);html+=HU.open(TAG_TR,["valign","top"]);for(let col=0;col<cols.length;col++){let cell=cols[col];cell=HU.div([CLASS,"display-cell"],cell);html+=HU.tag(TAG_TD,["width",width],cell);}
html+=HU.close(TAG_TR);html+=HU.close(TAG_TABLE);}}else if(this.layout==LAYOUT_COLUMNS){let cols=[];for(let i=0;i<displaysToLayout.length;i++){let display=displaysToLayout[i];let column=display.getColumn();if((""+column).length==0)column=0;while(cols.length<=column){cols.push([]);}
cols[column].push(display.layoutDiv);}
html+=HU.open(TAG_DIV,[CLASS,"row"]);let width=Math.round(100/cols.length)+"%";let weight=12/cols.length;for(let i=0;i<cols.length;i++){let rows=cols[i];let contents="";for(let j=0;j<rows.length;j++){contents+=rows[j];}
let weightToUse=weight;if(weights!=null){if(weightIdx>=weights.length){weightIdx=0;}
weightToUse=weights[weightIdx];weightIdx++;}
html+=HU.div([CLASS,"col-md-"+weightToUse],contents);}
html+=HU.close(TAG_DIV);}else{html+="Unknown layout:"+this.layout;}
if(!this.getShowMenu()&&displaysToLayout.length==0){}else{$("#"+this.getId()).show();}
let div=this.getGroupDiv();if(div.length>0){div.html(html);}else{this.writeHtml(ID_DISPLAYS,html);}
if(this.layout==LAYOUT_TABS){$("#"+tabId).tabs({activate:HtmlUtil.tabLoaded});}
this.initDisplays();},initDisplays:function(){this.getDisplaysToLayout().forEach(display=>{try{display.initDisplay();}catch(e){display.displayError("Error creating display:<br>"+e);console.log("error creating display: "+display.type);console.log(e.stack)}});},displayData:function(){},setLayout:function(layout,columns){this.layout=layout;if(columns){this.columns=columns;}
this.doLayout();},askMinZAxis:function(){let v=prompt("Minimum axis value","0");if(v!=null){v=parseFloat(v);for(let i=0;i<this.displays.length;i++){let display=this.displays[i];if(display.setMinZAxis){display.setMinZAxis(v);}}}},askMaxZAxis:function(){let v=prompt("Maximum axis value","0");if(v!=null){v=parseFloat(v);for(let i=0;i<this.displays.length;i++){let display=this.displays[i];if(display.setMaxZAxis){display.setMaxZAxis(v);}}}},askMinDate:function(){let d=this.minDate;if(!d)d="1950-0-0";this.minDate=prompt("Minimum date",d);if(this.minDate!=null){for(let i=0;i<this.displays.length;i++){let display=this.displays[i];if(display.setMinDate){display.setMinDate(this.minDate);}}}},askMaxDate:function(){let d=this.maxDate;if(!d)d="2020-0-0";this.maxDate=prompt("Maximum date",d);if(this.maxDate!=null){for(let i=0;i<this.displays.length;i++){let display=this.displays[i];if(display.setMaxDate){display.setMaxDate(this.maxDate);}}}},titlesOff:function(){for(let i=0;i<this.displays.length;i++){this.displays[i].setShowTitle(false);}},titlesOn:function(){for(let i=0;i<this.displays.length;i++){this.displays[i].setShowTitle(true);}},detailsOff:function(){for(let i=0;i<this.displays.length;i++){this.displays[i].setShowDetails(false);}
this.doLayout();},detailsOn:function(){for(let i=0;i<this.displays.length;i++){this.displays[i].setShowDetails(true);}
this.doLayout();},deleteAllDisplays:function(){this.displays=[];this.doLayout();},moveDisplayUp:function(display){let index=this.displays.indexOf(display);if(index<=0){return;}
this.displays.splice(index,1);this.displays.splice(index-1,0,display);this.doLayout();},moveDisplayDown:function(display){let index=this.displays.indexOf(display);if(index>=this.displays.length){return;}
this.displays.splice(index,1);this.displays.splice(index+1,0,display);this.doLayout();},moveDisplayTop:function(display){let index=this.displays.indexOf(display);if(index>=this.displays.length){return;}
this.displays.splice(index,1);this.displays.splice(0,0,display);this.doLayout();},});}
function RamaddaFieldsDisplay(displayManager,id,type,properties){const SUPER=new RamaddaDisplay(displayManager,id,type,properties);defineDisplay(this,SUPER,[],{needsData:function(){return true;},initDisplay:function(){SUPER.initDisplay.call(this);if(this.needsData()){if(this.useDisplayMessage()){this.setDisplayMessage(this.getLoadingMessage());}else{this.setContents(this.getLoadingMessage());}}
this.callUpdateUI();},updateUI:function(args){this.addFieldsCheckboxes();},getWikiAttributes:function(attrs){SUPER.getWikiAttributes.call(this,attrs);if(this.lastSelectedFields){attrs.push(PROP_FIELDS);var v="";for(var i=0;i<this.lastSelectedFields.length;i++){v+=this.lastSelectedFields[i].getId();v+=",";}
attrs.push(v);}},initDialog:function(){SUPER.initDialog.call(this);this.addFieldsCheckboxes();},getDialogContents:function(tabTitles,tabContents){var height="600";SUPER.getDialogContents.call(this,tabTitles,tabContents);},handleEventFieldsSelected:function(source,fields){if(fields.length>0&&(typeof fields[0]=="string")){var tmp=[];fields.forEach(f=>{f=this.getFieldById(null,f);if(f)tmp.push(f);});fields=tmp;}
this.userHasSelectedAField=true;this.overrideFields=null;this.removeProperty(PROP_FIELDS);this.setSelectedFields(fields);this.fieldSelectionChanged();},getFieldsToSelect:function(pointData){return pointData.getRecordFields();},canDoMultiFields:function(){return true;}})}
const PROP_LAYOUT_TYPE="layoutType";const PROP_LAYOUT_COLUMNS="layoutColumns";const PROP_SHOW_MAP="showMap";const PROP_SHOW_MENU="showMenu";const PROP_FROMDATE="fromDate";const PROP_TODATE="toDate";const DISPLAY_MULTI="multi";function addDisplayManager(displayManager){if(window.globalDisplayManagers==null){window.globalDisplayManagers={};}
window.globalDisplayManagers[displayManager.getId()]=displayManager;window.globalDisplayManager=displayManager;}
addGlobalDisplayType({type:DISPLAY_MULTI,label:"Multi Chart",requiresData:true,forUser:false,category:"Misc"});function getOrCreateDisplayManager(id,properties,force){if(!force){var displayManager=getDisplayManager(id);if(displayManager!=null){return displayManager;}
if(window.globalDisplayManager!=null){return window.globalDisplayManager;}}
var displayManager=new DisplayManager(id,properties);if(window.globalDisplayManager==null){window.globalDisplayManager=displayManager;}
return displayManager;}
function getDisplayManager(id){if(window.globalDisplayManagers==null){return null;}
var manager=window.globalDisplayManagers[id];return manager;}
var ID_DISPLAYS="displays";function DisplayManager(argId,argProperties){var ID_MENU_BUTTON="menu_button";var ID_MENU_CONTAINER="menu_container";var ID_MENU_OUTER="menu_outer";var ID_MENU_INNER="menu_inner";RamaddaUtil.inherit(this,this.SUPER=new DisplayThing(argId,argProperties));addRamaddaDisplay(this);RamaddaUtil.initMembers(this,{dataList:[],displayTypes:[],initMapBounds:null,});RamaddaUtil.defineMembers(this,{group:new DisplayGroup(this,argId,argProperties),showmap:this.getProperty(PROP_SHOW_MAP,null),setDisplayReady:function(){SUPER.setDisplayReadyCall(this);this.getLayoutManager().setDisplayReady();},getLayoutManager:function(){return this.group;},collectEntries:function(){return this.getLayoutManager().collectEntries();},getData:function(){return this.dataList;},handleEventFieldValueSelect:function(source,args){this.notifyEvent(DisplayEvent.fieldValueSelected,source,args);},handleEventFieldsSelected:function(source,fields){this.notifyEvent(DisplayEvent.fieldsSelected,source,fields);},handleEventPropertyChanged:function(source,prop){this.notifyEvent(DisplayEvent.propertyChanged,source,prop);},handleEventEntriesChanged:function(source,entries){this.notifyEvent(DisplayEvent.entriesChanged,source,entries);},handleEventMapBoundsChanged:function(source,bounds,forceSet){var args={"bounds":bounds,"force":forceSet};this.notifyEvent(DisplayEvent.mapBoundsChanged,source,args);},addMapLayer:function(source,entry){this.notifyEvent("addMapLayer",source,{entry:entry});},propagateEventRecordSelection:function(source,pointData,args){var index=args.index;if(pointData==null&&this.dataList.length>0){pointData=this.dataList[0];}
var fields=pointData.getRecordFields();var records=pointData.getRecords();if(records==null){return;}
if(index<0||index>=records.length){console.log("propagateEventRecordSelection: bad index= "+index);return;}
var record=records[index];if(record==null)return;var values=source?source.getRecordHtml(record,fields):"";if(source.recordSelectionCallback){var func=source.recordSelectionCallback;if((typeof func)=="string"){func=window[func];}
func({display:source,pointData:pointData,index:index,pointRecord:record});}
var params={index:index,record:record,html:values,data:pointData};this.notifyEvent(DisplayEvent.recordSelection,source,params);var entries=source.getEntries();if(entries!=null&&entries.length>0){this.handleEventEntrySelection(source,{entry:entries[0],selected:true});}},handleEventEntrySelection:function(source,props){this.notifyEvent(DisplayEvent.entrySelection,source,props);},handleEventEntryMouseover:function(source,props){this.notifyEvent(DisplayEvent.entryMouseover,source,props);},handleEventEntryMouseout:function(source,props){this.notifyEvent(DisplayEvent.entryMouseout,source,props);},handleEventPointDataLoaded:function(source,pointData){this.notifyEvent(DisplayEvent.pointDataLoaded,source,pointData);},ranges:{},setRange:function(field,range){if(this.ranges[field.getId()]==null){this.ranges[field.getId()]=range;}},getRange:function(field){return this.ranges[field.getId()];},makeMainMenu:function(){if(!this.getShowMenu()){return"";}
var get="getDisplayManager('"+this.getId()+"')";var layout="getDisplayManager('"+this.getId()+"').getLayoutManager()";var html="";var newMenus={};var cats=[];var displayTypes=[];if(window.globalDisplayTypes!=null){displayTypes=window.globalDisplayTypes;}
DISPLAY_CATEGORIES.forEach(category=>{newMenus[category]=[];cats.push(category);});for(var i=0;i<displayTypes.length;i++){var type=displayTypes[i];if(Utils.isDefined(type.forUser)&&!type.forUser){continue;}
var category=type.category;if(!category){category=CATEGORY_MISC;}
if(newMenus[category]==null){newMenus[category]=[];cats.push(category);}
let menuAttrs=["onclick",get+".userCreateDisplay('"+type.type+"');"];if(type.desc){menuAttrs.push(TITLE);menuAttrs.push(type.desc);}
newMenus[category].push(HU.tag(TAG_LI,[],HU.tag(TAG_A,menuAttrs,type.label)));}
let newMenu="";for(var i=0;i<cats.length;i++){var cat=cats[i];var menu=Utils.join(newMenus[cat],"");var subMenu=HU.tag("ul",[],menu);var catLabel=HU.tag(TAG_A,[],cat);newMenu+=HU.tag(TAG_LI,[],catLabel+subMenu);}
var publishMenu=HU.tag(TAG_LI,[],HU.onClick(layout+".publish('media_photoalbum');","New Photo Album"))+"\n"+
HU.tag(TAG_LI,[],HU.onClick(layout+".publish('wikipage');","New Wiki Page"))+"\n"+
HU.tag(TAG_LI,[],HU.onClick(layout+".publish('blogentry');","New Blog Post"))+"\n";var fileMenu=HU.tag(TAG_LI,[],"<a>Publish</a>"+HU.tag("ul",[],publishMenu))+"\n"+
HU.tag(TAG_LI,[],HU.onClick(layout+".showWikiText();","Show Text"))+"\n"+
HU.tag(TAG_LI,[],HU.onClick(layout+".copyWikiText();","Copy Text"))+"\n"+
HU.tag(TAG_LI,[],HU.onClick(layout+".copyDisplayedEntries();","Save entries"))+"\n";var titles=HU.tag(TAG_DIV,["class","ramadda-menu-block"],"Titles: "+HU.onClick(layout+".titlesOn();","On")+"/"+HU.onClick(layout+".titlesOff();","Off"));var dates=HU.tag(TAG_DIV,["class","ramadda-menu-block"],"Set date range: "+
HU.onClick(layout+".askMinDate();","Min")+"/"+
HU.onClick(layout+".askMaxDate();","Max"));var editMenu=HU.tag(TAG_LI,[],HU.tag(TAG_DIV,["class","ramadda-menu-block"],"Set axis range :"+
HU.onClick(layout+".askMinZAxis();","Min")+"/"+
HU.onClick(layout+".askMaxZAxis();","Max")))+
HU.tag(TAG_LI,[],dates)+
HU.tag(TAG_LI,[],titles)+"\n"+
HU.tag(TAG_LI,[],HU.tag(TAG_DIV,["class","ramadda-menu-block"],"Details: "+HU.onClick(layout+".detailsOn();","On",[])+"/"+
HU.onClick(layout+".detailsOff();","Off",[])))+
HU.tag(TAG_LI,[],HU.onClick(layout+".deleteAllDisplays();","Delete all displays"))+"\n"+
"";var table=HU.tag(TAG_DIV,["class","ramadda-menu-block"],"Table: "+
HU.onClick(layout+".setLayout('table',1);","1 column")+" / "+
HU.onClick(layout+".setLayout('table',2);","2 column")+" / "+
HU.onClick(layout+".setLayout('table',3);","3 column")+" / "+
HU.onClick(layout+".setLayout('table',4);","4 column"));var layoutMenu=HU.tag(TAG_LI,[],table)+
HU.tag(TAG_LI,[],HU.onClick(layout+".setLayout('rows');","Rows"))+"\n"+
HU.tag(TAG_LI,[],HU.onClick(layout+".setLayout('columns');","Columns"))+"\n"+
HU.tag(TAG_LI,[],HU.onClick(layout+".setLayout('tabs');","Tabs"));var menuBar=HU.tag(TAG_LI,[],"<a>File</a>"+HU.tag("ul",[],fileMenu));menuBar+=HU.tag(TAG_LI,[],"<a>Edit</a>"+HU.tag("ul",[],editMenu))+
HU.tag(TAG_LI,[],"<a>New</a>"+HU.tag("ul",[],newMenu))+
HU.tag(TAG_LI,[],"<a>Layout</a>"+HU.tag("ul",[],layoutMenu));var menu=HU.div([STYLE,"background:#fff;z-index:1000;",ATTR_CLASS,"xramadda-popup",ATTR_ID,this.getDomId(ID_MENU_OUTER)],HU.tag("ul",[ATTR_ID,this.getDomId(ID_MENU_INNER),ATTR_CLASS,"sf-menu"],menuBar));html+=menu;return html;},hasGeoMacro:function(jsonUrl){if(!jsonUrl)return false;return jsonUrl.match(/(\${latitude})/g)!=null;},getJsonUrl:function(jsonUrl,display,props){display.getRequestMacros().forEach(m=>{jsonUrl=m.apply(jsonUrl);});if(display.getAnimationEnabled()){}
if(display.getProperty('dbSelect')){jsonUrl+="&"+"dbSelect"+"="+display.getProperty("select");}
if(display.getProperty("requestArgs")){let args=display.getProperty("requestArgs").split(",");for(let i=0;i<args.length;i+=2){jsonUrl+="&"+args[i]+"="+args[i+1];}}
if(display.pageSkip){jsonUrl+="&skip="+display.pageSkip;}
var fromDate=display.getProperty(PROP_FROMDATE);if(fromDate!=null){jsonUrl+="&fromdate="+fromDate;}
var toDate=display.getProperty(PROP_TODATE);if(toDate!=null){jsonUrl+="&todate="+toDate;}
if(this.hasGeoMacro(jsonUrl)){var lon=props.lon;var lat=props.lat;if((lon==null||lat==null)&&this.map!=null){var tuple=this.getPosition();if(tuple!=null){lat=tuple[0];lon=tuple[1];}}
if(lon!=null&&lat!=null){jsonUrl=jsonUrl.replace("${latitude}",lat.toString());jsonUrl=jsonUrl.replace("${longitude}",lon.toString());}}
jsonUrl=jsonUrl.replace("${numpoints}",1000);return jsonUrl;},getDefaultData:function(){for(var i in this.dataList){var data=this.dataList[i];var records=data.getRecords();if(records!=null){return data;}}
if(this.dataList.length>0){return this.dataList[0];}
return null;},writeDisplay:function(){if(this.originalLocation==null){this.originalLocation=document.location;}
var url=this.originalLocation+"#";url+="&display0=linechart";for(var attr in document){}
document.location=url;},userCreateDisplay:function(type,props){if(props==null){props={};}
props.editMode=true;props.layoutHere=false;if(type==DISPLAY_LABEL&&props.text==null){var text=prompt("Text");if(text==null)return;props.text=text;}
return this.createDisplay(type,props);},createDisplay:function(type,props){if(props==null){props={};}
if(props.data!=null){props.theData=props.data;props.data=null;}
if(props.theData!=null&&!props.theData.hasData()){let haveItAlready=false;for(var i=0;i<this.dataList.length;i++){let existingData=this.dataList[i];if(existingData.equals(props.theData)){props.theData=existingData;haveItAlready=true;break;}}
if(!haveItAlready){this.dataList.push(props.theData);}
}
if(type==null||type.trim().length==0)return null;var proc=type.substring(0,1).toUpperCase()+type.substring(1);var classname=null;var names=["Ramadda"+proc+"Display",proc+"Display","Display"+proc,proc];var func=null;var funcName=null;var msg="";for(var i=0;i<names.length;i++){msg+=("trying:"+names[i]+"\n");if(window[names[i]]!=null){funcName=names[i];func=window[names[i]];break;}}
if(func==null){console.log("Error: could not find display function:"+type);alert("Error: could not find display function:"+type+" msg: "+msg);return;}
let displayId=props.displayId;if(!displayId){displayId=this.getUniqueId("display");}
if(props.theData==null&&this.dataList.length>0){props.theData=this.dataList[0];}
props.createdInteractively=true;if(!props.entryId){props.entryId=this.group.entryId;}
let display=eval(" new "+funcName+"(this,'"+displayId+"', props);");if(display==null){console.log("Error: could not create display using:"+funcName);alert("Error: could not create display using:"+funcName);return;}
if(props.dummy)return display;this.addDisplay(display);display.doFinalInitialization();return display;},pageHasLoaded:function(display){this.getLayoutManager().pageHasLoaded();},addDisplay:function(display){display.setDisplayManager(this);display.loadInitialData();this.getLayoutManager().addDisplay(display);},getDisplays:function(){return this.getLayoutManager().getDisplays();},notifyEvent:function(event,source,data){this.getLayoutManager().notifyEvent(event,source,data);},removeDisplay:function(display){this.getLayoutManager().removeDisplay(display);this.notifyEvent(DisplayEvent.removeDisplay,this,display);},setEntry:function(entry){this.getLayoutManager().getDisplays().forEach(display=>{display.setEntry(entry);});},});addDisplayManager(this);let displaysHtml=HU.div([ATTR_ID,this.getDomId(ID_DISPLAYS),ATTR_CLASS,"display-container",STYLE,HU.css("display","block")]);let html=HU.openTag(TAG_DIV,["style","position:relative;"]);html+=HU.div(["id",this.getDomId(ID_MENU_CONTAINER)]);html+=this.getEntriesMenu(argProperties);if(this.getShowMenu()){html+=HU.tag(TAG_A,[ATTR_CLASS,"display-menu-button",ATTR_ID,this.getDomId(ID_MENU_BUTTON)],SPACE);}
let targetDiv=this.getProperty("target",this.getProperty("targetDiv"));let _this=this;if(targetDiv!=null){if($("#"+targetDiv).length==0){console.log("Error: display group could not find targetDiv:"+targetDiv);targetDiv=null;}}
if(targetDiv!=null){$(document).ready(function(){$("#"+targetDiv).html(displaysHtml);_this.getLayoutManager().doLayout();});}else{html+=displaysHtml;}
html+=HU.closeTag(TAG_DIV);let divid=this.getProperty("divId",this.getId());$("#"+divid).html(html)
this.initializeEntriesMenu();this.jq(ID_MENU_BUTTON).html(HU.getIconImage("fa-cog",[TITLE,"Display menu"])).button({classes:{"ui-button":"display-manager-button",}}).click(function(event){if(this.dialog){this.dialog.remove();}
let html=_this.makeMainMenu();this.dialog=HU.makeDialog({content:html,title:"Displays",my:"left top",at:"left bottom",anchor:_this.jq(ID_MENU_BUTTON)});_this.jq(ID_MENU_INNER).superfish({speed:'fast',delay:300});});}
function RamaddaMultiDisplay(displayManager,id,properties){this.props=properties;let SUPER=new DisplayGroup(displayManager,id,properties,DISPLAY_MULTI);RamaddaUtil.inherit(this,SUPER);addRamaddaDisplay(this);RamaddaUtil.defineMembers(this,{inInitDisplay:false,haveInited:false,needsData:function(){return true;},pointDataLoaded:function(pointData,url,reload){SUPER.pointDataLoaded.call(this,pointData,url,reload);this.initDisplay();},processMacros:function(selectedFields,value,makeList){if((typeof value)!="string")return null;var toks=[];if(value.includes("${fieldLabel}")){for(i=0;i<selectedFields.length;i++){var v=value.replace("\${fieldLabel}",selectedFields[i].getLabel());toks.push(v);}}else if(value.includes("${fieldId}")){for(i=0;i<selectedFields.length;i++){var v=value.replace("\${fieldId}",selectedFields[i].getId());toks.push(v);}}else if(value.includes("${fieldCnt}")){var v=value.replace("\${fieldCnt}",selectedFields.length);toks.push(v);}else if(value.includes("${")){}else{return null;}
if(makeList)return toks;return Utils.join(toks,",");},initDisplay:function(){try{this.initDisplayInner();}catch(e){this.setContents(this.getMessage("An error occurred:"+e));console.log("An error occurred:"+e);console.log(e.stack);}},useChartableFields:function(){return false;},initDisplayInner:function(){SUPER.initDisplay.call(this);let records=this.filterData();if(!records){this.setDisplayMessage(this.getLoadingMessage());return null;}
var allFields=this.getData().getRecordFields();var fields=this.getSelectedFields(allFields);if(fields.length==0){this.setContents(this.getMessage("no fields"));return;}
if(this.inInitDisplay)return;if(this.haveInited)return;this.haveInited=true;this.inInitDisplay=true;var props={};var foreachMap={};var foreachList=[];var cnt=0;for(a in this.props){if(a.startsWith("foreach_")){var value=this.props[a];var toks;var tmp=this.processMacros(fields,value,true);if(tmp){toks=tmp;}else{toks=value.split(",");}
a=a.substring(8);if(toks.length>cnt)cnt=toks.length;foreachMap[a]=toks;foreachList.push({attr:a,toks:toks});}
if(a.startsWith("sub_")){var value=this.props[a];a=a.substring(4);var tmp=this.processMacros(fields,value,false);if(tmp){value=tmp;}
props[a]=value;}}
var html=HU.div([ATTR_ID,this.getDomId(ID_DISPLAYS),ATTR_CLASS,"display-container"]);this.setContents(html);var groupProps={target:this.getDomId(ID_DISPLAYS),}
groupProps[PROP_LAYOUT_TYPE]='table';groupProps[PROP_LAYOUT_COLUMNS]=this.getProperty(PROP_LAYOUT_COLUMNS,"2");this.displayManager=new DisplayManager(this.getId()+"_manager",groupProps);props.layoutHere=false;if(this.props['data'])
props['data']=this.props['data'];var subType=this.getProperty("subType","table");if(cnt==0)cnt=1;for(var i=0;i<cnt;i++){var dprops={};$.extend(dprops,props);for(var j=0;j<foreachList.length;j++){if(i<foreachList[j].toks.length){dprops[foreachList[j].attr]=foreachList[j].toks[i];}}
if(dprops['fields'])dprops['fields']=dprops['fields'].split(",");this.displayManager.createDisplay(subType,dprops);}
this.inInitDisplay=false;}});}
const FILTER_ALL="-all-";let pointDataCache={};function DataCollection(){RamaddaUtil.defineMembers(this,{data:[],hasData:function(){for(var i=0;i<this.data.length;i++){if(this.data[i])
if(this.data[i].hasData())return true;}
return false;},getList:function(){return this.data;},setData:function(data){this.data=[data];},addData:function(data){this.data.push(data);},handleEventMapClick:function(myDisplay,source,lon,lat){var anyHandled=false;for(var i=0;i<this.data.length;i++){if(this.data[i].handleEventMapClick(myDisplay,source,lon,lat)){anyHandled=true;}}
return anyHandled;},});}
function BasePointData(name,properties){if(properties==null)properties={};RamaddaUtil.defineMembers(this,{recordFields:null,records:null,entryId:null,entry:null});$.extend(this,properties);RamaddaUtil.defineMembers(this,{name:name,properties:properties,initWith:function(thatPointData){this.recordFields=thatPointData.recordFields;this.records=thatPointData.records;this.setGroupField();return this;},handleEventMapClick:function(myDisplay,source,lon,lat){return false;},hasData:function(){return this.records!=null&&this.records.length>0;},clear:function(){this.records=null;this.recordFields=null;},getProperties:function(){return this.properties;},getProperty:function(key,dflt){var value=this.properties[key];if(value==null)return dflt;return value;},getRecordFields:function(){return this.recordFields;},addRecordField:function(field){this.recordFields.push(field);},getRecords:function(){return this.records;},getNumericFields:function(){var recordFields=this.getRecordFields();var numericFields=[];for(var i=0;i<recordFields.length;i++){var field=recordFields[i];if(field.isNumeric())numericFields.push(field);}
return numericFields;},getChartableFields:function(display){var recordFields=this.getRecordFields();var numericFields=[];var skip=/(TIME|HOUR|MINUTE|SECOND|YEAR|MONTH|DAY|LATITUDE|LONGITUDE|^ELEVATION$)/g;var skip=/(xxxnoskip)/g;for(var i=0;i<recordFields.length;i++){var field=recordFields[i];if(!field.isNumeric()||!field.isChartable()){continue;}
var ID=field.getId().toUpperCase();if(ID.match(skip)){continue;}
numericFields.push(field);}
return RecordUtil.sort(numericFields);},getNonGeoFields:function(display){var recordFields=this.getRecordFields();var numericFields=[];var hadDate=false;for(var i=0;i<recordFields.length;i++){var field=recordFields[i];if(field.isFieldGeo()){continue;}
if(field.isFieldDate()){if(hadDate&&field.getId()=="recordDate"){continue;}
hadDate=true;}
numericFields.push(field);}
return numericFields;},loadData:function(display){},getName:function(){return this.name;},getTitle:function(){if(this.records!=null&&this.records.length>0)
return this.name+" - "+this.records.length+" points";return this.name;}});}
function convertToPointData(array){var fields=[];var records=[];var header=array[0];var samples=array[1];for(var i=0;i<header.length;i++){let label=String(header[i]);let id=label.toLowerCase().replace(/[ ., ]+/g,"_");let sample=samples[i];let tof=typeof sample;let type;if(tof=="string")
type="string";else if(tof=="number")
type="double";else if(sample.getTime)
type="date";else
console.log("Unknown type:"+tof);fields.push(new RecordField({id:id,index:i,label:label,type:type,chartable:true}));}
for(var i=1;i<array.length;i++){records.push(new PointRecord(fields,NaN,NaN,NaN,null,array[i]));}
return new PointData("pointdata",fields,records,null,null);}
function PointData(name,recordFields,records,url,properties){RamaddaUtil.inherit(this,new BasePointData(name,properties));this.parentPointData=properties?properties.parent:null;RamaddaUtil.defineMembers(this,{recordFields:recordFields,records:records,url:url,baseUrl:url,loadingCnt:0,getRootPointData:function(){if(this.parentPointData)
return this.parentPointData.getRootPointData();return this;},getUrl:function(){if(this.url)return this.url;if(this.parentPointData)return this.parentPointData.getUrl();return null;},getCacheUrl:function(){if(this.baseUrl)return this.baseUrl;if(this.parentPointData)return this.parentPointData.getCacheUrl();return null;},equals:function(that){if(this.jsonUrl){return this.jsonUrl==that.jsonUrl;}
return this.url==that.url;},getIsLoading:function(){return this.loadingCnt>0;},handleEventMapClick:function(myDisplay,source,lon,lat){let url=this.getUrl();let cacheObject=pointDataCache[url];this.lon=lon;this.lat=lat;if(myDisplay.getDisplayManager().hasGeoMacro(url)){this.loadData(myDisplay,true);return true;}
return false;},startLoading:function(){this.loadingCnt++;},stopLoading:function(){this.loadingCnt--;},setGroupField:function(){if(this.recordFields){for(var i=0;i<this.recordFields.length;i++){var field=this.recordFields[i];if(field.isFieldGroup()){this.groupField=field;break;}}}},extractGroup:function(group,records){if(!this.groupField)return records;var groupData=this.getDataGroups(records);if(groupData.length==0)return records;if(!group)group=groupData[0];return records;},getDataGroups:function(records){if(!this.groupData){if(!records)return[];this.groupData=[];var groupField=this.getGroupField();if(!groupField)return this.groupData;var seen={};for(var i=0;i<records.length;i++){var record=records[i];var data;if(record.tuple)
data=record.tuple;else if(record.record)
data=record.record.getData();console.log("data:"+data);var value=groupField.getValue(record);if(!seen[value]){seen[value]=true;this.groupData.push(value);}}}
console.log(this.groupData);return this.groupData;},getGroupField:function(){return this.groupField;},isGroup:function(){return this.getGroupField()!=null;},loadData:function(display,reload){let root=this.getRootPointData();if(root.url==null){console.log("No URL");return;}
let props={lat:this.lat,lon:this.lon,};let jsonUrl=display.displayManager.getJsonUrl(root.url,display,props);root.jsonUrl=jsonUrl;root.loadPointJson(jsonUrl,display,reload);},getCacheObject:function(){let cacheObject=pointDataCache[this.getUrl()];if(!cacheObject){let cacheUrl=this.getCacheUrl();if(cacheUrl)cacheObject=pointDataCache[cacheUrl];}
return cacheObject;},propagateEventDataChanged:function(source){let cacheObject=this.getCacheObject();if(cacheObject){let displays=cacheObject.displays;if(displays){displays.forEach(display=>{if(display==source)return;display.pointDataLoaded(this,this.url,true);});}}},loadPointJson:function(url,display,reload){let debug=displayDebug.loadPointJson;let debug2=false;let pointData=this;this.startLoading();let _this=this;if(debug){console.log("loadPointJson: "+display.type+" "+display.getId()+" url:"+url);}
let cacheId=this.getCacheUrl();let cacheObject=pointDataCache[cacheId];if(cacheObject==null){cacheObject={pointData:null,pending:[],displays:[],size:0,url:url,toString:function(){return"cache:"+(this.pointData==null?" no data ":" data:"+this.pointData.pdcnt+" "+this.pointData.getRecords().length)+" url:"+this.url;}};if(debug)
console.log("\tcreated cache object: "+cacheId);pointDataCache[cacheId]=cacheObject;}else{if(cacheObject.pending.indexOf(display)>=0){if(debug)
console.log("\tcache hit - display in pending list");return;}else{if(debug)
console.log("\tcache hit - display not in pending list");}}
if(cacheObject.displays.indexOf(display)<0){if(debug2)
console.log("adding to displays-1:"+display);cacheObject.displays.push(display);}
if(reload){cacheObject.pointData=null;cacheObject.pending=[];if(debug)
console.log("\treloading adding to pending:"+cacheObject.displays);cacheObject.displays.forEach(d=>{if(debug)
console.log("\tdisplay:"+d.type+" "+d.getId());cacheObject.pending.push(d);});}else{if(cacheObject.displays.indexOf(display)<0){if(debug2)
console.log("adding to displays-2:"+display);cacheObject.displays.push(display);}
if(cacheObject.pointData!=null){if(debug)
console.log("\tdata was in cache:"+cacheObject.pointData.getRecords().length+" url:"+url);display.pointDataLoaded(cacheObject.pointData,url,reload);return;}
cacheObject.pending.push(display);if(cacheObject.pending.length>1){if(debug)
console.log("\tWaiting on callback:"+cacheObject.pending.length+" "+url+" d:"+display);return;}}
let fail=function(jqxhr,textStatus,error){console.log("Point data load error:"+textStatus+" "+error);var err=textStatus;if(err){if(error)
err+=": "+error;}else{err=error;}
console.log("Point data load error:"+(err?err:""));cacheObject.pending.map(display=>{display.pointDataLoadFailed(err);});delete pointDataCache[url];pointData.stopLoading();}
let success=function(data){if(typeof data=="string"){try{data=JSON.parse(data);}catch(exc){console.log("Error:"+exc);if(data.length>1000)data=data.substring(0,999);console.log("data:"+data);display.displayError("Error loading data:"+exc+"<br>URL:"+url);return;}}
if(debug)console.log("pointDataLoaded");if(GuiUtils.isJsonError(data)){if(debug)
console.log("\tloadPointData failed");console.log("loadPointData failed:"+data);display.pointDataLoadFailed(data);return;}
if(data.errorcode=="nodata"||!data.fields){if(debug)
console.log("\tno data:"+url);let dummy=new PointData("",[],[]);let pending=cacheObject.pending;cacheObject.pending=[];pending.forEach(d=>{d.handleNoData(dummy);});return;}
if(debug)
console.log("\tmaking point data");let t1=new Date();var newData=makePointData(data,_this.derived,display,_this.url);let t2=new Date();if(debug)
Utils.displayTimes("makePointData",[t1,t2],true);if(debug)
console.log("\tdone making point data #records:"+newData.getRecords().length);pointData=cacheObject.pointData=newData;if(data.properties){display.applyRequestProperties(data.properties);}
let tmp=cacheObject.pending;if(debug){console.log("\tcalling pointDataLoaded on  "+tmp.length+" pending displays");if(cacheObject.displays)
console.log("\tcacheObject.displays:"+cacheObject.displays.length)}
cacheObject.pending=[];for(let i=0;i<tmp.length;i++){if(debug)
console.log("\tcalling pointDataLoaded:"+tmp[i]+" #:"+pointData.getRecords().length);tmp[i].pointDataLoaded(pointData,url,reload);}
if(cacheObject.pointData.records&&cacheObject.pointData.records.length){cacheObject.size=cacheObject.pointData.records.length*cacheObject.pointData.records[0].getData().length;}
let size=0;Object.keys(pointDataCache).map(key=>{size+=pointDataCache[key].size;});if(debug)
console.log("\tcache size:"+size);if(size>1000000){Object.keys(pointDataCache).map(key=>{if(pointDataCache[key].pending.length==0){if(debug)
console.log("\tDeleting from cache:"+key);delete pointDataCache[key];}});}
pointData.stopLoading();}
let fullUrl=url;if(!fullUrl.startsWith("http")){var base=window.location.protocol+"//"+window.location.host;fullUrl=base+fullUrl;}
if(!url.startsWith("/")&&!url.startsWith("http")){let root=String(window.location).replace(/\/[^\/]+$/,"");url=root+"/"+url;}
console.log(display.type+" load point data:"+url);Utils.doFetch(url,success,fail,null);}});this.setGroupField();}
function DerivedPointData(displayManager,name,pointDataList,operation){RamaddaUtil.inherit(this,new BasePointData(name));RamaddaUtil.defineMembers(this,{displayManager:displayManager,operation:operation,pointDataList:pointDataList,loadDataCalls:0,display:null,pointDataLoaded:function(pointData){this.loadDataCalls--;if(this.loadDataCalls<=0){this.initData();}},equals:function(that){if(that.pointDataList==null)return false;if(this.pointDataList.length!=that.pointDataList.length)return false;for(var i in this.pointDataList){if(!this.pointDataList[i].equals(that.pointDataList[i])){return false;}}
return true;},initData:function(){var pointData1=this.pointDataList[0];if(this.pointDataList.length==1){this.records=pointData1.getRecords();this.recordFields=pointData1.getRecordFields();console.log("initData:"+this.recordFields.length);}else if(this.pointDataList.length>1){var results=this.combineData(pointData1,this.pointDataList[1]);this.records=results.records;this.recordFields=results.recordFields;console.log("initData 2:"+this.recordFields.length);}
this.setGroupField();this.display.pointDataLoaded(this);},combineData:function(pointData1,pointData2){var records1=pointData1.getRecords();var records2=pointData2.getRecords();var newRecords=[];var newRecordFields;if(records1.length!=records2.length){console.log("bad records:"+records1.length+" "+records2.length);}
if(this.operation=="average"){for(var recordIdx=0;recordIdx<records1.length;recordIdx++){var record1=records1[recordIdx];var record2=records2[recordIdx];if(record1.getDate()!=record2.getDate()){console.log("Bad record date:"+record1.getDate()+" "+record2.getDate());break;}
var newRecord=$.extend(true,{},record1);var data1=newRecord.getData();var data2=record2.getData();for(var colIdx=0;colIdx<data1.length;colIdx++){data1[colIdx]=(data1[colIdx]+data2[colIdx])/2;}
newRecords.push(newRecord);}
newRecordFields=pointData1.getRecordFields();}else if(this.operation=="other func"){}
if(newRecordFields==null){newRecords=records1;newRecordFields=pointData1.getRecordFields();}
return{records:newRecords,recordFields:newRecordFields};},loadData:function(display){this.display=display;this.loadDataCalls=0;for(var i in this.pointDataList){var pointData=this.pointDataList[i];if(!pointData.hasData()){this.loadDataCalls++;pointData.loadData(this);}
if(this.loadDataCalls==0){this.initData();}}
}});}
function RecordField(props,source){$.extend(this,{isDate:props.type=="date",isLatitude:false,isLongitude:false,isElevation:false,forDisplay:true});$.extend(this,props);$.extend(this,{isGroup:props.group,properties:props});if(source&&source.getProperty){["type","label","unit"].forEach(t=>{let ext=source.getProperty(props.id+"."+t);if(ext)this[t]=ext;});}
RamaddaUtil.defineMembers(this,{clone:function(){var newField={};$.extend(newField,this);return newField;},toString:function(){if(this.group)
return this.getId();return this.getId();},getForDisplay:function(){return this.forDisplay;},getIndex:function(){return this.index;},getValue:function(record,dflt){let v;if(record.getValue)
v=record.getValue(this.index);else
v=record[this.index];if(!v&&!Utils.isDefined(v))return dflt;return v;},getGroup:function(){return this.group;},getEnumeratedValues:function(row){return this.enumeratedValues;},isFieldGroup:function(){return this.isGroup;},isRecordDate:function(){return this.getId()=="recordDate";},isFieldGeo:function(){return this.isFieldLatitude()||this.isFieldLongitude()||this.isFieldElevation();},isFieldLatitude:function(){return this.isLatitude||this.id.toLowerCase()=="latitude";},isFieldLongitude:function(){return this.isLongitude||this.id.toLowerCase()=="longitude";},isFieldElevation:function(){return this.isElevation||this.id.toLowerCase()=="elevation"||this.id.toLowerCase()=="altitude";},isFieldNumeric:function(){return this.isNumeric();},isFieldString:function(){return this.type=="string"||this.type=="enumeration"||this.type=="multienumeration";},isFieldEnumeration:function(){return this.type=="enumeration"||this.type=="multienumeration";},isFieldMultiEnumeration:function(){return this.type=="multienumeration";},isFieldDate:function(){return this.isDate;},isChartable:function(){return this.chartable;},getSortOrder:function(){return this.sortorder;},getId:function(){return this.id;},getTypeLabel:function(){var type="fa-font";if(this.isFieldGeo()){type="fa-globe";}else if(this.isFieldNumeric()){type="fa-hashtag";}else if(this.isFieldEnumeration()){type="fa-list";}
var tt=this.getType();return HtmlUtils.span(["title",tt,"class","fa "+type,"style","color:rgb(169, 169, 169);font-size:12pt;"]);},getUnitLabel:function(){return this.getLabel()+this.getUnitSuffix();},getUnitSuffix:function(){if(this.unit&&this.unit!="")
return"&nbsp;["+this.unit+"]";return"";},getLabel:function(){if(this.label==null||this.label.length==0)return this.id;return this.label;},setLabel:function(l){this.label=l;},canEdit:function(){return this.canedit==true;},isNumeric:function(){return this.type=="double"||this.type=="integer";},isString:function(){return this.type=="string"||this.isFieldEnumeration()||this.type=="url"||this.type=="image";},getType:function(){return this.type;},setType:function(t){this.type=t;},getMissing:function(){return this.missing;},setUnit:function(u){this.unit=u;},getUnit:function(){return this.unit;}});}
function PointRecord(fields,lat,lon,elevation,time,data,rowIdx){this.isPointRecord=true;$.extend(this,{rowIndex:rowIdx,fields:fields,latitude:lat,longitude:lon,elevation:elevation,recordTime:time,data:data,id:HtmlUtils.getUniqueId(),});if(!time&&data){data.every(d=>{if(d&&d.getTime){this.recordTime=d;return false;}
return true;});}}
PointRecord.prototype={clone:function(){var newRecord={};$.extend(newRecord,this);newRecord.data=[];this.data.map((v,idx)=>{newRecord.data[idx]=v;});return newRecord;},isHighlight:function(display){if(!this.highlightForDisplay)this.highlightForDisplay={};return this.highlightForDisplay[display];},getDisplayProperty:function(display,prop,dflt){if(!this.displayProperties)this.displayProperties={};let props=this.displayProperties[display];if(!props){props=this.displayProperties[display]={};}
return props[prop]||dflt;},setDisplayProperty:function(display,prop,value){if(!this.displayProperties)this.displayProperties={};let props=this.displayProperties[display];if(!props){props=this.displayProperties[display]={};}
props[prop]=value;},setHighlight:function(display,value){if(!this.highlightForDisplay)this.highlightForDisplay={};if(!value||this.highlightForDisplay[display]==null){this.highlightForDisplay[display]=value;}},clearHighlight:function(display){if(!this.highlightForDisplay)this.highlightForDisplay={};delete this.highlightForDisplay[display];},toString:function(){return"data:"+this.data;},getId:function(){return this.id;},getData:function(){return this.data;},setData:function(d){this.data=d;},getValueFromField:function(id){let value=null;this.fields.every(field=>{if(field.getId()==id){value=this.getValue(field.getIndex());return false;}
return true;});return value;},allZeros:function(){var tuple=this.getData();var allZeros=false;var nums=0;var nonZero=0;for(var j=0;j<tuple.length;j++){if(typeof tuple[j]=="number"){nums++;if(!isNaN(tuple[j])&&tuple[j]!=0){nonZero++;break;}}}
if(nums>0&&nonZero==0){return true;}
return false;},getValue:function(index){return this.data[index];},setValue:function(index,value){this.data[index]=value;},push:function(v){this.data.push(v);},hasDate:function(){return this.getDate()!=null;},hasLocation:function(){return this.latitude!=null&&!isNaN(this.latitude);},hasElevation:function(){return this.elevation!=null&&!isNaN(this.elevation);},setLocation:function(lat,lon){this.latitude=lat;this.longitude=lon;},getLatitude:function(){return this.latitude;},getLongitude:function(){return this.longitude;},getTime:function(){return this.recordTime;},getElevation:function(){return this.elevation;},getDate:function(){return this.recordTime;}};function makePointData(json,derived,source,url){let debug=false;if(debug)console.log("makePointData");var fields=[];var latitudeIdx=-1;var longitudeIdx=-1;var elevationIdx=-1;var dateIdx=-1;var dateIndexes=[];var offsetFields=[];var lastField=null;for(var i=0;i<json.fields.length;i++){var field=json.fields[i];var recordField=new RecordField(field,source);if(recordField.isFieldNumeric()){if(source.getProperty){var offset1=source.getProperty(recordField.getId()+".offset1",source.getProperty("offset1"));var offset2=source.getProperty(recordField.getId()+".offset2",source.getProperty("offset2"));var scale=source.getProperty(recordField.getId()+".scale",source.getProperty("scale"));if(offset1||offset2||scale){var unit=source.getProperty(recordField.getId()+".unit",source.getProperty("unit"));if(unit){recordField.unit=unit;}
var o={offset1:0,offset2:0,scale:1};if(offset1)o.offset1=parseFloat(offset1);if(offset2)o.offset2=parseFloat(offset2);if(scale)o.scale=parseFloat(scale);recordField.offset=o;offsetFields.push(recordField);}}}
lastField=recordField;fields.push(recordField);if(recordField.isFieldLatitude()){latitudeIdx=recordField.getIndex();}else if(recordField.isFieldLongitude()){longitudeIdx=recordField.getIndex();}else if(recordField.isFieldElevation()){elevationIdx=recordField.getIndex();}else if(recordField.isFieldDate()){dateIdx=recordField.getIndex();dateIndexes.push(dateIdx);}}
if(derived){var index=lastField.getIndex()+1;for(var dIdx=0;dIdx<derived.length;dIdx++){var d=derived[dIdx];var label=d.label||d.name;var recordField=new RecordField({type:"double",index:(index+dIdx),chartable:true,id:d.name,label:label,});recordField.derived=d;fields.push(recordField);}}
let pointRecords=[];let isArray=false;let hasGeo=false;let hasDate=false;let setDateFlags=false;let dateIsString=false;json.data.forEach((tuple,rowIndex)=>{if(debug&&rowIndex>0&&(rowIndex%10000)==0)console.log("\tprocessed:"+i);if(rowIndex==0){isArray=Array.isArray(tuple);hasDate=!(typeof tuple.date==='undefined');}
let values;if(isArray)
values=tuple;else
values=tuple.values;let date=null;if(isArray||!hasDate){if(dateIdx>=0){if(!setDateFlags){dateIsString=(typeof values[dateIdx]=="string");setDateFlags=true;}
if(dateIsString){date=new Date(values[dateIdx]);}else{date=new Date(0);date.setUTCMilliseconds(values[dateIdx]);}}}else{if(tuple.date!=null&&tuple.date!=0){date=new Date(0);date.setUTCMilliseconds(tuple.date);}}
if(isArray||(typeof tuple.latitude==='undefined')){if(latitudeIdx>=0)
tuple.latitude=values[latitudeIdx];else
tuple.latitude=NaN;}
if(isArray||(typeof tuple.longitude==='undefined')){if(longitudeIdx>=0)
tuple.longitude=values[longitudeIdx];else
tuple.longitude=NaN;}
for(var j=0;j<dateIndexes.length;j++){values[dateIndexes[j]]=new Date(values[dateIndexes[j]]);}
for(var col=0;col<values.length;col++){if(values[col]==null){values[col]=NaN;}}
if(derived){for(var dIdx=0;dIdx<derived.length;dIdx++){var d=derived[dIdx];if(!d.isRow){continue;}
if(!d.compiledFunction){var funcParams=[];var params=(d.columns.indexOf(";")>=0?d.columns.split(";"):d.columns.split(","));d.fieldsToUse=[];for(var i=0;i<params.length;i++){var param=params[i].trim();funcParams.push("v"+(i+1));var theField=null;for(var fIdx=0;fIdx<fields.length;fIdx++){var f=fields[fIdx];if(f.getId()==param){theField=f;break;}}
d.fieldsToUse.push(theField);}
var code="";for(var i=0;i<funcParams.length;i++){code+="var v"+(i+1)+"=args["+i+"];\n";}
let tmpFunc=d["function"];if(tmpFunc.indexOf("return")<0)tmpFunc="return "+tmpFunc;code+=tmpFunc+"\n";d.compiledFunction=new Function("args",code);}
var args=[];var anyNotNan=false;for(var fIdx=0;fIdx<d.fieldsToUse.length;fIdx++){var f=d.fieldsToUse[fIdx];var v=NaN;if(f!=null){v=values[f.getIndex()];if(v==null)v=NaN;}
if(!isNaN(v)){anyNotNan=true;}else{}
args.push(v);}
try{var result=NaN;if(anyNotNan){result=d.compiledFunction(args);if(d.decimals>=0){result=result.toFixed(d.decimals);}
result=parseFloat(result);}else{}
values.push(result);}catch(e){console.log("Error evaluating function:"+d["function"]+"\n"+e);values.push(NaN);}}}
for(var fieldIdx=0;fieldIdx<offsetFields.length;fieldIdx++){var field=offsetFields[fieldIdx];var offset=field.offset;var value=values[field.getIndex()];value=(value+offset.offset1)*offset.scale+offset.offset2;values[field.getIndex()]=value;}
var record=new PointRecord(fields,tuple.latitude,tuple.longitude,tuple.elevation,date,values,rowIndex);pointRecords.push(record);});if(source!=null){for(var i=0;i<fields.length;i++){var field=fields[i];var prefix="field."+field.getId()+".";if(Utils.isDefined(source[prefix+"unit"])){field.setUnit(source[prefix+"unit"]);}
if(Utils.isDefined(source[prefix+"label"])){field.setLabel(source[prefix+"label"]);}
if(Utils.isDefined(source[prefix+"scale"])||Utils.isDefined(source[prefix+"offset1"])||Utils.isDefined(source[prefix+"offset2"])){var offset1=Utils.isDefined(source[prefix+"offset1"])?parseFloat(source[prefix+"offset1"]):0;var offset2=Utils.isDefined(source[prefix+"offset2"])?parseFloat(source[prefix+"offset2"]):0;var scale=Utils.isDefined(source[prefix+"scale"])?parseFloat(source[prefix+"scale"]):1;var index=field.getIndex();for(var rowIdx=0;rowIdx<pointRecords.length;rowIdx++){var record=pointRecords[rowIdx];var values=record.getData();var value=values[index];values[index]=(value+offset1)*scale+offset2;}}}}
var name=json.name;if((typeof name==='undefined')){name="Point Data";}
pointRecords.sort(function(a,b){if(a.getDate()&&b.getDate()){if(a.getDate().getTime()<b.getDate().getTime())return-1;if(a.getDate().getTime()>b.getDate().getTime())return 1;return 0;}});let pd=new PointData(name,fields,pointRecords,url);return pd;}
function BaseFilter(display,properties){this.display=display;if(properties==null)properties={};RamaddaUtil.defineMembers(this,{properties:properties,isEnabled:function(){return true;},prepareToFilter:function(){},isRecordOk:function(display,record,values){return true;},getWidget:function(){return""},initWidget:function(inputFunc){}});}
function BoundsFilter(display,properties){RamaddaUtil.inherit(this,new BaseFilter(display,properties));$.extend(this,{enabled:true,getWidget:function(){let id=this.display.getDomId("boundsfilter");return HtmlUtils.span([STYLE,HU.css("margin-left","4px","margin-right","4px"),ID,id,CLASS,"ramadda-clickable",TITLE,"Filter records on map view. Shift-click to clear"],HtmlUtils.getIconImage("fas fa-globe-americas"));},initWidget:function(inputFunc){this.inputFunc=inputFunc;let id=this.display.getDomId("boundsfilter");let _this=this;this.display.jq("boundsfilter").click(function(event){if(event.shiftKey){if(!_this.bounds)return;_this.bounds=null;}else{_this.bounds=_this.display.getBounds();}
inputFunc($(this),null,_this.bounds);});},isRecordOk:function(record){if(!this.bounds){return true;}
if(record.hasLocation()){var b=this.bounds;var lat=record.getLatitude();var lon=record.getLongitude();if(lat>b.top||lat<b.bottom||lon<b.left||lon>b.right)
return false;}
return true;},});}
function RecordFilter(display,filterFieldId,properties){const ID_TEXT="_text_";this.id=filterFieldId;this.isText=this.id==ID_TEXT;let fields;if(this.isText){fields=display.getFieldsByType(null,"string");}else{let filterField=display.getFieldById(null,filterFieldId);if(filterField)
fields=[filterField];else{console.log("Error: could not find filter field::"+filterFieldId);fields=[];}}
$.extend(this,new BaseFilter(display,properties));this.getId=function(){return this.id;}
let getAttr=(suffix,dflt)=>{let key=this.getId()+"."+suffix;let v=display.getProperty(key,dflt);return v;};let label="";if(this.isText){label=getAttr("filterLabel","Text");}else{label=getAttr("filterLabel",fields.length>0?fields[0].getLabel():"");}
$.extend(this,{fields:fields,values:[],hideFilterWidget:display.getProperty("hideFilterWidget",false,true),displayType:getAttr("filterDisplay","menu"),label:label,suffix:getAttr("filterSuffix",""),depends:getAttr("filterDepends",null),dateIds:[],prefix:display.getProperty(this.getId()+".filterPrefix"),suffix:display.getProperty(this.getId()+".filterSuffix"),startsWith:display.getProperty(this.getId()+".filterStartsWith",false),ops:Utils.split(display.getProperty(this.getId()+".filterOps"),";",true,true),labelField:display.getFieldById(null,display.getProperty(this.getId()+".labelField"))});if(this.ops){let tmp=[];this.ops.forEach(tok=>{let tuple=tok.split(",");tmp.push({op:tuple[0],value:tuple[1],label:tuple[2]||this.id+tuple[0]+tuple[1]});});this.ops=tmp;}
$.extend(this,{toString:function(){return"filter:"+this.getId();},getField:function(){return this.fields[0];},getFieldId:function(){return this.fields[0].getId();},getLabel:function(){return this.label;},getValue:function(record){if(this.fields.length==1){return record.getValue(this.fields[0].getIndex());}else{let v=this.fields.reduce((acc,field)=>{return acc+=" "+record.getValue(field.getIndex());},"");return v;}},isFieldNumeric:function(){return this.getField().isNumeric();},isFieldEnumeration:function(){return this.getField().isFieldEnumeration();},isFieldMultiEnumeration:function(){return this.getField().isFieldMultiEnumeration();},getFieldType:function(){return this.getField().getType();},getFilterId:function(id){return this.display.getDomId("filterby_"+(id||this.getId()));},isEnabled:function(){return this.isText||this.getField()!=null;},recordOk:function(display,record,values){return true;},getProperty:function(key,dflt){return this.display.getProperty(key,dflt);},getPropertyFromUrl:function(key,dflt){return this.display.getPropertyFromUrl(key,dflt);},prepareToFilter:function(){this.mySearch=null;if(this.depend){this.checkDependency();}
if(!this.isEnabled()){return;}
let value=null;let _values=[];let values=null;let matchers=[];if(this.ops){let v=$("#"+this.getFilterId(this.getId())).val();if(v==FILTER_ALL){this.mySearch=null;return;}
this.mySearch={index:parseFloat(v)};return;}else if(this.isFieldNumeric()){let minField=$("#"+this.display.getDomId("filterby_"+this.getId()+"_min"));let maxField=$("#"+this.display.getDomId("filterby_"+this.getId()+"_max"));if(!minField.val()||!maxField.val())return;let minValue=parseFloat(minField.val().trim());let maxValue=parseFloat(maxField.val().trim());let dfltMinValue=parseFloat(minField.attr("data-min"));let dfltMaxValue=parseFloat(maxField.attr("data-max"));if(minValue!=dfltMinValue||maxValue!=dfltMaxValue){value=[minValue,maxValue];}}else if(this.getFieldType()=="date"){let date1=$("#"+this.display.getDomId("filterby_"+this.getId()+"_date1")).val();let date2=$("#"+this.display.getDomId("filterby_"+this.getId()+"_date2")).val();if(date1!=null&&date1.trim()!="")
date1=Utils.parseDate(date1);else
date1=null;if(date2!=null&&date2.trim()!="")
date2=Utils.parseDate(date2);else
date2=null;if(date1!=null||date2!=null)
value=[date1,date2];}else{values=this.getFieldValues();if(!values)return;if(!Array.isArray(values))values=[values];if(values.length==0)return;values=values.map(v=>{return v.replace(/_comma_/g,",");});values.forEach(v=>{_values.push((""+v).toLowerCase());try{matchers.push(new TextMatcher(v));}catch(skipIt){}});}
let anyValues=value!=null;if(!anyValues&&values){values.forEach(v=>{if(v.length>0&&v!=FILTER_ALL)anyValues=true});}
if(anyValues){this.mySearch={value:value,values:values,matchers:matchers,_values:_values,anyValues:anyValues,};}else{this.mySearch=null;}
},isRecordOk:function(record,debug){let ok=true;if(!this.isEnabled()||!this.mySearch){if(debug){if(!this.isEnabled())
console.log("\tfilter  not enabled");if(!this.mySearch)
console.log("\tfilter  no mySearch");}
return ok;}
if(debug)console.log("\tfilter.isRecordOk:"+JSON.stringify(this.mySearch));let rowValue=this.getValue(record);if(this.ops){let op=this.ops[this.mySearch.index];if(op.op=="<")ok=rowValue<op.value;else if(op.op=="<=")ok=rowValue<=op.value;else if(op.op==">")ok=rowValue>op.value;else if(op.op==">=")ok=rowValue>=op.value;else if(op.op=="==")ok=rowValue==op.value;}else if(this.isFieldEnumeration()){rowValue=String(rowValue);if(this.isFieldMultiEnumeration()){ok=false;let values=rowValue.split(",");values.forEach(value=>{value=value.trim();if(this.mySearch.values.includes(value))ok=true;});}else{ok=this.mySearch.values.includes(rowValue);}}else if(this.isFieldNumeric()){if(isNaN(this.mySearch.value[0])&&isNaN(this.mySearch.value[1]))return ok;if(isNaN(rowValue)||rowValue=="")ok=false;else if(!isNaN(this.mySearch.value[0])&&rowValue<this.mySearch.value[0])ok=false;else if(!isNaN(this.mySearch.value[1])&&rowValue>this.mySearch.value[1])ok=false;}else if(this.getFieldType()=="date"){if(this.mySearch.value&&Array.isArray(this.mySearch.value)){if(rowValue==null){ok=false;}else{let date1=this.mySearch.value[0];let date2=this.mySearch.value[1];let dttm=rowValue.getTime();if(isNaN(dttm))ok=false;else if(date1&&dttm<date1.getTime())
ok=false;else if(date2&&dttm>date2.getTime())
ok=false;}}}else{let startsWith=this.startsWith;ok=false;rowValue=String(rowValue).toLowerCase();for(let j=0;j<this.mySearch._values.length;j++){let fv=this.mySearch._values[j];if(startsWith){if(rowValue.toString().startsWith(fv)){ok=true;break;}}else if(rowValue.toString().indexOf(fv)>=0){ok=true;break;}}
if(!ok&&!startsWith){for(ri=0;ri<this.mySearch.matchers.length;ri++){let matcher=this.mySearch.matchers[ri];if(matcher.matches(rowValue.toString())){ok=true;break;}}}}
return ok;},doTags:function(){if(!this.getProperty(this.getId()+".showFilterTags",true))return false;let tags=this.getProperty(this.getId()+".showFilterTags")||this.getProperty("showFilterTags");return tags;},doTagsColor:function(){if(!this.getProperty(this.getId()+".colorFilterTags",true))return false;let tags=this.getProperty(this.getId()+".colorFilterTags",true)||this.getProperty("colorFilterTags");return tags;},getFieldValues:function(){if(this.isFieldEnumeration()){if(this.doTags()){return this.selectedTags||[];}}
let element=$("#"+this.display.getDomId("filterby_"+this.getId()));let value=null;if(element.attr("isCheckbox")){if(element.is(':checked')){value=element.attr("onValue");}else{value=element.attr("offValue");}}else if(element.attr("isButton")){value=element.attr("data-value");}else{value=element.val();}
if(!value){if(this.defaultValue)value=this.defaultValue;else value=FILTER_ALL;}
if(!Array.isArray(value)){if(!this.isFieldEnumeration()){value=value.split(",");}else{value=[value];}}
let tmp=[];value.forEach(v=>tmp.push(v.trim()));value=tmp;return value;},toggleTag:function(value,on,cbx,propagateEvent){let _this=this;let type=this.getFilterId();let tagId=Utils.makeId(type+"_"+value);if(on){if(this.selectedTags.includes(value))return;this.selectedTags=Utils.addUnique(this.selectedTags,value);let tagGroup=this.display.jq(ID_TAGBAR).find(".tag-group"+HU.attrSelect("tag-type",this.getFilterId()));if(tagGroup.length==0){let bar;if(this.display.getProperty("tagDiv"))
bar=$("#"+this.display.getProperty("tagDiv"));else
bar=this.display.jq(ID_TAGBAR);tagGroup=$(HU.div([STYLE,HU.css("display","inline-block"),CLASS,"tag-group","tag-type",this.getFilterId()])).appendTo(bar);}
let tag=$(HU.div(["metadata-type",type,"metadata-value",value,TITLE,value,STYLE,HU.css("background",Utils.getEnumColor(this.getFieldId())),CLASS,"display-search-tag",ID,tagId],value+SPACE+HU.getIconImage("fas fa-times"))).appendTo(tagGroup);tag.click(function(){_this.selectedTags=Utils.removeElement(_this.selectedTags,value);if(cbx)
cbx.prop('checked',false);$(this).remove();_this.inputFunc(_this.fakeInput,null,_this.selectedTags);});}else{this.selectedTags=Utils.removeElement(this.selectedTags,value);$("#"+tagId).remove();}
if(propagateEvent&&this.inputFunc){this.inputFunc(this.fakeInput,null,this.selectedTags);}},initWidget:function(inputFunc){if(!this.isEnabled())return;this.inputFunc=inputFunc;this.fakeInput={attr:function(key){return this[key];},val:function(){return null},id:this.getId(),fieldId:this.getFieldId()};this.initDateWidget(inputFunc);if(this.tagCbxs){let _this=this;let cbxChange=function(){let cbx=$(this);let on=cbx.is(':checked');let value=$(this).attr("metadata-value");_this.toggleTag(value,on,cbx,true);}
let clickId=this.getFilterId()+"_popup";$("#"+clickId).click(()=>{let dialog=this.display.createTagDialog(this.tagCbxs,$("#"+clickId),cbxChange,this.getFilterId(),this.getLabel());dialog.find(".metadata-cbx").each(function(){let value=$(this).attr('metadata-value');$(this).prop('checked',_this.selectedTags.includes(value));});});}},initDateWidget:function(inputFunc){if(!this.hideFilterWidget){for(let i=0;i<this.dateIds.length;i++){let id=this.dateIds[i];HtmlUtils.datePickerInit(id);$("#"+id).change(function(){inputFunc($(this));});}}},checkDependency:function(){if(!this.depend||!this.records||!this.dependMySearch||!this.depend.mySearch||!this.dependMySearch.values||!this.depend.mySearch.values){console.log("no depend:"+this.depend+" "+(this.records!=null)+" "+this.dependMySearch);return;}
let v1=this.dependMySearch.values;let v2=this.depend.mySearch.values;if(v1.length==v2.length){let equals=true;for(let i=0;i<v1.length&&equals;i++)
equals=v1[i]==v2[i];if(equals)return;}
let enums=this.getEnums(this.records);let widgetId=this.getFilterId(this.getId());let tmp=[];enums.map(e=>tmp.push(e.value));this.display.ignoreFilterChange=true;let widget=$("#"+widgetId);let val=widget.val();if(!val)val=widget.attr("data-value");widget.html(HU.makeOptions(tmp,val));this.display.ignoreFilterChange=false;},handleEventPropertyChanged:function(prop){if(this.isFieldEnumeration()&&this.doTags()){if(this.selectedTags){let type=this.getFilterId();this.selectedTags.forEach(value=>{let tagId=Utils.makeId(type+"_"+value);$("#"+tagId).remove();});}
this.selectedTags=[];prop.value.forEach(value=>{this.toggleTag(value,true);});return;}
let id=this.widgetId;if(prop.id&&prop.id.endsWith("date1")){id+="_date1";}else if(prop.id&&prop.id.endsWith("date2")){id+="_date2";}
let widget=$("#"+id);if(widget.attr("isCheckbox")){let on=widget.attr("onValue");widget.prop('checked',prop.value.includes(on));}else{widget.val(prop.value);}
widget.attr("data-value",prop.value);if(widget.attr("isButton")){widget.find(".display-filter-button").removeClass("display-filter-button-selected");widget.find("[value='"+prop.value+"']").addClass("display-filter-button-selected");}},getWidget:function(fieldMap,bottom,records,vertical){this.records=records;let debug=false;if(debug)console.log(this.id+".getWidget");if(!this.isEnabled()){if(debug)console.log("\tnot enabled");return"";}
let widgetStyle="";if(this.hideFilterWidget)
widgetStyle="display:none;";fieldMap[this.getId()]={field:this.fields[0],values:[],};let showLabel=true;let widget;let widgetId=this.widgetId=this.getFilterId(this.getId());let widgetLabel=this.getProperty(this.getId()+".filterLabel",this.getLabel());let suffix=this.getProperty(this.getId()+".filterSuffix","");if(this.ops){let labels=[];this.ops.forEach((op,idx)=>{labels.push([String(idx),op.label]);});let selected=this.getPropertyFromUrl(this.getId()+".filterValue",FILTER_ALL);let showLabel=this.getProperty(this.getId()+".showFilterLabel",this.getProperty("showFilterLabel",true));let allName=this.getProperty(this.getId()+".allName",!showLabel?this.getLabel():"All");let enums=Utils.mergeLists([[FILTER_ALL,allName]],labels);let attrs=[STYLE,widgetStyle,ID,widgetId,"fieldId",this.getId()];widget=HU.select("",attrs,enums,selected);}else if(this.isFieldEnumeration()){if(debug)console.log("\tis enumeration");let dfltValue=this.defaultValue=this.getPropertyFromUrl(this.getId()+".filterValue",FILTER_ALL);let enums=this.getEnums(records);let attrs=["style",widgetStyle,"id",widgetId,"fieldId",this.getId()];if(this.getProperty(this.getId()+".filterMultiple",false)){attrs.push("multiple");attrs.push("");attrs.push("size");attrs.push(this.getProperty(this.getId()+".filterMultipleSize","3"));dfltValue=dfltValue.split(",");}
if(this.displayType!="menu"){if(debug)console.log("\tnot menu");let includeAll=this.getProperty(this.getId()+".includeAll",this.getProperty("filter.includeAll",true));if(!includeAll&&dfltValue==FILTER_ALL)dfltValue=enums[0].value;let buttons="";let colorMap=Utils.parseMap(this.getProperty(this.getId()+".filterColorByMap"));let useImage=this.displayType=="image";let imageAttrs=[];let imageMap=Utils.getNameValue(this.getProperty(this.getId()+".filterImages"));if(useImage){let w=this.getProperty(this.getId()+".filterImageWidth");let h=this.getProperty(this.getId()+".filterImageHeight");if(h){imageAttrs.push("height");imageAttrs.push(h);}
if(w){imageAttrs.push("width");imageAttrs.push(w);}
if(!h&&!w){imageAttrs.push("width");imageAttrs.push("50");}
imageAttrs.push("style");imageAttrs.push(this.getProperty(this.getId()+".filterImageStyle","border-radius:50%;"));}
for(let j=0;j<enums.length;j++){let extra="";let v=enums[j].value;let color=colorMap?colorMap[v]:null;let label;if(Array.isArray(v)){label=v[1];v=v[0];}else{label=v;}
let style=this.getProperty(this.getId()+".filterItemStyle","");if(color){style+=" background-color:"+color+"; ";}
let clazz=" display-filter-item display-filter-item-"+this.displayType+" ";if(v==dfltValue){clazz+=" display-filter-item-"+this.displayType+"-selected ";}
if(v==FILTER_ALL){extra=" display-filter-item-all ";}
if(useImage){let image=null;if(imageMap)image=imageMap[v];if(!image||image=="")image=enums[j].image;if(image){buttons+=HtmlUtils.div(["fieldId",this.getId(),"class",clazz,"style",style,"data-value",v,"title",label],HtmlUtils.image(image,imageAttrs));}else{buttons+=HtmlUtils.div(["fieldId",this.getId(),"class",clazz,"style",style,"data-value",v,"title",label],label);}}else{buttons+=HtmlUtils.div(["fieldId",this.getId(),"class",clazz,"style",style,"data-value",v],label);}
buttons+="\n";}
if(useImage&&this.getProperty(this.getId()+".filterShowButtonsLabel")){buttons+=HtmlUtils.div(["class","display-filter-item-label","id",this.display.getDomId("filterby_"+this.getId()+"_label")],"&nbsp;");}
bottom[0]+=HtmlUtils.div(["data-value",dfltValue,"class","display-filter-items","id",widgetId,"isButton","true","fieldId",this.getId()],buttons);if(debug)console.log("\treturn 1");return"";}else if(this.getProperty(this.getId()+".filterCheckbox")){if(debug)console.log("\tis checkbox");attrs.push("isCheckbox");attrs.push(true);let tmp=[];enums.map(e=>tmp.push(e.value));let checked=tmp.includes(dfltValue);if(tmp.length>0){attrs.push("onValue");attrs.push(tmp[0]);}
if(tmp.length>1){attrs.push("offValue");attrs.push(tmp[1]);}
widget=HtmlUtils.checkbox("",attrs,checked);}else if(this.doTags()){let doColor=this.doTagsColor();showLabel=false;let cbxs=[];this.tagToCbx={};this.selectedTags=[];enums.map((e,idx)=>{let count=e.count;let value=e.value;let label=value;if(Array.isArray(value)){value=e.value[0];label=e.value[1];if(value==="")
label="-blank-";}
let showCount=true;if(count)label=label+(showCount?" ("+count+")":"");let cbxId=this.getFilterId()+"_cbx_"+idx;this.tagToCbx[value]=cbxId;let cbx=HU.checkbox("",[CLASS,"metadata-cbx",ID,cbxId,"metadata-type",this.getFilterId(),"metadata-value",value],false)+" "+HU.tag("label",[CLASS,"ramadda-noselect ramadda-clickable","for",cbxId],label);cbx=HU.span([CLASS,'display-search-tag','tag',label,STYLE,HU.css("background",Utils.getEnumColor(this.getFieldId()))],cbx);cbxs.push(cbx);});this.tagCbxs=cbxs;let clickId=this.getFilterId()+"_popup";let label=" "+this.getLabel()+" ("+cbxs.length+")";label=label.replace(/ /g,"&nbsp;");let style=HU.css("white-space","nowrap","line-height","1.5em","margin-top","6px","padding-right","5px");if(doColor)
style+=HU.css("border","1px solid #ccc","background",Utils.getEnumColor(this.getFieldId()));else
style+=HU.css();widget=HU.div([STYLE,style,TITLE,"Click to select tag",ID,clickId,CLASS,"ramadda-clickable entry-toggleblock-label"],HU.makeToggleImage("fas fa-plus","font-size:8pt;")+label);}else{if(debug)console.log("\tis select");let tmp=[];let showCount=this.getProperty(this.getId()+".filterShowCount",this.getProperty("filterShowCount",true));enums.map(e=>{let count=e.count;let v=e.value;let label=v;if(Array.isArray(v)){v=e.value[0];label=e.value[1];if(v==="")
label="-blank-";}
if(count)label=label+(showCount?" ("+count+")":"");tmp.push([v,label]);});widget=HtmlUtils.select("",attrs,tmp,dfltValue);}}else if(this.isFieldNumeric()){if(debug)console.log("\tis numeric");let min=0;let max=0;let cnt=0;records.map(record=>{let value=this.getValue(record);if(isNaN(value))return;if(cnt==0){min=value;max=value;}
else{min=Math.min(min,value);max=Math.max(max,value);}
cnt++;});let tmpMin=this.getPropertyFromUrl(this.getId()+".filterValueMin",this.getProperty("filterValueMin"));let tmpMax=this.getPropertyFromUrl(this.getId()+".filterValueMax",this.getProperty("filterValueMax"));let minStyle="";let maxStyle="";let dfltValueMin=min;let dfltValueMax=max;if(Utils.isDefined(tmpMin)){minStyle="background:"+TEXT_HIGHLIGHT_COLOR+";";dfltValueMin=parseFloat(tmpMin);}
if(Utils.isDefined(tmpMax)){maxStyle="background:"+TEXT_HIGHLIGHT_COLOR+";";dfltValueMax=parseFloat(tmpMax);}
widget=HtmlUtils.input("",dfltValueMin,[STYLE,minStyle,"data-min",min,"class","display-filter-range display-filter-input","style",widgetStyle,"id",widgetId+"_min","size",3,"fieldId",this.getId()]);widget+="-";widget+=HtmlUtils.input("",dfltValueMax,[STYLE,maxStyle,"data-max",max,"class","display-filter-range display-filter-input","style",widgetStyle,"id",widgetId+"_max","size",3,"fieldId",this.getId()]);}else if(this.getFieldType()=="date"){widget=HtmlUtils.datePicker("","",["class","display-filter-input","style",widgetStyle,"id",widgetId+"_date1","fieldId",this.getId()])+"-"+
HtmlUtils.datePicker("","",["class","display-filter-input","style",widgetStyle,"id",widgetId+"_date2","fieldId",this.getId()]);this.dateIds.push(widgetId+"_date1");this.dateIds.push(widgetId+"_date2");}else{let dfltValue=this.getPropertyFromUrl(this.getId()+".filterValue","");let width=this.getProperty(this.getId()+".filterWidth","150px");let attrs=[STYLE,widgetStyle+"width:"+HU.getDimension(width),"id",widgetId,"fieldId",this.getId(),"class","display-filter-input"];let placeholder=this.getProperty(this.getId()+".filterPlaceholder");attrs.push("width");attrs.push(width);if(placeholder){attrs.push("placeholder");attrs.push(placeholder);}else{showLabel=false;attrs.push("placeholder");attrs.push(widgetLabel);}
widget=HtmlUtils.input("",dfltValue,attrs);let values=fieldMap[this.getId()].values;let seen={};records.map(record=>{let value=this.getValue(record);if(!seen[value]){seen[value]=true;values.push(value);}});}
if(!this.hideFilterWidget){let tt=widgetLabel;if(widgetLabel.length>50)widgetLabel=widgetLabel.substring(0,49)+"...";if(!this.getProperty(this.getId()+".showFilterLabel",this.getProperty("showFilterLabel",true))){widgetLabel="";}
else
widgetLabel=widgetLabel+": ";let labelVertical=vertical||this.getProperty(this.getId()+".filterLabelVertical",false)||this.getProperty("filterLabelVertical",false);widgetLabel=this.display.makeFilterLabel(widgetLabel,tt,labelVertical);if(labelVertical)widgetLabel=widgetLabel+"<br>";if(vertical){widget=HtmlUtils.div([],(showLabel?widgetLabel:"")+widget+suffix);}else{widget=HtmlUtils.div(["style","display:inline-block;"],(showLabel?widgetLabel:"")+widget+suffix);}}
if(!vertical)
widget=widget+(this.hideFilterWidget?"":"&nbsp;&nbsp;");return widget;},getEnums:function(records){let counts={};let isMulti=this.isFieldMultiEnumeration();records.forEach((record,idx)=>{let value=this.getValue(record);if(value===null)return;value=String(value);let values=isMulti?value.split(","):[value];values.forEach(v=>{v=v.trim();if(!counts[v])counts[v]=1;else counts[v]++;});});let enums=null;let filterValues=this.getProperty(this.getId()+".filterValues");let showLabel=this.getProperty(this.getId()+".showFilterLabel",this.getProperty("showFilterLabel",true));if(filterValues){let toks;if((typeof filterValues)=="string"){filterValues=Utils.getMacro(filterValues);toks=filterValues.split(",");}else{toks=filterValues;}
enums=[];toks.map(tok=>{let tmp=tok.split(":");if(tmp.length>1){tok=[tmp[0],tmp[1]];}else if(tok==FILTER_ALL){let allName=this.getProperty(this.getId()+".allName",!showLabel?this.getLabel():"All");tok=[tmp[0],allName];}else{tok=[tok,tok];}
let count=counts[tok[0]];enums.push({value:tok,count:count});})}
let includeAll=this.getProperty(this.getId()+".includeAll",this.getProperty("filter.includeAll",true));if(enums==null){let depend=this.getProperty(this.getId()+".depends");if(depend){depend=this.depend=this.display.getRecordFilter(depend);}
let allName=this.getProperty(this.getId()+".allName",!showLabel?this.getLabel():"All");enums=[];if(includeAll&&!this.getProperty(this.getId()+".filterLabel")){enums.push({value:[FILTER_ALL,allName]});}
let seen={};let dflt=this.getField().getEnumeratedValues();if(dflt){for(let v in dflt){seen[v]=true;let count=counts[v];enums.push({value:[v,dflt[v]],count:count});}}
let enumValues=[];let imageField=this.display.getFieldByType(null,"image");let valuesAreNumbers=true;if(depend){depend.prepareToFilter();this.dependMySearch=depend.mySearch;}
records.forEach((record,idx)=>{if(depend){if(!depend.isRecordOk(record,idx<5))return;}
let value=this.getValue(record);let values;if(isMulti){values=value.split(",").map(v=>{return v.trim();});}else{values=[value];}
values.forEach(value=>{if(seen[value])return;seen[value]=true;let obj={};if(imageField)
obj.image=this.display.getDataValues(record)[imageField.getIndex()];if((+value+"")!=value)valuesAreNumbers=false;let label=value;if(label.length>30){label=label.substring(0,29)+"...";}
if(this.labelField){label+=" - "+this.labelField.getValue(record);console.log("l:"+label);}
if(typeof value=="string")
value=value.replace(/\'/g,"&apos;");let tuple=[value,label];obj.value=tuple;obj.count=counts[value];enumValues.push(obj);});});if(this.getProperty(this.getId()+".filterSort",true)){let sortCount=this.getProperty(this.getId()+".filterSortCount",true);enumValues.sort((a,b)=>{if(sortCount&&a.count&&b.count){if(b.count!=a.count)
return b.count-a.count;}
a=a.value;b=b.value;if(valuesAreNumbers){return+a-+b;}
return(""+a[1]).localeCompare(""+b[1]);});}
for(let j=0;j<enumValues.length;j++){let v=enumValues[j];enums.push(v);}}
return enums;}});}
function MonthFilter(param){RamaddaUtil.inherit(this,new BaseFilter());RamaddaUtil.defineMembers(this,{months:param.split(","),recordOk:function(display,record,values){for(i in this.months){let month=this.months[i];let date=record.getDate();if(date==null)return false;if(date.getMonth==null){return false;}
if(date.getMonth()==month)return true;}
return false;}});}
var ArrayUtil={add:function(v1,v2){if(isNaN(v1)||isNaN(v2))return NaN;return v1+v2;},average:function(values){var sum=0;if(values.length==0)return 0;for(var i=0;i<values.length;i++){sum+=values[i];}
return sum/values.length;},percentIncrease:function(values){var percents=[];var sum=0;if(values.length==0)return 0;var lastValue;for(var i=0;i<values.length;i++){var v=values[i];var incr=NaN;if(i>0&&lastValue!=0){incr=(v-lastValue)/lastValue;}
lastValue=v;percents.push(incr*100);}
return percents;},movingAverage:function(values,props){if(!props){props={};}
if(!props.step)props.step=5;if(values.length==0)return values;var newValues=[];console.log("STEP:"+props.step);let tupleGetter=values[0].tuple?v=>{return v.tuple}:v=>{return v};let isNumeric=tupleGetter(values[0]).map((v,idx)=>{return Utils.isNumber(v);});dataList.forEach((o,rowIdx)=>{if(rowIdx==0)return;let tuple=Utils.mergeLists(o.tuple);tmp.push({record:o.record,tuple:tuple});tuple[0]="x";tuple[1]=5;tuple.forEach((v,colIdx)=>{if(!isNumeric[colIdx])return;tuple[colIdx]=5;});});dataList=tmp;for(var i=props.step;i<values.length;i++){var total=0;var cnt=0;for(var j=i-props.step;j<i;j++){if(values[j]==values[j]){total+=values[j];cnt++;}}
var value=(cnt>0?total/cnt:NaN);if(newValues.length==0){for(var extraIdx=0;extraIdx<props.step;extraIdx++){newValues.push(value);}}
newValues.push(value);}
console.log("MovingAverage: values:"+values.length+" new:"+newValues.length);return newValues;},expMovingAverage:function(values,props){if(!props){props={};}
if(!props.step)props.step=5;var sma=ArrayUtil.movingAverage(values,props);var mult=(2.0/(props.step+1));var newValues=[];console.log("STEP:"+props.step);for(var i=props.step;i<values.length;i++){var total=0;var cnt=0;for(var j=i-props.step;j<i;j++){if(values[j]==values[j]){total+=values[j];cnt++;}}
var value=(cnt>0?total/cnt:NaN);if(newValues.length==0){for(var extraIdx=0;extraIdx<props.step;extraIdx++){newValues.push(value);}}
newValues.push(value);}
console.log("MovingAverage: values:"+values.length+" new:"+newValues.length);return newValues;},max:function(values){var max=NaN;for(var i=0;i<values.length;i++){if(i==0||values[i]>max){max=values[i];}}
return max;},min:function(values){var min=NaN;for(var i=0;i<values.length;i++){if(i==0||values[i]<min){min=values[i];}}
return min;},}
var RecordUtil={groupBy:function(records,display,dateBin,field){let debug=displayDebug.groupBy;if(debug)console.log("groupBy");let groups={max:0,values:[],labels:[],map:{},}
records.forEach((r,idx)=>{let key;let label=null;let date=r.getDate();if(field){if(field=="latlon"){key=label=r.getLatitude()+"/"+r.getLongitude();}else{key=label=r.getValue(field.getIndex());}}else{if(!date){return;}
key=date;if(dateBin===true){}else{if(dateBin=="day"){key=new Date(label=date.getFullYear()+"-"+date.getUTCMonth()+"-"+date.getUTCDay())}else if(dateBin=="month"){label=date.getFullYear()+"-"+date.getUTCMonth();key=new Date(label+"-01");}else if(dateBin=="year"){label=date.getFullYear();key=new Date(date.getFullYear()+"-01-01");}else if(dateBin=="decade"){let year=date.getFullYear();year=year-year%10;label=year+"s";key=new Date(year+"-01-01");}else if(dateBin){label=String(key);}}}
let array=groups.map[key];if(!array){if(debug)console.log("\tadding group:"+key);array=groups.map[key]=[];groups.values.push(key);if(label==null)
label=display.formatDate(date,null,true);groups.labels.push(label);}
array.push(r);groups.max=Math.max(groups.max,array.length);});return groups;},expandBounds:function(bounds,perc){return new RamaddaBounds(Math.min(90,bounds.north+(bounds.north-bounds.south)*perc),Math.max(-180,bounds.west-(bounds.east-bounds.west)*perc),Math.max(-90,bounds.south-(bounds.north-bounds.south)*perc),Math.min(180,bounds.east+(bounds.east-bounds.west)*perc));},convertBounds:function(bounds){if(!bounds)return null;return new RamaddaBounds(bounds);},subset:function(records,bounds){bounds=RecordUtil.convertBounds(bounds);let cnt=0;records=records.filter((record,idx)=>{let lat=record.getLatitude?record.getLatitude():record.r?record.r.getLatitude():record.y;let lon=record.getLongitude?record.getLongitude():record.r?record.r.getLongitude():record.x;let ok=lat<=bounds.north&&lat>=bounds.south&&lon>=bounds.west&&lon<=bounds.east;return ok;});return records;},getRanges:function(fields,records){var maxValues=[];var minValues=[];for(var i=0;i<fields.length;i++){maxValues.push(NaN);minValues.push(NaN);}
for(var row=0;row<records.length;row++){for(var col=0;col<fields.length;col++){var value=records[row].getValue(col);if(isNaN(value))continue;maxValues[col]=(isNaN(maxValues[col])?value:Math.max(value,maxValues[col]));minValues[col]=(isNaN(minValues[col])?value:Math.min(value,minValues[col]));}}
var ranges=[];for(var col=0;col<fields.length;col++){ranges.push([minValues[col],maxValues[col]]);}
return ranges;},getElevationRange:function(fields,records){var maxValue=NaN;var minValue=NaN;for(var row=0;row<records.length;row++){if(records[row].hasElevation()){var value=records[row].getElevation();maxValue=(isNaN(maxValue)?value:Math.max(value,maxValue));minValue=(isNaN(minValue)?value:Math.min(value,minValue));}}
return[minValue,maxValue];},slice:function(records,index){var values=[];for(var rowIdx=0;rowIdx<records.length;rowIdx++){var row=records[rowIdx];if(row.getValue){values.push(row.getValue(index));}else{values.push(row[index]);}}
return values;},sort:function(fields){fields=fields.slice(0);fields.sort(function(a,b){var s1=a.getSortOrder();var s2=b.getSortOrder();return s1<s2;});return fields;},getPoints:function(records,bounds){let points=[];this.getBounds(records,bounds,points);return points;},getBounds:function(records,bounds,points){bounds=bounds||{};if(records==null){return bounds;}
var north=NaN,west=NaN,south=NaN,east=NaN;let errorCnt=0;for(j=0;j<records.length;j++){var record=records[j];if(!isNaN(record.getLatitude())&&!isNaN(record.getLongitude())){if(j==0){north=record.getLatitude();south=record.getLatitude();west=record.getLongitude();east=record.getLongitude();}else{north=Math.max(north,record.getLatitude());south=Math.min(south,record.getLatitude());west=Math.min(west,record.getLongitude());east=Math.max(east,record.getLongitude());}
if(record.getLongitude()<-180||record.getLatitude()>90){}
if(points)
points.push(new OpenLayers.Geometry.Point(record.getLongitude(),record.getLatitude()));}}
bounds.north=north;bounds.west=west;bounds.south=south;bounds.east=east;return new RamaddaBounds(bounds);},findClosest:function(records,lon,lat,indexObj){if(records==null)return null;var closestRecord=null;var minDistance=1000000000;var index=-1;for(j=0;j<records.length;j++){var record=records[j];if(isNaN(record.getLatitude())){continue;}
var distance=Math.sqrt((lon-record.getLongitude())*(lon-record.getLongitude())+(lat-record.getLatitude())*(lat-record.getLatitude()));if(distance<minDistance){minDistance=distance;closestRecord=record;index=j;}}
if(indexObj!=null){indexObj.index=index;}
return closestRecord;},clonePoints:function(points){var result=[];for(var i=0;i<points.length;i++){var point=points[i];result.push(new OpenLayers.Geometry.Point(point.x,point.y));}
return result;}};function CsvUtil(){let eg="convertData=\"derived(field=field_id, function=population*10);\nrotateData(includeFields=true,includeDate=true,flipColumns=true);\naddPercentIncrease(replaceValues=false);\"\n";$.extend(this,{process:function(display,pointData,cmds){this.display=display;let theCmd;try{let commands=DataUtils.parseCommands(cmds);commands.map(cmd=>{theCmd=cmd;if(this[cmd.command]){let orig=pointData;pointData=this[cmd.command](pointData,cmd.args);if(!pointData)pointData=orig;else pointData.entryId=orig.entryId;}else{console.log("unknown command:"+cmd.command);}});}catch(e){console.log("Error applying derived function:"+theCmd.command);console.log(e);console.log(e.stack);}
return pointData;},help:function(pointData,args){console.log(eg);return null;},furlData:function(pointData,args){},derived:function(pointData,args){let records=pointData.getRecords();let fields=pointData.getRecordFields();let newFields=fields.slice();let newRecords=[];let id=args["field"]||("field_"+fields.length);newFields.push(new RecordField({id:id,index:fields.length,label:Utils.makeLabel(id),type:"double",chartable:true,unit:args.unit}));let func=args["function"];if(!func){console.log("No func specified in derived");return null;}
func=func.replace(/_nl_/g,"\n").replace(/_semi_/g,";");if(func.indexOf("return")<0){func="return "+func;}
let setVars="";fields.forEach((field,idx)=>{if(field.getId()!=""){if(func.indexOf(field.getId())<0)return;let varName=field.getId().replace(/^([0-9]+)/g,"v$1");setVars+="\tvar "+varName+"=displayGetFunctionValue(args[\""+field.getId()+"\"]);\n";}});let code="function displayDerivedEval(args) {\n"+setVars+func+"\n}";eval(code);records.forEach((record,rowIdx)=>{let newRecord=record.clone();newRecord.data=record.data.slice();newRecord.fields=newFields;newRecords.push(newRecord);let funcArgs={};fields.map((field,idx)=>{if(field.getId()!=""){funcArgs[field.getId()]=record.getValue(field.getIndex());}});try{let value=displayDerivedEval(funcArgs);newRecord.data.push(value);}catch(exc){console.log("Error processing derived:"+exc);newRecord.data.push(NaN);}});return new PointData("pointdata",newFields,newRecords,null,{parent:pointData});},rotateData:function(pointData,args){let records=pointData.getRecords();let header=this.display.getDataValues(records[0]);let rotated=[];for(var colIdx=0;colIdx<header.length;colIdx++){rotated.push([]);}
let includeFields=args["includeFields"]=="true";let includeDate=args["includeDate"]=="true";let flipColumns=args["flipColumns"]=="true";let fields=pointData.getRecordFields();if(!flipColumns&&includeFields){fields.map((f,colIdx)=>{if(f.isRecordDate())return;rotated[colIdx].push(colIdx==0?args["fieldName"]||"Field":f.getLabel());});}
for(var rowIdx=0;rowIdx<records.length;rowIdx++){let row=this.display.getDataValues(records[rowIdx]);for(var colIdx=0;colIdx<row.length;colIdx++){let field=fields[colIdx];if(field.isRecordDate()){continue;}
var value=row[colIdx];if(value.f)value=value.f;if(value.getTime){value=this.display.formatDate(value);}
if(!includeFields&&rowIdx==0&&colIdx==0)value="";if(flipColumns)
rotated[colIdx].unshift(value);else
rotated[colIdx].push(value);}}
if(flipColumns&&includeFields){fields.map((f,colIdx)=>{if(f.isRecordDate())return;rotated[colIdx].unshift(colIdx==0?args["fieldName"]||"Field":f.getLabel());});}
return convertToPointData(rotated);},addPercentIncrease:function(pointData,args){let records=pointData.getRecords();let header=this.display.getDataValues(records[0]);let fields=pointData.getRecordFields();let newRecords=[];let firstRecord=records[0];let replaceValues=args["replaceValues"]=="true";let newFields=[];let fieldOk=f=>{return!f.isFieldGeo()&&f.isNumeric();};fields.forEach((f,fieldIdx)=>{f=f.clone();let newField=f.clone();f.index=newFields.length;if(!fieldOk(newField)){newFields.push(f);return;}
if(!replaceValues){newFields.push(f);}
newField.unit="%";newField.index=newFields.length;newField.id=newField.id+"_percent";newField.label=newField.label+" % increase";newFields.push(newField);});let keyFields=this.display.getFieldsByIds(fields,(args.keyFields||"").replace(/_comma_/g,","));records.forEach((record,rowIdx)=>{let data=[];let newRecord=record.clone();newRecord.data=data;newRecord.fields=newFields;newRecords.push(newRecord);fields.forEach((f,fieldIdx)=>{let value=record.data[f.getIndex()];if(!fieldOk(f)){if(rowIdx==records.length-1){}
data.push(value);return;}
if(!replaceValues){data.push(value);}
if(rowIdx==0){data.push(0);}else{let basev=firstRecord.data[f.getIndex()];let perc=basev==0?0:(value-basev)/basev;data.push(perc);if(rowIdx==records.length-1){}}});});return new PointData("pointdata",newFields,newRecords,null,{parent:pointData});},addFixed:function(pointData,args){let records=pointData.getRecords();let header=this.display.getDataValues(records[0]);let fields=pointData.getRecordFields();let newRecords=[];let value=args["value"];let type=args["type"]||"double";if(type=="double")value=parseFloat(value);let id=args["id"];let label=args["label"]||Utils.makeLabel(id);let newFields=[];fields.forEach((f,fieldIdx)=>{newFields.push(f.clone());});newFields.push(new RecordField({id:id,index:newFields.length,label:label,type:type,chartable:true,}));records.forEach((record,rowIdx)=>{let newRecord=record.clone();newRecord.data=[];record.data.forEach(d=>{newRecord.data.push(d)});newRecord.data.push(value);newRecords.push(newRecord);});return new PointData("pointdata",newFields,newRecords,null,{parent:pointData});},addBearing:function(pointData,args){let records=pointData.getRecords();let fields=pointData.getRecordFields();let newRecords=[];let newFields=[];fields.forEach((f,fieldIdx)=>{f=f.clone();newFields.push(f);});let bearingField=new RecordField();newFields.push(new RecordField({id:"bearing",index:newFields.length,label:"Bearing",type:"double",chartable:true,}));let pervPoint;records.forEach((record,rowIdx)=>{let newRecord=record.clone();newRecord.fields=newFields;newRecords.push(newRecord);let bearing=NaN;if(prevPoint){let point={lat:newRecord.getLatitude(),lon:newRecord.getLongitude()};bearing=Utils.getBearing(prevPoint,point);prevPoint=point;}
newRecord.data.push(bearing);});return new PointData("pointdata",newFields,newRecords,null,{parent:pointData});},cut:function(pointData,args){let cut=args.fields?args.fields.split(","):[];let records=pointData.getRecords();let header=this.display.getDataValues(records[0]);let fields=pointData.getRecordFields();let newFields=[];let newRecords=[];let indices=[];fields.forEach((f,fieldIdx)=>{if(cut.indexOf(f.getId())>=0)return;f=f.clone();let newField=f.clone();indices.push(newField.index);newField.index=newFields.length;newFields.push(newField);});records.forEach((record,rowIdx)=>{let newRecord=record.clone();newRecord.fields=newFields;let data=newRecord.data;let newData=[];indices.forEach(i=>{newData.push(data[i]);});newRecord.data=newData;newRecords.push(newRecord);});return new PointData("pointdata",newFields,newRecords,null,{parent:pointData});},doAverage:function(pointData,args){let records=pointData.getRecords();let header=this.display.getDataValues(records[0]);let fields=pointData.getRecordFields();var newRecords=[];var newFields=[];var firstRow=records[0];fields.forEach(f=>{var newField=f.clone();newFields.push(newField);newField.label=newField.label+" (avg)";});var sums=[];fields.forEach(f=>{sums.push(0)});var newRecord;for(var rowIdx=0;rowIdx<records.length;rowIdx++){var record=records[rowIdx];if(newRecord==null){newRecord=record.clone();newRecords.push(newRecord);newRecord.fields=newFields;newRecord.parentRecords=[];}
newRecord.parentRecords.push(record);fields.forEach((f,idx)=>{if(!f.isNumeric())return;var v=record.data[f.getIndex()];sums[idx]+=v;});fields.map((f,idx)=>{if(!f.isNumeric())return;newRecord.data[idx]=sums[idx]/records.length;});}
return new PointData("pointdata",newFields,newRecords,null,{parent:pointData});},noop:function(pointData,args){return pointData;},doublingRate:function(pointData,args){let records=pointData.getRecords();let allFields=pointData.getRecordFields();let fields=this.display.getFieldsByIds(allFields,(args.fields||"").replace(/_comma_/g,","));let keyFields=this.display.getFieldsByIds(allFields,(args.keyFields||"").replace(/_comma_/g,","));let newRecords=[]
let newFields=Utils.cloneList(allFields);fields.map(f=>{if(!f.isNumeric())return;let newField=f.clone();newField.id=newField.id+"_doubling";newField.unit="days";newField.label=newField.label+" doubling";newField.index=newFields.length;newFields.push(newField);});let keys=[];for(var rowIdx=0;rowIdx<records.length;rowIdx++){let record=records[rowIdx];let newRecord=record.clone();let key="";keyFields.forEach(f=>{key+="_"+record.getValue(f.getIndex());});keys.push(key);}
for(var rowIdx=0;rowIdx<records.length;rowIdx++){let record=records[rowIdx];let newRecord=record.clone();let key=keys[rowIdx];newRecords.push(newRecord);newRecord.fields=newFields;fields.map((f,idx)=>{if(!f.isNumeric())return;let v=record.getValue(f.getIndex());let v2=NaN;let lastDate=null;for(var j=rowIdx-1;j>=0;j--){if(keyFields.length>0){let key2=keys[j];if(key!=key2)continue;}
let record2=records[j];v2=record2.getValue(f.getIndex());if(v>=v2*2){lastDate=record2.getDate();break;}}
let diff=NaN;if(lastDate){diff=(record.getDate().getTime()-lastDate.getTime())/1000/60/60/24;}
newRecord.data.push(diff);});}
return new PointData("pointdata",newFields,newRecords,null,{parent:pointData});},scaleAndOffset:function(pointData,args){let records=pointData.getRecords();let allFields=pointData.getRecordFields();let fields;if(args.fields)
fields=this.display.getFieldsByIds(allFields,(args.fields||"").replace(/_comma_/g,","));else
fields=allFields;let unit=args.unit;let scale=args.scale?parseFloat(args.scale):1;let offset1=args.offset1?parseFloat(args.offset1):0;let offset2=args.offset?parseFloat(args.offset):args.offset2?parseFloat(args.offset2):0;let newRecords=[]
let newFields=[];let changedFields={};fields.forEach(f=>{changedFields[f.getId()]=true});allFields.map(f=>{let newField=f.clone();newFields.push(newField);if(!f.isNumeric()){return;}
if(changedFields[newField.getId()]){newField.unit=unit;}});for(var rowIdx=0;rowIdx<records.length;rowIdx++){let record=records[rowIdx];let newRecord=record.clone();newRecords.push(newRecord);let data=record.getData();let newData=Utils.cloneList(data);fields.forEach(f=>{if(!f.isNumeric())return;let d=data[f.getIndex()];if(!isNaN(d)){d=(d+offset1)*scale+offset2;newData[f.getIndex()]=d;}});newRecord.setData(newData);}
return new PointData("pointdata",newFields,newRecords,null,{parent:pointData});},scaleAndOffset:function(pointData,args){let records=pointData.getRecords();let allFields=pointData.getRecordFields();let fields;if(args.fields)
fields=this.display.getFieldsByIds(allFields,(args.fields||"").replace(/_comma_/g,","));else
fields=allFields;let unit=args.unit;let scale=args.scale?parseFloat(args.scale):1;let offset1=args.offset1?parseFloat(args.offset1):0;let offset2=args.offset?parseFloat(args.offset):args.offset2?parseFloat(args.offset2):0;let newRecords=[]
let newFields=[];let changedFields={};fields.forEach(f=>{changedFields[f.getId()]=true});allFields.map(f=>{let newField=f.clone();newFields.push(newField);if(!f.isNumeric()){return;}
if(changedFields[newField.getId()]){newField.unit=unit;}});for(var rowIdx=0;rowIdx<records.length;rowIdx++){let record=records[rowIdx];let newRecord=record.clone();newRecords.push(newRecord);let data=record.getData();let newData=Utils.cloneList(data);fields.forEach(f=>{if(!f.isNumeric())return;let d=data[f.getIndex()];if(!isNaN(d)){d=(d+offset1)*scale+offset2;newData[f.getIndex()]=d;}});newRecord.setData(newData);}
return new PointData("pointdata",newFields,newRecords,null,{parent:pointData});},function:function(pointData,args){},accum:function(pointData,args){let records=pointData.getRecords();let allFields=pointData.getRecordFields();let fields;let suffix=args.suffix!=null?args.suffix:"_accum";if(args.fields)
fields=this.display.getFieldsByIds(allFields,(args.fields||"").replace(/_comma_/g,","));else
fields=allFields;let newRecords=[]
let newFields=[];let totals=[];allFields.map(f=>{totals.push(0);let newField=f.clone();newFields.push(newField);if(!f.isNumeric())return;newField.id=newField.id+suffix;newField.label=newField.label+suffix;});for(var rowIdx=0;rowIdx<records.length;rowIdx++){let record=records[rowIdx];let newRecord=record.clone();newRecords.push(newRecord);let data=record.getData();let newData=Utils.cloneList(data);fields.forEach(f=>{if(!f.isNumeric())return;let d=data[f.getIndex()];if(!isNaN(d)){let x=d;totals[f.getIndex()]+=d;d=totals[f.getIndex()];}
newData[f.getIndex()]=d;});newRecord.setData(newData);}
return new PointData("pointdata",newFields,newRecords,null,{parent:pointData});},aggregate:function(pointData,args){let records=pointData.getRecords();let allFields=pointData.getRecordFields();let groupField=this.display.getFieldById(allFields,args.groupBy);if(!groupField)throw new Error("No groupBy defined: "+args.groupBy+" args:"+JSON.stringify(args));let includeRows=args.includeRows;let fields;let suffix=args.suffix!==null?args.suffix:"_accum";suffix="";if(args.fields)
fields=this.display.getFieldsByIds(allFields,(args.fields||"").replace(/_comma_/g,","));else
fields=allFields;let newRecords=[]
let newFields=[];let totals=[];let groupMap={};let groups=[];let prop=(f,p)=>{let id=f.getId()+"."+p;if(Utils.isDefined(args[id]))return args[id];if(Utils.isDefined(this.display.getProperty(id)))return this.display.getProperty(id);return this.display.getProperty(p);};fields.forEach(f=>{let newField=f.clone();newFields.push(newField);newField.id=newField.id+suffix;newField.label=newField.label+suffix;if(newField.isNumeric()){newField.weightedByField=this.display.getFieldById(allFields,prop(newField,"weightedByField"));let op=prop(newField,"operator");if(!op&&newField.getUnit()=="%")
op="average";newField.operator=op;}});records.forEach(record=>{let groupValue=groupField.getValue(record);let group=groupMap[groupValue];if(!group){group=groupMap[groupValue]=[];groups.push(groupValue);}
group.push(record);});groups.forEach(group=>{let newData=[];let rows=groupMap[group];newFields.forEach(f=>{if(f.weightedByField){f.weight=Utils.sumList(rows.map(record=>{return f.weightedByField.getValue(record);}));}
if(f.isFieldNumeric())newData.push(0);else{if(f.getId()==groupField.getId())
newData.push(group);else
newData.push("");}});let debug=group=="Delaware";rows.forEach((record,recordIdx)=>{newFields.forEach((f,idx)=>{let v=f.getValue(record);if(f.isFieldNumeric()){if(!isNaN(v)){if(f.operator=="average"&&f.weightedByField){let weight=f.weightedByField.getValue(record);let percent=weight/f.weight;v=v*percent;}
newData[idx]+=v;}}else{if(recordIdx==0)
newData[idx]=v;if(groupField.getId()==f.getId()){newData[idx]=groupField.getValue(record);}}});});let newRecord=rows[0].clone();newRecords.push(newRecord);newFields.forEach(f=>{if(!f.isNumeric()){if(groupField.getId()!=f.getId())
newData[f.getIndex()]="";return;}
let debug=group=="Delaware";let d=newData[f.getIndex()]
if(!isNaN(d)){if(f.operator=="average"){if(!f.weightedByField){d=d/rows.length;}}
let decimals=prop(f,"numberFormatDecimals");if(decimals!==null)
d=Utils.roundDecimals(d,decimals);newData[f.getIndex()]=d;}});newRecord.setData(newData);newRecord.isAggregate=true;newRecord.aggregateValue=group;if(includeRows)
newRecords=Utils.mergeLists(newRecords,rows);})
return new PointData("pointdata",newFields,newRecords,null,{parent:pointData});},mean:function(pointData,args){let records=pointData.getRecords();let allFields=pointData.getRecordFields();let fields;if(args.fields)
fields=this.display.getFieldsByIds(allFields,(args.fields||"").replace(/_comma_/g,","));else
fields=allFields;let newRecords=[]
let newFields=[];allFields.map(f=>{newFields.push(f.clone());});newFields.push(new RecordField({id:"mean",index:newFields.length,label:"Mean",type:"double",chartable:true,}));for(var rowIdx=0;rowIdx<records.length;rowIdx++){let record=records[rowIdx];let newRecord=record.clone();newRecords.push(newRecord);let data=record.getData();let newData=Utils.cloneList(data);let total=0;let fieldCnt=0;fields.forEach(f=>{if(!f.isNumeric())return;fieldCnt++;let d=data[f.getIndex()];if(!isNaN(d)){total+=d;}});newData.push(total/fieldCnt);newRecord.setData(newData);}
return new PointData("pointdata",newFields,newRecords,null,{parent:pointData});},prune:function(pointData,args){let records=pointData.getRecords();let allFields=pointData.getRecordFields();let fields;if(args.fields)
fields=this.display.getFieldsByIds(allFields,(args.fields||"").replace(/_comma_/g,","));else
fields=allFields;let newRecords=[]
let newFields=[];allFields.map(f=>{newFields.push(f.clone());});for(var rowIdx=0;rowIdx<records.length;rowIdx++){let record=records[rowIdx];let data=record.getData();let newData=Utils.cloneList(data);let ok=false;let fieldCnt=0;fields.every(f=>{if(!f.isNumeric())return true;fieldCnt++;let d=data[f.getIndex()];if(!isNaN(d)){ok=true;return false;}
return true;});if(ok){let newRecord=record.clone();newRecord.setData(newData);newRecords.push(newRecord);}}
return new PointData("pointdata",newFields,newRecords,null,{parent:pointData});},mergeRows:function(pointData,args){let records=pointData.getRecords();let fields=pointData.getRecordFields();let op=args.operator||"count";let ops={};let keyFields=this.display.getFieldsByIds(fields,(args.keyFields||"").replace(/_comma_/g,","));let altFields=this.display.getFieldsByIds(fields,(args.altFields||"").replace(/_comma_/g,","));let newFields=[];let seen={};keyFields.forEach((f,idx)=>{seen[f.getId()]=true;let newField=f.clone();newField.index=newFields.length;newFields.push(newField);});let tmp=this.display.getFieldsByIds(fields,(args["valueFields"]||"").replace(/_comma_/g,","));if(args.valueFields==null)tmp=fields;let valueFields=[];tmp.forEach(f=>{if(!seen[f.getId()]){ops[f.getId()]=args[f.getId()+".operator"];valueFields.push(f);}});valueFields.forEach((f,idx)=>{var newField=f.clone();newField.index=newFields.length;if(newField.isNumeric()){let label=args[newField.id+".label"];newField.id=newField.id+"_"+(ops[f.getId()+".operator"]||op);newField.label=label||Utils.makeLabel(newField.id);}
newFields.push(newField);});if(op=="count"){newFields.push(new RecordField({id:"count",index:newFields.length,label:"Count",type:"double",chartable:true,}));}
let keys=[];let collection={};for(var rowIdx=0;rowIdx<records.length;rowIdx++){var record=records[rowIdx];let key="";keyFields.forEach(f=>{let v=record.getValue(f.getIndex());if(v==""&&altFields.length>0){altFields.forEach(f2=>{v+=record.getValue(f1.getIndex())+"-";});}
key+=v+"-";});let obj=collection[key];if(!obj){keys.push(key);obj=collection[key]={count:0,sums:[],mins:[],maxs:[],records:[]};valueFields.forEach((f,idx)=>{obj.sums.push(0);obj.mins.push(NaN);obj.maxs.push(NaN);});}
valueFields.forEach((f,idx)=>{let v=record.getValue(f.getIndex());if(f.isNumeric()&&!isNaN(v)){obj.sums[idx]+=v;obj.mins[idx]=isNaN(obj.mins[idx])?v:Math.min(obj.mins[idx],v);obj.maxs[idx]=isNaN(obj.maxs[idx])?v:Math.max(obj.maxs[idx],v);}});obj.count++;obj.records.push(record);}
let newRecords=[];let cnt=0;keys.forEach((key,idx)=>{let obj=collection[key];let data=[];let seen={};let date=obj.records[0].getDate();let bounds=RecordUtil.getBounds(obj.records);let lat=bounds.south+(bounds.north-bounds.south)/2;let lon=bounds.west+(bounds.east-bounds.west)/2;if(key.indexOf("US")>=0){cnt++;if(cnt==1){obj.records.forEach(r=>{});}}
keyFields.forEach(f=>{let v=obj.records[0].getValue(f.getIndex());data.push(v);seen[f.getId()]=true;});valueFields.forEach((f,idx)=>{if(seen[f.getId()])return;if(!f.isNumeric()){data.push(obj.records[0].getValue(f.getIndex()));}else{if(op=="sum")
data.push(obj.sums[idx]);else if(op=="average")
data.push(obj.sums[idx]/obj.count);else if(op=="min")
data.push(obj.mins[idx]);else if(op=="max")
data.push(obj.maxs[idx]);}});if(op=="count"){data.push(obj.count);}
let newRecord=new PointRecord(newFields,lat,lon,NaN,date,data);newRecords.push(newRecord);});return new PointData("pointdata",newFields,newRecords,null,{parent:pointData});},maxDate:function(pointData,args){let records=pointData.getRecords();let fields=pointData.getRecordFields();let keyFields=this.display.getFieldsByIds(fields,(args.keyFields||"").replace(/_comma_/g,","));let seen={};let keys=[];let collection={};for(var rowIdx=0;rowIdx<records.length;rowIdx++){var record=records[rowIdx];let key="";keyFields.forEach(f=>{key+=record.getValue(f.getIndex())+"-";});let obj=collection[key];if(!obj){keys.push(key);obj=collection[key]={records:[]};}
obj.records.push(record);}
let newRecords=[];let cnt=0;keys.forEach((key,idx)=>{let records=collection[key].records;let maxRecord=null;let maxDate=null;records.forEach(r=>{if(maxRecord==null||r.getDate().getTime()>maxDate){maxDate=r.getDate().getTime();maxRecord=r;}});newRecords.push(maxRecord);});return new PointData("pointdata",fields,newRecords,null,{parent:pointData});},unfurl:function(pointData,args){let records=pointData.getRecords();let fields=pointData.getRecordFields();let headerField=this.display.getFieldById(fields,args.headerField||"");let uniqueField=this.display.getFieldById(fields,args.uniqueField||"");let valueFields=this.display.getFieldsByIds(fields,args.valueFields||"");let includeFields=this.display.getFieldsByIds(fields,args.includeFields||"");let prefix=args.prefix||"";if(!headerField)throw new Error("No headerField");let uniqueIsDate=false;if(!uniqueField){if(args.uniqueField=="date"){uniqueIsDate=true;}else{throw new Error("No uniqueField");}}
if(valueFields.length==0)throw new Error("No value fields");let newColumns=[];let newColumnMap={};let uniqueToRecords={};let rowMap={};let uniques=[];let indexMap={};records.forEach(record=>{let unfurlValue=record.getValue(headerField.getIndex());let uniqueValue=uniqueIsDate?record.getDate():record.getValue(uniqueField.getIndex());if(!newColumnMap[unfurlValue]){newColumnMap[unfurlValue]=true;if(valueFields.length>1){valueFields.forEach(f=>{let label=unfurlValue+" - "
+f.getLabel();newColumns.push(label);});}else{newColumns.push(unfurlValue);}}
let rowGroup=rowMap[uniqueValue];if(rowGroup==null){rowMap[uniqueValue]=rowGroup=[];uniques.push(uniqueValue);}
rowGroup.push(record);});newColumns.sort((a,b)=>{if(typeof a=="number"&&typeof b=="number"){return a-b;}
return(""+a).localeCompare(""+b);});newColumns.forEach((v,idx)=>{indexMap[v]=idx;});let newRecords=[];let newFields=[];let uniqueType="string";if(uniques[0]){if(uniques[0].getTime)
uniqueType="date";else if(typeof uniques[0]=="number")
uniqueType="double";}
if(uniqueIsDate)
newColumns=Utils.mergeLists(["date"],newColumns);else
newColumns=Utils.mergeLists([uniqueField.getId()],newColumns);newColumns.forEach((c,idx)=>{if(idx>0)
c=prefix+""+c;else
c=""+c;let label=Utils.makeLabel(c);let id=Utils.makeId(c);let type=(idx==0?uniqueType:"double");newFields.push(new RecordField({id:id,index:newFields.length,label:label,type:type,chartable:true,}));});uniques.forEach(u=>{let array=[];newColumns.forEach(c=>{array.push("");});array[0]=u;let includeCnt=0;let rowValues=null;let firstRow=null;cnt=0;rowMap[u].forEach(row=>{if(firstRow==null){firstRow=row;}
let colname=row.getValue(headerField.getIndex());if(valueFields.length>1){valueFields.forEach(f=>{let label=colname+" - "+f.getId();let idx=indexMap[label];if(idx==null){return;}
let value=row.getValue(valueIndex);array[1+includeFields.length+idx]=value;});}else{let idx=indexMap[colname];if(idx==null){return;}
let valueIndex=valueFields[0].getIndex();let value=row.getValue(valueIndex);array[1+includeFields.length+idx]=value;}
cnt++;});includeFields.forEach(f=>{array[1+includeCnt]=firstRow.getValue(f.getIndex());includeCnt++;});let newRecord=new PointRecord(newFields,firstRow.getLatitude(),firstRow.getLongitude(),NaN,null,array);newRecords.push(newRecord);cnt++;});return new PointData("pointdata",newFields,newRecords,null,{parent:pointData});},});}
var DataUtils={getCsv:function(fields,records){let csv="";fields.forEach((f,idx)=>{if(idx>0)csv+=",";csv+=f.getId();});csv+="\n";records.forEach(r=>{fields.forEach((f,idx)=>{let v=r.getValue(f.getIndex());if(v&&v.getTime){v=Utils.formatDateYYYYMMDDHHMM(v);}else{v=String(v);}
if(idx>0)csv+=",";let needToQuote=v.indexOf("\n")>=0||v.indexOf(",")>=0;if(v.indexOf("\"")>=0){needToQuote=true;v=v.replace(/\"/g,"\"\"");}
if(needToQuote){v="\""+v+"\"";}
csv+=v;});csv+="\n";});return csv;},getJson:function(fields,records,filename){let json=[];records.forEach(r=>{let obj={};json.push(obj);fields.forEach((f,idx)=>{let v=r.getValue(f.getIndex());if(v&&v.getTime){v=Utils.formatDateYYYYMMDDHHMM(v);}else{v=String(v);}
obj[f.getId()]=v;});});Utils.makeDownloadFile(filename,JSON.stringify(json,null,2));},parseCommands:function(commands){let result=[];if(!commands)return result;commands.split(";").forEach(command=>{command=command.trim();let idx=command.indexOf("(");let args={};if(idx>=0){let rest=command.substring(idx+1).trim();command=command.substring(0,idx).trim();if(rest.endsWith(")"))rest=rest.substring(0,rest.length-1);let toks=[];let inQuote=false;let escape=false;let tok="";for(let i=0;i<rest.length;i++){let c=rest[i];if(c=="\\"){escape=true;continue;}
if(escape){tok+=c;escape=false;continue;}
if(c=="\'"){if(!inQuote){inQuote=true;}else{inQuote=false;}
tok+=c;continue;}
if(c==","){if(inQuote){tok+=c;continue;}
toks.push(tok);tok="";continue;}
tok+=c;}
toks.push(tok);toks.forEach(arg=>{arg=arg.trim();let value="";let atoks=arg.match(/(.*)=(.*)/);if(atoks){arg=atoks[1];value=atoks[2];}
arg=arg.trim();value=value.trim();value=value.replace(/^'/g,"").replace(/'$/g,"");if(arg!=""){args[arg]=value;}});}
if(command!=""){result.push({command:command,args:args});}});return result;},getDataFilters:function(display,prop){let filters=[];if(!prop)return filters;let baseId=display.getId();let cnt=0;DataUtils.parseCommands(prop).map(cmd=>{let filterId=baseId+"_"+(cnt++);let[type,fieldId,value,enabled,label,expr]=[cmd.command,cmd.args.field,cmd.args.value,cmd.args.enabled,cmd.args.label,cmd.args.expr];if(!Utils.isDefined(enabled))
enabled=true;else{enabled=enabled.trim()=="true"||enabled.trim()=="";}
if(label){var cbx=display.jq("datafilterenabled_"+filterId);if(cbx.length){enabled=cbx.is(':checked');}}
if(type=="match"||type=="notmatch")
value=new RegExp(value);else
value=+value;let fields=null;if(cmd.args.fields){fields=display.getFieldsByIds(null,cmd.args.fields.replace(/:/g,","));}
let allFields=display.getData().getRecordFields();let field=display.getFieldById(null,fieldId);filters.push({id:filterId,props:cmd.args,type:type.trim(),field:field,fields:fields?fields:field?[field]:null,allFields:allFields,value:value,label:label,enabled:enabled,expr:expr,isRecordOk:function(r){if(!this.enabled){return true;}
let value=this.field?r.getValue(this.field.getIndex()):NaN;if(this.type=="match"){return String(value).match(this.value);}else if(this.type=="nomissing"){let fieldsToUse=null;if(this.fields){fieldsToUse=this.fields;}else if(this.field){fieldsToUse=[this.field];}else{fieldsToUse=r.fields;}
let ok=false;fieldsToUse.some(f=>{if(field&&!(field.isFieldLatitude()||f.isFieldLongitude()))
if(f.isFieldLatitude()||f.isFieldLongitude())return true;if(f.isNumeric()){let v=r.getValue(f.getIndex());ok=!isNaN(v);}
return ok;});return ok;}else if(this.type=="notmatch"){return!String(value).match(this.value);}else if(this.type=="lessthan"){return value<this.value;}else if(this.type=="greaterthan"){return value>this.value;}else if(this.type=="equals"){return value==this.value;}else if(this.type=="notequals"){return value!=this.value;}else if(this.type=="bounds"){let lat=r.getLatitude();let lon=r.getLongitude();if(this.props.north&&lat>+this.props.north)return false;if(this.props.south&&lat<+this.props.south)return false;if(this.props.west&&lon<+this.props.west)return false;if(this.props.east&&lon>+this.props.east){return false;}
return true;}else if(this.type=="eval"){let code="function dataFilterCall(){\n";this.allFields.every(f=>{let value=r.getValue(f.getIndex());if(typeof value=="string")value="'"+value+"'";else if(typeof value!="number")value="'"+value+"'";code+=f.getId()+"="+value+";\n"
return true;});let expr=this.expr;if(expr==null)throw"No expr given in data filter";if(expr.indexOf("return")<0)expr=" return "+expr;code+=expr+"\n}\n";code+="var dataFilterValue = dataFilterCall();\n";eval(code);return dataFilterValue;}else{console.log("Unknown filter:"+this.type);return true;}}});});return filters;},}
function RequestMacro(display,macro){this.display=display;let values=null;let enums=this.getProperty("request."+macro+".values");if(enums){values=[]
let includeAll=false;if(this.getProperty("request."+macro+".includeAll",this.getProperty("request.includeAll",false))){values.push(["","All"]);includeAll=true;}
if(this.getProperty("request."+macro+".includeNone",false)){values.push(["","None"]);}
enums.split(",").forEach(tok=>{let toks=tok.split(":");let id=toks[0];let label=toks[1];if(!includeAll&&id=="_all_")return;values.push([id,label||id]);});}
let macroType=this.getProperty("request."+macro+".type",values!=null?"enumeration":macro=="bounds"?"bounds":"string");let dflt=this.getProperty("request."+macro+".default",null);if(dflt==null){if(values&&values.length>0&&macroType=="enumeration"){dflt=values[0][0];}else{dflt="";}
dflt="";}
if(dflt&&macroType=="enumeration"){if(dflt.split)dflt=dflt.split(",");}
let prefix=this.getProperty("requestPrefix","");$.extend(this,{name:macro,values:values,urlarg:this.getProperty("request."+macro+".urlarg",prefix+macro),type:macroType,triggerReload:this.getProperty("request."+macro+".triggerReload",true),dflt:dflt,dflt_from:this.getProperty("request."+macro+"_from.default",""),dflt_to:this.getProperty("request."+macro+"_to.default",""),dflt_min:this.getProperty("request."+macro+"_min.default",""),dflt_max:this.getProperty("request."+macro+"_max.default",""),label:this.getProperty("request."+macro+".label",Utils.makeLabel(macro)),multiple:this.getProperty("request."+macro+".multiple",false),template:this.getProperty("request."+macro+".template"),multitemplate:this.getProperty("request."+macro+".multitemplate"),nonetemplate:this.getProperty("request."+macro+".nonetemplate"),delimiter:this.getProperty("request."+macro+".delimiter"),rows:this.getProperty("request."+macro+".rows",3),});}
RequestMacro.prototype={getProperty:function(prop,dflt){return this.display.getProperty(prop,dflt);},isVisible:function(){return this.getProperty("request."+this.name+".visible",this.getProperty("macros.visible",true));},getWidget:function(dateIds){let debug=false;let visible=this.isVisible();let style=visible?"":"display:none;";let widget;let label=this.label;if(debug)console.log(this.getId()+".getWidget:"+label+" type:"+this.type);if(this.type=="bounds"){widget=HU.checkbox("",[ID,this.display.getDomId(this.getId())],false)+HU.span([CLASS,"display-request-reload",TITLE,"Reload with current bounds"]," In bounds");label=null;}else if(this.type=="enumeration"){if(this.values&&this.values.length>0){let attrs=[STYLE,style,ID,this.display.getDomId(this.getId()),CLASS,"display-filter-input"];let values=this.values;if(this.dflt){let first=[];let rest=[];values.forEach(v=>{if(this.dflt.indexOf(v[0])>=0)first.push(v);else rest.push(v);});values=Utils.mergeLists(first,rest);}else{}
if(this.multiple){attrs.push("multiple");attrs.push(null);attrs.push("size");attrs.push(Math.min(this.rows,values.length));}else{values=Utils.mergeLists([[VALUE_NONE,"--"]],values);}
if(debug)
console.log("\tselect: dflt:"+this.dflt+" values:"+this.values);widget=HU.select("",attrs,values,this.dflt,20);}}else if(this.type=="numeric"){let minId=this.display.getDomId(this.getId()+"_min");let maxId=this.display.getDomId(this.getId()+"_max");widget=HU.input("","",["data-min",this.dflt_min,STYLE,style,ID,minId,"size",4,CLASS,"display-filter-input display-filter-range"],this.dflt_min)+
" - "+
HU.input("","",["data-max",this.dflt_max,STYLE,style,ID,maxId,"size",4,CLASS,"display-filter-input display-filter-range"],this.dflt_max)
label=label+" range";}else if(this.type=="date"){let fromId=this.display.getDomId(this.getId()+"_from");let toId=this.display.getDomId(this.getId()+"_to");dateIds.push(fromId);dateIds.push(toId);widget=HU.datePicker("",this.dflt_from,[CLASS,"display-filter-input",STYLE,style,"name","",ID,fromId])+
" - "+
HU.datePicker("",this.dflt_to,[CLASS,"display-filter-input",STYLE,style,"name","",ID,toId])
label=label+" range";}else{let size="10";if(this.type=="number")
size="4";widget=HU.input("",this.dflt,[STYLE,style,ID,this.display.getDomId(this.getId()),"size",size,CLASS,"display-filter-input"]);}
if(!widget)return"";return(visible?this.display.makeFilterWidget(label,widget):widget);},isMacro:function(id){return id==this.name;},getId:function(){return"macro_"+this.name;},getValue:function(){let widget=this.display.jq(this.getId());let value=this.dflt;if(widget.length!=0){value=widget.val();}else{if(this.type=="enumeration"){return VALUE_NONE;}}
this.display.setProperty("request."+this.name+".default",value);return value;},setValue:function(prop){let id=this.getId();if(prop.what=="min")
this.display.jq(i+"_min").val(prop.value);else if(prop.what=="max")
this.display.jq(id+"_max").val(prop.value);else if(prop.what=="from")
this.display.jq(id+"_from").val(prop.value);else if(prop.what=="to")
this.display.jq(id+"_to").val(prop.value);else{console.log(this.type+" macroChanged:"+prop.value+" "+this.display.jq(id).length);this.display.jq(id).val(prop.value);console.log("after:"+this.display.jq(id).val());}},apply:function(url){if(this.type=="bounds"){if(this.display.getBounds&&this.display.jq(this.getId()).is(':checked')){let bounds=this.display.getBounds();if(bounds){bounds=RecordUtil.convertBounds(bounds);["north","south","east","west"].map(b=>{url+="&"+b+"="+bounds[b];});}}}else if(this.type=="numeric"){let min=this.display.jq(this.getId()+"_min").val()||"";let max=this.display.jq(this.getId()+"_max").val()||"";this.dflt_min=min;this.dflt_max=max;if(min!="")
url=url+"&"+HU.urlArg(this.urlarg+"_from",min);if(max!="")
url=url+"&"+HU.urlArg(this.urlarg+"_to",max);this.display.setProperty("request."+this.name+"_min.default",min);this.display.setProperty("request."+this.name+"_max.default",max);}else if(this.type=="date"){let from=this.display.jq(this.getId()+"_from").val()||"";let to=this.display.jq(this.getId()+"_to").val()||"";this.dflt_from=from;this.dflt_to=to;this.display.setProperty("request."+this.name+"_from.default",from);this.display.setProperty("request."+this.name+"_to.default",to);if(from!="")
url=url+"&"+HU.urlArg(this.urlarg+"_fromdate",from);if(to!="")
url=url+"&"+HU.urlArg(this.urlarg+"_todate",to);}else if(this.type=="enumeration"){let value=this.getValue();if(!Array.isArray(value)){value=[value];}
if(value[0]=="_all_"||value[0]=="_none_"||value[0]==VALUE_NONE)return url;if(value.length>0){let regexp=new RegExp(this.urlarg+"=[^$&]*",'g');url=url.replace(regexp,"");let values=[];value.forEach(v=>{if(this.template)v=this.template.replace(/\${value}/,v);values.push(v);});if(this.delimiter){let arg="";values.forEach((v,idx)=>{if(idx>0)arg+=this.delimiter;arg+=v;});if(this.multitemplate&&values.length>1){arg=this.multitemplate.replace(/\${value}/,arg);}
url=url+"&"+HU.urlArg(this.urlarg,arg);}else{values.forEach(v=>{url=url+"&"+HU.urlArg(this.urlarg,v);});}}else{}}else{let value=this.getValue();this.dflt=value;if(value!=""){let regexp=new RegExp(this.urlarg+"=[^$&]*",'g');url=url.replace(regexp,"");url=url+"&"+HU.urlArg(this.urlarg,value);}}
return url;}}
function RamaddaBounds(north,west,south,east){if(Utils.isDefined(north.north)){let b=north;this.north=b.north;this.west=b.west;this.south=b.south;this.east=b.east;}else if(Utils.isDefined(north.top)){let b=north;this.north=b.top;this.west=b.left;this.south=b.bottom;this.east=b.right}else{this.north=north;this.west=west;this.south=south;this.east=east;}
$.extend(this,{toString:function(){return"N:"+this.north+" W:"+this.west+" S:"+this.south+" E:"+this.east;}});}
function makeInlineData(display,src){let csv=$("#"+src).html().trim();let lines=csv.split("\n");let fields=[];let samples=lines[1].split(",");let latField=null,lonField=null,dateField=null;lines[0].split(",").forEach((tok,idx)=>{tok=tok.trim();let id=Utils.makeId(tok);let label=Utils.makeLabel(tok);let type="string";let sample=samples[idx];if(display.getProperty(id+".label")){label=display.getProperty(id+".label");}
if(display.getProperty(id+".type")){type=display.getProperty(id+".type");if(type=="enum")type="enumeration";}else{if(id=="date"){type="date";}else{if(!isNaN(parseFloat(sample)))type="double";}}
let field=new RecordField({id:tok,index:idx,label:label,type:type,chartable:true});fields.push(field);if(field.isFieldLatitude())latField=field;else if(field.isFieldLongitude())lonField=field;});let records=[];lines.forEach((line,idx)=>{if(idx==0)return;line=line.trim();if(line.length==0)return;let data=[];let lat=NaN;let lon=NaN;let date=null;line.split(",").forEach((tok,col)=>{tok=tok.replace(/_nl_/g,"\n").replace(/_qt_/g,"\"").replace(/_comma_/g,",");let field=fields[col];if(latField&&latField.getIndex()==col){lat=tok=parseFloat(tok);}else if(lonField&&lonField.getIndex()==col){lon=tok=parseFloat(tok);}else if(dateField&&dataField.getIndex()==col){date=tok=new Data(tok);}else{if(field.isFieldNumeric()){tok=parseFloat(tok);}}
data.push(tok);});records.push(new PointRecord(fields,lat,lon,NaN,date,data));});return new PointData(src,fields,records,"#"+src);}
const DISPLAY_LINECHART="linechart";const DISPLAY_AREACHART="areachart";const DISPLAY_BARCHART="barchart";const DISPLAY_BARTABLE="bartable";const DISPLAY_BARSTACK="barstack";const DISPLAY_PIECHART="piechart";const DISPLAY_TIMERANGECHART="timerangechart";const DISPLAY_SANKEY="sankey";const DISPLAY_CALENDAR="calendar";const DISPLAY_SCATTERPLOT="scatterplot";const DISPLAY_HISTOGRAM="histogram";const DISPLAY_BUBBLE="bubble";const DISPLAY_GAUGE="gauge";const DISPLAY_TABLE="table";const DISPLAY_WORDTREE="wordtree";const DISPLAY_TREEMAP="treemap";const ID_CHART="chart";const ID_CHARTS="charts";const ID_CHARTS_INNER="chartsinner";var googleChartsLoaded=false;function googleChartsHaveLoaded(){googleChartsLoaded=true;}
if(window["google"]){google.charts.setOnLoadCallback(googleChartsHaveLoaded);}
function haveGoogleChartsLoaded(){if(!googleChartsLoaded){if(Utils.isDefined(google.visualization)){if(Utils.isDefined(google.visualization.Gauge)){googleChartsLoaded=true;}}}
return googleChartsLoaded;}
function waitOnGoogleCharts(object,callback){if(haveGoogleChartsLoaded()){return true;}
if(!object.googleChartCallbackPending){object.googleChartCallbackPending=true;let func=function(){object.googleChartCallbackPending=false;callback();}
setTimeout(func,100);}
return false;}
addGlobalDisplayType({type:DISPLAY_TABLE,label:"Table",requiresData:true,forUser:true,category:CATEGORY_TABLE,desc:"Basic tabular display",tooltip:makeDisplayTooltip("Tabular display of data","table.png")},true);addGlobalDisplayType({type:DISPLAY_LINECHART,label:"Line Chart",requiresData:true,forUser:true,category:CATEGORY_CHARTS,tooltip:makeDisplayTooltip("Basic line chart","linechart.png","Show time series or other data"),helpurl:true});addGlobalDisplayType({type:DISPLAY_BARCHART,label:"Bar Chart",requiresData:true,forUser:true,category:CATEGORY_CHARTS,tooltip:makeDisplayTooltip(null,"barchart.png")});addGlobalDisplayType({type:DISPLAY_BARSTACK,label:"Stacked Bar Chart",requiresData:true,forUser:true,category:CATEGORY_CHARTS,tooltip:makeDisplayTooltip("Stacked bar chart","barstack.png"),helpurl:true});addGlobalDisplayType({type:DISPLAY_AREACHART,label:"Area Chart",requiresData:true,forUser:true,category:CATEGORY_CHARTS,tooltip:makeDisplayTooltip(null,"areachart.png")});addGlobalDisplayType({type:DISPLAY_BARTABLE,label:"Bar Table",requiresData:true,forUser:true,category:CATEGORY_CHARTS,tooltip:makeDisplayTooltip(null,"bartable.png")});addGlobalDisplayType({type:DISPLAY_SCATTERPLOT,label:"Scatter Plot",requiresData:true,forUser:true,category:CATEGORY_CHARTS,tooltip:makeDisplayTooltip(null,"scatterplot.png")});addGlobalDisplayType({type:DISPLAY_HISTOGRAM,label:"Histogram",requiresData:true,forUser:true,category:CATEGORY_CHARTS,tooltip:makeDisplayTooltip(null,"histogram.png")});addGlobalDisplayType({type:DISPLAY_BUBBLE,label:"Bubble Chart",requiresData:true,forUser:true,category:CATEGORY_CHARTS,tooltip:makeDisplayTooltip(null,"bubblechart.png")});addGlobalDisplayType({type:DISPLAY_PIECHART,label:"Pie Chart",requiresData:true,forUser:true,category:CATEGORY_CHARTS,tooltip:makeDisplayTooltip(null,"piechart.png")});addGlobalDisplayType({type:DISPLAY_GAUGE,label:"Gauge",requiresData:true,forUser:true,category:CATEGORY_MISC,tooltip:makeDisplayTooltip("A gauge","gauge.png")});addGlobalDisplayType({type:DISPLAY_TIMERANGECHART,label:"Timerange",requiresData:true,forUser:true,category:CATEGORY_MISC,tooltip:makeDisplayTooltip("Time ranges","timerange.png","Show data with start/end times")});addGlobalDisplayType({type:DISPLAY_SANKEY,label:"Sankey Chart",requiresData:true,forUser:true,category:CATEGORY_RADIAL_ETC,tooltip:makeDisplayTooltip(null,"sankey.png")});addGlobalDisplayType({type:DISPLAY_CALENDAR,label:"Calendar Chart",requiresData:true,forUser:true,category:CATEGORY_MISC,tooltip:makeDisplayTooltip("Show a calendar","calendar.png")});addGlobalDisplayType({type:DISPLAY_WORDTREE,label:"Word Tree",requiresData:true,forUser:true,category:CATEGORY_TEXT,tooltip:makeDisplayTooltip("Displays data as a tree of words","wordtree.png","Specify a number of fields. Each field value is a level in the tree")});addGlobalDisplayType({type:DISPLAY_TREEMAP,label:"Tree Map",requiresData:true,forUser:true,category:CATEGORY_RADIAL_ETC,tooltip:makeDisplayTooltip("A tree map","treemap.png")});let PROP_CHART_MIN="chartMin";let PROP_CHART_MAX="chartMax";let DFLT_WIDTH="600px";let DFLT_HEIGHT="200px";function RamaddaGoogleChart(displayManager,id,chartType,properties){const ID_TRENDS_CBX="trends_cbx";const ID_PERCENT_CBX="percent_cbx";const ID_COLORS="colors";const ID_HIGHLIGHTFIELDSHOLDER="highlightfieldsholder";const ID_HIGHLIGHTFIELDS="highlightfields";let _this=this;$.extend(this,{debugChartOptions:false,useTestData:false,indexField:-1,curveType:'none',fontSize:0,showPercent:false,percentFields:null,});const SUPER=new RamaddaFieldsDisplay(displayManager,id,chartType,properties);let myProps=[{label:'Chart Style'},{p:'highlightFields',d:null,ex:'fields'},{p:'highlightShowFields',d:null,ex:'true'},{p:'highlightShowFieldsSize',d:"4",ex:'4'},{p:"acceptHighlightFieldsEvent",d:true,ex:'true'},{p:'highlightDim',d:'true',ex:'true',tt:'Dim the non highlight lines'},{p:'lineDashStyle',d:null,ex:'2,2,20,2,20'},{p:'highlight.lineDashStyle',d:'2,2,20,2,20',ex:'2,2,20,2,20'},{p:'nohighlight.lineDashStyle',d:'2,2,20,2,20',ex:'2,2,20,2,20'},{p:'some_field.lineDashStyle',d:'2,2,20,2,20',ex:'2,2,20,2,20'},{p:'labelInLegend',d:null,ex:'label'},{p:'highlight.labelInLegend',d:null,ex:'label'},{p:'nohighlight.labelInLegend',d:null,ex:'label'},{p:'some_field.labelInLegend',d:null,ex:'label'},{p:'seriesType',d:null,ex:'line|area|bars'},{p:'highlight.seriesType',d:null,ex:'line|area|bars'},{p:'nohighlight.seriesType',d:null,ex:'line|area|bars'},{p:'some_field.seriesType',d:null,ex:'line|area|bars'},{p:'pointSize',d:null,ex:'0'},{p:'highlight.pointSize',d:'0',ex:'4'},{p:'nohighlight.pointSize',d:'0',ex:'4'},{p:'some_field.pointSize',d:'4',ex:'4'},{p:'lineWidth',d:null,ex:null},{p:'highlight.lineWidth',d:null,ex:'2'},{p:'nohighlight.lineWidth',d:null,ex:'2'},{p:'some_field.lineWidth',d:'2',ex:'2'},{p:'highlight.color',d:null,ex:null},{p:'nohighlight.color',d:null,ex:null},{p:'some_field.color',d:null,ex:null},{p:'pointShape',d:null,ex:null},{p:'highlight.pointShape',d:null,ex:null},{p:'nohighlight.pointShape',d:null,ex:null},{p:'some_field.pointShape',d:null,ex:null},{label:'Trendlines'},{p:'showTrendline',d:null,ex:"true"},{p:"trendlineType",ex:"exponential"},{p:"trendlineVisibleInLegend",ex:"true"},{p:"trendlineColor",ex:""},{p:"trendlineLineWidth",ex:"true"},{p:"trendlineOpacity",ex:"0.3"}];defineDisplay(this,SUPER,myProps,{useDisplayMessage:function(){return true;},getContentsClass:function(){return"display-contents-inner display-"+this.type;},useChartableFields:function(){return true;},defaultSelectedToAll:function(){return false;},updateUI:function(args){let debug=false;args=args||{};SUPER.updateUI.call(this,args);if(debug)
console.log(this.type+".updateUI")
if(!this.getDisplayReady()){if(debug)
console.log("\tdisplay not ready");return;}
if(debug)
console.log("\tcalling displayData");if(args.dataFilterChanged){this.setDisplayMessage("Creating display...");setTimeout(()=>{this.displayData(args.reload,debug);},1);return;}
this.displayData(args.reload,debug);},getWikiAttributes:function(attrs){this.defineWikiAttributes(["vAxisMinValue","vAxisMaxValue"]);SUPER.getWikiAttributes.call(this,attrs);if(this.colorList.join(",")!="blue,red,green"){attrs.push("colors");attrs.push(this.getColorList().join(", "));}},initDialog:function(){SUPER.initDialog.call(this);let _this=this;let updateFunc=function(e){if(e&&e.which!=13&&e.which!=0){return;}
_this.vAxisMinValue=Utils.toFloat(_this.jq("vaxismin").val());_this.vAxisMaxValue=Utils.toFloat(_this.jq("vaxismax").val());_this.minDate=_this.jq("mindate").val();_this.maxDate=_this.jq("maxdate").val();_this.displayData();};["vaxismin","vaxismax","mindate","maxdate"].map(f=>{this.jq(f).blur(updateFunc);this.jq(f).keypress(updateFunc);});this.jq(ID_COLORS).keypress(function(e){if(e.which!=13){return;}
let v=_this.jq(ID_COLORS).val();_this.colorList=v.split(",");_this.displayData();let pointData=_this.dataCollection.getList();_this.getDisplayManager().handleEventPointDataLoaded(_this,_this.lastPointData);});this.jq(ID_TRENDS_CBX).click(function(){_this.showTrendLines=_this.jq(ID_TRENDS_CBX).is(':checked');_this.displayData();});this.jq(ID_PERCENT_CBX).click(function(){_this.showPercent=_this.jq(ID_PERCENT_CBX).is(':checked');_this.displayData();});},setColor:function(){let v=prompt("Enter comma separated list of colors to use",this.colorList.join(","));if(v!=null){this.colorList=v.split(",");this.displayData();let pointData=this.dataCollection.getList();this.getDisplayManager().handleEventPointDataLoaded(this,this.lastPointData);}},getVAxisMinValue:function(){return parseFloat(this.getProperty("vAxisMinValue",NaN));},getVAxisMaxValue:function(){return parseFloat(this.getProperty("vAxisMaxValue",NaN));},getHAxisMinValue:function(){return parseFloat(this.getProperty("hAxisMinValue",NaN));},getHAxisMaxValue:function(){return parseFloat(this.getProperty("hAxisMaxValue",NaN));},getMenuItems:function(menuItems){SUPER.getMenuItems.call(this,menuItems);let get=this.getGet();let min="0";if(!isNaN(this.getVAxisMinValue())){min=""+this.getVAxisMinValue();}
let max="";if(!isNaN(this.getVAxisMaxValue())){max=""+this.getVAxisMaxValue();}
let tmp=HU.formTable();tmp+=HU.formEntry("Axis Range:",HU.input("",min,["size","7",ATTR_ID,this.domId("vaxismin")])+" - "+
HU.input("",max,["size","7",ATTR_ID,this.domId("vaxismax")]));tmp+=HU.formEntry("Date Range:",HU.input("",this.minDate,["size","10",ATTR_ID,this.domId("mindate")])+" - "+
HU.input("",this.maxDate,["size","10",ATTR_ID,this.domId("maxdate")]));tmp+=HU.formEntry("Colors:",HU.input("",this.getColorList().join(","),["size","35",ATTR_ID,this.domId(ID_COLORS)]));tmp+="</table>";menuItems.push(tmp);},getChartType:function(){return this.getType();},askMinZAxis:function(){this.setMinZAxis(prompt("Minimum axis value","0"));},setMinZAxis:function(v){if(v!=null){this.vAxisMinValue=parseFloat(v);this.displayData();}},askMaxZAxis:function(){this.setMaxZAxis(prompt("Maximum axis value","100"));},setMaxZAxis:function(v){if(v!=null){this.vAxisMaxValue=parseFloat(v);this.displayData();}},askMinDate:function(){let ex=this.minDate;if(ex==null||ex==""){ex="1800-01-01";}
let v=prompt("Minimum date",ex);if(v==null)return;this.setMinDate(v);},setMinDate:function(v){this.minDate=v;this.displayData();},askMaxDate:function(){let ex=this.maxDate;if(ex==null||ex==""){ex="2100-01-01";}
let v=prompt("Maximum date",ex);if(v==null)return;this.setMaxDate(v);},setMaxDate:function(v){this.maxDate=v;this.displayData();},trendLineEnabled:function(){return false;},getDialogContents:function(tabTitles,tabContents){let height="600";let html=HU.div([ATTR_ID,this.domId(ID_FIELDS),STYLE,HU.css('overflow-y','auto','max-height',height+"px")]," FIELDS ");if(this.trendLineEnabled()){html+=HU.div([ATTR_CLASS,"display-dialog-subheader"],"Other");html+=HU.checkbox(this.domId(ID_TRENDS_CBX),[],this.getProperty("showTrendLines",false))+"  "+"Show trend line";html+=" ";html+=HU.checkbox(this.domId(ID_PERCENT_CBX),[],this.showPercent)+"  "+"Show percent of displayed total"+"<br>";html+="<br>";}
tabTitles.push("Fields");tabContents.push(html);SUPER.getDialogContents.call(this,tabTitles,tabContents);},okToHandleEventRecordSelection:function(){return true;},handleEventRecordHighlight:function(source,args){this.handleEventRecordSelection(source,args);},handleEventRecordSelection:function(source,args){SUPER.handleEventRecordSelection.call(this,source,args);if(source==this){return;}
if(!this.okToHandleEventRecordSelection()){return;}
let index=this.findMatchingIndex(args.record).index
if(index<0||!Utils.isDefined(index)){return;}
this.setChartSelection(index);},getFieldsToSelect:function(pointData){return pointData.getRecordFields();},canDoGroupBy:function(){return false;},clearCache:function(){},googleChartCallbackPending:false,includeIndexInData:function(){return false;},getGroupBy:function(){return this.getProperty("groupByField");},getIncludeIndexIfDate:function(){return false;},makeIndexValue:function(indexField,value,offset){if(indexField.isString()){return{v:offset,f:value};}
if(value&&value.getTime){return{v:value,f:this.formatDate(value)}}
return value;},getFieldsToDisplay:function(fields){return fields;},displayData:function(reload,debug){if(debug)
console.log(this.type+" displayData "+this.getId()+" "+this.type);let isExpanded=this.jq(ID_CHART).attr("isexpanded");let originalHeight=this.jq(ID_CHART).attr("original-height");if(isExpanded==="true"){this.setProperty("expandedHeight",this.jq(ID_CHART).css("height"));this.setProperty("isExpanded",true);this.setProperty("originalHeight",originalHeight);}else{this.setProperty("expandedHeight",null);this.setProperty("isExpanded",false);this.setProperty("originalHeight",null);}
if(!this.getDisplayReady()){if(debug)
console.log("\tdisplay not ready");return;}
if(this.inError){if(debug)
console.log("\tin error");return;}
if(!haveGoogleChartsLoaded()){if(debug)
console.log("\tgoogle charts have not loaded callback pending:"+this.googleChartCallbackPending);if(!this.googleChartCallbackPending){this.googleChartCallbackPending=true;this.setDisplayMessage(this.getLoadingMessage());setTimeout(()=>{this.googleChartCallbackPending=false;this.displayData();},10000);}
return;}
if(this.inError){return;}
if(!this.hasData()){this.clearChart();this.setDisplayMessage(this.getLoadingMessage());return;}
if(!this.getAcceptEventDataSelection()){this.setDisplayMessage("Creating display...");}
if(debug)
console.log("\tpointData #records:"+(!pointData?"NULL":pointData.getRecords().length));let records=this.filterData();let selectedFields=this.getSelectedFields();if(debug)
console.log("\tselectedFields:"+selectedFields);if(selectedFields.length==0&&this.lastSelectedFields!=null){selectedFields=this.lastSelectedFields;if(debug)
console.log("\tusing last selectedFields:"+selectedFields);}
if(selectedFields==null||selectedFields.length==0){if(this.getChartType()==DISPLAY_TABLE||this.getChartType()==DISPLAY_TREEMAP){selectedFields=this.dataCollection.getList()[0].getNonGeoFields();if(debug)
console.log("\tfields from data collection:"+selectedFields);}else{selectedFields=this.getSelectedFields();if(debug)
console.log("\tgetSelectedFields again:"+selectedFields);selectedFields=this.getSelectedFields();if(selectedFields.length==0){this.getFields().every(f=>{if(f.isNumeric()&&!f.isFieldGeo()){selectedFields=[f];return false;}
return true;});}}}
if(selectedFields.length==0){if(!this.getAcceptEventDataSelection()){this.setDisplayMessage("No fields selected");}
return;}
let tmpFields=[];for(let i=0;i<selectedFields.length;i++){if(!this.shouldSkipField(selectedFields[i])){tmpFields.push(selectedFields[i]);}}
selectedFields=tmpFields;if(debug)
console.log("\tsetting lastSelectedFields:"+selectedFields);this.lastSelectedFields=selectedFields;if(this.lastSelectedFields&&this.lastSelectedFields.length>0){this.jq(ID_TITLE_FIELD).html(this.lastSelectedFields[0].getLabel());}
let props={includeIndex:this.includeIndexInData()};props.groupByIndex=-1;let groupBy=this.getGroupBy();if(groupBy){this.getFields().every(field=>{if(field.getId()==groupBy){props.groupByIndex=field.getIndex();props.groupByField=field;return false;}
return true;});}
let fieldsToSelect=selectedFields;if(this.raw){fieldsToSelect=this.dataCollection.getList()[0].getRecordFields();props.raw=true;}
props.includeIndexIfDate=this.getIncludeIndexIfDate();let dataHasIndex=props.includeIndex;let t1=new Date();let dataList=this.getStandardData(this.getFieldsToDisplay(fieldsToSelect),props);let t2=new Date();if(debug)
console.log(this.type+" fields:"+fieldsToSelect.length+" dataList:"+dataList.length);if(dataList.length==0&&!this.userHasSelectedAField){let pointData=this.dataCollection.getList()[0];let chartableFields=this.getFieldsToSelect(pointData);for(let i=0;i<chartableFields.length;i++){let field=chartableFields[i];dataList=this.getStandardData([field],props);if(dataList.length>0){this.setSelectedFields([field]);break;}}}
if(dataList.length==0){this.setDisplayMessage(this.getNoDataMessage());return;}
if(this.showPercent){let newList=[];let isNumber=[];let isOk=[];let headerRow=null;let fields=null;if(this.percentFields!=null){fields=this.percentFields.split(",");}
for(let i=0;i<dataList.length;i++){let row=this.getDataValues(dataList[i]);if(i==0){headerRow=row;continue;}
if(i==1){let seenIndex=false;for(let j=0;j<row.length;j++){let valueIsNumber=(typeof row[j]=="number");let valueIsDate=(typeof row[j]=="object");if(valueIsNumber){if(dataHasIndex&&!seenIndex){valueIsNumber=false;seenIndex=true;}}
if(valueIsDate){seenIndex=true;}
if(valueIsNumber&&fields!=null){valueIsNumber=fields.indexOf(fieldsToSelect[j].getId())>=0||fields.indexOf("#"+(j+1))>=0;}
isNumber.push(valueIsNumber);}
let newHeader=[];for(let j=0;j<headerRow.length;j++){let v=headerRow[j];if(!isNumber[j]){newHeader.push(v);}else{newHeader.push("% "+v);}}
newList.push(newHeader);}
let total=0;let cnt=0;for(let j=0;j<row.length;j++){if(isNumber[j]){total+=parseFloat(row[j]);cnt++;}}
let newRow=[];for(let j=0;j<row.length;j++){if(isNumber[j]){if(total!=0){let v=parseFloat(((row[j]/total)*100).toFixed(1));newRow.push(v);}else{newRow.push(NaN);}}else{newRow.push(row[j]);}}
newList.push(newRow);}
dataList=newList;}
try{this.clearDisplayMessage();this.makeGoogleChart(dataList,props,selectedFields);}catch(e){console.log(this.type+" Error making chart:\n"+e+"\n"+e.stack);return;}
let container=this.jq(ID_CHART);if(this.jq(ID_CHART).is(':visible')){this.lastWidth=container.width();}else{this.lastWidth=-1;}
if(reload){let pointData=this.getData();if(pointData){let dataList=pointData.getRecords();if(dataList.length>0){let record=dataList[0];this.propagateEventRecordSelection({record:record});}}}},printDataList:function(dataList){console.log("data list:"+dataList.length);for(let i=0;i<dataList.length;i++){let row=dataList[i];let s="";for(let j=0;j<row.length;j++){if(j>0)s+=", ";s+=row[j];}
console.log("row: "+i+"  "+s);}},mapCharts:function(func){if(this.charts!=null){this.charts.map(chart=>{func(chart);});}},clearChart:function(){this.mapCharts(chart=>{if(chart.clearChart){chart.clearChart();}});},setChartSelection:function(index){this.mapCharts(chart=>{if(chart.setSelection){chart.setSelection([{row:index,column:null}]);}});},tableHeaderMouseover:function(i,tooltip){},doAddTooltip:function(){return true;},getAddStyle:function(){return true;},getAnnotationTemplate:function(){return this.getProperty("annotationTemplate");},getFormatNumbers:function(){return false;},getDataTableValueGetter:function(){return(v)=>{return v;}},getHighlightFields:function(){let p=this.getPropertyFromUrl("highlightFields");return Utils.split(this.getPropertyFromUrl("highlightFields"),",",true,true)||[];},handleEventPropertyChanged:function(source,prop){if(prop.property=="highlightFields"){if(this.getProperty("acceptHighlightFieldsEvent",true)){this.setProperty("highlightFields",prop.value);this.forceUpdateUI();let v=Utils.split(prop.value,",",true,true);this.jq(ID_HIGHLIGHTFIELDS).val(v);}
return;}
SUPER.handleEventPropertyChanged.call(this,source,prop);},makeSeriesInfo:function(dataTable){let seriesNames=[];for(let i=1;i<dataTable.getNumberOfColumns();i++){if(dataTable.getColumnRole(i)!="")continue;seriesNames.push(dataTable.getColumnLabel(i));}
let colors=this.getColorList();let highlightMap={};let highlightFields=this.getHighlightFields();let highlightDim=this.getProperty("highlightDim",false);highlightFields.forEach(f=>{highlightMap[f]=true});let seriesInfo={};let useMultipleAxes=this.getProperty("useMultipleAxes",true);seriesNames.forEach((name,idx)=>{name=name.replace(/\(.*\)/g,"");let id=Utils.makeId(name);let highlight=highlightMap[id];let s={};["labelInLegend ","seriesType","lineDashStyle","pointSize","lineWidth","color","pointShape"].forEach(a=>{let dflt=this.getProperty((highlight?"highlight.":"nohighlight.")+a,this.getProperty(a));let value=this.getProperty(id+"."+a,dflt);if(value&&a=="lineDashStyle"){let tmp=[];Utils.split(value,",",true,true).forEach(tok=>{tmp.push(parseFloat(tok));});value=tmp;}
if(a=="seriesType")a="type";s[a]=value;});if(!s.color)s.color=colors[idx%colors.length];if(highlightFields.length>0){if(!highlight&&highlightDim){s.color=Utils.pSBC(0.75,s.color);}}
if(useMultipleAxes){if(idx%2==0){s.targetAxisIndex=0;}else{s.targetAxisIndex=1;}}
seriesInfo[idx]=s;});if(this.getProperty("highlightShowFields",false)){if(this.jq(ID_HIGHLIGHTFIELDSHOLDER).length==0){this.jq(ID_HEADER2).append(HU.span([ID,this.domId(ID_HIGHLIGHTFIELDSHOLDER)]));}
if(this.jq(ID_HIGHLIGHTFIELDS).length==0){let seriesValues=[];seriesNames.forEach(n=>{seriesValues.push([Utils.makeId(n),n]);});seriesValues.sort((a,b)=>{return a[1].localeCompare(b[1]);});let highlightWidget=SPACE+HU.vbox(["Highlight",HU.select("",[ID,this.domId(ID_HIGHLIGHTFIELDS),"multiple","true","size",this.getProperty("highlightShowFieldsSize","3")],seriesValues,highlightFields)]);let select=HU.span([CLASS,"display-filter",STYLE,""],highlightWidget);this.jq(ID_HIGHLIGHTFIELDSHOLDER).html(select);this.jq(ID_HIGHLIGHTFIELDS).change(()=>{let v=Utils.makeArray(this.jq(ID_HIGHLIGHTFIELDS).val());v=Utils.join(v,",");this.setProperty("highlightFields",v);this.addToDocumentUrl("highlightFields",v);this.forceUpdateUI();let props={property:"highlightFields",value:v};this.propagateEvent(DisplayEvent.propertyChanged,props);});}}
return seriesInfo;},makeTrendlinesInfo:function(dataTable){let seriesNames=[];for(let i=1;i<dataTable.getNumberOfColumns();i++){if(dataTable.getColumnRole(i)!="")continue;seriesNames.push(dataTable.getColumnLabel(i));}
let trendlinesInfo={};seriesNames.forEach((name,idx)=>{let id=Utils.makeId(name);if(this.getProperty("showTrendline."+id,this.getProperty("showTrendline"))){let s={};trendlinesInfo[idx]=s;s.type=this.getProperty("trendlineType."+id,this.getProperty("trendlineType"));s.visibleInLegend=this.getProperty("trendlineVisibleInLegend."+id,this.getProperty("trendlineVisibleInLegend"));s.color=this.getProperty("trendlineColor."+id,this.getProperty("trendlineColor"));s.lineWidth=this.getProperty("trendlineLineWidth."+id,this.getProperty("trendlineLineWidth"));s.opacity=this.getProperty("trendlineOpacity."+id,this.getProperty("trendlineOpacity"));}});return trendlinesInfo;},makeDataTable:function(dataList,props,selectedFields,chartOptions){let dateType=this.getProperty("dateType","date");let debug=false||displayDebug.makeDataTable;let debugRows=4;if(debug)console.log(this.type+" makeDataTable #records"+dataList.length);if(debug)console.log("\tfields:"+selectedFields);let maxWidth=this.getProperty("maxFieldLength",this.getProperty("maxFieldWidth",-1));let tt=this.getProperty("tooltip");let addTooltip=(tt||this.getProperty("addTooltip",false))&&this.doAddTooltip();let addStyle=this.getAddStyle();let annotationTemplate=this.getAnnotationTemplate();let formatNumbers=this.getFormatNumbers();if(dataList.length==1){return google.visualization.arrayToDataTable(this.makeDataArray(dataList));}
let groupField=this.getFieldById(null,this.getProperty("groupBy"));if(groupField){dataList=this.filterData();let groupedData=[];let groupValues=[];let seen={};let cnt=0;let dateToValue={};let dates=[];dataList.map(record=>{if(cnt++==0)return;let values=this.getDataValues(record);let value=values[groupField.getIndex()];if(!seen[value]){seen[value]=true;seen[Utils.makeId(value)]=true;groupValues.push(value);}
let newValues=dateToValue[record.getDate()];if(!newValues){dates.push(record.getDate());newValues={};dateToValue[record.getDate()]=newValues;}
newValues[value]=values[selectedFields[0].getIndex()];});let data=[];let tmp=[];let highlightFields=this.getHighlightFields();let tmpMap={};highlightFields.forEach(f=>{if(seen[f]){tmp.push(Utils.makeLabel(f));}});groupValues=Utils.mergeLists(tmp,groupValues);groupValues=groupValues.filter(v=>{if(tmpMap[v])return false;tmpMap[v]=true;return true;});dates.map(date=>{let tuple=[this.getDateValue(date)];data.push(tuple);let valueMap=dateToValue[date];groupValues.map(group=>{let value=valueMap[group];tuple.push(value);});});let header=Utils.mergeLists(["Date"],groupValues);let dataTable=new google.visualization.DataTable();if(data.length>0){let tuple=data[0];tuple.forEach((t,idx)=>{let name=header[idx];let type=t==null?"number":(typeof t);if(type=="number")
dataTable.addColumn("number",name);else if(type=="string")
dataTable.addColumn("string",name);else if(t.getTime||(t.v&&t.v.getTime))
dataTable.addColumn("date",name);else{console.log("Unknown type:"+t);console.log(JSON.stringify(t,null,2));sdfdsfdf()}});}
dataTable.addRows(data);if(chartOptions){chartOptions.series=this.makeSeriesInfo(dataTable);chartOptions.trendlines=this.makeTrendlinesInfo(dataTable);}
return dataTable;}
let justData=[];let tooltipFields=this.getFieldsByIds(null,this.getProperty("tooltipFields",""));let dataTable=new google.visualization.DataTable();let header=this.getDataValues(dataList[0]);let sample=this.getDataValues(dataList[1]);let fixedValueS=this.getProperty("fixedValue");let fixedValueN;if(fixedValueS)fixedValueN=parseFloat(fixedValueS);let fIdx=0;let indexIsString=this.getProperty("indexIsString",this.getProperty("forceStrings",false));let maxHeaderLength=this.getProperty("maxHeaderLength",-1);let maxHeaderWidth=this.getProperty("maxHeaderWidth",-1);let headerStyle=this.getProperty("headerStyle");for(let j=0;j<header.length;j++){let field=null;if(j>0||!props.includeIndex){field=selectedFields[fIdx++];}else{}
let value=sample[j];let headerLabel=header[j];if(maxHeaderLength>0&&headerLabel.length>maxHeaderLength){let orig=headerLabel;headerLabel=headerLabel.substring(0,maxHeaderLength-1)+"...";headerLabel=HU.span([TITLE,orig],headerLabel);}
if(maxHeaderWidth>0||headerStyle){let orig=headerLabel;let style="";if(maxHeaderWidth>0)
headerLabel=headerLabel.replace(/ /g,"&nbsp;");if(maxHeaderWidth>0)
style+="max-width:"+maxHeaderWidth+"px;overflow-x:auto;";if(headerStyle)
style+=headerStyle;headerLabel=HU.div([TITLE,orig,STYLE,style],headerLabel);}
if(j==0&&props.includeIndex){if((typeof value)=="object"){if(typeof value.v=="number"){if(indexIsString)
dataTable.addColumn('string',headerLabel);else{dataTable.addColumn('number',headerLabel);}}else{dataTable.addColumn(dateType,headerLabel);}}else{dataTable.addColumn((typeof value),headerLabel);}}else{if(j>0&&fixedValueS){dataTable.addColumn('number',this.getProperty("fixedValueLabel","Count"));}else{if(field.isString()){dataTable.addColumn('string',headerLabel);}else if(field.isFieldDate()){dataTable.addColumn(dateType,headerLabel);}else{dataTable.addColumn('number',headerLabel);}}
if(annotationTemplate){dataTable.addColumn({type:'string',role:'annotation','p':{'html':true}});}
if(addStyle){if(debug)
console.log("add style column");dataTable.addColumn({type:'string',role:'style'});}
if(j>0&&fixedValueS){break;}}}
if(addTooltip){if(debug)
console.log("add tooltip column");dataTable.addColumn({type:'string',role:'tooltip','p':{'html':true}});}
if(debug){for(let i=0;i<dataTable.getNumberOfColumns();i++)
console.log("col["+i+"]="+dataTable.getColumnLabel(i)+" "+dataTable.getColumnType(i));}
if(this.getProperty("annotations")||this.getProperty("annotationFields")){let clonedList=Utils.cloneList(dataList);clonedList.shift();this.annotations=new Annotations(this,clonedList);if(this.annotations.hasFields()){dataTable.addColumn({type:'string',role:'annotation','p':{'html':true}});dataTable.addColumn({type:'string',role:'annotationText','p':{'html':true}});}}
if(this.annotations&&this.annotations.isEnabled()){if(this.annotations.getShowLegend()){this.jq(ID_LEGEND).html("<table width=100%><tr valign=top><td width=10%></td><td width=90%>"+
HU.div([CLASS,"display-chart-legend"],this.annotations.getLegend())
+"</td></tr></table>");}
dataTable.addColumn({type:'string',role:'annotation','p':{'html':true}});dataTable.addColumn({type:'string',role:'annotationText','p':{'html':true}});}
let annotationCnt=0;let records=[];for(let i=1;i<dataList.length;i++){records.push(dataList[i].record);}
let colors=this.getColorTable(true);let colorBy=this.getColorByInfo(records);let valueGetter=this.getDataTableValueGetter(records);let didColorBy=false;let tuples=[];for(let rowIdx=1;rowIdx<dataList.length;rowIdx++){let record=dataList[rowIdx];let row=this.getDataValues(record);let theRecord=record.record;let color="";if(colorBy.index>=0){let value=theRecord.getData()[colorBy.index];hasColorByValue=true;colorByValue=value;didColorBy=true;color=colorBy.getColorFromRecord(theRecord);}
row=row.slice(0);let label="";if(theRecord){for(let j=0;j<tooltipFields.length;j++){label+="<b>"+tooltipFields[j].getLabel()+"</b>: "+
theRecord.getValue(tooltipFields[j].getIndex())+"<br>";}}
let tooltip="";tooltip+=label;for(let j=0;j<row.length;j++){if(j>0)
tooltip+="<br>";label=header[j].replace(/ /g,"&nbsp;");value=row[j];if(!Utils.isDefined(value))value="NA";if(value&&(typeof value)=="object"){if(value.f){value=value.f;}}
if(Utils.isNumber(value)){value=this.formatNumber(value);}
value=""+value;value=value.replace(/ /g,SPACE);tooltip+=HU.b(label)+":"+SPACE+value;}
let newRow=[];if(debug&&rowIdx<debugRows)
console.log("row["+rowIdx+"]:");let fIdx=0;for(let colIdx=0;colIdx<row.length;colIdx++){let field=selectedFields[fIdx++];let value=row[colIdx];if(indexIsString){if(value.f)value=(value.f).toString().replace(/\n/g," ");}
if(colIdx>0&&fixedValueS){newRow.push(valueGetter(fixedValueN,colIdx,field,theRecord));if(debug&&rowIdx<debugRows)
console.log("\t fixed:"+fixedValueN);}else{let type=(typeof value);if(type=="number"){if(formatNumbers){value={v:value,f:String(this.formatNumber(value))};}}else if(type=="boolean"){value=String(value);}
if(debug&&rowIdx<debugRows){let v=value.f?("f:"+value.f+" v:"+value.v):value;console.log("\t value["+colIdx+"]="+v+" "+(typeof value));}
if(maxWidth>0&&type=="string"&&value.length>maxWidth)
value=value.substring(0,maxWidth)+"...";let o=valueGetter(value,colIdx,field,theRecord);newRow.push(o);}
if(colIdx==0&&props.includeIndex){}else{if(annotationTemplate){let v=annotationTemplate.replace("${value}",value.f||value);if(debug&&rowIdx<debugRows)
console.log("\t annotation"+v);newRow.push(v);}
if(addStyle){newRow.push(color);if(debug&&rowIdx<debugRows)
console.log("\t color:"+color);}}
if(colIdx>0&&fixedValueS){break;}}
if(addTooltip){if(tt){tooltip=this.getRecordHtml(theRecord,null,tt);}
tooltip=HU.div([STYLE,HU.css('padding','8px')],tooltip);newRow.push(tooltip);if(debug&&rowIdx<debugRows)
console.log("\t tooltip:");}
if(this.annotations&&this.annotations.hasFields()){if(theRecord){let desc="";this.annotations.getFields().forEach(f=>{let d=""+theRecord.getValue(f.getIndex());if(d!="")
desc+=(d+"<br>");});desc=desc.trim();desc=desc.replace(/ /g,"&nbsp;");annotationCnt++;let label=null;if(desc.trim().length>0){label=""+(this.annotations.labelField?theRecord.getValue(this.annotations.labelField.getIndex()):(annotationCnt))
if(label.trim().length==0)label=""+annotationCnt;}
debug=true;if(debug&&rowIdx<debugRows){console.log("\t label:"+label);console.log("\t desc:"+desc);}
debug=false;console.log("A2:"+label);newRow.push(label);newRow.push(desc);}else{if(i<2)
console.log("No records for annotation");}}
if(this.annotations&&this.annotations.isEnabled()){let annotations=this.annotations.getAnnotationsFor(rowIdx);if(annotations){if(debug&&rowIdx<debugRows){console.log("\t annotation:"+annotations);}
let label="";let desc="";annotations.forEach(a=>{if(label!="")label+="/";label+=a.label;if(desc!="")desc+="<br>";else{if(a.record&&a.record.getDate()){desc+=HU.b(this.formatDate(a.record.getDate()))+"<br>";}}
desc+=a.description;});newRow.push(label);newRow.push(desc);}else{if(debug&&rowIdx<debugRows){console.log("\t annotation:"+"null");console.log("\t desc:"+"null");}
newRow.push(null);newRow.push(null);}
debug=false;}
justData.push(newRow);}
if(debug)
console.log("#rows:"+justData.length);dataTable.addRows(justData);if(didColorBy){colorBy.displayColorTable();}
if(chartOptions){if(!chartOptions.isStacked){chartOptions.series=this.makeSeriesInfo(dataTable);}
chartOptions.trendlines=this.makeTrendlinesInfo(dataTable);}
return dataTable;},makeChartOptions:function(dataList,props,selectedFields){let chartOptions={tooltip:{isHtml:true,trigger:'both'},};$.extend(chartOptions,{width:"100%",lineWidth:this.getProperty("lineWidth",1),colors:this.getColorList(),curveType:this.curveType,pointShape:this.getProperty("pointShape"),pointSize:this.getProperty("pointSize"),vAxis:{}});chartOptions.backgroundColor={};chartOptions.chartArea={};chartOptions.chartArea.backgroundColor={};chartOptions.legend={textStyle:{}};chartOptions.hAxis={gridlines:{},minorGridlines:{},textStyle:{},};chartOptions.xannotations={textStyle:{fontSize:this.getProperty('annotationsFontSize',12),color:this.getProperty('annotationsTextColor')},stem:{color:this.getProperty('annotationsStemColor'),length:this.getProperty('annotationsStemLength'),},style:this.getProperty('annotationsStyle')};chartOptions.vAxis={gridlines:{},minorGridlines:{},textStyle:{}};chartOptions.hAxis.minValue=this.getProperty("hAxisMinValue");chartOptions.hAxis.maxValue=this.getProperty("hAxisMaxValue");chartOptions.vAxis.minValue=this.getProperty("vAxisMinValue");chartOptions.vAxis.maxValue=this.getProperty("vAxisMaxValue");chartOptions.vAxis.logScale=this.getProperty("vAxisLogScale",this.getProperty("logScale"));chartOptions.hAxis.logScale=this.getProperty("hAxisLogScale");chartOptions.hAxis.titleTextStyle={};chartOptions.vAxis.titleTextStyle={};if(this.getProperty("hAxisDateFormat")){chartOptions.hAxis.format=this.getProperty("hAxisDateFormat");}
let lineColor=this.getProperty("lineColor");let backgroundColor=this.getProperty("chartBackground");this.setPropertyOn(chartOptions.backgroundColor,"chart.fill","fill",backgroundColor);this.setPropertyOn(chartOptions.backgroundColor,"chart.stroke","stroke",this.getProperty("chartArea.fill",""));this.setPropertyOn(chartOptions.backgroundColor,"chart.strokeWidth","strokeWidth",null);this.setPropertyOn(chartOptions.chartArea.backgroundColor,"chartArea.fill","fill",backgroundColor);this.setPropertyOn(chartOptions.chartArea.backgroundColor,"chartArea.stroke","stroke",null);this.setPropertyOn(chartOptions.chartArea.backgroundColor,"chartArea.strokeWidth","strokeWidth",null);let minorGridLinesColor=this.getProperty("minorGridLines.color",this.getProperty("gridlines.color",lineColor||"transparent"));this.setPropertyOn(chartOptions.hAxis.gridlines,"hAxis.gridlines.color","color",this.getProperty("gridlines.color",lineColor));this.setPropertyOn(chartOptions.hAxis.minorGridlines,"hAxis.minorGridlines.color","color",minorGridLinesColor);this.setPropertyOn(chartOptions.hAxis,"hAxis.baselineColor","baselineColor",this.getProperty("baselineColor",lineColor));this.setPropertyOn(chartOptions.vAxis.gridlines,"vAxis.gridlines.color","color",this.getProperty("gridlines.color",lineColor));this.setPropertyOn(chartOptions.vAxis.minorGridlines,"vAxis.minorGridlines.color","color",minorGridLinesColor);this.setPropertyOn(chartOptions.vAxis,"vAxis.baselineColor","baselineColor",this.getProperty("baselineColor",lineColor));let textColor=this.getProperty("textColor","#000");let textBold=this.getProperty("textBold","false");this.setPropertyOn(chartOptions.hAxis.textStyle,"hAxis.text.color","color",this.getProperty("axis.text.color",textColor));this.setPropertyOn(chartOptions.vAxis.textStyle,"vAxis.text.color","color",this.getProperty("axis.text.color",textColor));this.setPropertyOn(chartOptions.hAxis.textStyle,"hAxis.text.bold","bold",textBold);this.setPropertyOn(chartOptions.vAxis.textStyle,"vAxis.text.bold","bold",textBold);chartOptions.vAxis.title=Utils.decodeText(this.getProperty("vAxis.text",this.getProperty("vAxisText")));chartOptions.hAxis.title=Utils.decodeText(this.getProperty("hAxis.text",this.getProperty("hAxisText")));chartOptions.hAxis.slantedText=this.getProperty("hAxis.slantedText",this.getProperty("slantedText",false));this.setPropertyOn(chartOptions.hAxis.titleTextStyle,"hAxis.text.color","color",textColor);this.setPropertyOn(chartOptions.vAxis.titleTextStyle,"vAxis.text.color","color",textColor);this.setPropertyOn(chartOptions.legend.textStyle,"legend.text.color","color",textColor);if(this.getProperty("hAxis.ticks")||this.getProperty("hAxis.ticks")==""){chartOptions.hAxis.ticks=Utils.split(this.getProperty("hAxis.ticks"),",",true,true);}
if(this.getProperty("vAxis.ticks")||this.getProperty("vAxis.ticks")==""){chartOptions.vAxis.ticks=Utils.split(this.getProperty("vAxis.ticks"),",",true,true);}
if(this.fontSize>0){chartOptions.fontSize=this.fontSize;}
let defaultRanges=[];let numeric=[];dataList.forEach((v,idx)=>{if(idx==0)return;let tuple=this.getDataValues(v);if(idx==1){tuple.forEach((tv,idx)=>{numeric.push((typeof tv)=="number");});numeric.forEach(v=>defaultRanges.push([Number.MAX_VALUE,Number.MIN_VALUE]));}
let cnt=0;tuple.forEach((tv,idx)=>{if(numeric[idx]){defaultRanges[cnt][0]=Math.min(defaultRanges[cnt][0],tv);defaultRanges[cnt][1]=Math.max(defaultRanges[cnt][1],tv);cnt++;}});});let range=[NaN,NaN];if(!isNaN(this.getVAxisMinValue())){range[0]=this.getVAxisMinValue();}else if(defaultRanges.length>0){if(this.getProperty("vAxisUseDefault")){range[0]=defaultRanges[0][0];}}
if(!isNaN(this.getVAxisMaxValue())){range[1]=this.getVAxisMaxValue();}else if(defaultRanges.length>0){}
if(!isNaN(range[0])){chartOptions.vAxis.minValue=range[0];}
if(!isNaN(range[1])){chartOptions.vAxis.maxValue=range[1];}
this.chartDimensions={width:"90%",left:"10%",right:10,}
useMultipleAxes=this.getProperty("useMultipleAxes",true);if((selectedFields.length>1&&useMultipleAxes)||this.getProperty("padRight",false)===true){this.chartDimensions.width="80%";}
if(this.getProperty("showTrendLines",false)){chartOptions.trendlines={0:{type:'linear',color:'green',}};}
let expandedHeight=this.getProperty("expandedHeight");if(expandedHeight){chartOptions.height=expandedHeight;}
if(this.getPropertyShow){this.getPropertyShow=false;Utils.makeDownloadFile("props.txt",this.getPropertyOutput);}
this.setContents(HU.div([ID,this.domId(ID_CHARTS)]));return chartOptions;},getChartHeight:function(){return this.getProperty("height");},getChartWidth:function(){return this.getProperty("width");},getChartDiv:function(chartId){let divAttrs=[ATTR_ID,chartId];let style="";let width=this.getChartWidth();if(false&&width){if(width.endsWith("%")){style+=HU.css("width",width);}else{if(width>0)
style+=HU.css("width",width+"px");else if(width<0)
style+=HU.css("width",(-width)+"%");else
style+=HU.css("width",width);}}else{}
let expandedHeight=this.getProperty("expandedHeight");let height=this.getChartHeight();if(expandedHeight){style+=HU.css("height",expandedHeight);}else{if(height){if(height>0)
style+=HU.css("height",height+"px");else if(height<0)
style+=HU.css("height",(-height)+"%");else
style+=HU.css("height",height);}else{style+=HU.css("height","100%");}}
divAttrs.push(STYLE);divAttrs.push(style);divAttrs.push(CLASS);divAttrs.push("ramadda-expandable-target");let isExpanded=this.getProperty("isExpanded");let originalHeight=this.getProperty("originalHeight");if(isExpanded){divAttrs.push("isexpanded","true")
divAttrs.push("original-height",originalHeight)}
if(this.getProperty("expandableHeight")){divAttrs.push("expandable-height");divAttrs.push(this.getProperty("expandableHeight"));}
return HU.div(divAttrs,"");},doMakeGoogleChart:function(dataList,props,chartDiv,selectedFields,chartOptions){throw new Error("doMakeGoogleChart undefined");},makeGoogleChart:function(dataList,props,selectedFields){try{this.doMakeGoogleChartInner(dataList,props,selectedFields);}catch(err){this.setErrorMessage("Error creating chart: "+err);console.log(this.type+" Error creating chart:"+err);console.log(err.stack);}},setAxisRanges:function(chartOptions,selectedFields,records){if(this.getProperty("hAxisFixedRange")){let x=this.getColumnValues(records,selectedFields[0]);chartOptions.hAxis.minValue=x.min;chartOptions.hAxis.maxValue=x.max;}
if(this.getProperty("vAxisFixedRange")||this.getProperty("vAxisSelectedFields")||this.getProperty("vAxisAllFields")){let min=Number.MAX_VALUE;let max=Number.MIN_VALUE;let fields=this.getProperty("vAxisAllFields")?this.getFields():selectedFields;fields.forEach(f=>{if(f.isFieldNumeric()){let y=this.getColumnValues(records,f);if(!isNaN(y.min))
min=Math.min(min,y.min);if(!isNaN(y.max))
max=Math.max(max,y.max);}});if(min!=Number.MAX_VALUE){chartOptions.vAxis.minValue=min;chartOptions.vAxis.maxValue=max;}}},doMakeGoogleChartInner:function(dataList,props,selectedFields){if(typeof google=='undefined'){this.setDisplayMessage("No google");return;}
this.chartOptions=this.makeChartOptions(dataList,props,selectedFields);this.chartOptions.bar={groupWidth:"95%"}
if(!Utils.isDefined(this.chartOptions.height)){this.chartOptions.height="100%";}
this.charts=[];this.chartCount=-1;let records=this.getPointData().getRecords();this.setAxisRanges(this.chartOptions,selectedFields,records);if(this.getProperty("doMultiCharts",this.getProperty("multipleCharts",false))){let multiField=this.getFieldById(null,this.getProperty("multiField"));let labelPosition=this.getProperty("multiChartsLabelPosition","bottom");let map={};let groups=[];let tmp=[];dataList.forEach((v,idx)=>{if(idx>0)tmp.push(v)});if(!multiField){tmp.sort(function(a,b){let v1=a.record?a.record.getDate():a.date;let v2=b.record?b.record.getDate():b.date;return v1.getTime()-v2.getTime();});}
dataList=Utils.mergeLists([dataList[0]],tmp);dataList.forEach((v,idx)=>{if(idx==0)return;let record=v.record;let groupValue=record?multiField?record.getValue(multiField.getIndex()):record.getDate():v.date;let list=null;list=map[groupValue];if(!list){list=[];map[groupValue]=list;groups.push(groupValue);}
list.push(v);})
this.jq(ID_CHARTS).html(HU.div([ID,this.domId(ID_CHARTS_INNER),STYLE,HU.css('text-align','center')]));let multiStyle="width:200px;"+this.getProperty("multiStyle","");let multiLabelTemplate=this.getProperty("multiLabelTemplate","${value}");if(multiField)groups.sort();groups.forEach((groupValue,idx)=>{this.chartCount=idx;let tmpDataList=[];let list=map[groupValue];tmpDataList.push(dataList[0]);tmpDataList=Utils.mergeLists(tmpDataList,list);let innerId=this.domId(ID_CHART)+"_"+this.chartCount;let label=groupValue;if(groupValue.getTime)label=this.formatDate(groupValue);label=multiLabelTemplate.replace("${value}",label);let header=HU.div([CLASS,"display-multi-header"],label);let top=labelPosition=="top"?header:"";let bottom=labelPosition=="bottom"?header:"";let div=HU.div([CLASS,"display-multi-div",STYLE,HU.css('display','inline-block')+multiStyle],top+this.getChartDiv(innerId)+bottom);this.jq(ID_CHARTS_INNER).append(div);let chart=this.makeGoogleChartInner(tmpDataList,innerId,props,selectedFields);if(chart)this.charts.push(chart);});}else{this.jq(ID_CHARTS).append(this.getChartDiv(this.domId(ID_CHART)));let chart=this.makeGoogleChartInner(dataList,this.domId(ID_CHART),props,selectedFields);if(chart)this.charts.push(chart);}
this.mapCharts(chart=>{google.visualization.events.addListener(chart,'onmouseout',()=>{this.setChartSelection(null)});});},makeGoogleChartInner:function(dataList,chartId,props,selectedFields){let chartDiv=document.getElementById(chartId);if(!chartDiv){console.log(this.type+".makeGoogleChart: no chart div found:"+chartId);return;}
let dataTable=this.makeDataTable(dataList,props,selectedFields,this.chartOptions);let chart=this.doMakeGoogleChart(dataList,props,chartDiv,selectedFields,this.chartOptions);if(chart==null)return null;if(!dataTable){this.setDisplayMessage(this.getNoDataMessage());return null;}
if(this.getProperty("vAxisSharedRange")){let max=NaN;for(let i=0;i<dataTable.getNumberOfColumns();i++){let minmax=dataTable.getColumnRange(i);if(!isNaN(minmax.max)&&minmax.max!=null&&(typeof minmax.max)=="number"){max=max==null||isNaN(max)?minmax.max:Math.max(max,minmax.max);}}
chartOptions.vAxis.maxValue=max;}
if(this.getProperty("animation",false,true)){this.chartOptions.animation={startup:true,duration:parseFloat(this.getProperty("animationDuration",1000,true)),easing:this.getProperty("animationEasing","linear",true)};HU.callWhenScrolled(this.domId(ID_CHART),()=>{if(!this.animationCalled){this.animationCalled=true;this.mapCharts(chart=>{chart.draw(dataTable,this.chartOptions);});}});}else{try{if(this.debugChartOptions)
console.log(JSON.stringify(this.chartOptions,null,2));this.chart=chart;this.dataTable=dataTable;let testData=google.visualization.arrayToDataTable([['Genre','Fantasy & Sci Fi','Western'],['2010',10,24],['2020',16,22],['2030',28,19]]);chart.draw(this.useTestData?testData:dataTable,this.chartOptions);}catch(err){this.setErrorMessage("Error creating chart: "+err);console.log(this.type+" Error creating chart:"+err);console.log(err.stack);return null;}}
this.addEvents(chart);return chart;},addEvents:function(chart){let _this=this;if(this.getProperty("propagateHighlightEvent")){google.visualization.events.addListener(chart,'onmouseover',function(event){pointData=_this.dataCollection.getList()[0];let fields=pointData.getRecordFields();let records=pointData.getRecords();let record=records[event.row];if(!record)return;_this.getDisplayManager().notifyEvent(DisplayEvent.recordHighlight,_this,{highlight:true,record:record});});}
google.visualization.events.addListener(chart,'select',function(event){_this.mapCharts(chart=>{if(chart.getSelection){let selected=chart.getSelection();if(selected&&selected.length>0){let index=selected[0].row;let record=_this.indexToRecord[index];if(record){let records=_this.getBinnedRecords(record);if(records){if(records.length==1){_this.propagateEventRecordSelection({record:records[0]});}else{_this.propagateEventRecordSelection({record:records[0],records:records});}}else{_this.propagateEventRecordSelection({record:record});}}}}});});}});}
function RamaddaAxisChart(displayManager,id,chartType,properties){let SUPER=new RamaddaGoogleChart(displayManager,id,chartType,properties);let myProps=[{label:'Chart Properties'},{p:'indexField',ex:'field',tt:'alternate field to use as index'},{p:'indexIsString',ex:'true',tt:'if index is a string set to true'},{p:'vAxisMinValue',ex:''},{p:'vAxisMaxValue',ex:''},{p:'vAxisSharedRange',ex:'true',tt:'use the same max value across all time series'},{p:"hAxisFixedRange"},{p:"vAxisSelectedFields",ex:'true',tt:'Use selected fields to find min/max for the range'},{p:"vAxisAllFields",ex:'true',tt:'Use all field values to find min/max for the range'},{p:'vAxisLogScale',ex:'true'},{p:'hAxisLogScale',ex:'true'},{p:'tooltipFields',ex:''},{p:'annotations',ex:'date,label,desc;date,label,desc;',tt:'e.g. 2008-09-29,A,Start of housing crash;2008-11-04,B,Obama elected;'},{p:'annotationFields',ex:''},{p:'annotationLabelField',ex:''},{p:'dateType',ex:'datetime'},{p:'addTooltip',ex:'false',tt:'Set this to false for multi-series charts if you only want the hovered series to show in the tt'},{inlineLabel:'Multiples Charts'},{p:'doMultiCharts',ex:'true'},{p:'multiField',ex:'field'},{p:'multiStyle',ex:''},{p:'multiLabelTemplate',ex:'${value}'},{p:'multiChartsLabelPosition',ex:'bottom|top|none'},{inlineLabel:'Chart Layout'},{p:'chartHeight',ex:''},{p:'chartWidth',ex:''},{p:'chartLeft',ex:'0'},{p:'chartRight',ex:'0'},{p:'chartTop',ex:'0'},{p:'chartBottom',ex:'0'},{p:'lineColor',ex:''},{p:'chartBackground',ex:''},{p:'chart.fill',ex:''},{p:'chartArea.fill',ex:''},{p:'chart.stroke',ex:''},{p:'chart.strokeWidth',ex:''},{p:'chartArea.fill',ex:''},{p:'chartArea.stroke',ex:''},{p:'chartArea.strokeWidth',ex:''},{p:'gridlines.color',ex:'transparent'},{p:'minorGridLines.color',ex:'transparent'},{p:'gridlines.color',ex:''},{p:'hAxis.gridlines.color',ex:''},{p:'hAxis.minorGridlines.color',ex:'transparent'},{p:'baselineColor',ex:''},{p:'hAxis.baselineColor',ex:''},{p:'gridlines.color',ex:''},{p:'vAxis.gridlines.color',ex:''},{p:'vAxis.minorGridlines.color',ex:'transparent'},{p:'baselineColor',ex:''},{p:'vAxis.baselineColor',ex:''},{p:'textColor',ex:'#000'},{p:'textBold',ex:'true'},{p:'axis.text.color',ex:'#000'},{p:'hAxis.text.color',ex:'#000'},{p:'axis.text.color',ex:'#000'},{p:'vAxis.text.color',ex:'#000'},{p:'hAxis.text.bold',ex:'false'},{p:'vAxis.text.bold',ex:'false'},{p:'vAxisText',ex:''},{p:'vAxis.text',ex:''},{p:'slantedText',ex:'true'},{p:'hAxis.slantedText',ex:''},{p:'hAxis.text.color',ex:'#000'},{p:'vAxis.text.color',ex:'#000'},{p:'legend.position',ex:'top|bottom|none'},{p:'legend.text.color',ex:'#000'},{p:'hAxis.ticks',ex:''},{p:'hAxis.ticks',ex:''},{p:'vAxis.ticks',ex:''},{p:'vAxis.ticks',ex:''},{p:'useMultipleAxes',ex:'true'},{p:'showTrendLines',ex:'true'},];defineDisplay(this,SUPER,myProps,{setChartArea:function(chartOptions){if(!chartOptions.chartArea){chartOptions.chartArea={};}
$.extend(chartOptions.chartArea,{left:this.getProperty("chartLeft",this.chartDimensions.left),right:this.getProperty("chartRight",this.chartDimensions.right),top:this.getProperty("chartTop","10"),bottom:this.getProperty("chartBottom"),height:this.getProperty("chartHeight","70%"),width:this.getProperty("chartWidth",this.chartDimensions.width),});["left","top","right","bottom"].forEach(a=>{let v=chartOptions.chartArea[a];if(v)v=String(v).replace("px","");chartOptions.chartArea[a]=v;});},makeChartOptions:function(dataList,props,selectedFields){chartOptions=SUPER.makeChartOptions.call(this,dataList,props,selectedFields);let dataFields=dataList[0].fields;let expandedHeight=this.getProperty("expandedHeight");chartOptions.height=expandedHeight||this.getProperty("chartHeight",this.getProperty("height","150"));if(!chartOptions.legend)
chartOptions.legend={};this.setPropertyOn(chartOptions.legend,"legend.position","position",this.getProperty("legendPosition",'bottom'));this.setChartArea(chartOptions);let useMultipleAxes=this.getProperty("useMultipleAxes",true);if(useMultipleAxes){chartOptions.series=[{targetAxisIndex:0},{targetAxisIndex:1}];}
if(chartOptions.legend.position=="left"){console.log(chartOptions.legend.position);chartOptions.series=[{targetAxisIndex:1}]}
if(!chartOptions.hAxis){chartOptions.hAxis={};}
if(!chartOptions.vAxis){chartOptions.vAxis={};}
chartOptions.hAxis.textPosition=this.getProperty("hAxisTextPosition","top");chartOptions.vAxis.textPosition=this.getProperty("vAxisTextPosition");if(this.getProperty("hAxisTitle")){chartOptions.hAxis.title=this.getProperty("hAxisTitle");}
if(this.getProperty("vAxisTitle")){chartOptions.vAxis.title=this.getProperty("vAxisTitle");if(chartOptions.vAxis.title&&dataFields){let label=dataFields.reduce((acc,v)=>{return acc+" "+v.getLabel();},"");chartOptions.vAxis.title=chartOptions.vAxis.title.replace("${fields}",label);}}
if(Utils.isDefined(this.chartHeight)){chartOptions.height=this.chartHeight;}
return chartOptions;}});}
function RamaddaSeriesChart(displayManager,id,chartType,properties){const SUPER=new RamaddaAxisChart(displayManager,id,chartType,properties);defineDisplay(this,SUPER,[],{includeIndexInData:function(){return this.getProperty("includeIndex",true);},trendLineEnabled:function(){return true;},});}
function BlankchartDisplay(displayManager,id,properties){const SUPER=new RamaddaSeriesChart(displayManager,id,"blankchart",properties);defineDisplay(addRamaddaDisplay(this),SUPER,[],{doMakeGoogleChart:function(dataList,props,chartDiv,selectedFields,chartOptions){return null;},});}
function LinechartDisplay(displayManager,id,properties){const SUPER=new RamaddaSeriesChart(displayManager,id,DISPLAY_LINECHART,properties);defineDisplay(addRamaddaDisplay(this),SUPER,[],{doMakeGoogleChart:function(dataList,props,chartDiv,selectedFields,chartOptions){return new google.visualization.LineChart(chartDiv);},});}
function AreachartDisplay(displayManager,id,properties){const SUPER=new RamaddaSeriesChart(displayManager,id,DISPLAY_AREACHART,properties);let myProps=[{label:'Area Chart Properties'},{p:'isStacked',ex:'true'}];defineDisplay(addRamaddaDisplay(this),SUPER,myProps,{doMakeGoogleChart:function(dataList,props,chartDiv,selectedFields,chartOptions){if(this.isStacked)
chartOptions.isStacked=true;return new google.visualization.AreaChart(chartDiv);}});}
function RamaddaBaseBarchart(displayManager,id,type,properties){const SUPER=new RamaddaSeriesChart(displayManager,id,type,properties);let myProps=[];defineDisplay(this,SUPER,myProps,{canDoGroupBy:function(){return true;},makeChartOptions:function(dataList,props,selectedFields){chartOptions=SUPER.makeChartOptions.call(this,dataList,props,selectedFields);let chartType=this.getChartType();if(chartType==DISPLAY_BARSTACK){chartOptions.series=null;chartOptions.isStacked=true;}
if(this.getProperty("barWidth")){let w=this.getProperty("barWidth");if(w=="flex"){if(dataList.length<100){w="10";}else{w=null;}}
if(w){chartOptions.bar={groupWidth:w}}}
chartOptions.orientation=this.getProperty("orientation","horizontal");return chartOptions;},doMakeGoogleChart:function(dataList,props,chartDiv,selectedFields,chartOptions){return new google.visualization.BarChart(chartDiv);}});}
function BarchartDisplay(displayManager,id,properties){const SUPER=new RamaddaBaseBarchart(displayManager,id,DISPLAY_BARCHART,properties);defineDisplay(addRamaddaDisplay(this),SUPER,[],{});}
function BarstackDisplay(displayManager,id,properties){properties=$.extend({"isStacked":true},properties);const SUPER=new RamaddaBaseBarchart(displayManager,id,DISPLAY_BARSTACK,properties);defineDisplay(addRamaddaDisplay(this),SUPER,[],{});}
function HistogramDisplay(displayManager,id,properties){const SUPER=new RamaddaGoogleChart(displayManager,id,DISPLAY_HISTOGRAM,properties);let myProps=[{label:'Histogram Properties'},{p:'legendPosition',ex:'none|top|right|left|bottom'},{p:'textPosition',ex:'out|in|none'},{p:'isStacked',ex:'false|true|percent|relative'},{p:'logScale',ex:'true|false'},{p:'scaleType',ex:'log|mirrorLog'},{p:'minValue',ex:''},{p:'maxValue',ex:''}];defineDisplay(addRamaddaDisplay(this),SUPER,myProps,{okToHandleEventRecordSelection:function(){return false;},makeDataTable:function(dataList,props,selectedFields){return google.visualization.arrayToDataTable(this.makeDataArray(dataList));},doMakeGoogleChart:function(dataList,props,chartDiv,selectedFields,chartOptions){if(this.legendPosition){if(!chartOptions.legend)
chartOptions.legend={};chartOptions.legend.position=this.legendPosition;}
let isStacked=this.getProperty("isStacked",null);if(isStacked)
chartOptions.isStacked=isStacked=="true"?true:isStacked=="false"?false:isStacked;chartOptions.vAxis={};chartOptions.vAxis.viewWindow={};if(Utils.isDefined(this.logScale)){chartOptions.vAxis.logScale=(""+this.logScale)==true;}
if(this.textPosition){chartOptions.vAxis.textPosition=this.textPosition;}
if(Utils.isDefined(this.minValue)){chartOptions.vAxis.viewWindow.min=parseFloat(this.minValue);}
if(Utils.isDefined(this.maxValue)){chartOptions.vAxis.viewWindow.max=parseFloat(this.maxValue);}
if(!isNaN(this.getVAxisMaxValue())){chartOptions.vAxis.maxValue=this.getVAxisMaxValue();}
if(!isNaN(this.getVAxisMinValue())){chartOptions.vAxis.minValue=parseFloat(this.getVAxisMinValue());}
if(!isNaN(this.getHAxisMaxValue())){chartOptions.hAxis.maxValue=this.getHAxisMaxValue();}
if(!isNaN(this.getHAxisMinValue())){chartOptions.hAxis.minValue=parseFloat(this.getHAxisMinValue());}
return new google.visualization.Histogram(chartDiv);},});}
function RamaddaTextChart(displayManager,id,chartType,properties){const SUPER=new RamaddaGoogleChart(displayManager,id,chartType,properties);defineDisplay(this,SUPER,[],{getFieldsToSelect:function(pointData){return pointData.getNonGeoFields();},});}
function PiechartDisplay(displayManager,id,properties){let ID_PIE_LEGEND="pielegend";const SUPER=new RamaddaTextChart(displayManager,id,DISPLAY_PIECHART,properties);let myProps=[{label:'Pie Chart Properties'},{p:'groupBy',ex:''},{p:'groupByCount',ex:'true'},{p:'groupByCountLabel',ex:''},{p:'binCount',ex:'true'},{p:'pieHole',ex:'0.5'},{p:'is3D',ex:'true'},{p:'bins',ex:''},{p:'binMin',ex:''},{p:'binMax',ex:'max'},{p:'sliceVisibilityThreshold',ex:'0.01'},{p:'pieSliceTextColor',ex:'black'},{p:'pieSliceBorderColor',ex:'black'}];defineDisplay(addRamaddaDisplay(this),SUPER,myProps,{uniqueValues:[],uniqueValuesMap:{},canDoGroupBy:function(){return true;},makeGoogleChart:function(dataList,props,selectedFields){this.uniqueValues=[];this.uniqueValuesMap={};SUPER.makeGoogleChart.call(this,dataList,props,selectedFields);if(!this.getProperty("showTopLegend"))return;let legend="";let colors=this.getColorList();let colorCnt=0;this.uniqueValues.map((v,idx)=>{if(colorCnt>=colors.length)colorCnt=0;let color=colors[colorCnt];legend+=HU.div([STYLE,HU.css('display','inline-block','width','8px','height','8px','background',color)])+SPACE+v+SPACE2;colorCnt++;});if(this.jq(ID_PIE_LEGEND).length==0){this.jq(ID_HEADER2).append(HU.div([ID,this.domId(ID_PIE_LEGEND)]));}
this.jq(ID_PIE_LEGEND).html(legend);},setChartSelection:function(index){},getGroupBy:function(){if(!this.groupBy&&this.groupBy!=""){let stringField=this.getFieldByType(this.getFields(),"string");if(stringField){this.groupBy=stringField.getId();}}
return this.groupBy;},getChartDiv:function(chartId){let divAttrs=[ATTR_ID,chartId];divAttrs.push(STYLE);let style="";let width=this.getProperty("chartWidth")||this.getChartWidth();let height=this.getProperty("chartHeight")||this.getChartHeight();if(width){if(width>0)
style+="width:"+width+"px;";else if(width<0)
style+="width:"+(-width)+"%;";else
style+="width:"+width+";";}else{style+="width:"+"100%;";}
if(height){if(height>0)
style+="height:"+height+"px;";else if(height<0)
style+="height:"+(-height)+"%;";else
style+="height:"+height+";";}else{style+="height:"+"100%;";}
style+="padding:5px;"
divAttrs.push(style);return HU.div(divAttrs,"");},doMakeGoogleChart:function(dataList,props,chartDiv,selectedFields,chartOptions){chartOptions.tooltip={textStyle:{color:'#000000',fontSize:12,},showColorCode:true,};this.chartOptions.legend={'position':this.getProperty("legendPosition",'right'),'alignment':'center'};if(this.getProperty("bins",null)){chartOptions.title="Bins: "+this.getDataValues(dataList[0])[1];}else if(this.getProperty("sumFields")){chartOptions.title=this.getProperty("chartTitle","Categories/Values");}else{chartOptions.title=this.getDataValues(dataList[0])[0]+" - "+this.getDataValues(dataList[0])[1];}
if(this.is3D){chartOptions.is3D=true;}
if(this.pieHole){chartOptions.pieHole=this.pieHole;}
if(this.sliceVisibilityThreshold){chartOptions.sliceVisibilityThreshold=this.sliceVisibilityThreshold;}
chartOptions.pieSliceBorderColor=this.getProperty("pieSliceBorderColor","transparent");chartOptions.pieSliceTextStyle={color:this.getProperty("pieSliceTextColor","white")};chartOptions.chartArea={};$.extend(chartOptions.chartArea,{left:this.getProperty("chartLeft",0),right:this.getProperty("chartRight",0),top:this.getProperty("chartTop",0),bottom:this.getProperty("chartBottom",0),width:'100%',height:'100%'});return new google.visualization.PieChart(chartDiv);},getColorList:function(){if(this.getProperty("colors")&&this.getProperty("colors")!="default"){return SUPER.getColorList.call(this);}
if(this.getProperty("colorTable")){let ct=this.getColorTable();return ct.colors;}
return Utils.mergeLists(Utils.getColorTable("schemeset1",true),Utils.getColorTable("schemecategory",true));},makeDataTable:function(dataList,props,selectedFields){let dataTable=new google.visualization.DataTable();let list=[];let header=this.getDataValues(dataList[0]);dataTable.addColumn("string",header[0]);dataTable.addColumn("number",header[1]);if(this.getProperty("bins",null)){let bins=parseInt(this.getProperty("bins",null));let min=Number.MAX_VALUE;let max=Number.MIN_VALUE;let haveMin=false;let haveMax=false;if(this.getProperty("binMin")){min=parseFloat(this.getProperty("binMin"));haveMin=true;}
if(this.getProperty("binMax")){max=parseFloat(this.getProperty("binMax"));haveMax=true;}
let goodValues=[];for(let i=1;i<dataList.length;i++){let tuple=this.getDataValues(dataList[i]);let value=tuple[1];if(!Utils.isRealNumber(value)){continue;}
if(!haveMin)
min=Math.min(value,min);if(!haveMax)
max=Math.max(value,max);goodValues.push(value);}
let binList=[];let step=(max-min)/bins;for(let binIdx=0;binIdx<bins;binIdx++){binList.push({min:min+binIdx*step,max:min+(binIdx+1)*step,values:[]});}
for(let rowIdx=0;rowIdx<goodValues.length;rowIdx++){let value=goodValues[rowIdx];let ok=false;for(let binIdx=0;binIdx<binList.length;binIdx++){if(value<binList[binIdx].min||(value>=binList[binIdx].min&&value<=binList[binIdx].max)){binList[binIdx].values.push(value);ok=true;break;}}
if(!ok){binList[binList.length-1].values.push(value);}}
for(let binIdx=0;binIdx<bins;binIdx++){let bin=binList[binIdx];list.push(["Bin:"+this.formatNumber(bin.min)+"-"+this.formatNumber(bin.max),bin.values.length]);}}else if(this.getProperty("sumFields")){dataTable=new google.visualization.DataTable();dataTable.addColumn("string","Category");dataTable.addColumn("number","Value");let records=this.filterData();let sumFields=this.getFieldsByIds(null,this.getProperty("sumFields"));let sums=[];sumFields.map(f=>{sums.push(0)});if(this.chartCount>=0){records=[records[this.chartCount]];}
records.map(record=>{sumFields.map((f,idx)=>{let v=record.getValue(f.getIndex());if(!isNaN(v))sums[idx]+=v;});});sumFields.map((f,idx)=>{list.push([f.getLabel(),sums[idx]>0?sums[idx]:0]);});}else{for(let i=1;i<dataList.length;i++){let tuple=this.getDataValues(dataList[i]);let s=""+(tuple.length==1?"#"+i:tuple[0]);let v=tuple.length==1?tuple[0]:tuple[1];list.push([s,v]);}}
list.map(tuple=>{let s=tuple[0];if(!this.uniqueValuesMap[s]){this.uniqueValuesMap[s]=true;this.uniqueValues.push(s);}});dataTable.addRows(list);return dataTable;}});}
function SankeyDisplay(displayManager,id,properties){this.tries=0;google.charts.load('49',{packages:['sankey']});const SUPER=new RamaddaTextChart(displayManager,id,DISPLAY_SANKEY,properties);defineDisplay(addRamaddaDisplay(this),SUPER,[],{doMakeGoogleChart:function(dataList,props,chartDiv,selectedFields,chartOptions){chartOptions.height=parseInt(this.getProperty("chartHeight",this.getProperty("height","400")));chartOptions.sankey={node:{colors:this.colors,width:5,},link:{colorMode:'source',colors:this.colors,color:{}}}
try{return new google.visualization.Sankey(chartDiv);}catch(e){if(this.tries++<5){setTimeout(()=>{this.callUpdateUI();},1000);}
return null;}},defaultSelectedToAll:function(){return true;},makeDataTable:function(dataList,props,selectedFields){if(!this.getProperty("doCategories",false)){let values=this.makeDataArray(dataList);return google.visualization.arrayToDataTable(values);}
let strings=[];for(let i=0;i<selectedFields.length;i++){let field=selectedFields[i];if(field.isFieldString()){strings.push(field);}}
let values=[];values.push(["characteristic 1","characteristic 2","value"]);for(let i=1;i<strings.length;i++){let field1=strings[i-1];let field2=strings[i];let cnts={};for(let r=1;r<dataList.length;r++){let row=this.getDataValues(dataList[r]);let value1=row[i-1];let value2=row[i];let key=value1+"-"+value2;if(!cnts[key]){cnts[key]={v1:value1,v2:value2,cnt:0}}
cnts[key].cnt++;}
for(a in cnts){values.push([cnts[a].v1,cnts[a].v2,cnts[a].cnt]);}}
return google.visualization.arrayToDataTable(values);}});}
function WordtreeDisplay(displayManager,id,properties){const SUPER=new RamaddaTextChart(displayManager,id,DISPLAY_WORDTREE,properties);let myProps=[{label:"Word Tree"},{p:"treeRoot",d:"root",tt:"Word to use for root"},{p:"wordColors",ex:"red,green,blue",tt:"Colors to use for tree levels"},{p:"fixedSize",d:"false",tt:""},{p:"buckets",ex:"100,110,115,120,130",tt:"For numeric fields the buckets to put the records in"},{p:"&lt;field&gt;.buckets",ex:"100,110,115,120,130",tt:"Specify buckets for a particular field"},{p:"bucketLabels",ex:"young,middle,old,really_old",tt:"For numeric fields the labels used for the buckets"},{p:"&lt;field&gt;.bucketLabels",ex:"young,middle,old,really_old",tt:"Specify bucket labels for a particular field"},];defineDisplay(addRamaddaDisplay(this),SUPER,myProps,{handleEventRecordSelection:function(source,args){},doMakeGoogleChart:function(dataList,props,chartDiv,selectedFields,chartOptions){if(this.getProperty("chartHeight"))
chartOptions.height=parseInt(this.getProperty("chartHeight"));if(this.getWordColors()){let tmp=this.getWordColors().split(",");let colors=[];for(let i=0;i<3&&i<tmp.length;i++){colors.push(tmp[i]);}
if(colors.length==3)
chartOptions.colors=colors;}
if(this.getProperty("chartWidth")){chartOptions.width=parseInt(this.getProperty("chartWidth"));}
chartOptions.wordtree={format:'implicit',wordSeparator:"_SEP_",word:this.getTreeRoot(),}
if(this.getProperty("maxFontSize")){chartOptions.maxFontSize=parseInt(this.getProperty("maxFontSize"));}
return new google.visualization.WordTree(chartDiv);},makeDataTable:function(dataList,props,selectedFields){let root=this.getTreeRoot();let records=this.filterData(null,selectedFields,{skipFirst:true});let fields=this.getSelectedFields(this.getData().getRecordFields());let valueField=this.getFieldById(null,this.getProperty("colorBy"));let values=[];let typeTuple=["phrases"];values.push(typeTuple);let fixedSize=this.getFixedSize();if(valueField)
fixedSize=1;if(fixedSize)typeTuple.push("size");if(valueField)
typeTuple.push("value");let fieldInfo={};let header="";for(let i=0;i<fields.length;i++){let field=fields[i];if(header!="")
header+=" -&gt;";header+=field.getLabel();if(!field.isFieldNumeric())continue;let column=this.getColumnValues(records,field);let buckets=[];let argBuckets=this.getProperty("buckets."+field.getId(),this.getProperty("buckets",null));let min,max;if(argBuckets){let argBucketLabels=this.getProperty("bucketLabels."+field.getId(),this.getProperty("bucketLabels",null));let bucketLabels;if(argBucketLabels)
bucketLabels=argBucketLabels.split(",");let bucketList=argBuckets.split(",");let prevValue=0;for(let bucketIdx=0;bucketIdx<bucketList.length;bucketIdx++){let v=parseFloat(bucketList[bucketIdx]);if(bucketIdx==0){min=v;max=v;}
min=Math.min(min,v);max=Math.max(max,v);if(bucketIdx>0){let label;if(bucketLabels&&i<=bucketLabels.length)
label=bucketLabels[bucketIdx-1];else
label=Utils.formatNumber(prevValue,true)+"-"+Utils.formatNumber(v,true);buckets.push({min:prevValue,max:v,label:label});}
prevValue=v;}}else{let numBuckets=parseInt(this.getProperty("numBuckets."+field.getId(),this.getProperty("numBuckets",10)));min=column.min;max=column.max;let step=(column.max-column.min)/numBuckets;for(let bucketIdx=0;bucketIdx<numBuckets;bucketIdx++){let r1=column.min+(bucketIdx*step);let r2=column.min+((bucketIdx+1)*step);let label=Utils.formatNumber(r1,true)+"-"+Utils.formatNumber(r2,true);buckets.push({min:r1,max:r2,label:label});}}
fieldInfo[field.getId()]={min:min,max:max,buckets:buckets};}
let sep="_SEP_";for(let rowIdx=0;rowIdx<records.length;rowIdx++){let row=this.getDataValues(records[rowIdx]);let string=root;for(let fieldIdx=0;fieldIdx<fields.length;fieldIdx++){let field=fields[fieldIdx];string+=sep;let value=row[field.getIndex()];if(field.isFieldNumeric()){let info=fieldInfo[field.getId()];for(let bucketIdx=0;bucketIdx<info.buckets.length;bucketIdx++){let bucket=info.buckets[bucketIdx];if(value>=bucket.min&&value<=bucket.max){value=bucket.label;break;}}}
string+=value;}
let data=[string.trim()];if(fixedSize)data.push(parseInt(fixedSize));if(valueField)
data.push(row[valueField.getIndex()]);values.push(data);}
if(this.getProperty("header")){header=this.getProperty("header","");}else{header="<b>Fields: </b>"+header;if(this.getProperty("headerPrefix"))
header=this.getProperty("headerPrefix")+" "+header;}
this.writeHtml(ID_DISPLAY_TOP,header);return google.visualization.arrayToDataTable(values);},});}
function TableDisplay(displayManager,id,properties){const SUPER=new RamaddaTextChart(displayManager,id,DISPLAY_TABLE,properties);let myProps=[{label:'Table'},{p:'imageField',ex:''},{p:'tableWidth',ex:'100%'},{p:'frozenColumns',ex:'1'},{p:'colorCells',ex:'field1,field2'},{p:'foregroundColor'},{p:'showRowNumber',ex:true},{p:'field.colorTable',ex:''},{p:'field.colorByMap',ex:'value1:color1,value2:color2'},{p:'maxHeaderLength',ex:'60'},{p:'maxHeaderWidth',ex:'60'},{p:'headerStyle'}];defineDisplay(addRamaddaDisplay(this),SUPER,myProps,{canDoGroupBy:function(){return true;},defaultSelectedToAll:function(){return true;},getDataTableValueGetter:function(records){let unhighlightColor=this.getProperty("unhighlightColor","#fff");let highlightColor=this.getProperty("highlightColor","#FFFFCC");let colorCells=this.getProperty("colorCells");let colorByMap={};let linkField=this.getFieldById(null,this.getProperty("linkField"));let iconField=this.getFieldById(null,this.getProperty("iconField"));let foreground=this.getProperty("foregroundColor");let cbs=[];if(colorCells){colorCells.split(",").forEach(c=>{let f=this.getFieldById(null,c);if(f){colorByMap[c]=new ColorByInfo(this,null,records,null,c+".colorByMap",null,c,f);cbs.push(colorByMap[c]);}});}
let dom=this.jq(ID_COLORTABLE);cbs.forEach((cb,idx)=>{let id=this.domId(ID_COLORTABLE+idx);dom.append(HU.div([ID,id]));cb.displayColorTable(null,true,ID_COLORTABLE+idx);});return(v,idx,field,record)=>{if(v===null){return{v:0,f:""}}
let f=v;if(v.f){f=v.f;v=v.v;}
if(v.getTime){f=this.formatDate(v);}
if(iconField&&record&&idx==0){let icon=record.getValue(iconField.getIndex());f=HU.image(icon)+"&nbsp;"+f;}
if(linkField&&record&&idx==0){let url=record.getValue(linkField.getIndex());if(f)f=f.trim();if(Utils.isDefined(f)&&f!=""){f=HU.href(url,f);}}
if(!this.getFilterHighlight()||!record){f=HU.div([STYLE,HU.css('padding','4px')],f)}else{let c=record.isHighlight(this)?highlightColor:unhighlightColor;f=HU.div([STYLE,HU.css('padding','4px','background',c)],f)}
if(field){let colorBy=colorByMap[field.getId()];if(colorBy&&record){let color=colorBy.getColorFromRecord(record);let fg=foreground||Utils.getForegroundColor(color);f=HU.div([STYLE,HU.css('height','100%','background',color,'color',fg+" !important")],f)}
if(field.getType()=="url"){return{v:v,f:HU.href(v,v)};}
if(field.getType()=="image"){return{v:v,f:HU.href(v,HU.image(v,[WIDTH,this.getProperty("imageWidth",100)]))};}}
return{v:v,f:f};}},doMakeGoogleChart:function(dataList,props,chartDiv,selectedFields,chartOptions){let expandedHeight=this.getProperty("expandedHeight");if(!expandedHeight){chartOptions.height=null;if(this.chartHeight){chartOptions.height=this.chartHeight;}
if(chartOptions.height==null){let height=this.getProperty("height",null);if(height){chartOptions.height=height;}}
if(chartOptions.height==null){chartOptions.height="300px";}}
if(this.debugChartOptions)
console.log(JSON.stringify(chartOptions,null,2));chartOptions.allowHtml=true;if(this.getProperty("tableWidth"))
chartOptions.width=this.getProperty("tableWidth");chartOptions.frozenColumns=this.getProperty("frozenColumns",0);chartOptions.showRowNumber=this.getProperty("showRowNumber",false);if(dataList.length&&this.getDataValues(dataList[0]).length>4){chartOptions.cssClassNames={headerCell:'display-table-header-max'};}else{chartOptions.cssClassNames={headerCell:'display-table-header'};}
if(!chartOptions.cssClassNames)
chartOptions.cssClassNames={};if(this.getProperty("fixCellHeight",true)){chartOptions.cssClassNames.headerCell='display-table-cell';chartOptions.cssClassNames.tableCell='display-table-cell';}
return new google.visualization.Table(chartDiv);},doAddTooltip:function(){return false;},getAddStyle:function(){return false;},getFormatNumbers:function(){return true;},formatNumber:function(n){if(isNaN(n))
return this.getProperty("nanValue","--");return SUPER.formatNumber.call(this,n);},xxxxmakeDataTable:function(dataList,props,selectedFields){let rows=this.makeDataArray(dataList);let data=[];for(let rowIdx=0;rowIdx<rows.length;rowIdx++){let row=rows[rowIdx];for(let colIdx=0;colIdx<row.length;colIdx++){let t=(typeof row[colIdx]);if(t=="string"){row[colIdx]=row[colIdx].replace(/\n/g,"<br>");if(row[colIdx].startsWith("http:")||row[colIdx].startsWith("https:")){row[colIdx]="<a href='"+row[colIdx]+"'>"+row[colIdx]+"</a>";}}else if(t=="number"){if(isNaN(row[colIdx]))
row[colIdx]="--";}}
data.push(row);}
return google.visualization.arrayToDataTable(data);}});}
function BubbleDisplay(displayManager,id,properties){const SUPER=new RamaddaTextChart(displayManager,id,DISPLAY_BUBBLE,properties);let myProps=[{label:'Bubble Chart Attibutes'},{p:'xField'},{p:'yField'},{p:'labelField'},{p:'colorBy'},{p:'sizeField'},{p:'legendPosition',ex:'none|top|right|left|bottom'},{p:'hAxisFormat',ex:'none|decimal|scientific|percent|short|long'},{p:'vAxisFormat',ex:'none|decimal|scientific|percent|short|long'},{p:'hAxisTitle',ex:''},{p:'vAxisTitle',ex:''}];defineDisplay(addRamaddaDisplay(this),SUPER,myProps,{getChartDiv:function(chartId){let divAttrs=[ATTR_ID,chartId];divAttrs.push(STYLE);let style="";let width=this.getProperty("chartWidth")||this.getChartWidth();let height=this.getProperty("chartHeight")||this.getChartHeight();if(width){if(width>0)
style+="width:"+width+"px;";else if(width<0)
style+="width:"+(-width)+"%;";else
style+="width:"+width+";";}else{style+="width:"+"100%;";}
if(height){if(height>0)
style+="height:"+height+"px;";else if(height<0)
style+="height:"+(-height)+"%;";else
style+="height:"+height+";";}else{style+="height:"+"100%;";}
style+="padding:5px;"
divAttrs.push(style);return HU.div(divAttrs,"");},getFieldsToDisplay:function(fields){if(fields.length>=4)return fields;let labelField=this.getFieldById(null,this.getProperty("labelField"));let colorField=this.getFieldById(null,this.getColorBy(this.getProperty("colorField")));let sizeField=this.getFieldById(null,this.getProperty("sizeField"));let xField=this.getFieldById(null,this.getProperty("xField"));let yField=this.getFieldById(null,this.getProperty("yField"));if(!labelField)throw new Error("Need to specify labelField");if(!xField)throw new Error("Need to specify xField");if(!yField)throw new Error("Need to specify yField");let f=[labelField,xField,yField];if(colorField)f.push(colorField);if(sizeField)f.push(sizeField);return f;},makeDataTable:function(dataList,props,selectedFields,chartOptions){let debug=displayDebug.makeDataTable;if(debug){console.log(this.type+" makeDataTable #records:"+dataList.length);let fields=this.getSelectedFields();console.log("\t fields:"+fields);}
let tmp=[];let a=this.makeDataArray(dataList);while(a[0].length<5)
a[0].push("");tmp.push(a[0]);this.didUnhighlight=false;let minColorValue=Number.MAX_SAFE_INTEGER;for(let i=1;i<a.length;i++){let tuple=a[i];while(tuple.length<5){tuple.push(1);}
minColorValue=Math.min(minColorValue,tuple[3]);}
for(let i=1;i<a.length;i++){let tuple=a[i];while(tuple.length<5)
tuple.push(1);if(debug&&i<5)
console.log("\tdata:"+tuple);let ok=true;for(j=1;j<tuple.length&&ok;j++){if(isNaN(tuple[j]))ok=false;}
if(this.getFilterHighlight()){let unhighlightColor=this.getProperty("unhighlightColor","#eee");if(dataList[i].record&&!dataList[i].record.isHighlight(this)){this.didUnhighlight=true;tuple[3]=minColorValue-0.111;}}
if(ok)
tmp.push(tuple);}
return google.visualization.arrayToDataTable(tmp);},doMakeGoogleChart:function(dataList,props,chartDiv,selectedFields,chartOptions){let ct=this.getColorTable(true);if(ct){chartOptions.colors=ct;}else if(!this.colors){chartOptions.colors=this.getColorList();}
if(chartOptions.colors){chartOptions.colors=Utils.getColorTable("rainbow",true);}
$.extend(chartOptions.chartArea,{left:this.getProperty("chartLeft",this.chartDimensions.left),right:this.getProperty("chartRight",this.chartDimensions.right),top:this.getProperty("chartTop","10"),bottom:this.getProperty("chartBottom",40),height:this.getProperty("chartHeight",'200')});chartOptions.height="100px";chartOptions.sizeAxis={}
chartOptions.colorAxis={legend:{position:this.getProperty("legendPosition","in")}}
let colorTable=this.getColorTable(true);if(colorTable){chartOptions.colorAxis.colors=colorTable;if(this.didUnhighlight){chartOptions.colorAxis.colors=[...chartOptions.colorAxis.colors];chartOptions.colorAxis.colors.unshift(this.getProperty("unhighlightColor","#eee"));}}
chartOptions.bubble={textStyle:{auraColor:"none"},stroke:"#666"};header=this.getDataValues(dataList[0]);chartOptions.hAxis=chartOptions.hAxis||{};chartOptions.vAxis=chartOptions.vAxis||{};chartOptions.hAxis.minValue=this.getProperty("hAxisMinValue");chartOptions.hAxis.maxValue=this.getProperty("hAxisMaxValue");chartOptions.vAxis.minValue=this.getProperty("vAxisMinValue");chartOptions.vAxis.maxValue=this.getProperty("vAxisMaxValue");let records=this.getPointData().getRecords();if(this.getProperty("hAxisFixedRange")){let x=this.getColumnValues(records,selectedFields[1]);chartOptions.hAxis.minValue=x.min;chartOptions.hAxis.maxValue=x.max;}
if(this.getProperty("vAxisFixedRange")){let y=this.getColumnValues(records,selectedFields[2]);chartOptions.vAxis.minValue=y.min;chartOptions.vAxis.maxValue=y.max;}
chartOptions.vAxis.viewWindowMode=this.getProperty("viewWindowMode","pretty");chartOptions.hAxis.viewWindowMode=this.getProperty("viewWindowMode","pretty");chartOptions.hAxis.format=this.getProperty("hAxisFormat",null);chartOptions.vAxis.format=this.getProperty("vAxisFormat",null);chartOptions.hAxis.title=this.getProperty("hAxisTitle",header.length>1?header[1]:null);chartOptions.vAxis.title=this.getProperty("vAxisTitle",header.length>2?header[2]:null);return new google.visualization.BubbleChart(chartDiv);}});}
function BartableDisplay(displayManager,id,properties){const SUPER=new RamaddaSeriesChart(displayManager,id,DISPLAY_BARTABLE,properties);defineDisplay(addRamaddaDisplay(this),SUPER,[],{doMakeGoogleChart:function(dataList,props,chartDiv,selectedFields,chartOptions){let height="";if(Utils.isDefined(this.chartHeight)){height=this.chartHeight;}else{if(dataList.length>1){let numBars=dataList.length;if(this.isStacked){height=numBars*22;}else{height=numBars*22+numBars*14*(this.getDataValues(dataList[0]).length-2);}}}
$.extend(chartOptions,{title:"the title",bars:'horizontal',colors:this.getColorList(),width:(Utils.isDefined(this.chartWidth)?this.chartWidth:"100%"),chartArea:{left:'30%',top:0,width:'70%',height:'80%'},height:height,bars:'horizontal',tooltip:{showColorCode:true,},legend:{position:'none'},});if(Utils.isDefined(this.isStacked)){chartOptions.isStacked=this.isStacked;}
if(this.hAxis)
chartOptions.hAxis={title:this.hAxis};if(this.vAxis)
chartOptions.vAxis={title:this.vAxis};return new google.charts.Bar(chartDiv);},getDefaultSelectedFields:function(fields,dfltList){let f=[];for(i=0;i<fields.length;i++){let field=fields[i];if(!field.isNumeric()){f.push(field);break;}}
for(i=0;i<fields.length;i++){let field=fields[i];if(field.isNumeric()){f.push(field);break;}}
return f;}});}
function TreemapDisplay(displayManager,id,properties){const SUPER=new RamaddaTextChart(displayManager,id,DISPLAY_TREEMAP,properties);defineDisplay(addRamaddaDisplay(this),SUPER,[],{handleEventRecordSelection:function(source,args){},getFieldsToSelect:function(pointData){return pointData.getRecordFields();},tooltips:{},makeChartOptions:function(dataList,props,selectedFields){let _this=this;let tooltip=function(row,size,value){if(_this.tooltips[row]){return _this.tooltips[row];}
return"<div class='display-treemap-tooltip-outer'><div class='display-treemap-tooltip''><i>left-click: go down<br>right-click: go up</i></div></div>";};let chartOptions=SUPER.makeChartOptions.call(this,dataList,props,selectedFields);$.extend(chartOptions,{highlightOnMouseOver:true,generateTooltip:tooltip,maxDepth:parseInt(this.getProperty("maxDepth",2)),maxPostDepth:parseInt(this.getProperty("maxPostDepth",3)),});return chartOptions;},defaultSelectedToAll:function(){return true;},doMakeGoogleChart:function(dataList,props,chartDiv,selectedFields,chartOptions){let dataTable=this.makeDataTable(dataList,props,selectedFields,chartOptions);if(!dataTable)return null;return new google.visualization.TreeMap(chartDiv);},addTuple:function(data,colorField,seen,value,parent,n1,n2){let ovalue=value;let cnt=0;if(Utils.isDefined(seen[value])&&parent){value=parent+":"+value;}
while(true){if(!Utils.isDefined(seen[value])){seen[value]=true;break;}
value=ovalue+" "+(++cnt);}
let tuple=[value,parent,n1];if(colorField)tuple.push(n2);data.push(tuple);return value;},valueClicked:function(field,value){field=this.getFieldById(this.getFields(),field);this.propagateEvent("fieldValueSelected",{field:field,value:value});},makeDataTable:function(dataList,props,selectedFields){let records=this.filterData(null,null,{skipFirst:true});if(!records){return null;}
let allFields=this.getFields();let fields=this.getSelectedFields(allFields);if(fields.length==0)
fields=allFields;let strings=this.getFieldsByType(fields,"string");if(strings.length<2){this.displayError("No string fields specified");return null;}
let addPrefix=this.getProperty("addPrefix",true);let sizeField=this.getFieldById(allFields,this.getProperty("sizeBy"));let colorField=this.getFieldById(allFields,this.getProperty("colorBy"));let values=this.getFieldsByType(fields,"numeric");if(!sizeField&&values.length>0)
sizeField=values[0];if(!colorField&&values.length>1)
colorField=values[1];let tooltipFields=[];let toks=this.getProperty("tooltipFields","").split(",");for(let i=0;i<toks.length;i++){let tooltipField=this.getFieldById(null,toks[i]);if(tooltipField)
tooltipFields.push(tooltipField);}
if(tooltipFields.length==0)tooltipFields=allFields;this.tooltips={};let columns=[];for(let fieldIndex=0;fieldIndex<strings.length;fieldIndex++){let field=strings[fieldIndex];columns.push(this.getColumnValues(records,field).values);}
let data=[];let leafs=[];let tmptt=[];let seen={};this.addTuple(data,colorField,{},"Node","Parent","Value","Color");let root=strings[0].getLabel();this.addTuple(data,colorField,seen,root,null,0,0);let keys={};let call=this.getGet();for(let rowIdx=0;rowIdx<records.length;rowIdx++){let row=this.getDataValues(records[rowIdx]);let key="";let parentKey="";for(let fieldIndex=0;fieldIndex<strings.length-1;fieldIndex++){let values=columns[fieldIndex];if(key!="")
key+=":";key+=values[rowIdx];if(!Utils.isDefined(keys[key])){let parent=Utils.isDefined(keys[parentKey])?keys[parentKey]:root;let value=values[rowIdx];if(addPrefix&&fieldIndex>0)
value=parent+":"+value;keys[key]=this.addTuple(data,colorField,seen,value,parent,0,0);}
parentKey=key;}
let parent=Utils.isDefined(keys[parentKey])?keys[parentKey]:root;let value=row[strings[strings.length-1].getIndex()];let size=sizeField?row[sizeField.getIndex()]:1;let color=colorField?row[colorField.getIndex()]:0;value=this.addTuple(leafs,colorField,seen,value,parent,size,color);let tt="<div class='display-treemap-tooltip-outer'><div class='display-treemap-tooltip''>";for(let f=0;f<tooltipFields.length;f++){let v=row[tooltipFields[f].getIndex()];let field=tooltipFields[f];v=HU.onClick(call+".valueClicked('"+field.getId()+"','"+v+"')",v,[]);tt+=HU.b(field.getLabel())+": "+v+"<br>";}
tt+="</div></div>";tmptt.push(tt);}
for(let i=0;i<leafs.length;i++){data.push(leafs[i]);this.tooltips[data.length-2]=tmptt[i];}
return google.visualization.arrayToDataTable(data);},});}
function TimerangechartDisplay(displayManager,id,properties){const SUPER=new RamaddaTextChart(displayManager,id,DISPLAY_TIMERANGECHART,properties);defineDisplay(addRamaddaDisplay(this),SUPER,[],{doMakeGoogleChart:function(dataList,props,chartDiv,selectedFields,chartOptions){return new google.visualization.Timeline(chartDiv);},makeDataTable:function(dataList,props,selectedFields){let records=this.filterData(null,null,{skipFirst:true});let strings=[];let stringField=this.getFieldByType(selectedFields,"string");if(!stringField)
stringField=this.getFieldByType(null,"string");let showLabel=this.getProperty("showLabel",true);let labelFields=[];let labelFieldsTemplate=this.getProperty("labelFieldsTemplate");let toks=this.getProperty("labelFields","").split(",");for(let i=0;i<toks.length;i++){let field=this.getFieldById(null,toks[i]);if(field)
labelFields.push(field);}
let dateFields=this.getFieldsByType(selectedFields,"date");if(dateFields.length==0)
dateFields=this.getFieldsByType(null,"date");let values=[];let dataTable=new google.visualization.DataTable();if(dateFields.length<2){throw new Error("Need to have at least 2 date fields");}
if(stringField){dataTable.addColumn({type:'string',id:stringField.getLabel()});}else{dataTable.addColumn({type:'string',id:"Index"});}
if(labelFields.length>0){dataTable.addColumn({type:'string',id:'Label'});}
dataTable.addColumn({type:'date',id:dateFields[0].getLabel()});dataTable.addColumn({type:'date',id:dateFields[1].getLabel()});for(let r=0;r<records.length;r++){let row=this.getDataValues(records[r]);let tuple=[];values.push(tuple);if(stringField&&showLabel)
tuple.push(row[stringField.getIndex()]);else
tuple.push("#"+(r+1));if(labelFields.length>0){let label="";if(labelFieldsTemplate)
label=labelFieldsTemplate;for(let l=0;l<labelFields.length;l++){let f=labelFields[l];let value=row[f.getIndex()];if(labelFieldsTemplate){label=label.replace("{"+f.getId()+"}",value);}else{label+=value+" ";}}
tuple.push(label);}
tuple.push(row[dateFields[0].getIndex()]);tuple.push(row[dateFields[1].getIndex()]);}
dataTable.addRows(values);return dataTable;}});}
function CalendarDisplay(displayManager,id,properties){const SUPER=new RamaddaGoogleChart(displayManager,id,DISPLAY_CALENDAR,properties);let myProps=[{label:'Calendar'},{p:'cellSize',d:15,ex:"15"},{p:'missingValue',ex:""},{p:'strokeColor',d:'#76a7fa',ex:'#76a7fa'},{p:'strokeWidth',ex:'1'},{p:'strokeOpacity',d:0.5,ex:'0.5'},{p:'noDataBackground',ex:'green'},{p:'noDataColor',ex:'red'},{p:'colorAxis',ex:'red,blue'},];defineDisplay(addRamaddaDisplay(this),SUPER,myProps,{doMakeGoogleChart:function(dataList,props,chartDiv,selectedFields,chartOptions){let opts={calendar:{cellSize:parseInt(this.getPropertyCellSize()),cellColor:{stroke:this.getPropertyStrokeColor(),strokeOpacity:this.getPropertyStrokeOpacity(),strokeWidth:this.getPropertyStrokeWidth(1),},},height:this.getProperty("height",800),noDataPattern:{backgroundColor:this.getPropertyNoDataBackground(),color:this.getPropertyNoDataColor()},};let colors=this.getPropertyColorAxis();if(colors){opts.colorAxis={colors:colors.split(",")}}
$.extend(chartOptions,opts);if(this.jq(ID_CHART).width()==0){return;}
let cal=new google.visualization.Calendar(chartDiv);return cal;},defaultSelectedToAll:function(){return true;},getContentsStyle:function(){let height=this.getProperty("height",800);if(height>0){return" height:"+height+"px; "+" max-height:"+height+"px; overflow-y: auto;";}
return"";},canDoMultiFields:function(){return false;},getIncludeIndexIfDate:function(){return true;},makeDataTable:function(dataList,props,selectedFields){let dataTable=new google.visualization.DataTable();let header=this.getDataValues(dataList[0]);if(header.length<2)return null;dataTable.addColumn({type:'date',id:'Date'});dataTable.addColumn({type:'number',id:header[1]});dataTable.addColumn({type:'string',role:'tooltip','p':{'html':true}});let haveMissing=false;let missing=this.getPropertyMissingValue();if(missing){haveMissing=true;missing=parseFloat(missing);}
let list=[];let cnt=0;let options={weekday:'long',year:'numeric',month:'long',day:'numeric'};this.dateToRecords={};for(let i=1;i<dataList.length;i++){let records=this.getBinnedRecords(dataList[i].record);let obj=dataList[i];if(!records&&obj.record)records=[obj.record];let value=this.getDataValues(obj)[1];if(value==NaN)continue;if(haveMissing&&value==missing){continue;}
cnt++;let dttm=this.getDataValues(dataList[i])[0];this.dateToRecords[dttm.v.getTime()]=records;let tooltip="<center><b>"+dttm.f+"</b></center>"+
"<b>"+header[1].replace(/ /g,"&nbsp;")+"</b>:&nbsp;"+this.formatNumber(value);tooltip=HU.div([STYLE,HU.css('padding','5px')],tooltip);list.push([this.getDataValues(dataList[i])[0],value,tooltip]);}
dataTable.addRows(list);return dataTable;}});}
function GaugeDisplay(displayManager,id,properties){const SUPER=new RamaddaGoogleChart(displayManager,id,DISPLAY_GAUGE,properties);defineDisplay(addRamaddaDisplay(this),SUPER,[],{getChartHeight:function(){return this.getProperty("height",this.getChartWidth());},getChartWidth:function(){return this.getProperty("width","150");},doMakeGoogleChart:function(dataList,props,chartDiv,selectedFields,chartOptions){this.dataList=dataList;this.chartOptions=chartOptions;let min=Number.MAX_VALUE;let max=Number.MIN_VALUE;let setMinMax=true;for(let row=1;row<dataList.length;row++){let tuple=this.getDataValues(dataList[row]);for(let col=0;col<tuple.length;col++){if(!Utils.isNumber(tuple[col])){continue;}
let value=tuple[col];min=Math.min(min,value);max=Math.max(max,value);}}
min=Utils.formatNumber(min,true);max=Utils.formatNumber(max,true);if(Utils.isDefined(this.gaugeMin)){setMinMax=true;min=parseFloat(this.gaugeMin);}
if(Utils.isDefined(this.gaugeMax)){setMinMax=true;max=parseFloat(this.gaugeMax);}
if(setMinMax){chartOptions.min=min;chartOptions.max=max;}
return new google.visualization.Gauge(chartDiv);},makeDataTable:function(dataList,props,selectedFields){dataList=this.makeDataArray(dataList);if(!Utils.isDefined(this.index))this.index=dataList.length-1;let index=this.index+1;let list=[];list.push(["Label","Value"]);let header=this.getDataValues(dataList[0]);if(index>=dataList.length)index=dataList.length-1;let row=this.getDataValues(dataList[index]);for(let i=0;i<row.length;i++){if(!Utils.isNumber(row[i]))continue;let h=header[i];if(h.length>20){let index=h.indexOf("(");if(index>0){h=h.substring(0,index);}}
if(h.length>20){h=h.substring(0,19)+"...";}
if(this.getProperty("gaugeLabel"))
h=this.getProperty("gaugeLabel");else if(this["gaugeLabel"+(i+1)])h=this["gaugeLabel"+(i+1)];let value=row[i];list.push([h,Utils.formatNumber(value,true)]);}
return google.visualization.arrayToDataTable(list);},setChartSelection:function(index){this.index=index;let dataTable=this.makeDataTable(this.dataList);this.mapCharts(chart=>{chart.draw(dataTable,this.chartOptions);});},});}
function ScatterplotDisplay(displayManager,id,properties){const SUPER=new RamaddaGoogleChart(displayManager,id,DISPLAY_SCATTERPLOT,properties);defineDisplay(addRamaddaDisplay(this),SUPER,[],{trendLineEnabled:function(){return true;},setAxisRanges:function(chartOptions,selectedFields,records){if(this.getProperty("hAxisFixedRange")){let x=this.getColumnValues(records,selectedFields[0]);if(chartOptions.hAxis)chartOptions.hAxis={};chartOptions.hAxis.minValue=x.min;chartOptions.hAxis.maxValue=x.max;}
if(this.getProperty("vAxisFixedRange")){if(chartOptions.vAxis)chartOptions.vAxis={};let x=this.getColumnValues(records,selectedFields[1]);chartOptions.vAxis.minValue=x.min;chartOptions.vAxis.maxValue=x.max;}},makeChartOptions:function(dataList,props,selectedFields){let chartOptions=SUPER.makeChartOptions.call(this,dataList,props,selectedFields);chartOptions.curveType=null;chartOptions.lineWidth=0;$.extend(chartOptions,{title:'',tooltip:{isHtml:true},legend:'none',});if(!chartOptions.chartArea)chartOptions.chartArea={};$.extend(chartOptions.chartArea,{left:"10%",top:10,height:"80%",width:"90%"});if(this.getShowTitle()){chartOptions.title=this.getTitle(true);}
if(!chartOptions.hAxis)chartOptions.hAxis={};if(!chartOptions.vAxis)chartOptions.vAxis={};if(this.getProperty("hAxisLogScale",false))
chartOptions.hAxis.logScale=true;if(this.getProperty("vAxisLogScale",false))
chartOptions.vAxis.logScale=true;chartOptions.vAxis.viewWindowMode=this.getProperty("viewWindowMode","pretty");chartOptions.hAxis.viewWindowMode=this.getProperty("viewWindowMode","pretty");if(dataList.length>0&&this.getDataValues(dataList[0]).length>1){if(!chartOptions.vAxis)chartOptions.vAxis={};if(!chartOptions.hAxis)chartOptions.hAxis={};if(this.getProperty("hAxisTitle")){chartOptions.hAxis.title=this.getProperty("hAxisTitle");}
if(this.getProperty("vAxisTitle")){chartOptions.vAxis.title=this.getProperty("vAxisTitle");}
if(!chartOptions.hAxis.title){$.extend(chartOptions.hAxis,{title:this.getDataValues(dataList[0])[0]});}
if(!chartOptions.vAxis.title){$.extend(chartOptions.vAxis,{title:this.getDataValues(dataList[0])[1]});}
if(!isNaN(this.getVAxisMinValue())){chartOptions.vAxis.minValue=this.getVAxisMinValue();}
if(!isNaN(this.getVAxisMaxValue())){chartOptions.vAxis.maxValue=this.getVAxisMaxValue();}}
return chartOptions;},doMakeGoogleChart:function(dataList,props,chartDiv,selectedFields,chartOptions){if(!chartDiv)return
let height=this.getProperty("height",400);if(Utils.isDefined(this.getProperty("chartHeight"))){height=this.getProperty("chartHeight");}
let width="100%";if(Utils.isDefined(this.getProperty("chartWidth"))){width=this.getProperty("chartWidth");}
if((typeof height)=="number")height=height+"px";if((typeof width)=="number")width=width+"px";$("#"+chartDiv.id).css("width",width);$("#"+chartDiv.id).css("height",height);return new google.visualization.ScatterChart(chartDiv);},getDefaultSelectedFields:function(fields,dfltList){let f=[];for(i=0;i<fields.length;i++){let field=fields[i];if(field.isNumeric()){f.push(field);if(f.length>=2)
break;}}
return f;}});}
const DISPLAY_SLIDES="slides";const DISPLAY_IMAGES="images";const DISPLAY_IMAGEZOOM="imagezoom";const DISPLAY_CARDS="cards";addGlobalDisplayType({type:DISPLAY_IMAGES,label:"Images",requiresData:true,forUser:true,category:CATEGORY_IMAGES,tooltip:makeDisplayTooltip("Image Gallery","images.png"),});addGlobalDisplayType({type:DISPLAY_IMAGEZOOM,label:"Image Zoom",requiresData:true,forUser:true,category:CATEGORY_IMAGES,tooltip:makeDisplayTooltip("Image Zoom","imagezoom.png","Show a set of images and allow for zooming in"),});addGlobalDisplayType({type:DISPLAY_SLIDES,label:"Slides",requiresData:true,forUser:true,category:CATEGORY_IMAGES,tooltip:makeDisplayTooltip("Show records in a slide like format","slides.png")});addGlobalDisplayType({type:DISPLAY_CARDS,label:"Cards",requiresData:true,forUser:true,category:CATEGORY_IMAGES,tooltip:makeDisplayTooltip("Group records hierachically showing images","cards.png"),});function RamaddaCardsDisplay(displayManager,id,properties){const ID_RESULTS="results";const SUPER=new RamaddaFieldsDisplay(displayManager,id,DISPLAY_CARDS,properties);Utils.importJS(ramaddaBaseUrl+"/lib/color-thief.umd.js",()=>{},(jqxhr,settings,exception)=>{console.log("err");});let myProps=[{label:'Cards Attributes'},{p:'groupByFields',ex:''},{p:'initGroupFields',ex:''},{p:'tooltipFields',ex:''},{p:'captionFields'},{p:'captionTemplate',ex:'${name}'},{p:'sortFields',ex:''},{p:'labelField',ex:''},{p:'imageWidth',ex:'100'},{p:'imageMargin',ex:'5'},];defineDisplay(addRamaddaDisplay(this),SUPER,myProps,{getContentsStyle:function(){return"";},updateUI:function(){this.colorAnalysisEnabled=this.getProperty("doColorAnalysis");var pointData=this.getData();if(pointData==null)return;var allFields=pointData.getRecordFields();var fields=this.getSelectedFields(allFields);if(fields==null||fields.length==0){fields=allFields;}
var records=this.filterData();if(!records)return;let theFields=fields;this.initGrouping=this.getFieldsByIds(fields,this.getProperty("initGroupFields","",true));this.groupByFields=this.getFieldsByIds(fields,this.getProperty("groupByFields","",true));this.groupByMenus=+this.getProperty("groupByMenus",this.groupByFields.length);this.imageField=this.getFieldByType(fields,"image");this.urlField=this.getFieldByType(fields,"url");this.tooltipFields=this.getFieldsByIds(fields,this.getProperty("tooltipFields","",true));this.labelFields=this.getFieldsByIds(fields,this.getProperty("labelFields",null,true));if(this.labelFields.length==0){var tmp=this.getFieldById(fields,this.getProperty("labelField",null,true));if(tmp){this.labelFields.push(tmp);}}
this.onlyShowImages=this.getProperty("onlyShowImages",false);this.altLabelField=this.getFieldById(fields,this.getProperty("altLabelField",null,true));this.captionFields=this.getFieldsByIds(fields,this.getProperty("captionFields","",true));this.captionTemplate=this.getProperty("captionTemplate",null,true);if(this.captionFields.length==0)this.captionFields=this.tooltipFields;this.colorByField=this.getFieldById(fields,this.getProperty("colorBy",null,true));this.colorList=this.getColorTable(true);this.foregroundList=this.getColorTable(true,"foreground");if(!this.getProperty("showImages",true))this.imageField=null;if(!this.imageField){if(this.captionFields.length==0){this.displayError("No image or caption fields specified");return;}}
var contents="";if(!this.groupByHtml){this.groupByHtml="";if(this.colorAnalysisEnabled)
this.groupByHtml+=HU.span([CLASS,"ramadda-button",ID,this.domId("docolors")],"Do colors")+" "+
HU.span([CLASS,"ramadda-button",ID,this.domId("docolorsreset")],"Reset");if(this.groupByFields.length>0){var options=[["","--"]];this.groupByFields.map(field=>{options.push([field.getId(),field.getLabel()]);});this.groupByHtml+=HU.span([CLASS,"display-fitlerby-label"]," Group by: ");for(var i=0;i<this.groupByMenus;i++){var selected="";if(i<this.initGrouping.length){selected=this.initGrouping[i].getId();}
this.groupByHtml+=HU.select("",[ID,this.domId(ID_GROUPBY_FIELDS+i)],options,selected)+"&nbsp;";}
this.groupByHtml+="&nbsp;";this.jq(ID_HEADER1).html(HU.div([CLASS,"display-filterby"],this.groupByHtml));this.jq("docolors").button().click(()=>{this.analyzeColors();});this.jq("docolorsreset").button().click(()=>{this.updateUI();});}}
contents+=HU.div([ID,this.domId(ID_RESULTS)]);this.setContents(contents);let _this=this;this.jq(ID_HEADER1).find("input, input:radio,select").change(function(){_this.updateUI();});this.displaySearchResults(records,theFields);},analyzeColors:function(){if(!window["ColorThief"]){setTimeout(()=>this.analyzeColors(),1000);return;}
const colorThief=new ColorThief();var cnt=0;while(true){var img=document.querySelector('#'+this.domId("gallery")+"img"+cnt);var div=$('#'+this.domId("gallery")+"div"+cnt);cnt++;if(!img){return;}
img.crossOrigin='Anonymous';var c=colorThief.getColor(img);var p=colorThief.getPalette(img);var width=img.width/p.length;var html="";for(var i=0;i<p.length;i++){var c=p[i];html+=HU.div([STYLE,HU.css('display','inline-block','width',width+"px','height', img.height +'px','background','rgb("+c[0]+","+c[1]+","+c[2]+")")],"");}
div.css("width",img.width);div.css("height",img.height);div.html(html);img.style.display="none";}},displaySearchResults:function(records,fields){records=this.sortRecords(records);var fontSize=this.getProperty("fontSize",null);var cardStyle=this.getProperty("cardStyle",null);var width=this.getProperty("imageWidth","50");var margin=this.getProperty("imageMargin","0");var groupFields=[];var seen=[];for(var i=0;i<this.groupByMenus;i++){var id=this.jq(ID_GROUPBY_FIELDS+i).val();if(!seen[id]){seen[id]=true;var field=this.getFieldById(fields,id);if(field){groupFields.push(field);if(field.isNumeric()&&!field.range){var min=Number.MAX_VALUE;var max=Number.MIN_VALUE;records.map(record=>{var v=field.getValue(record);if(isNaN(v))return;if(v<min)min=v;if(v>max)max=v;});field.range=[min,max];var binsProp=this.getProperty(field.getId()+".bins");field.bins=[];if(binsProp){var l=binsProp.split(",");for(var i=0;i<l.length-1;i++){field.bins.push([+l[i],+l[i+1]]);}}else{var numBins=+this.getProperty(field.getId()+".binCount",10);field.binSize=(max-min)/numBins;for(var bin=0;bin<numBins;bin++){field.bins.push([min+field.binSize*bin,min+field.binSize*(bin+1)]);}}}}}}
function groupNode(id,field){$.extend(this,{id:id,field:field,members:[],isGroup:true,getCount:function(){if(this.members.length==0)return 0;if(this.members[0].isGroup){var cnt=0;this.members.map(node=>cnt+=node.getCount());return cnt;}
return this.members.length;},findGroup:function(v){for(var i=0;i<this.members.length;i++){if(this.members[i].isGroup&&this.members[i].id==v)return this.members[i];}
return null;},});}
var topGroup=new groupNode("");var colorMap={};var colorCnt=0;var imgCnt=0;for(var rowIdx=0;rowIdx<records.length;rowIdx++){let record=records[rowIdx];var row=this.getDataValues(records[rowIdx]);var contents="";var tooltip="";this.tooltipFields.map(field=>{if(tooltip!="")tooltip+="&#10;";tooltip+=field.getValue(record);});tooltip=tooltip.replace(/\"/g,"&quot;");var label="";var caption="";if(this.captionFields.length>0){if(this.captionTemplate)caption=this.captionTemplate;this.captionFields.map(field=>{var value=(""+field.getValue(record)).replace(/\"/g,"&quot;");if(this.captionTemplate)
caption=caption.replace("\${"+field.getId()+"}",value);else
caption+=value+"<br>";});if(this.urlField){var url=this.urlField.getValue(record);if(url&&url!=""){caption="<a style='color:inherit;'  href='"+url+"' target=_other>"+caption+"</a>";}}}
this.labelFields.map(f=>{label+=row[f.getIndex()]+" ";});label=label.trim();var html="";var img=null;if(this.imageField){img=row[this.imageField.getIndex()];if(this.onlyShowImages&&!Utils.stringDefined(img))continue;}
var imgAttrs=[CLASS,"display-cards-popup","data-fancybox",this.domId("gallery"),"data-caption",caption];if(img)img=img.trim();if(Utils.stringDefined(img)){if(this.colorAnalysisEnabled)
img=ramaddaBaseUrl+"/proxy?url="+img;img=HU.href(img,HU.div([ID,this.domId("gallery")+"div"+imgCnt],HU.image(img,["width",width,ID,this.domId("gallery")+"img"+imgCnt])),imgAttrs)+label;imgCnt++;html=HU.div([CLASS,"display-cards-item",TITLE,tooltip,STYLE,HU.css('margin',margin+'px')],img);}else{var style="";if(fontSize){style+=" font-size:"+fontSize+"; ";}
if(this.colorByField&&this.colorList){var value=this.colorByField.getValue(record);if(!Utils.isDefined(colorMap[value])){colorMap[value]=colorCnt++;}
var index=colorMap[value];if(index>=this.colorList.length){index=this.colorList.length%index;}
style+="background:"+this.colorList[index]+";";if(this.foregroundList){if(index<this.foregroundList.length){style+="color:"+this.foregroundList[index]+" !important;";}else{style+="color:"+this.foregroundList[this.foregroundList-1]+" !important;";}}}
if(cardStyle)
style+=cardStyle;var attrs=[TITLE,tooltip,CLASS,"ramadda-gridbox display-cards-card",STYLE,style];if(this.altLabelField){html=HU.div(attrs,this.altLabelField.getValue(record));}else{html=HU.div(attrs,caption);}
html=HU.href("",html,imgAttrs);}
var group=topGroup;for(var groupIdx=0;groupIdx<groupFields.length;groupIdx++){var groupField=groupFields[groupIdx];var value=row[groupField.getIndex()];if(groupField.isNumeric()){for(var binIdx=0;binIdx<groupField.bins.length;binIdx++){var bin=groupField.bins[binIdx];if(value<=bin[1]||binIdx==groupField.bins.length-1){value=Utils.formatNumber(bin[0])+" - "+Utils.formatNumber(bin[1]);break;}}}
var child=group.findGroup(value);if(!child){group.members.push(child=new groupNode(value,groupField));}
group=child;}
group.members.push(html);}
let total=topGroup.getCount();let topHtml=HU.div([CLASS,"display-cards-header"],"Total"+" ("+total+")");topHtml+=this.makeGroupHtml(topGroup,topGroup);this.writeHtml(ID_RESULTS,topHtml);this.jq(ID_RESULTS).find("a.display-cards-popup").fancybox({caption:function(instance,item){return $(this).data('caption')||'';}});},makeGroupHtml:function(group,topGroup){if(group.members.length==0)return"";var html="";if(group.members[0].isGroup){group.members.sort((a,b)=>{if(a.id<b.id)return-1;if(a.id>b.id)return 1;return 0;});var width=group.members.length==0?"100%":100/group.members.length;html+=HU.open(TABLE,[WIDTH,'100%','border',0])+HU.open(TR,['valign','top']);for(var i=0;i<group.members.length;i++){var child=group.members[i];var prefix="";if(child.field)
prefix=child.field.getLabel()+": ";html+=HU.open(TD,[WIDTH,width+"%"]);let perc=Math.round(100*child.getCount()/topGroup.getCount());html+=HU.div([CLASS,"display-cards-header"],prefix+child.id+" (#"+child.getCount()+" - "+perc+"%)");html+=this.makeGroupHtml(child,topGroup);html+=HU.close(TD);}
html+=HU.close(TR,TABLE);}else{html+=Utils.join(group.members,"");}
return html;}});}
function RamaddaImagesDisplay(displayManager,id,properties){const ID_GALLERY="gallery";const ID_NEXT="next";const ID_PREV="prev";const ID_IMAGES="images";let myProps=[{label:'Image Gallery Properties'},{p:'imageField',ex:''},{p:'labelFields',ex:''},{p:'topLabelTemplate',ex:''},{p:'bottomLabelTemplate',ex:''},{p:'tooltipFields',ex:''},{p:'numberOfImages',ex:'100'},{p:'includeBlanks',ex:'true'},{p:'blockWidth',ex:'150'},{p:'imageWidth',ex:'150'},{p:'imageHeight',ex:'150'},{p:'imageMargin',ex:'10px'},{p:'decorate',ex:'false'},{p:'doPopup',ex:'false'},{p:'imageStyle',ex:''},{p:'minHeightGallery',ex:150},{p:'maxHeightGallery',ex:150},{p:'columns',ex:'5'},{p:'noun',ex:'images'},];const SUPER=new RamaddaFieldsDisplay(displayManager,id,DISPLAY_IMAGES,properties);defineDisplay(addRamaddaDisplay(this),SUPER,myProps,{startIndex:0,dataFilterChanged:function(){this.startIndex=0;this.updateUI();},handleEventRecordSelection:function(source,args){let blocks=this.find(".display-images-block");let select=HU.attrSelect(RECORD_ID,args.record.getId());let block=this.find(select);blocks.css('border',null);block.css('border',"1px solid "+this.getHighlightColor());HU.scrollVisible(this.jq(ID_IMAGES),block);},updateUI:function(){let records=this.filterData();if(!records)return;let includeBlanks=this.getPropertyIncludeBlanks(false);let imageField=this.getFieldById(null,this.getProperty("imageField"));if(!imageField){imageField=this.getFieldByType(null,"image");}
let urlField=this.getFieldById(null,this.getProperty("urlField"));let tooltipClick=this.getProperty("tooltipClick");let pointData=this.getData();let fields=pointData.getRecordFields();let labelFields=this.getFieldsByIds(null,this.getProperty("labelFields",null,true));let topLabelTemplate=this.getPropertyTopLabelTemplate();let bottomLabelTemplate=this.getPropertyBottomLabelTemplate();let tooltipFields=this.getFieldsByIds(null,this.getProperty("tooltipFields",null,true));if(!imageField){this.setDisplayMessage("No image field in data");return;}
let decorate=this.getPropertyDecorate(true);let columns=+this.getPropertyColumns(0);let number=+this.getPropertyNumberOfImages(50);let colorBy=this.getColorByInfo(records);let width=this.getPropertyImageWidth();let blockWidth=this.getBlockWidth("200px");let height=this.getPropertyImageHeight();if(!width&&!height)width="100%";let imageStyle=this.getPropertyImageStyle("");let contents="";let uid=HtmlUtils.getUniqueId();let base="gallery"+uid;let displayedRecords=[];let doPopup=this.getPropertyDoPopup(true);let recordIndex=0;let columnCnt=-1;let columnMap={};let class1="display-images-image-outer display-images-block ";let class2="display-images-image-inner";this.idToRecord={};let baseStyle="";if(!decorate){class2="";class1="display-images-block";baseStyle=HU.css("margin",this.getPropertyImageMargin("10px"));}
if(columns){if(width&&width.endsWith("%"))
baseStyle+=HU.css(WIDTH,width);}
baseStyle+=this.getProperty("blockStyle","");if(this.startIndex<0)this.startIndex=0;if(this.startIndex>records.length)this.startIndex=records.length-number;let cnt=1;for(let rowIdx=this.startIndex;rowIdx<records.length;rowIdx++){let record=records[rowIdx];let row=this.getDataValues(record);let image=record.getValue(imageField.getIndex());if(image==""&&!includeBlanks){continue;}
if(cnt++>number)break;displayedRecords.push(record);this.idToRecord[record.getId()]=record;let topLabel=null;if(topLabelTemplate){topLabel=this.getRecordHtml(record,fields,topLabelTemplate);}
let label="";let galleryLabel="";if(Utils.stringDefined(bottomLabelTemplate)){label=this.getRecordHtml(record,fields,bottomLabelTemplate);}
labelFields.forEach(l=>{let value=record.getValue(l.getIndex());if(value.getTime){value=this.formatDate(value);}
galleryLabel+=" "+value;});if(galleryLabel=="")galleryLabel=label;else if(label=="")label=galleryLabel;let tt="";tooltipFields.forEach(l=>{tt+="\n"+l.getLabel()+": "+row[l.getIndex()]});tt=tt.trim();let style=baseStyle;let imgAttrs=[STYLE,imageStyle,"alt",galleryLabel,ID,base+"image"+rowIdx,"loading","lazy"];if(width)imgAttrs.push(WIDTH,width);else if(height)imgAttrs.push(HEIGHT,height);let img=image==""?SPACE1:HU.image(image,imgAttrs);let topLbl=(topLabel!=null?HU.div([CLASS,"ramadda-clickable display-images-toplabel"],topLabel):"");let lbl=HU.div([CLASS,"ramadda-clickable display-images-label"],label.trim());if(urlField){if(topLbl!="")
topLbl=HU.href(urlField.getValue(record),topLbl,["target","_target"]);lbl=HU.href(urlField.getValue(record),lbl,["target","_target"]);galleryLabel=HU.href(urlField.getValue(record),galleryLabel,["target","_target"]);galleryLabel=galleryLabel.replace(/"/g,"'");}
if(!this.getProperty("showBottomLabel",true))
lbl="";if(colorBy.isEnabled()){let c=colorBy.getColorFromRecord(record);style+=HU.css(BACKGROUND,c);}
style+=HU.css("vertical-align","top","width",blockWidth);if(doPopup){img=HU.href(image,img,[CLASS,"popup_image","data-fancybox",base,"data-caption",galleryLabel]);}else if(urlField&&!tooltipClick){img=HU.href(urlField.getValue(record),img,["target","_target"]);}
let block=HU.div([STYLE,style,RECORD_ID,record.getId(),RECORD_INDEX,recordIndex++,ID,base+"div"+rowIdx,CLASS,class1,TITLE,tt],HU.div([CLASS,class2],topLbl+img+lbl));if(columns){if(++columnCnt>=columns){columnCnt=0;}
if(!columnMap[columnCnt])columnMap[columnCnt]="";columnMap[columnCnt]+=block;}else{contents+=block;}}
if(columns){contents="<table border=0 width=100%><tr valign=top>";for(let col=0;true;col++){if(!columnMap[col])break;contents+=HU.td(['align','center'],columnMap[col]);}
contents+="</tr></table>";}else{}
let header="";if(this.startIndex>0){header+=HU.span([ID,this.domId(ID_PREV)],"Previous")+" ";}
if(this.startIndex+number<records.length){header+=HU.span([ID,this.domId(ID_NEXT)],"Next")+" ";}
cnt--;if(number<records.length){header+="Showing "+(this.startIndex+1)+" - "+(this.startIndex+cnt);header+=" of "+records.length+" "+this.getNoun("images");}
if(header!=""){header=HU.div([STYLE,HU.css('margin-right','10px',"display","inline-block")],header);this.jq(ID_HEADER2_PREFIX).html(header);this.jq(ID_HEADER2).css("text-align","left");}
header="";if(this.getPropertyMinHeightGallery()||this.getPropertyMaxHeightGallery()){let css="";if(this.getPropertyMinHeightGallery())css+=HU.css("min-height",HU.getDimension(this.getPropertyMinHeightGallery()));if(this.getPropertyMinHeightGallery())css+=HU.css("max-height",HU.getDimension(this.getPropertyMaxHeightGallery()));contents=HU.div([ID,this.domId(ID_IMAGES),STYLE,css+HU.css("overflow-y","auto")],contents);}
contents=HU.div([CLASS,"ramadda-grid"],contents);this.setContents(header+contents);let blocks=this.find(".display-images-block");let _this=this;blocks.mouseenter(function(){$(this).attr("oldborder",$(this).css("border"));$(this).css("border","1px solid "+_this.getHighlightColor());});blocks.mouseleave(function(){$(this).css("border",$(this).attr("oldborder"));});this.makeTooltips(blocks,displayedRecords);if(!doPopup){let _this=this;if(!tooltipClick){blocks.click(function(){let record=_this.idToRecord[$(this).attr(RECORD_ID)];if(record){_this.propagateEventRecordSelection({record:record});}});}}
this.jq(ID_PREV).button().click(()=>{this.startIndex-=number;this.updateUI();});this.jq(ID_NEXT).button().click(()=>{this.startIndex+=number;this.updateUI();});if(this.getProperty("propagateEventRecordList",false)){this.getDisplayManager().notifyEvent(DisplayEvent.recordList,this,{recordList:displayedRecords,});}}})}
function RamaddaImagezoomDisplay(displayManager,id,properties){const ID_THUMBS="thumbs";const ID_THUMB="thumb";const ID_IMAGE="image";const ID_IMAGEINNER="imageinner";const ID_POPUP="imagepopup";const ID_POPUPIMAGE="imagepopupimage";const ID_RECT="imagerect";const SUPER=new RamaddaFieldsDisplay(displayManager,id,DISPLAY_IMAGEZOOM,properties);let myProps=[{label:"Image Zoom Attributes"},{p:'labelFields'},{p:'thumbField'},{p:'thumbWidth',ex:'100'},{p:'imageWidth',ex:'150'},{p:'urlField'},{p:'popupWidth'},{p:'popupHeight'},{p:"popupImageWidth",d:2000}];defineDisplay(addRamaddaDisplay(this),SUPER,myProps,{dataFilterChanged:function(){this.updateUI();},updateUI:function(){let pointData=this.getData();if(pointData==null)return;let records=this.filterData();if(!records)return;let fields=pointData.getRecordFields();this.urlField=this.getFieldById(fields,this.getProperty("urlField","url"));this.imageField=this.getFieldById(fields,"image");if(!this.imageField)
this.imageField=this.getFieldByType(fields,"image");if(!this.imageField){this.setDisplayMessage("No image field in data");return;}
this.labelFields=this.getFieldsByIds(fields,this.getPropertyLabelFields());let thumbField=this.getFieldById(fields,this.getProperty("thumbField","thumb"))||this.imageField;let thumbWidth=parseFloat(this.getProperty("thumbWidth",100));let height=this.getHeightForStyle();let imageWidth=this.getProperty("imageWidth",500);this.popupWidth=+this.getProperty("popupWidth",imageWidth);this.popupHeight=+this.getProperty("popupHeight",300);let rect=HU.div([STYLE,HU.css("border","1px solid "+this.getHighlightColor(),"width","20px","height","20px","left","10px","top","10px","display","none","position","absolute","z-index",1000,"pointer-events","none"),ID,this.domId(ID_RECT)]);let imageDiv=HU.div(["style","position:relative"],rect+
HU.div([ID,this.domId(ID_IMAGE),STYLE,HU.css("position","relative")])+
HU.div([ID,this.domId(ID_POPUP),CLASS,"display-imagezoom-popup",STYLE,HU.css("z-index","100","display","none",WIDTH,this.popupWidth+"px",HEIGHT,this.popupHeight+"px","overflow-y","hidden","overflow-x","hidden","position","absolute","top","0px","left",imageWidth+"px")],""));let contents=HU.table(["border",0,WIDTH,"100%"],HU.tr(["valign","top"],HU.td([WIDTH,"2%"],HU.div([ID,this.domId(ID_THUMBS),STYLE,HU.css("max-height",height,"overflow-y","auto","display","inline-block")],""))+
HU.td([WIDTH,"90%"],imageDiv)));let thumbsHtml="";let first=null;for(let rowIdx=0;rowIdx<records.length;rowIdx++){let row=this.getDataValues(records[rowIdx]);let image=row[this.imageField.getIndex()];if(image==""){continue;}
if(!first)first=records[rowIdx];let thumb=row[thumbField.getIndex()];thumbsHtml+=HU.image(thumb,[RECORD_INDEX,rowIdx,ID,this.domId(ID_THUMB)+rowIdx,WIDTH,thumbWidth,CLASS,"display-imagezoom-thumb"])+"<br>\n";}
this.setContents(contents);this.jq(ID_THUMBS).html(thumbsHtml);let _this=this;let thumbs=this.jq(ID_THUMBS).find(".display-imagezoom-thumb");let thumbSelect=(thumb=>{thumbs.css("border","1px solid transparent");thumb.css("border","1px solid "+this.getHighlightColor());let index=parseFloat(thumb.attr(RECORD_INDEX));HU.addToDocumentUrl("imagezoom_thumb",index);let record=records[index]
_this.handleImage(record);_this.propagateEventRecordSelection({record:record});});thumbs.mouseover(function(){thumbSelect($(this));});this.jq(ID_THUMBS).css("border","1px solid transparent");let selectedIndex=HU.getUrlArgument("imagezoom_thumb");let x=HU.getUrlArgument("imagezoom_x");let y=HU.getUrlArgument("imagezoom_y");let selectedThumb=this.jq(ID_THUMB+(selectedIndex||"0"));if(selectedThumb.length)
thumbSelect(selectedThumb);if(selectedIndex)this.showPopup();if(Utils.isDefined(x)){setTimeout(()=>{this.handleMouseMove({x:parseFloat(x),y:parseFloat(y)});},250);}
this.jq(ID_IMAGE).click((e)=>{let width=+this.getPopupImageWidth();if(event.shiftKey){this.setProperty("popupImageWidth",Math.max(width*0.9,500));}else{this.setProperty("popupImageWidth",width*1.2);}
this.showPopup();this.handleMouseMove();});},showPopup:function(){if(!this.currentRecord)return;let row=this.getDataValues(this.currentRecord);let image=row[this.imageField.getIndex()];this.jq(ID_POPUP).css("display","block");let imageAttrs=[ID,this.domId(ID_POPUPIMAGE),STYLE,HU.css("xposition","absolute")];if(this.getPopupImageWidth()){imageAttrs.push(WIDTH);imageAttrs.push(this.getPopupImageWidth());}
this.jq(ID_POPUP).html(HU.image(image,imageAttrs));},handleImage:function(record,offset){let _this=this;this.currentRecord=record;let row=this.getDataValues(record);let image=row[this.imageField.getIndex()];let width=this.getProperty("imageWidth",500);let label="";if(this.labelFields.length>0){this.labelFields.map(l=>{label+=" "+row[l.getIndex()]});if(this.urlField){var url=this.urlField.getValue(record);if(url&&url!=""){label="<a style='color:inherit;'  href='"+url+"' target=_other>"+label+"</a>";}}}
let html=HU.image(image,["x","+:zoom in/-:zoom out",STYLE,HU.css("z-index",1000),WIDTH,width,ID,this.domId(ID_IMAGEINNER)]);if(label!="")
html+=HU.div([STYLE,"color:#000"],label);this.jq(ID_IMAGE).html(html);this.jq(ID_POPUP).html("");this.jq(ID_POPUP).css("display","none");this.jq(ID_IMAGEINNER).mouseenter(()=>{this.showPopup();});this.jq(ID_IMAGEINNER).mouseout(()=>{this.jq(ID_POPUP).html("");this.jq(ID_POPUP).css("display","none");this.jq(ID_RECT).css("display","none");});this.jq(ID_IMAGEINNER).mousemove((e)=>{this.handleMouseMove({event:e});});if(offset)
this.jq(ID_POPUPIMAGE).offset(offset);},handleMouseMove(params){if(!params)params={event:this.currentMouseEvent};this.currentMouseEvent=params.event;let image=this.jq(ID_IMAGEINNER);let w=image.width();let h=image.height();let popupImage=this.jq(ID_POPUPIMAGE);let iw=popupImage.width();let ih=popupImage.height();if(h==0||ih==0)return false;let popupWidth=popupImage.parent().width();let popupHeight=popupImage.parent().height();let scaleX=w/iw;let scaleY=h/ih;let scaledWidth=scaleX*popupWidth;let scaledHeight=scaleY*popupHeight;let sw2=scaledWidth/2;let sh2=scaledHeight/2;let parentOffset=image.parent().offset();if(!Utils.isDefined(params.x))
params.x=params.event.pageX-parentOffset.left;if(!Utils.isDefined(params.y))
params.y=params.event.pageY-parentOffset.top;if(params.x<sw2)params.x=sw2;if(params.y<sh2)params.y=sh2;if(params.x>w-sw2)params.x=w-sw2;if(params.y>h-sh2)params.y=h-sh2;let offX=scaleX*iw/2;let offY=scaleY*ih/2;let percentW=(params.x-sw2)/w;let percentH=(params.y-sh2)/h;if(popupImage.parent().length==0)return;let pp=popupImage.parent().offset();let offset={left:pp.left-percentW*iw,top:pp.top-percentH*ih};this.jq(ID_POPUPIMAGE).offset(offset);let rect=this.jq(ID_RECT);rect.css({"display":"block",top:params.y-sh2+"px",left:params.x-sw2+"px",width:scaledWidth+"px",height:scaledHeight+"px"});return true;},})}
function RamaddaSlidesDisplay(displayManager,id,properties){const ID_SLIDE="slide";const ID_PREV="prev";const ID_NEXT="next";if(!Utils.isDefined(properties.displayStyle))properties.displayStyle="background:rgba(0,0,0,0);";const SUPER=new RamaddaFieldsDisplay(displayManager,id,DISPLAY_SLIDES,properties);let myProps=[{label:'Slides Attributes'},{p:'template',ex:''}];defineDisplay(addRamaddaDisplay(this),SUPER,myProps,{slideIndex:0,handleEventRecordSelection:function(source,args){if(!this.records)return;var index=-1;for(var i=0;i<this.records.length;i++){if(this.records[i].getId()==args.record.getId()){index=i;break;}}
if(index>=0){this.slideIndex=index;this.displaySlide();}},getContentsStyle:function(){var style="";var height=this.getHeightForStyle();if(height){style+=" height:"+height+";";}
var width=this.getWidthForStyle();if(width){style+=" width:"+width+";";}
return style;},updateUI:function(){var pointData=this.getData();if(pointData==null)return;this.records=this.filterData();if(!this.records)return;this.fields=this.getData().getRecordFields();this.records=this.sortRecords(this.records);var template=this.getProperty("template","");var slideWidth=this.getProperty("slideWidth","100%");var height=this.getHeightForStyle("400");var left=HU.div([ID,this.domId(ID_PREV),STYLE,HU.css('font-size','200%'),CLASS,"display-slides-arrow-left fas fa-angle-left"]);var right=HU.div([ID,this.domId(ID_NEXT),STYLE,HU.css('font-size','200%'),CLASS,"display-slides-arrow-right fas fa-angle-right"]);var slide=HU.div([STYLE,HU.css('overflow-y','auto','max-height',height),ID,this.domId(ID_SLIDE),CLASS,"display-slides-slide"]);var navStyle="padding-top:20px;";var contents=HU.div([STYLE,HU.css('position','relative')],"<table width=100%><tr valign=top><td width=20>"+HU.div([STYLE,navStyle],left)+"</td><td>"+
slide+"</td>"+
"<td width=20>"+HU.div([STYLE,navStyle],right)+"</td></tr></table>");this.setContents(contents);this.jq(ID_PREV).click(()=>{this.slideIndex--;this.displaySlide(true);});this.jq(ID_NEXT).click(()=>{this.slideIndex++;this.displaySlide(true);});setTimeout(()=>{this.displaySlide();},200);},displaySlide:function(propagateEvent){if(this.slideIndex<0)this.slideIndex=0;if(this.slideIndex>=this.records.length)this.slideIndex=this.records.length-1;if(this.slideIndex==0)
this.jq(ID_PREV).hide();else
this.jq(ID_PREV).show();if(this.slideIndex==this.records.length-1)
this.jq(ID_NEXT).hide();else
this.jq(ID_NEXT).show();var record=this.records[this.slideIndex];var row=this.getDataValues(record);var html=this.applyRecordTemplate(record,row,this.fields,this.getProperty("template",""));html=html.replace(/\${recordIndex}/g,(this.slideIndex+1));this.jq(ID_SLIDE).html(html);var args={highlight:true,record:record};if(propagateEvent)
this.getDisplayManager().notifyEvent(DisplayEvent.recordHighlight,this,args);},handleEventRecordHighlight:function(source,args){}})}
const DISPLAY_FILTER="filter";const DISPLAY_ANIMATION="animation";const DISPLAY_LABEL="label";const DISPLAY_DOWNLOAD="download";const DISPLAY_LEGEND="legend";const DISPLAY_RELOADER="reloader";const DISPLAY_MESSAGE="message";const DISPLAY_FIELDSLIST="fieldslist";const DISPLAY_TICKS="ticks";const DISPLAY_MENU="menu";addGlobalDisplayType({type:DISPLAY_DOWNLOAD,label:"Download",requiresData:true,forUser:true,category:CATEGORY_CONTROLS,tooltip:makeDisplayTooltip("Show a download link",null,"Allows user to select fields and<br>download CSV and JSON")});addGlobalDisplayType({type:DISPLAY_RELOADER,label:"Reloader",requiresData:true,forUser:true,category:CATEGORY_CONTROLS,tooltip:makeDisplayTooltip("Reload the displays",null,"Automatically reloads the displays on a set frequency")});addGlobalDisplayType({type:DISPLAY_FILTER,label:"Filter",requiresData:false,category:CATEGORY_CONTROLS,tooltip:makeDisplayTooltip("No data, just provides data filtering")});addGlobalDisplayType({type:DISPLAY_ANIMATION,label:"Animation",requiresData:true,category:CATEGORY_CONTROLS,tooltip:makeDisplayTooltip("Steps through time to drive other displays","animation.png","")});addGlobalDisplayType({type:DISPLAY_MESSAGE,label:"Message",requiresData:true,forUser:true,category:CATEGORY_CONTROLS,tooltip:makeDisplayTooltip("No data, just a formatted message",null,"")});addGlobalDisplayType({type:DISPLAY_MENU,label:"Menu",requiresData:true,forUser:true,category:CATEGORY_CONTROLS,tooltip:makeDisplayTooltip("Shows records in a menu to be selected")});addGlobalDisplayType({type:DISPLAY_FIELDSLIST,label:"Fields List",requiresData:true,forUser:true,category:CATEGORY_CONTROLS,});addGlobalDisplayType({type:DISPLAY_LABEL,label:"Label",requiresData:false,category:CATEGORY_CONTROLS,tooltip:makeDisplayTooltip("No data, just a text label",null,"Useful to add text to the display layout")});addGlobalDisplayType({type:DISPLAY_LEGEND,label:"Legend",requiresData:false,forUser:true,category:CATEGORY_CONTROLS,tooltip:makeDisplayTooltip("No data, just a configurable legend","legend.png")});addGlobalDisplayType({type:DISPLAY_TICKS,label:"Ticks",requiresData:true,forUser:true,category:CATEGORY_CONTROLS,tooltip:makeDisplayTooltip("Shows records as ticks in a timeline","ticks.png")});function RamaddaFilterDisplay(displayManager,id,properties){let SUPER=new RamaddaDisplay(displayManager,id,DISPLAY_FILTER,properties);let myProps=[];defineDisplay(addRamaddaDisplay(this),SUPER,myProps,{html:"<p>&nbsp;&nbsp;&nbsp;Nothing selected&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<p>",initDisplay:function(){this.createUI();this.setContents(this.html);},});}
function RamaddaAnimationDisplay(displayManager,id,properties){var ID_START="start";var ID_STOP="stop";var ID_TIME="time";let SUPER=new RamaddaDisplay(displayManager,id,DISPLAY_ANIMATION,properties);let myProps=[];defineDisplay(addRamaddaDisplay(this),SUPER,myProps,{running:false,timestamp:0,index:0,sleepTime:500,iconStart:"fa-play",iconStop:"fa-stop",iconBack:"fa-step-backward",iconForward:"fa-step-forward",iconSlower:"fa-minus",iconFaster:"fa-plus",iconBegin:"fa-fast-backward",iconEnd:"fa-fast-forward",needsData:function(){return true;},deltaIndex:function(i){this.stop();this.setIndex(this.index+i);},setIndex:function(i){if(i<0)i=0;this.index=i;this.applyStep(true,!Utils.isDefined(i));},toggle:function(){if(this.running){this.stop();}else{this.start();}},tick:function(){if(!this.running)return;this.index++;this.applyStep();var theAnimation=this;setTimeout(function(){theAnimation.tick();},this.sleepTime);},applyStep:function(propagate,goToEnd){if(!Utils.isDefined(propagate))propagate=true;let records=this.currentRecords;if(records==null){$("#"+this.getDomId(ID_TIME)).html("No data");return;}
if(goToEnd)this.index=records.length-1;if(this.index>=records.length){this.index=0;}
var record=records[this.index];var label="";if(record.getDate()!=null){var dttm=this.formatDate(record.getDate(),{suffix:this.getTimeZone()});label+=HU.b("Date:")+" "+dttm;}else{label+=HU.b("Index:")+" "+this.index;}
$("#"+this.getDomId(ID_TIME)).html(label);if(propagate){this.propagateEventRecordSelection({record:record});}},handleEventRecordSelection:function(source,args){if(!args.record)return;let records=this.currentRecords;if(!records){if(args.record)records=[args.record];}
records.every((r,idx)=>{if(r.getId()==args.record.getId()){this.index=idx;this.applyStep(false);return false;}
return true;});},faster:function(){this.sleepTime=this.sleepTime/2;if(this.sleepTime==0)this.sleepTime=100;},slower:function(){this.sleepTime=this.sleepTime*1.5;},start:function(){if(this.running)return;this.running=true;this.timestamp++;$("#"+this.getDomId(ID_START)).html(HU.getIconImage(this.iconStop));this.tick();},stop:function(){if(!this.running)return;this.running=false;this.timestamp++;$("#"+this.getDomId(ID_START)).html(HU.getIconImage(this.iconStart));},updateUI:function(){let records=this.filterData();if(!records)return;this.currentRecords=records;this.stop();var get=this.getGet();var html="";let c="display-animation-button";html+=HU.onClick(get+".setIndex(0);",HU.div([ATTR_TITLE,"beginning",ATTR_CLASS,c],HU.getIconImage(this.iconBegin)));html+=HU.onClick(get+".deltaIndex(-1);",HU.div([ATTR_TITLE,"step back",ATTR_CLASS,c],HU.getIconImage(this.iconBack)));html+=HU.onClick(get+".toggle();",HU.div([ATTR_ID,this.getDomId(ID_START),ATTR_TITLE,"play/stop",ATTR_CLASS,c],HU.getIconImage(this.iconStart)));html+=HU.onClick(get+".deltaIndex(1);",HU.div([ATTR_TITLE,"step forward",ATTR_CLASS,c],HU.getIconImage(this.iconForward)));html+=HU.onClick(get+".setIndex();",HU.div([ATTR_TITLE,"end",ATTR_CLASS,c],HU.getIconImage(this.iconEnd)));html+=HU.onClick(get+".faster();",HU.div([ATTR_TITLE,"faster",ATTR_CLASS,c],HU.getIconImage(this.iconFaster)));html+=HU.onClick(get+".slower();",HU.div([ATTR_TITLE,"slower",ATTR_CLASS,c],HU.getIconImage(this.iconSlower)));html+=HU.div(["style","display:inline-block; min-height:24px; margin-left:10px;",ATTR_ID,this.getDomId(ID_TIME)],"&nbsp;");this.setDisplayTitle("Animation");this.setContents(html);},});}
function RamaddaMessageDisplay(displayManager,id,properties){const SUPER=new RamaddaDisplay(displayManager,id,DISPLAY_MESSAGE,properties);let myProps=[];defineDisplay(addRamaddaDisplay(this),SUPER,myProps,{needsData:function(){return false;},updateUI:function(){if(this.getProperty("decorate",true)){this.setContents(this.getMessage(this.getProperty("message",this.getNoDataMessage())));}else{this.setContents(this.getProperty("message",this.getNoDataMessage()));}}});}
function RamaddaFieldslistDisplay(displayManager,id,properties){const ID_POPUP="popup";const ID_POPUP_BUTTON="popupbutton";const SUPER=new RamaddaDisplay(displayManager,id,DISPLAY_FIELDSLIST,properties);let myProps=[{label:"Metadata"},{p:"decorate",ex:true},{p:"asList",ex:true},{p:"reverseFields",ex:true},{p:"selectable",ex:true},{p:"showFieldDetails",ex:true},{p:"showPopup",d:true,ex:false,tt:"Popup the selector"},{p:"numericOnly",ex:true},{p:"filterSelect",ex:true,tt:"Use this display to select filter fields"},{p:"filterSelectLabel",tt:"Label to use for the button"}];defineDisplay(addRamaddaDisplay(this),SUPER,myProps,{needsData:function(){return true;},updateUI:function(){let records=this.filterData();if(records==null)return;let html="";let selectedFields;if(this.getFilterSelect()){selectedFields=this.getFieldsByIds(null,this.getProperty("filterFields",""));}else{selectedFields=this.getFieldsByIds(null,this.getProperty("fields",""));}
if(this.selectedMap==null){this.selectedMap={};if(selectedFields&&selectedFields.length!=0){selectedFields.forEach(f=>{this.selectedMap[f.getId()]=true;});}else{selectedFields=null;}}else{selectedFields=null;}
let fields=this.getData().getRecordFields();if(this.getNumericOnly()){fields=fields.filter(f=>{return f.isFieldNumeric();});}
if(this.getReverseFields()){let tmp=[];fields.forEach(f=>{tmp.unshift(f);});fields=tmp;}
this.fields=fields;this.fieldsMap={};this.fields.forEach(f=>{this.fieldsMap[f.getId()]=f;});let fs=[];let clazz=" display-fields-field ";let asList=this.getAsList();if(this.getDecorate(true))clazz+=" display-fields-field-decorated ";if(asList)
clazz+=" display-fields-list-field";let selectable=this.getSelectable(true);let details=this.getShowFieldDetails(false);fields.forEach((f,idx)=>{let block=f.getLabel();if(details){block+="<br>"+
f.getId()+f.getUnitSuffix()+"<br>"+
f.getType();}
let c=clazz;let selected=this.selectedMap[f.getId()];if(selectable)c+=" display-fields-field-selectable ";if(selectable&&selected)c+=" display-fields-field-selected ";let title="";if(selectable)
title="Click to toggle. Shift-click toggle all";block=HU.div([TITLE,title,"field-selected",selected,"field-id",f.getId(),'class',c],block);fs.push(block);});let fhtml=Utils.wrap(fs,"","");html+=fhtml;if(this.getShowPopup()){html=HU.div([ID,this.domId(ID_POPUP_BUTTON)],this.getFilterSelect()?this.getFilterSelectLabel("Select Filter Fields"):"Select fields")+
HU.div([ID,this.domId(ID_POPUP),STYLE,"display:none;max-height:300px;overflow-y:auto;width:600px;"],html);}
this.setContents(html);if(this.getShowPopup()){this.jq(ID_POPUP_BUTTON).button().click(()=>{HU.makeDialog({contentId:this.domId(ID_POPUP),inPlace:true,anchor:this.domId(ID_POPUP_BUTTON),draggable:true,header:true,sticky:true});});}
if(selectable){let _this=this;let fieldBoxes=this.find(".display-fields-field");fieldBoxes.click(function(event){let shift=event.shiftKey;let selected=$(this).attr("field-selected")=="true";selected=!selected;$(this).attr("field-selected",selected);if(selected){$(this).addClass("display-fields-field-selected");}else{$(this).removeClass("display-fields-field-selected");}
if(shift){fieldBoxes.attr("field-selected",selected);if(selected){fieldBoxes.addClass("display-fields-field-selected");}else{fieldBoxes.removeClass("display-fields-field-selected");}}
let selectedFields=[];fieldBoxes.each(function(){let selected=$(this).attr("field-selected")=="true";if(selected){let id=$(this).attr("field-id");let field=_this.fieldsMap[id];if(field)selectedFields.push(field);}});_this.selectedMap={};selectedFields.forEach(f=>{_this.selectedMap[f.getId()]=true;});setTimeout(()=>{if(_this.getFilterSelect()){_this.propagateEvent(DisplayEvent.filterFieldsSelected,selectedFields);}else{_this.propagateEvent(DisplayEvent.fieldsSelected,selectedFields);}},20);});}}});}
function RamaddaLabelDisplay(displayManager,id,properties){var ID_TEXT="text";var ID_EDIT="edit";if(properties&&!Utils.isDefined(properties.showTitle)){properties.showTitle=false;}
this.text="";this.editMode=properties.editMode;if(properties.text)this.text=properties.text;else if(properties.label)this.text=properties.label;else if(properties.html)this.text=properties.html;if(properties["class"])this["class"]=properties["class"];else this["class"]="display-text";const SUPER=new RamaddaDisplay(displayManager,id,DISPLAY_LABEL,properties);let myProps=[];defineDisplay(addRamaddaDisplay(this),SUPER,myProps,{initDisplay:function(){var theDisplay=this;this.createUI();var textClass=this["class"];if(this.editMode){textClass+=" display-text-edit ";}
var style="color:"+this.getTextColor("contentsColor")+";";var html=HU.div([ATTR_CLASS,textClass,ATTR_ID,this.getDomId(ID_TEXT),"style",style],this.text);if(this.editMode){html+=HU.textarea(ID_EDIT,this.text,["rows",5,"cols",120,ATTR_SIZE,"120",ATTR_CLASS,"display-text-input",ATTR_ID,this.getDomId(ID_EDIT)]);}
this.setContents(html);if(this.editMode){var editObj=this.jq(ID_EDIT);editObj.blur(function(){theDisplay.text=editObj.val();editObj.hide();theDisplay.initDisplay();});this.jq(ID_TEXT).click(function(){var src=theDisplay.jq(ID_TEXT);var edit=theDisplay.jq(ID_EDIT);edit.show();edit.css('z-index','9999');edit.position({of:src,my:"left top",at:"left top",collision:"none none"});theDisplay.jq(ID_TEXT).html("");});}},getWikiAttributes:function(attrs){SUPER.getWikiAttributes(attrs);attrs.push("text");attrs.push(this.text);},});}
function RamaddaLegendDisplay(displayManager,id,properties){if(!properties.width)properties.width='100%';let SUPER=new RamaddaDisplay(displayManager,id,DISPLAY_LEGEND,properties);RamaddaUtil.inherit(this,SUPER);let myProps=[{label:'Legend'},{p:'labels',ex:''},{p:'colors',ex:''},{p:'inBox',ex:'true'},{p:'labelColor',ex:'#fff'},{p:'labelColors',ex:'color1,color2,...'},{p:'orientation',ex:'vertical'}];defineDisplay(addRamaddaDisplay(this),SUPER,myProps,{needsData:function(){return false;},updateUI:function(){let labels=this.getProperty("labels","").split(",");let colors=this.getColorList();let html="";let colorWidth=this.getProperty("colorWidth","20px");let labelColor=this.getProperty("labelColor","#000");let labelColors=this.getProperty("labelColors")?this.getProperty("labelColors").split(","):null;let inBox=this.getProperty("inBox",false);let orientation=this.getProperty("orientation","horizontal");let delim=orientation=="horizontal"?" ":"<br>";for(let i=0;i<labels.length;i++){let label=labels[i];let color=colors[i]||"#fff";if(i>0)html+=delim;if(!inBox){html+=HU.div(["class","display-legend-item"],HU.div(["class","display-legend-color","style","background:"+color+";width:"+colorWidth+";"+
"height:15px;"])+
HU.div(["class","display-legend-label"],label));}else{let lc=labelColors?labelColors[i]:labelColor||labelColor;html+=HU.div(["class","display-legend-color","style","margin-left:8px;background:"+color+";"],HU.div(["class","display-legend-label","style","margin-left:8px;margin-right:8x;color:"+lc+";"],label));}}
if(orientation!="vertical"){html=HU.center(html);}
this.setContents(html);},});}
function RamaddaDownloadDisplay(displayManager,id,properties){const SUPER=new RamaddaFieldsDisplay(displayManager,id,DISPLAY_DOWNLOAD,properties);const ID_DOWNLOAD_CSV="downloadcsv";const ID_DOWNLOAD_JSON="downloadjson";const ID_DOWNLOAD_COPY="downloadcopy";const ID_CANCEL="cancel";let myProps=[{label:'Download'},{p:'csvLabel',ex:'Download'},{p:'useIcon',d:'false',ex:'false'},{p:'iconSize',ex:''},{p:'fileName',d:'download',ex:'download'},{p:'askFields',d:'false',ex:'true'},{p:'showCsvButton',ex:false,tt:'Show/hide the CSV button'},{p:'showJsonButton',ex:false,tt:'Show/hide the JSON button'},{p:'showCopyButton',ex:false,tt:'Show/hide the Copy button'},];defineDisplay(addRamaddaDisplay(this),SUPER,myProps,{fieldOn:{},needsData:function(){return true;},updateUI:function(){let label=this.getPropertyCsvLabel("Download Data");label=label.replace("${title}",this.getProperty("title",""));let useIcon=this.getPropertyUseIcon(true);label=HU.span([ID,this.getDomId("csv")],useIcon?HU.getIconImage("fa-download",[STYLE,"cursor:pointer;font-size:32pt !important;",TITLE,label]):label);this.setContents(HU.div([],label));if(useIcon){this.jq("csv").click(()=>{this.doDownload();});}else{this.jq("csv").button().click(()=>{this.doDownload();});}},getCsv:function(fields,records,copy){fields=fields||this.getData().getRecordFields();let csv=DataUtils.getCsv(fields,records);if(copy){Utils.copyToClipboard(csv);alert("Copied to clipboard");}else{Utils.makeDownloadFile(this.getPropertyFileName()+".csv",csv);}},getJson:function(fields,records){fields=fields||this.getData().getRecordFields();DataUtils.getJson(fields,records,this.getPropertyFileName()+".json");},applyFieldSelection:function(){this.getData().getRecordFields().forEach(f=>{let cbx=this.jq("cbx_"+f.getId());let on=cbx.is(':checked');this.fieldOn[f.getId()]=on;});},getDownloadDialog:function(records){let selectedFields=this.getSelectedFields();if(selectedFields){this.fieldOn={};this.getData().getRecordFields().forEach(f=>{this.fieldOn[f.getId()]=false;});selectedFields.forEach(f=>{this.fieldOn[f.getId()]=true;});}
let space=SPACE;let buttons="";if(this.getShowCsvButton(true))
buttons+=HU.div([ID,this.getDomId(ID_DOWNLOAD_CSV)],"CSV")+space;if(this.getShowJsonButton(true))
buttons+=HU.div([ID,this.getDomId(ID_DOWNLOAD_JSON)],"JSON")+space;if(this.getShowCopyButton(true))
buttons+=HU.div([ID,this.getDomId(ID_DOWNLOAD_COPY)],"Copy")+space;buttons+=HU.div([ID,this.getDomId(ID_CANCEL)],"Cancel");let html=HU.center("#"+records.length+" records")+HU.center(buttons);html+="<b>Include:</b>";let cbx="";cbx+=HU.checkbox(this.getDomId("cbx_toggle_all"),[],true,"Toggle all")+"<br>";this.getData().getRecordFields().forEach((f,idx)=>{let on=this.fieldOn[f.getId()];if(!Utils.isDefined(on)){on=true;}
cbx+=HU.checkbox(this.getDomId("cbx_"+f.getId()),[CLASS,"display-downloader-field-cbx"],on,f.getLabel())+"<br>";});html+=HU.div([STYLE,HU.css("max-height","200px","overflow-y","auto","margin-left","10px")],cbx);html=HU.div([STYLE,HU.css("margin","5px")],html);return html;},doDownload:function(){let records=this.filterData();let func=(json,copy)=>{this.jq(ID_DIALOG).hide();let fields=[];this.applyFieldSelection();this.getData().getRecordFields().forEach(f=>{if(this.fieldOn[f.getId()]){fields.push(f);}});if(json)
this.getJson(fields,records);else
this.getCsv(fields,records,copy);if(this.dialog)this.dialog.remove();this.dialog=null;};if(this.getPropertyAskFields(true)){let html=this.getDownloadDialog(records);let dialog;let init=()=>{let _this=this;this.jq("cbx_toggle_all").click(function(){let on=$(this).is(':checked');dialog.find(".display-downloader-field-cbx").each(function(){$(this).prop("checked",on);});});this.jq(ID_CANCEL).button().click(()=>{this.applyFieldSelection();this.jq(ID_DIALOG).hide();if(this.dialog)this.dialog.remove();this.dialog=null;});this.jq(ID_DOWNLOAD_CSV).button().click(()=>{func(false);});this.jq(ID_DOWNLOAD_JSON).button().click(()=>{func(true);});this.jq(ID_DOWNLOAD_COPY).button().click(()=>{func(false,true);});};dialog=this.showDialog(html,this.getDomId(ID_DISPLAY_CONTENTS),init,this.getTitle());}else{this.getCsv(null,records);}},});}
function RamaddaReloaderDisplay(displayManager,id,properties){const ID_CHECKBOX="cbx";const ID_COUNTDOWN="countdown";const SUPER=new RamaddaFieldsDisplay(displayManager,id,DISPLAY_RELOADER,properties);let myProps=[{label:'Reloader'},{p:'interval',ex:'30',d:30,label:"Interval"},{p:'showCheckbox',ex:'false',d:true,label:"Show Checkbox"},{p:'showCountdown',ex:'false',d:true,label:"Show Countdown"},];defineDisplay(addRamaddaDisplay(this),SUPER,myProps,{needsData:function(){return true;},xxpointDataLoaded:function(pointData,url,reload){},reloadData:function(){let pointData=this.dataCollection.getList()[0];pointData.loadData(this,true);},updateUI:function(){let html="";if(this.jq(ID_COUNTDOWN).length>0)return;if(this.getPropertyShowCheckbox()){html+=HU.checkbox(this.getDomId(ID_CHECKBOX),[],true);}
if(this.getPropertyShowCountdown()){html+=" "+HU.span([CLASS,"display-reloader-label",ID,this.getDomId(ID_COUNTDOWN)],this.getCountdownLabel(this.getPropertyInterval()));}else{if(this.getPropertyShowCheckbox()){html+=" "+HU.span([ID,this.getDomId(ID_COUNTDOWN)],"Reload");}}
this.setContents(html);this.clearDisplayMessage();this.jq(ID_CHECKBOX).change(()=>{let cbx=this.jq(ID_CHECKBOX);if(cbx.is(':checked')){this.setTimer(this.lastTime);}});this.jq(ID_COUNTDOWN).addClass("ramadda-clickable").css("cursor","pointer").attr("title","Reload").click(()=>{this.checkReload(-1);});this.setTimer(this.getPropertyInterval());},setDisplayMessage:function(msg){},okToRun:function(){let cbx=this.jq(ID_CHECKBOX);if(cbx.length==0)return true;return cbx.is(':checked');},getCountdownLabel:function(time){let pad="";if(time<10)pad="&nbsp;";if(time>60){let minutes=Math.round((time-time%60)/60);let seconds=time%60;if(minutes<10)minutes="0"+String(minutes);if(seconds<10)seconds="0"+String(seconds);return"Reload in "+minutes+":"+seconds+pad;}
return"Reload in "+time+" seconds"+pad;},updateCountdown(time){if(this.getPropertyShowCountdown()){this.jq(ID_COUNTDOWN).html(this.getCountdownLabel(time));}else{this.jq(ID_COUNTDOWN).html("Reload");}},setTimer(time){if(!this.okToRun())return;this.lastTime=time;this.updateCountdown(time);if(this.lastTimeout)clearTimeout(this.lastTimeout);this.lastTimeout=setTimeout(()=>{this.checkReload(time);},1000);},checkReload:function(time){time--;if(time<=0){this.jq(ID_COUNTDOWN).html("Reloading..."+HU.span([STYLE,"color:transparent;"],""));this.reloadData();time=this.getPropertyInterval();if(this.lastTimeout)clearTimeout(this.lastTimeout);this.lastTimeout=setTimeout(()=>{this.setTimer(time);},1000);}else{this.setTimer(time);}}});}
function RamaddaTicksDisplay(displayManager,id,properties){if(!properties.animationHeight)properties.animationHeight="30px";properties.doAnimation=false;properties.animationShowButtons=false;properties.animationMakeSlider=false;const ID_ANIMATION="animation";const SUPER=new RamaddaFieldsDisplay(displayManager,id,DISPLAY_TICKS,properties);let myProps=[{label:'Time Ticks'},{p:'animationHeight',ex:'30px'},{p:'showYears',ex:'true'},];defineDisplay(addRamaddaDisplay(this),SUPER,myProps,{needsData:function(){return true;},dataFilterChanged:function(){SUPER.dataFilterChanged.call(this);},updateUI:function(){let records=this.filterData();if(!records)return;let dateInfo=this.getDateInfo(records);let years={}
if(!this.getPropertyShowYears(false)){years["all"]={records:records,yearCnt:"all"}}else{let yearCnt=0;records.forEach(record=>{if(!record.getDate())return;let year=record.getDate().getUTCFullYear();if(years[year]==null){years[year]={records:[],}}
years[year].records.push(record);});}
let html="";Object.keys(years).sort().forEach(year=>{html+=HU.div([CLASS,'display-ticks-ticks',ID,this.getDomId(ID_ANIMATION+year)]);})
this.setContents(html);Object.keys(years).sort().forEach((year,idx)=>{let info=years[year];let dateInfo=this.getDateInfo(info.records);let animation=new DisplayAnimation(this,true,{baseDomId:ID_ANIMATION+year,targetDiv:this.jq(ID_ANIMATION+year)});animation.makeControls();if(year!="all"){dateInfo.dateMin=new Date(Date.UTC(year,0,1));dateInfo.dateMax=new Date(Date.UTC(year,11,31));}
animation.init(dateInfo.dateMin,dateInfo.dateMax,info.records);});}});}
function RamaddaMenuDisplay(displayManager,id,properties){const ID_MENU="menu";const ID_PREV="prev";const ID_NEXT="next";const SUPER=new RamaddaFieldsDisplay(displayManager,id,DISPLAY_MENU,properties);let myProps=[{label:'Record Menu'},{p:'labelTemplate',d:'${name}'},{p:'menuLabel',ex:''},{p:'showArrows',d:false,ex:true},];defineDisplay(addRamaddaDisplay(this),SUPER,myProps,{needsData:function(){return true;},handleEventRecordSelection:function(source,args){SUPER.handleEventRecordSelection.call(this,source,args);if(!this.recordToIdx)return;let idx=this.recordToIdx[args.record.getId()];if(Utils.isDefined(idx)){this.jq(ID_MENU).val(idx);}},pointDataLoaded:function(pointData,url,reload){SUPER.pointDataLoaded.call(this,pointData,url,reload);console.log("menu pointDataLoaded");if(this.haveLoadedData&&this.records){setTimeout(()=>{let record=this.records[+this.jq(ID_MENU).val()];console.log("changing:"+record);if(record){this.propagateEventRecordSelection({record:record});}},100);}
this.haveLoadedData=true;},updateUI:function(){this.records=this.filterData();if(!this.records)return;let options=[];let labelTemplate=this.getLabelTemplate();this.recordToIdx={};this.records.forEach((record,idx)=>{let label=this.getRecordHtml(record,null,labelTemplate);options.push([idx,label]);this.recordToIdx[record.getId()]=idx;});let menu=HU.select("",[ATTR_ID,this.getDomId(ID_MENU)],options);if(this.getShowArrows(false)){let noun=this.getProperty("noun","Data");let prev=HU.span([CLASS,"display-changeentries-button",TITLE,"Previous "+noun,ID,this.getDomId(ID_PREV),TITLE,"Previous"],HU.getIconImage("fa-chevron-left"));let next=HU.span([CLASS,"display-changeentries-button",TITLE,"Next "+noun,ID,this.getDomId(ID_NEXT),TITLE,"Next"],HU.getIconImage("fa-chevron-right"));menu=prev+" "+menu+" "+next;}
let label=this.getMenuLabel();if(label)menu=label+" "+menu;this.setContents(menu);if(this.getShowArrows(false)){this.jq(ID_PREV).click(e=>{let index=+this.jq(ID_MENU).val()-1;if(index<0){index=this.records.length-1;}
this.jq(ID_MENU).val(index).trigger("change");});this.jq(ID_NEXT).click(e=>{let index=+this.jq(ID_MENU).val()+1;if(index>=this.records.length){index=0;}
this.jq(ID_MENU).val(index).trigger("change");});}
this.jq(ID_MENU).change(()=>{let record=this.records[+this.jq(ID_MENU).val()];this.propagateEventRecordSelection({record:record});});}});}
const DISPLAY_NOTEBOOK="notebook";addGlobalDisplayType({type:DISPLAY_NOTEBOOK,label:"Notebook",requiresData:false,category:CATEGORY_CONTROLS});var pluginDefintions={'jsx':{"languageId":"jsx","displayName":"React JSX","url":"https://raw.githubusercontent.com/hamilton/iodide-jsx/master/docs/evaluate-jsx.js","module":"jsx","evaluator":"evaluateJSX","pluginType":"language"},"lisp":{"languageId":"lisp","displayName":"Microtalk Lisp","url":"https://ds604.neocities.org/js/microtalk.js","module":"MICROTALK","evaluator":"evaluate","pluginType":"language","outputHandler":"processLispOutput",},"sql":{"languageId":"sql","displayName":"SqlLite","url":ramaddaBaseHtdocs+"/lib/notebook/sqllite.js","module":"SqlLite","evaluator":"evaluate","pluginType":"language"},"plantuml":{"languageId":"plantuml","displayName":"PlantUml","codeMirrorMode":"","keybinding":"x","url":"https://raw.githubusercontent.com/six42/iodide-plantuml-plugin/master/src/iodide-plantuml-plugin.js","depends":[{"type":"js","url":"https://raw.githubusercontent.com/johan/js-deflate/master/rawdeflate.js"}],"module":"plantuml","evaluator":"plantuml_img","pluginType":"language"},"ml":{"languageId":"ml","displayName":"ocaml","codeMirrorMode":"mllike","keybinding":"o","url":"https://louisabraham.github.io/domical/eval.js","module":"evaluator","evaluator":"execute","pluginType":"language","depends":[{"type":"css","url":"https://louisabraham.github.io/domical/style.css"}]}};function RamaddaNotebookDisplay(displayManager,id,properties){var ID_NOTEBOOK="notebook";var ID_IMPORTS="imports";var ID_CELLS="cells";var ID_CELLS_BOTTOM="cellsbottom";var ID_INPUTS="inputs";var ID_OUTPUTS="outputs";var ID_CONSOLE="console";var ID_CONSOLE_TOOLBAR="consoletoolbar";var ID_CONSOLE_CONTAINER="consolecontainer";var ID_CONSOLE_OUTPUT="consoleout";var ID_CELL="cell";var ID_MENU="menu";this.properties=properties||{};let SUPER=new RamaddaDisplay(displayManager,id,DISPLAY_NOTEBOOK,properties);RamaddaUtil.inherit(this,SUPER);addRamaddaDisplay(this);RamaddaUtil.defineMembers(this,{runOnLoad:this.getProperty("runOnLoad",true),displayMode:this.getProperty("displayMode",false),showConsole:this.getProperty("showConsole",true),consoleHidden:this.getProperty("consoleHidden",false),layout:this.getProperty("layout","horizontal"),columns:this.getProperty("columns",1),});RamaddaUtil.defineMembers(this,{cells:[],cellCount:0,fetchedNotebook:false,currentEntries:{},globals:{},baseEntries:{},outputRenderers:[],initDisplay:async function(){this.createUI();var imports=HtmlUtils.div(["id",this.getDomId(ID_IMPORTS)]);var contents=imports+HtmlUtils.div([ATTR_CLASS,"display-notebook-cells",ATTR_ID,this.getDomId(ID_CELLS)],"&nbsp;&nbsp;Loading...")+
HtmlUtils.div([ATTR_ID,this.getDomId(ID_CELLS_BOTTOM)]);var popup=HtmlUtils.div(["class","ramadda-popup",ATTR_ID,this.getDomId(ID_MENU)]);contents=HtmlUtils.div([ATTR_ID,this.getDomId(ID_NOTEBOOK)],popup+contents);this.setContents(contents);this.makeCellLayout();this.jq(ID_NOTEBOOK).hover(()=>{},()=>{this.jq(ID_MENU).hide()});if(!this.fetchedNotebook){this.initOutputRenderers();if(!this.fetchingNotebook){this.fetchingNotebook=true;await Utils.importCSS(ramaddaBaseHtdocs+"/lib/fontawesome/css/all.min.css");await Utils.importJS(ramaddaBaseHtdocs+"/lib/ace/src-min/ace.js");await Utils.importJS(ramaddaBaseUrl+"/lib/showdown.min.js");var imports="<link rel='preload' href='https://cdn.jsdelivr.net/npm/katex@0.10.1/dist/fonts/KaTeX_Main-Regular.woff2' as='font' type='font/woff2' crossorigin='anonymous'>\n<link rel='preload' href='https://cdn.jsdelivr.net/npm/katex@0.10.1/dist/fonts/KaTeX_Math-Italic.woff2' as='font' type='font/woff2' crossorigin='anonymous'>\n<link rel='preload' href='https://cdn.jsdelivr.net/npm/katex@0.10.1/dist/fonts/KaTeX_Size2-Regular.woff2' as='font' type='font/woff2' crossorigin='anonymous'>\n<link rel='preload' href='https://cdn.jsdelivr.net/npm/katex@0.10.1/dist/fonts/KaTeX_Size4-Regular.woff2' as='font' type='font/woff2' crossorigin='anonymous'/>\n<link rel='stylesheet' href='https://fonts.googleapis.com/css?family=Lato:300,400,700,700i'>\n<link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/katex@0.10.1/dist/katex.min.css' crossorigin='anonymous'>\n<link rel='stylesheet' href='static/index.css'><script defer src='https://cdn.jsdelivr.net/npm/katex@0.10.1/dist/katex.min.js' crossorigin='anonymous'></script>";$(imports).appendTo("head");setTimeout(()=>this.fetchNotebook(1),10);}}else{this.layoutCells();}},fetchNotebook:async function(cnt){if(!window["ace"]){if(cnt>50){alert("Could not load ace.js");return;}
setTimeout(()=>this.fetchNotebook(cnt+1),cnt*10);return;}
var dttm=new Date().getTime();ace.config.set('basePath',ramaddaBaseUrl+"/htdocs_v"+dttm+"/lib/ace/src-min");let _this=this;this.fetchedNotebook=true;await this.getEntry(this.getProperty("entryId",""),entry=>{this.baseEntry=entry;});await this.baseEntry.getRoot(entry=>{this.rootEntry=entry;});var id=this.getProperty("entryId","");var url=ramaddaBaseUrl+"/getnotebook?entryid="+id;url+="&notebookId="+this.getProperty("notebookId","default_notebook");var jqxhr=$.getJSON(url,function(data){_this.loadJson(data);}).fail(function(){var props={showInput:true,}
this.addCell("init cell",props,false).run();this.cells[0].focus();});},formatObject:function(value){return Utils.formatJson(value);},initOutputRenderers:function(){let notebook=this;this.outputRenderers=[];this.addOutputRenderer({shouldRender:(value)=>{return Array.isArray(value);},render:(value)=>{return Utils.formatJson(value);},});this.addOutputRenderer({shouldRender:(value)=>{return Array.isArray(value)&&value.length>0&&Array.isArray(value[0]);},render:(value)=>{var table="<table>";for(var rowIdx=0;rowIdx<value.length;rowIdx++){var row=value[rowIdx];table+="<tr>";for(var colIdx=0;colIdx<row.length;colIdx++){table+="<td>&nbsp;"+row[colIdx]+"</td>";}
table+="</tr>";}
table+="</table>";return table;}});this.addOutputRenderer({shouldRender:(value)=>{return typeof value==="object"&&value.getTime;},render:(value)=>{return notebook.formatDate(value)},});this.addOutputRenderer({shouldRender:(value)=>{var t=typeof value;return t==="string"||t==="number"||t==="boolean";},render:(value)=>{if(typeof value==="string"){if(value.split("\n").length>1){return HtmlUtils.div(["style"," white-space: pre;"],value);}}
return value},});this.addOutputRenderer({shouldRender:(value)=>{return typeof value==="object"&&"lat"in value&&"lon"in value;},render:(value)=>{var url='http://staticmap.openstreetmap.de/staticmap.php?center='+value.lat+','+value.lon+'&zoom=17&size=400x150&maptype=mapnik';return"<img src='"+url+"'/>"},});},addOutputRenderer:function(renderer){if(this.outputRenderers.indexOf(renderer)<0){this.outputRenderers.push(renderer);}},formatOutput:function(value){if(!value)return null;for(var i=this.outputRenderers.length-1;i>=0;i--){var renderer=this.outputRenderers[i];if(renderer.shouldRender&&renderer.shouldRender(value)){return renderer.render(value);}}
var v=null;if(value.iodideRender){v=value.iodideRender();}else if(value.notebookRender){v=value.notebookRender();}
if(v){if(typeof v=="string"){return v;}}
return null;},getBaseEntry:function(){return this.baseEntry;},getRootEntry:function(){return this.rootEntry;},getPopup:function(){return this.jq(ID_MENU);},loadJson:async function(data){if(data.error){this.setContents(_this.getMessage("Failed to load notebook: "+data.error));return;}
if(!Utils.isDefined(this.properties.runOnLoad)&&Utils.isDefined(data.runOnLoad)){this.runOnLoad=data.runOnLoad;}
if(!Utils.isDefined(this.properties.displayMode)&&Utils.isDefined(data.displayMode)){this.displayMode=data.displayMode;}
if(!Utils.isDefined(this.properties.showConsole)&&Utils.isDefined(data.showConsole)){this.showConsole=data.showConsole;}
if(Utils.isDefined(data.consoleHidden)){this.consoleHidden=data.consoleHidden;}
if(!Utils.isDefined(this.properties.columns)&&Utils.isDefined(data.columns)){this.columns=data.columns;}
if(!Utils.isDefined(this.properties.layout)&&Utils.isDefined(data.layout)){this.layout=data.layout;}
if(Utils.isDefined(data.currentEntries)){for(a in data.currentEntries){var obj={};if(this.currentEntries[a])continue;obj.name=a;obj.entryId=data.currentEntries[a].entryId;try{await this.getEntry(obj.entryId,e=>obj.entry=e);this.currentEntries[a]=obj;}catch(e){}}}
if(Utils.isDefined(data.cells)){this.cells=[];data.cells.forEach(cell=>this.addCell(cell.outputHtml,cell,true));this.layoutCells();}
if(this.cells.length==0){var props={showInput:true,}
this.addCell("%%wiki\n",props,false);this.layoutCells();this.cells[0].focus();}
if(this.runOnLoad){this.runAll();}},addEntry:async function(name,entryId){var entry;await this.getEntry(entryId,e=>entry=e);this.currentEntries[name]={entryId:entryId,entry:entry};},getCurrentEntries:function(){return this.currentEntries;},clearEntries:function(){this.currentEntries={};for(a in this.baseEntries)
this.currentEntries[a]=this.baseEntries[a];},saveNotebook:function(output){var json=this.getJson(output);json=JSON.stringify(json,null,2);var args={entryid:this.getProperty("entryId",""),notebookId:this.getProperty("notebookId","default_notebook"),notebook:json};var url=ramaddaBaseUrl+"/savenotebook";$.post(url,args,(result)=>{if(result.error){alert("Error saving notebook: "+result.error);return;}
if(result.result!="ok"){alert("Error saving notebook: "+result.result);return;}
if(!this.getShowConsole()){alert("Notebook saved");}else{this.log("Notebook saved","info","nb");}});},showInput:function(){if(this.displayMode&&!this.getProperty("user")){return false;}
if(this.getProperty("showInput",true)==false){return false;}
return true;},getJson:function(output){var obj={cells:[],currentEntries:{},runOnLoad:this.runOnLoad,displayMode:this.displayMode,showConsole:this.showConsole,consoleHidden:this.consoleHidden,layout:this.layout,columns:this.columns,};for(var name in this.currentEntries){var e=this.currentEntries[name];obj.currentEntries[name]={entryId:e.entryId};}
this.cells.forEach(cell=>obj.cells.push(cell.getJson(output)));return obj;},initConsole:function(){if(!this.showInput()){return;}
let _this=this;this.console=this.jq(ID_CONSOLE_OUTPUT);if(this.consoleHidden)
this.console.hide();this.jq(ID_CONSOLE).find(".ramadda-image-link").click(function(e){var what=$(this).attr("what");if(what=="clear"){_this.console.html("");}
e.stopPropagation();});this.consoleToolbar=this.jq(ID_CONSOLE_TOOLBAR);this.consoleToolbar.click(()=>{if(this.console.is(":visible")){this.console.hide(400);this.consoleHidden=true;}else{this.consoleHidden=false;this.console.show(400);}});},getShowConsole:function(){return this.showInput()&&this.showConsole;},makeConsole:function(){this.console=null;if(!this.getShowConsole()){return"";}
var contents=this.jq(ID_CONSOLE_OUTPUT).html();var consoleToolbar=HtmlUtils.div(["id",this.getDomId(ID_CONSOLE_TOOLBAR),"class","display-notebook-console-toolbar","title","click to hide/show console"],HtmlUtils.leftRight("",HtmlUtils.span(["class","ramadda-image-link","title","Clear","what","clear"],HtmlUtils.image(Utils.getIcon("clear.png")))));return HtmlUtils.div(["id",this.getDomId(ID_CONSOLE),"class","display-notebook-console"],consoleToolbar+
HtmlUtils.div(["class","display-notebook-console-output","id",this.getDomId(ID_CONSOLE_OUTPUT)],contents||""));},makeCellLayout:function(){var html="";var consoleContainer=HtmlUtils.div(["id",this.getDomId(ID_CONSOLE_CONTAINER)]);this.jq(ID_CELLS_BOTTOM).html("");if(this.showInput()&&this.layout=="horizontal"){var left=HtmlUtils.div(["id",this.getDomId(ID_INPUTS),"style","width:100%;"]);var right=HtmlUtils.div(["id",this.getDomId(ID_OUTPUTS),"style","width:100%;"]);var center=HtmlUtils.div([],"");left+=consoleContainer;html="<table style='table-layout:fixed;' border=0 width=100%><tr valign=top><td width=50%>"+left+"</td><td style='border-left:1px #ccc solid;' width=1>"+center+"</td><td width=49%>"+right+"</td></tr></table>";}else{this.jq(ID_CELLS_BOTTOM).html(consoleContainer);}
this.jq(ID_CELLS).html(html);},plugins:{},addPlugin:async function(plugin,chunk){var error;if(plugin.depends){for(var i=0;i<plugin.depends.length;i++){var obj=plugin.depends[i];var type=obj.type;var url=obj.url;if(type=="js"){await Utils.importJS(url,()=>{},(jqxhr,settings,exception)=>{error="Error fetching plugin url:"+url;});}else if(type=="css"){await Utils.importCSS(url,()=>{},(jqxhr,settings,exception)=>{error="Error fetching plugin url:"+url;});}
if(error){this.log(error,"error","nb",chunk?chunk.div:null);return;}}}
var url=Utils.replaceRoot(plugin.url);await Utils.importJS(url,()=>{},(jqxhr,settings,exception)=>{error="Error fetching plugin url:"+url;});if(!error){var module=plugin.module;var tries=200;while(window[module]==null&&tries-->0){await new Promise(resolve=>setTimeout(resolve,100));}
if(!window[module]){error="Could not load plugin module: "+module;}else{if(window[module].isPluginReady){var tries=200;while(!window[module].isPluginReady()&&tries-->0){await new Promise(resolve=>setTimeout(resolve,100));}
if(!window[module].isPluginReady())
error="Could not load plugin module: "+module;}}}
if(error){this.log(error,"error","nb",chunk?chunk.div:null);return;}
this.plugins[plugin.languageId]=plugin;},hasPlugin:async function(id,callback){if(!this.plugins[id]){if(window.pluginDefintions[id]){await this.addPlugin(window.pluginDefintions[id],null);}}
Utils.call(callback,this.plugins[id]!=null);},processChunkWithPlugin:async function(id,chunk,callback){var module=this.plugins[id].module;var func=this.plugins[id].evaluator;var result=window[module][func](chunk.getContent(),chunk);return Utils.call(callback,result);},processPluginOutput:function(id,chunk,result){if(!result)return;var module=this.plugins[id].module;var func=window[this.plugins[id].outputHandler];if(func){chunk.div.append(func(result));}else{if(typeof result=="object"){}else{chunk.div.set(result);}}},log:function(msg,type,from,div){var icon="";var clazz="display-notebook-console-item";if(typeof msg=="object"){msg=Utils.formatJson(msg);}
if(type=="error"){clazz+=" display-notebook-console-item-error";icon=HtmlUtils.image(Utils.getIcon("cross-octagon.png"));if(div){div.append(HtmlUtils.div(["class","display-notebook-chunk-error"],msg));}}else if(type=="output"){clazz+=" display-notebook-console-item-output";icon=HtmlUtils.image(Utils.getIcon("arrow-000-small.png"));}else if(type=="info"){clazz+=" display-notebook-console-item-info";icon=HtmlUtils.image(Utils.getIcon("information.png"));}
if(!this.console)return;if(!from)from="";else from=HtmlUtils.div(["class","display-notebook-console-from"],from);var block=HtmlUtils.div(["style","margin-left:5px;"],msg);var html="<table width=100%><tr valign=top><td width=10>"+icon+"</td><td>"+
block+
"</td><td width=10>"+
from+
"</td></tr></table>";var item=HtmlUtils.div(["class",clazz],html);this.console.append(item);var height=this.console.prop('scrollHeight');if(height>200)
this.console.scrollTop(height-200);},clearConsole:function(){this.console.html("");},layoutCells:function(){for(var i=0;i<this.cells.length;i++){var cell=this.cells[i];cell.prepareToLayout();}
this.makeCellLayout();if(this.showInput()&&this.layout=="horizontal"){var left="";var right="";var id;for(var i=0;i<this.cells.length;i++){var cell=this.cells[i];id=cell.id;cell.index=i+1;left+=HtmlUtils.div([ATTR_CLASS,"display-notebook-cell",ATTR_ID,cell.id+"_cellinput"],"");left+="\n";right+=HtmlUtils.div([ATTR_CLASS,"display-notebook-cell",ATTR_ID,cell.id+"_celloutput"],"");}
this.jq(ID_INPUTS).html(left);this.jq(ID_OUTPUTS).html(right);}else{var html="<div class=row style='padding:0px;margin:0px;'>";var clazz=HtmlUtils.getBootstrapClass(this.columns);var colCnt=0;for(var i=0;i<this.cells.length;i++){var cell=this.cells[i];cell.index=i+1;html+=HtmlUtils.openTag("div",["class",clazz]);html+=HtmlUtils.openTag("div",["style","max-width:100%;overflow-x:auto;padding:0px;margin:px;"]);html+=HtmlUtils.div([ATTR_CLASS,"display-notebook-cell",ATTR_ID,cell.id+"_cellinput"],"");html+=HtmlUtils.div([ATTR_CLASS,"display-notebook-cell",ATTR_ID,cell.id+"_celloutput"],"");html+=HtmlUtils.closeTag("div");html+=HtmlUtils.closeTag("div");html+="\n";colCnt++;if(colCnt>=this.columns){colCnt=0;html+=HtmlUtils.closeTag("div");html+="<div class=row style='padding:0px;margin:0px;'>";}};html+=HtmlUtils.closeTag("div");this.jq(ID_CELLS).append(html);}
for(var i=0;i<this.cells.length;i++){var cell=this.cells[i];cell.createCell();};this.jq(ID_CONSOLE_CONTAINER).html(this.makeConsole());this.initConsole();},addCell:function(content,props,layoutLater){cell=this.createCell(content,props);this.cells.push(cell);if(!layoutLater){if(this.showInput()&&this.layout=="horizontal"){this.jq(ID_INPUTS).append(HtmlUtils.div([ATTR_CLASS,"display-notebook-cell",ATTR_ID,cell.id+"_cellinput"],""));this.jq(ID_OUTPUTS).append(HtmlUtils.div([ATTR_CLASS,"display-notebook-cell",ATTR_ID,cell.id+"_celloutput"],""));}else{this.jq(ID_CELLS).append(HtmlUtils.div([ATTR_CLASS,"display-notebook-cell",ATTR_ID,cell.id+"_cellinput"],""));this.jq(ID_CELLS).append(HtmlUtils.div([ATTR_CLASS,"display-notebook-cell",ATTR_ID,cell.id+"_celloutput"],""));}
cell.createCell();}
return cell;},createCell:function(content,props){if(!props)props={showInput:true};var cellId=this.getId()+"_"+this.cellCount;props.id=cellId;this.cellCount++;this.jq(ID_CELLS).append(HtmlUtils.div([ATTR_CLASS,"display-notebook-cell",ATTR_ID,cellId],""));var cell=new RamaddaNotebookCell(this,cellId,content,props);return cell;},clearOutput:function(){this.cells.forEach(cell=>cell.clearOutput());},getIndex:function(cell){var idx=0;for(var i=0;i<this.cells.length;i++){if(cell.id==this.cells[i].id){idx=i;break;}}
return idx;},moveCellUp:function(cell){var cells=[];var newCell=null;var idx=this.getIndex(cell);if(idx==0)return;this.cells.splice(idx,1);this.cells.splice(idx-1,0,cell);this.layoutCells();cell.focus();},moveCellDown:function(cell){var cells=[];var newCell=null;var idx=this.getIndex(cell);if(idx==this.cells.length-1)return;this.cells.splice(idx,1);this.cells.splice(idx+1,0,cell);this.layoutCells();cell.focus();},newCellAbove:function(cell){var cells=[];var newCell=null;for(var i=0;i<this.cells.length;i++){if(cell.id==this.cells[i].id){newCell=this.createCell("%%wiki\n",{showInput:true,showHeader:false});cells.push(newCell);}
cells.push(this.cells[i]);}
this.cells=cells;this.layoutCells();newCell.focus();},newCellBelow:function(cell){var cells=[];var newCell=null;for(var i=0;i<this.cells.length;i++){cells.push(this.cells[i]);if(cell.id==this.cells[i].id){newCell=this.createCell("%%wiki\n",{showInput:true,showHeader:false});cells.push(newCell);}}
this.cells=cells;this.layoutCells();newCell.focus();},deleteCell:function(cell){cell.jq(ID_CELL).remove();var cells=[];this.cells.forEach(c=>{if(cell.id!=c.id){cells.push(c);}});this.cells=cells;if(this.cells.length==0){this.addCell("",null);}},cellValues:{},setCellValue:function(name,value){this.cellValues[name]=value;},getCellValues:function(){return this.cellValues;},convertInput:function(input){for(name in this.cellValues){var re=new RegExp("\\$\\{"+name+"\\}","g");input=input.replace(re,this.cellValues[name]);}
return input;},inGlobalChanged:false,globalChanged:async function(name,value){var globalChangeCalled=this.inGlobalChanged;var top=!this.inGlobalChanged;if(this.inRunAll){top=false;}
this.inGlobalChanged=true;if(top){this.cells.forEach(cell=>cell.prepareToRun());}
for(var i=0;i<this.cells.length;i++){await this.cells[i].globalChanged(name,value);}
if(!globalChangeCalled){this.inGlobalChanged=false;}},addGlobal:async function(name,value,dontPropagate){name=name.trim().replace(/[ -]/g,"_");var oldValue=this.getGlobalValue(name);if(Utils.isDefined(window[name]))window[name]=value;this.globals[name]=value;if(!dontPropagate){var newValue=this.getGlobalValue(name);if(newValue!=oldValue){}}},getGlobalValue:function(name){if(!this.globals[name])return null;if(typeof this.globals[name]=="function")return this.globals[name]();return this.globals[name];},inRunAll:false,runAll:async function(){this.inRunAll=true;var ok=true;this.cellValues={};for(var i=0;i<this.cells.length;i++){var cell=this.cells[i];cell.prepareToRun();}
for(var i=0;i<this.cells.length;i++){var cell=this.cells[i];if(!cell.runFirst)continue;await this.runCell(cell).then(result=>ok=result);}
if(!ok)return;for(var i=0;i<this.cells.length;i++){var cell=this.cells[i];if(cell.runFirst)continue;await this.runCell(cell,true).then(result=>ok=result);}
this.inRunAll=false;},runCell:async function(cell,doingAll){if(cell.hasRun)return true;await cell.run(result=>ok=result,{doingAll:doingAll});if(!ok)return false;var raw=cell.getRawOutput();if(raw){raw=raw.trim();if(Utils.stringDefined(cell.cellName)){this.cellValues[cell.cellName]=raw;}}
return true;},toggleAll:function(on){this.cells.forEach(cell=>{cell.showInput=on;cell.applyStyle();});},});}
var iodide={addOutputRenderer:function(renderer){notebook.addOutputRenderer(renderer);},addOutputHandler:function(renderer){notebook.addOutputHandler(renderer);},output:{text:function(t){notebook.write(t);},element:function(tag){var id=HtmlUtils.getUniqueId();notebook.write(HtmlUtils.tag(tag,["id",id]));return document.getElementById(id);}},};var notebook;function NotebookState(cell,div){this.id=HtmlUtils.getUniqueId();this.cell=cell;this.notebook=cell.notebook;$.extend(this,{entries:{},div:div,stopFlag:false,result:null,log:function(msg,type,from){this.getNotebook().log(msg,type,from,this.div);},clearConsole:function(){this.getNotebook().clearConsole();},getStop:function(){return this.stopFlag;},getCell:function(){return this.cell;},addGlobal:async function(name,value){await this.getNotebook().addGlobal(name,value);},globalChanged:async function(name,value){await this.getNotebook().globalChanged(name,value);},setValue:function(name,value){this.notebook.setCellValue(name,value);},makeData:async function(entry){if(!entry)
await this.getCurrentEntry(e=>entry=e);if((typeof entry)=="string"){await this.notebook.getEntry(entry,e=>entry=e);}
var jsonUrl=this.notebook.getPointUrl(entry);if(jsonUrl==null){this.writeError("Not a point type:"+entry.getName());return null;}
var pointDataProps={entry:entry,entryId:entry.getId()};return new PointData(entry.getName(),null,null,jsonUrl,pointDataProps);},log:function(msg,type){this.getNotebook().log(msg,type,"js");},getNotebook:function(){return this.notebook;},save:function(output){this.notebook.saveNotebook(output);return"notebook saved";},clearEntries:function(){this.clearEntries();},ls:async function(entry){var div=new Div();if(!entry)
await this.getCurrentEntry(e=>entry=e);this.call.getEntryHeading(entry,div);this.write(div.toString());},lsEntries:function(){var h="";var entries=this.currentEntries;for(var name in entries){var e=entries[name];h+=name+"="+e.entry.getName()+"<br>";}
this.write(h);},stop:function(){this.stopFlag=true;},setGlobal:async function(name,value){await this.cell.notebook.addGlobal(name,value);},setEntry:function(name,entryId){this.cell.notebook.addEntry(name,entryId);},getEntry:async function(entryId,callback){await this.cell.notebook.getEntry(e=>entry=e);return Utils.call(callback,entry);},wiki:async function(s,entry,callback){if(!callback){var wdiv=new Div();this.div.append(wdiv.toString());callback=h=>wdiv.append(h);}
if(entry==null)
await this.cell.getCurrentEntry(e=>entry=e);if((typeof entry)!="string")entry=entry.getId();await GuiUtils.loadHtml(ramaddaBaseUrl+"/wikify?doImports=false&entryid="+entry+"&text="+encodeURIComponent(s),callback);},addOutputRenderer:function(renderer){this.getNotebook().addOutputRenderer(renderer);},addOutputHandler:function(renderer){this.getNotebook().addOutputRenderer(renderer);},output:{text:function(t){notebook.write(t);},element:function(tag){var id=HtmlUtils.getUniqueId();notebook.write(HtmlUtils.tag(tag,["id",id]));return document.getElementById(id);}},clearOutput:function(){this.cell.clearOutput();},clearAllOutput:function(){this.getNotebook().clearOutput();},write:function(value,clear){if(!value)return;var s=this.getNotebook().formatOutput(value);if(s==null&&(typeof value)=="object"){s=this.notebook.formatObject(value);}
if(clear)
this.div.set(s);else
this.div.append(s);},linechart:async function(entry,props){if(!entry)
await this.cell.getCurrentEntry(e=>entry=e);this.cell.createDisplay(this,entry,DISPLAY_LINECHART,props);},});}
var notebookStates={};function RamaddaNotebookCell(notebook,id,content,props){this.notebook=notebook;var ID_CELL="cell";var ID_HEADER="header";var ID_CELLNAME="cellname";var ID_INPUT="input";var ID_INPUT_TOOLBAR="inputtoolbar";var ID_OUTPUT="output";var ID_MESSAGE="message";var ID_BUTTON_MENU="menubutton";var ID_BUTTON_RUN="runbutton";var ID_BUTTON_TOGGLE="togglebutton";var ID_MENU="menu";var ID_CELLNAME_INPUT="cellnameinput";var ID_SHOWHEADER_INPUT="showheader";var ID_SHOWEDIT="showedit";var ID_RUN_ON_LOAD="runonload";var ID_DISPLAY_MODE="displaymode";var ID_LAYOUT_TYPE="layouttype";var ID_SHOWCONSOLE="showconsole";var ID_LAYOUT_COLUMNS="layoutcolumns";var ID_RUNFIRST="runfirst";var ID_SHOW_OUTPUT="showoutput";var ID_RUN_ICON="runningicon";let SUPER=new DisplayThing(id,{});RamaddaUtil.inherit(this,SUPER);RamaddaUtil.defineMembers(this,{id:id,inputRows:1,index:0,content:content,outputHtml:"",showInput:false,showHeader:false,cellName:"",runFirst:false,showOutput:true,});if(props){$.extend(this,props);}
RamaddaUtil.defineMembers(this,{getJson:function(output){var obj={id:this.id,inputRows:this.inputRows,content:this.getInputText(),showInput:this.showInput,showHeader:this.showHeader,runFirst:this.runFirst,showOutput:this.showOutput,cellName:this.cellName,};if(this.currentEntry)
obj.currentEntryId=this.currentEntry.getId();if(output)
obj.outputHtml=this.outputHtml;return obj;},createCell:function(){if(this.content==null){this.content="%% wiki";}
this.editId=addHandler(this);addHandler(this,this.editId+"_entryid");addHandler(this,this.editId+"_wikilink");var _this=this;var buttons=this.makeButton(ID_BUTTON_MENU,icon_menu,"Show menu","showmenu")+
this.makeButton(ID_BUTTON_RUN,Utils.getIcon("run.png"),"Run this cell","run")+
this.makeButton(ID_BUTTON_RUN,Utils.getIcon("runall.png"),"Run all","runall");var runIcon=HtmlUtils.image(icon_blank,["align","right","id",this.getDomId(ID_RUN_ICON),"style","padding-bottom:2px;padding-top:2px;padding-right:5px;"]);buttons=buttons+"&nbsp;"+HtmlUtils.span(["id",this.getDomId(ID_CELLNAME)],this.cellName);buttons+=runIcon;var header=HtmlUtils.div([ATTR_CLASS,"display-notebook-header",ATTR_ID,this.getDomId(ID_HEADER),"tabindex","0","title","Click to toggle input\nShift-click to clear output"],"&nbsp;"+buttons);var content="";var lines=this.content.split("\n");var inMeta=false;for(var i=0;i<lines.length;i++){var line=lines[i];var _line=line.trim();if(_line.startsWith("%%")){if(_line.match(/^%% *meta/)){inMeta=true;}else{inMeta=false;}}
if(!inMeta){content+=line+"\n";}}
content=content.replace(/</g,"&lt;").replace(/>/g,"&gt;");var input=HtmlUtils.div([ATTR_CLASS,"display-notebook-input ace_editor",ATTR_ID,this.getDomId(ID_INPUT),"title","shift-return: run chunk\nctrl-return: run to end"],content);var inputToolbar=HtmlUtils.div(["id",this.getDomId(ID_INPUT_TOOLBAR)],"");input=HtmlUtils.div(["class","display-notebook-input-container"],inputToolbar+input);var output=HtmlUtils.div([ATTR_CLASS,"display-notebook-output",ATTR_ID,this.getDomId(ID_OUTPUT)],this.outputHtml);output=HtmlUtils.div(["class","display-notebook-output-container"],output);var menu=HtmlUtils.div(["id",this.getDomId(ID_MENU),"class","ramadda-popup"],"");var html=header+input;html=HtmlUtils.div(["id",this.getDomId(ID_CELL)],html);$("#"+this.id+"_cellinput").html(html);$("#"+this.id+"_celloutput").html(output);var url=ramaddaBaseUrl+"/wikitoolbar?doImports=false&entryid="+this.entryId+"&handler="+this.editId;url+="&extrahelp="+ramaddaBaseUrl+"/userguide/notebook.html|Notebook Help";GuiUtils.loadHtml(url,h=>{this.inputToolbar=h;this.jq(ID_INPUT_TOOLBAR).html(h);$("#"+this.editId+"_prefix").html(HtmlUtils.span(["id",this.getDomId("toolbar_notebook"),"style","border-right:1px #ccc solid;","class","ramadda-menubar-button"],"Notebook"));this.jq("toolbar_notebook").click(()=>this.showNotebookMenu());});this.header=this.jq(ID_HEADER);this.header.click((e)=>{if(e.shiftKey)
this.processCommand("clear");else{this.hidePopup();this.processCommand("toggle");}});let wikiEditor=new WikiEditor("","",this.getDomId(ID_INPUT),false,{maxLines:30,minLines:5});this.editor=wikiEditor.getEditor();this.editor.getSession().on('change',()=>{this.inputChanged();});this.menuButton=this.jq(ID_BUTTON_MENU);this.toggleButton=this.jq(ID_BUTTON_TOGGLE);this.cell=this.jq(ID_CELL);this.input=this.jq(ID_INPUT);this.output=this.jq(ID_OUTPUT);this.inputContainer=this.cell.find(".display-notebook-input-container");this.inputMenu=this.cell.find(".display-notebook-input-container");this.applyStyle();this.header.find(".display-notebook-menu-button").click(function(e){_this.processCommand($(this).attr("what"));e.stopPropagation();});this.calculateInputHeight();this.input.focus(()=>this.hidePopup());this.input.click(()=>this.hidePopup());this.output.click(()=>this.hidePopup());this.input.on('input selectionchange propertychange',()=>this.calculateInputHeight());var moveFunc=(e)=>{var key=e.key;if(key=='v'&&e.ctrlKey){this.notebook.moveCellDown(_this);return;}
if(key==6&&e.ctrlKey){this.notebook.moveCellUp(_this);return;}};this.input.keydown(moveFunc);this.header.keydown(moveFunc);this.input.keydown(function(e){var key=e.key;if(key=='s'&&e.ctrlKey){_this.notebook.saveNotebook(false);return;}
if(key=='Enter'){if(e.shiftKey||e.ctrlKey){if(e.preventDefault){e.preventDefault();}
if(e.shiftKey&&e.ctrlKey){_this.run(null);}else{_this.run(null,{justCurrent:true,toEnd:e.ctrlKey});if(!e.ctrlKey){_this.stepToNextChunk();}}}}});},selectClick(type,id,entryId,value){if(type=="entryid"){this.insertText(entryId);}else{this.insertText("[["+entryId+"|"+value+"]]");}
this.input.focus();},insertTags:function(tagOpen,tagClose,sampleText){var id=this.getDomId(ID_INPUT);var textComp=GuiUtils.getDomObject(id);insertTagsInner(id,textComp.obj,tagOpen,tagClose,sampleText);this.calculateInputHeight();},insertText:function(value){var id=this.getDomId(ID_INPUT);var textComp=GuiUtils.getDomObject(id);insertAtCursor(id,textComp.obj,value);this.calculateInputHeight();},showNotebookMenu:function(){var link=this.jq("toolbar_notebook");this.makeMenu(link,"left bottom");},makeButton:function(id,icon,title,command){if(!command)command="noop";return HtmlUtils.div(["what",command,"title",title,"class","display-notebook-menu-button","id",this.getDomId(id)],HtmlUtils.image(icon,[]));},makeMenu:function(src,at){if(!src){src=this.input;}
if(!src.is(":visible")){src=this.header;}
if(!src.is(":visible")){src=this.output;}
if(!at)at="left top";let _this=this;var space="&nbsp;&nbsp;";var line="<div style='border-top:1px #ccc solid;margin-top:4px;margin-bottom:4px;'></div>"
var menu="";menu+=HtmlUtils.input(ID_CELLNAME_INPUT,_this.cellName,["placeholder","Cell name","style","width:100%;","id",_this.getDomId(ID_CELLNAME_INPUT)]);menu+="<br>";menu+="<table  width=100%> ";menu+="<tr><td align=right><b>New cell:</b>&nbsp;</td><td>";menu+=HtmlUtils.div(["class","ramadda-link","what","newabove"],"Above")+space;menu+=HtmlUtils.div(["class","ramadda-link","what","newbelow"],"Below");menu+="</td></tr>"
menu+="<tr><td align=right><b>Move:</b>&nbsp;</td><td>";menu+=HtmlUtils.div(["title","ctrl-^","class","ramadda-link","what","moveup"],"Up")+space;menu+=HtmlUtils.div(["title","ctrl-v","class","ramadda-link","what","movedown"],"Down");menu+="</td></tr>"
menu+="</table>";menu+=line;menu+=HtmlUtils.div(["title","ctrl-return","class","ramadda-link","what","hideall"],"Hide all inputs");menu+="<br>"
menu+=HtmlUtils.div(["class","ramadda-link","what","clearall"],"Clear all outputs");menu+="<br>";var cols=this.notebook.columns;var colId=_this.getDomId(ID_LAYOUT_COLUMNS);menu+="<b>Layout:</b> ";menu+=HtmlUtils.checkbox(_this.getDomId(ID_LAYOUT_TYPE),[],_this.notebook.layout=="horizontal")+" Horizontal"+"<br>";menu+=line;menu+=HtmlUtils.checkbox(_this.getDomId(ID_SHOW_OUTPUT),[],_this.showOutput)+" Output enabled"+"<br>";menu+=HtmlUtils.checkbox(_this.getDomId(ID_SHOWCONSOLE),[],_this.notebook.showConsole)+" Show console"+"<br>";menu+=HtmlUtils.checkbox(_this.getDomId(ID_RUNFIRST),[],_this.runFirst)+" Run first"+"<br>";menu+=HtmlUtils.checkbox(_this.getDomId(ID_RUN_ON_LOAD),[],_this.notebook.runOnLoad)+" Run on load"+"<br>";menu+=HtmlUtils.div(["title","Don't show the left side and input for anonymous users"],HtmlUtils.checkbox(_this.getDomId(ID_DISPLAY_MODE),[],_this.notebook.displayMode)+" Display mode"+"<br>");menu+=line;menu+=HtmlUtils.div(["class","ramadda-link","what","savewithout"],"Save notebook")+"<br>";menu+=line;menu+=HtmlUtils.div(["class","ramadda-link","what","delete"],"Delete cell")+"<br>";menu+=HtmlUtils.div(["class","ramadda-link","what","help"],"Help")+"<br>";menu=HtmlUtils.div(["class","display-notebook-menu"],menu);var popup=this.getPopup();this.dialogShown=true;popup.html(HtmlUtils.div(["class","ramadda-popup-inner"],menu));popup.show();popup.position({of:src,my:"left top",at:at,collision:"fit fit"});_this.jq(ID_SHOWHEADER_INPUT).focus();_this.jq(ID_SHOWCONSOLE).change(function(e){_this.notebook.showConsole=_this.jq(ID_SHOWCONSOLE).is(':checked');_this.hidePopup();_this.notebook.layoutCells();});_this.jq(ID_SHOWHEADER_INPUT).change(function(e){_this.showHeader=_this.jq(ID_SHOWHEADER_INPUT).is(':checked');_this.applyStyle();});_this.jq(ID_RUNFIRST).change(function(e){_this.runFirst=_this.jq(ID_RUNFIRST).is(':checked');});_this.jq(ID_SHOW_OUTPUT).change(function(e){_this.showOutput=_this.jq(ID_SHOW_OUTPUT).is(':checked');_this.applyStyle();});_this.jq(ID_RUN_ON_LOAD).change(function(e){_this.notebook.runOnLoad=_this.jq(ID_RUN_ON_LOAD).is(':checked');});_this.jq(ID_DISPLAY_MODE).change(function(e){_this.notebook.displayMode=_this.jq(ID_DISPLAY_MODE).is(':checked');});_this.jq(ID_SHOWEDIT).change(function(e){_this.showInput=_this.jq(ID_SHOWEDIT).is(':checked');_this.applyStyle();});_this.jq(ID_LAYOUT_TYPE).change(function(e){if(_this.jq(ID_LAYOUT_TYPE).is(':checked')){_this.notebook.layout="horizontal";}else{_this.notebook.layout="vertical";}
_this.hidePopup();_this.notebook.layoutCells();});_this.jq(ID_LAYOUT_COLUMNS).keypress(function(e){var keyCode=e.keyCode||e.which;if(keyCode!=13){return;}
var cols=parseInt(_this.jq(ID_LAYOUT_COLUMNS).val());if(isNaN(cols)){_this.jq(ID_LAYOUT_COLUMNS).val("bad:"+_this.jq(ID_LAYOUT_COLUMNS).val());return;}
_this.hidePopup();});_this.jq(ID_CELLNAME_INPUT).keypress(function(e){var keyCode=e.keyCode||e.which;if(keyCode==13){_this.hidePopup();return;}});popup.find(".ramadda-link").click(function(){var what=$(this).attr("what");_this.processCommand(what);});},hidePopup:function(){var popup=this.getPopup();if(popup&&this.dialogShown){var cols=parseInt(this.jq(ID_LAYOUT_COLUMNS).val());this.cellName=this.jq(ID_CELLNAME_INPUT).val();this.jq(ID_CELLNAME).html(this.cellName);popup.hide();this.applyStyle();if(!isNaN(cols)&&this.notebook.columns!=cols){this.notebook.columns=cols;this.notebook.layoutCells();}}
this.dialogShown=false;},processCommand:function(command){if(command=="showmenu"){this.makeMenu();return;}else if(command=="toggle"){this.showInput=!this.showInput;this.applyStyle(true);}else if(command=="showthis"){this.showInput=true;this.applyStyle();}else if(command=="hidethis"){this.showInput=false;this.applyStyle();}else if(command=="showall"){this.notebook.toggleAll(true);}else if(command=="hideall"){this.notebook.toggleAll(false);}else if(command=="run"){this.notebook.runCell(this);}else if(command=="runall"){this.notebook.runAll();}else if(command=="clear"){this.clearOutput();}else if(command=="clearall"){this.notebook.clearOutput();}else if(command=="moveup"){this.notebook.moveCellUp(this);}else if(command=="movedown"){this.notebook.moveCellDown(this);}else if(command=="newabove"){this.notebook.newCellAbove(this);}else if(command=="newbelow"){this.notebook.newCellBelow(this);}else if(command=="savewith"){this.notebook.saveNotebook(true);}else if(command=="savewithout"){this.notebook.saveNotebook(false);}else if(command=="help"){var win=window.open(ramaddaBaseUrl+"/userguide/notebook.html",'_blank');win.focus();}else if(command=="delete"){this.askDelete();return;}else{console.log("unknown command:"+command);}
this.hidePopup();},shouldShowInput:function(){return this.showInput&&this.notebook.showInput();},applyStyle:function(fromUser){if(this.shouldShowInput()){this.jq(ID_INPUT_TOOLBAR).css("display","block");this.inputContainer.show(400,()=>this.editor.resize());this.showHeader=true;}else{this.jq(ID_INPUT_TOOLBAR).css("display","none");this.inputContainer.hide(fromUser?200:0);this.showHeader=false;}
this.showHeader=this.notebook.showInput();if(this.showHeader){this.header.css("display","block");}else{this.header.css("display","none");}
if(this.showOutput){this.output.css("display","block");}else{this.output.css("display","none");}},getPopup:function(){return this.notebook.getPopup();},askDelete:function(){let _this=this;var menu="";menu+="Are you sure you want to delete this cell?<br>";menu+=HtmlUtils.span(["class","ramadda-link","what","yes"],"Yes");menu+=HtmlUtils.span(["style","margin-left:50px;","class","ramadda-link","what","cancel"],"No");var popup=this.getPopup();popup.html(HtmlUtils.div(["class","ramadda-popup-inner"],menu));popup.show();var src=this.input;if(!src.is(":visible")){src=this.output;}
if(!src.is(":visible")){src=this.header;}
popup.position({of:src,my:"left top",at:"left top",collision:"fit fit"});popup.find(".ramadda-link").click(function(){var what=$(this).attr("what");_this.hidePopup();if(what=="yes"){_this.notebook.deleteCell(_this);}});},inputChanged:function(){var value=this.getInputText();var lines=value.split("\n");var cursor=this.editor.getCursorPosition();for(var i=cursor.row;i>=0;i--){var line=lines[i].trim();if(line.startsWith("%%")){var type=line.substring(2).trim();if(type.startsWith("md")||type.startsWith("html")||type.startsWith("css")||type.startsWith("raw")){var doRows={};doRows[i]=true;this.runInner(value,doRows);}
break;}}},stepToNextChunk:function(){var value=this.getInputText();var lines=value.split("\n");var cursor=this.editor.getCursorPosition();for(var i=cursor.row+1;i<lines.length;i++){if(lines[i].trim().startsWith("%%")){var ll=lines[i].length;this.editor.selection.moveTo(i,ll);this.editor.scrollToLine(i,true,true,function(){});break;}}},run:async function(callback,args){if(!args)args={};var justCurrent=args.justCurrent;var toEnd=args.toEnd;var doingAll=args.doingAll;if(this.running)return Utils.call(callback,true);this.running=true;var doRows=null;try{var ok=true;var value=this.getInputText();if(justCurrent){doRows={};var cursor=this.editor.getCursorPosition();var row=cursor.row;var lines=value.split("\n");var percentCnt=0;if(toEnd){justCurrent=false;while(row>=0){if(lines[row].trim().startsWith("%%")){break;}
row--;}
if(row<0)row=0;while(row<lines.length){doRows[row]=true;row++;}}else{row++;while(row<lines.length){if(lines[row].trim().startsWith("%%")){row--;break;}
row++;}
if(row>=lines.length)row=lines.length-1;while(row>=0){var line=lines[row].trim();doRows[row]=true;if(line.startsWith("%%"))break;row--;}}}
this.jq(ID_RUN_ICON).attr("src",icon_progress);await this.runInner(value,doRows,doingAll).then(r=>ok=r);this.jq(ID_RUN_ICON).attr("src",icon_blank);if(!ok){this.running=false;return Utils.call(callback,false);}
this.outputUpdated();}catch(e){this.jq(ID_RUN_ICON).attr("src",icon_blank);this.running=false;this.writeOutput("An error occurred:"+e.toString()+" "+(typeof e));console.log("error:"+e.toString());if(e.stack)
console.log(e.stack);return Utils.call(callback,false);}
this.running=false;return Utils.call(callback,true);},prepareToLayout:function(){this.content=this.getInputText();},getInputText:function(){if(!this.editor)return this.content;return this.editor.getValue();},globalChanged:async function(name,value){for(var i=0;i<this.chunks.length;i++){var chunk=this.chunks[i];if(chunk.hasRun)continue;if(chunk.depends.includes(name)){var ok=true;await this.runChunk(chunk,r=>ok=r);if(!ok)break;}}},prepareToRun:function(){this.hasRun=false;if(this.chunks){this.chunks.forEach(chunk=>chunk.hasRun=false);}},runInner:async function(value,doRows,doingAll){value=value.trim();value=value.replace(/{cellname}/g,this.cellName);value=this.notebook.convertInput(value);if(!this.chunks)this.chunks=[];var chunks=this.chunks;var type="wiki";var rest="";var commands=value.split("\n");var prevChunk=null;var chunkCnt=0;var _cell=this;var getChunk=(cell,type,content,doChunk,rest)=>{var props=Utils.parseAttributes(rest);props.type=type;props.doChunk=doChunk;props.content=content;var chunk=(chunkCnt<chunks.length?chunks[chunkCnt]:null);chunkCnt++;if(chunk){if(chunk.div.jq().length==0){chunk=null;}else{}}else{}
if(!chunk){chunk=new NotebookChunk(cell,props);chunks.push(chunk);if(!chunk.skipOutput){if(prevChunk)prevChunk.div.jq().after(chunk.div.toString());else cell.output.html(chunk.div.toString());}}else{chunk.initChunk(props);}
prevChunk=chunk;chunk.div.jq().show();return chunk;};var content="";var doChunk=true;for(var rowIdx=0;rowIdx<commands.length;rowIdx++){var command=commands[rowIdx];var _command=command.trim();if(_command.startsWith("//"))continue;if(_command.startsWith("%%")){var newRest=_command.substring(2).trim();var newType;var index=newRest.indexOf(" ");if(index<0){newType=newRest;newRest="";}else{newType=newRest.substring(0,index).trim();newRest=newRest.substring(index);}
if(content!=""){getChunk(this,type,content,doChunk,rest);}
doChunk=doRows?doRows[rowIdx]:true;content="";if(content!="")content+="\n";if(newType!="")
type=newType;rest=newRest;continue;}
content=content+command+"\n";}
if(content!=""){getChunk(this,type,content,doChunk,rest);}
this.chunkMap={};for(var i=0;i<this.chunks.length;i++){var chunk=this.chunks[i];if(chunk.name){this.chunkMap[chunk.name]=chunk;}}
for(var i=chunkCnt;i<this.chunks.length;i++){this.chunks[i].div.jq().hide();}
this.rawOutput="";var ok=true;await this.runChunks(this.chunks,doingAll,true,r=>ok=r);if(!ok)return false;await this.runChunks(this.chunks,doingAll,false,r=>ok=r);if(!ok)return false;Utils.initContent("#"+this.getDomId(ID_OUTPUT));return true;},runChunks:async function(chunks,doingAll,justFirst,callback){for(var i=0;i<chunks.length;i++){var chunk=chunks[i];var ok=true;if(justFirst===true&&!chunk.props["runfirst"]){continue;}
if(justFirst===false&&chunk.props["runfirst"]===true){continue;}
if(doingAll&&chunk.props["skiprunall"]===true){continue;}
if(!chunk.doChunk){continue;}
await this.runChunk(chunk,(r=>ok=r));if(!ok)return Utils.call(callback,false);}
return Utils.call(callback,true);},runChunk:async function(chunk,callback){if(chunk.hasRun){return Utils.call(callback,true);}
chunk.ok=true;chunk.div.set("");chunk.hasRun=true;for(var i=0;i<chunk.depends.length;i++){var name=chunk.depends[i];if(this.chunkMap[name]&&!this.chunkMap[name].hasRun){var ok=true;var otherChunk=this.chunkMap[name];await this.runChunk(otherChunk,false,null,(r=>ok=r));if(!ok||!otherChunk.ok){return Utils.call(callback,false);}}}
await this.processChunk(chunk);if(!chunk.ok){Utils.call(callback,false);return;}
if(chunk.name&&(typeof chunk.name=="string")){var name=chunk.name.trim();if(chunk.output){if(name!=""){await this.notebook.addGlobal(name,chunk.output);}}else{await this.notebook.addGlobal(name,null);}}
return Utils.call(callback,true);},writeOutput:function(h){if(!this.output){err=new Error();console.log("no output:"+err.stack);return;}
this.output.html(h);this.outputUpdated();},outputUpdated:function(){this.outputHtml=this.jq(ID_OUTPUT).html();},getRawOutput:function(){return this.rawOutput;},focus:function(){this.input.focus();},clearOutput:function(){if(this.chunks)
this.chunks.forEach(chunk=>chunk.div.set(""));this.outputHtml="";},processHtml:async function(chunk){var content=chunk.getContent();if(content.match("%\n*$")){content=content.trim();content=content.substring(0,content.length-1);}
this.rawOutput+=content+"\n";chunk.output=content;chunk.div.set(content);},processCss:async function(chunk){var css=HtmlUtils.tag("style",["type","text/css"],chunk.getContent());this.rawOutput+=css+"\n";chunk.output=css;chunk.div.set(css);},handleError:function(chunk,error,from){chunk.ok=false;console.log("An error occurred:"+error);this.notebook.log(error,"error",from,chunk.div);},getFetchUrl:async function(url,type,callback){url=Utils.replaceRoot(url);if(url.match(/^[a-z0-9]+-[a-z0-9].*/)){return Utils.call(callback,ramaddaBaseUrl+"/entry/get?entryid="+url);}else{if(!url.startsWith("http")){if((url.startsWith("/")&&!url.startsWith(ramaddaBaseUrl))||url.startsWith("..")||!url.startsWith("/")){var entry;await this.getEntryFromPath(url,e=>entry=e);if(!entry){return Utils.call(callback,null);}
return Utils.call(callback,ramaddaBaseUrl+"/entry/get?entryid="+entry.getId());}}
return Utils.call(callback,url);}},processFetch:async function(chunk){var lines=chunk.getContent().split("\n");for(var i=0;i<lines.length;i++){var line=lines[i].trim();if(line=="")continue;var origLine=line;var error=null;var msgExtra="";var idx=line.indexOf(":");if(idx<0){this.handleError(chunk,"Bad fetch line:"+line,"io");return;}
var tag=line.substring(0,idx);line=line.substring(idx+1).trim();var idx=line.indexOf(" //");if(idx>=0){line=line.substring(0,idx).trim();}
var url=null;var variable=null;if(["text","json","blob"].includes(tag)){var args=line.match(/^([a-zA-Z0-9_]+) *= *(.*)$/);if(args){variable=args[1];line=args[2].trim();msgExtra=" (var "+variable+")";}}
await this.getFetchUrl(line,tag,u=>url=u);if(!url){this.handleError(chunk,"Unable to get entry url:"+line,"io");return;}
if(tag=="js"){if(url.match("jquery-.*\\.js"))return;await Utils.importJS(url,()=>{},(jqxhr,settings,exception)=>{error="Error fetching "+origLine+" "+(exception?exception.toString():"");},false);}else if(tag=="css"){await Utils.importCSS(url,null,(jqxhr,settings,exception)=>error="Error fetching "+origLine+" "+exception,true);}else if(tag=="html"){await Utils.doFetch(url,h=>chunk.div.append(h),(jqxhr,settings,exception)=>error="Error fetching "+origLine+" "+exception);}else if(tag=="text"||tag=="json"||tag=="blob"){var isJson=tag=="json";var isBlob=tag=="blob";var results=null;await Utils.doFetch(url,h=>results=h,(jqxhr,settings,err)=>error="Error fetching "+origLine+" error:"+(err?err.toString():""),tag=="blob"?"blob":"text");if(results){if(isJson){if(typeof results=="string")
results=JSON.parse(results);}else if(isBlob){results=new Blob([results],{});}
if(variable){await this.notebook.addGlobal(variable,results);}else{if(isJson){chunk.div.append(Utils.formatJson(results));}else{chunk.div.append(HtmlUtils.pre(["style","max-width:100%;overflow-x:auto;"],results));}}}}else{error="Unknown fetch:"+origLine;}
if(error){this.handleError(chunk,error,"io");return;}else{this.notebook.log("Loaded: "+url+msgExtra,"output","io");}}},processMd:async function(chunk){var content=chunk.getContent();this.rawOutput+=content+"\n";if(content.match("%\n*$")){content=content.trim();content=content.substring(0,content.length-1);}
var o="";var tex=null;var lines=content.split("\n");var texs=[];for(var i=0;i<lines.length;i++){var line=lines[i];var _line=line.trim();if(_line.startsWith("$$")){if(tex!=null){try{var html=katex.renderToString(tex,{throwOnError:true});o+="tex:"+texs.length+":\n";texs.push(html);}catch(e){o+="Error parsing tex:"+e+"<pre>"+tex+"</pre>";}
tex=null;}else{tex="";}}else if(tex!=null){tex+=line+"\n";}else{o+=line+"\n";}}
var converter=new showdown.Converter();var html=converter.makeHtml(o);for(var i=0;i<texs.length;i++){html=html.replace("tex:"+i+":",texs[i]);}
var md=HtmlUtils.div(["class","display-notebook-md"],html);chunk.output=html;chunk.div.set(md);},processPy:async function(chunk){if(!this.notebook.loadedPyodide){chunk.div.set("Loading Python...");await Utils.importJS(ramaddaBaseHtdocs+"/lib/pyodide/pyodide.js");await languagePluginLoader.then(()=>{pyodide.runPython('import sys\nsys.version;');},(e)=>console.log("error:"+e));await pyodide.loadPackage(['numpy','cycler','pytz','matplotlib'])
chunk.div.set("");this.notebook.loadedPyodide=true;}
pyodide.runPython(chunk.getContent());},processPlugin:async function(chunk){var plugin=JSON.parse(chunk.getContent());await this.notebook.addPlugin(plugin,chunk);},processWiki:async function(chunk){this.rawOutput+=chunk.getContent()+"\n";var id=this.notebook.getProperty("entryId","");await this.getCurrentEntry(e=>entry=e);if(entry)id=entry.getId();let _this=this;let divId=HtmlUtils.getUniqueId();var wikiCallback=function(html){var h=HtmlUtils.div(["id",divId,"style"],html);chunk.div.set(h);chunk.output=h;}
var wiki="{{group showMenu=false}}\n"+chunk.getContent();await GuiUtils.loadHtml(ramaddaBaseUrl+"/wikify?doImports=false&entryid="+id+"&text="+encodeURIComponent(chunk.getContent()),wikiCallback);},processSh:async function(chunk){var r="";var lines=chunk.getContent().split("\n");var commands=[];for(var i=0;i<lines.length;i++){var fullLine=lines[i].trim();if(fullLine=="")continue;var cmds=fullLine.split(";");for(var cmdIdx=0;cmdIdx<cmds.length;cmdIdx++){var line=cmds[cmdIdx].trim();if(line==""||line.startsWith("#")||line.startsWith("//"))continue;var toks=line.split(" ");var command=toks[0].trim();var proc=null;var extra=null;if(this["processCommand_"+command]){proc=this["processCommand_"+command];}else{proc=this.processCommand_help;extra="Unknown command: <i>"+command+"</i>";}
var div=new Div("");commands.push({proc:proc,line:line,toks:toks,extra:extra,div:div});r+=div.set("");}}
let _this=this;chunk.div.set(r);var i=0;for(i=0;i<commands.length;i++){var cmd=commands[i];if(cmd.extra){cmd.div.append(extra);}
await cmd.proc.call(_this,cmd.line,cmd.toks,cmd.div,cmd.extra);}},processJs:async function(chunk,state){var lines;var topLines=0;await this.getCurrentEntry(e=>{current=e});if(!notebookStates[state.id]){throw new Error("Null NB:"+state.id);}
try{var notebookEntries=this.notebook.getCurrentEntries();for(name in notebookEntries){state.entries[name]=notebookEntries[name].entry;}
var jsSet="";state.entries["current"]=current;state.entries["parent"]=this.parentEntry;state.entries["base"]=this.notebook.getBaseEntry();state.entries["root"]=this.notebook.getRootEntry();var stateJS="notebookStates['"+state.id+"']";topLines++;jsSet+="var notebook= "+stateJS+";\n";topLines++;for(name in state.entries){var e=state.entries[name];topLines++;jsSet+="var "+name+"= notebook.entries['"+name+"'];\n"}
for(name in this.notebook.cellValues){var clean=name.replace(/ /g,"_").replace(/[^a-zA-Z0-9_]+/g,"_");topLines++;jsSet+="var "+clean+"= notebook.getNotebook().cellValues['"+name+"'];\n";}
for(name in this.notebook.globals){name=name.trim();if(name=="")continue;topLines++;jsSet+="var "+name+"= notebook.getNotebook().getGlobalValue('"+name+"');\n";}
var js=chunk.getContent().trim();lines=js.split("\n");js=jsSet+"\n"+js;var result=eval.call(null,js);if(state.getStop()){chunk.ok=false;}
var html="";if(result!=null){chunk.output=result;var rendered=this.notebook.formatOutput(result);if(rendered!=null){html=rendered;this.rawOutput+=html+"\n";}else{var type=typeof result;if(type!="object"&&type!="function"){html=result;this.rawOutput+=html+"\n";}}}
chunk.div.append(html);}catch(e){chunk.ok=false;var line=lines[e.lineNumber-topLines-1];console.log("Error:"+e.stack);this.notebook.log("Error: "+e.message+"<br>&gt;"+(line?line:""),"error","js",chunk.div);}},processChunk:async function(chunk){var state=new NotebookState(this,chunk.div);window.notebook=state;notebookStates[state.id]=state;if(chunk.type=="html"){await this.processHtml(chunk,state);}else if(chunk.type=="plugin"){await this.processPlugin(chunk,state);}else if(chunk.type=="wiki"){await this.processWiki(chunk,state);}else if(chunk.type=="css"){await this.processCss(chunk,state);}else if(chunk.type=="fetch"){await this.processFetch(chunk,state);}else if(chunk.type=="raw"){var content=chunk.getContent();chunk.output=content;this.rawOutput+=content;}else if(chunk.type=="js"){await this.processJs(chunk,state);}else if(chunk.type=="sh"){await this.processSh(chunk,state);}else if(chunk.type=="meta"){}else if(chunk.type=="md"){await this.processMd(chunk,state);}else if(chunk.type=="py"){await this.processPy(chunk,state);}else{var hasPlugin;await this.notebook.hasPlugin(chunk.type,p=>hasPlugin=p);if(hasPlugin){chunk.div.set("");var result;await this.notebook.processChunkWithPlugin(chunk.type,chunk,r=>result=r);if(result){this.notebook.processPluginOutput(chunk.type,chunk,result);}
return;}
this.notebook.log("Unknown type:"+chunk.type,"error",null,chunk.div);chunk.ok=false;}
delete notebookStates[state.id];if(state.getStop()){chunk.ok=false;}},calculateInputHeight:function(){this.content=this.getInputText();if(!this.content)return;var lines=this.content.split("\n");if(lines.length!=this.inputRows){this.inputRows=lines.length;this.input.attr("rows",Math.max(1,this.inputRows));}},writeStatusMessage:function(v){var msg=this.jq(ID_MESSAGE);if(!v){msg.hide();msg.html("");}else{msg.show();msg.position({of:this.getOutput(),my:"left top",at:"left+4 top+4",collision:"none none"});msg.html(v);}},handleControlKey:function(event){var k=event.which;},getOutput:function(){return this.jq(ID_OUTPUT);},getInput:function(){return this.jq(ID_INPUT);},writeResult:function(html){this.writeStatusMessage(null);html=HtmlUtils.div([ATTR_CLASS,"display-notebook-result"],html);var output=this.jq(ID_OUTPUT);output.append(html);output.animate({scrollTop:output.prop("scrollHeight")},1000);this.currentOutput=output.html();this.currentInput=this.getInputText();},writeError:function(msg){this.writeStatusMessage(msg);},header:function(msg){return HtmlUtils.div([ATTR_CLASS,"display-notebook-header"],msg);},processCommand_help:function(line,toks,div,callback,prefix){if(div==null)div=new Div();var help="";if(prefix!=null)help+=prefix;help+="<pre>pwd, ls, cd</pre>";return div.append(help);},entries:{},selectEntry:function(entryId){var cnt=1;var entries=this.notebook.getCurrentEntries();while(entries["entry"+cnt]){cnt++;}
var id=prompt("Set an ID","entry"+cnt);if(id==null||id.trim()=="")return;this.notebook.addEntry(id,entryId);},setId:function(entryId){var cursor=this.editor.getCursorPosition();this.editor.insert(entryId);},cdEntry:function(entryId){var div=new Div("");this.currentEntry=this.entries[entryId];notebookState.entries["current"]=this.currentEntry;this.output.html(div.toString());this.processCommand_pwd("pwd",[],div);this.outputUpdated();},addToToolbar:function(id,entry,toolbarItems){var call="getHandler('"+id+"').setId('"+entry.getId()+"')";var icon=HtmlUtils.image(ramaddaBaseUrl+"/icons/setid.png",["border",0,ATTR_TITLE,"Set ID in Input"]);toolbarItems.unshift(HtmlUtils.tag(TAG_A,["onclick",call],icon));var call="getHandler('"+id+"').selectEntry('"+entry.getId()+"')";var icon=HtmlUtils.image(ramaddaBaseUrl+"/icons/circle-check.png",["border",0,ATTR_TITLE,"Select Entry"]);toolbarItems.unshift(HtmlUtils.tag(TAG_A,["onclick",call],icon));},getEntryPrefix:function(id,entry){this.entries[entry.getId()]=entry;var call="getHandler('"+id+"').cdEntry('"+entry.getId()+"')";return HtmlUtils.div(["style","padding-right:4px;","title","cd to entry","onclick",call,"class","ramadda-link"],HtmlUtils.image(ramaddaBaseUrl+"/icons/go.png"));},displayEntries:function(entries,div){if(div==null)div=new Div();this.currentEntries=entries;if(entries==null||entries.length==0){return div.msg("No children");}
var handlerId=addHandler(this);var html=this.notebook.getEntriesTree(entries,{handlerId:handlerId,showIndex:false,suffix:Utils.getUniqueId("_shell_")});div.set(HtmlUtils.div(["style","max-height:200px;overflow-y:auto;"],html));this.outputUpdated();},getEntryFromArgs:function(args,dflt){var currentEntries=this.currentEntries;if(currentEntries==null){return dflt;}
for(var i=0;i<args.length;i++){var arg=args[i];if(arg.match("^\d+$")){var index=parseInt(arg);break;}
if(arg=="-entry"){i++;var index=parseInt(args[i])-1;if(index<0||index>=currentEntries){this.writeError("Bad entry index:"+index+" should be between 1 and "+currentEntries.length);return;}
return currentEntries[index];}}
return dflt;},setCurrentEntry:async function(entry){this.currentEntry=entry;this.parentEntry=null;if(this.currentEntry)
await this.currentEntry.getParentEntry(entry=>{this.parentEntry=entry;});},getCurrentEntry:async function(callback){if(this.currentEntry==null){await this.setCurrentEntry(this.notebook.getBaseEntry());}
if(this.currentEntry==null){if(Utils.isDefined(dflt))return dflt;this.rootEntry=new Entry({id:ramaddaBaseEntry,name:"Root",type:"group"});this.currentEntry=this.rootEntry;}
return Utils.call(callback,this.currentEntry);},createDisplay:async function(state,entry,displayType,displayProps){if(!entry)await this.getCurrentEntry(e=>entry=e);if((typeof entry)=="string"){await this.notebook.getEntry(entry,e=>entry=e);}
if(!state.displayManager){var divId=HtmlUtils.getUniqueId();state.div.append(HtmlUtils.div(["id",divId],""));state.displayManager=new DisplayManager(divId,{"showMap":false,"showMenu":false,"showTitle":false,"layoutType":"table","layoutColumns":1,"defaultMapLayer":"osm","entryId":""});}
var divId=HtmlUtils.getUniqueId();state.div.append(HtmlUtils.div(["id",divId],"DIV"));var props={layoutHere:true,divid:divId,showMenu:true,sourceEntry:entry,entryId:entry.getId(),showTitle:true,showDetails:true,title:entry.getName(),};if(displayProps){$.extend(props,displayProps);}
if(!props.data&&displayType!=DISPLAY_ENTRYLIST){var jsonUrl=this.notebook.getPointUrl(entry);if(jsonUrl==null){this.writeError("Not a point type:"+entry.getName());return;}
if(jsonUrl==null){jsonUrl=this.getPointUrl(entry);}
var pointDataProps={entry:entry,entryId:entry.getId()};props.data=new PointData(entry.getName(),null,null,jsonUrl,pointDataProps);}
state.displayManager.createDisplay(displayType,props);},createPointDisplay:async function(toks,displayType){await this.getCurrentEntry(e=>current=e);var entry=this.getEntryFromArgs(toks,currentEntry);var jsonUrl=this.notebook.getPointUrl(entry);if(jsonUrl==null){this.writeError("Not a point type:"+entry.getName());return;}
this.notebook.createDisplay(entry.getId(),displayType,jsonUrl);},processCommand_table:function(line,toks){this.createPointDisplay(toks,DISPLAY_TABLE);},processCommand_linechart:function(line,toks){this.createPointDisplay(toks,DISPLAY_LINECHART);},processCommand_barchart:function(line,toks){this.createPointDisplay(toks,DISPLAY_BARCHART);},processCommand_bartable:function(line,toks){this.createPointDisplay(toks,DISPLAY_BARTABLE);},processCommand_hello:function(line,toks){this.writeResult("Hello, how are you?");},processCommand_scatterplot:function(line,toks){this.createPointDisplay(toks,DISPLAY_SCATTERPLOT)},processCommand_blog:function(line,toks){this.getLayoutManager().publish('blogentry');},getEntryHeading:function(entry,div){var entries=[entry];var handlerId=addHandler(this);var html=this.notebook.getEntriesTree(entries,{handlerId:handlerId,showIndex:false,suffix:Utils.getUniqueId("_shell_")});div.set(HtmlUtils.div(["style","max-height:200px;overflow-y:auto;"],html));return div;},processCommand_pwd:async function(line,toks,div){if(div==null)div=new Div();await this.getCurrentEntry(e=>entry=e);return this.getEntryHeading(entry,div);},processCommand_set:async function(line,toks,div){if(div==null)div=new Div();if(toks.length<2){div.append("Error: usage: set &lt;name&gt; &lt;value&gt;");return;}
var name=toks[1];if(toks.length==2){var v=this.notebook.getGlobalValue(name);if(v){div.append(v);}else{div.append("Unknown: "+name);}}else{var v=Utils.join(toks," ",2);v=v.replace(/\"/g,"");await this.notebook.addGlobal(name,v);}},processCommand_clearEntries:function(line,toks,div){this.notebook.clearEntries();div.set("Entries cleared");},processCommand_printEntries:async function(line,toks,div){var h="";await this.getCurrentEntry(e=>current=e);h+="current"+"="+current.getName()+"<br>";var entries=this.notebook.getCurrentEntries();for(var name in entries){var e=entries[name];h+=name+"="+e.entry.getName()+"<br>";}
if(h=="")h="No entries";div.set(h);},processCommand_echo:async function(line,toks,div){line=line.replace(/^echo */,"");div.set(line);},processCommand_print:async function(line,toks,div){line=line.replace(/^print */,"");div.set(line);},processCommand_info:async function(line,toks,div){await this.getCurrentEntry(e=>entry=e);div.append("current:"+entry.getName()+" id:"+entry.getId()+"<br>");},processCommand_cd:async function(line,toks,div){if(div==null)div=new Div();if(toks.length<=1){await this.setCurrentEntry(this.notebook.getBaseEntry());return;}
var arg=Utils.join(toks," ",1).trim();var entry;await this.getEntryFromPath(arg,e=>entry=e);if(!entry){div.msg("Could not get entry:"+arg);return;}
await this.setCurrentEntry(entry);},getEntryFromPath:async function(arg,callback){var entry;await this.getCurrentEntry(e=>entry=e);if(arg.startsWith("/")){await entry.getRoot(e=>{entry=e});}
var dirs=arg.split("/");for(var i=0;i<dirs.length;i++){var dir=dirs[i];if(dir=="")continue;if(dir==".."){await entry.getParentEntry(e=>{entry=e});if(!entry){break;}}else{await entry.getChildrenEntries(c=>children=c);var child=null;var startsWith=false;var endsWith=false;if(dir.endsWith("*")){dir=dir.substring(0,dir.length-1);startsWith=true;}
if(dir.startsWith("*")){dir=dir.substring(1);endsWith=true;}
for(var childIdx=0;childIdx<children.length;childIdx++){var name=children[childIdx].getName();if(startsWith&&endsWith){if(name.includes(dir)){child=children[childIdx];break;}}else if(startsWith){if(name.startsWith(dir)){child=children[childIdx];break;}}else if(endsWith){if(name.endsWith(dir)){child=children[childIdx];break;}}
if(children[childIdx].getName()==dir){child=children[childIdx];break;}}
if(!child){break;}
entry=child;}}
return Utils.call(callback,entry);},processCommand_ls:async function(line,toks,div){if(div==null)div=new Div();div.set("Listing entries...");await this.getCurrentEntry(e=>entry=e);await entry.getChildrenEntries(children=>{this.displayEntries(children,div)},"");},entryListChanged:function(entryList){var entries=entryList.getEntries();if(entries.length==0){this.writeStatusMessage("Sorry, nothing found");}else{this.displayEntries(entries);}},processCommand_search:async function(line,toks,div){var text="";for(var i=1;i<toks.length;i++)text+=toks[i]+" ";text=text.trim();var settings=new EntrySearchSettings({text:text,});var jsonUrl=this.notebook.getRamadda().getSearchUrl(settings,OUTPUT_JSON);let _this=this;var myCallback={entryListChanged:function(list){var entries=list.getEntries();div.set("");if(entries.length==0){div.append("Nothing found");}else{_this.displayEntries(entries,div)}}};var entryList=new EntryList(this.notebook.getRamadda(),jsonUrl,myCallback,false);div.set("Searching...");await entryList.doSearch();},processCommand_clear:function(line,toks,div){this.clearOutput();},processCommand_save:function(line,toks,div){this.notebook.saveNotebook();},});}
function processLispOutput(r){if(r&&r.val)return r.val;return Utils.formatJson(r);}
function NotebookChunk(cell,props){for(name in props)
props[name.toLowerCase()]=props[name];this.div=new Div(null,"display-notebook-chunk");this.cell=cell;$.extend(this,{getContent:function(){var content=this.content;for(name in this.cell.notebook.globals){var value=this.cell.notebook.getGlobalValue(name);if(typeof value=="object"){value=Utils.formatJson(value);}
content=content.replace("${"+name.trim()+"}",value);}
return content;},initChunk:function(props){this.skipOutput=false;if(props["skipoutput"]===true){this.skipOutput=true;this.div.set("");this.div=new Div();}
var depends=[];if(props["depends"]&&typeof props["depends"]=="string")depends=props["depends"].split(",");var content=props.content||"";var regexp=RegExp(/\${([^ }]+)}/g);while((result=regexp.exec(content))!==null){var param=result[1];if(!depends.includes(param))depends.push(param);}
$.extend(this,{name:props["name"],depends:depends,output:null,runFirst:props["runFirst"],hasRun:false,content:content,type:props.type,props:props,doChunk:!!props.doChunk,ok:true});}});this.initChunk(props);}
const DISPLAY_D3_GLIDER_CROSS_SECTION="GliderCrossSection";const DISPLAY_D3_LINECHART="D3LineChart";const DISPLAY_SKEWT="skewt";const DISPLAY_VENN="venn";const DISPLAY_CHERNOFF="chernoff";const DISPLAY_D3BUBBLE="d3bubble";const DISPLAY_MINIDOTS="minidots";addGlobalDisplayType({type:DISPLAY_D3_LINECHART,forUser:false,label:"D3 LineChart",requiresData:true,category:"Charts"});addGlobalDisplayType({type:DISPLAY_D3_GLIDER_CROSS_SECTION,forUser:false,label:"Glider cross section",requiresData:true,category:CATEGORY_MISC});addGlobalDisplayType({type:DISPLAY_VENN,forUser:true,label:"Venn Diagram",requiresData:true,category:CATEGORY_MISC,tooltip:makeDisplayTooltip("A Venn diagram","venn.png")});addGlobalDisplayType({type:DISPLAY_MINIDOTS,forUser:false,label:"Mini Dots",requiresData:true,category:CATEGORY_MISC});addGlobalDisplayType({type:DISPLAY_CHERNOFF,forUser:false,label:"Chernoff Faces",requiresData:true,category:CATEGORY_MISC});addGlobalDisplayType({type:DISPLAY_D3BUBBLE,forUser:true,label:"Bubble Chart",requiresData:true,category:CATEGORY_IMAGES,tooltip:makeDisplayTooltip("Animated bubbles showing images","d3bubble.png"),});addGlobalDisplayType({type:DISPLAY_SKEWT,forUser:false,label:"SkewT",requiresData:true,category:CATEGORY_MISC});const FIELD_TIME="time";const FIELD_DEPTH="depth";const FIELD_VALUE="value";const FIELD_SELECTEDFIELD="selectedfield";const TYPE_LATITUDE="latitude";const TYPE_LONGITUDE="longitude";const TYPE_TIME="time";const TYPE_VALUE="value";const TYPE_ELEVATION="elevation";const FUNC_MOVINGAVERAGE="movingAverage";const D3Util={foo:"bar",getAxis:function(axisType,range){var axis;if(axisType==FIELD_TIME){axis=d3.time.scale().range(range);}else{axis=d3.scale.linear().range(range);}
return axis;},getDataValue:function(axis,record,index){var data;if(axis.fieldIdx>=0){data=record.getData()[axis.fieldIdx];}else{switch(axis.type){case TYPE_TIME:data=new Date(record.getDate());break;case TYPE_ELEVATION:data=record.getElevation();break;case TYPE_LATITUDE:data=record.getLatitude();case TYPE_LONGITUDE:data=record.getLongitude();default:data=record.getData()[index];}}
if(axis.reverse==true){return-1*data;}else{return data;}},getColorFromColorBar:function(value,range){var colors=["#00008B","#0000CD","#0000FF","#00FFFF","#7CFC00","#FFFF00","#FFA500","#FF4500","#FF0000","#8B0000"];var colorScale=d3.scale.linear().domain([0,colors.length-1]).range(range);var colorScaler=d3.scale.linear().range(colors).domain(d3.range(0,colors.length).map(colorScale));color=colorScaler(value);return color;},addColorBar:function(svg,colors,colorSpacing,displayWidth){var colorBar=svg.append("g").attr({"id":"colorBarG","transform":"translate("+(displayWidth-40)+",0)"});colorBar.append("g").append("defs").append("linearGradient").attr({id:"colorBarGradient",x1:"0%",y1:"100%",x2:"0%",y2:"0%"}).selectAll("stop").data(colors).enter().append("stop").attr({"offset":function(d,i){return colorSpacing*(i)+"%"},"stop-color":function(d,i){return colors[i]},"stop-opacity":1});return colorBar;}}
function RamaddaSkewtDisplay(displayManager,id,properties){const ID_SKEWT="skewt";const ID_DATE_LABEL="skewtdate";const SUPER=new RamaddaDisplay(displayManager,id,DISPLAY_SKEWT,properties);let myProps=[{label:'Skewt Attributes'},{p:'skewtWidth',ex:'500'},{p:'skewtHeight',ex:'550'},{p:'hodographWidth',ex:'150'},{p:'showHodograph',ex:'false'},{p:'windStride',ex:'1'},{p:'showText',ex:'false'},];defineDisplay(addRamaddaDisplay(this),SUPER,myProps,{needsData:function(){return true;},initDisplay:function(){SUPER.initDisplay.call(this);},handleEventPointDataLoaded:function(source,pointData){this.updateUI();},updateUI:async function(){if(!this.loadedResources){var time=new Date();await Utils.importCSS(ramaddaBaseUrl+"/htdocs_v_"+time.getTime()+"/lib/skewt/sounding.css");await Utils.importJS(ramaddaBaseUrl+"/htdocs_v_"+time.getTime()+"/lib/skewt/d3skewt.js");this.loadedResources=true;}
if(!window["D3Skewt"]){setTimeout(()=>this.updateUI(),100);return;}
SUPER.updateUI.call(this);let records=this.filterData();if(!records||records.length==0){this.setDisplayMessage(this.getLoadingMessage());return;}
let skewtId=this.getDomId(ID_SKEWT);let html=HtmlUtils.div(["id",skewtId],"");this.setContents(html);var date=records[0].getDate();if(this.jq(ID_DATE_LABEL).length==0){this.jq(ID_TOP_LEFT).append(HtmlUtils.div([ID,this.getDomId(ID_DATE_LABEL)]));}
if(date!=null){this.jq(ID_DATE_LABEL).html("Date: "+this.formatDate(date));}else{this.jq(ID_DATE_LABEL).html("");}
var options={};if(this.propertyDefined("showHodograph"))
options.showHodograph=this.getProperty("showHodograph",true);if(this.propertyDefined("showText"))
options.showText=this.getProperty("showText",true);if(this.propertyDefined("skewtWidth"))
options.skewtWidth=parseInt(this.getProperty("skewtWidth"));if(this.propertyDefined("skewtHeight"))
options.skewtHeight=parseInt(this.getProperty("skewtHeight"));if(this.propertyDefined("hodographWidth")){options.hodographWidth=parseInt(this.getProperty("hodographWidth"));}
if(this.propertyDefined("windStride")){options.windStride=parseInt(this.getProperty("windStride"));}
options.showText=this.getProperty("showText",true);var fields=this.getData().getRecordFields();var names=[{id:"pressure",aliases:["vertCoord"]},{id:"height",aliases:["Geopotential_height_isobaric"]},{id:"temperature",aliases:["Temperature_isobaric"]},{id:"dewpoint",aliases:[]},{id:"rh",aliases:["Relative_humidity_isobaric","relative_humidity"]},{id:"wind_direction",aliases:[]},{id:"wind_speed",aliases:[]},{id:"uwind",aliases:["u-component_of_wind_isobaric","u"]},{id:"vwind",aliases:["v-component_of_wind_isobaric","v"]},];var data={};var dataFields={};for(var i=0;i<names.length;i++){var obj=names[i];var id=obj.id;var field=this.getFieldById(fields,id);if(field==null){for(var j=0;j<obj.aliases.length;j++){field=this.getFieldById(fields,obj.aliases[j]);if(field)break;}}
if(field){data[id]=this.getColumnValues(records,field).values;dataFields[id]=field;}}
if(!data.pressure){this.displayError("No pressure defined in data");return;}
if(!data.temperature){this.displayError("No temperature defined in data");return;}
if(!data.height){var pressures=[1013.25,954.61,898.76,845.59,795.01,746.91,701.21,657.80,616.6,577.52,540.48,505.39,472.17,440.75,411.05,382.99,356.51,331.54,303.00,285.85,264.99,226.99,193.99,165.79,141.70,121.11,103.52,88.497,75.652,64.674,55.293,25.492,11.970,5.746,2.871,1.491,0.798,0.220,0.052,0.010,];var alts=[0,500,1000,1500,2000,2500,3000,3500,4000,4500,5000,5500,6000,6500,7000,7500,8000,8500,9000,9500,10000,11000,12000,13000,14000,15000,16000,17000,18000,19000,20000,25000,30000,35000,40000,45000,50000,60000,70000,80000,];data.height=[];for(var i=0;i<data.pressure.length;i++){var pressure=data.pressure[i];var alt=alts[alts.length-1];for(var j=0;j<pressures.length;j++){if(pressure>=pressures[j]){if(j==0)alt=0;else{var p1=pressures[j-1];var p2=pressures[j];var a1=alts[j-1];var a2=alts[j];var percent=1-(pressure-p2)/(p1-p2);alt=(a2-a1)*percent+a1;}
break;}}
data.height.push(alt);}}
if(!data.dewpoint){if(!data.rh){this.displayError("No dewpoint or rh");return;}
data.dewpoint=[];for(var i=0;i<data.rh.length;i++){var rh=data.rh[i];var t=data.temperature[i];var dp=t-(100-rh)/5;data.dewpoint.push(dp);}}
if(!data.wind_speed){if(!data.uwind||!data.vwind){this.displayError("No wind speed defined in data");return;}
data.wind_speed=[];data.wind_direction=[];for(var i=0;i<data.uwind.length;i++){var u=data.uwind[i];var v=data.vwind[i];var ws=Math.sqrt(u*u+v*v);var wdir=180+(180/Math.PI)*Math.atan2(v,u);data.wind_speed.push(ws);data.wind_direction.push(wdir);}}
var alldata=data;data={};for(a in alldata)data[a]=[];alldata[names[0].id].map((v,idx)=>{var ok=true;for(id in alldata){if(isNaN(alldata[id][idx])){ok=false;break;}}
if(ok){for(id in alldata){data[id].push(alldata[id][idx]);}}});if(data.height.length>1){if(data.height[0]>data.height[1]){for(name in data)
data[name]=Utils.reverseArray(data[name]);}}
if(data.temperature.length==0){this.displayError(this.getNoDataMessage());return;}
options.myid=this.getId();try{this.skewt=new D3Skewt(skewtId,options,data);}catch(e){this.displayError("An error occurred: "+e);console.log("error:"+e.stack);return;}
await this.getDisplayEntry((e)=>{if(!e)return;var q=e.getAttribute("variables");if(!q)return;q=q.value;q=q.replace(/\r\n/g,"\n");q=q.replace(/^ *\n/,"");q=q.replace(/^ *([^:]+):([^\n].*)$/gm,"<div title='$1' class=display-skewt-index-label>$1</div>: <div title='$2'  class=display-skewt-index>$2</div>");q=q.replace(/[[\r\n]/g,"\n");q=HtmlUtils.div(["class","display-skewt-text"],q);$("#"+this.skewt.textBoxId).html(q);});}});}
function RamaddaD3Display(displayManager,id,properties){const ID_SVG="svg";const SUPER=new RamaddaDisplay(displayManager,id,"d3",properties);defineDisplay(addRamaddaDisplay(this),SUPER,[],{initDisplay:function(){this.createUI();this.setDisplayTitle(properties.graph.title);var width=this.getProperty("innerWidth",600);var height=this.getProperty("innerHeight",300);var margin={top:20,right:50,bottom:30,left:50};var divStyle="height:"+height+"px;"+
"width:"+width+"px;";var html=HtmlUtils.div([ATTR_ID,this.getDomId(ID_SVG),ATTR_STYLE,divStyle],"");this.setContents(html);this.displayHeight=parseInt((d3.select("#"+this.getDomId(ID_SVG)).style("height")).split("px")[0])-margin.top-margin.bottom;this.displayWidth=parseInt((d3.select("#"+this.getDomId(ID_SVG)).style("width")).split("px")[0])-margin.left-margin.right;var myThis=this;var zoom=d3.behavior.zoom().on("zoom",function(){myThis.zoomBehaviour()});this.zoom=zoom;this.svg=d3.select("#"+this.getDomId(ID_SVG)).append("svg").attr("width",this.displayWidth+margin.left+margin.right).attr("height",this.displayHeight+margin.top+margin.bottom).attr(ATTR_CLASS,"D3graph").call(zoom).on("click",function(){myThis.click(d3.event)}).on("dblclick",function(){myThis.dbclick(d3.event)}).append("g").attr("transform","translate("+margin.left+","+margin.top+")");this.x=D3Util.getAxis(properties.graph.axis.x.type,[0,this.displayWidth-100]);this.y=D3Util.getAxis(properties.graph.axis.y.type,[this.displayHeight,0]);this.xAxis=d3.svg.axis().scale(this.x).orient("bottom");this.yAxis=d3.svg.axis().scale(this.y).orient("left");this.svg.append("g").attr(ATTR_CLASS,"x axis").attr("transform","translate(0,"+this.displayHeight+")").call(this.xAxis);this.svg.append("g").attr(ATTR_CLASS,"y axis").call(this.yAxis);var colors=["#00008B","#0000CD","#0000FF","#00FFFF","#7CFC00","#FFFF00","#FFA500","#FF4500","#FF0000","#8B0000"];var colorSpacing=100/(colors.length-1);var colorBar=D3Util.addColorBar(this.svg,colors,colorSpacing,this.displayWidth);this.color=d3.scale.category10();this.updateUI();},needsData:function(){return true;},initDialog:function(){this.addFieldsCheckboxes();},getDialogContents:function(){var height=this.getProperty(PROP_HEIGHT,"400");var html=HtmlUtils.div([ATTR_ID,this.getDomId(ID_FIELDS),ATTR_CLASS,"display-fields",]);html+=SUPER.getDialogContents.apply(this);return html;},fieldSelectionChanged:function(){this.updateUI();},updateUI:function(){var onlyZoom=false;if(!this.hasData()){return;}
test=this;var selectedFields=this.getSelectedFields();if(selectedFields.length==0){return;}
this.addFieldsCheckboxes();pointData=this.getData();if(pointData==null){console.log("no data");return;}
var fields=pointData.getNumericFields();var records=pointData.getRecords();var ranges=RecordUtil.getRanges(fields,records);var elevationRange=RecordUtil.getElevationRange(fields,records);var offset=(elevationRange[1]-elevationRange[0])*0.05;var x=this.x;var y=this.y;var color=this.color;var axis=properties.graph.axis;if(onlyZoom){this.zoom.x(this.x);this.zoom.y(this.y);}else{this.x.domain(d3.extent(records,function(d){return D3Util.getDataValue(axis.x,d,selectedFields[0].getIndex());}));this.y.domain(d3.extent(records,function(d){return D3Util.getDataValue(axis.y,d,selectedFields[0].getIndex());}));this.zoom.x(this.x);this.zoom.y(this.y);}
this.svg.selectAll(".y.axis").call(this.yAxis);this.svg.selectAll(".x.axis").call(this.xAxis);this.svg.selectAll(".line").remove();this.svg.selectAll(".legendElement").remove();var myThis=this;for(var fieldIdx=0;fieldIdx<selectedFields.length;fieldIdx++){var dataIndex=selectedFields[fieldIdx].getIndex();var range=ranges[dataIndex];var line=d3.svg.line().x(function(d){return x(D3Util.getDataValue(axis.x,d,selectedFields[fieldIdx].getIndex()));}).y(function(d){return y(D3Util.getDataValue(axis.y,d,selectedFields[fieldIdx].getIndex()));});displayLine=this.svg.append("path").datum(records).attr(ATTR_CLASS,"line").attr("d",line).on("mousemove",function(){myThis.mouseover(d3.event)}).attr("fill","none").attr("stroke",function(d){return color(fieldIdx);}).attr("stroke-width","0.5px");if(properties.graph.axis.z==FIELD_SELECTEDFIELD){displayLine.attr("stroke","url(#colorBarGradient)");}
if(properties.graph.derived!=null){var funcs=properties.graph.derived.split(",");for(funcIdx=0;funcIdx<funcs.length;funcIdx++){var func=funcs[funcIdx];if(func==FUNC_MOVINGAVERAGE){var movingAverageLine=d3.svg.line().x(function(d){return x(D3Util.getDataValue(axis.x,d,selectedFields[fieldIdx].getIndex()));}).y(function(d,i){if(i==0){return _movingSum=D3Util.getDataValue(axis.y,d,selectedFields[fieldIdx].getIndex());}else{_movingSum+=D3Util.getDataValue(axis.y,d,selectedFields[fieldIdx].getIndex());}
return y(_movingSum/i);}).interpolate("basis");this.svg.append("path").attr(ATTR_CLASS,"line").attr("d",movingAverageLine(records)).attr("fill","none").attr("stroke",function(d){return color(fieldIdx);}).attr("stroke-width","1.5px").attr("viewBox","50 50 100 100 ").style("stroke-dasharray",("3, 3"));}else{console.log("Error: Unknown derived function:"+func);}}}
this.svg.append("svg:rect").attr(ATTR_CLASS,"legendElement").attr("x",this.displayWidth-100).attr("y",(50+50*fieldIdx)).attr("stroke",function(d){return color(fieldIdx);}).attr("height",2).attr("width",40);this.svg.append("svg:text").attr(ATTR_CLASS,"legendElement").attr("x",this.displayWidth-100+40+10).attr("y",(55+55*fieldIdx)).attr("stroke",function(d){return color(fieldIdx);}).attr("style","font-size:50%").text(selectedFields[fieldIdx].getLabel());}},zoomBehaviour:function(){this.updateUI(true);},handleEventRecordSelection:function(source,args){},mouseover:function(){testing=d3.event;console.log("mouseover");},click:function(event){console.log("click:"+event);},dbclick:function(event){this.zoom();this.updateUI();},getSVG:function(){return this.svg;}});}
function RamaddaD3LineChartDisplay(displayManager,id,properties){var dfltProperties={};dfltProperties.graph={title:"Line chart",derived:FUNC_MOVINGAVERAGE,axis:{y:{type:TYPE_VALUE,fieldname:FIELD_SELECTEDFIELD},x:{type:TYPE_TIME,fieldname:FIELD_TIME,}}};properties=$.extend(dfltProperties,properties);return new RamaddaD3Display(displayManager,id,properties);}
function RamaddaGliderCrossSectionDisplay(displayManager,id,properties){var dfltProperties={};dfltProperties.graph={title:"Glider cross section",derived:null,axis:{y:{type:TYPE_ELEVATION,fieldname:FIELD_DEPTH,reverse:true},x:{type:TYPE_TIME,fieldname:FIELD_TIME,},z:FIELD_SELECTEDFIELD,}};properties=$.extend(dfltProperties,properties);return new RamaddaD3Display(displayManager,id,properties);}
function RamaddaVennDisplay(displayManager,id,properties){const ID_VENN="venn";const SUPER=new RamaddaFieldsDisplay(displayManager,id,DISPLAY_VENN,properties);defineDisplay(addRamaddaDisplay(this),SUPER,[],{getContentsStyle:function(){return"";},checkLayout:function(){this.updateUIInner();},updateUI:function(){var includes="<script src='"+ramaddaBaseUrl+"/lib/venn.js'></script>";this.writeHtml(ID_DISPLAY_TOP,includes);let _this=this;var func=function(){_this.updateUIInner();};setTimeout(func,10);},updateUIInner:function(){let records=this.filterData();if(!records){return;}
var allFields=this.getData().getRecordFields();var fields=this.getSelectedFields(allFields);if(fields.length==0)
fields=allFields;var strings=this.getFieldsByType(fields,"string");if(strings.length==0){this.displayError("No string fields specified");return;}
var setInfos={};var setCnt=0;for(var rowIdx=0;rowIdx<records.length;rowIdx++){var row=this.getDataValues(records[rowIdx]);var keys=[];var key="";for(var fieldIdx=0;fieldIdx<strings.length;fieldIdx++){var field=strings[fieldIdx];var value=row[field.getIndex()];var setKey=field.getId()+"--"+value;keys.push(setKey);key+="--"+setKey;if(!Utils.isDefined(setInfos[setKey])){setInfos[setKey]={count:0,setIds:[setCnt],label:value,};setCnt++;}
setInfos[setKey].count++;}
var ids=[];if(!Utils.isDefined(setInfos[key])){for(var i=0;i<keys.length;i++){ids.push(setInfos[keys[i]].setIds[0]);}
setInfos[key]={count:0,setIds:ids,label:null,};}
setInfos[key].count++;}
var sets=[];for(var a in setInfos){var setInfo=setInfos[a];var obj={sets:setInfo.setIds,size:setInfo.count};if(setInfo.label)
obj.label=setInfo.label;sets.push(obj);}
this.setContents(HtmlUtils.div(["id",this.getDomId(ID_VENN),"style","height:300px;"],""));var chart=venn.VennDiagram().width(600).height(400);var id="#"+this.getDomId(ID_VENN);var strokeColors=this.getColorTable(true,"strokeColors","nice");var fillColors=this.getColorTable(true,"fillColors","nice");var textColors=this.getColorTable(true,"textColors");if(!textColors)
textColors=strokeColors;d3.select(id).datum(sets).call(chart);d3.selectAll(id+" .venn-circle path").style("fill-opacity",parseFloat(this.getProperty("fillOpacity",0.5))).style("stroke-width",parseInt(this.getProperty("strokeWidth",1))).style("stroke-opacity",parseFloat(this.getProperty("strokeOpacity",0.5))).style("stroke",function(d,i){return i<strokeColors.length?strokeColors[i]:strokeColors[i%strokeColors.length];}).style("fill",function(d,i){return i<fillColors.length?fillColors[i]:fillColors[i%fillColors.length];})
d3.selectAll(id+" .venn-circle text").style("fill",function(d,i){return i<textColors.length?textColors[i]:textColors[i%textColors.length];}).style("font-size",this.getProperty("fontSize","16px")).style("font-weight",this.getProperty("fontWeight","100"));}});}
function RamaddaMinidotsDisplay(displayManager,id,properties){const ID_MINIDOTS="minidots";const SUPER=new RamaddaFieldsDisplay(displayManager,id,DISPLAY_MINIDOTS,properties);let myProps=[{label:'Minidots Properties'},{p:'dateField',ex:''},{p:'valueField',ex:''},];defineDisplay(addRamaddaDisplay(this),SUPER,[],{getContentsStyle:function(){return"";},checkLayout:function(){this.updateUI();},updateUI:function(){let records=this.filterData();if(!records){return;}
let dotsWidth=+this.getProperty("dotsWidth",500);let dotsHeight=+this.getProperty("dotsHeight",200);let valueField=this.getFieldById(null,this.getPropertyValueField());let dateField=this.getFieldById(null,this.getPropertyDateField());let groupByField=this.getFieldById(null,this.getProperty("groupBy"));let divisor=+this.getProperty("divisor",1);if(!valueField){this.displayError("No value field specified");return;}
if(!dateField)dateField=this.getFieldByType(null,"date");let dateToCount={};let minDate=null,maxDate=null;let groups={};records.forEach(record=>{let date=dateField?record.getValue(dateField.getIndex()):record.getDate();minDate=minDate!=null?Math.min(minDate,date.getTime()):date;maxDate=maxDate!=null?Math.max(maxDate,date.getTime()):date;});records.forEach(record=>{let groupByValue=groupByField?record.getValue(groupByField.getIndex()):"all";let date=dateField?record.getValue(dateField.getIndex()):record.getDate();minDate=minDate!=null?Math.min(minDate,date.getTime()):date;maxDate=maxDate!=null?Math.max(maxDate,date.getTime()):date;let data=groups[groupByValue];if(!data){groups[groupByValue]=data={records:[],total:0,list:[],seen:{}}}
data.records.push(record);let value=record.getValue(valueField.getIndex());data.total+=value;value=value/divisor;if(data.list.length>5000)return;for(let i=0;i<value;i++){data.list.push({x:date.getTime(),y:Math.random(),record:record});}});let range={minx:minDate,maxx:maxDate,miny:0,maxy:1}
let groupList=Object.keys(groups).sort();if(!groupByField){let data=groups["all"];this.setContents(HtmlUtils.div([CLASS,"display-minidots-dots",ID,this.getDomId(ID_MINIDOTS),STYLE,HU.css(HEIGHT,HU.getDimension(dotsHeight),WIDTH,HU.getDimension(dotsWidth))],""));drawDots(this,"#"+this.getDomId(ID_MINIDOTS),dotsWidth,dotsHeight,data.list,range,null );}else{let container=this.jq(ID_MINIDOTS);let table="<table border=1>";groupList.forEach((key,idx)=>{let data=groups[key];table+="<tr>";table+=HU.td([],key+" ("+data.total+")");let id=this.getDomId(ID_MINIDOTS+"_"+idx);table+=HU.td([],HtmlUtils.div([CLASS,"display-minidots-dots",ID,id,STYLE,HU.css(HEIGHT,HU.getDimension(dotsHeight),WIDTH,HU.getDimension(dotsWidth))],""));table+="</tr>\n";});this.setContents(table);groupList.forEach((key,idx)=>{let data=groups[key];let id=this.getDomId(ID_MINIDOTS+"_"+idx);drawDots(this,"#"+id,dotsWidth,dotsHeight,data.list,range,null );});}}});}
function RamaddaChernoffDisplay(displayManager,id,properties){const ID_VENN="venn";const SUPER=new RamaddaFieldsDisplay(displayManager,id,DISPLAY_VENN,properties);defineDisplay(addRamaddaDisplay(this),SUPER,[],{getContentsStyle:function(){return"";},checkLayout:function(){this.updateUIInner();},timeout:100,written:false,updateUI:function(){if(!this.written){this.written=true;var includes="<script src='"+ramaddaBaseUrl+"/lib/chernoff.js'></script>";this.writeHtml(ID_DISPLAY_TOP,includes);}
this.updateUIInner();},updateUIInner:function(){let _this=this;if(!Utils.isDefined(d3.chernoff)){this.timeout=this.timeout*2;var func=function(){_this.updateUIInner();};setTimeout(func,this.timeout);return;}
let records=this.filterData();if(!records){return;}
var allFields=this.getData().getRecordFields();var fields=this.getSelectedFields(allFields);var numericFields=this.getFieldsByType(fields,"numeric");if(numericFields.length==0){this.displayError("No numeric fields specified");return;}
if(fields.length==0)
fields=allFields;var string=this.getFieldByType(fields,"string");var legend="";var colorField=this.getFieldById(allFields,this.getProperty("colorBy"));var colorscale;if(colorField){var colors=this.getColorTable(true,null,"blue_white_red");var colorValues=this.getColumnValues(records,colorField);colorscale=[];var min=parseFloat(this.getProperty("colorByMin",colorValues.min));var max=parseFloat(this.getProperty("colorByMax",colorValues.max));var range=max-min;for(var i=0;i<colorValues.values.length;i++){var value=colorValues.values[i];var percent=(value-min)/range;var idx=Math.round(percent*(colors.length-1));colorscale.push(colors[idx]);}
this.displayColorTable(colors,ID_DISPLAY_BOTTOM,min,max);legend+="<b>Colored by</b>: "+colorField.getLabel()+"&nbsp;&nbsp;";}
var attrs=[{label:"Face width",name:"face",key:"f",min:0,max:1},{label:"Hair",name:"hair",key:"h",min:-1,max:1},{label:"Mouth",name:"mouth",key:"m",min:-1,max:1},{label:"Nose height",name:"noseHeight",key:"nh",min:0,max:1},{label:"Nose width",name:"noseWidth",key:"nw",min:0,max:1},{label:"Eyes height",name:"eyesHeight",key:"eh",min:0,max:1},{label:"Eyes width",name:"eyesWidth",key:"ew",min:0,max:1},{label:"Brow",name:"brow",key:"b",min:-1,max:1}];var html="";var showHelp=this.getProperty("showHelp",false);if(showHelp){html+="Settings:<br><table class=ramadda-table><thead><tr><th>Attribute&nbsp;</th><th>&nbsp;Default range&nbsp;</th><th>&nbsp;Set field&nbsp;</th><th>&nbsp;Set min&nbsp;</th><th>&nbsp;Set max&nbsp;</th></tr></thead><tbody>";}
for(a in attrs){var attr=attrs[a];if(showHelp){html+="<tr><td>"+attr.label+"</td><td align=center>"+attr.min+" - "+attr.max+"</td><td>"+attr.name+"Field=&lt;field_id&gt;"+"</td><td>"+attr.name+"Min=&lt;min_value&gt;"+"</td><td>"+attr.name+"Max=&lt;max_value&gt;"+"</td></tr>";}
attr.field=this.getFieldById(allFields,this.getProperty(attr.name+"Field"));if(attr.field){legend+="<b>"+attr.label+"</b>: "+attr.field.getLabel()+"&nbsp;&nbsp;";if(Utils.isDefined(this.getProperty(attr.name+"Min"))){attr.min=parseFloat(this.getProperty(attr.name+"Min"));}
if(Utils.isDefined(this.getProperty(attr.name+"Max"))){attr.max=parseFloat(this.getProperty(attr.name+"Max"));}
attr.column=this.getColumnValues(records,attr.field);}}
if(showHelp){html+="</tbody></table>";}
var sortField=this.getFieldById(allFields,this.getProperty("sortBy"));var rows=[];for(var rowIdx=0;rowIdx<records.length;rowIdx++){var blob={values:this.getDataValues(records[rowIdx])};if(colorscale)blob.color=colorscale[rowIdx]
rows.push(blob);}
if(sortField){rows.sort(function(a,b){var v1=a.values[sortField.getIndex()];var v2=b.values[sortField.getIndex()];if(v1<v2)return 1;if(v1>v2)return-1;return 0;});}
var data=[];for(var rowIdx=0;rowIdx<rows.length;rowIdx++){var blob=rows[rowIdx];var row=blob.values;var color=blob.color;var faceData={f:0.5,h:0,m:0,nh:0.5,nw:0.5,eh:0.5,ew:0.5,b:0};data.push({faceData:faceData,color:color});var tt="";for(a in attrs){var attr=attrs[a];var field=attr.field;if(!field){faceData[attr.key]=attr.min+(attr.max-attr.min)/2;}else{var value=row[field.getIndex()];var min=attr.column.min;var max=attr.column.max;tt+=field.getLabel()+": "+value+" range: "+min+" - "+max+" ("+attr.label+")\n";if(max!=min){var percent=(value-min)/(max-min);var adjValue=attr.min+(attr.max-attr.min)*percent;faceData[attr.key]=adjValue;}}}
var label=(string?row[string.getIndex()]:"Row: "+rowIdx);var labelValue=(string?row[string.getIndex()]:"");label=HtmlUtils.div(["class","display-chernoff-label"],label);var div=HtmlUtils.div(["id",this.getDomId("chernoff")+"_"+rowIdx,"class","display-chernoff-face"],"");html+=HtmlUtils.div(["title",tt,"class","display-chernoff-wrapper ramadda-div-link","value",labelValue],div+label);}
legend=HtmlUtils.div(["class","display-chernoff-legend"],legend);var height=this.getProperty("height","400px");if(!height.endsWith("px"))height+="px";this.setContents(legend+HtmlUtils.div(["style","height:"+height+";","class","display-chernoff-container","id",this.getDomId("chernoff")],html));for(var rowIdx=0;rowIdx<records.length;rowIdx++){var div="#"+this.getDomId("chernoff")+"_"+rowIdx;this.makeFace(div,data[rowIdx].faceData,data[rowIdx].color);}
if(string){this.find(".ramadda-div-link").click(function(){var value=$(this).attr("value");_this.propagateEvent("fieldValueSelected",{field:string,value:value});});}},makeFace:function(div,faceData,color){function chernoffFace(){var width=400,height=200;var chernoff=d3.chernoff().face(function(d){return d.f;}).hair(function(d){return d.h;}).mouth(function(d){return d.m;}).nosew(function(d){return d.nw;}).noseh(function(d){return d.nh;}).eyew(function(d){return d.ew;}).eyeh(function(d){return d.eh;}).brow(function(d){return d.b;});function data(){return[faceData];}
function drawFace(selection){var svg=selection.append("svg").attr("width",width).attr("height",height);var face=svg.selectAll("g.chernoff").data(data()).enter().append("g").attr("class","chernoff").call(chernoff);if(color)
face.attr("style","fill:"+color);}
function draw(selection){selection.call(drawFace);}
return draw;}
d3.select(div).call(chernoffFace());}});}
function RamaddaD3bubbleDisplay(displayManager,id,properties){const ID_BUBBLES="bubbles";const SUPER=new RamaddaDisplay(displayManager,id,DISPLAY_D3BUBBLE,properties);if(!window["BubbleChart"]){Utils.importJS(ramaddaBaseUrl+"/lib/d3/d3-legend.min.js");Utils.importJS(ramaddaBaseUrl+"/lib/d3/bubblechart.js");}
let myProps=[{label:'Bubble Chart'},{p:'labelField',ex:''},{p:'colorBy',ex:''},{p:'valueField',ex:''},{p:'descriptionField',ex:''},{p:'imageField',ex:''},{p:'sizeLabel1',ex:''},{p:'sizeLabel2',ex:''},{p:'showSizeLegend',ex:'false'}];defineDisplay(addRamaddaDisplay(this),SUPER,myProps,{needsData:function(){return true;},callbackWaiting:false,displayData:function(){this.updateUI();},updateUI:function(){if(!window["BubbleChart"]){if(!this.callbackWaiting){this.callbackWaiting=true;setTimeout(()=>{this.callbackWaiting=false;this.updateUI()},100);}
return;}
if(this.getContents().width()==0){this.setContents("...");return;}
let records=this.filterData();if(!records){return;}
let colorByField=this.getFieldById(null,this.getProperty("colorBy","category"));let valueField=this.getFieldById(null,this.getProperty("valueField"));if(colorByField)
this.setProperty("sortFields",colorByField.getId());let html=HtmlUtil.tag("svg",["id",this.getDomId(ID_BUBBLES),"width","100%","height","700","font-family","sans-serif","font-size","10","text-anchor","middle"])
this.setContents(html);let values;let min=0;let max=0;if(valueField){values=this.getColumnValues(records,valueField).values;values.map((v,idx)=>{min=idx==0?v:Math.min(v,min);max=idx==0?v:Math.max(v,max);});}
let labelField=this.getFieldById(null,this.getProperty("labelField","name"));let descField=this.getFieldById(null,this.getProperty("descriptionField"));let imageField=this.getFieldById(null,this.getProperty("imageField"));let template=this.getProperty("template","${default}");if(!labelField){this.setContents(this.getMessage("No label field found"));return}
let data=[];records.map(r=>{let desc=descField?r.getValue(descField.getIndex()):this.getRecordHtml(r,null,template);let label=r.getValue(labelField.getIndex());let obj={name:label,icon:label,desc:desc,cat:"",value:10,}
if(colorByField)
obj.cat=r.getValue(colorByField.getIndex());if(valueField)
obj.value=r.getValue(valueField.getIndex());if(imageField)
obj.icon=r.getValue(imageField.getIndex());data.push(obj);});if(data.length==0){this.setContents(this.getMessage(this.getNoDataMessage()));return;}
let colors=this.getColorTable(true);new BubbleChart("#"+this.domId(ID_BUBBLES),data,{label1:this.getProperty("sizeLabel1"),label2:this.getProperty("sizeLabel2"),colors:colors,showSizeLegend:this.getProperty("showSizeLegend",valueField!=null)});}})}
const DISPLAY_WORDCLOUD="wordcloud";const DISPLAY_TEXTSTATS="textstats";const DISPLAY_FREQUENCY="frequency";const DISPLAY_TEXTANALYSIS="textanalysis";const DISPLAY_TEXTRAW="textraw";const DISPLAY_TEXT="text";const DISPLAY_BLOCKS="blocks";const DISPLAY_TEMPLATE="template";const DISPLAY_TOPFIELDS="topfields";const DISPLAY_GLOSSARY="glossary";addGlobalDisplayType({type:DISPLAY_TEXT,label:"Text Readout",requiresData:true,forUser:true,category:CATEGORY_TEXT,tooltip:makeDisplayTooltip("Simple text display","text.png")});addGlobalDisplayType({type:DISPLAY_TEMPLATE,label:"Template",requiresData:true,forUser:true,category:CATEGORY_TEXT,tooltip:makeDisplayTooltip("Flexible text template to show records","template.png")});addGlobalDisplayType({type:DISPLAY_TOPFIELDS,label:"Top Fields",requiresData:true,forUser:true,category:CATEGORY_MISC,tooltip:makeDisplayTooltip("List Fields","topfields.png","For every row it sorts the field values and lists the field names"),});addGlobalDisplayType({type:DISPLAY_WORDCLOUD,forUser:true,label:"Word Cloud",requiresData:true,category:CATEGORY_TEXT,tooltip:makeDisplayTooltip("Cloud of words","wordcloud.png")});addGlobalDisplayType({type:DISPLAY_TEXTSTATS,forUser:true,label:"Text Stats",requiresData:true,category:CATEGORY_TEXT,tooltip:makeDisplayTooltip("Summary statistics for text","textstats.png","Incudes line/word count, word length and frequency")});addGlobalDisplayType({type:DISPLAY_FREQUENCY,forUser:true,label:"Frequency",requiresData:true,category:CATEGORY_TEXT,tooltip:makeDisplayTooltip("Text field based frequencies","frequency.png")});addGlobalDisplayType({type:DISPLAY_TEXTRAW,forUser:true,label:"Text Raw",requiresData:true,category:CATEGORY_TEXT,tooltip:makeDisplayTooltip("Shows raw text","textraw.png","Provides a search field")});addGlobalDisplayType({type:DISPLAY_TEXTANALYSIS,forUser:true,label:"Text Analysis",requiresData:true,category:CATEGORY_TEXT,tooltip:makeDisplayTooltip("Analyzes text","textanalysis.png")});addGlobalDisplayType({type:DISPLAY_BLOCKS,forUser:true,label:"Blocks",requiresData:true,category:CATEGORY_MISC,tooltip:makeDisplayTooltip("Blocks","blocks.png","Shows a certain number of small blocks or<br> icons color coded from the data"),});addGlobalDisplayType({type:DISPLAY_GLOSSARY,forUser:true,label:"Glossary",requiresData:true,category:CATEGORY_TEXT,tooltip:makeDisplayTooltip("Searchable glossary","glossary.png")});function RamaddaBaseTextDisplay(displayManager,id,type,properties){const ID_TEXTBLOCK="textblock";const SUPER=new RamaddaFieldsDisplay(displayManager,id,type,properties);defineDisplay(this,SUPER,[],{processText:function(cnt,fields){let records=this.filterData();if(!records){return null;}
var fieldInfo={};var allFields=this.getData().getRecordFields();fields=fields||this.getSelectedFields(allFields);if(fields.length==0)
fields=allFields;var strings=this.getFieldsByType(fields,"string");if(strings.length==0){this.displayError("No string fields specified");return null;}
var minLength=parseInt(this.getProperty("minLength",0));var maxLength=parseInt(this.getProperty("maxLength",100));var stopWords=this.getProperty("stopWords");if(stopWords){if(stopWords=="default"){stopWords=Utils.stopWords;}else{stopWords=stopWords.split(",");}}
var extraStopWords=this.getProperty("extraStopWords");if(extraStopWords)extraStopWords=extraStopWords.split(",");var stripTags=this.getProperty("stripTags",false);var tokenize=this.getProperty("tokenize",false);var lowerCase=this.getProperty("lowerCase",false);var removeArticles=this.getProperty("removeArticles",false);if(cnt){cnt.count=0;cnt.total=0;cnt.lengths={};}
for(var rowIdx=0;rowIdx<records.length;rowIdx++){var row=this.getDataValues(records[rowIdx]);for(var fieldIdx=0;fieldIdx<strings.length;fieldIdx++){var field=strings[fieldIdx];if(!fieldInfo[field.getId()]){fieldInfo[field.getId()]={field:field,words:[],counts:{},divId:this.domId(ID_TEXTBLOCK+(field.getIndex())),}}
var fi=fieldInfo[field.getId()];var value=row[field.getIndex()];if(stripTags){value=Utils.stripTags(value);}
var values=[value];if(tokenize){values[0]=values[0].replace(/\"/g," ");values=Utils.tokenizeWords(values[0],stopWords,extraStopWords,removeArticles);}
for(var valueIdx=0;valueIdx<values.length;valueIdx++){var value=values[valueIdx].trim();if(values.length>1&&value.length<=1)continue;if(value.startsWith("&"))continue;var _value=value.toLowerCase();if(cnt){cnt.count++;cnt.total+=value.length;if(!Utils.isDefined(cnt.lengths[value.length]))
cnt.lengths[value.length]=0;cnt.lengths[value.length]++;}
if(!tokenize){if(stopWords&&stopWords.includes(_value))continue;if(extraStopWords&&extraStopWords.includes(_value))continue;}
if(value.length>maxLength)continue;if(value.length<minLength)continue;if(lowerCase)value=value.toLowerCase();if(!Utils.isDefined(fi.counts[value])){fi.counts[value]=0;}
fi.counts[value]++;}}}
return fieldInfo;}});}
function RamaddaWordcloudDisplay(displayManager,id,properties){const SUPER=new RamaddaBaseTextDisplay(displayManager,id,DISPLAY_WORDCLOUD,properties);let myProps=[{label:"Wordcloud"},{p:'termField'},{p:'fields'},{p:'tableFields'},{p:'countField'},{p:'tokenize',ex:true},{p:'handleClick',ex:true},{p:'showFieldLabel',ex:true},{p:'showRecords'},{p:'combined'},{p:'shape',ex:'rectangular'},{p:'stopWords',ex:'word1,word2'},{p:'showFieldLabel',ex:'false'}];defineDisplay(addRamaddaDisplay(this),SUPER,myProps,{getContentsStyle:function(){return"";},checkLayout:function(){this.updateUIInner();},updateUI:function(){if(!this.loadedJq){this.loadedJq=true;let includes="<link rel='stylesheet' href='"+ramaddaBaseUrl+"/lib/jqcloud.min.css'>";includes+="<script src='"+ramaddaBaseUrl+"/lib/jqcloud.min.js'></script>";this.writeHtml(ID_DISPLAY_TOP,includes);let _this=this;let func=function(){_this.updateUIInner();};setTimeout(func,10);}else{this.updateUIInner();}},updateUIInner:function(){let records=this.filterData();if(records==null)return;let options={autoResize:true,};let colors=this.getColorTable(true);if(colors){options.colors=colors,options.classPattern=null;options.fontSize={from:0.1,to:0.02};}
if(this.getProperty("shape"))
options.shape=this.getProperty("shape");let countField=this.getFieldById(null,this.getProperty("countField"));let termField=this.getFieldById(null,this.getProperty("termField"));if(countField&&termField){let minLength=parseInt(this.getProperty("minLength",0));let maxLength=parseInt(this.getProperty("maxLength",100));let stopWords=this.getProperty("stopWords");if(stopWords){if(stopWords=="default"){stopWords=Utils.stopWords;}else{stopWords=stopWords.split(",");}}
let info=[];let wordToWeight={};records.every(record=>{let word=termField.getValue(record);let _word=word.toLowerCase();if(stopWords&&stopWords.includes(_word))return true;if(!wordToWeight[word]){wordToWeight[word]=0;}
wordToWeight[word]+=countField.getValue(record);return true;});let handlers=null;let _this=this;if(this.getProperty("handleClick",true)){handlers={click:function(w){let word=w.target.innerText;_this.showRows(records,null,word,fields);}}};for(word in wordToWeight){info.push({text:word,html:{style:"cursor:pointer;"},weight:wordToWeight[word],handlers:handlers,});}
this.setContents(HU.div([ID,this.domId("words"),STYLE,HU.css('height','300px')],""));$("#"+this.domId("words")).jQCloud(info,options);return}
let allFields=this.getData().getRecordFields();let fields=termField?[termField]:this.getSelectedFields(allFields);let fieldInfo=this.processText(null,fields);if(fieldInfo==null)return;if(fields.length==0)
fields=allFields;let strings=this.getFieldsByType(fields,"string");let _this=this;let divs="";let words=[];let maxWords=parseInt(this.getProperty("maxWords",-1));let minCount=parseInt(this.getProperty("minCount",0));let width=(100*1/strings.length)+"%;";for(a in fieldInfo){let fi=fieldInfo[a];let field=fi.field;let handlers=null;if(this.getProperty("handleClick",true)){handlers={click:function(w){let word=w.target.innerText;_this.showRows(records,field,word,fields);}}};let counts=[];for(word in fi.counts){let count=fi.counts[word];counts.push({word:word,count:count});}
counts.sort(function(a,b){if(a.count<b.count)return-1;if(a.count>b.count)return 1;return 0;});if(minCount>0){let tmp=[];for(let i=0;i<counts.length;i++){if(counts[i].count>=minCount)
tmp.push(counts[i]);}
counts=tmp;}
if(maxWords>0){let tmp=[];for(let i=0;i<=maxWords&&i<counts.length;i++){if(counts[i].count>=minCount)
tmp.push(counts[i]);}
counts=tmp;}
for(let wordIdx=0;wordIdx<counts.length;wordIdx++){let word=counts[wordIdx];let obj1={weight:word.count,html:{style:"cursor:pointer;"},handlers:handlers,text:word.word,};let obj2={weight:word.count,html:{style:"cursor:pointer;"},handlers:handlers,text:field.getLabel()+":"+word.word,};fi.words.push(obj1);words.push(obj2);}
let label="";if(this.getProperty("showFieldLabel",true))
label=HU.b(fi.field.getLabel());divs+=HU.div([STYLE,HU.css('display','inline-block','width',width)],label+HU.div([STYLE,HU.css('border','1px #ccc solid','height','300px'),ID,fi.divId],""));}
this.setContents("");if(this.getProperty("combined",false)){this.setContents(HU.div([ID,this.domId("words"),STYLE,HU.css('height','300px')],""));$("#"+this.domId("words")).jQCloud(words,options);}else{this.setContents(divs);for(a in fieldInfo){let fi=fieldInfo[a];$("#"+fi.divId).jQCloud(fi.words,options);}}},showRows:function(records,field,word,stringFields){if(!field)
field=this.getFieldById(null,this.getProperty("termField"));let tokenize=this.getProperty("tokenize",false);if(stringFields&&word.startsWith(field.getLabel()+":")){word=word.replace(field.getLabel()+":","");}
let tableFields;if(this.getProperty("tableFields")){tableFields={};let list=this.getProperty("tableFields").split(",");for(a in list){tableFields[list[a]]=true;}}
let fields=this.getData().getRecordFields();let html="";let data=[];let header=[];data.push(header);for(let fieldIdx=0;fieldIdx<fields.length;fieldIdx++){let f=fields[fieldIdx];if(tableFields&&!tableFields[f.getId()])continue;header.push(fields[fieldIdx].getLabel());}
let showRecords=this.getProperty("showRecords",false);if(showRecords){html+="<br>";}
let re=new RegExp("(\\b"+word+"\\b)",'i');for(let rowIdx=0;rowIdx<records.length;rowIdx++){let row=this.getDataValues(records[rowIdx]);let value=row[field.getIndex()];if(tokenize){if(!value.match(re)){continue;}}else{if(word!=value){continue;}}
let tuple=[];data.push(tuple);for(let col=0;col<fields.length;col++){let f=fields[col];if(tableFields&&!tableFields[f.getId()])continue;let v=row[f.getIndex()];if(v.getTime){v={v:v,f:this.formatDate(v)};}else{if(tokenize){v=v.replace(re,"<span style=background:yellow;>$1</span>");}}
if(showRecords){html+=HU.b(f.getLabel())+": "+v+"</br>";}else{tuple.push(v);}}
if(showRecords){html+="<p>";}}
if(showRecords){this.writeHtml(ID_DISPLAY_BOTTOM,HU.center(html));}else{let prefix="";if(!tokenize){prefix=(field?field.getLabel():"Word")+"="+word}
this.writeHtml(ID_DISPLAY_BOTTOM,HU.center(prefix+HU.div([ID,this.domId("table"),STYLE,HU.css('height','300px')],"")));let dataTable=google.visualization.arrayToDataTable(data);this.chart=new google.visualization.Table(document.getElementById(this.domId("table")));this.chart.draw(dataTable,{allowHtml:true});}}});}
function RamaddaTemplateDisplay(displayManager,id,properties){if(!Utils.isDefined(properties.showTitle))properties.showTitle=false;if(!Utils.isDefined(properties.showMenu))properties.showMenu=false;if(!Utils.isDefined(properties.displayStyle))properties.displayStyle="background:rgba(0,0,0,0);";const SUPER=new RamaddaFieldsDisplay(displayManager,id,DISPLAY_TEMPLATE,properties);let myProps=[{label:"Template"},{p:"template"},{p:"toggleTemplate",ex:"",tt:'Used as the toggle label for hiding/showing the main template'},{p:"headerTemplate",ex:"... ${totalCount} ... ${selectedCount}"},{p:"footerTemplate",ex:"... ${totalCount} ... ${selectedCount}"},{p:"emptyMessage"},{p:"select",ex:"max|min|<|>|=|<=|>=|contains"},{p:"selectField"},{p:"selectValue"},{p:'onlyShowSelected',ex:'true'},{p:'showFirst',ex:'true'},{p:'showLast',ex:'true'},{p:'selectHighlight',ex:'true'},{p:'handleSelectOnClick'},{p:"groupByField"},{p:"groupDelimiter",ex:"<br>"},{p:"groupTemplate",wikivalue:"<b>${group}</b><ul>${contents}</ul>"},{p:"sortGroups",wikivalue:"true"},{p:'${&lt;field&gt;_total}'},{p:'${&lt;field&gt;_max}'},{p:'${&lt;field&gt;_min}'},{p:'${&lt;field&gt;_average}'},{p:'highlightOnScroll',ex:'true'}];defineDisplay(addRamaddaDisplay(this),SUPER,myProps,{dataFilterChanged:function(){if(this.getPropertyOnlyShowSelected()&&this.selectedRecord){this.selectedRecord=null;this.selectedRecords=null;this.setContents("");}
SUPER.dataFilterChanged.call(this);},updateUI:function(){let pointData=this.getData();if(pointData==null)return;let records=this.filterData();if(!records)return;if(this.getPropertyOnlyShowSelected()){if(!this.selectedRecord&&!this.selectedRecords){if(this.getShowFirst(true)){this.selectedRecord=records[0];}}
if(!this.selectedRecord&&!this.selectedRecords){this.setContents("<br>");return;}
records=this.selectedRecords||[this.selectedRecord];}else{if(this.getShowFirst(false)){records=[records[0]];}else if(this.getShowLast(false)){records=[records[records.length-1]];}}
records=this.sortRecords(records);let fields=pointData.getRecordFields();let uniqueFields=this.getFieldsByIds(fields,this.getProperty("uniqueFields"));let uniqueMap={};let template=this.getProperty("template","");let toggleTemplate=this.getProperty("toggleTemplate");let select=this.getProperty("select","all");let selected=[];let summary={};let goodRecords=[];records.forEach(record=>{if(uniqueFields.length>0){var key="";uniqueFields.map(uf=>{key+="__"+uf.getValue(record);});if(Utils.isDefined(uniqueMap[key])){return;}
uniqueMap[key]=true;}
goodRecords.push(record);for(var i=0;i<fields.length;i++){var f=fields[i];var v=f.getValue(record);if(!summary[f.getId()]){summary[f.getId()]={total:0,min:v,max:v,count:0,uniques:{},uniqueCount:0}}
var s=summary[f.getId()];if(f.isString()){if(!s.uniques[v]){s.uniqueCount++;s.uniques[v]=true;}
continue;}
if(f.isDate&&v.getTime){if(v.getTime()<s.min.getTime())s.min=v;if(v.getTime()>s.max.getTime())s.max=v;}else if(!isNaN(v)){s.total+=v;s.min=Math.min(s.min,v);s.max=Math.max(s.max,v);s.count++;}}});records=goodRecords;for(var i=0;i<fields.length;i++){var f=fields[i];if(!f.isNumeric())continue;var s=summary[f.getId()];if(s&&s.count){s.average=s.total/s.count;}}
if(select=="max"||select=="min"||select=="="||select=="<"||select==">"||select=="<="||select=="?>="||select=="match"){var selectField=this.getProperty("selectField",null);if(selectField)selectField=this.getFieldById(null,selectField);if(!selectField){this.setContents("No selectField specified");return;}
var selectValue=this.getProperty("selectValue","0");var selectValueNum=parseFloat(selectValue);var max=0;var min=0;var cnt=0;var maxRecord;var minRecord;var equalsRecord;records.map(record=>{var v=selectField.getValue(record);if(select=="match"){if(v.match(selectValue)){selected.push(record);}
return;}
if(select=="="){if(v==selectValue){selected.push(record);}
return;}
if(isNaN(v))return;if(select=="<"){if(v<selectValueNum){selected.push(record);}
return;}
if(select==">"){if(v>selectValueNum){selected.push(record);}
return;}
if(select==">="){if(v>=selectValueNum){selected.push(record);}
return;}
if(select=="<="){if(v<=selectValueNum){selected.push(record);}
return;}
if(cnt++==0){min=v;max=v;minRecord=record;maxRecord=record;return;}
if(v<min){min=v;minRecord=record;}
if(v>max){max=v;maxRecord=record;}});if(select=="min"){if(minRecord)
selected.push(minRecord);}else if(select=="max"){if(maxRecord)
selected.push(maxRecord);}}else{selected=records;}
var contents="";if(selected.length==0){contents=this.getProperty("emptyMessage","Nothing found");}
var colorBy=this.getColorByInfo(selected);let attrs={};attrs["selectedCount"]=selected.length;attrs["totalCount"]=records.length;for(var i=0;i<fields.length;i++){var f=fields[i];var s=summary[f.getId()];if(!s)continue;if(f.isDate){attrs[f.getId()+"_min"]=s.min;attrs[f.getId()+"_max"]=s.max;continue;}
if(s&&f.isString()){attrs[f.getId()+"_uniques"]=s.uniqueCount;continue;}
if(!f.isNumeric())continue;if(s){attrs[f.getId()+"_total"]=s.total;attrs[f.getId()+"_min"]=s.min;attrs[f.getId()+"_max"]=s.max;attrs[f.getId()+"_average"]=s.average;}}
var headerTemplate=this.getProperty("headerTemplate","");var footerTemplate=this.getProperty("footerTemplate","");if(selected.length==1){let row=this.getDataValues(selected[0]);headerTemplate=this.applyRecordTemplate(selected[0],row,fields,headerTemplate);footerTemplate=this.applyRecordTemplate(selected[0],row,fields,footerTemplate);}
if(this.filters){let replace=(pattern,value)=>{headerTemplate=headerTemplate.replace(pattern,value);footerTemplate=footerTemplate.replace(pattern,value);};for(var filterIdx=0;filterIdx<this.filters.length;filterIdx++){let filter=this.filters[filterIdx];if(!filter.isEnabled()){continue;}
let f=filter.getField();if(f.isNumeric()){var min=$("#"+this.domId("filterby_"+f.getId()+"_min")).val().trim();var max=$("#"+this.domId("filterby_"+f.getId()+"_max")).val().trim();attrs["filter_"+f.getId()+"_min"]=min;attrs["filter_"+f.getId()+"_max"]=max;}else{var widget=$("#"+this.domId("filterby_"+f.getId()));if(!widget.val||widget.val()==null)continue;var value=widget.val();if(!value)continue;if(Array.isArray(value)){var tmp="";value.map(v=>{if(tmp!="")tmp+=", ";tmp+=v;});value=tmp;}
value=value.trim();if(value==FILTER_ALL){var regexp=new RegExp("\\${filter_"+f.getId()+"[^}]*\\}",'g');replace(regexp,"");}else{var regexp=new RegExp("\\${filter_"+f.getId()+" +prefix='([^']*)' +suffix='([^']*)' *\\}",'g');replace(regexp,"$1"+value+"$2");var regexp=new RegExp("\\${filter_"+f.getId()+" +prefix='([^']*)' *\\}",'g');replace(regexp,"$1"+value);var regexp=new RegExp("\\${filter_"+f.getId()+" +suffix='([^']*)' *\\}",'g');replace(regexp,value+"$1");var regexp=new RegExp("\\${filter_"+f.getId()+" *\\}",'g');replace(regexp,value);}}}}
let th=Utils.tokenizeMacros(headerTemplate);let tf=Utils.tokenizeMacros(footerTemplate);headerTemplate=th.apply(attrs);footerTemplate=tf.apply(attrs);if(selected.length>0){contents+=headerTemplate;}
if(template!=""){let groupByField=this.getFieldById(null,this.getProperty("groupByField"));let groupDelimiter=this.getProperty("groupDelimiter"," ");let groupTemplate=this.getProperty("groupTemplate","<b>${group}</b><ul>${contents}</ul>");let groupList=[];let groups={};var props=this.getTemplateProps(fields);var max=parseFloat(this.getProperty("maxNumber",-1));var cols=parseFloat(this.getProperty("templateColumns",-1));var colTag;if(cols>0){colTag="col-md-"+Math.round(12/cols);contents+='<div class="row-tight row">';}
var colCnt=0;var style=this.getProperty("templateStyle","");let handleSelectOnClick=this.getPropertyHandleSelectOnClick(true);for(var rowIdx=0;rowIdx<selected.length;rowIdx++){if(max!=-1&&rowIdx>=max)break;if(cols>0){if(colCnt>=cols){colCnt=0;contents+='</div>\n';contents+='<div class="row-tight row">\n';}
contents+='<div  class="'+colTag+'">\n';colCnt++;}
var record=selected[rowIdx];var color=null;if(colorBy.index>=0){var value=record.getData()[colorBy.index];color=colorBy.getColor(value,record);}
let s=template.trim();let row=this.getDataValues(record);if(s.startsWith("${default")){s=this.getRecordHtml(record,fields,s);}else{s=this.applyRecordTemplate(record,row,fields,s,props);}
let macros=Utils.tokenizeMacros(s);let rowAttrs={};rowAttrs["selectCount"]=selected.length;rowAttrs["totalCount"]=records.length;rowAttrs[RECORD_INDEX]=rowIdx+1;let dataFilters=this.getDataFilters();this.filters.forEach(f=>{if(!f.isEnabled()||!f.getField)return;rowAttrs["filter."+f.getField().getId()]=f.getFieldValues();});var recordStyle=style;if(color){if(this.getProperty("colorBackground",false)){recordStyle=HU.css("background",color)+recordStyle;}
rowAttrs["color"]=color;}
if(!handleSelectOnClick)
recordStyle+=HU.css("cursor","default");var tag=HU.openTag("div",[CLASS,"display-template-record",STYLE,recordStyle,ID,this.getId()+"-"+record.getId(),TITLE,"",RECORD_ID,record.getId(),RECORD_INDEX,rowIdx]);s=macros.apply(rowAttrs);if(s.startsWith("<td")){s=s.replace(/<td([^>]*)>/,"<td $1>"+tag);s=s.replace(/<\/td>$/,"</div></td>");}else if(s.startsWith("<tr")){s=s.replace(/<td([^>]*)>/g,"<td $1>"+tag);s=s.replace(/<\/td>/g,"</div></td>");}else{s=tag+s+HU.close(DIV);}
if(toggleTemplate){let t=this.applyRecordTemplate(record,row,fields,toggleTemplate,props);s=HU.toggleBlock(t,s,false);}
if(groupByField){let groupValue=groupByField.getValue(record);if(groupValue.getTime)groupValue=this.formatDate(groupValue);if(!groups[groupValue]){groupList.push(groupValue);groups[groupValue]="";}else{groups[groupValue]+=groupDelimiter;}
groups[groupValue]+=s;}else{contents+=s;}
if(cols>0){contents+=HU.close(DIV);}}
if(groupByField){if(this.getPropertySortGroups(false))
groupList=groupList.sort();groupList.forEach(group=>{contents+=groupTemplate.replace("${group}",group).replace("${contents}",groups[group]);});}
if(cols>0){contents+=HU.close(DIV);}}
if(selected.length>0)
contents+=footerTemplate;this.setContents(contents,true);this.addFieldClickHandler(null,null,false);var recordElements=this.find(".display-template-record");this.makeTooltips(recordElements,selected);this.makePopups(recordElements,selected);let _this=this;if(this.getPropertyHandleSelectOnClick(true)){this.find(".display-template-record").click(function(){var record=selected[$(this).attr(RECORD_INDEX)];_this.handleEventRecordHighlight(this,{record:record,highlight:true,immediate:true,skipScroll:true});_this.propagateEventRecordSelection({highlight:true,record:record});});}
if(this.getPropertyHighlightOnScroll(false)){let items=this.find(".display-template-record");this.getContents().css('overflow-y','scroll');this.getContents().scroll(()=>{let topElement=null;items.each(function(){let pos=$(this).position();if(pos.top<0){topElement=$(this);}});if(topElement){var record=selected[topElement.attr(RECORD_INDEX)];if(record&&this.currentTopRecord&&record!=this.currentTopRecord){this.propagateEventRecordSelection({highlight:true,record:record});}
this.currentTopRecord=record;}});}},highlightCount:0,handleEventRecordSelection:function(source,args){this.selectedRecords=args.records;this.selectedRecord=args.record;if(this.getProperty("onlyShowSelected")){this.updateUI();}else{args.highlight=true;this.handleEventRecordHighlight(source,args);}},handleEventRecordHighlight:function(source,args){if(this.getPropertySelectHighlight()){this.selectedRecord=args.record;this.callUpdateUI();return}
this.currentTopRecord=null;let myCount=++this.highlightCount;var id="#"+this.getId()+"-"+args.record.getId();if(this.highlightedElement){this.unhighlightElement(this.highlightedElement);this.highlightedElement=null;}
if(args.highlight){if(args.immediate){this.highlightElement(args);}else{setTimeout(()=>{if(myCount==this.highlightCount){this.highlightElement(args);}},500);}}else{var id="#"+this.getId()+"-"+args.record.getId();var element=$(id);this.unhighlightElement(element);}},unhighlightElement:function(element){this.currentTopRecord=null;element.removeClass("display-template-record-highlight");var css=this.getProperty("highlightOffCss","").split(";");if(css.length>0){css.map(tok=>{var c=tok.split(":");var a=c[0];var v=c.length>1?c[1]:null;if(!v||v==""){v=element.attr("prev-"+a);}
if(v){element.css(a,v);}});}},highlightElement:function(args){var id="#"+this.getId()+"-"+args.record.getId();var element=$(id);this.highlightedElement=element;element.addClass("display-template-record-highlight");var css=this.getProperty("highlightOnCss","").split(";");if(css.length>0){css.map(tok=>{var c=tok.split(":");var a=c[0];var v=c.length>1?c[1]:null;if(!v||v==""){v=element.attr("prev-"+a);}
if(v){var oldV=element.css(a);if(oldV){element.attr("prev-"+a,oldV);}
element.css(a,v);}});}
try{if(!args.skipScroll){var eo=element.offset();if(eo==null)return;var container=this.getContents();if(this.getProperty("orientation","vertical")=="vertical"){var c=container.offset().top;var s=container.scrollTop();container.scrollTop(eo.top-c+s)}else{var c=container.offset().left;var s=container.scrollLeft();container.scrollLeft(eo.left-c+s)}}}catch(err){console.log("Error:"+err);}}})}
function RamaddaTopfieldsDisplay(displayManager,id,properties){const ID_SLIDE="slide";const SUPER=new RamaddaFieldsDisplay(displayManager,id,DISPLAY_TOPFIELDS,properties);let myProps=[{label:'Top Fields'},{p:'fieldCount',tt:''},{p:'labelField',tt:''},{p:'dateFormat',ex:'yyyy'},{p:'labelField'},{p:'scaleFont',ex:'false'}]
defineDisplay(addRamaddaDisplay(this),SUPER,myProps,{needsData:function(){return true;},updateUI:function(){var pointData=this.getData();if(pointData==null)return;let records=this.filterData();if(!records)return;var fields=this.getData().getNonGeoFields();var labelField=this.getFieldById(fields,this.getProperty("labelField"));if(labelField==null){labelField=this.getFieldById(fields,TITLE);}
if(labelField==null){labelField=this.getFieldById(fields,"name");}
var fieldsToUse=this.getFieldsByIds(fields,this.getPropertyFields());if(fieldsToUse.length==0)fieldsToUse=fields;var html="";var fieldCount=+this.getProperty("fieldCount",10);var dataList=[];var min=Number.MAX_VALUE;var max=Number.MIN_VALUE;var dateFormat=this.getProperty("dateFormat");for(var i=0;i<records.length;i++){var record=records[i];var tuple=record.getData();var data=[];for(var j=0;j<fieldsToUse.length;j++){var field=fieldsToUse[j];if(!field.isNumeric())continue;var value=tuple[field.getIndex()];if(!isNaN(value)){min=Math.min(min,value);max=Math.max(max,value);}
data.push({value:value,field:field});}
data.sort((a,b)=>{return b.value-a.value;});var header=labelField?tuple[labelField.getIndex()]:" Record:"+(i+1);if((labelField&&labelField.isFieldDate())||(typeof header=="date")){header=Utils.formatDateWithFormat(header,dateFormat);}
dataList.push({data:data,record:record,header:header});}
var scaleFont=this.getProperty("scaleFont",true);for(var i=0;i<dataList.length;i++){var data=dataList[i].data;var record=dataList[i].record;var header=dataList[i].header;var tuple=record.getData();var div="";var contents="";for(var j=0;j<data.length&&j<fieldCount;j++){var value=data[j].value;var percent=max==min?1:(value-min)/(max-min);var fontSize=6+Math.round(percent*24)+"pt";if(!scaleFont)fontSize="100%";var field=data[j].field;contents+=HU.div(["field-id",field.getId(),"data-value",field.getLabel(),TITLE,"Value: "+value,CLASS,"display-topfields-row",STYLE,"font-size:"+fontSize+";"],field.getLabel());}
div+=HU.div([CLASS,"display-topfields-header",RECORD_INDEX,i],header);