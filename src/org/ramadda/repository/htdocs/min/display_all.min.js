var build_date="RAMADDA build date: Sat Dec 11 05:41:18 MST 2021";function AreaWidget(t){const e="mapcontains",i="north",a="south",s="east",l="west",r="mapsettings",o="showmap",n="mappopupwrapper",h="mappopup",d="mapclear",p="mapsetlocation";$.extend(this,{areaContains:"true"==HU.getUrlArgument("map_contains"),display:t,initHtml:function(){this.display.jq(r).click((()=>{this.showSettings()})),this.display.jq(o).click((()=>{this.showMap()}));this.map=new RepositoryMap(this.display.domId(h),{}),this.map.setSelection(this.display.getId(),!0,1)},showSettings:function(){let t=this,i="";i+=HU.div([CLASS,"ramadda-clickable",TITLE,"Use my location",ID,this.display.domId(p)],HU.getIconImage("fas fa-compass")+SPACE+"Use my location"),i+=HU.div([CLASS,"ramadda-clickable",TITLE,"Clear form",ID,this.display.domId(d)],HU.getIconImage("fas fa-eraser")+SPACE+"Clear form"),i+=HU.div([TITLE,"Search mode: checked - contains, unchecked - overlaps"],HtmlUtils.checkbox("",[ID,this.display.getDomId(e)],this.areaContains)+HU.tag("label",[CLASS,"ramadda-clickable","for",this.display.getDomId(e)],SPACE+"Contains")),i=HU.div([STYLE,"margin:5px;"],i),this.settingsDialog=HU.makeDialog({content:i,anchor:this.display.jq(r),draggable:!1,header:!0}),this.display.jq(e).change((function(e){t.areaContains=$(this).is(":checked")})),this.display.jq(p).click((()=>{this.settingsDialog.remove(),this.useMyLocation()})),this.display.jq(d).click((()=>{this.settingsDialog.remove(),this.areaClear()}))},getHtml:function(){let t=HU.getUrlArgument("map_bounds"),e="",d="",p="",g="";t&&([e,d,p,g]=t.split(","));this.display.getGet();let c=HU.div([TITLE,"Settings",CLASS,"ramadda-clickable",ID,this.display.domId(r)],HU.getIconImage("fas fa-cog")),u=HU.div([CLASS,"ramadda-clickable",ID,this.display.domId(o),TITLE,"Show map selector"],HtmlUtils.getIconImage("fas fa-globe")),y=(t,e,i,a)=>HtmlUtils.input(t,a,["placeholder",e,ATTR_CLASS,"input display-area-input","size","5",ATTR_ID,this.display.getDomId(t),ATTR_TITLE,i]),m=HtmlUtils.openTag(TAG_TABLE,[ATTR_CLASS,"display-area"]);return m+=HtmlUtils.tr([],HtmlUtils.td(["align","center"],HtmlUtils.leftCenterRight("",y(i," N","North",e),u,"20%","60%","20%"))),m+=HtmlUtils.tr([],HtmlUtils.td([],y(l," W","West",d)+y(s," E","East",g))),m+=HtmlUtils.tr([],HtmlUtils.td(["align","center"],HtmlUtils.leftCenterRight("",y(a," S","South",p),c,"20%","60%","20%"))),m+=HtmlUtils.closeTag(TAG_TABLE),m+=HU.div([ID,this.display.domId(n),STYLE,HU.css("display","none")],SPACE+"Shift-drag: select region. Cmd-drag: move region"+HU.div([ID,this.display.domId(h),STYLE,HU.css("width","400px","height","300px")])),m},showMap:function(){let t=this.display.jq(o);this.dialog=HU.makeDialog({contentId:this.display.domId(n),anchor:t,draggable:!0,header:!0}),this.map.selectionPopupInit(),this.map.getMap().updateSize()},areaClear:function(){$("#"+this.display.getDomId(i)).val(""),$("#"+this.display.getDomId(l)).val(""),$("#"+this.display.getDomId(a)).val(""),$("#"+this.display.getDomId(s)).val(""),this.display.areaClear()},useMyLocation:function(){if(navigator.geolocation){let t=this;navigator.geolocation.getCurrentPosition((function(e){t.setUseMyLocation(e)}))}},setUseMyLocation:function(t){let e=t.coords.latitude,r=t.coords.longitude,o=5;this.display.myLocationOffset&&(o=parseFloat(this.display.myLocationOffset)),$("#"+this.display.getDomId(i)).val(e+o),$("#"+this.display.getDomId(l)).val(r-o),$("#"+this.display.getDomId(a)).val(e-o),$("#"+this.display.getDomId(s)).val(r+o),this.display.submitSearchForm&&this.display.submitSearchForm()},areaLinkClick:function(){this.linkArea=!this.linkArea;let t=root+(this.linkArea?"/icons/link.png":"/icons/link_break.png");if($("#"+this.display.getDomId("arealink")).attr("src",t),this.linkArea&&this.lastBounds){let t=this.lastBounds;$("#"+this.display.getDomId(i)).val(MapUtils.formatLocationValue(t.top)),$("#"+this.display.getDomId(l)).val(MapUtils.formatLocationValue(t.left)),$("#"+this.display.getDomId(a)).val(MapUtils.formatLocationValue(t.bottom)),$("#"+this.display.getDomId(s)).val(MapUtils.formatLocationValue(t.right))}},linkArea:!1,lastBounds:null,handleEventMapBoundsChanged:function(t,e){bounds=e.bounds,this.lastBounds=bounds,(e.force||this.linkArea)&&($("#"+this.display.getDomId(i)).val(MapUtils.formatLocationValue(bounds.top)),$("#"+this.display.getDomId(l)).val(MapUtils.formatLocationValue(bounds.left)),$("#"+this.display.getDomId(a)).val(MapUtils.formatLocationValue(bounds.bottom)),$("#"+this.display.getDomId(s)).val(MapUtils.formatLocationValue(bounds.right)))},setSearchSettings:function(t){let e=this.display.getFieldValue(this.display.getDomId(i),null),r=this.display.getFieldValue(this.display.getDomId(l),null),o=this.display.getFieldValue(this.display.getDomId(a),null),n=this.display.getFieldValue(this.display.getDomId(s),null);t.setAreaContains(this.areaContains),HU.addToDocumentUrl("map_contains",this.areaContains),t.setBounds(e,r,o,n),HU.addToDocumentUrl("map_bounds",[e||"",r||"",o||"",n||""].join(","))}})}function DateRangeWidget(t,e){const i="date_start",a="date_end";let s,l;this.what=e||"date","createdate"==e?(s="Create start",l="Create end"):(s="Start date",l="End date"),this.baseId=this.what,RamaddaUtil.inherit(this,{display:t,initHtml:function(){$("#"+this.baseId+i).datepicker({dateFormat:"yy-mm-dd"}),$("#"+this.baseId+a).datepicker({dateFormat:"yy-mm-dd"})},setSearchSettings:function(t){let e=$("#"+this.baseId+i).val(),s=$("#"+this.baseId+a).val();HU.addToDocumentUrl(this.baseId+i,Utils.stringDefined(e)?e:null),HU.addToDocumentUrl(this.baseId+a,Utils.stringDefined(s)?s:null),"createdate"==this.what?t.setCreateDateRange(e,s):t.setDateRange(e,s)},getHtml:function(){let t=HU.getUrlArgument(this.baseId+i),e=HU.getUrlArgument(this.baseId+a);return HtmlUtils.input(this.baseId+i,t||"",[CLASS,"display-date-input","placeholder"," "+s,TITLE,s,ATTR_ID,this.baseId+i])+" - "+HtmlUtils.input(this.baseId+a,e||"",[CLASS,"display-date-input","placeholder"," "+l,TITLE,l,ATTR_ID,this.baseId+a])}})}function DisplayAnimation(t,e,i){i=i||{},$.extend({},i);const a="animrun",s="animnext",l="animprev",r="animbegin",o="animend",n="slider",h="ticks",d="tooltip",p="showall",g="window",c="step",u="settings",y="faster",m="slower",f="reset",D="animationlabel",I="frame",T="sliding";$.extend(this,{display:t,enabled:e,targetDiv:i.targetDiv,baseDomId:i.baseDomId,labelSize:t.getProperty("animationLabelSize","12pt"),labelStyle:t.getProperty("animationLabelStyle",""),running:!1,inAnimation:!1,begin:null,end:null,dateMin:null,dateMax:null,dateRange:0,dateFormat:t.getProperty("animationDateFormat",t.getProperty("dateFormat","yyyymmdd")),mode:t.getProperty("animationMode","cumulative"),startAtBeginning:t.getProperty("animationStartAtBeginning",!0),startAtEnd:t.getProperty("animationStartAtEnd",!1),speed:parseInt(t.getProperty("animationSpeed",500)),dwell:parseInt(t.getProperty("animationDwell",1e3)),getEnabled:function(){return this.enabled},toggleAnimation:function(){this.running=!this.running,this.btnRun&&this.btnRun.html(HtmlUtils.getIconImage(this.running?"fa-stop":"fa-play")),this.running&&this.startAnimation()},getDomId:function(t){return this.domId(t)},domId:function(t){return this.display.getDomId(t+(this.baseDomId?this.baseDomId:""))},jq:function(t){return this.display.jq(t+(this.baseDomId?this.baseDomId:""))},init:function(t,e,i){let a=!1;let s=this;if(this.records=i,this.dateMin=t,this.dateMax=e,this.begin=this.dateMin,this.end=this.dateMax,!this.dateMin)return;this.dates=[];let l={};i.every((t=>(l[t.getDate()]||(l[t.getDate()]=!0,this.dates.push(t.getDate())),!0))),this.dates.sort((function(t,e){return t.getTime()-e.getTime()})),this.dateRange=this.dateMax.getTime()-this.dateMin.getTime(),this.steps=parseFloat(this.display.getProperty("animationSteps",60)),this.setWindow(),this.frameIndex=0,this.display.getProperty("animationStartShowAll",!1)||this.resetRange();let r=this.mode!=I?[this.begin.getTime(),this.end.getTime()]:[this.begin.getTime()],o={mouseleave:function(t){s.tooltip&&s.tooltip.hide()},mousemove:function(t){if(s.tooltip&&t.offsetX>=0){let e=s.tooltip.parent().width(),i=s.tooltip.parent().offset().left,a=(t.pageX-i)/e,l=new Date(s.dateMin.getTime()+a*s.dateRange);l=s.formatAnimationDate(l,s.tooltipDateFormat),s.makeSlider||(l+="<br>+/-:zoom"),s.tooltip.html(l),s.tooltip.show(),s.tooltip.position({of:t.target,my:"left top",at:"left+"+t.offsetX+" bottom",collision:"fit fit"})}}};if(this.makeSlider){this.jq(n).slider({range:s.mode!=I,min:s.dateMin.getTime(),max:s.dateMax.getTime(),values:r,slide:function(t,e){s.stopAnimation(),s.setSliderValues(e.values),s.updateLabels()},stop:function(t,e){s.stopAnimation(),s.setSliderValues(e.values),s.dateRangeChanged(!0)}});this.jq(n).on(o)}else this.jq(h).on(o);this.updateTicks(),this.updateLabels()},resetRange:function(){this.startAtEnd?(this.begin=this.dateMax,this.end=this.dateMax,this.mode==I&&(this.frameIndex=this.dates.length-1)):this.startAtBeginning&&(this.begin=this.dateMin,this.end=new Date(this.begin.getTime()+this.window)),this.mode==I&&(this.end=this.begin)},setWindow:function(){let t=this.display.getProperty("animationWindow"),e=this.display.getProperty("animationStep",t);t?this.window=this.getMillis(t):this.steps>0&&(this.window=this.dateRange/this.steps),this.step=e?this.getMillis(e):this.window},timeMap:{century:31536e8,centuries:31536e8,decade:31536e7,halfdecade:15768e7,year:31536e6,years:31536e6,month:26784e5,months:26784e5,week:6048e5,weeks:6048e5,day:864e5,days:864e5,hour:36e5,hours:36e5,minute:6e4,minutes:6e4,second:1e3,seconds:1e3},getMillis:function(t){let e=1,i="day",a=(t=(""+t).trim()).match("^([0-9]+)(.*)");a?(e=+a[1],i=a[2].trim()):(a=t.match("(^[0-9]+)$"),a?(i="minute",e=+a[1]):i=t);let s=1;return i=i.toLowerCase().trim(),this.timeMap[i]?s=this.timeMap[i]:(i.endsWith("s")&&(i=i.substring(0,i.length-1)),this.timeMap[i]?s=this.timeMap[i]:console.log("Unknown unit:"+i)),e*s},getIndex:function(){return this.frameIndex},getBeginTime:function(){return this.begin},handleEventAnimationChanged(t){this.begin=t.begin,this.end=t.end,this.stopAnimation(),this.applyAnimation()},setSliderValues:function(t){if(this.mode!=I)this.begin=new Date(t[0]),this.end=new Date(t[1]);else{let e=new Date(t[0]),i=this.dates[0],a=0;this.dates.forEach(((t,s)=>{Math.abs(t.getTime()-e.getTime())<Math.abs(i.getTime()-e.getTime())&&(i=t,a=s)})),this.begin=this.end=i,this.frameIndex=a}},handleEventRecordHighlight:function(t,e){let i=$("#"+this.display.getId()+"-"+e.record.getId());this.ticks&&this.ticks.removeClass("display-animation-tick-highlight"),e.highlight?i.addClass("display-animation-tick-highlight"):i.removeClass("display-animation-tick-highlight")},makeControls:function(){this.tickHeight=this.display.getProperty("animationHeight","15px"),this.makeSlider=this.display.getProperty("animationMakeSlider",!0);let e="",i=this.display.getProperty("animationShowButtons",!0),b=t.getProperty("animationShowSlider",!0),S=t.getProperty("animationShowLabel",!0);if(i){let i=t.getProperty("animationWidgetShort",!1);e+=HtmlUtils.span([ID,this.getDomId(u),TITLE,"Settings"],HtmlUtils.getIconImage("fas fa-cog")),i||(e+=HtmlUtils.span([ID,this.getDomId(r),TITLE,"Go to beginning"],HtmlUtils.getIconImage("fa-fast-backward"))),e+=HtmlUtils.span([ID,this.getDomId(l),TITLE,"Previous"],HtmlUtils.getIconImage("fa-step-backward")),i||(e+=HtmlUtils.span([ID,this.getDomId(a),TITLE,"Run/Stop"],HtmlUtils.getIconImage("fa-play"))),e+=HtmlUtils.span([ID,this.getDomId(s),TITLE,"Next"],HtmlUtils.getIconImage("fa-step-forward")),i||(e+=HtmlUtils.span([ID,this.getDomId(o),TITLE,"Go to end"],HtmlUtils.getIconImage("fa-fast-forward")))}if(S&&(e+=i?HtmlUtils.span([ID,this.getDomId(D),CLASS,"display-animation-label",STYLE,this.labelStyle+HU.css("font-size",this.labelSize)]):HtmlUtils.div([ID,this.getDomId(D),CLASS,"display-animation-label",STYLE,this.labelStyle+HU.css("text-align","center","font-size",this.labelSize)])),e=HtmlUtils.div([CLASS,"display-animation-buttons"],e),b){let i=HU.css("height",this.tickHeight)+t.getProperty("animationSliderStyle",""),a=HU.div([ID,this.getDomId(d),CLASS,"display-animation-tooltip"],""),s=HU.css("height",this.tickHeight);this.makeSlider||(s+=HU.css("background","efefef","border","1px solid #aaa")),this.makeSlider||(i+=HU.css("cursor","move")),e+=HtmlUtils.div([CLASS,"display-animation-slider",STYLE,i,ID,this.getDomId(n)],a+HtmlUtils.div([STYLE,s,CLASS,"display-animation-ticks","tabindex","0",ID,this.getDomId(h)]))}if(this.html=HtmlUtils.div([STYLE,this.display.getProperty("animationStyle")],e),this.display.getProperty("animationShow",!0)&&(this.targetDiv?this.targetDiv.append(this.html):this.jq(ID_TOP_LEFT).append(this.html)),!this.makeSlider){let t=this;this.jq(h).mouseenter((function(t){$(this).focus()})),this.lastKeyTime=0;let e=this.jq(h);e.mousedown((function(e){t.mouseIsDown=!0;let i=$(this).parent().offset();t.mouseX=e.pageX-i.left})),e.mousemove((function(e){if(!t.mouseIsDown)return;var i=$(this).parent().offset(),a=e.pageX-i.left;let s=t.dateMax.getTime()-t.dateMin.getTime(),l=$(this).width(),r=t.mouseX-a;i=$(this).parent().offset();if(t.mouseX=e.pageX-i.left,0==r)return;let o=s*r/l;t.originaDateMin||(t.originaDateMin=t.dateMin,t.originaDateMax=t.dateMax),t.dateMin=new Date(t.dateMin.getTime()+o),t.dateMax=new Date(t.dateMax.getTime()+o);new Date;t.updateTicks();new Date;t.updateLabels()})),e.mouseup((function(e){t.mouseIsDown=!1})),e.keypress((function(e){let i=new Date;i.getTime(),t.lastKeyTime;t.lastKeyTime=i.getTime(),43==e.which?t.zoom(!0):45==e.which?t.zoom(!1):61==e.which&&t.zoomReset()})),this.jq(h).bind("xwheel",(function(e){if($(this).focus(),e.originalEvent.deltaY<0){let e=t.dateMax.getTime()-t.dateMin.getTime(),i=e-.9*e;t.dateMin=new Date(t.dateMin.getTime()+i),t.dateMax=new Date(t.dateMax.getTime()-i),t.updateTicks(),t.updateLabels()}else e.originalEvent.deltaY;e.stopPropagation(),e.stopImmediatePropagation(),e.preventDefault()}))}this.display.getProperty("animationTooltipShow",!1)&&(this.tooltip=this.jq(d),this.tooltipDateFormat=this.display.getProperty("animationTooltipDateFormat"));let v=this;this.jq(u).button().click((function(){let t=v.display.getProperty("animationWindow"),e=v.display.getProperty("animationStep",t),i="ramadda-hoverable ramadda-clickable",a=HU.div([ID,v.domId(y),TITLE,"Faster",CLASS,i],"Faster")+HU.div([ID,v.domId(m),TITLE,"Slower",CLASS,i],"Slower")+HU.div([ID,v.domId(f),TITLE,"Reset",CLASS,i],"Reset")+HU.div([ID,v.domId(p),TITLE,"Show all",CLASS,i],"Show all");t&&(a+=HU.div([TITLE,"Window, e.g., 1 week, 2 months, 3 days, 2 weeks, etc"],"Window:<br>"+SPACE2+HU.input("",t,[ID,v.domId(g),"size","10"])),a+=HU.div([TITLE,"Step, e.g., 1 week, 2 months, 3 days, 2 weeks, etc"],"Step:<br>"+SPACE2+HU.input("",e,[ID,v.domId(c),"size","10"]))),a=HU.div([STYLE,HU.css("margin","4px")],a),v.dialog=HU.makeDialog({content:a,anchor:$(this),draggable:!1,header:!1});let s=t=>{Utils.isReturnKey(t)&&(v.dialog.hide(),v.display.setProperty("animationWindow",v.jq(g).val()),v.display.setProperty("animationStep",v.jq(c).val()),v.setWindow(),v.resetRange(),v.dateRangeChanged())};v.jq(g).keyup(s),v.jq(c).keyup(s),v.jq(y).click((()=>{v.dialog.hide(),v.speed=.75*v.speed})),v.jq(m).click((()=>{v.dialog.hide(),v.speed=1.5*v.speed})),v.jq(f).click((()=>{v.dialog.hide(),v.speed=parseInt(v.display.getProperty("animationSpeed",500)),v.resetRange(),v.inAnimation=!1,v.stopAnimation(),v.dateRangeChanged()})),v.jq(p).click((()=>{v.dialog.hide(),v.begin=v.dateMin,v.end=v.dateMax,v.inAnimation=!1,v.stopAnimation(),v.dateRangeChanged()}))})),this.btnRun=this.jq(a),this.btnPrev=this.jq(l),this.btnNext=this.jq(s),this.btnBegin=this.jq(r),this.btnEnd=this.jq(o),this.label=this.jq(D),this.btnRun.button().click((()=>{this.toggleAnimation()})),this.btnBegin.button().click((()=>{let t=this.getDiff(),e=this.fullRange();this.begin=this.dateMin,this.mode==T?this.end=new Date(this.begin.getTime()+(e?this.window:t)):this.mode==I?(this.frameIndex=0,this.begin=this.end=this.deltaFrame(0)):this.end=new Date(this.dateMin.getTime()+this.window),this.stopAnimation(),this.dateRangeChanged()})),this.btnEnd.button().click((()=>{let t=this.getDiff(),e=this.fullRange();this.end=this.dateMax,this.mode==T?this.begin=new Date(this.end.getTime()-(e?this.window:t)):this.mode==I?(this.frameIndex=this.dates.length+1,this.begin=this.end=this.deltaFrame(0)):this.end=this.dateMax,this.stopAnimation(),this.dateRangeChanged()})),this.btnPrev.button().click((()=>{this.stopAnimation(),this.doPrev()})),this.btnNext.button().click((()=>{this.stopAnimation(),this.doNext()}))},fullRange:function(){return this.atBegin()&&this.atEnd()},atEnd:function(){return this.end.getTime()>=this.dateMax.getTime()},atBegin:function(){return this.begin.getTime()<=this.dateMin.getTime()},getDiff:function(){return this.end.getTime()-this.begin.getTime()},doPrev:function(){let t=this.getDiff()||this.window;t=this.window||this.getDiff(),this.mode==T?(this.begin=new Date(this.begin.getTime()-t),this.begin.getTime()<this.dateMin.getTime()&&(this.begin=this.dateMin),this.end=new Date(this.begin.getTime()+t)):this.mode==I?this.begin=this.end=this.deltaFrame(-1):(this.end=new Date(this.end.getTime()-this.window),this.end.getTime()<=this.begin.getTime()&&(this.end=new Date(this.begin.getTime()+this.window))),this.dateRangeChanged()},doNext:function(){let t=this.atEnd();if(this.mode==T){let t=this.window||this.getDiff();this.begin=new Date(this.begin.getTime()+this.step),this.end=new Date(this.end.getTime()+this.step),this.atEnd()&&(this.end=this.dateMax,this.begin=new Date(this.end.getTime()-t),this.inAnimation=!1,this.stopAnimation())}else if(this.mode==I){if(this.begin=this.end=this.deltaFrame(1),this.running&&t){if(this.display.getProperty("animationLoop",!0))return void setTimeout((()=>{this.begin=this.end=this.dateMin,this.frameIndex=0,this.updateUI()}),this.dwell);this.stopAnimation()}}else this.end=new Date(this.end.getTime()+this.window),this.atEnd()&&(this.end=this.dateMax,this.inAnimation=!1,this.stopAnimation());this.dateRangeChanged()},deltaFrame:function(t){if(this.frameIndex+=t,this.dates)return this.frameIndex>=this.dates.length?this.frameIndex=this.dates.length-1:this.frameIndex<0&&(this.frameIndex=0),this.dates[this.frameIndex]},startAnimation:function(){if(this.dateMax){if(!this.inAnimation){if(this.inAnimation=!0,this.label.html(""),this.mode==I)return this.frameIndex=0,this.begin=this.end=this.deltaFrame(0),this.display.animationStart(),void this.doNext();this.fullRange()&&(this.end=new Date(this.begin.getTime()+this.window)),this.display.animationStart()}this.doNext()}},stopAnimation:function(){this.btnRun&&this.btnRun.html(HtmlUtils.getIconImage("fa-play")),this.running=!1},setDateRange:function(t,e){this.begin=t,this.end=e,this.stopAnimation(),this.updateUI()},dateRangeChanged:function(t){this.applyAnimation(t),this.display.getDisplayManager().notifyEvent(DisplayEvent.animationChanged,this.display,{begin:this.begin,end:this.end})},applyAnimation:function(t){this.display.animationApply(this),this.updateUI()},setRecordListHighlight:function(t){this.recordListHighlight=t,this.updateTicks()},zoomReset:function(){this.originaDateMin&&(this.dateMax=this.originaDateMax,this.dateMin=this.originaDateMin,this.updateTicks(),this.updateLabels())},zoom:function(t){let e=this.dateMax.getTime()-this.dateMin.getTime(),i=e-e*(t?.9:1.1);this.originaDateMin||(this.originaDateMin=this.dateMin,this.originaDateMax=this.dateMax),this.dateMin=new Date(this.dateMin.getTime()+i),this.dateMax=new Date(this.dateMax.getTime()-i),this.updateTicks(),this.updateLabels()},updateTicks:function(){let e=!1;if(this.tickCount=0,!this.records||!this.display.getProperty("animationShowTicks",!0))return;this.highlightRecords={},this.recordListHighlight&&this.recordListHighlight.forEach((t=>{this.highlightRecords[t.getId()]=!0}));let i=this.display.getProperty("animationTickStyle",""),a="",s=this.dateMin.getTime(),l=this.dateMax.getTime(),r={};new Date;for(let t=0;t<this.records.length;t++){let e=this.records[t],o=e.getDate().getTime();if(r[o])continue;if(r[o]=!0,o<s)continue;if(o>l)continue;this.tickCount++;let n=(o-s)/(l-s)*100,h=this.formatAnimationDate(e.getDate()),d="display-animation-tick";this.highlightRecords[e.getId()]&&(d+=" display-animation-tick-highlight-base "),a+=HtmlUtils.div([TITLE,"",ID,this.display.getId()+"-"+e.getId(),CLASS,d,STYLE,HU.css("height",this.tickHeight,"left",n+"%")+i,TITLE,h,RECORD_ID,e.getId()],"")}new Date;this.jq(h).html(a);new Date;let o=t.getProperty("animationHighlightRecord",!1),n=t.getProperty("animationSelectRecord",!0);this.ticks=this.jq(h).find(".display-animation-tick");let d=this;this.display.makeTooltips(this.ticks,this.records,((t,e)=>{if(d.display.animationLastRecordSelectTime){if((new Date).getTime()-d.display.animationLastRecordSelectTime.getTime()<1500)return!1}return e&&o&&(n&&d.display.propagateEventRecordSelection({select:!1,record:null}),this.display.handleEventRecordHighlight(this,{highlight:t,record:e,skipAnimation:!0})),!0}),null,o),n&&this.display.makeRecordSelect(this.ticks,this.display.makeIdToRecords(this.records),(t=>{d.display.animationLastRecordSelectTime=new Date}));new Date},updateUI:function(t){t||this.makeSlider&&(this.jq(n).slider("values",0,this.begin.getTime()),this.jq(n).slider("values",1,this.end.getTime())),this.updateLabels(),this.end.getTime()<=this.dateMax.getTime()?this.running&&setTimeout((()=>{this.running&&this.doNext()}),this.speed):(this.running=!1,this.inAnimation=!1,this.btnRun&&this.btnRun.html(HtmlUtils.getIconImage("fa-play")))},makeLabel:function(t){return HU.span([STYLE,HU.css("font-size",this.labelSize)+this.labelStyle],t)},updateLabels:function(){this.label&&(this.makeSlider?this.mode==I&&this.begin==this.end?this.label.html(this.makeLabel(this.formatAnimationDate(this.begin))):this.label.html(this.makeLabel(this.formatAnimationDate(this.begin)+" - "+this.formatAnimationDate(this.end))):this.label.html(HU.leftCenterRight(this.makeLabel(this.formatAnimationDate(this.dateMin)),this.makeLabel("# "+this.tickCount),this.makeLabel(this.formatAnimationDate(this.dateMax)))))},formatAnimationDate:function(t,e,i){let a=this.display.getProperty("timeZoneOffset"),s=this.display.getProperty("timeZone");a&&(i&&console.log("date before:"+t.toUTCString()),t=Utils.createDate(t,-a),i&&console.log("date after:"+t.toUTCString()));let l=Utils.formatDateWithFormat(t,e||this.dateFormat,!0);return s?l+" "+s:l}})}function ColorByInfo(t,e,i,a,s,l,r,o,n,h){this.properties=n||{},a||(a="colorBy"),r?Array.isArray(r)||(r=[r]):r=["colorBy",""],$.extend(this,{display:t,fieldProp:a,fieldValue:t.getProperty(a),propPrefix:r,colorHistory:{}});let d=this.getProperty(a||"colorBy",null);if(null==o&&(o=a.getId?a:t.getFieldById(null,d)),o&&(this.field=o,r=[o.getId()+".",""],d=o.getId(),this.propPrefix.unshift(o.getId()+".colorBy"),this.propPrefix.push("colorBy")),$.extend(this,{display:t,id:d,fields:e,field:o,colorThresholdField:t.getFieldById(null,t.getProperty("colorThresholdField")),aboveColor:t.getProperty("colorThresholdAbove","red"),belowColor:t.getProperty("colorThresholdBelow","blue"),nullColor:t.getProperty("nullColor"),excludeZero:this.getProperty(PROP_EXCLUDE_ZERO,!1),overrideRange:this.getProperty("overrideColorRange",!1),inverse:this.getProperty("Inverse",!1),origRange:null,origMinValue:0,origMaxValue:0,minValue:0,maxValue:0,toMinValue:0,toMaxValue:100,isString:!1,stringMap:null,colorByMap:{},colorByValues:[],colorByMinPerc:this.getProperty("MinPercentile",-1),colorByMaxPerc:this.getProperty("MaxPercentile",-1),colorByOffset:0,pctFields:null,compareFields:t.getFieldsByIds(null,this.getProperty("CompareFields",""))}),h&&h.colorOverflow,"year"==this.fieldValue){let t={};this.dates=[],i.forEach((e=>{let i=e.getDate().getUTCFullYear();t[i]||(t[i]=!0,this.dates.push(i))})),this.dates.sort(),this.setRange(this.dates[0],this.dates[this.dates.length-1])}if(this.convertAlpha=this.getProperty("convertColorAlpha",!1),this.convertAlpha){if(Utils.isDefined(this.getProperty("alphaSourceMin")))this.alphaSourceMin=+this.getProperty("alphaSourceMin",40),this.alphaSourceMax=+this.getProperty("alphaSourceMax",80);else{var p=0,g=0;i.forEach(((t,e)=>{var i=t.getData();if(this.compareFields.length>0)this.compareFields.map(((t,a)=>{var s=i[t.getIndex()];isNaN(s)||(p=0==e&&0==a?s:Math.min(p,s),g=0==e&&0==a?s:Math.max(g,s))}));else if(this.index=0){var a=i[this.index];if(isNaN(a))return;p=0==e?a:Math.min(p,a),g=0==e?a:Math.max(g,a)}})),this.alphaSourceMin=p,this.alphaSourceMax=g}this.alphaTargetMin=+this.getProperty("alphaTargetMin",0),this.alphaTargetMax=+this.getProperty("alphaTargetMax",1)}if(this.convertIntensity=this.getProperty("convertColorIntensity",!1),this.convertIntensity){if(Utils.isDefined(this.getProperty("intensitySourceMin")))this.intensitySourceMin=+this.getProperty("intensitySourceMin",80),this.intensitySourceMax=+this.getProperty("intensitySourceMax",40);else{p=0,g=0;i.forEach(((t,e)=>{var i=t.getData();if(this.compareFields.length>0)this.compareFields.map(((t,a)=>{var s=i[t.getIndex()];isNaN(s)||(p=0==e&&0==a?s:Math.min(p,s),g=0==e&&0==a?s:Math.max(g,s))}));else if(this.index=0){var a=i[this.index];if(isNaN(a))return;p=0==e?a:Math.min(p,a),g=0==e?a:Math.max(g,a)}})),this.intensitySourceMin=p,this.intensitySourceMax=g}this.intensityTargetMin=+this.getProperty("intensityTargetMin",1),this.intensityTargetMax=+this.getProperty("intensityTargetMax",0)}null!=this.display.percentFields&&(this.pctFields=this.display.percentFields.split(","));let c=l||this.display.getColorTable(!0,[d+".colorTable","colorTable"]);if(!c&&d){let t=this.display.getProperty(d+".colors");t&&(c=t.split(","))}if(!c){var u=this.getProperty(d+".colors");u&&(c=u.split(","))}if(c||(c=this.display.getColorTable(!0)),this.colors=c,this.hasField(),!this.colors&&this.display.colors&&this.display.colors.length>0&&(this.colors=source.colors,1==this.colors.length&&Utils.ColorTables[this.colors[0]]&&(this.colors=Utils.ColorTables[this.colors[0]].colors)),null==this.colors&&(this.colors=Utils.ColorTables.grayscale.colors),!this.field)for(var y=0;y<e.length;y++){var m=e[y];m.getId()!=this.id&&"#"+(y+1)!=this.id||(this.field=m)}this.field||("hour"==this.id?this.timeField="hour":"day"==this.id&&(this.timeField="day")),this.field&&this.field.isString()&&(this.isString=!0),this.index=null!=this.field?this.field.getIndex():-1,this.stringMap=this.display.getColorByMap(s);let f=[],D={};if(this.index>=0||this.timeField){let t=NaN,e=NaN;i.forEach(((i,a)=>{let s,l=i.getData();s=this.timeField?"hour"==this.timeField?i.getTime().getHours():i.getTime().getTime():l[this.index],this.isString?D[s]||(D[s]=!0,f.push(s)):this.excludeZero&&0===s||(t=Utils.min(t,s),e=Utils.max(e,s))})),this.minValue=t,this.maxValue=e,this.origRange=[t,e]}f.length>0&&(f.sort(((t,e)=>t.toString().localeCompare(e.toString()))),f.forEach((t=>{if(!Utils.isDefined(this.colorByMap[t])){let e,i=this.colorByValues.length;this.lastColorByMap&&this.lastColorByMap[t]?e=this.lastColorByMap[t]:(i>=this.colors.length&&(this.colorOverflow=!0,i%=this.colors.length),e=this.colors[i]),this.colorByValues.push({value:t,color:e}),this.colorByMap[t]=e,this.setRange(1,this.colorByValues.length,!0)}}))),this.display.showPercent&&this.setRange(0,100,!0);var I=this.getProperty("Steps");I&&(this.steps=I.split(",")),this.colorByLog=this.getProperty("Log",!1),this.colorByLog10=this.getProperty("Log10",!1),this.colorByLog2=this.getProperty("Log2",!1),this.colorByLog?this.colorByFunc=Math.log:this.colorByLog10?this.colorByFunc=Math.log10:this.colorByLog2&&(this.colorByFunc=Math.log2),this.setRange(this.getProperty("Min",this.minValue),this.getProperty("Max",this.maxValue),!0),this.range=this.maxValue-this.minValue,this.toMinValue=this.getProperty("ToMin",this.toMinValue),this.toMaxValue=this.getProperty("ToMax",this.toMaxValue),this.enabled=null!=this.timeField||this.getProperty("doColorBy",!0)&&this.index>=0,this.initDisplayCalled=!1}function drawSparkLine(t,e,i,a,s,l,r,o,n,h,d){h||(h={}),d||(d={top:0,right:0,bottom:0,left:0});const p=i-d.left-d.right,g=a-d.top-d.bottom,c=i/s.length,u=d3.scaleLinear().domain([0,s.length]).range([0,p]),y=d3.scaleLinear().domain([r,o]).range([g,0]);d3.scaleLinear().domain([r,o]).range([0,g]);let m=d3.select("body").append("div").attr(CLASS,"sparkline-tooltip").style("opacity",0);const f=d3.select(e).append("svg").attr("width",i).attr("height",a).append("g").attr("transform","translate("+d.left+","+d.top+")");d3.line().x(((t,e)=>u(e))).y((t=>y(t)));let D=h.lineColor||t.getProperty("sparklineLineColor","#000"),I=h.barColor||t.getProperty("sparklineBarColor","MediumSeaGreen"),T=h.circleColor||t.getProperty("sparklineCircleColor","#000"),b=h.circleRadius||t.getProperty("sparklineCircleRadius",1),S=h.lineWidth||t.getProperty("sparklineLineWidth",1),v=!0,x=(t,e,i)=>n?n.getColorFromRecord(l[e],i):i,U=h.showBars||t.getProperty("sparklineShowBars",!1);f.append("line").attr("x1",0).attr("y1",0).attr("x2",0).attr("y2",a).attr("stroke-width",1).attr("stroke","#ccc"),f.append("line").attr("x1",0).attr("y1",a).attr("x2",i).attr("y2",a).attr("stroke-width",1).attr("stroke","#ccc");let L=t=>isNaN(t)?0:t;if(U&&(v=!1,f.selectAll(".bar").data(s).enter().append("rect").attr("class","bar").attr("x",((t,e)=>L(u(e)))).attr("y",(t=>L(y(t)))).attr("width",c).attr("height",(t=>L(a-y(t)))).attr("fill",((t,e)=>x(0,e,I))).style("cursor","pointer")),(h.showLines||t.getProperty("sparklineShowLines",!0))&&f.selectAll("line").data(s).enter().append("line").attr("x1",((t,e)=>u(e))).attr("y1",((t,e)=>y(t))).attr("x2",((t,e)=>u(e+1))).attr("y2",((t,e)=>y(e<s.length-1?s[e+1]:s[e]))).attr("stroke-width",S).attr("stroke",((t,e)=>isNaN(t)?"rgba(0,0,0,0)":x(0,e,D))).style("cursor","pointer"),(h.showCircles||t.getProperty("sparklineShowCircles",!1))&&f.selectAll("circle").data(s).enter().append("circle").attr("r",((t,e)=>isNaN(t)?0:b)).attr("cx",((t,e)=>L(u(e)))).attr("cy",((t,e)=>L(y(t)))).attr("fill",((t,e)=>x(0,e,T))).style("cursor","pointer"),h.showEndpoints||t.getProperty("sparklineShowEndPoints",v)){let e=0;for(;isNaN(s[e])&&e<s.length;)e++;let i=s.length-1;for(;isNaN(s[i])&&i>=0;)i--;f.append("circle").attr("r",h.endPointRadius||t.getProperty("sparklineEndPointRadius",2)).attr("cx",u(e)).attr("cy",y(s[e])).attr("fill",h.endPoint1Color||t.getProperty("sparklineEndPoint1Color")||x(s[0],0,t.getProperty("sparklineEndPoint1Color","steelblue"))),f.append("circle").attr("r",h.endPointRadius||t.getProperty("sparklineEndPointRadius",2)).attr("cx",u(i)).attr("cy",y(s[i])).attr("fill",h.endPoint2Color||t.getProperty("sparklineEndPoint2Color")||x(s[s.length-1],s.length-1,t.getProperty("sparklineEndPoint2Color","tomato")))}let E=t,P=t.getProperty("sparklineDoTooltip",!0)||h.doTooltip;f.on("click",(function(){let t=d3.mouse(this);if(l){let e=l[Math.round(u.invert(t[0]))];e&&E.propagateEventRecordSelection({select:!0,record:e})}})),P&&f.on("mouseover",(function(){if(!l)return;let t=d3.mouse(this),i=l[Math.round(u.invert(t[0]))];if(!i)return;let a=E.getRecordHtml(i),s=$(e),r=s.offset().top+s.height(),o=s.offset().left;m.transition().duration(200).style("opacity",.9),m.html(a).style("left",o+"px").style("top",r+"px")})).on("mouseout",(function(t){m.transition().duration(500).style("opacity",0)}))}function drawDots(t,e,i,a,s,l,r,o,n){o=o||{};const h=i-(n=n||{top:0,right:0,bottom:0,left:0}).left-n.right,d=a-n.top-n.bottom,p=d3.scaleLinear().domain([l.minx,l.maxx]).range([0,h]),g=d3.scaleLinear().domain([l.miny,l.maxy]).range([d,0]);let c=d3.select("body").append("div").attr(CLASS,"sparkline-tooltip").style("opacity",0);const u=d3.select(e).append("svg").attr("width",i).attr("height",a).append("g");o.circleColor||t.getProperty("sparklineCircleColor","#000");let y=o.circleRadius||t.getProperty("sparklineCircleRadius",1);console.log(JSON.stringify(l));let m=t=>isNaN(t)?0:t,f={};u.selectAll("circle").data(s).enter().append("circle").attr("r",((t,e)=>y)).attr("cx",((t,e)=>m(p(t.x)))).attr("cy",((t,e)=>m(g(t.y)))).attr("fill",((t,e)=>"#000")).attr(RECORD_ID,((t,e)=>(f[t.record.getId()]=t.record,t.record.getId()))).style("cursor","pointer");let D=t,I=t.getProperty("sparklineDoTooltip",!0)||o.doTooltip;u.on("click",(function(){let t=d3.mouse(this);if(records){let e=records[Math.round(p.invert(t[0]))];e&&D.propagateEventRecordSelection({select:!0,record:e})}})),I&&u.on("mouseover",(function(){d3.select(this).attr("r",10).style("fill","red");let t=$(e);t.attr("r",20),console.log("mouse over:"+d3.select(this).attr(RECORD_ID))})).on("mouseout",(function(t){c.transition().duration(500).style("opacity",0)}))}function drawPieChart(t,e,i,a,s,l,r,o,n){n||(n={});let h=Utils.isDefined(n.margin)?n.margin:4,d=n.pieColors||Utils.ColorTables.cats.colors,p=Math.min(i,a)/2-h,g=d3.select(e).append("svg").attr("width",i).attr("height",a).append("g").attr("transform","translate("+i/2+","+a/2+")"),c={};s.forEach((t=>{c[t[0]]=t[1]}));let u=d3.scaleOrdinal().domain(c).range(d),y=d3.pie().value((function(t){return t.value}))(d3.entries(c));g.selectAll("whatever").data(y).enter().append("path").attr("d",d3.arc().innerRadius(0).outerRadius(p)).attr("fill",(function(t){return u(t.data.key)})).attr("stroke","black").style("stroke-width","1px").style("opacity",.7)}function SizeBy(t,e,i){this.display=t,e||(e=t.filterData());let a=this.display.getPointData().getRecordFields();$.extend(this,{id:this.display.getProperty(i||"sizeBy"),minValue:0,maxValue:0,field:null,index:-1,isString:!1,stringMap:{}});let s=this.display.getProperty("sizeByMap");if(s){let t=s.split(",");for(let e=0;e<t.length;e++){let i=t[e].split(":");i.length>1&&(this.stringMap[i[0]]=i[1])}}for(let t=0;t<a.length;t++){let e=a[t];e.getId()!=this.id&&"#"+(t+1)!=this.id||(this.field=e,e.isString()&&(this.isString=!0))}if(this.index=null!=this.field?this.field.getIndex():-1,!this.isString&&this.field){let t=this.display.getColumnValues(e,this.field);this.minValue=t.min,this.maxValue=t.max,Utils.isDefined(this.display.getProperty("sizeByMin"))&&(this.minValue=+this.display.getProperty("sizeByMin",0)),Utils.isDefined(this.display.getProperty("sizeByMax"))&&(this.maxValue=+this.display.getProperty("sizeByMax",0))}this.display.getProperty("sizeBySteps")&&(this.steps=[],this.display.getProperty("sizeBySteps").split(",").forEach((t=>{let[e,i]=t.split(":");this.steps.push({value:+e,size:+i})}))),this.radiusMin=parseFloat(this.display.getProperty("sizeByRadiusMin",-1)),this.radiusMax=parseFloat(this.display.getProperty("sizeByRadiusMax",-1)),this.offset=0,this.sizeByLog=this.display.getProperty("sizeByLog",!1),this.origMinValue=this.minValue,this.origMaxValue=this.maxValue,this.maxValue=Math.max(this.minValue,this.maxValue),this.sizeByLog&&(this.func=Math.log,this.minValue<1&&(this.offset=1-this.minValue),this.minValue=this.func(this.minValue+this.offset),this.maxValue=this.func(this.maxValue+this.offset))}function Annotations(t,e){this.display=t,e||(e=this.display.filterData());this.display.getPointData().getRecordFields();this.labelField=this.display.getFieldById(null,this.display.getProperty("annotationLabelField")),this.fields=this.display.getFieldsByIds(null,this.display.getProperty("annotationFields"));let i=this.display.getProperty("annotations");i&&(this.fields=[]),this.map={};let a=(t,e,i)=>{i.record=t,this.map[e]||(this.map[e]=[]),this.map[e].push(i),this.map[t.getId()]||(this.map[t.getId()]=[]),this.map[t.getId()].push(i)};if(i){this.annotations=[],this.legend="";let t=0,s=i.split(";");this.hasRange=!1;for(let e=0;e<s.length;e++){let i=s[e].split(",");if(i.length<2)continue;let a=i[0].trim(),l=i[1];""==l.trim()&&(t++,l=""+t);let r=i.length<2?"":i[2],o=i.length<3?null:i[3],n=!1,h={label:l,description:r,toString:function(){return this.label+" "+this.description}};if(this.annotations.push(h),a.match(/^[0-9]+$/))a=parseFloat(a);else{let t=null;a.indexOf(":")>=0&&(t=a.split(":")[1],a=a.split(":")[0]);a="today"==a?new Date:Utils.parseDate(a,!1),t?(this.hasRange=!0,t="today"==t?Utils.formatDateYYYYMMDD(new Date):Utils.parseDate(t,!1),r=r||this.display.formatDate(a)+"-"+this.display.formatDate(t),h.index2=t.getTime()):r=r||this.display.formatDate(a),n=!0}h.index=n?a.getTime():a;let d=r;null!=o&&(d=HU.href(o,d,["target","_annotation"])),this.legend+=HU.b(l)+":"+d+" "}for(let t=0;t<this.annotations.length;t++){let i=this.annotations[t],s=null,l=null,r=null;for(let t=0;t<e.length;t++){let o=e[t],n=o.record?o.record:o,h=this.display.getDataValues(e[t])[0];h.v&&(h=h.v),n&&(h=n.getTime());let d=Number.MAX_VALUE;i.index2?(d=h>=i.index&&h<=i.index2?0:Math.min(Math.abs(i.index-h),Math.abs(i.index2-h)),0==d&&a(n,t,i)):d=Math.abs(i.index-h),(null==s||d<r)&&(s=t,r=d,l=n)}null!=s&&a(l,s,i)}}}ColorByInfo.prototype={initDisplay:function(){this.filterHighlight=this.display.getFilterHighlight(),this.initDisplayCalled=!0},getProperty:function(t,e,i){if(this.properties[t])return this.properties[t];this.debug&&console.log("getProperty:"+t);for(let e=0;e<this.propPrefix.length;e++){this.display.debugGetProperty=i,this.debug&&console.log("\t"+this.propPrefix[e]+t);let a=this.display.getProperty(this.propPrefix[e]+t);if(this.display.debugGetProperty=!1,Utils.isDefined(a))return a}return e},isEnabled:function(){return this.enabled},displayColorTable:function(t,e,i){if(this.getProperty("showColorTable",!0)){if(this.compareFields.length>0){var a="";this.compareFields.map(((t,e)=>{a+=HtmlUtils.div([STYLE,HU.css("display","inline-block","width","15px","height","15px","background",this.colors[e])])+" "+t.getLabel()+" "})),this.display.jq(i||ID_COLORTABLE).html(HtmlUtils.div([STYLE,HU.css("text-align","center","margin-top","5px")],a))}if(e||!(this.index<0))if(this.stringMap){let e=[];for(var s in this.colorByValues=[],this.stringMap){let t=this.stringMap[s];this.colorByValues.push({value:s,color:t}),e.push(t)}this.display.displayColorTable(e,i||ID_COLORTABLE,this.origMinValue,this.origMaxValue,{field:this.field,colorByInfo:this,width:t,stringValues:this.colorByValues})}else{let e=this.colors;if(this.getProperty("clipColorTable",!0)&&this.colorByValues.length){var l=[];for(s=0;s<this.colorByValues.length&&s<e.length;s++)l.push(this.colors[s]);e=l}let a=this.colorByValues.map((t=>t));a.sort(((t,e)=>t.value.toString().localeCompare(e.value.toString()))),this.display.displayColorTable(e,i||ID_COLORTABLE,this.origMinValue,this.origMaxValue,{field:this.field,colorByInfo:this,width:t,stringValues:a})}}},resetRange:function(){this.origRange&&this.setRange(this.origRange[0],this.origRange[1])},setRange:function(t,e,i){!i&&this.overrideRange||(this.origMinValue=t,this.origMaxValue=e,this.colorByFunc&&(t<0?this.colorByOffset=-t:0==t&&(this.colorByOffset=1),t=this.colorByFunc(t+this.colorByOffset),e=this.colorByFunc(e+this.colorByOffset)),this.minValue=t,this.maxValue=e,this.range=e-t,this.origRange||(this.origRange=[t,e]))},getValuePercent:function(t){let e=(t-this.minValue)/this.range;return this.inverse&&(e=1-e),e},scaleToValue:function(t){let e=this.getValuePercent(t);return this.toMinValue+e*(this.toMaxValue-this.toMinValue)},getColorFromRecord:function(t,e,i){if(this.initDisplayCalled||this.initDisplay(),this.filterHighlight&&!t.isHighlight(this.display))return this.display.getProperty("unhighlightColor","#eee");if(this.colorThresholdField&&this.display.selectedRecord){let e=this.display.selectedRecord.getValue(this.colorThresholdField.getIndex());return t.getValue(this.colorThresholdField.getIndex())>e?this.aboveColor:this.belowColor}if(this.index>=0){let e=t.getData()[this.index];return this.getColor(e,t,i)}if(this.timeField){let e;return e="hour"==this.timeField?t.getTime().getHours():t.getTime().getTime(),this.getColor(e,t,i)}if("year"==this.fieldValue){let e=t.getDate().getUTCFullYear();return this.getColor(e,t)}return e},hasField:function(){return this.index>=0},getColor:function(t,e,i){let a=this.getColorInner(t,e);return null==a&&(a=this.nullColor),a},getColorInner:function(t,e){if(this.initDisplayCalled||this.initDisplay(),this.filterHighlight&&e&&!e.isHighlight(this.display))return this.display.getUnhighlightColor();let i=.5;if(this.showPercent){let a=0,s=e.getData();for(let t=0;t<s.length;t++){let e=this.fields[t].isNumeric()&&!this.fields[t].isFieldGeo();e&&null!=this.pctFields&&(e=this.pctFields.indexOf(this.fields[t].getId())>=0||this.pctFields.indexOf("#"+(t+1))>=0),e&&(a+=s[t])}0!=a&&(i=t/a*100,i=(i-this.minValue)/(this.maxValue-this.minValue))}else{let e=t;if(this.stringMap){let e=this.stringMap[t];return Utils.isDefined(e)?e:this.stringMap.default}if(this.isString&&(color=this.colorByMap[e],color))return color;e+=this.colorByOffset,this.colorByFunc&&e>0&&(e=this.colorByFunc(e)),i=this.range?(e-this.minValue)/this.range:.5}let a=0;if(this.steps)for(;a<this.steps.length&&!(t<=this.steps[a]);a++);else a=parseInt(i*this.colors.length);if(a>=this.colors.length?a=this.colors.length-1:a<0&&(a=0),this.stringMap){let e=this.stringMap[t];return Utils.isDefined(e)?e:this.stringMap.default}return this.colors[a]},convertColor:function(t,e){return t=this.convertColorIntensity(t,e),t=this.convertColorAlpha(t,e)},convertColorIntensity:function(t,e){if(!this.convertIntensity)return t;return percent=(e-this.intensitySourceMin)/(this.intensitySourceMax-this.intensitySourceMin),intensity=this.intensityTargetMin+percent*(this.intensityTargetMax-this.intensityTargetMin),Utils.pSBC(intensity,t)||t},convertColorAlpha:function(t,e){if(!this.convertAlpha)return t;return percent=(e-this.alphaSourceMin)/(this.alphaSourceMax-this.alphaSourceMin),alpha=this.alphaTargetMin+percent*(this.alphaTargetMax-this.alphaTargetMin),Utils.addAlphaToColor(t,alpha)||t}},SizeBy.prototype={getMaxSize:function(){return this.getSizeFromValue(this.origMaxValue)},getSize:function(t,e,i){if(this.index<=0)return e;let a=t[this.index];return this.getSizeFromValue(a,i,!1)},getSizeFromValue:function(t,e,i){if(this.steps){if(t<=this.steps[0].value)return this.steps[0].size;for(let e=1;e<this.steps.length;e++)if(t>this.steps[e-1].value&&t<=this.steps[e].value)return this.steps[e].size;return this.steps[this.steps.length-1].size}if(this.isString){let i;if(Utils.isDefined(this.stringMap[t])){i=parseInt(this.stringMap[t])}else if(Utils.isDefined(this.stringMap["*"])){i=parseInt(this.stringMap["*"])}return isNaN(i)&&(i=this.radiusMin),e&&e(NaN,i),i}{let a=this.maxValue-this.minValue,s=t+this.offset;this.func&&(s=this.func(s));let l,r=0==a?NaN:(s-this.minValue)/a;return l=this.radiusMax>=0&&this.radiusMin>=0?Math.round(this.radiusMin+r*(this.radiusMax-this.radiusMin)):6+parseInt(15*r),i&&console.log("min:"+this.minValue+" max:"+this.maxValue+" value:"+t+" percent:"+r+" v:"+s+" size:"+l),isNaN(l)&&(l=this.radiusMin),e&&e(r,l),l}},getLegend:function(t,e,i){let a="";if(this.index<0)return"";if(this.steps)this.steps.forEach((t=>{let s=2*t.size+"px",l=t.value;a+=HU.div([CLASS,"display-size-legend-item"],HU.center(HU.div([STYLE,HU.css("height",s,"width",s,"background-color",e||"#bbb","border-radius","50%")]))+l),i&&(a+="<br>")}));else for(let s=0;s<=t;s++){let l=this.origMinValue+s/t*(this.origMaxValue-this.origMinValue),r=this.getSizeFromValue(l,null,!1);if(isNaN(r)||0==r)continue;l=this.display.formatNumber(l);let o=2*r+"px";a+=HU.div([CLASS,"display-size-legend-item"],HU.center(HU.div([STYLE,HU.css("height",o,"width",o,"background-color",e||"#bbb","border-radius","50%")]))+l),i&&(a+="<br>")}return HU.div([CLASS,"display-size-legend"],a)}},Annotations.prototype={isEnabled:function(){return null!=this.annotations},getAnnotations:function(){return this.annotations},getAnnotationsFor:function(t){return this.map[t]},getAnnotationFromDate:function(t){let e=Number.MAX_VALUE,i=null,a=null,s=t.getTime();for(let t=0;t<this.annotations.length;t++){let l=this.annotations[t];if(l.index2){if(s>=l.index&&s<=l.index2)return l}else e=Math.abs(l.index-s),(null==i||e<a)&&(i=l,a=e)}return i},getLegend:function(){return this.legend},getShowLegend:function(){return this.display.getProperty("showAnnotationsLegend")},hasFields:function(){return this.fields&&this.fields.length>0},getFields:function(){return this.fields}};let Gfx={gridData:function(t,e,i,a){a||(a={}),(isNaN(a.cellSize)||null==a.cellSize)&&(a.cellSize=a.cellSizeX),(isNaN(a.cellSizeX)||null==a.cellSizeX)&&(a.cellSizeX=a.cellSize),(isNaN(a.cellSizeY)||null==a.cellSizeY)&&(a.cellSizeY=a.cellSizeX);let s={shape:"circle",color:"blue",w:800,h:400,scale:1,cellSize:2,cellSizeX:2,cellSizeY:2,operator:"average"};$.extend(s,a);let l=HtmlUtils.getUniqueId();s.scale=+s.scale;let r=s.scale;s.w*=s.scale,s.h*=s.scale,$(document.body).append('<canvas style="display:none;" id="'+l+'" width="'+s.w+'" height="'+s.h+'"></canvas>');let o=document.getElementById(l),n=o.getContext("2d"),h=a.bounds.east-a.bounds.west,d=a.bounds.north-a.bounds.south;n.font=s.cellFont||"8pt Arial;";let p=n.createLinearGradient(0,0,0,o.height);p.addColorStop(0,"white"),p.addColorStop(1,"red");let g,c=(t,e)=>Math.floor(s.w*(e-a.bounds.west)/h);if(s.display&&s.display.map){s.display.map.transformLLPoint(MapUtils.createLonLat(s.bounds.east,85)),s.display.map.transformLLPoint(MapUtils.createLonLat(s.bounds.east,-85));let t=s.display.map.transformLLPoint(MapUtils.createLonLat(s.bounds.east,s.bounds.north)),e=s.display.map.transformLLPoint(MapUtils.createLonLat(s.bounds.east,s.bounds.south));g=(i,a)=>{let l=s.display.map.transformLLPoint(MapUtils.createLonLat(a,i)),r=(t.lat-l.lat)/(t.lat-e.lat);return Math.floor(r*s.h)}}else g=(t,e)=>Math.floor(s.h*(a.bounds.north-t)/d);if(n.lineStyle="#000",s.doHeatmap){let l=Math.floor(s.w/s.cellSizeX),h=Math.floor(s.h/s.cellSizeY),d=[];i.forEach(((e,i)=>{let a=e.getLatitude(),r=e.getLongitude(),o=c(0,r),n=g(a,r);e[t+"_coordinates"]={x:o,y:n};let p=0;s.colorBy&&s.colorBy.index>=0&&(p=e.getValue(s.colorBy.index));let u=0;s.lengthBy&&s.lengthBy.index>=0&&(u=e.getValue(s.lengthBy.index)),o=Math.floor(o/s.cellSizeX),n=Math.floor(n/s.cellSizeY),o<0&&(o=0),n<0&&(n=0),o>=l&&(o=l-1),n>=h&&(n=h-1),d.push({x:o,y:n,colorValue:p,r:e})}));let p=Gfx.gridPoints(h,l,d,a);s.cellSizeX=+s.cellSizeX,s.cellSizeY=+s.cellSizeY,this.applyFilter(s,p);let u=this.getMinMaxGrid(p,(t=>t.v));s.colorBy&&(Utils.isDefined(s.display.getProperty("colorByMin"))||s.colorBy.setRange(u.min,u.max),s.colorBy.index=0);let y=s.display.getProperty("hmCountThreshold","count"==s.operator?1:0),m=new Glyph(s.display,r,e,i,{type:"rect",canvasWidth:o.width,canvasHeight:o.height,colorByInfo:s.colorBy,width:s.cellSizeX,height:s.cellSizeY,stroke:!1,pos:"c",dx:s.cellSizeX/2,dy:s.cellSizeY/2},"");s.shape="rect";for(let t=0;t<h;t++){let e=p[t];for(let i=0;i<l;i++){let a=e[i],l=a.v;if(isNaN(l))continue;let r=i*s.cellSizeX,h=t*s.cellSizeY;a.count>=y&&m.draw(s,o,n,r,h,{colorValue:a.v,col:i,row:t,cell:a,grid:p})}}}else{i.sort(((t,e)=>e.getLatitude()-t.getLatitude()));let a=[],l=1;for(;l<11;){let t=s.display.getProperty("glyph"+l++);t&&a.push(new Glyph(s.display,r,e,i,{canvasWidth:o.width,canvasHeight:o.height},t))}a.forEach((e=>{i.forEach(((i,a)=>{let l=i.getLatitude(),r=i.getLongitude(),h=c(0,r),d=g(l,r);i[t+"_coordinates"]={x:h,y:d};let p=s.colorBy?i.getData()[s.colorBy.index]:null,u=s.lengthBy?i.getData()[s.lengthBy.index]:null;e.draw(s,o,n,h,d,{colorValue:p,lengthValue:u,record:i},a<10)}))}))}let u=s.display.getProperty("colorTableAlpha",-1);if(u>0){let t=n.getImageData(0,0,s.w,s.h),e=t.data,i=e.length;for(let t=3;t<i;t+=4)e[t]&&(e[t]=255*u);t.data=e,n.putImageData(t,0,0)}let y=o.toDataURL("image/png");return o.parentNode.removeChild(o),y},gridPoints:function(t,e,i,a){let s=displayDebug.gridPoints,l=[];for(let i=0;i<t;i++){let t=[];l.push(t);for(let i=0;i<e;i++)t.push({v:NaN,count:0,total:0,min:NaN,max:NaN,t:""})}i.forEach(((t,e)=>{let i=l[t.y][t.x];i.min=0==i.count?t.colorValue:Math.min(i.min,t.colorValue),i.max=0==i.count?t.colorValue:Math.max(i.max,t.colorValue),i.count++,i.total+=t.colorValue}));let r=NaN,o=NaN,n=0,h=0;for(let i=0;i<t;i++)for(let t=0;t<e;t++){let e,s=l[i][t];0!=s.count&&(e="count"==a.operator?s.count:"min"==a.operator?s.min:"max"==a.operator?s.max:"total"==a.operator?s.total:s.total/s.count,s.v=e,isNaN(e)||(r=isNaN(r)?e:Math.min(r,e),o=isNaN(o)?e:Math.max(o,e)),n=Math.max(n,s.count),h=0==h?s.count:Math.min(h,s.count))}return s&&console.log("operator:"+a.operator+" values:"+r+" - "+o+" counts:"+h+" - "+n),l.minValue=r,l.maxValue=o,l.minCount=h,l.maxCount=n,l},getGridValue:function(t,e,i,a,s,l){return e>=0&&e<t.length&&i>=0&&i<t[e].length?isNaN(t[e][i])?0:(s[0]+=a,l[0]++,t[e][i]*a):0},applyKernel:function(t,e){let i=this.cloneGrid(t,null,0);for(let a=0;a<t.length;a++){let s=i[a];for(let i=0;i<s.length;i++){isNaN(s[i])&&(s[i]=0);let l=[0],r=[0],o=0;e.every((e=>(o+=this.getGridValue(t,a+e[0],i+e[1],e[2],l,r),!0))),r[0]>0?s[i]=o/l[0]:s[i]=NaN}}return i},blurGrid:function(t,e){let i={average5:[[0,1,0],[1,1,1],[0,1,0]],average9:[[1,1,1],[1,1,1],[1,1,1]],average25:[[1,1,1,1,1],[1,1,1,1,1],[1,1,1,1,1],[1,1,1,1,1],[1,1,1,1,1]],average49:[[1,1,1,1,1,1,1],[1,1,1,1,1,1,1],[1,1,1,1,1,1,1],[1,1,1,1,1,1,1],[1,1,1,1,1,1,1],[1,1,1,1,1,1,1],[1,1,1,1,1,1,1]],gauss9:[[.077847,.123317,.077847],[.123317,.195346,.123317],[.077847,.123317,.077847]],gauss25:[[.003765,.015019,.023792,.015019,.003765],[.015019,.059912,.094907,.059912,.015019],[.023792,.094907,.150342,.094907,.023792],[.015019,.059912,.094907,.059912,.015019],[.003765,.015019,.023792,.015019,.003765]],gauss49:[[67e-8,2292e-8,19117e-8,38771e-8,19117e-8,2292e-8,67e-8],[2292e-8,78633e-8,.00655965,.01330373,.00655965,78633e-8,2292e-8],[19117e-8,.00655965,.05472157,.11098164,.05472157,.00655965,19117e-8],[38771e-8,.01330373,.11098164,.22508352,.11098164,.01330373,38771e-8],[19117e-8,.00655965,.05472157,.11098164,.05472157,.00655965,19117e-8],[2292e-8,78633e-8,.00655965,.01330373,.00655965,78633e-8,2292e-8],[67e-8,2292e-8,19117e-8,38771e-8,19117e-8,2292e-8,67e-8]]},a=i[t];return a||(t.startsWith("average")?a=i.average5:t.startsWith("gauss")&&(a=i.gauss9)),a?this.applyKernel(e,this.makeKernel(a)):e},makeKernel:function(t){let e=[],i=(t.length-1)/2;for(let a=0;a<t.length;a++){let s=t[a],l=a-i;for(let r=0;r<s.length;r++){let s=r-i;e.push([l,s,t[a][r]])}}return e},printGrid:function(t){console.log("grid:");for(let e=0;e<t.length;e++){let i=t[e],a="";for(let t=0;t<i.length;t++)Utils.isDefined(i[t].v)?a+=i[t].v+",":a+=i[t]+",";console.log(a)}},applyFilter(t,e){if(!t.filter||""==t.filter||"none"==t.filter)return;let i=this.cloneGrid(e,(t=>t.v)),a=t.display.getProperty("hmFilterPasses",1);for(let e=0;e<a;e++)i=this.blurGrid(t.filter,i);let s=t.display.getProperty("hmFilterThreshold",-999);for(let t=0;t<e.length;t++){let a=e[t];for(let e=0;e<a.length;e++){let l=a[e],r=i[t][e];-999!=s&&r<s&&(r=l.v),l.v=r}}},getMinMaxGrid:function(t,e){let i=NaN,a=NaN;for(let s=0;s<t.length;s++){let l=t[s];for(let t=0;t<l.length;t++){let r=l[t];e&&(r=e(r,s,t)),isNaN(r)||(i=isNaN(i)?r:Math.min(i,r),a=isNaN(a)?r:Math.max(a,r))}}return{min:i,max:a}},cloneGrid:function(t,e,i){let a=[],s=Utils.isDefined(i);for(let l=0;l<t.length;l++){let r=t[l],o=[];a.push(o);for(let t=0;t<r.length;t++){let a=r[t];e&&(a=e(a,l,t)),s?o.push(i):o.push(a)}}return a},convertGeoToPixel:function(t,e,i,a,s){let l=i.west,r=i.east-l,o=i.south*Math.PI/180,n=a/r*(e-l);t=t*Math.PI/180;let h=a/r*360/(2*Math.PI),d=h/2*Math.log((1+Math.sin(o))/(1-Math.sin(o)));return[n,s-(h/2*Math.log((1+Math.sin(t))/(1-Math.sin(t)))-d)]}};function Glyph(t,e,i,a,s,l){if(s=s||{},$.extend(this,{display:t,type:"label",dx:0,dy:0,label:"",baseHeight:0,baseWidth:0,width:8,fill:!0,stroke:!0,toString:function(){return this.type}}),$.extend(this,s),l.split(",").forEach((t=>{let e=t.split(":"),i=e[0],a="";for(let t=1;t<e.length;t++)t>1&&(a+=":"),a+=e[t];a=a.replace(/_nl_/g,"\n").replace(/_colon_/g,":").replace(/_comma_/g,","),"true"==a?a=!0:"false"==a&&(a=!1),this[i]=a})),this.labelBy&&(this.labelField=t.getFieldById(i,this.labelBy),this.labelField||console.log("Could not find label field: "+this.labelBy)),"image"==this.type&&(this.imageField=t.getFieldById(i,this.imageField),this.myImage=new Image),this.scale=e,null==this.height&&("3dbar"==this.type?this.height=20:this.height=8),null==this.pos&&("3dbar"==this.type?this.color="blue":"rect"==this.type?this.pos="c":this.pos="nw"),this.width=+this.width,this.height=+this.height,"canvasWidth"==this.dx?this.dx=this.canvasWidth:"-canvasWidth"==this.dx?this.dx=-this.canvasWidth:"canvasWidth2"==this.dx?this.dx=this.canvasWidth/2:"-canvasWidth2"==this.dx?this.dx=-this.canvasWidth/2:"width"==this.dx?this.dx=this.width:"-width"==this.dx?this.dx=-this.width:"width2"==this.dx?this.dx=this.width/2:"-width2"==this.dx&&(this.dx=-this.width/2),"canvasHeight"==this.dy?this.dy=this.canvasHeight:"-canvasHeight"==this.dy?this.dy=-this.canvasHeight:"canvasHeight2"==this.dy?this.dy=this.canvasHeight/2:"-canvasHeight2"==this.dy?this.dy=-this.canvasHeight/2:"height"==this.dy?this.dy=this.height:"-height"==this.dy?this.dy=-this.height:"height2"==this.dy?this.dy=this.height/2:"-height2"==this.dy&&(this.dy=-this.height/2),this.baseWidth=+this.baseWidth,this.width=+this.width*e,this.height=+this.height*e,this.dx=+this.dx*e,this.dy=+this.dy*e,this.sizeBy)if(this.sizeByField=t.getFieldById(i,this.sizeBy),this.sizeByField){let e={Min:this.sizeByMin,Max:this.sizeByMax};this.sizeByInfo=new ColorByInfo(t,i,a,this.sizeBy,this.sizeBy,null,this.sizeBy,this.sizeByField,e)}else console.log("Could not find sizeBy field:"+this.sizeBy);if(!this.colorByInfo&&this.colorBy){this.colorByField=t.getFieldById(i,this.colorBy);let e=this.colorTable?t.getColorTableInner(!0,this.colorTable):null;if(this.colorByField){let s={Min:this.colorByMin,Max:this.colorByMax};this.colorByInfo=new ColorByInfo(t,i,a,this.colorBy,this.colorBy+".colorByMap",e,this.colorBy,this.colorByField,s)}else console.log("Could not find colorBy field:"+this.colorBy)}}Glyph.prototype={draw:function(t,e,i,a,s,l,r){let o=null;if(this.colorByInfo)if(this.colorByField){let t=l.record.getValue(this.colorByField.getIndex());o=this.colorByInfo.getColor(t)}else l.colorValue&&(o=this.colorByInfo.getColor(l.colorValue));let n=1;if(this.sizeByInfo){let t=l.record.getValue(this.sizeByField.getIndex());n=this.sizeByInfo.getValuePercent(t)}if(l.alphaByCount&&l.cell&&l.grid&&l.grid.maxCount!=l.grid.minCount){let t=(l.cell.count-l.grid.minCount)/(l.grid.maxCount-l.grid.minCount);o=Utils.addAlphaToColor(c,t)}if(i.fillStyle=o||this.fillStyle||this.color||"blue",i.strokeStyle=this.strokeStyle||this.color||"#000",i.lineWidth=this.lineWidth||1,"label"==this.type||this.label){let t=this.labelField?l.record.getValue(this.labelField.getIndex()):this.label;if(null===t)return void console.log("No label value");"number"==typeof t&&(this.valueScale&&(t*=+this.valueScale),this.decimals&&(t=number_format(t,+this.decimals))),this.template&&(t=this.template.replace("${value}",t)),i.font=this.font||"12pt arial",i.fillStyle=i.strokeStyle=o||this.color||"#000";let e=String(t);l.record&&l.record.fields.forEach((t=>{e=e.replace("${"+t.getId()+"}",l.record.getValue(t.getIndex()))})),e=e.split("\n");let r=0,n=3,h=0;e.forEach(((t,e)=>{let a=i.measureText(t);e>0&&(r+=n),h=Math.max(h,a.width),r+=a.actualBoundingBoxAscent+a.actualBoundingBoxDescent}));let d=Utils.translatePoint(a,s,h,r,this.pos,{dx:this.dx,dy:this.dy});e.forEach((t=>{let e=i.measureText(t);i.fillText(t,d.x,d.y),d.y+=e.actualBoundingBoxAscent+e.actualBoundingBoxDescent+n}))}else if("circle"==this.type){i.beginPath();let t=this.width*n+this.baseWidth,e=Utils.translatePoint(a,s,t,t,this.pos,{dx:this.dx,dy:this.dy}),l=e.x+t/2,r=e.y+t/2;i.arc(l,r,t/2,0,2*Math.PI),this.fill&&i.fill(),this.stroke&&i.stroke()}else if("rect"==this.type){let t=Utils.translatePoint(a,s,this.width,this.height,this.pos,{dx:this.dx,dy:this.dy});this.fill&&i.fillRect(t.x,t.y,this.width,this.height),this.stroke&&i.strokeRect(t.x,t.y,this.width,this.height)}else if("image"==this.type){if(this.imageField){let t=l.record.getValue(this.imageField.getIndex()),e=Utils.translatePoint(a,s,this.width,this.height,this.pos,{dx:this.dx,dy:this.dy}),r=new Image;r.src=t,setTimeout((()=>{i.drawImage(r,e.x,e.y,40,40)}),1e3)}}else if("gauge"==this.type){let t=Utils.translatePoint(a,s,this.width,this.height,this.pos,{dx:this.dx,dy:this.dy});i.fillStyle=this.fillColor||"#F7F7F7",i.beginPath();let e=t.x+this.width/2,l=t.y+this.height;i.arc(e,l,this.width/2,1*Math.PI,0),i.fill(),i.strokeStyle="#000",i.stroke(),i.beginPath(),i.beginPath();this.width;let r=180*n,o=e-.4*this.width,h=l,d=Utils.rotate(e,l,o,h,r);if(i.strokeStyle=this.color||"#000",i.lineWidth=this.lineWidth||2,i.moveTo(e,l),i.lineTo(d.x,d.y),i.stroke(),i.lineWidth=1,this.showLabel=!0,this.showLabel&&this.sizeByInfo){i.fillStyle="#000";let t=String(this.sizeByInfo.minValue);i.font=this.font||"9pt arial";let a=i.measureText(t);i.fillText(t,e-this.width/2-a.width-2,l),i.fillText(this.sizeByInfo.maxValue,e+this.width/2+2,l)}}else if("3dbar"==this.type){let t=Utils.translatePoint(a,s,this.width,this.height,this.pos,{dx:this.dx,dy:this.dy}),l=n*this.height+parseFloat(this.baseHeight);i.fillStyle=o||this.color,i.strokeStyle=this.strokeStyle||"#000",this.draw3DRect(e,i,t.x,e.height-t.y-this.height,+this.width,l,+this.width)}else if("axis"==this.type){let t=Utils.translatePoint(a,s,this.width,this.height,this.pos,{dx:this.dx,dy:this.dy});this.height,parseFloat(this.baseHeight);i.strokeStyle=this.strokeStyle||"#000",i.beginPath(),i.moveTo(t.x,t.y),i.lineTo(t.x,t.y+this.height),i.lineTo(t.x+this.width,t.y+this.height),i.stroke()}else if("vector"==this.type){if(!this.sizeByInfo)return void console.log("make Vector: no sizeByInfo");i.strokeStyle=o||this.color;let e=l.record.getValue(this.sizeByField.getIndex());n=this.sizeByInfo.getValuePercent(e);let r=t.cellSizeH;t.lengthBy&&t.lengthBy.index>=0&&(r=t.lengthBy.scaleToValue(e));let h=a+r,d=s,p=t.display.getProperty("arrowLength",-1);if(t.colorBy&&t.colorBy.index>=0){let i=180*t.colorBy.getValuePercent(e)+90;i*=Math.PI/360,h=r*Math.cos(i)-0*Math.sin(i),d=0*Math.cos(i)-r*Math.sin(i),h+=a,d+=s}p<=0&&(i.save(),i.fillStyle="#000",i.beginPath(),i.arc(a,s,1,0,2*Math.PI),i.fill(),i.restore()),i.beginPath(),i.moveTo(a,s),i.lineTo(h,d),i.lineWidth=t.display.getProperty("lineWidth",1),i.stroke(),p>0&&(i.beginPath(),this.drawArrow(i,a,s,h,d,p),i.stroke())}else if("tile"==this.type){let e=a+t.cellSizeX/2,r=s+t.cellSizeY/2;l.row%2==0&&(e+=t.cellSizeX/2,r-=t.cellSizeY/2);let o=t.cellSizeX/2,n=t.cellSizeY/2;i.beginPath();let h=Math.PI/2;i.moveTo(e+o*Math.cos(h),r+n*Math.sin(h));for(let t=0;t<7;t++)i.lineTo(e+o*Math.cos(h+2*t*Math.PI/6),r+n*Math.sin(h+2*t*Math.PI/6));i.strokeStyle="#000",i.stroke()}else console.log("Unknwon cell shape:"+this.type)},draw3DRect:function(t,e,i,a,s,l,r){let o=function(t,e,i){return function(){let a=Array.prototype.slice.call(arguments,0);t.beginPath();let s=a.pop();for(s&&t.moveTo(e.apply(void 0,s),i.apply(void 0,s));void 0!==(s=a.pop());)t.lineTo(e.apply(void 0,s),i.apply(void 0,s));t.closePath(),t.stroke(),t.fill()}}(e,(function(t,e,i){return t+i/2}),(function(t,e,i){return e+i/4}));e.save(),e.scale(1,-1),e.translate(0,-t.height),e.save(),e.translate(i,a);let n=e.fillStyle;e.fillStyle=Utils.pSBC(-.5,n),o([s,0,0],[s,0,r],[s,l,r],[s,l,0]),e.fillStyle=n,o([0,0,0],[0,l,0],[s,l,0],[s,0,0]),e.fillStyle=Utils.pSBC(.5,n),o([0,l,0],[0,l,r],[s,l,r],[s,l,0]),e.fillStyle=n,e.restore(),e.restore()},drawArrow:function(t,e,i,a,s,l){let r=a-e,o=s-i,n=Math.atan2(o,r);t.moveTo(e,i),t.lineTo(a,s),t.lineTo(a-l*Math.cos(n-Math.PI/6),s-l*Math.sin(n-Math.PI/6)),t.moveTo(a,s),t.lineTo(a-l*Math.cos(n+Math.PI/6),s-l*Math.sin(n+Math.PI/6))}};var xcnt=0;const displayDebug={getProperty:!1,notifyEvent:!1,handleEventPropertyChanged:!1,getSelectedFields:!1,filterData:!1,getStandardData:!1,makeDataTable:!1,checkSearchBar:!1,handleNoData:!1,pointDataLoaded:!1,displayMapUpdateUI:!1,displayMapCreateMap:!1,displayMapAddPoints:!1,loadPointJson:!1,groupBy:!1,gridPoints:!1,setEntry:!1},CATEGORY_CHARTS="Basic Charts",CATEGORY_TABLE="Tables",CATEGORY_MISC="Misc Charts",CATEGORY_MAPS="Maps",CATEGORY_IMAGES="Images",CATEGORY_RADIAL_ETC="Trees, etc",CATEGORY_TEXT="Text",CATEGORY_ENTRIES="Entries",CATEGORY_CONTROLS="Controls",DISPLAY_CATEGORIES=[CATEGORY_CHARTS,CATEGORY_TABLE,CATEGORY_MAPS,CATEGORY_IMAGES,CATEGORY_MISC,CATEGORY_TEXT,CATEGORY_RADIAL_ETC,CATEGORY_CONTROLS,CATEGORY_ENTRIES],ID_BOTTOM="bottom",ID_COLORTABLE="colortable",ID_LEGEND="legend",ID_FIELDS="fields",ID_HEADER="header",ID_HEADER1="header1",ID_HEADER2="header2",ID_HEADER2_PREFIX="header2prefix",ID_HEADER2_PREPREFIX="header2preprefix",ID_HEADER2_PREPREPREFIX="header2prepreprefix",ID_HEADER2_SUFFIX="header2suffix",ID_FILTERBAR="filterbar",ID_TAGBAR="tagbar",ID_TITLE=ATTR_TITLE,ID_TITLE_EDIT="title_edit",ID_LEFT="left",ID_RIGHT="right",ID_TITLE_FIELD="titlefield",ID_TOP="top",ID_TOP_RIGHT="topright",ID_TOP_LEFT="topleft",ID_DETAILS="details",ID_DETAILS_SNIPPET="snippet",ID_DISPLAY_CONTENTS="contents",ID_DISPLAY_TOP="top",ID_DISPLAY_BOTTOM="bottom",ID_GROUP_CONTENTS="group_contents",ID_DETAILS_MAIN="detailsmain",ID_GROUPBY_FIELDS="groupdbyfields",ID_TOOLBAR="toolbar",ID_TOOLBAR_INNER="toolbarinner",ID_LIST="list",ID_DISPLAY_MESSAGE="displaymessage",ID_DIALOG="dialog",ID_DIALOG_TABS="dialog_tabs",ID_FOOTER="footer",ID_FOOTER_LEFT="footer_left",ID_FOOTER_RIGHT="footer_right",ID_MENU_BUTTON="menu_button",ID_MENU_OUTER="menu_outer",ID_MENU_INNER="menu_inner",ID_DISPLAY_PROGRESS="display_progress",ID_REPOSITORY="repository",ID_REQUEST_PROPERTIES="request_properties",ID_PAGE_COUNT="pagecount",ID_PAGE_PREV="pageprev",ID_PAGE_NEXT="pagenext",ID_PAGE_LABEL="pagelabel",ID_PAGE_BUTTONS="pagebuttons",ID_FILTER_HIGHLIGHT="filterhighlight",ID_FILTER_DATE="filterdate",ID_FILTER_COUNT="filtercount",ID_ENTRIES_MENU="entries_menu",ID_ENTRIES_PREV="entries_prev",ID_ENTRIES_NEXT="entries_next",PROP_DISPLAY_FILTER="displayFilter",PROP_EXCLUDE_ZERO="excludeZero",PROP_EXCLUDE_NAN="excludeUndefined",PROP_DIVID="divid",PROP_FIELDS="fields",PROP_LAYOUT_HERE="layoutHere",PROP_HEIGHT="height",PROP_WIDTH="width",RECORD_INDEX="recordindex",RECORD_ID="recordid",TEXT_HIGHLIGHT_COLOR="yellow",HIGHLIGHT_COLOR="#436EEE",VALUE_NONE="--none--",DisplayEvent={};function displayDefineEvent(t,e){!1!==e&&(e=!0),DisplayEvent[t]={name:t,share:t+".share",accept:t+".accept",shareGroup:t+".shareGroup",acceptGroup:t+".acceptGroup",default:e,handler:"handleEvent"+t[0].toUpperCase()+t.substring(1),toString:function(){return this.name}}}displayDefineEvent("setEntry"),displayDefineEvent("recordSelection"),displayDefineEvent("recordList"),displayDefineEvent("recordHighlight"),displayDefineEvent("propertyChanged"),displayDefineEvent("pointDataLoaded"),displayDefineEvent("dataSelection"),displayDefineEvent("fieldsSelected"),displayDefineEvent("filterFieldsSelected"),displayDefineEvent("fieldsChanged"),displayDefineEvent("fieldValueSelected"),displayDefineEvent("entrySelection"),displayDefineEvent("entriesChanged"),displayDefineEvent("mapBoundsChanged",!1),displayDefineEvent("animationChanged"),displayDefineEvent("entryMouseOver"),displayDefineEvent("entryMouseOut"),displayDefineEvent("removeDisplay"),displayDefineEvent("filterChanged");let globalDisplayCount=0;function addGlobalDisplayProperty(t,e){null==window.globalDisplayProperties&&(window.globalDisplayProperties={}),"true"===e?e=!0:"false"===e&&(e=!1),window.globalDisplayProperties[t]=e}function addGlobalDisplayType(t,e){null==window.globalDisplayTypes&&(window.globalDisplayTypes=[],window.globalDisplayTypesMap={}),t.type&&(window.globalDisplayTypesMap[t.type]=t),e?window.globalDisplayTypes.unshift(t):window.globalDisplayTypes.push(t)}function makeDisplayTooltip(t,e,i){let a="";if(null!=t&&(a+=HU.b(t)),e){Array.isArray(e)||(e=[e]);let t=e.reduce(((t,e)=>(e.startsWith("/")||(e=ramaddaBaseUrl+"/help/display/"+e),t+"<td><img src="+e+" width=250px></td>")),"<table><tr valign=top>");t+="</tr></table>",""!=a&&(a+="<br>"),a+=t}return i&&(a+="<br>"+i),a=a.replace(/"/g,"&quot;"),a}function getGlobalDisplayProperty(t){return null==window.globalDisplayProperties?null:window.globalDisplayProperties[t]}function addRamaddaDisplay(t){return Utils.addDisplay(t),t.displayCount=globalDisplayCount++,t}async function ramaddaDisplaySetSelectedEntry(t,e){await getGlobalRamadda().getEntry(t,(t=>{(e=e||Utils.displaysList)&&e.forEach((e=>{e.setEntry&&e.setEntry(t)}))}))}function ramaddaDisplayCheckLayout(){Utils.displaysList.forEach((t=>{if(t.checkLayout){new Date;t.checkLayout();new Date}}))}function getRamaddaDisplay(t){let e=Utils.displaysMap[t];return e||(Utils.displaysList.forEach((t=>{t.getId&&(Utils.displaysMap[t.getId()]=t),t.displayId&&(Utils.displaysMap[t.displayId]=t)})),Utils.displaysMap[t])}function removeRamaddaDisplay(t){var e=getRamaddaDisplay(t);e&&(e.removeDisplay(),Utils.removeDisplay(e))}function displayGetFunctionValue(t){return t.getTime?t.getTime():isNaN(t)?"string"==typeof t?t:0:t}function ramaddaDisplayStepAnimation(){Utils.displaysList.forEach((t=>{t.getProperty&&t.getAnimation&&t.getProperty("doAnimation")&&t.getAnimation().doNext()}))}function displayDefineMembers(t,e,i){return RamaddaUtil.defineMembers(t,i),e&&t.defineProperties&&t.defineProperties(e),t}function defineDisplay(t,e,i,a){return RamaddaUtil.inherit(t,e),displayDefineMembers(t,i,a),a.ctor&&t.ctor(),t}function DisplayThing(t,e){for(var i in null==e&&(e={}),e)"string"==typeof e[i]&&("true"==e[i]?e[i]=!0:"false"==e[i]&&(e[i]=!1));for(var a in e){var l=a.split(".");if(l.length<=1)continue;let t={};var r=e[a];"true"==r?r=!0:"false"==r&&(r=!1);for(i=0;i<l.length;i++){var o=l[i];if(i==l.length-1){t[o]=r;break}var n=t[o];null==n?(t[o]={},t=t[o]):t=n}}this.ignoreGlobals=e.ignoreGlobals,this.displayId=null,displayDefineMembers(this,null,{objectId:t,properties:e,displayParent:null,getId:function(){return this.objectId},setId:function(t){this.objectId=t},removeDisplay:function(){this.dialogElement&&this.dialogElement.remove()},setEntry:function(t){},handleEntryMenu:async function(t){await getGlobalRamadda().getEntry(t,(t=>{this.setEntry(t)}))},getEntriesMenu:function(t){if(t&&t.entryCollection){let e=t.entryCollection.split(",");this.changeEntries=[];let i=[];e.forEach((t=>{var e=t.split(":");this.changeEntries.push(e[0]),i.push([e[0],e[1]])}));let a=this.getProperty("noun","Data"),s=HU.span([CLASS,"display-changeentries-button",TITLE,"Previous "+a,ID,this.getDomId(ID_ENTRIES_PREV),TITLE,"Previous"],HU.getIconImage("fa-chevron-left")),l=HU.span([CLASS,"display-changeentries-button",TITLE,"Next "+a,ID,this.getDomId(ID_ENTRIES_NEXT),TITLE,"Next"],HU.getIconImage("fa-chevron-right")),r=t.changeEntriesLabel||"Select "+a;return""!=r&&(r+="<br>"),HU.center(HU.div([CLASS,"display-filter"],r+s+" "+HU.select("",[ATTR_ID,this.getDomId(ID_ENTRIES_MENU)],i)+" "+l))}return""},initializeEntriesMenu:function(){this.jq(ID_ENTRIES_PREV).click((t=>{let e=this.jq(ID_ENTRIES_MENU)[0].selectedIndex;e<=0&&(e=this.changeEntries.length);let i=this.changeEntries[e-1];this.jq(ID_ENTRIES_MENU).val(i),this.handleEntryMenu(i)})),this.jq(ID_ENTRIES_NEXT).click((t=>{let e=this.jq(ID_ENTRIES_MENU)[0].selectedIndex;e>=this.changeEntries.length-1&&(e=0);let i=this.changeEntries[e+1];this.jq(ID_ENTRIES_MENU).val(i),this.handleEntryMenu(i)})),this.jq(ID_ENTRIES_MENU).change((t=>{let e=this.jq(ID_ENTRIES_MENU).val();this.handleEntryMenu(e)}))},popup:function(t,e,i,a){a=a||$("#"+e);var s=i||$("#"+t),l="left top",r="left bottom";a.show(),a.position({of:s,my:l,at:r,collision:"none none"}),a.position({of:s,my:l,at:r,collision:"none none"}),a.draggable(),a.show()},initDialog:function(){},showDialog:function(t,e,i){this.dialogElement||($(document.body).append(HU.div([ATTR_CLASS,"display-dialog",ID,this.getDomId(ID_DIALOG)])),this.dialogElement=this.jq(ID_DIALOG)),this.dialogElement.html(this.makeDialog(t)),this.popup(e||this.getDomId(ID_MENU_BUTTON),null,null,this.dialogElement),i?i():this.initDialog()},getShowMenu:function(){if(Utils.isDefined(this.showMenu))return this.showMenu;var t=!1;return null!=this.displayParent&&(t=this.displayParent.getProperty("showChildMenu",t)),this.getProperty(PROP_SHOW_MENU,t)},getShowTitle:function(){if(this.getProperty("showTitle"))return this.getProperty("showTitle");var t=!1;return null!=this.displayParent&&(t=this.displayParent.getProperty("showChildTitle",t)),this.getProperty("showTitle",t)},getTimeZone:function(){return this.getProperty("timeZone")},formatDate:function(t,e,i){if(!t||!t.getTime)return"";try{return this.formatDateInner(t,e,i)}catch(e){return console.log(e.stack),console.error('Error formatting date:"'+t+'" error:'+e),!t.getTime&&t.v&&(t=t.v),""+t}},dateFormat:null,formatDateInner:function(t,e,i){if(this.dateFormat||(this.dateFormat=this.getProperty("dateFormat",this.getProperty("dateFormat2"))),!this.dateFormat&&i)return String(t);if(!t.getTime&&t.v&&(t=t.v),t.getTime&&isNaN(t.getTime()))return"Invalid date";if(this.dateFormat){let e=Utils.formatDateWithFormat(t,this.dateFormat,!0);if(e)return String(e)}if(!t.toLocaleDateString)return String(t);var a;a=e&&!Utils.isDefined(e.suffix)?e.suffix:this.getProperty("dateSuffix");var s=this.getTimeZone();return!a&&s&&(a=s),Utils.formatDate(t,e?e.options:null,{timeZone:s,suffix:a})},getUniqueId:function(t){return HU.getUniqueId(t)},toString:function(){return"DisplayThing:"+this.getId()},domId:function(t){return this.getDomId(t)},getDomId:function(t){return this.getId()+"_"+t},gid:function(t){return this.getId()+"_"+t},find:function(t){return this.getContents().find(t)},getContents:function(){return this.jq(ID_DISPLAY_CONTENTS)},jq:function(t){return $("#"+this.getDomId(t))},selectboxit:function(t,e){let i={showEffect:"fadeIn",showEffectSpeed:400,hideEffect:"fadeOut",hideEffectSpeed:400};e&&$.extend(i,e),HtmlUtils.initSelect(t,i)},writeHtml:function(t,e){try{$("#"+this.getDomId(t)).html(e)}catch(i){console.log("writeHtml error:"+i),console.log("idSuffix:"+t),console.log("html:"+e)}},getTemplateProps:function(t){return{iconField:this.getFieldById(t,this.getProperty("iconField")),iconSize:parseFloat(this.getProperty("iconSize",16)),iconMap:this.getIconMap(),colorBy:this.getProperty("colorBy"),colorByMap:this.getColorByMap()}},macroHook:function(t,e){return null},applyRecordTemplate:function(t,e,i,a,l,r,o){i=this.getFields(i),l||(l=this.getTemplateProps(i)),r||(r=Utils.tokenizeMacros(a,{hook:(e,i)=>this.macroHook(t,e,i),dateFormat:this.getProperty("dateFormat")}));let n={};if(l.iconMap&&l.iconField){var h=e[l.iconField.getIndex()];(g=l.iconMap[h])&&(n[l.iconField.getId()+"_icon"]=HU.image(g,["width",l.iconSize]))}let d=(t,e)=>{let i=r.getAttributes(t.getId()+"_image"),a=[],s=i?i.width:null;return s?(a.push("width"),a.push(s)):this.getProperty("imageWidth")?(a.push("width"),a.push(this.getProperty("imageWidth"))):(a.push("width"),a.push("300")),a.push("style"),a.push("vertical-align:top"),HU.image(e,a)},p={};i.forEach((t=>p[t.getId()]=t)),r.tokens.forEach((a=>{if(a.attrs)if("default"==a.tag)n[a.tag]=this.getRecordHtml(t,i,"${default}");else if("list"==a.attrs.type&&a.attrs.fields){let t="<table class=display-table>";a.attrs.fields.split(",").forEach((i=>{let a=p[i],s=e[a.getIndex()];"image"==a.getType()?s=d(a,s):"url"==a.getType()&&""!=s&&(s=HU.href(s,s)),t+="<tr><td align=right><b>"+a.getLabel()+"</b>:</td><td>  "+s+"</td></tr>"})),t+="</table>",n[a.tag]=t}}));for(let t=0;t<i.length;t++){let a=i[t],h=e[a.getIndex()];if(o&&console.log("macro:"+t+" field:"+a.getId()+" type:"+a.getType()+" value:"+h),l.iconMap){var g=l.iconMap[a.getId()+"."+h];g&&(s=s.replace("${"+a.getId()+"_icon}",HU.image(g,["size",l.iconSize])))}if("image"==a.getType())if(h&&h.trim().length>1){let t=r.getAttributes(a.getId()+"_image"),e=[],i=t?t.width:null;i?(e.push("width"),e.push(i)):this.getProperty("imageWidth")?(e.push("width"),e.push(this.getProperty("imageWidth"))):(e.push("width"),e.push("100%")),e.push("style"),e.push("vertical-align:top");var c=HU.image(h,e);n[a.getId()+"_image"]=c,n[a.getId()+"_url"]=h}else n[a.getId()+"_url"]=ramaddaCdn+"/icons/blank.gif",n[a.getId()+"_image"]="";else if("movie"==a.getType()){if(h&&h.trim().length>0){let t=[];this.getProperty("movieWidth")&&(t.push("width"),t.push(this.getProperty("movieWidth")));let e=HU.movie(h,t);n[a.getId()+"_movie"]=e,n[a.getId()+"_url"]=h}}else{if("url"==a.getType()){if(h&&h.trim().length>1){let t=r.getAttributes(a.getId()+"_href"),e=t?t.label:null;n[a.getId()+"_href"]=HU.href(h,e||h),n[a.getId()]=h}else n[a.getId()+"_href"]="",n[a.getId()]="";continue}if(a.isDate){h&&(n[a.getId()]=h);continue}}var u;l.colorByMap&&(u=l.colorBy&&l.colorBy==a.getId()?l.colorByMap[h]:l.colorByMap[a.getId()+"."+h]),u&&(n[a.getId()+"_color"]=u),n[a.getId()]=h,a.isNumeric()&&(n[a.getId()+"_format"]=Utils.formatNumberComma(h))}this.addMacroAttributes(r,e,n);return n.recordIndex=t.rowIndex+1,r.apply(n,o,((t,e)=>{if("tags"==t.attrs.display){let i=t.tag,a=this.filterMap[i],s=Utils.getEnumColor(i),l="";return""==(e=String(e).trim())?"":(e.split(",").forEach((t=>{l+=HU.div(["metadata-type",i,"metadata-value",t,TITLE,t,STYLE,HU.css("background",s),CLASS,"display-search-tag"],t)})),a&&(l=a.getLabel()+": "+l+"<br>"),l)}return"Unknown tag handler:"+t.attrs.handle}))},addMacroAttributes:function(t,e,i){},getFields:function(t){if(!t){var e=this.pointData||this.getData();if(null==e)return null;t=e.getRecordFields()}return t},getFieldLabel:function(t){return this.getProperty(t.getId()+".label",t.getLabel())},getRecordUrlHtml:function(t,e,i){let a=i.getValue(e.getIndex()),s=t[e.getId()+".label"]||t["url.label"]||t.label||"Link";return HU.href(a,s,["target","_link"])},getSortedFields:function(t){if(!(t.filter((t=>null==t||null!=t.getGroup())).length>0))return t;let e=[],i={};for(let a=0;a<t.length;a++){let s=t[a];null!=s&&(group=s.getGroup(),null==group&&(group=group+"_"+a),i[group]||(i[group]=[],e.push(group)),i[group].push(s))}return t=[],e.forEach((e=>{t=Utils.mergeLists(t,i[e])})),t},getRecordHtml:function(t,e,i,a){if(!(e=this.getFields(e)))return"";let s=this.getFieldById(null,this.getProperty("urlField","url")),l=this.getFieldById(null,this.getProperty("linkField"))||s,r=this.getFieldById(null,this.getProperty("titleField")),o=this.getProperty("titleTemplate"),n=this.getFieldById(null,this.getProperty("descriptionField")),h=l?t.getValue(l.getIndex()):null,d=this.getProperty("showDate",!0),p=this.getProperty("showImage",!0),g=this.getProperty("showMovie",!0),c=!1,u=this.getProperty("showElevation",!1);if(Utils.isDefined(this.showGeo)&&(c=""+this.showGeo=="true"),""==i)return"";if(Utils.stringDefined(i)||(i=this.getProperty("recordTemplate")),Utils.stringDefined(i)&&!i.startsWith("${default")&&"${fields}"!=i)return this.applyRecordTemplate(t,this.getDataValues(t),e,i,null,null,a);if("${fields}"==i)e=this.getFieldsByIds(null,this.getProperty("tooltipFields",this.getPropertyFields()));else{let t=this.getProperty("tooltipFields");t&&(e=this.getFieldsByIds(null,t))}let y=this.getProperty("itemsPerColumn",50),m={};i&&(m=Utils.tokenizeMacros(i,{hook:(e,i)=>this.macroHook(t,e,i),dateFormat:this.getProperty("dateFormat")}).getAttributes("default")||{}),y=m.itemsPerColumn||y;let f="";if(r||o){let i="";o?o.startsWith("${default")||(i=this.getRecordHtml(t,e,o,a)):(i=t.getValue(r.getIndex()),i.getTime&&(i=this.formatDate(i)),i=HU.center(HU.h3(i))),h&&(i=HU.href(h,i,["target","_target"])),f+=i,h=null}if(n){let e=t.getValue(n.getIndex());f+=e}let D={};this.getProperty("tooltipNotFields","").split(",").forEach((t=>{D[t]=!0}));let I=[],T=!1,b=[];b=this.getProperty("labelColumnAttrs")?this.getProperty("labelColumnAttrs").split(","):["align","right"];let S=this.getProperty("labelWidth");e=this.getSortedFields(e);let v=null;for(let i=0;i<2;i++)for(let a=0;a<e.length;a++){let s=e[a];if(D[s.getId()])continue;if(m[s.getId()+".hide"])continue;if(s==r||s==n)continue;if(0==i&&!s.derived)continue;if(1==i&&s.derived)continue;if(!s.getForDisplay())continue;if(s.isRecordDate()){if(!d)continue;T=!0}if(!c&&s.isFieldGeo())continue;v!=s.getGroup()&&(v=s.getGroup(),Utils.isDefined(v)&&I.push(HU.tr([],HU.td(["colspan","2"],HU.div([CLASS,"ramadda-header-small"],v)))));let l=t.getValue(s.getIndex()),o=l,h=o;if("number"==typeof o&&(o=this.formatNumber(o,s.getId())),s.isFieldDate()&&(o=this.formatDate(o)),"image"==s.getType()&&""!=o){if(!p)continue;let t=[];this.getProperty("imageWidth")?(t.push("width"),t.push(this.getProperty("imageWidth"))):(t.push("width"),t.push("200")),t.push("align"),t.push("top"),o=HU.image(o,t)}if("movie"==s.getType()&&""!=o){if(!g)continue;var x=[];x.push("width"),x.push("200"),o=HU.movie(o,x)}"url"==s.getType()&&(o=this.getRecordUrlHtml(m,s,t));let u=s.getLabel();o+=s.getUnitSuffix();let y=u+"="+l;o.length>100&&(o=HU.div([STYLE,HU.css("max-height","100px","overflow-y","auto")],o));let f=this.formatRecordLabel(u)+":";S&&(f=HU.div([STYLE,HU.css("max-width",HU.getDimension(S),"overflow-x","auto")],f)),f=HU.div([TITLE,y],f);let U=HU.open(TR,["valign","top"]);U+=HU.td(b,HU.div([CLASS,"display-record-table-label"],f)),U+=HU.td(["field-id",s.getId(),"field-value",h,"align","left"],HU.div([STYLE,HU.css("margin-left","5px")],o)),U+=HU.close(TR),I.push(U)}if(!T&&d&&t.hasDate()){let e=HU.open(TR,["valign","top"]),i=this.formatRecordLabel("Date");e+=HU.td([],HU.b(i+":")),e+=HU.td(["align","left"],HU.div([STYLE,HU.css("margin-left","5px")],this.formatDate(t.getDate()))),e+=HU.close(TR),I.push(e)}u&&t.hasElevation()&&I.push(HU.tr([],HU.td([ALIGN,"right"],HU.b("Elevation:"))+HU.td([ALIGN,"left"],number_format(t.getElevation(),4,".",""))));f+="<table><tr valign=top>";let U=Utils.splitList(I,y),L=U.length>1?"margin-right:5px;":"";return U.forEach((t=>{f+="<td><div style='"+L+"'><table>"+Utils.join(t,"")+"</table></div></td>"})),f+="</tr><table>",this.getProperty("recordHtmlStyle")&&(f=HU.div([CLASS,"ramadda-shadow-box display-tooltip",STYLE,this.getProperty("recordHtmlStyle")],f)),f},formatRecordLabel:function(t){return t=(t=t.replace(/!!/g," -- ")).replace(/ /g,"&nbsp;")},getFormValue:function(t,e){var i=$("#"+this.getDomId(t)).val();return null!=i?(i.length>0&&this.setProperty(t,i),"none"==i&&this.setProperty(t,null),i):this.getProperty(t,e)},getName:function(){return this.getFormValue("name",this.getId())},getEventSource:function(){return this.getFormValue("eventSource","")},setDisplayParent:function(t){this.displayParent=t},getDisplayParent:function(){return null==this.displayParent&&(this.displayParent=this.getLayoutManager()),this.displayParent},removeProperty:function(t){this.properties[t]=null},setProperty:function(t,e){this.properties[t]=e,this.transientProperties[t]=e},getSelfProperty:function(t,e){return null!=this[t]?this[t]:this.getProperty(t,e)},initTooltip:function(){},formatNumber:function(t,e,i){if(!this.getProperty(e?[e+".doFormatNumber","doFormatNumber"]:"doFormatNumber",!0))return t;if(isNaN(t))return this.getProperty("nanValue","--");let a=this.formatNumberInner(t,e,i),s=this.getProperty(e?[e+".numberTemplate","numberTemplate"]:"numberTemplate");return s&&(a=s.replace("${number}",a)),a=String(a),a.endsWith(".")&&(a=a.substring(0,a.length-1)),a},formatNumberInner:function(t,e,i){t=+t;let a=this.getProperty(e?[e+".formatNumberScale","formatNumberScale"]:"formatNumberScale");Utils.isDefined(a)&&(t*=a);let s=this.getProperty(e?[e+".formatNumberDecimals","formatNumberDecimals"]:"formatNumberDecimals");if(Utils.isDefined(s))return number_format(t,s);if(this.getProperty(e?[e+".formatNumberComma","formatNumberComma"]:"formatNumberComma",!1)){return Utils.formatNumberComma(t)}return Utils.formatNumber(t,!1,i)},propertyDefined:function(t){return Utils.isDefined(this.getProperty(t))},setPropertyOn:function(t,e,i,a){var s=this.getProperty(e,a);Utils.isDefined(s)&&null!=s&&(t[i]=s)},getDisplayProp:function(t,e,i){if(Utils.isDefined(this[e]))return this[e];let a="map-"+e;return Utils.isDefined(t[a])?t[a]:t.getProperty?t.getProperty(e,i):null},getPropertyFromUrl:function(t,e){let i=HU.getUrlArgument("display"+this.displayCount+"."+t);return i||this.getProperty(t,e)},getPropertyFields:function(t){return this.getPropertyFromUrl(PROP_FIELDS,t)},transientProperties:{},getPropertyCounts:{},priorProps:{},getProperty:function(t,e,i,a){let s=!1;if(this.getPropertyCounts[t]||(this.getPropertyCounts[t]=0),void 0!==this.transientProperties[t]){return s&&console.log("getProperty:"+t+"  dflt:"+e+" transient:"+this.transientProperties[t]),this.transientProperties[t]}s|=this.debugGetProperty,this.getPropertyCount++,this.getPropertyCounts[t]++;let l=this.getPropertyInner(t,null,i,a);if(s&&console.log("getProperty:"+t+"  dflt:"+e+" got:"+l),null!=this.writePropertyDef&&(this.seenWriteProperty||(this.seenWriteProperty={}),!this.seenWriteProperty[t])){let i=t=>t?"'"+t+"'":"null";this.writePropertyDef+="{p:'"+t+"',d:"+i(e)+",wikiValue:"+i(l||e)+"},\n",this.seenWriteProperty[t]=!0}return Utils.isDefined(l)||(l=e),this.getPropertyCounts[t]>10&&(this.transientProperties[t]=Utils.isDefined(l)?l:null),l},getPropertyInner:function(t,e,i,a){let s=displayDebug.getProperty;s=this.debugGetProperty,Array.isArray(t)||(t=[t]);for(let i=0;i<t.length;i++){let a=t[i];if(s&&console.log("getProperty:"+a+" dflt:"+e),this.dynamicProperties&&Utils.isDefined(this.dynamicProperties[a]))return this.dynamicProperties[a];var l=this.properties[a];if(null!=l)return s&&console.log("\tgot property from this.properties:"+l),l}if(!a)for(let e=0;e<t.length;e++){let a=t[e];var r=null;if(null!=this.displayParent&&(r=this.displayParent.getPropertyInner("inherit."+a,i)),!r&&this.getDisplayManager&&(r=this.getDisplayManager().getPropertyInner("inherit."+a)),r)return s&&console.log("\tgetProperty-3"),r}if(!this.ignoreGlobals){if(!a){if(null!=this.displayParent)return s&&console.log("\tgetProperty calling parent"),this.displayParent.getPropertyInner(t,i);if(this.getDisplayManager)return s&&console.log("\tgetProperty-5"),this.getDisplayManager().getPropertyInner(t)}for(let e=0;e<t.length;e++){if(l=getGlobalDisplayProperty(t[e]),Utils.isDefined(l))return s&&console.log("\tgetProperty-6:"+l),l}}return s&&console.log("\tgetProperty-6 dflt:"+e),e}})}function RamaddaDisplay(t,e,i,s){const l=new DisplayThing(e,s);RamaddaUtil.inherit(this,l),window.globalDisplayTypesMap&&(this.typeDef=window.globalDisplayTypesMap[i]),this._wikiTags=[],this.defineProperties=function(t){let e=[];t.forEach((t=>{if(e.push(t),t.p){if(t.p.indexOf("&")<0&&(!Utils.isDefined(t.doGetter)||t.doGetter)){let e=(e,i)=>(Utils.isDefined(e)||(e=t.d),this.getProperty(t.p,e)),i="getProperty"+t.p.substring(0,1).toUpperCase()+t.p.substring(1);this[i]||(this[i]=e),i="get"+t.p.substring(0,1).toUpperCase()+t.p.substring(1),this[i]||(this[i]=e)}t.wikiValue=t.wikiValue||t.w}})),this._wikiTags=Utils.mergeLists(e,this._wikiTags)},displayDefineMembers(this,[{label:"Display"},{p:"fields",doGetter:!1,ex:"comma separated list of field ids or indices - e.g. #1,#2,#4-#7,etc or *"},{p:"notFields",ex:"regexp",tt:"regexp to not include fields"},{p:"fieldsPatterns",ex:"comma separated list of regexp patterns to match on fields to display"},{p:"showMenu",ex:!0},{p:"showTitle",ex:!0},{p:"showEntryIcon",ex:!0},{p:"layoutHere",ex:!0},{p:"width",doGetter:!1,ex:"100%"},{p:"height",doGetter:!1,ex:"400"},{p:"tooltip",doGetter:!1,ex:"${default}"},{p:"tooltipPositionMy",ex:"left top"},{p:"tooltipPositionAt",ex:"left bottom+2"},{p:"recordTemplate",doGetter:!1,ex:"${default}",tt:"Template for popups etc. Can be ${default attrs} or '${field} .. ${fieldn}...'"},{p:"titleTemplate",doGetter:!1,ex:"${field1}",tt:"Template for title in ${default} template display"},{p:"itemsPerColumn",ex:10,tt:"How many items to show in each column in a tooltip"},{p:"labelColumnAttrs",ex:"align,right",tt:"Attributes of the label column in the record templates"},{p:"labelWidth",ex:"10",tt:"Width of labels the record templates"},{p:"displayStyle",ex:"css styles",tt:"Specify styles for display"},{p:"title",ex:""},{p:"titleBackground",ex:"color"},{p:"linkField",ex:""},{p:"titleField",ex:""},{p:"descriptionField",ex:""},{p:"textColor",ex:"color"},{p:"backgroundImage",ex:"",tt:"Image url to display in background"},{p:"background",ex:"color"},{p:"showProgress",ex:!0},{p:"loadingMessage",ex:"",tt:"Message to show when loading data"},{p:"doEntries",ex:!0,tt:"Make the children entries be data"},{p:"addAttributes",ex:!0,tt:"Include the extra attributes of the children"},{p:"sortFields",tt:"Comma separated list of fields to sort the data on"},{p:"sortAscending",ex:"true|false",d:!0},{p:"showSortDirection",ex:!0},{p:"sortByFields",ex:"",tt:"Show sort by fields in a menu"},{p:"sortHighlight",ex:!0,tt:"Sort based on highlight from the filters"},{p:"showDisplayFieldsMenu",ex:!0},{p:"displayFieldsMenuMultiple",ex:!0},{p:"displayFieldsMenuSide",ex:"left"},{p:"displayHeaderSide",ex:"left"},{p:"leftSideWidth",ex:"150px"},{label:"Formatting"},{p:"dateFormat",ex:"yyyy|yyyymmdd|yyyymmddhh|yyyymmddhhmm|yyyymm|yearmonth|monthdayyear|monthday|mon_day|mdy|hhmm"},{p:"dateFormatDaysAgo",ex:!0},{p:"doFormatNumber",ex:!1},{p:"formatNumberDecimals",ex:0},{p:"formatNumberScale",ex:100},{p:"numberTemplate",ex:"${number}%"},{p:"&lt;field_id&gt;.&lt;format&gt;",ex:"..."},{label:"Data Requests"},{p:"requestFields",tt:"Comma separated list of fields for querying server side data"},{p:"requestPrefix",ex:"search.",tt:"Prefix to prepend to the url argument"},{p:"request.&lt;request field&gt;.multiple",ex:"true",tt:"Support multiple enumerated selections"},{label:"Filter Data"},{p:"fieldsNumeric",ex:!0,tt:"Only get numeric fields"},{p:"filterFields",ex:""},{p:"filterFieldsToPropagate"},{p:"hideFilterWidget",ex:!0},{p:"filterHighlight",d:!1,ex:!0,tt:"Highlight the records"},{p:"showFilterTags",d:!1},{p:"tagDiv",tt:"Div id to show tags in"},{p:"showFilterHighlight",ex:!1,tt:"show/hide the filter highlight widget"},{p:"headerOrientation",ex:"vertical"},{p:"filterSliderImmediate",ex:!0,tt:"Apply the change while sliding"},{p:"filterLogic",ex:"and|or",tt:"Specify logic to apply filters"},{p:"&lt;field&gt;.filterValue"},{p:"&lt;field&gt;.filterValueMin"},{p:"&lt;field&gt;.filterValueMax"},{p:"&lt;field&gt;.filterValues"},{p:"&lt;field&gt;.filterMultiple",ex:!0},{p:"&lt;field&gt;.filterMultipleSize",ex:5},{p:"filterShowCount",ex:!1},{p:"filterShowTotal",ex:!0},{p:"&lt;field&gt;.filterLabel"},{p:"&lt;field&gt;.showFilterLabel"},{p:"&lt;field&gt;.filterLabelVertical",ex:!0},{p:"filterLabelVertical",ex:!0},{p:"&lt;field&gt;.filterByStyle",ex:"background:white;"},{p:"&lt;field&gt;.includeAll",ex:!1},{p:"&lt;field&gt;.filterSort",ex:!1},{p:"&lt;field&gt;.filterSortCount",ex:!1},{p:"&lt;field&gt;.filterStartsWith",ex:!0},{p:"&lt;field&gt;.filterDisplay",ex:"menu|tab|button|image"},{p:"&lt;field&gt;.filterOps",ex:"<,5000000,label1;>,5000000",tt:"Add menu with fixed filters"},{p:"excludeUndefined",ex:!0,tt:"Exclude any records with an undefined value"},{p:"excludeZero",ex:!0,tt:"Exclude any records with a 0 value"},{p:"filterPaginate",ex:"true",tt:"Show the record pagination"},{p:"recordSelectFilterFields",tt:"Set the value of other displays filter fields"},{p:"selectFields",ex:"prop:label:field1,...fieldN;prop:...."},{p:"match value",ex:'dataFilters="match(field=field,value=value,label=,enabled=);"',tt:"Only show records that match"},{p:"not match value",ex:'dataFilters="notmatch(field=field,value=value,label=,enabled=);"',tt:"Only show records that dont match"},{p:"no missing values",ex:'dataFilters="nomissing(field=field,label=,enabled=);"',tt:"Dont show missing values"},{p:"less than",ex:'dataFilters="lessthan(field=field,value=value,label=,enabled=);"'},{p:"greater than",ex:'dataFilters="greaterthan(field=field,value=value,label=,enabled=);"'},{p:"equals",ex:'dataFilters="equals(field=field,value=value,label=,enabled=);"'},{p:"not equals",ex:'dataFilters="notequals(field=field,value=value,label=,enabled=);"'},{p:"filterLatest",ex:"fields",tt:"Only show the latest records grouped by fields"},{p:"filterDate",ex:"year",tt:"Show a simple pull down menu to select a year to display"},{p:"filterDateIncludeAll",ex:!0,tt:"Include all years"},{p:"startDate",ex:"yyyy,MM,dd,hh,mm,ss",tt:"Filter data on date"},{p:"endDate",ex:"yyyy,MM,dd,hh,mm,ss",tt:"Filter data on date"},{label:"Events"},{p:DisplayEvent.filterChanged.share,ex:!0,tt:"Share filter changed"},{p:DisplayEvent.filterChanged.accept,ex:!0,tt:"Accept filter changed"},{p:DisplayEvent.filterChanged.shareGroup,tt:"Only share in this group"},{p:DisplayEvent.filterChanged.acceptGroup,tt:"Only share in this group"},{p:DisplayEvent.recordSelection.share,ex:!0,tt:"Share record selection"},{p:DisplayEvent.recordSelection.accept,ex:!0,tt:"Accept record selection"},{p:DisplayEvent.recordSelection.shareGroup,tt:"Only share in this group"},{p:DisplayEvent.recordSelection.acceptGroup,tt:"Only share in this group"},{p:DisplayEvent.recordHighlight.share,ex:!0,tt:"Share record highlight"},{p:DisplayEvent.recordHighlight.accept,ex:!0,tt:"Accept record highlight"},{p:DisplayEvent.recordHighlight.shareGroup,tt:"Only share in this group"},{p:DisplayEvent.recordHighlight.acceptGroup,tt:"Only share in this group"},{p:DisplayEvent.recordList.share,ex:!0,tt:"Share record list"},{p:DisplayEvent.recordList.accept,ex:!0,tt:"Accept record list"},{p:DisplayEvent.recordList.shareGroup,tt:"Only share in this group"},{p:DisplayEvent.recordList.acceptGroup,tt:"Only share in this group"},{p:DisplayEvent.fieldsChanged.share,ex:!0,tt:"Share fields changed"},{p:DisplayEvent.fieldsChanged.accept,ex:!0,tt:"Accept fields changed"},{p:DisplayEvent.fieldsChanged.shareGroup,tt:"Only share in this group"},{p:DisplayEvent.fieldsChanged.acceptGroup,tt:"Only share in this group"},{p:DisplayEvent.setEntry.share,ex:!0,tt:"When displaying entries as data this shares the selected entry with other displays"},{p:DisplayEvent.setEntry.accept,ex:!0,tt:"When displaying entries as data this accepts the new entry"},{p:DisplayEvent.setEntry.shareGroup,tt:"When sharing the entry this groups what displays to share with"},{p:DisplayEvent.setEntry.acceptGroup,tt:"When sharing the entry this must match with the shareGroup"},{p:"acceptEventDataSelection",ex:!0,tt:"accept new data coming from other displays"},{label:"Convert Data"},{p:"binDate",ex:"day|month|year",tt:"Bin the dates"},{p:"binType",ex:"count|average|total"},{p:"groupBy",ex:"field",tt:"Group the data"},{p:"aggregateBy",tt:"Add an extra row for the aggregated rows"},{p:"aggregateOperator",ex:"sum|percent",tt:"Operator to apply on the aggregated rows"},{p:"aggregateOperator.fieldName",ex:"sum|percent",tt:"Operator to apply on the aggregated rows for the given field"},{p:"convertData",label:"derived data",ex:"derived(field=new_field_id, function=foo*bar);",tt:"Add derived field"},{p:"convertData",label:"merge rows",ex:"mergeRows(keyFields=f1\\\\,f2, operator=count|sum|average, valueFields=);",tt:"Merge rows together"},{p:"convertData",label:"percent increase",ex:"addPercentIncrease(replaceValues=false);",tt:"Add percent increase"},{p:"convertData",label:"doubling rate",ex:"doublingRate(fields=f1\\\\,f2, keyFields=f3);",tt:"Calculate # days to double"},{p:"convertData",label:"add fixed",ex:'addFixed(id=max_pool_elevation\\\\,value=3700,type=double);"',tt:"add fixed value"},{p:"convertData",label:"unfurl",ex:"unfurl(headerField=field to get header from,uniqueField=e.g. date,valueFields=);",tt:"Unfurl"},{p:"convertData",label:"Accumulate data",ex:"accum(fields=);",tt:"Accumulate"},{p:"convertData",label:"Add an average field",ex:"mean(fields=);",tt:"Mean"},{p:"convertData",label:"Count uniques",ex:"count(field=,sort=true,label=Count);",tt:"Count uniques"},{p:"convertData",label:"rotate data",ex:"rotateData(includeFields=true,includeDate=true,flipColumns=true);",tt:"Rotate data"},{p:"convertData",label:"Prune where fields are all NaN",ex:"prune(fields=);",tt:"Prune"},{p:"convertData",label:"Scale and offset",ex:"accum(scale=1,offset1=0,offset2=0,unit=,fields=);",tt:"(d + offset1) * scale + offset2"},{p:"convertDataPost",label:"Same as above but after filtering is done",tt:"Same as above but after filtering is done"},{label:"Color"},{p:"colors",ex:"color1,...,colorN",tt:"Comma separated array of colors"},{p:"colorBy",ex:"",tt:"Field id to color by"},{p:"colorByFields",ex:"",tt:"Show color by fields in a menu"},{p:"colorByLog",ex:"true",tt:"Use a log scale for the color by"},{p:"colorByMap",ex:"value1:color1,...,valueN:colorN",tt:"Specify colors for color by text values"},{p:"colorTableAlpha",ex:.5,tt:"Set transparency on color table values"},{p:"colorTableInverse",ex:!0,tt:"Inverse the color table"},{p:"colorTablePruneLeft",ex:"N",tt:"Prune first N colors"},{p:"colorTablePruneRight",ex:"N",tt:"Prune last N colors"},{p:"colorByMin",ex:"value",tt:"Min scale value"},{p:"colorByMax",ex:"value",tt:"Max scale value"},{p:"nullColor",ex:"transparent"},{p:"showColorTable",ex:"false",tt:"Display the color table"},{p:"colorTableLabel",ex:""},{p:"showColorTableDots",ex:!0},{p:"colorTableDotsDecimals",ex:"0"},{p:"colorTableSide",ex:"bottom|right|left|top"},{p:"showColorTableStride",ex:1,tt:"How many colors should be shown"},{p:"colorByAllRecords",ex:!0,tt:"use all records for color range"},{p:"convertColorIntensity",ex:!0},{p:"intensitySourceMin",ex:"0"},{p:"intensitySourceMax",ex:100},{p:"intensityTargetMin",ex:1},{p:"intensityTargetMax",ex:0},{p:"convertColorAlpha",ex:!0},{p:"alphaSourceMin",ex:0},{p:"alphaSourceMax",ex:100},{p:"alphaTargetMin",ex:0},{p:"alphaTargetMax",ex:1},{label:"Animation"},{p:"doAnimation",ex:!0},{p:"animationHighlightRecord",ex:!0},{p:"animationHighlightRecordList",ex:!0},{p:"acceptEventAnimationChange",ex:!1},{p:"acceptDateRangeChange",ex:!0},{p:"animationDateFormat",ex:"yyyy"},{p:"animationLabelSize",ex:"12pt"},{p:"animationStyle"},{p:"animationTooltipShow",ex:"true"},{p:"animationTooltipDateFormat",ex:"yyyymmddhhmm"},{p:"animationMode",ex:"sliding|frame|cumulative"},{p:"animationWindow",ex:"1 day|2 weeks|3 months|1 year|2 decades|etc"},{p:"animationStep",ex:"1 day|2 weeks|3 months|1 year|2 decades|etc"},{p:"animationSpeed",ex:500},{p:"animationLoop",ex:!0},{p:"animationDwell",ex:1e3},{p:"animationStartShowAll",ex:!0,tt:"Show full range at start"},{p:"animationShowButtons",ex:!1},{p:"animationShowLabel",ex:!1},{p:"animationShowSlider",ex:!1},{p:"animationWidgetShort",ex:!0},{p:"selectFirst",ex:!0,tt:"Select the first record when animating so other displays will hilight it"},{p:"selectLast",ex:!0,tt:"Select the last record when animating so other displays will hilight it"}],{displayReady:Utils.getPageLoaded(),type:i,displayManager:t,filters:[],dataCollection:new DataCollection,selectedCbx:[],entries:[],wikiAttrs:[TITLE,"showTitle","showDetails","minDate","maxDate"],_properties:[],callHook:function(t,e,i,a,s){return t="hook_"+t,"none"==(t=this.getProperty(t,t))?null:(window[t]||(t=this.type+"_"+t),window[t]?window[t](this,e,i,a,s):void 0)},getWikiEditorTags:function(){return this._wikiTags},getTypeDef:function(){return this.typeDef},getTypeLabel:function(){return this.typeDef?this.typeDef.label:null},getTypeHelpUrl:function(){if(!this.typeDef)return null;let t=this.typeDef.helpUrl;return t?!0===t?"https://ramadda.org/repository/alias/help_"+this.typeDef.type:t:null},defineSizeByProperties:function(){this.defineProperties([{inlineLabel:"Size By"},{p:"sizeBy",ex:"field",tt:"Field to size points by"},{p:"sizeByLog",ex:!0,tt:"Use log scale for size by"},{p:"sizeByMap",ex:"value1:size,...,valueN:size",tt:"Define sizes if sizeBy is text"},{p:"sizeByRadiusMin",ex:"2",tt:"Scale size by"},{p:"sizeByRadiusMax",ex:"20",tt:"Scale size by"},{p:"sizeByLegendSide",ex:"bottom|top|left|right"},,{p:"sizeByLegendStyle"},{p:"sizeBySteps",ex:"value1:size1,v2:s2,...",tt:"Use steps for sizes"}])},getDisplayManager:function(){return this.displayManager},getLayoutManager:function(){return this.getDisplayManager().getLayoutManager()},addToDocumentUrl:function(t,e){HU.addToDocumentUrl("display"+this.displayCount+"."+t,e)},createTagDialog:function(t,e,i,a,s){let l=HU.div([STYLE,HU.css("margin","5px","width","600px;","max-height","300px","overflow-y","auto")],Utils.wrap(t,"","")),r=HU.getUniqueId("input_"),o=HU.input("","",[STYLE,HU.css("width","300px;"),"placeholder","Search for "+s.toLowerCase(),ID,r]),n=HU.div([STYLE,HU.css("margin","10px")],HU.center(o)+l);this.tagDialogs||(this.tagDialogs={}),this.tagDialogs[a]&&this.tagDialogs[a].remove();let h=HU.makeDialog({content:n,anchor:e,title:s,draggable:!0,header:!0});this.tagDialogs[a]=h,h.find(":checkbox").change(i);let d=h.find(".display-search-tag");return $("#"+r).keyup((function(t){let e=$(this).val().trim().toLowerCase();d.each((function(){if(""==e)$(this).show();else{let t=$(this).attr("tag");t&&(t=t.toLowerCase(),t.indexOf(e)>=0?$(this).show():$(this).hide())}}))})),h},getAnimationEnabled:function(){return this.getProperty("doAnimation",!1)},getAnimation:function(){return this.animationControl||(this.animationControl=new DisplayAnimation(this,this.getAnimationEnabled())),this.animationControl},propagateEvent:function(t,e){this.getDisplayManager().notifyEvent(t,this,e)},displayError:function(t){this.displayHtml(HU.getErrorDialog(t))},clearHtml:function(){this.displayHtml("")},displayHtml:function(t){this.setContents(t)},getEventHandler:function(t){return this[t.handler]},notifyEvent:function(t,e,i){let a=this.getEventHandler(t);null!=a?(displayDebug.notifyEvent&&console.log(this.type+".notifyEvent calling function:"+a.name),a.apply(this,[e,i])):displayDebug.notifyEvent&&console.log(this.type+".notifyEvent no event handler function:"+t.name+" "+t.handler)},getColorTableHorizontal:function(){return"bottom"==this.getProperty("colorTableSide","bottom")||"top"==this.getProperty("colorTableSide","bottom")},displayColorTable:function(t,e,i,a,s){s||(s={}),s.showColorTableDots=this.getProperty("showColorTableDots"),s.decimals=this.getProperty("colorTableDotsDecimals",-1),s.showRange=this.getProperty("colorTableShowRange");let l=this.getProperty("colorTableLabels");s.labels=l?l.split(","):null,s.labelStyle=this.getProperty("colorTableLabelStyle","font-size:12pt;"),s.horizontal=this.getColorTableHorizontal(),s.stride=this.getProperty("showColorTableStride",1),Utils.displayColorTable(t,this.getDomId(e),i,a,s);let r=this.getColorTableLabel();if(r&&(s.field&&(r=r.replace("${field}",s.field.getLabel())),this.jq(e).prepend(HU.center(r))),!s||!s.colorByInfo)return;this.jq(e).find(".display-colortable-slice").css("cursor","pointer");let o=this;this.originalColorRange||(this.originalColorRange=[i,a]),this.jq(e).find(".display-colortable-slice").click((function(t){let e=$(this).attr("data-value"),i=HtmlUtils.getTooltip();HtmlUtils.setPopupObject(i);let a="";a+=HU.div([CLASS,"ramadda-menu-item","what","setmin"],"Set range min to "+Utils.formatNumber(e)),a+=HU.div([CLASS,"ramadda-menu-item","what","setmax"],"Set range max to "+Utils.formatNumber(e)),a+=HU.div([CLASS,"ramadda-menu-item","what","reset"],"Reset range"),o.getProperty("colorByLog")?a+=HU.div([CLASS,"ramadda-menu-item","what","togglelog"],"Use linear scale"):a+=HU.div([CLASS,"ramadda-menu-item","what","togglelog"],"Use log scale"),a+=Utils.getColorTablePopup(),i.html(a),$(i).find(".ramadda-colortable-select").click((function(){let t=$(this).attr("colortable");t&&(console.log("color table:"+t),o.setProperty("colorTable",t),o.forceUpdateUI())})),i.show(),i.position({of:$(this),my:"left top",at:"left bottom",collision:"none none"}),i.find(".ramadda-menu-item").click((function(){let t=$(this).attr("what");"reset"==t?(o.setProperty("colorByMin",o.getProperty("colorByMinOrig")),o.setProperty("colorByMax",o.getProperty("colorByMaxOrig")),o.setProperty("overrideColorRange",!1)):"togglelog"==t?o.getProperty("colorByLog")?o.setProperty("colorByLog",!1):o.setProperty("colorByLog",!0):"setmin"==t?(Utils.isDefined(o.getProperty("colorByMinOrig"))||o.setProperty("colorByMinOrig",o.getProperty("colorByMin")),o.setProperty("colorByMin",e),o.setProperty("overrideColorRange",!0)):(Utils.isDefined(o.getProperty("colorByMaxOrig"))||o.setProperty("colorByMaxOrig",o.getProperty("colorByMax")),o.setProperty("colorByMax",e),o.setProperty("overrideColorRange",!0)),o.forceUpdateUI()}))}))},getUnhighlightColor:function(){return this.getProperty("unhighlightColor","#eee")},getColorList:function(){if(this.colorList&&this.colorList.length>0)return this.colorList;if(this.getProperty("colors")&&"default"!=this.getProperty("colors")){var t=this.getProperty("colors");Array.isArray(t)||(t=t.split(",")),this.colorList=t}return this.colorList&&0!=this.colorList.length||(this.colorList=["blue","red","green","orange","fuchsia","aqua","navy","brown","cadetblue","blueviolet","coral","cornflowerblue","darkcyan","darkgoldenrod","darkorange","darkseagreen"]),this.colorList},getColorTableName:function(t){t&&!Array.isArray(t)&&(t=[t]);let e=null;if(t)t.every((t=>(e=this.getProperty(t),!e)));else{var i=this.getProperty("colorBy");i&&(e=this.getProperty("colorTable."+i)),e||(e=this.getProperty("colorBar",this.getProperty("colorTable")))}return"none"==e?null:e},getColorTable:function(t,e,i){let a=this.getColorTableName(e);return a||(a=i),this.getColorTableInner(t,a)},getColorTableInner:function(t,e){let i;if(e){let a=null;return e.startsWith("colors:")?(i=e.substring("colors:".length).split(","),this.convertColors(i)):(a=Utils.ColorTables[e],a&&t?this.convertColors(a.colors):!a&&name?this.convertColors(e.split(",")):a)}if(this.getProperty("colors")&&"default"!=this.getProperty("colors")){var a=this.getProperty("colors");return"object"!=typeof a&&(a=a.split(",")),this.convertColors(a)}return null},addAlpha:function(t,e){if(!t)return null;if(!(e=Utils.isDefined(e)?e:this.getProperty("colorTableAlpha")))return t;t=Utils.cloneList(t);var i=[];return t.forEach((t=>{i.push(Utils.addAlphaToColor(t,e))})),i},convertColors:function(t){if(t=this.addAlpha(t),this.getColorTableInverse()){let e=[];for(let i=t.length-1;i>=0;i--)e.push(t[i]);t=e}if(this.getProperty("colorTablePruneLeft")){let e=[];for(let i=+this.getProperty("colorTablePruneLeft");i<t.length;i++)e.push(t[i]);t=e}if(this.getProperty("colorTablePruneRight")){let e=[],i=+this.getProperty("colorTablePruneRight");for(let a=0;a<t.length-i;a++)e.push(t[a]);t=e}return t},getColorByColors:function(t,e){var i=this.getProperty("colorBy");if(!i)return null;var a=this.getFieldById(fields,i);if(!a)return null;var s=this.getColumnValues(t,a),l=this.getColorTable();if(l||(l=Utils.getColorTable(e||"blue_white_red")),!l)return null;var r=parseFloat(this.getProperty("colorByMin",s.min)),o=parseFloat(this.getProperty("colorByMax",s.max));l.colors&&(l=l.colors);for(var n=o-r,h=[],d=0;d<s.values.length;d++){var p=s.values[d],g=parseInt((p-r)/n*l.length);g>=l.length?g=l.length-1:g<0&&(g=0),h.push(l[g])}return{colors:h,min:r,max:o}},getDefaultGridByArgs:function(){let t=this.getProperty("doHeatmap",!1),e={display:this,shape:this.getProperty("cellShape","rect"),color:this.getProperty("cellColor","blue"),stroke:!this.getProperty("cellFilled",!0),cellSize:this.getProperty("cellSize",t?0:4),cellSizeH:this.getProperty("cellSizeH",20),cellSizeHBase:this.getProperty("cellSizeHBase",0),cell3D:this.getProperty("cell3D",!1),cellShowText:this.getProperty("cellShowText",!1),cellLabels:Utils.split(this.getProperty("cellLabels")),cellFonts:Utils.split(this.getProperty("cellFonts")),cellLabelColors:Utils.split(this.getProperty("cellLabelColor")),cellLabelPositions:Utils.split(this.getProperty("cellLabelPositions")),cellLabelOffsetsX:Utils.split(this.getProperty("cellLabelOffsetsX")),cellLabelOffsetsY:Utils.split(this.getProperty("cellLabelOffsetsY")),doHeatmap:t,operator:this.getProperty("hm.operator",this.getProperty("hmOperator","count")),filter:this.getProperty("hm.filter",this.getProperty("hmFilter"))};return e.cellSizeX=+this.getProperty("cellSizeX",e.cellSize),e.cellSizeY=+this.getProperty("cellSizeY",e.cellSize),e},getIconMap:function(){var t,e=this.getProperty("iconMap");if(e){var i=e.split(",");t={};for(var a=0;a<i.length;a++){var s=i[a].split(":");s.length>1&&(t[s[0]]=s[1])}}return t},getColorByInfo:function(t,e,i,a,s,l){let r=this.getData();return null==r?null:(this.getProperty("colorByAllRecords")&&(t=r.getRecords()),new ColorByInfo(this,r.getRecordFields(),t,e,i,a,s,null,null,l))},getColorByMap:function(t){return t=this.getProperty(t||"colorByMap"),this.debugGetProperty=!1,Utils.parseMap(t)},toString:function(){return this.type+" - "+this.getId()},getType:function(){return this.type},getClass:function(t){return null==t?this.getBaseClass():this.getBaseClass()+"-"+t},getBaseClass:function(){return"display-"+this.getType()},setDisplayManager:function(t){this.displayManager=t,this.setDisplayParent(t.getLayoutManager())},setContents:function(t,e){this.clearDisplayMessage(),e||(t=HU.div([ATTR_CLASS,"display-contents-inner display-"+this.getType()+"-inner"],t)),this.writeHtml(ID_DISPLAY_CONTENTS,t)},addEntry:function(t){this.entries.push(t)},clearCachedData:function(){},setEntry:function(t){if(displayDebug.setEntry&&console.log(this.type+".setEntry:"+t),this.entries=[],this.addEntry(t),this.entry=t,this.entryId=t.getId(),this.clearCachedData(),this.properties.theData){this.dataCollection=new DataCollection;let e={entryId:this.entryId,lat:this.getProperty("latitude"),lon:this.getProperty("longitude")},i=this.properties.theData.url;i=i?i.replace(/entryid=.*?&/,"entryid="+t.getId()+"&"):this.getRamadda().getRoot()+"/entry/show?entryid="+t.getId()+"&output=points.product&product=points.json&max=5000",this.properties.theData=this.data=new PointData(t.getName(),null,null,i,e),this.startProgress(),this.data.loadData(this)}else this.callUpdateUI();this.getShowTitle()&&this.jq(ID_TITLE).html(t.getName())},getTextColor:function(t,e){return t?this.getProperty(t,this.getProperty("textColor",e)):this.getProperty("textColor","#000")},getTitleHtml:function(t){var e="";if(this.getShowTitle()){var i=HU.css("color",this.getTextColor("titleColor","#000")),a=this.getProperty("titleBackground");a&&(i+=HU.css("background",a,"padding","2px","padding-right","6px","padding-left","6px")),e=this.getShowTitle()?this.getDisplayTitle(t):"";let s=this.getProperty("entryId")||this.entryId;s&&(e=HU.href(this.getRamadda().getEntryUrl(s),e,[ATTR_CLASS,"display-title",STYLE,i])),e=HU.span([ID,this.domId(ID_TITLE)],e)}if(this.getProperty("showEntryIcon")){let t=this.getProperty("entryIcon");t&&(e=HU.image(t)+" "+e)}return e},handleEventMapClick:function(t,e){if(this.dataCollection)for(var i=this.dataCollection.getList(),a=0;a<i.length;a++)i[a].handleEventMapClick(this,t,e.lon,e.lat)},acceptEvent:function(t,e){return this.getProperty(t.accept,e)},shareEvent:function(t,e){return this.getProperty(t.share,e)},handleEventMapBoundsChanged:function(t,e){this.acceptEvent(DisplayEvent.mapBoundsChanged,this.getProperty("acceptBoundsChange"))&&(this.filterBounds=e.bounds,this.callUpdateUI())},handleEventFilterFieldsSelected:function(t,e){if(e.length>0&&"string"==typeof e[0]){var i=[];e.forEach((t=>{(t=this.getFieldById(null,t))&&i.push(t)})),e=i}let a="";e.forEach((t=>{""!=a&&(a+=","),a+=t.getId()})),this.setProperty("filterFields",a),this.haveCalledUpdateUI=!1,this.checkSearchBar()},handleEventFieldValueSelected:function(t,e){this.setProperty("filterPattern",e.value),this.setProperty("patternFilterField",e.field.getId()),this.callUpdateUI()},setDateRange:function(t,e,i){this.minDateObj=t,this.maxDateObj=e,this.dateRangeDoDay=i},handleDateRangeChanged:function(t,e){this.setDateRange(e.minDate,e.maxDate),this.getAnimation().getEnabled()&&this.getAnimation().setDateRange(e.minDate,e.maxDate),this.haveCalledUpdateUI=!1,this.dataFilterChanged()},displayFieldsChanged:function(t,e){if(this.addToDocumentUrl(PROP_FIELDS,t),this.setProperty(PROP_FIELDS,t),this.callUpdateUI(),this.displayFieldsMenuEnums&&e&&this.getProperty("showDisplayFieldsMenu")){this.jq("displayfields").val(t)}},handleEventFilterChanged:function(t,e){if(!this.acceptEvent(DisplayEvent.filterChanged,this.getProperty("acceptEventFilter",!0)))return;this.haveCalledUpdateUI=!1;let i=e.properties;i||(i=[],i.push(e)),this.settingFilterValue=!0,i.forEach((t=>{let e=this.filterMap?this.filterMap[t.fieldId]:null;if(!e)return;let i=this.getFilterId(t.fieldId);t.id&&t.id.endsWith("date1")?i+="_date1":t.id&&t.id.endsWith("date2")&&(i+="_date2"),"_highlight"==t.fieldId?(this.jq(ID_FILTER_HIGHLIGHT).val(t.value),this.setProperty("filterHighlight","highlight"==t.value)):Utils.isDefined(t.value2)?($("#"+i+"_min").val(t.value),$("#"+i+"_min").attr("data-value",t.value),$("#"+i+"_max").val(t.value2),$("#"+i+"_max").attr("data-value",t.value2)):e.handleEventPropertyChanged(t)})),this.settingFilterValue=!1,this.dataFilterChanged()},handleEventPropertyChanged:function(t,e){let i=displayDebug.handleEventPropertyChanged;if("dateRange"!=e.property)if("displayFields"!=e.property){if("macroValue"==e.property){if(e.entryId!=this.entryId)return;if(!this.getProperty("acceptRequestChangeEvent",!0))return;let t=this.getRequestMacros(),a=null;if(t.every((t=>!t.isMacro(e.id)||(a=t,!1))),!a)return;if(!this.getProperty("request."+a.name+".acceptChangeEvent",!0))return;return a.setValue(e),i&&console.log(this.getId()+" event-reloading"),void this.reloadData()}this.setProperty(e.property,e.value),this.callUpdateUI()}else{if(!this.acceptEvent(DisplayEvent.fieldsChanged,!this.getProperty("acceptEventDisplayFieldsChange",!1)))return;this.displayFieldsChanged(e.value,!0)}else this.getProperty("acceptDateRangeChange")&&this.handleDateRangeChanged(t,e)},handleEventRecordList:function(t,e){this.getAnimationEnabled()&&this.getProperty("animationHighlightRecordList")&&this.getAnimation().setRecordListHighlight(e.recordList),this.getProperty("acceptEventRecordList",!1)&&(this.recordListOverride=e.recordList,this.haveCalledUpdateUI=!1,this.callUpdateUI())},handleEventRecordHighlight:function(t,e){this.getAnimation().getEnabled()&&!e.skipAnimation&&this.getAnimation().handleEventRecordHighlight(t,e)},handleEventAnimationChanged:function(t,e){this.getProperty("acceptEventAnimationChange",!0)&&this.getAnimation().getEnabled()&&this.getAnimation().handleEventAnimationChanged(e)},handleEventSetEntry:function(t,e){this.acceptEvent(DisplayEvent.setEntry,this.getProperty(DisplayEvent.setEntry.acceptGroup,this.getProperty("acceptShareSelectedEntry",!1)))?(displayDebug.setEntry&&console.log(this.type+".handleEventSetEntry calling setEntry:"+e.entry),this.setEntry(e.entry)):displayDebug.setEntry&&console.log(this.type+".handleEventSetEntry not calling setEntry:"+e.entry)},propagateEventRecordSelection:function(t){if(displayDebug.notifyEvent&&console.log(this.type+".propagateEventRecordSelection"),this.shareEvent(DisplayEvent.setEntry,this.getProperty(DisplayEvent.setEntry.shareGroup,this.getProperty("shareSelectedEntry")))){let e=t.record.getValueFromField("id");if(displayDebug.setEntry&&console.log(this.type+" sharing entry:"+e),e){let t=this;setTimeout((async function(){await getGlobalRamadda().getEntry(e,(e=>{displayDebug.setEntry&&console.log(t.type+" calling notifyEvent with entry:"+e),t.getDisplayManager().notifyEvent(DisplayEvent.setEntry,t,{entry:e})}))}))}}if(this.shareEvent(DisplayEvent.recordSelection,!0)&&this.getDisplayManager().notifyEvent(DisplayEvent.recordSelection,this,t),this.getProperty("recordSelectFilterFields")){let e=this.getFieldsByIds(null,this.getProperty("recordSelectFilterFields"));if(e&&e.length>0){let i={properties:[]};e.forEach((e=>{i.properties.push({id:e.getId(),fieldId:e.getId(),value:t.record.getValue(e.getIndex())})})),this.propagateEvent(DisplayEvent.filterChanged,i)}}},handleEventRecordSelection:function(t,e){if(this.selectedRecord=e.record,this.selectedRecord&&this.getProperty("colorThresholdField")&&(this.haveCalledUpdateUI=!1,this.callUpdateUI()),!t.getEntries)return;let i=t.getEntries();for(let t=0;t<i.length;t++){let e=i[t];if(this.getEntries().indexOf(e)>=0){this.highlightEntry(e);break}}},areaClear:function(){this.getDisplayManager().notifyEvent("areaClear",this)},handleEventEntryMouseover:function(t,e){},handleEventEntryMouseout:function(t,e){},handleEventEntrySelection:function(t,e){this.getEntries().indexOf(e.entry)>=0&&(e.selected?this.jq(ID_TITLE).addClass("display-title-select"):this.jq(ID_TITLE).removeClass("display-title-select"))},highlightEntry:function(t){this.jq(ID_TITLE).addClass("display-title-select")},getEntries:function(){return this.entries},getDisplayEntry:async function(t){var e=this.getEntries();if(null!=e&&e.length>0)return Utils.call(t,e[0]);let i=this.entryId||this.getProperty("entryId");var a;i?await this.getRamadda().getEntry(i,(e=>{a=e,Utils.call(t,a)})):Utils.call(t,null)},hasEntries:function(){return null!=this.entries&&this.entries.length>0},getWaitImage:function(){return HU.image(ramaddaCdn+"/icons/progress.gif")},useDisplayMessage:function(){return!0},setDisplayMessage:function(t){if(!Utils.stringDefined(t))return void this.jq(ID_DISPLAY_MESSAGE).html("").hide();let e=this.jq(ID_DISPLAY_CONTENTS),i=e.css("min-height");i&&"0px"!=i||(e.css("min-height","75px"),e.attr("display-set-minheight","true")),this.jq(ID_DISPLAY_MESSAGE).html(t).show()},clearDisplayMessage:function(){let t=this.jq(ID_DISPLAY_CONTENTS);this.jq(ID_DISPLAY_MESSAGE).hide(),null!=t.attr("display-set-minheight")&&t.css("min-height","")},getLoadingMessage:function(t){return this.getAcceptEventDataSelection()?"":(t||this.getProperty("theData")||(t="No data specified"),t||(t=this.getProperty("loadingMessage","icon_progress Loading data...")),""==t?"":(t=t.replace("icon_progress",HU.image(icon_progress)),this.useDisplayMessage()?SPACE+t:HU.div([STYLE,HU.css("text-align","center")],this.getMessage(SPACE+t))))},reloadData:function(){if(this.startProgress(),this.haveCalledUpdateUI=!1,this.getProperty("okToLoadData",!0)){this.dataCollection.getList()[0].loadData(this,!0)}},getMessage:function(t){return HU.div([ATTR_CLASS,"display-output-message"],t)},getNoDataMessage:function(){return this.getProperty("noDataMessage","No data available")},getFieldValue:function(t,e){var i=$("#"+t);return i.length>0?i.val():e},getFieldValues:function(t,e){var i=$("#"+t);if(i.length>0){let t=[];return i.each((function(){t.push($(this).val())})),t}return e},getFooter:function(){return HU.div([ATTR_ID,this.getDomId(ID_FOOTER),ATTR_CLASS,"display-footer"],HU.leftRight(HU.div([ATTR_ID,this.getDomId(ID_FOOTER_LEFT),ATTR_CLASS,"display-footer-left"],""),HU.div([ATTR_ID,this.getDomId(ID_FOOTER_RIGHT),ATTR_CLASS,"display-footer-right"],"")))},shouldSkipField:function(t){return this.skipFields&&!this.skipFieldsList&&(this.skipFieldsList=this.skipFields.split(",")),!!this.skipFieldsList&&this.skipFieldsList.indexOf(t.getId())>=0},fieldSelected:function(t){if(this.userHasSelectedAField=!0,this.selectedFields=null,this.overrideFields=null,this.removeProperty(PROP_FIELDS),this.fieldSelectionChanged(),t.shiftKey){let t=this.getSelectedFields();this.propagateEvent(DisplayEvent.fieldsSelected,t)}},addFieldsCheckboxes:function(t){if(!this.hasData())return;var e=this.getPropertyFields();null!=e&&0==e.length&&(e=null);let i=null;null!=e&&(Array.isArray(e)||(e=e.split(",")),i={},e.forEach((t=>{if(t.startsWith("#")){let e=t.split("-");if(2==e.length){let t=+e[0].replace("#",""),a=+e[1].replace("#","");for(let e=t;e<=a;e++)i["#"+e]=!0}}i[t]=!0})));var a="",s=this.getId()+"_checkbox",l=this.getId()+"_groupby",r=this.dataCollection.getList();null!=t&&(this.overrideFields=[]);var o={};for(var h=0;h<r.length;h++){let u=r[h],y=this.getFieldsToSelect(u);if(this.canDoGroupBy()){let t=u.getRecordFields(),e=0;for(n=0;n<t.length;n++){let i=t[n];if("string"==i.getType()){if(0==e){a+=HU.div([ATTR_CLASS,"display-dialog-subheader"],"Group By"),a+=HU.open(TAG_DIV,[ATTR_CLASS,"display-fields"]);var d=null==this.groupBy||""==this.groupBy;a+=HU.tag(TAG_DIV,[ATTR_TITLE,"none"],HU.radio("none",this.getDomId("groupby"),l,"none",!d)+" None")}e++;d=this.groupBy==i.getId();var p="groupby_"+h+"_"+n;i.radioId=this.getDomId(p),a+=HU.tag(TAG_DIV,[ATTR_TITLE,i.getId()],HU.radio(i.radioId,this.getDomId("groupby"),l,i.getId(),d)+" "+i.getUnitLabel()+" ("+i.getId()+")")}}e>0&&(a+=HU.close(TAG_DIV))}let m="";if(y.length>0){let l=this.getSelectedFields([]),r=[];for(let t=0;t<l.length;t++)r.push(l[t].getId());a+=HU.div([ATTR_CLASS,"display-dialog-subheader"],"Displayed Fields"),a+=HU.open(TAG_DIV,[ATTR_CLASS,"display-fields"]);for(let l=0;l<y.length;l++){let d=y[l],p="cbx_"+h+"_"+l;d.checkboxId=this.getDomId(p);let u=!1,f=!0;if(null!=t){for(var g=0;g<t.length;g++)if(t[g].getId()==d.getId()){u=!0,this.overrideFields.push(d.getId());break}}else r.length>0?u=r.indexOf(d.getId())>=0:null!=i?(u=e[d.getId()],u||(u=e["#"+(l+1)])):null!=this.overrideFields?(u=this.overrideFields.indexOf(d.getId())>=0,u||(u=this.overrideFields.indexOf("#"+(l+1))>=0)):this.selectedCbx.indexOf(d.getId())>=0?u=!0:0==this.selectedCbx.length&&(u=0==n);let D=d.getUnitLabel();var c;if(o[D]?(D=D+" "+o[D],o[D]++):o[D]=1,f)d.derived&&(D+=" (derived)"),c=this.canDoMultiFields()?HU.checkbox(d.checkboxId,[CLASS,s],u):HU.radio(d.checkboxId,"field_radio",s,"",u),a+=HU.tag(TAG_DIV,[ATTR_TITLE,d.getId()],c+" "+D);else m+=HU.div([],D)}}""!=m&&(a+=HU.div([STYLE,HU.css("border-top","1px #888  solid")],"<b>No Data Available</b>"+m)),a+=HU.close(TAG_DIV)}this.writeHtml(ID_FIELDS,a),this.userHasSelectedAField=!1;let u=this;$("."+s).click((function(t){u.fieldSelected(t)})),$("."+l).change((function(t){u.groupBy=$(this).val(),u.displayData&&u.displayData()}))},fieldSelectionChanged:function(){this.setDisplayTitle(),this.displayData&&(this.clearCachedData(),this.displayData())},defaultSelectedToAll:function(){return!0},setSelectedFields:function(t){this.clearCachedData(),this.selectedFields=t,this.addFieldsCheckboxes(t)},getSelectedFields:function(t){let e=displayDebug.getSelectedFields;if((e&&console.log(this.type+".getSelectedFields"),this.getBinDate())&&"count"==(s=this.getBinType("total"))){var i=[];return i.push(new RecordField({id:s,label:this.getProperty("binDateLabel",this.getProperty("binCountLabel","Count")),type:"double",chartable:!0})),i}this.debugSelected=e,this.lastSelectedFields=this.getSelectedFieldsInner(t);let a=this.getProperty("notFields");if(a){let t=[];this.lastSelectedFields.forEach((e=>{e.getId().match(a)||e.getLabel().match(a)||t.push(e)})),this.lastSelectedFields=t}e&&console.log("\tsetting lastSelectedFields:"+this.lastSelectedFields);this.getPropertyFields();if(this.setDisplayTitle(),this.getBinDate()){var s=this.getProperty("binType","total");let t=[];this.lastSelectedFields.forEach((e=>{if(e.isNumeric()){const i=s;e.getId().startsWith(i)?t.push(e):t.push(new RecordField({id:i+"_"+e.getId(),index:e.getIndex(),label:this.getProperty("binDateLabel",Utils.camelCase(s)+" of "+e.getLabel()),type:"double",chartable:e.isChartable()}))}else t.push(e)})),this.lastSelectedFields=t}return Utils.cloneList(this.lastSelectedFields)},getSelectedFieldsInner:function(t){if(this.debugSelected&&(console.log("getSelectedFieldsInner dflt:"+(t||"null")),console.log("\tlast selected = "+this.lastSelectedFields)),this.selectedFields)return this.debugSelected&&console.log("\treturning this.selectedFields:"+this.selectedFields),this.selectedFields;var e=[],i=this.dataCollection.getList(),a=this.getPropertyFields();if(a&&"string"==typeof a&&(a=a.split(",")),a){let t=[];a.forEach((e=>{if(!e.match("-"))return void t.push(e);let i=e.split("-"),a=parseFloat(i[0].trim().substring(1)),s=parseFloat(i[1].trim().substring(1));for(let e=a;e<=s;e++)t.push("#"+e)})),a=t}let s={};var l=this.getProperty("fieldAliases");l&&l.split(",").forEach((t=>{[name,alias]=t.split(":"),s[alias]=name}));for(var r=0;r<i.length;r++){var o=i[r];this.pointData&&(o=this.pointData);var n=this.getFieldsToSelect(o);if(null!=a&&a.length>0){this.debugSelected&&console.log("\thave fixed fields:"+a.length);let t=[];for(var h=0;h<a.length;h++){var d=a[h];if("*"==d){t=n;break}(u=this.getFieldById(n,d))&&t.push(u)}this.getProperty("fieldsNumeric")&&(t=t.filter((t=>t.isNumeric()))),e=t}}if(!this.userHasSelectedAField&&null!=a&&a.length>0)return this.debugSelected&&console.log("\tfrom fixed:"+e.length),e;this.userHasSelectedAField=!1;var p=null,g=null;this.selectedCbx=[];var c=!1;for(r=0;r<i.length;r++){o=i[r];for(p=this.getFieldsToSelect(o),h=0;h<p.length;h++){var u=p[h];null==g&&u.isNumeric()&&(g=u);var y="cbx_"+r+"_"+h,m=this.getDomId(y),f=$("#"+m);f.length>0&&(c=!0,f.is(":checked")&&(this.selectedCbx.push(u.getId()),e.push(u)))}}return 0==e.length&&!c&&this.lastSelectedFields&&this.lastSelectedFields.length>0?(this.debugSelected&&console.log("\tlastSelectedFields:"+this.lastSelectedFields),this.lastSelectedFields):(0==e.length&&(e=this.getDefaultSelectedFields(p,t,this.debugSelected),this.debugSelected&&console.log("\tusing default selected:"+e)),e)},getDefaultSelectedFields:function(t,e,i){let a=i||displayDebug.getDefaultSelectedFields;a&&console.log("getDefaultSelectedFields");let s=this.getProperty("fieldsPatterns");if(s){let t=this.getFields();if(t){let e=!1,i=[];if(e&&console.log("fields:"+t),s.split(",").forEach((a=>{e&&console.log("\tpattern:"+a),t.every((t=>{if(!t.isFieldNumeric())return!0;let s=t.getId().toLowerCase();return e&&console.log("\t\tid:"+s),!(s.match(a)&&(e&&console.log("\t\tmatch"),!i.includes(t)))||(e&&console.log("\t\tadd to matched"),i.push(t),!1)}))})),e&&console.log("returning:"+i),i.length)return i}}if(this.defaultSelectedToAll()){let t=this.getFields();if(t){var l=[];for(n=0;n<t.length;n++){(r=t[n]).isFieldGeo()||l.push(r)}}return a&&console.log("\treturning allFields:"+l),l}if(null!=e)return a&&console.log("\treturning dfltList:"+e),e;for(n=0;n<t.length;n++){var r;if((r=t[n]).isNumeric()&&!r.isFieldGeo())return[r]}return[]},sortRecords:function(t,e){if(!e){let t=this.getProperty("sortFields","",!0);"${fields}"==t&&(t=this.getProperty("fields","",!0)),0==(e=this.getFieldsByIds(null,t)).length&&this.sortByFields&&this.sortByFields.length>0&&(e=[this.sortByFields[0]])}if(e.length>0){t=Utils.cloneList(t);let i=this.getSortAscending();t.sort(((t,a)=>{let s=this.getDataValues(t),l=this.getDataValues(a),r=0;for(let t=0;t<e.length;t++){let a=e[t],o=s[a.getIndex()],n=l[a.getIndex()];if(a.isNumeric()||a.isFieldDate()?r=isNaN(o)&&isNaN(n)?0:isNaN(o)?i?-1:1:isNaN(n)?i?1:-1:o<n?i?-1:1:o>n?i?1:-1:0:(r=String(o).localeCompare(String(n)),i||(r=-r)),0!=r)break}return r}))}if(this.getProperty("sortHighlight")&&(t=Utils.cloneList(t)).sort(((t,e)=>{let i=t.isHighlight(this),a=e.isHighlight(this);return i&&!a?-1:!i&&a?1:0})),this.getProperty("reverse",!1)){let e=[];for(let i=(t=Utils.cloneList(t)).length-1;i>=0;i--)e.push(t[i]);t=e}return t},getFieldById:function(t,e,i){if(i&&console.log("getFieldById:"+e),null!=t&&null==e){if("string"!=typeof t)return i&&console.log("\tbadfields:"+t),null;e=t,t=null}if(!e)return i&&console.log("\tno id"),null;if(e=String(e).trim(),!t){let e=this.getData();if(null==e)return i&&console.log("\tno data"),null;t=e.getRecordFields(),i&&console.log("\tusing  fields:"+t)}let a={},s=this.getProperty("fieldAliases");s&&s.split(",").forEach((t=>{[name,alias]=t.split(":"),a[alias]=name}));let l=null;return e.split("|").every((e=>{let s=a[e],r=e.indexOf("*")>=0;for(let a=0;a<t.length;a++){let o=t[a];if(i&&console.log("\tField:"+o.getId()),o.getId()==e||e=="#"+(a+1)||o.getId()==s)return l=o,i&&console.log("\tgot it:"+l),!1;if(r&&o.getId().match(e))return l=o,i&&console.log("\tgot it from pattern:"+l),!1}return!0})),i&&console.log("\tgot:"+l),l},getFieldsByIds:function(t,e){if(!t){let e=this.getData();null!=e&&(t=e.getRecordFields())}let i=[];if(!e)return i;if("*"==e)return t;if("string"==typeof e&&(e=e.split(",")),!t){var a=this.getData();if(null==a)return null;t=a.getRecordFields()}for(let a=0;a<e.length;a++){let s=e[a];if(s.startsWith("#")){let e=s.split("-");if(2==e.length){let a=+e[0].replace("#",""),s=+e[1].replace("#","");console.log(a+" "+s);for(let e=a;e<=s;e++){let e=this.getFieldById(t,"#"+a);e&&i.push(e)}continue}}let l=this.getFieldById(t,e[a]);l&&i.push(l)}return i},getFieldByType:function(t,e){return 0==(t=this.getFieldsByType(t,e)).length?null:t[0]},getFieldsByType:function(t,e){if(!t){let e=this.getData();if(null==e)return null;t=e.getRecordFields()}let i=[],s="numeric"==e,l="string"==e;for(a in t){let r=t[a];if(!r.isRecordDate()){if(null==e)return r;s?r.isFieldNumeric()&&i.push(r):l?r.isFieldString()&&i.push(r):r.getType()==e&&i.push(r)}}return i},getDateValues:function(t){let e=[];return t.forEach((t=>{e.push(t.getDate())})),e},getColumnValues:function(t,e){for(var i=[],a=Number.MAX_VALUE,s=Number.MIN_VALUE,l=0;l<t.length;l++){var r=t[l].getData()[e.getIndex()];i.push(r),Utils.isNumber(r)&&!isNaN(r)&&(a=Math.min(a,r),s=Math.max(s,r))}return{values:i,min:a,max:s}},requiresGrouping:function(){return!1},makeTree:function(t){if(null==t){let e=this.getData();if(null==e)return null;t=e.getRecords()}let e=this.getProperty("treeTemplate"),i=this.getProperty("treeTooltip"),a=[],s={},l=[],r={};var o=this.getFieldById(null,this.getProperty("labelField")),n=this.getFieldsByIds(null,this.getProperty("nodeFields"));let h=this.getProperty("treeRoot"),d=null;if(h&&(d={id:h,label:h,children:[],parent:null},a.push(d)),n.length>0){let e=0;return t.forEach((t=>{var i=null==o?p:t.getValue(o.getIndex());let r=null,h=null;n.forEach((e=>{let i=t.getValue(e.getIndex()),l=r?r+"-"+i:i,o=s[l];o||(o={id:l,label:i,children:[],parent:h},s[l]=o,h||(d?(o.parent=d,d.children.push(o)):a.push(o)),h&&h.children.push(o)),r=l,h=o}));var p="leaf"+e++,g={id:p,label:i,children:[],record:t,parent:h};h.children.push(g),s[p]=g,l.push(g)})),a}let p=this.getFieldById(null,this.getProperty("parentField")),g=this.getFieldById(null,this.getProperty("idField"));if(!p)throw new Error("No parent field specified");if(!g)throw new Error("No id field specified");return t.forEach((t=>{var n=t.getValue(p.getIndex()),h=t.getValue(g.getIndex()),c={id:h,label:null==o?h:t.getValue(o.getIndex()),children:[],record:t,parentId:n,parent:null};e&&(c.display=this.getRecordHtml(t,null,e)),i&&(c.tooltip=this.getRecordHtml(t,null,i)),s[h]=c,l.push(c),""==n&&(r[h]=c,d?(c.parent=d,c.parentId=d.id,d.children.push(c)):a.push(c))})),l.forEach((t=>{let e=s[t.parentId];if(e)t.parent=e,e.children.push(t);else if(!r[t.id])throw new Error("No parent :"+t.parentId+" for node:"+t.label)})),a},getSegments:function(){var t=this.getProperty("timeSegments");if(!t)return null;var e=[];return t.split(",").forEach(((t,i)=>{var a=t.split(";"),s=a[0],l=Utils.parseDate(a[1],!1),r=Utils.parseDate(a[2],!1);e.push({name:s,start:l,end:r})})),e},convertPointData:function(t){let e=t,i=this.getSegments();if(i){let s=t.getRecords(),l=[],r=[];l.push(r);var a=0;i.forEach(((t,e)=>{var o=t.name;r.push(o);for(var n=t.start,h=t.end,d=1;a<s.length;a++){var p=s[a];if(p.getTime()<n.getTime())continue;if(p.getTime()>h.getTime())break;var g=p.getValue(1);let t=null;if(d>=l.length){t=[];for(let e=0;e<i.length;e++)t.push(NaN);l.push(t)}else t=l[d];t[e]=g,d++}})),(t=convertToPointData(l)).entryId=e.entryId}try{t=(new CsvUtil).process(this,t,this.getProperty("convertData"))}catch(t){return this.handleError("Error:"+t,t),null}return t},requiresGeoLocation:function(){return!1},checkDataFilters:function(t,e){if(!t)return!0;for(let i=0;i<t.length;i++)if(!t[i].isRecordOk(e))return!1;return!0},getDataFilters:function(t){return DataUtils.getDataFilters(this,t||this.getProperty("dataFilters"))},getFilterHighlight:function(){return this.getProperty("filterHighlight",!1)},getFilterTextMatchers:function(){let t=[];if(this.filters)for(var e=0;e<this.filters.length;e++){let s=this.filters[e];if(s.field){var i=$("#"+this.getDomId("filterby_"+s.field.getId()));if(i.val&&null!=i.val()){var a=i.val()||"";""!=a.trim()&&t.push(new TextMatcher(a))}}}return t},filterDataPhase2:function(t){return t},filterData:function(t,e,i){if(this.recordListOverride)return this.recordListOverride;let a={doGroup:!1,skipFirst:!1,applyDateRange:!0};i&&$.extend(a,i);let s=displayDebug.filterData;this.getAnimationEnabled()&&this.getProperty("animationFilter",!0)&&this.setDateRange(this.getAnimation().begin,this.getAnimation().end);let l=this.getFilterHighlight(),r=this.getProperty("startDate"),o=this.getProperty("endDate");r&&(this.startDateObject=Utils.createDate(r,+this.getProperty("timeZoneOffset",0)),s&&console.log(this.type+" start date:"+r+" dttm:"+this.startDateObject.toUTCString())),o&&(this.endDateObject=Utils.createDate(o,+this.getProperty("timeZoneOffset",0)),s&&console.log(this.type+"end date:"+this.endDateObject.toUTCString()));let n=this.getProperty("filterDate");if(n){let t=$("#"+this.getFilterId(ID_FILTER_DATE)).val();if(t)if("all"==t)this.setDateRange(null,null);else if(t=new Date(t),"year"==n)this.setDateRange(new Date(t.getFullYear()+"-01-01"),new Date(t.getFullYear()+"-12-31"));else if("day"==n){let e=t.getUTCFullYear()+"-"+(t.getUTCMonth()+1)+"-"+t.getUTCDate(),i=new Date(e);this.setDateRange(i,i,!0)}}let h=this.getData();if(!t){if(null==h)return null;t=h.getRecords()}if(e||(e=h.getRecordFields()),(a.doGroup||this.requiresGrouping())&&(t=h.extractGroup(this.dataGroup,t)),s&&console.log("fitler #records:"+t.length),this.getProperty("filterLatest")){let e=this.getFieldsByIds(null,this.getProperty("filterLatest")),i={},a=[],s=[];t.forEach((t=>{if(!t.getTime())return;let a="";e.forEach((e=>{a+="_"+t.getValue(e.getIndex())}));let l=i[a];l?t.getDate().getTime()>l.getDate().getTime()&&(i[a]=t):(i[a]=t,s.push(a))})),s.forEach((t=>{a.push(i[t])})),t=a}if(t.forEach((t=>{t.clearHighlight(this)})),t=t.filter(((t,e)=>{let i=t.getDate();return!i||this.dateInRange(i,e<5&&s)})),s&&console.log("filter Fields:"+this.filters.length+" #records:"+t.length),this.filters.length){let e=[],i=this.getProperty("filterLogic","and");this.filters.forEach((t=>t.prepareToFilter(s))),s&&console.log("filter:"+this.filters.length),t.forEach(((t,r)=>{let o=!0,n=!1;this.filters.forEach((e=>{if(!e.isEnabled())return;e.isRecordOk(t,r<5&&s)?n=!0:o=!1}));let h="and"==i?o:n;a.skipFirst&&0==r&&(h=!0),l?(e.push(t),t.setHighlight(this,h)):(t.clearHighlight(this),h&&e.push(t))})),s=!1,t=e}s&&console.log("filterData-2 #records:"+t.length);let d=parseInt(this.getProperty("stride",-1));if(d<0){var p=parseInt(this.getProperty("maxDisplayedPoints",-1));if(p>0&&t.length>0)for(d=1;t.length/d>p;)d++}if(d>0){for(var g=[],c=0;c<t.length;c+=d+1)g.push(t[c]);t=g,s&&console.log("R-3:"+t.length)}if(t=this.filterDataPhase2(t),this.getProperty("filterPaginate")){let e=this.pageSkip||0,i=+this.getProperty("pageCount",1e3);if(e>0||i<t.length){let a=[],s=e;for(i=Utils.max(i,1e3);!(s<t.length||(s-=i,s<0)););s<0&&(s=0),s!=e&&this.updatePaginateLabel(e,i,t.length),e=s,console.log("skip:"+e+" count:"+i+" "+t.length);for(let s=e;s<t.length&&(a.push(t[s]),!(a.length>=i));s++);t=a}}if(this.getProperty("binDate")){let i=this.getProperty("binDate"),a=this.getProperty("binType","total"),s="count"==a,l=[],r=(t[0],{}),o={};this.binRecordToRecords={};let n={};for(c=0;c<t.length;c++){let a=t[c];var u,y=this.getDataValues(a),m=null;if("month"==i)u=a.getDate().getUTCFullYear()+"-"+(a.getDate().getUTCMonth()+1);else if("day"==i)u=a.getDate().getUTCFullYear()+"-"+(a.getDate().getUTCMonth()+1)+"-"+a.getDate().getUTCDate();else if("week"==i){var f=+Utils.formatDateWeek(a.getDate());u=a.getDate().getUTCFullYear()+"-"+f;var D=1+7*(f-1);m=new Date(a.getDate().getUTCFullYear(),0,D)}else u=a.getDate().getUTCFullYear()+"";if(Utils.isDefined(r[u])){let t=n[u];this.binRecordToRecords[t.getId()].records.push(a),o[u]++;var I=r[u];if(s){for(k=0;k<I.length;k++)I[k]++;continue}for(var T=a.getData(),b=0;b<T.length;b++){"number"==typeof(L=T[b])&&(isNaN(L)||(isNaN(I[b])?I[b]=L:I[b]+=L))}}else{o[u]=1;var S=m;m||(S=Utils.parseDate(u));var v=Utils.cloneList(a.getData());if(s)for(k=0;k<v.length;k++)v[k]=1;var x=new PointRecord(e,a.getLatitude(),a.getLongitude(),a.getElevation(),S,v);n[u]=x,this.binRecordToRecords[x.getId()]={records:[a]},r[u]=v,l.push(x)}}if("average"==a)for(u in o)for(y=r[u],b=0;b<y.length;b++){"number"==typeof(L=y[b])&&(isNaN(L)||(y[b]=L/o[u]))}t=l}this.requiresGeoLocation()&&(t=t.filter((t=>t.hasLocation())));let U=this.getDataFilters();if(U.length&&(t=t.filter(((t,e)=>!!this.checkDataFilters(U,t)))),t=this.sortRecords(t),this.getProperty("uniqueField")){let e=this.getFieldById(null,this.getProperty("uniqueField")),i={},a=[];for(c=t.length-1;c>=0;c--){var L=(E=t[c]).getValue(e.getIndex());Utils.isDefined(i[L])||(i[L]=!0,a.push(E))}t=a}this.recordToIndex={},this.indexToRecord={};for(c=0;c<t.length;c++){var E=t[c];this.recordToIndex[E.getId()]=c,this.indexToRecord[c]=E}let P=this.getProperty("convertDataPost");if(P){let e=new PointData("pointdata",h.getRecordFields(),t,null,{parent:h});this.pointData=(new CsvUtil).process(this,e,P),t=this.pointData.getRecords()}return s&&console.log("filtered:"+t.length),this.jq(ID_FILTER_COUNT).html("Count: "+t.length),this.filteredRecords=t,this.getSelectFirst()?this.propagateEventRecordSelection({record:t[0]}):this.getSelectLast()&&this.propagateEventRecordSelection({record:t[t.length-1]}),this.handleResult("filterData",t)},handleResult:function(t,e){return e},getBinnedRecords:function(t){return this.binRecordToRecords?this.binRecordToRecords[t.getId()].records:t.parentRecords},canDoGroupBy:function(){return!1},canDoMultiFields:function(){return!0},useChartableFields:function(){return!1},getFieldsToSelect:function(t){return this.useChartableFields()?t.getChartableFields(this):t.getRecordFields()},getGet:function(){return"getRamaddaDisplay('"+this.getId()+"')"},assembleWikiText:function(t){var e="";if(window.globalDisplayProperties)for(key in window.globalDisplayProperties)e+='{{displayProperty name="'+key+'" value="'+window.globalDisplayProperties[key]+'"}}\n';e+=this.getWikiText();for(var i=0;i<this.displays.length;i++){var a=this.displays[i];a.getIsLayoutFixed()||(e+=a.getWikiText())}return e},showWikiText:function(t){var e=this.assembleWikiText();HtmlUtils.setPopupObject(HtmlUtils.getTooltip()),e=e.replace(/</g,"&lt;").replace(/>/g,"&gt;"),e=HU.pre([STYLE,HU.css("max-width","500px","max-height","400px","overflow-x","auto","overflow-y","auto")],e),this.showDialog(e)},copyWikiText:function(t){Utils.copyText(this.assembleWikiText()),alert("Wiki text has been copied to the clipboard")},publish:function(t){null==t&&(t="wikipage");var e=[],i=prompt("Name","");if(null!=i){e.push("name"),e.push(i),e.push("type"),e.push(t);var a="";"wikipage"==t?a+='+section label="{{name}}"\n${extra}\n':"blogentry"==t&&(a="<wiki>\n"),a+="",a+=this.assembleWikiText(),"wikipage"==t&&(a+="-section\n\n");for(var s="",l=this.getChildEntries(),r=0;r<l.length;r++){s+=l[r].getId()+","}l.length>0&&(e.push("entries"),e.push(s)),"media_photoalbum"==t&&(a=""),e.push("description_encoded"),console.log(a),e.push(window.btoa(a));var o=HU.getUrl(ramaddaBaseUrl+"/entry/publish",e);window.open(o,"_blank")}},getChildEntries:function(t){for(var e={},i=[],a=0;a<this.displays.length;a++){var s=this.displays[a];if((t||!s.getIsLayoutFixed())&&s.getEntries){var l=s.getEntries();if(l)for(var r=0;r<l.length;r++)null==e[l[r].getId()]&&(e[l[r].getId()]=!0,i.push(l[r]))}}return i},copyDisplayedEntries:function(){for(var t=[],e=0;e<this.displays.length;e++){var i=this.displays[e];if(!i.getIsLayoutFixed()&&i.getEntries){var a=i.getEntries();if(a)for(var s=0;s<a.length;s++)t.push(a[s])}}return this.copyEntries(t)},defineWikiAttributes:function(t){for(var e=0;e<t.length;e++)this.wikiAttrs.indexOf(t[e])<0&&this.wikiAttrs.push(t[e])},getWikiAttributes:function(t){for(var e=0;e<this.wikiAttrs.length;e++){var i=this[this.wikiAttrs[e]];Utils.isDefined(i)&&(t.push(this.wikiAttrs[e]),t.push(i))}},getWikiText:function(){var t=["layoutHere","false","type",this.type,"column",this.getColumn(),"row",this.getRow()];this.getProperty("entryId")&&(t.push("entry"),t.push(this.getProperty("entryId"))),this.getWikiAttributes(t);var e=null;if(this.getEntries){var i=this.getEntries();i&&i.length>0&&(e=i[0].getId())}return e||(e=this.entryId),e&&(t.push("entry"),t.push(e)),"{{display "+HU.attrs(t)+"}}\n\n"},copyEntries:function(t){for(var e=[],i={},a=0;a<t.length;a++){null==i[(r=t[a]).getId()]&&(i[r.getId()]=r,e.push(r))}for(var s="",l=0;l<e.length;l++){var r;s+=(r=e[l]).getId()+","}var o=ramaddaBaseUrl+"/entry/copy?action.force=copy&from="+s;window.open(o,"_blank")},entryHtmlHasBeenDisplayed:async function(t){if(t.getIsGroup()){var e=this;await t.getChildrenEntries((function(i){var a=HU.open(TAG_OL,[ATTR_CLASS,"display-entrylist-list",ATTR_ID,e.getDomId(ID_LIST)]);a+=e.getEntriesTree(i),a+=HU.close(TAG_OL),e.jq(ID_GROUP_CONTENTS+t.getIdForDom()).html(a),e.addEntrySelect()}))}},getEntryHtml:function(t,e){let i={showHeader:!0,headerRight:!1,showDetails:this.getShowDetails(),showImage:!0};$.extend(i,e),e=i;let a=this.getEntryMenuButton(t),s="";if(e.showHeader){let i=a+SPACE+t.getLink(null,!0,["target","_entries"]);e.headerRight?s+=HU.leftRight(i,e.headerRight):s+=i}let l=HU.getUniqueId("entry_");s+=HU.div([ID,l],"");let r=t.getMetadata();if(i.showImage)if(t.isImage()){let e=HU.tag(TAG_IMG,["src",t.getImageUrl(),ATTR_CLASS,"display-entry-image"]);s+=HU.href(t.getResourceUrl(),e,["download",null])+"<br>"}else for(var o=0;o<r.length;o++)if("content.thumbnail"==r[o].type){let e,i=r[o].value.attr1;e=0==i.indexOf("http")?i:ramaddaBaseUrl+"/metadata/view/"+i+"?element=1&entryid="+t.getId()+"&metadata_id="+r[o].id+"&thumbnail=false",s+=HU.image(e,[ATTR_CLASS,"display-entry-thumbnail"])}t.getIsGroup()&&(s+=HU.div([ATTR_ID,this.getDomId(ID_GROUP_CONTENTS+t.getIdForDom())],"")),s+=HU.formTable(),e.showDetails&&(t.url&&(s+=HU.formEntry("URL:",HU.href(t.url,t.url))),t.remoteUrl&&(s+=HU.formEntry("URL:",HU.href(t.remoteUrl,t.remoteUrl))),t.remoteRepository&&(s+=HU.formEntry("From:",HU.href(t.remoteRepository.url,t.remoteRepository.name))));var n=t.getAttributes();t.getFilesize()>0&&(s+=HU.formEntry("File:",t.getFilename()+" "+HU.href(t.getResourceUrl(),HU.image(ramaddaCdn+"/icons/download.png"),["download",null])+" "+t.getFormattedFilesize()));for(var h=0;h<n.length;h++){var d=n[h],p=d.value;if((!d.getCanShow||d.getCanShow())&&!Utils.isFalse(d.canshow)){if(d.isUrl&&d.isUrl()){var g="",c=p.split("\n");for(o=0;o<c.length;o++){var u=c[o].trim();0!=u.length&&(g+=HU.href(u,u),g+="<br>")}p=g}s+=HU.formEntry(d.label+":",p)}}return s+=HU.close(TAG_TABLE),s},getEntriesTree:function(t,e){e||(e={});let i=this.getProperty("entryColumns",null);if(null!=i){let e=this.getProperty("columnNames",null);null!=e&&(e=e.split(",")),i=i.split(",");let a=[],s=[];for(let t=0;t<i.length;t++){let e=i[t].split(":"),l=null,r=null;e.length>1?"property"==e[0]?(r="property",l=i[t]):(l=e[0],r=e[1]):(l=i[t],r=l),a.push(l),s.push(r)}return i=a,null==e&&(e=s),this.getEntriesTable(t,i,e)}let a=e.suffix,s="";a?(s=a,a="'"+a+"'"):a="null";let l=getHandler(e.handlerId),r=e.showIndex,o="",n="entryrow_"+this.getId(),h=!0;null==this.entriesMap&&(this.entriesMap={});let d=this.getProperty("doWorkbench");for(let i=0;i<t.length;i++){h=!h;let p=t[i];this.entriesMap[p.getId()]=p;let g=this.makeEntryToolbar(p,l,e.handlerId),c=d?this.getEntryMenuButton(p):"",u=p.getDisplayName();u.length>100&&(u=u.substring(0,99)+"...");let y=p.getIconImage([ATTR_TITLE,"View entry"]),m=HU.tag(TAG_A,["target","_entries",ATTR_HREF,p.getEntryUrl()],y+" "+u);u="";let f=p.getIdForDom()+s,D=p.getId(),I=HU.image(icon_tree_closed,[ATTR_BORDER,"0","tree-open","false",ATTR_ID,this.getDomId(ID_TREE_LINK+f)]),T=this.getGet()+".toggleEntryDetails(event, '"+D+"',"+a+",'"+e.handlerId+"');",b=this.getGet()+".entryHeaderClick(event, '"+D+"',"+a+"); ",S=HU.onClick(T,I),v="";r&&(v="#"+(i+1)+" "),l&&l.getEntryPrefix&&(v+=l.getEntryPrefix(e.handlerId,p));let x=HU.div([ATTR_CLASS,"display-entrylist-name"],c+" "+S+" "+v+m+" "+u),U="";U=HU.div([ATTR_CLASS,"display-entrylist-details-snippet",ATTR_ID,this.getDomId(ID_DETAILS_SNIPPET+f)],p.getSnippet()||""),this.getProperty("showSnippetInList")&&(x+=U,U="");let L,E=HU.div([ATTR_CLASS,"display-entrylist-details-inner",ATTR_ID,this.getDomId(ID_DETAILS_INNER+f)],""),P=HU.div([ATTR_ID,this.getDomId(ID_DETAILS+f),ATTR_CLASS,"display-entrylist-details"],HU.div([ATTR_CLASS,"display-entrylist-details-ancestors",ATTR_ID,this.getDomId(ID_DETAILS_ANCESTORS+f)],"")+U+HU.div([ATTR_CLASS,"display-entrylist-details-tags",ATTR_ID,this.getDomId(ID_DETAILS_TAGS+f)],"")+E);L=d&&this.getProperty("showToolbar",!0)?HU.leftCenterRight(x,"",g,"80%","1%","19%"):x;let C=HU.div(["onclick",b,ATTR_ID,this.getDomId(ID_DETAILS_MAIN+f),ATTR_CLASS,"display-entrylist-entry-main entry-main-display-entrylist-"+(h?"even":"odd"),ATTR_ENTRYID,D],L);L=HU.div([CLASS,h?"ramadda-row-even":"ramadda-row-odd",ATTR_ID,this.getDomId("entryinner_"+f)],C+P),o+=HU.div([ATTR_ID,this.getDomId("entry_"+f),ATTR_ENTRYID,D,ATTR_CLASS,"display-entrylist-entry"+n],L),o+="\n"}return o},addEntrySelect:function(){var t=this,e=$("#"+this.getDomId(ID_DISPLAY_CONTENTS)+"  ."+this.getClass("entry-main"));e.unbind(),e.mouseover((async function(e){var i,a=$(this).attr(ATTR_ENTRYID);(await t.getEntry(a,(t=>{i=t})),i)?t.propagateEvent("entryMouseover",{entry:i}):console.log("no entry:"+a)})),e.mouseout((async function(e){let i,a=$(this).attr(ATTR_ENTRYID);if(await t.getEntry(a,(t=>{i=t})),!i)return;t.propagateEvent("entryMouseout",{entry:i});Utils.cleanId(a);let s=t.getEntryToolbarId(a);$("#"+s)})),this.madeList,this.madeList=!0},getEntriesTable:function(t,e,i){null==this.entriesMap&&(this.entriesMap={});var a=this.getProperty("columnWidths",null);null!=a&&(a=a.split(","));var s=HU.open(TAG_TABLE,[ATTR_WIDTH,"100%","cellpadding","0","cellspacing","0"]);s+=HU.open(TAG_TR,["valign","top"]);for(var l=0;l<i.length;l++)s+=HU.td([ATTR_ALIGN,"center",ATTR_CLASS,"display-entrytable-header"],i[l]);s+=HU.close(TAG_TR);for(l=0;l<t.length;l++){s+=HU.open(TAG_TR,["valign","top"]);var r=t[l];this.entriesMap[r.getId()]=r;for(var o=0;o<e.length;o++){var n=null;null!=a&&(n=a[o]);var h=e[o],d="";if("name"==h)d=HU.tag(TAG_A,[ATTR_HREF,r.getEntryUrl()],r.getName());else if(h.match(".*property:.*")){var p=h.substring("property:".length),g=r.getMetadata();d="";for(o=0;o<g.length;o++){var c=g[o];c.type==p&&(""!=d&&(d+="<br>"),d+=c.value.attr1)}}else"description"==h?d=r.getDescription():"date"==h?null==(d=r.ymd)&&(d=r.startDate):d=r.getAttributeValue(h);var u=[ATTR_CLASS,"display-entrytable-cell"];null!=n&&(u.push(ATTR_WIDTH),u.push(n)),s+=HU.td(u,d)}s+=HU.close(TAG_TR)}return s+=HU.close(TAG_TABLE)},makeEntryToolbar:function(t,e,i){var a=this.getGet(),s=[],l="{showMenu:true,showTitle:true}";"type_wms_layer"==t.getType().getId()&&s.push(HU.tag(TAG_A,["onclick",a+".addMapLayer("+HU.sqt(t.getId())+");"],HU.image(ramaddaCdn+"/icons/map.png",["border",0,ATTR_TITLE,"Add Map Layer"]))),"geo_shapefile"!=t.getType().getId()&&"geo_geojson"!=t.getType().getId()||s.push(HU.tag(TAG_A,["onclick",a+".addMapLayer("+HU.sqt(t.getId())+");"],HU.image(ramaddaCdn+"/icons/map.png",["border",0,ATTR_TITLE,"Add Map Layer"])));var r=this.getPointUrl(t);null!=r&&(r=r.replace(/\'/g,"_"),s.push(HU.tag(TAG_A,["onclick",a+".createDisplay("+HU.sqt(t.getFullId())+","+HU.sqt("table")+","+HU.sqt(r)+","+l+");"],HU.getIconImage("fa-table",[ATTR_TITLE,"Create Tabular Display"]))),s.push(HU.tag(TAG_A,["onclick",a+".createDisplay("+HU.sqt(t.getFullId())+","+HU.sqt("linechart")+","+HU.sqt(r)+","+l+");"],HU.getIconImage("fa-chart-line",[ATTR_TITLE,"Create Chart"]))));s.push(HU.tag(TAG_A,["onclick",a+".createDisplay("+HU.sqt(t.getFullId())+","+HU.sqt("entrydisplay")+","+HU.sqt(r)+","+l+");"],HU.getIconImage("fa-file",["border",0,ATTR_TITLE,"Show Entry"]))),t.getFilesize()>0&&s.push(HU.tag(TAG_A,[ATTR_HREF,t.getResourceUrl(),"download",null],HU.image(ramaddaCdn+"/icons/download.png",["border",0,ATTR_TITLE,"Download ("+t.getFormattedFilesize()+")"])));this.getEntryMenuButton(t);var o=[];e&&e.addToToolbar&&e.addToToolbar(i,t,s);for(var n=0;n<s.length;n++)o.push(HU.div([ATTR_CLASS,"display-entry-toolbar-item"],s[n]));return s=o,HU.div([ATTR_CLASS,"display-entry-toolbar",ATTR_ID,this.getEntryToolbarId(t.getIdForDom())],HU.join(s,""))},getEntryToolbarId:function(t){var e=t.replace(/:/g,"_").replace(/\//g,"_").replace(/[\(\)]/g,"_");return e=e.replace(/=/g,"_"),this.getDomId(ID_TOOLBAR+"_"+e)},hideEntryDetails:function(t){},entryHeaderClick:function(t,e,i){var a=t.target;a.outerHTML&&0!=a.outerHTML.indexOf("<div")||this.toggleEntryDetails(t,e)},makeEntryTags:function(t,e,i,a){i=i||"";let s="",l={},r=[];return t.getMetadata().forEach((t=>{if(["content.pagestyle","content.pagetemplate","content.thumbnail","content.attachment"].includes(t.type))return;if(t.type.startsWith("map"))return;if(t.type.startsWith("spatial"))return;let o=t.label+": "+t.value.attr1,n=String(t.value.attr1);"property"==t.type&&(o+=":"+t.value.attr2,n+=":"+t.value.attr2),n.length>20&&(n=n.substring(0,19)+"..."),n=i+n;let h=Utils.getUniqueId("metadata_"),d=HU.div(["metadata-type",t.type,"metadata-value",t.value.attr1,ID,h,CLASS,"display-search-tag",TITLE,o,STYLE,HU.css("background",getMetadataColor(t.type))],n);e?(l[t.type]||(l[t.type]=[],r.push(t)),l[t.type].push(d)):s+=d,a&&(a[h]=t)})),e&&r.forEach((t=>{s+=t.label+": "+l[t.type].join(" "),s+="<br>"})),s},toggleEntryDetails:async function(t,e,i,a,s){if(!s)return void await this.getEntry(e,(s=>{this.toggleEntryDetails(t,e,i,a,s)}));null==i&&(i="");let l=this.jq(ID_TREE_LINK+s.getIdForDom()+i),r=ID_DETAILS+s.getIdForDom()+i,o=this.jq(r);if(t&&t.shiftKey){let t=Utils.cleanId(e),i=this.jq(ID_DETAILS_MAIN+t);this.selectedEntriesFromTree||(this.selectedEntriesFromTree={});let a="true"==i.attr("ramadda-selected");return a?(i.removeClass("display-entrylist-entry-main-selected"),i.attr("ramadda-selected","false"),this.selectedEntriesFromTree[s.getId()]=null):(i.addClass("display-entrylist-entry-main-selected"),i.attr("ramadda-selected","true"),this.selectedEntriesFromTree[s.getId()]=s),void this.propagateEvent(DisplayEvent.entrySelection,{entry:s,selected:!a})}let n="true"==l.attr("tree-open");n?l.attr("src",icon_tree_closed):l.attr("src",icon_tree_open),l.attr("tree-open",n?"false":"true");let h=()=>{n?o.hide():o.show(),t&&t.stopPropagation&&t.stopPropagation()},d=this,p=null!=o.attr("has-content");if(o.attr("has-content","true"),p)return void h();let g=this.jq(ID_DETAILS_INNER+s.getIdForDom()+i);if(!s.isSynth()&&s.getIsGroup()){g.html(HU.image(icon_progress));let t=function(t){d.displayChildren(s,t,i,a)};s.getChildrenEntries(t)}else g.html(this.getEntryHtml(s,{showHeader:!1}));h();let c={},u=s.isSynth()?"":HU.getIconImage("fas fa-search")+SPACE,y=this.makeEntryTags(s,!1,u,c),m=this.jq(ID_DETAILS_TAGS+s.getIdForDom()+i),f=$(HU.span([CLASS,"display-search-tag"],u+"Type: "+s.getType().getLabel())).appendTo(m);s.isSynth()||f.click((function(){d.typeTagClicked(s.getType())}));let D=$(y).appendTo(m);if(s.isSynth()||D.click((function(){d.metadataTagClicked(c[$(this).attr("id")])})),!s.isSynth()&&this.getProperty("showEntryBreadcrumbs",!0)){let t="",e=a=>{if(a){let i=a.getLink(null,!1,["target","_entries"]);""!=t&&(i+=HU.div([CLASS,"breadcrumb-delimiter"])),t=i+t,a.getParentEntry(e)}else this.jq(ID_DETAILS_ANCESTORS+s.getIdForDom()+i).html(t)};s.getParentEntry(e)}},metadataTagClicked:function(t){},typeTagClicked:function(t){},getSelectedEntriesFromTree:function(){var t=[];if(this.selectedEntriesFromTree)for(var e in this.selectedEntriesFromTree){var i=this.selectedEntriesFromTree[e];null!=i&&t.push(i)}return t},displayChildren:function(t,e,i,a){i||(i="");let s=this.jq(ID_DETAILS_INNER+t.getIdForDom()+i),l=this.getEntryHtml(t,{showHeader:!1,showImage:0==e.length});if(0==e.length)s.html(l);else{let t=l;this.showDetailsForGroup&&(t+=l),t+=this.getEntriesTree(e,{handlerId:a}),s.html(t),this.addEntrySelect()}},getEntryMenuButton:function(t){return HU.onClick(this.getGet()+".showEntryMenu(event, '"+t.getId()+"');",HU.image(ramaddaCdn+"/icons/menu.png",[ATTR_CLASS,"display-entry-toolbar-item",ATTR_ID,this.getDomId(ID_MENU_BUTTON+t.getIdForDom())]))},setOriginalRamadda:function(t){this.originalRamadda=t},setRamadda:function(t){this.ramadda=t},getRamadda:function(){return null!=this.ramadda?this.ramadda:null!=this.ramaddaBaseUrl?(this.ramadda=getRamadda(this.ramaddaBaseUrl),this.ramadda):getGlobalRamadda()},getEntry:async function(t,e){if(this.entriesMap&&this.entriesMap[t])return Utils.call(e,this.entriesMap[t]);var i=this.getRamadda(),a=t.split(",");2==a.length&&(t=a[1],i=getRamadda(a[0]));var s=null;return null!=this.entryList&&await this.entryList.getEntry(t,(t=>s=t)),null==s&&await i.getEntry(t,(t=>s=t)),null==s&&await this.getRamadda().getEntry(t,(t=>s=t)),Utils.call(e,s)},addMapLayer:async function(t){var e;await this.getEntry(t,(t=>{e=t})),null!=e?this.getDisplayManager().addMapLayer(this,e):console.log("No entry:"+t)},doit:function(){console.log("doit")},createDisplay:async function(t,e,i,a){var s;if(await this.getEntry(t,(t=>{s=t})),null==s)return console.log("No entry:"+t),null;var l={sourceEntry:s,entryId:s.getId(),showDetails:!0,title:s.getName(),layoutHere:!1};if(a&&$.extend(l,a),e!=DISPLAY_ENTRYLIST){null==i&&(i=this.getPointUrl(s));var r={entry:s,entryId:s.getId()};l.data=new PointData(s.getName(),null,null,i,r)}null!=this.lastDisplay?(l.column=this.lastDisplay.getColumn(),l.row=this.lastDisplay.getRow()):(l.column=this.getProperty("newColumn",this.getColumn()),l.row=this.getProperty("newRow",this.getRow())),this.lastDisplay=this.getDisplayManager().createDisplay(e,l)},getPointUrl:function(t){let e=t.getService("points.json");return null!=e?e.url:(e=t.getService("grid.point.json"),null!=e?e.url:null)},getEntryMenu:async function(t,e){var i;if(await this.getEntry(t,(t=>{i=t})),null==i)return Utils.call(e,"null entry");var s=this.getGet(),l=[],r=[],o=[],n=[];o.push(HU.tag(TAG_LI,[],HU.tag(TAG_A,["href",i.getEntryUrl(),"target","_"],"View Entry"))),i.getFilesize()>0&&r.push(HU.tag(TAG_LI,[],HU.tag(TAG_A,["download",null,"href",i.getResourceUrl()],"Download "+i.getFilename()+" ("+i.getFormattedFilesize()+")"))),null!=this.jsonUrl&&r.push(HU.tag(TAG_LI,[],"Data: "+HU.onClick(s+".fetchUrl('json');","JSON")+HU.onClick(s+".fetchUrl('csv');","CSV")));var h="{showMenu:true,showTitle:true}",d="<a>New</a><ul>";d+=HU.tag(TAG_LI,[],HU.onClick(s+".createDisplay('"+i.getFullId()+"','entrydisplay',null,null,"+h+");","New Entry Display")),n.push(HU.tag(TAG_LI,[],HU.onClick(s+".createDisplay('"+i.getFullId()+"','entrydisplay',null,null,"+h+");","New Entry Display")));var p=this.getPointUrl(i);if(null!=p){var g=window.globalDisplayTypes,c={};if(g)for(var u=0;u<g.length;u++){var y=g[u];if(y.requiresData&&y.forUser){Utils.isDefined(c[y.category])||(c[y.category]="<li> <a>"+y.category+"</a><ul>\n"),p=p.replace(/\'/g,"_");var m=s+".createDisplay("+HU.sqt(i.getFullId())+","+HU.sqt(y.type)+","+HU.sqt(p)+",null,"+h+");",f=HU.tag(TAG_LI,[],HU.tag(TAG_A,["onclick",m],y.label));c[y.category]+=f+"\n",n.push(f)}}for(a in c)d+=c[a]+"</li></ul>"}r.length>0&&l.push("<a>File</a>"+HU.tag(TAG_UL,[],HU.join(r))),o.length>0&&l.push("<a>View</a>"+HU.tag(TAG_UL,[],HU.join(o))),n.length>0&&l.push(d);var D="";for(u=0;u<l.length;u++)D+=HU.tag(TAG_LI,[],l[u]);e(HU.tag(TAG_UL,[ATTR_ID,this.getDomId(ID_MENU_INNER+i.getIdForDom()),ATTR_CLASS,"sf-menu"],D))},showEntryMenu:async function(t,e){var i;await this.getEntryMenu(e,(t=>{i=t})),this.writeHtml(ID_MENU_OUTER,i);var a=this.getDomId(ID_MENU_BUTTON+Utils.cleanId(e));this.dialog=HU.makeDialog({content:i,anchor:a,draggable:!1,header:!1}),$("#"+this.getDomId(ID_MENU_INNER+Utils.cleanId(e))).superfish({speed:"fast",delay:300})},fetchUrl:function(t,e){null==e&&(e=this.jsonUrl),null!=(e=this.getDisplayManager().getJsonUrl(e,this))&&(null!=t&&"json"!=t&&(e=e.replace("points.json","points."+t)),window.open(e,"_blank"))},getMenuItems:function(t){},getDisplayMenuSettings:function(){var t="getRamaddaDisplay('"+this.getId()+"')",e=HU.onClick(t+".moveDisplayRight();","Right"),i=HU.onClick(t+".moveDisplayLeft();","Left"),a=HU.onClick(t+".moveDisplayTop();","Top"),s=HU.onClick(t+".moveDisplayUp();","Up"),l=HU.onClick(t+".moveDisplayDown();","Down"),r=HU.open(TABLE,[CLASS,"formtable"])+"<tr><td align=right><b>Move:</b></td><td>"+a+" "+s+" "+l+" "+e+" "+i+"</td></tr><tr><td align=right><b>Row:</b></td><td> "+HU.input("",this.getProperty("row",""),["size","7",ATTR_ID,this.getDomId("row")])+" &nbsp;&nbsp;<b>Col:</b> "+HU.input("",this.getProperty("column",""),["size","7",ATTR_ID,this.getDomId("column")])+"</td></tr><tr><td align=right><b>Width:</b></td><td> "+HU.input("",this.getProperty("width",""),["size","7",ATTR_ID,this.getDomId("width")])+"  <b>Height:</b> "+HU.input("",this.getProperty("height",""),["size","7",ATTR_ID,this.getDomId("height")])+"</td></tr></table>",o=HU.checkbox(this.getDomId("showtitle"),[],this.getProperty("showTitle"))+" Title  "+HU.checkbox(this.getDomId("showdetails"),[],this.getProperty("showDetails"))+" Details &nbsp;&nbsp;&nbsp;"+HU.onClick(t+".askSetTitle();","Set Title");return r+=HU.formTable()+HU.formEntry("Show:",o)+HU.close(TABLE)},loadInitialData:function(){this.getProperty("okToLoadData",!0)&&this.needsData()&&null!=this.properties.theData&&(this.getProperty("latitude")&&(this.properties.theData.lat=this.getProperty("latitude"),this.properties.theData.lon=this.getProperty("longitude","-105")),this.properties.theData.hasData()?this.addData(this.properties.theData):this.properties.theData.loadData(this))},getData:function(){if(!this.hasData()){if(!this.properties.dataSrc)return null;this.addData(makeInlineData(this,this.properties.dataSrc))}return this.dataCollection.getList()[0]},hasData:function(){return null!=this.dataCollection&&this.dataCollection.hasData()},getCreatedInteractively:function(){return 1==this.createdInteractively},needsData:function(){return!1},askSetTitle:function(){var t=this.getTitle(!1),e=prompt(TITLE,t);null!=e&&(this.title=e,this.setProperty(ATTR_TITLE,e),this.setDisplayTitle(this.title))},getShowDetails:function(){return this.getSelfProperty("showDetails",!0)},setShowDetails:function(t){this.showDetails=t,this.showDetails?this.jq(ID_DETAILS).show():this.jq(ID_DETAILS).hide()},setShowTitle:function(t){("true"===t||"false"===t)&&(t=!0),this.setProperty("showTitle",t),t?this.jq(ID_TITLE).show():this.jq(ID_TITLE).hide()},setDisplayProperty:function(t,e){this.setProperty(t,e),$("#"+this.getDomId(t)).val(e)},deltaColumn:function(t){var e=parseInt(this.getProperty("column",0));(e+=t)<0&&(e=0),this.setDisplayProperty("column",e),this.getLayoutManager().layoutChanged(this),this.jq("col").val(e)},deltaRow:function(t){var e=parseInt(this.getProperty("row",0));isNaN(e)&&(e=0),(e+=t)<0&&(e=0),this.setDisplayProperty("row",e),this.getLayoutManager().layoutChanged(this),this.jq("row").val(e)},moveDisplayRight:function(){this.getLayoutManager().isLayoutColumns()?this.deltaColumn(1):this.getLayoutManager().moveDisplayDown(this)},moveDisplayLeft:function(){this.getLayoutManager().isLayoutColumns()?this.deltaColumn(-1):this.getLayoutManager().moveDisplayUp(this)},moveDisplayUp:function(){this.getLayoutManager().isLayoutRows()?this.deltaRow(-1):this.getLayoutManager().moveDisplayUp(this)},moveDisplayDown:function(){this.getLayoutManager().isLayoutRows()?this.deltaRow(1):this.getLayoutManager().moveDisplayDown(this)},moveDisplayTop:function(){this.getLayoutManager().moveDisplayTop(this)},getDialogContents:function(t,e){this.getDisplayDialogContents(t,e)},getDisplayDialogContents:function(t,e){this.getGet();var i=[];this.getMenuItems(i);var a="<form>";a+=this.getDisplayMenuSettings();for(var s=0;s<i.length;s++)a+=HU.div([ATTR_CLASS,"display-menu-item"],i[s]);a+="</form>",t.push("Display"),e.push(a)},checkLayout:function(){},displayData:function(){},setDisplayReady:function(){var t=!this.displayReady;this.displayReady=!0,t&&this.callUpdateUI({force:!0})},getDisplayReady:function(){return this.displayReady},pageHasLoaded:function(){this.displayReady||this.setDisplayReady(!0)},checkFinished:function(){return!1},getIsFinished(){return this.isFinished},setIsFinished(){this.isFinished=!0},isDisplayFinished:function(){return this.checkFinished()?this.getIsFinished():!(!this.hasData()&&this.needsData())},doFinalInitialization:function(){},initDisplay:function(){this.inError||(this.createUI(),this.getAnimation().getEnabled()&&this.getAnimation().makeControls(),this.checkSearchBar(),this.callUpdateUI({force:!0}),this.getProperty("reloadSeconds")&&this.runReload())},runReload:function(){setTimeout((()=>{this.reloadData(),this.runReload()}),1e3*this.getProperty("reloadSeconds"))},getMainDiv:function(){this.getProperty("targetDiv",this.getProperty(PROP_DIVID,null,null,!0),null,!0);return $("#"+divid)},getGroupDiv:function(){return $("#"+this.getProperty("groupDiv"))},createUI:function(){let t=this.getProperty("targetDiv",this.getProperty(PROP_DIVID,null,null,!0),null,!0);if(null!=t){var e=this.getHtml();let i=$("#"+t);this.getProperty("displayInline")&&(i.css("display","inline-block"),i.css("vertical-align","bottom"));let a=this.getWidth("100%");a&&"-1"!=a&&i.css("width",HU.getDimension(a)),i.html(e)}else console.log("error: no div defined for display:"+this.getType())},getHtml:function(){let t=this.getGet(),e="";this.getShowMenu()&&(e=HU.onClick(t+".showDialog();",HU.image(ramaddaCdn+"/icons/downdart.png",[ATTR_CLASS,"display-dialog-button",ATTR_ID,this.getDomId(ID_MENU_BUTTON)])),e+=" "),this.getShowProgress(!1);let i="";this.getShowTitle()&&(i=this.getTitle(!1).trim());let a="";if(""!=e||""!=i){let t=this.getTitleHtml(i);a=""==e?t:HU.div(["class","display-header"],e+SPACE+t)}a=HU.div([ID,this.getDomId(ID_TOP_LEFT),CLASS,"display-header-block"],a);let s=this.getAnimationEnabled(),l=HU.div([ID,this.getDomId(ID_HEADER1),CLASS,"display-header-block display-header1"],""),r=HU.div([ID,this.getDomId(ID_HEADER2),CLASS,"display-header-block display-header2"],""),o=HU.div([ID,this.getDomId(ID_TOP),CLASS,"display-header-block"],s?"":r),n=HU.div([ID,this.getDomId(ID_TOP_RIGHT)],""),h=this.getProperty("showHeader",!0)?HU.leftCenterRight(a,o,n,null,null,null,{valign:"bottom"}):"",d=l;s&&(d+=r),h=d+h;let p=HU.div([ID,this.getDomId(ID_COLORTABLE)]),g="",c="",u=HU.div([ATTR_CLASS,"",ATTR_ID,this.getDomId(ID_BOTTOM)]),y=HU.div([ID,this.getDomId(ID_LEGEND)]),m=this.getProperty("colorTableSide","bottom");"top"==m?h+=p:"right"==m?g+=p:"left"==m?c+=p:u+=p,u+=y;let f="";this.getProperty("leftSideWidth")&&(f=HU.css("width",HU.getDimension(this.getProperty("leftSideWidth"))));let D=HU.div([ATTR_ID,this.getDomId(ID_LEFT),STYLE,f],c),I=HU.div([ATTR_ID,this.getDomId(ID_RIGHT)],g),T="1%",b="98%",S=this.getContentsDiv(),v=HU.open("table",[STYLE,"border:1px solid transparent;",CLASS,"display-ui-table","width","100%","border","0","cellpadding","0","cellspacing","0"]);this.getProperty("showDisplayTop",!0)&&(v+=HU.tr([],HU.td(["width",T])+HU.td(["width",b],h)+HU.td(["width",T]))),v+=HU.tr(["valign","top"],HU.td(["width",T],D)+HU.td(["width",b],S)+HU.td(["width",T],I)),this.getProperty("showDisplayBottom",!0)&&(v+=HU.tr([],HU.td(["width",T])+HU.td(["width",b],u)+HU.td(["width",T]))),v+=HU.close("table");let x=HU.div([ID,this.domId(ID_DISPLAY_MESSAGE),CLASS,"display-output-message",STYLE,HU.css("display","none","position","absolute","top","10px","left","50%","-webkit-transform","translateX(-50%)","transform","translateX(-50%)")],"message"),U=HU.div([ATTR_CLASS,"ramadda-popup",STYLE,"display:none;",ATTR_ID,this.getDomId(ID_MENU_OUTER)],""),L=this.getProperty("displayStyle","");return U+=HU.div([CLASS,"display-contents display-"+this.type+"-contents",STYLE,HU.css("position","relative")+L],v+x),U},getWidthForStyle:function(t){var e=this.getProperty("width",-1);return-1==e?t:HU.getDimension(e)},getHeightForStyle:function(t){let e=this.getProperty("height",-1);return-1==e?t:(new String(e).match("^[0-9]+$")&&(e+="px"),e)},getContentsStyle:function(){let t="",e=this.getHeightForStyle();e&&(t+=HU.css(HEIGHT,e));let i=this.getProperty("maxHeight");return i&&(t+=HU.css("max-height",HU.getDimension(i),"overflow-y","auto")),t},getContentsClass:function(){return"ramadda-expandable-target display-contents-inner display-"+this.type},getContentsDiv:function(){let t=this.getContentsStyle();t+=this.getProperty("contentsStyle","");let e=this.getProperty("backgroundImage");e&&(e=HU.getEntryImage(this.entryId,e),t+=HU.css("background-attachment","auto","background-size","100% auto","background-image","url('"+e+"')"));let i=this.getProperty("background");i&&(t+=HU.css("background",i));let a=HU.div([STYLE,"",ATTR_ID,this.getDomId(ID_DISPLAY_TOP)],""),s=HU.div([STYLE,"",ATTR_ID,this.getDomId(ID_DISPLAY_BOTTOM)],""),l=this.getProperty("expandedHeight");l&&(t+=HU.css(HEIGHT,l));let r=[ATTR_CLASS,this.getContentsClass(),STYLE,t,ATTR_ID,this.getDomId(ID_DISPLAY_CONTENTS)];return this.getProperty("expandableHeight")&&(r.push("expandable-height"),r.push(this.getProperty("expandableHeight"))),a+"\n"+HU.div(r,"")+"\n"+s},prepareToLayout:function(){this.getColumn(),this.getWidth(),this.getHeight(),this.getName(),this.getEventSource()},getColumn:function(){return this.getFormValue("column",0)},getRow:function(){return this.getFormValue("row",0)},getWidth:function(t){return this.getFormValue("width",t)},getHeight:function(){return this.getFormValue("height",0)},getDisplayTitle:function(t){t||(t=null!=this.title?this.title:"");var e=t,i=this.lastSelectedFields;return e=i&&i.length>0?e.replace("{field}",i[0].getLabel()):e.replace("{field}",HU.span([ID,this.getDomId(ID_TITLE_FIELD)],"&nbsp;"))},setDisplayTitle:function(t){Utils.stringDefined(t)||(t=this.getTitle(!1).trim());var e=this.getTitleHtml(t);this.getShowTitle()?this.jq(ID_TITLE).show():this.jq(ID_TITLE).hide(),this.writeHtml(ID_TITLE,e)},getTitle:function(t){var e="";t&&this.hasEntries()&&(e=this.getEntryMenuButton(this.getEntries()[0])+" ");var i=this.getProperty(ATTR_TITLE);if(null!=i)return e+i;if(null==this.dataCollection)return e;var a=this.dataCollection.getList();i="";for(var s=0;s<a.length;s++){s>0&&(i+="/"),i+=a[s].getName()}return e+i},getIsLayoutFixed:function(){return this.getProperty(PROP_LAYOUT_HERE,!0)},makeToolbar:function(t){var e="",i=this.getGet(),a=t.addLabel,s=[],l=[],r=[];this.getIsLayoutFixed()||(l.push("removeRamaddaDisplay('"+this.getId()+"')"),s.push("fa-cut"),r.push("Delete display")),l.push(i+".copyDisplay();"),s.push("fa-copy"),r.push("Copy Display"),null!=this.jsonUrl&&(l.push(i+".fetchUrl('json');"),s.push(ramaddaCdn+"/icons/json.png"),r.push("Download JSON"),l.push(i+".fetchUrl('csv');"),s.push(ramaddaCdn+"/icons/csv.png"),r.push("Download CSV"));for(var o=0;o<l.length;o++){var n=HU.getIconImage(s[o],[ATTR_TITLE,r[o],ATTR_CLASS,"display-dialog-header-icon"]);a&&(n+=" "+r[o]+"<br>"),e+=HU.onClick(l[o],n)}return e},getHeader2:function(){return""},initHeader2:function(){},writeHeader:function(t,e){""==e?this.jq(t).css("display","none"):this.jq(t).css("display","inline-block"),this.jq(t).html(e)},checkLayout:function(){let t=this.jq(ID_DISPLAY_CONTENTS).width();this.lastWidth!=t&&(this.lastWidth=t,this.displayData())},forceUpdateUI:function(){this.haveCalledUpdateUI=!1,this.callUpdateUI()},callUpdateUI:function(t){t=t||{};try{t.force&&(this.haveCalledUpdateUI=!1),this.updateUI(t)}catch(t){this.handleError("Error:"+t,t)}},updateUI:function(t){},getFilterId:function(t){return this.getDomId("filterby_"+t)},getRequestMacros:function(){return this.requestMacros||(this.requestMacros=this.getRequestMacrosInner()),this.requestMacros},getRequestMacrosInner:function(){let t=[],e=this.getProperty("requestFields",""),i=this.getProperty("extraFields1",""),a=this.getProperty("extraFields2","");return Utils.mergeLists(i.split(","),e.split(","),a.split(",")).forEach((e=>{""!=e&&t.push(new RequestMacro(this,e))})),t},applyRequestProperties:function(t){t&&(this.requestMacros=null,this.dynamicProperties=t,this.createRequestProperties())},createRequestProperties:function(){let t="",e=this.getRequestMacros(),i=[];e.forEach((e=>{t+=e.getWidget(i)+"&nbsp;&nbsp;",e.isVisible()&&(t+=SPACE2)})),this.writeHeader(ID_REQUEST_PROPERTIES,t);let a=(t,e,i)=>{if(this.settingMacroValue)return;if(t.triggerReload&&(this.macroChanged(),this.reloadData()),!t.name)return;this.settingMacroValue=!0;let a={entryId:this.entryId,property:"macroValue",id:t.name,what:i,value:e};this.propagateEvent(DisplayEvent.propertyChanged,a),this.settingMacroValue=!1};i.forEach((t=>{HU.datePickerInit(t)})),this.jq(ID_HEADER2).find(".display-request-reload").click((()=>{a({triggerReload:!0})})),e.every((t=>($("#"+this.getDomId(t.getId())+",#"+this.getDomId(t.getId()+"_min")+",#"+this.getDomId(t.getId()+"_max")+",#"+this.getDomId(t.getId()+"_from")+",#"+this.getDomId(t.getId()+"_to")).keyup((function(e){13==(e.keyCode||e.which)&&a(t,$(this).val())})),"bounds"==t.type&&this.jq(t.getId()).change((function(e){a(t,$(this).is(":checked"))})),"enumeration"==t.type&&this.jq(t.getId()).change((function(e){a(t,$(this).val())})),this.jq(t.getId()+"_min").change((function(t){})),this.jq(t.getId()+"_max").change((function(t){})),this.jq(t.getId()+"_from").change((function(e){a(t,$(this).val(),"from")})),this.jq(t.getId()+"_to").change((function(e){a(t,$(this).val(),"to")})),!0)))},makeFilterWidget:function(t,e,i){return t?HU.div([CLASS,"display-filter-widget"],this.makeFilterLabel(t,i)+(0==t.trim().length?" ":": ")+e):HU.div([CLASS,"display-filter-widget"],e)},makeFilterLabel:function(t,e,i){let a="display-filter-label";i&&(a+=" display-filter-label-vertical ");let s=[CLASS,a];return e&&(s.push(TITLE),s.push(e)),HU.span(s,t)},stepFilterDateAnimation:function(t,e){let i=$("#"+this.getFilterId(ID_FILTER_DATE)),a=i[0].selectedIndex;a+=e,a>=i.find("option").length||a<0||(i[0].selectedIndex=a,t(i),this.filterDatePlayingAnimation&&setTimeout((()=>{this.stepFilterDateAnimation(t,1)}),this.getProperty("filterDateAnimationSleep",1e3)))},addFilters:function(t){},initializeRangeSlider:function(t,e,i){let a=this;t.mousedown((function(){let t=$(this).attr(ID);t.endsWith("_min")?t=t.replace(/_min$/,""):t.endsWith("_max")&&(t=t.replace(/_max$/,""));let s=$("#"+t+"_min"),l=$("#"+t+"_max"),r={min:parseFloat(s.attr("data-min")),max:parseFloat(l.attr("data-max"))},o=String(s.attr("data-min")).replace(/.*\./,""),n=String(l.attr("data-max")).replace(/.*\./,""),h=Math.max(o.length,n.length),d=parseFloat(s.val()),p=parseFloat(l.val()),g=HU.div([ID,"filter-range",STYLE,HU.css("width","200px")],""),c=HtmlUtils.getTooltip();c.html(g),c.show(),c.position({of:s,my:"left top",at:"left bottom+2",collision:"fit fit"}),isNaN(d)&&(d=r.min),isNaN(p)&&(p=r.max);var u=1;parseInt(r.max)==r.max&&parseInt(r.min)==r.min||(u=(r.max-r.min)/1e5),$("#filter-range").slider({range:!0,min:r.min,max:r.max,step:u,values:[d,p],slide:function(t,a){let r=String(Utils.roundDecimals(a.values[0],h)),o=String(Utils.roundDecimals(a.values[1],h));r.endsWith(".")&&(r=r.replace(/\./,"")),o.endsWith(".")&&(o=o.replace(/\./,"")),s.val(r),l.val(o),s.attr("data-value",s.val()),l.attr("data-value",l.val()),i&&e(s,l)},stop:function(){HtmlUtils.getTooltip().hide(),a.checkFilterField(l),e(s,l)}})}))},getRecordFilter:function(t){if(this.filters)for(let e=0;e<this.filters.length;e++){let i=this.filters[e];if(i.field&&i.field.getId()==t)return this.filters[e]}return null},checkSearchBar:function(){let t=this.getProperty("hideFilterWidget",!1,!0),e="vertical"==this.getProperty("headerOrientation","horizontal"),i="display-filter",a=displayDebug.checkSearchBar;a&&console.log("checkSearchBar");let s=this,l=this.getFieldById(null,this.getProperty("colorBy",""));this.colorByFields=this.getFieldsByIds(null,this.getProperty("colorByFields","",!0)),this.sizeByFields=this.getFieldsByIds(null,this.getProperty("sizeByFields","",!0)),this.sortByFields=this.getFieldsByIds(null,this.getProperty("sortByFields","",!0));let r=this.getData();if(null==r)return;r.getRecordFields();let o=r.getRecords();o=this.sortRecords(o);let n="";if(this.getShowProgress(!1)&&(n+=HU.div([ID,this.getDomId(ID_DISPLAY_PROGRESS),STYLE,HU.css("display","inline-block","margin-right","4px","min-width","20px")])),n+=HU.div([CLASS,"display-header-span"],""),n+=HU.div([ID,this.getDomId(ID_HEADER2_PREPREPREFIX),CLASS,"display-header-span"],""),n+=HU.div([ID,this.getDomId(ID_HEADER2_PREPREFIX),CLASS,"display-header-span"],""),n+=HU.div([ID,this.getDomId(ID_HEADER2_PREFIX),CLASS,"display-header-span"],""),n+=this.getHeader2(),(this.getProperty("pageRequest",!1)||this.getProperty("filterPaginate"))&&(n+=HU.div([CLASS,"display-header-span display-filter",ID,this.getDomId(ID_PAGE_COUNT)])),n+=HU.div([ID,this.getDomId(ID_REQUEST_PROPERTIES),CLASS,"display-header-span"],""),this.getProperty("legendFields")||this.getProperty("showFieldLegend",!1)){let t=this.getColorList(),e=this.getFieldsByIds(null,this.getProperty("legendFields",this.getPropertyFields(this.getProperty("sumFields")))),i="",a=0;e.forEach((e=>{a>=t.length&&(a=0);let s=t[a];i+=HU.div([STYLE,HU.css("display","inline-block","width","8px","height","8px","background",s)])+" "+e.getLabel()+"&nbsp;&nbsp; ",a++})),n+=i}if(this.getProperty("showDisplayFieldsMenu",!1)){let t=r.getChartableFields();if(t.length){let e=this.getSelectedFields(),a=[];e.forEach((t=>a.push(t.getId())));let s=[];t.forEach((t=>{t.isFieldGeo()||s.push([t.getId(),t.getLabel()])}));let l=[ID,this.getDomId("displayfields")];this.getProperty("displayFieldsMenuMultiple",!1)&&(l.push("multiple"),l.push("true"),l.push("size"),l.push("4")),this.displayFieldsMenuEnums=s;let r=HU.span([CLASS,i],this.makeFilterLabel("Display: ")+HU.select("",l,s,a))+SPACE;"left"==this.getProperty("displayFieldsMenuSide","top")?this.jq(ID_LEFT).append(r):n+=r}}let h=this.getProperty("selectFields"),d=[];if(h&&h.split(";").forEach((t=>{let[e,a,s]=t.split(":");null==s&&(s=a,a=Utils.makeLabel(e));let l=this.getFieldsByIds(null,s),r=[];l.forEach((t=>{t.isFieldGeo()||r.push([t.getId(),t.getLabel()])})),n+=HU.span([CLASS,i],(""==a?"":this.makeFilterLabel(a+": "))+HU.select("",[ID,this.getDomId("fieldselect_"+e)],r,this.getProperty(e,"")))+SPACE,d.push(e)})),this.colorByFields.length>0){let t=[];this.colorByFields.forEach((e=>{e.isFieldGeo()||t.push([e.getId(),e.getLabel()])}));let e=l?l.getId():"";n+=HU.span([CLASS,i],this.makeFilterLabel(this.getProperty("colorByLabel","Color by: "))+HU.select("",[ID,this.getDomId("colorbyselect")],t,e))+SPACE}let p=this.getProperty("sortAscending",!0);if(this.sortByFields.length>0){let t=[];this.sortByFields.forEach((e=>{if(e.isFieldGeo())return;let i=e.getId(),a=e.getLabel();Utils.stringDefined(e.getGroup())&&(a=e.getGroup()+"-"+a);let s=" &uarr;",l=" &darr;";e.isFieldString()&&(s="A-Z",l="Z-A"),p||e.isFieldString()?(t.push([i+"_up",a+" "+s]),t.push([i+"_down",a+" "+l])):(t.push([i+"_down",a+" "+l]),t.push([i+"_up",a+" "+s]))})),n+=HU.span([CLASS,i],this.makeFilterLabel("Order: ")+HU.select("",[ID,this.getDomId("sortbyselect")],t,this.getProperty("sortFields","")))+SPACE}if(this.getProperty("showSortDirection")&&(n+=HU.select("",[ID,this.getDomId("sortdirection")],[["up","Sort Up"],["down","Sort Down"]],p?"up":"down")+SPACE),this.sizeByFields.length>0){let t=[];this.sizeByFields.forEach((e=>{t.push([e.getId(),e.getLabel()])})),n+=HU.span([CLASS,i],this.makeFilterLabel("Size by: ")+HU.select("",[ID,this.getDomId("sizebyselect")],t,this.getProperty("sizeBy","")))+SPACE}let g=this.getFilterHighlight();if(this.getProperty("showFilterHighlight")){let e=[["filter","Filter"],["highlight","Highlight"]],i=HU.select("",["fieldId","_highlight",ID,this.getDomId(ID_FILTER_HIGHLIGHT)],e,g?"highlight":"filter")+SPACE2;t&&(i=HU.div([STYLE,HU.css("display","none")],i)),n+=i}let c=[];if(this.getDataFilters().forEach((t=>{if(!t.label)return;let e=this.getDomId("datafilterenabled_"+t.id);c.push(e),n+=HU.checkbox("",[ID,e],t.enabled)+" "+this.makeFilterLabel(t.label+"&nbsp;&nbsp;")})),this.getProperty("filterDate")){let e=this.getProperty("filterDate"),a=[];this.getProperty("filterDateIncludeAll")&&a.push(["all","All"]);let s=null,l={},r=[];o.forEach((t=>r.push(t.getDate()))),r.sort((function(t,e){return t.getTime()-e.getTime()})),r.forEach((t=>{let i=null;"year"==e?i=t.getFullYear():"day"==e&&(i=Utils.formatDateMonthDayYear(t)),l[i]||(s=String(t),a.push([String(t),i]),l[i]=!0)}));let h="year"==e?"Year":"month"==e?"Month":"day"==e?"Day":e,d="";this.getProperty("filterDateShow",!0)||(d+="display:none;");let p=this.getFilterId(ID_FILTER_DATE);h=this.makeFilterLabel("Select "+h+": ");let g="";g+=HU.div([ID,this.getDomId("filterDateStepBackward"),STYLE,HU.css("display","inline-block"),TITLE,"Step Back"],HU.getIconImage("fa-step-backward",[STYLE,HU.css("cursor","pointer")]))+SPACE1,g+=HU.div([ID,this.getDomId("filterDatePlay"),STYLE,HU.css("display","inline-block"),TITLE,"Play/Stop Animation"],HU.getIconImage("fa-play",[STYLE,HU.css("cursor","pointer")]))+SPACE1,g+=HU.div([ID,this.getDomId("filterDateStepForward"),STYLE,HU.css("display","inline-block"),TITLE,"Step Forward"],HU.getIconImage("fa-step-forward",[STYLE,HU.css("cursor","pointer")]))+SPACE1;let c=HU.span([CLASS,i,STYLE,d],g+HU.select("",["fieldId","filterDate",ATTR_ID,p],a,s))+SPACE;t&&(c=HU.div([STYLE,HU.css("display","none")],c)),n+=c}let u=this.getProperty("filterFields","").split(",").map((t=>t.trim())),y={};if(this.filters=[],this.filterMap={},this.addFilters(this.filters),u.length>0){let a=null;for(let t=0;t<u.length;t++){if(""==u[t])continue;if(u[t].startsWith("group:")){a=u[t].substring(6),"none"==a&&(a=null);continue}let e=new RecordFilter(this,u[t]);e.group=a,this.filters.push(e),this.filterMap[e.getId()]=e}let s="",l=[""];a=null,groupHtml=null,this.filters.forEach((t=>{let i=t.getWidget(y,l,o,e);if(e||(i=HU.span([ID,this.domId("filtercontainer_"+t.id)],i)),null!=t.group)return t.group!=a&&null!=groupHtml&&(s+=HU.toggleBlock(a,groupHtml,!1),groupHtml=null),a=t.group,null==groupHtml&&(groupHtml=""),void(groupHtml+=i);null!=groupHtml&&(s+=HU.toggleBlock(a,groupHtml,!1),groupHtml=null),s+=i})),null!=groupHtml&&(s+=HU.toggleBlock(a,groupHtml,!1)),style=(t?"display:none;":"")+this.getProperty("filterByStyle",""),this.getProperty("showFilterTotal",!1)&&(s+=HU.span([CLASS,"display-filter-label",ID,this.getDomId(ID_FILTER_COUNT)],""));let r=s+l[0]+HU.div([ID,this.domId(ID_TAGBAR)],"");n+=HU.div([CLASS,"display-header-span "+i,STYLE,style,ID,this.getDomId(ID_FILTERBAR)],r)}n=e?HU.div([CLASS,"display-header-vertical"],n):HU.div([STYLE,"line-height:0;"],n);let m=this.getDisplayHeaderSide();"left"==m?this.jq(ID_LEFT).html(n):"right"==m?this.jq(ID_RIGHT).html(n):this.jq(ID_HEADER2).html(n),this.initHeader2(),this.jq("test").button().click((()=>{this.haveCalledUpdateUI=!1,this.callUpdateUI()})),this.createRequestProperties();let f=(t,e,i)=>{let a=!1;if(this.ignoreFilterChange)return;let l,r,o=t.attr(ID);if(!o)return void console.log("No ID attribute");this.filters.every((t=>t.widgetId!=o||(l=t,r=t.id,!1)));let n=[];if(l&&this.filters.forEach((t=>{if(t.depends==l.id){n.push(t);let e=$("#"+t.widgetId);this.ignoreFilterChange=!0,t.lastValue=e.val(),e.val(FILTER_ALL),this.ignoreFilterChange=!1}})),!e)if(o.endsWith("_min"))e=$("#"+o.replace(/_min$/,"_max"));else if(o.endsWith("_max")){let i=t;t=$("#"+o.replace(/_max$/,"_min")),e=i}if(t.attr("isCheckbox")){let e=t.attr("onValue")||!0,a=t.attr("offValue")||!1;t.is(":checked")?(i=e,console.log(s.type+" cbx is checked value:"+i+" on:"+e+" off:"+a)):(i=a,console.log(s.type+" cbx is not checked value:"+i+" on:"+e+" off:"+a))}if(i||(i=t.val()),null!==i&&""!==i||(i=t.attr("data-value")||t.val()),null==i)return void 0;if(!Array.isArray(i)&&t.attr("isButton")){var h=[];i.split(",").forEach((t=>{h.push(t.replace(/_comma_/g,","))})),i=h}let d=t.attr("fieldId");if(s.checkFilterField(t),s.haveCalledUpdateUI=!1,s.settingFilterValue)return;s.settingFilterValue=!0,this.filteredRecords=null,s.dataFilterChanged();n.forEach((t=>{null==this.filteredRecords&&(this.filteredRecords=this.filterRecords());let e=t.getWidget({},[],this.filteredRecords);if(this.jq("filtercontainer_"+t.id).html(e),t.initWidget&&t.initWidget(f),t.widgetId){let e=$("#"+t.widgetId);if(!e.length)return void console.log("Could not find dependent widget:"+t.id);if(t.lastValue){if(e[0].options){$.map(e[0].options,(t=>t.value)).includes(t.lastValue)||(t.lastValue=FILTER_ALL)}e.val(t.lastValue)}e.change((function(){f($(this))}))}return!0})),this.addToDocumentUrl(d+".filterValue",i);let p={id:o,fieldId:d,value:i};e&&(p.value2=e.val()),s.propagateEvent(DisplayEvent.filterChanged,p),s.settingFilterValue=!1};c.forEach((t=>{$("#"+t).click((function(t){f($(this))}))})),this.filters.forEach((t=>{t.initWidget&&t.initWidget(f)})),this.jq(ID_FILTERBAR).find(".display-filter-items").each((function(){let t=$(this);$(this).find(".display-filter-item").click((function(e){var i=$(this).hasClass("display-filter-item-all"),a="display-filter-item--selected",l=$(this).hasClass(a),r=$(this).attr("fieldId"),o=s.getProperty(r+".filterMultiple",!1);e.metaKey&&!i&&o?t.find(".display-filter-item-all").removeClass(a):t.find(".display-filter-item").removeClass(a),l&&e.metaKey?$(this).removeClass(a):$(this).addClass(a);var n=[];t.find("."+a).each((function(){n.push($(this).attr("data-value").replace(/,/g,"_comma_"))})),0==n.length&&(t.find(".display-filter-item-all").addClass(a),n.push(FILTER_ALL));var h=Utils.join(n,",");t.attr("data-value",h),$("#"+t.attr(ID)+"_label").html(n.includes(FILTER_ALL)?SPACE:h),f(t,null,n)}))})),this.jq(ID_FILTERBAR).find(".display-filter-input").keyup((function(t){if(13==(t.keyCode||t.which))return;HtmlUtils.hidePopupObject();let e=$(this),i=$(this).val().trim();if(""==i)return;let a=$(this).attr("fieldId"),s=(y[a].field,y[a].values),l=[],r=null;try{i=i.replace(/\./g,"\\."),r=new RegExp("("+i+")","i")}catch(t){}for(let t=0;t<s.length;t++){let e=s[t].toString(),a=r?e.match(r):e.indexOf(i)>=0;if(a&&l.push([a[1],s[t]]),l.length>30)break}if(l.length>0){let t="",i=0;if(l.forEach((e=>{let a=e[0],s=(e=e[1]).replace(r,"<span style='background:"+TEXT_HIGHLIGHT_COLOR+";'>"+a+"</span>");e=e.replace(/\'/g,"'"),t+=HU.div([TITLE,e,CLASS,"ramadda-hoverable ramadda-clickable display-filter-popup-item","item",e],s)+"\n",i++})),i>0){let i=HtmlUtils.setPopupObject(HtmlUtils.getTooltip());i.html(HU.div([STYLE,HU.css("margin","5px"),CLASS,"ramadda-popup-inner ramadda-snippet-popup"],t)),i.show(),i.position({of:$(this),my:"left top",at:"left bottom"}),$(".display-filter-popup-item").click((function(){HtmlUtils.hidePopupObject(),e.val($(this).attr("item")),f(e)}))}}})),this.initializeRangeSlider(this.jq(ID_FILTERBAR).find(".display-filter-range"),f,this.getProperty("filterSliderImmediate")),this.jq(ID_FILTER_HIGHLIGHT).change((function(){s.setProperty("filterHighlight","highlight"==$(this).val()),s.haveCalledUpdateUI=!1,f($(this))})),$("#"+this.getFilterId(ID_FILTER_DATE)).change((function(){f($(this))})),this.jq("filterDatePlay").click((function(){s.filterDatePlayingAnimation=!s.filterDatePlayingAnimation;let t=s.filterDatePlayingAnimation?"fa-stop":"fa-play";$(this).html(HU.getIconImage(t,[STYLE,HU.css("cursor","pointer")])),s.filterDatePlayingAnimation&&s.stepFilterDateAnimation(f,1)})),this.jq("filterDateStepBackward").click((function(){s.filterDatePlayingAnimation=!1;let t=s.filterDatePlayingAnimation?"fa-stop":"fa-play";s.jq("filterDatePlay").html(HU.getIconImage(t,[STYLE,HU.css("cursor","pointer")])),s.stepFilterDateAnimation(f,-1)})),this.jq("filterDateStepForward").click((function(){s.filterDatePlayingAnimation=!1;let t=s.filterDatePlayingAnimation?"fa-stop":"fa-play";s.jq("filterDatePlay").html(HU.getIconImage(t,[STYLE,HU.css("cursor","pointer")])),s.stepFilterDateAnimation(f,1)})),this.jq("displayfields").change((function(){let t=$(this).val();Array.isArray(t)&&(t=t.join(",")),s.displayFieldsChanged(t),s.propagateEvent(DisplayEvent.propertyChanged,{property:"displayFields",value:t})})),d.forEach((t=>{this.jq("fieldselect_"+t).change((function(){s.fieldSelectedChanged(t,$(this).val())}))})),this.jq("colorbyselect").change((function(){s.colorByFieldChanged($(this).val())})),this.jq("sortbyselect").change((function(){let t=$(this).val();t.endsWith("_up")?(s.setProperty("sortAscending",!0),t=t.replace(/_up$/,"")):(t=t.replace(/_down$/,""),s.setProperty("sortAscending",!1)),s.sortByFieldChanged(t)})),this.jq("sortdirection").change((function(){let t=$(this).val();s.setProperty("sortAscending","up"==t),s.forceUpdateUI()})),this.jq("sizebyselect").change((function(){s.sizeByFieldChanged($(this).val())})),this.jq(ID_FILTERBAR).find("input").keyup((function(t){13==(t.keyCode||t.which)&&f($(this))})),this.jq(ID_FILTERBAR).find("input:radio,select").change((function(){f($(this))})),this.jq(ID_FILTERBAR).find("input:checkbox").change((function(){f($(this))}));a&&console.log("checkSearchBar-getting filtered data");let D=this.filterData();a&&console.log("checkSearchBar-done getting filtered data");let I=this.getDateInfo(D);if(a&&console.log("checkSearchBar-11"),I.dateMax){a&&console.log("checkSearchBar-getAnimation");let t=this.getAnimation();t.getEnabled()&&(a&&console.log("checkSearchBar-calling animation.init"),t.init(I.dateMin,I.dateMax,D),a&&console.log("checkSearchBar-done calling animation.init"),this.minDateObj||(a&&console.log("checkSearchBar-calling setDateRange"),this.getProperty("animationFilter",!0)&&this.setDateRange(t.begin,t.end),a&&console.log("checkSearchBar-done calling setDateRange")))}a&&console.log("checkSearchBar-done")},getDateInfo:function(t){let e=null,i=null,a=[];return t.every((t=>{if(null==e)e=t.getDate(),i=t.getDate();else{let s=t.getDate();s&&(a.push(s),s.getTime()<e.getTime()&&(e=s),s.getTime()>i.getTime()&&(i=s))}return!0})),{dateMin:e,dateMax:i,dates:a}},getHighlightColor:function(){return this.getProperty("highlightColor",HIGHLIGHT_COLOR)},checkFilterField:function(t){let e=t.attr("data-min"),i=t.attr("data-max"),a=t.val();Utils.isDefined(e)?a!=e?t.css("background",TEXT_HIGHLIGHT_COLOR):t.css("background","white"):Utils.isDefined(i)&&(a!=i?t.css("background",TEXT_HIGHLIGHT_COLOR):t.css("background","white"))},fieldSelectedChanged:function(t,e){this.setProperty(t,e),this.haveCalledUpdateUI=!1,this.callUpdateUI()},colorByFieldChanged:function(t){this.setProperty("colorBy",t),this.callUpdateUI()},sortByFieldChanged:function(t){this.setProperty("sortFields",t),this.callUpdateUI()},sizeByFieldChanged:function(t){},someFieldChanged:function(t,e){},macroChanged:function(){this.pageSkip=0},dataFilterChanged:function(t){(t=t||{}).dataFilterChanged=!0,this.callUpdateUI(t)},addFieldClickHandler:function(t,e,i){let a=this;if(e){t||(t=this.jq(ID_DISPLAY_CONTENTS));let s=this.makeIdToRecords(e),l=function(){i&&($(this).parent().find(".display-row-highlight").removeClass("display-row-highlight"),$(this).addClass("display-row-highlight"));let t=e[$(this).attr(RECORD_INDEX)];t||(t=s[$(this).attr(RECORD_ID)]),t&&a.propagateEventRecordSelection({record:t})},r=t.find("["+RECORD_INDEX+"]");r.length||(r=t.find("["+RECORD_ID+"]")),r.length||(r=t),r.click(l)}if(this.getProperty("propagateValueClick",!0)){let e=this;t||(t=this.jq(ID_DISPLAY_CONTENTS)),t.find("[field-id]").click((function(){let t={id:$(this).attr("field-id"),fieldId:fieldId,value:$(this).attr("field-value")};e.propagateEvent(DisplayEvent.filterChanged,t)}))}},makeIdToRecords:function(t){let e={};return t.forEach((t=>e[t.getId()]=t)),e},makeTooltipClick:function(t,e){let i=this.getProperty("tooltipClick");if(!i)return;t.css("cursor","pointer");let a=this.makeIdToRecords(e),s=this;t.click((function(){let t=a[$(this).attr(RECORD_ID)];if(!t)return;s.tooltipDialog&&(s.tooltipDialog.remove(),s.tooltipDialog=null);let e=s.getRecordHtml(t,null,i);e=HU.div([STYLE,HU.css("width","600px")],e),s.tooltipDialog=HU.makeDialog({content:e,anchor:$(this),draggable:!0,header:!0}),s.getProperty("dialogListener")&&s.getProperty("dialogListener")(this,s.tooltipDialog),s.initTemplatePopup(s.tooltipDialog)}))},initTemplatePopup:function(t){let e=this;t.find(".display-search-tag").click((function(){let t=$(this).attr("metadata-type");if(null==t)return;let i=e.filterMap[t];if(null==i)return;let a=$(this).attr("metadata-value");i.toggleTag(a,!0,null,!0)}))},makeTooltips:function(t,e,i,a,s){if(this.getProperty("tooltipClick")&&this.makeTooltipClick(t,e),Utils.isDefined(s)&&null!=s||(s=this.shareEvent(DisplayEvent.recordHighlight,this.getProperty("propagateEventRecordHighlight",!1))),!this.getProperty("showTooltips",!0))return;let l=a||this.getProperty("tooltip");if(null==l)return;let r=this,o=this.makeIdToRecords(e),n={content:function(){let t=o[$(this).attr(RECORD_ID)];if(t||(t=e[parseFloat($(this).attr(RECORD_INDEX))]),!t)return null;let a=!0;if(i&&!1===i(!0,t)&&(a=!1),a&&s&&r.getDisplayManager().notifyEvent(DisplayEvent.recordHighlight,r,{highlight:!0,record:t}),""==l||"none"==l)return null;let n=r.getProperty("tooltipStyle"),h=r.getRecordHtml(t,null,l);return n&&(h=HU.div([STYLE,n],h)),h},close:function(t,a){let l=o[$(this).attr(RECORD_ID)];l||(l=e[parseFloat($(this).attr(RECORD_INDEX))]);let n=!0;i&&!1===i(!1,l)&&(n=!1),n&&s&&r.getDisplayManager().notifyEvent(DisplayEvent.recordHighlight,r,{highlight:!1,record:l})},position:{my:r.getProperty("tooltipPositionMy","left top"),at:r.getProperty("tooltipPositionAt","left bottom+2"),collision:r.getProperty("tooltipCollision","flip")},show:{delay:parseFloat(r.getProperty("tooltipDelay",1e3)),duration:parseFloat(r.getProperty("tooltipDuration",500))},classes:{"ui-tooltip":r.getProperty("tooltipClass","ramadda-shadow-box  display-tooltip")}};t.length>500?(t.mouseenter((function(){$(this).tooltip(n).tooltip("open")})),t.mouseleave((function(){$(this).tooltip({}).tooltip("close")}))):t.tooltip(n)},makeRecordSelect:function(t,e,i){let a=this;t.click((function(t){let s=e[$(this).attr(RECORD_ID)];s&&(i&&i(s),a.propagateEventRecordSelection({select:!0,record:s}))}))},makePopups:function(t,e,i,a){if(a||(a=this.getProperty("popupTemplate")),!a)return;let s=this;t.click((function(t){let l=e[parseFloat($(this).attr(RECORD_INDEX))];l&&(i&&i(l),s.propagateEventRecordSelection({select:!0,record:l}),s.showRecordPopup($(this),l,i,a))}))},showRecordPopup:function(t,e,i){if(!e)return;if(i||(i=this.getProperty("popupTemplate")),!i)return;let a=this;HtmlUtils.hidePopupObject();let s=a.getRecordHtml(e,null,i);s=HU.div([CLASS,"display-popup "+a.getProperty("popupClass",""),STYLE,a.getProperty("popupStyle","")],s);let l=HtmlUtils.setPopupObject(HtmlUtils.getTooltip());l.html(s),l.show(),l.position({of:t,my:a.getProperty("popupPositionMy","left top"),at:a.getProperty("popupPositionAt","left bottom+2"),collision:a.getProperty("popupCollision","none none")})},animationStart:function(t){},animationApply:function(t,e){this.getProperty("animationFilter",!0)&&this.setDateRange(t.begin,t.end),e||(this.haveCalledUpdateUI=!1,this.dataFilterChanged({source:"animation"})),this.propagateEvent(DisplayEvent.propertyChanged,{property:"dateRange",minDate:t.begin,maxDate:t.end})},makeDialog:function(t){if(!t){var e=[],i=[];this.getDialogContents(e,i),e.push("Edit"),i.push(this.makeToolbar({addLabel:!0}));for(var a="<ul>",s="",l=0;l<e.length;l++){var r=this.getDomId("tabs")+l;a+=HU.tag("li",[],HU.tag("a",["href","#"+r],e[l])),a+="\n";var o=HU.div([ATTR_CLASS,"display-dialog-tab"],i[l]);s+=HU.div([ID,r],o),s+="\n"}a+="</ul>\n",t=HU.div([ID,this.getDomId(ID_DIALOG_TABS)],a+s)}return t},initDialog:function(){var t=this,e=function(e){if(!e||13==e.which||0==e.which){var i=!1;["column","row","width","height"].forEach((e=>{t[e]==t.jq(e).val()||!t[e]&&""==t.jq(e).val().trim()||(i=!0,t[e]=t.jq(e).val())})),i&&t.getLayoutManager().doLayout()}};["column","row","width","height"].forEach((t=>{this.jq(t).blur(e),this.jq(t).keypress(e)})),this.jq("showtitle").change((function(){t.setShowTitle(t.jq("showtitle").is(":checked"))})),this.jq("showdetails").change((function(){t.setShowDetails(t.jq("showdetails").is(":checked"))})),this.jq(ID_DIALOG_TABS).tabs()},showDialog:function(t,e,i,a){this.dialog&&this.dialog.remove(),this.dialogElement;let s=this.makeDialog(t);return this.dialog=HU.makeDialog({content:s,title:a||this.getTitle(),anchor:e||this.jq(ID_MENU_BUTTON),draggable:!0,header:!0}),i?i():this.initDialog(),this.dialog},copyDisplay:function(){let t={};$.extend(!0,t,this),t.setId(t.getId()+this.getUniqueId("display")),addRamaddaDisplay(t),this.getDisplayManager().addDisplay(t)},removeDisplay:function(){this.getDisplayManager().removeDisplay(this),this.dialogElement&&this.dialogElement.remove()},doingQuickEntrySearch:!1,doQuickEntrySearch:function(t,e){if(this.doingQuickEntrySearch)return;var i=t.term;if(null==i||i.length<=1)return;this.doingQuickEntrySearch=!0;var a=new EntrySearchSettings({name:i,max:10});this.searchSettings&&a.clearAndAddType(this.searchSettings.entryType);let s=this;var l=this.getRamadda().getSearchUrl(a,OUTPUT_JSON),r={entryListChanged:function(t){s.doneQuickEntrySearch(t,e)}};new EntryList(this.getRamadda(),l,r,!0)},doneQuickEntrySearch:function(t,e){for(var i=[],a=t.getEntries(),s=0;s<a.length;s++)i.push(a[s].getName());e(i),this.doingQuickEntrySearch=!1},addData:async function(t){var e=t.getRecords();e&&e.length>0?this.hasElevation=e[0].hasElevation():this.hasElevation=!1,t=this.convertPointData(t),this.dataCollection.addData(t);var i=t.entry;null==i&&t.entryId&&await this.getRamadda().getEntry(t.entryId,(t=>{i=t})),i&&(t.entry=i,this.addEntry(i))},handleWarning:function(t){window.location.hash&&"#fortest"==window.location.hash||console.warn(t)},handleLog:function(t){window.location.hash&&"#fortest"==window.location.hash||console.log(t)},handleError:function(t,e){if(this.setErrorMessage(t),console.error(this.type+" "+t),e&&e.stack){let t="",i=15;e.stack.split("\n").every((e=>i--<0?(t+="...\n",!1):(t+=e+"\n",!0))),console.error(t)}},setErrorMessage:function(t){this.setContents(this.getMessage(t))},clearProgress:function(){this.jq(ID_DISPLAY_PROGRESS).html("")},startProgress:function(){this.jq(ID_DISPLAY_PROGRESS).length>0?this.jq(ID_DISPLAY_PROGRESS).html(HU.image(icon_progress)):this.useDisplayMessage()?this.setDisplayMessage(this.getLoadingMessage()):this.setContents(this.getLoadingMessage())},handleNoData:function(t,e){let i=displayDebug.handleNoData;this.jq(ID_PAGE_COUNT).html(""),e?(this.dataCollection||(this.dataCollection=new DataCollection),this.dataCollection.setData(t)):(i&&console.log("\tno reload"),this.addData(t),this.checkSearchBar()),this.setContents(this.getMessage(this.getNoDataMessage()))},pointDataLoadFailed:function(t){if(this.clearProgress(),this.inError=!0,errorMessage=this.getProperty("errorMessage",null),null==errorMessage){var e="";if(t&&t.error)e=t.error,e=String(e).replace(/</g,"&lt;").replace(/>/g,"&gt;");else if(t&&t.errorcode&&"warning"==t.errorcode)e=t.error,e=String(e).replace(/</g,"&lt;").replace(/>/g,"&gt;");else{e="<b>An error has occurred:</b>",t||(t=this.getNoDataMessage());for(var i=t.error?t.error:t,a="",s=(i=i.replace(/<[^>]*>/g,"")).split("\n"),l={},r=0;r<s.length;r++){var o=s[r].trim();""!=o&&(l[o]||(l[o]=!0,a+=o+"\n"))}i=a,e+=i=HU.tag("pre",[STYLE,HU.css("max-height","300px","overflow-y","auto","max-width","100%","overflow-x","auto")],i)}e=e.replace(/\n/g,"<br>"),this.setErrorMessage(e)}else this.setContents(errorMessage)},clearCache:function(){},handleEventDataSelection:function(t,e){this.getAcceptEventDataSelection()&&this.pointDataLoaded(e.data,"",!0)},getRequirement:function(){return null},updatePaginateLabel:function(t,e,i){let a=this.getProperty("filterPaginate"),s=e;null!=t&&t>0?s=String(t+1)+"-"+(e+t):e<i&&(s="1-"+e),s=this.getProperty("pageRequestLabel","Showing: ${count}").replace("${count}",s),this.jq(ID_PAGE_LABEL).html(s);let l="";l+=null!=t&&t>0?HU.getIconImage("fa-step-backward",[ID,this.getDomId(ID_PAGE_PREV),CLASS,"display-page-button",TITLE,"View previous"]):HU.getIconImage("fa-step-backward",[CLASS,"display-page-button fa-disabled"]),l+=e<i?HU.getIconImage("fa-step-forward",[ID,this.getDomId(ID_PAGE_NEXT),CLASS,"display-page-button",TITLE,"View next"]):HU.getIconImage("fa-step-forward",[CLASS,"display-page-button fa-disabled"]),this.jq(ID_PAGE_BUTTONS).html(l);let r=this;this.jq(ID_PAGE_NEXT).click((()=>{this.pageSkip||(this.pageSkip=0),a?(this.pageSkip+=+this.getProperty("pageCount",1e3),r.haveCalledUpdateUI=!1,r.dataFilterChanged(),r.updatePaginateLabel(this.pageSkip,e,i)):(this.pageSkip+=i,this.reloadData())})),this.jq(ID_PAGE_PREV).click((()=>{this.pageSkip||(this.pageSkip=0),a?(this.pageSkip-=+this.getProperty("pageCount",1e3),this.pageSkip<0&&(this.pageSkip=0),r.haveCalledUpdateUI=!1,r.updatePaginateLabel(this.pageSkip,e,i),r.dataFilterChanged()):(this.pageSkip-=i,this.pageSkip<0&&(this.pageSkip=0),this.reloadData())}))},pointDataLoaded:function(t,e,i){let a=displayDebug.pointDataLoaded;this.clearProgress(),this.inError=!1,this.clearCache(),a&&console.log(this.type+" pointDataLoad:"+this.getId()+" "+this.type+" #records:"+t.getRecords().length),a&&console.log("\tclearing last selected fields");t.getRecords();this.lastSelectedFields=null,i?(t=this.convertPointData(t),this.dataCollection||(this.dataCollection=new DataCollection),a&&console.log("\tcalling setData"),this.dataCollection.setData(t)):(a&&console.log("\tcalling addData"),this.addData(t),this.checkSearchBar());let s=this.getProperty("filterPaginate");if(this.getProperty("pageRequest")||s){a&&console.log("\tupdating pageRequest");let i=t.getRecords().length,s=null,l=e?e.match(/skip=([0-9]+)/):null;l&&(s=+l[1]);let r=+this.getProperty("max",5e3),o=i;null!=s&&s>0?o=String(s+1)+"-"+(i+s):i==r&&(o="1-"+i);let n=this.getProperty("pageRequestLabel","Showing: ${count}").replace("${count}",o)+" ",h=!s&&i<r;null!=s&&s>0?n+=HU.getIconImage("fa-step-backward",[ID,this.getDomId(ID_PAGE_PREV),CLASS,"display-page-button",TITLE,"View previous"]):h||(n+=HU.getIconImage("fa-step-backward",[CLASS,"display-page-button fa-disabled"])),i==r?n+=HU.getIconImage("fa-step-forward",[ID,this.getDomId(ID_PAGE_NEXT),CLASS,"display-page-button",TITLE,"View next"]):h||(n+=HU.getIconImage("fa-step-forward",[CLASS,"display-page-button fa-disabled"])),this.jq(ID_PAGE_COUNT).html(n+"&nbsp;&nbsp;"),this.jq(ID_PAGE_NEXT).click((()=>{this.pageSkip||(this.pageSkip=0),this.pageSkip+=r,this.reloadData()})),this.jq(ID_PAGE_PREV).click((()=>{this.pageSkip||(this.pageSkip=0),this.pageSkip-=r,this.pageSkip<0&&(this.pageSkip=0),this.reloadData()}))}if(this.jsonUrl=null!=e?e:null,this.getDisplayReady()){this.getProperty("dateFormat")||t.getRecordFields().forEach((t=>{t.isFieldDate()&&"year"==t.getId()&&this.setProperty("dateFormat","yyyy")})),this.haveCalledUpdateUI=!1,a&&console.log("\tcalling updateUI");try{let t=this.getRequirement();t?HU.waitForIt(t,(()=>{this.updateUI({reload:i})})):this.updateUI({reload:i})}catch(t){return void this.handleError("Error creating display:<br>"+t,t)}i||(this.lastPointData=t,this.propagateEvent(DisplayEvent.pointDataLoaded,t))}else a&&console.log("pointDataLoaded: display not ready")},getHasDate:function(t){var e=null;for(this.hasDate=!1,j=0;j<t.length;j++){var i=t[j].getDate();if(null!=i){if(null!=e&&e.getTime()!=i.getTime()){this.hasDate=!0;break}e=i}}return this.hasDate},dateInRange:function(t,e){if(e&&console.log("dateInRange: date:"+t+" minDate:"+this.minDateObj+" maxDate:"+this.maxDateObj),null!=t){if(this.dateRangeDoDay&&this.minDateObj){if(t.getUTCFullYear()!=this.minDateObj.getUTCFullYear()||t.getUTCMonth()!=this.minDateObj.getUTCMonth()||t.getUTCDate()!=this.minDateObj.getUTCDate())return!1}else{if(null!=this.minDateObj&&t.getTime()<this.minDateObj.getTime())return e&&console.log("    minDate:\n\t"+t.getTime()+"\n\t"+this.minDateObj.getTime()),!1;if(null!=this.maxDateObj&&t.getTime()>this.maxDateObj.getTime())return e&&console.log("    maxDate:\n\t"+t.getTime()+"\n\t"+this.minDateObj.getTime()),!1}if(null!=this.startDateObject&&t.getTime()<this.startDateObject.getTime())return!1;if(null!=this.endDateObject&&t.getTime()>this.endDateObject.getTime())return e&&console.log("    endDate:\n\t"+t.getTime()+"\n\t"+this.endDateObject.getTime()),!1}return!0},getPointData:function(){return this.pointData?this.pointData:0==this.dataCollection.getList().length?null:this.dataCollection.getList()[0]},getRecords:function(){let t=this.getData();return null==t?null:t.getRecords()},getDataValues:function(t){return t.tuple?t.tuple:t.getData?t.getData():t},indexToRecord:{},recordToIndex:{},findMatchingDates:function(t,e,i){Utils.isDefined(i)||(i=0);let a=[],s=t.getTime();return e.forEach((t=>{let e=t.getDate();e&&Math.abs(e.getTime()-s)<=i&&a.push(t)})),a},findMatchingIndex:function(t){if(!t)return{index:-1,record:null};var e=this.recordToIndex[t.getId()];if(Utils.isDefined(e))return{index:e,record:this.indexToRecord[e]};if(!t.hasDate())return-1;let i=this.filteredRecords;if(!i)for(n in i=[],this.indexToRecord)i.push(this.indexToRecord[n]);var a,s=0;return i.forEach((e=>{if(!e.hasDate())return-1;var i=Math.abs(t.getDate().getTime()-e.getDate().getTime());a?i<s&&(s=i,a=e):(s=i,a=e)})),a?{index:this.recordToIndex[a.getId()],record:a}:{index:-1,record:null}},makeDataArray:function(t){if(0==t.length)return t;var e=[];if(t[0].getData)for(var i=0;i<t.length;i++)e.push(t[i].getData()[0]);else if(t[0].tuple)for(i=0;i<t.length;i++)e.push(t[i].tuple);else e=t;return e},printFields:function(t,e){if(console.log(t),e)for(a in e)console.log("   "+e[a].getId());else console.log("   null fields")},makeIndexValue:function(t,e,i){return e+i},getStandardData:function(t,e){e||(e={});let i=displayDebug.getStandardData;i&&console.log("getStandardData:"+this.type+"  fields:"+t);let a=this.getProperty("showUnit",this.getProperty("showUnitInSeries",!0));this.recordToIndex={},this.indexToRecord={};var s=this.getPointData(),l=this.getProperty(PROP_EXCLUDE_ZERO,!1),r=this.getProperty(PROP_EXCLUDE_NAN,!1);null==t&&(t=s.getRecordFields(),i&&console.log("\tgetRecordFields: "+t.length)),props={makeObject:!0,includeIndex:!0,includeIndexIfDate:!1,groupByIndex:-1,raw:!1},null!=e&&$.extend(props,e);let o=props.groupByIndex,h=[],d={},p=[],g=this.getProperty("groupByDate"),c=this.getProperty("groupByFill"),u={},y=[];var m=[],f=[],D=[];if(this.getProperty("binDate")&&(i&&console.log("binning date"),"count"==this.getProperty("binType","total"))){var I=[];t.forEach((t=>{I.push(new RecordField({index:0,id:t.getId(),label:this.getProperty("binDateLabel",this.getProperty("binCountLabel","Count")),type:"double",chartable:!0}))})),t=I}let T=!1;for(t=t.filter((t=>{if(t.isFieldDate()){if(T&&t.isRecordDate())return null;T=!0}return t})),n=0;n<t.length;n++){(G=t[n]).isFieldNumeric()&&G.isFieldDate();var b=G.getLabel();a&&null!=G.getUnit()&&(b+=" ("+G.getUnit()+")"),b=b.replace(/!!/g," -- "),f.push(b),D.push(G)}props.makeObject?m.push({tuple:f,fields:D,record:null}):m.push(f),h.push(""),p.push(null),this.minDateObj||(this.minDateObj=Utils.parseDate(this.minDate,!1),i&&console.log("getStandardData setting min date:"+this.minDateObj)),this.minDateObj||(this.maxDateObj=Utils.parseDate(this.maxDate,!0,this.minDateObj),i&&console.log("getStandardData setting max date:"+this.maxDateObj)),null==this.minDateObj&&null!=this.maxDateObj&&(this.minDateObj=Utils.parseDate(this.minDate,!1,this.maxDateObj));let S=0;Utils.isDefined(this.offset)&&(S=parseFloat(this.offset));let x=0,U=e.records?e.records:this.filterData();i&&console.log("getStandardData #fields:"+t.length+" #records:"+U.length);s.getRecordFields();this.hasDate=this.getHasDate(U);let L=-1,E=this.getFieldById(null,this.getProperty("indexField"));new Date;for(let e=0;e<U.length;e++){let i=U[e],a=i.getDate();if(!this.dateInRange(a))continue;L++,this.recordToIndex[i.getId()]=L,this.indexToRecord[L]=i;let s=[];if(props&&(props.includeIndex||props.includeIndexIfDate)){var P=null;if(E){let t=this.makeIndexValue(E,i.getValue(E.getIndex()),e);s.push(t),P=E.getLabel()}else if(this.hasDate){let t=this.getDateValue(a,null);s.push(t),P="Date"}else props.includeIndexIfDate||(s.push(e),P=this.getProperty("indexName","Index"));null!=P&&0==L&&f.unshift(P)}let n=!0,c=!0,u=!1,y=!1;for(let e=0;e<t.length;e++){let a=t[e];a.isFieldNumeric()&&a.isFieldDate();var C=i.getValue(a.getIndex());0!=S&&(C+=S),null!=C&&(n=!1),"number"==typeof C&&(r&&isNaN(C)&&(y=!0),u=!0,0!=C&&(c=!1)),a.isFieldDate()&&(C=this.getDateValue(C,null)),s.push(C)}if(!y&&!(u&&c&&l)){if(o>=0){C=i.getValue(o);d[C]||(d[C]=!0),g?h.push(i.getDate()+"-"+C):h.push(C),p.push(i)}props.makeObject?m.push({tuple:s,record:i}):m.push(s),n||x++}}new Date;if(0==x)return console.log(this.type+" no nonNull records"),[];if(o>=0){var A={},w=[],H=[],R=[];let e=this.getProperty("groupByCount");if(R.push(props.groupByField.getLabel()),e)R.push(this.getProperty("groupByCountLabel","Count"));else for(var k=0;k<t.length;k++){(G=t[k]).getIndex()!=o&&R.push(G.getLabel())}let i={};for(var _=0;_<m.length;_++){var F=this.getDataValues(m[_]);if(0!=_){var M=h[_],N=p[_],B=N.getValue(o),O=A[M];if(null==O){if(O=new Array,w.push(M),g){let t=u[N.getDate()];null==t&&(u[N.getDate()]=t=[],y.push(N.getDate())),t.push(O)}if(i[B]||(i[B]=[]),i[B].push(O),O.record=N,H.push(O),O.push(B),e)O.push(0);else for(k=0;k<t.length;k++){(G=t[k]).getIndex()!=o&&O.push(0)}A[M]=O}var Y=0;if(e)O[1]++;else for(k=0;k<t.length;k++){var G;if((G=t[k]).getIndex()!=o){var V=F[k];if(Y++,Utils.isNumber(V))"string"==typeof O[Y]&&(O[Y]=0),O[Y]+=parseFloat(V);else{0==O[Y]&&(O[Y]="");var q=O[Y];if(Utils.isDefined(q)||(q=""),q.length<150){Utils.isDefined(V)||(V="");var j=""+V;q.indexOf(j)<0&&(""!=q&&(q+=", "),q+=j,O[Y]=q)}}}}}}if(c&&y.forEach((t=>{let e=u[t],i={};for(v in e.forEach((t=>{i[t[0]]=!0})),d)if(!i[v]){i[v]=!0;let e=[v,0];e.date=t,H.push(e)}})),this.getProperty("groupBySort")&&H.sort((function(t,e){return e[1]-t[1]})),this.getProperty("groupByMaxNumber")){let t=+this.getProperty("groupByMaxNumber");H=H.filter(((e,i)=>i<t))}let a=[];return a.push(R),H.forEach((t=>a.push(t))),a}if(this.getProperty("movingAverageSteps")){this.getProperty("movingAverageSteps");let t=[m[n]],e=m[1].tuple.map(((t,e)=>Utils.isNumber(t)));m.forEach(((i,a)=>{if(0==a)return;let s=Utils.mergeLists(i.tuple);t.push({record:i.record,tuple:s}),s[0]="x",s[1]=5,s.forEach(((t,i)=>{e[i]&&(s[i]=5)}))})),m=t}return m},isGoogleLoaded:function(){return"undefined"!=typeof google&&void 0!==google.visualization&&void 0!==google.visualization.DateFormat},initDateFormats:function(){if(!this.isGoogleLoaded())return!1;if(this.fmt_yyyy)return!0;var t=0;return this.timezone=this.getProperty("timezone"),Utils.isDefined(this.timezone)&&(t=parseFloat(this.timezone)),this.fmt_yyyymmddhhmm=new google.visualization.DateFormat({pattern:"yyyy-MM-dd HH:mm Z",timeZone:t}),this.fmt_yyyymmdd=new google.visualization.DateFormat({pattern:"yyyy-MM-dd",timeZone:t}),this.fmt_yyyy=new google.visualization.DateFormat({pattern:"yyyy",timeZone:t}),!0},getDateValue:function(t){if(!this.initDateFormats())return t;if(date="object"!=typeof t?new Date(t):t,isNaN(date.getUTCFullYear()))return{v:date,f:"NA"};if(this.getProperty("dateFormatDaysAgo",!1)){let t=new Date,e=Math.round((t.getTime()-date.getTime())/1e3/60/60/24);return{v:date,f:e+" days ago"}}return{v:date,f:this.formatDate(date)}},applyFilters:function(t,e){return this.filters.forEach((e=>{if(!e.isRecordOk(t))return!1})),!0}});let r=this.getProperty(PROP_DISPLAY_FILTER);if(null!=r)for(var o=r.split(";"),n=0;n<o.length;n++){r=o[n];var h=r.split(":"),d=h[0];"month"==d?this.filters.push(new MonthFilter(h[1])):this.handleError("Unknown filter:"+d)}}function DisplayGroup(t,e,i,a){const s="table",l="htable",r="tabs",o="columns",n="rows",h=new RamaddaDisplay(t,e,a||"group",i);RamaddaUtil.inherit(this,h),displayDefineMembers(this,[{label:"Group Properties"},{p:PROP_LAYOUT_TYPE,ex:Utils.join([s,l,r,o,n],",")},{p:PROP_LAYOUT_COLUMNS,d:1}],{displays:[],layout:this.getProperty(PROP_LAYOUT_TYPE,s),columns:this.getProperty(PROP_LAYOUT_COLUMNS,1),isLayoutColumns:function(){return this.layout==o},getWikiText:function(){var t=["layoutType",this.layout,"layoutColumns",this.columns,"showMenu","false","groupDiv","$entryid_maindiv"];let e="";return e+='<div id="{{entryid}}_maindiv"></div>\n',e+="{{group "+HU.attrs(t)+"}}\n",e},walkTree:function(t,e){for(var i=0;i<this.displays.length;i++){let a=this.displays[i];null!=a.walkTree?a.walkTree(t,e):t.call(e,a)}},collectEntries:function(t){null==t&&(t=[]);for(let e=0;e<this.displays.length;e++){let i=this.displays[e];if(null!=i.collectEntries)i.collectEntries(t);else{let e=i.getEntries();null!=e&&e.length>0&&t.push({source:i,entries:e})}}return t},isLayoutRows:function(){return this.layout==n},getPosition:function(){for(let t=0;t<this.displays.length;t++){let e=this.displays[t];if(e.getPosition)return e.getPosition()}},getDisplays:function(){return this.displays},notifyEvent:function(t,e,i){this.getDisplays();let a=null!=e&&e.getProperty?e.getProperty(t+".shareGroup"):"";displayDebug.notifyEvent&&console.log("displayManager.notifyEvent:"+t);for(let s=0;s<this.displays.length;s++){let l=this.displays[s];if(l==e)continue;let r=null!=l&&l.getProperty?l.getProperty(t.acceptGroup):"";if(a){if(r!=a){displayDebug.notifyEvent&&console.log("\t"+l.type+" not in group:"+a);continue}}else if(r){displayDebug.notifyEvent&&console.log("\t"+l.type+" incoming not in accept group:"+r);continue}if(!l.acceptEvent(t,t.default)){displayDebug.notifyEvent&&console.log("\t"+l.type+" not accepting");continue}let o=l.getEventSource();null!=o&&o.length>0&&o!=e.getId()&&o!=e.getName()||l.notifyEvent(t,e,i)}},getDisplaysToLayout:function(){let t=[];for(let e=0;e<this.displays.length;e++)this.displays[e].getIsLayoutFixed()||t.push(this.displays[e]);return t},pageHasLoaded:function(t){this.doLayout()},addDisplay:function(t){this.displays.push(t),t.getIsLayoutFixed()?t.initDisplay():Utils.getPageLoaded()&&this.doLayout()},layoutChanged:function(t){this.doLayout()},removeDisplay:function(t){let e=this.displays.indexOf(t);e>=0&&this.displays.splice(e,1),this.doLayout()},doLayout:function(){let t="",e=100,i=this.getDisplaysToLayout();this.displays.forEach((t=>{null!=t.prepareToLayout&&t.prepareToLayout()}));let a=0,h=null;void 0!==this.weights&&(h=this.weights.split(","));for(let t=0;t<i.length;t++){let e=HU.getUniqueId("divid_"),a=HU.div([CLASS," display-wrapper",ID,e],"");i[t].setProperty(PROP_DIVID,e),i[t].layoutDiv=a}let d=HU.getUniqueId("tabs_");if(this.layout==s)if(1==i.length)t+=i[0].layoutDiv;else{let s=12/this.columns,l=0,r={};for(;l<i.length;l++){let t=i[l];if(Utils.isDefined(t.column)&&Utils.isDefined(t.row)&&t.columns>=0&&t.row>=0){let e=t.column+"_"+t.row;null==r[e]&&(r[e]=[]),r[e].push(t)}}for(l=0;l<i.length;l++){e++,e>=this.columns&&(l>0&&(t+=HU.close(TAG_DIV)),t+=HU.open("div",[CLASS,"row"]),e=0);let r=s;null!=h&&(a>=h.length&&(a=0),r=h[a],a++),t+=HU.div([CLASS,"col-md-"+r+" display-wrapper display-cell"],i[l].layoutDiv),t+="\n"}l>0&&(t+=HU.close(TAG_DIV))}else if(this.layout==l)if(1==i.length)t+=i[0].layoutDiv;else{let e=Math.round(100/this.columns)+"%",a=0;t+=HU.open(TABLE,[WIDTH,"100%"]);let s=100;for(let a=0;a<i.length;a++)s++,s>=this.columns&&(a>0&&(t+=HU.close(TAG_TR)),t+=HU.open("tr",["valign","top"]),t+="\n",s=0),t+=HU.td(["width",e],i[a].layoutDiv),t+="\n";a>0&&(t+=HU.close(TAG_TR))}else if(this.layout==r){t+=HU.open(TAG_DIV,[ID,d,CLASS,"ui-tabs"]),t+=HU.open(TAG_UL,[]);let e="",a=0;for(let s=0;s<i.length;s++){let l=i[s],r=l.getTitle(!1);r.length>20&&(r=r.substring(0,19)+"..."),t+=HU.tag(TAG_LI,[],HU.tag(TAG_A,["href","#"+d+"-"+a],r)),e+=HU.div([ID,d+"-"+a,CLASS,"ui-tabs-hide"],l.layoutDiv),a++}t+=HU.close(TAG_UL),t+=e,t+=HU.close(TAG_DIV)}else if(this.layout==n){let e=[];for(let t=0;t<i.length;t++){let a=i[t],s=a.getRow();for(0==(""+s).length&&(s=0);e.length<=s;)e.push([]);e[s].push(a.layoutDiv)}for(let i=0;i<e.length;i++){let a=e[i],s=Math.round(100/a.length)+"%";t+=HU.open(TAG_TABLE,["border","0","width","100%","cellpadding","0","cellspacing","0"]),t+=HU.open(TAG_TR,["valign","top"]);for(let e=0;e<a.length;e++){let i=a[e];i=HU.div([CLASS,"display-cell"],i),t+=HU.tag(TAG_TD,["width",s],i)}t+=HU.close(TAG_TR),t+=HU.close(TAG_TABLE)}}else if(this.layout==o){let e=[];for(let t=0;t<i.length;t++){let a=i[t],s=a.getColumn();for(0==(""+s).length&&(s=0);e.length<=s;)e.push([]);e[s].push(a.layoutDiv)}t+=HU.open(TAG_DIV,[CLASS,"row"]);Math.round(100/e.length);let s=12/e.length;for(let i=0;i<e.length;i++){let l=e[i],r="";for(let t=0;t<l.length;t++)r+=l[t];let o=s;null!=h&&(a>=h.length&&(a=0),o=h[a],a++),t+=HU.div([CLASS,"col-md-"+o],r)}t+=HU.close(TAG_DIV)}else t+="Unknown layout:"+this.layout;(this.getShowMenu()||0!=i.length)&&$("#"+this.getId()).show();let p=this.getGroupDiv();p.length>0?p.html(t):this.writeHtml(ID_DISPLAYS,t),this.layout==r&&$("#"+d).tabs({activate:HtmlUtil.tabLoaded}),this.initDisplays()},initDisplays:function(){this.getDisplaysToLayout().forEach((t=>{try{t.initDisplay()}catch(e){t.handleError("Error creating display:<br>"+e,e)}}))},displayData:function(){},setLayout:function(t,e){this.layout=t,e&&(this.columns=e),this.doLayout()},askMinZAxis:function(){let t=prompt("Minimum axis value","0");if(null!=t){t=parseFloat(t);for(let e=0;e<this.displays.length;e++){let i=this.displays[e];i.setMinZAxis&&i.setMinZAxis(t)}}},askMaxZAxis:function(){let t=prompt("Maximum axis value","0");if(null!=t){t=parseFloat(t);for(let e=0;e<this.displays.length;e++){let i=this.displays[e];i.setMaxZAxis&&i.setMaxZAxis(t)}}},askMinDate:function(){let t=this.minDate;if(t||(t="1950-0-0"),this.minDate=prompt("Minimum date",t),null!=this.minDate)for(let t=0;t<this.displays.length;t++){let e=this.displays[t];e.setMinDate&&e.setMinDate(this.minDate)}},askMaxDate:function(){let t=this.maxDate;if(t||(t="2020-0-0"),this.maxDate=prompt("Maximum date",t),null!=this.maxDate)for(let t=0;t<this.displays.length;t++){let e=this.displays[t];e.setMaxDate&&e.setMaxDate(this.maxDate)}},titlesOff:function(){for(let t=0;t<this.displays.length;t++)this.displays[t].setShowTitle(!1)},titlesOn:function(){for(let t=0;t<this.displays.length;t++)this.displays[t].setShowTitle(!0)},detailsOff:function(){for(let t=0;t<this.displays.length;t++)this.displays[t].setShowDetails(!1);this.doLayout()},detailsOn:function(){for(let t=0;t<this.displays.length;t++)this.displays[t].setShowDetails(!0);this.doLayout()},deleteAllDisplays:function(){this.displays=[],this.doLayout()},moveDisplayUp:function(t){let e=this.displays.indexOf(t);e<=0||(this.displays.splice(e,1),this.displays.splice(e-1,0,t),this.doLayout())},moveDisplayDown:function(t){let e=this.displays.indexOf(t);e>=this.displays.length||(this.displays.splice(e,1),this.displays.splice(e+1,0,t),this.doLayout())},moveDisplayTop:function(t){let e=this.displays.indexOf(t);e>=this.displays.length||(this.displays.splice(e,1),this.displays.splice(0,0,t),this.doLayout())}})}function RamaddaFieldsDisplay(t,e,i,a){const s=new RamaddaDisplay(t,e,i,a);defineDisplay(this,s,[],{needsData:function(){return!0},initDisplay:function(){s.initDisplay.call(this),this.needsData()&&(this.useDisplayMessage()?this.setDisplayMessage(this.getLoadingMessage()):this.setContents(this.getLoadingMessage())),this.callUpdateUI()},updateUI:function(t){this.addFieldsCheckboxes()},getWikiAttributes:function(t){if(s.getWikiAttributes.call(this,t),this.lastSelectedFields){t.push(PROP_FIELDS);for(var e="",i=0;i<this.lastSelectedFields.length;i++)e+=this.lastSelectedFields[i].getId(),e+=",";t.push(e)}},initDialog:function(){s.initDialog.call(this),this.addFieldsCheckboxes()},getDialogContents:function(t,e){s.getDialogContents.call(this,t,e)},handleEventFieldsSelected:function(t,e){var i=[];e.forEach((t=>{let e=t.getId?t.getId():t;(t=this.getFieldById(null,e))&&i.push(t)})),e=i,this.userHasSelectedAField=!0,this.overrideFields=null,this.removeProperty(PROP_FIELDS),this.setSelectedFields(e),this.fieldSelectionChanged()},getFieldsToSelect:function(t){return t.getRecordFields()},canDoMultiFields:function(){return!0}})}addGlobalDisplayType({type:"group",label:"Group",requiresData:!1,forUser:!0,category:"Basic Charts",tooltip:makeDisplayTooltip("Create a collection of displays",null,"This allows you to layout displays and share common attributes"),helpUrl:!0},!0);const PROP_LAYOUT_TYPE="layoutType",PROP_LAYOUT_COLUMNS="layoutColumns",PROP_SHOW_MAP="showMap",PROP_SHOW_MENU="showMenu",PROP_FROMDATE="fromDate",PROP_TODATE="toDate",DISPLAY_MULTI="multi";function addDisplayManager(t){null==window.globalDisplayManagers&&(window.globalDisplayManagers={}),window.globalDisplayManagers[t.getId()]=t,window.globalDisplayManager=t}function getOrCreateDisplayManager(t,e,i){if(!i){if(null!=(a=getDisplayManager(t)))return a;if(null!=window.globalDisplayManager)return window.globalDisplayManager}var a=new DisplayManager(t,e);return null==window.globalDisplayManager&&(window.globalDisplayManager=a),a}function getDisplayManager(t){return null==window.globalDisplayManagers?null:window.globalDisplayManagers[t]}addGlobalDisplayType({type:DISPLAY_MULTI,label:"Multi Chart",requiresData:!0,forUser:!1,category:"Misc"});var ID_DISPLAYS="displays";function DisplayManager(argId,argProperties){var ID_MENU_BUTTON="menu_button",ID_MENU_CONTAINER="menu_container",ID_MENU_OUTER="menu_outer",ID_MENU_INNER="menu_inner";RamaddaUtil.inherit(this,this.SUPER=new DisplayThing(argId,argProperties)),addRamaddaDisplay(this),RamaddaUtil.initMembers(this,{dataList:[],displayTypes:[],initMapBounds:null}),RamaddaUtil.defineMembers(this,{group:new DisplayGroup(this,argId,argProperties),showmap:this.getProperty(PROP_SHOW_MAP,null),setDisplayReady:function(){SUPER.setDisplayReadyCall(this),this.getLayoutManager().setDisplayReady()},getLayoutManager:function(){return this.group},collectEntries:function(){return this.getLayoutManager().collectEntries()},getData:function(){return this.dataList},handleEventFieldValueSelect:function(t,e){this.notifyEvent(DisplayEvent.fieldValueSelected,t,e)},handleEventFieldsSelected:function(t,e){this.notifyEvent(DisplayEvent.fieldsSelected,t,e)},handleEventPropertyChanged:function(t,e){this.notifyEvent(DisplayEvent.propertyChanged,t,e)},handleEventEntriesChanged:function(t,e){this.notifyEvent(DisplayEvent.entriesChanged,t,e)},handleEventMapBoundsChanged:function(t,e,i){var a={bounds:e,force:i};this.notifyEvent(DisplayEvent.mapBoundsChanged,t,a)},addMapLayer:function(t,e){this.notifyEvent("addMapLayer",t,{entry:e})},propagateEventRecordSelection:function(t,e,i){var a=i.index;null==e&&this.dataList.length>0&&(e=this.dataList[0]);var s=e.getRecordFields(),l=e.getRecords();if(null!=l)if(a<0||a>=l.length)console.log("propagateEventRecordSelection: bad index= "+a);else{var r=l[a];if(null!=r){var o=t?t.getRecordHtml(r,s):"";if(t.recordSelectionCallback){var n=t.recordSelectionCallback;"string"==typeof n&&(n=window[n]),n({display:t,pointData:e,index:a,pointRecord:r})}var h={index:a,record:r,html:o,data:e};this.notifyEvent(DisplayEvent.recordSelection,t,h);var d=t.getEntries();null!=d&&d.length>0&&this.handleEventEntrySelection(t,{entry:d[0],selected:!0})}}},handleEventEntrySelection:function(t,e){this.notifyEvent(DisplayEvent.entrySelection,t,e)},handleEventEntryMouseover:function(t,e){this.notifyEvent(DisplayEvent.entryMouseover,t,e)},handleEventEntryMouseout:function(t,e){this.notifyEvent(DisplayEvent.entryMouseout,t,e)},handleEventPointDataLoaded:function(t,e){this.notifyEvent(DisplayEvent.pointDataLoaded,t,e)},ranges:{},setRange:function(t,e){null==this.ranges[t.getId()]&&(this.ranges[t.getId()]=e)},getRange:function(t){return this.ranges[t.getId()]},makeMainMenu:function(){if(!this.getShowMenu())return"";var t="getDisplayManager('"+this.getId()+"')",e="getDisplayManager('"+this.getId()+"').getLayoutManager()",i="",a={},s=[],l=[];null!=window.globalDisplayTypes&&(l=window.globalDisplayTypes),DISPLAY_CATEGORIES.forEach((t=>{a[t]=[],s.push(t)}));for(var r=0;r<l.length;r++){var o=l[r];if(Utils.isDefined(o.forUser)&&!o.forUser)continue;var n=o.category;n||(n=CATEGORY_MISC),null==a[n]&&(a[n]=[],s.push(n));let e=["onclick",t+".userCreateDisplay('"+o.type+"');"];o.desc&&(e.push(TITLE),e.push(o.desc)),a[n].push(HU.tag(TAG_LI,[],HU.tag(TAG_A,e,o.label)))}let h="";for(r=0;r<s.length;r++){var d=s[r],p=Utils.join(a[d],""),g=HU.tag("ul",[],p),c=HU.tag(TAG_A,[],d);h+=HU.tag(TAG_LI,[],c+g)}var u=HU.tag(TAG_LI,[],HU.onClick(e+".publish('media_photoalbum');","New Photo Album"))+"\n"+HU.tag(TAG_LI,[],HU.onClick(e+".publish('wikipage');","New Wiki Page"))+"\n"+HU.tag(TAG_LI,[],HU.onClick(e+".publish('blogentry');","New Blog Post"))+"\n",y=HU.tag(TAG_LI,[],"<a>Publish</a>"+HU.tag("ul",[],u))+"\n"+HU.tag(TAG_LI,[],HU.onClick(e+".showWikiText();","Show Text"))+"\n"+HU.tag(TAG_LI,[],HU.onClick(e+".copyWikiText();","Copy Text"))+"\n"+HU.tag(TAG_LI,[],HU.onClick(e+".copyDisplayedEntries();","Save entries"))+"\n",m=HU.tag(TAG_DIV,["class","ramadda-menu-block"],"Titles: "+HU.onClick(e+".titlesOn();","On")+"/"+HU.onClick(e+".titlesOff();","Off")),f=HU.tag(TAG_DIV,["class","ramadda-menu-block"],"Set date range: "+HU.onClick(e+".askMinDate();","Min")+"/"+HU.onClick(e+".askMaxDate();","Max")),D=HU.tag(TAG_LI,[],HU.tag(TAG_DIV,["class","ramadda-menu-block"],"Set axis range :"+HU.onClick(e+".askMinZAxis();","Min")+"/"+HU.onClick(e+".askMaxZAxis();","Max")))+HU.tag(TAG_LI,[],f)+HU.tag(TAG_LI,[],m)+"\n"+HU.tag(TAG_LI,[],HU.tag(TAG_DIV,["class","ramadda-menu-block"],"Details: "+HU.onClick(e+".detailsOn();","On",[])+"/"+HU.onClick(e+".detailsOff();","Off",[])))+HU.tag(TAG_LI,[],HU.onClick(e+".deleteAllDisplays();","Delete all displays"))+"\n",I=HU.tag(TAG_DIV,["class","ramadda-menu-block"],"Table: "+HU.onClick(e+".setLayout('table',1);","1 column")+" / "+HU.onClick(e+".setLayout('table',2);","2 column")+" / "+HU.onClick(e+".setLayout('table',3);","3 column")+" / "+HU.onClick(e+".setLayout('table',4);","4 column")),T=HU.tag(TAG_LI,[],I)+HU.tag(TAG_LI,[],HU.onClick(e+".setLayout('rows');","Rows"))+"\n"+HU.tag(TAG_LI,[],HU.onClick(e+".setLayout('columns');","Columns"))+"\n"+HU.tag(TAG_LI,[],HU.onClick(e+".setLayout('tabs');","Tabs")),b=HU.tag(TAG_LI,[],"<a>File</a>"+HU.tag("ul",[],y));return b+=HU.tag(TAG_LI,[],"<a>Edit</a>"+HU.tag("ul",[],D))+HU.tag(TAG_LI,[],"<a>New</a>"+HU.tag("ul",[],h))+HU.tag(TAG_LI,[],"<a>Layout</a>"+HU.tag("ul",[],T)),i+=p=HU.div([STYLE,"background:#fff;z-index:1000;",ATTR_CLASS,"xramadda-popup",ATTR_ID,this.getDomId(ID_MENU_OUTER)],HU.tag("ul",[ATTR_ID,this.getDomId(ID_MENU_INNER),ATTR_CLASS,"sf-menu"],b))},hasGeoMacro:function(t){return!!t&&null!=t.match(/(\${latitude})/g)},getJsonUrl:function(t,e,i){if(e.getRequestMacros().forEach((e=>{t=e.apply(t)})),e.getAnimationEnabled(),e.getProperty("dbSelect")&&(t+="&dbSelect="+e.getProperty("select")),e.getProperty("requestArgs")){let i=e.getProperty("requestArgs").split(",");for(let e=0;e<i.length;e+=2)t+="&"+i[e]+"="+i[e+1]}e.pageSkip&&(t+="&skip="+e.pageSkip);var a=e.getProperty(PROP_FROMDATE);null!=a&&(t+="&fromdate="+a);var s=e.getProperty(PROP_TODATE);if(null!=s&&(t+="&todate="+s),this.hasGeoMacro(t)){var l=i.lon,r=i.lat;if((null==l||null==r)&&null!=this.map){var o=this.getPosition();null!=o&&(r=o[0],l=o[1])}null!=l&&null!=r&&(t=(t=t.replace("${latitude}",r.toString())).replace("${longitude}",l.toString()))}return t=t.replace("${numpoints}",1e3)},getDefaultData:function(){for(var t in this.dataList){var e=this.dataList[t];if(null!=e.getRecords())return e}return this.dataList.length>0?this.dataList[0]:null},writeDisplay:function(){null==this.originalLocation&&(this.originalLocation=document.location);var t=this.originalLocation+"#";for(var e in t+="&display0=linechart",document);document.location=t},userCreateDisplay:function(t,e){if(null==e&&(e={}),e.editMode=!0,e.layoutHere=!1,t==DISPLAY_LABEL&&null==e.text){var i=prompt("Text");if(null==i)return;e.text=i}return this.createDisplay(t,e)},createDisplay:function(type,props){if(null==props&&(props={}),null!=props.data&&(props.theData=props.data,props.data=null),null!=props.theData&&!props.theData.hasData()){let t=!1;for(var i=0;i<this.dataList.length;i++){let e=this.dataList[i];if(e.equals(props.theData)){props.theData=e,t=!0;break}}t||this.dataList.push(props.theData)}if(null==type||0==type.trim().length)return null;for(var proc=type.substring(0,1).toUpperCase()+type.substring(1),classname=null,names=["Ramadda"+proc+"Display",proc+"Display","Display"+proc,proc],func=null,funcName=null,msg="",i=0;i<names.length;i++)if(msg+="trying:"+names[i]+"\n",null!=window[names[i]]){funcName=names[i],func=window[names[i]];break}if(null==func)return console.log("Error: could not find display function:"+type),void alert("Error: could not find display function:"+type+" msg: "+msg);let displayId=props.displayId;displayId||(displayId=this.getUniqueId("display")),null==props.theData&&this.dataList.length>0&&(props.theData=this.dataList[0]),props.createdInteractively=!0,props.entryId||(props.entryId=this.group.entryId);let display=eval(" new "+funcName+"(this,'"+displayId+"', props);");return null==display?(console.log("Error: could not create display using:"+funcName),void alert("Error: could not create display using:"+funcName)):(props.dummy||(this.addDisplay(display),display.doFinalInitialization()),display)},pageHasLoaded:function(t){this.getLayoutManager().pageHasLoaded()},addDisplay:function(t){t.setDisplayManager(this),t.loadInitialData(),this.getLayoutManager().addDisplay(t)},getDisplays:function(){return this.getLayoutManager().getDisplays()},notifyEvent:function(t,e,i){this.getLayoutManager().notifyEvent(t,e,i)},removeDisplay:function(t){this.getLayoutManager().removeDisplay(t),this.notifyEvent(DisplayEvent.removeDisplay,this,t)},setEntry:function(t){this.getLayoutManager().getDisplays().forEach((e=>{e.setEntry(t)}))}}),addDisplayManager(this);let displaysHtml=HU.div([ATTR_ID,this.getDomId(ID_DISPLAYS),ATTR_CLASS,"display-container",STYLE,HU.css("display","block")]),html=HU.openTag(TAG_DIV,["style","position:relative;"]);html+=HU.div(["id",this.getDomId(ID_MENU_CONTAINER)]),html+=this.getEntriesMenu(argProperties),this.getShowMenu()&&(html+=HU.tag(TAG_A,[ATTR_CLASS,"display-menu-button",ATTR_ID,this.getDomId(ID_MENU_BUTTON)],SPACE));let targetDiv=this.getProperty("target",this.getProperty("targetDiv")),_this=this;null!=targetDiv&&0==$("#"+targetDiv).length&&(console.log("Error: display group could not find targetDiv:"+targetDiv),targetDiv=null),null!=targetDiv?$(document).ready((function(){$("#"+targetDiv).html(displaysHtml),_this.getLayoutManager().doLayout()})):html+=displaysHtml,html+=HU.closeTag(TAG_DIV);let divid=this.getProperty("divId",this.getId());$("#"+divid).html(html),this.initializeEntriesMenu(),this.jq(ID_MENU_BUTTON).html(HU.getIconImage("fa-cog",[TITLE,"Display menu"])).button({classes:{"ui-button":"display-manager-button"}}).click((function(t){this.dialog&&this.dialog.remove();let e=_this.makeMainMenu();this.dialog=HU.makeDialog({content:e,title:"Displays",my:"left top",at:"left bottom",anchor:_this.jq(ID_MENU_BUTTON)}),_this.jq(ID_MENU_INNER).superfish({speed:"fast",delay:300})}))}function RamaddaMultiDisplay(t,e,s){this.props=s;let l=new DisplayGroup(t,e,s,DISPLAY_MULTI);RamaddaUtil.inherit(this,l),addRamaddaDisplay(this),RamaddaUtil.defineMembers(this,{inInitDisplay:!1,haveInited:!1,needsData:function(){return!0},pointDataLoaded:function(t,e,i){l.pointDataLoaded.call(this,t,e,i),this.initDisplay()},processMacros:function(t,e,a){if("string"!=typeof e)return null;var s=[];if(e.includes("${fieldLabel}"))for(i=0;i<t.length;i++){var l=e.replace("${fieldLabel}",t[i].getLabel());s.push(l)}else if(e.includes("${fieldId}"))for(i=0;i<t.length;i++){l=e.replace("${fieldId}",t[i].getId());s.push(l)}else if(e.includes("${fieldCnt}")){l=e.replace("${fieldCnt}",t.length);s.push(l)}else if(!e.includes("${"))return null;return a?s:Utils.join(s,",")},initDisplay:function(){try{this.initDisplayInner()}catch(t){this.setContents(this.getMessage("An error occurred:"+t)),console.log("An error occurred:"+t),console.log(t.stack)}},useChartableFields:function(){return!1},initDisplayInner:function(){if(l.initDisplay.call(this),!this.filterData())return this.setDisplayMessage(this.getLoadingMessage()),null;var t=this.getData().getRecordFields(),e=this.getSelectedFields(t);if(0!=e.length){if(!this.inInitDisplay&&!this.haveInited){this.haveInited=!0,this.inInitDisplay=!0;var i={},s={},r=[],o=0;for(a in this.props){if(a.startsWith("foreach_")){var n,h=this.props[a];n=(d=this.processMacros(e,h,!0))||h.split(","),a=a.substring(8),n.length>o&&(o=n.length),s[a]=n,r.push({attr:a,toks:n})}if(a.startsWith("sub_")){var d;h=this.props[a];a=a.substring(4),(d=this.processMacros(e,h,!1))&&(h=d),i[a]=h}}var p=HU.div([ATTR_ID,this.getDomId(ID_DISPLAYS),ATTR_CLASS,"display-container"]);this.setContents(p);var g={target:this.getDomId(ID_DISPLAYS)};g[PROP_LAYOUT_TYPE]="table",g[PROP_LAYOUT_COLUMNS]=this.getProperty(PROP_LAYOUT_COLUMNS,"2"),this.displayManager=new DisplayManager(this.getId()+"_manager",g),i.layoutHere=!1,this.props.data&&(i.data=this.props.data);var c=this.getProperty("subType","table");0==o&&(o=1);for(var u=0;u<o;u++){var y={};$.extend(y,i);for(var m=0;m<r.length;m++)u<r[m].toks.length&&(y[r[m].attr]=r[m].toks[u]);y.fields&&(y.fields=y.fields.split(",")),this.displayManager.createDisplay(c,y)}this.inInitDisplay=!1}}else this.setContents(this.getMessage("no fields"))}})}const FILTER_ALL="-all-";let pointDataCache={};function DataCollection(){RamaddaUtil.defineMembers(this,{data:[],hasData:function(){for(var t=0;t<this.data.length;t++)if(this.data[t]&&this.data[t].hasData())return!0;return!1},getList:function(){return this.data},setData:function(t){this.data=[t]},addData:function(t){this.data.push(t)},handleEventMapClick:function(t,e,i,a){for(var s=!1,l=0;l<this.data.length;l++)this.data[l].handleEventMapClick(t,e,i,a)&&(s=!0);return s}})}function BasePointData(t,e){null==e&&(e={}),RamaddaUtil.defineMembers(this,{recordFields:null,records:null,entryId:null,entry:null}),$.extend(this,e),RamaddaUtil.defineMembers(this,{name:t,properties:e,initWith:function(t){return this.recordFields=t.recordFields,this.records=t.records,this.setGroupField(),this},handleEventMapClick:function(t,e,i,a){return!1},hasData:function(){return null!=this.records&&this.records.length>0},clear:function(){this.records=null,this.recordFields=null},getProperties:function(){return this.properties},getProperty:function(t,e){var i=this.properties[t];return null==i?e:i},getRecordFields:function(){return this.recordFields},addRecordField:function(t){this.recordFields.push(t)},getRecords:function(){return this.records},getNumericFields:function(){for(var t=this.getRecordFields(),e=[],i=0;i<t.length;i++){var a=t[i];a.isNumeric()&&e.push(a)}return e},getChartableFields:function(t){for(var e=this.getRecordFields(),i=[],a=/(xxxnoskip)/g,s=0;s<e.length;s++){var l=e[s];if(l.isNumeric()&&l.isChartable())l.getId().toUpperCase().match(a)||i.push(l)}return RecordUtil.sort(i)},getNonGeoFields:function(t){for(var e=this.getRecordFields(),i=[],a=!1,s=0;s<e.length;s++){var l=e[s];if(!l.isFieldGeo()){if(l.isFieldDate()){if(a&&"recordDate"==l.getId())continue;a=!0}i.push(l)}}return i},loadData:function(t){},getName:function(){return this.name},getTitle:function(){return null!=this.records&&this.records.length>0?this.name+" - "+this.records.length+" points":this.name}})}function convertToPointData(t){for(var e=[],i=[],a=t[0],s=t[1],l=0;l<a.length;l++){let t,i=String(a[l]),r=i.toLowerCase().replace(/[ ., ]+/g,"_"),o=s[l],n=typeof o;"string"==n?t="string":"number"==n?t="double":o.getTime?t="date":console.log("Unknown type:"+n),e.push(new RecordField({id:r,index:l,label:i,type:t,chartable:!0}))}for(l=1;l<t.length;l++)i.push(new PointRecord(e,NaN,NaN,NaN,null,t[l]));return new PointData("pointdata",e,i,null,null)}function PointData(t,e,i,a,s){RamaddaUtil.inherit(this,new BasePointData(t,s)),this.parentPointData=s?s.parent:null,RamaddaUtil.defineMembers(this,{recordFields:e,records:i,url:a,baseUrl:a,loadingCnt:0,getRootPointData:function(){return this.parentPointData?this.parentPointData.getRootPointData():this},getUrl:function(){return this.url?this.url:this.parentPointData?this.parentPointData.getUrl():null},getCacheUrl:function(){return this.baseUrl?this.baseUrl:this.parentPointData?this.parentPointData.getCacheUrl():null},equals:function(t){return this.jsonUrl?this.jsonUrl==t.jsonUrl:this.url==t.url},getIsLoading:function(){return this.loadingCnt>0},handleEventMapClick:function(t,e,i,a){let s=this.getUrl();pointDataCache[s];return this.lon=i,this.lat=a,!!t.getDisplayManager().hasGeoMacro(s)&&(this.loadData(t,!0),!0)},startLoading:function(){this.loadingCnt++},stopLoading:function(){this.loadingCnt--},setGroupField:function(){if(this.recordFields)for(var t=0;t<this.recordFields.length;t++){var e=this.recordFields[t];if(e.isFieldGroup()){this.groupField=e;break}}},extractGroup:function(t,e){if(!this.groupField)return e;var i=this.getDataGroups(e);return 0==i.length||t||(t=i[0]),e},getDataGroups:function(t){if(!this.groupData){if(!t)return[];this.groupData=[];var e=this.getGroupField();if(!e)return this.groupData;for(var i={},a=0;a<t.length;a++){var s,l=t[a];l.tuple?s=l.tuple:l.record&&(s=l.record.getData()),console.log("data:"+s);var r=e.getValue(l);i[r]||(i[r]=!0,this.groupData.push(r))}}return console.log(this.groupData),this.groupData},getGroupField:function(){return this.groupField},isGroup:function(){return null!=this.getGroupField()},loadData:function(t,e){let i=this.getRootPointData();if(null==i.url)return void console.log("No URL");let a={lat:this.lat,lon:this.lon},s=t.displayManager.getJsonUrl(i.url,t,a);i.jsonUrl=s,i.loadPointJson(s,t,e)},getCacheObject:function(){let t=pointDataCache[this.getUrl()];if(!t){let e=this.getCacheUrl();e&&(t=pointDataCache[e])}return t},propagateEventDataChanged:function(t){let e=this.getCacheObject();if(e){let i=e.displays;i&&i.forEach((e=>{e!=t&&e.pointDataLoaded(this,this.url,!0)}))}},loadPointJson:function(t,e,i){let a=displayDebug.loadPointJson,s=this;this.startLoading();let l=this;a&&console.log("loadPointJson: "+e.type+" "+e.getId()+" url:"+t);let r=this.getCacheUrl(),o=pointDataCache[r];if(null==o)o={pointData:null,pending:[],displays:[],size:0,url:t,toString:function(){return"cache:"+(null==this.pointData?" no data ":" data:"+this.pointData.pdcnt+" "+this.pointData.getRecords().length)+" url:"+this.url}},a&&console.log("\tcreated cache object: "+r),pointDataCache[r]=o;else{if(o.pending.indexOf(e)>=0)return void(a&&console.log("\tcache hit - display in pending list"));a&&console.log("\tcache hit - display not in pending list")}if(o.displays.indexOf(e)<0&&o.displays.push(e),i)o.pointData=null,o.pending=[],a&&console.log("\treloading adding to pending:"+o.displays),o.displays.forEach((t=>{a&&console.log("\tdisplay:"+t.type+" "+t.getId()),o.pending.push(t)}));else{if(o.displays.indexOf(e)<0&&o.displays.push(e),null!=o.pointData)return a&&console.log("\tdata was in cache:"+o.pointData.getRecords().length+" url:"+t),void e.pointDataLoaded(o.pointData,t,i);if(o.pending.push(e),o.pending.length>1)return void(a&&console.log("\tWaiting on callback:"+o.pending.length+" "+t+" d:"+e))}let n=t;n.startsWith("http")||(n=window.location.protocol+"//"+window.location.host+n);if(!t.startsWith("/")&&!t.startsWith("http")){let e=String(window.location).replace(/\/[^\/]+$/,"");t=e+"/"+t}e.handleLog("display:"+e.type+" data:"+t),Utils.doFetch(t,(function(r){if("string"==typeof r)try{r=JSON.parse(r)}catch(i){return console.log("Error:"+i),r.length>1e3&&(r=r.substring(0,999)),console.log("data:"+r),void e.displayError("Error loading data:"+i+"<br>URL:"+t)}if(a&&console.log("pointDataLoaded"),GuiUtils.isJsonError(r))return a&&console.log("\tloadPointData failed"),console.log("loadPointData failed:"+t),console.dir(r),void e.pointDataLoadFailed(r);if("nodata"==r.errorcode||!r.fields){a&&console.log("\tno data:"+t);let e=new PointData("",[],[]),i=o.pending;return o.pending=[],void i.forEach((t=>{t.handleNoData(e)}))}a&&console.log("\tmaking point data");let n=new Date;var h=makePointData(r,l.derived,e,l.url);let d=new Date;a&&Utils.displayTimes("makePointData",[n,d],!0),a&&console.log("\tdone making point data #records:"+h.getRecords().length),s=o.pointData=h,r.properties&&e.applyRequestProperties(r.properties);let p=o.pending;a&&(console.log("\tcalling pointDataLoaded on  "+p.length+" pending displays"),o.displays&&console.log("\tcacheObject.displays:"+o.displays.length)),o.pending=[];for(let e=0;e<p.length;e++)a&&console.log("\tcalling pointDataLoaded:"+p[e]+" #:"+s.getRecords().length),p[e].pointDataLoaded(s,t,i);o.pointData.records&&o.pointData.records.length&&(o.size=o.pointData.records.length*o.pointData.records[0].getData().length);let g=0;Object.keys(pointDataCache).map((t=>{g+=pointDataCache[t].size})),a&&console.log("\tcache size:"+g),g>1e6&&Object.keys(pointDataCache).map((t=>{0==pointDataCache[t].pending.length&&(a&&console.log("\tDeleting from cache:"+t),delete pointDataCache[t])})),s.stopLoading()}),(function(e,i,a){console.log("Point data load error:"+i+" "+a);var l=i;l?a&&(l+=": "+a):l=a,console.log("Point data load error:"+t+" "+(l||"")),o.pending.map((t=>{t.pointDataLoadFailed(l)})),delete pointDataCache[t],s.stopLoading()}),null)}}),this.setGroupField()}function DerivedPointData(t,e,i,a){RamaddaUtil.inherit(this,new BasePointData(e)),RamaddaUtil.defineMembers(this,{displayManager:t,operation:a,pointDataList:i,loadDataCalls:0,display:null,pointDataLoaded:function(t){this.loadDataCalls--,this.loadDataCalls<=0&&this.initData()},equals:function(t){if(null==t.pointDataList)return!1;if(this.pointDataList.length!=t.pointDataList.length)return!1;for(var e in this.pointDataList)if(!this.pointDataList[e].equals(t.pointDataList[e]))return!1;return!0},initData:function(){var t=this.pointDataList[0];if(1==this.pointDataList.length)this.records=t.getRecords(),this.recordFields=t.getRecordFields(),console.log("initData:"+this.recordFields.length);else if(this.pointDataList.length>1){var e=this.combineData(t,this.pointDataList[1]);this.records=e.records,this.recordFields=e.recordFields,console.log("initData 2:"+this.recordFields.length)}this.setGroupField(),this.display.pointDataLoaded(this)},combineData:function(t,e){var i,a=t.getRecords(),s=e.getRecords(),l=[];if(a.length!=s.length&&console.log("bad records:"+a.length+" "+s.length),"average"==this.operation){for(var r=0;r<a.length;r++){var o=a[r],n=s[r];if(o.getDate()!=n.getDate()){console.log("Bad record date:"+o.getDate()+" "+n.getDate());break}for(var h=$.extend(!0,{},o),d=h.getData(),p=n.getData(),g=0;g<d.length;g++)d[g]=(d[g]+p[g])/2;l.push(h)}i=t.getRecordFields()}else this.operation;return null==i&&(l=a,i=t.getRecordFields()),{records:l,recordFields:i}},loadData:function(t){for(var e in this.display=t,this.loadDataCalls=0,this.pointDataList){var i=this.pointDataList[e];i.hasData()||(this.loadDataCalls++,i.loadData(this)),0==this.loadDataCalls&&this.initData()}}})}function RecordField(t,e){$.extend(this,{isDate:"date"==t.type,isLatitude:!1,isLongitude:!1,isElevation:!1,forDisplay:!0}),$.extend(this,t),$.extend(this,{isGroup:t.group,properties:t}),e&&e.getProperty&&["type","label","unit"].forEach((i=>{let a=e.getProperty(t.id+"."+i);a&&(this[i]=a)})),RamaddaUtil.defineMembers(this,{clone:function(){var t={};return $.extend(t,this),t},toString:function(){return this.getId()+" type:"+this.getType()+" index:"+this.index},getForDisplay:function(){return this.forDisplay},getIndex:function(){return this.index},getValue:function(t,e){let i;return i=t.getValue?t.getValue(this.index):t[this.index],i||Utils.isDefined(i)?i:e},getGroup:function(){return this.group},getEnumeratedValues:function(t){return this.enumeratedValues},isFieldGroup:function(){return this.isGroup},isRecordDate:function(){return"recordDate"==this.getId()},isFieldGeo:function(){return this.isFieldLatitude()||this.isFieldLongitude()||this.isFieldElevation()},isFieldLatitude:function(){return this.isLatitude||"latitude"==this.id.toLowerCase()},isFieldLongitude:function(){return this.isLongitude||"longitude"==this.id.toLowerCase()},isFieldElevation:function(){return this.isElevation||"elevation"==this.id.toLowerCase()||"altitude"==this.id.toLowerCase()},isFieldNumeric:function(){return this.isNumeric()},isFieldString:function(){return"string"==this.type||"enumeration"==this.type||"multienumeration"==this.type},isFieldEnumeration:function(){return"enumeration"==this.type||"multienumeration"==this.type},isFieldMultiEnumeration:function(){return"multienumeration"==this.type},isFieldDate:function(){return this.isDate},isChartable:function(){return this.chartable},getSortOrder:function(){return this.sortorder},getId:function(){return this.id},getTypeLabel:function(){var t="fa-font";this.isFieldGeo()?t="fa-globe":this.isFieldNumeric()?t="fa-hashtag":this.isFieldEnumeration()&&(t="fa-list");var e=this.getType();return HtmlUtils.span(["title",e,"class","fa "+t,"style","color:rgb(169, 169, 169);font-size:12pt;"])},getUnitLabel:function(){return this.getLabel()+this.getUnitSuffix()},getUnitSuffix:function(){return this.unit&&""!=this.unit?"&nbsp;["+this.unit+"]":""},getLabel:function(){return null==this.label||0==this.label.length?this.id:this.label},setLabel:function(t){this.label=t},canEdit:function(){return 1==this.canedit},isNumeric:function(){return"double"==this.type||"integer"==this.type},isString:function(){return"string"==this.type||this.isFieldEnumeration()||"url"==this.type||"image"==this.type},getType:function(){return this.type},setType:function(t){this.type=t},getMissing:function(){return this.missing},setUnit:function(t){this.unit=t},getUnit:function(){return this.unit}})}function PointRecord(t,e,i,a,s,l,r){this.isPointRecord=!0,$.extend(this,{rowIndex:r,fields:t,latitude:e,longitude:i,elevation:a,recordTime:s,data:l,id:HtmlUtils.getUniqueId()}),!s&&l&&l.every((t=>!t||!t.getTime||(this.recordTime=t,!1)))}function makePointData(t,e,i,a){for(var s=[],l=-1,r=-1,o=-1,n=[],h=[],d=null,p=0;p<t.fields.length;p++){if((I=new RecordField(E=t.fields[p],i)).isFieldNumeric()&&i.getProperty){var g=i.getProperty(I.getId()+".offset1",i.getProperty("offset1")),c=i.getProperty(I.getId()+".offset2",i.getProperty("offset2")),u=i.getProperty(I.getId()+".scale",i.getProperty("scale"));if(g||c||u){var y=i.getProperty(I.getId()+".unit",i.getProperty("unit"));y&&(I.unit=y);var m={offset1:0,offset2:0,scale:1};g&&(m.offset1=parseFloat(g)),c&&(m.offset2=parseFloat(c)),u&&(m.scale=parseFloat(u)),I.offset=m,h.push(I)}}d=I,s.push(I),I.isFieldLatitude()?l=I.getIndex():I.isFieldLongitude()?r=I.getIndex():I.isFieldElevation()?I.getIndex():I.isFieldDate()&&(o=I.getIndex(),n.push(o))}if(e)for(var f=d.getIndex()+1,D=0;D<e.length;D++){var I,T=e[D],b=T.label||T.name;(I=new RecordField({type:"double",index:f+D,chartable:!0,id:T.name,label:b})).derived=T,s.push(I)}let S=[],v=!1,x=!1,U=!1,L=!1;if(t.data.forEach(((t,i)=>{let a;0==i&&(v=Array.isArray(t),x=!(void 0===t.date)),a=v?t:t.values;let d=null;v||!x?o>=0&&(U||(L="string"==typeof a[o],U=!0),L?d=Utils.parseDate(a[o]):(d=new Date(0),d.setUTCMilliseconds(a[o]))):null!=t.date&&0!=t.date&&(d=new Date(0),d.setUTCMilliseconds(t.date)),(v||void 0===t.latitude)&&(t.latitude=l>=0?a[l]:NaN),(v||void 0===t.longitude)&&(t.longitude=r>=0?a[r]:NaN);for(var p=0;p<n.length;p++){let t=n[p],e=a[t];a[t]=Utils.parseDate(e)}for(var g=0;g<a.length;g++)null==a[g]&&(a[g]=NaN);if(e)for(var c=0;c<e.length;c++){var u=e[c];if(u.isRow){if(!u.compiledFunction){var y=[],m=u.columns.indexOf(";")>=0?u.columns.split(";"):u.columns.split(",");u.fieldsToUse=[];for(var f=0;f<m.length;f++){var D=m[f].trim();y.push("v"+(f+1));for(var I=null,T=0;T<s.length;T++){if((C=s[T]).getId()==D){I=C;break}}u.fieldsToUse.push(I)}var b="";for(f=0;f<y.length;f++)b+="var v"+(f+1)+"=args["+f+"];\n";let t=u.function;t.indexOf("return")<0&&(t="return "+t),b+=t+"\n",u.compiledFunction=new Function("args",b)}var E=[],P=!1;for(T=0;T<u.fieldsToUse.length;T++){var C,A=NaN;null!=(C=u.fieldsToUse[T])&&null==(A=a[C.getIndex()])&&(A=NaN),isNaN(A)||(P=!0),E.push(A)}try{var w=NaN;P&&(w=u.compiledFunction(E),u.decimals>=0&&(w=w.toFixed(u.decimals)),w=parseFloat(w)),a.push(w)}catch(t){console.log("Error evaluating function:"+u.function+"\n"+t),a.push(NaN)}}}for(var H=0;H<h.length;H++){var R=h[H],k=R.offset,_=a[R.getIndex()];_=(_+k.offset1)*k.scale+k.offset2,a[R.getIndex()]=_}var F=new PointRecord(s,t.latitude,t.longitude,t.elevation,d,a,i);S.push(F)})),null!=i)for(p=0;p<s.length;p++){var E,P="field."+(E=s[p]).getId()+".";if(Utils.isDefined(i[P+"unit"])&&E.setUnit(i[P+"unit"]),Utils.isDefined(i[P+"label"])&&E.setLabel(i[P+"label"]),Utils.isDefined(i[P+"scale"])||Utils.isDefined(i[P+"offset1"])||Utils.isDefined(i[P+"offset2"])){g=Utils.isDefined(i[P+"offset1"])?parseFloat(i[P+"offset1"]):0,c=Utils.isDefined(i[P+"offset2"])?parseFloat(i[P+"offset2"]):0,u=Utils.isDefined(i[P+"scale"])?parseFloat(i[P+"scale"]):1,f=E.getIndex();for(var C=0;C<S.length;C++){var A=S[C].getData(),w=A[f];A[f]=(w+g)*u+c}}}var H=t.name;return void 0===H&&(H="Point Data"),S.sort((function(t,e){if(t.getDate()&&e.getDate())return t.getDate().getTime()<e.getDate().getTime()?-1:t.getDate().getTime()>e.getDate().getTime()?1:0})),new PointData(H,s,S,a)}function BaseFilter(t,e){this.display=t,null==e&&(e={}),RamaddaUtil.defineMembers(this,{properties:e,isEnabled:function(){return!0},prepareToFilter:function(){},isRecordOk:function(t,e,i){return!0},getWidget:function(){return""},initWidget:function(t){}})}function BoundsFilter(t,e){RamaddaUtil.inherit(this,new BaseFilter(t,e)),$.extend(this,{enabled:!0,getWidget:function(){let t=this.display.getDomId("boundsfilter");return HtmlUtils.span([STYLE,HU.css("margin-left","4px","margin-right","4px"),ID,t,CLASS,"ramadda-clickable",TITLE,"Filter records on map view. Shift-click to clear"],HtmlUtils.getIconImage("fas fa-globe-americas"))},initWidget:function(t){this.inputFunc=t;this.display.getDomId("boundsfilter");let e=this;this.display.jq("boundsfilter").click((function(i){if(i.shiftKey){if(!e.bounds)return;e.bounds=null}else e.bounds=e.display.getBounds();t($(this),null,e.bounds)}))},isRecordOk:function(t){if(!this.bounds)return!0;if(t.hasLocation()){var e=this.bounds,i=t.getLatitude(),a=t.getLongitude();if(i>e.top||i<e.bottom||a<e.left||a>e.right)return!1}return!0}})}function RecordFilter(t,e,i){let a;if(this.id=e,this.isText="_text_"==this.id,this.isText)a=t.getFieldsByType(null,"string");else{let i=t.getFieldById(null,e);i?a=[i]:(console.warn("Error: could not find filter field::"+e),t.getFieldById(null,e),a=[])}$.extend(this,new BaseFilter(t,i)),this.getId=function(){return this.id};let s=(e,i)=>{let a=this.getId()+"."+e;return t.getProperty(a,i)},l="";if(l=this.isText?s("filterLabel","Text"):s("filterLabel",a.length>0?a[0].getLabel():""),$.extend(this,{fields:a,values:[],hideFilterWidget:t.getProperty("hideFilterWidget",!1,!0),displayType:s("filterDisplay","menu"),label:l,suffix:s("filterSuffix",""),depends:s("filterDepends",null),dateIds:[],prefix:t.getProperty(this.getId()+".filterPrefix"),suffix:t.getProperty(this.getId()+".filterSuffix"),startsWith:t.getProperty(this.getId()+".filterStartsWith",!1),ops:Utils.split(t.getProperty(this.getId()+".filterOps"),";",!0,!0),labelField:t.getFieldById(null,t.getProperty(this.getId()+".labelField"))}),this.ops){let t=[];this.ops.forEach((e=>{let i=e.split(",");t.push({op:i[0],value:i[1],label:i[2]||this.id+i[0]+i[1]})})),this.ops=t}$.extend(this,{toString:function(){return"filter:"+this.getId()},getField:function(){return this.fields[0]},getFieldId:function(){return this.fields[0].getId()},getLabel:function(){return this.label},getValue:function(t){if(1==this.fields.length)return t.getValue(this.fields[0].getIndex());return this.fields.reduce(((e,i)=>e+" "+t.getValue(i.getIndex())),"")},isFieldNumeric:function(){return this.getField().isNumeric()},isFieldEnumeration:function(){return this.getField().isFieldEnumeration()},isFieldMultiEnumeration:function(){return this.getField().isFieldMultiEnumeration()},getFieldType:function(){return this.getField().getType()},getFilterId:function(t){return this.display.getDomId("filterby_"+(t||this.getId()))},isEnabled:function(){return this.isText||null!=this.getField()},recordOk:function(t,e,i){return!0},getProperty:function(t,e){return this.display.getProperty(t,e)},getPropertyFromUrl:function(t,e){return this.display.getPropertyFromUrl(t,e)},prepareToFilter:function(){if(this.mySearch=null,this.depend&&this.checkDependency(),!this.isEnabled())return;let t=null,e=[],i=null,a=[];if(this.ops){let t=$("#"+this.getFilterId(this.getId())).val();return t==FILTER_ALL?void(this.mySearch=null):void(this.mySearch={index:parseFloat(t)})}if(this.isFieldNumeric()){let e=$("#"+this.display.getDomId("filterby_"+this.getId()+"_min")),i=$("#"+this.display.getDomId("filterby_"+this.getId()+"_max"));if(!e.val()||!i.val())return;let a=parseFloat(e.val().trim()),s=parseFloat(i.val().trim()),l=parseFloat(e.attr("data-min")),r=parseFloat(i.attr("data-max"));a==l&&s==r||(t=[a,s])}else if("date"==this.getFieldType()){let e=$("#"+this.display.getDomId("filterby_"+this.getId()+"_date1")).val(),i=$("#"+this.display.getDomId("filterby_"+this.getId()+"_date2")).val();e=null!=e&&""!=e.trim()?Utils.parseDate(e):null,i=null!=i&&""!=i.trim()?Utils.parseDate(i):null,null==e&&null==i||(t=[e,i])}else{if(i=this.getFieldValues(),!i)return;if(Array.isArray(i)||(i=[i]),0==i.length)return;i=i.map((t=>t.replace(/_comma_/g,","))),i.forEach((t=>{e.push((""+t).toLowerCase());try{a.push(new TextMatcher(t))}catch(t){}}))}let s=null!=t;!s&&i&&i.forEach((t=>{t.length>0&&t!=FILTER_ALL&&(s=!0)})),this.mySearch=s?{value:t,values:i,matchers:a,_values:e,anyValues:s}:null},isRecordOk:function(t,e){let i=!0;if(!this.isEnabled()||!this.mySearch)return e&&(this.isEnabled()||console.log("\t"+this+"  not enabled"),this.mySearch||console.log("\t"+this+"  no mySearch")),i;let a=this.getValue(t);if(this.ops){let t=this.ops[this.mySearch.index];"<"==t.op?i=a<t.value:"<="==t.op?i=a<=t.value:">"==t.op?i=a>t.value:">="==t.op?i=a>=t.value:"=="==t.op&&(i=a==t.value)}else if(this.isFieldEnumeration())if(a=String(a),this.isFieldMultiEnumeration()){i=!1,a.split(",").forEach((t=>{t=t.trim(),this.mySearch.values.includes(t)&&(i=!0)}))}else i=this.mySearch.values.includes(a);else if(this.isFieldNumeric()){if(isNaN(this.mySearch.value[0])&&isNaN(this.mySearch.value[1]))return i;(isNaN(a)||""==a||!isNaN(this.mySearch.value[0])&&a<this.mySearch.value[0]||!isNaN(this.mySearch.value[1])&&a>this.mySearch.value[1])&&(i=!1)}else if("date"==this.getFieldType()){if(this.mySearch.value&&Array.isArray(this.mySearch.value))if(null==a)i=!1;else{let t=this.mySearch.value[0],e=this.mySearch.value[1],s=a.getTime();(isNaN(s)||t&&s<t.getTime()||e&&s>e.getTime())&&(i=!1)}}else{let t=this.startsWith;i=!1,a=String(a).toLowerCase();for(let e=0;e<this.mySearch._values.length;e++){let s=this.mySearch._values[e];if(t){if(a.toString().startsWith(s)){i=!0;break}}else if(a.toString().indexOf(s)>=0){i=!0;break}}if(!i&&!t)for(ri=0;ri<this.mySearch.matchers.length;ri++){if(this.mySearch.matchers[ri].matches(a.toString())){i=!0;break}}}return i},doTags:function(){if(!this.getProperty(this.getId()+".showFilterTags",!0))return!1;return this.getProperty("showFilterTags")},doTagsColor:function(){if(!this.getProperty(this.getId()+".colorFilterTags",!0))return!1;return this.getProperty(this.getId()+".colorFilterTags",!0)||this.getProperty("colorFilterTags")},getFieldValues:function(){if(this.isFieldEnumeration()&&this.doTags())return this.selectedTags||[];let t=$("#"+this.display.getDomId("filterby_"+this.getId())),e=null;e=t.attr("isCheckbox")?t.is(":checked")?t.attr("onValue"):t.attr("offValue"):t.attr("isButton")?t.attr("data-value"):t.val(),e||(e=this.defaultValue?this.defaultValue:FILTER_ALL),Array.isArray(e)||(e=this.isFieldEnumeration()?[e]:e.split(","));let i=[];return e.forEach((t=>i.push(t.trim()))),e=i,e},toggleTag:function(t,e,i,a){let s=this,l=this.getFilterId(),r=Utils.makeId(l+"_"+t);if(e){if(this.selectedTags.includes(t))return;this.selectedTags=Utils.addUnique(this.selectedTags,t);let e=this.display.jq(ID_TAGBAR).find(".tag-group"+HU.attrSelect("tag-type",this.getFilterId()));if(0==e.length){let t;t=this.display.getProperty("tagDiv")?$("#"+this.display.getProperty("tagDiv")):this.display.jq(ID_TAGBAR),e=$(HU.div([STYLE,HU.css("display","inline-block"),CLASS,"tag-group","tag-type",this.getFilterId()])).appendTo(t)}$(HU.div(["metadata-type",l,"metadata-value",t,TITLE,t,STYLE,HU.css("background",Utils.getEnumColor(this.getFieldId())),CLASS,"display-search-tag",ID,r],t+SPACE+HU.getIconImage("fas fa-times"))).appendTo(e).click((function(){s.selectedTags=Utils.removeElement(s.selectedTags,t),i&&i.prop("checked",!1),$(this).remove(),s.inputFunc(s.fakeInput,null,s.selectedTags)}))}else this.selectedTags=Utils.removeElement(this.selectedTags,t),$("#"+r).remove();a&&this.inputFunc&&this.inputFunc(this.fakeInput,null,this.selectedTags)},initWidget:function(t){if(this.isEnabled()&&(this.inputFunc=t,this.fakeInput={attr:function(t){return this[t]},val:function(){return null},id:this.getId(),fieldId:this.getFieldId()},this.initDateWidget(t),this.tagCbxs)){let t=this,e=function(){let e=$(this),i=e.is(":checked"),a=$(this).attr("metadata-value");t.toggleTag(a,i,e,!0)},i=this.getFilterId()+"_popup";$("#"+i).click((()=>{this.display.createTagDialog(this.tagCbxs,$("#"+i),e,this.getFilterId(),this.getLabel()).find(".metadata-cbx").each((function(){let e=$(this).attr("metadata-value");$(this).prop("checked",t.selectedTags.includes(e))}))}))}},initDateWidget:function(t){if(!this.hideFilterWidget)for(let e=0;e<this.dateIds.length;e++){let i=this.dateIds[e];HtmlUtils.datePickerInit(i),$("#"+i).change((function(){t($(this))}))}},checkDependency:function(){if(!(this.depend&&this.records&&this.dependMySearch&&this.depend.mySearch&&this.dependMySearch.values&&this.depend.mySearch.values))return void console.log("no depend:"+this.depend+" "+(null!=this.records)+" "+this.dependMySearch);let t=this.dependMySearch.values,e=this.depend.mySearch.values;if(t.length==e.length){let i=!0;for(let a=0;a<t.length&&i;a++)i=t[a]==e[a];if(i)return}let i=this.getEnums(this.records),a=this.getFilterId(this.getId()),s=[];i.map((t=>s.push(t.value))),this.display.ignoreFilterChange=!0;let l=$("#"+a),r=l.val();r||(r=l.attr("data-value")),l.html(HU.makeOptions(s,r)),this.display.ignoreFilterChange=!1},handleEventPropertyChanged:function(t){if(this.isFieldEnumeration()&&this.doTags()){if(this.selectedTags){let t=this.getFilterId();this.selectedTags.forEach((e=>{let i=Utils.makeId(t+"_"+e);$("#"+i).remove()}))}this.selectedTags=[];let e=t.values?t.values:null;return e||(t.value?Array.isArray(t.value)?e=t.value:e[t.value]:e=[]),void t.value.forEach((t=>{t&&this.toggleTag(t,!0)}))}let e=this.widgetId;t.id&&t.id.endsWith("date1")?e+="_date1":t.id&&t.id.endsWith("date2")&&(e+="_date2");let i=$("#"+e);if(i.attr("isCheckbox")){let e=i.attr("onValue");i.prop("checked",t.value.includes(e))}else i.val(t.value);i.attr("data-value",t.value),i.attr("isButton")&&(i.find(".display-filter-button").removeClass("display-filter-button-selected"),i.find("[value='"+t.value+"']").addClass("display-filter-button-selected"))},getWidget:function(t,e,i,a){this.records=i;let s=!1;if(!this.isEnabled())return"";let l="";this.hideFilterWidget&&(l="display:none;"),t[this.getId()]={field:this.fields[0],values:[]};let r,o=!0,n=this.widgetId=this.getFilterId(this.getId()),h=this.getProperty(this.getId()+".filterLabel",this.getLabel()),d=this.getProperty(this.getId()+".filterSuffix","");if(this.ops){let t=[];this.ops.forEach(((e,i)=>{t.push([String(i),e.label])}));let e=this.getPropertyFromUrl(this.getId()+".filterValue",FILTER_ALL),i=this.getProperty(this.getId()+".showFilterLabel",this.getProperty("showFilterLabel",!0)),a=this.getProperty(this.getId()+".allName",i?"All":this.getLabel()),s=Utils.mergeLists([[FILTER_ALL,a]],t),o=[STYLE,l,ID,n,"fieldId",this.getId()];r=HU.select("",o,s,e)}else if(this.isFieldEnumeration()){s;let t=this.defaultValue=this.getPropertyFromUrl(this.getId()+".filterValue",FILTER_ALL),a=this.getEnums(i),h=["style",l,"id",n,"fieldId",this.getId()];if(this.getProperty(this.getId()+".filterMultiple",!1)&&(h.push("multiple"),h.push(""),h.push("size"),h.push(this.getProperty(this.getId()+".filterMultipleSize","3")),t=t.split(",")),"menu"!=this.displayType){s,this.getProperty(this.getId()+".includeAll",this.getProperty("filter.includeAll",!0))||t!=FILTER_ALL||(t=a[0].value);let i="",l=Utils.parseMap(this.getProperty(this.getId()+".filterColorByMap")),r="image"==this.displayType,o=[],h=Utils.getNameValue(this.getProperty(this.getId()+".filterImages"));if(r){let t=this.getProperty(this.getId()+".filterImageWidth"),e=this.getProperty(this.getId()+".filterImageHeight");e&&(o.push("height"),o.push(e)),t&&(o.push("width"),o.push(t)),e||t||(o.push("width"),o.push("50")),o.push("style"),o.push(this.getProperty(this.getId()+".filterImageStyle","border-radius:50%;"))}for(let e=0;e<a.length;e++){let s,n="",d=a[e].value,p=l?l[d]:null;Array.isArray(d)?(s=d[1],d=d[0]):s=d;let g=this.getProperty(this.getId()+".filterItemStyle","");p&&(g+=" background-color:"+p+"; ");let c=" display-filter-item display-filter-item-"+this.displayType+" ";if(d==t&&(c+=" display-filter-item-"+this.displayType+"-selected "),d==FILTER_ALL&&(n=" display-filter-item-all "),r){let t=null;h&&(t=h[d]),t&&""!=t||(t=a[e].image),i+=t?HtmlUtils.div(["fieldId",this.getId(),"class",c,"style",g,"data-value",d,"title",s],HtmlUtils.image(t,o)):HtmlUtils.div(["fieldId",this.getId(),"class",c,"style",g,"data-value",d,"title",s],s)}else i+=HtmlUtils.div(["fieldId",this.getId(),"class",c,"style",g,"data-value",d],s);i+="\n"}return r&&this.getProperty(this.getId()+".filterShowButtonsLabel")&&(i+=HtmlUtils.div(["class","display-filter-item-label","id",this.display.getDomId("filterby_"+this.getId()+"_label")],"&nbsp;")),e[0]+=HtmlUtils.div(["data-value",t,"class","display-filter-items","id",n,"isButton","true","fieldId",this.getId()],i),""}if(this.getProperty(this.getId()+".filterCheckbox")){s,h.push("isCheckbox"),h.push(!0);let e=[];a.map((t=>e.push(t.value)));let i=e.includes(t);e.length>0&&(h.push("onValue"),h.push(e[0])),e.length>1&&(h.push("offValue"),h.push(e[1])),r=HtmlUtils.checkbox("",h,i)}else if(this.doTags()){let t=this.doTagsColor();o=!1;let e=[];this.tagToCbx={},this.selectedTags=[],a.map(((t,i)=>{let a=t.count,s=t.value,l=s;Array.isArray(s)&&(s=t.value[0],l=t.value[1],""===s&&(l="-blank-"));a&&(l=l+" ("+a+")");let r=this.getFilterId()+"_cbx_"+i;this.tagToCbx[s]=r;let o=HU.checkbox("",[CLASS,"metadata-cbx",ID,r,"metadata-type",this.getFilterId(),"metadata-value",s],!1)+" "+HU.tag("label",[CLASS,"ramadda-noselect ramadda-clickable","for",r],l);o=HU.span([CLASS,"display-search-tag","tag",l,STYLE,HU.css("background",Utils.getEnumColor(this.getFieldId()))],o),e.push(o)})),this.tagCbxs=e;let i=this.getFilterId()+"_popup",s=" "+this.getLabel()+" ("+e.length+")";s=s.replace(/ /g,"&nbsp;");let l=HU.css("white-space","nowrap","line-height","1.5em","margin-top","6px","padding-right","5px");l+=t?HU.css("border","1px solid #ccc","background",Utils.getEnumColor(this.getFieldId())):HU.css(),r=HU.div([STYLE,l,TITLE,"Click to select tag",ID,i,CLASS,"ramadda-clickable entry-toggleblock-label"],HU.makeToggleImage("fas fa-plus","font-size:8pt;")+s)}else{s;let e=[],i=this.getProperty(this.getId()+".filterShowCount",this.getProperty("filterShowCount",!0));a.map((t=>{let a=t.count,s=t.value,l=s;Array.isArray(s)&&(s=t.value[0],l=t.value[1],""===s&&(l="-blank-")),a&&(l+=i?" ("+a+")":""),e.push([s,l])})),r=HtmlUtils.select("",h,e,t)}}else if(this.isFieldNumeric()){s;let t=0,e=0,a=0;i.map((i=>{let s=this.getValue(i);isNaN(s)||(0==a?(t=s,e=s):(t=Math.min(t,s),e=Math.max(e,s)),a++)}));let o=this.getPropertyFromUrl(this.getId()+".filterValueMin",this.getProperty("filterValueMin")),h=this.getPropertyFromUrl(this.getId()+".filterValueMax",this.getProperty("filterValueMax")),d="",p="",g=t,c=e;Utils.isDefined(o)&&(d="background:"+TEXT_HIGHLIGHT_COLOR+";",g=parseFloat(o)),Utils.isDefined(h)&&(p="background:"+TEXT_HIGHLIGHT_COLOR+";",c=parseFloat(h)),r=HtmlUtils.input("",g,[STYLE,d,"data-min",t,"class","display-filter-range display-filter-input","style",l,"id",n+"_min","size",3,"fieldId",this.getId()]),r+="-",r+=HtmlUtils.input("",c,[STYLE,p,"data-max",e,"class","display-filter-range display-filter-input","style",l,"id",n+"_max","size",3,"fieldId",this.getId()])}else if("date"==this.getFieldType())r=HtmlUtils.datePicker("","",["class","display-filter-input","style",l,"id",n+"_date1","fieldId",this.getId()])+"-"+HtmlUtils.datePicker("","",["class","display-filter-input","style",l,"id",n+"_date2","fieldId",this.getId()]),this.dateIds.push(n+"_date1"),this.dateIds.push(n+"_date2");else{let e=this.getPropertyFromUrl(this.getId()+".filterValue",""),a=this.getProperty(this.getId()+".filterWidth","150px"),s=[STYLE,l+"width:"+HU.getDimension(a),"id",n,"fieldId",this.getId(),"class","display-filter-input"],d=this.getProperty(this.getId()+".filterPlaceholder");s.push("width"),s.push(a),d?(s.push("placeholder"),s.push(d)):(o=!1,s.push("placeholder"),s.push(h)),r=HtmlUtils.input("",e,s);let p=t[this.getId()].values,g={};i.map((t=>{let e=this.getValue(t);g[e]||(g[e]=!0,p.push(e))}))}if(!this.hideFilterWidget){let t=h;h.length>50&&(h=h.substring(0,49)+"..."),this.getProperty(this.getId()+".showFilterLabel",this.getProperty("showFilterLabel",!0))?h+=": ":h="";let e=a||this.getProperty(this.getId()+".filterLabelVertical",!1)||this.getProperty("filterLabelVertical",!1);h=this.display.makeFilterLabel(h,t,e),e&&(h+="<br>"),r=a?HtmlUtils.div([],(o?h:"")+r+d):HtmlUtils.div(["style","display:inline-block;"],(o?h:"")+r+d)}return a||(r+=this.hideFilterWidget?"":"&nbsp;&nbsp;"),r},getEnums:function(t){let e={},i=this.isFieldMultiEnumeration();t.forEach(((t,a)=>{let s=this.getValue(t);null!==s&&(s=String(s),(i?s.split(","):[s]).forEach((t=>{t=t.trim(),e[t]?e[t]++:e[t]=1})))}));let a=null,s=this.getProperty(this.getId()+".filterValues"),l=this.getProperty(this.getId()+".showFilterLabel",this.getProperty("showFilterLabel",!0));if(s){let t;"string"==typeof s?(s=Utils.getMacro(s),t=s.split(",")):t=s,a=[],t.map((t=>{let i=t.split(":");if(i.length>1)t=[i[0],i[1]];else if(t==FILTER_ALL){let e=this.getProperty(this.getId()+".allName",l?"All":this.getLabel());t=[i[0],e]}else t=[t,t];let s=e[t[0]];a.push({value:t,count:s})}))}let r=this.getProperty(this.getId()+".includeAll",this.getProperty("filter.includeAll",!0));if(null==a){let s=this.getProperty(this.getId()+".depends");s&&(s=this.depend=this.display.getRecordFilter(s));let o=this.getProperty(this.getId()+".allName",l?"All":this.getLabel());a=[],r&&!this.getProperty(this.getId()+".filterLabel")&&a.push({value:[FILTER_ALL,o]});let n={},h=this.getField().getEnumeratedValues();if(h)for(let t in h){n[t]=!0;let i=e[t];a.push({value:[t,h[t]],count:i})}let d=[],p=this.display.getFieldByType(null,"image"),g=!0;if(s&&(s.prepareToFilter(),this.dependMySearch=s.mySearch),t.forEach(((t,a)=>{if(s&&!s.isRecordOk(t,a<5))return;let l,r=this.getValue(t);l=i?r.split(",").map((t=>t.trim())):[r],l.forEach((i=>{if(n[i])return;n[i]=!0;let a={};p&&(a.image=this.display.getDataValues(t)[p.getIndex()]),+i+""!=i&&(g=!1);let s=i;s.length>30&&(s=s.substring(0,29)+"..."),this.labelField&&(s+=" - "+this.labelField.getValue(t),console.log("l:"+s)),"string"==typeof i&&(i=i.replace(/\'/g,"&apos;"));let l=[i,s];a.value=l,a.count=e[i],d.push(a)}))})),this.getProperty(this.getId()+".filterSort",!0)){let t=this.getProperty(this.getId()+".filterSortCount",!0);d.sort(((e,i)=>t&&e.count&&i.count&&i.count!=e.count?i.count-e.count:(e=e.value,i=i.value,g?+e-+i:(""+e[1]).localeCompare(""+i[1]))))}for(let t=0;t<d.length;t++){let e=d[t];a.push(e)}}return a}})}function MonthFilter(t){RamaddaUtil.inherit(this,new BaseFilter),RamaddaUtil.defineMembers(this,{months:t.split(","),recordOk:function(t,e,a){for(i in this.months){let t=this.months[i],a=e.getDate();if(null==a)return!1;if(null==a.getMonth)return!1;if(a.getMonth()==t)return!0}return!1}})}PointRecord.prototype={clone:function(){var t={};return $.extend(t,this),t.data=[],this.data.map(((e,i)=>{t.data[i]=e})),t},isHighlight:function(t){return this.highlightForDisplay||(this.highlightForDisplay={}),this.highlightForDisplay[t]},getDisplayProperty:function(t,e,i){this.displayProperties||(this.displayProperties={});let a=this.displayProperties[t];return a||(a=this.displayProperties[t]={}),a[e]||i},setDisplayProperty:function(t,e,i){this.displayProperties||(this.displayProperties={});let a=this.displayProperties[t];a||(a=this.displayProperties[t]={}),a[e]=i},setHighlight:function(t,e){this.highlightForDisplay||(this.highlightForDisplay={}),e&&null!=this.highlightForDisplay[t]||(this.highlightForDisplay[t]=e)},clearHighlight:function(t){this.highlightForDisplay||(this.highlightForDisplay={}),delete this.highlightForDisplay[t]},toString:function(){return"data:"+this.data},getId:function(){return this.id},getData:function(){return this.data},setData:function(t){this.data=t},getValueFromField:function(t){let e=null;return this.fields.every((i=>i.getId()!=t||(e=this.getValue(i.getIndex()),!1))),e},allZeros:function(){for(var t=this.getData(),e=0,i=0,a=0;a<t.length;a++)if("number"==typeof t[a]&&(e++,!isNaN(t[a])&&0!=t[a])){i++;break}return e>0&&0==i},getValue:function(t){return this.data[t]},setValue:function(t,e){this.data[t]=e},push:function(t){this.data.push(t)},hasDate:function(){return null!=this.getDate()},hasLocation:function(){return null!=this.latitude&&!isNaN(this.latitude)},hasElevation:function(){return null!=this.elevation&&!isNaN(this.elevation)},setLocation:function(t,e){this.latitude=t,this.longitude=e},getLatitude:function(){return this.latitude},getLongitude:function(){return this.longitude},getTime:function(){return this.recordTime},getElevation:function(){return this.elevation},getDate:function(){return this.recordTime}};var ArrayUtil={add:function(t,e){return isNaN(t)||isNaN(e)?NaN:t+e},average:function(t){var e=0;if(0==t.length)return 0;for(var i=0;i<t.length;i++)e+=t[i];return e/t.length},percentIncrease:function(t){var e,i=[];if(0==t.length)return 0;for(var a=0;a<t.length;a++){var s=t[a],l=NaN;a>0&&0!=e&&(l=(s-e)/e),e=s,i.push(100*l)}return i},movingAverage:function(t,e){if(e||(e={}),e.step||(e.step=5),0==t.length)return t;var i=[];console.log("STEP:"+e.step);let a=(t[0].tuple?t=>t.tuple:t=>t)(t[0]).map(((t,e)=>Utils.isNumber(t)));dataList.forEach(((t,e)=>{if(0==e)return;let i=Utils.mergeLists(t.tuple);tmp.push({record:t.record,tuple:i}),i[0]="x",i[1]=5,i.forEach(((t,e)=>{a[e]&&(i[e]=5)}))})),dataList=tmp;for(var s=e.step;s<t.length;s++){for(var l=0,r=0,o=s-e.step;o<s;o++)t[o]==t[o]&&(l+=t[o],r++);var n=r>0?l/r:NaN;if(0==i.length)for(var h=0;h<e.step;h++)i.push(n);i.push(n)}return console.log("MovingAverage: values:"+t.length+" new:"+i.length),i},expMovingAverage:function(t,e){e||(e={}),e.step||(e.step=5);ArrayUtil.movingAverage(t,e),e.step;var i=[];console.log("STEP:"+e.step);for(var a=e.step;a<t.length;a++){for(var s=0,l=0,r=a-e.step;r<a;r++)t[r]==t[r]&&(s+=t[r],l++);var o=l>0?s/l:NaN;if(0==i.length)for(var n=0;n<e.step;n++)i.push(o);i.push(o)}return console.log("MovingAverage: values:"+t.length+" new:"+i.length),i},max:function(t){for(var e=NaN,i=0;i<t.length;i++)(0==i||t[i]>e)&&(e=t[i]);return e},min:function(t){for(var e=NaN,i=0;i<t.length;i++)(0==i||t[i]<e)&&(e=t[i]);return e}},RecordUtil={groupBy:function(t,e,i,a){let s=displayDebug.groupBy;s&&console.log("groupBy");let l={max:0,values:[],labels:[],map:{}};return t.forEach(((t,r)=>{let o,n=null,h=t.getDate();if(a)o=n="latlon"==a?t.getLatitude()+"/"+t.getLongitude():t.getValue(a.getIndex());else{if(!h)return;if(o=h,!0===i);else if("day"==i)o=new Date(n=h.getFullYear()+"-"+h.getUTCMonth()+"-"+h.getUTCDay());else if("month"==i)n=h.getFullYear()+"-"+h.getUTCMonth(),o=new Date(n+"-01");else if("year"==i)n=h.getFullYear(),o=new Date(h.getFullYear()+"-01-01");else if("decade"==i){let t=h.getFullYear();t-=t%10,n=t+"s",o=new Date(t+"-01-01")}else i&&(n=String(o))}let d=l.map[o];d||(s&&console.log("\tadding group:"+o),d=l.map[o]=[],l.values.push(o),null==n&&(n=e.formatDate(h,null,!0)),l.labels.push(n)),d.push(t),l.max=Math.max(l.max,d.length)})),l},expandBounds:function(t,e){return new RamaddaBounds(Math.min(90,t.north+(t.north-t.south)*e),Math.max(-180,t.west-(t.east-t.west)*e),Math.max(-90,t.south-(t.north-t.south)*e),Math.min(180,t.east+(t.east-t.west)*e))},convertBounds:function(t){return t?new RamaddaBounds(t):null},subset:function(t,e){e=RecordUtil.convertBounds(e);return t=t.filter(((t,i)=>{let a=t.getLatitude?t.getLatitude():t.r?t.r.getLatitude():t.y,s=t.getLongitude?t.getLongitude():t.r?t.r.getLongitude():t.x;return a<=e.north&&a>=e.south&&s>=e.west&&s<=e.east}))},getRanges:function(t,e){for(var i=[],a=[],s=0;s<t.length;s++)i.push(NaN),a.push(NaN);for(var l=0;l<e.length;l++)for(var r=0;r<t.length;r++){var o=e[l].getValue(r);isNaN(o)||(i[r]=isNaN(i[r])?o:Math.max(o,i[r]),a[r]=isNaN(a[r])?o:Math.min(o,a[r]))}var n=[];for(r=0;r<t.length;r++)n.push([a[r],i[r]]);return n},getElevationRange:function(t,e){for(var i=NaN,a=NaN,s=0;s<e.length;s++)if(e[s].hasElevation()){var l=e[s].getElevation();i=isNaN(i)?l:Math.max(l,i),a=isNaN(a)?l:Math.min(l,a)}return[a,i]},slice:function(t,e){for(var i=[],a=0;a<t.length;a++){var s=t[a];s.getValue?i.push(s.getValue(e)):i.push(s[e])}return i},sort:function(t){return(t=t.slice(0)).sort((function(t,e){return t.getSortOrder()<e.getSortOrder()})),t},getPoints:function(t,e){let i=[];return this.getBounds(t,e,i),i},getBounds:function(t,e,i){if(e=e||{},null==t)return e;var a=NaN,s=NaN,l=NaN,r=NaN;for(j=0;j<t.length;j++){var o=t[j];isNaN(o.getLatitude())||isNaN(o.getLongitude())||(0==j?(a=o.getLatitude(),l=o.getLatitude(),s=o.getLongitude(),r=o.getLongitude()):(a=Math.max(a,o.getLatitude()),l=Math.min(l,o.getLatitude()),s=Math.min(s,o.getLongitude()),r=Math.max(r,o.getLongitude())),o.getLongitude()<-180||o.getLatitude(),i&&i.push({x:o.getLongitude(),y:o.getLatitude()}))}return e.north=a,e.west=s,e.south=l,e.east=r,new RamaddaBounds(e)},findClosest:function(t,e,i,a){if(null==t)return null;var s=null,l=1e9,r=-1;for(j=0;j<t.length;j++){var o=t[j];if(!isNaN(o.getLatitude())){var n=Math.sqrt((e-o.getLongitude())*(e-o.getLongitude())+(i-o.getLatitude())*(i-o.getLatitude()));n<l&&(l=n,s=o,r=j)}}return null!=a&&(a.index=r),s},clonePoints:function(t){for(var e=[],i=0;i<t.length;i++){var a=t[i];e.push({x:a.x,y:a.y})}return e}};function CsvUtil(){let eg='convertData="derived(field=field_id, function=population*10);\nrotateData(includeFields=true,includeDate=true,flipColumns=true);\naddPercentIncrease(replaceValues=false);"\n';$.extend(this,{process:function(t,e,i){let a;this.display=t;try{DataUtils.parseCommands(i).map((t=>{if(a=t,this[t.command]){let i=e;(e=this[t.command](e,t.args))?e.entryId=i.entryId:e=i}else console.log("unknown command:"+t.command)}))}catch(t){console.log("Error applying derived function:"+a.command),console.log(t),console.log(t.stack)}return e},help:function(t,e){return console.log(eg),null},furlData:function(t,e){},derived:function(pointData,args){let records=pointData.getRecords(),fields=pointData.getRecordFields(),newFields=fields.slice(),newRecords=[],id=args.field||"field_"+fields.length;newFields.push(new RecordField({id:id,index:fields.length,label:Utils.makeLabel(id),type:"double",chartable:!0,unit:args.unit}));let func=args.function;if(!func)return console.log("No func specified in derived"),null;func=func.replace(/_nl_/g,"\n").replace(/_semi_/g,";"),func.indexOf("return")<0&&(func="return "+func);let setVars="";fields.forEach(((t,e)=>{if(""!=t.getId()){if(func.indexOf(t.getId())<0)return;let e=t.getId().replace(/^([0-9]+)/g,"v$1");setVars+="\tvar "+e+'=displayGetFunctionValue(args["'+t.getId()+'"]);\n'}}));let code="function displayDerivedEval(args) {\n"+setVars+func+"\n}";return eval(code),records.forEach(((t,e)=>{let i=t.clone();i.data=t.data.slice(),i.fields=newFields,newRecords.push(i);let a={};fields.map(((e,i)=>{""!=e.getId()&&(a[e.getId()]=t.getValue(e.getIndex()))}));try{let t=displayDerivedEval(a);i.data.push(t)}catch(t){console.log("Error processing derived:"+t),i.data.push(NaN)}})),new PointData("pointdata",newFields,newRecords,null,{parent:pointData})},rotateData:function(t,e){let i=t.getRecords(),a=this.display.getDataValues(i[0]),s=[];for(var l=0;l<a.length;l++)s.push([]);let r="true"==e.includeFields,o=(e.includeDate,"true"==e.flipColumns),n=t.getRecordFields();!o&&r&&n.map(((t,i)=>{t.isRecordDate()||s[i].push(0==i?e.fieldName||"Field":t.getLabel())}));for(var h=0;h<i.length;h++){let t=this.display.getDataValues(i[h]);for(l=0;l<t.length;l++){if(!n[l].isRecordDate()){var d=t[l];d.f&&(d=d.f),d.getTime&&(d=this.display.formatDate(d)),r||0!=h||0!=l||(d=""),o?s[l].unshift(d):s[l].push(d)}}}return o&&r&&n.map(((t,i)=>{t.isRecordDate()||s[i].unshift(0==i?e.fieldName||"Field":t.getLabel())})),convertToPointData(s)},addPercentIncrease:function(t,e){let i=t.getRecords(),a=(this.display.getDataValues(i[0]),t.getRecordFields()),s=[],l=i[0],r="true"==e.replaceValues,o=[],n=t=>!t.isFieldGeo()&&t.isNumeric();a.forEach(((t,e)=>{let i=(t=t.clone()).clone();t.index=o.length,n(i)?(r||o.push(t),i.unit="%",i.index=o.length,i.id=i.id+"_percent",i.label=i.label+" % increase",o.push(i)):o.push(t)}));this.display.getFieldsByIds(a,(e.keyFields||"").replace(/_comma_/g,","));return i.forEach(((t,e)=>{let h=[],d=t.clone();d.data=h,d.fields=o,s.push(d),a.forEach(((a,s)=>{let o=t.data[a.getIndex()];if(!n(a))return i.length,void h.push(o);if(r||h.push(o),0==e)h.push(0);else{let t=l.data[a.getIndex()],e=0==t?0:(o-t)/t;h.push(e),i.length}}))})),new PointData("pointdata",o,s,null,{parent:t})},addFixed:function(t,e){let i=t.getRecords(),a=(this.display.getDataValues(i[0]),t.getRecordFields()),s=[],l=e.value,r=e.type||"double";"double"==r&&(l=parseFloat(l));let o=e.id,n=e.label||Utils.makeLabel(o),h=[];return a.forEach(((t,e)=>{h.push(t.clone())})),h.push(new RecordField({id:o,index:h.length,label:n,type:r,chartable:!0})),i.forEach(((t,e)=>{let i=t.clone();i.data=[],t.data.forEach((t=>{i.data.push(t)})),i.data.push(l),s.push(i)})),new PointData("pointdata",h,s,null,{parent:t})},addBearing:function(t,e){let i=t.getRecords(),a=t.getRecordFields(),s=[],l=[];a.forEach(((t,e)=>{t=t.clone(),l.push(t)}));new RecordField;return l.push(new RecordField({id:"bearing",index:l.length,label:"Bearing",type:"double",chartable:!0})),i.forEach(((t,e)=>{let i=t.clone();i.fields=l,s.push(i);let a=NaN;if(prevPoint){let t={lat:i.getLatitude(),lon:i.getLongitude()};a=Utils.getBearing(prevPoint,t),prevPoint=t}i.data.push(a)})),new PointData("pointdata",l,s,null,{parent:t})},cut:function(t,e){let i=e.fields?e.fields.split(","):[],a=t.getRecords(),s=(this.display.getDataValues(a[0]),t.getRecordFields()),l=[],r=[],o=[];return s.forEach(((t,e)=>{if(i.indexOf(t.getId())>=0)return;let a=(t=t.clone()).clone();o.push(a.index),a.index=l.length,l.push(a)})),a.forEach(((t,e)=>{let i=t.clone();i.fields=l;let a=i.data,s=[];o.forEach((t=>{s.push(a[t])})),i.data=s,r.push(i)})),new PointData("pointdata",l,r,null,{parent:t})},doAverage:function(t,e){let i=t.getRecords(),a=(this.display.getDataValues(i[0]),t.getRecordFields());var s=[],l=[];i[0];a.forEach((t=>{var e=t.clone();l.push(e),e.label=e.label+" (avg)"}));var r,o=[];a.forEach((t=>{o.push(0)}));for(var n=0;n<i.length;n++){var h=i[n];null==r&&(r=h.clone(),s.push(r),r.fields=l,r.parentRecords=[]),r.parentRecords.push(h),a.forEach(((t,e)=>{if(t.isNumeric()){var i=h.data[t.getIndex()];o[e]+=i}})),a.map(((t,e)=>{t.isNumeric()&&(r.data[e]=o[e]/i.length)}))}return new PointData("pointdata",l,s,null,{parent:t})},noop:function(t,e){return t},doublingRate:function(t,e){let i=t.getRecords(),a=t.getRecordFields(),s=this.display.getFieldsByIds(a,(e.fields||"").replace(/_comma_/g,",")),l=this.display.getFieldsByIds(a,(e.keyFields||"").replace(/_comma_/g,",")),r=[],o=Utils.cloneList(a);s.map((t=>{if(!t.isNumeric())return;let e=t.clone();e.id=e.id+"_doubling",e.unit="days",e.label=e.label+" doubling",e.index=o.length,o.push(e)}));let n=[];for(var h=0;h<i.length;h++){let t=i[h],e=(t.clone(),"");l.forEach((i=>{e+="_"+t.getValue(i.getIndex())})),n.push(e)}for(h=0;h<i.length;h++){let t=i[h],e=t.clone(),a=n[h];r.push(e),e.fields=o,s.map(((s,r)=>{if(!s.isNumeric())return;let o=t.getValue(s.getIndex()),d=NaN,p=null;for(var g=h-1;g>=0;g--){if(l.length>0){let t=n[g];if(a!=t)continue}let t=i[g];if(d=t.getValue(s.getIndex()),o>=2*d){p=t.getDate();break}}let c=NaN;p&&(c=(t.getDate().getTime()-p.getTime())/1e3/60/60/24),e.data.push(c)}))}return new PointData("pointdata",o,r,null,{parent:t})},scaleAndOffset:function(t,e){let i,a=t.getRecords(),s=t.getRecordFields();i=e.fields?this.display.getFieldsByIds(s,(e.fields||"").replace(/_comma_/g,",")):s;let l=e.unit,r=e.scale?parseFloat(e.scale):1,o=e.offset1?parseFloat(e.offset1):0,n=e.offset?parseFloat(e.offset):e.offset2?parseFloat(e.offset2):0,h=[],d=[],p={};i.forEach((t=>{p[t.getId()]=!0})),s.map((t=>{let e=t.clone();d.push(e),t.isNumeric()&&p[e.getId()]&&(e.unit=l)}));for(var g=0;g<a.length;g++){let t=a[g],e=t.clone();h.push(e);let s=t.getData(),l=Utils.cloneList(s);i.forEach((t=>{if(!t.isNumeric())return;let e=s[t.getIndex()];isNaN(e)||(e=(e+o)*r+n,l[t.getIndex()]=e)})),e.setData(l)}return new PointData("pointdata",d,h,null,{parent:t})},scaleAndOffset:function(t,e){let i,a=t.getRecords(),s=t.getRecordFields();i=e.fields?this.display.getFieldsByIds(s,(e.fields||"").replace(/_comma_/g,",")):s;let l=e.unit,r=e.scale?parseFloat(e.scale):1,o=e.offset1?parseFloat(e.offset1):0,n=e.offset?parseFloat(e.offset):e.offset2?parseFloat(e.offset2):0,h=[],d=[],p={};i.forEach((t=>{p[t.getId()]=!0})),s.map((t=>{let e=t.clone();d.push(e),t.isNumeric()&&p[e.getId()]&&(e.unit=l)}));for(var g=0;g<a.length;g++){let t=a[g],e=t.clone();h.push(e);let s=t.getData(),l=Utils.cloneList(s);i.forEach((t=>{if(!t.isNumeric())return;let e=s[t.getIndex()];isNaN(e)||(e=(e+o)*r+n,l[t.getIndex()]=e)})),e.setData(l)}return new PointData("pointdata",d,h,null,{parent:t})},function:function(t,e){},accum:function(t,e){let i,a=t.getRecords(),s=t.getRecordFields(),l=null!=e.suffix?e.suffix:"_accum";i=e.fields?this.display.getFieldsByIds(s,(e.fields||"").replace(/_comma_/g,",")):s;let r=[],o=[],n=[];s.map((t=>{n.push(0);let e=t.clone();o.push(e),t.isNumeric()&&(e.id=e.id+l,e.label=e.label+l)}));for(var h=0;h<a.length;h++){let t=a[h],e=t.clone();r.push(e);let s=t.getData(),l=Utils.cloneList(s);i.forEach((t=>{if(!t.isNumeric())return;let e=s[t.getIndex()];if(!isNaN(e)){n[t.getIndex()]+=e,e=n[t.getIndex()]}l[t.getIndex()]=e})),e.setData(l)}return new PointData("pointdata",o,r,null,{parent:t})},aggregate:function(t,e){let i=t.getRecords(),a=t.getRecordFields(),s=this.display.getFieldById(a,e.groupBy);if(!s)throw new Error("No groupBy defined: "+e.groupBy+" args:"+JSON.stringify(e));let l,r=e.includeRows,o=null!==e.suffix?e.suffix:"_accum";o="",l=e.fields?this.display.getFieldsByIds(a,(e.fields||"").replace(/_comma_/g,",")):a;let n=[],h=[],d={},p=[],g=(t,i)=>{let a=t.getId()+"."+i;return Utils.isDefined(e[a])?e[a]:Utils.isDefined(this.display.getProperty(a))?this.display.getProperty(a):this.display.getProperty(i)};return l.forEach((t=>{let e=t.clone();if(h.push(e),e.id=e.id+"",e.label=e.label+"",e.isNumeric()){e.weightedByField=this.display.getFieldById(a,g(e,"weightedByField"));let t=g(e,"operator");t||"%"!=e.getUnit()||(t="average"),e.operator=t}})),i.forEach((t=>{let e=s.getValue(t),i=d[e];i||(i=d[e]=[],p.push(e)),i.push(t)})),p.forEach((t=>{let e=[],i=d[t];h.forEach((a=>{a.weightedByField&&(a.weight=Utils.sumList(i.map((t=>a.weightedByField.getValue(t))))),a.isFieldNumeric()?e.push(0):a.getId()==s.getId()?e.push(t):e.push("")}));i.forEach(((t,i)=>{h.forEach(((a,l)=>{let r=a.getValue(t);if(a.isFieldNumeric()){if(!isNaN(r)){if("average"==a.operator&&a.weightedByField){r*=a.weightedByField.getValue(t)/a.weight}e[l]+=r}}else 0==i&&(e[l]=r),s.getId()==a.getId()&&(e[l]=s.getValue(t))}))}));let a=i[0].clone();n.push(a),h.forEach((t=>{if(!t.isNumeric())return void(s.getId()!=t.getId()&&(e[t.getIndex()]=""));let a=e[t.getIndex()];if(!isNaN(a)){"average"==t.operator&&(t.weightedByField||(a/=i.length));let s=g(t,"numberFormatDecimals");null!==s&&(a=Utils.roundDecimals(a,s)),e[t.getIndex()]=a}})),a.setData(e),a.isAggregate=!0,a.aggregateValue=t,r&&(n=Utils.mergeLists(n,i))})),new PointData("pointdata",h,n,null,{parent:t})},mean:function(t,e){let i,a=t.getRecords(),s=t.getRecordFields();i=e.fields?this.display.getFieldsByIds(s,(e.fields||"").replace(/_comma_/g,",")):s;let l=[],r=[];s.map((t=>{r.push(t.clone())})),r.push(new RecordField({id:"mean",index:r.length,label:"Mean",type:"double",chartable:!0}));for(var o=0;o<a.length;o++){let t=a[o],e=t.clone();l.push(e);let s=t.getData(),r=Utils.cloneList(s),n=0,h=0;i.forEach((t=>{if(!t.isNumeric())return;h++;let e=s[t.getIndex()];isNaN(e)||(n+=e)})),r.push(n/h),e.setData(r)}return new PointData("pointdata",r,l,null,{parent:t})},count:function(t,e){let i=t.getRecords(),a=t.getRecordFields();if(!e.field)throw new Error("No field specified");let s=this.display.getFieldById(a,e.field),l=[],r=s.clone();r.index=0,l.push(r),l.push(new RecordField({id:"count",index:1,label:"Count",type:"integer",chartable:!0}));let o={},n=[];for(var h=0;h<i.length;h++){let t=i[h],e=s.getValue(t);Utils.isDefined(o[e])||(o[e]=0,n.push(e))}let d=[];return e.sort&&n.sort(),n.forEach((t=>{let e=[t,n[t]],i=new PointRecord(l,NaN,NaN,NaN,null,e);d.push(i)})),new PointData("pointdata",l,d,null,{parent:t})},prune:function(t,e){let i,a=t.getRecords(),s=t.getRecordFields();i=e.fields?this.display.getFieldsByIds(s,(e.fields||"").replace(/_comma_/g,",")):s;let l=[],r=[];s.map((t=>{r.push(t.clone())}));for(var o=0;o<a.length;o++){let t=a[o],e=t.getData(),s=Utils.cloneList(e),r=!1,n=0;if(i.every((t=>{if(!t.isNumeric())return!0;n++;let i=e[t.getIndex()];return!!isNaN(i)||(r=!0,!1)})),r){let e=t.clone();e.setData(s),l.push(e)}}return new PointData("pointdata",r,l,null,{parent:t})},mergeRows:function(t,e){let i=t.getRecords(),a=t.getRecordFields(),s=e.operator||"count",l={},r=this.display.getFieldsByIds(a,(e.keyFields||"").replace(/_comma_/g,",")),o=this.display.getFieldsByIds(a,(e.altFields||"").replace(/_comma_/g,",")),n=[],h={};r.forEach(((t,e)=>{h[t.getId()]=!0;let i=t.clone();i.index=n.length,n.push(i)}));let d=this.display.getFieldsByIds(a,(e.valueFields||"").replace(/_comma_/g,","));null==e.valueFields&&(d=a);let p=[];d.forEach((t=>{h[t.getId()]||(l[t.getId()]=e[t.getId()+".operator"],p.push(t))})),p.forEach(((t,i)=>{var a=t.clone();if(a.index=n.length,a.isNumeric()){let i=e[a.id+".label"];a.id=a.id+"_"+(l[t.getId()+".operator"]||s),a.label=i||Utils.makeLabel(a.id)}n.push(a)})),"count"==s&&n.push(new RecordField({id:"count",index:n.length,label:"Count",type:"double",chartable:!0}));let g=[],c={};for(var u=0;u<i.length;u++){var y=i[u];let t="";r.forEach((e=>{let i=y.getValue(e.getIndex());""==i&&o.length>0&&o.forEach((t=>{i+=y.getValue(f1.getIndex())+"-"})),t+=i+"-"}));let e=c[t];e||(g.push(t),e=c[t]={count:0,sums:[],mins:[],maxs:[],records:[]},p.forEach(((t,i)=>{e.sums.push(0),e.mins.push(NaN),e.maxs.push(NaN)}))),p.forEach(((t,i)=>{let a=y.getValue(t.getIndex());t.isNumeric()&&!isNaN(a)&&(e.sums[i]+=a,e.mins[i]=isNaN(e.mins[i])?a:Math.min(e.mins[i],a),e.maxs[i]=isNaN(e.maxs[i])?a:Math.max(e.maxs[i],a))})),e.count++,e.records.push(y)}let m=[],f=0;return g.forEach(((t,e)=>{let i=c[t],a=[],l={},o=i.records[0].getDate(),h=RecordUtil.getBounds(i.records),d=h.south+(h.north-h.south)/2,g=h.west+(h.east-h.west)/2;t.indexOf("US")>=0&&(f++,1==f&&i.records.forEach((t=>{}))),r.forEach((t=>{let e=i.records[0].getValue(t.getIndex());a.push(e),l[t.getId()]=!0})),p.forEach(((t,e)=>{l[t.getId()]||(t.isNumeric()?"sum"==s?a.push(i.sums[e]):"average"==s?a.push(i.sums[e]/i.count):"min"==s?a.push(i.mins[e]):"max"==s&&a.push(i.maxs[e]):a.push(i.records[0].getValue(t.getIndex())))})),"count"==s&&a.push(i.count);let u=new PointRecord(n,d,g,NaN,o,a);m.push(u)})),new PointData("pointdata",n,m,null,{parent:t})},maxDate:function(t,e){let i=t.getRecords(),a=t.getRecordFields(),s=this.display.getFieldsByIds(a,(e.keyFields||"").replace(/_comma_/g,",")),l=[],r={};for(var o=0;o<i.length;o++){var n=i[o];let t="";s.forEach((e=>{t+=n.getValue(e.getIndex())+"-"}));let e=r[t];e||(l.push(t),e=r[t]={records:[]}),e.records.push(n)}let h=[];return l.forEach(((t,e)=>{let i=r[t].records,a=null,s=null;i.forEach((t=>{(null==a||t.getDate().getTime()>s)&&(s=t.getDate().getTime(),a=t)})),h.push(a)})),new PointData("pointdata",a,h,null,{parent:t})},unfurl:function(t,e){let i=t.getRecords(),a=t.getRecordFields(),s=this.display.getFieldById(a,e.headerField||""),l=this.display.getFieldById(a,e.uniqueField||""),r=this.display.getFieldsByIds(a,e.valueFields||""),o=this.display.getFieldsByIds(a,e.includeFields||""),n=e.prefix||"";if(!s)throw new Error("No headerField");let h=!1;if(!l){if("date"!=e.uniqueField)throw new Error("No uniqueField");h=!0}if(0==r.length)throw new Error("No value fields");let d=[],p={},g={},c=[],u={};i.forEach((t=>{let e=t.getValue(s.getIndex()),i=h?t.getDate():t.getValue(l.getIndex());p[e]||(p[e]=!0,r.length>1?r.forEach((t=>{let i=e+" - "+t.getLabel();d.push(i)})):d.push(e));let a=g[i];null==a&&(g[i]=a=[],c.push(i)),a.push(t)})),d.sort(((t,e)=>"number"==typeof t&&"number"==typeof e?t-e:(""+t).localeCompare(""+e))),d.forEach(((t,e)=>{u[t]=e}));let y=[],m=[],f="string";return c[0]&&(c[0].getTime?f="date":"number"==typeof c[0]&&(f="double")),d=h?Utils.mergeLists(["date"],d):Utils.mergeLists([l.getId()],d),d.forEach(((t,e)=>{t=e>0?n+""+t:""+t;let i=Utils.makeLabel(t),a=Utils.makeId(t),s=0==e?f:"double";m.push(new RecordField({id:a,index:m.length,label:i,type:s,chartable:!0}))})),c.forEach((t=>{let e=[];d.forEach((t=>{e.push("")})),e[0]=t;let i=0,a=null;cnt=0,g[t].forEach((t=>{null==a&&(a=t);let i=t.getValue(s.getIndex());if(r.length>1)r.forEach((a=>{let s=i+" - "+a.getId(),l=u[s];if(null==l)return;let r=t.getValue(valueIndex);e[1+o.length+l]=r}));else{let a=u[i];if(null==a)return;let s=r[0].getIndex(),l=t.getValue(s);e[1+o.length+a]=l}cnt++})),o.forEach((t=>{e[1+i]=a.getValue(t.getIndex()),i++}));let l=new PointRecord(m,a.getLatitude(),a.getLongitude(),NaN,null,e);y.push(l),cnt++})),new PointData("pointdata",m,y,null,{parent:t})}})}var DataUtils={getCsv:function(t,e){let i="";return t.forEach(((t,e)=>{e>0&&(i+=","),i+=t.getId()})),i+="\n",e.forEach((e=>{t.forEach(((t,a)=>{let s=e.getValue(t.getIndex());s=s&&s.getTime?Utils.formatDateYYYYMMDDHHMM(s):String(s),a>0&&(i+=",");let l=s.indexOf("\n")>=0||s.indexOf(",")>=0;s.indexOf('"')>=0&&(l=!0,s=s.replace(/\"/g,'""')),l&&(s='"'+s+'"'),i+=s})),i+="\n"})),i},getJson:function(t,e,i){let a=[];e.forEach((e=>{let i={};a.push(i),t.forEach(((t,a)=>{let s=e.getValue(t.getIndex());s=s&&s.getTime?Utils.formatDateYYYYMMDDHHMM(s):String(s),i[t.getId()]=s}))})),Utils.makeDownloadFile(i,JSON.stringify(a,null,2))},parseCommands:function(t){let e=[];return t?(t.split(";").forEach((t=>{let i=(t=t.trim()).indexOf("("),a={};if(i>=0){let e=t.substring(i+1).trim();t=t.substring(0,i).trim(),e.endsWith(")")&&(e=e.substring(0,e.length-1));let s=[],l=!1,r=!1,o="";for(let t=0;t<e.length;t++){let i=e[t];if("\\"!=i)if(r)o+=i,r=!1;else if("'"!=i)if(","!=i)o+=i;else{if(l){o+=i;continue}s.push(o),o=""}else l=!l,o+=i;else r=!0}s.push(o),s.forEach((t=>{let e="",i=(t=t.trim()).match(/(.*)=(.*)/);i&&(t=i[1],e=i[2]),t=t.trim(),e=e.trim(),e=e.replace(/^'/g,"").replace(/'$/g,""),""!=t&&(a[t]=e)}))}""!=t&&e.push({command:t,args:a})})),e):e},getDataFilters:function(display,prop){let filters=[];if(!prop)return filters;let baseId=display.getId(),cnt=0;return DataUtils.parseCommands(prop).map((cmd=>{let filterId=baseId+"_"+cnt++,[type,fieldId,value,enabled,label,expr]=[cmd.command,cmd.args.field,cmd.args.value,cmd.args.enabled,cmd.args.label,cmd.args.expr];if(enabled=!Utils.isDefined(enabled)||("true"==enabled.trim()||""==enabled.trim()),label){var cbx=display.jq("datafilterenabled_"+filterId);cbx.length&&(enabled=cbx.is(":checked"))}value="match"==type||"notmatch"==type?new RegExp(value):+value;let fields=null;cmd.args.fields&&(fields=display.getFieldsByIds(null,cmd.args.fields.replace(/:/g,",")));let allFields=display.getData().getRecordFields(),field=display.getFieldById(null,fieldId);filters.push({id:filterId,props:cmd.args,type:type.trim(),field:field,fields:fields||(field?[field]:null),allFields:allFields,value:value,label:label,enabled:enabled,expr:expr,isRecordOk:function(r){if(!this.enabled)return!0;let value=this.field?r.getValue(this.field.getIndex()):NaN;if("match"==this.type)return String(value).match(this.value);if("nomissing"==this.type){let t=null;t=this.fields?this.fields:this.field?[this.field]:r.fields;let e=!1;return t.some((t=>{if(field&&!field.isFieldLatitude()&&!t.isFieldLongitude()&&(t.isFieldLatitude()||t.isFieldLongitude()))return!0;if(t.isNumeric()){let i=r.getValue(t.getIndex());e=!isNaN(i)}return e})),e}if("notmatch"==this.type)return!String(value).match(this.value);if("lessthan"==this.type)return value<this.value;if("greaterthan"==this.type)return value>this.value;if("equals"==this.type)return value==this.value;if("notequals"==this.type)return value!=this.value;if("bounds"==this.type){let t=r.getLatitude(),e=r.getLongitude();return!(this.props.north&&t>+this.props.north)&&(!(this.props.south&&t<+this.props.south)&&(!(this.props.west&&e<+this.props.west)&&!(this.props.east&&e>+this.props.east)))}if("eval"==this.type){let code="function dataFilterCall(){\n";this.allFields.every((t=>{let e=r.getValue(t.getIndex());return("string"==typeof e||"number"!=typeof e)&&(e="'"+e+"'"),code+=t.getId()+"="+e+";\n",!0}));let expr=this.expr;if(null==expr)throw"No expr given in data filter";return expr.indexOf("return")<0&&(expr=" return "+expr),code+=expr+"\n}\n",code+="var dataFilterValue = dataFilterCall();\n",eval(code),dataFilterValue}return console.log("Unknown filter:"+this.type),!0}})})),filters}};function RequestMacro(t,e){this.display=t;let i=null,a=this.getProperty("request."+e+".values");if(a){i=[];let t=!1;this.getProperty("request."+e+".includeAll",this.getProperty("request.includeAll",!1))&&(i.push(["","All"]),t=!0),this.getProperty("request."+e+".includeNone",!1)&&i.push(["","None"]),a.split(",").forEach((e=>{let a=e.split(":"),s=a[0],l=a[1];(t||"_all_"!=s)&&i.push([s,l||s])}))}let s=this.getProperty("request."+e+".type",null!=i?"enumeration":"bounds"==e?"bounds":"string"),l=this.getProperty("request."+e+".default",null);null==l&&(l=i&&i.length>0&&"enumeration"==s?i[0][0]:"",l=""),l&&"enumeration"==s&&l.split&&(l=l.split(","));let r=this.getProperty("requestPrefix","");$.extend(this,{name:e,values:i,urlarg:this.getProperty("request."+e+".urlarg",r+e),type:s,triggerReload:this.getProperty("request."+e+".triggerReload",!0),dflt:l,dflt_from:this.getProperty("request."+e+"_from.default",""),dflt_to:this.getProperty("request."+e+"_to.default",""),dflt_min:this.getProperty("request."+e+"_min.default",""),dflt_max:this.getProperty("request."+e+"_max.default",""),label:this.getProperty("request."+e+".label",Utils.makeLabel(e)),multiple:this.getProperty("request."+e+".multiple",!1),template:this.getProperty("request."+e+".template"),multitemplate:this.getProperty("request."+e+".multitemplate"),nonetemplate:this.getProperty("request."+e+".nonetemplate"),delimiter:this.getProperty("request."+e+".delimiter"),rows:this.getProperty("request."+e+".rows",3)})}function RamaddaBounds(t,e,i,a){if(Utils.isDefined(t.north)){let e=t;this.north=e.north,this.west=e.west,this.south=e.south,this.east=e.east}else if(Utils.isDefined(t.top)){let e=t;this.north=e.top,this.west=e.left,this.south=e.bottom,this.east=e.right}else this.north=t,this.west=e,this.south=i,this.east=a;$.extend(this,{toString:function(){return"N:"+this.north+" W:"+this.west+" S:"+this.south+" E:"+this.east}})}function makeInlineData(t,e){let i=$("#"+e).html().trim().split("\n"),a=[],s=i[1].split(","),l=null,r=null;i[0].split(",").forEach(((e,i)=>{e=e.trim();let o=Utils.makeId(e),n=Utils.makeLabel(e),h="string",d=s[i];t.getProperty(o+".label")&&(n=t.getProperty(o+".label")),t.getProperty(o+".type")?(h=t.getProperty(o+".type"),"enum"==h&&(h="enumeration")):"date"==o?h="date":isNaN(parseFloat(d))||(h="double");let p=new RecordField({id:e,index:i,label:n,type:h,chartable:!0});a.push(p),p.isFieldLatitude()?l=p:p.isFieldLongitude()&&(r=p)}));let o=[];return i.forEach(((t,e)=>{if(0==e)return;if(0==(t=t.trim()).length)return;let i=[],s=NaN,n=NaN,h=null;t.split(",").forEach(((t,e)=>{t=t.replace(/_nl_/g,"\n").replace(/_qt_/g,'"').replace(/_comma_/g,",");let o=a[e];l&&l.getIndex()==e?s=t=parseFloat(t):r&&r.getIndex()==e?n=t=parseFloat(t):o.isFieldNumeric()&&(t=parseFloat(t)),i.push(t)})),o.push(new PointRecord(a,s,n,NaN,h,i))})),new PointData(e,a,o,"#"+e)}RequestMacro.prototype={getProperty:function(t,e){return this.display.getProperty(t,e)},isVisible:function(){return this.getProperty("request."+this.name+".visible",this.getProperty("macros.visible",!0))},getWidget:function(t){let e,i=this.isVisible(),a=i?"":"display:none;",s=this.label;if("bounds"==this.type)e=HU.checkbox("",[ID,this.display.getDomId(this.getId())],!1)+HU.span([CLASS,"display-request-reload",TITLE,"Reload with current bounds"]," In bounds"),s=null;else if("enumeration"==this.type){if(this.values&&this.values.length>0){let t=[STYLE,a,ID,this.display.getDomId(this.getId()),CLASS,"display-filter-input"],i=this.values;if(this.dflt){let t=[],e=[];i.forEach((i=>{this.dflt.indexOf(i[0])>=0?t.push(i):e.push(i)})),i=Utils.mergeLists(t,e)}this.multiple?(t.push("multiple"),t.push(null),t.push("size"),t.push(Math.min(this.rows,i.length))):i=Utils.mergeLists([[VALUE_NONE,"--"]],i),e=HU.select("",t,i,this.dflt,20)}}else if("numeric"==this.type){let t=this.display.getDomId(this.getId()+"_min"),i=this.display.getDomId(this.getId()+"_max");e=HU.input("","",["data-min",this.dflt_min,STYLE,a,ID,t,"size",4,CLASS,"display-filter-input display-filter-range"],this.dflt_min)+" - "+HU.input("","",["data-max",this.dflt_max,STYLE,a,ID,i,"size",4,CLASS,"display-filter-input display-filter-range"],this.dflt_max),s+=" range"}else if("date"==this.type){let i=this.display.getDomId(this.getId()+"_from"),l=this.display.getDomId(this.getId()+"_to");t.push(i),t.push(l),e=HU.datePicker("",this.dflt_from,[CLASS,"display-filter-input",STYLE,a,"name","",ID,i])+" - "+HU.datePicker("",this.dflt_to,[CLASS,"display-filter-input",STYLE,a,"name","",ID,l]),s+=" range"}else{let t="10";"number"==this.type&&(t="4"),e=HU.input("",this.dflt,[STYLE,a,ID,this.display.getDomId(this.getId()),"size",t,CLASS,"display-filter-input"])}return e?i?this.display.makeFilterWidget(s,e):e:""},isMacro:function(t){return t==this.name},getId:function(){return"macro_"+this.name},getValue:function(){let t=this.display.jq(this.getId()),e=this.dflt;if(0!=t.length)e=t.val();else if("enumeration"==this.type)return VALUE_NONE;return this.display.setProperty("request."+this.name+".default",e),e},setValue:function(t){let e=this.getId();"min"==t.what?this.display.jq(i+"_min").val(t.value):"max"==t.what?this.display.jq(e+"_max").val(t.value):"from"==t.what?this.display.jq(e+"_from").val(t.value):"to"==t.what?this.display.jq(e+"_to").val(t.value):(console.log(this.type+" macroChanged:"+t.value+" "+this.display.jq(e).length),this.display.jq(e).val(t.value),console.log("after:"+this.display.jq(e).val()))},apply:function(t){if("bounds"==this.type){if(this.display.getBounds&&this.display.jq(this.getId()).is(":checked")){let e=this.display.getBounds();e&&(e=RecordUtil.convertBounds(e),["north","south","east","west"].map((i=>{t+="&"+i+"="+e[i]})))}}else if("numeric"==this.type){let e=this.display.jq(this.getId()+"_min").val()||"",i=this.display.jq(this.getId()+"_max").val()||"";this.dflt_min=e,this.dflt_max=i,""!=e&&(t=t+"&"+HU.urlArg(this.urlarg+"_from",e)),""!=i&&(t=t+"&"+HU.urlArg(this.urlarg+"_to",i)),this.display.setProperty("request."+this.name+"_min.default",e),this.display.setProperty("request."+this.name+"_max.default",i)}else if("date"==this.type){let e=this.display.jq(this.getId()+"_from").val()||"",i=this.display.jq(this.getId()+"_to").val()||"";this.dflt_from=e,this.dflt_to=i,this.display.setProperty("request."+this.name+"_from.default",e),this.display.setProperty("request."+this.name+"_to.default",i),""!=e&&(t=t+"&"+HU.urlArg(this.urlarg+"_fromdate",e)),""!=i&&(t=t+"&"+HU.urlArg(this.urlarg+"_todate",i))}else if("enumeration"==this.type){let e=this.getValue();if(Array.isArray(e)||(e=[e]),"_all_"==e[0]||"_none_"==e[0]||e[0]==VALUE_NONE)return t;if(e.length>0){let i=new RegExp(this.urlarg+"=[^$&]*","g");t=t.replace(i,"");let a=[];if(e.forEach((t=>{this.template&&(t=this.template.replace(/\${value}/,t)),a.push(t)})),this.delimiter){let e="";a.forEach(((t,i)=>{i>0&&(e+=this.delimiter),e+=t})),this.multitemplate&&a.length>1&&(e=this.multitemplate.replace(/\${value}/,e)),t=t+"&"+HU.urlArg(this.urlarg,e)}else a.forEach((e=>{t=t+"&"+HU.urlArg(this.urlarg,e)}))}}else{let e=this.getValue();if(this.dflt=e,""!=e){let i=new RegExp(this.urlarg+"=[^$&]*","g");t=(t=t.replace(i,""))+"&"+HU.urlArg(this.urlarg,e)}}return t}};const DISPLAY_LINECHART="linechart",DISPLAY_AREACHART="areachart",DISPLAY_BARCHART="barchart",DISPLAY_BARTABLE="bartable",DISPLAY_BARSTACK="barstack",DISPLAY_PIECHART="piechart",DISPLAY_TIMERANGECHART="timerangechart",DISPLAY_SANKEY="sankey",DISPLAY_CALENDAR="calendar",DISPLAY_SCATTERPLOT="scatterplot",DISPLAY_HISTOGRAM="histogram",DISPLAY_BUBBLE="bubble",DISPLAY_GAUGE="gauge",DISPLAY_TABLE="table",DISPLAY_WORDTREE="wordtree",DISPLAY_TREEMAP="treemap",DISPLAY_ORGCHART="orgchart",ID_CHART="chart",ID_CHARTS="charts",ID_CHARTS_INNER="chartsinner";var ramaddaChartInfo={debug:!1,version:"51",loading:!1,chartsHaveLoaded:!1,pending:[],packages:{}};function haveGoogleChartsLoaded(t){if(ramaddaChartInfo.chartsHaveLoaded)return t&&t(),!0;if(t&&ramaddaChartInfo.pending.push(t),!window.google){if(ramaddaChartInfo.debug&&console.log("\tno google"),ramaddaChartInfo.loading)return!1;ramaddaChartInfo.loading=!0,Utils.loadScript("https://www.gstatic.com/charts/loader.js",(()=>{ramaddaChartInfo.debug&&console.log("loader.js loaded calling google.charts.load version:"+ramaddaChartInfo.version),google.charts.load(ramaddaChartInfo.version,{packages:["corechart"]}),google.charts.setOnLoadCallback((()=>{ramaddaChartInfo.debug&&console.log("core chart loaded"),ramaddaChartInfo.chartsHaveLoaded=!0,ramaddaChartInfo.pending.forEach((t=>{ramaddaChartInfo.debug&&console.log("\tcalling callback"),t()})),ramaddaChartInfo.pendingDisplays=[]}))}))}}function ramaddaLoadGoogleChart(t,e){let i=ramaddaChartInfo.packages[t];return i||(i=ramaddaChartInfo.packages[t]={loading:!1,loaded:!1,pending:[]}),!!i.loaded||(e&&i.pending.push(e),i.loading||(i.loading=!0,ramaddaChartInfo.debug&&console.log("calling google.charts.load:"+t),google.charts.load(ramaddaChartInfo.version,{packages:[t],callback:()=>{ramaddaChartInfo.debug&&console.log("google.charts.load callback:"+t+" pending:"+i.pending.length),i.loaded=!0,i.pending.forEach((t=>t()))}})),!1)}addGlobalDisplayType({type:DISPLAY_TABLE,label:"Table",requiresData:!0,forUser:!0,category:CATEGORY_TABLE,desc:"Basic tabular display",tooltip:makeDisplayTooltip("Tabular display of data","table.png")},!0),addGlobalDisplayType({type:DISPLAY_LINECHART,label:"Line Chart",requiresData:!0,forUser:!0,category:CATEGORY_CHARTS,tooltip:makeDisplayTooltip("Basic line chart","linechart.png","Show time series or other data"),helpurl:!0}),addGlobalDisplayType({type:DISPLAY_BARCHART,label:"Bar Chart",requiresData:!0,forUser:!0,category:CATEGORY_CHARTS,tooltip:makeDisplayTooltip(null,"barchart.png")}),addGlobalDisplayType({type:DISPLAY_BARSTACK,label:"Stacked Bar Chart",requiresData:!0,forUser:!0,category:CATEGORY_CHARTS,tooltip:makeDisplayTooltip("Stacked bar chart","barstack.png"),helpurl:!0}),addGlobalDisplayType({type:DISPLAY_AREACHART,label:"Area Chart",requiresData:!0,forUser:!0,category:CATEGORY_CHARTS,tooltip:makeDisplayTooltip(null,"areachart.png")}),addGlobalDisplayType({type:DISPLAY_BARTABLE,label:"Bar Table",requiresData:!0,forUser:!0,category:CATEGORY_CHARTS,tooltip:makeDisplayTooltip(null,"bartable.png")}),addGlobalDisplayType({type:DISPLAY_SCATTERPLOT,label:"Scatter Plot",requiresData:!0,forUser:!0,category:CATEGORY_CHARTS,tooltip:makeDisplayTooltip(null,"scatterplot.png")}),addGlobalDisplayType({type:DISPLAY_HISTOGRAM,label:"Histogram",requiresData:!0,forUser:!0,category:CATEGORY_CHARTS,tooltip:makeDisplayTooltip(null,"histogram.png")}),addGlobalDisplayType({type:DISPLAY_BUBBLE,label:"Bubble Chart",requiresData:!0,forUser:!0,category:CATEGORY_CHARTS,tooltip:makeDisplayTooltip(null,"bubblechart.png")}),addGlobalDisplayType({type:DISPLAY_PIECHART,label:"Pie Chart",requiresData:!0,forUser:!0,category:CATEGORY_CHARTS,tooltip:makeDisplayTooltip(null,"piechart.png")}),addGlobalDisplayType({type:DISPLAY_GAUGE,label:"Gauge",requiresData:!0,forUser:!0,category:CATEGORY_MISC,tooltip:makeDisplayTooltip("A gauge","gauge.png")}),addGlobalDisplayType({type:DISPLAY_TIMERANGECHART,label:"Timerange",requiresData:!0,forUser:!0,category:CATEGORY_MISC,tooltip:makeDisplayTooltip("Time ranges","timerange.png","Show data with start/end times")}),addGlobalDisplayType({type:DISPLAY_SANKEY,label:"Sankey Chart",requiresData:!0,forUser:!0,category:CATEGORY_RADIAL_ETC,tooltip:makeDisplayTooltip(null,"sankey.png")}),addGlobalDisplayType({type:DISPLAY_CALENDAR,label:"Calendar Chart",requiresData:!0,forUser:!0,category:CATEGORY_MISC,tooltip:makeDisplayTooltip("Show a calendar","calendar.png")}),addGlobalDisplayType({type:DISPLAY_WORDTREE,label:"Word Tree",requiresData:!0,forUser:!0,category:CATEGORY_TEXT,tooltip:makeDisplayTooltip("Displays data as a tree of words","wordtree.png","Specify a number of fields. Each field value is a level in the tree")}),addGlobalDisplayType({type:DISPLAY_TREEMAP,label:"Tree Map",requiresData:!0,forUser:!0,category:CATEGORY_RADIAL_ETC,tooltip:makeDisplayTooltip("A tree map","treemap.png")}),addGlobalDisplayType({type:DISPLAY_ORGCHART,label:"Org Chart",requiresData:!0,forUser:!0,category:CATEGORY_RADIAL_ETC,tooltip:makeDisplayTooltip(null,"orgchart.png")});let PROP_CHART_MIN="chartMin",PROP_CHART_MAX="chartMax",DFLT_WIDTH="600px",DFLT_HEIGHT="200px";function RamaddaGoogleChart(t,e,a,s){const l="trends_cbx",r="percent_cbx",o="colors",n="highlightfieldsholder",h="highlightfields";$.extend(this,{debugChartOptions:!1,useTestData:!1,indexField:-1,curveType:"none",fontSize:0,showPercent:!1,percentFields:null});const d=new RamaddaFieldsDisplay(t,e,a,s);this.debugTimes=!1,defineDisplay(this,d,[{label:"Chart Style"},{p:"highlightFields",d:null,ex:"fields"},{p:"highlightShowFields",d:null,ex:"true"},{p:"highlightShowFieldsSize",d:"4",ex:"4"},{p:"acceptHighlightFieldsEvent",d:!0,ex:"true"},{p:"highlightDim",d:"true",ex:"true",tt:"Dim the non highlight lines"},{p:"lineDashStyle",d:null,ex:"2,2,20,2,20"},{p:"highlight.lineDashStyle",d:"2,2,20,2,20",ex:"2,2,20,2,20"},{p:"nohighlight.lineDashStyle",d:"2,2,20,2,20",ex:"2,2,20,2,20"},{p:"some_field.lineDashStyle",d:"2,2,20,2,20",ex:"2,2,20,2,20"},{p:"labelInLegend",d:null,ex:"label"},{p:"highlight.labelInLegend",d:null,ex:"label"},{p:"nohighlight.labelInLegend",d:null,ex:"label"},{p:"some_field.labelInLegend",d:null,ex:"label"},{p:"seriesType",d:null,ex:"line|area|bars"},{p:"highlight.seriesType",d:null,ex:"line|area|bars"},{p:"nohighlight.seriesType",d:null,ex:"line|area|bars"},{p:"some_field.seriesType",d:null,ex:"line|area|bars"},{p:"pointSize",d:null,ex:"0"},{p:"highlight.pointSize",d:"0",ex:"4"},{p:"nohighlight.pointSize",d:"0",ex:"4"},{p:"some_field.pointSize",d:"4",ex:"4"},{p:"lineWidth",d:null,ex:null},{p:"highlight.lineWidth",d:null,ex:"2"},{p:"nohighlight.lineWidth",d:null,ex:"2"},{p:"some_field.lineWidth",d:"2",ex:"2"},{p:"highlight.color",d:null,ex:null},{p:"nohighlight.color",d:null,ex:null},{p:"some_field.color",d:null,ex:null},{p:"pointShape",d:null,ex:null},{p:"highlight.pointShape",d:null,ex:null},{p:"nohighlight.pointShape",d:null,ex:null},{p:"some_field.pointShape",d:null,ex:null},{label:"Trendlines"},{p:"showTrendline",d:null,ex:"true"},{p:"trendlineType",ex:"exponential"},{p:"trendlineVisibleInLegend",ex:"true"},{p:"trendlineColor",ex:""},{p:"trendlineLineWidth",ex:"true"},{p:"trendlineOpacity",ex:"0.3"}],{checkFinished:function(){return!0},useDisplayMessage:function(){return!0},getContentsClass:function(){return"display-contents-inner display-"+this.type},useChartableFields:function(){return!0},defaultSelectedToAll:function(){return!1},getRequiredPackages:function(){return[]},chartCallbackPending:!1,updateUI:function(t){let e=this.chartCallbackPending?null:()=>{this.updateUI()};if(this.chartCallbackPending=!0,!haveGoogleChartsLoaded(e))return;let i=this.getRequiredPackages();if(i.length>0){this.packageLoading||(this.packageLoading={});let t=i.length;if(i.forEach((e=>{ramaddaLoadGoogleChart(e,this.packageLoading[e]?null:()=>{this.updateUI()})&&t--})),t>0)return}t=t||{},d.updateUI.call(this,t),this.updateUIInner(t)},updateUIInner:function(t){let e=!1;if(this.getDisplayReady()){if(t.dataFilterChanged)return this.setDisplayMessage(this.getLoadingMessage()),void setTimeout((()=>{this.displayData(t.reload,e)}),1);this.displayData(t.reload,e)}},getWikiAttributes:function(t){this.defineWikiAttributes(["vAxisMinValue","vAxisMaxValue"]),d.getWikiAttributes.call(this,t),"blue,red,green"!=this.colorList.join(",")&&(t.push("colors"),t.push(this.getColorList().join(", ")))},initDialog:function(){d.initDialog.call(this);let t=this,e=function(e){e&&13!=e.which&&0!=e.which||(t.vAxisMinValue=Utils.toFloat(t.jq("vaxismin").val()),t.vAxisMaxValue=Utils.toFloat(t.jq("vaxismax").val()),t.minDate=t.jq("mindate").val(),t.maxDate=t.jq("maxdate").val(),t.displayData())};["vaxismin","vaxismax","mindate","maxdate"].map((t=>{this.jq(t).blur(e),this.jq(t).keypress(e)})),this.jq(o).keypress((function(e){if(13!=e.which)return;let i=t.jq(o).val();t.colorList=i.split(","),t.displayData();t.dataCollection.getList();t.getDisplayManager().handleEventPointDataLoaded(t,t.lastPointData)})),this.jq(l).click((function(){t.showTrendLines=t.jq(l).is(":checked"),t.displayData()})),this.jq(r).click((function(){t.showPercent=t.jq(r).is(":checked"),t.displayData()}))},setColor:function(){let t=prompt("Enter comma separated list of colors to use",this.colorList.join(","));if(null!=t){this.colorList=t.split(","),this.displayData();this.dataCollection.getList();this.getDisplayManager().handleEventPointDataLoaded(this,this.lastPointData)}},getVAxisMinValue:function(){return parseFloat(this.getProperty("vAxisMinValue",NaN))},getVAxisMaxValue:function(){return parseFloat(this.getProperty("vAxisMaxValue",NaN))},getHAxisMinValue:function(){return parseFloat(this.getProperty("hAxisMinValue",NaN))},getHAxisMaxValue:function(){return parseFloat(this.getProperty("hAxisMaxValue",NaN))},getMenuItems:function(t){d.getMenuItems.call(this,t);this.getGet();let e="0";isNaN(this.getVAxisMinValue())||(e=""+this.getVAxisMinValue());let i="";isNaN(this.getVAxisMaxValue())||(i=""+this.getVAxisMaxValue());let a=HU.formTable();a+=HU.formEntry("Axis Range:",HU.input("",e,["size","7",ATTR_ID,this.domId("vaxismin")])+" - "+HU.input("",i,["size","7",ATTR_ID,this.domId("vaxismax")])),a+=HU.formEntry("Date Range:",HU.input("",this.minDate,["size","10",ATTR_ID,this.domId("mindate")])+" - "+HU.input("",this.maxDate,["size","10",ATTR_ID,this.domId("maxdate")])),a+=HU.formEntry("Colors:",HU.input("",this.getColorList().join(","),["size","35",ATTR_ID,this.domId(o)])),a+="</table>",t.push(a)},getChartType:function(){return this.getType()},askMinZAxis:function(){this.setMinZAxis(prompt("Minimum axis value","0"))},setMinZAxis:function(t){null!=t&&(this.vAxisMinValue=parseFloat(t),this.displayData())},askMaxZAxis:function(){this.setMaxZAxis(prompt("Maximum axis value","100"))},setMaxZAxis:function(t){null!=t&&(this.vAxisMaxValue=parseFloat(t),this.displayData())},askMinDate:function(){let t=this.minDate;null!=t&&""!=t||(t="1800-01-01");let e=prompt("Minimum date",t);null!=e&&this.setMinDate(e)},setMinDate:function(t){this.minDate=t,this.displayData()},askMaxDate:function(){let t=this.maxDate;null!=t&&""!=t||(t="2100-01-01");let e=prompt("Maximum date",t);null!=e&&this.setMaxDate(e)},setMaxDate:function(t){this.maxDate=t,this.displayData()},trendLineEnabled:function(){return!1},getDialogContents:function(t,e){let i=HU.div([ATTR_ID,this.domId(ID_FIELDS),STYLE,HU.css("overflow-y","auto","max-height","600px")]," FIELDS ");this.trendLineEnabled()&&(i+=HU.div([ATTR_CLASS,"display-dialog-subheader"],"Other"),i+=HU.checkbox(this.domId(l),[],this.getProperty("showTrendLines",!1))+"  Show trend line",i+=" ",i+=HU.checkbox(this.domId(r),[],this.showPercent)+"  Show percent of displayed total<br>",i+="<br>"),t.push("Fields"),e.push(i),d.getDialogContents.call(this,t,e)},okToHandleEventRecordSelection:function(){return!0},handleEventRecordHighlight:function(t,e){this.handleEventRecordSelection(t,e)},handleEventRecordSelection:function(t,e){if(d.handleEventRecordSelection.call(this,t,e),t==this)return;if(!this.okToHandleEventRecordSelection())return;let i=this.findMatchingIndex(e.record).index;i<0||!Utils.isDefined(i)||this.setChartSelection(i)},getFieldsToSelect:function(t){return t.getRecordFields()},canDoGroupBy:function(){return!1},clearCache:function(){},googleChartCallbackPending:!1,includeIndexInData:function(){return!1},getGroupBy:function(){return this.getProperty("groupByField")},getIncludeIndexIfDate:function(){return!1},makeIndexValue:function(t,e,i){return t.isString()?{v:i,f:e}:e&&e.getTime?{v:e,f:this.formatDate(e)}:e},getFieldsToDisplay:function(t){return t},displayData:function(t,e){e&&console.log(this.type+" displayData "+this.getId()+" "+this.type);let i=this.jq(ID_CHART).attr("isexpanded"),a=this.jq(ID_CHART).attr("original-height");if("true"===i?(this.setProperty("expandedHeight",this.jq(ID_CHART).css("height")),this.setProperty("isExpanded",!0),this.setProperty("originalHeight",a)):(this.setProperty("expandedHeight",null),this.setProperty("isExpanded",!1),this.setProperty("originalHeight",null)),!this.getDisplayReady())return void(e&&console.log("\tdisplay not ready"));if(this.inError)return void(e&&console.log("\tin error"));if(!haveGoogleChartsLoaded())return e&&console.log("\tgoogle charts have not loaded callback pending:"+this.googleChartCallbackPending),void(this.googleChartCallbackPending||(this.googleChartCallbackPending=!0,this.setDisplayMessage(this.getLoadingMessage()),setTimeout((()=>{this.googleChartCallbackPending=!1,this.displayData()}),100)));if(this.inError)return;if(!this.hasData())return this.clearChart(),void this.setDisplayMessage(this.getLoadingMessage());this.getAcceptEventDataSelection()||this.setDisplayMessage("Creating display...");let s=this.filterData(),l=this.getSelectedFields();if(e&&console.log("\tpointData #records:"+s.length),e&&console.log("\tselectedFields:"+l),0==l.length&&null!=this.lastSelectedFields&&(l=this.lastSelectedFields,e&&console.log("\tusing last selectedFields:"+l)),null!=l&&0!=l.length||(this.getChartType()==DISPLAY_TABLE||this.getChartType()==DISPLAY_TREEMAP?(l=this.dataCollection.getList()[0].getNonGeoFields(),e&&console.log("\tfields from data collection:"+l)):(l=this.getSelectedFields(),e&&console.log("\tgetSelectedFields again:"+l),l=this.getSelectedFields(),0==l.length&&this.getFields().every((t=>!(t.isNumeric()&&!t.isFieldGeo())||(l=[t],!1))))),0==l.length)return void(this.getAcceptEventDataSelection()||this.setDisplayMessage("No fields selected"));let r=[];for(let t=0;t<l.length;t++)this.shouldSkipField(l[t])||r.push(l[t]);l=r,e&&console.log("\tsetting lastSelectedFields:"+l),this.lastSelectedFields=l,this.lastSelectedFields&&this.lastSelectedFields.length>0&&this.jq(ID_TITLE_FIELD).html(this.lastSelectedFields[0].getLabel());let o={includeIndex:this.includeIndexInData(),groupByIndex:-1},n=this.getGroupBy();n&&this.getFields().every((t=>t.getId()!=n||(o.groupByIndex=t.getIndex(),o.groupByField=t,!1)));let h=l;this.raw&&(h=this.dataCollection.getList()[0].getRecordFields(),o.raw=!0),o.includeIndexIfDate=this.getIncludeIndexIfDate();let d=o.includeIndex,p=new Date,g=this.getStandardData(this.getFieldsToDisplay(h),o),c=new Date;if(this.debugTimes&&Utils.displayTimes("chart.getStandardData",[p,c],!0),e&&console.log(this.type+" fields:"+h.length+" dataList:"+g.length),0==g.length&&!this.userHasSelectedAField){let t=this.dataCollection.getList()[0],e=this.getFieldsToSelect(t);for(let t=0;t<e.length;t++){let i=e[t];if(g=this.getStandardData([i],o),g.length>0){this.setSelectedFields([i]);break}}}if(0==g.length)return void this.setContents(this.getMessage(this.getNoDataMessage()));if(this.showPercent){let t=[],e=[],i=null,a=null;null!=this.percentFields&&(a=this.percentFields.split(","));for(let s=0;s<g.length;s++){let l=this.getDataValues(g[s]);if(0==s){i=l;continue}if(1==s){let s=!1;for(let t=0;t<l.length;t++){let i="number"==typeof l[t],r="object"==typeof l[t];i&&d&&!s&&(i=!1,s=!0),r&&(s=!0),i&&null!=a&&(i=a.indexOf(h[t].getId())>=0||a.indexOf("#"+(t+1))>=0),e.push(i)}let r=[];for(let t=0;t<i.length;t++){let a=i[t];e[t]?r.push("% "+a):r.push(a)}t.push(r)}let r=0,o=0;for(let t=0;t<l.length;t++)e[t]&&(r+=parseFloat(l[t]),o++);let n=[];for(let t=0;t<l.length;t++)if(e[t])if(0!=r){let e=parseFloat((l[t]/r*100).toFixed(1));n.push(e)}else n.push(NaN);else n.push(l[t]);t.push(n)}g=t}try{this.clearDisplayMessage();let t=new Date;this.makeGoogleChart(g,o,l);let e=new Date;this.debugTimes&&Utils.displayTimes("chart.makeGoogleChart",[t,e],!0)}catch(t){return this.handleError("Error making chart:"+t,t),void this.setIsFinished()}this.setIsFinished();let u=this.jq(ID_CHART);if(this.jq(ID_CHART).is(":visible")?this.lastWidth=u.width():this.lastWidth=-1,t){let t=this.getData();if(t){let e=t.getRecords();if(e.length>0){let t=e[0];this.propagateEventRecordSelection({record:t})}}}},printDataList:function(t){console.log("data list:"+t.length);for(let e=0;e<t.length;e++){let i=t[e],a="";for(let t=0;t<i.length;t++)t>0&&(a+=", "),a+=i[t];console.log("row: "+e+"  "+a)}},mapCharts:function(t){null!=this.charts&&this.charts.map((e=>{t(e)}))},clearChart:function(){this.mapCharts((t=>{t.clearChart&&t.clearChart()}))},setChartSelection:function(t){this.mapCharts((e=>{e.setSelection&&e.setSelection([{row:t,column:null}])}))},tableHeaderMouseover:function(t,e){},doAddTooltip:function(){return!0},getAddStyle:function(){return!0},getAnnotationTemplate:function(){return this.getProperty("annotationTemplate")},getFormatNumbers:function(){return!1},getDataTableValueGetter:function(){return t=>t},getHighlightFields:function(){this.getPropertyFromUrl("highlightFields");return Utils.split(this.getPropertyFromUrl("highlightFields"),",",!0,!0)||[]},handleEventPropertyChanged:function(t,e){if("highlightFields"!=e.property)d.handleEventPropertyChanged.call(this,t,e);else if(this.getProperty("acceptHighlightFieldsEvent",!0)){this.setProperty("highlightFields",e.value),this.forceUpdateUI();let t=Utils.split(e.value,",",!0,!0);this.jq(h).val(t)}},makeSeriesInfo:function(t){let e=[];for(let i=1;i<t.getNumberOfColumns();i++)""==t.getColumnRole(i)&&e.push(t.getColumnLabel(i));let i=this.getColorList(),a={},s=this.getHighlightFields(),l=this.getProperty("highlightDim",!1);s.forEach((t=>{a[t]=!0}));let r={},o=this.getProperty("useMultipleAxes",!0);if(e.forEach(((t,e)=>{t=t.replace(/\(.*\)/g,"");let n=Utils.makeId(t),h=a[n],d={};["labelInLegend ","seriesType","lineDashStyle","pointSize","lineWidth","color","pointShape"].forEach((t=>{let e=this.getProperty((h?"highlight.":"nohighlight.")+t,this.getProperty(t)),i=this.getProperty(n+"."+t,e);if(i&&"lineDashStyle"==t){let t=[];Utils.split(i,",",!0,!0).forEach((e=>{t.push(parseFloat(e))})),i=t}"seriesType"==t&&(t="type"),d[t]=i})),d.color||(d.color=i[e%i.length]),s.length>0&&!h&&l&&(d.color=Utils.pSBC(.75,d.color)),o&&(d.targetAxisIndex=e%2==0?0:1),r[e]=d})),this.getProperty("highlightShowFields",!1)&&(0==this.jq(n).length&&this.jq(ID_HEADER2).append(HU.span([ID,this.domId(n)])),0==this.jq(h).length)){let t=[];e.forEach((e=>{t.push([Utils.makeId(e),e])})),t.sort(((t,e)=>t[1].localeCompare(e[1])));let i=SPACE+HU.vbox(["Highlight",HU.select("",[ID,this.domId(h),"multiple","true","size",this.getProperty("highlightShowFieldsSize","3")],t,s)]),a=HU.span([CLASS,"display-filter",STYLE,""],i);this.jq(n).html(a),this.jq(h).change((()=>{let t=Utils.makeArray(this.jq(h).val());t=Utils.join(t,","),this.setProperty("highlightFields",t),this.addToDocumentUrl("highlightFields",t),this.forceUpdateUI();let e={property:"highlightFields",value:t};this.propagateEvent(DisplayEvent.propertyChanged,e)}))}return r},makeTrendlinesInfo:function(t){let e=[];for(let i=1;i<t.getNumberOfColumns();i++)""==t.getColumnRole(i)&&e.push(t.getColumnLabel(i));let i={};return e.forEach(((t,e)=>{let a=Utils.makeId(t);if(this.getProperty("showTrendline."+a,this.getProperty("showTrendline"))){let t={};i[e]=t,t.type=this.getProperty("trendlineType."+a,this.getProperty("trendlineType")),t.visibleInLegend=this.getProperty("trendlineVisibleInLegend."+a,this.getProperty("trendlineVisibleInLegend")),t.color=this.getProperty("trendlineColor."+a,this.getProperty("trendlineColor")),t.lineWidth=this.getProperty("trendlineLineWidth."+a,this.getProperty("trendlineLineWidth")),t.opacity=this.getProperty("trendlineOpacity."+a,this.getProperty("trendlineOpacity"))}})),i},makeDataTable:function(t,e,a,s){this.getPropertyCount=0,this.getPropertyCounts={};let l=this.getProperty("dateType","date"),r=displayDebug.makeDataTable;r&&console.log(this.type+" makeDataTable #records"+t.length),r&&console.log("\tfields:"+a);let o=this.getProperty("maxFieldLength",this.getProperty("maxFieldWidth",-1)),n=this.getProperty("tooltip"),h=(n||this.getProperty("addTooltip",!1))&&this.doAddTooltip(),d=this.getAddStyle(),p=this.getAnnotationTemplate(),g=this.getFormatNumbers();if(1==t.length)return google.visualization.arrayToDataTable(this.makeDataArray(t));let c=this.getFieldById(null,this.getProperty("groupBy"));if(c){t=this.filterData();let e=[],i={},l=0,o={},n=[];r&&console.log("record[0]:"+t[0]),t.map(((t,s)=>{if(0==l++)return;let r=this.getDataValues(t),h=r[c.getIndex()];i[h]||(i[h]=!0,i[Utils.makeId(h)]=!0,e.push(h));let d=o[t.getDate()];d||(n.push(t.getDate()),d={},o[t.getDate()]=d),d[h]=r[a[0].getIndex()]}));let h=[],d=[],p=this.getHighlightFields(),g={};p.forEach((t=>{i[t]&&d.push(Utils.makeLabel(t))})),e=Utils.mergeLists(d,e),e=e.filter((t=>!g[t]&&(g[t]=!0,!0))),n.map((t=>{let i=[this.getDateValue(t)];h.push(i);let a=o[t];e.map((t=>{let e=a[t];i.push(e)}))}));let u=Utils.mergeLists(["Date"],e);r&&console.log("header:"+u);let y=new google.visualization.DataTable;if(h.length>0){h[0].forEach(((t,e)=>{let i=u[e],a=null==t?"number":typeof t;"number"==a?(r&&console.log("column:"+i+" type: number"),y.addColumn("number",i)):"string"==a?(r&&console.log("column:"+i+" type: string"),y.addColumn("string",i)):t.getTime||t.v&&t.v.getTime?(r&&console.log("column:"+i+" type: date"),y.addColumn("date",i)):(console.log("Unknown type:"+t),console.log(JSON.stringify(t,null,2)))}))}return y.addRows(h),s&&(s.series=this.makeSeriesInfo(y),s.trendlines=this.makeTrendlinesInfo(y)),y}let u,y=[],m=this.getFieldsByIds(null,this.getProperty("tooltipFields","")),f=new google.visualization.DataTable,D=this.getDataValues(t[0]),I=this.getDataValues(t[1]),T=this.getProperty("fixedValue");T&&(u=parseFloat(T));let b=0,S=this.getProperty("indexIsString",this.getProperty("forceStrings",!1)),v=this.getProperty("maxHeaderLength",-1),x=this.getProperty("maxHeaderWidth",-1),U=this.getProperty("headerStyle");for(let t=0;t<D.length;t++){let i=null;(t>0||!e.includeIndex)&&(i=a[b++]);let s=I[t],o=D[t];if(v>0&&o.length>v){let t=o;o=o.substring(0,v-1)+"...",o=HU.span([TITLE,t],o)}if(x>0||U){let t=o,e="";x>0&&(o=o.replace(/ /g,"&nbsp;")),x>0&&(e+="max-width:"+x+"px;overflow-x:auto;"),U&&(e+=U),o=HU.div([TITLE,t,STYLE,e],o)}if(0==t&&e.includeIndex)"object"==typeof s?"number"==typeof s.v?S?f.addColumn("string",o):f.addColumn("number",o):f.addColumn(l,o):f.addColumn(typeof s,o);else if(t>0&&T?f.addColumn("number",this.getProperty("fixedValueLabel","Count")):i.isString()?f.addColumn("string",o):i.isFieldDate()?f.addColumn(l,o):f.addColumn("number",o),p&&f.addColumn({type:"string",role:"annotation",p:{html:!0}}),d&&(r&&console.log("add style column"),f.addColumn({type:"string",role:"style"})),t>0&&T)break}if(h&&(r&&console.log("add tooltip column"),f.addColumn({type:"string",role:"tooltip",p:{html:!0}})),r)for(let t=0;t<f.getNumberOfColumns();t++)console.log("col["+t+"]="+f.getColumnLabel(t)+" "+f.getColumnType(t));if(this.getProperty("annotations")||this.getProperty("annotationFields")){let e=Utils.cloneList(t);e.shift(),this.annotations=new Annotations(this,e),this.annotations.hasFields()&&(f.addColumn({type:"string",role:"annotation",p:{html:!0}}),f.addColumn({type:"string",role:"annotationText",p:{html:!0}}))}this.annotations&&this.annotations.isEnabled()&&(this.annotations.getShowLegend()&&this.jq(ID_LEGEND).html("<table width=100%><tr valign=top><td width=10%></td><td width=90%>"+HU.div([CLASS,"display-chart-legend"],this.annotations.getLegend())+"</td></tr></table>"),f.addColumn({type:"string",role:"annotation",p:{html:!0}}),f.addColumn({type:"string",role:"annotationText",p:{html:!0}}));let L=0,E=[new Date],P=[];for(let e=1;e<t.length;e++)P.push(t[e].record);this.getColorTable(!0);let C=this.getColorByInfo(P),A=this.getDataTableValueGetter(P),w=!1;for(let s=1;s<t.length;s++){let l=t[s],c=this.getDataValues(l),f=l.record,I="";if(C.index>=0){let t=f.getData()[C.index];hasColorByValue=!0,colorByValue=t,w=!0,I=C.getColorFromRecord(f)}c=c.slice(0);let b=[];r&&s<4&&console.log("row["+s+"]:");let v=0;for(let t=0;t<c.length;t++){let i=a[v++],l=c[t];if(S&&l.f&&(l=l.f.toString().replace(/\n/g," ")),t>0&&T)b.push(A(u,t,i,f)),r&&s<4&&console.log("\t fixed:"+u);else{let e=typeof l;if("number"==e?g&&(l={v:l,f:String(this.formatNumber(l))}):"boolean"==e&&(l=String(l)),r&&s<4){let e=l.f?"f:"+l.f+" v:"+l.v:l;console.log("\t value["+t+"]="+e+" "+typeof l)}o>0&&"string"==e&&l.length>o&&(l=l.substring(0,o)+"...");let a=A(l,t,i,f);b.push(a)}if(0==t&&e.includeIndex);else{if(p){let t=p.replace("${value}",l.f||l);r&&s<4&&console.log("\t annotation"+t),b.push(t)}d&&(b.push(I),r&&s<4&&console.log("\t color:"+I))}if(t>0&&T)break}if(h){let t="";if(n)t=this.getRecordHtml(f,null,n);else{let e="";if(f)for(let t=0;t<m.length;t++)e+="<b>"+m[t].getLabel()+"</b>: "+f.getValue(m[t].getIndex())+"<br>";t+=e;for(let i=0;i<c.length;i++)i>0&&(t+="<br>"),e=D[i].replace(/ /g,"&nbsp;"),value=c[i],Utils.isDefined(value)||(value="NA"),value&&value.f&&(value=value.f),Utils.isNumber(value)&&(value=this.formatNumber(value)),value=""+value,value=value.replace(/ /g,SPACE),t+=HU.b(e)+":"+SPACE+value}t=HU.div([STYLE,HU.css("padding","8px")],t),b.push(t),r&&s<4&&console.log("\t tooltip:")}if(this.annotations&&this.annotations.hasFields())if(f){let t="";this.annotations.getFields().forEach((e=>{let i=""+f.getValue(e.getIndex());""!=i&&(t+=i+"<br>")})),t=t.trim(),t=t.replace(/ /g,"&nbsp;"),L++;let e=null;t.trim().length>0&&(e=""+(this.annotations.labelField?f.getValue(this.annotations.labelField.getIndex()):L),0==e.trim().length&&(e=""+L)),r=!0,r&&s<4&&(console.log("\t label:"+e),console.log("\t desc:"+t)),r=!1,console.log("A2:"+e),b.push(e),b.push(t)}else i<2&&console.log("No records for annotation");if(this.annotations&&this.annotations.isEnabled()){let t=this.annotations.getAnnotationsFor(s);if(t){r&&s<4&&console.log("\t annotation:"+t);let e="",i="";t.forEach((t=>{""!=e&&(e+="/"),e+=t.label,""!=i?i+="<br>":t.record&&t.record.getDate()&&(i+=HU.b(this.formatDate(t.record.getDate()))+"<br>"),i+=t.description})),b.push(e),b.push(i)}else r&&s<4&&(console.log("\t annotation:null"),console.log("\t desc:null")),b.push(null),b.push(null);r=!1}y.push(b)}return r&&console.log("#rows:"+y.length),E.push(new Date),f.addRows(y),w&&C.displayColorTable(),s&&(s.isStacked||(s.series=this.makeSeriesInfo(f)),s.trendlines=this.makeTrendlinesInfo(f)),this.debugTimes&&Utils.displayTimes("makeDataTable",E,!0),f},makeChartOptions:function(t,e,i){let a={tooltip:{isHtml:!0,trigger:"both"}};$.extend(a,{width:"100%",lineWidth:this.getProperty("lineWidth",1),colors:this.getColorList(),curveType:this.curveType,pointShape:this.getProperty("pointShape"),pointSize:this.getProperty("pointSize"),vAxis:{}}),a.backgroundColor={},a.chartArea={},a.chartArea.backgroundColor={},a.legend={textStyle:{}},a.hAxis={gridlines:{},minorGridlines:{},textStyle:{}},a.xannotations={textStyle:{fontSize:this.getProperty("annotationsFontSize",12),color:this.getProperty("annotationsTextColor")},stem:{color:this.getProperty("annotationsStemColor"),length:this.getProperty("annotationsStemLength")},style:this.getProperty("annotationsStyle")},a.vAxis={gridlines:{},minorGridlines:{},textStyle:{}},a.hAxis.minValue=this.getProperty("hAxisMinValue"),a.hAxis.maxValue=this.getProperty("hAxisMaxValue"),a.vAxis.minValue=this.getProperty("vAxisMinValue"),a.vAxis.maxValue=this.getProperty("vAxisMaxValue"),a.vAxis.logScale=this.getProperty("vAxisLogScale",this.getProperty("logScale")),a.hAxis.logScale=this.getProperty("hAxisLogScale"),a.hAxis.titleTextStyle={},a.vAxis.titleTextStyle={},this.getProperty("hAxisDateFormat")&&(a.hAxis.format=this.getProperty("hAxisDateFormat"));let s=this.getProperty("lineColor"),l=this.getProperty("chartBackground");this.setPropertyOn(a.backgroundColor,"chart.fill","fill",l),this.setPropertyOn(a.backgroundColor,"chart.stroke","stroke",this.getProperty("chartArea.fill","")),this.setPropertyOn(a.backgroundColor,"chart.strokeWidth","strokeWidth",null),this.setPropertyOn(a.chartArea.backgroundColor,"chartArea.fill","fill",l),this.setPropertyOn(a.chartArea.backgroundColor,"chartArea.stroke","stroke",null),this.setPropertyOn(a.chartArea.backgroundColor,"chartArea.strokeWidth","strokeWidth",null);let r=this.getProperty("minorGridLines.color",this.getProperty("gridlines.color")||s||"transparent");this.setPropertyOn(a.hAxis.gridlines,"hAxis.gridlines.color","color",this.getProperty("gridlines.color")||s),this.setPropertyOn(a.hAxis.minorGridlines,"hAxis.minorGridlines.color","color",r),this.setPropertyOn(a.hAxis,"hAxis.baselineColor","baselineColor",this.getProperty("baselineColor")||s),this.setPropertyOn(a.vAxis.gridlines,"vAxis.gridlines.color","color",this.getProperty("gridlines.color")||s),this.setPropertyOn(a.vAxis.minorGridlines,"vAxis.minorGridlines.color","color",r),this.setPropertyOn(a.vAxis,"vAxis.baselineColor","baselineColor",this.getProperty("baselineColor")||s);let o,n=this.getProperty("textColor","#000"),h=this.getProperty("textBold","false");this.setPropertyOn(a.hAxis.textStyle,"hAxis.text.color","color",this.getProperty("axis.text.color",n)),this.setPropertyOn(a.vAxis.textStyle,"vAxis.text.color","color",this.getProperty("axis.text.color",n)),this.setPropertyOn(a.hAxis.textStyle,"hAxis.text.bold","bold",h),this.setPropertyOn(a.vAxis.textStyle,"vAxis.text.bold","bold",h),a.vAxis.title=Utils.decodeText(this.getProperty("vAxis.text",this.getProperty("vAxisText"))),a.hAxis.title=Utils.decodeText(this.getProperty("hAxis.text",this.getProperty("hAxisText"))),a.hAxis.slantedText=this.getProperty("hAxis.slantedText",this.getProperty("slantedText",!1)),this.setPropertyOn(a.hAxis.titleTextStyle,"hAxis.text.color","color",n),this.setPropertyOn(a.vAxis.titleTextStyle,"vAxis.text.color","color",n),this.setPropertyOn(a.legend.textStyle,"legend.text.color","color",n),o=this.getProperty("hAxis.ticks"),(o||""==o)&&(a.hAxis.ticks=Utils.split(this.getProperty("hAxis.ticks"),",",!0,!0)),o=this.getProperty("vAxis.ticks"),(o||""==o)&&(a.vAxis.ticks=Utils.split(this.getProperty("vAxis.ticks"),",",!0,!0)),this.fontSize>0&&(a.fontSize=this.fontSize);let d=[],p=[];t.forEach(((t,e)=>{if(0==e)return;let i=this.getDataValues(t);1==e&&(i.forEach(((t,e)=>{p.push("number"==typeof t)})),p.forEach((t=>d.push([Number.MAX_VALUE,Number.MIN_VALUE]))));let a=0;i.forEach(((t,e)=>{p[e]&&(d[a][0]=Math.min(d[a][0],t),d[a][1]=Math.max(d[a][1],t),a++)}))}));let g=[NaN,NaN];isNaN(this.getVAxisMinValue())?d.length>0&&this.getProperty("vAxisUseDefault")&&(g[0]=d[0][0]):g[0]=this.getVAxisMinValue(),isNaN(this.getVAxisMaxValue())?d.length:g[1]=this.getVAxisMaxValue(),isNaN(g[0])||(a.vAxis.minValue=g[0]),isNaN(g[1])||(a.vAxis.maxValue=g[1]),this.chartDimensions={width:"90%",left:"10%",right:10},useMultipleAxes=this.getProperty("useMultipleAxes",!0),(i.length>1&&useMultipleAxes||!0===this.getProperty("padRight",!1))&&(this.chartDimensions.width="80%"),this.getProperty("showTrendLines",!1)&&(a.trendlines={0:{type:"linear",color:"green"}});let c=this.getProperty("expandedHeight");return c&&(a.height=c),this.getPropertyShow&&(this.getPropertyShow=!1,Utils.makeDownloadFile("props.txt",this.getPropertyOutput)),this.setContents(HU.div([ID,this.domId(ID_CHARTS)])),a},getChartHeight:function(){return this.getProperty("height")},getChartWidth:function(){return this.getProperty("width")},getChartDiv:function(t){let e=[ATTR_ID,t],i="";this.getChartWidth();let a=this.getProperty("expandedHeight"),s=this.getChartHeight();i+=a?HU.css("height",a):s?s>0?HU.css("height",s+"px"):s<0?HU.css("height",-s+"%"):HU.css("height",s):HU.css("height","100%"),e.push(STYLE),e.push(i),e.push(CLASS),e.push("ramadda-expandable-target");let l=this.getProperty("isExpanded"),r=this.getProperty("originalHeight");return l&&(e.push("isexpanded","true"),e.push("original-height",r)),this.getProperty("expandableHeight")&&(e.push("expandable-height"),e.push(this.getProperty("expandableHeight"))),HU.div(e,"")},doMakeGoogleChart:function(t,e,i,a,s){throw new Error("doMakeGoogleChart undefined")},makeGoogleChart:function(t,e,i){try{this.doMakeGoogleChartInner(t,e,i)}catch(t){this.handleError("Error creating chart: "+t,t)}},setAxisRanges:function(t,e,i){if(this.getProperty("hAxisFixedRange")){let a=this.getColumnValues(i,e[0]);t.hAxis.minValue=a.min,t.hAxis.maxValue=a.max}if(this.getProperty("vAxisFixedRange")||this.getProperty("vAxisSelectedFields")||this.getProperty("vAxisAllFields")){let a=Number.MAX_VALUE,s=Number.MIN_VALUE;(this.getProperty("vAxisAllFields")?this.getFields():e).forEach((t=>{if(t.isFieldNumeric()){let e=this.getColumnValues(i,t);isNaN(e.min)||(a=Math.min(a,e.min)),isNaN(e.max)||(s=Math.max(s,e.max))}})),a!=Number.MAX_VALUE&&(t.vAxis.minValue=a,t.vAxis.maxValue=s)}},doMakeGoogleChartInner:function(t,e,i){if("undefined"==typeof google)return void this.setDisplayMessage("No google");this.chartOptions=this.makeChartOptions(t,e,i),this.chartOptions.bar={groupWidth:"95%"},Utils.isDefined(this.chartOptions.height)||(this.chartOptions.height="100%"),this.charts=[],this.chartCount=-1;let a=this.getPointData().getRecords();if(this.setAxisRanges(this.chartOptions,i,a),this.getProperty("doMultiCharts",this.getProperty("multipleCharts",!1))){let a=this.getFieldById(null,this.getProperty("multiField")),s=this.getProperty("multiChartsLabelPosition","bottom"),l={},r=[],o=[];t.forEach(((t,e)=>{e>0&&o.push(t)})),a||o.sort((function(t,e){let i=t.record?t.record.getDate():t.date,a=e.record?e.record.getDate():e.date;return i.getTime()-a.getTime()})),(t=Utils.mergeLists([t[0]],o)).forEach(((t,e)=>{if(0==e)return;let i=t.record,s=i?a?i.getValue(a.getIndex()):i.getDate():t.date,o=null;o=l[s],o||(o=[],l[s]=o,r.push(s)),o.push(t)})),this.jq(ID_CHARTS).html(HU.div([ID,this.domId(ID_CHARTS_INNER),STYLE,HU.css("text-align","center")]));let n="width:200px;"+this.getProperty("multiStyle",""),h=this.getProperty("multiLabelTemplate","${value}");a&&r.sort(),r.forEach(((a,r)=>{this.chartCount=r;let o=[],d=l[a];o.push(t[0]),o=Utils.mergeLists(o,d);let p=this.domId(ID_CHART)+"_"+this.chartCount,g=a;a.getTime&&(g=this.formatDate(a)),g=h.replace("${value}",g);let c=HU.div([CLASS,"display-multi-header"],g),u="top"==s?c:"",y="bottom"==s?c:"",m=HU.div([CLASS,"display-multi-div",STYLE,HU.css("display","inline-block")+n],u+this.getChartDiv(p)+y);this.jq(ID_CHARTS_INNER).append(m);let f=this.makeGoogleChartInner(o,p,e,i);f&&this.charts.push(f)}))}else{this.jq(ID_CHARTS).append(this.getChartDiv(this.domId(ID_CHART)));let a=this.makeGoogleChartInner(t,this.domId(ID_CHART),e,i);a&&this.charts.push(a)}this.mapCharts((t=>{google.visualization.events.addListener(t,"onmouseout",(()=>{}))}))},makeGoogleChartInner:function(t,e,i,a){let s=document.getElementById(e);if(!s)return void console.log(this.type+".makeGoogleChart: no chart div found:"+e);let l=this.makeDataTable(t,i,a,this.chartOptions),r=this.doMakeGoogleChart(t,i,s,a,this.chartOptions);if(null==r)return null;if(!l)return this.setDisplayMessage(this.getNoDataMessage()),null;if(this.getProperty("vAxisSharedRange")){let t=NaN;for(let e=0;e<l.getNumberOfColumns();e++){let i=l.getColumnRange(e);isNaN(i.max)||null==i.max||"number"!=typeof i.max||(t=null==t||isNaN(t)?i.max:Math.max(t,i.max))}chartOptions.vAxis.maxValue=t}if(this.getProperty("animation",!1,!0))this.chartOptions.animation={startup:!0,duration:parseFloat(this.getProperty("animationDuration",1e3,!0)),easing:this.getProperty("animationEasing","linear",!0)},HU.callWhenScrolled(this.domId(ID_CHART),(()=>{this.animationCalled||(this.animationCalled=!0,this.mapCharts((t=>{t.draw(l,this.chartOptions)})))}));else try{this.debugChartOptions&&console.log(JSON.stringify(this.chartOptions,null,2)),this.chart=r,this.dataTable=l;let t=google.visualization.arrayToDataTable([["Genre","Fantasy & Sci Fi","Western"],["2010",10,24],["2020",16,22],["2030",28,19]]);new Date;r.draw(this.useTestData?t:l,this.chartOptions)}catch(t){return this.handleError("Error creating chart:"+t,t),null}return this.addEvents(r),r},addEvents:function(t){let e=this;this.getProperty("propagateHighlightEvent")&&google.visualization.events.addListener(t,"onmouseover",(function(t){pointData=e.dataCollection.getList()[0];pointData.getRecordFields();let i=pointData.getRecords()[t.row];i&&e.getDisplayManager().notifyEvent(DisplayEvent.recordHighlight,e,{highlight:!0,record:i})})),google.visualization.events.addListener(t,"select",(function(t){e.mapCharts((t=>{if(t.getSelection){let i=t.getSelection();if(i&&i.length>0){let t=i[0].row,a=e.indexToRecord[t];if(a){let t=e.getBinnedRecords(a);t?1==t.length?e.propagateEventRecordSelection({record:t[0]}):e.propagateEventRecordSelection({record:t[0],records:t}):e.propagateEventRecordSelection({record:a})}}}}))}))}})}function RamaddaAxisChart(t,e,i,a){let s=new RamaddaGoogleChart(t,e,i,a);defineDisplay(this,s,[{label:"Chart Properties"},{p:"indexField",ex:"field",tt:"alternate field to use as index"},{p:"indexIsString",ex:"true",tt:"if index is a string set to true"},{p:"vAxisMinValue",ex:""},{p:"vAxisMaxValue",ex:""},{p:"vAxisSharedRange",ex:"true",tt:"use the same max value across all time series"},{p:"hAxisFixedRange"},{p:"vAxisSelectedFields",ex:"true",tt:"Use selected fields to find min/max for the range"},{p:"vAxisAllFields",ex:"true",tt:"Use all field values to find min/max for the range"},{p:"vAxisLogScale",ex:"true"},{p:"hAxisLogScale",ex:"true"},{p:"tooltipFields",ex:""},{p:"annotations",ex:"date,label,desc;date,label,desc;",tt:"e.g. 2008-09-29,A,Start of housing crash;2008-11-04,B,Obama elected;"},{p:"annotationFields",ex:""},{p:"annotationLabelField",ex:""},{p:"dateType",ex:"datetime"},{p:"addTooltip",ex:"false",tt:"Set this to false for multi-series charts if you only want the hovered series to show in the tt"},{inlineLabel:"Multiples Charts"},{p:"doMultiCharts",ex:"true"},{p:"multiField",ex:"field"},{p:"multiStyle",ex:""},{p:"multiLabelTemplate",ex:"${value}"},{p:"multiChartsLabelPosition",ex:"bottom|top|none"},{inlineLabel:"Chart Layout"},{p:"chartHeight",ex:""},{p:"chartWidth",ex:""},{p:"chartLeft",ex:"0"},{p:"chartRight",ex:"0"},{p:"chartTop",ex:"0"},{p:"chartBottom",ex:"0"},{p:"lineColor",ex:""},{p:"chartBackground",ex:""},{p:"chart.fill",ex:""},{p:"chartArea.fill",ex:""},{p:"chart.stroke",ex:""},{p:"chart.strokeWidth",ex:""},{p:"chartArea.fill",ex:""},{p:"chartArea.stroke",ex:""},{p:"chartArea.strokeWidth",ex:""},{p:"gridlines.color",ex:"transparent"},{p:"minorGridLines.color",ex:"transparent"},{p:"gridlines.color",ex:""},{p:"hAxis.gridlines.color",ex:""},{p:"hAxis.minorGridlines.color",ex:"transparent"},{p:"baselineColor",ex:""},{p:"hAxis.baselineColor",ex:""},{p:"gridlines.color",ex:""},{p:"vAxis.gridlines.color",ex:""},{p:"vAxis.minorGridlines.color",ex:"transparent"},{p:"baselineColor",ex:""},{p:"vAxis.baselineColor",ex:""},{p:"textColor",ex:"#000"},{p:"textBold",ex:"true"},{p:"axis.text.color",ex:"#000"},{p:"hAxis.text.color",ex:"#000"},{p:"axis.text.color",ex:"#000"},{p:"vAxis.text.color",ex:"#000"},{p:"hAxis.text.bold",ex:"false"},{p:"vAxis.text.bold",ex:"false"},{p:"vAxisText",ex:""},{p:"vAxis.text",ex:""},{p:"slantedText",ex:"true"},{p:"hAxis.slantedText",ex:""},{p:"hAxis.text.color",ex:"#000"},{p:"vAxis.text.color",ex:"#000"},{p:"legend.position",ex:"top|bottom|none"},{p:"legend.text.color",ex:"#000"},{p:"hAxis.ticks",ex:""},{p:"hAxis.ticks",ex:""},{p:"vAxis.ticks",ex:""},{p:"vAxis.ticks",ex:""},{p:"useMultipleAxes",ex:"true"},{p:"showTrendLines",ex:"true"}],{setChartArea:function(t){t.chartArea||(t.chartArea={}),$.extend(t.chartArea,{left:this.getProperty("chartLeft",this.chartDimensions.left),right:this.getProperty("chartRight",this.chartDimensions.right),top:this.getProperty("chartTop","10"),bottom:this.getProperty("chartBottom"),height:this.getProperty("chartHeight","70%"),width:this.getProperty("chartWidth",this.chartDimensions.width)}),["left","top","right","bottom"].forEach((e=>{let i=t.chartArea[e];i&&(i=String(i).replace("px","")),t.chartArea[e]=i}))},makeChartOptions:function(t,e,i){chartOptions=s.makeChartOptions.call(this,t,e,i);let a=t[0].fields,l=this.getProperty("expandedHeight");if(chartOptions.height=l||this.getProperty("chartHeight",this.getProperty("height","150")),chartOptions.legend||(chartOptions.legend={}),this.setPropertyOn(chartOptions.legend,"legend.position","position",this.getProperty("legendPosition","bottom")),this.setChartArea(chartOptions),this.getProperty("useMultipleAxes",!0)&&(chartOptions.series=[{targetAxisIndex:0},{targetAxisIndex:1}]),"left"==chartOptions.legend.position&&(console.log(chartOptions.legend.position),chartOptions.series=[{targetAxisIndex:1}]),chartOptions.hAxis||(chartOptions.hAxis={}),chartOptions.vAxis||(chartOptions.vAxis={}),chartOptions.hAxis.textPosition=this.getProperty("hAxisTextPosition","top"),chartOptions.vAxis.textPosition=this.getProperty("vAxisTextPosition"),this.getProperty("hAxisTitle")&&(chartOptions.hAxis.title=this.getProperty("hAxisTitle")),this.getProperty("vAxisTitle")&&(chartOptions.vAxis.title=this.getProperty("vAxisTitle"),chartOptions.vAxis.title&&a)){let t=a.reduce(((t,e)=>t+" "+e.getLabel()),"");chartOptions.vAxis.title=chartOptions.vAxis.title.replace("${fields}",t)}return Utils.isDefined(this.chartHeight)&&(chartOptions.height=this.chartHeight),chartOptions}})}function RamaddaSeriesChart(t,e,i,a){defineDisplay(this,new RamaddaAxisChart(t,e,i,a),[],{includeIndexInData:function(){return this.getProperty("includeIndex",!0)},trendLineEnabled:function(){return!0}})}function BlankchartDisplay(t,e,i){const a=new RamaddaSeriesChart(t,e,"blankchart",i);defineDisplay(addRamaddaDisplay(this),a,[],{doMakeGoogleChart:function(t,e,i,a,s){return null}})}function LinechartDisplay(t,e,i){const a=new RamaddaSeriesChart(t,e,DISPLAY_LINECHART,i);defineDisplay(addRamaddaDisplay(this),a,[],{doMakeGoogleChart:function(t,e,i,a,s){return new google.visualization.LineChart(i)}})}function AreachartDisplay(t,e,i){const a=new RamaddaSeriesChart(t,e,DISPLAY_AREACHART,i);defineDisplay(addRamaddaDisplay(this),a,[{label:"Area Chart Properties"},{p:"isStacked",ex:"true"}],{doMakeGoogleChart:function(t,e,i,a,s){return this.isStacked&&(s.isStacked=!0),new google.visualization.AreaChart(i)}})}function RamaddaBaseBarchart(t,e,i,a){const s=new RamaddaSeriesChart(t,e,i,a);defineDisplay(this,s,[],{canDoGroupBy:function(){return!0},makeChartOptions:function(t,e,i){if(chartOptions=s.makeChartOptions.call(this,t,e,i),this.getChartType()==DISPLAY_BARSTACK&&(chartOptions.series=null,chartOptions.isStacked=!0),this.getProperty("barWidth")){let e=this.getProperty("barWidth");"flex"==e&&(e=t.length<100?"10":null),e&&(chartOptions.bar={groupWidth:e})}return chartOptions.orientation=this.getProperty("orientation","horizontal"),chartOptions},doMakeGoogleChart:function(t,e,i,a,s){return new google.visualization.BarChart(i)}})}function BarchartDisplay(t,e,i){const a=new RamaddaBaseBarchart(t,e,DISPLAY_BARCHART,i);defineDisplay(addRamaddaDisplay(this),a,[],{})}function BarstackDisplay(t,e,i){i=$.extend({isStacked:!0},i);const a=new RamaddaBaseBarchart(t,e,DISPLAY_BARSTACK,i);defineDisplay(addRamaddaDisplay(this),a,[],{})}function HistogramDisplay(t,e,i){const a=new RamaddaGoogleChart(t,e,DISPLAY_HISTOGRAM,i);defineDisplay(addRamaddaDisplay(this),a,[{label:"Histogram Properties"},{p:"legendPosition",ex:"none|top|right|left|bottom"},{p:"textPosition",ex:"out|in|none"},{p:"isStacked",ex:"false|true|percent|relative"},{p:"logScale",ex:"true|false"},{p:"scaleType",ex:"log|mirrorLog"},{p:"minValue",ex:""},{p:"maxValue",ex:""}],{okToHandleEventRecordSelection:function(){return!1},makeDataTable:function(t,e,i){return google.visualization.arrayToDataTable(this.makeDataArray(t))},doMakeGoogleChart:function(t,e,i,a,s){this.legendPosition&&(s.legend||(s.legend={}),s.legend.position=this.legendPosition);let l=this.getProperty("isStacked",null);return l&&(s.isStacked="true"==l||"false"!=l&&l),s.vAxis={},s.vAxis.viewWindow={},Utils.isDefined(this.logScale)&&(s.vAxis.logScale=""+this.logScale==1),this.textPosition&&(s.vAxis.textPosition=this.textPosition),Utils.isDefined(this.minValue)&&(s.vAxis.viewWindow.min=parseFloat(this.minValue)),Utils.isDefined(this.maxValue)&&(s.vAxis.viewWindow.max=parseFloat(this.maxValue)),isNaN(this.getVAxisMaxValue())||(s.vAxis.maxValue=this.getVAxisMaxValue()),isNaN(this.getVAxisMinValue())||(s.vAxis.minValue=parseFloat(this.getVAxisMinValue())),isNaN(this.getHAxisMaxValue())||(s.hAxis.maxValue=this.getHAxisMaxValue()),isNaN(this.getHAxisMinValue())||(s.hAxis.minValue=parseFloat(this.getHAxisMinValue())),new google.visualization.Histogram(i)}})}function RamaddaTextChart(t,e,i,a){defineDisplay(this,new RamaddaGoogleChart(t,e,i,a),[],{getFieldsToSelect:function(t){return t.getNonGeoFields()}})}function PiechartDisplay(t,e,i){let a="pielegend";const s=new RamaddaTextChart(t,e,DISPLAY_PIECHART,i);defineDisplay(addRamaddaDisplay(this),s,[{label:"Pie Chart Properties"},{p:"groupBy",ex:""},{p:"groupByCount",ex:"true"},{p:"groupByCountLabel",ex:""},{p:"binCount",ex:"true"},{p:"pieHole",ex:"0.5"},{p:"is3D",ex:"true"},{p:"bins",ex:""},{p:"binMin",ex:""},{p:"binMax",ex:"max"},{p:"sliceVisibilityThreshold",ex:"0.01"},{p:"pieSliceTextColor",ex:"black"},{p:"pieSliceBorderColor",ex:"black"}],{uniqueValues:[],uniqueValuesMap:{},canDoGroupBy:function(){return!0},makeGoogleChart:function(t,e,i){if(this.uniqueValues=[],this.uniqueValuesMap={},s.makeGoogleChart.call(this,t,e,i),!this.getProperty("showTopLegend"))return;let l="",r=this.getColorList(),o=0;this.uniqueValues.map(((t,e)=>{o>=r.length&&(o=0);let i=r[o];l+=HU.div([STYLE,HU.css("display","inline-block","width","8px","height","8px","background",i)])+SPACE+t+SPACE2,o++})),0==this.jq(a).length&&this.jq(ID_HEADER2).append(HU.div([ID,this.domId(a)])),this.jq(a).html(l)},setChartSelection:function(t){},getGroupBy:function(){if(!this.groupBy&&""!=this.groupBy){let t=this.getFieldByType(this.getFields(),"string");t&&(this.groupBy=t.getId())}return this.groupBy},getChartDiv:function(t){let e=[ATTR_ID,t];e.push(STYLE);let i="",a=this.getProperty("chartWidth")||this.getChartWidth(),s=this.getProperty("chartHeight")||this.getChartHeight();return i+=a?a>0?"width:"+a+"px;":a<0?"width:"+-a+"%;":"width:"+a+";":"width:100%;",i+=s?s>0?"height:"+s+"px;":s<0?"height:"+-s+"%;":"height:"+s+";":"height:100%;",i+="padding:5px;",e.push(i),HU.div(e,"")},doMakeGoogleChart:function(t,e,i,a,s){return s.tooltip={textStyle:{color:"#000000",fontSize:12},showColorCode:!0},this.chartOptions.legend={position:this.getProperty("legendPosition","right"),alignment:"center"},this.getProperty("bins",null)?s.title="Bins: "+this.getDataValues(t[0])[1]:this.getProperty("sumFields")?s.title=this.getProperty("chartTitle","Categories/Values"):s.title=this.getDataValues(t[0])[0]+" - "+this.getDataValues(t[0])[1],this.is3D&&(s.is3D=!0),this.pieHole&&(s.pieHole=this.pieHole),this.sliceVisibilityThreshold&&(s.sliceVisibilityThreshold=this.sliceVisibilityThreshold),s.pieSliceBorderColor=this.getProperty("pieSliceBorderColor","transparent"),s.pieSliceTextStyle={color:this.getProperty("pieSliceTextColor","white")},s.chartArea={},$.extend(s.chartArea,{left:this.getProperty("chartLeft",0),right:this.getProperty("chartRight",0),top:this.getProperty("chartTop",0),bottom:this.getProperty("chartBottom",0),width:"100%",height:"100%"}),new google.visualization.PieChart(i)},getColorList:function(){if(this.getProperty("colors")&&"default"!=this.getProperty("colors"))return s.getColorList.call(this);if(this.getProperty("colorTable")){return this.getColorTable().colors}return Utils.mergeLists(Utils.getColorTable("schemeset1",!0),Utils.getColorTable("schemecategory",!0))},makeDataTable:function(t,e,i){let a=new google.visualization.DataTable,s=[],l=this.getDataValues(t[0]);if(a.addColumn("string",l[0]),a.addColumn("number",l[1]),this.getProperty("bins",null)){let e=parseInt(this.getProperty("bins",null)),i=Number.MAX_VALUE,a=Number.MIN_VALUE,l=!1,r=!1;this.getProperty("binMin")&&(i=parseFloat(this.getProperty("binMin")),l=!0),this.getProperty("binMax")&&(a=parseFloat(this.getProperty("binMax")),r=!0);let o=[];for(let e=1;e<t.length;e++){let s=this.getDataValues(t[e])[1];Utils.isRealNumber(s)&&(l||(i=Math.min(s,i)),r||(a=Math.max(s,a)),o.push(s))}let n=[],h=(a-i)/e;for(let t=0;t<e;t++)n.push({min:i+t*h,max:i+(t+1)*h,values:[]});for(let t=0;t<o.length;t++){let e=o[t],i=!1;for(let t=0;t<n.length;t++)if(e<n[t].min||e>=n[t].min&&e<=n[t].max){n[t].values.push(e),i=!0;break}i||n[n.length-1].values.push(e)}for(let t=0;t<e;t++){let e=n[t];s.push(["Bin:"+this.formatNumber(e.min)+"-"+this.formatNumber(e.max),e.values.length])}}else if(this.getProperty("sumFields")){a=new google.visualization.DataTable,a.addColumn("string","Category"),a.addColumn("number","Value");let t=this.filterData(),e=this.getFieldsByIds(null,this.getProperty("sumFields")),i=[];e.map((t=>{i.push(0)})),this.chartCount>=0&&(t=[t[this.chartCount]]),t.map((t=>{e.map(((e,a)=>{let s=t.getValue(e.getIndex());isNaN(s)||(i[a]+=s)}))})),e.map(((t,e)=>{s.push([t.getLabel(),i[e]>0?i[e]:0])}))}else for(let e=1;e<t.length;e++){let i=this.getDataValues(t[e]),a=""+(1==i.length?"#"+e:i[0]),l=1==i.length?i[0]:i[1];s.push([a,l])}return s.map((t=>{let e=t[0];this.uniqueValuesMap[e]||(this.uniqueValuesMap[e]=!0,this.uniqueValues.push(e))})),a.addRows(s),a}})}function SankeyDisplay(t,e,i){this.tries=0;const s=new RamaddaTextChart(t,e,DISPLAY_SANKEY,i);defineDisplay(addRamaddaDisplay(this),s,[],{getRequiredPackages:function(){return["sankey"]},doMakeGoogleChart:function(t,e,i,a,s){return s.height=parseInt(this.getProperty("chartHeight",this.getProperty("height","400"))),s.sankey={node:{colors:this.colors,width:5},link:{colorMode:"source",colors:this.colors,color:{}}},new google.visualization.Sankey(i)},defaultSelectedToAll:function(){return!0},makeDataTable:function(t,e,i){if(!this.getProperty("doCategories",!1)){let e=this.makeDataArray(t);return google.visualization.arrayToDataTable(e)}let s=[];for(let t=0;t<i.length;t++){let e=i[t];e.isFieldString()&&s.push(e)}let l=[];l.push(["characteristic 1","characteristic 2","value"]);for(let e=1;e<s.length;e++){s[e-1],s[e];let i={};for(let a=1;a<t.length;a++){let s=this.getDataValues(t[a]),l=s[e-1],r=s[e],o=l+"-"+r;i[o]||(i[o]={v1:l,v2:r,cnt:0}),i[o].cnt++}for(a in i)l.push([i[a].v1,i[a].v2,i[a].cnt])}return google.visualization.arrayToDataTable(l)}})}function WordtreeDisplay(t,e,i){const a=new RamaddaTextChart(t,e,DISPLAY_WORDTREE,i);defineDisplay(addRamaddaDisplay(this),a,[{label:"Word Tree"},{p:"treeRoot",d:"root",tt:"Word to use for root"},{p:"wordColors",ex:"red,green,blue",tt:"Colors to use for tree levels"},{p:"fixedSize",d:"false",tt:""},{p:"buckets",ex:"100,110,115,120,130",tt:"For numeric fields the buckets to put the records in"},{p:"&lt;field&gt;.buckets",ex:"100,110,115,120,130",tt:"Specify buckets for a particular field"},{p:"bucketLabels",ex:"young,middle,old,really_old",tt:"For numeric fields the labels used for the buckets"},{p:"&lt;field&gt;.bucketLabels",ex:"young,middle,old,really_old",tt:"Specify bucket labels for a particular field"}],{handleEventRecordSelection:function(t,e){},getRequiredPackages:function(){return["wordtree"]},doMakeGoogleChart:function(t,e,i,a,s){if(this.getProperty("chartHeight")&&(s.height=parseInt(this.getProperty("chartHeight"))),this.getWordColors()){let t=this.getWordColors().split(","),e=[];for(let i=0;i<3&&i<t.length;i++)e.push(t[i]);3==e.length&&(s.colors=e)}return this.getProperty("chartWidth")&&(s.width=parseInt(this.getProperty("chartWidth"))),s.wordtree={format:"implicit",wordSeparator:"_SEP_",word:this.getTreeRoot()},this.getProperty("maxFontSize")&&(s.maxFontSize=parseInt(this.getProperty("maxFontSize"))),new google.visualization.WordTree(i)},makeDataTable:function(t,e,i){let a=this.getTreeRoot(),s=this.filterData(null,i,{skipFirst:!0}),l=this.getSelectedFields(this.getData().getRecordFields()),r=this.getFieldById(null,this.getProperty("colorBy")),o=[],n=["phrases"];o.push(n);let h=this.getFixedSize();r&&(h=1),h&&n.push("size"),r&&n.push("value");let d={},p="";for(let t=0;t<l.length;t++){let e=l[t];if(""!=p&&(p+=" -&gt;"),p+=e.getLabel(),!e.isFieldNumeric())continue;let i,a,r=this.getColumnValues(s,e),o=[],n=this.getProperty("buckets."+e.getId(),this.getProperty("buckets",null));if(n){let s,l=this.getProperty("bucketLabels."+e.getId(),this.getProperty("bucketLabels",null));l&&(s=l.split(","));let r=n.split(","),h=0;for(let e=0;e<r.length;e++){let l=parseFloat(r[e]);if(0==e&&(i=l,a=l),i=Math.min(i,l),a=Math.max(a,l),e>0){let i;i=s&&t<=s.length?s[e-1]:this.formatNumber(h)+"-"+this.formatNumber(l),o.push({min:h,max:l,label:i})}h=l}}else{let t=parseInt(this.getProperty("numBuckets."+e.getId(),this.getProperty("numBuckets",10)));i=r.min,a=r.max;let s=(r.max-r.min)/t;for(let e=0;e<t;e++){let t=r.min+e*s,i=r.min+(e+1)*s,a=this.formatNumber(t)+"-"+this.formatNumber(i);o.push({min:t,max:i,label:a})}}d[e.getId()]={min:i,max:a,buckets:o}}for(let t=0;t<s.length;t++){let e=this.getDataValues(s[t]),i=a;for(let t=0;t<l.length;t++){let a=l[t];i+="_SEP_";let s=e[a.getIndex()];if(a.isFieldNumeric()){let t=d[a.getId()];for(let e=0;e<t.buckets.length;e++){let i=t.buckets[e];if(s>=i.min&&s<=i.max){s=i.label;break}}}i+=s}let n=[i.trim()];h&&n.push(parseInt(h)),r&&n.push(e[r.getIndex()]),o.push(n)}return this.getProperty("header")?p=this.getProperty("header",""):(p="<b>Fields: </b>"+p,this.getProperty("headerPrefix")&&(p=this.getProperty("headerPrefix")+" "+p)),this.writeHtml(ID_DISPLAY_TOP,p),google.visualization.arrayToDataTable(o)}})}function TableDisplay(t,e,i){const a=new RamaddaTextChart(t,e,DISPLAY_TABLE,i);defineDisplay(addRamaddaDisplay(this),a,[{label:"Table"},{p:"imageField",ex:""},{p:"tableWidth",ex:"100%"},{p:"frozenColumns",ex:"1"},{p:"colorCells",ex:"field1,field2"},{p:"foregroundColor"},{p:"showRowNumber",ex:!0},{p:"field.colorTable",ex:""},{p:"field.colorByMap",ex:"value1:color1,value2:color2"},{p:"maxHeaderLength",ex:"60"},{p:"maxHeaderWidth",ex:"60"},{p:"headerStyle"}],{getRequiredPackages:function(){return["table"]},canDoGroupBy:function(){return!0},defaultSelectedToAll:function(){return!0},getDataTableValueGetter:function(t){let e=this.getProperty("unhighlightColor","#fff"),i=this.getProperty("highlightColor","#FFFFCC"),a=this.getProperty("colorCells"),s={},l=this.getFieldById(null,this.getProperty("linkField")),r=this.getFieldById(null,this.getProperty("iconField")),o=this.getProperty("foregroundColor"),n=[];a&&a.split(",").forEach((e=>{let i=this.getFieldById(null,e);i&&(s[e]=new ColorByInfo(this,null,t,null,e+".colorByMap",null,e,i),n.push(s[e]))}));let h=this.jq(ID_COLORTABLE);return n.forEach(((t,e)=>{let i=this.domId(ID_COLORTABLE+e);h.append(HU.div([ID,i])),t.displayColorTable(null,!0,ID_COLORTABLE+e)})),(t,a,n,h)=>{if(null===t)return{v:0,f:""};let d=t;if(t.f&&(d=t.f,t=t.v),t.getTime&&(d=this.formatDate(t)),r&&h&&0==a){let t=h.getValue(r.getIndex());d=HU.image(t)+"&nbsp;"+d}if(l&&h&&0==a){let t=h.getValue(l.getIndex());d&&(d=d.trim()),Utils.isDefined(d)&&""!=d&&(d=HU.href(t,d))}if(this.getFilterHighlight()&&h){let t=h.isHighlight(this)?i:e;d=HU.div([STYLE,HU.css("padding","4px","background",t)],d)}else d=HU.div([STYLE,HU.css("padding","4px")],d);if(n){let e=s[n.getId()];if(e&&h){let t=e.getColorFromRecord(h),i=o||Utils.getForegroundColor(t);d=HU.div([STYLE,HU.css("height","100%","background",t,"color",i+" !important")],d)}if("url"==n.getType())return{v:t,f:HU.href(t,t)};if("image"==n.getType())return{v:t,f:HU.href(t,HU.image(t,[WIDTH,this.getProperty("imageWidth",100)]))}}return{v:t,f:d}}},doMakeGoogleChart:function(t,e,i,a,s){if(!this.getProperty("expandedHeight")){if(s.height=null,this.chartHeight&&(s.height=this.chartHeight),null==s.height){let t=this.getProperty("height",null);t&&(s.height=t)}null==s.height&&(s.height="300px")}return this.debugChartOptions&&console.log(JSON.stringify(s,null,2)),s.allowHtml=!0,this.getProperty("tableWidth")&&(s.width=this.getProperty("tableWidth")),s.frozenColumns=this.getProperty("frozenColumns",0),s.showRowNumber=this.getProperty("showRowNumber",!1),t.length&&this.getDataValues(t[0]).length>4?s.cssClassNames={headerCell:"display-table-header-max"}:s.cssClassNames={headerCell:"display-table-header"},s.cssClassNames||(s.cssClassNames={}),this.getProperty("fixCellHeight",!0)&&(s.cssClassNames.headerCell="display-table-cell",s.cssClassNames.tableCell="display-table-cell"),new google.visualization.Table(i)},doAddTooltip:function(){return!1},getAddStyle:function(){return!1},getFormatNumbers:function(){return!0},xxxxmakeDataTable:function(t,e,i){let a=this.makeDataArray(t),s=[];for(let t=0;t<a.length;t++){let e=a[t];for(let t=0;t<e.length;t++){let i=typeof e[t];"string"==i?(e[t]=e[t].replace(/\n/g,"<br>"),(e[t].startsWith("http:")||e[t].startsWith("https:"))&&(e[t]="<a href='"+e[t]+"'>"+e[t]+"</a>")):"number"==i&&isNaN(e[t])&&(e[t]="--")}s.push(e)}return google.visualization.arrayToDataTable(s)}})}function BubbleDisplay(t,e,i){const a=new RamaddaTextChart(t,e,DISPLAY_BUBBLE,i);defineDisplay(addRamaddaDisplay(this),a,[{label:"Bubble Chart Attibutes"},{p:"xField"},{p:"yField"},{p:"labelField"},{p:"colorBy"},{p:"sizeField"},{p:"legendPosition",ex:"none|top|right|left|bottom"},{p:"hAxisFormat",ex:"none|decimal|scientific|percent|short|long"},{p:"vAxisFormat",ex:"none|decimal|scientific|percent|short|long"},{p:"hAxisTitle",ex:""},{p:"vAxisTitle",ex:""}],{getChartDiv:function(t){let e=[ATTR_ID,t];e.push(STYLE);let i="",a=this.getProperty("chartWidth")||this.getChartWidth(),s=this.getProperty("chartHeight")||this.getChartHeight();return i+=a?a>0?"width:"+a+"px;":a<0?"width:"+-a+"%;":"width:"+a+";":"width:100%;",i+=s?s>0?"height:"+s+"px;":s<0?"height:"+-s+"%;":"height:"+s+";":"height:100%;",i+="padding:5px;",e.push(i),HU.div(e,"")},getFieldsToDisplay:function(t){if(t.length>=4)return t;let e=this.getFieldById(null,this.getProperty("labelField")),i=this.getFieldById(null,this.getColorBy(this.getProperty("colorField"))),a=this.getFieldById(null,this.getProperty("sizeField")),s=this.getFieldById(null,this.getProperty("xField")),l=this.getFieldById(null,this.getProperty("yField"));if(!e)throw new Error("Need to specify labelField");if(!s)throw new Error("Need to specify xField");if(!l)throw new Error("Need to specify yField");let r=[e,s,l];return i&&r.push(i),a&&r.push(a),r},makeDataTable:function(t,e,i,a){let s=displayDebug.makeDataTable;if(s){console.log(this.type+" makeDataTable #records:"+t.length);let e=this.getSelectedFields();console.log("\t fields:"+e)}let l=[],r=this.makeDataArray(t);for(;r[0].length<5;)r[0].push("");l.push(r[0]),this.didUnhighlight=!1;let o=Number.MAX_SAFE_INTEGER;for(let t=1;t<r.length;t++){let e=r[t];for(;e.length<5;)e.push(1);o=Math.min(o,e[3])}for(let e=1;e<r.length;e++){let i=r[e];for(;i.length<5;)i.push(1);s&&e<5&&console.log("\tdata:"+i);let a=!0;for(j=1;j<i.length&&a;j++)isNaN(i[j])&&(a=!1);if(this.getFilterHighlight()){this.getProperty("unhighlightColor","#eee");t[e].record&&!t[e].record.isHighlight(this)&&(this.didUnhighlight=!0,i[3]=o-.111)}a&&l.push(i)}return google.visualization.arrayToDataTable(l)},doMakeGoogleChart:function(t,e,i,a,s){let l=this.getColorTable(!0);l?s.colors=l:this.colors||(s.colors=this.getColorList()),s.colors&&(s.colors=Utils.getColorTable("rainbow",!0)),$.extend(s.chartArea,{left:this.getProperty("chartLeft",this.chartDimensions.left),right:this.getProperty("chartRight",this.chartDimensions.right),top:this.getProperty("chartTop","10"),bottom:this.getProperty("chartBottom",40),height:this.getProperty("chartHeight","200")}),s.height="100px",s.sizeAxis={},s.colorAxis={legend:{position:this.getProperty("legendPosition","in")}};let r=this.getColorTable(!0);r&&(s.colorAxis.colors=r,this.didUnhighlight&&(s.colorAxis.colors=[...s.colorAxis.colors],s.colorAxis.colors.unshift(this.getProperty("unhighlightColor","#eee")))),s.bubble={textStyle:{auraColor:"none"},stroke:"#666"},header=this.getDataValues(t[0]),s.hAxis=s.hAxis||{},s.vAxis=s.vAxis||{},s.hAxis.minValue=this.getProperty("hAxisMinValue"),s.hAxis.maxValue=this.getProperty("hAxisMaxValue"),s.vAxis.minValue=this.getProperty("vAxisMinValue"),s.vAxis.maxValue=this.getProperty("vAxisMaxValue");let o=this.getPointData().getRecords();if(this.getProperty("hAxisFixedRange")){let t=this.getColumnValues(o,a[1]);s.hAxis.minValue=t.min,s.hAxis.maxValue=t.max}if(this.getProperty("vAxisFixedRange")){let t=this.getColumnValues(o,a[2]);s.vAxis.minValue=t.min,s.vAxis.maxValue=t.max}return s.vAxis.viewWindowMode=this.getProperty("viewWindowMode","pretty"),s.hAxis.viewWindowMode=this.getProperty("viewWindowMode","pretty"),s.hAxis.format=this.getProperty("hAxisFormat",null),s.vAxis.format=this.getProperty("vAxisFormat",null),s.hAxis.title=this.getProperty("hAxisTitle",header.length>1?header[1]:null),s.vAxis.title=this.getProperty("vAxisTitle",header.length>2?header[2]:null),new google.visualization.BubbleChart(i)}})}function BartableDisplay(t,e,a){const s=new RamaddaSeriesChart(t,e,DISPLAY_BARTABLE,a);defineDisplay(addRamaddaDisplay(this),s,[],{getRequiredPackages:function(){return["bar"]},doMakeGoogleChart:function(t,e,i,a,s){let l="";if(Utils.isDefined(this.chartHeight))l=this.chartHeight;else if(t.length>1){let e=t.length;l=this.isStacked?22*e:22*e+14*e*(this.getDataValues(t[0]).length-2)}return $.extend(s,{title:"the title",bars:"horizontal",colors:this.getColorList(),width:Utils.isDefined(this.chartWidth)?this.chartWidth:"100%",chartArea:{left:"30%",top:0,width:"70%",height:"80%"},height:l,bars:"horizontal",tooltip:{showColorCode:!0},legend:{position:"none"}}),Utils.isDefined(this.isStacked)&&(s.isStacked=this.isStacked),this.hAxis&&(s.hAxis={title:this.hAxis}),this.vAxis&&(s.vAxis={title:this.vAxis}),new google.charts.Bar(i)},getDefaultSelectedFields:function(t,e){let a=[];for(i=0;i<t.length;i++){let e=t[i];if(!e.isNumeric()){a.push(e);break}}for(i=0;i<t.length;i++){let e=t[i];if(e.isNumeric()){a.push(e);break}}return a}})}function TreemapDisplay(t,e,i){const a=new RamaddaTextChart(t,e,DISPLAY_TREEMAP,i);defineDisplay(addRamaddaDisplay(this),a,[],{handleEventRecordSelection:function(t,e){},getRequiredPackages:function(){return["treemap"]},getFieldsToSelect:function(t){return t.getRecordFields()},tooltips:{},makeChartOptions:function(t,e,i){let s=this,l=a.makeChartOptions.call(this,t,e,i);return $.extend(l,{highlightOnMouseOver:!0,generateTooltip:function(t,e,i){return s.tooltips[t]?s.tooltips[t]:"<div class='display-treemap-tooltip-outer'><div class='display-treemap-tooltip''><i>left-click: go down<br>right-click: go up</i></div></div>"},maxDepth:parseInt(this.getProperty("maxDepth",2)),maxPostDepth:parseInt(this.getProperty("maxPostDepth",3))}),l},defaultSelectedToAll:function(){return!0},doMakeGoogleChart:function(t,e,i,a,s){return this.makeDataTable(t,e,a,s)?new google.visualization.TreeMap(i):null},addTuple:function(t,e,i,a,s,l,r){let o=a,n=0;for(Utils.isDefined(i[a])&&s&&(a=s+":"+a);;){if(!Utils.isDefined(i[a])){i[a]=!0;break}a=o+" "+ ++n}let h=[a,s,l];return e&&h.push(r),t.push(h),a},valueClicked:function(t,e){t=this.getFieldById(this.getFields(),t),this.propagateEvent("fieldValueSelected",{field:t,value:e})},makeDataTable:function(t,e,i){let a=this.filterData(null,null,{skipFirst:!0});if(!a)return null;let s=this.getFields(),l=this.getSelectedFields(s);0==l.length&&(l=s);let r=this.getFieldsByType(l,"string");if(r.length<2)return this.displayError("No string fields specified"),null;let o=this.getProperty("addPrefix",!0),n=this.getFieldById(s,this.getProperty("sizeBy")),h=this.getFieldById(s,this.getProperty("colorBy")),d=this.getFieldsByType(l,"numeric");!n&&d.length>0&&(n=d[0]),!h&&d.length>1&&(h=d[1]);let p=[],g=this.getProperty("tooltipFields","").split(",");for(let t=0;t<g.length;t++){let e=this.getFieldById(null,g[t]);e&&p.push(e)}0==p.length&&(p=s),this.tooltips={};let c=[];for(let t=0;t<r.length;t++){let e=r[t];c.push(this.getColumnValues(a,e).values)}let u=[],y=[],m=[],f={};this.addTuple(u,h,{},"Node","Parent","Value","Color");let D=r[0].getLabel();this.addTuple(u,h,f,D,null,0,0);let I={},T=this.getGet();for(let t=0;t<a.length;t++){let e=this.getDataValues(a[t]),i="",s="";for(let e=0;e<r.length-1;e++){let a=c[e];if(""!=i&&(i+=":"),i+=a[t],!Utils.isDefined(I[i])){let l=Utils.isDefined(I[s])?I[s]:D,r=a[t];o&&e>0&&(r=l+":"+r),I[i]=this.addTuple(u,h,f,r,l,0,0)}s=i}let l=Utils.isDefined(I[s])?I[s]:D,d=e[r[r.length-1].getIndex()],g=n?e[n.getIndex()]:1,b=h?e[h.getIndex()]:0;d=this.addTuple(y,h,f,d,l,g,b);let S="<div class='display-treemap-tooltip-outer'><div class='display-treemap-tooltip''>";for(let t=0;t<p.length;t++){let i=e[p[t].getIndex()],a=p[t];i=HU.onClick(T+".valueClicked('"+a.getId()+"','"+i+"')",i,[]),S+=HU.b(a.getLabel())+": "+i+"<br>"}S+="</div></div>",m.push(S)}for(let t=0;t<y.length;t++)u.push(y[t]),this.tooltips[u.length-2]=m[t];return google.visualization.arrayToDataTable(u)}})}function TimerangechartDisplay(t,e,i){const a=new RamaddaTextChart(t,e,DISPLAY_TIMERANGECHART,i);defineDisplay(addRamaddaDisplay(this),a,[{label:"Time Range"},{p:"startDateField",ex:""},{p:"endDateField",ex:""},{p:"labelFields",ex:""},{p:"showLabel",ex:"false"},{p:"fontSize",d:10},{p:"font",d:"Helvetica"},{p:"alternatingRowStyle",d:"true",ex:"false"}],{getRequiredPackages:function(){return["timeline"]},doMakeGoogleChart:function(t,e,i,a,s){return this.dataColors&&this.dataColors.length&&(s.colors=this.dataColors),s.alternatingRowStyle=this.getAlternatingRowStyle(),s.timeline={rowLabelStyle:{fontName:this.getFont(),fontSize:this.getFontSize()},barLabelStyle:{fontName:this.getFont(),fontSize:this.getFontSize()}},s.tooltip=null,new google.visualization.Timeline(i)},makeDataTable:function(t,e,i){let a=this.getProperty("tooltip"),s=(a||this.getProperty("addTooltip",!1))&&this.doAddTooltip(),l=this.filterData(null,null,{skipFirst:!0}),r=this.getFieldByType(i,"string");r||(r=this.getFieldByType(null,"string"));let o=this.getProperty("showLabel",!0),n=[],h=this.getProperty("labelFieldsTemplate"),d=this.getProperty("labelFields","").split(",");for(let t=0;t<d.length;t++){let e=this.getFieldById(null,d[t]);e&&n.push(e)}let p=this.getFieldById(null,this.getPropertyStartDateField()),g=this.getFieldById(null,this.getPropertyEndDateField()),c=[];c=null==p||null==g?this.getFieldsByType(null,"date"):[p,g];let u=[],y=new google.visualization.DataTable;if(c.length<2)throw new Error("Need to have at least 2 date fields");r?y.addColumn({type:"string",id:r.getLabel()}):y.addColumn({type:"string",id:"Index"}),n=[],n.length>0?y.addColumn({type:"string",id:"Label"}):s&&y.addColumn({type:"string",id:"dummy"}),s&&y.addColumn({type:"string",role:"tooltip",p:{html:!0}}),y.addColumn({type:"date",id:c[0].getLabel()}),y.addColumn({type:"date",id:c[1].getLabel()});let m=this.getColorByInfo(l);m.isEnabled()&&(this.dataColors=[]);for(let t=0;t<l.length;t++){let e=l[t],i=this.getDataValues(l[t]),d=[];if(this.dataColors&&this.dataColors.push(m.getColorFromRecord(e,"blue")),u.push(d),r&&o?d.push(i[r.getIndex()]):d.push("#"+(t+1)),n.length>0){let t="";h&&(t=h);for(let e=0;e<n.length;e++){let a=n[e],s=i[a.getIndex()];h?t=t.replace("{"+a.getId()+"}",s):t+=s+" "}d.push(t)}else s&&d.push(null);if(s){let t=this.getRecordHtml(e,null,a);d.push(t)}d.push(i[c[0].getIndex()]),d.push(i[c[1].getIndex()])}return y.addRows(u),m.isEnabled()&&m.displayColorTable(null,!0),y}})}function CalendarDisplay(t,e,i){const a=new RamaddaGoogleChart(t,e,DISPLAY_CALENDAR,i);defineDisplay(addRamaddaDisplay(this),a,[{label:"Calendar"},{p:"cellSize",d:15,ex:"15"},{p:"missingValue",ex:""},{p:"strokeColor",d:"#76a7fa",ex:"#76a7fa"},{p:"strokeWidth",ex:"1"},{p:"strokeOpacity",d:.5,ex:"0.5"},{p:"noDataBackground",ex:"green"},{p:"noDataColor",ex:"red"},{p:"colorAxis",ex:"red,blue"}],{getRequiredPackages:function(){return["calendar"]},doMakeGoogleChart:function(t,e,i,a,s){let l={calendar:{cellSize:parseInt(this.getPropertyCellSize()),cellColor:{stroke:this.getPropertyStrokeColor(),strokeOpacity:this.getPropertyStrokeOpacity(),strokeWidth:this.getPropertyStrokeWidth(1)}},height:this.getProperty("height",800),noDataPattern:{backgroundColor:this.getPropertyNoDataBackground(),color:this.getPropertyNoDataColor()}},r=this.getPropertyColorAxis();if(r&&(l.colorAxis={colors:r.split(",")}),$.extend(s,l),0!=this.jq(ID_CHART).width())return new google.visualization.Calendar(i)},defaultSelectedToAll:function(){return!0},getContentsStyle:function(){let t=this.getProperty("height",800);return t>0?" height:"+t+"px;  max-height:"+t+"px; overflow-y: auto;":""},canDoMultiFields:function(){return!1},getIncludeIndexIfDate:function(){return!0},makeDataTable:function(t,e,i){let a=new google.visualization.DataTable,s=this.getDataValues(t[0]);if(s.length<2)return null;a.addColumn({type:"date",id:"Date"}),a.addColumn({type:"number",id:s[1]}),a.addColumn({type:"string",role:"tooltip",p:{html:!0}});let l=!1,r=this.getPropertyMissingValue();r&&(l=!0,r=parseFloat(r));let o=[];this.dateToRecords={};for(let e=1;e<t.length;e++){let i=this.getBinnedRecords(t[e].record),a=t[e];!i&&a.record&&(i=[a.record]);let n=this.getDataValues(a)[1];if(NaN==n)continue;if(l&&n==r)continue;0;let h=this.getDataValues(t[e])[0];this.dateToRecords[h.v.getTime()]=i;let d="<center><b>"+h.f+"</b></center><b>"+s[1].replace(/ /g,"&nbsp;")+"</b>:&nbsp;"+this.formatNumber(n);d=HU.div([STYLE,HU.css("padding","5px")],d),o.push([this.getDataValues(t[e])[0],n,d])}return a.addRows(o),a}})}function GaugeDisplay(t,e,i){const a=new RamaddaGoogleChart(t,e,DISPLAY_GAUGE,i);defineDisplay(addRamaddaDisplay(this),a,[],{getRequiredPackages:function(){return["gauge"]},getChartHeight:function(){return this.getProperty("height",this.getChartWidth())},getChartWidth:function(){return this.getProperty("width","150")},doMakeGoogleChart:function(t,e,i,a,s){this.dataList=t,this.chartOptions=s;let l=Number.MAX_VALUE,r=Number.MIN_VALUE,o=!0;for(let e=1;e<t.length;e++){let i=this.getDataValues(t[e]);for(let t=0;t<i.length;t++){if(!Utils.isNumber(i[t]))continue;let e=i[t];l=Math.min(l,e),r=Math.max(r,e)}}return l=Utils.formatNumber(l,!0),r=Utils.formatNumber(r,!0),Utils.isDefined(this.gaugeMin)&&(o=!0,l=parseFloat(this.gaugeMin)),Utils.isDefined(this.gaugeMax)&&(o=!0,r=parseFloat(this.gaugeMax)),o&&(s.min=l,s.max=r),new google.visualization.Gauge(i)},makeDataTable:function(t,e,i){t=this.makeDataArray(t),Utils.isDefined(this.index)||(this.index=t.length-1);let a=this.index+1,s=[];s.push(["Label","Value"]);let l=this.getDataValues(t[0]);a>=t.length&&(a=t.length-1);let r=this.getDataValues(t[a]);for(let t=0;t<r.length;t++){if(!Utils.isNumber(r[t]))continue;let e=l[t];if(e.length>20){let t=e.indexOf("(");t>0&&(e=e.substring(0,t))}e.length>20&&(e=e.substring(0,19)+"..."),this.getProperty("gaugeLabel")?e=this.getProperty("gaugeLabel"):this["gaugeLabel"+(t+1)]&&(e=this["gaugeLabel"+(t+1)]);let i=r[t];s.push([e,Utils.formatNumber(i,!0)])}return google.visualization.arrayToDataTable(s)},setChartSelection:function(t){this.index=t;let e=this.makeDataTable(this.dataList);this.mapCharts((t=>{t.draw(e,this.chartOptions)}))}})}function ScatterplotDisplay(t,e,a){const s=new RamaddaGoogleChart(t,e,DISPLAY_SCATTERPLOT,a);defineDisplay(addRamaddaDisplay(this),s,[],{trendLineEnabled:function(){return!0},setAxisRanges:function(t,e,i){if(this.getProperty("hAxisFixedRange")){let a=this.getColumnValues(i,e[0]);t.hAxis&&(t.hAxis={}),t.hAxis.minValue=a.min,t.hAxis.maxValue=a.max}if(this.getProperty("vAxisFixedRange")){t.vAxis&&(t.vAxis={});let a=this.getColumnValues(i,e[1]);t.vAxis.minValue=a.min,t.vAxis.maxValue=a.max}},makeChartOptions:function(t,e,i){let a=s.makeChartOptions.call(this,t,e,i);return a.curveType=null,a.lineWidth=0,$.extend(a,{title:"",tooltip:{isHtml:!0},legend:"none"}),a.chartArea||(a.chartArea={}),$.extend(a.chartArea,{left:"10%",top:10,height:"80%",width:"90%"}),this.getShowTitle()&&(a.title=this.getTitle(!0)),a.hAxis||(a.hAxis={}),a.vAxis||(a.vAxis={}),this.getProperty("hAxisLogScale",!1)&&(a.hAxis.logScale=!0),this.getProperty("vAxisLogScale",!1)&&(a.vAxis.logScale=!0),a.vAxis.viewWindowMode=this.getProperty("viewWindowMode","pretty"),a.hAxis.viewWindowMode=this.getProperty("viewWindowMode","pretty"),t.length>0&&this.getDataValues(t[0]).length>1&&(a.vAxis||(a.vAxis={}),a.hAxis||(a.hAxis={}),this.getProperty("hAxisTitle")&&(a.hAxis.title=this.getProperty("hAxisTitle")),this.getProperty("vAxisTitle")&&(a.vAxis.title=this.getProperty("vAxisTitle")),a.hAxis.title||$.extend(a.hAxis,{title:this.getDataValues(t[0])[0]}),a.vAxis.title||$.extend(a.vAxis,{title:this.getDataValues(t[0])[1]}),isNaN(this.getVAxisMinValue())||(a.vAxis.minValue=this.getVAxisMinValue()),isNaN(this.getVAxisMaxValue())||(a.vAxis.maxValue=this.getVAxisMaxValue())),a},doMakeGoogleChart:function(t,e,i,a,s){if(!i)return;let l=this.getProperty("height",400);Utils.isDefined(this.getProperty("chartHeight"))&&(l=this.getProperty("chartHeight"));let r="100%";return Utils.isDefined(this.getProperty("chartWidth"))&&(r=this.getProperty("chartWidth")),"number"==typeof l&&(l+="px"),"number"==typeof r&&(r+="px"),$("#"+i.id).css("width",r),$("#"+i.id).css("height",l),new google.visualization.ScatterChart(i)},getDefaultSelectedFields:function(t,e){let a=[];for(i=0;i<t.length;i++){let e=t[i];if(e.isNumeric()&&(a.push(e),a.length>=2))break}return a}})}function OrgchartDisplay(t,e,i){const a="orgchart",s=new RamaddaGoogleChart(t,e,DISPLAY_ORGCHART,i);defineDisplay(addRamaddaDisplay(this),s,[{label:"Orgchart"},{p:"labelField",ex:""},{p:"parentField",ex:""},{p:"idField",ex:""},{p:"treeRoot",ex:"some label"},{p:"treeTemplate",ex:""},{p:"treeNodeSize",ex:"small|medium|large"}],{handleEventRecordSelection:function(t,e){},needsData:function(){return!0},getRequiredPackages:function(){return["orgchart"]},updateUIInner:function(){if(this.displayHtml(HU.div([ID,this.domId(a)],"")),0==this.jq(a).length)return void setTimeout((()=>this.updateUI()),1e3);let t=null;try{t=this.makeTree()}catch(t){return void this.handleError("An error has occurred:"+t,t)}if(null==t)return;let e=new google.visualization.DataTable;e.addColumn("string","Name"),e.addColumn("string","Parent"),e.addColumn("string","ToolTip");let i=[],s=function(t){0;let e=t.label;t.display&&(e={v:t.label,f:t.display});let a=[e,t.parent?t.parent.label:"",t.tooltip||""];i.push(a),t.children.length>0&&t.children.map(s),t.record};t.map(s),e.addRows(i),new google.visualization.OrgChart(document.getElementById(this.domId(a))).draw(e,{allowHtml:!0,allowCollapse:!0,size:this.getProperty("treeNodeSize","medium")})}})}const DISPLAY_SLIDES="slides",DISPLAY_IMAGES="images",DISPLAY_IMAGEZOOM="imagezoom",DISPLAY_CARDS="cards";function RamaddaCardsDisplay(t,e,i){const a="results",s=new RamaddaFieldsDisplay(t,e,DISPLAY_CARDS,i);Utils.importJS(ramaddaCdn+"/lib/color-thief.umd.js",(()=>{}),((t,e,i)=>{console.log("err")}));defineDisplay(addRamaddaDisplay(this),s,[{label:"Cards Attributes"},{p:"groupByFields",ex:""},{p:"initGroupFields",ex:""},{p:"tooltipFields",ex:""},{p:"captionFields"},{p:"captionTemplate",ex:"${name}"},{p:"sortFields",ex:""},{p:"labelField",ex:""},{p:"imageWidth",ex:"100"},{p:"imageMargin",ex:"5"}],{getContentsStyle:function(){return""},updateUI:function(){this.colorAnalysisEnabled=this.getProperty("doColorAnalysis");var t=this.getData();if(null==t)return;var e=t.getRecordFields(),i=this.getSelectedFields(e);null!=i&&0!=i.length||(i=e);var s=this.filterData();if(!s)return;let l=i;if(this.initGrouping=this.getFieldsByIds(i,this.getProperty("initGroupFields","",!0)),this.groupByFields=this.getFieldsByIds(i,this.getProperty("groupByFields","",!0)),this.groupByMenus=+this.getProperty("groupByMenus",this.groupByFields.length),this.imageField=this.getFieldByType(i,"image"),this.urlField=this.getFieldByType(i,"url"),this.tooltipFields=this.getFieldsByIds(i,this.getProperty("tooltipFields","",!0)),this.labelFields=this.getFieldsByIds(i,this.getProperty("labelFields",null,!0)),0==this.labelFields.length){var r=this.getFieldById(i,this.getProperty("labelField",null,!0));r&&this.labelFields.push(r)}if(this.onlyShowImages=this.getProperty("onlyShowImages",!1),this.altLabelField=this.getFieldById(i,this.getProperty("altLabelField",null,!0)),this.captionFields=this.getFieldsByIds(i,this.getProperty("captionFields","",!0)),this.captionTemplate=this.getProperty("captionTemplate",null,!0),0==this.captionFields.length&&(this.captionFields=this.tooltipFields),this.colorByField=this.getFieldById(i,this.getProperty("colorBy",null,!0)),this.colorList=this.getColorTable(!0),this.foregroundList=this.getColorTable(!0,"foreground"),this.getProperty("showImages",!0)||(this.imageField=null),!this.imageField&&0==this.captionFields.length)return void this.displayError("No image or caption fields specified");var o="";if(!this.groupByHtml&&(this.groupByHtml="",this.colorAnalysisEnabled&&(this.groupByHtml+=HU.span([CLASS,"ramadda-button",ID,this.domId("docolors")],"Do colors")+" "+HU.span([CLASS,"ramadda-button",ID,this.domId("docolorsreset")],"Reset")),this.groupByFields.length>0)){var n=[["","--"]];this.groupByFields.map((t=>{n.push([t.getId(),t.getLabel()])})),this.groupByHtml+=HU.span([CLASS,"display-fitlerby-label"]," Group by: ");for(var h=0;h<this.groupByMenus;h++){var d="";h<this.initGrouping.length&&(d=this.initGrouping[h].getId()),this.groupByHtml+=HU.select("",[ID,this.domId(ID_GROUPBY_FIELDS+h)],n,d)+"&nbsp;"}this.groupByHtml+="&nbsp;",this.jq(ID_HEADER1).html(HU.div([CLASS,"display-filterby"],this.groupByHtml)),this.jq("docolors").button().click((()=>{this.analyzeColors()})),this.jq("docolorsreset").button().click((()=>{this.updateUI()}))}o+=HU.div([ID,this.domId(a)]),this.setContents(o);let p=this;this.jq(ID_HEADER1).find("input, input:radio,select").change((function(){p.updateUI()})),this.displaySearchResults(s,l)},analyzeColors:function(){if(!window.ColorThief)return void setTimeout((()=>this.analyzeColors()),1e3);const t=new ColorThief;for(var e=0;;){var i=document.querySelector("#"+this.domId("gallery")+"img"+e),a=$("#"+this.domId("gallery")+"div"+e);if(e++,!i)return;i.crossOrigin="Anonymous";for(var s=t.getColor(i),l=t.getPalette(i),r=i.width/l.length,o="",n=0;n<l.length;n++){s=l[n];o+=HU.div([STYLE,HU.css("display","inline-block","width",r+"px','height', img.height +'px','background','rgb("+s[0]+","+s[1]+","+s[2]+")")],"")}a.css("width",i.width),a.css("height",i.height),a.html(o),i.style.display="none"}},displaySearchResults:function(t,e){t=this.sortRecords(t);for(var i=this.getProperty("fontSize",null),s=this.getProperty("cardStyle",null),l=this.getProperty("imageWidth","50"),r=this.getProperty("imageMargin","0"),o=[],n=[],h=0;h<this.groupByMenus;h++){var d=this.jq(ID_GROUPBY_FIELDS+h).val();if(!n[d]){n[d]=!0;var p=this.getFieldById(e,d);if(p&&(o.push(p),p.isNumeric()&&!p.range)){var g=Number.MAX_VALUE,c=Number.MIN_VALUE;t.map((t=>{var e=p.getValue(t);isNaN(e)||(e<g&&(g=e),e>c&&(c=e))})),p.range=[g,c];var u=this.getProperty(p.getId()+".bins");if(p.bins=[],u){var y=u.split(",");for(h=0;h<y.length-1;h++)p.bins.push([+y[h],+y[h+1]])}else{var m=+this.getProperty(p.getId()+".binCount",10);p.binSize=(c-g)/m;for(var f=0;f<m;f++)p.bins.push([g+p.binSize*f,g+p.binSize*(f+1)])}}}}function D(t,e){$.extend(this,{id:t,field:e,members:[],isGroup:!0,getCount:function(){if(0==this.members.length)return 0;if(this.members[0].isGroup){var t=0;return this.members.map((e=>t+=e.getCount())),t}return this.members.length},findGroup:function(t){for(var e=0;e<this.members.length;e++)if(this.members[e].isGroup&&this.members[e].id==t)return this.members[e];return null}})}for(var I=new D(""),T={},b=0,S=0,v=0;v<t.length;v++){let e=t[v];var x=this.getDataValues(t[v]),U="";this.tooltipFields.map((t=>{""!=U&&(U+="&#10;"),U+=t.getValue(e)})),U=U.replace(/\"/g,"&quot;");var L="",E="";if(this.captionFields.length>0&&(this.captionTemplate&&(E=this.captionTemplate),this.captionFields.map((t=>{var i=(""+t.getValue(e)).replace(/\"/g,"&quot;");this.captionTemplate?E=E.replace("${"+t.getId()+"}",i):E+=i+"<br>"})),this.urlField)){var P=this.urlField.getValue(e);P&&""!=P&&(E="<a style='color:inherit;'  href='"+P+"' target=_other>"+E+"</a>")}this.labelFields.map((t=>{L+=x[t.getIndex()]+" "})),L=L.trim();var C="",A=null;if(!this.imageField||(A=x[this.imageField.getIndex()],!this.onlyShowImages||Utils.stringDefined(A))){var w=[CLASS,"display-cards-popup","data-fancybox",this.domId("gallery"),"data-caption",E];if(A&&(A=A.trim()),Utils.stringDefined(A))this.colorAnalysisEnabled&&(A=ramaddaBaseUrl+"/proxy?url="+A),A=HU.href(A,HU.div([ID,this.domId("gallery")+"div"+S],HU.image(A,["width",l,ID,this.domId("gallery")+"img"+S])),w)+L,S++,C=HU.div([CLASS,"display-cards-item",TITLE,U,STYLE,HU.css("margin",r+"px")],A);else{var H="";if(i&&(H+=" font-size:"+i+"; "),this.colorByField&&this.colorList){var R=this.colorByField.getValue(e);Utils.isDefined(T[R])||(T[R]=b++);var k=T[R];k>=this.colorList.length&&(k=this.colorList.length%k),H+="background:"+this.colorList[k]+";",this.foregroundList&&(k<this.foregroundList.length?H+="color:"+this.foregroundList[k]+" !important;":H+="color:"+this.foregroundList[this.foregroundList-1]+" !important;")}s&&(H+=s);var _=[TITLE,U,CLASS,"ramadda-gridbox display-cards-card",STYLE,H];C=this.altLabelField?HU.div(_,this.altLabelField.getValue(e)):HU.div(_,E),C=HU.href("",C,w)}for(var F=I,M=0;M<o.length;M++){var N=o[M];R=x[N.getIndex()];if(N.isNumeric())for(var B=0;B<N.bins.length;B++){if(R<=(f=N.bins[B])[1]||B==N.bins.length-1){R=Utils.formatNumber(f[0])+" - "+Utils.formatNumber(f[1]);break}}var O=F.findGroup(R);O||F.members.push(O=new D(R,N)),F=O}F.members.push(C)}}let Y=I.getCount(),G=HU.div([CLASS,"display-cards-header"],"Total ("+Y+")");G+=this.makeGroupHtml(I,I),this.writeHtml(a,G),HU.createFancyBox(this.jq(a).find("a.display-cards-popup"),{caption:function(t,e){return $(this).data("caption")||""}})},makeGroupHtml:function(t,e){if(0==t.members.length)return"";var i="";if(t.members[0].isGroup){t.members.sort(((t,e)=>t.id<e.id?-1:t.id>e.id?1:0));var a=0==t.members.length?"100%":100/t.members.length;i+=HU.open(TABLE,[WIDTH,"100%","border",0])+HU.open(TR,["valign","top"]);for(var s=0;s<t.members.length;s++){var l=t.members[s],r="";l.field&&(r=l.field.getLabel()+": "),i+=HU.open(TD,[WIDTH,a+"%"]);let o=Math.round(100*l.getCount()/e.getCount());i+=HU.div([CLASS,"display-cards-header"],r+l.id+" (#"+l.getCount()+" - "+o+"%)"),i+=this.makeGroupHtml(l,e),i+=HU.close(TD)}i+=HU.close(TR,TABLE)}else i+=Utils.join(t.members,"");return i}})}function RamaddaImagesDisplay(t,e,i){const a="next",s="prev",l="images";const r=new RamaddaFieldsDisplay(t,e,DISPLAY_IMAGES,i);defineDisplay(addRamaddaDisplay(this),r,[{label:"Image Gallery Properties"},{p:"imageField",ex:""},{p:"labelFields",ex:""},{p:"topLabelTemplate",ex:""},{p:"bottomLabelTemplate",ex:""},{p:"tooltipFields",ex:""},{p:"numberOfImages",ex:"100"},{p:"includeBlanks",ex:"true"},{p:"blockWidth",ex:"150"},{p:"imageWidth",ex:"150"},{p:"imageHeight",ex:"150"},{p:"imageMargin",ex:"10px"},{p:"decorate",ex:"false"},{p:"doPopup",ex:"false"},{p:"imageStyle",ex:""},{p:"minHeightGallery",ex:150},{p:"maxHeightGallery",ex:150},{p:"columns",ex:"5"},{p:"noun",ex:"images"}],{startIndex:0,dataFilterChanged:function(){this.startIndex=0,this.updateUI()},handleEventRecordSelection:function(t,e){let i=this.find(".display-images-block"),a=HU.attrSelect(RECORD_ID,e.record.getId()),s=this.find(a);i.css("border",null),s.css("border","1px solid "+this.getHighlightColor()),HU.scrollVisible(this.jq(l),s)},updateUI:function(){let t=this.filterData();if(!t)return;let e=this.getPropertyIncludeBlanks(!1),i=this.getFieldById(null,this.getProperty("imageField"));i||(i=this.getFieldByType(null,"image"));let r=this.getFieldById(null,this.getProperty("urlField")),o=this.getProperty("tooltipClick"),n=this.getData().getRecordFields(),h=this.getFieldsByIds(null,this.getProperty("labelFields",null,!0)),d=this.getPropertyTopLabelTemplate(),p=this.getPropertyBottomLabelTemplate(),g=this.getFieldsByIds(null,this.getProperty("tooltipFields",null,!0));if(!i)return void this.setDisplayMessage("No image field in data");let c=this.getPropertyDecorate(!0),u=+this.getPropertyColumns(0),y=+this.getPropertyNumberOfImages(50),m=this.getColorByInfo(t),f=this.getPropertyImageWidth(),D=this.getBlockWidth("200px"),I=this.getPropertyImageHeight();f||I||(f="100%");let T=this.getPropertyImageStyle(""),b="",S="gallery"+HtmlUtils.getUniqueId(),v=[],x=this.getPropertyDoPopup(!0),U=0,L=-1,E={},P="display-images-image-outer display-images-block ",C="display-images-image-inner";this.idToRecord={};let A="";c||(C="",P="display-images-block",A=HU.css("margin",this.getPropertyImageMargin("10px"))),u&&f&&f.endsWith("%")&&(A+=HU.css(WIDTH,f)),A+=this.getProperty("blockStyle",""),this.startIndex<0&&(this.startIndex=0),this.startIndex>t.length&&(this.startIndex=t.length-y);let w=1;for(let a=this.startIndex;a<t.length;a++){let s=t[a],l=this.getDataValues(s),c=s.getValue(i.getIndex());if(""==c&&!e)continue;if(w++>y)break;v.push(s),this.idToRecord[s.getId()]=s;let H=null;d&&(H=this.getRecordHtml(s,n,d));let R="",k="";Utils.stringDefined(p)&&(R=this.getRecordHtml(s,n,p)),h.forEach((t=>{let e=s.getValue(t.getIndex());e.getTime&&(e=this.formatDate(e)),k+=" "+e})),""==k?k=R:""==R&&(R=k);let _="";g.forEach((t=>{_+="\n"+t.getLabel()+": "+l[t.getIndex()]})),_=_.trim();let F=A,M=[STYLE,T,"alt",k,ID,S+"image"+a,"loading","lazy"];f?M.push(WIDTH,f):I&&M.push(HEIGHT,I);let N=""==c?SPACE1:HU.image(c,M),B=null!=H?HU.div([CLASS,"ramadda-clickable display-images-toplabel"],H):"",O=HU.div([CLASS,"ramadda-clickable display-images-label"],R.trim());if(r&&(""!=B&&(B=HU.href(r.getValue(s),B,["target","_target"])),O=HU.href(r.getValue(s),O,["target","_target"]),k=HU.href(r.getValue(s),k,["target","_target"]),k=k.replace(/"/g,"'")),this.getProperty("showBottomLabel",!0)||(O=""),m.isEnabled()){let t=m.getColorFromRecord(s);F+=HU.css(BACKGROUND,t)}F+=HU.css("vertical-align","top","width",D),x?N=HU.href(c,N,[CLASS,"popup_image","data-fancybox",S,"data-caption",k]):r&&!o&&(N=HU.href(r.getValue(s),N,["target","_target"]));let Y=HU.div([STYLE,F,RECORD_ID,s.getId(),RECORD_INDEX,U++,ID,S+"div"+a,CLASS,P,TITLE,_],HU.div([CLASS,C],B+N+O));u?(++L>=u&&(L=0),E[L]||(E[L]=""),E[L]+=Y):b+=Y}if(u){b="<table border=0 width=100%><tr valign=top>";for(let t=0;E[t];t++)b+=HU.td(["align","center"],E[t]);b+="</tr></table>"}let H="";if(this.startIndex>0&&(H+=HU.span([ID,this.domId(s)],"Previous")+" "),this.startIndex+y<t.length&&(H+=HU.span([ID,this.domId(a)],"Next")+" "),w--,y<t.length&&(H+="Showing "+(this.startIndex+1)+" - "+(this.startIndex+w),H+=" of "+t.length+" "+this.getNoun("images")),""!=H&&(H=HU.div([STYLE,HU.css("margin-right","10px","display","inline-block")],H),this.jq(ID_HEADER2_PREFIX).html(H),this.jq(ID_HEADER2).css("text-align","left")),H="",this.getPropertyMinHeightGallery()||this.getPropertyMaxHeightGallery()){let t="";this.getPropertyMinHeightGallery()&&(t+=HU.css("min-height",HU.getDimension(this.getPropertyMinHeightGallery()))),this.getPropertyMinHeightGallery()&&(t+=HU.css("max-height",HU.getDimension(this.getPropertyMaxHeightGallery()))),b=HU.div([ID,this.domId(l),STYLE,t+HU.css("overflow-y","auto")],b)}b=HU.div([CLASS,"ramadda-grid"],b),this.setContents(H+b);let R=this.find(".display-images-block"),k=this;if(R.mouseenter((function(){$(this).attr("oldborder",$(this).css("border")),$(this).css("border","1px solid "+k.getHighlightColor())})),R.mouseleave((function(){$(this).css("border",$(this).attr("oldborder"))})),this.makeTooltips(R,v),x)HU.createFancyBox(this.jq(ID_RESULTS).find("a.popup_image"),{caption:function(t,e){return $(this).data("data-caption")||""}});else{let t=this;o||R.click((function(){let e=t.idToRecord[$(this).attr(RECORD_ID)];e&&t.propagateEventRecordSelection({record:e})}))}this.jq(s).button().click((()=>{this.startIndex-=y,this.updateUI()})),this.jq(a).button().click((()=>{this.startIndex+=y,this.updateUI()})),this.getProperty("propagateEventRecordList",!1)&&this.getDisplayManager().notifyEvent(DisplayEvent.recordList,this,{recordList:v})}})}function RamaddaImagezoomDisplay(t,e,i){const a="thumbs",s="thumb",l="image",r="imageinner",o="imagepopup",n="imagepopupimage",h="imagerect",d=new RamaddaFieldsDisplay(t,e,DISPLAY_IMAGEZOOM,i);defineDisplay(addRamaddaDisplay(this),d,[{label:"Image Zoom Attributes"},{p:"labelFields"},{p:"thumbField"},{p:"thumbWidth",ex:"100"},{p:"imageWidth",ex:"150"},{p:"urlField"},{p:"popupWidth"},{p:"popupHeight"},{p:"popupImageWidth",d:2e3}],{dataFilterChanged:function(){this.updateUI()},updateUI:function(){let t=this.getData();if(null==t)return;let e=this.filterData();if(!e)return;let i=t.getRecordFields();if(this.urlField=this.getFieldById(i,this.getProperty("urlField","url")),this.imageField=this.getFieldById(i,"image"),this.imageField||(this.imageField=this.getFieldByType(i,"image")),!this.imageField)return void this.setDisplayMessage("No image field in data");this.labelFields=this.getFieldsByIds(i,this.getPropertyLabelFields());let r=this.getFieldById(i,this.getProperty("thumbField","thumb"))||this.imageField,n=parseFloat(this.getProperty("thumbWidth",100)),d=this.getHeightForStyle(),p=this.getProperty("imageWidth",500);this.popupWidth=+this.getProperty("popupWidth",p),this.popupHeight=+this.getProperty("popupHeight",300);let g=HU.div([STYLE,HU.css("border","1px solid "+this.getHighlightColor(),"width","20px","height","20px","left","10px","top","10px","display","none","position","absolute","z-index",1e3,"pointer-events","none"),ID,this.domId(h)]),c=HU.div(["style","position:relative"],g+HU.div([ID,this.domId(l),STYLE,HU.css("position","relative")])+HU.div([ID,this.domId(o),CLASS,"display-imagezoom-popup",STYLE,HU.css("z-index","100","display","none",WIDTH,this.popupWidth+"px",HEIGHT,this.popupHeight+"px","overflow-y","hidden","overflow-x","hidden","position","absolute","top","0px","left",p+"px")],"")),u=HU.table(["border",0,WIDTH,"100%"],HU.tr(["valign","top"],HU.td([WIDTH,"2%"],HU.div([ID,this.domId(a),STYLE,HU.css("max-height",d,"overflow-y","auto","display","inline-block")],""))+HU.td([WIDTH,"90%"],c))),y="",m=null;for(let t=0;t<e.length;t++){let i=this.getDataValues(e[t]);if(""==i[this.imageField.getIndex()])continue;m||(m=e[t]);let a=i[r.getIndex()];y+=HU.image(a,[RECORD_INDEX,t,ID,this.domId(s)+t,WIDTH,n,CLASS,"display-imagezoom-thumb"])+"<br>\n"}this.setContents(u),this.jq(a).html(y);let f=this,D=this.jq(a).find(".display-imagezoom-thumb"),I=t=>{D.css("border","1px solid transparent"),t.css("border","1px solid "+this.getHighlightColor());let i=parseFloat(t.attr(RECORD_INDEX));HU.addToDocumentUrl("imagezoom_thumb",i);let a=e[i];f.handleImage(a),f.propagateEventRecordSelection({record:a})};D.mouseover((function(){I($(this))})),this.jq(a).css("border","1px solid transparent");let T=HU.getUrlArgument("imagezoom_thumb"),b=HU.getUrlArgument("imagezoom_x"),S=HU.getUrlArgument("imagezoom_y"),v=this.jq(s+(T||"0"));v.length&&I(v),T&&this.showPopup(),Utils.isDefined(b)&&setTimeout((()=>{this.handleMouseMove({x:parseFloat(b),y:parseFloat(S)})}),250),this.jq(l).click((t=>{let e=+this.getPopupImageWidth();event.shiftKey?this.setProperty("popupImageWidth",Math.max(.9*e,500)):this.setProperty("popupImageWidth",1.2*e),this.showPopup(),this.handleMouseMove()}))},showPopup:function(){if(!this.currentRecord)return;let t=this.getDataValues(this.currentRecord)[this.imageField.getIndex()];this.jq(o).css("display","block");let e=[ID,this.domId(n),STYLE,HU.css("xposition","absolute")];this.getPopupImageWidth()&&(e.push(WIDTH),e.push(this.getPopupImageWidth())),this.jq(o).html(HU.image(t,e))},handleImage:function(t,e){this.currentRecord=t;let i=this.getDataValues(t),a=i[this.imageField.getIndex()],s=this.getProperty("imageWidth",500),d="";if(this.labelFields.length>0&&(this.labelFields.map((t=>{d+=" "+i[t.getIndex()]})),this.urlField)){var p=this.urlField.getValue(t);p&&""!=p&&(d="<a style='color:inherit;'  href='"+p+"' target=_other>"+d+"</a>")}let g=HU.image(a,["x","+:zoom in/-:zoom out",STYLE,HU.css("z-index",1e3),WIDTH,s,ID,this.domId(r)]);""!=d&&(g+=HU.div([STYLE,"color:#000"],d)),this.jq(l).html(g),this.jq(o).html(""),this.jq(o).css("display","none"),this.jq(r).mouseenter((()=>{this.showPopup()})),this.jq(r).mouseout((()=>{this.jq(o).html(""),this.jq(o).css("display","none"),this.jq(h).css("display","none")})),this.jq(r).mousemove((t=>{this.handleMouseMove({event:t})})),e&&this.jq(n).offset(e)},handleMouseMove(t){t||(t={event:this.currentMouseEvent}),this.currentMouseEvent=t.event;let e=this.jq(r),i=e.width(),a=e.height(),s=this.jq(n),l=s.width(),o=s.height();if(0==a||0==o)return!1;let d=i/l,p=a/o,g=d*s.parent().width(),c=p*s.parent().height(),u=g/2,y=c/2,m=e.parent().offset();Utils.isDefined(t.x)||(t.x=t.event.pageX-m.left),Utils.isDefined(t.y)||(t.y=t.event.pageY-m.top),t.x<u&&(t.x=u),t.y<y&&(t.y=y),t.x>i-u&&(t.x=i-u),t.y>a-y&&(t.y=a-y);let f=(t.x-u)/i,D=(t.y-y)/a;if(0==s.parent().length)return;let I=s.parent().offset(),T={left:I.left-f*l,top:I.top-D*o};return this.jq(n).offset(T),this.jq(h).css({display:"block",top:t.y-y+"px",left:t.x-u+"px",width:g+"px",height:c+"px"}),!0}})}function RamaddaSlidesDisplay(t,e,i){const a="slide",s="prev",l="next",r=new RamaddaFieldsDisplay(t,e,DISPLAY_SLIDES,i);defineDisplay(addRamaddaDisplay(this),r,[{label:"Slides Attributes"},{p:"template",ex:""}],{slideIndex:0,handleEventRecordSelection:function(t,e){if(this.records){for(var i=-1,a=0;a<this.records.length;a++)if(this.records[a].getId()==e.record.getId()){i=a;break}i>=0&&(this.slideIndex=i,this.displaySlide())}},getContentsStyle:function(){var t="",e=this.getHeightForStyle();e&&(t+=" height:"+e+";");var i=this.getWidthForStyle();return i&&(t+=" width:"+i+";"),t},updateUI:function(){if(null!=this.getData()&&(this.records=this.filterData(),this.records)){this.fields=this.getData().getRecordFields(),this.records=this.sortRecords(this.records);this.getProperty("template",""),this.getProperty("slideWidth","100%");var t=this.getHeightForStyle("400"),e=HU.div([ID,this.domId(s),STYLE,HU.css("font-size","200%"),CLASS,"display-slides-arrow-left fas fa-angle-left"]),i=HU.div([ID,this.domId(l),STYLE,HU.css("font-size","200%"),CLASS,"display-slides-arrow-right fas fa-angle-right"]),r=HU.div([STYLE,HU.css("overflow-y","auto","max-height",t),ID,this.domId(a),CLASS,"display-slides-slide"]),o="padding-top:20px;",n=HU.div([STYLE,HU.css("position","relative")],"<table width=100%><tr valign=top><td width=20>"+HU.div([STYLE,o],e)+"</td><td>"+r+"</td><td width=20>"+HU.div([STYLE,o],i)+"</td></tr></table>");this.setContents(n),this.jq(s).click((()=>{this.slideIndex--,this.displaySlide(!0)})),this.jq(l).click((()=>{this.slideIndex++,this.displaySlide(!0)})),setTimeout((()=>{this.displaySlide()}),200)}},displaySlide:function(t){this.slideIndex<0&&(this.slideIndex=0),this.slideIndex>=this.records.length&&(this.slideIndex=this.records.length-1),0==this.slideIndex?this.jq(s).hide():this.jq(s).show(),this.slideIndex==this.records.length-1?this.jq(l).hide():this.jq(l).show();var e=this.records[this.slideIndex],i=this.getDataValues(e),r=this.applyRecordTemplate(e,i,this.fields,this.getProperty("template",""));r=r.replace(/\${recordIndex}/g,this.slideIndex+1),this.jq(a).html(r);var o={highlight:!0,record:e};t&&this.getDisplayManager().notifyEvent(DisplayEvent.recordHighlight,this,o)},handleEventRecordHighlight:function(t,e){}})}addGlobalDisplayType({type:DISPLAY_IMAGES,label:"Images",requiresData:!0,forUser:!0,category:CATEGORY_IMAGES,tooltip:makeDisplayTooltip("Image Gallery","images.png")}),addGlobalDisplayType({type:DISPLAY_IMAGEZOOM,label:"Image Zoom",requiresData:!0,forUser:!0,category:CATEGORY_IMAGES,tooltip:makeDisplayTooltip("Image Zoom","imagezoom.png","Show a set of images and allow for zooming in")}),addGlobalDisplayType({type:DISPLAY_SLIDES,label:"Slides",requiresData:!0,forUser:!0,category:CATEGORY_IMAGES,tooltip:makeDisplayTooltip("Show records in a slide like format","slides.png")}),addGlobalDisplayType({type:DISPLAY_CARDS,label:"Cards",requiresData:!0,forUser:!0,category:CATEGORY_IMAGES,tooltip:makeDisplayTooltip("Group records hierachically showing images","cards.png")});const DISPLAY_FILTER="filter",DISPLAY_ANIMATION="animation",DISPLAY_LABEL="label",DISPLAY_DOWNLOAD="download",DISPLAY_LEGEND="legend",DISPLAY_RELOADER="reloader",DISPLAY_MESSAGE="message",DISPLAY_FIELDSLIST="fieldslist",DISPLAY_TICKS="ticks",DISPLAY_MENU="menu";function RamaddaFilterDisplay(t,e,i){let a=new RamaddaDisplay(t,e,DISPLAY_FILTER,i);defineDisplay(addRamaddaDisplay(this),a,[],{html:"<p>&nbsp;&nbsp;&nbsp;Nothing selected&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<p>",initDisplay:function(){this.createUI(),this.setContents(this.html)}})}function RamaddaAnimationDisplay(t,e,i){var a="start",s="time";let l=new RamaddaDisplay(t,e,DISPLAY_ANIMATION,i);defineDisplay(addRamaddaDisplay(this),l,[],{running:!1,timestamp:0,index:0,sleepTime:500,iconStart:"fa-play",iconStop:"fa-stop",iconBack:"fa-step-backward",iconForward:"fa-step-forward",iconSlower:"fa-minus",iconFaster:"fa-plus",iconBegin:"fa-fast-backward",iconEnd:"fa-fast-forward",needsData:function(){return!0},deltaIndex:function(t){this.stop(),this.setIndex(this.index+t)},setIndex:function(t){t<0&&(t=0),this.index=t,this.applyStep(!0,!Utils.isDefined(t))},toggle:function(){this.running?this.stop():this.start()},tick:function(){if(this.running){this.index++,this.applyStep();var t=this;setTimeout((function(){t.tick()}),this.sleepTime)}},applyStep:function(t,e){Utils.isDefined(t)||(t=!0);let i=this.currentRecords;if(null!=i){e&&(this.index=i.length-1),this.index>=i.length&&(this.index=0);var a=i[this.index],l="";if(null!=a.getDate()){var r=this.formatDate(a.getDate(),{suffix:this.getTimeZone()});l+=HU.b("Date:")+" "+r}else l+=HU.b("Index:")+" "+this.index;$("#"+this.getDomId(s)).html(l),t&&this.propagateEventRecordSelection({record:a})}else $("#"+this.getDomId(s)).html("No data")},handleEventRecordSelection:function(t,e){if(!e.record)return;let i=this.currentRecords;i||e.record&&(i=[e.record]),i.every(((t,i)=>t.getId()!=e.record.getId()||(this.index=i,this.applyStep(!1),!1)))},faster:function(){this.sleepTime=this.sleepTime/2,0==this.sleepTime&&(this.sleepTime=100)},slower:function(){this.sleepTime=1.5*this.sleepTime},start:function(){this.running||(this.running=!0,this.timestamp++,$("#"+this.getDomId(a)).html(HU.getIconImage(this.iconStop)),this.tick())},stop:function(){this.running&&(this.running=!1,this.timestamp++,$("#"+this.getDomId(a)).html(HU.getIconImage(this.iconStart)))},updateUI:function(){let t=this.filterData();if(!t)return;this.currentRecords=t,this.stop();var e=this.getGet(),i="";let l="display-animation-button";i+=HU.onClick(e+".setIndex(0);",HU.div([ATTR_TITLE,"beginning",ATTR_CLASS,l],HU.getIconImage(this.iconBegin))),i+=HU.onClick(e+".deltaIndex(-1);",HU.div([ATTR_TITLE,"step back",ATTR_CLASS,l],HU.getIconImage(this.iconBack))),i+=HU.onClick(e+".toggle();",HU.div([ATTR_ID,this.getDomId(a),ATTR_TITLE,"play/stop",ATTR_CLASS,l],HU.getIconImage(this.iconStart))),i+=HU.onClick(e+".deltaIndex(1);",HU.div([ATTR_TITLE,"step forward",ATTR_CLASS,l],HU.getIconImage(this.iconForward))),i+=HU.onClick(e+".setIndex();",HU.div([ATTR_TITLE,"end",ATTR_CLASS,l],HU.getIconImage(this.iconEnd))),i+=HU.onClick(e+".faster();",HU.div([ATTR_TITLE,"faster",ATTR_CLASS,l],HU.getIconImage(this.iconFaster))),i+=HU.onClick(e+".slower();",HU.div([ATTR_TITLE,"slower",ATTR_CLASS,l],HU.getIconImage(this.iconSlower))),i+=HU.div(["style","display:inline-block; min-height:24px; margin-left:10px;",ATTR_ID,this.getDomId(s)],"&nbsp;"),this.setDisplayTitle("Animation"),this.setContents(i)}})}function RamaddaMessageDisplay(t,e,i){const a=new RamaddaDisplay(t,e,DISPLAY_MESSAGE,i);defineDisplay(addRamaddaDisplay(this),a,[],{needsData:function(){return!1},updateUI:function(){this.getProperty("decorate",!0)?this.setContents(this.getMessage(this.getProperty("message",this.getNoDataMessage()))):this.setContents(this.getProperty("message",this.getNoDataMessage()))}})}function RamaddaFieldslistDisplay(t,e,i){const a="popup",s="popupbutton",l=new RamaddaDisplay(t,e,DISPLAY_FIELDSLIST,i);defineDisplay(addRamaddaDisplay(this),l,[{label:"Metadata"},{p:"decorate",ex:!0},{p:"asList",ex:!0},{p:"reverseFields",ex:!0},{p:"selectable",ex:!0},{p:"showFieldDetails",ex:!0},{p:"showPopup",d:!0,ex:!1,tt:"Popup the selector"},{p:"numericOnly",ex:!0},{p:"filterSelect",ex:!0,tt:"Use this display to select filter fields"},{p:"filterSelectLabel",tt:"Label to use for the button"}],{needsData:function(){return!0},fieldsToMap:{},getFieldsKey:function(){let t=this.getFields(),e="";return t.forEach((t=>{e+="_"+t.getId()})),e},setEntry:function(t){if(this.selectedMap){let t=this.getFieldsKey();this.fieldsToMap[t]=this.selectedMap}this.selectedMap=null,l.setEntry.call(this,t)},updateUI:function(){if(null==this.filterData())return;let t,e="";t=this.getFilterSelect()?this.getFieldsByIds(null,this.getProperty("filterFields","")):this.getSelectedFields();let i=this.getFieldsKey();this.selectedMap=this.selectedMap||this.fieldsToMap[i],null==this.selectedMap?(this.selectedMap={},t&&0!=t.length?t.forEach((t=>{this.selectedMap[t.getId()]=!0})):t=null):t=null;let l=this.getData().getRecordFields();if(this.getNumericOnly()&&(l=l.filter((t=>t.isFieldNumeric()))),this.getReverseFields()){let t=[];l.forEach((e=>{t.unshift(e)})),l=t}this.fields=l,this.fieldsMap={},this.fields.forEach((t=>{this.fieldsMap[t.getId()]=t}));let r=[],o=" display-fields-field ",n=this.getAsList();this.getDecorate(!0)&&(o+=" display-fields-field-decorated "),n&&(o+=" display-fields-list-field");let h=this.getSelectable(!0),d=this.getShowFieldDetails(!1);if(l.forEach(((t,e)=>{let i=t.getLabel();d&&(i+="<br>"+t.getId()+t.getUnitSuffix()+"<br>"+t.getType());let a=o,s=this.selectedMap[t.getId()];h&&(a+=" display-fields-field-selectable "),h&&s&&(a+=" display-fields-field-selected ");let l="";h&&(l="Click to toggle. Shift-click toggle all"),i=HU.div([TITLE,l,"field-selected",s,"field-id",t.getId(),"class",a],i),r.push(i)})),e+=Utils.wrap(r,"",""),this.getShowPopup()&&(e=HU.div([ID,this.domId(s)],this.getFilterSelect()?this.getFilterSelectLabel("Select Filter Fields"):"Select fields")+HU.div([ID,this.domId(a),STYLE,"display:none;max-height:300px;overflow-y:auto;width:600px;"],e)),this.setContents(e),this.getShowPopup()&&this.jq(s).button().click((()=>{HU.makeDialog({contentId:this.domId(a),inPlace:!0,anchor:this.domId(s),draggable:!0,header:!0,sticky:!0})})),h){let t=this,e=this.find(".display-fields-field");e.click((function(i){let a=i.shiftKey,s="true"==$(this).attr("field-selected");s=!s,$(this).attr("field-selected",s),s?$(this).addClass("display-fields-field-selected"):$(this).removeClass("display-fields-field-selected"),a&&(e.attr("field-selected",s),s?e.addClass("display-fields-field-selected"):e.removeClass("display-fields-field-selected"));let l=[];e.each((function(){if("true"==$(this).attr("field-selected")){let e=$(this).attr("field-id"),i=t.fieldsMap[e];i&&l.push(i)}})),t.selectedMap={},l.forEach((e=>{t.selectedMap[e.getId()]=!0})),setTimeout((()=>{t.getFilterSelect()?t.propagateEvent(DisplayEvent.filterFieldsSelected,l):t.propagateEvent(DisplayEvent.fieldsSelected,l)}),20)}))}}})}function RamaddaLabelDisplay(t,e,i){var a="text",s="edit";i&&!Utils.isDefined(i.showTitle)&&(i.showTitle=!1),this.text="",this.editMode=i.editMode,i.text?this.text=i.text:i.label?this.text=i.label:i.html&&(this.text=i.html),i.class?this.class=i.class:this.class="display-text";const l=new RamaddaDisplay(t,e,DISPLAY_LABEL,i);defineDisplay(addRamaddaDisplay(this),l,[],{initDisplay:function(){var t=this;this.createUI();var e=this.class;this.editMode&&(e+=" display-text-edit ");var i="color:"+this.getTextColor("contentsColor")+";",l=HU.div([ATTR_CLASS,e,ATTR_ID,this.getDomId(a),"style",i],this.text);if(this.editMode&&(l+=HU.textarea(s,this.text,["rows",5,"cols",120,ATTR_SIZE,"120",ATTR_CLASS,"display-text-input",ATTR_ID,this.getDomId(s)])),this.setContents(l),this.editMode){var r=this.jq(s);r.blur((function(){t.text=r.val(),r.hide(),t.initDisplay()})),this.jq(a).click((function(){var e=t.jq(a),i=t.jq(s);i.show(),i.css("z-index","9999"),i.position({of:e,my:"left top",at:"left top",collision:"none none"}),t.jq(a).html("")}))}},getWikiAttributes:function(t){l.getWikiAttributes(t),t.push("text"),t.push(this.text)}})}function RamaddaLegendDisplay(t,e,i){i.width||(i.width="100%");let a=new RamaddaDisplay(t,e,DISPLAY_LEGEND,i);RamaddaUtil.inherit(this,a);defineDisplay(addRamaddaDisplay(this),a,[{label:"Legend"},{p:"labels",ex:""},{p:"colors",ex:""},{p:"circles",ex:"true"},{p:"inBox",ex:"true"},{p:"labelColor",ex:"#fff"},{p:"labelColors",ex:"color1,color2,..."},{p:"labelField",ex:""},{p:"orientation",ex:"vertical"}],{getColorList:function(){if(this.getProperty("colorTable")){return this.getColorTable().colors}return a.getColorList.call(this)},needsData:function(){return null!=this.getProperty("labelField")},updateUI:function(){let t=this.getProperty("labels","").split(","),e=this.getFieldById(null,this.getProperty("labelField"));if(e){let i=this.filterData();if(!i)return void this.setDisplayMessage(this.getLoadingMessage());t=[],i.forEach((i=>{t.push(e.getValue(i))}))}let i=this.getColorList(),a="",s=this.getProperty("colorWidth","20px"),l=this.getProperty("labelColor","#000"),r=this.getProperty("labelColors")?this.getProperty("labelColors").split(","):null,o=this.getProperty("inBox",!1),n=this.getProperty("orientation","horizontal"),h="horizontal"==n?" ":"<br>",d=this.getCircles();for(let e=0;e<t.length;e++){let n=t[e],p=i[e]||"#fff";if(e>0&&(a+=h),o){let t=r?r[e]:l||l;a+=HU.div(["class","display-legend-color","style","margin-left:8px;background:"+p+";"],HU.div(["class","display-legend-label","style","margin-left:8px;margin-right:8x;color:"+t+";"],n))}else a+=HU.div(["class","display-legend-item"],HU.div(["class","display-legend-color "+(d?"display-colortable-dot":""),"style","background:"+p+";width:"+s+";"+(d?"height:"+s+";":"height:15px;")])+HU.div(["class","display-legend-label"],n))}"vertical"!=n&&(a=HU.center(a)),this.setContents(a)}})}function RamaddaDownloadDisplay(t,e,i){const a=new RamaddaFieldsDisplay(t,e,DISPLAY_DOWNLOAD,i),s="downloadcsv",l="downloadjson",r="downloadcopy",o="cancel";defineDisplay(addRamaddaDisplay(this),a,[{label:"Download"},{p:"csvLabel",ex:"Download"},{p:"useIcon",d:"false",ex:"false"},{p:"iconSize",ex:"",d:"16pt"},{p:"fileName",d:"download",ex:"download"},{p:"askFields",d:"false",ex:"true"},{p:"showCsvButton",ex:!1,tt:"Show/hide the CSV button"},{p:"showJsonButton",ex:!1,tt:"Show/hide the JSON button"},{p:"showCopyButton",ex:!1,tt:"Show/hide the Copy button"}],{fieldOn:{},needsData:function(){return!0},updateUI:function(){let t=this.getPropertyCsvLabel("Download Data");t=t.replace("${title}",this.getProperty("title",""));let e=this.getPropertyUseIcon(!0),i=this.getIconSize();t=HU.span([ID,this.getDomId("csv")],e?HU.getIconImage("fa-download",null,[STYLE,"cursor:pointer;font-size:"+i+";",TITLE,t]):t),this.setContents(HU.div([],t)),e?this.jq("csv").click((()=>{this.doDownload()})):this.jq("csv").button().click((()=>{this.doDownload()}))},getCsv:function(t,e,i){t=t||this.getData().getRecordFields();let a=DataUtils.getCsv(t,e);i?(Utils.copyToClipboard(a),alert("Copied to clipboard")):Utils.makeDownloadFile(this.getPropertyFileName()+".csv",a)},getJson:function(t,e){t=t||this.getData().getRecordFields(),DataUtils.getJson(t,e,this.getPropertyFileName()+".json")},applyFieldSelection:function(){this.getData().getRecordFields().forEach((t=>{let e=this.jq("cbx_"+t.getId()).is(":checked");this.fieldOn[t.getId()]=e}))},getDownloadDialog:function(t){let e=this.getSelectedFields();e&&(this.fieldOn={},this.getData().getRecordFields().forEach((t=>{this.fieldOn[t.getId()]=!1})),e.forEach((t=>{this.fieldOn[t.getId()]=!0})));let i=SPACE,a="";this.getShowCsvButton(!0)&&(a+=HU.div([ID,this.getDomId(s)],"CSV")+i),this.getShowJsonButton(!0)&&(a+=HU.div([ID,this.getDomId(l)],"JSON")+i),this.getShowCopyButton(!0)&&(a+=HU.div([ID,this.getDomId(r)],"Copy")+i),a+=HU.div([ID,this.getDomId(o)],"Cancel");let n=HU.center("#"+t.length+" records")+HU.center(a);n+="<b>Include:</b>";let h="";return h+=HU.checkbox(this.getDomId("cbx_toggle_all"),[],!0,"Toggle all")+"<br>",this.getData().getRecordFields().forEach(((t,e)=>{let i=this.fieldOn[t.getId()];Utils.isDefined(i)||(i=!0),h+=HU.checkbox(this.getDomId("cbx_"+t.getId()),[CLASS,"display-downloader-field-cbx"],i,t.getLabel())+"<br>"})),n+=HU.div([STYLE,HU.css("max-height","200px","overflow-y","auto","margin-left","10px")],h),n=HU.div([STYLE,HU.css("margin","5px")],n),n},doDownload:function(){let t=this.filterData(),e=(e,i)=>{this.jq(ID_DIALOG).hide();let a=[];this.applyFieldSelection(),this.getData().getRecordFields().forEach((t=>{this.fieldOn[t.getId()]&&a.push(t)})),e?this.getJson(a,t):this.getCsv(a,t,i),this.dialog&&this.dialog.remove(),this.dialog=null};if(this.getPropertyAskFields(!0)){let i,a=this.getDownloadDialog(t),n=()=>{this.jq("cbx_toggle_all").click((function(){let t=$(this).is(":checked");i.find(".display-downloader-field-cbx").each((function(){$(this).prop("checked",t)}))})),this.jq(o).button().click((()=>{this.applyFieldSelection(),this.jq(ID_DIALOG).hide(),this.dialog&&this.dialog.remove(),this.dialog=null})),this.jq(s).button().click((()=>{e(!1)})),this.jq(l).button().click((()=>{e(!0)})),this.jq(r).button().click((()=>{e(!1,!0)}))};i=this.showDialog(a,this.getDomId(ID_DISPLAY_CONTENTS),n,this.getTitle())}else this.getCsv(null,t)}})}function RamaddaReloaderDisplay(t,e,i){const a="cbx",s="countdown",l=new RamaddaFieldsDisplay(t,e,DISPLAY_RELOADER,i);defineDisplay(addRamaddaDisplay(this),l,[{label:"Reloader"},{p:"interval",ex:"30",d:30,label:"Interval"},{p:"showCheckbox",ex:"false",d:!0,label:"Show Checkbox"},{p:"showCountdown",ex:"false",d:!0,label:"Show Countdown"}],{needsData:function(){return!0},xxpointDataLoaded:function(t,e,i){},reloadData:function(){this.dataCollection.getList()[0].loadData(this,!0)},updateUI:function(){let t="";this.jq(s).length>0||(this.getPropertyShowCheckbox()&&(t+=HU.checkbox(this.getDomId(a),[],!0)),this.getPropertyShowCountdown()?t+=" "+HU.span([CLASS,"display-reloader-label",ID,this.getDomId(s)],this.getCountdownLabel(this.getPropertyInterval())):this.getPropertyShowCheckbox()&&(t+=" "+HU.span([ID,this.getDomId(s)],"Reload")),this.setContents(t),this.clearDisplayMessage(),this.jq(a).change((()=>{this.jq(a).is(":checked")&&this.setTimer(this.lastTime)})),this.jq(s).addClass("ramadda-clickable").css("cursor","pointer").attr("title","Reload").click((()=>{this.checkReload(-1)})),this.setTimer(this.getPropertyInterval()))},setDisplayMessage:function(t){},okToRun:function(){let t=this.jq(a);return 0==t.length||t.is(":checked")},getCountdownLabel:function(t){let e="";if(t<10&&(e="&nbsp;"),t>60){let i=Math.round((t-t%60)/60),a=t%60;return i<10&&(i="0"+String(i)),a<10&&(a="0"+String(a)),"Reload in "+i+":"+a+e}return"Reload in "+t+" seconds"+e},updateCountdown(t){this.getPropertyShowCountdown()?this.jq(s).html(this.getCountdownLabel(t)):this.jq(s).html("Reload")},setTimer(t){this.okToRun()&&(this.lastTime=t,this.updateCountdown(t),this.lastTimeout&&clearTimeout(this.lastTimeout),this.lastTimeout=setTimeout((()=>{this.checkReload(t)}),1e3))},checkReload:function(t){--t<=0?(this.jq(s).html("Reloading..."+HU.span([STYLE,"color:transparent;"],"")),this.reloadData(),t=this.getPropertyInterval(),this.lastTimeout&&clearTimeout(this.lastTimeout),this.lastTimeout=setTimeout((()=>{this.setTimer(t)}),1e3)):this.setTimer(t)}})}function RamaddaTicksDisplay(t,e,i){i.animationHeight||(i.animationHeight="30px"),i.doAnimation=!1,i.animationShowButtons=!1,i.animationMakeSlider=!1;const a="animation",s=new RamaddaFieldsDisplay(t,e,DISPLAY_TICKS,i);defineDisplay(addRamaddaDisplay(this),s,[{label:"Time Ticks"},{p:"animationHeight",ex:"30px"},{p:"showYears",ex:"true"}],{needsData:function(){return!0},dataFilterChanged:function(){s.dataFilterChanged.call(this)},updateUI:function(){let t=this.filterData();if(!t)return;this.getDateInfo(t);let e={};if(this.getPropertyShowYears(!1)){t.forEach((t=>{if(!t.getDate())return;let i=t.getDate().getUTCFullYear();null==e[i]&&(e[i]={records:[]}),e[i].records.push(t)}))}else e.all={records:t,yearCnt:"all"};let i="";Object.keys(e).sort().forEach((t=>{i+=HU.div([CLASS,"display-ticks-ticks",ID,this.getDomId(a+t)])})),this.setContents(i),Object.keys(e).sort().forEach(((t,i)=>{let s=e[t],l=this.getDateInfo(s.records),r=new DisplayAnimation(this,!0,{baseDomId:a+t,targetDiv:this.jq(a+t)});r.makeControls(),"all"!=t&&(l.dateMin=new Date(Date.UTC(t,0,1)),l.dateMax=new Date(Date.UTC(t,11,31))),r.init(l.dateMin,l.dateMax,s.records)}))}})}function RamaddaMenuDisplay(t,e,i){const a="menu",s="prev",l="next",r=new RamaddaFieldsDisplay(t,e,DISPLAY_MENU,i);defineDisplay(addRamaddaDisplay(this),r,[{label:"Record Menu"},{p:"labelTemplate",d:"${name}"},{p:"menuLabel",ex:""},{p:"showArrows",d:!1,ex:!0}],{needsData:function(){return!0},handleEventRecordSelection:function(t,e){if(r.handleEventRecordSelection.call(this,t,e),!this.recordToIdx)return;let i=this.recordToIdx[e.record.getId()];Utils.isDefined(i)&&this.jq(a).val(i)},pointDataLoaded:function(t,e,i){r.pointDataLoaded.call(this,t,e,i),this.haveLoadedData&&this.records&&setTimeout((()=>{let t=this.records[+this.jq(a).val()];t&&this.propagateEventRecordSelection({record:t})}),100),this.haveLoadedData=!0},updateUI:function(){if(this.records=this.filterData(),!this.records)return;let t=[],e=this.getLabelTemplate();this.recordToIdx={},this.records.forEach(((i,a)=>{let s=this.getRecordHtml(i,null,e);t.push([a,s]),this.recordToIdx[i.getId()]=a}));let i=HU.select("",[ATTR_ID,this.getDomId(a)],t);if(this.getShowArrows(!1)){let t=this.getProperty("noun","Data"),e=HU.span([CLASS,"display-changeentries-button ramadda-clickable",TITLE,"Previous "+t,ID,this.getDomId(s),TITLE,"Previous"],HU.getIconImage("fa-chevron-left")),a=HU.span([CLASS,"display-changeentries-button ramadda-clickable",TITLE,"Next "+t,ID,this.getDomId(l),TITLE,"Next"],HU.getIconImage("fa-chevron-right"));i=i.replace(/\n/g,""),i=e+"&nbsp;"+i+"&nbsp;"+a}let r=this.getMenuLabel();r&&(i=r+"&nbsp;"+i),this.setContents(i),this.getShowArrows(!1)&&(this.jq(s).click((t=>{let e=+this.jq(a).val()-1;e<0&&(e=this.records.length-1),this.jq(a).val(e).trigger("change")})),this.jq(l).click((t=>{let e=+this.jq(a).val()+1;e>=this.records.length&&(e=0),this.jq(a).val(e).trigger("change")}))),this.jq(a).change((()=>{let t=this.records[+this.jq(a).val()];this.propagateEventRecordSelection({record:t})}))}})}addGlobalDisplayType({type:DISPLAY_DOWNLOAD,label:"Download",requiresData:!0,forUser:!0,category:CATEGORY_CONTROLS,tooltip:makeDisplayTooltip("Show a download link",null,"Allows user to select fields and<br>download CSV and JSON")}),addGlobalDisplayType({type:DISPLAY_RELOADER,label:"Reloader",requiresData:!0,forUser:!0,category:CATEGORY_CONTROLS,tooltip:makeDisplayTooltip("Reload the displays",null,"Automatically reloads the displays on a set frequency")}),addGlobalDisplayType({type:DISPLAY_FILTER,label:"Filter",requiresData:!1,category:CATEGORY_CONTROLS,tooltip:makeDisplayTooltip("No data, just provides data filtering")}),addGlobalDisplayType({type:DISPLAY_ANIMATION,label:"Animation",requiresData:!0,category:CATEGORY_CONTROLS,tooltip:makeDisplayTooltip("Steps through time to drive other displays","animation.png","")}),addGlobalDisplayType({type:DISPLAY_MESSAGE,label:"Message",requiresData:!0,forUser:!0,category:CATEGORY_CONTROLS,tooltip:makeDisplayTooltip("No data, just a formatted message",null,"")}),addGlobalDisplayType({type:DISPLAY_MENU,label:"Menu",requiresData:!0,forUser:!0,category:CATEGORY_CONTROLS,tooltip:makeDisplayTooltip("Shows records in a menu to be selected")}),addGlobalDisplayType({type:DISPLAY_FIELDSLIST,label:"Fields List",requiresData:!0,forUser:!0,category:CATEGORY_CONTROLS}),addGlobalDisplayType({type:DISPLAY_LABEL,label:"Label",requiresData:!1,category:CATEGORY_CONTROLS,tooltip:makeDisplayTooltip("No data, just a text label",null,"Useful to add text to the display layout")}),addGlobalDisplayType({type:DISPLAY_LEGEND,label:"Legend",requiresData:!1,forUser:!0,category:CATEGORY_CONTROLS,tooltip:makeDisplayTooltip("No data, just a configurable legend","legend.png")}),addGlobalDisplayType({type:DISPLAY_TICKS,label:"Ticks",requiresData:!0,forUser:!0,category:CATEGORY_CONTROLS,tooltip:makeDisplayTooltip("Shows records as ticks in a timeline","ticks.png")});const DISPLAY_NOTEBOOK="notebook";addGlobalDisplayType({type:DISPLAY_NOTEBOOK,label:"Notebook",requiresData:!1,category:CATEGORY_CONTROLS});var pluginDefintions={jsx:{languageId:"jsx",displayName:"React JSX",url:"https://raw.githubusercontent.com/hamilton/iodide-jsx/master/docs/evaluate-jsx.js",module:"jsx",evaluator:"evaluateJSX",pluginType:"language"},lisp:{languageId:"lisp",displayName:"Microtalk Lisp",url:"https://ds604.neocities.org/js/microtalk.js",module:"MICROTALK",evaluator:"evaluate",pluginType:"language",outputHandler:"processLispOutput"},sql:{languageId:"sql",displayName:"SqlLite",url:ramaddaBaseHtdocs+"/lib/notebook/sqllite.js",module:"SqlLite",evaluator:"evaluate",pluginType:"language"},plantuml:{languageId:"plantuml",displayName:"PlantUml",codeMirrorMode:"",keybinding:"x",url:"https://raw.githubusercontent.com/six42/iodide-plantuml-plugin/master/src/iodide-plantuml-plugin.js",depends:[{type:"js",url:"https://raw.githubusercontent.com/johan/js-deflate/master/rawdeflate.js"}],module:"plantuml",evaluator:"plantuml_img",pluginType:"language"},ml:{languageId:"ml",displayName:"ocaml",codeMirrorMode:"mllike",keybinding:"o",url:"https://louisabraham.github.io/domical/eval.js",module:"evaluator",evaluator:"execute",pluginType:"language",depends:[{type:"css",url:"https://louisabraham.github.io/domical/style.css"}]}};function RamaddaNotebookDisplay(t,e,i){var s="notebook",l="cells",r="cellsbottom",o="inputs",n="outputs",h="console",d="consoletoolbar",p="consolecontainer",g="consoleout",c="menu";this.properties=i||{};let u=new RamaddaDisplay(t,e,DISPLAY_NOTEBOOK,i);RamaddaUtil.inherit(this,u),addRamaddaDisplay(this),RamaddaUtil.defineMembers(this,{runOnLoad:this.getProperty("runOnLoad",!0),displayMode:this.getProperty("displayMode",!1),showConsole:this.getProperty("showConsole",!0),consoleHidden:this.getProperty("consoleHidden",!1),layout:this.getProperty("layout","horizontal"),columns:this.getProperty("columns",1)}),RamaddaUtil.defineMembers(this,{cells:[],cellCount:0,fetchedNotebook:!1,currentEntries:{},globals:{},baseEntries:{},outputRenderers:[],initDisplay:async function(){this.createUI();var t=(i=HtmlUtils.div(["id",this.getDomId("imports")]))+HtmlUtils.div([ATTR_CLASS,"display-notebook-cells",ATTR_ID,this.getDomId(l)],"&nbsp;&nbsp;Loading...")+HtmlUtils.div([ATTR_ID,this.getDomId(r)]),e=HtmlUtils.div(["class","ramadda-popup",ATTR_ID,this.getDomId(c)]);if(t=HtmlUtils.div([ATTR_ID,this.getDomId(s)],e+t),this.setContents(t),this.makeCellLayout(),this.jq(s).hover((()=>{}),(()=>{this.jq(c).hide()})),this.fetchedNotebook)this.layoutCells();else if(this.initOutputRenderers(),!this.fetchingNotebook){this.fetchingNotebook=!0,await Utils.importJS(ramaddaBaseHtdocs+"/lib/ace/src-min/ace.js"),await Utils.importJS(ramaddaBaseUrl+"/lib/showdown.min.js");var i="<link rel='preload' href='https://cdn.jsdelivr.net/npm/katex@0.10.1/dist/fonts/KaTeX_Main-Regular.woff2' as='font' type='font/woff2' crossorigin='anonymous'>\n<link rel='preload' href='https://cdn.jsdelivr.net/npm/katex@0.10.1/dist/fonts/KaTeX_Math-Italic.woff2' as='font' type='font/woff2' crossorigin='anonymous'>\n<link rel='preload' href='https://cdn.jsdelivr.net/npm/katex@0.10.1/dist/fonts/KaTeX_Size2-Regular.woff2' as='font' type='font/woff2' crossorigin='anonymous'>\n<link rel='preload' href='https://cdn.jsdelivr.net/npm/katex@0.10.1/dist/fonts/KaTeX_Size4-Regular.woff2' as='font' type='font/woff2' crossorigin='anonymous'/>\n<link rel='stylesheet' href='https://fonts.googleapis.com/css?family=Lato:300,400,700,700i'>\n<link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/katex@0.10.1/dist/katex.min.css' crossorigin='anonymous'>\n<script defer src='https://cdn.jsdelivr.net/npm/katex@0.10.1/dist/katex.min.js' crossorigin='anonymous'><\/script>";$(i).appendTo("head"),setTimeout((()=>this.fetchNotebook(1)),10)}},fetchNotebook:async function(t){if(!window.ace)return t>50?void alert("Could not load ace.js"):void setTimeout((()=>this.fetchNotebook(t+1)),10*t);var e=(new Date).getTime();ace.config.set("basePath",ramaddaBaseUrl+"/htdocs_v"+e+"/lib/ace/src-min");let i=this;this.fetchedNotebook=!0,await this.getEntry(this.getProperty("entryId",""),(t=>{this.baseEntry=t})),await this.baseEntry.getRoot((t=>{this.rootEntry=t}));var a=this.getProperty("entryId",""),s=ramaddaBaseUrl+"/getnotebook?entryid="+a;s+="&notebookId="+this.getProperty("notebookId","default_notebook");$.getJSON(s,(function(t){i.loadJson(t)})).fail((function(){this.addCell("init cell",{showInput:!0},!1).run(),this.cells[0].focus()}))},formatObject:function(t){return Utils.formatJson(t)},initOutputRenderers:function(){let t=this;this.outputRenderers=[],this.addOutputRenderer({shouldRender:t=>Array.isArray(t),render:t=>Utils.formatJson(t)}),this.addOutputRenderer({shouldRender:t=>Array.isArray(t)&&t.length>0&&Array.isArray(t[0]),render:t=>{for(var e="<table>",i=0;i<t.length;i++){var a=t[i];e+="<tr>";for(var s=0;s<a.length;s++)e+="<td>&nbsp;"+a[s]+"</td>";e+="</tr>"}return e+="</table>"}}),this.addOutputRenderer({shouldRender:t=>"object"==typeof t&&t.getTime,render:e=>t.formatDate(e)}),this.addOutputRenderer({shouldRender:t=>{var e=typeof t;return"string"===e||"number"===e||"boolean"===e},render:t=>"string"==typeof t&&t.split("\n").length>1?HtmlUtils.div(["style"," white-space: pre;"],t):t}),this.addOutputRenderer({shouldRender:t=>"object"==typeof t&&"lat"in t&&"lon"in t,render:t=>"<img src='"+("http://staticmap.openstreetmap.de/staticmap.php?center="+t.lat+","+t.lon+"&zoom=17&size=400x150&maptype=mapnik")+"'/>"})},addOutputRenderer:function(t){this.outputRenderers.indexOf(t)<0&&this.outputRenderers.push(t)},formatOutput:function(t){if(!t)return null;for(var e=this.outputRenderers.length-1;e>=0;e--){var i=this.outputRenderers[e];if(i.shouldRender&&i.shouldRender(t))return i.render(t)}var a=null;return t.iodideRender?a=t.iodideRender():t.notebookRender&&(a=t.notebookRender()),a&&"string"==typeof a?a:null},getBaseEntry:function(){return this.baseEntry},getRootEntry:function(){return this.rootEntry},getPopup:function(){return this.jq(c)},loadJson:async function(t){if(t.error)this.setContents(_this.getMessage("Failed to load notebook: "+t.error));else{if(!Utils.isDefined(this.properties.runOnLoad)&&Utils.isDefined(t.runOnLoad)&&(this.runOnLoad=t.runOnLoad),!Utils.isDefined(this.properties.displayMode)&&Utils.isDefined(t.displayMode)&&(this.displayMode=t.displayMode),!Utils.isDefined(this.properties.showConsole)&&Utils.isDefined(t.showConsole)&&(this.showConsole=t.showConsole),Utils.isDefined(t.consoleHidden)&&(this.consoleHidden=t.consoleHidden),!Utils.isDefined(this.properties.columns)&&Utils.isDefined(t.columns)&&(this.columns=t.columns),!Utils.isDefined(this.properties.layout)&&Utils.isDefined(t.layout)&&(this.layout=t.layout),Utils.isDefined(t.currentEntries))for(a in t.currentEntries){var e={};if(!this.currentEntries[a]){e.name=a,e.entryId=t.currentEntries[a].entryId;try{await this.getEntry(e.entryId,(t=>e.entry=t)),this.currentEntries[a]=e}catch(t){}}}if(Utils.isDefined(t.cells)&&(this.cells=[],t.cells.forEach((t=>this.addCell(t.outputHtml,t,!0))),this.layoutCells()),0==this.cells.length){this.addCell("%%wiki\n",{showInput:!0},!1),this.layoutCells(),this.cells[0].focus()}this.runOnLoad&&this.runAll()}},addEntry:async function(t,e){var i;await this.getEntry(e,(t=>i=t)),this.currentEntries[t]={entryId:e,entry:i}},getCurrentEntries:function(){return this.currentEntries},clearEntries:function(){for(a in this.currentEntries={},this.baseEntries)this.currentEntries[a]=this.baseEntries[a]},saveNotebook:function(t){var e=this.getJson(t);e=JSON.stringify(e,null,2);var i={entryid:this.getProperty("entryId",""),notebookId:this.getProperty("notebookId","default_notebook"),notebook:e},a=ramaddaBaseUrl+"/savenotebook";$.post(a,i,(t=>{t.error?alert("Error saving notebook: "+t.error):"ok"==t.result?this.getShowConsole()?this.log("Notebook saved","info","nb"):alert("Notebook saved"):alert("Error saving notebook: "+t.result)}))},showInput:function(){return!(this.displayMode&&!this.getProperty("user"))&&0!=this.getProperty("showInput",!0)},getJson:function(t){var e={cells:[],currentEntries:{},runOnLoad:this.runOnLoad,displayMode:this.displayMode,showConsole:this.showConsole,consoleHidden:this.consoleHidden,layout:this.layout,columns:this.columns};for(var i in this.currentEntries){var a=this.currentEntries[i];e.currentEntries[i]={entryId:a.entryId}}return this.cells.forEach((i=>e.cells.push(i.getJson(t)))),e},initConsole:function(){if(!this.showInput())return;let t=this;this.console=this.jq(g),this.consoleHidden&&this.console.hide(),this.jq(h).find(".ramadda-image-link").click((function(e){"clear"==$(this).attr("what")&&t.console.html(""),e.stopPropagation()})),this.consoleToolbar=this.jq(d),this.consoleToolbar.click((()=>{this.console.is(":visible")?(this.console.hide(400),this.consoleHidden=!0):(this.consoleHidden=!1,this.console.show(400))}))},getShowConsole:function(){return this.showInput()&&this.showConsole},makeConsole:function(){if(this.console=null,!this.getShowConsole())return"";var t=this.jq(g).html(),e=HtmlUtils.div(["id",this.getDomId(d),"class","display-notebook-console-toolbar","title","click to hide/show console"],HtmlUtils.leftRight("",HtmlUtils.span(["class","ramadda-image-link","title","Clear","what","clear"],HtmlUtils.image(Utils.getIcon("clear.png")))));return HtmlUtils.div(["id",this.getDomId(h),"class","display-notebook-console"],e+HtmlUtils.div(["class","display-notebook-console-output","id",this.getDomId(g)],t||""))},makeCellLayout:function(){var t="",e=HtmlUtils.div(["id",this.getDomId(p)]);if(this.jq(r).html(""),this.showInput()&&"horizontal"==this.layout){var i=HtmlUtils.div(["id",this.getDomId(o),"style","width:100%;"]),a=HtmlUtils.div(["id",this.getDomId(n),"style","width:100%;"]);t="<table style='table-layout:fixed;' border=0 width=100%><tr valign=top><td width=50%>"+(i+=e)+"</td><td style='border-left:1px #ccc solid;' width=1>"+HtmlUtils.div([],"")+"</td><td width=49%>"+a+"</td></tr></table>"}else this.jq(r).html(e);this.jq(l).html(t)},plugins:{},addPlugin:async function(t,e){var i;if(t.depends)for(var a=0;a<t.depends.length;a++){var s=t.depends[a],l=s.type,r=s.url;if("js"==l?await Utils.importJS(r,(()=>{}),((t,e,a)=>{i="Error fetching plugin url:"+r})):"css"==l&&await Utils.importCSS(r,(()=>{}),((t,e,a)=>{i="Error fetching plugin url:"+r})),i)return void this.log(i,"error","nb",e?e.div:null)}r=Utils.replaceRoot(t.url);if(await Utils.importJS(r,(()=>{}),((t,e,a)=>{i="Error fetching plugin url:"+r})),!i){for(var o=t.module,n=200;null==window[o]&&n-- >0;)await new Promise((t=>setTimeout(t,100)));if(window[o]){if(window[o].isPluginReady){for(n=200;!window[o].isPluginReady()&&n-- >0;)await new Promise((t=>setTimeout(t,100)));window[o].isPluginReady()||(i="Could not load plugin module: "+o)}}else i="Could not load plugin module: "+o}i?this.log(i,"error","nb",e?e.div:null):this.plugins[t.languageId]=t},hasPlugin:async function(t,e){this.plugins[t]||window.pluginDefintions[t]&&await this.addPlugin(window.pluginDefintions[t],null),Utils.call(e,null!=this.plugins[t])},processChunkWithPlugin:async function(t,e,i){var a=this.plugins[t].module,s=this.plugins[t].evaluator,l=window[a][s](e.getContent(),e);return Utils.call(i,l)},processPluginOutput:function(t,e,i){if(i){this.plugins[t].module;var a=window[this.plugins[t].outputHandler];a?e.div.append(a(i)):"object"==typeof i||e.div.set(i)}},log:function(t,e,i,a){var s="",l="display-notebook-console-item";if("object"==typeof t&&(t=Utils.formatJson(t)),"error"==e?(l+=" display-notebook-console-item-error",s=HtmlUtils.image(Utils.getIcon("cross-octagon.png")),a&&a.append(HtmlUtils.div(["class","display-notebook-chunk-error"],t))):"output"==e?(l+=" display-notebook-console-item-output",s=HtmlUtils.image(Utils.getIcon("arrow-000-small.png"))):"info"==e&&(l+=" display-notebook-console-item-info",s=HtmlUtils.image(Utils.getIcon("information.png"))),this.console){i=i?HtmlUtils.div(["class","display-notebook-console-from"],i):"";var r="<table width=100%><tr valign=top><td width=10>"+s+"</td><td>"+HtmlUtils.div(["style","margin-left:5px;"],t)+"</td><td width=10>"+i+"</td></tr></table>",o=HtmlUtils.div(["class",l],r);this.console.append(o);var n=this.console.prop("scrollHeight");n>200&&this.console.scrollTop(n-200)}},clearConsole:function(){this.console.html("")},layoutCells:function(){for(var t=0;t<this.cells.length;t++){(h=this.cells[t]).prepareToLayout()}if(this.makeCellLayout(),this.showInput()&&"horizontal"==this.layout){var e="",i="";for(t=0;t<this.cells.length;t++){(h=this.cells[t]).id,h.index=t+1,e+=HtmlUtils.div([ATTR_CLASS,"display-notebook-cell",ATTR_ID,h.id+"_cellinput"],""),e+="\n",i+=HtmlUtils.div([ATTR_CLASS,"display-notebook-cell",ATTR_ID,h.id+"_celloutput"],"")}this.jq(o).html(e),this.jq(n).html(i)}else{var a="<div class=row style='padding:0px;margin:0px;'>",s=HtmlUtils.getBootstrapClass(this.columns),r=0;for(t=0;t<this.cells.length;t++){(h=this.cells[t]).index=t+1,a+=HtmlUtils.openTag("div",["class",s]),a+=HtmlUtils.openTag("div",["style","max-width:100%;overflow-x:auto;padding:0px;margin:px;"]),a+=HtmlUtils.div([ATTR_CLASS,"display-notebook-cell",ATTR_ID,h.id+"_cellinput"],""),a+=HtmlUtils.div([ATTR_CLASS,"display-notebook-cell",ATTR_ID,h.id+"_celloutput"],""),a+=HtmlUtils.closeTag("div"),a+=HtmlUtils.closeTag("div"),a+="\n",++r>=this.columns&&(r=0,a+=HtmlUtils.closeTag("div"),a+="<div class=row style='padding:0px;margin:0px;'>")}a+=HtmlUtils.closeTag("div"),this.jq(l).append(a)}for(t=0;t<this.cells.length;t++){var h;(h=this.cells[t]).createCell()}this.jq(p).html(this.makeConsole()),this.initConsole()},addCell:function(t,e,i){return cell=this.createCell(t,e),this.cells.push(cell),i||(this.showInput()&&"horizontal"==this.layout?(this.jq(o).append(HtmlUtils.div([ATTR_CLASS,"display-notebook-cell",ATTR_ID,cell.id+"_cellinput"],"")),this.jq(n).append(HtmlUtils.div([ATTR_CLASS,"display-notebook-cell",ATTR_ID,cell.id+"_celloutput"],""))):(this.jq(l).append(HtmlUtils.div([ATTR_CLASS,"display-notebook-cell",ATTR_ID,cell.id+"_cellinput"],"")),this.jq(l).append(HtmlUtils.div([ATTR_CLASS,"display-notebook-cell",ATTR_ID,cell.id+"_celloutput"],""))),cell.createCell()),cell},createCell:function(t,e){e||(e={showInput:!0});var i=this.getId()+"_"+this.cellCount;return e.id=i,this.cellCount++,this.jq(l).append(HtmlUtils.div([ATTR_CLASS,"display-notebook-cell",ATTR_ID,i],"")),new RamaddaNotebookCell(this,i,t,e)},clearOutput:function(){this.cells.forEach((t=>t.clearOutput()))},getIndex:function(t){for(var e=0,i=0;i<this.cells.length;i++)if(t.id==this.cells[i].id){e=i;break}return e},moveCellUp:function(t){var e=this.getIndex(t);0!=e&&(this.cells.splice(e,1),this.cells.splice(e-1,0,t),this.layoutCells(),t.focus())},moveCellDown:function(t){var e=this.getIndex(t);e!=this.cells.length-1&&(this.cells.splice(e,1),this.cells.splice(e+1,0,t),this.layoutCells(),t.focus())},newCellAbove:function(t){for(var e=[],i=null,a=0;a<this.cells.length;a++)t.id==this.cells[a].id&&(i=this.createCell("%%wiki\n",{showInput:!0,showHeader:!1}),e.push(i)),e.push(this.cells[a]);this.cells=e,this.layoutCells(),i.focus()},newCellBelow:function(t){for(var e=[],i=null,a=0;a<this.cells.length;a++)e.push(this.cells[a]),t.id==this.cells[a].id&&(i=this.createCell("%%wiki\n",{showInput:!0,showHeader:!1}),e.push(i));this.cells=e,this.layoutCells(),i.focus()},deleteCell:function(t){t.jq("cell").remove();var e=[];this.cells.forEach((i=>{t.id!=i.id&&e.push(i)})),this.cells=e,0==this.cells.length&&this.addCell("",null)},cellValues:{},setCellValue:function(t,e){this.cellValues[t]=e},getCellValues:function(){return this.cellValues},convertInput:function(t){for(name in this.cellValues){var e=new RegExp("\\$\\{"+name+"\\}","g");t=t.replace(e,this.cellValues[name])}return t},inGlobalChanged:!1,globalChanged:async function(t,e){var i=this.inGlobalChanged,a=!this.inGlobalChanged;this.inRunAll&&(a=!1),this.inGlobalChanged=!0,a&&this.cells.forEach((t=>t.prepareToRun()));for(var s=0;s<this.cells.length;s++)await this.cells[s].globalChanged(t,e);i||(this.inGlobalChanged=!1)},addGlobal:async function(t,e,i){t=t.trim().replace(/[ -]/g,"_");this.getGlobalValue(t);if(Utils.isDefined(window[t])&&(window[t]=e),this.globals[t]=e,!i)this.getGlobalValue(t)},getGlobalValue:function(t){return this.globals[t]?"function"==typeof this.globals[t]?this.globals[t]():this.globals[t]:null},inRunAll:!1,runAll:async function(){this.inRunAll=!0;var t=!0;this.cellValues={};for(var e=0;e<this.cells.length;e++){(i=this.cells[e]).prepareToRun()}for(e=0;e<this.cells.length;e++){(i=this.cells[e]).runFirst&&await this.runCell(i).then((e=>t=e))}if(t){for(e=0;e<this.cells.length;e++){var i;(i=this.cells[e]).runFirst||await this.runCell(i,!0).then((e=>t=e))}this.inRunAll=!1}},runCell:async function(t,e){if(t.hasRun)return!0;if(await t.run((t=>ok=t),{doingAll:e}),!ok)return!1;var i=t.getRawOutput();return i&&(i=i.trim(),Utils.stringDefined(t.cellName)&&(this.cellValues[t.cellName]=i)),!0},toggleAll:function(t){this.cells.forEach((e=>{e.showInput=t,e.applyStyle()}))}})}var iodide={addOutputRenderer:function(t){notebook.addOutputRenderer(t)},addOutputHandler:function(t){notebook.addOutputHandler(t)},output:{text:function(t){notebook.write(t)},element:function(t){var e=HtmlUtils.getUniqueId();return notebook.write(HtmlUtils.tag(t,["id",e])),document.getElementById(e)}}},notebook;function NotebookState(t,e){this.id=HtmlUtils.getUniqueId(),this.cell=t,this.notebook=t.notebook,$.extend(this,{entries:{},div:e,stopFlag:!1,result:null,log:function(t,e,i){this.getNotebook().log(t,e,i,this.div)},clearConsole:function(){this.getNotebook().clearConsole()},getStop:function(){return this.stopFlag},getCell:function(){return this.cell},addGlobal:async function(t,e){await this.getNotebook().addGlobal(t,e)},globalChanged:async function(t,e){await this.getNotebook().globalChanged(t,e)},setValue:function(t,e){this.notebook.setCellValue(t,e)},makeData:async function(t){t||await this.getCurrentEntry((e=>t=e)),"string"==typeof t&&await this.notebook.getEntry(t,(e=>t=e));var e=this.notebook.getPointUrl(t);if(null==e)return this.writeError("Not a point type:"+t.getName()),null;var i={entry:t,entryId:t.getId()};return new PointData(t.getName(),null,null,e,i)},log:function(t,e){this.getNotebook().log(t,e,"js")},getNotebook:function(){return this.notebook},save:function(t){return this.notebook.saveNotebook(t),"notebook saved"},clearEntries:function(){this.clearEntries()},ls:async function(t){var e=new Div;t||await this.getCurrentEntry((e=>t=e)),this.call.getEntryHeading(t,e),this.write(e.toString())},lsEntries:function(){var t="",e=this.currentEntries;for(var i in e){t+=i+"="+e[i].entry.getName()+"<br>"}this.write(t)},stop:function(){this.stopFlag=!0},setGlobal:async function(t,e){await this.cell.notebook.addGlobal(t,e)},setEntry:function(t,e){this.cell.notebook.addEntry(t,e)},getEntry:async function(t,e){return await this.cell.notebook.getEntry((t=>entry=t)),Utils.call(e,entry)},wiki:async function(t,e,i){if(!i){var a=new Div;this.div.append(a.toString()),i=t=>a.append(t)}null==e&&await this.cell.getCurrentEntry((t=>e=t)),"string"!=typeof e&&(e=e.getId()),await GuiUtils.loadHtml(ramaddaBaseUrl+"/wikify?doImports=false&entryid="+e+"&text="+encodeURIComponent(t),i)},addOutputRenderer:function(t){this.getNotebook().addOutputRenderer(t)},addOutputHandler:function(t){this.getNotebook().addOutputRenderer(t)},output:{text:function(t){notebook.write(t)},element:function(t){var e=HtmlUtils.getUniqueId();return notebook.write(HtmlUtils.tag(t,["id",e])),document.getElementById(e)}},clearOutput:function(){this.cell.clearOutput()},clearAllOutput:function(){this.getNotebook().clearOutput()},write:function(t,e){if(t){var i=this.getNotebook().formatOutput(t);null==i&&"object"==typeof t&&(i=this.notebook.formatObject(t)),e?this.div.set(i):this.div.append(i)}},linechart:async function(t,e){t||await this.cell.getCurrentEntry((e=>t=e)),this.cell.createDisplay(this,t,DISPLAY_LINECHART,e)}})}var notebookStates={};function RamaddaNotebookCell(t,e,i,a){this.notebook=t;var s="cell",l="header",r="cellname",o="input",n="inputtoolbar",h="output",d="menubutton",p="runbutton",g="cellnameinput",c="showheader",u="showedit",y="runonload",m="displaymode",f="layouttype",D="showconsole",I="layoutcolumns",T="runfirst",b="showoutput",S="runningicon";let v=new DisplayThing(e,{});RamaddaUtil.inherit(this,v),RamaddaUtil.defineMembers(this,{id:e,inputRows:1,index:0,content:i,outputHtml:"",showInput:!1,showHeader:!1,cellName:"",runFirst:!1,showOutput:!0}),a&&$.extend(this,a),RamaddaUtil.defineMembers(this,{getJson:function(t){var e={id:this.id,inputRows:this.inputRows,content:this.getInputText(),showInput:this.showInput,showHeader:this.showHeader,runFirst:this.runFirst,showOutput:this.showOutput,cellName:this.cellName};return this.currentEntry&&(e.currentEntryId=this.currentEntry.getId()),t&&(e.outputHtml=this.outputHtml),e},createCell:function(){null==this.content&&(this.content="%% wiki"),this.editId=addHandler(this),addHandler(this,this.editId+"_entryid"),addHandler(this,this.editId+"_wikilink");var t=this,e=this.makeButton(d,icon_menu,"Show menu","showmenu")+this.makeButton(p,Utils.getIcon("run.png"),"Run this cell","run")+this.makeButton(p,Utils.getIcon("runall.png"),"Run all","runall"),i=HtmlUtils.image(icon_blank,["align","right","id",this.getDomId(S),"style","padding-bottom:2px;padding-top:2px;padding-right:5px;"]);e=e+"&nbsp;"+HtmlUtils.span(["id",this.getDomId(r)],this.cellName),e+=i;for(var a=HtmlUtils.div([ATTR_CLASS,"display-notebook-header",ATTR_ID,this.getDomId(l),"tabindex","0","title","Click to toggle input\nShift-click to clear output"],"&nbsp;"+e),g="",c=this.content.split("\n"),u=!1,y=0;y<c.length;y++){var m=c[y],f=m.trim();f.startsWith("%%")&&(u=!!f.match(/^%% *meta/)),u||(g+=m+"\n")}g=g.replace(/</g,"&lt;").replace(/>/g,"&gt;");var D=HtmlUtils.div([ATTR_CLASS,"display-notebook-input ace_editor",ATTR_ID,this.getDomId(o),"title","shift-return: run chunk\nctrl-return: run to end"],g),I=HtmlUtils.div(["id",this.getDomId(n)],"");D=HtmlUtils.div(["class","display-notebook-input-container"],I+D);var T=HtmlUtils.div([ATTR_CLASS,"display-notebook-output",ATTR_ID,this.getDomId(h)],this.outputHtml);T=HtmlUtils.div(["class","display-notebook-output-container"],T);HtmlUtils.div(["id",this.getDomId("menu"),"class","ramadda-popup"],"");var b=a+D;b=HtmlUtils.div(["id",this.getDomId(s)],b),$("#"+this.id+"_cellinput").html(b),$("#"+this.id+"_celloutput").html(T);var v=ramaddaBaseUrl+"/wikitoolbar?doImports=false&entryid="+this.entryId+"&handler="+this.editId;v+="&extrahelp="+ramaddaBaseUrl+"/userguide/notebook.html|Notebook Help",GuiUtils.loadHtml(v,(t=>{this.inputToolbar=t,this.jq(n).html(t),$("#"+this.editId+"_prefix").html(HtmlUtils.span(["id",this.getDomId("toolbar_notebook"),"style","border-right:1px #ccc solid;","class","ramadda-menubar-button"],"Notebook")),this.jq("toolbar_notebook").click((()=>this.showNotebookMenu()))})),this.header=this.jq(l),this.header.click((t=>{t.shiftKey?this.processCommand("clear"):(this.hidePopup(),this.processCommand("toggle"))}));let x=new WikiEditor("","",this.getDomId(o),!1,{maxLines:30,minLines:5});this.editor=x.getEditor(),this.editor.getSession().on("change",(()=>{this.inputChanged()})),this.menuButton=this.jq(d),this.toggleButton=this.jq("togglebutton"),this.cell=this.jq(s),this.input=this.jq(o),this.output=this.jq(h),this.inputContainer=this.cell.find(".display-notebook-input-container"),this.inputMenu=this.cell.find(".display-notebook-input-container"),this.applyStyle(),this.header.find(".display-notebook-menu-button").click((function(e){t.processCommand($(this).attr("what")),e.stopPropagation()})),this.calculateInputHeight(),this.input.focus((()=>this.hidePopup())),this.input.click((()=>this.hidePopup())),this.output.click((()=>this.hidePopup())),this.input.on("input selectionchange propertychange",(()=>this.calculateInputHeight()));var U=e=>{var i=e.key;"v"==i&&e.ctrlKey?this.notebook.moveCellDown(t):6==i&&e.ctrlKey&&this.notebook.moveCellUp(t)};this.input.keydown(U),this.header.keydown(U),this.input.keydown((function(e){var i=e.key;"s"==i&&e.ctrlKey?t.notebook.saveNotebook(!1):"Enter"==i&&(e.shiftKey||e.ctrlKey)&&(e.preventDefault&&e.preventDefault(),e.shiftKey&&e.ctrlKey?t.run(null):(t.run(null,{justCurrent:!0,toEnd:e.ctrlKey}),e.ctrlKey||t.stepToNextChunk()))}))},selectClick(t,e,i,a){"entryid"==t?this.insertText(i):this.insertText("[["+i+"|"+a+"]]"),this.input.focus()},insertTags:function(t,e,i){var a=this.getDomId(o),s=GuiUtils.getDomObject(a);insertTagsInner(a,s.obj,t,e,i),this.calculateInputHeight()},insertText:function(t){var e=this.getDomId(o),i=GuiUtils.getDomObject(e);insertAtCursor(e,i.obj,t),this.calculateInputHeight()},showNotebookMenu:function(){var t=this.jq("toolbar_notebook");this.makeMenu(t,"left bottom")},makeButton:function(t,e,i,a){return a||(a="noop"),HtmlUtils.div(["what",a,"title",i,"class","display-notebook-menu-button","id",this.getDomId(t)],HtmlUtils.image(e,[]))},makeMenu:function(t,e){t||(t=this.input),t.is(":visible")||(t=this.header),t.is(":visible")||(t=this.output),e||(e="left top");let i=this;var a="&nbsp;&nbsp;",s="<div style='border-top:1px #ccc solid;margin-top:4px;margin-bottom:4px;'></div>",l="";l+=HtmlUtils.input(g,i.cellName,["placeholder","Cell name","style","width:100%;","id",i.getDomId(g)]),l+="<br>",l+="<table  width=100%> ",l+="<tr><td align=right><b>New cell:</b>&nbsp;</td><td>",l+=HtmlUtils.div(["class","ramadda-link","what","newabove"],"Above")+a,l+=HtmlUtils.div(["class","ramadda-link","what","newbelow"],"Below"),l+="</td></tr>",l+="<tr><td align=right><b>Move:</b>&nbsp;</td><td>",l+=HtmlUtils.div(["title","ctrl-^","class","ramadda-link","what","moveup"],"Up")+a,l+=HtmlUtils.div(["title","ctrl-v","class","ramadda-link","what","movedown"],"Down"),l+="</td></tr>",l+="</table>",l+=s,l+=HtmlUtils.div(["title","ctrl-return","class","ramadda-link","what","hideall"],"Hide all inputs"),l+="<br>",l+=HtmlUtils.div(["class","ramadda-link","what","clearall"],"Clear all outputs"),l+="<br>";this.notebook.columns,i.getDomId(I);l+="<b>Layout:</b> ",l+=HtmlUtils.checkbox(i.getDomId(f),[],"horizontal"==i.notebook.layout)+" Horizontal<br>",l+=s,l+=HtmlUtils.checkbox(i.getDomId(b),[],i.showOutput)+" Output enabled<br>",l+=HtmlUtils.checkbox(i.getDomId(D),[],i.notebook.showConsole)+" Show console<br>",l+=HtmlUtils.checkbox(i.getDomId(T),[],i.runFirst)+" Run first<br>",l+=HtmlUtils.checkbox(i.getDomId(y),[],i.notebook.runOnLoad)+" Run on load<br>",l+=HtmlUtils.div(["title","Don't show the left side and input for anonymous users"],HtmlUtils.checkbox(i.getDomId(m),[],i.notebook.displayMode)+" Display mode<br>"),l+=s,l+=HtmlUtils.div(["class","ramadda-link","what","savewithout"],"Save notebook")+"<br>",l+=s,l+=HtmlUtils.div(["class","ramadda-link","what","delete"],"Delete cell")+"<br>",l+=HtmlUtils.div(["class","ramadda-link","what","help"],"Help")+"<br>",l=HtmlUtils.div(["class","display-notebook-menu"],l);var r=this.getPopup();this.dialogShown=!0,r.html(HtmlUtils.div(["class","ramadda-popup-inner"],l)),r.show(),r.position({of:t,my:"left top",at:e,collision:"fit fit"}),i.jq(c).focus(),i.jq(D).change((function(t){i.notebook.showConsole=i.jq(D).is(":checked"),i.hidePopup(),i.notebook.layoutCells()})),i.jq(c).change((function(t){i.showHeader=i.jq(c).is(":checked"),i.applyStyle()})),i.jq(T).change((function(t){i.runFirst=i.jq(T).is(":checked")})),i.jq(b).change((function(t){i.showOutput=i.jq(b).is(":checked"),i.applyStyle()})),i.jq(y).change((function(t){i.notebook.runOnLoad=i.jq(y).is(":checked")})),i.jq(m).change((function(t){i.notebook.displayMode=i.jq(m).is(":checked")})),i.jq(u).change((function(t){i.showInput=i.jq(u).is(":checked"),i.applyStyle()})),i.jq(f).change((function(t){i.jq(f).is(":checked")?i.notebook.layout="horizontal":i.notebook.layout="vertical",i.hidePopup(),i.notebook.layoutCells()})),i.jq(I).keypress((function(t){if(13==(t.keyCode||t.which)){var e=parseInt(i.jq(I).val());isNaN(e)?i.jq(I).val("bad:"+i.jq(I).val()):i.hidePopup()}})),i.jq(g).keypress((function(t){13!=(t.keyCode||t.which)||i.hidePopup()})),r.find(".ramadda-link").click((function(){var t=$(this).attr("what");i.processCommand(t)}))},hidePopup:function(){var t=this.getPopup();if(t&&this.dialogShown){var e=parseInt(this.jq(I).val());this.cellName=this.jq(g).val(),this.jq(r).html(this.cellName),t.hide(),this.applyStyle(),isNaN(e)||this.notebook.columns==e||(this.notebook.columns=e,this.notebook.layoutCells())}this.dialogShown=!1},processCommand:function(t){if("showmenu"!=t){if("toggle"==t)this.showInput=!this.showInput,this.applyStyle(!0);else if("showthis"==t)this.showInput=!0,this.applyStyle();else if("hidethis"==t)this.showInput=!1,this.applyStyle();else if("showall"==t)this.notebook.toggleAll(!0);else if("hideall"==t)this.notebook.toggleAll(!1);else if("run"==t)this.notebook.runCell(this);else if("runall"==t)this.notebook.runAll();else if("clear"==t)this.clearOutput();else if("clearall"==t)this.notebook.clearOutput();else if("moveup"==t)this.notebook.moveCellUp(this);else if("movedown"==t)this.notebook.moveCellDown(this);else if("newabove"==t)this.notebook.newCellAbove(this);else if("newbelow"==t)this.notebook.newCellBelow(this);else if("savewith"==t)this.notebook.saveNotebook(!0);else if("savewithout"==t)this.notebook.saveNotebook(!1);else if("help"==t){window.open(ramaddaBaseUrl+"/userguide/notebook.html","_blank").focus()}else{if("delete"==t)return void this.askDelete();console.log("unknown command:"+t)}this.hidePopup()}else this.makeMenu()},shouldShowInput:function(){return this.showInput&&this.notebook.showInput()},applyStyle:function(t){this.shouldShowInput()?(this.jq(n).css("display","block"),this.inputContainer.show(400,(()=>this.editor.resize())),this.showHeader=!0):(this.jq(n).css("display","none"),this.inputContainer.hide(t?200:0),this.showHeader=!1),this.showHeader=this.notebook.showInput(),this.showHeader?this.header.css("display","block"):this.header.css("display","none"),this.showOutput?this.output.css("display","block"):this.output.css("display","none")},getPopup:function(){return this.notebook.getPopup()},askDelete:function(){let t=this;var e="";e+="Are you sure you want to delete this cell?<br>",e+=HtmlUtils.span(["class","ramadda-link","what","yes"],"Yes"),e+=HtmlUtils.span(["style","margin-left:50px;","class","ramadda-link","what","cancel"],"No");var i=this.getPopup();i.html(HtmlUtils.div(["class","ramadda-popup-inner"],e)),i.show();var a=this.input;a.is(":visible")||(a=this.output),a.is(":visible")||(a=this.header),i.position({of:a,my:"left top",at:"left top",collision:"fit fit"}),i.find(".ramadda-link").click((function(){var e=$(this).attr("what");t.hidePopup(),"yes"==e&&t.notebook.deleteCell(t)}))},inputChanged:function(){for(var t=this.getInputText(),e=t.split("\n"),i=this.editor.getCursorPosition().row;i>=0;i--){var a=e[i].trim();if(a.startsWith("%%")){var s=a.substring(2).trim();if(s.startsWith("md")||s.startsWith("html")||s.startsWith("css")||s.startsWith("raw")){var l={};l[i]=!0,this.runInner(t,l)}break}}},stepToNextChunk:function(){for(var t=this.getInputText().split("\n"),e=this.editor.getCursorPosition().row+1;e<t.length;e++)if(t[e].trim().startsWith("%%")){var i=t[e].length;this.editor.selection.moveTo(e,i),this.editor.scrollToLine(e,!0,!0,(function(){}));break}},run:async function(t,e){e||(e={});var i=e.justCurrent,a=e.toEnd,s=e.doingAll;if(this.running)return Utils.call(t,!0);this.running=!0;var l=null;try{var r=!0,o=this.getInputText();if(i){l={};var n=this.editor.getCursorPosition().row,h=o.split("\n");if(a){for(i=!1;n>=0&&!h[n].trim().startsWith("%%");)n--;for(n<0&&(n=0);n<h.length;)l[n]=!0,n++}else{for(n++;n<h.length;){if(h[n].trim().startsWith("%%")){n--;break}n++}for(n>=h.length&&(n=h.length-1);n>=0;){var d=h[n].trim();if(l[n]=!0,d.startsWith("%%"))break;n--}}}if(this.jq(S).attr("src",icon_progress),await this.runInner(o,l,s).then((t=>r=t)),this.jq(S).attr("src",icon_blank),!r)return this.running=!1,Utils.call(t,!1);this.outputUpdated()}catch(e){return this.jq(S).attr("src",icon_blank),this.running=!1,this.writeOutput("An error occurred:"+e.toString()+" "+typeof e),console.log("error:"+e.toString()),e.stack&&console.log(e.stack),Utils.call(t,!1)}return this.running=!1,Utils.call(t,!0)},prepareToLayout:function(){this.content=this.getInputText()},getInputText:function(){return this.editor?this.editor.getValue():this.content},globalChanged:async function(t,e){for(var i=0;i<this.chunks.length;i++){var a=this.chunks[i];if(!a.hasRun&&a.depends.includes(t)){var s=!0;if(await this.runChunk(a,(t=>s=t)),!s)break}}},prepareToRun:function(){this.hasRun=!1,this.chunks&&this.chunks.forEach((t=>t.hasRun=!1))},runInner:async function(t,e,i){t=(t=t.trim()).replace(/{cellname}/g,this.cellName),t=this.notebook.convertInput(t),this.chunks||(this.chunks=[]);for(var a=this.chunks,s="wiki",l="",r=t.split("\n"),o=null,n=0,d=(t,e,i,s,l)=>{var r=Utils.parseAttributes(l);r.type=e,r.doChunk=s,r.content=i;var h=n<a.length?a[n]:null;return n++,h&&0==h.div.jq().length&&(h=null),h?h.initChunk(r):(h=new NotebookChunk(t,r),a.push(h),h.skipOutput||(o?o.div.jq().after(h.div.toString()):t.output.html(h.div.toString()))),o=h,h.div.jq().show(),h},p="",g=!0,c=0;c<r.length;c++){var u=r[c],y=u.trim();if(!y.startsWith("//"))if(y.startsWith("%%")){var m,f=y.substring(2).trim(),D=f.indexOf(" ");D<0?(m=f,f=""):(m=f.substring(0,D).trim(),f=f.substring(D)),""!=p&&d(this,s,p,g,l),g=!e||e[c],""!=(p="")&&(p+="\n"),""!=m&&(s=m),l=f}else p=p+u+"\n"}""!=p&&d(this,s,p,g,l),this.chunkMap={};for(var I=0;I<this.chunks.length;I++){var T=this.chunks[I];T.name&&(this.chunkMap[T.name]=T)}for(I=n;I<this.chunks.length;I++)this.chunks[I].div.jq().hide();this.rawOutput="";var b=!0;return await this.runChunks(this.chunks,i,!0,(t=>b=t)),!!b&&(await this.runChunks(this.chunks,i,!1,(t=>b=t)),!!b&&(Utils.initContent("#"+this.getDomId(h)),!0))},runChunks:async function(t,e,i,a){for(var s=0;s<t.length;s++){var l=t[s],r=!0;if((!0!==i||l.props.runfirst)&&((!1!==i||!0!==l.props.runfirst)&&(!e||!0!==l.props.skiprunall)&&l.doChunk&&(await this.runChunk(l,(t=>r=t)),!r)))return Utils.call(a,!1)}return Utils.call(a,!0)},runChunk:async function(t,e){if(t.hasRun)return Utils.call(e,!0);t.ok=!0,t.div.set(""),t.hasRun=!0;for(var i=0;i<t.depends.length;i++){var a=t.depends[i];if(this.chunkMap[a]&&!this.chunkMap[a].hasRun){var s=!0,l=this.chunkMap[a];if(await this.runChunk(l,!1,null,(t=>s=t)),!s||!l.ok)return Utils.call(e,!1)}}if(await this.processChunk(t),t.ok){if(t.name&&"string"==typeof t.name){a=t.name.trim();t.output?""!=a&&await this.notebook.addGlobal(a,t.output):await this.notebook.addGlobal(a,null)}return Utils.call(e,!0)}Utils.call(e,!1)},writeOutput:function(t){if(!this.output)return err=new Error,void console.log("no output:"+err.stack);this.output.html(t),this.outputUpdated()},outputUpdated:function(){this.outputHtml=this.jq(h).html()},getRawOutput:function(){return this.rawOutput},focus:function(){this.input.focus()},clearOutput:function(){this.chunks&&this.chunks.forEach((t=>t.div.set(""))),this.outputHtml=""},processHtml:async function(t){var e=t.getContent();e.match("%\n*$")&&(e=(e=e.trim()).substring(0,e.length-1)),this.rawOutput+=e+"\n",t.output=e,t.div.set(e)},processCss:async function(t){var e=HtmlUtils.tag("style",["type","text/css"],t.getContent());this.rawOutput+=e+"\n",t.output=e,t.div.set(e)},handleError:function(t,e,i){t.ok=!1,console.log("An error occurred:"+e),this.notebook.log(e,"error",i,t.div)},getFetchUrl:async function(t,e,i){return(t=Utils.replaceRoot(t)).match(/^[a-z0-9]+-[a-z0-9].*/)?Utils.call(i,ramaddaBaseUrl+"/entry/get?entryid="+t):t.startsWith("http")||!(t.startsWith("/")&&!t.startsWith(ramaddaBaseUrl)||t.startsWith(".."))&&t.startsWith("/")?Utils.call(i,t):(await this.getEntryFromPath(t,(t=>a=t)),a?Utils.call(i,ramaddaBaseUrl+"/entry/get?entryid="+a.getId()):Utils.call(i,null));var a},processFetch:async function(t){for(var e=t.getContent().split("\n"),i=0;i<e.length;i++){var a=e[i].trim();if(""!=a){var s=a,l=null,r="";if((o=a.indexOf(":"))<0)return void this.handleError(t,"Bad fetch line:"+a,"io");var o,n=a.substring(0,o);(o=(a=a.substring(o+1).trim()).indexOf(" //"))>=0&&(a=a.substring(0,o).trim());var h=null,d=null;if(["text","json","blob"].includes(n)){var p=a.match(/^([a-zA-Z0-9_]+) *= *(.*)$/);p&&(d=p[1],a=p[2].trim(),r=" (var "+d+")")}if(await this.getFetchUrl(a,n,(t=>h=t)),!h)return void this.handleError(t,"Unable to get entry url:"+a,"io");if("js"==n){if(h.match("jquery-.*\\.js"))return;await Utils.importJS(h,(()=>{}),((t,e,i)=>{l="Error fetching "+s+" "+(i?i.toString():"")}),!1)}else if("css"==n)await Utils.importCSS(h,null,((t,e,i)=>l="Error fetching "+s+" "+i),!0);else if("html"==n)await Utils.doFetch(h,(e=>t.div.append(e)),((t,e,i)=>l="Error fetching "+s+" "+i));else if("text"==n||"json"==n||"blob"==n){var g="json"==n,c="blob"==n,u=null;await Utils.doFetch(h,(t=>u=t),((t,e,i)=>l="Error fetching "+s+" error:"+(i?i.toString():"")),"blob"==n?"blob":"text"),u&&(g?"string"==typeof u&&(u=JSON.parse(u)):c&&(u=new Blob([u],{})),d?await this.notebook.addGlobal(d,u):g?t.div.append(Utils.formatJson(u)):t.div.append(HtmlUtils.pre(["style","max-width:100%;overflow-x:auto;"],u)))}else l="Unknown fetch:"+s;if(l)return void this.handleError(t,l,"io");this.notebook.log("Loaded: "+h+r,"output","io")}}},processMd:async function(t){var e=t.getContent();this.rawOutput+=e+"\n",e.match("%\n*$")&&(e=(e=e.trim()).substring(0,e.length-1));for(var i="",a=null,s=e.split("\n"),l=[],r=0;r<s.length;r++){var o=s[r];if(o.trim().startsWith("$$"))if(null!=a){try{var n=katex.renderToString(a,{throwOnError:!0});i+="tex:"+l.length+":\n",l.push(n)}catch(t){i+="Error parsing tex:"+t+"<pre>"+a+"</pre>"}a=null}else a="";else null!=a?a+=o+"\n":i+=o+"\n"}for(n=(new showdown.Converter).makeHtml(i),r=0;r<l.length;r++)n=n.replace("tex:"+r+":",l[r]);var h=HtmlUtils.div(["class","display-notebook-md"],n);t.output=n,t.div.set(h)},processPy:async function(t){this.notebook.loadedPyodide||(t.div.set("Loading Python..."),await Utils.importJS(ramaddaBaseHtdocs+"/lib/pyodide/pyodide.js"),await languagePluginLoader.then((()=>{pyodide.runPython("import sys\nsys.version;")}),(t=>console.log("error:"+t))),await pyodide.loadPackage(["numpy","cycler","pytz","matplotlib"]),t.div.set(""),this.notebook.loadedPyodide=!0),pyodide.runPython(t.getContent())},processPlugin:async function(t){var e=JSON.parse(t.getContent());await this.notebook.addPlugin(e,t)},processWiki:async function(t){this.rawOutput+=t.getContent()+"\n";var e=this.notebook.getProperty("entryId","");await this.getCurrentEntry((t=>entry=t)),entry&&(e=entry.getId());let i=HtmlUtils.getUniqueId();t.getContent();await GuiUtils.loadHtml(ramaddaBaseUrl+"/wikify?doImports=false&entryid="+e+"&text="+encodeURIComponent(t.getContent()),(function(e){var a=HtmlUtils.div(["id",i,"style"],e);t.div.set(a),t.output=a}))},processSh:async function(t){for(var e="",i=t.getContent().split("\n"),a=[],s=0;s<i.length;s++){var l=i[s].trim();if(""!=l)for(var r=l.split(";"),o=0;o<r.length;o++){var n=r[o].trim();if(""!=n&&!n.startsWith("#")&&!n.startsWith("//")){var h=n.split(" "),d=h[0].trim(),p=null,g=null;this["processCommand_"+d]?p=this["processCommand_"+d]:(p=this.processCommand_help,g="Unknown command: <i>"+d+"</i>");var c=new Div("");a.push({proc:p,line:n,toks:h,extra:g,div:c}),e+=c.set("")}}}let u=this;t.div.set(e);s=0;for(s=0;s<a.length;s++){var y=a[s];y.extra&&y.div.append(g),await y.proc.call(u,y.line,y.toks,y.div,y.extra)}},processJs:async function(t,e){var i,a=0;if(await this.getCurrentEntry((t=>{current=t})),!notebookStates[e.id])throw new Error("Null NB:"+e.id);try{var s=this.notebook.getCurrentEntries();for(name in s)e.entries[name]=s[name].entry;var l="";e.entries.current=current,e.entries.parent=this.parentEntry,e.entries.base=this.notebook.getBaseEntry(),e.entries.root=this.notebook.getRootEntry();var r="notebookStates['"+e.id+"']";for(name in a++,l+="var notebook= "+r+";\n",a++,e.entries){var o=e.entries[name];a++,l+="var "+name+"= notebook.entries['"+name+"'];\n"}for(name in this.notebook.cellValues){var n=name.replace(/ /g,"_").replace(/[^a-zA-Z0-9_]+/g,"_");a++,l+="var "+n+"= notebook.getNotebook().cellValues['"+name+"'];\n"}for(name in this.notebook.globals)name=name.trim(),""!=name&&(a++,l+="var "+name+"= notebook.getNotebook().getGlobalValue('"+name+"');\n");var h=t.getContent().trim();i=h.split("\n"),h=l+"\n"+h;var d=eval.call(null,h);e.getStop()&&(t.ok=!1);var p="";if(null!=d){t.output=d;var g=this.notebook.formatOutput(d);if(null!=g)p=g,this.rawOutput+=p+"\n";else{var c=typeof d;"object"!=c&&"function"!=c&&(p=d,this.rawOutput+=p+"\n")}}t.div.append(p)}catch(o){t.ok=!1;var u=i[o.lineNumber-a-1];console.log("Error:"+o.stack),this.notebook.log("Error: "+o.message+"<br>&gt;"+(u||""),"error","js",t.div)}},processChunk:async function(t){var e=new NotebookState(this,t.div);if(window.notebook=e,notebookStates[e.id]=e,"html"==t.type)await this.processHtml(t,e);else if("plugin"==t.type)await this.processPlugin(t,e);else if("wiki"==t.type)await this.processWiki(t,e);else if("css"==t.type)await this.processCss(t,e);else if("fetch"==t.type)await this.processFetch(t,e);else if("raw"==t.type){var i=t.getContent();t.output=i,this.rawOutput+=i}else if("js"==t.type)await this.processJs(t,e);else if("sh"==t.type)await this.processSh(t,e);else if("meta"==t.type);else if("md"==t.type)await this.processMd(t,e);else if("py"==t.type)await this.processPy(t,e);else{var a,s;if(await this.notebook.hasPlugin(t.type,(t=>a=t)),a)return t.div.set(""),await this.notebook.processChunkWithPlugin(t.type,t,(t=>s=t)),void(s&&this.notebook.processPluginOutput(t.type,t,s));this.notebook.log("Unknown type:"+t.type,"error",null,t.div),t.ok=!1}delete notebookStates[e.id],e.getStop()&&(t.ok=!1)},calculateInputHeight:function(){if(this.content=this.getInputText(),this.content){var t=this.content.split("\n");t.length!=this.inputRows&&(this.inputRows=t.length,this.input.attr("rows",Math.max(1,this.inputRows)))}},writeStatusMessage:function(t){var e=this.jq("message");t?(e.show(),e.position({of:this.getOutput(),my:"left top",at:"left+4 top+4",collision:"none none"}),e.html(t)):(e.hide(),e.html(""))},handleControlKey:function(t){t.which},getOutput:function(){return this.jq(h)},getInput:function(){return this.jq(o)},writeResult:function(t){this.writeStatusMessage(null),t=HtmlUtils.div([ATTR_CLASS,"display-notebook-result"],t);var e=this.jq(h);e.append(t),e.animate({scrollTop:e.prop("scrollHeight")},1e3),this.currentOutput=e.html(),this.currentInput=this.getInputText()},writeError:function(t){this.writeStatusMessage(t)},header:function(t){return HtmlUtils.div([ATTR_CLASS,"display-notebook-header"],t)},processCommand_help:function(t,e,i,a,s){null==i&&(i=new Div);var l="";return null!=s&&(l+=s),l+="<pre>pwd, ls, cd</pre>",i.append(l)},entries:{},selectEntry:function(t){for(var e=1,i=this.notebook.getCurrentEntries();i["entry"+e];)e++;var a=prompt("Set an ID","entry"+e);null!=a&&""!=a.trim()&&this.notebook.addEntry(a,t)},setId:function(t){this.editor.getCursorPosition();this.editor.insert(t)},cdEntry:function(t){var e=new Div("");this.currentEntry=this.entries[t],notebookState.entries.current=this.currentEntry,this.output.html(e.toString()),this.processCommand_pwd("pwd",[],e),this.outputUpdated()},addToToolbar:function(t,e,i){var a="getHandler('"+t+"').setId('"+e.getId()+"')",s=HtmlUtils.image(ramaddaBaseUrl+"/icons/setid.png",["border",0,ATTR_TITLE,"Set ID in Input"]);i.unshift(HtmlUtils.tag(TAG_A,["onclick",a],s));a="getHandler('"+t+"').selectEntry('"+e.getId()+"')",s=HtmlUtils.image(ramaddaBaseUrl+"/icons/circle-check.png",["border",0,ATTR_TITLE,"Select Entry"]);i.unshift(HtmlUtils.tag(TAG_A,["onclick",a],s))},getEntryPrefix:function(t,e){this.entries[e.getId()]=e;var i="getHandler('"+t+"').cdEntry('"+e.getId()+"')";return HtmlUtils.div(["style","padding-right:4px;","title","cd to entry","onclick",i,"class","ramadda-link"],HtmlUtils.image(ramaddaBaseUrl+"/icons/go.png"))},displayEntries:function(t,e){if(null==e&&(e=new Div),this.currentEntries=t,null==t||0==t.length)return e.msg("No children");var i=addHandler(this),a=this.notebook.getEntriesTree(t,{handlerId:i,showIndex:!1,suffix:Utils.getUniqueId("_shell_")});e.set(HtmlUtils.div(["style","max-height:200px;overflow-y:auto;"],a)),this.outputUpdated()},getEntryFromArgs:function(t,e){var i=this.currentEntries;if(null==i)return e;for(var a=0;a<t.length;a++){var s=t[a];if(s.match("^d+$")){var l=parseInt(s);break}if("-entry"==s)return a++,(l=parseInt(t[a])-1)<0||l>=i?void this.writeError("Bad entry index:"+l+" should be between 1 and "+i.length):i[l]}return e},setCurrentEntry:async function(t){this.currentEntry=t,this.parentEntry=null,this.currentEntry&&await this.currentEntry.getParentEntry((t=>{this.parentEntry=t}))},getCurrentEntry:async function(t){if(null==this.currentEntry&&await this.setCurrentEntry(this.notebook.getBaseEntry()),null==this.currentEntry){if(Utils.isDefined(dflt))return dflt;this.rootEntry=new Entry({id:ramaddaBaseEntry,name:"Root",type:"group"}),this.currentEntry=this.rootEntry}return Utils.call(t,this.currentEntry)},createDisplay:async function(t,e,i,a){if(e||await this.getCurrentEntry((t=>e=t)),"string"==typeof e&&await this.notebook.getEntry(e,(t=>e=t)),!t.displayManager){var s=HtmlUtils.getUniqueId();t.div.append(HtmlUtils.div(["id",s],"")),t.displayManager=new DisplayManager(s,{showMap:!1,showMenu:!1,showTitle:!1,layoutType:"table",layoutColumns:1,defaultMapLayer:"osm",entryId:""})}s=HtmlUtils.getUniqueId();t.div.append(HtmlUtils.div(["id",s],"DIV"));var l={layoutHere:!0,divid:s,showMenu:!0,sourceEntry:e,entryId:e.getId(),showTitle:!0,showDetails:!0,title:e.getName()};if(a&&$.extend(l,a),!l.data&&i!=DISPLAY_ENTRYLIST){var r=this.notebook.getPointUrl(e);if(null==r)return void this.writeError("Not a point type:"+e.getName());null==r&&(r=this.getPointUrl(e));var o={entry:e,entryId:e.getId()};l.data=new PointData(e.getName(),null,null,r,o)}t.displayManager.createDisplay(i,l)},createPointDisplay:async function(t,e){await this.getCurrentEntry((t=>current=t));var i=this.getEntryFromArgs(t,currentEntry),a=this.notebook.getPointUrl(i);null!=a?this.notebook.createDisplay(i.getId(),e,a):this.writeError("Not a point type:"+i.getName())},processCommand_table:function(t,e){this.createPointDisplay(e,DISPLAY_TABLE)},processCommand_linechart:function(t,e){this.createPointDisplay(e,DISPLAY_LINECHART)},processCommand_barchart:function(t,e){this.createPointDisplay(e,DISPLAY_BARCHART)},processCommand_bartable:function(t,e){this.createPointDisplay(e,DISPLAY_BARTABLE)},processCommand_hello:function(t,e){this.writeResult("Hello, how are you?")},processCommand_scatterplot:function(t,e){this.createPointDisplay(e,DISPLAY_SCATTERPLOT)},processCommand_blog:function(t,e){this.getLayoutManager().publish("blogentry")},getEntryHeading:function(t,e){var i=[t],a=addHandler(this),s=this.notebook.getEntriesTree(i,{handlerId:a,showIndex:!1,suffix:Utils.getUniqueId("_shell_")});return e.set(HtmlUtils.div(["style","max-height:200px;overflow-y:auto;"],s)),e},processCommand_pwd:async function(t,e,i){return null==i&&(i=new Div),await this.getCurrentEntry((t=>entry=t)),this.getEntryHeading(entry,i)},processCommand_set:async function(t,e,i){if(null==i&&(i=new Div),e.length<2)i.append("Error: usage: set &lt;name&gt; &lt;value&gt;");else{var a,s=e[1];if(2==e.length)(a=this.notebook.getGlobalValue(s))?i.append(a):i.append("Unknown: "+s);else a=(a=Utils.join(e," ",2)).replace(/\"/g,""),await this.notebook.addGlobal(s,a)}},processCommand_clearEntries:function(t,e,i){this.notebook.clearEntries(),i.set("Entries cleared")},processCommand_printEntries:async function(t,e,i){var a="";await this.getCurrentEntry((t=>current=t)),a+="current="+current.getName()+"<br>";var s=this.notebook.getCurrentEntries();for(var l in s){a+=l+"="+s[l].entry.getName()+"<br>"}""==a&&(a="No entries"),i.set(a)},processCommand_echo:async function(t,e,i){t=t.replace(/^echo */,""),i.set(t)},processCommand_print:async function(t,e,i){t=t.replace(/^print */,""),i.set(t)},processCommand_info:async function(t,e,i){await this.getCurrentEntry((t=>entry=t)),i.append("current:"+entry.getName()+" id:"+entry.getId()+"<br>")},processCommand_cd:async function(t,e,i){if(null==i&&(i=new Div),e.length<=1)await this.setCurrentEntry(this.notebook.getBaseEntry());else{var a,s=Utils.join(e," ",1).trim();await this.getEntryFromPath(s,(t=>a=t)),a?await this.setCurrentEntry(a):i.msg("Could not get entry:"+s)}},getEntryFromPath:async function(t,e){var i;await this.getCurrentEntry((t=>i=t)),t.startsWith("/")&&await i.getRoot((t=>{i=t}));for(var a=t.split("/"),s=0;s<a.length;s++){var l=a[s];if(""!=l)if(".."==l){if(await i.getParentEntry((t=>{i=t})),!i)break}else{await i.getChildrenEntries((t=>children=t));var r=null,o=!1,n=!1;l.endsWith("*")&&(l=l.substring(0,l.length-1),o=!0),l.startsWith("*")&&(l=l.substring(1),n=!0);for(var h=0;h<children.length;h++){var d=children[h].getName();if(o&&n){if(d.includes(l)){r=children[h];break}}else if(o){if(d.startsWith(l)){r=children[h];break}}else if(n&&d.endsWith(l)){r=children[h];break}if(children[h].getName()==l){r=children[h];break}}if(!r)break;i=r}}return Utils.call(e,i)},processCommand_ls:async function(t,e,i){null==i&&(i=new Div),i.set("Listing entries..."),await this.getCurrentEntry((t=>entry=t)),await entry.getChildrenEntries((t=>{this.displayEntries(t,i)}),"")},entryListChanged:function(t){var e=t.getEntries();0==e.length?this.writeStatusMessage("Sorry, nothing found"):this.displayEntries(e)},processCommand_search:async function(t,e,i){for(var a="",s=1;s<e.length;s++)a+=e[s]+" ";a=a.trim();var l=new EntrySearchSettings({text:a}),r=this.notebook.getRamadda().getSearchUrl(l,OUTPUT_JSON);let o=this;var n={entryListChanged:function(t){var e=t.getEntries();i.set(""),0==e.length?i.append("Nothing found"):o.displayEntries(e,i)}},h=new EntryList(this.notebook.getRamadda(),r,n,!1);i.set("Searching..."),await h.doSearch()},processCommand_clear:function(t,e,i){this.clearOutput()},processCommand_save:function(t,e,i){this.notebook.saveNotebook()}})}function processLispOutput(t){return t&&t.val?t.val:Utils.formatJson(t)}function NotebookChunk(t,e){for(name in e)e[name.toLowerCase()]=e[name];this.div=new Div(null,"display-notebook-chunk"),this.cell=t,$.extend(this,{getContent:function(){var t=this.content;for(name in this.cell.notebook.globals){var e=this.cell.notebook.getGlobalValue(name);"object"==typeof e&&(e=Utils.formatJson(e)),t=t.replace("${"+name.trim()+"}",e)}return t},initChunk:function(t){this.skipOutput=!1,!0===t.skipoutput&&(this.skipOutput=!0,this.div.set(""),this.div=new Div);var e=[];t.depends&&"string"==typeof t.depends&&(e=t.depends.split(","));for(var i=t.content||"",a=RegExp(/\${([^ }]+)}/g);null!==(result=a.exec(i));){var s=result[1];e.includes(s)||e.push(s)}$.extend(this,{name:t.name,depends:e,output:null,runFirst:t.runFirst,hasRun:!1,content:i,type:t.type,props:t,doChunk:!!t.doChunk,ok:!0})}}),this.initChunk(e)}const DISPLAY_D3_GLIDER_CROSS_SECTION="GliderCrossSection",DISPLAY_D3_LINECHART="D3LineChart",DISPLAY_SKEWT="skewt",DISPLAY_VENN="venn",DISPLAY_CHERNOFF="chernoff",DISPLAY_D3BUBBLE="d3bubble",DISPLAY_MINIDOTS="minidots";addGlobalDisplayType({type:DISPLAY_D3_LINECHART,forUser:!1,label:"D3 LineChart",requiresData:!0,category:"Charts"}),addGlobalDisplayType({type:DISPLAY_D3_GLIDER_CROSS_SECTION,forUser:!1,label:"Glider cross section",requiresData:!0,category:CATEGORY_MISC}),addGlobalDisplayType({type:DISPLAY_VENN,forUser:!0,label:"Venn Diagram",requiresData:!0,category:CATEGORY_MISC,tooltip:makeDisplayTooltip("A Venn diagram","venn.png")}),addGlobalDisplayType({type:DISPLAY_MINIDOTS,forUser:!1,label:"Mini Dots",requiresData:!0,category:CATEGORY_MISC}),addGlobalDisplayType({type:DISPLAY_CHERNOFF,forUser:!1,label:"Chernoff Faces",requiresData:!0,category:CATEGORY_MISC}),addGlobalDisplayType({type:DISPLAY_D3BUBBLE,forUser:!0,label:"Bubble Chart",requiresData:!0,category:CATEGORY_IMAGES,tooltip:makeDisplayTooltip("Animated bubbles showing images","d3bubble.png")}),addGlobalDisplayType({type:DISPLAY_SKEWT,forUser:!1,label:"SkewT",requiresData:!0,category:CATEGORY_MISC});const FIELD_TIME="time",FIELD_DEPTH="depth",FIELD_VALUE="value",FIELD_SELECTEDFIELD="selectedfield",TYPE_LATITUDE="latitude",TYPE_LONGITUDE="longitude",TYPE_TIME="time",TYPE_VALUE="value",TYPE_ELEVATION="elevation",FUNC_MOVINGAVERAGE="movingAverage",D3Util={foo:"bar",getAxis:function(t,e){return t==FIELD_TIME?d3.time.scale().range(e):d3.scale.linear().range(e)},getDataValue:function(t,e,i){var a;if(t.fieldIdx>=0)a=e.getData()[t.fieldIdx];else switch(t.type){case TYPE_TIME:a=new Date(e.getDate());break;case TYPE_ELEVATION:a=e.getElevation();break;case TYPE_LATITUDE:a=e.getLatitude();case TYPE_LONGITUDE:a=e.getLongitude();default:a=e.getData()[i]}return 1==t.reverse?-1*a:a},getColorFromColorBar:function(t,e){var i=["#00008B","#0000CD","#0000FF","#00FFFF","#7CFC00","#FFFF00","#FFA500","#FF4500","#FF0000","#8B0000"],a=d3.scale.linear().domain([0,i.length-1]).range(e),s=d3.scale.linear().range(i).domain(d3.range(0,i.length).map(a));return color=s(t),color},addColorBar:function(t,e,i,a){var s=t.append("g").attr({id:"colorBarG",transform:"translate("+(a-40)+",0)"});return s.append("g").append("defs").append("linearGradient").attr({id:"colorBarGradient",x1:"0%",y1:"100%",x2:"0%",y2:"0%"}).selectAll("stop").data(e).enter().append("stop").attr({offset:function(t,e){return i*e+"%"},"stop-color":function(t,i){return e[i]},"stop-opacity":1}),s}};function RamaddaSkewtDisplay(t,e,i){const s="skewtdate",l=new RamaddaDisplay(t,e,DISPLAY_SKEWT,i);defineDisplay(addRamaddaDisplay(this),l,[{label:"Skewt Attributes"},{p:"skewtWidth",ex:"500"},{p:"skewtHeight",ex:"550"},{p:"hodographWidth",ex:"150"},{p:"showHodograph",ex:"false"},{p:"windStride",ex:"1"},{p:"showText",ex:"false"}],{needsData:function(){return!0},initDisplay:function(){l.initDisplay.call(this)},handleEventPointDataLoaded:function(t,e){this.updateUI()},updateUI:async function(){if(!this.loadedResources){new Date;await Utils.importCSS(ramaddaCdn+"/lib/skewt/sounding.css"),await Utils.importJS(ramaddaCdn+"/lib/skewt/d3skewt.js"),this.loadedResources=!0}if(!window.D3Skewt)return void setTimeout((()=>this.updateUI()),100);l.updateUI.call(this);let t=this.filterData();if(!t||0==t.length)return void this.setDisplayMessage(this.getLoadingMessage());let e=this.getDomId("skewt"),i=HtmlUtils.div(["id",e],"");this.setContents(i);var r=t[0].getDate();0==this.jq(s).length&&this.jq(ID_TOP_LEFT).append(HtmlUtils.div([ID,this.getDomId(s)])),null!=r?this.jq(s).html("Date: "+this.formatDate(r)):this.jq(s).html("");var o={};this.propertyDefined("showHodograph")&&(o.showHodograph=this.getProperty("showHodograph",!0)),this.propertyDefined("showText")&&(o.showText=this.getProperty("showText",!0)),this.propertyDefined("skewtWidth")&&(o.skewtWidth=parseInt(this.getProperty("skewtWidth"))),this.propertyDefined("skewtHeight")&&(o.skewtHeight=parseInt(this.getProperty("skewtHeight"))),this.propertyDefined("hodographWidth")&&(o.hodographWidth=parseInt(this.getProperty("hodographWidth"))),this.propertyDefined("windStride")&&(o.windStride=parseInt(this.getProperty("windStride"))),o.showText=this.getProperty("showText",!0);for(var n=this.getData().getRecordFields(),h=[{id:"pressure",aliases:["vertCoord"]},{id:"height",aliases:["Geopotential_height_isobaric"]},{id:"temperature",aliases:["Temperature_isobaric"]},{id:"dewpoint",aliases:[]},{id:"rh",aliases:["Relative_humidity_isobaric","relative_humidity"]},{id:"wind_direction",aliases:[]},{id:"wind_speed",aliases:[]},{id:"uwind",aliases:["u-component_of_wind_isobaric","u"]},{id:"vwind",aliases:["v-component_of_wind_isobaric","v"]}],d={},p={},g=0;g<h.length;g++){var c=h[g],u=c.id,y=this.getFieldById(n,u);if(null==y)for(var m=0;m<c.aliases.length&&!(y=this.getFieldById(n,c.aliases[m]));m++);y&&(d[u]=this.getColumnValues(t,y).values,p[u]=y)}if(d.pressure)if(d.temperature){if(!d.height){var f=[1013.25,954.61,898.76,845.59,795.01,746.91,701.21,657.8,616.6,577.52,540.48,505.39,472.17,440.75,411.05,382.99,356.51,331.54,303,285.85,264.99,226.99,193.99,165.79,141.7,121.11,103.52,88.497,75.652,64.674,55.293,25.492,11.97,5.746,2.871,1.491,.798,.22,.052,.01],D=[0,500,1e3,1500,2e3,2500,3e3,3500,4e3,4500,5e3,5500,6e3,6500,7e3,7500,8e3,8500,9e3,9500,1e4,11e3,12e3,13e3,14e3,15e3,16e3,17e3,18e3,19e3,2e4,25e3,3e4,35e3,4e4,45e3,5e4,6e4,7e4,8e4];d.height=[];for(g=0;g<d.pressure.length;g++){var I=d.pressure[g],T=D[D.length-1];for(m=0;m<f.length;m++)if(I>=f[m]){if(0==m)T=0;else{var b=f[m],S=D[m-1];T=(D[m]-S)*(1-(I-b)/(f[m-1]-b))+S}break}d.height.push(T)}}if(!d.dewpoint){if(!d.rh)return void this.displayError("No dewpoint or rh");d.dewpoint=[];for(g=0;g<d.rh.length;g++){var v=d.rh[g],x=d.temperature[g]-(100-v)/5;d.dewpoint.push(x)}}if(!d.wind_speed){if(!d.uwind||!d.vwind)return void this.displayError("No wind speed defined in data");d.wind_speed=[],d.wind_direction=[];for(g=0;g<d.uwind.length;g++){var U=d.uwind[g],L=d.vwind[g],E=Math.sqrt(U*U+L*L),P=180+180/Math.PI*Math.atan2(L,U);d.wind_speed.push(E),d.wind_direction.push(P)}}var C=d;for(a in d={},C)d[a]=[];if(C[h[0].id].map(((t,e)=>{var i=!0;for(u in C)if(isNaN(C[u][e])){i=!1;break}if(i)for(u in C)d[u].push(C[u][e])})),d.height.length>1&&d.height[0]>d.height[1])for(name in d)d[name]=Utils.reverseArray(d[name]);if(0!=d.temperature.length){o.myid=this.getId();try{this.skewt=new D3Skewt(e,o,d)}catch(t){return this.displayError("An error occurred: "+t),void console.log("error:"+t.stack)}await this.getDisplayEntry((t=>{if(t){var e=t.getAttribute("variables");e&&(e=(e=(e=(e=(e=e.value).replace(/\r\n/g,"\n")).replace(/^ *\n/,"")).replace(/^ *([^:]+):([^\n].*)$/gm,"<div title='$1' class=display-skewt-index-label>$1</div>: <div title='$2'  class=display-skewt-index>$2</div>")).replace(/[[\r\n]/g,"\n"),e=HtmlUtils.div(["class","display-skewt-text"],e),$("#"+this.skewt.textBoxId).html(e))}}))}else this.displayError(this.getNoDataMessage())}else this.displayError("No temperature defined in data");else this.displayError("No pressure defined in data")}})}function RamaddaD3Display(t,e,i){const a="svg",s=new RamaddaDisplay(t,e,"d3",i);defineDisplay(addRamaddaDisplay(this),s,[],{initDisplay:function(){this.createUI(),this.setDisplayTitle(i.graph.title);var t=this.getProperty("innerWidth",600),e=20,s=50,l=30,r=50,o="height:"+this.getProperty("innerHeight",300)+"px;width:"+t+"px;",n=HtmlUtils.div([ATTR_ID,this.getDomId(a),ATTR_STYLE,o],"");this.setContents(n),this.displayHeight=parseInt(d3.select("#"+this.getDomId(a)).style("height").split("px")[0])-e-l,this.displayWidth=parseInt(d3.select("#"+this.getDomId(a)).style("width").split("px")[0])-r-s;var h=this,d=d3.behavior.zoom().on("zoom",(function(){h.zoomBehaviour()}));this.zoom=d,this.svg=d3.select("#"+this.getDomId(a)).append("svg").attr("width",this.displayWidth+r+s).attr("height",this.displayHeight+e+l).attr(ATTR_CLASS,"D3graph").call(d).on("click",(function(){h.click(d3.event)})).on("dblclick",(function(){h.dbclick(d3.event)})).append("g").attr("transform","translate("+r+","+e+")"),this.x=D3Util.getAxis(i.graph.axis.x.type,[0,this.displayWidth-100]),this.y=D3Util.getAxis(i.graph.axis.y.type,[this.displayHeight,0]),this.xAxis=d3.svg.axis().scale(this.x).orient("bottom"),this.yAxis=d3.svg.axis().scale(this.y).orient("left"),this.svg.append("g").attr(ATTR_CLASS,"x axis").attr("transform","translate(0,"+this.displayHeight+")").call(this.xAxis),this.svg.append("g").attr(ATTR_CLASS,"y axis").call(this.yAxis);var p=["#00008B","#0000CD","#0000FF","#00FFFF","#7CFC00","#FFFF00","#FFA500","#FF4500","#FF0000","#8B0000"],g=100/(p.length-1);D3Util.addColorBar(this.svg,p,g,this.displayWidth);this.color=d3.scale.category10(),this.updateUI()},needsData:function(){return!0},initDialog:function(){this.addFieldsCheckboxes()},getDialogContents:function(){this.getProperty(PROP_HEIGHT,"400");var t=HtmlUtils.div([ATTR_ID,this.getDomId(ID_FIELDS),ATTR_CLASS,"display-fields"]);return t+=s.getDialogContents.apply(this)},fieldSelectionChanged:function(){this.updateUI()},updateUI:function(){if(this.hasData()){test=this;var t=this.getSelectedFields();if(0!=t.length)if(this.addFieldsCheckboxes(),pointData=this.getData(),null!=pointData){var e=pointData.getNumericFields(),a=pointData.getRecords(),s=RecordUtil.getRanges(e,a),l=RecordUtil.getElevationRange(e,a),r=(l[1],l[0],this.x),o=this.y,n=this.color,h=i.graph.axis;this.x.domain(d3.extent(a,(function(e){return D3Util.getDataValue(h.x,e,t[0].getIndex())}))),this.y.domain(d3.extent(a,(function(e){return D3Util.getDataValue(h.y,e,t[0].getIndex())}))),this.zoom.x(this.x),this.zoom.y(this.y),this.svg.selectAll(".y.axis").call(this.yAxis),this.svg.selectAll(".x.axis").call(this.xAxis),this.svg.selectAll(".line").remove(),this.svg.selectAll(".legendElement").remove();for(var d=this,p=0;p<t.length;p++){s[t[p].getIndex()];var g=d3.svg.line().x((function(e){return r(D3Util.getDataValue(h.x,e,t[p].getIndex()))})).y((function(e){return o(D3Util.getDataValue(h.y,e,t[p].getIndex()))}));if(displayLine=this.svg.append("path").datum(a).attr(ATTR_CLASS,"line").attr("d",g).on("mousemove",(function(){d.mouseover(d3.event)})).attr("fill","none").attr("stroke",(function(t){return n(p)})).attr("stroke-width","0.5px"),i.graph.axis.z==FIELD_SELECTEDFIELD&&displayLine.attr("stroke","url(#colorBarGradient)"),null!=i.graph.derived){var c=i.graph.derived.split(",");for(funcIdx=0;funcIdx<c.length;funcIdx++){var u=c[funcIdx];if(u==FUNC_MOVINGAVERAGE){var y=d3.svg.line().x((function(e){return r(D3Util.getDataValue(h.x,e,t[p].getIndex()))})).y((function(e,i){return 0==i?_movingSum=D3Util.getDataValue(h.y,e,t[p].getIndex()):(_movingSum+=D3Util.getDataValue(h.y,e,t[p].getIndex()),o(_movingSum/i))})).interpolate("basis");this.svg.append("path").attr(ATTR_CLASS,"line").attr("d",y(a)).attr("fill","none").attr("stroke",(function(t){return n(p)})).attr("stroke-width","1.5px").attr("viewBox","50 50 100 100 ").style("stroke-dasharray","3, 3")}else console.log("Error: Unknown derived function:"+u)}}this.svg.append("svg:rect").attr(ATTR_CLASS,"legendElement").attr("x",this.displayWidth-100).attr("y",50+50*p).attr("stroke",(function(t){return n(p)})).attr("height",2).attr("width",40),this.svg.append("svg:text").attr(ATTR_CLASS,"legendElement").attr("x",this.displayWidth-100+40+10).attr("y",55+55*p).attr("stroke",(function(t){return n(p)})).attr("style","font-size:50%").text(t[p].getLabel())}}else console.log("no data")}},zoomBehaviour:function(){this.updateUI(!0)},handleEventRecordSelection:function(t,e){},mouseover:function(){testing=d3.event,console.log("mouseover")},click:function(t){console.log("click:"+t)},dbclick:function(t){this.zoom(),this.updateUI()},getSVG:function(){return this.svg}})}function RamaddaD3LineChartDisplay(t,e,i){var a={};return a.graph={title:"Line chart",derived:FUNC_MOVINGAVERAGE,axis:{y:{type:TYPE_VALUE,fieldname:FIELD_SELECTEDFIELD},x:{type:TYPE_TIME,fieldname:FIELD_TIME}}},new RamaddaD3Display(t,e,i=$.extend(a,i))}function RamaddaGliderCrossSectionDisplay(t,e,i){var a={};return a.graph={title:"Glider cross section",derived:null,axis:{y:{type:TYPE_ELEVATION,fieldname:FIELD_DEPTH,reverse:!0},x:{type:TYPE_TIME,fieldname:FIELD_TIME},z:FIELD_SELECTEDFIELD}},new RamaddaD3Display(t,e,i=$.extend(a,i))}var loadedVenn=!1;function RamaddaVennDisplay(t,e,i){const a="venn",s=new RamaddaFieldsDisplay(t,e,DISPLAY_VENN,i);defineDisplay(addRamaddaDisplay(this),s,[],{getContentsStyle:function(){return""},checkLayout:function(){this.updateUIInner()},updateUI:function(){if(!loadedVenn){loadedVenn=!0;var t="<script src='"+ramaddaCdn+"/lib/venn.js'><\/script>";this.writeHtml(ID_DISPLAY_TOP,t)}let e=this;var i=function(){window.venn?e.updateUIInner():setTimeout(i,1e3)};i()},updateUIInner:function(){let t=this.filterData();if(t){var e=this.getData().getRecordFields(),i=this.getSelectedFields(e);0==i.length&&(i=e);var s=this.getFieldsByType(i,"string");if(0!=s.length){for(var l={},r=0,o=0;o<t.length;o++){for(var n=this.getDataValues(t[o]),h=[],d="",p=0;p<s.length;p++){var g=s[p],c=n[g.getIndex()],u=g.getId()+"--"+c;h.push(u),d+="--"+u,Utils.isDefined(l[u])||(l[u]={count:0,setIds:[r],label:c},r++),l[u].count++}var y=[];if(!Utils.isDefined(l[d])){for(var m=0;m<h.length;m++)y.push(l[h[m]].setIds[0]);l[d]={count:0,setIds:y,label:null}}l[d].count++}var f=[];for(var D in l){var I=l[D],T={sets:I.setIds,size:I.count};I.label&&(T.label=I.label),f.push(T)}this.setContents(HtmlUtils.div(["id",this.getDomId(a),"style","height:300px;"],""));var b=venn.VennDiagram().width(600).height(400),S="#"+this.getDomId(a),v=this.getColorTable(!0,"strokeColors","nice"),x=this.getColorTable(!0,"fillColors","nice"),U=this.getColorTable(!0,"textColors");U||(U=v),d3.select(S).datum(f).call(b),d3.selectAll(S+" .venn-circle path").style("fill-opacity",parseFloat(this.getProperty("fillOpacity",.5))).style("stroke-width",parseInt(this.getProperty("strokeWidth",1))).style("stroke-opacity",parseFloat(this.getProperty("strokeOpacity",.5))).style("stroke",(function(t,e){return e<v.length?v[e]:v[e%v.length]})).style("fill",(function(t,e){return e<x.length?x[e]:x[e%x.length]})),d3.selectAll(S+" .venn-circle text").style("fill",(function(t,e){return e<U.length?U[e]:U[e%U.length]})).style("font-size",this.getProperty("fontSize","16px")).style("font-weight",this.getProperty("fontWeight","100"))}else this.displayError("No string fields specified")}}})}function RamaddaMinidotsDisplay(t,e,i){const a="minidots",s=new RamaddaFieldsDisplay(t,e,DISPLAY_MINIDOTS,i);defineDisplay(addRamaddaDisplay(this),s,[],{getContentsStyle:function(){return""},checkLayout:function(){this.updateUI()},updateUI:function(){let t=this.filterData();if(!t)return;let e=+this.getProperty("dotsWidth",500),i=+this.getProperty("dotsHeight",200),s=this.getFieldById(null,this.getPropertyValueField()),l=this.getFieldById(null,this.getPropertyDateField()),r=this.getFieldById(null,this.getProperty("groupBy")),o=+this.getProperty("divisor",1);if(!s)return void this.displayError("No value field specified");l||(l=this.getFieldByType(null,"date"));let n=null,h=null,d={};t.forEach((t=>{let e=l?t.getValue(l.getIndex()):t.getDate();n=null!=n?Math.min(n,e.getTime()):e,h=null!=h?Math.max(h,e.getTime()):e})),t.forEach((t=>{let e=r?t.getValue(r.getIndex()):"all",i=l?t.getValue(l.getIndex()):t.getDate();n=null!=n?Math.min(n,i.getTime()):i,h=null!=h?Math.max(h,i.getTime()):i;let a=d[e];a||(d[e]=a={records:[],total:0,list:[],seen:{}}),a.records.push(t);let p=t.getValue(s.getIndex());if(a.total+=p,p/=o,!(a.list.length>5e3))for(let e=0;e<p;e++)a.list.push({x:i.getTime(),y:Math.random(),record:t})}));let p={minx:n,maxx:h,miny:0,maxy:1},g=Object.keys(d).sort();if(r){this.jq(a);let t="<table border=1>";g.forEach(((a,s)=>{let l=d[a];t+="<tr>",t+=HU.td([],a+" ("+l.total+")");let r=this.getDomId("minidots_"+s);t+=HU.td([],HtmlUtils.div([CLASS,"display-minidots-dots",ID,r,STYLE,HU.css(HEIGHT,HU.getDimension(i),WIDTH,HU.getDimension(e))],"")),t+="</tr>\n"})),this.setContents(t),g.forEach(((t,a)=>{let s=d[t];drawDots(this,"#"+this.getDomId("minidots_"+a),e,i,s.list,p,null)}))}else{let t=d.all;this.setContents(HtmlUtils.div([CLASS,"display-minidots-dots",ID,this.getDomId(a),STYLE,HU.css(HEIGHT,HU.getDimension(i),WIDTH,HU.getDimension(e))],"")),drawDots(this,"#"+this.getDomId(a),e,i,t.list,p,null)}}})}function RamaddaChernoffDisplay(t,e,i){const s=new RamaddaFieldsDisplay(t,e,DISPLAY_VENN,i);defineDisplay(addRamaddaDisplay(this),s,[],{getContentsStyle:function(){return""},checkLayout:function(){this.updateUIInner()},timeout:100,written:!1,updateUI:function(){if(!this.written){this.written=!0;var t="<script src='"+ramaddaCdn+"/lib/chernoff.js'><\/script>";this.writeHtml(ID_DISPLAY_TOP,t)}this.updateUIInner()},updateUIInner:function(){let t=this;if(!Utils.isDefined(d3.chernoff)){this.timeout=2*this.timeout;return void setTimeout((function(){t.updateUIInner()}),this.timeout)}let e=this.filterData();if(e){var i=this.getData().getRecordFields(),s=this.getSelectedFields(i);if(0!=this.getFieldsByType(s,"numeric").length){0==s.length&&(s=i);var l,r=this.getFieldByType(s,"string"),o="",n=this.getFieldById(i,this.getProperty("colorBy"));if(n){var h=this.getColorTable(!0,null,"blue_white_red"),d=this.getColumnValues(e,n);l=[];for(var p=parseFloat(this.getProperty("colorByMin",d.min)),g=(w=parseFloat(this.getProperty("colorByMax",d.max)))-p,c=0;c<d.values.length;c++){var u=((A=d.values[c])-p)/g,y=Math.round(u*(h.length-1));l.push(h[y])}this.displayColorTable(h,ID_DISPLAY_BOTTOM,p,w),o+="<b>Colored by</b>: "+n.getLabel()+"&nbsp;&nbsp;"}var m=[{label:"Face width",name:"face",key:"f",min:0,max:1},{label:"Hair",name:"hair",key:"h",min:-1,max:1},{label:"Mouth",name:"mouth",key:"m",min:-1,max:1},{label:"Nose height",name:"noseHeight",key:"nh",min:0,max:1},{label:"Nose width",name:"noseWidth",key:"nw",min:0,max:1},{label:"Eyes height",name:"eyesHeight",key:"eh",min:0,max:1},{label:"Eyes width",name:"eyesWidth",key:"ew",min:0,max:1},{label:"Brow",name:"brow",key:"b",min:-1,max:1}],f="",D=this.getProperty("showHelp",!1);for(a in D&&(f+="Settings:<br><table class=ramadda-table><thead><tr><th>Attribute&nbsp;</th><th>&nbsp;Default range&nbsp;</th><th>&nbsp;Set field&nbsp;</th><th>&nbsp;Set min&nbsp;</th><th>&nbsp;Set max&nbsp;</th></tr></thead><tbody>"),m){var I=m[a];D&&(f+="<tr><td>"+I.label+"</td><td align=center>"+I.min+" - "+I.max+"</td><td>"+I.name+"Field=&lt;field_id&gt;</td><td>"+I.name+"Min=&lt;min_value&gt;</td><td>"+I.name+"Max=&lt;max_value&gt;</td></tr>"),I.field=this.getFieldById(i,this.getProperty(I.name+"Field")),I.field&&(o+="<b>"+I.label+"</b>: "+I.field.getLabel()+"&nbsp;&nbsp;",Utils.isDefined(this.getProperty(I.name+"Min"))&&(I.min=parseFloat(this.getProperty(I.name+"Min"))),Utils.isDefined(this.getProperty(I.name+"Max"))&&(I.max=parseFloat(this.getProperty(I.name+"Max"))),I.column=this.getColumnValues(e,I.field))}D&&(f+="</tbody></table>");for(var T=this.getFieldById(i,this.getProperty("sortBy")),b=[],S=0;S<e.length;S++){var v={values:this.getDataValues(e[S])};l&&(v.color=l[S]),b.push(v)}T&&b.sort((function(t,e){var i=t.values[T.getIndex()],a=e.values[T.getIndex()];return i<a?1:i>a?-1:0}));var x=[];for(S=0;S<b.length;S++){var U=(v=b[S]).values,L=v.color,E={f:.5,h:0,m:0,nh:.5,nw:.5,eh:.5,ew:.5,b:0};x.push({faceData:E,color:L});var P="";for(a in m){var C=(I=m[a]).field;if(C){var A=U[C.getIndex()],w=(p=I.column.min,I.column.max);if(P+=C.getLabel()+": "+A+" range: "+p+" - "+w+" ("+I.label+")\n",w!=p){u=(A-p)/(w-p);var H=I.min+(I.max-I.min)*u;E[I.key]=H}}else E[I.key]=I.min+(I.max-I.min)/2}var R=r?U[r.getIndex()]:"Row: "+S,k=r?U[r.getIndex()]:"";R=HtmlUtils.div(["class","display-chernoff-label"],R);var _=HtmlUtils.div(["id",this.getDomId("chernoff")+"_"+S,"class","display-chernoff-face"],"");f+=HtmlUtils.div(["title",P,"class","display-chernoff-wrapper ramadda-div-link","value",k],_+R)}o=HtmlUtils.div(["class","display-chernoff-legend"],o);var F=this.getProperty("height","400px");F.endsWith("px")||(F+="px"),this.setContents(o+HtmlUtils.div(["style","height:"+F+";","class","display-chernoff-container","id",this.getDomId("chernoff")],f));for(S=0;S<e.length;S++){_="#"+this.getDomId("chernoff")+"_"+S;this.makeFace(_,x[S].faceData,x[S].color)}r&&this.find(".ramadda-div-link").click((function(){var e=$(this).attr("value");t.propagateEvent("fieldValueSelected",{field:r,value:e})}))}else this.displayError("No numeric fields specified")}},makeFace:function(t,e,i){d3.select(t).call(function(){var t=d3.chernoff().face((function(t){return t.f})).hair((function(t){return t.h})).mouth((function(t){return t.m})).nosew((function(t){return t.nw})).noseh((function(t){return t.nh})).eyew((function(t){return t.ew})).eyeh((function(t){return t.eh})).brow((function(t){return t.b}));function a(a){var s=a.append("svg").attr("width",400).attr("height",200).selectAll("g.chernoff").data([e]).enter().append("g").attr("class","chernoff").call(t);i&&s.attr("style","fill:"+i)}return function(t){t.call(a)}}())}})}function RamaddaD3bubbleDisplay(t,e,i){const a="bubbles",s=new RamaddaDisplay(t,e,DISPLAY_D3BUBBLE,i);window.BubbleChart||(Utils.importJS(ramaddaCdn+"/lib/d3/d3-legend.min.js"),Utils.importJS(ramaddaCdn+"/lib/d3/bubblechart.js"));defineDisplay(addRamaddaDisplay(this),s,[{label:"Bubble Chart"},{p:"labelField",ex:""},{p:"colorBy",ex:""},{p:"valueField",ex:""},{p:"descriptionField",ex:""},{p:"imageField",ex:""},{p:"sizeLabel1",ex:""},{p:"sizeLabel2",ex:""},{p:"showSizeLegend",ex:"false"}],{needsData:function(){return!0},callbackWaiting:!1,displayData:function(){this.updateUI()},updateUI:function(){if(!window.BubbleChart)return void(this.callbackWaiting||(this.callbackWaiting=!0,setTimeout((()=>{this.callbackWaiting=!1,this.updateUI()}),100)));if(0==this.getContents().width())return void this.setContents("...");let t=this.filterData();if(!t)return;let e=this.getFieldById(null,this.getProperty("colorBy","category")),i=this.getFieldById(null,this.getProperty("valueField"));e&&this.setProperty("sortFields",e.getId());let s,l=HtmlUtil.tag("svg",["id",this.getDomId(a),"width","100%","height","700","font-family","sans-serif","font-size","10","text-anchor","middle"]);this.setContents(l);let r=0,o=0;i&&(s=this.getColumnValues(t,i).values,s.map(((t,e)=>{r=0==e?t:Math.min(t,r),o=0==e?t:Math.max(t,o)})));let n=this.getFieldById(null,this.getProperty("labelField","name")),h=this.getFieldById(null,this.getProperty("descriptionField")),d=this.getFieldById(null,this.getProperty("imageField")),p=this.getProperty("template","${default}");if(!n)return void this.setContents(this.getMessage("No label field found"));let g=[];if(t.map((t=>{let a=h?t.getValue(h.getIndex()):this.getRecordHtml(t,null,p),s=t.getValue(n.getIndex()),l={name:s,icon:s,desc:a,cat:"",value:10};e&&(l.cat=t.getValue(e.getIndex())),i&&(l.value=t.getValue(i.getIndex())),d&&(l.icon=t.getValue(d.getIndex())),g.push(l)})),0==g.length)return void this.setContents(this.getMessage(this.getNoDataMessage()));let c=this.getColorTable(!0);new BubbleChart("#"+this.domId(a),g,{label1:this.getProperty("sizeLabel1"),label2:this.getProperty("sizeLabel2"),colors:c,showSizeLegend:this.getProperty("showSizeLegend",null!=i)})}})}const DISPLAY_WORDCLOUD="wordcloud",DISPLAY_TEXTSTATS="textstats",DISPLAY_FREQUENCY="frequency",DISPLAY_TEXTANALYSIS="textanalysis",DISPLAY_TEXTRAW="textraw",DISPLAY_TEXT="text",DISPLAY_BLOCKS="blocks",DISPLAY_TEMPLATE="template",DISPLAY_TOPFIELDS="topfields",DISPLAY_GLOSSARY="glossary";function RamaddaBaseTextDisplay(t,e,i,a){defineDisplay(this,new RamaddaFieldsDisplay(t,e,i,a),[],{processText:function(t,e){let i=this.filterData();if(!i)return null;var a={},s=this.getData().getRecordFields();0==(e=e||this.getSelectedFields(s)).length&&(e=s);var l=this.getFieldsByType(e,"string");if(0==l.length)return this.displayError("No string fields specified"),null;var r=parseInt(this.getProperty("minLength",0)),o=parseInt(this.getProperty("maxLength",100)),n=this.getProperty("stopWords");n&&(n="default"==n?Utils.stopWords:n.split(","));var h=this.getProperty("extraStopWords");h&&(h=h.split(","));var d=this.getProperty("stripTags",!1),p=this.getProperty("tokenize",!1),g=this.getProperty("lowerCase",!1),c=this.getProperty("removeArticles",!1);t&&(t.count=0,t.total=0,t.lengths={});for(var u=0;u<i.length;u++)for(var y=this.getDataValues(i[u]),m=0;m<l.length;m++){var f=l[m];a[f.getId()]||(a[f.getId()]={field:f,words:[],counts:{},divId:this.domId("textblock"+f.getIndex())});var D=a[f.getId()],I=y[f.getIndex()];d&&(I=Utils.stripTags(I));var T=[I];p&&(T[0]=T[0].replace(/\"/g," "),T=Utils.tokenizeWords(T[0],n,h,c));for(var b=0;b<T.length;b++){I=T[b].trim();if(!(T.length>1&&I.length<=1)&&!I.startsWith("&")){var S=I.toLowerCase();if(t&&(t.count++,t.total+=I.length,Utils.isDefined(t.lengths[I.length])||(t.lengths[I.length]=0),t.lengths[I.length]++),!p){if(n&&n.includes(S))continue;if(h&&h.includes(S))continue}I.length>o||I.length<r||(g&&(I=I.toLowerCase()),Utils.isDefined(D.counts[I])||(D.counts[I]=0),D.counts[I]++)}}}return a}})}function RamaddaWordcloudDisplay(t,e,i){const s=new RamaddaBaseTextDisplay(t,e,DISPLAY_WORDCLOUD,i);defineDisplay(addRamaddaDisplay(this),s,[{label:"Wordcloud"},{p:"termField"},{p:"fields"},{p:"tableFields"},{p:"countField"},{p:"tokenize",ex:!0},{p:"handleClick",ex:!0},{p:"showFieldLabel",ex:!0},{p:"showRecords"},{p:"combined"},{p:"shape",ex:"rectangular"},{p:"stopWords",ex:"word1,word2"},{p:"showFieldLabel",ex:"false"}],{getContentsStyle:function(){return""},checkLayout:function(){this.updateUIInner()},hasJq:!1,updateUI:function(){if(this.loadedJq)this.hasJq&&this.updateUIInner();else{this.loadedJq=!0;let t="<link rel='stylesheet' href='"+ramaddaCdn+"/lib/jqcloud.min.css'>";t+="<script src='"+ramaddaCdn+"/lib/jqcloud.min.js'><\/script>",this.writeHtml(ID_DISPLAY_TOP,t);let e=this,i=$("body"),a=function(){i.jQCloud?(e.hasJq=!0,e.updateUIInner()):setTimeout(a,100)};setTimeout(a,100)}},updateUIInner:function(){let t=this.filterData();if(null==t)return;let e={autoResize:!0},i=this.getColorTable(!0);i&&(e.colors=i,e.classPattern=null,e.fontSize={from:.1,to:.02}),this.getProperty("shape")&&(e.shape=this.getProperty("shape"));let s=this.getFieldById(null,this.getProperty("countField")),l=this.getFieldById(null,this.getProperty("termField"));if(s&&l){parseInt(this.getProperty("minLength",0)),parseInt(this.getProperty("maxLength",100));let i=this.getProperty("stopWords");i&&(i="default"==i?Utils.stopWords:i.split(","));let a=[],r={};t.every((t=>{let e=l.getValue(t),a=e.toLowerCase();return i&&i.includes(a)||(r[e]||(r[e]=0),r[e]+=s.getValue(t)),!0}));let n=null,h=this;for(word in this.getProperty("handleClick",!0)&&(n={click:function(e){let i=e.target.innerText;h.showRows(t,null,i,o)}}),r)a.push({text:word,html:{style:"cursor:pointer;"},weight:r[word],handlers:n});return this.setContents(HU.div([ID,this.domId("words"),STYLE,HU.css("height","300px")],"")),void $("#"+this.domId("words")).jQCloud(a,e)}let r=this.getData().getRecordFields(),o=l?[l]:this.getSelectedFields(r),n=this.processText(null,o);if(null==n)return;0==o.length&&(o=r);let h=this.getFieldsByType(o,"string"),d=this,p="",g=[],c=parseInt(this.getProperty("maxWords",-1)),u=parseInt(this.getProperty("minCount",0)),y=100/h.length+"%;";for(a in n){let e=n[a],i=e.field,s=null;this.getProperty("handleClick",!0)&&(s={click:function(e){let a=e.target.innerText;d.showRows(t,i,a,o)}});let l=[];for(word in e.counts){let t=e.counts[word];l.push({word:word,count:t})}if(l.sort((function(t,e){return t.count<e.count?-1:t.count>e.count?1:0})),u>0){let t=[];for(let e=0;e<l.length;e++)l[e].count>=u&&t.push(l[e]);l=t}if(c>0){let t=[];for(let e=0;e<=c&&e<l.length;e++)l[e].count>=u&&t.push(l[e]);l=t}for(let t=0;t<l.length;t++){let a=l[t],r={weight:a.count,html:{style:"cursor:pointer;"},handlers:s,text:a.word},o={weight:a.count,html:{style:"cursor:pointer;"},handlers:s,text:i.getLabel()+":"+a.word};e.words.push(r),g.push(o)}let r="";this.getProperty("showFieldLabel",!0)&&(r=HU.b(e.field.getLabel())),p+=HU.div([STYLE,HU.css("display","inline-block","width",y)],r+HU.div([STYLE,HU.css("border","1px #ccc solid","height","300px"),ID,e.divId],""))}if(this.setContents(""),this.getProperty("combined",!1))this.setContents(HU.div([ID,this.domId("words"),STYLE,HU.css("height","300px")],"")),$("#"+this.domId("words")).jQCloud(g,e);else for(a in this.setContents(p),n){let t=n[a];$("#"+t.divId).jQCloud(t.words,e)}},showRows:function(t,e,i,s){e||(e=this.getFieldById(null,this.getProperty("termField")));let l,r=this.getProperty("tokenize",!1);if(s&&i.startsWith(e.getLabel()+":")&&(i=i.replace(e.getLabel()+":","")),this.getProperty("tableFields")){l={};let t=this.getProperty("tableFields").split(",");for(a in t)l[t[a]]=!0}let o=this.getData().getRecordFields(),n="",h=[],d=[];h.push(d);for(let t=0;t<o.length;t++){let e=o[t];l&&!l[e.getId()]||d.push(o[t].getLabel())}let p=this.getProperty("showRecords",!1);p&&(n+="<br>");let g=new RegExp("(\\b"+i+"\\b)","i");for(let a=0;a<t.length;a++){let s=this.getDataValues(t[a]),d=s[e.getIndex()];if(r){if(!d.match(g))continue}else if(i!=d)continue;let c=[];h.push(c);for(let t=0;t<o.length;t++){let e=o[t];if(l&&!l[e.getId()])continue;let i=s[e.getIndex()];i.getTime?i={v:i,f:this.formatDate(i)}:r&&(i=i.replace(g,"<span style=background:yellow;>$1</span>")),p?n+=HU.b(e.getLabel())+": "+i+"</br>":c.push(i)}p&&(n+="<p>")}if(p)this.writeHtml(ID_DISPLAY_BOTTOM,HU.center(n));else{let t="";r||(t=(e?e.getLabel():"Word")+"="+i),this.writeHtml(ID_DISPLAY_BOTTOM,HU.center(t+HU.div([ID,this.domId("table"),STYLE,HU.css("height","300px")],"")));let a=google.visualization.arrayToDataTable(h);this.chart=new google.visualization.Table(document.getElementById(this.domId("table"))),this.chart.draw(a,{allowHtml:!0})}}})}function RamaddaTemplateDisplay(t,e,i){Utils.isDefined(i.showTitle)||(i.showTitle=!1),Utils.isDefined(i.showMenu)||(i.showMenu=!1);const a=new RamaddaFieldsDisplay(t,e,DISPLAY_TEMPLATE,i);defineDisplay(addRamaddaDisplay(this),a,[{label:"Template"},{p:"template"},{p:"toggleTemplate",ex:"",tt:"Used as the toggle label for hiding/showing the main template"},{p:"headerTemplate",ex:"... ${totalCount} ... ${selectedCount}"},{p:"footerTemplate",ex:"... ${totalCount} ... ${selectedCount}"},{p:"emptyMessage"},{p:"select",ex:"max|min|<|>|=|<=|>=|contains"},{p:"selectField"},{p:"selectValue"},{p:"onlyShowSelected",ex:"true"},{p:"showRecords",tt:"comma separated list of record indices",ex:"0,3,4"},{p:"dontShowRecords",tt:"comma separated list of record indices to not show",ex:"0,3,4"},{p:"showFirst",ex:"true"},{p:"showLast",ex:"true"},{p:"selectHighlight",ex:"true"},{p:"handleSelectOnClick"},{p:"groupByField"},{p:"groupDelimiter",ex:"<br>"},{p:"groupTemplate",wikivalue:"<b>${group}</b><ul>${contents}</ul>"},{p:"sortGroups",wikivalue:"true"},{p:"${&lt;field&gt;_total}"},{p:"${&lt;field&gt;_max}"},{p:"${&lt;field&gt;_min}"},{p:"${&lt;field&gt;_average}"},{p:"highlightOnScroll",ex:"true"}],{dataFilterChanged:function(){this.getPropertyOnlyShowSelected()&&this.selectedRecord&&(this.selectedRecord=null,this.selectedRecords=null,this.setContents("")),a.dataFilterChanged.call(this)},updateUI:function(){let t=this.getData();if(null==t)return;let e=this.filterData();if(!e)return;if(this.getPropertyOnlyShowSelected()){if(this.selectedRecord||this.selectedRecords||this.getShowFirst(!0)&&(this.selectedRecord=e[0]),!this.selectedRecord&&!this.selectedRecords)return void this.setContents("<br>");e=this.selectedRecords||[this.selectedRecord]}else this.getShowFirst(!1)?e=[e[0]]:this.getShowLast(!1)&&(e=[e[e.length-1]]);e=this.sortRecords(e);let i=this.getShowRecords();if(i){let t=[];i.split(",").forEach((i=>{t.push(e[+i])})),e=t}let a=this.getDontShowRecords();if(a){let t={};a.split(",").forEach((e=>{t[+e]=!0}));let i=[];for(let a=0;a<e.length;a++)t[a]||i.push(e[a]);e=i}let s=t.getRecordFields(),l=this.getFieldsByIds(s,this.getProperty("uniqueFields")),r={},o=this.getProperty("template",""),n=this.getProperty("toggleTemplate"),h=this.getProperty("select","all"),d=[],p={},g=[];e.forEach((t=>{if(l.length>0){var e="";if(l.map((i=>{e+="__"+i.getValue(t)})),Utils.isDefined(r[e]))return;r[e]=!0}g.push(t);for(var i=0;i<s.length;i++){var a=s[i],o=a.getValue(t);p[a.getId()]||(p[a.getId()]={total:0,min:o,max:o,count:0,uniques:{},uniqueCount:0});var n=p[a.getId()];a.isString()?n.uniques[o]||(n.uniqueCount++,n.uniques[o]=!0):a.isDate&&o.getTime?(o.getTime()<n.min.getTime()&&(n.min=o),o.getTime()>n.max.getTime()&&(n.max=o)):isNaN(o)||(n.total+=o,n.min=Math.min(n.min,o),n.max=Math.max(n.max,o),n.count++)}})),e=g;for(var c=0;c<s.length;c++){if((L=s[c]).isNumeric())(U=p[L.getId()])&&U.count&&(U.average=U.total/U.count)}if("max"==h||"min"==h||"="==h||"<"==h||">"==h||"<="==h||"?>="==h||"match"==h){var u=this.getProperty("selectField",null);if(u&&(u=this.getFieldById(null,u)),!u)return void this.setContents("No selectField specified");var y,m,f=this.getProperty("selectValue","0"),D=parseFloat(f),I=0,T=0,b=0;e.map((t=>{var e=u.getValue(t);if("match"!=h)if("="!=h){if(!isNaN(e))if("<"!=h)if(">"!=h)if(">="!=h)if("<="!=h){if(0==b++)return T=e,I=e,m=t,void(y=t);e<T&&(T=e,m=t),e>I&&(I=e,y=t)}else e<=D&&d.push(t);else e>=D&&d.push(t);else e>D&&d.push(t);else e<D&&d.push(t)}else e==f&&d.push(t);else e.match(f)&&d.push(t)})),"min"==h?m&&d.push(m):"max"==h&&y&&d.push(y)}else d=e;var S="";0==d.length&&(S=this.getProperty("emptyMessage","Nothing found"));var v=this.getColorByInfo(d);let x={};x.selectedCount=d.length,x.totalCount=e.length;for(c=0;c<s.length;c++){var U,L=s[c];(U=p[L.getId()])&&(L.isDate?(x[L.getId()+"_min"]=U.min,x[L.getId()+"_max"]=U.max):U&&L.isString()?x[L.getId()+"_uniques"]=U.uniqueCount:L.isNumeric()&&U&&(x[L.getId()+"_total"]=U.total,x[L.getId()+"_min"]=U.min,x[L.getId()+"_max"]=U.max,x[L.getId()+"_average"]=U.average))}var E=this.getProperty("headerTemplate",""),P=this.getProperty("footerTemplate","");if(1==d.length){let t=this.getDataValues(d[0]);E=this.applyRecordTemplate(d[0],t,s,E),P=this.applyRecordTemplate(d[0],t,s,P)}if(this.filters){let t=(t,e)=>{E=E.replace(t,e),P=P.replace(t,e)};for(var C=0;C<this.filters.length;C++){let e=this.filters[C];if(!e.isEnabled())continue;let i=e.getField();if(i.isNumeric()){T=$("#"+this.domId("filterby_"+i.getId()+"_min")).val().trim(),I=$("#"+this.domId("filterby_"+i.getId()+"_max")).val().trim();x["filter_"+i.getId()+"_min"]=T,x["filter_"+i.getId()+"_max"]=I}else{var A=$("#"+this.domId("filterby_"+i.getId()));if(!A.val||null==A.val())continue;if(!(V=A.val()))continue;if(Array.isArray(V)){var w="";V.map((t=>{""!=w&&(w+=", "),w+=t})),V=w}if((V=V.trim())==FILTER_ALL){var H=new RegExp("\\${filter_"+i.getId()+"[^}]*\\}","g");t(H,"")}else{H=new RegExp("\\${filter_"+i.getId()+" +prefix='([^']*)' +suffix='([^']*)' *\\}","g");t(H,"$1"+V+"$2");H=new RegExp("\\${filter_"+i.getId()+" +prefix='([^']*)' *\\}","g");t(H,"$1"+V);H=new RegExp("\\${filter_"+i.getId()+" +suffix='([^']*)' *\\}","g");t(H,V+"$1");H=new RegExp("\\${filter_"+i.getId()+" *\\}","g");t(H,V)}}}}let R=Utils.tokenizeMacros(E),k=Utils.tokenizeMacros(P);if(E=R.apply(x),P=k.apply(x),d.length>0&&(S+=E),""!=o){let t=this.getFieldById(null,this.getProperty("groupByField")),i=this.getProperty("groupDelimiter"," "),a=this.getProperty("groupTemplate","<b>${group}</b><ul>${contents}</ul>"),l=[],r={};var _,F=this.getTemplateProps(s),M=(I=parseFloat(this.getProperty("maxNumber",-1)),parseFloat(this.getProperty("templateColumns",-1)));M>0&&(_="col-md-"+Math.round(12/M),S+='<div class="row-tight row">');var N=0,B=this.getProperty("templateStyle","");let h=this.getPropertyHandleSelectOnClick(!0);for(var O=0;O<d.length&&!(-1!=I&&O>=I);O++){M>0&&(N>=M&&(N=0,S+="</div>\n",S+='<div class="row-tight row">\n'),S+='<div  class="'+_+'">\n',N++);var Y=d[O],G=null;if(v.index>=0){var V=Y.getData()[v.index];G=v.getColor(V,Y)}let a=o.trim(),p=this.getDataValues(Y);a=a.startsWith("${default")?this.getRecordHtml(Y,s,a):this.applyRecordTemplate(Y,p,s,a,F);let g=Utils.tokenizeMacros(a),c={};c.selectCount=d.length,c.totalCount=e.length,c[RECORD_INDEX]=O+1;this.getDataFilters();this.filters.forEach((t=>{t.isEnabled()&&t.getField&&(c["filter."+t.getField().getId()]=t.getFieldValues())}));var q=B;G&&(this.getProperty("colorBackground",!1)&&(q=HU.css("background",G)+q),c.color=G),h||(q+=HU.css("cursor","default"));var j=HU.openTag("div",[CLASS,"display-template-record",STYLE,q,ID,this.getId()+"-"+Y.getId(),TITLE,"",RECORD_ID,Y.getId(),RECORD_INDEX,O]);if(a=g.apply(c),a.startsWith("<td")?(a=a.replace(/<td([^>]*)>/,"<td $1>"+j),a=a.replace(/<\/td>$/,"</div></td>")):a.startsWith("<tr")?(a=a.replace(/<td([^>]*)>/g,"<td $1>"+j),a=a.replace(/<\/td>/g,"</div></td>")):a=j+a+HU.close(DIV),n){let t=this.applyRecordTemplate(Y,p,s,n,F);a=HU.toggleBlock(t,a,!1)}if(t){let e=t.getValue(Y);e.getTime&&(e=this.formatDate(e)),r[e]?r[e]+=i:(l.push(e),r[e]=""),r[e]+=a}else S+=a;M>0&&(S+=HU.close(DIV))}t&&(this.getPropertySortGroups(!1)&&(l=l.sort()),l.forEach((t=>{S+=a.replace("${group}",t).replace("${contents}",r[t])}))),M>0&&(S+=HU.close(DIV))}d.length>0&&(S+=P),this.setContents(S,!0),this.addFieldClickHandler(null,null,!1);var W=this.find(".display-template-record");this.makeTooltips(W,d),this.makePopups(W,d);let z=this;if(this.getPropertyHandleSelectOnClick(!0)&&this.find(".display-template-record").click((function(){var t=d[$(this).attr(RECORD_INDEX)];z.handleEventRecordHighlight(this,{record:t,highlight:!0,immediate:!0,skipScroll:!0}),z.propagateEventRecordSelection({highlight:!0,record:t})})),this.getPropertyHighlightOnScroll(!1)){let t=this.find(".display-template-record");this.getContents().css("overflow-y","scroll"),this.getContents().scroll((()=>{let e=null;if(t.each((function(){$(this).position().top<0&&(e=$(this))})),e){var i=d[e.attr(RECORD_INDEX)];i&&this.currentTopRecord&&i!=this.currentTopRecord&&this.propagateEventRecordSelection({highlight:!0,record:i}),this.currentTopRecord=i}}))}},highlightCount:0,handleEventRecordSelection:function(t,e){this.selectedRecords=e.records,this.selectedRecord=e.record,this.getProperty("onlyShowSelected")?this.updateUI():(e.highlight=!0,this.handleEventRecordHighlight(t,e))},handleEventRecordHighlight:function(t,e){if(this.getPropertySelectHighlight())return this.selectedRecord=e.record,void this.callUpdateUI();this.currentTopRecord=null;let i=++this.highlightCount;var a="#"+this.getId()+"-"+e.record.getId();if(this.highlightedElement&&(this.unhighlightElement(this.highlightedElement),this.highlightedElement=null),e.highlight)e.immediate?this.highlightElement(e):setTimeout((()=>{i==this.highlightCount&&this.highlightElement(e)}),500);else{a="#"+this.getId()+"-"+e.record.getId();var s=$(a);this.unhighlightElement(s)}},unhighlightElement:function(t){this.currentTopRecord=null,t.removeClass("display-template-record-highlight");var e=this.getProperty("highlightOffCss","").split(";");e.length>0&&e.map((e=>{var i=e.split(":"),a=i[0],s=i.length>1?i[1]:null;s&&""!=s||(s=t.attr("prev-"+a)),s&&t.css(a,s)}))},highlightElement:function(t){var e="#"+this.getId()+"-"+t.record.getId(),i=$(e);this.highlightedElement=i,i.addClass("display-template-record-highlight");var a=this.getProperty("highlightOnCss","").split(";");a.length>0&&a.map((t=>{var e=t.split(":"),a=e[0],s=e.length>1?e[1]:null;if(s&&""!=s||(s=i.attr("prev-"+a)),s){var l=i.css(a);l&&i.attr("prev-"+a,l),i.css(a,s)}}));try{if(!t.skipScroll){var s=i.offset();if(null==s)return;var l=this.getContents();if("vertical"==this.getProperty("orientation","vertical")){var r=l.offset().top,o=l.scrollTop();l.scrollTop(s.top-r+o)}else{r=l.offset().left,o=l.scrollLeft();l.scrollLeft(s.left-r+o)}}}catch(t){console.log("Error:"+t)}}})}function RamaddaTopfieldsDisplay(t,e,i){const a=new RamaddaFieldsDisplay(t,e,DISPLAY_TOPFIELDS,i);defineDisplay(addRamaddaDisplay(this),a,[{label:"Top Fields"},{p:"fieldCount",tt:""},{p:"labelField",tt:""},{p:"dateFormat",ex:"yyyy"},{p:"labelField"},{p:"scaleFont",ex:"false"}],{needsData:function(){return!0},updateUI:function(){if(null==this.getData())return;let t=this.filterData();if(!t)return;var e=this.getData().getNonGeoFields(),i=this.getFieldById(e,this.getProperty("labelField"));null==i&&(i=this.getFieldById(e,TITLE)),null==i&&(i=this.getFieldById(e,"name"));var a=this.getFieldsByIds(e,this.getPropertyFields());0==a.length&&(a=e);for(var s="",l=+this.getProperty("fieldCount",10),r=[],o=Number.MAX_VALUE,n=Number.MIN_VALUE,h=this.getProperty("dateFormat"),d=0;d<t.length;d++){for(var p=(f=t[d]).getData(),g=[],c=0;c<a.length;c++){if((S=a[c]).isNumeric()){var u=p[S.getIndex()];isNaN(u)||(o=Math.min(o,u),n=Math.max(n,u)),g.push({value:u,field:S})}}g.sort(((t,e)=>e.value-t.value));var y=i?p[i.getIndex()]:" Record:"+(d+1);(i&&i.isFieldDate()||"date"==typeof y)&&(y=Utils.formatDateWithFormat(y,h)),r.push({data:g,record:f,header:y})}var m=this.getProperty("scaleFont",!0);for(d=0;d<r.length;d++){g=r[d].data;var f=r[d].record,D=(y=r[d].header,p=f.getData(),""),I="";for(c=0;c<g.length&&c<l;c++){u=g[c].value;var T=n==o?1:(u-o)/(n-o),b=6+Math.round(24*T)+"pt";m||(b="100%");var S=g[c].field;I+=HU.div(["field-id",S.getId(),"data-value",S.getLabel(),TITLE,"Value: "+u,CLASS,"display-topfields-row",STYLE,"font-size:"+b+";"],S.getLabel())}D+=HU.div([CLASS,"display-topfields-header",RECORD_INDEX,d],y),D+=HU.div([CLASS,"display-topfields-values"],I),s+=HU.div([CLASS,"display-topfields-record"],D)}this.setContents(s);let v=this;this.find(".display-topfields-header").click((function(){var e=$(this).attr(RECORD_INDEX);v.find(".display-topfields-record").removeClass("display-topfields-selected"),$(this).parent().addClass("display-topfields-selected");var i=t[e];i&&v.propagateEventRecordSelection({record:i})}));let x=this.find(".display-topfields-row");x.hover((function(){x.removeClass("display-topfields-highlight");var t=$(this).attr("data-value");v.find(HU.attrSelect("data-value",t)).addClass("display-topfields-highlight")})),x.click((function(){var t=$(this).attr("field-id");v.getDisplayManager().notifyEvent(DisplayEvent.fieldsSelected,v,[t])}))},handleEventRecordSelection:function(t,e){if(e.record){var i=this.recordToIndex[e.record.getId()];if(Utils.isDefined(i)){var a=this.getContents();a.find(".display-topfields-record").removeClass("display-topfields-selected");var s=a.find(HU.attrSelect(RECORD_INDEX,i)).parent();s.addClass("display-topfields-selected");var l=a.offset().top,r=a.scrollTop(),o=s.offset().top-l+r;a.scrollTop(o)}}}})}function RamaddaBlocksDisplay(t,e,i){const a=new RamaddaFieldsDisplay(t,e,DISPLAY_BLOCKS,i),s="blocks_header",l="blocks",r="blocks_footer";defineDisplay(addRamaddaDisplay(this),a,[{label:"Block"},{p:"animStep",d:0,ex:"1000",tt:"Animation delay (ms)"},{p:"doSum",d:!0,ex:"false",tt:""},{p:"numBlocks",d:1e3,ex:"1000",tt:"How many blocks to show"},{p:"header",d:!0,ex:"Each block represents ${blockValue} ... There were a total of ${total} ...",tt:""},{p:"blockIcon",d:null,ex:"fa-male",tt:"Use an icon"},{p:"emptyBlockStyle",d:"background:transparent;border:1px solid #ccc;",tt:"Style for blocks not displayed yet"}],{getContentsStyle:function(){return""},updateUI:function(){let t,e=this.getPropertyFields();if(!e||(t=this.filterData(),t)){if(this.counts=[],this.counts2=[],e){let i=this.getFieldsByIds(null,e);if(!i)return;this.footers=[],this.headers=[];let a=this.getNumBlocks(1e3);this.total=0,i.forEach((e=>{this.footers.push("${count} "+e.getLabel());let i=e.getValue(t[0]);isNaN(i)||(this.total+=i),this.counts.push(i)})),this.total>0&&(this.blockValue=this.total/a,this.counts.forEach((t=>{let e=(isNaN(t)?0:t/this.total)*a;this.counts2.push(e)})))}else{this.blockValue=0;let t=this.getProperty("counts","100",!0).split(";");for(var i=0;i<t.length;i++)this.counts.push(parseFloat(t[i]));if(this.getPropertyDoSum())this.counts2=this.counts;else{this.total=0;for(i=0;i<this.counts.length;i++){let t=this.counts[i];this.counts2.push(this.counts[i]-this.total),this.total+=t}}this.footers=this.getProperty("footers","",!0).split(";"),this.headers=this.getProperty("headers","",!0).split(";")}for(;this.footers.length<this.counts.length;)this.footers.push("");for(;this.headers.length<this.counts.length;)this.headers.push("");this.setContents(HU.div([CLASS,"display-blocks-header",STYLE,this.getProperty("headerStyle","",!0),ID,this.domId(s)])+HU.div([CLASS,"display-blocks-blocks",ID,this.domId(l)],"")+HU.div([CLASS,"display-blocks-footer",STYLE,this.getProperty("footerStyle","",!0),ID,this.domId(r)])),this.showBlocks(!0),this.getProperty("displayOnScroll")?HU.callWhenScrolled(this.domId(ID_DISPLAY_CONTENTS),(()=>{this.displayedBlocks||(this.displayedBlocks=!0,this.timeout&&clearTimeout(this.timeout),this.tmeout=setTimeout((()=>{this.showBlocks(!1)}),this.getPropertyAnimStep()))}),500):this.showBlocks(!1)}},showBlocks:function(t,e){Utils.isDefined(e)||(e=t?this.counts.length:0);let i="";i+=HU.openDiv([CLASS,"display-blocks"]);let a=this.getProperty("colors","#d73027,#fdae61,#74add1,#423E3B,red,green,blue",!0),o="string"==typeof a?a.split(","):a,n="";for(;o.length<this.counts.length;)o.push(o[o.length-1]);let h=parseFloat(this.getProperty("multiplier","1",!0)),d=this.getProperty("blockDimensions","8",!0),p=this.getProperty("labelStyle","",!0),g=this.getProperty("blockIcon"),c=g?"display-block-icon":"display-block",u=this.getEmptyBlockStyle();for(let a=0;a<this.counts2.length;a++){let s=h*this.counts[a];isNaN(s)&&(s=0);let l=this.footers[a].replace("${count}",Utils.formatNumberComma(s)),r=g?"":"width:"+d+"px;height:"+d+"px;",y="";if(t)r+=u;else if(a<e){g?y+=HU.css("color",o[a]):r+=HU.css("background",o[a]);let t=g?HU.getIconImage(g,null,[STYLE,y]):"";n+=HU.div([CLASS,c,STYLE,r],t)+" "+HU.span([STYLE,p],l)+"&nbsp;&nbsp;"}else r+=HU.css("background","transparent","border","1px solid #ccc"),n+="&nbsp;&nbsp;";let m=g?HU.getIconImage(g,null,[STYLE,y]):"";this.counts2[a];for(let t=0;t<1e4&&t<this.counts2[a];t++)i+=HU.div([CLASS,c,STYLE,r,TITLE,l],m);0}i+=HU.closeDiv();let y=this.getProperty("header","");y=y.replace("${total}",Utils.formatNumberComma(this.total)).replace("${blockValue}",Utils.formatNumberComma(Math.round(this.blockValue))),this.jq(s).html(y),this.jq(l).html(i),this.jq(r).html(n),e<this.counts.length&&(this.getPropertyAnimStep()?(this.timeout&&clearTimeout(this.timeout),this.timeout=setTimeout((()=>{this.showBlocks(!1,e+1)}),this.getPropertyAnimStep())):this.showBlocks(!1,e+1))}})}function RamaddaTextstatsDisplay(t,e,i){const s=new RamaddaBaseTextDisplay(t,e,DISPLAY_TEXTSTATS,i);defineDisplay(addRamaddaDisplay(this),s,[],{updateUI:function(){let t={},e=this.processText(t);if(null==e)return;let i=this.filterData(),s=this.getData().getRecordFields(),l=this.getSelectedFields(s);0==l.length&&(l=s);this.getFieldsByType(l,"string");let r="",o=[],n=parseInt(this.getProperty("maxWords",-1)),h=parseInt(this.getProperty("minCount",0)),d=this.getProperty("showBars",!0),p=(this.getProperty("barsScale",10),this.getProperty("barColor","blue")),g=parseInt(this.getProperty("barWidth","400"));for(a in e){let s=e[a];s.field;for(word in s.counts){let t=s.counts[word];o.push({word:word,count:t})}if(o.sort((function(t,e){return t.count<e.count?-1:t.count>e.count?1:0})),h>0){let t=[];for(let e=0;e<o.length;e++)o[e].count>=h&&t.push(o[e]);o=t}if(n>0){let t=[];for(let e=0;e<=n&&e<o.length;e++)o[e].count>=h&&t.push(o[e]);o=t}let l=0,c=0;o.length>0&&(c=o[0].count,l=o[o.length-1].count);let u=[];for(a in t.lengths)u.push({length:parseInt(a),count:t.lengths[a]});u.sort((function(t,e){return t.length<e.length?-1:t.length>e.length?1:0})),l=0,c=0;for(let t=0;t<u.length;t++)c=0==t?u[t].count:Math.max(c,u[t].count),l=0==t?u[t].count:Math.min(l,u[t].count);this.getProperty("showFieldLabel",!0)&&(r+=HU.b(s.field.getLabel())+"<br>");let y="20%",m="10%";if(this.getProperty("showSummary",!0)&&(r+=HU.openTag("table",[CLASS,"nowrap ramadda-table",ID,this.domId("table_summary")]),r+=HU.openTag("thead",[]),r+=HU.tr([],HU.th(["width",y],"Summary")+HU.th([],"&nbsp;")),r+=HU.closeTag("thead"),r+=HU.openTag("tbody",[]),r+=HU.tr([],HU.td(["align","right"],"Total lines:")+HU.td([],i.length)),r+=HU.tr([],HU.td(["align","right"],"Total words:")+HU.td([],t.count)),r+=HU.tr([],HU.td(["align","right"],"Average word length:")+HU.td([],Math.round(t.total/t.count))),r+=HU.closeTag("tbody"),r+=HU.closeTag("table"),r+="<br>"),this.getProperty("showCounts",!0)){r+=HU.openTag("table",[CLASS,"row-border nowrap ramadda-table",ID,this.domId("table_counts")]),r+=HU.openTag("thead",[]),r+=HU.tr([],HU.th(["width",y],"Word Length")+HU.th(["width",m],"Count")+(d?HU.th([],""):"")),r+=HU.closeTag("thead"),r+=HU.openTag("tbody",[]);for(let t=0;t<u.length;t++){let e=HU.td([],u[t].length)+HU.td([],u[t].count);if(d){let i=2+(u[t].count-l)/c*g,a=p,s=HU.div([STYLE,"height:10px;width:"+i+"px;background:"+a],"");e+=HU.td([],s)}r+=HU.tr([],e)}r+=HU.closeTag("tbody"),r+=HU.closeTag("table"),r+="<br>"}if(this.getProperty("showFrequency",!0)){r+=HU.openTag("table",[CLASS,"row-border ramadda-table",ID,this.domId("table_frequency")]),r+=HU.openTag("thead",[]),r+=HU.tr([],HU.th(["width",y],"Word")+HU.th(["width",m],"Frequency")+(d?HU.th([],""):"")),r+=HU.closeTag("thead"),r+=HU.openTag("tbody",[]);let t=0,e=0;o.length>0&&(t=o[0].count,e=o[o.length-1].count);let i=0;for(let t=0;t<o.length;t++)i+=o[t].count;for(let a=o.length-1;a>=0;a--){let s=Math.round(o[a].count/i*1e4)/100,l=HU.td([],o[a].word+"&nbsp;:&nbsp;")+HU.td([],o[a].count+"&nbsp;&nbsp;("+s+"%)&nbsp;:&nbsp;");if(d){let i=2+(o[a].count-t)/e*g,s=p,r=HU.div([STYLE,"height:10px;width:"+i+"px;background:"+s],"");l+=HU.td([],r)}r+=HU.tr([],l)}r+=HU.closeTag("tbody"),r+=HU.closeTag("table")}}this.setContents(r);let c=this.getProperty("tableHeight","200");this.getProperty("showSummary",!0)&&HU.formatTable("#"+this.domId("table_summary"),{scrollY:this.getProperty("tableSummaryHeight",c)}),this.getProperty("showCounts",!0)&&HU.formatTable("#"+this.domId("table_counts"),{scrollY:this.getProperty("tableCountsHeight",c)}),this.getProperty("showFrequency",!0)&&HU.formatTable("#"+this.domId("table_frequency"),{scrollY:this.getProperty("tableFrequenecyHeight",c),searching:this.getProperty("showSearch",!0)},(t=>{this.frequencyTable=t,this.frequencyTable.on("search.dt",(()=>{this.settingSearch||this.propagateEvent(DisplayEvent.propertyChanged,{property:"searchValue",value:this.frequencyTable.search()})}))}))},handleEventPropertyChanged:function(t,e){if("searchValue"==e.property)return this.settingSearch=!0,this.setProperty("searchValue",e.value),this.frequencyTable.search(e.value),this.frequencyTable.draw(),void(this.settingSearch=!1);s.handleEventPropertyChanged.call(this,t,e)}})}function RamaddaFrequencyDisplay(t,e,i){const a=new RamaddaBaseTextDisplay(t,e,DISPLAY_FREQUENCY,i);defineDisplay(addRamaddaDisplay(this),a,[{label:"Frequency"},{p:"orientation",ex:"vertical"},{p:"tableHeight",ex:"300px"},{p:"showPercent",ex:"false"},{p:"showCount",ex:"false"},{p:"showBars",ex:"true"},{p:"showBars",ex:"false"},{p:"showHeader",ex:"false"},{p:"banner",ex:"true"},{p:"barWidth",ex:"200"},{p:"clickFunction",ex:"selectother"}],{updateUI:function(){let t=this.filterData();if(!t)return;let e=this.getData().getRecordFields(),i=this.getSelectedFields(e);0==i.length&&(i=e);let a={};for(let t=0;t<i.length;t++){let e=i[t];Utils.isDefined(a[e.getId()])||(a[e.getId()]={counts:{},values:[],min:null,max:null,total:0,numbers:[],field:e})}let s=this.getProperty("showCount",!0),l=this.getProperty("showPercent",!0),r=this.getProperty("showBars",!1),o=+this.getProperty("barWidth",200);for(let e=0;e<t.length;e++){let s=this.getDataValues(t[e]);for(let t=0;t<i.length;t++){let e=i[t],l=a[e.getId()],r=s[e.getIndex()];if(Utils.isDefined(l.min)||(l.min=r,l.max=r),e.isNumeric())l.numbers.push(r),isNaN(l.max)?l.max=r:isNaN(r)||(l.max=Math.max(r,l.max)),isNaN(l.min)?l.min=r:isNaN(r)||(l.min=Math.min(r,l.min));else{if(!Utils.isDefined(l.counts[r])){let t={value:r,count:0};l.counts[r]=t,l.values.push(t)}l.total++,l.counts[r].count++}}}let n="",h="";for(let t=0;t<i.length;t++){h+="<div style='text-align:center;'>";let e=i[t],d=a[e.getId()];if(e.isNumeric()){let t=parseFloat(this.getProperty("numBins",10,!0));d.bins=[];let i=d.max-d.min,a=(d.max-d.min)/t,s="Not defined";d.bins.push(s);let l={value:s,count:0};d.counts[s]=l,d.values.push(l);let r,o=this.getProperty(e.getId()+".bins");if(Utils.stringDefined(o)){let t=o.split(",");r=[],t.map((t=>r.push(+t)));for(let e=0;e<t.length-1;e++){let i=+t[e]+" - "+ +t[e+1];d.bins.push(i);let a={value:i,count:0};d.counts[i]=a,d.values.push(a)}}else for(let e=0;e<t;e++){let t=Utils.formatNumber(d.min+a*e)+" - "+Utils.formatNumber(d.min+a*(e+1));d.bins.push(t);let i={value:t,count:0};d.counts[t]=i,d.values.push(i)}for(let e=0;e<d.numbers.length;e++){let s=d.numbers[e],l=0;if(!isNaN(s))if(r){for(let t=0;t<r.length-1;t++)if(s>=r[t]&&s<r[t+1]){l=t;break}}else if(0!=a){let e=(s-d.min)/i;l=Math.round(e/(1/t))+1,l>t&&(l=t)}let o=d.bins[l];if(!Utils.isDefined(d.counts[o])){let t={value:d.bins[l],count:0};d.counts[o]=t,d.values.push(t)}d.total++,d.counts[o].count++}}let p="vertical"!=this.getProperty("orientation","");if(null!=this.getProperty("floatTable")&&(p=1==this.getProperty("floatTable")),n+=HU.openTag("div",[CLASS,"display-frequency-table",STYLE,p?"":"display:block;"]),n+=HU.openTag("table",["cellpadding","3",ID,this.domId("summary"+t),"table-height",this.getProperty("tableHeight","300",!0),CLASS,"stripe row-border nowrap ramadda-table"]),this.getProperty("showHeader",!0)){n+=HU.openTag("thead",[]);let t=HU.span([TITLE,"Click to reset",CLASS,"display-frequency-label","data-field",d.field.getId()],e.getLabel());t=HU.div([STYLE,"max-width:500px;overflow-x:auto;"],t);let i=s?HU.th(["align","right","width","20%"],HU.div([STYLE,"text-align:right"],"Count")):"",a=l?HU.th(["align","right","width","20%"],HU.div([STYLE,"text-align:right"],"Percent")):"",h=r?HU.th(["align","right","width",o],HU.div([STYLE,"text-align:right"],"&nbsp;")):"";n+=HU.tr([],HU.th(["xxwidth","60%"],t+i+a+h)),n+=HU.closeTag("thead")}n+=HU.openTag("tbody",[]);let g=this.getColorTable(!0),c=this.getProperty("barColor","blue");if(g)for(let t=0;t<d.values.length;t++){d.values[t].value;t<g.length?d.values[t].color=g[t]:d.values[t].color=g[g.length-1]}e.isNumeric()||d.values.sort(((t,e)=>t.count<e.count?1:t.count>e.count?-1:0));let u=0;for(let t=0;t<d.values.length;t++){let e=d.values[t].count;if(0==e)continue;let i=e/d.total;u=Math.max(u,i)}for(let t=0;t<d.values.length;t++){let e=d.values[t].value,i=e;""==i&&(i="&lt;blank&gt;");let a=d.values[t].count;if(0==a)continue;let p=a/d.total;e=e.replace(/\'/g,"&apos;");let g=a,y=d.values[t].color;y||(y=c),l&&(g+=" ("+Math.round(100*p)+"%)"),h+=HU.div([TITLE,"Click to select",CLASS," display-frequency-item","data-field",d.field.getId(),"data-value",e],e+"<br>"+g);let m=HU.td([],e),f=s?HU.td(["align","right"],a):"",D=l?HU.td(["align","right"],0==d.total?"0":Math.round(100*p)+"%"):"",I=p/u,T=r?HU.td(["valign","center","width",o],HU.div([TITLE,Math.round(100*p)+"%",STYLE,"background:"+y+";height:10px;width:"+Math.round(I*o)+"px"],"")):"";n+=HU.tr([],m+f+D+T)}n+=HU.close(TBODY,TABLE,DIV),h+=HU.close(TD)}this.getProperty("banner",!1)&&(n=HU.div([CLASS,"display-frequency-banner"],h)),this.setContents(n);let d=this,p=this.find(".display-frequency-item");if(p.click((function(){let t=d.getProperty("clickFunction"),e=$(this).attr("data-value"),i=$(this).attr("data-field"),a=($(this).parent(),$(this).hasClass("display-frequency-item-selected"));p.removeClass("display-frequency-item-selected"),a?e=FILTER_ALL:$(this).addClass("display-frequency-item-selected"),t&&"select"!=t?"selectother"==t&&d.propagateEvent(DisplayEvent.fitlerChanged,{value:e,id:d.getFilterId(i),fieldId:i}):d.handleEventPropertyChanged(d,{property:"pattern",fieldId:i,value:e})})),this.find(".display-frequency-label").click((function(){let t=$(this).attr("data-field");d.handleEventFilterChanged(d,{id:ID,fieldId:t,value:"-all-"})})),this.getProperty("showHeader",!0))for(let t=0;t<i.length;t++)HU.formatTable("#"+this.domId("summary"+t),{})}})}function RamaddaTextanalysisDisplay(t,e,i){const a=new RamaddaBaseTextDisplay(t,e,DISPLAY_TEXTANALYSIS,i);defineDisplay(addRamaddaDisplay(this),a,[],{checkLayout:function(){this.updateUIInner()},updateUI:function(){var t="<script src='"+ramaddaCdn+"/lib/compromise.min.js'><\/script>";this.writeHtml(ID_DISPLAY_TOP,t);let e=this;var i=function(){window.nlp?e.updateUIInner():setTimeout(i,100)};setTimeout(i,100)},updateUIInner:function(){if(!this.filterData())return null;let t=this;this.setDisplayMessage("Processing text...");setTimeout((function(){t.updateUIInnerInner()}),10)},updateUIInnerInner:function(){let t=this.filterData();var e=this.getData().getRecordFields(),i=this.getSelectedFields(e);0==i.length&&(i=e);var a=this.getFieldsByIds(i,"fields");if(0==a.length&&(a=this.getFieldsByType(i,"string")),0==a.length)return this.displayError("No string fields specified"),null;if(!this.lastRecords||this.lastRecords.length!=t.length){this.lastRecords=t;for(var s="",l=0;l<t.length;l++){for(var r=this.getDataValues(t[l]),o="",n=0;n<a.length;n++){o+=" ",o+=r[i[n].getIndex()]}s+=o,s+="\n"}this.nlp=window.nlp(s)}var h=this.nlp,d=[];if(this.getProperty("showPeople",!1)&&d.push(this.printList("People",h.people().out("topk"))),this.getProperty("showPlaces",!1)&&d.push(this.printList("Places",h.places().out("topk"))),this.getProperty("showOrganizations",!1)&&d.push(this.printList("Organizations",h.organizations().out("topk"))),this.getProperty("showTopics",!1)&&d.push(this.printList("Topics",h.topics().out("topk"))),this.getProperty("showNouns",!1)&&d.push(this.printList("Nouns",h.nouns().out("topk"))),this.getProperty("showVerbs",!1)&&d.push(this.printList("Verbs",h.verbs().out("topk"))),this.getProperty("showAdverbs",!1)&&d.push(this.printList("Adverbs",h.adverbs().out("topk"))),this.getProperty("showAdjectives",!1)&&d.push(this.printList("Adjectives",h.adjectives().out("topk"))),this.getProperty("showClauses",!1)&&d.push(this.printList("Clauses",h.clauses().out("topk"))),this.getProperty("showContractions",!1)&&d.push(this.printList("Contractions",h.contractions().out("topk"))),this.getProperty("showPhoneNumbers",!1)&&d.push(this.printList("Phone Numbers",h.phoneNumbers().out("topk"))),this.getProperty("showValues",!1)&&d.push(this.printList("Values",h.values().out("topk"))),this.getProperty("showAcronyms",!1)&&d.push(this.printList("Acronyms",h.acronyms().out("topk"))),this.getProperty("showNGrams",!1)&&d.push(this.printList("NGrams",h.ngrams().out("topk"))),this.getProperty("showDates",!1)&&d.push(this.printList("Dates",h.dates().out("topk"))),this.getProperty("showQuotations",!1)&&d.push(this.printList("Quotations",h.quotations().out("topk"))),this.getProperty("showUrls",!1)&&d.push(this.printList("URLs",h.urls().out("topk"))),this.getProperty("showStatements",!1)&&d.push(this.printList("Statements",h.statements().out("topk"))),this.getProperty("showTerms",!1)&&d.push(this.printList("Terms",h.terms().out("topk"))),this.getProperty("showPossessives",!1)&&d.push(this.printList("Possessives",h.possessives().out("topk"))),0!=d.length){this.getProperty("height","400");for(var p=HU.openTag("div",[ID,this.domId("tables")]),g=0;g<d.length;g+=3){var c=d[g],u=g+1<d.length?d[g+1]:null,y=g+2<d.length?d[g+2]:null,m=u?y?"33%":"50%":"100%",f="padding:5px";r="";r+=HU.td(["width",m],HU.div([STYLE,f],c)),u&&(r+=HU.td(["width",m],HU.div([STYLE,f],u))),y&&(r+=HU.td(["width",m],HU.div([STYLE,f],y))),p+=HU.tag("table",["width","100%"],HU.tr(r))}p+=HU.closeTag("div"),this.setContents(p),HU.formatTable("#"+this.domId("tables")+" .ramadda-table",{scrollY:this.getProperty("tableHeight","200")})}else this.setDisplayMessage("No text types specified")},printList:function(t,e){var i=parseInt(this.getProperty("maxWords",10)),a=parseInt(this.getProperty("minCount",0)),s=HU.openTag("table",["width","100%",CLASS,"stripe hover ramadda-table"])+HU.openTag("thead",[]);s+=HU.tr([],HU.th([],t)+HU.th([],"&nbsp;")),s+=HU.close(THEAD),s+=HU.open(TBODY);for(var l=0,r=0;r<e.length;r++)if(!(e[r].count<a)){var o=HU.td([],e[r].normal)+HU.td([],e[r].count+" ("+e[r].percent+"%)");if(s+=HU.tr([],o),l++>i)break}return s+=HU.close(TBODY,TABLE)}})}function RamaddaTextrawDisplay(t,e,i){const a="text",s="label",l="search",r="shrink",o=new RamaddaBaseTextDisplay(t,e,DISPLAY_TEXTRAW,i);defineDisplay(addRamaddaDisplay(this),o,[{label:"Raw Text"},{p:"doBubble",ex:"true"},{p:"addLineNumbers",ex:"false"},{p:"labelTemplate",ex:"${lineNumber}"},{p:"maxLines",ex:"1000"},{p:"pattern",ex:"initial search pattern"},{p:"fromField",ex:""},{p:"linesDescriptor",ex:""},{p:"asHtml",ex:"false"},{p:"breakLines",ex:"true"},{p:"includeEmptyLines",ex:"false"}],{doShrink:i.initialShrink,checkLayout:function(){this.updateUI()},updateUI:function(){if(!this.filterData())return null;var t=this.getData();this.allRecords=t.getRecords();var e=this.getProperty("pattern");e&&0==e.length&&(e=null),e&&(e=e.replace(/"/g,"&quot;"));let i="";this.filters&&0!=this.filters.length||(i+=" "+HU.input("pattern",e||"",["placeholder","Search text",ID,this.domId(l)])),this.showShrink=this.getProperty("showShrink",!1),this.showShrink&&(i+=" "+HU.checkbox("shrink",[ID,this.domId(r)],this.getProperty("initialShrink",!0))+" Shrink "),this.writeHtml(ID_TOP_RIGHT,HU.span([ID,this.domId(s)]," ")+i);let o=this;this.jq(r).click((function(){o.doShrink=o.jq(r).is(":checked"),o.setProperty("initialShrink",o.doShrink),o.updateUI()})),this.jq(l).keypress((function(t){13==t.which&&(o.setProperty("pattern",$(this).val()),o.propagateEvent(DisplayEvent.propertyChanged,{property:"pattern",value:$(this).val()}),o.updateUI())}));var n=this.getProperty("height","600"),h=this.getProperty("displayInnerStyle",""),d=HU.div([ID,this.domId(a),STYLE,"padding:4px;border:1px #ccc solid; max-height:"+n+"px;overflow-y:auto;"+h]);this.setContents(d);new Date;this.showText();new Date},handleEventPropertyChanged:function(t,e){if("pattern"==e.property)return this.setProperty("pattern",e.value),void this.updateUI();o.handleEventPropertyChanged.call(this,t,e)},showText:function(){let t=this,e=this.filterData();if(!e)return null;this.records=e,this.recordToIndex={},this.indexToRecord={};var i=this.getProperty("pattern");i&&0==i.length&&(i=null);var r=this.getProperty("asHtml",!0),o=this.getProperty("addLineNumbers",!0),n=this.getProperty("labelTemplate",""),h="10px";""==n&&(h="1px"),""==n&&o&&(n="${lineNumber}"),n&&(r=!0);var d,p,g=parseInt(this.getProperty("maxLines",1e5)),c=(parseInt(this.getProperty("lineLength",1e4)),this.getProperty("breakLines",!0)),u=this.getProperty("includeEmptyLines",!1),y=this.getData().getRecordFields(),m=this.getSelectedFields(y);if(0==m.length&&(m=y),0==this.getFieldsByType(m,"string").length)return this.displayError("No string fields specified"),null;this.getProperty("highlights")&&(d=[],p=this.getProperty("highlightStyles","background:rgb(250_comma_0_comma_0);").split(","),this.getProperty("highlights","").split(",").map((t=>{t.indexOf("(")<0&&(t="("+t+")"),d.push(RegExp(t,"ig"))})));var f=HU.openTag("div",[STYLE,"position:relative;"]);f+=HU.div([ID,this.domId("overlay"),STYLE,"position:absolute;top:0;left:0;"],HU.tag("table",[ID,this.domId("overlaytable")]));var D=this.getFieldById(null,this.getProperty("fromField")),I=this.getProperty("doBubble",!1);n&&(f+="<table width=100%>");var T=0,b=0,S=new TextMatcher(i),v={},x={};this.filters&&this.filters.map((t=>{t.field&&t.field.isString&&(x[t.field.getId()]=t)}));var U={};m.map((t=>{U[t.getId()]=this.getProperty(t.getId()+".template")}));var L=this.getColorByInfo(e),E=this.getProperty("delimiter",""),P=this.showShrink?this.getProperty("rowScale",.3):null;this.showShrink&&(f+=HU.tr([],HU.td([],HU.getIconImage("fa-caret-down"))));let C=this.getFields(),A=this.getTemplateProps(C),w=Utils.tokenizeMacros(n||"");for(var H=0;H<e.length;H++){var R=e[H];Utils.isDefined(R.lineNumber)||(R.lineNumber=H+1),this.indexToRecord[H]=R,this.recordToIndex[R.getId()]=H;for(var k=this.getDataValues(R),_="",F=0;F<m.length;F++){var M=m[F];if(0==H&&x[M.getId()]){let t=x[M.getId()];if(O=t.getFieldValues()){Array.isArray(O)||(O=[O]);try{v[M.getId()]=[],O.map((t=>{if(""!=t&&t!=FILTER_ALL){var e=new TextMatcher(t);v[M.getId()].push(e)}}))}catch(t){console.log("Error making regexp:"+t)}}}O=(O=""+k[M.getIndex()]).replace(/</g,"&lt;").replace(/>/g,"&gt;"),v[M.getId()]&&v[M.getId()].map((t=>{O=t.highlight(O)})),""!=_&&(_+=E+" "),U[M.getId()]&&(O=U[M.getId()].replace("${value}",O)),_+=O}if(_=_.trim(),!u&&0==_.length)continue;T++;var N=["valign","top"],B="";if(L.index>=0){var O=R.getData()[L.index],Y=L.getColor(O,R);Y&&(N.push(STYLE),B+="background:"+Utils.addAlphaToColor(Y,"0.25")+";")}N.push(CLASS),N.push("display-raw-row");var G=S.matches(_),V=G&&S.hasPattern();if(V&&(N.push("matched"),N.push(!0)),P)V||(B+="-webkit-transform: scale(1,"+P+");",B+="line-height:"+P+";",N.push(STYLE),N.push(B));else if(!G)continue;if(_=S.highlight(_),++b>g)break;let t=[TITLE," ",CLASS," display-raw-line ",RECORD_INDEX,H];if(I&&(_=HU.div([CLASS,"ramadda-bubble"],_)),D&&(_+=HU.div([CLASS,"ramadda-bubble-from"],""+k[D.getIndex()])),d)for(var q=0;q<d.length;q++){var j=d[q],W=q<p.length?p[q]:p[p.length-1];W=W.replace(/_comma_/g,","),_=_.replace(j,"<span style='"+W+"'>$1</span>")}if(_=HU.div(t,_),n){let t=this.getDataValues(R),e=this.applyRecordTemplate(R,t,C,n,A,w);var z=R.lineNumber;Utils.isDefined(z),e=e.replace("${lineNumber}","#"+z),e=e.replace(/ /g,"&nbsp;");var X="";this.showShrink&&(X+=HU.td([WIDTH,"5px",STYLE,HU.css("background","#ccc")],HU.getIconImage("fa-caret-right",null,[STYLE,"line-height:0px;"]))),X+=HU.td([WIDTH,h],"<a name=line_"+T+"></a><a href=#line_"+T+">"+e+"</a>&nbsp;  ")+HU.td([],_),f+=HU.tr(N,X)}else f+=_,r?f+=c?"<p>":"<br>":(f+="\n",c&&(f+="\n"))}o&&(f+=HU.close(TABLE)),f+=HU.close(DIV),r||(f=HU.tag(PRE,[],f)),this.writeHtml(a,f),L.displayColorTable();var J=" "+this.getProperty("linesDescriptor","lines"),K=b+J;if(this.allRecords.length!=b&&(K=b+"/"+this.allRecords.length+J+" ("+Math.round(b/this.allRecords.length*100)+"%)"),this.jq(s).html(K),this.jq(l).focus(),P){var Z=this.jq(a).find(".display-raw-row"),Q=function(){$(this).css("transform","scaleY(1)"),$(this).css("line-height","1.5"),$(this).css("border-bottom","1px solid #ccc"),$(this).css("border-top","1px solid #ccc")},tt=function(){var t=this;$(t).attr("matched")||($(t).css("transform","scaleY("+P+")"),$(t).css("line-height",P),$(t).css("border-bottom","0px solid #ccc"),$(t).css("border-top","0px solid #ccc"))};Z.each(tt),Z.mouseenter(Q),Z.mousemove(Q),Z.mouseout(tt)}let et=this.jq(a).find(".display-raw-line");et.click((function(){var e=$(this).attr(RECORD_INDEX),i=t.indexToRecord[e];i&&(t.showRecordPopup($(this),i),t.propagateEventRecordSelection({record:i}),t.highlightLine(e))})),this.makeTooltips(et,e)},highlightLine:function(t){var e=this.jq(a);e.find(".display-raw-line").removeClass("display-raw-line-selected");var i=HU.attrSelect(RECORD_INDEX,t);e.find(i).addClass("display-raw-line-selected")},handleEventRecordSelection:function(t,e){var i=this.findMatchingIndex(e.record).index;if(!(i<0)&&Utils.isDefined(i)){this.highlightLine(i);var s=this.jq(a),l=HU.attrSelect(RECORD_INDEX,i),r=s.find(l),o=s.offset().top,n=s.scrollTop(),h=r.offset().top-o+n;s.scrollTop(h)}}})}function RamaddaTextDisplay(t,e,i){const a=new RamaddaDisplay(t,e,DISPLAY_TEXT,i);i.recordTemplate||(i.recordTemplate="${default}"),defineDisplay(addRamaddaDisplay(this),a,[{label:"Text Display"},{p:"recordTemplate",ex:""},{p:"showDefault",d:!0,ex:"false"},{p:"message",d:null,ex:""}],{needsData:function(){return!0},handleAnnotation:function(){let t=null,e=this.getProperty("template","${date} - ${description}"),i=Utils.tokenizeMacros(e),a={},s=null;if(this.selectedRecord&&(t=this.annotations.getAnnotationFromDate(s=this.selectedRecord.getDate())),t||(t=this.annotations.getAnnotationFromDate(s=this.getAnimation().getBeginTime())),a.date=s||"",!t)return void this.setContents("");a.description=t.description,a.label=t.label,this.annotations.getShowLegend()?a.legend=this.annotations.getLegend():a.legend="";let l=i.apply(a);this.getProperty("decorate",!0)&&(l=this.getMessage(l)),this.setContents(l)},updateUI:function(){if(a.updateUI.call(this),this.getProperty("annotations")){if(null==this.getData())return;if(this.annotations||(this.annotations=new Annotations(this,this.filterData())),this.annotations.isEnabled())return void this.handleAnnotation()}if(this.selectedRecord)this.setContents(this.getRecordHtml(this.selectedRecord));else if(this.getPropertyShowDefault()){this.recordMap={};let t=this.filterData();t&&t.length>0&&(t.forEach(((t,e)=>{this.recordMap[t.getId()]=t})),this.selectedRecord=t[0],this.setContents(this.getRecordHtml(t[0])))}else this.getPropertyMessage()&&this.setDisplayMessage(this.getPropertyMessage())},pointDataLoaded:function(t,e,i){this.selectedRecord=null,a.pointDataLoaded.call(this,t,e,i)},handleEventRecordSelection:function(t,e){this.recordMap&&!this.recordMap[e.record.getId()]||(this.selectedRecord=e.record,this.updateUI())}})}function RamaddaGlossaryDisplay(t,e,i){const a=new RamaddaFieldsDisplay(t,e,DISPLAY_GLOSSARY,i),s="glossary_header";defineDisplay(addRamaddaDisplay(this),a,[{label:"Glossary"},{p:"wordField",ex:""},{p:"definitionField",ex:""}],{updateUI:function(){let t=this.filterData();if(!t)return;let e=this.getFieldById(null,this.getProperty("wordField")),i=this.getFieldById(null,this.getProperty("definitionField"));if(!e)return void this.displayError("No word field specified");if(!i)return void this.displayError("No definition field specified");let a={};t.forEach((t=>{let s=String(e.getValue(t)).trim(),l=i.getValue(t),r=s.substring(0,1).toUpperCase();(a[r]||(a[r]=[])).push({word:s,definition:l,record:t})}));let l=this.getFilterTextMatchers(),r=HU.div([CLASS,"display-glossary-letter"],"All"),o="";Object.keys(a).sort().forEach((t=>{let e=t.trim();e=""==e?"_":e;let i=" display-glossary-letter ";if(this.searchLetter==e&&(i+=" display-glossary-letter-highlight "),r+=HU.div([CLASS,i,"letter",e],e),this.searchLetter&&this.searchLetter!=e)return;let s=HU.div([CLASS,"display-glossary-group-header"],e)+HU.openTag(DIV,[CLASS,"display-glossary-group-inner"]);a[t].sort(((t,e)=>t.word.localeCompare(e.word))).forEach((t=>{let e=String(t.definition);l.forEach((t=>{e=t.highlight(e)}));let i=HU.div([CLASS,"display-glossary-word"],t.word)+HU.div([CLASS,"display-glossary-definition"],e);s+=HU.div([TITLE,"",CLASS,"display-glossary-entry",RECORD_ID,t.record.getId()],i)})),s+=HU.closeTag(DIV),o+=s}));let n=this.getProperty("glossaryHeight","600px");r=HU.div([ID,this.domId(s),CLASS,"display-glossary-header"],r),o=HU.div([STYLE,HU.css("max-height",HU.getDimension(n),"overflow-y","auto")],o),this.setContents(r+o);let h=this;this.jq(s).find(".display-glossary-letter").click((function(){h.searchLetter=$(this).attr("letter"),h.forceUpdateUI()})),this.makeTooltips(this.find(".display-glossary-entry"),t)}})}addGlobalDisplayType({type:DISPLAY_TEXT,label:"Text Readout",requiresData:!0,forUser:!0,category:CATEGORY_TEXT,tooltip:makeDisplayTooltip("Simple text display","text.png")}),addGlobalDisplayType({type:DISPLAY_TEMPLATE,label:"Template",requiresData:!0,forUser:!0,category:CATEGORY_TEXT,tooltip:makeDisplayTooltip("Flexible text template to show records","template.png")}),addGlobalDisplayType({type:DISPLAY_TOPFIELDS,label:"Top Fields",requiresData:!0,forUser:!0,category:CATEGORY_MISC,tooltip:makeDisplayTooltip("List Fields","topfields.png","For every row it sorts the field values and lists the field names")}),addGlobalDisplayType({type:DISPLAY_WORDCLOUD,forUser:!0,label:"Word Cloud",requiresData:!0,category:CATEGORY_TEXT,tooltip:makeDisplayTooltip("Cloud of words","wordcloud.png")}),addGlobalDisplayType({type:DISPLAY_TEXTSTATS,forUser:!0,label:"Text Stats",requiresData:!0,category:CATEGORY_TEXT,tooltip:makeDisplayTooltip("Summary statistics for text","textstats.png","Incudes line/word count, word length and frequency")}),addGlobalDisplayType({type:DISPLAY_FREQUENCY,forUser:!0,label:"Frequency",requiresData:!0,category:CATEGORY_TEXT,tooltip:makeDisplayTooltip("Text field based frequencies","frequency.png")}),addGlobalDisplayType({type:DISPLAY_TEXTRAW,forUser:!0,label:"Text Raw",requiresData:!0,category:CATEGORY_TEXT,tooltip:makeDisplayTooltip("Shows raw text","textraw.png","Provides a search field")}),addGlobalDisplayType({type:DISPLAY_TEXTANALYSIS,forUser:!0,label:"Text Analysis",requiresData:!0,category:CATEGORY_TEXT,tooltip:makeDisplayTooltip("Analyzes text","textanalysis.png")}),addGlobalDisplayType({type:DISPLAY_BLOCKS,forUser:!0,label:"Blocks",requiresData:!0,category:CATEGORY_MISC,tooltip:makeDisplayTooltip("Blocks","blocks.png","Shows a certain number of small blocks or<br> icons color coded from the data")}),addGlobalDisplayType({type:DISPLAY_GLOSSARY,forUser:!0,label:"Glossary",requiresData:!0,category:CATEGORY_TEXT,tooltip:makeDisplayTooltip("Searchable glossary","glossary.png")});let DISPLAY_ENTRYLIST="entrylist",DISPLAY_TESTLIST="testlist",DISPLAY_ENTRYDISPLAY="entrydisplay",DISPLAY_ENTRY_GALLERY="entrygallery",DISPLAY_ENTRY_GRID="entrygrid",DISPLAY_OPERANDS="operands",DISPLAY_METADATA="metadata",DISPLAY_ENTRYTIMELINE="entrytimeline",DISPLAY_REPOSITORIES="repositories",DISPLAY_ENTRYTITLE="entrytitle",DISPLAY_SEARCH="search",DISPLAY_SIMPLESEARCH="simplesearch",ID_RESULTS="results",ID_SEARCH_FORM="searchform",ID_SEARCH_HEADER="searchheader",ID_SEARCH_BAR="searchbar",ID_SEARCH_TAG="searchtag",ID_SEARCH_TAG_GROUP="searchtaggroup",ID_ENTRIES="entries",ID_DETAILS_INNER="detailsinner",ID_DETAILS_ANCESTORS="detailsancestors",ID_DETAILS_TAGS="detailstags",ID_DETAILS_TYPE="detailstype",ID_PROVIDERS="providers",ID_SEARCH_ORDERBY="orderby",ID_SEARCH_SETTINGS="searchsettings",ID_SEARCH_AREA="search_area",ID_SEARCH_DATE_RANGE="search_date",ID_SEARCH_DATE_CREATE="search_createdate",ID_SEARCH_TAGS="search_tags",ID_SEARCH_ANCESTOR="search_ancestor",ID_TREE_LINK="treelink",ATTR_ENTRYID="entryid",ID_SEARCH="search",ID_FORM="form",ID_TEXT_FIELD="textfield",ID_ANCESTOR="ancestor",ID_ANCESTOR_NAME="ancestorname",ID_TYPE_FIELD="typefield",ID_TYPE_DIV="typediv",ID_TYPEFIELDS="typefields",ID_METADATA_FIELD="metadatafield",ID_COLUMN="column",ID_SEARCH_HIDEFORM="searchhideform";function RamaddaEntryDisplay(t,e,i,a){const s=new RamaddaDisplay(t,e,i,a);RamaddaUtil.inherit(this,s),this.defineProperties([{label:"Entry Search"},{p:"providers",ex:"this,category:.*",tt:"List of search providers"}]),this.ramaddas=new Array;let l=this.getProperty("repositories",this.getProperty("repos",null));if(null!=l){let t=l.split(",");for(let e=0;e<t.length;e++){let i=t[e];i=i.trim(),this.ramaddas.push(getRamadda(i))}if(this.ramaddas.length>0){let t=new RepositoryContainer("all","All entries");addRepository(t);for(let e=0;e<this.ramaddas.length;e++)t.addRepository(this.ramaddas[e]);this.ramaddas.push(t),this.setOriginalRamadda(this.ramaddas[0]),this.setRamadda(this.ramaddas[0])}}RamaddaUtil.defineMembers(this,{searchSettings:new EntrySearchSettings({parent:a.searchEntryParent||a.entryParent,provider:a.provider,text:a.searchEntryText||a.entryText,entryType:a.searchEntryType,orderBy:a.orderBy,ancestor:a.searchAncestor||a.ancestor}),entryList:a.entryList,entryMap:{},writeEntries:function(t,e){this.jq(ID_ENTRIES).html(t)},writeMessage:function(t){this.jq(ID_RESULTS).html(t)},writeResults:function(t){this.jq(ID_RESULTS).html(t)},getSearchSettings:function(){if(null!=this.getPropertyProviders()){let t=this.searchSettings.provider,e=this.jq(ID_PROVIDERS).val();null!=e?t=e:this.getPropertyProviders().forEach((e=>{t=e.id}));let i=this.getRamadda(),a=!0;i&&i.getId()==t&&(a=!1),this.searchSettings.provider=a?t:null}return this.searchSettings},getEntries:function(){return null==this.entryList?[]:this.entryList.getEntries()},getEntriesMetadata:function(t){let e=[],i={},a={};for(let s=0;s<t.length;s++){let l=t[s].getMetadata();for(let t=0;t<l.length;t++){let s=l[t];null==a[s.type]&&(a[s.type]="",e.push(s.type)),i[l[t].type]=l[t].label}}let s="";s+=HU.openTag(TAG_TABLE,["id",this.getDomId("table"),ATTR_CLASS,"cell-border stripe ramadda-table",ATTR_WIDTH,"100%","cellpadding","5","cellspacing","0"]),s+="<thead>";let l=this.findEntryType(this.searchSettings.entryType),r="Entry";null!=l&&(r=l.getLabel()),this.writeMessage(this.getResultsHeader(t));let o=null,n=this.getProperty("metadataTypes",null);null!=n?o=n.split(","):(o=e,o.sort());let h={"content.pagestyle":!0,"content.pagetemplate":!0,"content.sort":!0,"spatial.polygon":!0},d=[];d.push(HU.th([],HU.b(r)));for(let t=0;t<o.length;t++){if(h[o[t]])continue;let e=i[o[t]];null==e&&(e=o[t]),d.push(HU.th([],HU.b(e)))}let p=HU.tr(["valign","bottom"],HU.join(d,""));s+=p,s+="</thead><tbody>";let g="<div class=display-metadata-divider></div>",c=this.missingMessage;(c=null)&&(c="&nbsp;");for(let e=0;e<t.length;e++){let i=t[e],a=i.getMetadata(),l=[],r=(this.getDomId("entrylink"+i.getIdForDom()),i.getLink(i.getIconImage()+" "+i.getName()));l.push(HU.td([],HU.div([ATTR_CLASS,"display-metadata-entrylink"],r)));for(let t=0;t<o.length;t++){let e=o[t];if(h[e])continue;let s=null;for(let t=0;t<a.length;t++){let l=a[t];if(l.type==e){let t=null;if("content.thumbnail"==l.type||"content.logo"==l.type){let e=this.getRamadda().getRoot()+"/metadata/view/"+l.value.attr1+"?element=1&entryid="+i.getId()+"&metadata_id="+l.id;t=HU.image(e,[ATTR_WIDTH,"100"])}else if("content.url"==l.type||"dif.related_url"==l.type){let e=l.value.attr2;null!=e&&""!=e||(e=l.value.attr1),t=HU.href(l.value.attr1,e)}else if("content.attachment"==l.type){let e=l.value.attr1.split("_file_")[1],a=this.getRamadda().getRoot()+"/metadata/view/"+l.value.attr1+"?element=1&entryid="+i.getId()+"&metadata_id="+l.id;t=HU.href(a,e)}else t=l.value.attr1,Utils.isDefined(l.value.attr2)&&String(l.value.attr2).trim().length>0&&(t+=" - "+l.value.attr2);null!=t&&(null==s?s="":s+=g,s+=HU.div([ATTR_CLASS,"display-metadata-item"],t))}}null==s&&(s=c),null==s&&(s="");let r=HU.tag(TAG_A,[ATTR_STYLE,"color:#000;",ATTR_HREF,this.getRamadda().getRoot()+"/metadata/addform?entryid="+i.getId()+"&metadata_type="+e,"target","_blank","alt","Add metadata",ATTR_TITLE,"Add metadata"],"+");r=HU.div(["class","display-metadata-table-add"],r);let n=r+g;s.length>0&&(n+=s),l.push(HU.td([],HU.div([ATTR_CLASS,"display-metadata-table-cell-contents"],n)))}s+=HU.tr(["valign","top"],HU.join(l,"")),(e+1)%10==0&&(s+=p)}return s+="</tbody>",s+=HU.closeTag(TAG_TABLE),s},getEntriesGallery:function(t){let e="",i="",a=0,s=[];for(let l=0;l<t.length;l++){let r=t[l];if(r.isImage()){s.push(r);let t=HU.tag(TAG_A,[ATTR_HREF,r.getEntryUrl()],r.getName());a++;let e=r.getImageUrl();i+=HU.tag(TAG_IMG,["src",e,ATTR_WIDTH,"500",ATTR_ID,this.getDomId("entry_"+r.getIdForDom()),ATTR_ENTRYID,r.getId(),ATTR_CLASS,"display-entrygallery-entry"])+"<br>"+t+"<p>"}else{let t=r.getIconImage([ATTR_TITLE,"View entry"]);e+=HU.tag(TAG_A,[ATTR_HREF,r.getEntryUrl()],t+" "+r.getName())+"<br>"}}if(a>1){this.galleryId=HU.getUniqueId("gallery_");let t=HU.open("div",[ID,this.galleryId,CLASS,"ramadda-grid"]),e=this.getProperty("galleryItemWidth","200px");for(let i=0;i<s.length;i++){let a=s[i],l=["width",e];t+=HU.open("div",[CLASS,"display-entrygallery-item",STYLE,HU.css(l)]);let r=HU.tag(TAG_A,["target","_entries",ATTR_HREF,a.getEntryUrl()],a.getName());r=r.replace(/"/g,"'");let o=a.getImageUrl(),n=HU.image(o,["loading","lazy",ATTR_WIDTH,"100%",ATTR_ID,this.getDomId("entry_"+a.getIdForDom()),ATTR_ENTRYID,a.getId(),ATTR_CLASS,"display-entrygallery-entry"]);n=HU.href(a.getResourceUrl(),n,["data-fancybox",this.galleryId,"data-caption",r,CLASS,"popup_image"]),t+=HU.div([CLASS,"image-outer"],HU.div(["class","image-inner"],n)+HU.div(["class","image-caption"],r)),t+=HU.close("div")}t+=HU.close("div"),i=t}return""!=e&&(a>0&&(i+="<hr>"),i+=HU.div([STYLE,HU.css("margin","10px")],e)),i}}),null!=a.searchEntryType&&this.searchSettings.addType(a.searchEntryType)}function RamaddaSearcherDisplay(t,e,i,a){let s="-- None --";const l=new RamaddaEntryDisplay(t,e,i,a);defineDisplay(this,l,[{label:"Search"},{p:"showForm",d:!0},{p:"formOpen",d:!0},{p:"showOrderBy",d:!0,ex:"true"},{p:"orderBy",ex:"name_ascending|name_descending|fromdate_ascending|fromdate_descending|todate_|createdate_|size_"},{p:"orientation",ex:"horizontal|vertical",d:"horizontal"},{p:"showSearchSettings",d:!0},{p:"showToggle",d:!1},{p:"formHeight",d:"400px"},{p:"entriesHeight",d:"400px"},{p:"showEntries",d:!0},{p:"showFooter",d:!0},{p:"showType",d:!0},{p:"entryTypes",ex:"comma separated list of types"},{p:"ancestor",ex:"this",tt:"Constrain search to this tree"},{p:"doSearch",d:!0,tt:"Apply search at initial display"},{p:"searchHeaderLabel",d:"Search"},{p:"searchOpen",d:!0},{p:"showAncestor",d:!0},{p:"showEntryBreadcrumbs",ex:"false"},{p:"showSnippetInList",ex:"true"},{p:"showDate",d:!0},{p:"showCreateDate",ex:"true",d:!1},{p:"showArea",d:!0},{p:"showText",d:!0},{p:"textRequired",d:!1},{p:"searchText",d:"",tt:"Initial search text"},{p:"searchPrefix",ex:"name:, contents:, path:"},{p:"showMetadata",d:!0},{p:"metadataTypes",d:"enum_tag:Tag,content.keyword:Keyword,thredds.variable:Variable"},{p:"showTags",d:!0},{p:"tagPopupLimit",d:25,tt:"When do we show the tag popup"},{p:"showSearchLabels",d:!0},{p:"comparators",d:"<=,>=,=,between",tt:"comparators for numeric search"},{p:"searchDirect",d:!0,tt:"Directly search remote RAMADDA repositories"},{p:"fields",d:null},{p:"formWidth",d:"300px"},{p:"entriesWidth",d:0},{p:"displayTypes",ex:"list,images,timeline,map,metadata"},{p:"defaultImage",ex:"blank.gif"},{p:"showDetailsForGroup",d:!1},{p:"doWorkbench",d:!1,ex:"true",tt:"Show the new, charts, etc links"}],{metadataTypeList:[],haveSearched:!1,haveTypes:!1,metadata:{},metadataLoading:{},ctor:function(){if(this.getShowMetadata()&&this.getShowSearchSettings()){let t=this.getMetadataTypes().split(",");for(let e=0;e<t.length;e++){let i=t[e],a=i,s=null,l=i.split(":");l.length>1&&(i=l[0],l.length>=3?(s=l[1],a=l[2]):a=l[1]),this.metadataTypeList.push(new MetadataType(i,a,s))}}},getLoadingMessage:function(t){return t||""},isLayoutHorizontal:function(){return"horizontal"==this.getOrientation()},initHtml:function(){if(this.jq(ID_ANCESTOR).click((t=>{let e=this.domId(ID_ANCESTOR),i=this.getRamadda().getRoot();selectInitialClick(t,e,e,!0,null,null,"",i)})),this.jq(ID_SEARCH_HIDEFORM).click((()=>{this.formShown=!this.formShown,this.formShown?this.jq(ID_SEARCH_FORM).show():this.jq(ID_SEARCH_FORM).hide()})),this.areaWidget&&this.areaWidget.initHtml(),this.getShowOrderBy()){let t=this.getSearchSettings(),e="";[["Relevant","relevant"],["A-Z","name_ascending"],["Z-A","name_descending"],["Create date - newest first","createdate_descending"],["Create date - oldest first","createdate_ascending"],["From date - youngest first","fromdate_descending"],["From date - oldest first","fromdate_ascending"],["Size - largest first","size_descending"],["Size - smallest first","size_ascending"]].forEach((i=>{let a=i[0],s=i[1],l=t.orderBy==s?" selected ":"";e+="<option title='"+a+"'  "+l+' value="'+s+'">'+a+"</option>\n"}));let i=HU.tag("select",["id",this.getDomId(ID_SEARCH_ORDERBY),ATTR_CLASS,"display-search-orderby"],e);this.jq(ID_SEARCH_HEADER).append(i)}this.addExtraForm()},getDefaultHtml:function(){let t="",e=this.isLayoutHorizontal(),i=this.getFooter();this.getShowFooter(!0)||(i=""),this.jq(ID_BOTTOM).html(i),i="";let a=[ATTR_ID,this.getDomId(ID_ENTRIES),ATTR_CLASS,this.getClass("content")],s=this.getProperty("innerHeight",null),l=this.getProperty("entriesStyle",""),r="";null==s&&(s=this.getEntriesHeight()),null!=s&&(r="margin: 0px; padding: 0px;  xmin-height:"+HU.getDimension(s)+"; max-height:"+HU.getDimension(s)+"; overflow-y: auto;"),r+=l,a.push(ATTR_STYLE),a.push(r);let o=HU.div([CLASS,e?"display-search-bar":"display-search-bar-vertical",ID,this.domId(ID_SEARCH_BAR)],""),n="";this.getProperty("showHeader",!0)&&(n=HU.div([ATTR_CLASS,"display-entries-results",ATTR_ID,this.getDomId(ID_RESULTS)],"&nbsp;")),n=HU.leftRightTable(n,HU.div([CLASS,"display-search-header",ID,this.domId(ID_SEARCH_HEADER)]),null,null,{valign:"bottom"});let h="";e&&this.getShowForm()&&(h=HU.div([TITLE,"Toggle form",ID,this.domId(ID_SEARCH_HIDEFORM),CLASS,"ramadda-clickable",STYLE,HU.css("position","absolute","left","0px","top","0px")],HU.getIconImage("fas fa-bars")));let d=HU.div([STYLE,HU.css("position","relative")],h+o+n+HU.div(a,this.getLoadingMessage()));if(e){t+=HU.open("table",["width","100%","border",0]),t+="<tr valign=top>";if(this.getShowForm()){let e=HU.div([STYLE,HU.css("min-height","400px","max-width",HU.getDimension(this.getFormWidth()),"overflow-x","auto")],this.makeSearchForm());t+=HU.tag("td",[ID,this.getDomId(ID_SEARCH_FORM),"width","1%"],e),this.formShown=!0}if(this.getShowEntries()){let e=[];""===this.getEntriesWidth()?e=[]:0!=this.getEntriesWidth()&&(e=[ATTR_WIDTH,this.getEntriesWidth()]),t+=HU.tag("td",[],d)}t+=HU.closeTag("tr"),t+=HU.closeTag("table"),t+=HU.openTag(TAG_DIV,["class","row"]),this.getShowForm()&&(t+=HU.tag(TAG_DIV,["class","col-md-6"],"")),this.getShowEntries()&&this.getShowFooter(!0)&&(t+=HU.tag(TAG_DIV,["class","col-md-6"],i)),t+=HU.closeTag(TAG_DIV)}else this.getShowForm()&&(t+=this.makeSearchForm()),this.getShowEntries()&&(t+=d,t+=i);return t+=HU.div([ATTR_CLASS,"display-entry-popup",ATTR_ID,this.getDomId(ID_DETAILS)],"&nbsp;"),t},initDisplay:function(){let t=this;this.jq(ID_SEARCH).click((function(e){t.submitSearchForm(),e.preventDefault()})),this.jq(ID_TEXT_FIELD).autocomplete({source:function(t,e){}}),this.jq(ID_SEARCH_ORDERBY).change((()=>{this.submitSearchForm()})),HtmlUtils.initSelect(this.jq(ID_REPOSITORY)),this.jq(ID_REPOSITORY).change((function(){let e=t.jq(ID_REPOSITORY).val(),i=getRamadda(e);t.setRamadda(i),t.addTypes(null),t.typeChanged()})),this.jq(ID_FORM).submit((function(e){t.submitSearchForm(),e.preventDefault()})),this.addTypes(this.entryTypes),this.initMetadata(),this.haveSearched||this.getDoSearch()&&this.submitSearchForm()},showEntryDetails:async function(t,e,i,a){},getCloser:function(){return""},initCloser:function(t){this.jq("close").click((()=>{this.jq(t||ID_RESULTS).hide()}))},getResultsHeader:function(t,e){let i=this.getSearchSettings(),a="Showing "+(i.skip+1)+"-"+(i.skip+Math.min(i.max,t.length));0==t.length&&(a=SPACE3+SPACE3+SPACE3);let s=[],l=[];i.skip>0&&s.push(HU.onClick(this.getGet()+".loadPrevUrl();",HU.getIconImage("fa-arrow-left",[ATTR_TITLE,"Previous"]),[ATTR_CLASS,"display-link"]));let r=!1;t.length>0&&(s.push(HU.onClick(this.getGet()+".loadNextUrl();",HU.getIconImage("fa-arrow-right",[ATTR_TITLE,"Next"]),[ATTR_CLASS,"display-link"])),r=!0),t.length>0&&(l.push(HU.onClick(this.getGet()+".loadLess();",HU.getIconImage("fa-minus",[ATTR_TITLE,"View less"]),[ATTR_CLASS,"display-link"])),r&&l.push(HU.onClick(this.getGet()+".loadMore();",HU.getIconImage("fa-plus",[ATTR_TITLE,"View more"]),[ATTR_CLASS,"display-link"])));let o="",n="&nbsp;&nbsp;&nbsp;";return e&&(o=this.getCloser()),o+="&nbsp;"+a+n,o+=HU.join(s,"&nbsp;")+n+HU.join(l,"&nbsp;"),o+"<br>"},makeSearchSettings:function(){let t=this.getSearchSettings();t.text=this.getFieldValue(this.getDomId(ID_TEXT_FIELD),t.text),t.text?(HU.addToDocumentUrl(ID_TEXT_FIELD,t.text),""!=t.text.trim()&&this.getSearchPrefix()&&(t.text=this.getSearchPrefix()+t.text)):HU.addToDocumentUrl(ID_TEXT_FIELD,""),t.ancestor=this.getAncestor();let e=this.jq(ID_SEARCH_ORDERBY).val();if(e){let i=e.indexOf("_ascending")>=0;"relevant"==e&&(i=!1),e=e.replace("_ascending","").replace("_descending",""),t.orderBy=e,t.ascending=i}this.haveTypes?(t.entryType=this.getFieldValue(this.getDomId(ID_TYPE_FIELD),t.entryType),t.entryType?HU.addToDocumentUrl(ID_TYPE_FIELD,t.entryType):HU.addToDocumentUrl(ID_TYPE_FIELD,"")):this.typeList&&1==this.typeList.length&&(t.entryType=this.typeList[0]),t.clearAndAddType(t.entryType);let i=this.jq(ID_ANCESTOR+"_hidden").val();if(Utils.stringDefined(i)){t.ancestor=i,HU.addToDocumentUrl(ID_ANCESTOR,i);let e=this.jq(ID_ANCESTOR).val();e&&HU.addToDocumentUrl(ID_ANCESTOR_NAME,e)}else HU.addToDocumentUrl(ID_ANCESTOR,null),HU.addToDocumentUrl(ID_ANCESTOR_NAME,null);if(this.areaWidget&&this.areaWidget.setSearchSettings(t),this.dateRangeWidget&&this.dateRangeWidget.setSearchSettings(t),this.createdateRangeWidget&&this.createdateRangeWidget.setSearchSettings(t),t.metadata=[],this.getShowTags()){this.jq(ID_SEARCH_BAR).find(".display-search-tag").each((function(){let e=$(this).attr("metadata-type"),i=$(this).attr("metadata-value");e&&t.metadata.push({type:e,value:i})}))}else for(let e=0;e<this.metadataTypeList.length;e++){let i=this.metadataTypeList[e],a=i.getValue();null==a&&(a=this.getFieldValues(this.getMetadataFieldId(i),null)),null!=a&&(Array.isArray(a)||(a=[a]),a.forEach((e=>{t.metadata.push({type:i.getType(),value:e})})))}return t},submitSearchForm:function(){if(this.fixedEntries)return;this.haveSearched=!0;let t=this.makeSearchSettings();if(this.getTextRequired()&&(null==t.text||0==t.text.trim().length))return void this.writeEntries("");let e=this.getRamadda();if(this.writeMessage(this.getWaitImage()+" Searching..."),e.children){this.entryList=new EntryListHolder(e,this),this.multiSearch={count:0};for(let t=0;t<e.children.length;t++){let i=e.children[t],a=this.makeSearchUrl(i);this.updateForSearching(a),this.entryList.addEntryList(new EntryList(i,a,null,!1)),this.multiSearch.count++}this.entryList.doSearch(this)}else{this.multiSearch=null;let t=this.makeSearchUrl(this.getRamadda());this.handleLog(t),this.entryList=new EntryList(this.getRamadda(),t,this,!0),this.updateForSearching(t)}},entryListChanged:function(t){},handleSearchError:function(t,e){this.writeEntries(""),this.writeMessage("Error performing search:"+e),console.log("Error performing search:"+e)},updateForSearching:function(t){let e=this.getRamadda().getSearchLinks(this.getSearchSettings());this.footerRight=null==e?"":"Links: "+HU.join(e," - "),this.writeHtml(ID_FOOTER_RIGHT,this.footerRight);let i=this.searchMessage;null==i&&(i=this.getRamadda().getSearchMessage());let a=this.getSearchSettings().provider;null!=a&&(i=null,null!=this.providerMap&&this.providerMap[a]&&(i=this.providerMap[a].name),null==i&&(i=a),i="Searching "+i),this.hideEntryDetails()},prepareToLayout:function(){l.prepareToLayout.apply(this),this.savedValues={};let t=this.getSearchableColumns();for(let e=0;e<t.length;e++){let i=t[e],a=this.getDomId(ID_COLUMN+i.getName()),s=$("#"+a).val();null!=s&&0!=s.length&&(this.savedValues[a]=s)}},makeSearchUrl:function(t){let e="",i=this.getSearchableColumns(),a=this.jq(ID_SEARCH_BAR);for(let t=0;t<i.length;t++){let s=i[t];if(!s.getCanSearch())continue;let l=ID_COLUMN+s.getName(),r=s.getSearchArg(),o=a.find(HU.attrSelect("column",s.getName()));if(s.isNumeric()){this.jq(l+"_expr").val();let t=this.jq(l+"_from").val(),i=this.jq(l+"_to").val();if(Utils.stringDefined(t)||Utils.stringDefined(i)){let n=(Utils.stringDefined(t)?t+" &lt; ":"")+s.getLabel()+(Utils.stringDefined(i)?" &lt; "+i:"");0==o.length?(o=$(HU.div([CLASS,"display-search-tag","column",s.getName()],n)).appendTo(a),o.click((()=>{this.jq(l+"_from").val(""),this.jq(l+"_to").val(""),this.submitSearchForm()}))):o.html(n),Utils.stringDefined(t)&&(e+="&"+r+"_from="+encodeURIComponent(t)),Utils.stringDefined(i)&&(e+="&"+r+"_to="+encodeURIComponent(i))}else o.remove()}else{let t=this.jq(l).val();if(null==t||t==VALUE_NONE){o.remove();continue}if("string"==s.getType()&&""==t){o.remove();continue}let i=s.getLabel()+"="+t;0==o.length?(o=$(HU.div([CLASS,"display-search-tag","column",s.getName()],i)).appendTo(a),o.click((()=>{this.jq(l).data("selectBox-selectBoxIt").selectOption(VALUE_NONE),this.submitSearchForm()}))):o.html(i),e+="&"+r+"="+encodeURIComponent(t)}}return this.getSearchSettings().setExtra(e),t.getSearchUrl(this.getSearchSettings(),OUTPUT_JSON)},makeSearchForm:function(){let t=HU.openTag("form",[ATTR_ID,this.getDomId(ID_FORM),"action","#"]),e=HU.getIconImage("fa-search",[ATTR_TITLE,"Search"]),i=[],a=HU.div([ATTR_ID,this.getDomId(ID_SEARCH),ATTR_CLASS,"display-search-button ramadda-clickable"],e),l="",r=(this.getSearchSettings(),(t,e)=>o?HU.div([CLASS,"display-search-label"],t)+HU.div([CLASS,"display-search-widget"],e):HU.formEntry("",e)),o=this.isLayoutHorizontal();if(this.ramaddas.length>0){let t=HU.openTag(TAG_SELECT,[ATTR_ID,this.getDomId(ID_REPOSITORY),ATTR_CLASS,"display-repositories-select"]),e=ramaddaCdn+"/icons/favicon.png";for(let i=0;i<this.ramaddas.length;i++){let a=this.ramaddas[i],s=[ATTR_TITLE,"",ATTR_VALUE,a.getId(),"data-iconurl",e];this.getRamadda().getId()==a.getId()&&(s.push("selected"),s.push(null));t+=HU.tag(TAG_OPTION,s,a.getName())}t+=HU.closeTag(TAG_SELECT),i.push(t)}if(this.providerMap={},null!=this.getPropertyProviders())if(1==this.getPropertyProviders().length)this.provider=this.getPropertyProviders()[0].id;else{let t="",e=HU.getUrlArgument(ID_PROVIDERS),a={},s=[];if(this.getPropertyProviders().forEach((t=>{this.providerMap[t.id]=t;let i=t.id;Utils.isDefined(e)||(e=i);let l=t.name;l.length>40&&(l=l.substring(0,39)+"...");let r="";i==e&&(r+=" selected ");let o=t.category||"",n=a[o];null==n&&(s.push(o),a[o]="",n="");let h=t.icon;h&&(h=h.replace(/\${urlroot}/g,ramaddaBaseUrl),h=h.replace(/\${root}/g,ramaddaBaseUrl),r+=' data-iconurl="'+h+'" '),n+="<option  title='"+l+"' class=display-search-provider "+r+' value="'+i+'">'+l+"</option>\n",a[o]=n})),1==s.length)t+=a[s[0]];else for(let e=0;e<s.length;e++){let i=s[e];""!=i&&(t+='<optgroup label="'+i+'">\n'),t+=a[i],""!=i&&(t+="</optgroup>")}let l=HU.tag("select",[STYLE,HU.css(),"multiple",null,"id",this.getDomId(ID_PROVIDERS),ATTR_CLASS,"display-search-providers"],t);i.push(l)}this.typeList=null,this.getEntryTypes()&&(this.typeList=this.getEntryTypes().split(",")),this.getShowType()&&(null==this.typeList||0==this.typeList.length?i.push(HU.div([STYLE,HU.css("margin-bottom","4px"),ATTR_ID,this.getDomId(ID_TYPE_DIV)],HU.span([ATTR_CLASS,"display-loading"],"Loading types..."))):l+=HU.div([STYLE,HU.css("margin-bottom","4px"),ATTR_ID,this.getDomId(ID_TYPE_DIV)]));let n=this.getFormText();n&&""!=n||(n=HU.getUrlArgument(ID_TEXT_FIELD));let h=["placeholder",this.getEgText("Search text"),TITLE,"e.g. name:, contents:,path:",ATTR_CLASS,"display-simplesearch-input",ATTR_ID,this.domId(ID_TEXT_FIELD)];this.getProperty("inputSize")?(h.push(ATTR_SIZE),h.push(this.getProperty("inputSize","30"))):(h.push(STYLE),h.push(HU.css("width","100%","min-width","200px","max-width","300px")));let d=HU.input("",n,h);this.getShowText()&&i.push(d);let p="",g="";if(i.length>0&&(o?(t+="<table><tr valign=top><td>"+a+"</td><td>"+i[0]+"</td></tr></table>",g+=HU.join(i.slice(1),"")):(i=Utils.mergeLists([a],i),i=i.map((t=>HU.div([STYLE,HU.css("margin-right","8px")],t))),t+=HU.hrow(...i))),o||(l+=HU.formTable()),this.getShowAncestor()&&!0===ramaddaTreeSearchEnabled){let t=HU.getUrlArgument(ID_ANCESTOR),e=HU.getUrlArgument(ID_ANCESTOR_NAME),i=this.domId(ID_ANCESTOR),a=(HU.squote(i),HU.squote(i),HU.href("javascript:void(0);",HU.getIconImage("fas fa-eraser"),["onClick","clearSelect("+HU.squote(i)+");",TITLE,"Clear selection"])),s=HU.input("",e||"",["READONLY",null,"placeholder"," Search under",STYLE,HU.css("cursor","pointer","width","100%"),ID,i,CLASS,"ramadda-entry-popup-select  disabledinput"]);l+=HU.hidden("",t||"",[ID,i+"_hidden"]),l+=r("",HU.div([ID,this.domId(ID_SEARCH_ANCESTOR)],HU.leftRightTable(a,s,"5%","95%")))}if(this.getShowDate()&&(this.dateRangeWidget=new DateRangeWidget(this),l+=r("",HU.div([ID,this.domId(ID_SEARCH_DATE_RANGE)],this.dateRangeWidget.getHtml()))),this.getShowCreateDate(!0)&&(this.createdateRangeWidget=new DateRangeWidget(this,"createdate"),l+=r("",HU.div([ID,this.domId(ID_SEARCH_DATE_CREATE)],this.createdateRangeWidget.getHtml()))),this.getShowArea()&&(this.areaWidget=new AreaWidget(this),l+=r("",HU.div([ID,this.domId(ID_SEARCH_AREA)],this.areaWidget.getHtml()))),l+=HU.div([ATTR_ID,this.getDomId(ID_TYPEFIELDS)],""),this.getShowMetadata()){let t="";for(let e=0;e<this.metadataTypeList.length;e++){let i,a=this.metadataTypeList[e],l=a.getValue();if(i=null!=l?l:HU.tag(TAG_SELECT,[ATTR_ID,this.getMetadataFieldId(a),ATTR_CLASS,"display-metadatalist"],HU.tag(TAG_OPTION,[ATTR_TITLE,"",ATTR_VALUE,""],s)),this.getShowTags()){let e=HU.div([CLASS,"display-search-metadata-block"],HU.div([CLASS,"display-search-metadata-block-inner",ID,this.getMetadataFieldId(a)])),i=this.getMetadataFieldId(a)+"_count",s=this.getMetadataFieldId(a)+"_wrapper",l=a.getLabel()+" "+HU.span([ID,i]);t+=HU.div([ID,s],HU.toggleBlock(l,e,!1,{headerStyle:HU.css("border","1px solid #ccc","margin-top","6px","background",Utils.getEnumColor(a))}))}else t+=r(a.getLabel()+":",i)}l+=HU.div([ID,this.domId(ID_SEARCH_TAGS)],t)}if(o||(l+=HU.closeTag(TAG_TABLE)),this.getShowSearchSettings()){let t=this.getDomId(ID_SEARCH_SETTINGS);this.getShowToggle()?p+=HU.div([ATTR_CLASS,"display-search-extra",ATTR_ID,t],HU.toggleBlock("Search Settings",HU.div([ATTR_CLASS,"display-search-extra-inner"],l),this.getFormOpen(!0))):p+=HU.div([ATTR_CLASS,"display-search-extra",ATTR_ID,t],HU.div([ATTR_CLASS,"display-search-extra-inner"],l))}return p+='<input type="submit" style="position:absolute;left:-9999px;width:1px;height:1px;"/>',this.getFormHeight()&&(p=HU.div([STYLE,HU.css("overflow-y","auto","max-height",HU.getDimension(this.getFormHeight()))],p)),t+=HU.div([STYLE,"margin-top:5px",CLASS,"display-search-extra"],g),t+=p,t+=HU.closeTag("form"),t},getEgText:function(t){return t=this.getProperty("placeholder",t),this.eg&&(t=" "+this.eg),t},getFormText:function(){let t=this.getSearchSettings().text;if(null==t){t=Utils.getUrlArgs(document.location.search).text}return null==t&&(t=this.getSearchText()),t},handleEventMapBoundsChanged:function(t,e){this.areaWidget&&this.areaWidget.handleEventMapBoundsChanged(t,e)},typeChanged:function(){let t=this.getSearchSettings();t.skip=0,t.max=DEFAULT_MAX,t.entryType=this.getFieldValue(this.getDomId(ID_TYPE_FIELD),t.entryType),t.clearAndAddType(t.entryType),this.addExtraForm(),this.submitSearchForm()},initMetadata:function(){this.metadata={},this.metadataLoading={};for(let t=0;t<this.metadataTypeList.length;t++){let e=this.metadataTypeList[t];this.addMetadata(e,null)}},addMetadata:function(t,e){if(null==e&&(e=this.metadata[t.getType()]),null==e){let i=this;this.metadataLoading[t.getType()]||(this.metadataLoading[t.getType()]=!0,e=this.getRamadda().getMetadataCount(t,(function(t,e){i.addMetadata(t,e)})))}if(null==e)return;this.metadataBoxes||(this.metadataBoxes={}),this.metadataBoxes[t.getType()]={},this.metadata[t.getType()]=e;let i=this.getTagPopupLimit(),a=HU.tag(TAG_OPTION,[ATTR_TITLE,"",ATTR_VALUE,""],s),l=[];for(let s=0;s<e.length;s++){let r=e[s].count,o=e[s].value,n=e[s].label,h=t.getType(),d=[ATTR_VALUE,o,ATTR_CLASS,"display-metadatalist-item"];!1&&(d.push("selected"),d.push(null)),a+=HU.tag(TAG_OPTION,d,n+" ("+r+")");let p=this.getMetadataFieldId(t)+"_checkbox_"+s;this.metadataBoxes[h][o]=p;let g=HU.checkbox("",[ID,p,"metadata-type",h,"metadata-value",o],!1)+" "+HU.tag("label",[CLASS,"ramadda-noselect ramadda-clickable","for",p],n+" ("+r+")");e.length>i&&(g=HU.span([CLASS,"display-search-tag","tag",n,STYLE,HU.css("background",Utils.getEnumColor(t))],g)),l.push(g)}if(this.getShowTags()){let e=this.getMetadataFieldId(t)+"_count",a=this.getMetadataFieldId(t)+"_wrapper";$("#"+e).html("("+l.length+")");HU.div([STYLE,HU.css("margin","5px","width","800px;","max-height","300px","overflow-y","auto")],Utils.wrap(l,"",""));let s=Utils.wrap(l,"","<br>"),r=this.getMetadataFieldId(t)+"_popup",o=this,n=function(){let e=$(this).attr("metadata-value"),i=($(this).attr("metadata-type"),$(this).is(":checked")),a=$(this);if(i)o.addMetadataTag(t.getType(),t.getLabel(),e,a);else{let i=Utils.makeId(o.domId(ID_SEARCH_TAG)+"_"+t.getType()+"_"+e);$("#"+i).remove()}o.submitSearchForm()};l.length>i?($("#"+a).html(HU.div([STYLE,HU.css("border","1px solid #ccc","margin-top","6px","background",Utils.getEnumColor(t)),TITLE,"Click to select tag",ID,r,CLASS,"ramadda-clickable entry-toggleblock-label"],HU.makeToggleImage("fas fa-plus","font-size:8pt;")+" "+t.getLabel()+" ("+l.length+")")),$("#"+r).click((()=>{this.createTagDialog(l,$("#"+r),n,t.getType(),t.getLabel())}))):$("#"+this.getMetadataFieldId(t)).html(s),$("#"+this.getMetadataFieldId(t)).find(":checkbox").change(n)}else $("#"+this.getMetadataFieldId(t)).html(a),HtmlUtils.initSelect($("#"+this.getMetadataFieldId(t)))},metadataTagSelected:function(t,e){let i=ID_SEARCH_TAG_GROUP+"_"+t;return this.jq(i).find(HU.attrSelect("metadata-type",t)+HU.attrSelect("metadata-value",e)).length>0},addMetadataTag:function(t,e,i,a){let s=this,l=ID_SEARCH_TAG_GROUP+"_"+t,r=s.jq(l);if(this.metadataTagSelected(t,i))return!1;let o=Utils.makeId(s.domId(ID_SEARCH_TAG)+"_"+t+"_"+i);return 0==r.length&&(r=$(HU.div([CLASS,"display-search-tag-group",ID,s.domId(l)])).appendTo(s.jq(ID_SEARCH_BAR))),$(HU.div(["metadata-type",t,"metadata-value",i,TITLE,e+":"+i,STYLE,HU.css("background",Utils.getEnumColor(t)),CLASS,"display-search-tag",ID,o],i+SPACE+HU.getIconImage("fas fa-times"))).appendTo(r).click((function(){$(this).remove(),a&&a.prop("checked",!1),s.submitSearchForm()})),!0},typeTagClicked:function(t){HtmlUtils.initSelect(this.jq(ID_TYPE_FIELD),{selectOption:t.getId()})},metadataTagClicked:function(t){if(!this.metadataBoxes[t.type]||!this.metadataBoxes[t.type][t.value.attr1])return this.addMetadataTag(t.type,t.type,t.value.attr1,null),void this.submitSearchForm();let e=$("#"+this.metadataBoxes[t.type][t.value.attr1]);e.is(":checked")||e.click()},getMetadataFieldId:function(t){let e=t.getType();return e=e.replace(".","_"),this.getDomId(ID_METADATA_FIELD+e)},findEntryType:function(t){if(null==this.entryTypes)return null;for(let e=0;e<this.entryTypes.length;e++){let i=this.entryTypes[e];if(i.getId()==t)return i}return null},addTypes:function(t){if(null==t&&(t=this.getRamadda().getEntryTypes(((t,e)=>{this.addTypes(e)}),this.getEntryTypes())),null==t)return;if(this.entryTypes=t,this.getEntryTypes()){let t={};this.getEntryTypes().split(",").forEach((e=>{t[e]=!0}));let e=[];for(let i=0;i<this.entryTypes.length;i++){let a=this.entryTypes[i];(t[a.getId()]||null!=a.getCategory()&&t[a.getCategory()])&&e.push(a)}this.entryTypes=e}if(this.haveTypes=!0,!this.getShowType())return void this.addExtraForm();let e=[],i={},a=HU.openTag(TAG_SELECT,[ATTR_ID,this.getDomId(ID_TYPE_FIELD),ATTR_CLASS,"display-typelist","onchange",this.getGet()+".typeChanged();"]);a+=HU.tag(TAG_OPTION,[ATTR_TITLE,"",ATTR_VALUE,""],"Any Type");let s=!1;for(let t=0;t<this.entryTypes.length;t++){let a=this.entryTypes[t],l=a.getIcon(),r=[ATTR_TITLE,a.getLabel(),ATTR_VALUE,a.getId(),ATTR_CLASS,"display-typelist-type","data-iconurl",l],o=this.getSearchSettings().hasType(a.getId());if(!o){let t=HU.getUrlArgument(ID_TYPE_FIELD);t&&(o=a.getId()==t)}o&&(s=!0,r.push("selected"),r.push(null));let n=a.getLabel();a.getEntryCount()>0&&(n+=" ("+a.getEntryCount()+")");let h=HU.tag(TAG_OPTION,r,n);null==i[a.getCategory()]&&(i[a.getCategory()]=HU.tag(TAG_OPTION,[ATTR_CLASS,"display-typelist-category",ATTR_TITLE,"",ATTR_VALUE,""],a.getCategory()),e.push(a.getCategory())),i[a.getCategory()]+=h}for(let t in e)a+=i[e[t]];a+=HU.closeTag(TAG_SELECT),1==this.entryTypes.length?this.writeHtml(ID_TYPE_DIV,HU.hidden(ID_TYPE_FIELD,this.entryTypes[0].getId())):this.writeHtml(ID_TYPE_DIV,a),HtmlUtils.initSelect(this.jq(ID_TYPE_FIELD),{autoWidth:!1,"max-height":"100px"}),this.addExtraForm(),s&&this.submitSearchForm()},getSelectedType:function(){if(null==this.entryTypes)return null;if(1==this.entryTypes.length)return this.entryTypes[0];for(let t=0;t<this.entryTypes.length;t++){let e=this.entryTypes[t];if(e.getId&&this.getSearchSettings().hasType(e.getId()))return e}let t=this.getFieldValue(this.getDomId(ID_TYPE_FIELD),null);if(t)for(let e=0;e<this.entryTypes.length;e++){let i=this.entryTypes[e];if(i.getId&&t==i.getId())return i}return null},getSearchableColumns:function(){let t=[],e=this.getSelectedType();if(null==e)return t;let i=e.getColumns();if(null==i)return t;for(let e=0;e<i.length;e++){let a=i[e];a.getCanSearch()&&t.push(a)}return t},addExtraForm:function(){null==this.savedValues&&(this.savedValues={});let t="",e=this.getSearchableColumns();this.getComparators().split(",");for(let i=0;i<e.length;i++){let a=e[i];if(null!=this.getProperty("fields")&&this.getProperty("fields").indexOf(a.getName())<0)continue;t.length;let s="",l=this.getDomId(ID_COLUMN+a.getName()),r=this.savedValues[l];null==r&&(r=this.jq(ID_COLUMN+a.getName()).val());let o="",n="";if(a.getSuffix()&&(n=HU.span([STYLE,HU.css("cursor","help","margin-left","10px"),TITLE,a.getSuffix()],HU.getIconImage("fas fa-info"))),a.isEnumeration()){let t=this.getShowSearchLabels();s=HU.openTag(TAG_SELECT,[ATTR_ID,l,ATTR_CLASS,"display-searchmenu display-metadatalist"]),s+="\n",s+=HU.tag(TAG_OPTION,[CLASS,"display-metadatalist-item",ATTR_TITLE,"",ATTR_VALUE,VALUE_NONE],t?"-- Select --":a.getLabel());let e=a.getValues();s+="\n";for(let t in e){let i=e[t].value||"",a="";i==r&&(a=" selected "),""==i&&(i="--blank--");let l=e[t].label.trim();"&lt;blank&gt;"==l&&(l="--blank--"),""==l&&(l="--blank--"),s+=HU.tag(TAG_OPTION,[CLASS,"display-metadatalist-item",ATTR_TITLE,l,ATTR_VALUE,i,a,null],l),s+="\n"}s+=HU.closeTag(TAG_SELECT),t?(o+=HU.div([CLASS,"display-search-label"],a.getLabel()+":"),o+=HU.div([CLASS,"display-search-widget"],s+n)):o+=HU.div([CLASS,"display-search-block display-search-widget"],s+n)}else if(a.isNumeric()){let t=HU.input("","",[ATTR_CLASS,"input",STYLE,HU.css("width","2.5em"),ATTR_ID,l+"_from"]),e=HU.input("","",[ATTR_CLASS,"input",STYLE,HU.css("width","2.5em"),ATTR_ID,l+"_to"]);o+=HU.div([CLASS,"display-search-label"],a.getLabel())+t+" - "+e+n}else s=HU.input("",r,["placeholder",a.getLabel(),ATTR_CLASS,"input",ATTR_SIZE,"15",ATTR_ID,l]),o+=HU.div([CLASS,"display-search-label"],"")+HU.div([CLASS,"display-search-widget"],s+" "+n);t+=o}t.length>0&&(t=HU.toggleBlock(this.getSearchHeaderLabel(),t,this.getSearchOpen())),this.writeHtml(ID_TYPEFIELDS,t);this.jq(ID_TYPEFIELDS).find(".ramadda-expr").change((function(){let t=$(this).attr("id"),e=$(this).val();t=t.replace("_expr","_to"),"between"==e?$("#"+t).show():$("#"+t).hide()}));let i=this.jq(ID_TYPEFIELDS).find(".display-searchmenu");HtmlUtils.initSelect(i),i.change((()=>{this.submitSearchForm()}))},getEntries:function(){return null==this.entryList?[]:this.entryList.getEntries()},loadNextUrl:function(){this.getSearchSettings().skip+=this.getSearchSettings().max,this.submitSearchForm()},loadMore:function(){this.getSearchSettings().max=this.getSearchSettings().max+=DEFAULT_MAX,this.submitSearchForm()},loadLess:function(){let t=this.getSearchSettings().max;t=parseInt(.75*t),this.getSearchSettings().max=Math.max(1,t),this.submitSearchForm()},loadPrevUrl:function(){this.getSearchSettings().skip=Math.max(0,this.getSearchSettings().skip-this.getSearchSettings().max),this.submitSearchForm()},entryListChanged:function(t){this.entryList=t}})}function RamaddaEntrylistDisplay(t,e,i,a){null==a&&(a=DISPLAY_ENTRYLIST);const s=new RamaddaSearcherDisplay(t,e,DISPLAY_ENTRYLIST,i);defineDisplay(addRamaddaDisplay(this),s,[],{haveDisplayed:!1,selectedEntries:[],getSelectedEntries:function(){return this.selectedEntries},initDisplay:function(){let t=this;this.getIsLayoutFixed()&&this.haveDisplayed||(this.haveDisplayed=!0,this.createUI(),this.setContents(this.getDefaultHtml()),this.initHtml(),this.providerChanged(!0),this.dateRangeWidget&&this.dateRangeWidget.initHtml(),this.createdateRangeWidget&&this.createdateRangeWidget.initHtml(),s.initDisplay.apply(this),null!=this.entryList&&this.entryList.haveLoaded&&this.entryListChanged(this.entryList),HtmlUtils.initSelect(this.jq(ID_PROVIDERS),{autoWidth:!1,"max-height":"100px"}),this.jq(ID_PROVIDERS).change((function(){t.providerChanged()})))},providerChanged:function(t){if(0==this.jq(ID_PROVIDERS).length)return;!t&&this.jq(ID_ANCESTOR).val&&(this.jq(ID_ANCESTOR).val(""),this.jq(ID_ANCESTOR+"_hidden").val("")),this.getSearchSettings().skip=0;let e=this.jq(ID_PROVIDERS).val();this.provider=this.providerMap[e],HU.addToDocumentUrl(ID_PROVIDERS,e),this.jq(ID_SEARCH_BAR).html("");let i=[ID_SEARCH_AREA,ID_SEARCH_TAGS,ID_SEARCH_ANCESTOR,ID_SEARCH_DATE_CREATE,ID_SEARCH_DATE_RANGE];if(this.provider&&"ramadda"!=this.provider.type){this.setRamadda(this.originalRamadda),(this.provider.capabilities||"").split(",").forEach((t=>{let e=i.indexOf("search_"+t);e>=0&&i.splice(e,1)})),i.forEach((t=>{this.jq(t).hide()})),this.jq(ID_TYPE_DIV).hide()}else i.forEach((t=>{this.jq(t).show()})),this.jq(ID_TYPE_DIV).show(),this.getSearchDirect()&&(this.provider&&this.setRamadda(getRamadda(this.provider.id+";"+this.provider.name)),this.addTypes(),this.initMetadata())},getMenuItems:function(t){if(s.getMenuItems.apply(this,t),this.getSelectedEntriesFromTree().length>0){let e=this.getGet();t.push(HU.onClick(e+".makeDisplayList();","Make List")),t.push(HU.onClick(e+".makeDisplayGallery();","Make Gallery"))}},makeDisplayList:function(){let t=this.getSelectedEntriesFromTree();if(0==t.length)return;let e={selectedEntries:t,showForm:!1,showMenu:!0,fixedEntries:!0};e.entryList=new EntryList(this.getRamadda(),"",this,!1),e.entryList.setEntries(t),this.getDisplayManager().createDisplay(DISPLAY_ENTRYLIST,e)},makeDisplayGallery:function(){let t=this.getSelectedEntriesFromTree();if(0==t.length)return;let e={selectedEntries:t},i=this.getEgText(),a=this.getFormText();HU.input("",a,["placeholder",i,ATTR_CLASS,"display-search-input",ATTR_SIZE,"30",ATTR_ID,this.getDomId(ID_TEXT_FIELD)]);this.getDisplayManager().createDisplay(DISPLAY_ENTRY_GALLERY,e)},handleEventEntrySelection:function(t,e){this.selectEntry(e.entry,e.selected)},selectEntry:function(t,e){let i=!1;if(e){this.jq("entry_"+t.getIdForDom()).addClass("ui-selected"),this.selectedEntries.indexOf(t)<0&&(this.selectedEntries.push(t),i=!0)}else{this.jq("entry_"+t.getIdForDom()).removeClass("ui-selected");let e=this.selectedEntries.indexOf(t);e>=0&&(this.selectedEntries.splice(e,1),i=!0)}},makeEntriesDisplay:function(t){this.tabId=null,this.mapId=null,this.myDisplays&&this.myDisplays.forEach((t=>{removeRamaddaDisplay(t.display.getId())})),this.myDisplays=[];let e=[],i=[];if(this.getDisplayTypes("list,images,timeline,map").split(",").forEach((a=>{if("list"==a)e.push("List"),i.push(this.getEntriesTree(t));else if("images"==a){let s=this.getDefaultImage();if(t.filter((t=>!!s||t.isImage())).length>0){e.push("Images");let t=HU.getUniqueId(a+"_");this.myDisplays.push({id:t,type:a}),i.push(HU.div([ID,t,STYLE,HU.css("width","100%")]))}}else if("timeline"==a){e.push("Timeline");let t=HU.getUniqueId(a+"_");this.myDisplays.push({id:t,type:a}),i.push(HU.div([ID,t,STYLE,HU.css("width","100%")]))}else if("map"==a){if(this.areaEntries=t.filter((t=>t.hasBounds()||t.hasLocation())),this.areaEntries.length>0){e.push("Map");let t=HU.getUniqueId(a+"_");this.myDisplays.push({id:t,type:a,entries:this.areaEntries}),i.push(HU.div([ID,t,STYLE,HU.css("width","100%")]))}}else if("metadata"==a){e.push("Metadata");let a=HU.div([STYLE,HU.css("width","800px","max-width","800px","overflow-x","auto")],this.getEntriesMetadata(t));i.push(a)}})),1==e.length)return HU.div([CLASS,"xdisplay-entrylist-content-border"],i[0]);let a=HU.getUniqueId("tabs_"),s=HU.open("div",[ID,a,CLASS,"ui-tabs"])+"<ul>";return e.forEach(((t,e)=>{s+="<li>"+HU.href("#"+a+"-"+e,t)+"</li>\n"})),s+="</ul>\n",this.tabCount=i.length,i.forEach(((t,e)=>{s+=HU.div([ID,a+"-"+e,CLASS,"ui-tabs-hide"],t)})),s+=HU.close("div"),this.tabId=a,s},entryListChanged:function(t){this.multiSearch&&this.multiSearch.count--,s.entryListChanged.apply(this,[t]);let e=this.entryList.getEntries();if(0==e.length){this.getSearchSettings().max=DEFAULT_MAX;let t="Nothing found";this.multiSearch&&this.multiSearch.count>0&&(t="Nothing found so far. Still searching "+this.multiSearch.count+" repositories"),this.writeHtml(ID_FOOTER_LEFT,""),this.jq(ID_ENTRIES).html(this.getMessage(t)),this.getDisplayManager().handleEventEntriesChanged(this,[])}if(this.writeMessage(this.getResultsHeader(e)),0==e.length)return;this.getGet();this.writeHtml(ID_FOOTER_LEFT,""),null!=this.footerRight&&this.writeHtml(ID_FOOTER_RIGHT,this.footerRight);let i=this.makeEntriesDisplay(e),a="";a+=HU.openTag(TAG_OL,[ATTR_CLASS,this.getClass("list"),ATTR_ID,this.getDomId(ID_LIST)]),a+=i,a+=HU.closeTag(TAG_OL),this.writeEntries(a,e),this.addEntrySelect(),this.getDisplayManager().handleEventEntriesChanged(this,e),this.galleryId&&HU.createFancyBox($("#"+this.galleryId).find("a.popup_image"),{helpers:{title:{type:"over"}}});let l=(t,e)=>{this.activeTabIndex=e.newTab.index(),HtmlUtil.tabLoaded()};if(this.tabId){let t=this.activeTabIndex;t>=this.tabCount&&(t=this.tabCount-1),$("#"+this.tabId).tabs({activate:l,active:t})}if(this.myDisplays&&this.myDisplays.length){let t=0,i=[new RecordField({type:"string",index:t++,id:"name",label:"Name"}),new RecordField({type:"string",index:t++,id:"description",label:"Description"}),new RecordField({type:"url",index:t++,id:"url",label:"URL"}),new RecordField({type:"image",index:t++,id:"image",label:"Image"}),new RecordField({type:"url",index:t++,id:"iconUrl",label:"Icon"}),new RecordField({type:"string",index:t++,id:"tags",label:"Tags"}),new RecordField({index:t++,id:"latitude",label:"Latitude"}),new RecordField({index:t++,id:"longitude",label:"Longitude"})],a=null;this.entryTypes&&this.entryTypes.length&&(a=this.entryTypes[0],a.getColumns().forEach((e=>{i.push(new RecordField({index:t++,id:e.getName(),label:e.getLabel()}))})));let s=t=>{let e=[];return t.forEach((t=>{let s=this.makeEntryTags(t,!0,""),l=this.getDefaultImage();l&&l.startsWith("http")&&(l=ramaddaBaseUrl+l);let r=[t.getName(),t.getSnippet()||"",t.getEntryUrl(),t.getImageUrl()||l||"",t.getIconUrl(),s,t.getLatitude(),t.getLongitude()];a&&a.getColumns().forEach((e=>{let i=t.getAttributeValue(e.getName());r.push(i)})),e.push(new PointRecord(i,t.getLatitude(),t.getLongitude(),NaN,t.getStartDate()||t.getCreateDate(),r,0))})),e},l=new PointData("pointdata",i,s(e),null,null),r=this;this.myDisplays.forEach((t=>{let e=t.entries?new PointData("pointdata",i,s(t.entries)):l,a=this.getProperty("tooltip"),o={dialogListener:(t,e)=>{e.find(".display-search-tag").click((function(){let t=$(this).attr("metadata-type"),e=$(this).attr("metadata-value");r.addMetadataTag(t,t,e)&&r.submitSearchForm()}))},highlightColor:"#436EEE",blockStyle:this.getProperty("blockStyle",""),doPopup:this.getProperty("doPopup",!0),tooltip:a,tooltipClick:a,descriptionField:"description",imageWidth:"140px",blockWidth:"150px",numberOfImages:500,showTableOfContents:!0,iconField:"iconUrl",iconSize:16,displayEntries:!1,imageField:"image",urlField:"url",titleField:"name",labelField:"name",labelFields:"name",showBottomLabel:!1,bottomLabelTemplate:"",topLabelTemplate:"${name}",textTemplate:"${description}",displayId:t.id,divid:t.id,showMenu:!1,theData:e,displayStyle:""};t.display=this.getDisplayManager().createDisplay(t.type,o)}))}if(this.mapId&&this.areaEntries&&this.areaEntries.length>0){let t=new RepositoryMap(this.mapId);t.initMap(!1),this.areaEntries.forEach((e=>{let i=HU.tag(TAG_A,["target","_entries",ATTR_HREF,e.getEntryUrl()],e.getName()),a=i;e.isImage()&&(a=HU.image(e.getResourceUrl(),[ATTR_WIDTH,"400",ATTR_ID,this.getDomId("entry_"+e.getIdForDom()),ATTR_ENTRYID,e.getId(),ATTR_CLASS,"display-entrygallery-entry"])+"<br>"+i),t.addMarker("",{x:e.getLongitude(),y:e.getLatitude()},e.getIconUrl(),"",a,null,16,0,!0,{})})),t.centerOnMarkersInit(null)}}})}function RamaddaSimplesearchDisplay(t,e,i){const a=new RamaddaSearcherDisplay(t,e,DISPLAY_SIMPLESEARCH,i);defineDisplay(addRamaddaDisplay(this),a,[{label:"Simple Search"},{p:"resultsPosition",ex:"absolute|relative"},{p:"maxHeight",ex:300},{p:"maxWidth",ex:200},{p:"maxWidth",ex:200},{p:"autoSearch",ex:!0},{p:"showHeader",ex:!0},{p:"inputSize",ex:"100%"},{p:"searchEntryType",ex:"",tt:"Constrain search to entries of this type"},{p:"doPageSearch",ex:"true"},{p:"pageSearchSelector",d:".search-component",ex:".search-component or .entry-list-row"}],{callNumber:1,haveDisplayed:!1,selectedEntries:[],getSelectedEntries:function(){return this.selectedEntries},initDisplay:function(){let t=this;if(this.getIsLayoutFixed()&&this.haveDisplayed)return;this.haveDisplayed=!0,this.createUI(),this.setContents(this.getDefaultHtml()),this.initHtml();let e=this.jq(ID_TEXT_FIELD);this.getAutoSearch(!0)&&e.keyup((function(e){t.getSearchSettings().skip=0,t.getSearchSettings().max=DEFAULT_MAX;let i=$(this).val().trim();if(""==i)return void t.clearSearch();if(!t.getDoPageSearch()&&i.length<=4)return;let a=++t.callNumber;setTimeout((()=>{a==t.callNumber&&t.doSearch(!0,a)}),400)})),this.jq(ID_SEARCH).click((function(e){t.doSearch(!1,++t.callNumber),e.preventDefault()})),this.jq(ID_FORM).submit((function(e){t.doSearch(!1,++t.callNumber),e.preventDefault()})),this.jq(ID_TEXT_FIELD).autocomplete({source:function(t,e){}})},getDefaultHtml:function(){let t=this.makeSearchForm(),e="";if(!("absolute"==this.getProperty("resultsPosition","absolute"))){this.getMaxHeight(400)&&(e+=HU.css("max-height",HU.getDimension(this.getMaxHeight(400)))),this.getMaxWidth()&&(e+=HU.css("width",HU.getDimension(this.getMaxWidth(400))),e+=HU.css("max-width",HU.getDimension(this.getMaxWidth(200))));let i=HU.div([ID,this.domId(ID_ENTRIES),CLASS,"display-simplesearch-entries",STYLE,e]);this.getShowHeader(!0)&&(t+=HU.div([ATTR_CLASS,"display-entries-results",ATTR_ID,this.getDomId(ID_RESULTS)])),t+=i}return t},makeSearchForm:function(){let t=HU.openTag("form",[ATTR_ID,this.getDomId(ID_FORM),"action","#"]),e=this.getEgText(),i=this.getFormText(),a=this.getPropertyInputSize("100%");return t+=HU.input("",i,[STYLE,HU.css("width",a),"placeholder",e,ATTR_CLASS,"display-search-input",ATTR_ID,this.getDomId(ID_TEXT_FIELD)]),t+='<input type="submit" style="position:absolute;left:-9999px;width:1px;height:1px;"/>',t+=HU.closeTag("form"),t+=HU.div([ID,this.domId(ID_FORM)]),t},handleNoEntries:function(){this.writeEntries("",[]),this.writeMessage("Nothing found"),this.getDisplayManager().handleEventEntriesChanged(this,[])},writeMessage:function(t){this.makeDialog(),a.writeMessage.call(this,t)},makeDialog:function(){if(!this.dialog||null!=this.dialog.parent()&&0!=this.dialog.parent().length||(this.dialog=null),this.dialog)this.dialog.show();else{let t=HU.div([ATTR_CLASS,"display-entries-results",ATTR_ID,this.getDomId(ID_RESULTS)],"&nbsp;"),e=HU.div([CLASS,"display-entries-entries",ATTR_ID,this.getDomId(ID_ENTRIES)],"");this.dialog=HU.makeDialog({content:t+e,anchor:this.getContents(),draggable:!0,header:!0})}},writeEntries:function(t,e){"absolute"==this.getProperty("resultsPosition","absolute")?(this.makeDialog(),Utils.stringDefined(t)?(this.jq(ID_ENTRIES).html(t),this.writeMessage(this.getResultsHeader(e,!0))):this.jq(ID_ENTRIES).html("")):this.jq(ID_ENTRIES).html(t)},getPageSearchSelectors:function(){let t=$(this.getPageSearchSelector());return 0==t.length&&console.log(this.type+" could not find page search components:"+this.getPageSearchSelector()),t},doPageSearch:function(){let t=(this.jq(ID_TEXT_FIELD).val()||"").trim();if(""==t)return void this.clearPageSearch();let e,i=this.getPageSearchSelectors();t=t.toLowerCase();try{e=new RegExp(t)}catch(t){console.log("bad regexp:"+t)}i.each((function(){let i=Utils.stripTags($(this).html()).toLowerCase(),a=!1;(i.indexOf(t)>=0||e&&i.match(e))&&(a=!0),a?$(this).show():$(this).hide()}))},clearPageSearch:function(){this.getPageSearchSelectors().show()},clearSearch:function(){this.writeMessage(""),this.writeEntries(""),this.dialog&&(this.dialog.remove(),this.dialog=null),this.getDoPageSearch()&&this.clearPageSearch()},doSearch:function(t,e){this.getDoPageSearch()?this.doPageSearch():this.submitSearchForm(t,e)},submitSearchForm:function(t,e){this.writeMessage(this.getWaitImage()+" Searching..."),null==e&&(e=this.callNumber),this.haveSearched=!0,this.makeSearchSettings().entryType=this.getSearchEntryType();let i=this.makeSearchUrl(this.getRamadda());this.entryList=new EntryList(this.getRamadda(),i);this.entryList.doSearch(null,(()=>{this.callNumber==e&&this.entryListChanged(this.entryList)}),(t=>{this.writeEntries("Error:"+t)})),t||this.updateForSearching(i)},makeDisplayList:function(){let t=this.getSelectedEntriesFromTree();if(0==t.length)return;let e={selectedEntries:t,showForm:!1,showMenu:!0,fixedEntries:!0};e.entryList=new EntryList(this.getRamadda(),"",this,!1),e.entryList.setEntries(t),this.getDisplayManager().createDisplay(DISPLAY_ENTRYLIST,e)},handleEventEntrySelection:function(t,e){this.selectEntry(e.entry,e.selected)},selectEntry:function(t,e){let i=!1;if(e){this.jq("entry_"+t.getIdForDom()).addClass("ui-selected"),this.selectedEntries.indexOf(t)<0&&(this.selectedEntries.push(t),i=!0)}else{this.jq("entry_"+t.getIdForDom()).removeClass("ui-selected");let e=this.selectedEntries.indexOf(t);e>=0&&(this.selectedEntries.splice(e,1),i=!0)}},makeEntriesDisplay:function(t){return this.getEntriesTree(t)},entryListChanged:function(t){this.multiSearch&&this.multiSearch.count--,a.entryListChanged.apply(this,[t]);let e=this.entryList.getEntries();if(0==e.length)return this.getSearchSettings().skip=0,this.getSearchSettings().max=DEFAULT_MAX,void this.handleNoEntries();this.writeMessage(this.getResultsHeader(e,!0)),this.initCloser(ID_RESULTS);this.getGet();this.writeHtml(ID_FOOTER_LEFT,""),null!=this.footerRight&&this.writeHtml(ID_FOOTER_RIGHT,this.footerRight);let i="",s={};e.forEach(((t,e)=>{s[t.getId()]=t;let a=t.getThumbnail(),l=[TITLE,"",CLASS,"display-simplesearch-entry","entryid",t.getId()];a&&l.push("thumbnail",a),i+=HU.div(l,HU.href(this.getRamadda().getEntryUrl(t),HU.image(t.getIconUrl())+"  "+t.getName()))})),this.writeEntries(i,e);let l=this;this.jq(ID_ENTRIES).find(".display-simplesearch-entry img").tooltip({content:function(){let t,e=$(this).attr("thumbnail"),i=s[$(this).attr("entryid")],a=!0;i.getParentEntry((e=>{t=e,a||l.jq("parenttooltip").html(HU.b("Parent: ")+t.getName())})),a=!1;let r=i.getSnippet(),o=HU.div([ID,l.domId("parenttooltip")],t?HU.b("Parent: ")+t.getName():"");return r&&(o+=r),e&&(o+=HU.div([STYLE,HU.css("max-height","100px","overflow-y","hidden")],HU.image(e,["width","300px"]))),o}}),this.getDisplayManager().handleEventEntriesChanged(this,e)}})}function RamaddaEntrygridDisplay(t,e,i){const a="contents",s="grid",l="axis_left",r="axis_bottom",o="canvas",n="links",h="gridsettings",d="yAxisAscending",p="scaleHeight",g="xAxisAscending",c="scaleWidth",u="showIcon",y="showName",m="boxColor";let f=new RamaddaEntryDisplay(t,e,DISPLAY_ENTRY_GRID,i);defineDisplay(addRamaddaDisplay(this),f,[],{entries:i.entries,initDisplay:function(){let t=this;this.createUI();let e=HU.div([ATTR_ID,this.getDomId(a)],this.getLoadingMessage("Loading entries..."));if(this.setContents(e),!this.entryIds)return void t.jq(a).html(this.getLoadingMessage("No entries specified"));let i={entries:this.entryIds},h=new EntrySearchSettings(i),d=this.getRamadda().getSearchUrl(h,OUTPUT_JSON,"BAR"),p={entryListChanged:function(e){if(t.entries=e.getEntries(),0==t.entries.length)return void t.jq(a).html(t.getLoadingMessage("No entries selected"));t.drag=null,t.jq(a).html(t.makeFramework()),t.canvas=$("#"+t.getDomId(o)),t.gridPopup=$("#"+t.getDomId(s)+" .display-grid-popup");let i=t.jq(r),h=t.jq(l),d=function(e){t.handledClick=!1,t.drag={dragging:!1,x:GuiUtils.getEventX(e),y:GuiUtils.getEventY(e),X:{minDate:t.axis.X.minDate?t.axis.X.minDate:t.minDate,maxDate:t.axis.X.maxDate?t.axis.X.maxDate:t.maxDate},Y:{minDate:t.axis.Y.minDate?t.axis.Y.minDate:t.minDate,maxDate:t.axis.Y.maxDate?t.axis.Y.maxDate:t.maxDate}}},p=function(e){t.drag=null,t.handledClick=!1},g=function(e){t.drag&&(t.drag.dragging&&(t.handledClick=!0),t.drag=null)},c=function(e,i,a){let s=t.drag;if(!s)return;s.dragging=!0;let l=GuiUtils.getEventX(e),r=(s.x,GuiUtils.getEventY(e)),o=(s.y,$(this).width()),n=$(this).height(),h=(l-s.x)/o,d=(r-s.y)/n,p=t.getXAxisAscending(),g=t.getXAxisAscending(),c=(s.X.maxDate.getTime()-s.X.minDate.getTime())*h,u=(s.Y.maxDate.getTime()-s.Y.minDate.getTime())*d;i&&(t.axis.X.minDate=new Date(s.X.minDate.getTime()+(p?-1:1)*c),t.axis.X.maxDate=new Date(s.X.maxDate.getTime()+(p?-1:1)*c)),a&&(t.axis.Y.minDate=new Date(s.Y.minDate.getTime()+(g?1:-1)*u),t.axis.Y.maxDate=new Date(s.Y.maxDate.getTime()+(g?1:-1)*u)),t.makeGrid(t.entries)},u=function(e,i,a){if(t.handledClick)return void(t.handledClick=!1);if(t.drag&&t.drag.dragging)return void(t.drag=null);let s;if(t.drag=null,e.metaKey||e.ctrlKey)s="reset";else{s=e.shiftKey?"zoomout":"zoomin"}t.doZoom(s,i,a)};t.canvas.mousedown(d),t.canvas.mouseleave(p),t.canvas.mouseup(g),t.canvas.mousemove((function(t){c(t,!0,!0)})),t.canvas.click((function(t){u(t,!0,!0)})),i.mousedown(d),i.mouseleave(p),i.mouseup(g),i.mousemove((function(t){c(t,!0,!1)})),i.click((function(t){u(t,!0,!1)})),h.mousedown(d),h.mouseleave(p),h.mouseup(g),h.mousemove((function(t){c(t,!1,!0)})),h.click((function(t){u(t,!1,!0)}));let y=HU.image(icon_zoom,["class","display-grid-action","title","reset zoom","action","reset"])+HU.image(icon_zoom_in,["class","display-grid-action","title","zoom in","action","zoomin"])+HU.image(icon_zoom_out,["class","display-grid-action","title","zoom out","action","zoomout"]);t.jq(n).html(y),$("#"+t.getDomId(s)+" .display-grid-action").click((function(){let e=$(this).attr("action");t.doZoom(e)})),t.jq(l).html(""),t.jq(r).html(""),t.makeGrid(t.entries)}};new EntryList(this.getRamadda(),d,p,!0)},initDialog:function(){f.initDialog.call(this);let t=this;this.jq("gridsettings :checkbox").click((function(){t.setProperty($(this).attr("attr"),$(this).is(":checked")),t.makeGrid(t.entries)}));let e=this.jq("gridsettings :input");e.blur((function(){t.setProperty($(this).attr("attr"),$(this).val()),t.makeGrid(t.entries)})),e.keypress((function(e){13==(e.keyCode?e.keyCode:e.which)&&(t.setProperty($(this).attr("attr"),$(this).val()),t.makeGrid(t.entries))}))},getDialogContents:function(t,e){let i="";i+=HU.openTag("div",["id",this.getDomId(h)]),i+=HU.formTable(),i+=HU.formEntry("",HU.checkbox(this.getDomId(u),["attr",u],this.getProperty(u,"true"))+" Show Icon&nbsp;&nbsp;"+HU.checkbox(this.getDomId(y),["attr",y],this.getProperty(y,"true"))+" Show Name"),i+=HU.formEntry("X-Axis:",HU.checkbox(this.getDomId(g),["attr",g],this.getXAxisAscending())+" Ascending&nbsp;&nbsp;"+HU.checkbox(this.getDomId(c),["attr",c],this.getXAxisScale())+" Scale Width"),i+=HU.formEntry("Y-Axis:",HU.checkbox(this.getDomId(d),["attr",d],this.getYAxisAscending())+" Ascending&nbsp;&nbsp;"+HU.checkbox(this.getDomId(p),["attr",p],this.getYAxisScale())+" Scale Height"),i+=HU.formEntry("Box Color:",HU.input(this.getDomId(m),this.getProperty(m,"lightblue"),["attr",m])),i+=HU.formTableClose(),i+=HU.closeTag("div"),t.push("Entry Grid"),e.push(i),f.getDialogContents.call(this,t,e)},doZoom:function(t,e,i){if(Utils.isDefined(e)||(e=!0),Utils.isDefined(i)||(i=!0),"reset"==t)this.axis.Y.minDate=null,this.axis.Y.maxDate=null,this.axis.X.minDate=null,this.axis.X.maxDate=null;else{let a="zoomout"==t;if(e){let t=this.axis.X.minDate.getTime(),e=this.axis.X.maxDate.getTime(),i=(a?1:-1)*(e-t)*.1;this.axis.X.minDate=new Date(t-i),this.axis.X.maxDate=new Date(e+i)}if(i){let t=this.axis.Y.minDate.getTime(),e=this.axis.Y.maxDate.getTime(),i=(a?1:-1)*(e-t)*.1;this.axis.Y.minDate=new Date(t-i),this.axis.Y.maxDate=new Date(e+i)}}this.makeGrid(this.entries)},initGrid:function(t){let e=this,i=this.canvas.find(".display-grid-entry");i.click((function(i){let a=parseInt($(this).attr("index"));entry=t[a];let s=entry.getEntryUrl();e.urlTemplate&&(s=e.urlTemplate.replace("{url}",s).replace(/{entryid}/g,entry.getId()).replace(/{resource}/g,entry.getResourceUrl())),e.handledClick=!0,e.drag=null,window.open(s,"_entry")})),i.mouseout((function(){let t=$(this).attr("entryid");if(t){e.canvas.find("[entryid='"+t+"']").each((function(){"box"==$(this).attr("itemtype")&&($(this).attr("prevcolor",$(this).css("background")),$(this).css("background",$(this).attr("prevcolor")))}))}e.gridPopup.hide()})),i.mouseover((function(i){let a=$(this).attr("entryid");if(a){e.canvas.find("[entryid='"+a+"']").each((function(){"box"==$(this).attr("itemtype")&&($(this).attr("prevcolor",$(this).css("background")),$(this).css("background","rgba(0,0,255,0.5)"))}))}GuiUtils.getEventX(i);let s=parseInt($(this).attr("index"));entry=t[s];let l=entry.getThumbnail(),r="";l?r=HU.image(l,["width","300;"])+"<br>":entry.isImage()&&(r+=HU.image(entry.getResourceUrl(),["width","300"])+"<br>"),r+=entry.getIconImage()+" "+entry.getName()+"<br>",r+="Date: "+(entry.getStartDate().getUTCFullYear()+"-"+Utils.padLeft(entry.getStartDate().getUTCMonth()+1,2,"0")+"-"+Utils.padLeft(entry.getStartDate().getUTCDate(),2,"0"))+" - "+(entry.getEndDate().getUTCFullYear()+"-"+Utils.padLeft(entry.getEndDate().getUTCMonth()+1,2,"0")+"-"+Utils.padLeft(entry.getEndDate().getUTCDate(),2,"0"))+" UTC",e.gridPopup.html(r),e.gridPopup.show(),e.gridPopup.position({of:$(this),at:"left bottom",my:"left top",collision:"none none"}),e.gridPopup.position({of:$(this),my:"left top",at:"left bottom",collision:"none none"})}))},makeFramework:function(t){let e="";return e+=HU.openDiv(["class","display-grid","id",this.getDomId(s)]),e+=HU.div(["class","display-grid-popup ramadda-popup"],""),e+=HU.openTag("table",["border","0","class","","cellspacing","0","cellspacing","0","width","100%","style","height:100%;"]),e+=HU.openTag("tr",["valign","bottom"]),e+=HU.tag("td"),e+=HU.tag("td",[],HU.div(["id",this.getDomId(n)],"")),e+=HU.closeTag("tr"),e+=HU.openTag("tr",["style","height:100%;"]),e+=HU.openTag("td",["style","height:100%;"]),e+=HU.openDiv(["class","display-grid-axis-left ramadda-noselect","id",this.getDomId(l)]),e+=HU.closeDiv(),e+=HU.closeDiv(),e+=HU.closeTag("td"),e+=HU.openTag("td",["style","height:"+this.getProperty("height","400")+"px"]),e+=HU.openDiv(["class","display-grid-canvas ramadda-noselect","id",this.getDomId(o)]),e+=HU.closeDiv(),e+=HU.closeDiv(),e+=HU.closeTag("td"),e+=HU.closeTag("tr"),e+=HU.openTag("tr",[]),e+=HU.tag("td",["width","100"],"&nbsp;"),e+=HU.openTag("td",[]),e+=HU.div(["class","display-grid-axis-bottom ramadda-noselect","title","click:zoom in;shift-click:zoom out;command/ctrl click: reset","id",this.getDomId(r)],""),e+=HU.closeTag("table"),e+=HU.closeTag("td"),e},getXAxisType:function(){return this.getProperty("xAxisType","date")},getYAxisType:function(){return this.getProperty("yAxisType","month")},getXAxisAscending:function(){return this.getProperty(g,!0)},getYAxisAscending:function(){return this.getProperty(d,!0)},getXAxisScale:function(){return this.getProperty(c,!0)},getYAxisScale:function(){return this.getProperty(p,!1)},makeGrid:function(t){let e=this.getProperty(u,!0),i=this.getProperty(y,!0);if(!this.minDate){let e=null,i=null;for(let a=0;a<t.length;a++){let s=t[a];e=null==e||e.getTime()>s.getStartDate().getTime()?s.getStartDate():e,i=null==i||i.getTime()<s.getEndDate().getTime()?s.getEndDate():i}this.minDate=new Date(Date.UTC(e.getUTCFullYear(),0,1)),this.maxDate=new Date(Date.UTC(i.getUTCFullYear()+1,0,1))}let a={width:this.canvas.width(),height:this.canvas.height(),Y:{vertical:!0,axisType:this.getYAxisType(),ascending:this.getYAxisAscending(),scale:this.getYAxisScale(),skip:1,maxTicks:Math.ceil(this.canvas.height()/80),minDate:this.minDate,maxDate:this.maxDate,ticks:[],lines:"",html:"",minDate:this.minDate,maxDate:this.maxDate},X:{vertical:!1,axisType:this.getXAxisType(),ascending:this.getXAxisAscending(),scale:this.getXAxisScale(),skip:1,maxTicks:Math.ceil(this.canvas.width()/80),minDate:this.minDate,maxDate:this.maxDate,ticks:[],lines:"",html:""}};this.axis?(this.axis.X.minDate?(a.X.minDate=this.axis.X.minDate,a.X.maxDate=this.axis.X.maxDate):(this.axis.X.minDate=a.X.minDate,this.axis.X.maxDate=a.X.maxDate),this.axis.Y.minDate?(a.Y.minDate=this.axis.Y.minDate,a.Y.maxDate=this.axis.Y.maxDate):(this.axis.Y.minDate=a.Y.minDate,this.axis.Y.maxDate=a.Y.maxDate)):this.axis=a,"size"==a.Y.axisType?this.calculateSizeAxis(a.Y):"date"==a.Y.axisType?this.calculateDateAxis(a.Y):this.calculateMonthAxis(a.Y);for(let t=0;t<a.Y.ticks.length;t++){let e=a.Y.ticks[t],i="bottom:"+e.percent+"%;",s=e.major?"display-grid-hline-major":"display-grid-hline";a.Y.lines+=HU.div(["style",i,"class",s]," "),a.Y.html+=HU.div(["style",i,"class","display-grid-axis-left-tick"],e.label+" "+HU.div(["class","display-grid-htick"],""))}"size"==a.X.axisType?this.calculateSizeAxis(a.X):"date"==a.X.axisType?this.calculateDateAxis(a.X):this.calculateMonthAxis(a.X);for(let t=0;t<a.X.ticks.length;t++){let e=a.X.ticks[t];if(e.percent>0){let t=e.major?"display-grid-vline-major":"display-grid-vline";a.X.lines+=HU.div(["style","left:"+e.percent+"%;","class",t]," ")}a.X.html+=HU.div(["style","left:"+e.percent+"%;","class","display-grid-axis-bottom-tick"],HU.div(["class","display-grid-vtick"],"")+" "+e.label)}let s="",n={};for(let l=0;l<t.length;l++){let r=t[l],o=this[a.Y.calculatePercent].call(this,r,a.Y),h=this[a.X.calculatePercent].call(this,r,a.X);o.p1<0&&(o.p2=o.p2+o.p1,o.p1=0),o.p1+o.p2>100&&(o.p2=100-o.p1);let d="",p="";a.X.ascending?(d+="left:"+h.p1+"%;",p+="left:"+h.p1+"%;"):(d+="right:"+h.p1+"%;",p+="left:"+(100-h.p2)+"%;"),a.X.scale&&(h.delta>1?d+="width:"+h.delta+"%;":d+="width:"+this.getProperty("fixedWidth","5")+"px;");let g=p;a.Y.ascending?(d+=" bottom:"+o.p2+"%;",p+=" bottom:"+o.p2+"%;",g+=" bottom:"+o.p2+"%;"):(d+=" top:"+o.p2+"%;",p+=" top:"+o.p2+"%;",g+=" top:"+o.p2+"%;",g+="margin-top:-15px;"),a.Y.scale&&(o.p2>1?d+="height:"+o.delta+"%;":d+="height:"+this.getProperty("fixedHeight","5")+"px;"),r.getName().includes("rilsd")&&console.log("pos:"+g),e&&(s+=HU.div(["class","display-grid-entry-icon display-grid-entry","entryid",r.getId(),"index",l,"style",p],r.getIconImage()));let c=Math.round(h.p1)+"---"+Math.round(o.p1);if(i&&!n[c]){n[c]=!0;let t=r.getName().replace(/ /g,"&nbsp;");s+=HU.div(["class","display-grid-entry-text display-grid-entry","entryid",r.getId(),"index",l,"style",g],t)}let u=d+"background:"+this.getProperty(m,"lightblue");s+=HU.div(["class","display-grid-entry-box display-grid-entry","itemtype","box","entryid",r.getId(),"style",u,"index",l],"")}this.jq(l).html(a.Y.html),this.jq(o).html(a.Y.lines+a.X.lines+s),this.jq(r).html(a.X.html),this.initGrid(t)},calculateSizeAxis:function(t){let e=Number.MAX_VALUE,i=Number.MIN_VALUE;for(let t=0;t<this.entries.length;t++){let a=this.entries[t];e=Math.min(e,a.getSize()),i=Math.max(i,a.getSize())}},checkOrder:function(t,e){return{p1:e.p1,p2:e.p2,delta:Math.abs(e.p2-e.p1)}},calculateDatePercent:function(t,e){let i=100*(t.getStartDate().getTime()-e.min)/e.range,a=100*(t.getEndDate().getTime()-e.min)/e.range;return this.checkOrder(e,{p1:i,p2:a,delta:Math.abs(a-i)})},calculateMonthPercent:function(t,e){let i=t.getStartDate(),a=t.getEndDate(),s=new Date(Date.UTC(1,i.getUTCMonth(),i.getUTCDate())),l=new Date(Date.UTC(1,a.getUTCMonth(),a.getUTCDate())),r=(s.getTime()-e.min)/e.range*100,o=(l.getTime()-e.min)/e.range*100;return t.getName().includes("rilsd")&&(console.log("t1:"+s),console.log("t2:"+l),console.log("before:"+r+" "+o)),this.checkOrder(e,{p1:r,p2:o,delta:Math.abs(o-r)})},calculateMonthAxis:function(t){t.calculatePercent="calculateMonthPercent",t.minDate=new Date(Date.UTC(0,11,15)),t.maxDate=new Date(Date.UTC(1,11,31)),t.min=t.minDate.getTime(),t.max=t.maxDate.getTime(),t.range=t.max-t.min;let e=Utils.getMonthShortNames();for(let i=0;i<e.length;i++){let a=new Date(Date.UTC(1,i)),s=(t.maxDate.getTime()-a.getTime())/t.range;t.ascending&&(s=1-s),t.ticks.push({percent:100*s,label:e[i],major:!1})}},calculateDateAxis:function(t){t.calculatePercent="calculateDatePercent";let e=t.maxDate.getUTCFullYear()-t.minDate.getUTCFullYear();if(t.type="year",t.skip=Math.max(1,Math.floor(e/t.maxTicks)),e/t.skip<=t.maxTicks/2){let e=0,i=new Date(t.minDate.getTime());for(;i.getTime()<t.maxDate.getTime();)Utils.incrementMonth(i),e++;if(t.skip=Math.max(1,Math.floor(e/t.maxTicks)),t.type="month",e/t.skip<=t.maxTicks/2){let e=new Date(t.minDate.getTime()),i=0;for(;e.getTime()<t.maxDate.getTime();)Utils.incrementDay(e),i++;t.skip=Math.max(1,Math.floor(i/t.maxTicks)),t.type="day"}}t.min=t.minDate.getTime(),t.max=t.maxDate.getTime(),t.range=t.max-t.min;let i,a=Utils.getMonthShortNames(),s=null,l=null;for(i="year"==t.type?new Date(Date.UTC(t.minDate.getUTCFullYear())):"month"==t.type?new Date(Date.UTC(t.minDate.getUTCFullYear(),t.minDate.getUTCMonth())):new Date(Date.UTC(t.minDate.getUTCFullYear(),t.minDate.getUTCMonth(),t.minDate.getUTCDate()));i.getTime()<t.maxDate.getTime();){let e=(i.getTime()-t.minDate.getTime())/t.range;if(t.ascending||(e=1-e),e*=100,e>=0&&e<100){let r="",o=i.getUTCFullYear(),n=i.getUTCMonth(),h=!1;"year"==t.type?r=o:"month"==t.type?(r=a[i.getUTCMonth()],s!=o&&(r=r+"<br>"+o,s=o,h=!0)):(r=i.getUTCDate(),s==o&&l==n||(r=r+"<br>"+a[n]+" "+o,s=o,l=n,h=!0)),t.ticks.push({percent:e,label:r,major:h})}"year"==t.type?Utils.incrementYear(i,t.skip):"month"==t.type?Utils.incrementMonth(i,t.skip):Utils.incrementDay(i,t.skip)}}})}function RamaddaMetadataDisplay(t,e,i){let a;null==i.formOpen&&(i.formOpen=!1),RamaddaUtil.inherit(this,a=new RamaddaSearcherDisplay(t,e,DISPLAY_METADATA,i)),addRamaddaDisplay(this),RamaddaUtil.defineMembers(this,{haveDisplayed:!1,initDisplay:function(){this.createUI(),this.setContents(this.getDefaultHtml()),this.initHtml(),a.initDisplay.apply(this),this.haveDisplayed&&this.entryList&&this.entryListChanged(this.entryList),this.haveDisplayed=!0},entryListChanged:function(t){this.entryList=t;let e=this.entryList.getEntries();if(0==e.length)return void this.writeMessage("Nothing found");let i=this.getEntriesMetadata(e);this.writeEntries(i,e),HU.formatTable("#"+this.getDomId("table"),{scrollY:400})}})}function RamaddaEntrydisplayDisplay(t,e,i){let a;if($.extend(this,{sourceEntry:i.sourceEntry}),RamaddaUtil.inherit(this,a=new RamaddaDisplay(t,e,DISPLAY_ENTRYDISPLAY,i)),null==i.sourceEntry&&null!=i.entryId){let t=this;(async function(){await t.getEntry(i.entryId,(e=>{t.sourceEntry=e,t.initDisplay()}))})()}addRamaddaDisplay(this),$.extend(this,{selectedEntry:null,initDisplay:function(){this.createUI();let t=this.title;if(null!=this.sourceEntry){this.addEntryHtml(this.sourceEntry);let e=this.sourceEntry.getEntryUrl();null==t&&(t=this.sourceEntry.getName()),t=HU.tag("a",["href",e,"title",this.sourceEntry.getName(),"alt",this.sourceEntry.getName()],t)}else this.addEntryHtml(this.selectedEntry),null==t&&(t="Entry Display");this.setDisplayTitle(t)},handleEventEntrySelection:function(t,e){if(null!=this.sourceEntry)return;let i=e.selected,a=e.entry;if(!i){if(this.selectedEntry!=a)return;return this.selectedEntry=null,void this.setContents("")}this.selectedEntry=a,this.addEntryHtml(this.selectedEntry)},getEntries:function(){return[this.sourceEntry]},addEntryHtml:function(t){if(null==t)return void this.setContents("&nbsp;");let e=this.getEntryHtml(t,{showHeader:!1}),i=this.getProperty("height","400px");i.endsWith("px")||(i+="px"),this.setContents(HU.div(["class","display-entry-description","style","height:"+i+";"],e)),this.entryHtmlHasBeenDisplayed(t)}})}function RamaddaEntrytitleDisplay(t,e,i){let a;if($.extend(this,{sourceEntry:i.sourceEntry}),RamaddaUtil.inherit(this,a=new RamaddaDisplay(t,e,DISPLAY_ENTRYDISPLAY,i)),null==i.sourceEntry&&null!=i.entryId){let t=this;(async function(){await t.getEntry(i.entryId,(e=>{t.sourceEntry=e,t.initDisplay()}))})()}defineDisplay(addRamaddaDisplay(this),a,[{label:"Entry Title"},{p:"template",ex:"<b>${icon} ${name} Date: ${date} ${start_date} ${end_date} ${entry_attribute...}</b>"},{p:"showLink",ex:"false"}],{initDisplay:function(){this.createUI();let t="";if(this.sourceEntry){let e=this.sourceEntry;t=this.getProperty("template","<b>${icon} ${name} Date: ${date}</b>"),t=t.replace("${name}",e.getDisplayName()),t=t.replace("${icon}",e.getIconImage()),t=t.replace("${date}",this.formatDate(e.getStartDate())),t=t.replace("${start_date}",this.formatDate(e.getStartDate())),t=t.replace("${end_date}",this.formatDate(e.getEndDate())),e.getAttributeNames().map((i=>{t=t.replace("${"+i+"}",e.getAttributeValue(i))})),this.getProperty("showLink",!0)&&(t=HU.href(e.getEntryUrl(),t))}this.displayHtml(t)},setEntry:function(t){this.sourceEntry=t,this.initDisplay()},handleEventEntrySelection:function(t,e){}})}function RamaddaOperandsDisplay(t,e,i){const a=TAG_SELECT,s="newdisplay";$.extend(this,new RamaddaEntryDisplay(t,e,DISPLAY_OPERANDS,i)),addRamaddaDisplay(this),$.extend(this,{baseUrl:null,initDisplay:function(){this.createUI(),this.baseUrl=this.getRamadda().getSearchUrl(this.searchSettings,OUTPUT_JSON),null==this.entryList&&(this.entryList=new EntryList(this.getRamadda(),jsonUrl,this));let t="";t+=HU.div([ATTR_ID,this.domId(ID_ENTRIES),ATTR_CLASS,this.getClass("entries")],""),this.setContents(t)},entryListChanged:function(t){let e="<form>";e+="<p>",e+=HU.openTag(TAG_TABLE,[ATTR_CLASS,"formtable","cellspacing","0","cellspacing","0"]);let i=this.entryList.getEntries();this.getGet();for(let t=1;t<=2;t++){let s=HU.openTag(TAG_SELECT,[ATTR_ID,this.getDomId(a+t)]);s+=HU.tag(TAG_OPTION,[ATTR_TITLE,"",ATTR_VALUE,""],"-- Select --");for(let t=0;t<i.length;t++){let e=i[t];e.getIconImage(),e.getName();s+=HU.tag(TAG_OPTION,[ATTR_TITLE,e.getName(),ATTR_VALUE,e.getId()],e.getName())}s+=HU.closeTag(TAG_SELECT),e+=HU.formEntry("Data:",s)}let l=HU.openTag(TAG_SELECT,[ATTR_ID,this.getDomId(ID_CHARTTYPE)]);l+=HU.tag(TAG_OPTION,[ATTR_TITLE,"",ATTR_VALUE,"linechart"],"Line chart"),l+=HU.tag(TAG_OPTION,[ATTR_TITLE,"",ATTR_VALUE,"barchart"],"Bar chart"),l+=HU.tag(TAG_OPTION,[ATTR_TITLE,"",ATTR_VALUE,"barstack"],"Stacked bars"),l+=HU.tag(TAG_OPTION,[ATTR_TITLE,"",ATTR_VALUE,"bartable"],"Bar table"),l+=HU.tag(TAG_OPTION,[ATTR_TITLE,"",ATTR_VALUE,"piechart"],"Pie chart"),l+=HU.tag(TAG_OPTION,[ATTR_TITLE,"",ATTR_VALUE,"scatterplot"],"Scatter Plot"),l+=HU.closeTag(TAG_SELECT),e+=HU.formEntry("Chart Type:",l),e+=HU.closeTag(TAG_TABLE),e+="<p>",e+=HU.tag(TAG_DIV,[ATTR_CLASS,"display-button",ATTR_ID,this.getDomId(s)],"New Chart"),e+="<p>",e+="</form>",this.writeEntries(e);let r=this;this.jq(s).button().click((function(t){r.createDisplay()}))},createDisplay:function(){let e=this.getEntry(this.jq("select1").val()),i=this.getEntry(this.jq("select2").val());if(null==e)return void alert("No data selected");let a=[];a.push(new PointData(e.getName(),null,null,ramaddaBaseUrl+"/entry/show?&output=points.product&product=points.json&numpoints=1000&entryid="+e.getId())),null!=i&&a.push(new PointData(i.getName(),null,null,ramaddaBaseUrl+"/entry/show?&output=points.product&product=points.json&numpoints=1000&entryid="+i.getId()));let s=new DerivedPointData(this.displayManager,"Derived Data",a,"average"),l=this.jq(ID_CHARTTYPE).val();t.createDisplay(l,{layoutFixed:!1,data:s})}})}function RamaddaRepositoriesDisplay(t,e,i){RamaddaUtil.inherit(this,new RamaddaEntryDisplay(t,e,DISPLAY_REPOSITORIES,i)),addRamaddaDisplay(this),RamaddaUtil.defineMembers(this,{initDisplay:function(){let t=this;this.createUI();let e="";0==this.ramaddas.length?e+=this.getMessage("No repositories specified"):e+=this.getMessage("Loading repository listing"),this.numberWithTypes=0,this.finishedInitDisplay=!1,this.ramaddas.length>1&&"all"==this.ramaddas[this.ramaddas.length-1].getRoot()&&this.ramaddas.splice(this.ramaddas.length-1,1);for(let e=0;e<this.ramaddas.length;e++){null!=this.ramaddas[e].getEntryTypes((function(e,i){t.gotTypes(e,i)}))&&this.numberWithTypes++}this.setDisplayTitle("Repositories"),this.setContents(e),this.finishedInitDisplay=!0,this.displayRepositories()},displayRepositories:function(){if(!this.finishedInitDisplay||this.numberWithTypes!=this.ramaddas.length)return;let t={},e=[],i="";i+=HU.openTag(TAG_TABLE,[ATTR_CLASS,"display-repositories-table",ATTR_WIDTH,"100%",ATTR_BORDER,"1","cellspacing","0","cellpadding","5"]);for(let i=0;i<this.ramaddas.length;i++){let a=this.ramaddas[i].getEntryTypes();for(let i=0;i<a.length;i++){let s=a[i];null==t[s.getId()]&&(t[s.getId()]=s,e.push(s))}}i+=HU.openTag(TAG_TR,["valign","bottom"]),i+=HU.th([ATTR_CLASS,"display-repositories-table-header"],"Type");for(let t=0;t<this.ramaddas.length;t++){let e=this.ramaddas[t],a=HU.href(e.getRoot(),e.getName());i+=HU.th([ATTR_CLASS,"display-repositories-table-header"],a)}i+="</tr>";let a=[];null!=this.categories&&(a=this.categories.split(","));let s={},l=[];for(let t=0;t<e.length;t++){let i=e[t],a="";a+="<tr>",a+=HU.td([],HU.image(i.getIcon())+" "+i.getLabel());for(let t=0;t<this.ramaddas.length;t++){let e=this.ramaddas[t],s=e.getEntryType(i.getId());if(null==s)a+=HU.td([ATTR_CLASS,"display-repositories-table-type-hasnot"],"");else{let t=HU.tag(TAG_A,["href",e.getRoot()+"/search/type/"+s.getId(),"target","_blank"],s.getEntryCount());a+=HU.td([ATTR_ALIGN,"right",ATTR_CLASS,"display-repositories-table-type-has"],t)}}a+="</tr>";let r=s[i.getCategory()];null==r&&(r=[],s[i.getCategory()]=r,l.push(i.getCategory())),r.push(a)}for(let t=0;t<l.length;t++){let e=l[t];if(a.length>0){let t=!1;for(let i=0;i<a.length;i++){if(e==a[i]){t=!0;break}if(e.match(a[i])){t=!0;break}}if(!t)continue}let r=s[e];i+="<tr>",i+=HU.th(["colspan",""+(1+this.ramaddas.length)],e),i+="</tr>";for(let t=0;t<r.length;t++)i+=r[t]}i+=HU.closeTag(HU.TAG_TABLE),this.setContents(i)},gotTypes:function(t,e){this.numberWithTypes++,this.displayRepositories()}})}function RamaddaExampleDisplay(t,e,i){var a="click",s="data";RamaddaUtil.inherit(this,new RamaddaDisplay(t,e,"example",i)),addRamaddaDisplay(this),RamaddaUtil.defineMembers(this,{initDisplay:function(){this.createUI();var t=this.getGet(),e="<p>";e+=HtmlUtils.onClick(t+".click();",HtmlUtils.div([ATTR_ID,this.getDomId(a)],"Click me")),e+="<p>",e+=HtmlUtils.div([ATTR_ID,this.getDomId(s)],""),this.setContents(e),this.updateUI()},needsData:function(){return!0},updateUI:function(){var t=this.getData();if(null!=t){t.getRecordFields();var e="";e+="#records:"+t.getRecords().length,this.jq(s).html(e)}},handleEventRecordSelection:function(t,e){},click:function(){this.jq(a).html("Click again")}})}addGlobalDisplayType({type:DISPLAY_ENTRYLIST,label:"Entry List",requiresData:!1,category:CATEGORY_ENTRIES}),addGlobalDisplayType({type:DISPLAY_ENTRYDISPLAY,label:"Entry Display",requiresData:!1,category:CATEGORY_ENTRIES}),addGlobalDisplayType({type:DISPLAY_ENTRYTITLE,label:"Entry Title",requiresData:!1,category:CATEGORY_ENTRIES}),addGlobalDisplayType({type:DISPLAY_ENTRY_GALLERY,label:"Entry Gallery",requiresData:!1,category:CATEGORY_ENTRIES}),addGlobalDisplayType({type:DISPLAY_ENTRY_GRID,label:"Entry Date Grid",requiresData:!1,category:CATEGORY_ENTRIES}),addGlobalDisplayType({type:DISPLAY_METADATA,label:"Metadata Table",requiresData:!1,category:CATEGORY_ENTRIES});const DISPLAY_MAP="map",DISPLAY_MAPGRID="mapgrid",DISPLAY_MAPCHART="mapchart",DISPLAY_MAPARRAY="maparray",DISPLAY_MAPSHRINK="mapshrink",DISPLAY_MAPIMAGES="mapimages";let displayMapMarkers=["marker.png","marker-blue.png","marker-gold.png","marker-green.png"],displayMapCurrentMarker=-1,displayMapUrlToVectorListeners={},displayMapMarkerIcons={};function MapFeature(t,e){RamaddaUtil.defineMembers(this,{source:t,points:e})}addGlobalDisplayType({type:DISPLAY_MAP,label:"Map",category:CATEGORY_MAPS,tooltip:makeDisplayTooltip("Maps of many colors",["map1.png","map2.png"],"Lots of ways to show georeferenced data - dots, heatmaps, plots, etc")}),addGlobalDisplayType({type:DISPLAY_MAPGRID,label:"Map Grid",category:CATEGORY_MAPS,tooltip:makeDisplayTooltip("Schematic map grid","mapgrid.png","Can display US States or World countries")}),addGlobalDisplayType({type:DISPLAY_MAPCHART,label:"Map Chart",requiresData:!0,category:CATEGORY_MAPS,tooltip:makeDisplayTooltip("2.5D display in a map","mapchart.png","Plot numeric data as heights. Can display US States, European countries or world countries")}),addGlobalDisplayType({type:DISPLAY_MAPSHRINK,label:"Map Shrink",requiresData:!0,category:CATEGORY_MAPS,tooltip:makeDisplayTooltip("Show values as relative size of map regions","mapshrink.png","Can display US States, European countries or world countries")}),addGlobalDisplayType({type:DISPLAY_MAPARRAY,label:"Map Array",requiresData:!0,category:CATEGORY_MAPS,tooltip:makeDisplayTooltip("Colored map regions displayed separately","maparray.png","Can display US States, European countries or world countries")}),addGlobalDisplayType({type:DISPLAY_MAPIMAGES,label:"Map Images",requiresData:!0,category:CATEGORY_MAPS,tooltip:makeDisplayTooltip("Display images in map regions","mapimage.png","Can display US States, European countries or world countries")});var ID_MAP="map";function RamaddaBaseMapDisplay(t,e,i,a){$.extend(this,{theMap:null});const s=new RamaddaDisplay(t,e,i,a);RamaddaUtil.inherit(this,s),this.defineSizeByProperties();displayDefineMembers(this,[{label:"Base Map Properties"},{p:"bounds",ex:"north,west,south,east",tt:"initial bounds"},{p:"gridBounds",ex:"north,west,south,east"},{p:"mapCenter",ex:"lat,lon",tt:"initial position"},{p:"zoomLevel",ex:4,tt:"initial zoom"},{p:"zoomTimeout",ex:500,tt:"initial zoom timeout delay. set this if the map is in tabs, etc, and not going to the initial zoom"},{p:"linked",ex:!0,tt:"Link location with other maps"},{p:"linkGroup",ex:"some_name",tt:"Map groups to link with"},{p:"initialLocation",ex:"lat,lon",tt:"initial location"},{p:"defaultMapLayer",ex:"ol.openstreetmap|esri.topo|esri.street|esri.worldimagery|esri.lightgray|esri.physical|opentopo|usgs.topo|usgs.imagery|usgs.relief|osm.toner|osm.toner.lite|watercolor"},{p:"mapLayers",ex:"ol.openstreetmap,esri.topo,esri.street,esri.worldimagery,esri.lightgray,esri.physical,opentopo,usgs.topo,usgs.imagery,usgs.relief,osm.toner,osm.toner.lite,watercolor"},{p:"extraLayers",tt:"comma separated list of layers to display"},{p:"annotationLayerTop",ex:"true",tt:"If showing the extra annotation layer put it on top"},{p:"showLocationSearch",ex:"true"},{p:"showLatLonPosition",ex:"false",d:!0},{p:"showLayerSwitcher",d:!0,ex:"false"},{p:"showScaleLine",ex:"true",d:!1},{p:"showZoomPanControl",ex:"true",d:!0},{p:"showZoomOnlyControl",ex:"false",d:!1},{p:"enableDragPan",ex:"false",d:!0},{p:"showLayers",d:!0,ex:"false",tt:"Connect points with map vectors"},{p:"showBaseLayersSelect",ex:!0,d:!1},{p:"locations",ex:"usairports.json,usstates.json"},{p:"highlightColor",d:"blue",ex:"#ccc",tt:""},{p:"highlightFillColor",ex:"#ccc",tt:""},{p:"highlightStrokeWidth",ex:"2",tt:""},{p:"highlightStrokeColor"},{p:"highlightStrokeWidth"},{p:"highlightFill"},{p:"highlightOpacity"},{p:"vectorLayerStrokeColor"},{p:"vectorLayerFillColor"},{p:"vectorLayerFillOpacity",ex:.25},{p:"vectorLayerStrokeWidth",ex:2}],{mapBoundsSet:!1,initDisplay:function(){s.initDisplay.call(this),HU.documentReady||$(document).ready((()=>{this.map&&setTimeout((()=>{this.callingUpdateSize=!0,this.map.getMap().updateSize(),this.callingUpdateSize=!1}),50)}));var t=this,e="",i=this.getProperty("height",this.getProperty("mapHeight",300));i<0&&(i=-i+"%"),i=HU.getDimension(i),e+=HU.css(HEIGHT,i);let a=HU.div(["tabindex","1",ATTR_CLASS,"display-map-map ramadda-expandable-target",STYLE,e,ATTR_ID,this.domId(ID_MAP)]),l=HU.div([CLASS,"ramadda-map-container"],a+HU.div([CLASS,"ramadda-map-slider",STYLE,this.getProperty("popupSliderStyle","max-height:400px;overflow-y:auto;max-width:300px;overflow-x:auto;"),ID,this.domId(ID_MAP)+"_slider"]));if(this.setContents(l),this.map?this.map.setMapDiv(this.domId(ID_MAP)):this.createMap(),!this.haveCalledUpdateUI){setTimeout((function(){t.updateUI()}),1)}},setErrorMessage:function(t){this.map?this.map.setProgress(HU.div([ATTR_CLASS,"display-map-message"],t)):s.setErrorMessage.call(this,t)},setMessage:function(t){this.map&&(""!=t&&(t=HU.div([ATTR_CLASS,"display-map-message"],t)),this.map.setProgress(t))},setMapLabel:function(t){this.map&&this.map.setLabel(HU.div([ATTR_CLASS,"display-map-message"],t))},startProgress:function(){this.setMessage(this.getProperty("loadingMessage","Creating map..."))},clearProgress:function(){this.errorMessage?this.errorMessage=null:this.map&&this.map.setProgress("")},checkLayout:function(){if(this.map){var t=this.jq(ID_MAP);if(t.width()>0&&this.lastWidth!=t.width()&&this.map&&(this.lastWidth=t.width(),this.map.getMap().updateSize()),!this.setMapLocationAndZoom&&this.mapParams&&(this.setMapLocationAndZoom=!0,this.mapParams.initialZoom>=0&&this.map.getMap().zoomTo(this.mapParams.initialZoom),this.mapParams.initialLocation)){let t=MapUtils.createLonLat(this.mapParams.initialLocation.lon,this.mapParams.initialLocation.lat);this.map.setCenter(t)}}},initMapParams:function(t){this.getProperty("showOpacitySlider"),t.showOpacitySlider=!0,["highlightStrokeColor","highlightFillColor","highlightStrokeWidth","highlightFillOpacity"].forEach((e=>{let i=this.getProperty(e);Utils.isDefined(i)&&(t[e]=i)}))},initMap:function(t){},doDisplayMap:function(){return!0},createMap:function(){let t=this;var e={defaultMapLayer:this.getDefaultMapLayer(map_default_layer),showLayerSwitcher:this.getShowLayerSwitcher(),showScaleLine:this.getShowScaleLine(),showLatLonPosition:this.getShowLatLonPosition(),showZoomPanControl:this.getShowZoomPanControl(),showZoomOnlyControl:this.getShowZoomOnlyControl(),enableDragPan:this.getEnableDragPan(),highlightColor:this.getHighlightColor(),highlightFillColor:this.getHighlightFillColor("transparent"),highlightStrokeWidth:this.getHighlightStrokeWidth(1),showLatLonLines:this.getProperty("showLatLonLines")};this.mapParams=e;var i=this.getProperty("displayDiv",null);i&&(e.displayDiv=i,e.displayDivSticky=this.getProperty("displayDivSticky",!1)),this.getShowLocationSearch(!0)||(e.showLocationSearch=!1);var a=this.getMapLayers(null);if(a&&(e.mapLayers=[a]),e.linked=this.getLinked(!1),e.linkGroup=this.getLinkGroup(null),this.hadInitialPosition=!1,this.getProperty("latitude")&&(this.hadInitialPosition=!0,e.initialLocation={lon:+this.getProperty("longitude",-105),lat:+this.getProperty("latitude",40)}),this.getMapCenter()&&(this.hadInitialPosition=!0,[lat,lon]=this.getMapCenter().split(","),e.initialLocation={lon:lon,lat:lat}),this.getZoomLevel()&&(this.hadInitialPosition=!0,e.initialZoom=+this.getZoomLevel(),e.initialZoomTimeout=this.getZoomTimeout()),this.map=this.getProperty("theMap",null),this.map)this.map.setMapDiv(this.domId(ID_MAP));else{if(this.getInitialLocation()){let t=this.getInitialLocation().split(",");e.initialLocation={lat:+t[0],lon:+t[1]}}this.initMapParams(e),this.map=new RepositoryMap(this.domId(ID_MAP),e),this.map.textGetter=(t,e)=>null,this.lastWidth=this.jq(ID_MAP).width()}this.initMap(this.map),this.doDisplayMap()&&this.map.setDefaultCanSelect(!1),this.map.initMap(!1);let s=Utils.isDefined(this.getZoomLevel())||Utils.isDefined(this.getMapCenter())||this.hadInitialPosition;if(this.getPropertyBounds()||this.getPropertyGridBounds()){this.hadInitialPosition=!0;let t=this.getPropertyBounds(this.getGridBounds("")).split(",");if(4==t.length){if(this.getProperty("showBounds",!1)){var l={};this.getProperty("boundsColor")&&(l.strokeColor=this.getProperty("boundsColor","")),this.map.addRectangle("bounds",parseFloat(t[0]),parseFloat(t[1]),parseFloat(t[2]),parseFloat(t[3]),l,"")}s||this.setInitMapBounds(parseFloat(t[0]),parseFloat(t[1]),parseFloat(t[2]),parseFloat(t[3]))}}if(this.getProperty("annotationLayer")){let t={theMap:this.map,embedded:!0,displayOnly:!0};this.getPropertyAnnotationLayerTop()&&(t.layerIndex=100),this.editableMap=new RamaddaEditablemapDisplay(this.getDisplayManager(),HU.getUniqueId(""),t),this.editableMap.initDisplay(!0),this.editableMap.loadMap(this.getProperty("annotationLayer"))}this.getProperty("extraLayers","").split(",").forEach((t=>{if(0==t.trim().length)return;let e=t.split(":");e=e.map((t=>t.replace(/_semicolon_/g,":")));let i=e[0];if("baselayer"==i){let t=this.map.getBaseLayer(e[1]);t?t.setVisibility(!0):console.log("Could not find base layer:"+e[1])}else if("geojson"==i||"kml"==i){let t=e[1],a=(t=>(t.startsWith("resources")?t=ramaddaBaseUrl+"/"+t:t.startsWith("/resources")?t=ramaddaBaseUrl+t:t.startsWith("/")||t.startsWith("http")||(t=ramaddaBaseUrl+"/entry/get?entryid="+t),t))(e[2]),s={fillColor:"transparent"};for(let t=3;t<e.length;t+=2)s[e[t]]=e[t+1];"kml"==i?this.map.addKmlLayer(t,a,!1,null,null,s,null):this.map.addGeoJsonLayer(t,a,!1,null,null,s,null)}else if("wms"==i){let t=e[1],i=e[2],a=e[3],s=e[4];this.map.addWMSLayer(t,i,a,!1,!0,{opacity:s})}else console.log("Unknown map type:"+i)})),this.getShowLayers()&&setTimeout((()=>{if(t.getProperty("kmlLayer")){var e=ramaddaBaseUrl+"/entry/show?output=shapefile.kml&entryid="+t.getProperty("kmlLayer");t.addBaseMapLayer(e,!0)}t.getProperty("geojsonLayer")&&(e=t.getRamadda().getEntryDownloadUrl(t.getProperty("geojsonLayer")),t.addBaseMapLayer(e,!1))}),500)},addBaseMapLayer:function(t,e){let i=this;if(mapLoadInfo=displayMapUrlToVectorListeners[t],null==mapLoadInfo){mapLoadInfo={otherMaps:[],layer:null};let a=function(t){i.mapFeatureSelected(t)};a=null;let s=null!=this.getProperty("bounds")||Utils.isDefined(this.getProperty("zoomLevel"))||Utils.isDefined(this.getProperty("mapCenter")),l={strokeColor:this.getProperty("vectorLayerStrokeColor","#000"),fillColor:this.getProperty("vectorLayerFillColor","#ccc"),fillOpacity:this.getProperty("vectorLayerFillOpacity",.25),strokeWidth:this.getProperty("vectorLayerStrokeWidth",1)};e?this.map.addKMLLayer(this.getProperty("kmlLayerName"),t,this.doDisplayMap(),a,null,l,(function(e,a){i.baseMapLoaded(a,t)}),!s):this.map.addGeoJsonLayer(this.getProperty("geojsonLayerName"),t,this.doDisplayMap(),a,null,l,(function(e,a){i.baseMapLoaded(a,t)}),!s)}else mapLoadInfo.layer?this.cloneLayer(mapLoadInfo.layer):(this.map.showLoadingImage(),mapLoadInfo.otherMaps.push(this))},baseMapLoaded:function(t,e){if(this.vectorLayer=t,this.applyVectorMap(),mapLoadInfo=displayMapUrlToVectorListeners[e],mapLoadInfo){mapLoadInfo.layer=t;for(var i=0;i<mapLoadInfo.otherMaps.length;i++)mapLoadInfo.otherMaps[i].cloneLayer(t);mapLoadInfo.otherMaps=[]}},applyVectorMap:function(t,e,i){},getBounds:function(){return this.map.getBounds()}})}function RamaddaMapDisplay(t,e,s){const l="map",r="latfield",o="lonfield",n="sizebylegend",h="shapes",d="heatmapanimlist",p="heatmapanimplay",g="heatmapanimstep",c="heatmaptoggle",u="regionselector",y="trackview";$.extend(this,{showBoxes:!0,showPercent:!1,percentFields:null,kmlLayer:null,kmlLayerName:"",geojsonLayer:null,geojsonLayerName:"",theMap:null});const m=new RamaddaBaseMapDisplay(t,e,DISPLAY_MAP,s);RamaddaUtil.inherit(this,m),addRamaddaDisplay(this),this.defineSizeByProperties();displayDefineMembers(this,[{label:"Map Properties"},{p:"strokeWidth",d:1},{p:"strokeColor",d:"#000"},{p:"fillColor",d:"blue"},{p:"fillOpacity",d:.5},{p:"radius",d:5,tt:"Size of the map points"},{p:"scaleRadius",ex:"true",tt:"Scale the radius based on # points shown"},{p:"radiusScale",ex:"value,size,value,size e.g.: 10000,1,8000,2,5000,3,2000,3,1000,5,500,6,250,8,100,10,50,12",tt:"Radius scale"},{p:"maxRadius",ex:"16",d:1e3},{p:"shape",d:"circle",ex:"plane|star|cross|x|square|triangle|circle|lightning|church",tt:"Use shape"},{p:"markerIcon",ex:"/icons/..."},{p:"iconSize",ex:16},{p:"justOneMarker",ex:"true",tt:"This is for data that is all at one point and you want to support selecting points for other displays"},{p:"showPoints",ex:"true",tt:"Also show the map points when showing heatmap or glyphs or vectors"},{p:"applyPointsToVectors",d:!0,tt:"If false then just show any attached map vectors without coloring them from the points"},{p:"bounds",ex:"north,west,south,east",tt:"initial bounds"},{p:"gridBounds",ex:"north,west,south,east"},{p:"mapCenter",ex:"lat,lon",tt:"initial position"},{p:"zoomLevel",ex:4,tt:"initial zoom"},{p:"zoomTimeout",ex:500,tt:"initial zoom timeout delay. set this if the map is in tabs, etc, and not going to the initial zoom"},{p:"fixedPosition",ex:!0,tt:"Keep the initial position"},{p:"linked",ex:!0,tt:"Link location with other maps"},{p:"linkGroup",ex:"some_name",tt:"Map groups to link with"},{p:"initialLocation",ex:"lat,lon",tt:"initial location"},{p:"defaultMapLayer",ex:"ol.openstreetmap|esri.topo|esri.street|esri.worldimagery|esri.lightgray|esri.physical|opentopo|usgs.topo|usgs.imagery|usgs.relief|osm.toner|osm.toner.lite|watercolor"},{p:"mapLayers",ex:"ol.openstreetmap,esri.topo,esri.street,esri.worldimagery,esri.lightgray,esri.physical,opentopo,usgs.topo,usgs.imagery,usgs.relief,osm.toner,osm.toner.lite,watercolor"},{p:"extraLayers",tt:"comma separated list of layers to display",ex:"baselayer:goes-visible,baselayer:nexrad,geojson:US States:/resources/usmap.json:fillColor:transparent"},{p:"doPopup",ex:"false",tt:"Don't show popups"},{p:"doPopupSlider",ex:"true",tt:"Do the inline popup that slides down"},{p:"popupSliderRight",ex:"true",tt:"Position the inline slider to the right"},{p:"popupSliderStyle",ex:"max-width:300px;overflow-x:auto;",tt:""},{p:"labelField",ex:"",tt:"field to show in TOC"},{p:"showRegionSelector",ex:!0},{p:"regionSelectorLabel"},{p:"centerOnFilterChange",ex:!0,tt:"Center map when the data filters change"},{p:"centerOnHighlight",ex:!0,tt:"Center map when a record is highlighted"},{p:"boundsAnimation",ex:!0,tt:"Animate when map is centered"},{p:"iconField",ex:'""',tt:"Field id for the image icon url"},{p:"rotateField",ex:'""',tt:"Field id for degrees rotation"},{label:"Map GUI"},{p:"showTableOfContents",ex:"true",tt:"Show left table of contents"},{p:"tableOfContentsTitle"},{p:"showMarkersToggle",ex:"true",tt:"Show the toggle checkbox for the marker layer"},{p:"showMarkersToggleLabel",ex:"label",tt:"Label to use for checkbox"},{p:"showClipToBounds",ex:"true",tt:"Show the clip bounds checkbox"},{p:"clipToBounds",ex:"true",tt:"Clip to bounds"},{p:"showMarkers",ex:"false",tt:"Hide the markers"},{label:"Map Highlight"},{p:"showRecordSelection",ex:"false"},{p:"highlight",ex:"true",tt:"Show mouse over highlights"},{p:"displayDiv",tt:"Div id to show highlights in"},{p:"recordHighlightShape",ex:"circle|star|cross|x|square|triangle|circle|lightning|rectangle"},{p:"recordHighlightRadius",ex:"20",tt:"Radius to use to show other displays highlighted record"},{p:"recordHighlightStrokeWidth",ex:"2",tt:"Stroke to use to show other displays highlighted record"},{p:"recordHighlightStrokeColor",ex:"red",tt:"Color to use to show other displays highlighted record"},{p:"recordHighlightFillColor",ex:"rgba(0,0,0,0)",tt:"Fill color to use to show other displays highlighted record"},{p:"recordHighlightFillOpacity",ex:"0.5",tt:"Fill opacity to use to show other displays highlighted record"},{p:"recordHighlightVerticalLine",tt:"Draw a vertical line at the location of the selected record"},{p:"highlightColor",ex:"#ccc",tt:""},{p:"highlightFillColor",ex:"#ccc",tt:""},{p:"highlightStrokeWidth",ex:"2",tt:""},{p:"unhighlightColor",ex:"#ccc",tt:"Fill color when records are unhighlighted with the filters"},{p:"unhighlightStrokeWidth",ex:"1",tt:"Stroke width for when records are unhighlighted with the filters"},{p:"unhighlightStrokeColor",ex:"#aaa",tt:"Stroke color for when records are unhighlighted with the filters"},{p:"unhighlightRadius",ex:"1",tt:"Radius for when records are highlighted with the filters"},{label:"Map Collisions"},{p:"handleCollisions",ex:"true",tt:"Handle point collisions"},{p:"collisionFixed",d:!1,ex:"false",tt:"Always show markers"},{p:"collisionMinPixels",d:16,ex:"16",tt:"How spread out"},{p:"collisionDotColor",ex:"red",tt:"Color of dot drawn at center"},{p:"collisionDotRadius",ex:"3",tt:"Radius of dot drawn at center"},{p:"collisionScaleDots",ex:"false",d:!0,tt:"Scale the group dots"},{p:"collisionLineColor",ex:"red",tt:"Color of line drawn at center"},{p:"collisionIcon",ex:"/icons/...",tt:"Use an icon for collisions"},{p:"collisionIconSize",d:16,ex:"16"},{p:"collisionTooltip",ex:"${default}",tt:"Tooltip to use for collision dot"},{label:"Map Lines"},{p:"showSegments",ex:"true",tt:"If data has 2 lat/lon locations draw a line"},{p:"isPath",ex:"true",tt:"Make a path from the points"},{p:"pathWidth",ex:"2"},{p:"pathColor",ex:"red"},{p:"isTrajectory",ex:"true",tt:"Make a path from the points"},{p:"showPathEndPoint",ex:!0},{p:"pathEndPointShape",ex:"arrow"},{p:"latField1",tt:"Field id for segments"},{p:"lonField1",tt:"Field id for segments"},{p:"latField2",tt:"Field id for segments"},{p:"lonField2",tt:"Field id for segments"},{p:"trackUrlField",ex:"field id",tt:"The data can contain a URL that points to data"},{label:"Map Labels"},{p:"labelTemplate",ex:"${field}",tt:"Display labels in the map"},{p:"labelKeyField",ex:"field",tt:"Make a key, e.g., A, B, C, ... based on the value of the key field"},{p:"labelLimit",ex:"1000",tt:"Max number of records to display labels"},{p:"doLabelGrid",ex:"true",tt:"Use a grid to determine if a label should be shown"},{p:"labelFontColor",ex:"#000"},{p:"labelFontSize",ex:"12px"},{p:"labelFontFamily",ex:"'Open Sans', Helvetica Neue, Arial, Helvetica, sans-serif"},{p:"labelFontWeight",ex:"plain"},{p:"labelAlign",ex:"l|c|r t|m|b"},{p:"labelXOffset",ex:"0"},{p:"labelYOffset",ex:"0"},{p:"labelOutlineColor",ex:"#fff"},{p:"labelOutlineWidth",ex:"0"},{label:"Map Glyphs"},{p:"doGridPoints",ex:"true",tt:"Display a image showing shapes or bars"},{p:"gridWidth",ex:"800",tt:"Width of the canvas"},{label:"label glyph",p:"glyph1",ex:"type:label,pos:sw,dx:10,dy:-10,label:field_colon_ ${field}_nl_field2_colon_ ${field2}"},{label:"rect glyph",p:"glyph1",ex:"type:rect,pos:sw,dx:10,dy:0,colorBy:field,width:150,height:100"},{label:"circle glyph",p:"glyph1",ex:"type:circle,pos:n,dx:10,dy:-10,fill:true,colorBy:field,width:20,baseWidth:5,sizeBy:field"},{label:"3dbar glyph",p:"glyph1",ex:"type:3dbar,pos:sw,dx:0,dy:0,height:30,width:6,baseHeight:5,sizeBy:field"},{label:"gauge glyph",p:"glyph1",ex:"type:gauge,color:#000,pos:sw,width:50,height:50,dx:10,dy:-10,sizeBy:field,sizeByMin:0"},{label:"Heatmap"},{p:"doHeatmap",ex:"true",tt:"Grid the data into an image"},{p:"hmShowPoints",ex:"true",tt:"Also show the map points"},{p:"hmShowReload",ex:"true",tt:""},{p:"hmShowGroups",ex:"true",tt:""},{p:"hmBounds",ex:"north,west,south,east",tt:""},{p:"htmlLayerField"},{p:"htmlLayerShape",ex:"barchart|piechart"},{p:"htmlLayerWidth",ex:"30"},{p:"htmlLayerHeight",ex:"15"},{p:"htmlLayerStyle",ex:"css style"},{p:"htmlLayerScale",ex:"2:0.75,3:1,4:2,5:3,6:4,7:6",tt:"zoomlevel:scale,..."},{p:"cellShape",ex:"rect|3dbar|circle|vector"},{p:"cellColor",ex:"color"},{p:"cellFilled",ex:!0},{p:"cellSize",ex:"8"},{p:"cellSizeH",ex:"20",tt:"Base value to scale by to get height"},{p:"cellSizeHBase",ex:"0",tt:"Extra height value"},{p:"angleBy",ex:"field",tt:"field for angle of vectors"},{p:"hmOperator",ex:"count|average|min|max"},{p:"hmAnimationSleep",ex:"1000"},{p:"hmReloadOnZoom",ex:"true"},{p:"reloadOnZoom",ex:"true"},{p:"hmGroupByDate",ex:"true|day|month|year|decade",tt:"Group heatmap images by date"},{p:"hmGroupBy",ex:"field id",tt:"Field to group heatmap images"},{p:"hmLabelPrefix"},{p:"hmShowToggle",ex:!0,tt:"Show the toggle checkbox to turn off/on the heatmap"},{p:"hmToggleLabel"},{p:"boundsScale",ex:"0.1",tt:"Scale up the map bounds"},{p:"hmFilter",ex:"average5|average9|average25|gauss9|gauss25",tt:"Apply filter to image"},{p:"hmFilterPasses",ex:"1"},{p:"hmFilterThreshold",ex:"1"},{p:"hmCountThreshold",ex:"1"}],{mapBoundsSet:!1,features:[],myMarkers:{},mapEntryInfos:{},tracks:{},checkFinished:function(){return!0},initDisplay:function(){m.initDisplay.call(this);let t=this.getProperty("sizeByLegendSide");if(t){let e=HU.div([ID,this.domId(n)]);"top"==t?this.jq(ID_TOP).append(e):"left"==t?this.jq(ID_LEFT).append(e):"right"==t?this.jq(ID_RIGHT).append(e):"bottom"==t?this.jq(ID_BOTTOM).append(e):console.log("Unknown legend side:"+t)}this.startProgress()},checkLayout:function(){if(this.map){var t=this.jq(l);if(t.width()>0&&this.lastWidth!=t.width()&&this.map&&(this.lastWidth=t.width(),this.map.getMap().updateSize()),!this.setMapLocationAndZoom&&this.mapParams&&(this.setMapLocationAndZoom=!0,this.mapParams.initialZoom>=0&&this.map.getMap().zoomTo(this.mapParams.initialZoom),this.mapParams.initialLocation)){let t=MapUtils.createLonLat(this.mapParams.initialLocation.lon,this.mapParams.initialLocation.lat);this.map.setCenter(t)}}},handlePopup:function(t,e){if(!this.trackUrlField)return;let i=()=>{if(t.record)if(this.tracks[t.record.getId()])this.removeTrack(t.record);else{let e=t.record.getValue(this.trackUrlField.getIndex());$.getJSON(e,(e=>{this.loadTrack(t.record,e)})).fail((t=>{console.log("url failed:"+e+"\n"+t)}))}};this.jq(y).click(i),this.jq("trackview_1").click(i)},macroHook:function(t,e,i){if(!this.trackUrlField)return null;if(e.tag!=this.trackUrlField.getId())return null;if(0==String(i).trim().length)return"";this.currentPopupRecord=t;let a=null!=this.tracks[t.getId()]?"Remove track":e.attrs.label||"View track";return SPACE+HU.span([CLASS,"ramadda-clickable",ID,this.domId(y)],a)},getRecordUrlHtml:function(t,e,i){if(this.currentPopupRecord=i,!this.trackUrlField||this.trackUrlField.getId()!=e.getId())return m.getRecordUrlHtml.call(this,t,e,i);i.getValue(e.getIndex());let a=null!=this.tracks[i.getId()]?"Remove track":t[e.getId()+".label"]||"View track";return HU.span([CLASS,"ramadda-clickable",ID,this.domId("trackview_1")],a)},removeTrack:function(t){this.tracks[t.getId()]&&(this.map.removePolygon(this.tracks[t.getId()]),this.tracks[t.getId()]=null),this.jq(y).html("View track"),this.jq("trackview_1").html("View track"),this.jq(ID_LEFT).find(HU.attrSelect(RECORD_ID,t.getId())).removeClass("display-map-toc-item-on")},loadTrack:function(t,e){let i=makePointData(e,null,this,""),a=RecordUtil.getPoints(i.getRecords(),{}),s=this.markers?this.markers[t.getId()]:null,l=this.jq(ID_LEFT).find(HU.attrSelect(RECORD_ID,t.getId()));t.trackData=i,l.addClass("display-map-toc-item-on");try{t.setLocation(a[0].y,a[0].x);let e=new OpenLayers.LonLat(a[0].x,a[0].y);e=this.map.transformLLPoint(e),s&&s.move(e)}catch(t){console.log(t)}let r={strokeColor:this.getStrokeColor("blue"),strokeWidth:this.getStrokeWidth(1),fillColor:this.getProperty("fillColor")||"transparent"},o=this.map.addPolygon("","",a,r);o.record=t,this.tracks[t.getId()]=o,o.geometry&&this.map.zoomToExtent(o.geometry.getBounds()),this.map.closePopup(),setTimeout((()=>{this.getDisplayManager().notifyEvent(DisplayEvent.dataSelection,this,{data:i})}),100)},applyToFeatureLayers:function(t){this.myFeatureLayer&&t(this.myFeatureLayer),this.myFeatureLayerNoSelect&&t(this.myFeatureLayerNoSelect)},addFeatures:function(t,e){this.myFeatureLayer||(this.myFeatureLayerNoSelect=this.map.createFeatureLayer("Features-2",!1),this.myFeatureLayer=this.map.createFeatureLayer("Map Features",!0),this.getProperty("showMarkersToggle")&&!this.getProperty("markersVisibility",!0)&&this.applyToFeatureLayers((t=>{t.setVisibility(!1)})),this.myFeatures=[]);let i=e?this.myFeatureLayerNoSelect:this.myFeatureLayer;i.addFeatures(t),t.forEach((t=>{t.layer=i,this.myFeatures.push(t)}))},removeFeature:function(t){t&&this.applyToFeatureLayers((e=>{e.removeFeatures([t])}))},removeFeatureLayer:function(){this.myFeatureLayer&&this.map.removeLayer(this.myFeatureLayer),this.myFeatureLayerNoSelect&&this.map.removeLayer(this.myFeatureLayerNoSelect),this.labelFeatures&&(this.map.labelLayer.removeFeatures(this.labelFeatures),this.labelFeatures=null,this.jq("legendid").html("")),this.myFeatureLayer=null,this.myFeatureLayerNoSelect=null,this.myFeatures=null},initMapParams:function(t){m.initMapParams.call(this,t),this.getDoPopupSlider()&&(t.doPopupSlider=!0,this.getPopupSliderRight()&&(t.popupSliderRight=!0))},initMap:function(t){this.getShowMarkers(this.getProperty("markersVisibility",!0))||t.getMarkersLayer().setVisibility(!1);let e=this.getProperty("boundsAnimation");if(e){this.didAnimationBounds=!1;let t=e.split(",");if(4==t.length){var i=parseFloat(this.getProperty("animationPause","1000"));HU.callWhenScrolled(this.domId(l),(()=>{if(!_this.didAnimationBounds){_this.didAnimationBounds=!0;var e=t,i=MapUtils.createBounds(parseFloat(e[1]),parseFloat(e[2]),parseFloat(e[3]),parseFloat(e[0]));_this.map.animateViewToBounds(i)}}),i)}}},createMap:function(){m.createMap.call(this);let t=this;this.getShowMarkers(this.getProperty("markersVisibility",!0))||this.map.getMarkersLayer().setVisibility(!1),this.doDisplayMap()&&this.map.setDefaultCanSelect(!1),this.map.initMap(!1),this.map.addRegionSelectorControl((function(e){t.propagateEvent(DisplayEvent.mapBoundsChanged,{bounds:e,force:!0})}),!0),this.map.popupHandler=(t,e)=>{this.handlePopup(t,e)},this.map.addFeatureSelectHandler((t=>{let e=!1;if(t.collisionInfo)t.collisionInfo.dotSelected(t);else{if(t.record&&(this.propagateEventRecordSelection({record:t.record}),this.propagateFilterFields(t.record),e=!0),t.record&&!this.map.doPopup&&this.getProperty("showRecordSelection",!0)&&(this.highlightPoint(t.record.getLatitude(),t.record.getLongitude(),!0,!1),e=!0),t.record&&this.getProperty("shareSelected")){let i=this.getFieldById(null,"id");i&&ramaddaDisplaySetSelectedEntry(t.record.getValue(i.getIndex()),this.getDisplayManager().getDisplays()),e=!0}e&&(this.lastFeatureSelectTime=new Date)}})),this.map.addFeatureHighlightHandler(((t,e)=>{if(t.record){if(this.lastHighlightedRecord){var i={highlight:!1,record:this.lastHighlightedRecord};this.getDisplayManager().notifyEvent(DisplayEvent.recordHighlight,this,i),this.getAnimationEnabled()&&this.getAnimation().handleEventRecordHighlight(this,i),this.lastHighlightedRecord=null}e&&(this.lastHighlightedRecord=t.record);i={highlight:e,record:t.record};this.getDisplayManager().notifyEvent(DisplayEvent.recordHighlight,this,i),this.getAnimationEnabled()&&this.getAnimation().handleEventRecordHighlight(this,i)}})),this.map.highlightBackgroundColor=this.getProperty("highlighBackgroundColor","#fff"),this.getProperty("addEntryMarkers")?this.map.doPopup=!0:this.map.doPopup=this.getProperty("doPopup",!0),this.map.addClickHandler(this.domId(o),this.domId(r),null,this),this.map.getMap().events.register("updatesize","",(()=>{this.callingUpdateSize||t.updateHtmlLayers()})),this.map.getMap().events.register("zoomend","",(()=>{if(t.mapBoundsChanged(),t.checkHeatmapReload(),t.updateHtmlLayers(),this.haveAddPoints&&this.getHandleCollisions()){if(this.lastZoom==this.map.getZoom())return;this.lastCollisionTimeout&&clearTimeout(this.lastCollisionTimeout),this.lastTimeout=setTimeout((()=>{this.haveCalledUpdateUI=!1,this.updateUI(),this.lastCollisionTimeout=null}),1e3)}})),this.createTime=new Date,this.map.getMap().events.register("moveend","",(()=>{t.map.doingPopup||(t.mapBoundsChanged(),t.checkHeatmapReload())}));var e=this.getProperty("boundsAnimation");if(e){this.didAnimationBounds=!1;let a=e.split(",");if(4==a.length){var i=parseFloat(this.getProperty("animationPause","1000"));HU.callWhenScrolled(this.domId(l),(()=>{if(!t.didAnimationBounds){t.didAnimationBounds=!0;var e=a,i=MapUtils.createBounds(parseFloat(e[1]),parseFloat(e[2]),parseFloat(e[3]),parseFloat(e[0]));t.map.animateViewToBounds(i)}}),i)}}let a=this.features;this.features=[];for(var s=0;s<a.length;s++)this.addFeature(a[s]);if(this.getProperty("displayEntries",!0)){let t=this.getDisplayManager().collectEntries();for(let e=0;e<t.length;e++){let i=t[e];this.handleEventEntriesChanged(i.source,i.entries)}}if(this.getProperty("addEntryMarkers")&&this.getDisplayEntry((t=>{t?t.getChildrenEntries((t=>{t.forEach((t=>{if(!t.hasLocation())return;let e=new MapUtils.createLonLat(t.getWest(),t.getNorth()),i="<b>"+t.getName()+"</b>";t.isImage()&&(i+="<br>"+HU.image(t.getImageUrl(),["width","200px"])),this.map.addMarker(t.getId(),e,t.getIconUrl(),"",i,null,16)}))})):console.log("failed to get entry")})),this.layerEntries){var n=function(e){t.handleLayerSelect(e)},h=function(e){t.handleLayerUnselect(e)},d=this.layerEntries.split(",");for(s=0;s<d.length;s++){var p=d[s],g=ramaddaBaseUrl+"/entry/show?output=shapefile.kml&entryid="+p;this.map.addKMLLayer("layer",g,!0,n,h)}}for(var c=1;;c++){let t=this.getProperty("marker"+c);if(!t)break;let e={};if(t.startsWith("base64:")&&(t=window.atob(t.substring(7))),0==t.indexOf("{"))e=JSON.parse(t);else{let[i,a,s]=t.split(",");e.lat=i,e.lon=a,e.text=s}let i=new OpenLayers.LonLat(parseFloat(e.lon),parseFloat(e.lat));null!=e.size&&""!=e.size||(e.size=16);let a=e.type||"icon",s=e;if(s.pointRadius=e.size||"16",s.labelYOffset=-8-s.pointRadius,"icon"==a){let t=e.icon||"/markers/marker-red.png";this.map.addMarker("",i,t,e.description,e.description,"",parseFloat(e.size||"16"),null,!0,s)}else s.fillColor=s.fillColor||"blue",s.strokeWidth=s.strokeWidth||"1",s.graphicName=a,"none"==a&&(s.graphicName="circle",s.pointRadius=0,s.fillColor="transparent"),this.map.addPoint("",i,s,e.description),"circle"!=s.graphicName&&this.map.addPoint("",i,{pointRadius:s.pointRadius,strokeColor:"transparent",fillColor:"transparent"},e.description);this.map.doPopup=!0}},getBounds:function(){return this.map.getBounds()},mapFeatureSelected:function(t){this.getPointData()&&(this.map.onFeatureSelect(t),Utils.isDefined(t.feature.record)&&this.propagateEventRecordSelection({record:t.feature.record}))},showVectorLayer:!0,toggleVectorLayer:function(){this.showVectorLayer=!this.showVectorLayer,null!=this.vectorLayer&&this.vectorLayer.setVisibility(this.showVectorLayer),this.haveCalledUpdateUI=!1,this.updateUI()},doDisplayMap:function(){return!!this.getShowLayers()&&(!!this.getProperty("displayAsMap",!0)&&((this.getProperty("kmlLayer")||this.getProperty("geojsonLayer"))&&this.getShowLayers()?this.showVectorLayer:void 0))},cloneLayer:function(t){let e=this;this.map.hideLoadingImage();for(var i=(t=t.clone()).features,a=[],s=0;s<i.length;s++){if(feature=i[s],feature=feature.clone(),feature.style)for(var l in oldStyle=feature.style,feature.style={},oldStyle)feature.style[l]=oldStyle[l];feature.layer=t,a.push(feature)}t.removeAllFeatures(),this.map.getMap().addLayer(t),t.addFeatures(a),this.vectorLayer=t,this.applyVectorMap(),this.map.addSelectCallback(t,this.doDisplayMap(),(function(t){e.mapFeatureSelected(t)}))},handleEventPointDataLoaded:function(t,e){},handleEventFieldsSelected:function(t,e){this.getProperty("selectedFieldIsColorBy")&&e.length>0&&this.colorByFieldChanged(e[0])},handleLayerSelect:function(t){var e=this.layerSelectArgs;if(!this.layerSelectPath){if(!e)return void this.map.onFeatureSelect(t);this.layerSelectPath="/search/do"}var i=ramaddaBaseUrl+this.layerSelectPath;if(e)for(var a=e.split(","),s=0;s<a.length;s++){var l=a[s].split(":"),r=l[0],o=l[1],n=t.feature.attributes;for(var h in n){if(""+h==o){var d=null;if("object"==typeof n[h]||"Object"==typeof n[h])d=n[h].value;else d=n[h];i=(i=HU.appendArg(i,r,d)).replace("${"+r+"}",d)}}}i=HU.appendArg(i,"output","json"),new EntryList(this.getRamadda(),i,null,!1).doSearch(this),this.getEntryList().showMessage("Searching",HU.div([ATTR_STYLE,HU.css("margin","20px")],this.getWaitImage()))},getEntryList:function(){if(!this.entryListDisplay){var t=this.getUniqueId("display");this.entryListDisplay=new RamaddaEntrylistDisplay(this.getDisplayManager(),t,{showMenu:!0,showTitle:!0,showDetails:!0,layoutHere:!1,showForm:!1,doSearch:!1}),this.getDisplayManager().addDisplay(this.entryListDisplay)}return this.entryListDisplay},entryListChanged:function(t){t.getEntries();this.getEntryList().entryListChanged(t)},handleLayerUnselect:function(t){this.map.onFeatureUnselect(t)},addMapLayer:function(t,e){var i=this,a=e.entry;if(this.addedLayers||(this.addedLayers={}),this.addedLayers[a.getId()]){(o=this.addedLayers[a.getId()])&&(this.map.removeKMLLayer(o),this.addedLayers[a.getId()]=null)}else{var s=a.getType().getId();if("geo_shapefile"!=s&&"geo_geojson"!=s){var l=a.getAttributeValue("base_url");if(Utils.stringDefined(l))null==(o=a.getAttributeValue("layer_name"))&&(o=a.getName()),this.map.addWMSLayer(a.getName(),l,o,!1);else console.log("No base url:"+a.getId())}else{var r=MapUtils.createBounds(a.getWest(),a.getSouth(),a.getEast(),a.getNorth());(r.left<-180||r.right>180||r.bottom<-90||r.top>90)&&(r=null);var o,n=function(t){i.handleLayerSelect(t)},h=function(t){i.handleLayerUnselect(t)};if("geo_geojson"==s){var d=a.getRamadda().getEntryDownloadUrl(a);o=this.map.addGeoJsonLayer(this.getProperty("geojsonLayerName"),d,this.doDisplayMap(),n,h,null,null,!0)}else{d=ramaddaBaseUrl+"/entry/show?output=shapefile.kml&entryid="+a.getId();o=this.map.addKMLLayer(a.getName(),d,!0,n,h,null,null,!0)}this.addedLayers[a.getId()]=o}}},mapBoundsChanged:function(){let t=this.map.getMap().calculateBounds().transform(this.map.sourceProjection,this.map.displayProjection);if(this.propagateEvent(DisplayEvent.mapBoundsChanged,{bounds:t,force:!1}),(this.clipToView||this.getClipToBounds())&&this.lastUpdateTime){(new Date).getTime()-this.lastUpdateTime.getTime()>1e3&&(this.haveCalledUpdateUI=!1,this.clipBounds=!0,this.updatingFromClip=!0,this.updateUI())}},addFeature:function(t){this.features.push(t),t.line=this.map.addPolygon("lines_"+t.source.getId(),RecordUtil.clonePoints(t.points),null)},getContentsDiv:function(){return HU.div([ATTR_CLASS,"display-inner-contents",ID,this.domId(ID_DISPLAY_CONTENTS)],"")},removeHighlight:function(){this.highlightMarker&&this.removeFeature(this.highlightMarker)},highlightPoint:function(t,a,s,l){if(this.map&&(this.removeHighlight(),s)){var r=new OpenLayers.LonLat(a,t),o={pointRadius:parseFloat(this.getProperty("recordHighlightRadius",+this.getPropertyRadius(6)+8)),stroke:!0,strokeColor:this.getProperty("recordHighlightStrokeColor","#000"),strokeWidth:parseFloat(this.getProperty("recordHighlightStrokeWidth",2)),fillColor:this.getProperty("recordHighlightFillColor","#ccc"),fillOpacity:parseFloat(this.getProperty("recordHighlightFillOpacity",.5))};if(this.getProperty("recordHighlightUseMarker",!1)){var n=+this.getProperty("recordHighlightRadius",+this.getRadius(24));this.highlightMarker=this.map.createMarker("pt-"+i,r,null,"pt-"+i,null,null,n)}else if(this.getProperty("recordHighlightVerticalLine",!1)){let t=[];t.push(new OpenLayers.Geometry.Point(a,0)),t.push(new OpenLayers.Geometry.Point(a,80)),this.highlightMarker=this.map.createPolygon(e,"highlight",t,o,null)}else o.graphicName=this.getProperty("recordHighlightShape"),this.highlightMarker=this.map.createPoint("highlight",r,o);this.highlightMarker&&this.addFeatures([this.highlightMarker]),l&&this.getProperty("centerOnHighlight",!1)&&this.map.setCenter(r)}},handleEventEntryMouseover:function(t,i){this.map&&(e=i.entry.getId()+"_mouseover",attrs={lineColor:"red",fillColor:"red",fillOpacity:.5,lineOpacity:.5,doCircle:!0,lineWidth:1,fill:!0,circle:{lineColor:"black"},polygon:{lineWidth:4}},this.addOrRemoveEntryMarker(e,i.entry,!0,attrs))},handleEventEntryMouseout:function(t,i){this.map&&(e=i.entry.getId()+"_mouseover",this.addOrRemoveEntryMarker(e,i.entry,!1))},handleEventAreaClear:function(){this.map&&this.map.clearRegionSelector()},propagateFilterFields:function(t){this.getFieldsByIds(null,this.getProperty("filterFieldsToPropagate")).map((e=>{let i={fieldId:e.getId(),value:t.getValue(e.getIndex())};this.propagateEvent(DisplayEvent.filterChanged,i)}))},handleClick:function(t,e,i,a){let s=!1;if(this.lastFeatureSelectTime){let t=(new Date).getTime()-this.lastFeatureSelectTime.getTime();if(this.lastFeatureSelectTime=null,t<1e3)return void 0}if(e.shiftKey){if(Utils.isAnonymous())return;let t=prompt("Marker text","");if(!t)return;let e=ramaddaBaseUrl+"/metadata/addform?entryid="+this.getProperty("entryId")+"&metadata_type=map_marker&metadata_attr1="+encodeURIComponent(t)+"&metadata_attr2="+a+","+i;return void(window.location=e)}if(!this.map)return void 0;if(this.doDisplayMap())return void 0;if(this.getJustOneMarker(!1)){s;let t=this.getPointData();t&&(t.handleEventMapClick(this,this,i,a),this.getDisplayManager().notifyEvent("mapClick",this,{lat:a,lon:i}))}if(!this.records)return void 0;let l=RecordUtil.findClosest(this.records,i,a,[]);l&&(this.propagateEventRecordSelection({record:l}),this.highlightMarker&&this.highlightPoint(l.getLatitude(),l.getLongitude(),!0,!1),this.propagateFilterFields(l))},getPosition:function(){var t=$("#"+this.domId(r)).val(),e=$("#"+this.domId(o)).val();return null==t?null:[t,e]},haveInitBounds:!1,setInitMapBounds:function(t,e,i,a){this.map&&(this.haveInitBounds||(this.haveInitBounds=!0,this.map.centerOnMarkers(new OpenLayers.Bounds(e,i,a,t),!0)))},sourceToEntries:{},handleEventEntriesChanged:function(t,e){if(this.map&&(t==this.lastSource&&this.map.clearSelectionMarker(),void 0===t.forMap||t.forMap)){var i=this.sourceToEntries[t.getId()];if(null!=i)for(var a=0;a<i.length;a++){var s=t.getId()+"_"+i[a].getId();this.addOrRemoveEntryMarker(s,i[a],!1)}this.sourceToEntries[t.getId()]=e;new OpenLayers.Layer.Markers("Markers"),new OpenLayers.Layer.Vector("Lines",{});var l=-90,r=180,o=90,n=-180,h=!1;for(a=0;a<e.length;a++){var d=e[a];s=t.getId()+"_"+d.getId(),this.addOrRemoveEntryMarker(s,e[a],!0);if(d.hasBounds()){if(d.getNorth()>90||d.getSouth()<-90||d.getEast()>180||d.getWest()<-180){console.log("bad bounds on entry:"+d.getName()+" "+d.getNorth()+" "+d.getSouth()+" "+d.getEast()+" "+d.getWest());continue}l=Math.max(l,d.getNorth()),o=Math.min(o,d.getSouth()),n=Math.max(n,d.getEast()),r=Math.min(r,d.getWest()),h=!0}}h&&MapUtils.createBounds(r,o,n,l)}},handleEventEntrySelection:function(t,e){if(this.map){var i=e.entry;if(null!=i){e.selected;i.hasLocation()}else this.map.clearSelectionMarker()}},addOrRemoveEntryMarker:function(t,e,i,a){a||(a={});var s={lineColor:e.lineColor,fillColor:e.lineColor,lineWidth:e.lineWidth,doCircle:!1,doRectangle:this.showBoxes,fill:!1,fillOpacity:.75,pointRadius:12,polygon:{},circle:{}};dfltPolygon={},dfltCircle={},$.extend(s,a),s.lineColor||(s.lineColor="blue"),$.extend(dfltPolygon,s),a.polygon&&$.extend(dfltPolygon,a.polygon),$.extend(dfltCircle,s),a.circle&&$.extend(dfltCircle,a.circle);var l=this.mapEntryInfos[t];if(i){if(null==l){if(l=new MapEntryInfo(e),this.mapEntryInfos[t]=l,e.hasBounds()&&s.doRectangle){var r={};l.rectangle=this.map.addRectangle(t,e.getNorth(),e.getWest(),e.getSouth(),e.getEast(),r)}var o=e.getLatitude(),n=e.getLongitude();if(o<-90||o>90||n<-180||n>180)return;var h=new OpenLayers.LonLat(n,o);if(s.doCircle?(r={pointRadius:dfltCircle.pointRadius,stroke:!0,strokeColor:dfltCircle.lineColor,strokeWidth:dfltCircle.lineWidth,fillColor:dfltCircle.fillColor,fillOpacity:dfltCircle.fillOpacity,fill:dfltCircle.fill},l.circle=this.map.addPoint(t,h,r)):l.marker=this.map.addMarker(t,h,e.getIconUrl(),"",this.getEntryHtml(e)),e.polygon){for(var d=[],p=0;p<e.polygon.length;p+=2)d.push(new OpenLayers.Geometry.Point(e.polygon[p+1],e.polygon[p]));r={strokeColor:dfltPolygon.lineColor,strokeWidth:Utils.isDefined(dfltPolygon.lineWidth)?dfltPolygon.lineWidth:2};l.polygon=this.map.addPolygon(t,e.getName(),d,r,l.marker)}var g=this;l.marker&&(l.marker.entry=e,l.marker.ramaddaClickHandler=function(t){g.handleMapClick(t)},null==this.handledMarkers&&(this.map.centerToMarkers(),this.handledMarkers=!0))}return l}null!=l&&(l.removeFromMap(this.map),this.mapEntryInfos[t]=null)},handleMapClick:function(t){null!=this.selectedMarker&&this.getDisplayManager().handleEventEntrySelection(this,{entry:this.selectedMarker.entry,selected:!1}),this.getDisplayManager().handleEventEntrySelection(this,{entry:t.entry,selected:!0}),this.selectedMarker=t},applyVectorMap:function(t,e,i){if(!t&&this.vectorMapApplied)return;let a=this.myPoints||this.myFeatures;if(!this.doDisplayMap()||!this.vectorLayer||!a)return;if(!this.getApplyPointsToVectors())return;i||(i={});e||(e=this.textGetter);let s=this.getFieldById(null,this.getProperty("linkField")),l=this.getProperty("linkFeature"),r=this.vectorLayer.features.slice(),o=r.slice(),n={};if(a.forEach((t=>{let e=t.record;if(!e)return;let i=e.getDisplayProperty(this,"feature");i&&(n[e.getId()]=i)})),l&&s){l=l.toLowerCase();let t={};a.forEach((e=>{let i=e.record;if(i){let e=i.getData()[s.getIndex()];e=e.toString().trim(),i.linkValue=e,t[e]=i}})),r.forEach(((e,i)=>{let a=e.attributes,s=!1;for(let i in a){let r=String(i).toLowerCase();if(l==r){s=!0;let l=this.map.getAttrValue(a,i),r=!1;l?(r&&console.log("\tbefore"),l=l.toString().trim(),e.linkValue=l,record=t[l],record?(r&&console.log("\tAdding:"+l+": "+record.getId()),n[record.getId()]=e):r&&console.log("\tCould not find record:"+l.replace(/ /g,"X")+":"),r&&console.log("\tAFter")):console.log("no attr value")}}s||console.log("No ATTR found")}))}let h=0;r.forEach(((t,e)=>{t.wasPruned=t.pruned,t.pruned=!1,t.newStyle=null,t.style&&(t.style.display="inline-block"),t.featureIndex=h++,t.featureMatched=!1,t.pointCount=0,t.circles=[],t.style&&(t.style.balloonStyle=null)})),this.vectorMapApplied=!0;let d=null,p=this.getProperty("colorByCount",!1),g=[],c={},u=-1,y=-1;if(a.forEach(((t,i)=>{if(t.style&&"none"==t.style.display)return;let a=t.record,s=t.center,l={index:-1,maxExtent:d},o=n[a.getId()];o?(o.featureMatched=!0,o.geometry&&(null===d&&(d=new OpenLayers.Bounds),d.extend(o.geometry.getBounds()))):o=this.findContainingFeature(r,s,l,!1),o&&(a.setDisplayProperty(this,"feature",o),!t.colorByColor&&t.hasColorByValue&&isNaN(t.colorByValue)||(d=l.maxExtent,c[o.featureIndex]||(c[o.featureIndex]=!0,g.push(o)),o.circles.push(t),o.record=a,o.textGetter=e,p?(o.pointCount++,u=-1==u?o.pointCount:Math.max(u,o.pointCount),y=-1==y?o.pointCount:Math.min(y,o.pointCount)):l.index>=0&&r.splice(l.index,1)))})),!p)for(let t=0;t<g.length;t++){let e=g[t];style=e.style,style||(style={stylename:"from display"}),style.display=null;let i={};$.extend(i,style);let a=e.circles[0];$.extend(i,a.style),e.newStyle=i,e.popupText=a.text,e.dataIndex=t}let m=this.getProperty("pruneFeatures",!1);if(p){let t=this.getColorTable(!0);null==t&&(t=Utils.ColorTables.grayscale.colors);let e=u-y,i=this.getProperty("doCountLabel","points");for(let a=0;a<r.length;a++){let s=r[a],l=0==e?0:(s.pointCount-y)/e,o=parseInt(l*t.length);o>=t.length?o=t.length-1:o<0&&(o=0);let n=t[o],h=s.style;h||(h={stylename:"from display"});let d={};$.extend(d,h),$.extend(d,{fillColor:n,fillOpacity:.75,strokeWidth:1}),0==s.pointCount&&!0===m&&(d.display="none"),s.newStyle=d,s.dataIndex=a,s.popupText=HU.div([],s.pointCount+SPACE+i)}this.displayColorTable(t,ID_COLORTABLE,y,u,{})}else if(m)for(let t=0;t<r.length;t++){let e=r[t];if(e.featureMatched)continue;let i=e.style;i||(i={stylename:"from display"});let a={};$.extend(a,i),a.display="none",e.pruned=!0,e.newStyle=a}o.forEach(((t,e)=>{t.newStyle||(t.newStyle={}),(t.wasPruned&&!t.pruned||!t.style||t.newStyle.display&&"none"==t.newStyle.display&&t.newStyle.display!=t.style.display||t.style.fillColor!=t.newStyle.fillColor)&&(t.style=t.newStyle,t.style.fillColor||(t.style.fillColor="rgba(230,230,230,0.5)",t.style.strokeColor="rgba(200,200,200,0.5)",t.style.strokeWidth=1),this.vectorLayer.drawFeature(t)),t.newStyle=null})),!i.dontSetBounds&&d&&!this.hadInitialPosition&&this.getCenterOnFilterChange(!0)&&this.map.zoomToExtent(d,!0),this.getProperty("fixedPosition",!1)||(this.hadInitialPosition=!1)},findContainingFeature:function(t,e,i,a){let s=null;for(let l=0;l<t.length;l++){let r=t[l],o=r.geometry;if(o){if(bounds=o.getBounds(),bounds.contains(e.x,e.y)){if(a&&console.log("\tfindContainingFeature:"+e.x+" "+e.y),o.components&&(a&&console.log("\thas components:"+o.components.length),o.components.every((t=>(bounds=t.getBounds(),bounds.contains(e.x,e.y)?t.containsPoint?(a&&console.log("\t\tcontains:"+t.containsPoint(e)),!t.containsPoint(e)||(s=r,r.geometry&&(null===i.maxExtent&&(i.maxExtent=new OpenLayers.Bounds),i.maxExtent.extend(r.geometry.getBounds())),i.index=l,!1)):(a&&console.log("\t\tunknown geometry:"+t.CLASS_NAME),!0):(a&&console.log("\t\tnot contain:"+bounds+" "+t.CLASS_NAME),!0))))),s)return s;if(o.containsPoint){if(o.containsPoint(e)){null===i.maxExtent&&(i.maxExtent=new OpenLayers.Bounds),i.maxExtent.extend(o.getBounds()),s=r,i.index=l;break}}else a&&!o.components&&console.log("unknown geometry:"+o.CLASS_NAME)}}else a&&console.log("\tno geometry")}return s},needsData:function(){return!0},animationStart:function(t){if(this.myFeatures)for(let t=0;t<this.myFeatures.length;t++){this.myFeatures[t].style.display="none"}this.map.circles&&this.map.circles.redraw()},handleDateRangeChanged:function(t,e){this.getAnimation().setDateRange(e.minDate,e.maxDate),this.applyDateRange()},animationApply:function(t){m.animationApply.call(this,t,!0),this.applyDateRange()},applyDateRange:function(){let t=this.getAnimation(),e=t.begin.getTime(),i=t.end.getTime(),a={};if(this.myFeatures)for(let t=0;t<this.myFeatures.length;t++){let s=this.myFeatures[t];if(s.date<e||s.date>i)s.style.display="none";else if(a[s.location]){let t=a[s.location];t.date<s.date?(a[s.location]=s,t.style.display="none",s.style.display="inline"):s.style.display="none"}else a[s.location]=s,s.style.display="inline"}this.applyToFeatureLayers((t=>{t.redraw()})),this.applyVectorMap(!0,this.textGetter)},showAllPoints:function(){if(this.myFeatures){for(let t=0;t<this.myFeatures.length;t++){this.myFeatures[t].style.display="inline"}this.map.lines&&this.map.lines.redraw()}this.applyToFeatureLayers((t=>{t.redraw()})),this.applyVectorMap(!0)},colorByFieldChanged:function(t){this.haveCalledUpdateUI=!1,this.setProperty("colorBy",t),this.vectorMapApplied=!1,this.updateUI({fieldChanged:!0})},sizeByFieldChanged:function(t){this.haveCalledUpdateUI=!1,this.setProperty("sizeBy",t),this.vectorMapApplied=!1,this.updateUI({fieldChanged:!0})},dataFilterChanged:function(t){t||(t={}),this.vectorMapApplied=!1,this.updateUI({source:t.source,dataFilterChanged:!0,dontSetBounds:!0,reload:!0,callback:()=>{"animation"!=t.source&&this.getCenterOnFilterChange(!1)&&(this.vectorLayer&&this.showVectorLayer?this.map.zoomToLayer(this.vectorLayer,1.2):this.lastImageLayer?this.map.zoomToLayer(this.lastImageLayer):this.map.centerOnMarkers(null,!1,!0))}})},requiresGeoLocation:function(){return!this.shapesField||!this.shapesTypeField},addFilters:function(t){m.addFilters.call(this,t),this.getProperty("showBoundsFilter")&&t.push(new BoundsFilter(this))},getHeader2:function(){let t=m.getHeader2.call(this);if(this.getProperty("showClipToBounds")&&(this.clipToView=!1,t=HU.div([STYLE,HU.css("display","inline-block","cursor","pointer","padding","1px","border","1px solid rgba(0,0,0,0)"),TITLE,"Clip to view",ID,this.domId("clip")],HU.getIconImage("fa-map"))+SPACE2+t),this.getProperty("showMarkersToggle")){let e=this.getProperty("markersVisibility",!0);t+=HU.checkbox(this.domId("showMarkersToggle"),[ID,this.domId("showMarkersToggle")],e,this.getProperty("showMarkersToggleLabel","Show Markers"))+SPACE2}if(this.getShowBaseLayersSelect()&&this.map.baseLayers){let e=[],i=!1;for(a in this.map.baseLayers){let t=this.map.baseLayers[a];t.isBaseLayer&&(t.getVisibility()&&(i=a),e.push([a,t.name]))}t+=HU.span([TITLE,"Choose base layer",CLASS,"display-filter"],HU.select("",[ID,this.domId("baselayers")],e,i))}return this.getProperty("showVectorLayerToggle",!1)&&(t+=HU.checkbox("",[ID,this.domId("showVectorLayerToggle")],!this.showVectorLayer)+" "+this.getProperty("showVectorLayerToggleLabel","Show Points")+SPACE4),t+=HU.span([ID,this.domId("locations")]),t},locationMenuCnt:0,addLocationMenu:function(t,e){let i="",a=this.locationMenuCnt++,s=e.label||e.name;s||(s=Utils.makeLabel(t.replace(/^.*[\\\/]/,"").replace(/\.[^\.]+$/,"").replace("_"," "))),i+=HU.div([CLASS,"ramadda-menu-button ramadda-clickable bold",ID,this.domId("location_"+a)],"View "+s)+SPACE,this.map.appendToolbar(i);let l=this;this.jq("location_"+a).click((function(){let t="",i=[];e.features?e.features.forEach((t=>{let e=t.properties.NAME||t.properties.name;i.push({name:e,geometry:t.geometry})})):i=e.locations,i.sort(((t,e)=>t.name.localeCompare(e.name))),i.forEach(((e,i)=>{Utils.isDefined(e.latitude)?t+=HU.div([CLASS,"ramadda-clickable ramadda-hoverable","latitude",e.latitude,"longitude",e.longitude,CLASS,"display-map-location"],e.name):Utils.isDefined(e.north)?t+=HU.div([CLASS,"ramadda-clickable ramadda-hoverable","north",e.north,"west",e.west,"south",e.south,"east",e.east,CLASS,"display-map-location"],e.name):Utils.isDefined(e.geometry)&&(t+=HU.div([CLASS,"ramadda-clickable ramadda-hoverable","index",i,CLASS,"display-map-location"],e.name))})),t=HU.div([ID,l.domId("locationmenu"),STYLE,HU.css("max-height","200px","overflow-y","auto","padding","5px")],t);let a=HU.makeDialog({content:t,my:"left top",at:"left bottom",anchor:$(this),draggable:!1,header:!1});l.jq("locationmenu").find(".ramadda-clickable").click((function(){if(l.locationFeatures&&l.locationFeatures.forEach((t=>{l.map.getHighlightLinesLayer().removeFeatures([t])})),l.locationFeatures=[],$(this).attr("longitude")){let t=MapUtils.createLonLat(+$(this).attr("longitude"),+$(this).attr("latitude"));l.map.getMap().zoomTo(9),l.map.setCenter(t)}else if($(this).attr("north"))l.map.setViewToBounds(new RamaddaBounds(+$(this).attr("north"),+$(this).attr("west"),+$(this).attr("south"),+$(this).attr("east")));else{let t=i[$(this).attr("index")].geometry,e=t.type,a=t.coordinates,s={strokeColor:"blue",fillColor:"rgba(0,0,255,0.10)",strokeWidth:2};if("MultiPolygon"==e)for(let t=0;t<a.length;t++){let e=a[t];for(let t=0;t<e.length;t++)l.locationFeatures.push(l.createFeature(e[t],null,null,s))}else if("Polygon"==e)for(let t=0;t<a.length;t++)l.locationFeatures.push(l.createFeature(a[t],null,null,s));else console.log("Unknown geometry:"+e);l.map.centerOnFeatures(l.locationFeatures)}a.remove()}))}))},initHeader2:function(){let t=this;this.jq("baselayers").change((function(){let e=$(this).val();for(let i in t.map.baseLayers)if(i==e){t.map.getMap().setBaseLayer(t.map.baseLayers[i]);break}})),this.getProperty("locations","").split(",").forEach((t=>{if(0==(t=t.trim()).length)return;t.startsWith("/")||t.startsWith("http")||(t=ramaddaCdn+"/resources/"+t);Utils.doFetch(t,(e=>{e=JSON.parse(e),this.addLocationMenu(t,e)}),(e=>{console.log("Error loading location json:"+t+"\n"+e)}),null)})),this.jq("showMarkersToggle").change((function(){let e=$(this).is(":checked");t.applyToFeatureLayers((t=>{t.setVisibility(e)}))})),this.jq("showVectorLayerToggle").change((function(){t.toggleVectorLayer()})),this.jq("clip").click((function(e){t.clipToView=!t.clipToView,t.clipToView?$(this).css("border","1px solid #aaa"):$(this).css("border","1px solid rgba(0,0,0,0)"),t.haveCalledUpdateUI=!1,t.updateUI()}))},handleNoData:function(t,e){this.jq(ID_PAGE_COUNT).html(""),this.addPoints([],[],[]),this.setMessage(this.getNoDataMessage())},createFeature:function(t,e,i,a){a||(this.baseStyle&&(this.baseStyle=OpenLayers.Util.extend({},OpenLayers.Feature.Vector.style.default),$.extend(this.baseStyle,{strokeColor:this.getProperty("vectorLayerStrokeColor","#000"),fillColor:this.getProperty("vectorLayerFillColor","#ccc"),fillOpacity:this.getProperty("vectorLayerFillOpacity",.1),strokeWidth:this.getProperty("vectorLayerStrokeWidth",1),cursor:"pointer"})),a=this.baseStyle);let s=[];t.forEach((t=>{let e=new OpenLayers.Geometry.Point(t[0],t[1]),i=this.map.transformLLPoint(e);s.push(i)}));let l=new OpenLayers.Geometry.LinearRing(s),r=new OpenLayers.Geometry.Polygon([l]),o=new OpenLayers.Feature.Vector(r,null,a);return this.map.getHighlightLinesLayer().addFeatures([o]),o.record=e,o.textGetter=i,o},loadShapes:function(t){this.coordinateFeatures&&this.map.getHighlightLinesLayer().removeFeatures(this.coordinateFeatures);let e=t=>t.record?this.getRecordHtml(t.record,null,this.getProperty("tooltip")):"NONE";this.coordinateFeatures=[],t.forEach(((t,i)=>{let a=t.getValue(this.shapesTypeField.getIndex()),s=t.getValue(this.shapesField.getIndex()),l=JSON.parse(s);if("MultiPolygon"==a)for(let i=0;i<l.length;i++){let a=l[i];for(let i=0;i<a.length;i++)this.coordinateFeatures.push(this.createFeature(a[i],t,e))}else if("Polygon"==a)for(let i=0;i<l.length;i++)this.coordinateFeatures.push(this.createFeature(l[i],t,e));else console.log("Unknown geometry:"+a)}))},toggleTrack:function(t,e){this.markers&&this.markers[t.getId()];if(this.tracks[t.getId()])e&&e.removeClass("display-map-toc-item-on"),this.map.removePolygon(this.tracks[t.getId()]),this.tracks[t.getId()]=null,e&&e.attr(TITLE,"Click to view; Double-click to view track");else{e&&(e.addClass("display-map-toc-item-on"),e.attr(TITLE,"Click to view; Double-click to remove track"));let i=t.getValue(this.trackUrlField.getIndex());""!=i&&$.getJSON(i,(e=>{this.loadTrack(t,e)})).fail((t=>{console.log("url failed:"+i+"\n"+t)}))}this.map.setCenter(new OpenLayers.LonLat(t.getLongitude(),t.getLatitude()))},makeToc:function(t){let e=this.getFieldById(null,this.getProperty("labelField","name"));if(e||(e=this.getFieldByType(null,"string")),e){let i="",a=this.getFieldById(null,this.getProperty("iconField"));t.forEach(((t,s)=>{let l="View record";this.trackUrlField&&(l="Click to view; Double-click to view track");let r="ramadda-clickable  display-map-toc-item ramadda-noselect",o=e.getValue(t);a?o=HU.getIconImage(a.getValue(t,icon_blank16),["width",16])+SPACE+o:r+=" ramadda-nav-list-link ",i+=HU.span([TITLE,l,CLASS,r,RECORD_ID,t.getId(),RECORD_INDEX,s],o)}));let s=this.getProperty("height",this.getProperty("mapHeight",300));i=HU.div([CLASS,"display-map-toc",STYLE,HU.css("max-height","calc("+HU.getDimension(s)+" - 1em)"),ID,this.domId("toc")],i);let l=this.getProperty("tableOfContentsTitle","");l&&(i=HU.center(HU.b(l))+i),this.jq(ID_LEFT).html(i);let r=this,o=this.jq(ID_LEFT).find(".display-map-toc-item");this.makeTooltips(o,t),o.click((function(){let e=$(this).attr(RECORD_INDEX),i=t[e];i&&(r.highlightPoint(i.getLatitude(),i.getLongitude(),!0,!1),r.map.setCenter(new OpenLayers.LonLat(i.getLongitude(),i.getLatitude())),r.map.setZoom(10),i.trackData&&setTimeout((()=>{r.getDisplayManager().notifyEvent("dataSelection",r,{data:i.trackData})}),100))})),o.dblclick((function(){r.removeHighlight();let e=$(this).attr(RECORD_INDEX),i=t[e];if(i){if(r.trackUrlField){let t=i.getValue(r.trackUrlField.getIndex());if(t&&t.length>0)return void r.toggleTrack(i,$(this))}r.map.setCenter(new OpenLayers.LonLat(i.getLongitude(),i.getLatitude()))}}))}},updateUI:function(t){t||(t={});let e=!1;if(this.lastUpdateTime=null,m.updateUI.call(this,t),this.haveCalledUpdateUI||!this.getDisplayReady()||!this.hasData()||!this.getProperty("showData",!0))return void 0;let i=this.getPointData();this.lastZoom=this.map?this.map.getZoom():null,this.shapesField=this.getFieldById(null,this.getProperty("shapesField")),this.shapesTypeField=this.getFieldById(null,this.getProperty("shapesTypeField")),this.trackUrlField=this.getFieldById(null,this.getProperty("trackUrlField"));let a=this.records=this.filterData();this.shapesTypeField&&this.shapesField&&(this.setProperty("tooltipNotFields",this.shapesTypeField.getId()+","+this.shapesField),this.loadShapes(a)),null!=a&&(this.getShowTableOfContents(!1)&&this.makeToc(a),this.updatingFromClip||"animation"!=t.source&&this.setMessage(t.dataFilterChanged||t.fieldChanged||t.reload?"Reloading map...":"Creating map..."),this.updatingFromClip=!1,setTimeout((()=>{try{this.updateUIInner(t,i,a,e),t.callback&&t.callback(),this.clearProgress()}catch(t){console.log(t),console.log(t.stack),this.setMessage("Error:"+t)}this.setIsFinished()})))},filterDataPhase2:function(t){if(t=m.filterDataPhase2.call(this,t),this.clipBounds||this.clipToView){let e=RecordUtil.getBounds(t);this.clipBounds=!1;let i=!1;if((!this.lastPointBounds||this.lastPointBounds&&this.lastPointBounds!=e)&&(i=!0),this.lastPointBounds=e,this.clipToView||i){let e=this.map.getMap().calculateBounds().transform(this.map.sourceProjection,this.map.displayProjection),i=t.filter((t=>e.containsLonLat(new OpenLayers.LonLat(t.getLongitude(),t.getLatitude()))));t=i}}return t},updateUIInner:function(t,e,i,a){let s=this,l=new Date;if((a=a||displayDebug.displayMapUpdateUI)&&console.log("displaymap.updateUIInner:"+i.length),this.haveCalledUpdateUI=!0,this.getProperty("showRegionSelector")){if(!ramaddaMapRegions){$.getJSON(ramaddaBaseUrl+"/regions.json",(t=>{if(GuiUtils.isJsonError(t))return console.log("Error fetching regions"),void(ramaddaMapRegions=[]);ramaddaMapRegions=t}))}let t=this.getProperty("regionSelectorLabel")||HU.getIconImage("fa-globe-americas"),e=HU.div([CLASS,"ramadda-menu-button ramadda-clickable",TITLE,"Select region",ID,this.domId("selectregion")],t)+SPACE2;this.writeHeader(ID_HEADER2_PREPREFIX,e),this.jq("selectregion").click((function(){let t=s.domId(u),e={};ramaddaMapRegions.forEach(((t,i)=>{if("World"==t.name)return;let a=t.group;"model regions"==a.toLowerCase()&&(a="Regions");let s=t.name.replace(/ /g,"&nbsp;"),l=HU.div([CLASS,"ramadda-menu-item","idx",i],s);e[a]||(e[a]=""),e[a]+=l}));let i="<table width=100%><tr valign=top>";Object.keys(e).forEach((t=>{i+=HU.td([STYLE,HU.css()],HU.div([STYLE,HU.css("font-weight","bold","border-bottom","1px solid #ccc","margin-right","5px")],Utils.camelCase(t))+HU.div([STYLE,HU.css("max-height","200px","overflow-y","auto","margin-right","10px")],e[t]))})),i+="</tr></table>";let a=HtmlUtils.setPopupObject(HtmlUtils.getTooltip());i=HU.div([ID,t],i),a.html(HU.div([CLASS,"ramadda-popup-inner"],i)),a.show(),a.position({of:$(this),my:"left top",at:"left bottom"}),s.jq(u).find(".ramadda-menu-item").click((function(){let t=ramaddaMapRegions[+$(this).attr("idx")];HtmlUtils.hidePopupObject(),s.map.setViewToBounds(new RamaddaBounds(t.north,t.west,t.south,t.east))}))}))}if(!this.getProperty("makeDisplay",!0))return;let r={},o=RecordUtil.getPoints(i,r),n=e.getRecordFields(),h=this.getProperty("showSegments",!1);if(0!=i.length&&(isNaN(r.north)||(this.initBounds=r,h||this.hadInitialPosition||t.dontSetBounds||t.dataFilterChanged&&!this.getCenterOnFilterChange(!0)||this.setInitMapBounds(r.north,r.west,r.south,r.east))),null==this.map)return;this.highlightMarker&&(this.map.removePoint(this.highlightMarker),this.map.removeMarker(this.highlightMarker),this.highlightMarker=null),this.map.clearSeenMarkers();let d=new Date;a&&console.log("displaymap calling addPoints"),this.addPoints(i,n,o,r,a);let p=new Date;this.addLabels(i,n),this.applyVectorMap(!0,this.textGetter,t);let g=new Date;a&&Utils.displayTimes("time pts="+o.length,[l,d,p,g],!0),this.lastUpdateTime=new Date},heatmapCnt:0,animationApply:function(t,e){if(!this.heatmapLayers||!this.heatmapVisible)return void m.animationApply.call(this,t,e);let i=null,a=null,s=[];this.heatmapLayers.every((e=>!e.date||(e.date.getTime()>=t.begin.getTime()&&e.date.getTime()<=t.end.getTime()?(i=e.date,a=e,e.setVisibility(!0)):e.getVisibility()&&s.push(e),!0))),s.forEach((t=>{t.setVisibility(!1)})),console.log("map.applyAnimation-2:"+i),i||m.animationApply.call(this,t,e),null!=a&&this.setMapLabel(a.heatmapLabel)},setDateRange:function(t,e){this.getProperty("doGridPoints",!1)||this.getProperty("doHeatmap",!1),m.setDateRange.call(this,t,e)},showColorTable:function(t){t.displayColorTable(null,!0),this.callingUpdateSize=!0,this.callingUpdateSize=!1},applyHeatmapAnimation:function(t){this.jq(d)[0].selectedIndex=t;let e=[];this.heatmapLayers.forEach(((i,a)=>{t==a?i.setVisibility(!0):e.push(i)})),e.forEach((t=>{t.setVisibility(!1)})),this.setMapLabel(this.heatmapLayers[t].heatmapLabel)},stepHeatmapAnimation:function(){let t=this.jq(d)[0].selectedIndex;t++,t>=this.heatmapLayers.length&&(t=0),this.applyHeatmapAnimation(t),this.heatmapPlayingAnimation&&setTimeout((()=>{this.stepHeatmapAnimation()}),this.getHmAnimationSleep(1e3))},checkHeatmapReload:function(){if(!this.getHmReloadOnZoom(this.getReloadOnZoom(!1)))return;let t=new Date;if(t.getTime()-this.createTime.getTime()<3e3)return;let e=0;this.checkHeatmapReloadTime&&(e=t.getTime()-this.checkHeatmapReloadTime.getTime()),this.checkHeatmapReloadTime=t,e<1e3?this.checkHeatmapReloadPending||(this.checkHeatmapReloadPending=!0,setTimeout((()=>{this.checkHeatmapReloadPending=!1,this.checkHeatmapReload()}),1100)):(this.checkHeatmapReloadTime=null,this.reloadHeatmap=!0,this.haveCalledUpdateUI=!1,this.updateUI())},createHeatmap(t,e,i){let a=displayDebug.displayMapCreateMap;a&&console.log("createHeatmap");let s=this.getColorByInfo(t,null,null,null,["hmColorBy","colorBy",""]),l=this.getColorByInfo(t,"angleBy",null,null,["hmAngleBy","angleBy",""]),r=this.getColorByInfo(t,"lengthBy",null,null,["hmLengthBy","lengthBy",""]);if(l.isEnabled()||(l=s),r.isEnabled()||(r=null),t=t||this.filterData(),this.getHmBounds()){let t=this.getHmBounds().split(",");i=new RamaddaBounds(+t[0],+t[1],+t[2],+t[3])}let o=this.map.getBounds();if(i=i||RecordUtil.getBounds(t),i=RecordUtil.convertBounds(o),this.heatmapLayers)try{this.heatmapLayers.every((t=>(this.map.removeLayer(t),!0)))}catch(t){console.log(t)}if(this.heatmapLayers=[],0==t.length)return this.errorMessage=this.getNoDataMessage(),void this.setMessage(this.errorMessage);this.reloadHeatmap&&(this.reloadHeatmap=!1,i=new RamaddaBounds(this.map.getBounds()),t=RecordUtil.subset(t,i)),i=RecordUtil.expandBounds(i,this.getProperty("boundsScale",.05));let n=this.getDefaultGridByArgs(),h=(i.east-i.west)/(i.north-i.south),u=Math.round(this.getProperty("gridWidth",800)),y=Math.round(u/h),m=this.getFieldById(null,this.getHmGroupBy()),f=this.getHmGroupByDate();a&&console.log("\tcalling groupBy");new Date;let D=m||f?RecordUtil.groupBy(t,this,f,m):null;new Date;a&&console.log("\tdone calling groupBy"),null!=D&&0!=D.max||(doTimes=!1,D={max:t.length,values:["none"],map:{none:t}});let I=D.max;if(0==n.cellSize){let t=Math.sqrt(I),e=Math.round(u/t);n.cellSizeX=n.cellSizeY=n.cellSize=e}else String(n.cellSize).endsWith("%")&&(n.cellSize=n.cellSizeX=n.cellSizeY=Math.floor(parseFloat(n.cellSize.substring(0,n.cellSize.length-1))/100*u));let T=$.extend({colorBy:s,angleBy:l,lengthBy:r,w:u,h:y,bounds:i,forMercator:!0},n);a&&console.log("#records:"+t.length+" dim:"+u+" "+y+" #records:"+t.length+" cell:"+n.cellSizeX+" #records:"+t.length+" bounds:"+i);let b=[],S=this.getHmLabelPrefix("${field}-");if(D.values.every(((t,l)=>{let r=D.map[t];a&&console.log("group:"+t+" #:"+D.map[t].length);let o=Gfx.gridData(this.getId(),e,r,T),n="none"==t?"Heatmap":S+" "+D.labels[l];n=n.replace("${field}",s.field?s.field.getLabel():""),b.push(n);let h=this.map.addImageLayer("heatmap"+this.heatmapCnt++,n,"",o,0==l,i.north,i.west,i.south,i.east,u,y,{isBaseLayer:!1});return this.map.getMap().setLayerIndex(h,1e3),h.heatmapLabel=n,f&&t.getTime&&(h.date=t),this.heatmapLayers.push(h),!0})),this.getHmShowGroups(!0)&&this.heatmapLayers.length>1&&!this.getAnimationEnabled()){this.heatmapPlayingAnimation=!1;let t="";m||(t+=HU.div([ID,this.domId(p),STYLE,HU.css("display","inline-block"),TITLE,"Play/Stop Animation"],HU.getIconImage("fa-play",[CLASS,"display-anim-button"]))),t+=HU.div([ID,this.domId(g),STYLE,HU.css("display","inline-block"),TITLE,"Step"],HU.getIconImage("fa-step-forward",[CLASS,"display-anim-button"])),t+=HU.div([STYLE,HU.css("display","inline-block","margin-left","5px","margin-right","5px")],HU.select("",[ID,this.domId(d)],b)),this.writeHeader(ID_HEADER2_PREPREFIX,t);let e=this;this.jq(d).change((function(){let t=$(this)[0].selectedIndex;e.applyHeatmapAnimation(t)})),this.jq(p).click((function(){e.heatmapPlayingAnimation=!e.heatmapPlayingAnimation;let t=e.heatmapPlayingAnimation?"fa-stop":"fa-play";$(this).html(HU.getIconImage(t,[CLASS,"display-anim-button"])),e.heatmapPlayingAnimation&&e.stepHeatmapAnimation()})),this.jq(g).click((function(){e.heatmapPlayingAnimation=!1;let t=e.heatmapPlayingAnimation?"fa-stop":"fa-play";e.jq(p).html(HU.getIconImage(t,[CLASS,"display-anim-button"])),e.stepHeatmapAnimation()}))}if("none"!=D.values[0]&&this.setMapLabel(b[0]),this.showColorTable(s),this.getHmShowToggle()||this.getHmShowReload()){let t=this.jq(c),e=HU.getIconImage("fa-sync",[CLASS,"display-anim-button",TITLE,"Reload heatmap",ID,this.domId("heatmapreload")])+SPACE2;this.heatmapVisible=0==t.length||t.is(":checked"),this.writeHeader(ID_HEADER2_PREFIX,e+HU.checkbox("",[ID,this.domId(c)],this.heatmapVisible)+SPACE+this.getHmToggleLabel("Toggle Heatmap")+SPACE2);let i=this;this.jq("heatmapreload").click((()=>{this.reloadHeatmap=!0,this.haveCalledUpdateUI=!1,this.updateUI()})),this.jq(c).change((function(){if(i.heatmapLayers){let t=$(this).is(":checked");i.heatmapVisible=t,i.heatmapLayers.forEach((e=>e.setVisibility(t))),i.map.setPointsVisibility(!t)}}))}},updateHtmlLayers:function(){this.htmlLayerInfo&&this.createHtmlLayer(this.htmlLayerInfo.records,this.htmlLayerInfo.fields)},updateHtmlLayer:function(){if(this.htmlLayer){if(!this.htmlLayerId){this.htmlLayerId=this.getUniqueId("htmllayer");let t=this.map.getMap().getViewport();t=$(t).children()[0],$(t).css("display","relative"),$(t).append(HU.div([CLASS,"display-map-htmllayer",ID,this.htmlLayerId]))}$("#"+this.htmlLayerId).html(this.htmlLayer)}},createHtmlLayer:function(t,e){let i=this.getFieldById(e,this.getHtmlLayerField());this.htmlLayerInfo={records:t,fields:e},this.htmlLayer="";let a=this.getHtmlLayerWidth(30),s=this.getHtmlLayerHeight(15),l=this.getHtmlLayerShape("barchart");if("barchart"==l&&this.setProperty("colorBy",i.getId()),this.getHtmlLayerScale()){let t=[];this.getHtmlLayerScale().split(",").forEach((e=>{t.push(e.split(":"))}));let e=this.map.map.getZoom(),i=1;1==t.length&&1==t[0].length?i=t[0][0]:t.every((t=>(i=t[1],!(t[0]>=e)))),a*=i,s*=i}let r=this.getHtmlLayerStyle(""),o=[],n=this.getColumnValues(t,i),h=RecordUtil.groupBy(t,this,!1,"latlon"),d=$($(this.map.getMap().getViewport()).children()[0]),p=+d.css("left").replace("px",""),g=+d.css("top").replace("px",""),c=3*a,u=3*s,y=[];h.values.forEach(((t,e)=>{let l=h.map[t],n=[];y.push(l[0]),l.forEach(((t,e)=>{n.push(t.getValue(i.getIndex()))}));let d=l[0],m=this.map.getMap().getPixelFromLonLat(this.map.transformLLPoint(new OpenLayers.LonLat(d.getLongitude(),d.getLatitude()))),f=this.getId()+"_sl"+e,D=f+"_hover",I=HU.div([ID,f,CLASS,"display-map-html-item",STYLE,r+HU.css("line-height","0px","z-index","1000","position","absolute","left",m.x-a/2-p+"px","top",m.y-s/2-g+"px")])+HU.div([ID,D,RECORD_INDEX,e,TITLE,"",CLASS,"display-map-html-hitem",STYLE,r+HU.css("display","none","line-heigh","0px","z-index","1001","position","absolute","left",m.x-c/2-p+"px","top",m.y-u/2-g+"px")]);this.htmlLayer+=I,o.push({id:f,hoverId:D,data:n,records:l})})),this.updateHtmlLayer();let m=this.getColorByInfo(t);o.forEach(((t,e)=>{"pie"==l||"piechart"==l?[0,1].forEach(((e,i)=>{let l=HU.getUniqueId("pie"),r=0==i?a:c,o=0==i?s:u,n=HU.tag("canvas",[STYLE,HU.css("cursor","pointer"),ID,l,WIDTH,r,HEIGHT,o]);0==i?$("#"+t.id).html(n):$("#"+t.hoverId).html(n);let h=document.getElementById(l),d=m&&m.isEnabled()?m.getColor(t.data[0]):this.getFillColor("#619FCA");var p=h.getContext("2d");1==i&&(p.fillStyle="#fff",p.beginPath(),p.moveTo(r/2,o/2),p.arc(r/2,o/2,r/2-2,0-Math.PI/2,2*Math.PI),p.closePath(),p.fill()),p.beginPath(),p.moveTo(r/2,o/2),p.arc(r/2,o/2,r/2-2,0-Math.PI/2,2*t.data[0]*Math.PI-Math.PI/2),p.lineTo(r/2,o/2),p.closePath(),p.strokeStyle=this.getStrokeColor("#888"),p.fillStyle=d,p.fill(),p.stroke(),p.beginPath(),p.arc(r/2,o/2,r/2-2,0,2*Math.PI),p.closePath(),p.stroke()})):(drawSparkLine(this,"#"+t.id,a,s,t.data,t.records,n.min,n.max,m),$("#"+t.hoverId).css("background","#fff").css("border","1px solid #ccc"),drawSparkLine(this,"#"+t.hoverId,c,u,t.data,t.records,n.min,n.max,m))}));let f=this.find(".display-map-html-item"),D=this.find(".display-map-html-hitem");this.makeTooltips(D,y),f.mouseenter((function(){$(this).css("display","none"),$("#"+$(this).attr(ID)+"_hover").fadeIn(1e3)})),D.mouseleave((function(){$("#"+$(this).attr(ID).replace("_hover","")).css("display","block"),$(this).css("display","none")})),m.hasField()&&this.showColorTable(m)},addPoints:function(t,e,i,a,s){if(this.getDoGridPoints()||this.getDoHeatmap(!1))return(this.getHmShowPoints()||this.getShowPoints())&&(this.createPoints(t,e,i,a,s),this.getHmShowToggle(!1)&&this.map.circles&&this.map.setPointsVisibility(!1)),void this.createHeatmap(t,e,a);this.getHtmlLayerField()?this.createHtmlLayer(t,e):this.createPoints(t,e,i,a,s)},createPoints:function(t,i,s,l,r){r=r||displayDebug.displayMapAddPoints;let o=[],d=[],p=[],g=this.getColorByInfo(t,null,null,null,null,this.lastColorBy);this.lastColorBy=g;let c=0,u=this.getFieldById(i,this.getProperty("polygonField")),y=this.getColorTable(!0,"polygonColorTable",null),m=this.getProperty("latlon",!0),f=this,D=+this.getPropertyRadius(8),I=this.getFilterHighlight(),T=this.getUnhighlightColor(),b=this.getProperty("unhighlightStrokeWidth",0),S=this.getProperty("unhighlightStrokeColor","#aaa"),x=this.getProperty("unhighlightRadius",-1);if(this.markers={},this.getPropertyScaleRadius()){let t={},e=0;s.every((i=>{let a=i.x+"_"+i.y;return t[a]||(e++,t[a]=!0),!0}));let i=this.getPropertyRadiusScale();i=Utils.stringDefined(i)?i.split(",").map((t=>+t)):[1e4,2,6e3,3,4500,4,3500,5,2600,6,1300,7,800,8,300,9,275,10,250,11,225,12,175,13,125,14,100,15,50,16],D=i[1];for(let t=0;t<i.length;t+=2)e<i[t]&&(D=i[t+1])}D=Math.min(D,this.getMaxRadius());let U=+this.getPropertyStrokeWidth(),L=this.getPropertyStrokeColor();this.getDisplayProp(f,"sizeBy",null);if(this.getDisplayProp(f,"isTrajectory",!1)){let t={strokeWidth:2,strokeColor:"blue",fillColor:this.getProperty("fillColor","transparent")};return 1==s.length?d.push(this.map.createPoint(ID,s[0],t,null)):(this.getShowPathEndPoint()&&(d.push(this.map.createMarker("startpoint",s[0],ramaddaCdn+"/icons/map/marker-green.png")),d.push(this.map.createMarker("endpoint",s[s.length-1],ramaddaCdn+"/icons/map/marker-blue.png"))),d.push(this.map.createPolygon(ID,"",s,t,null))),void this.addFeatures(d)}let E=this.getFieldById(i,this.getProperty("latField1")),P=this.getFieldById(i,this.getProperty("latField2")),C=this.getFieldById(i,this.getProperty("lonField1")),A=this.getFieldById(i,this.getProperty("lonField2")),w=this.getProperty("sizeSegments",!1),H=this.getProperty("sizeEndPoints",!0),R=this.getProperty("showEndPoints",!1),k=parseInt(this.getProperty("endPointSize","4")),_=k,F=parseInt(this.getProperty("segmentWidth","1")),M=F,N=this.getShowLayers()&&(this.getProperty("geojsonLayer")||this.getProperty("kmlLayer")),B=this.getProperty("showPoints",!N),O=this.getProperty("lineColor","green"),Y=this.getProperty("lineCap","round"),G=this.getFieldById(i,this.getProperty("iconField")),V=this.getFieldById(i,this.getProperty("rotateField")),q=this.getProperty("markerIcon",this.getProperty("pointIcon"));q&&q.startsWith("/")&&(q=ramaddaBaseUrl+q);let j=q||G,W=parseFloat(this.getProperty("iconSize",this.getProperty("radius",32))),z=this.getIconMap(),X=this.getProperty("defaultShape",null),J=["circle","triangle","star","square","cross","x","lightning","rectangle","church"],K=0,Z={id:this.getDisplayProp(f,"shapeBy",null),field:null,map:{}};this.getDisplayProp(f,"shapeByMap",null)&&this.getDisplayProp(f,"shapeByMap",null).split(",").forEach((t=>{let e=t.split(":");Z.map[e[0]]=e[1]}));let Q=new SizeBy(this,this.getProperty("sizeByAllRecords",!0)?this.getData().getRecords():t);for(let t=0;t<i.length;t++){let e=i[t];e.getId()!=Z.id&&"#"+(t+1)!=Z.id||(Z.field=e,e.isString()&&(Z.isString=!0))}if(Z.index=null!=Z.field?Z.field.getIndex():-1,this.getProperty("showColorByMenu",!1)&&g.field&&!this.madeColorByMenu){this.madeColorByMenu=!0;let t=HU.open(SELECT,[CLASS,"ramadda-pulldown",ID,this.domId("colorByMenu")]);for(let e=0;e<i.length;e++){let a=i[e];if(!a.isNumeric()||a.isFieldGeo())continue;let s="";g.field.getId()==a.getId()&&(s="selected "),t+="<option value='"+a.getId()+"' "+s+">"+a.getLabel()+"</option>\n"}t+=HU.close(SELECT),this.writeHtml(ID_TOP_RIGHT,"Color by: "+t),this.jq("colorByMenu").change((()=>{let t=this.jq("colorByMenu").val();this.vectorMapApplied=!1,this.haveCalledUpdateUI=!1,this.setProperty("colorBy",t),this.updateUI()}))}let tt=null,et=null,it=[],at=this.getPropertyJustOneMarker();for(let e=0;e<t.length;e++){let i=t[e];if(it.push(i.getDate()),null==tt)tt=i.getDate(),et=i.getDate();else{let t=i.getDate();t&&(t.getTime()<tt.getTime()&&(tt=t),t.getTime()>et.getTime()&&(et=t))}}et&&this.getAnimationEnabled(),this.removeFeatureLayer();let st,lt,rt=!1,ot={},nt={strokeColor:this.getProperty("pathColor",O),strokeWidth:this.getProperty("pathWidth",1)},ht=this.getPropertyFillColor(),dt=this.getPropertyFillOpacity(),pt=this.getProperty("isPath",!1),gt=this.getFieldById(null,this.getProperty("groupByField"));gt&&(lt=RecordUtil.groupBy(t,this,!1,gt));let ct=this.getProperty("showSegments",!1),ut=this.getProperty("tooltip"),yt=this.getProperty("highlight"),mt=this.getProperty("highlightTemplate");mt&&(yt=!0);let ft=this.getProperty("highlightWidth",200),Dt=this.getProperty("highlightHeight",-1),It=null;Dt>0&&(It=new OpenLayers.Size(ft,Dt));let Tt=this.textGetter=t=>{if(t.record){let e=this.getRecordHtml(t.record,i,ut);return""==e?"BLANK":e}return null},bt=t=>t.record?HU.div([STYLE,HU.css("background","#fff")],this.getRecordHtml(t.record,i,mt||ut)):null;this.haveAddPoints=!0;let St=this.displayInfo={};if(t.forEach((t=>{let e=St[t.getId()]={features:[],visible:!0};t.point?(e.x=t.point.x,e.y=t.point.y):(e.x=t.getLongitude(),e.y=t.getLatitude())})),this.getHandleCollisions()){this.getProperty("collisionLabels",!1)&!this.map.collisionLabelsLayer&&(this.map.collisionLabelsLayer=new OpenLayers.Layer.Vector("Collision Labels",{styleMap:new OpenLayers.StyleMap({default:{label:"${label}"}})}),this.map.addVectorLayer(this.map.collisionLabelsLayer,!0),this.map.collisionLabelsLayer.setZIndex(100));let e=this.map.getBounds(),i=e.right-e.left,a=$("#"+this.getProperty(PROP_DIVID)).width()/i,s=.025*i,l=0,r=0,o=this.getProperty("collisionMinPixels",16);for(;a*l<o&&r<100;)l+=s,r++;let n=this.getProperty("collisionLineWidth","2"),h=this.getProperty("collisionLineColor","#000"),p={},g=-1,c=[6,12,24,48,96,192];for(let t=0;t<c.length&&!(a<c[t]);t++)g++;let u=t=>{if(g>0){return Utils.roundDecimals(t,g)}return t=Math.round(t),g<0&&t%2!=0&&t--,t},y=t=>{let e=u(t.y),i=u(t.x);return new OpenLayers.Geometry.Point(i,e)};t.forEach((t=>{let e=St[t.getId()];null!==e.x&&null!==e.y&&(e.rpoint=y(e),p[e.rpoint]?p[e.rpoint]++:p[e.rpoint]=1)}));let m=this.collisionState={};t.forEach(((t,e)=>{let i=St[t.getId()],a=i,s=i.rpoint;if(null==s)return;if(1==p[s])return;let r=p[s],o=360/r,g=l,c=r/8;c>1&&(g*=c);let u=m[s];u||(u=m[s]=new CollisionInfo(this,p[s],s),d.push(u.createDot(e))),i.collisionInfo=u,i.visible=u.visible,u.addRecord(t);let y=u.records.length,f=Utils.rotate(s.x,s.y,s.x,s.y-g,y*o-180,!0),D=this.map.createLine("line-"+e,"",s.y,s.x,f.y,f.x,{strokeColor:h,strokeWidth:n});u.visible||(D.featureVisible=!1,this.map.checkFeatureVisible(D,!0)),u.addLine(D),d.push(D),a.x=f.x,a.y=f.y}))}let vt=0,xt=function(t,e){H&&!isNaN(t)&&(k=_+parseInt(10*t)),w&&(isNaN(t)?F=M+e:(F=M+parseInt(10*t),F=e,(0==F||isNaN(F))&&(F=1)))};pt&&lt&&lt.values.forEach((t=>{let e=null,i=null,a=null;if(lt.map[t].forEach((t=>{if(e||(e=t),vt++,i){nt.strokeColor=g.getColorFromRecord(t,nt.strokeColor,!0);let e=this.map.createLine("line-"+vt,"",i.getLatitude(),i.getLongitude(),t.getLatitude(),t.getLongitude(),nt);d.push(e),e.record=t,e.textGetter=Tt}a=i,i=t})),i){let t=g.getColorFromRecord(i,nt.strokeColor);if(a&&this.getShowPathEndPoint(!1)){let e=this.getProperty("pathEndPointShape",null);var s=Utils.getBearing({lon:a.getLongitude(),lat:a.getLatitude()},{lon:i.getLongitude(),lat:i.getLatitude()});let l=this.map.createPoint("endpoint",{x:i.getLongitude(),y:i.getLatitude()},{fillColor:t,strokeColor:"#000",pointRadius:6,graphicName:e,rotation:s},null);d.push(l)}if(this.getProperty("showPathStartPoint",!1)){let i=this.map.createPoint("startpoint",{x:e.getLongitude(),y:e.getLatitude()},{fillColor:t,pointRadius:2},null);d.push(i)}}}));let Ut=g.isEnabled(),Lt=this.getPropertyShape(),Et=!1,Pt=[new Date];if(t.forEach(((i,a)=>{vt++;let s=St[i.getId()];if(!s)return;let l=s;if(l){if(!Utils.isDefined(l.x)||!Utils.isDefined(l.y))return}else l=new OpenLayers.Geometry.Point(i.getLongitude(),i.getLatitude());if(at){if(r=!1,Et)return void(r&&console.log("didMarker"));if(this.map.removeMarker(this.justOneMarker),isNaN(l.x)||isNaN(l.y))return;if(Et=!0,this.justOneMarker=this.map.createMarker(e,[l.x,l.y],null,"",""),d.push(this.justOneMarker),r&&console.log("\tadding justOneMarker had initial position:"+this.hadInitialPosition),!this.hadInitialPosition){let t=MapUtils.createLonLat(l.x,l.y);r&&console.log("\tsetting center:"+t),this.map.setCenter(t)}return}let n=i.getData(),h={pointRadius:D,strokeWidth:U,strokeColor:L,fillColor:ht,fillOpacity:dt};if(Z.field){let t=n[Z.index];t&&(Utils.isDefined(Z.map[t])||(X?Z.map[t]=X:(K>=J.length&&(K=0),Z.map[t]=J[K++])),Utils.isDefined(Z.map[t])&&(h.graphicName=Z.map[t]))}if(F=M,h.pointRadius=Q.getSize(n,h.pointRadius,xt),h.pointRadius<0)return;(isNaN(h.pointRadius)||0==h.pointRadius)&&(h.pointRadius=D);let f,v,w=!1,H=null;if(g.compareFields.length>0){let t=null,e=0;g.compareFields.forEach(((a,s)=>{let l=i.getData()[a.getIndex()];(0==s||l>e)&&(t=g.colors[s],e=l)})),f=e,H=t}else if(Ut){let t=i.getData()[g.index];f=t,H=g.getColorFromRecord(i,H)}if(H&&(rt=!0,w=!0,v=h.fillColor=g.convertColor(H,f)),I&&!i.isHighlight(this)&&(h.fillColor=T,h.strokeColor=S,h.strokeWidth=b,x>0&&(h.pointRadius=x)),u){let t=n[u.getIndex()],e={};$.extend(e,h),e.fillColor="transparent",0==e.strokeWidth&&(e.strokeWidth=1),y&&(c>=y.length&&(c=0),e.strokeColor=y[c++]);let a=this.map.createPolygonString(t,e,m);a.forEach((t=>{t.textGetter=Tt,t.record=i;let e=i.getDate();e&&(t.date=e.getTime()),d.push(t)})),a.forEach((t=>{d.push(t)}))}if(ct&&E&&P&&C&&A){let t=n[E.getIndex()],e=n[P.getIndex()],a=n[C.getIndex()],s=n[A.getIndex()],l={};h.fillColor?l.strokeColor=h.fillColor:l.strokeColor=O,l.strokeLinecap=Y,l.strokeColor=g.getColorFromRecord(i,l.strokeColor),l.strokeWidth=F;let r=this.map.createLine("line-"+vt,"",t,a,e,s,l);if(d.push(r),r.record=i,r.textGetter=Tt,yt&&(r.highlightTextGetter=bt,r.highlightSize=It),r.record=i,d.push(r),R){let r={};$.extend(r,h),r.fillColor=l.strokeColor,r.strokeColor=l.strokeColor,r.pointRadius=_,r.pointRadius=k;let o=new OpenLayers.LonLat(a,t),n=new OpenLayers.LonLat(s,e);if(!Utils.isDefined(ot[o])){ot[o]=!0;let t=this.map.createPoint("endpt-"+vt,o,r);d.push(t),t.record=i,t.textGetter=Tt,d.push(t)}if(!Utils.isDefined(ot[n])){ot[n]=!0;let t=this.map.createPoint("endpt2-"+vt,n,r);d.push(t),t.record=i,t.textGetter=Tt,d.push(t)}}}let N=1e4*l.x+l.y;if(ot[N]){if(ot[N]>500)return;ot[N]++}else ot[N]=1;let B=null,tt=s.features;if(j)if(G){let t=i.getData()[G.getIndex()];z&&(t=z[t],t||(t=this.getMarkerIcon()));let e=W;Q.index>=0&&(e=h.pointRadius),s.collisionInfo||(B=this.map.createMarker("pt-"+vt,l,t,"pt-"+vt,null,null,e),B.isMarker=!0,tt.push(B),this.markers[i.getId()]=B,p.push(B))}else{let t={};V&&(t.rotation=i.getValue(V.getIndex())),B=this.map.createMarker("pt-"+vt,l,q,"pt-"+vt,null,null,W,null,null,t),p.push(B),B.isMarker=!0,tt.push(B),this.markers[i.getId()]=B}if(j&&!Ut||(h.graphicName||(h.graphicName=Lt),V&&(h.rotation=i.getValue(V.getIndex())),h.fillColor=g.getColorFromRecord(i,h.fillColor),D>0&&(B=this.map.createPoint("pt-"+vt,l,h,null),p.push(B),this.markers[i.getId()]=B,tt.push(B))),pt&&!lt&&st){nt.strokeColor=g.getColorFromRecord(i,nt.strokeColor);let t=this.map.createLine("line-"+vt,"",st.y,st.x,l.y,l.x,nt);p.push(t)}st=l,o&&tt.forEach((t=>{o.push(t)}));let et=i.getDate();tt.forEach((e=>{yt&&(e.highlightTextGetter=bt,e.highlightSize=It),e.record=i,e.textGetter=Tt,e.hasColorByValue=w,e.colorByValue=f,e.colorByColor=v,et&&(e.date=et.getTime()),s.visible||(e.featureVisible=!1,this.map.checkFeatureVisible(e,!0,t.length<20))})),s.collisionInfo&&s.collisionInfo.addPoints(tt)})),Pt.push(new Date),B&&this.addFeatures(p),this.myPoints=p,this.addFeatures(d),Pt.push(new Date),t.length>0&&this.getProperty("selectFirstRecord")&&!this.haveSelectedFirstRecord){this.haveSelectedFirstRecord=!0;let e=t[0];this.propagateEventRecordSelection({record:e});let i=this.getProperty("displayDiv",null);i&&this.textGetter&&$("#"+i).html(this.textGetter({record:e}));let a=this.markers[e.getId()];a&&this.map.handleFeatureclick(null,a)}ct&&this.map.centerOnMarkers();let Ct=this.getProperty("sizeByLegendSide");if(Ct){let t=Q.getLegend(5,ht,"left"==Ct||"right"==Ct);if(""!=t){let e=this.getProperty("sizeByLegendStyle");e&&(t=HU.div([STYLE,e],t)),this.jq(n).html(t),this.callingUpdateSize=!0,this.map.getMap().updateSize(),this.callingUpdateSize=!1}}if(Pt=[new Date],this.jq(ID_BOTTOM).append(HU.div([ID,this.domId(h)])),rt&&this.showColorTable(g),Pt.push(new Date),G&&z){let t="";for(a in z)t+=HU.image(z[a],["width","32"])+" "+a+" ";this.jq(h).html(HU.center(t))}if(Z.field){let t=Z.field.getLabel()+": ";for(v in Z.map){let e=Z.map[v];"circle"==e?e=HU.getIconImage("fa-circle"):"square"==e||"rectangle"==e?e=HU.getIconImage("fa-square"):"star"==e?e=HU.getIconImage("fa-star"):"triangle"==e?e=HU.getIconImage("/icons/triangle.png",["width","16px"]):"lightning"==e?e=HU.getIconImage("/icons/lightning.png",["width","16px"]):"cross"==e?e=HU.getIconImage("/icons/cross.png",["width","16px"]):"church"==e&&(e=HU.getIconImage("fa-cross")),t+=e+" "+v+SPACE2}this.jq(h).html(HU.center(t))}this.getProperty("animationTakeStep",!1)&&this.getAnimation().doNext()},addLabels:function(t,e){let i=this.getLabelLimit(1e3);if(t.length>i)return;let a,s=this.map.getMap().viewPortDiv.offsetWidth,l=this.map.getMap().viewPortDiv.offsetHeight,r=this.map.getBounds(),o=Math.round(s/10),n=Math.round(l/10),h=(r.right-r.left)/o,d=(r.top-r.bottom)/n,p={},g=this.getDoLabelGrid(),c=this.getLabelTemplate();if(this.getLabelKeyField()&&(a=this.getFieldById(e,this.getLabelKeyField())),!c&&!a)return;a&&(c="${_key}"),c=c.replace(/_nl_/g,"\n"),this.map.labelLayer||(this.map.labelLayer=new OpenLayers.Layer.Vector("Labels",{styleMap:new OpenLayers.StyleMap({default:{label:c,fontColor:this.getProperty("labelFontColor","#000"),fontSize:this.getProperty("labelFontSize","10pt"),fontFamily:this.getProperty("labelFontFamily","'Open Sans', Helvetica Neue, Arial, Helvetica, sans-serif"),fontWeight:this.getProperty("labelFontWeight","plain"),labelAlign:this.getProperty("labelAlign","lb"),labelXOffset:this.getProperty("labelXOffset","0"),labelYOffset:this.getProperty("labelYOffset","0"),labelOutlineColor:this.getProperty("labelOutlineColor","#fff"),labelOutlineWidth:this.getProperty("labelOutlineWidth","0"),labelSelect:!0}})}),this.map.addVectorLayer(this.map.labelLayer,!0),this.map.labelLayer.setZIndex(100));let u={},y="";var m=[],f=this.getProperty("colorBy"),D=this.getProperty("sizeBy");let I=0,T="ABCDEFGHIJKLMNOPQRSTUVWXYZ".split(""),b=[];for(let t=0;t<3;t++)T.forEach((e=>{let i="";for(let a=0;a<=t;a++)i+=e;b.push(i)}));for(var S=0;S<t.length;S++){var v=t[S],x=v.point;let i=Math.floor((v.getLongitude()-r.left)/h),s=Math.floor((v.getLatitude()-r.bottom)/d);if(g){let t=i+"_"+s;if(p[t])continue;p[t]=!0}x={x:v.getLongitude(),y:v.getLatitude()};var U=new OpenLayers.Geometry.Point(x.x,x.y);U.transform(this.map.displayProjection,this.map.sourceProjection);var L=new OpenLayers.Feature.Vector(U);if(L.noSelect=!0,L.attributes={},L.attributes[RECORD_INDEX]=S+1,L.attributes.recordIndex=S+1+"",a){let t=a.getValue(v);u[t]||(I>=b.length&&(I=0),u[t]=b[I++],y+=u[t]+": "+t+"<br>"),L.attributes._key=u[t]}for(var E=0;E<e.length;E++){var P=e[E];L.attributes[P.getId()]=P.getValue(v),f&&P.getId()==f&&(L.attributes.colorBy=P.getValue(v)),D&&P.getId()==D&&(L.attributes.sizeBy=P.getValue(v))}m.push(L)}y.length>0&&(this.legendId||(this.legendId=this.domId("legendid"),this.jq(ID_RIGHT).append(HU.div([ID,this.legendId,CLASS,"display-map-legend",STYLE,HU.css("max-height",this.getHeight("400px"))]))),this.jq("legendid").html(y)),this.labelFeatures&&this.map.labelLayer.removeFeatures(this.labelFeatures),this.map.labelLayer.addFeatures(m),this.labelFeatures=m,$("#"+this.map.labelLayer.id).css("z-index",900)},handleEventRemoveDisplay:function(t,e){if(this.map){var i=this.mapEntryInfos[e];null!=i&&i.removeFromMap(this.map);var a=this.findFeature(e,!0);null!=a&&null!=a.line&&this.map.removePolygon(a.line)}},findFeature:function(t,e){for(var i in this.features){var a=this.features[i];if(a.source==t)return e&&this.features.splice(i,1),a}return null},getMarkerIcon:function(){if(this.getProperty("markerIcon")){var t=this.getProperty("markerIcon");return t.startsWith("/")?ramaddaBaseUrl+t:t}return displayMapCurrentMarker++,displayMapCurrentMarker>=displayMapMarkers.length&&(displayMapCurrentMarker=0),ramaddaCdn+"/lib/openlayers/v2/img/"+displayMapMarkers[displayMapCurrentMarker]},highlightMarker:null,handleEventRecordHighlight:function(t,e){m.handleEventRecordHighlight.call(this,t,e),this.highlightPoint(e.record.getLatitude(),e.record.getLongitude(),e.highlight,!0)},handleEventRecordSelection:function(t,e){(m.handleEventRecordSelection.call(this,t,e),this.map)&&(e.highlight=!0,this.getProperty("showRecordSelection",!0)&&this.handleEventRecordHighlight(t,e))}})}function MapEntryInfo(t){RamaddaUtil.defineMembers(this,{entry:t,marker:null,rectangle:null,removeFromMap:function(t){null!=this.marker&&t.removeMarker(this.marker),null!=this.rectangle&&t.removePolygon(this.rectangle),null!=this.polygon&&t.removePolygon(this.polygon),null!=this.circle&&t.removePoint(this.circle)}})}var ramaddaGridState={grids:{},loading:{}};function RamaddaMapgridDisplay(t,e,i){const a=new RamaddaFieldsDisplay(t,e,DISPLAY_MAPGRID,i);defineDisplay(addRamaddaDisplay(this),a,[{label:"Grid Map Attributes"},{p:"localeField",ex:""},{p:"grid",ex:"countries|us"},{p:"cellSize",ex:"30",tt:"use 0 for flexible width"},{p:"cellHeight",ex:"30"},{p:"showCellLabel",ex:"false"}],{needsData:function(){return!0},displayData:function(t){this.updateUI()},handleEventFieldsSelected:function(t,e){this.getProperty("selectedFieldIsColorBy")&&e.length>0&&this.colorByFieldChanged(e[0])},colorByFieldChanged:function(t){this.haveCalledUpdateUI=!1,this.setProperty("colorBy",t),this.vectorMapApplied=!1,this.updateUI({colorByFieldChanged:!0})},updateUI:function(){let t=this.getProperty("grid","us"),e=ramaddaGridState.grids[t];if(!e){if(ramaddaGridState.loading[t])return;ramaddaGridState.loading[t]=!0;let e=ramaddaCdn+"/resources/grid_"+t+".json";return void $.getJSON(e,(e=>{ramaddaGridState.grids[t]=e,this.updateUI()})).fail((function(t){console.log("error loading "+e),console.dir(t)}))}let i=this.filterData();if(!i)return;let a=this.getData().getNonGeoFields(),s=this.getFieldById(a,this.getProperty("localeField","state"));null==s&&(s=this.getFieldById(a,"state"));let l=Number.MAX_VALUE,r=Number.MAX_VALUE,o=Number.MIN_VALUE,n=Number.MIN_VALUE,h={};e.forEach((t=>{l=Math.min(l,t.x),o=Math.max(o,t.x),r=Math.min(r,t.y),n=Math.max(n,t.y),h[this.domId("cell_"+t.x+"_"+t.y)]=t}));let d=this.getColorByInfo(i),p=this.getColorByInfo(i,"sparklineColorBy"),g=this.getColorByInfo(i,"strokeColorBy","strokeColorByMap"),c=this.getFieldById(a,this.getProperty("sparklineField")),u=HU.open(TABLE,[WIDTH,"100%"]),y=this.getProperty("cellWidth",this.getProperty("cellSize",0)),m=this.getProperty("cellHeight",y);0==m&&(m=30);let f=this.getProperty("showCellLabel",!0),D=this.getProperty("cellStyle",""),I={};for(let t=1;t<=n;t++){u+=HU.open(TR);for(let e=1;e<=o;e++){let i=this.domId("cell_"+e+"_"+t),a=h[i],s=" id='"+i+"' ",l=HU.css("position","relative","margin","1px","vertical-align","center","text-align","center",HEIGHT,m+"px");y>0&&(l+=HU.css(WIDTH,y+"px"));let r="";a&&(l+="background:#ccc;"+D,c||(s+=" title='"+a.name+"' "),s+=HU.attr(CLASS,"display-mapgrid-cell"),r=HU.div([STYLE,HU.css("padding-left","3px")],f?a.codes[0]:""),a.codes.forEach((t=>I[t]=i)),I[a.name]=i),u+=HU.td([],"<div "+s+" style='"+l+"'>"+r+"</div>")}u+=HU.close(TR)}u+=HU.tr([],HU.td(["colspan",o],"<br>"+HU.div([ID,this.domId(ID_COLORTABLE)]))),u+=HU.close(TABLE),this.setContents(HU.center(u));let T=[],b=this.stateData={},S=0,v=0,x=this.getContents();for(let t=0;t<i.length;t++){let e=i[t],a=e.getData()[s.getIndex()],l=I[a];if(l||(l=I[a.toUpperCase()]),l){if($("#"+l).attr(RECORD_INDEX,t),b[a]||(T.push(a),b[a]={cellId:l,data:[],records:[]}),c){let i=e.getValue(c.getIndex());isNaN(i)||(S=0==t?i:Math.min(S,i),v=0==t?i:Math.max(v,i),b[a].data.push(i),b[a].records.push(e))}if(d.isEnabled()){e.getData()[d.index];let i=d.getColorFromRecord(e),a=x.find("#"+l);a.css("background",i);let s=Utils.getForegroundColor(i);s&&a.css("color",s),a.attr(RECORD_INDEX,t)}if(g.isEnabled()){let t=e.getData()[g.index],i=g.getColor(t,e),a=x.find("#"+l);a.css("border-color",i),a.css("border-width","2px")}}}if(c){let t=0;T.forEach(((e,i)=>{let a=b[e],s=a.cellId+"_inner",l=y;0==l&&(l=$("#"+a.cellId).width());let r=HU.css(WIDTH,l+"px",HEIGHT,m-t+"px","position","absolute","left","0px","top",t+"px"),o=HU.div([ID,s,STYLE,r]);$("#"+a.cellId).append(o),drawSparkLine(this,"#"+s,l,m-t,a.data,a.records,S,v,p)}))}this.makePopups(x.find(".display-mapgrid-cell"),i);let U=this;x.find(".display-mapgrid-cell").click((function(){let t=i[$(this).attr(RECORD_INDEX)];t&&U.propagateEventRecordSelection({record:t})})),c||this.makeTooltips(x.find(".display-mapgrid-cell"),i,null,"${default}"),d.index>=0&&d.displayColorTable(),p.index>=0&&p.displayColorTable()},handleEventRecordSelection:function(t,e){let i=this.getContents();this.selectedCell&&this.selectedCell.css("border",this.selectedBorder);let a=this.recordToIndex[e.record.getId()];Utils.isDefined(a)&&(this.selectedCell=i.find(HU.attrSelect(RECORD_INDEX,a)),this.selectedBorder=this.selectedCell.css("border"),this.selectedCell.css("border","1px solid red"))}})}const ID_BASEMAP="basemap";function RamaddaBasemapDisplay(t,e,i,a){const s=new RamaddaFieldsDisplay(t,e,i,a);defineDisplay(addRamaddaDisplay(this),s,[{label:"Base map properties"},{p:"regionField",ex:""},{p:"valueField",ex:""},{p:"mapFile",ex:"usmap.json|countries.json",d:"usmap.json"},{p:"skipRegions",ex:"Alaska,Hawaii"},{p:"pruneMissing",ex:"true"},{p:"mapBackground",ex:"transparent"},{p:"transforms",ex:"Alaska,0.4,30,-40;Hawaii,2,50,5;Region,scale,offsetX,offsetY"},{p:"prunes",ex:"Alaska,100;Region,maxCount"},{p:"mapWidth",ex:"600"},{p:"mapHeight",ex:"400"},{p:"maxLon"},{p:"minLon"},{p:"maxLat"},{p:"minLat"},{p:"strokeColor"},{p:"strokeWidth"},{p:"missingFill"}],{checkLayout:function(){this.updateUI()},makeMap:function(){},makePoly:function(t){let e=[];return t.forEach((t=>{let i=t[0],a=t[1];isNaN(i)||isNaN(a)||e.push({x:i,y:a})})),e},findValues:function(t,e){if(e[t])return e[t];let i=null;return this.aliasMap[t]?(this.aliasMap[t].forEach((t=>{e[t]&&(i=e[t])})),i):null},makeValueMap:function(t,e){let i=this.getFieldById(null,this.getPropertyRegionField()),a=this.getFieldById(null,this.getPropertyValueField());if(!i)return this.displayError("No region field specified"),null;if(!a&&e)return this.displayError("No value field specified"),null;a&&(null==this.getProperty("colorBy")&&this.setProperty("colorBy",a.getId()),null==this.getProperty("sizeBy")&&this.setProperty("sizeBy",a.getId()));let s={};return this.valueRange={min:null,max:null},this.idToRecord={},t.forEach((t=>{let e=t.getValue(i.getIndex());this.idToRecord[t.getId()]=t;let l=s[e]={record:t};if(a){let e=t.getValue(a.getIndex());l.value=e,this.valueRange.min=null===this.valueRange.min?e:Math.min(e,this.valueRange.min),this.valueRange.max=null===this.valueRange.max?e:Math.max(e,this.valueRange.max)}})),a&&t.forEach((t=>{let e=t.getValue(i.getIndex()),a=s[e],l=(a.value-this.valueRange.min)/(this.valueRange.max-this.valueRange.min);a.percent=l})),s},writeMap:function(t){let e,i=this.getMapWidth(this.getProperty("width",800)),a=HU.css(BACKGROUND,this.getMapBackground("transparent"),WIDTH,HU.getDimension(i));if(!t){e=this.getMapHeight(this.getProperty("height"));let t=this.mapRange.maxLon-this.mapRange.minLon,s=this.mapRange.maxLat-this.mapRange.minLat;e||(e=s/t*i),isNaN(e)&&(e=400),a+=HU.css(HEIGHT,HU.getDimension(e))}return this.mapRange.maxLon=this.getPropertyMaxLon(this.mapRange.maxLon),this.mapRange.minLon=this.getPropertyMinLon(this.mapRange.minLon),this.mapRange.maxLat=this.getPropertyMaxLat(this.mapRange.maxLat),this.mapRange.minLat=this.getPropertyMinLat(this.mapRange.minLat),this.setContents(HU.div([ID,this.domId(ID_BASEMAP),STYLE,a])),isNaN(i)&&(i=this.getContents().width()),[i,e]},makeSvg:function(t,e){return[d3.select("#"+this.domId(ID_BASEMAP)).append("svg").attr("width",t).attr("height",e).append("g"),d3.scaleLinear().domain([this.mapRange.minLon,this.mapRange.maxLon]).range([0,t-0]),d3.scaleLinear().domain([this.mapRange.maxLat,this.mapRange.minLat]).range([0,e-0])]},clearTooltip:function(){this.tooltipDiv&&this.tooltipDiv.style("opacity",0)},makeTooltipDiv:function(){return this.tooltipDiv||(this.tooltipDiv=d3.select("body").append("div").attr("class","ramadda-shadow-box  display-tooltip").style("opacity",0).style("position","absolute").style("background","#fff")),this.clearTooltip(),this.tooltipDiv},addEvents:function(t,e,i){e=e||this.idToRecord,i=i||this.makeTooltipDiv();let a=this,s=this.getProperty("tooltip");t.on("click",(function(t,i){let s=d3.select(this),l=e[s.attr(RECORD_ID)];l&&a.propagateEventRecordSelection({record:l})})),t.on("mouseover",(function(t,i){let l=d3.select(this),r=e[l.attr(RECORD_ID)];if(l.attr("lastStroke",l.attr("stroke")).attr("lastFill",l.attr("fill")),l.attr("stroke",a.getPropertyHighlightStrokeColor("blue")).attr("stroke-width",a.getPropertyHighlightStrokeWidth(1)).attr("fill",a.getPropertyHighlightFill("blue")),!s)return;let o=l.attr("regionName"),n=null;r?(a.propagateEventRecordSelection({highlight:!0,record:r}),n=a.getRecordHtml(r,null,s)):(n=o,console.log("no record found for region:"+o)),n&&(console.log("d:"+d3.event),a.tooltipDiv.html(n).style("left",d3.event.pageX+10+"px").style("top",d3.event.pageY+20+"px"),a.tooltipDiv.style("opacity",1))})),t.on("mouseout",(function(t,e){let i=d3.select(this);i.attr("stroke",i.attr("lastStroke")).attr("fill",i.attr("lastFill")).attr("stroke-width",1),a.tooltipDiv.style("opacity",0)}))},updateUI:function(){if(this.clearTooltip(),this.mapJson)(this.regions||this.makeRegions())&&this.makeMap();else if(!this.gettingFile){this.gettingFile=!0;let t=this.getPropertyMapFile();t.startsWith("/")||t.startsWith("http")||(t=ramaddaCdn+"/resources/"+t);$.getJSON(t,(t=>{this.mapJson=t,this.regionNames=[],this.makeRegions(),this.updateUI()}))}},makeRegions:function(){if(!this.mapJson)return!1;let t=this.getProperty("debug"),e=this.getPropertyPruneMissing(!1),i={};if(null==this.getData())return!1;let a=this.getData().getRecords(),s=this.getFieldById(null,this.getPropertyRegionField());if(null==s)return this.displayError("No region field"),!1;a.forEach((t=>{let e=t.getValue(s.getIndex());i[e]=!0})),this.regions={},this.mapRange={minLon:null,maxLon:null,minLat:null,maxLat:null};let l={},r={};this.getPropertyTransforms("").split(";").map((t=>t.split(","))).forEach((t=>{let e=t[0];l[e]={scale:null!=t[1]?+t[1]:1,dx:null!=t[2]?+t[2]:0,dy:null!=t[3]?+t[3]:0}})),this.getPropertyPrunes("").split(";").map((t=>t.split(","))).forEach((t=>{let e=t[0];r[e]=+t[1]}));let o=(t,e)=>{let i=r[t];if(i>0&&e.length<i)return null;let a=l[t];if(!a)return e;let s=Utils.getBounds(e),o=s.minx+(s.maxx-s.minx)/2,n=s.miny+(s.maxy-s.miny)/2;return e.map((t=>(t[0]=(t[0]-o)*a.scale+o,t[1]=(t[1]-n)*a.scale+n,t[0]+=a.dx,t[1]+=a.dy,t))),e};this.skipRegions=this.getPropertySkipRegions("").split(",").map((t=>t.replace(/_comma_/g,",")));let n=this.mapJson.geojson;return n||(n=this.mapJson.features),this.aliasMap={},n.forEach((a=>{let s=a.properties.name||a.properties.name_long||a.properties.NAME||a.properties.ADMIN,l=[s];if("United States of America"==s&&l.push("United States"),"United Republic of Tanzania"==s&&l.push("Tanzania"),"Democratic Republic of the Congo"==s&&l.push("Democratic Republic of Congo"),"Czech Rep."==s&&l.push("Czech Republic"),"Bosnia and Herz."==s&&l.push("Bosnia and Herzegovina"),this.aliasMap[s]=l,a.properties.ISO_A3&&l.push(a.properties.ISO_A3),a.properties.STUSPS&&l.push(a.properties.STUSPS),a.properties.STATEFP&&l.push(a.properties.STATEFP),!a.geometry)return void(t&&console.log(s+" no geometry"));t&&console.log("region:"+s);let r=!0;if(l.forEach((t=>{this.skipRegions.includes(t)&&(r=!1)})),!r)return;if(r=!1,l.forEach((t=>{i[t]&&(r=!0)})),r||this.handleWarning("Missing data for map region:"+s),e&&!r)return;this.regionNames.push(s);let n=a.geometry.coordinates,h={name:s,aliases:l,polygons:[],bounds:null};l.forEach((t=>{this.regions[t]=h})),"MultiPolygon"==a.geometry.type?n.forEach((t=>{t.forEach((t=>{(t=o(s,t))&&h.polygons.push(t)}))})):n.forEach((t=>{h.polygons.push(o(s,t))})),h.polygons.forEach((t=>{t.forEach((t=>{let e=t[0],i=t[1];isNaN(e)||isNaN(i)||(this.mapRange.minLon=null===this.mapRange.minLon?e:Math.min(this.mapRange.minLon,e),this.mapRange.maxLon=null===this.mapRange.maxLon?e:Math.max(this.mapRange.maxLon,e),this.mapRange.minLat=null===this.mapRange.minLat?i:Math.min(this.mapRange.minLat,i),this.mapRange.maxLat=null===this.mapRange.maxLat?i:Math.max(this.mapRange.maxLat,i))}))}));let d=null;h.polygons.forEach((t=>{d=Utils.mergeBounds(d,Utils.getBounds(t))})),h.bounds=d})),!0}})}function RamaddaMapchartDisplay(t,e,i){const a=new RamaddaBasemapDisplay(t,e,DISPLAY_MAPCHART,i);defineDisplay(addRamaddaDisplay(this),a,[{label:"Map chart Properties"},{p:"maxLayers",ex:"10"},{p:"translateX",ex:"0"},{p:"translateY",ex:"0"},{p:"skewX",ex:"-10"},{p:"skewY",ex:"0"},{p:"rotate",ex:"10"},{p:"scale",ex:"0"},{p:"fillColor",ex:"red"},{p:"blur",ex:"4"}],{makeMap:function(){let t=this.filterData();if(!t)return;let e=this.makeValueMap(t,!0);if(!e)return;let i=this.getData().getRecords(),a=this.getPropertyPruneMissing(!1),s=+this.getPropertyMaxLayers(20);Object.keys(e).forEach((t=>{let i=e[t];i.layers=Math.round(i.percent*(s-1))+1})),this.colorBy=this.getColorByInfo(i);let[l,r]=this.writeMap(),[o,n,h]=this.makeSvg(l,r);SU.transform(o,SU.translate(l/2,r/2),SU.scale(.9),SU.rotate(this.getPropertyRotate(0)),SU.translate(-l/2,-r/2),SU.translate(this.getPropertyTranslateX(30),this.getPropertyTranslateY(0)),SU.skewX(this.getPropertySkewX(-10)),SU.scale(this.getPropertyScale(1)));o.append("defs");SU.makeBlur(o,"blur",this.getPropertyBlur(3));for(let t=0;t<s;t++)this.regionNames.forEach((i=>{let s=this.findValues(i,e),l=1,r=NaN,d=null==s,p=null;if(d){if(a)return;if(l=1,t>0)return}else l=s.layers,r=s.value,p=s.record;let g=p?p.getId():"";Utils.isDefined(l)||(l=1),t>l||this.regions[i].polygons.forEach((e=>{let a=HtmlUtils.getUniqueId(),s=this.makePoly(e),p="transparent";if(d?(p="#ccc",lineColor="#000"):t==l-1?(p=this.colorBy.getColor(r),lineColor=Utils.pSBC(.1,p)):lineColor=Utils.pSBC(-.3,this.colorBy.getColor(r)),d)return void o.selectAll(i+a).data([s]).enter().append("polygon").attr("points",(function(e){return e.map((e=>[-t+n(e.x),-t+h(e.y)].join(","))).join(" ")})).attr("regionName",i).attr("fill","#ccc").attr("stroke-width",1).attr("stroke","black");0==t&&o.selectAll(i+a).data([s]).enter().append("polygon").attr("points",(function(e){return e.map((e=>[-t+n(e.x),-t+h(e.y)].join(","))).join(" ")})).attr("stroke-width",3).attr("stroke","black").style("filter","url(#blur)");let c=o.selectAll(i+a).data([s]).enter().append("polygon").attr("points",(function(e){return e.map((e=>[-t+n(e.x),-t+h(e.y)].join(","))).join(" ")})).attr("fill",p).attr("opacity",1).attr("stroke",lineColor).attr("stroke-width",1).style("cursor","pointer").attr(RECORD_ID,g);this.addEvents(c)}))}));this.colorBy.displayColorTable()}})}function RamaddaMaparrayDisplay(t,e,i){const a=new RamaddaBasemapDisplay(t,e,DISPLAY_MAPARRAY,i);defineDisplay(addRamaddaDisplay(this),a,[{label:"Map array properties"},{p:"blockWidth",ex:""},{p:"sortByValue",ex:"true"},{p:"fillColor",ex:"red"},{p:"showValue",ex:"true"}],{makeMap:function(){let t=this.filterData();if(!t)return;let e=this.makeValueMap(t,!0);if(!e)return;let i=this.getData().getRecords();this.colorBy=this.getColorByInfo(i);let[a,s]=this.writeMap(!0),l=this.getPropertyBlockWidth(75),r=l,o=this.getPropertyPruneMissing(!0),n=this.regionNames;this.getPropertySortByValue(!0)?n.sort(((t,i)=>e[t].value-e[i].value)):n.sort();let h="";n.forEach(((t,e)=>{h+=HU.div([CLASS,"display-maparray-block"],HU.div([CLASS,"display-maparray-header"],t)+HU.div([ID,this.domId("mapblock_"+e),CLASS,"display-maparray-map",STYLE,HU.css(WIDTH,l+"px",HEIGHT,r+"px")])+HU.div([ID,this.domId("maplabel_"+e),"display-maparray-label"]))})),this.jq(ID_BASEMAP).html(h+"<p>");let d=this.getPropertyShowValue(!0);n.forEach(((t,i)=>{let a,s,n=this.regions[t],h=d3.select("#"+this.domId("mapblock_"+i)).append("svg").attr("width",l).attr("height",r).append("g"),p=n.bounds.getWidth(),g=n.bounds.getHeight();p>g?(a=d3.scaleLinear().domain([n.bounds.minx,n.bounds.maxx]).range([0,l-5]),s=d3.scaleLinear().domain([n.bounds.maxy,n.bounds.miny]).range([0,g/p*r-5])):(a=d3.scaleLinear().domain([n.bounds.minx,n.bounds.maxx]).range([0,p/g*l-5]),s=d3.scaleLinear().domain([n.bounds.maxy,n.bounds.miny]).range([0,r-5]));let c=e[t],u=NaN,y=null==c,m=null;if(y){if(o)return}else u=c.value,m=c.record,d&&this.jq("maplabel_"+i).html(u);let f=m?m.getId():"";n.polygons.forEach((e=>{let i=HtmlUtils.getUniqueId(),l=this.makePoly(e),r="transparent";if(y?(r="#ccc",lineColor="#000"):(r=this.colorBy.getColor(u),lineColor="#ccc"),y)return void h.selectAll(t+i).data([l]).enter().append("polygon").attr("points",(function(t){return t.map((t=>[-layer+a(t.x),-layer+s(t.y)].join(","))).join(" ")})).attr("fill","#ccc").attr("stroke-width",1).attr("stroke","black");let o=h.selectAll(t+i).data([l]).enter().append("polygon").attr("points",(function(t){return t.map((t=>[+a(t.x),+s(t.y)].join(","))).join(" ")})).attr("fill",r).attr("opacity",1).attr("stroke",lineColor).attr("stroke-width",1).style("cursor","pointer").attr(RECORD_ID,f);this.addEvents(o)}))})),this.colorBy.displayColorTable()}})}function RamaddaMapshrinkDisplay(t,e,i){const a=new RamaddaBasemapDisplay(t,e,DISPLAY_MAPSHRINK,i);defineDisplay(addRamaddaDisplay(this),a,[{label:"Map shrink Properties"}],{makeMap:function(){let t=this.filterData();if(!t)return;let e=this.getData().getRecords(),i=this.getPropertyPruneMissing(!1),a=this.makeValueMap(t,!0);if(!a)return;let s=new SizeBy(this,e);this.colorBy=this.getColorByInfo(e);let[l,r]=this.writeMap(),[o,n,h]=this.makeSvg(l,r);for(let t=0;t<2;t++)this.regionNames.forEach((e=>{let l=this.findValues(e,a),r=NaN,d=null==l,p=null;if(d){if(i)return;if(t>0)return}else r=l.value,p=l.record;let g=p?p.getId():"";this.regions[e].polygons.forEach((i=>{let a=HtmlUtils.getUniqueId(),l=this.makePoly(i),p="red",c="";if(lineColor="#000",0==t)p="#fff";else{lineColor="transparent",p=this.colorBy.getColor(r);let t=Utils.getBounds(i).getCenter(),e=function(t,e){return percent=t,percent};s.getSizeFromValue(r,e),c=SU.translate(n(t.x),h(t.y))+SU.scale(percent)+SU.translate(-n(t.x),-h(t.y))}if(d)return void o.selectAll(e+"base"+a).data([l]).enter().append("polygon").attr("points",(function(e){return e.map((e=>[-t+n(e.x),-t+h(e.y)].join(","))).join(" ")})).attr("fill","#ccc").attr("stroke-width",1).attr("stroke","black");0==t&&o.selectAll(e+"base"+a).data([l]).enter().append("polygon").attr("points",(function(e){return e.map((e=>[-t+n(e.x),-t+h(e.y)].join(","))).join(" ")})).attr("stroke-width",1).attr("stroke","black").attr("transform",c);let u=o.selectAll(e+a).data([l]).enter().append("polygon").attr("points",(function(e){return e.map((e=>[-t+n(e.x),-t+h(e.y)].join(","))).join(" ")})).attr("fill",p).attr("opacity",1).attr("stroke",lineColor).attr("stroke-width",1).attr("transform",c).style("cursor","pointer").attr(RECORD_ID,g);1==t&&this.addEvents(u)}))}));this.colorBy.displayColorTable()}})}function RamaddaMapimagesDisplay(t,e,i){const a=new RamaddaBasemapDisplay(t,e,DISPLAY_MAPIMAGES,i);defineDisplay(addRamaddaDisplay(this),a,[{label:"Map Images Properties"},{p:"imageField",ex:""}],{getHeightForStyle:function(t){return null},addMacroAttributes:function(t,e,i){if(a.addMacroAttributes.call(this,t,e,i),!this.imageField)return;let s=e[this.imageField.getIndex()],l=[],r=t.getAttributes("imageField_image"),o=r?r.width:null;o?(l.push("width"),l.push(o)):this.getProperty("imageWidth")?(l.push("width"),l.push(this.getProperty("imageWidth"))):(l.push("width"),l.push("100%")),l.push("style"),l.push("vertical-align:top");let n=HU.image(s,l);i.imageField_image=n,i.imageField_url=s},makeMap:function(){let t=this.filterData();if(!t)return;if(this.imageField=this.getFieldById(null,this.getPropertyImageField()),null==this.imageField&&(this.imageField=this.getFieldByType(null,"image")),null==this.imageField)return void this.displayError("No image fields");let e=this.makeValueMap(t);if(!e)return;Object.keys(e).forEach((t=>{let i=e[t];i.image=i.record.getValue(this.imageField.getIndex())}));let[i,a]=this.writeMap(),[s,l,r]=this.makeSvg(i,a);var o=s.append("defs");this.regionNames.forEach(((t,i)=>{let a=this.findValues(t,e),n=null!=a?a.record.getId():"",h=Utils.cleanId(t);this.regions[t].polygons.forEach((e=>{let i=HtmlUtils.getUniqueId();null!=a&&o.append("svg:pattern").attr("id","bgimage"+i).attr("x","1").attr("y","1").attr("width","100%").attr("height","100%").attr("patternContentUnits","objectBoundingBox").append("svg:image").attr("xlink:href",a.image).attr("preserveAspectRatio","none").attr("width",1).attr("height",1).attr("x","0").attr("y","0");let d=s.selectAll(h+"base"+i).data([this.makePoly(e)]).enter().append("polygon").attr("regionName",t).attr("points",(function(t){return t.map((t=>[l(t.x),r(t.y)].join(","))).join(" ")})).attr(RECORD_ID,n).attr("stroke-width",this.getPropertyStrokeWidth(1)).attr("stroke",this.getPropertyStrokeColor("#000"));null!=a?d.style("fill","url(#bgimage"+i+")"):d.style("fill",this.getPropertyMissingFill("#fff")),this.addEvents(d)}))}))}})}function CollisionInfo(t,e,i){$.extend(this,{dot:null,display:t,roundPoint:i,visible:t.getPropertyCollisionFixed(),dot:null,numRecords:e,records:[],addLines:!1,lines:[],points:[],addRecord:function(t){this.records.push(t)},addLine:function(t){this.lines.push(t)},checkLines:function(){this.addedLines||(this.addedLines=!0,this.display.addFeatures(this.lines,!0),this.display.addFeatures(this.points,!1))},createDot:function(t){let e=this.display.getCollisionTooltip(),i=null==e?null:t=>{let i="";return this.records.forEach((t=>{i+=HU.div([STYLE,HU.css("border-bottom","1px solid #ccc")],this.display.getRecordHtml(t,null,e))})),i},a=this.display.getCollisionIcon(),s=this.display.getCollisionIconSize(16);return this.dot=a?this.display.map.createMarker("dot-"+t,[this.roundPoint.x,this.roundPoint.y],a,"","",null,s,null,null,null,null,!1):this.display.map.createPoint("dot-"+t,this.roundPoint,this.getCollisionDotStyle(this),null,i),this.dot.collisionInfo=this,this.dot},dotSelected:function(t){this.display.getCollisionFixed()||this.setVisible(!this.visible)},styleCollisionDot:function(t){$.extend(t.style,this.getCollisionDotStyle(t.collisionInfo))},addPoints:function(t){t.forEach((t=>this.points.push(t)))},getCollisionDotStyle:function(t){let e=this.display.getCollisionFixed(),i=this.display.getProperty("collisionDotColor","blue"),a=this.display.getProperty("collisionDotRadius",6);if(!e){if(this.display.getPropertyCollisionScaleDots(!1)){let e=t.numRecords/16;e>1&&(a=Math.min(a*e,32))}i=t.visible?this.display.getProperty("collisionDotColorOn",i):this.display.getProperty("collisionDotColorOff",i)}return{fillColor:i,pointRadius:a}},setVisible:function(t){this.visible=t,this.styleCollisionDot(this.dot),this.dot.layer.drawFeature(this.dot,this.dot.style),this.checkLines(),this.lines.forEach((t=>{t.featureVisible=this.visible,this.display.map.checkFeatureVisible(t,!0)})),this.records.forEach((t=>{let e=this.display.displayInfo[t.getId()];e&&e.features.forEach((t=>{t.featureVisible=this.visible,this.display.map.checkFeatureVisible(t,!0)}))}))}}),this.visible&&this.checkLines()}const DISPLAY_EDITABLEMAP="editablemap";function RamaddaEditablemapDisplay(t,e,i){OpenLayers.Handler.ImageHandler=OpenLayers.Class(OpenLayers.Handler.RegularPolygon,{initialize:function(t,e,i){OpenLayers.Handler.RegularPolygon.prototype.initialize.apply(this,arguments),this.display=i.display},finalize:function(){if(this.theImage=this.image,this.image=null,this.imageBounds){let t=this.imageBounds.width/this.imageBounds.height,e=this.feature.geometry.components[0].components,i=e[0],a=e[1],s=e[2],l=e[3],r=a.x-i.x,o=i.y-l.y;s.x=a.x=i.x+t*(i.y-l.y),r=a.x-i.x,o=i.y-l.y}OpenLayers.Handler.RegularPolygon.prototype.finalize.apply(this,arguments),setTimeout((()=>{this.display.clearCommands();let t=this.display.myLayer.features[this.display.myLayer.features.length-1];t.style.strokeColor="transparent",this.display.myLayer.redraw(t)}),500)},move:function(t){if(!this.checkingImageSize){this.checkingImageSize=!0;const t=new Image;let e=this;t.onload=function(){e.imageBounds={width:this.width,height:this.height}},t.src=this.style.imageUrl}OpenLayers.Handler.RegularPolygon.prototype.move.apply(this,arguments);let e=this.feature.geometry.getBounds();this.image&&this.display.map.removeLayer(this.image);let i=this.feature.geometry.components[0],a=i.components,s=a[0],l=a[1],r=(a[2],a[3]),o=(l.x,s.x,s.y,r.y,this.display.map.transformProjBounds(e));if(this.imageBounds){let e=this.imageBounds.width/this.imageBounds.height;t.shiftKey||(o.right=e*(o.top-o.bottom)+o.left)}this.lastBounds=o,this.image=this.display.map.addImageLayer("","","",this.style.imageUrl,!0,o.top,o.left,o.bottom,o.right),this.image.setOpacity(this.style.imageOpacity)}});const s="message",l="listdelete",r="listok",o="listcancel",n="delete",h="apply",d="cancel",p="new_file",g="menu_file",c="menu_edit",u="deleteall",y="toback",m="tofront",f="copy",D="paste",I="commands",T="clear",b="list",S="list",v="properties",x="save",U="download",L="selector",E="edit",P="mover",C="resize",A="reshape",w=new RamaddaBaseMapDisplay(t,e,DISPLAY_EDITABLEMAP,i);RamaddaUtil.inherit(this,w),addRamaddaDisplay(this),this.defineSizeByProperties(),this.map=this.getProperty("theMap");displayDefineMembers(this,[{label:"Editable Map Properties"},{p:"displayOnly",d:!1},{p:"strokeColor",d:"blue"},{p:"strokeWidth",d:2},{p:"pointRadius",d:10},{p:"externalGraphic",d:"/map/marker-blue.png"},{p:"fontSize",d:"16px"},{p:"fontWeight",d:"normal"},{p:"fontFamily",d:"'Open Sans', Helvetica Neue, Arial, Helvetica, sans-serif"},{p:"imageOpacity",d:1}],{commands:[],myLayer:[],glyphs:{},selected:{},getMap:function(){return this.map},handleEvent:function(t,e){},setCommand:function(t,e){e=e||{},this.clearCommands(),this.command=t;let i=this.glyphMap[t];this.commands.forEach((t=>{t.deactivate()})),t&&(this.jq("new_"+t).addClass("ramadda-display-editablemap-command-active"),this.commands.every((a=>{if(a.name!=t)return!0;if(i){let t=new OpenLayers.StyleMap({default:{}}),s={};if($.extend(s,i.getStyle()),i.isImage()){let t=e.url||prompt("Image URL:",this.lastImageUrl);if(!t)return;this.lastImageUrl=t,s.imageUrl=this.lastImageUrl}else if(i.isLabel()){let t=prompt("Label text:",this.lastText);if(!t)return;t=t.replace(/\\n/g,"\n"),this.lastText=t,s.label=t}a.handler.style=s,a.handler.layerOptions.styleMap=t}let s=i?"New "+i.label:a.message;return s=s||"",this.showCommandMessage(s),a.activate(),!1})))},clearCommands:function(){this.showCommandMessage("");let t=this.jq(I).find(".ramadda-clickable");t.removeClass("ramadda-display-editablemap-command-active"),t.each((function(){$(this).attr("selected",!1)})),this.commands.forEach((t=>{t.deactivate()})),this.command=null,this.myLayer.redraw()},addFeatureList:function(){let t="<table width=100%>";t+="<tr title='Shift click to edit' valign=top><td style='padding:5px;'><b>Type</b></td></tr>",this.featureListMap={},this.myLayer.features.forEach(((e,i)=>{if(!e.type)return;this.featureListMap[i]=e;let a=e.style;t+=HU.openTag("tr",[CLASS,"ramadda-clickable ramadda-display-editablemap-feature","feature-idx",i]),t+=HU.td([TITLE,"Shift click to edit",STYLE,HU.css("padding","5px")],e.type);let s="";e.style.imageUrl?s+=HU.href(e.style.imageUrl,e.style.imageUrl,["target","_image"]):"label"==e.type?s+=a.label:s+=JSON.stringify(a),t+=HU.td([TITLE,"Shift click to edit",STYLE,HU.css("padding","5px")],s),t+="</tr>"})),t+="</table>";let e=this;this.jq(S).html(t),this.jq(S).find(".ramadda-display-editablemap-feature").click((function(t){let i="ramadda-display-editablemap-feature-selected",a=e.featureListMap[$(this).attr("feature-idx")];t.shiftKey&&a?e.doProperties(a.style,e.getFeaturePropertyApply(),a):$(this).hasClass(i)?($(this).removeClass(i),a&&e.featureSelector.clickoutFeature(a)):($(this).addClass(i),a&&e.featureSelector.clickFeature(a))}))},listFeatures:function(){let t=()=>{this.listDialog&&(this.listDialog.hide(),this.listDialog.remove()),this.listDialog=null};t();let e="";e+=HU.center(HU.b("Features")),e+=HU.div([ID,this.domId(S),STYLE,HU.css("margin-bottom","10px","border","1px solid #ccc","max-height","300px","max-width","600px","overflow-x","auto","overflow-y","auto")],""),e+=HU.div([ID,this.domId(l),CLASS,"display-button"],"Delete Selected"),e+=SPACE2,e+=HU.div([ID,this.domId(r),CLASS,"display-button"],"Ok"),e+=SPACE2,e+=HU.div([ID,this.domId(o),CLASS,"display-button"],"Cancel"),e=HU.div([CLASS,"wiki-editor-popup"],e);this.listDialog=HU.makeDialog({content:e,anchor:this.jq(g),title:"Features",header:!0,draggable:!0,remove:!1});this.addFeatureList(),this.jq(l).button().click((()=>{let t=this,e=[];this.jq(S).find(".ramadda-display-editablemap-feature-selected").each((function(){let i=t.featureListMap[$(this).attr("feature-idx")];i&&e.push(i)})),this.removeImages(e),this.setClipboard(e),this.myLayer.removeFeatures(e),this.addFeatureList()})),this.jq(r).button().click((()=>{let e=[];this.myLayer.features.forEach(((t,i)=>{this.jq("cbx"+i).is(":checked")&&e.push(t)})),this.myLayer.removeFeatures(e),t(),this.listDialog=null})),this.jq(o).button().click((()=>{t()}))},addFeatures:function(t){let e=this.myLayer;e.addFeatures(t),t.forEach((t=>{t.layer=e}))},addControl:function(t,e,i){return i.name=t,i.message=e,this.map.getMap().addControl(i),this.commands.push(i),i},pasteCount:0,doPaste:function(t){if(!this.clipboard)return;let e=this.clipboard.map((t=>{(t=t.clone()).style&&(t.style=$.extent({},t.style))}));for(let t=0;t<e.length;t++)e[t].type=this.clipboard[t].type;let i=this.map.getMap().getExtent().getHeight();this.pasteCount++;let a=.05*this.pasteCount*i;e.forEach((t=>{t.geometry.move(a,-a),this.checkImage(t)})),this.myLayer.addFeatures(e)},getFeaturePropertyApply:function(){return(t,e)=>{e.forEach((e=>{if("labelSelect"==e)return;let i=this.jq(e).val();"label"==e&&(i=i.replace(/\\n/g,"\n")),t.style[e]=i})),t.style.imageUrl&&(t.image&&t.image.setOpacity(t.style.imageOpacity),this.checkImage(t)),this.myLayer.redraw()}},doEdit:function(t){if(!t){if(!this.myLayer.selectedFeatures)return;if(0==this.myLayer.selectedFeatures.length)return;t=this.myLayer.selectedFeatures[0]}if(!t)return;t.style,HU.div([STYLE,HU.css("margin","8px")],"Feature: "+t.type);this.myLayer.redraw(t);let e=this.getFeaturePropertyApply();t.image&&Utils.isDefined(t.image.opacity)&&(t.style.imageOpacity=t.image.opacity),this.doProperties(t.style,e,t)},makeMenu:function(t){return HU.div([CLASS,"wiki-editor-popup"],t)},menuItem:function(t,e){return HU.div([ID,t,CLASS,"ramadda-clickable"],e)},doProperties:function(t,e,i){let s,l="";l+=HU.formTable();let r={};if(t){s=[];let e=t.imageUrl;for(a in t)e&&"imageUrl"!=a&&"imageOpacity"!=a||(s.push(a),r[a]=t[a])}else s=["strokeColor","strokeWidth","pointRadius","externalGraphic","fontSize","fontWeight","fontFamily"];s.forEach((t=>{if("labelSelect"==t)return;let e,i=t;if(i=i.replace("stroke","stroke ").replace("fill","fill "),i=Utils.makeLabel(i),"externalGraphic"==t){let i=["/map/marker-blue.png","/map/marker-gold.png","/map/marker-green.png","/map/marker.png","/map/POI.png","/map/arts.png","/map/bar.png","/map/binocular.png","/map/blue-dot.png","/map/blue-pushpin.png","/map/building.png","/map/burn.png","/map/bus.png","/map/cabs.png","/map/calendar.png","/map/camera.png","/map/campfire.png","/map/campground.png","/map/car.png","/map/caution.png","/map/coffeehouse.png","/map/convienancestore.png","/map/cycling.png","/map/dollar.png","/map/drinking_water.png","/map/earthquake.png","/map/electronics.png","/map/envelope.png","/map/euro.png","/map/fallingrocks.png","/map/ferry.png","/map/film.png","/map/firedept.png","/map/fishing.png","/map/flag.png","/map/gas.png","/map/glass.png","/map/globe.png","/map/golfer.png","/map/green-dot.png","/map/grn-pushpin.png","/map/grocerystore.png","/map/hammer.png","/map/helicopter.png","/map/hiker.png","/map/home.png","/map/homegardenbusiness.png","/map/horsebackriding.png","/map/hospitals.png","/map/hotsprings.png","/map/info.png","/map/info_circle.png","/map/lodging.png","/map/ltblu-pushpin.png","/map/ltblue-dot.png","/map/man.png","/map/marina.png","/map/mechanic.png","/map/motorcycling.png","/map/mountain.png","/map/movies.png","/map/orange-dot.png","/map/paper-plane.png","/map/parkinglot.png","/map/partly_cloudy.png","/map/pharmacy-us.png","/map/phone.png","/map/picnic.png","/map/pink-dot.png","/map/pink-pushpin.png","/map/plane.png","/map/police.png","/map/postoffice-us.png","/map/purple-dot.png","/map/purple-pushpin.png","/map/question.png","/map/rail.png","/map/rainy.png","/map/rangerstation.png","/map/realestate.png","/map/recycle.png","/map/red-dot.png","/map/red-pushpin.png","/map/restaurant.png","/map/sailing.png","/map/salon.png","/map/shopping-basket.png","/map/shopping.png","/map/ski.png","/map/smiley.png","/map/snack_bar.png","/map/snowflake_simple.png","/map/sportvenue.png","/map/star.png","/map/sticky-note.png","/map/subway.png","/map/sunny.png","/map/swimming.png","/map/toilets.png","/map/trail.png","/map/tram.png","/map/tree.png","/map/truck.png","/map/volcano.png","/map/water.png","/map/waterfalls.png","/map/wheel_chair_accessible.png","/map/woman.png","/map/yellow-dot.png","/map/yen.png","/map/ylw-pushpin.png"],s="",l=r[t];null===l&&(l=this.getExternalGraphic()),i.forEach((t=>{let e=ramaddaBaseUrl+t,i=t.replace("/map/",""),a=["value",t,"data-class","ramadda-select-icon","data-style","","img-src",e];t==l&&a.push("selected","true"),s+=HU.tag("option",a," "+i)}));var a=HU.openTag("select",[ID,this.domId("externalGraphic")]);a+=s,e=a+=HU.closeTag("select")}else{let i=r[t];if(!Utils.isDefined(i)){let e="get"+t[0].toUpperCase()+t.substring(1);i=e?this[e]():this.getProperty(t)}let a="20";"label"==t?(a="80",e=HU.textarea("",i,[ID,this.domId(t),"rows",5,"cols",60])):("strokeWidth"==t||"pointRadius"==t||"fontSize"==t||"fontWeight"==t||"imageOpacity"==t?a="4":"fontFamily"==t?a="60":"imageUrl"==t&&(a="80"),e=HU.input("",i,[ID,this.domId(t),"size",a]))}l+=HU.formEntry(i+":",e)})),l+="</table>",l=HU.div([STYLE,HU.css("max-height","350px","overflow-y","scroll","margin-bottom","5px")],l),l+="<center>",l+=HU.div([ID,this.domId(h),CLASS,"display-button"],"Apply"),l+=SPACE2,l+=HU.div([ID,this.domId("ok"),CLASS,"display-button"],"Ok"),l+=SPACE2,i&&(l+=HU.div([ID,this.domId(n),CLASS,"display-button"],"Delete"),l+=SPACE2),l+=HU.div([ID,this.domId(d),CLASS,"display-button"],"Cancel"),l=HU.div([CLASS,"wiki-editor-popup"],l),l+="</center>",this.map.ignoreKeyEvents=!0;let o=HU.makeDialog({content:l,anchor:this.jq(g),title:"Map Properties",header:!0,draggable:!0,remove:!1});this.jq("externalGraphic").iconselectmenu().iconselectmenu("menuWidget").addClass("ui-menu-icons ramadda-select-icon"),null==e&&(e=()=>{let t={};s.forEach((e=>{let i=this.jq(e).val();this.setProperty(e,i),"externalGraphic"==e&&(i=ramaddaBaseUrl+i),t[e]=i})),this.glyphs.forEach((e=>{e.applyStyle(t)}))});let p=()=>{this.map.ignoreKeyEvents=!1,o.hide(),o.remove()};i&&this.jq(n).button().click((()=>{this.myLayer.removeFeatures([i]),p()})),this.jq("ok").button().click((()=>{e(i,s),p()})),this.jq(h).button().click((()=>{e(i,s)})),this.jq(d).button().click((()=>{p()}))},doSaveAs:function(){let t=prompt("New entry name:");if(!t)return;let e={name:t,type:"geo_editable_json",group:this.getProperty("parentEntryId"),authtoken:this.getProperty("authToken"),response:"json"},i=ramaddaBaseUrl+"/entry/change";$.post(i,e,(t=>{if(t.entries&&t.entries.length)return this.setProperty("entryId",t.entries[0]),this.doSave(),void this.showMessage("Saved");console.log(t),t.error?this.showMessage(t.error):this.showMessage(t.message)})).fail((function(t,e,i){console.log("fail:"+result),this.showMessage("failed to save map:"+e+" "+i)}))},doSave:function(){let t=this;if("geo_editable_json"!=this.getProperty("thisEntryType"))return void this.showMessage("Entry is not the correct type");let e=this.makeJson(),i=ramaddaBaseUrl+"/entry/setfile";var a={entryid:this.getProperty("entryId"),file:e};$.post(i,a,(e=>{e.error?t.showMessage(e.error):t.showMessage(e.message)})).fail((function(e,i,a){t.showMessage("failed to save map:"+i+" "+a)}))},doDownload:function(){let t=this.makeJson();console.log(JSON.stringify(t,null,2)),Utils.makeDownloadFile("map.json",t)},makeJson:function(){let t=[];return this.myLayer.features.forEach((e=>{if(!e.type)return;let i=e.geometry,a={type:e.type,points:[]};e.style&&(e.image&&Utils.isDefined(e.image.opacity)&&(e.style.imageOpacity=e.image.opacity),a.style=e.style),t.push(a);let s=i.getVertices();if(a.geometryType=i.CLASS_NAME,e.image){let t=e.geometry.getBounds(),i=this.map.transformProjBounds(t);a.points.push({latitude:i.top,longitude:i.left}),a.points.push({latitude:i.top,longitude:i.right}),a.points.push({latitude:i.bottom,longitude:i.right}),a.points.push({latitude:i.bottom,longitude:i.left}),a.points.push({latitude:i.top,longitude:i.left})}else s.forEach((t=>{let e=t.clone().transform(this.map.sourceProjection,this.map.displayProjection);a.points.push({latitude:e.y,longitude:e.x})}))})),JSON.stringify(t,null,2)},showFileMenu:function(t){let e="";Utils.isAnonymous()||(e+=this.menuItem(this.domId(x),"Save")),e+=this.menuItem(this.domId(U),"Download"),e+=this.menuItem(this.domId(v),"Set Default Properties"),e+=this.menuItem(this.domId(b),"List Features"),e+=this.menuItem(this.domId(T),"Clear Commands"),e=this.makeMenu(e),this.dialog=HU.makeDialog({content:e,anchor:t});let i=this;this.jq("navigate").click((function(){HtmlUtils.hidePopupObject(),i.setCommand(null)})),this.jq(x).click((function(){HtmlUtils.hidePopupObject(),i.doSave()})),this.jq("saveas").click((function(){HtmlUtils.hidePopupObject(),i.doSaveAs()})),this.jq(U).click((function(){HtmlUtils.hidePopupObject(),i.doDownload()})),this.jq(v).click((function(){HtmlUtils.hidePopupObject(),i.doProperties()})),this.jq(T).click((function(){HtmlUtils.hidePopupObject(),i.clearCommands()})),this.jq(b).click((function(){HtmlUtils.hidePopupObject(),i.listFeatures()}))},showNewMenu:function(t){let e="";this.glyphs.forEach((t=>{e+=this.menuItem(this.domId("menunew_"+t.type),"New "+t.label)})),e=this.makeMenu(e),this.dialog=HU.makeDialog({content:e,anchor:t});let i=this;this.glyphs.forEach((t=>{this.jq("menunew_"+t.type).click((function(){HtmlUtils.hidePopupObject(),i.setCommand(t.type)}))}))},showEditMenu:function(t){let e=this.menuItem(this.domId("cut"),"Cut")+this.menuItem(this.domId(f),"Copy")+this.menuItem(this.domId(D),"Paste")+HU.div([CLASS,"ramadda-menu-divider"])+this.menuItem(this.domId(L),"Select")+HU.div([CLASS,"ramadda-menu-divider"])+this.menuItem(this.domId(P),"Move")+this.menuItem(this.domId(A),"Reshape")+this.menuItem(this.domId(C),"Resize")+HU.div([CLASS,"ramadda-menu-divider"])+this.menuItem(this.domId(m),"To Front")+this.menuItem(this.domId(y),"To Back")+HU.div([CLASS,"ramadda-menu-divider"])+this.menuItem(this.domId(E),"Edit Properties")+HU.div([CLASS,"ramadda-menu-divider"])+this.menuItem(this.domId(u),"Delete All");e=this.makeMenu(e),this.dialog=HU.makeDialog({content:e,anchor:t});let i=[E,L,P,A,C],a=this;this.jq(u).click((function(){HtmlUtils.hidePopupObject(),a.doDeleteAll()})),this.jq("cut").click((function(){HtmlUtils.hidePopupObject(),a.doCut()})),this.jq(f).click((function(){HtmlUtils.hidePopupObject(),a.doCopy()})),this.jq(D).click((function(){HtmlUtils.hidePopupObject(),a.doPaste()})),this.jq(m).click((function(){HtmlUtils.hidePopupObject(),a.toFront(!0)})),this.jq(y).click((function(){HtmlUtils.hidePopupObject(),a.toFront(!1)})),i.forEach((t=>{this.jq(t).click((function(){HtmlUtils.hidePopupObject(),L==t&&(a.myLayer.selectedFeatures=[]),a.setCommand(t)}))}))},setClipboard:function(t){this.clipboard=t?t.map((t=>t)):null,this.pasteCount=0},removeImages:function(t){t&&t.forEach((t=>{t.image&&(this.map.removeLayer(t.image),t.image=null)}))},clearBounds:function(t){t.clearBounds&&t.clearBounds(),t.components&&t.components.forEach((t=>{this.clearBounds(t)}))},checkImage:function(t){if(!t.style||!t.style.imageUrl)return;t.image&&Utils.isDefined(t.image.opacity)&&(t.style.imageOpacity=t.image.opacity),this.removeImages([t]),this.clearBounds(t.geometry);let e=t.geometry.getBounds(),i=this.map.transformProjBounds(e);t.image=this.map.addImageLayer("","","",t.style.imageUrl,!0,i.top,i.left,i.bottom,i.right),Utils.isDefined(t.style.imageOpacity)&&t.image.setOpacity(t.style.imageOpacity)},toFront:function(t){if(!this.myLayer.selectedFeatures)return;let e=this.myLayer.selectedFeatures,i=this.myLayer.features;e.forEach((e=>{const a=i.indexOf(e);console.log("index:"+a),a>-1&&(i.splice(a,1),t?i.push(e):i.unshift(e))})),this.myLayer.redraw()},doCut:function(){if(this.myLayer.selectedFeatures){this.removeImages(this.myLayer.selectedFeatures);let t=this.myLayer.selectedFeatures.map((t=>t));this.setClipboard(t),this.myLayer.removeFeatures(t)}},doDeleteAll:function(){window.confirm("Are you sure you want to delete all map features?")&&(this.removeImages(this.myLayer.features),this.setClipboard(this.myLayer.features.map((t=>t))),this.myLayer.removeFeatures(this.myLayer.features))},doCopy:function(){this.myLayer.selectedFeatures&&this.setClipboard(this.myLayer.selectedFeatures.map((t=>t)))},addGlyph:function(t){this.glyphs[t.getId()]=t},loadAnnotationJson:function(t,e,i,a){t.forEach((t=>{if(!t.points||0==t.points.length)return void console.log("No points defined:"+JSON.stringify(t));let s,l=a?a[t.type]:null,r=t.style||(l?l.getStyle():{});if(r=$.extend({},r),r.label&&(r.pointRadius=0),r.fillColor||(r.fillColor="transparent"),t.points.length>1){let i=[];if(t.points.forEach((t=>{i.push(new OpenLayers.Geometry.Point(t.longitude,t.latitude))})),"OpenLayers.Geometry.Polygon"==t.geometryType){e.transformPoints(i);let t=new OpenLayers.Geometry.LinearRing(i),a=new OpenLayers.Geometry.Polygon(t);s=new OpenLayers.Feature.Vector(a,null,r)}else s=e.createPolygon("","",i,r)}else{let i=MapUtils.createLonLat(t.points[0].longitude,t.points[0].latitude);s=e.createPoint("",i,r)}s.type=t.type,s.style=r,this.checkImage(s),i.addFeatures([s])}))},loadMap:function(t){let e=this.getProperty("fileUrl",null,!1,!0);if(!e&&t&&(e=ramaddaBaseUrl+"/entry/get?entryid="+t),!e)return;let i=this;$.ajax({url:e,dataType:"text",success:t=>{""==t&&(t="[]");try{if(i.loadAnnotationJson(JSON.parse(t),i.map,i.myLayer,i.glyphMap),!i.getProperty("embedded")&&i.myLayer.features.length>0&&!i.getProperty("zoomLevel")){let t=new OpenLayers.Bounds;i.myLayer.features.forEach((e=>{t.extend(e.geometry.getBounds())})),i.map.zoomToExtent(t)}}catch(e){this.showMessage("Failed to load map:"+e),console.log("error:"+e),console.log(e.stack),console.log("map json:"+t)}}}).fail((t=>{this.showMessage("Failed to load map:"+t),console.log("error:"+JSON.stringify(t))}))},doMakeMapGlyphs:function(){return[new GlyphType(this,"marker","Marker",{strokeWidth:0,fillColor:"transparent",externalGraphic:ramaddaBaseUrl+this.getExternalGraphic(),pointRadius:this.getPointRadius(10)},OpenLayers.Handler.Point),new GlyphType(this,"point","Point",{strokeWidth:this.getProperty("strokeWidth",2),fillColor:"transparent",strokeColor:this.getStrokeColor(),pointRadius:this.getPointRadius(4)},OpenLayers.Handler.Point),new GlyphType(this,"label","Label",{label:"label",fontColor:this.getProperty("labelFontColor","#000"),fontSize:this.getFontSize(),fontFamily:this.getFontFamily(),fontWeight:this.getFontWeight(),labelAlign:this.getProperty("labelAlign","lb"),labelXOffset:this.getProperty("labelXOffset","0"),labelYOffset:this.getProperty("labelYOffset","0"),labelOutlineColor:this.getProperty("labelOutlineColor","#fff"),labelOutlineWidth:this.getProperty("labelOutlineWidth","0"),labelSelect:!0},OpenLayers.Handler.Point),new GlyphType(this,"box","Box",{strokeColor:this.getStrokeColor(),strokeWidth:this.getStrokeWidth(),fillColor:"transparent",fillOpacity:1},OpenLayers.Handler.RegularPolygon,{snapAngle:90,sides:4,irregular:!0}),new GlyphType(this,"circle","Circle",{strokeColor:this.getStrokeColor(),strokeWidth:this.getStrokeWidth(),fillColor:"transparent",fillOpacity:1},OpenLayers.Handler.RegularPolygon,{snapAngle:45,sides:40}),new GlyphType(this,"triangle","Triangle",{strokeColor:this.getStrokeColor(),strokeWidth:this.getStrokeWidth(),fillColor:"transparent",fillOpacity:1},OpenLayers.Handler.RegularPolygon,{snapAngle:10,sides:3}),new GlyphType(this,"hexagon","Hexagon",{strokeColor:this.getStrokeColor(),strokeWidth:this.getStrokeWidth(),fillColor:"transparent",fillOpacity:1},OpenLayers.Handler.RegularPolygon,{snapAngle:90,sides:6}),new GlyphType(this,"line","Line",{strokeColor:this.getStrokeColor(),strokeWidth:this.getStrokeWidth()},OpenLayers.Handler.Path,{maxVertices:2}),new GlyphType(this,"polyline","Polyline",{strokeColor:this.getStrokeColor(),strokeWidth:this.getStrokeWidth(),fillColor:"transparent",fillOpacity:1},OpenLayers.Handler.Path),new GlyphType(this,"freehand","Freehand",{strokeColor:this.getStrokeColor(),strokeWidth:this.getStrokeWidth()},OpenLayers.Handler.Path,{freehand:!0}),new GlyphType(this,"image","Image",{strokeColor:"blue",strokeWidth:1,imageOpacity:this.getImageOpacity(1),fillColor:"transparent"},OpenLayers.Handler.ImageHandler,{snapAngle:90,sides:4,irregular:!0,isImage:!0})]},showCommandMessage:function(t){this.jq(s).html(t),this.jq(s).show()},showMessage:function(t){this.setMessage(t),this.messageErase&&clearTimeout(this.messageErase),this.messageErase=setTimeout((()=>{this.setMessage("")}),3e3)},initDisplay:function(t){t||w.initDisplay.call(this);let e,i=this;if(this.myLayer=this.map.createFeatureLayer("Annotation Features",!1,null,{rendererOptions:{zIndexing:!0}}),this.getProperty("layerIndex")&&(this.myLayer.ramaddaLayerIndex=+this.getProperty("layerIndex")),this.icon="/icons/map/marker-blue.png",this.glyphs=this.doMakeMapGlyphs(),this.glyphMap={},this.glyphs.forEach((t=>{this.glyphMap[t.type]=t})),t)return;if(this.map.featureClickHandler=t=>{this.command},Utils.isAnonymous()){let t=HU.div([STYLE,HU.css("display","inline-block"),ID,this.domId(ID_MAP)+"_header"]);this.jq(ID_TOP_LEFT).append(HU.center(t))}else{var a=new OpenLayers.Control;e=new OpenLayers.Control;var l={keydown:function(t){if(t.metaKey)switch(t.keyCode){case 88:return void i.doCut();case 86:return void i.doPaste(t);case 67:return void i.doCopy();case 69:return void i.doEdit()}}};new OpenLayers.Handler.Keyboard(e,l,{}).activate(),this.map.getMap().addControl(a),this.addControl(L,"Click-drag to select",this.featureSelector=new OpenLayers.Control.SelectFeature(this.myLayer,{highlight:function(t){let e={};if($.extend(e,t.style),e.strokeColor="#000",e.pointRadius&&(e.pointRadius*=1.5),e.strokeWidth&&(e.strokeWidth*=2),e.fontSize){let t=String(e.fontSize).match(/([0-9\.]+)(.*)/);if(t){let i=1.5*t[1];e.fontSize=i+t[2]}e.fontWeight="bold"}this.selectStyle=e,OpenLayers.Control.SelectFeature.prototype.highlight.apply(this,arguments)},selectStyle:{pointRadius:this.getPointRadius(),strokeWidth:2,fillOpacity:.5,fillColor:"blue",cursor:"pointer"},clickout:!0,toggle:!0,multiple:!0,hover:!1,toggleKey:"ctrlKey",multipleKey:"shiftKey",box:!0})),this.addControl(E,"Click to edit properties",new OpenLayers.Control.SelectFeature(this.myLayer,{onSelect:function(t){i.doEdit(t)},clickout:!0,toggle:!0,multiple:!1,hover:!1,toggleKey:"ctrlKey",multipleKey:"shiftKey",box:!1}));let t=t=>{t.image&&i.checkImage(t)},r=OpenLayers.Class(OpenLayers.Control.ModifyFeature,{dragVertex:function(e,i){if(!this.feature.image)return void OpenLayers.Control.ModifyFeature.prototype.dragVertex.apply(this,arguments);let a=this.feature.geometry.getVertices(),s=e.geometry.getVertices()[0],l=-1;a.every(((t,e)=>t.x!=s.x||t.y!=s.y||(l=e,!1)));var r=this.map.getLonLatFromViewPortPx(i),o=e.geometry;o.move(r.lon-o.x,r.lat-o.y),s=e.geometry.getVertices()[0],0==l?(a[3].x=s.x,a[1].y=s.y):1==l?(a[2].x=s.x,a[0].y=s.y):2==l?(a[1].x=s.x,a[3].y=s.y):3==l&&(a[0].x=s.x,a[2].y=s.y),this.feature.geometry.clearBounds(),this.layer.drawFeature(this.feature,this.standalone?void 0:"select"),this.layer.drawFeature(e),t(this.feature)}}),o=(this.addControl(P,"Click drag to move",new OpenLayers.Control.DragFeature(this.myLayer,{onDrag:function(e,i){t(e)}})),new r(this.myLayer,{onDrag:function(e,i){t(e)},mode:OpenLayers.Control.ModifyFeature.RESIZE|OpenLayers.Control.ModifyFeature.DRAG})),n=new r(this.myLayer,{onDrag:function(e,i){t(e)},createVertices:!1,mode:OpenLayers.Control.ModifyFeature.RESHAPE});this.addControl(C,"Click to resize",o),this.addControl(A,"Click to reshape",n);let h=HU.div([ID,this.domId(g),CLASS,"ramadda-menubar-button"],"File")+HU.div([ID,this.domId(c),CLASS,"ramadda-menubar-button"],"Edit")+HU.div([ID,this.domId(p),CLASS,"ramadda-menubar-button"],"New");h=HU.div([CLASS,"ramadda-menubar"],h),h+=HU.span([ID,this.domId(s),STYLE,HU.css("margin-left","10px")],"");let d=HU.div([STYLE,HU.css("margin-left","20px","display","inline-block"),ID,this.domId(ID_MAP)+"_header"]);h=HU.table(["width","100%"],HU.tr(["valign","bottom"],HU.td(["width","50%"],h)+HU.td(["width","50%"],d))),this.jq(ID_TOP_LEFT).append(h),this.jq(p).click((function(){i.showNewMenu($(this))})),this.jq(g).click((function(){i.showFileMenu($(this))})),this.jq(c).click((function(){i.showEditMenu($(this))}))}this.glyphs.forEach((t=>{this.glyphMap[t.type]=t,t.createDrawer()})),this.jq(I).html(""),this.defaultStyle={},this.jq(ID_MAP).mouseover((function(){$(this).focus()})),Utils.initDragAndDrop(this.jq(ID_MAP),(t=>{}),(t=>{}),((t,e,i)=>{let a=this.getProperty("entryId")||this.entryId;Ramadda.handleDropEvent(t,e,i,a,((t,e,i,a)=>{this.setCommand("image",{url:t.geturl})}))}),"image.*"),"geo_editable_json"==this.getProperty("thisEntryType")&&this.loadMap()}})}addGlobalDisplayType({type:DISPLAY_EDITABLEMAP,label:"Editable Map",category:CATEGORY_MAPS,tooltip:makeDisplayTooltip("Editable map")});var MapObject=function(t,e,i){this.id=HU.getUniqueId(""),i.objectId=this.id,this.display=t,this.feature=i,this.display.addGlyph(this)};MapObject.prototype={getId:function(){return this.id}};var GlyphType=function(t,e,i,l,r,o){this.display=t,this.label=i,this.type=e,this.glyphStyle=l,this.handler=r,this.options=o||{},this.options.display=t,this.options.mapGlyph=this,$.extend(this,{getStyle:function(){return this.glyphStyle},isLabel:function(){return null!=this.getStyle().label},isImage:function(){return this.options.isImage},isIcon:function(){return null!=this.getStyle().externalGraphic},applyStyle:function(t){for(a in t)this.getStyle()[a]&&(this.getStyle()[a]=t[a])},newFeature:function(t){new MapObject(this.display,this.type,t)},createDrawer:function(){let t=this,e=this.display.myLayer,i=OpenLayers.Class(OpenLayers.Control.DrawFeature,{initialize:function(e,i){let a=OpenLayers.Util.extend({},OpenLayers.Feature.Vector.style.default);a={},$.extend(a,t.getStyle()),i={handlerOptions:{style:a,layerOptions:{styleMap:new OpenLayers.StyleMap({default:a})}}},$.extend(i.handlerOptions,t.options),OpenLayers.Control.DrawFeature.prototype.initialize.apply(this,[e,t.handler||OpenLayers.Handler.Point,i])},drawFeature:function(e){OpenLayers.Control.DrawFeature.prototype.drawFeature.apply(this,arguments);let i,l=this.layer.features[this.layer.features.length-1];if(this.handler.theImage&&(l.image=this.handler.theImage),l.type=t.type,this.handler.style&&(i=this.handler.style),i){for(a in t.getStyle())Utils.isDefined(i[a])||(i[a]=t.getStyle()[s]);l.style&&l.style.label&&(i.label=l.style.label);let e={};$.extend(e,i),l.style=e}this.layer.redraw(),t.newFeature(l),t.isLabel()&&t.display.setCommand(null)}});return this.drawer=new i(e),this.display.addControl(this.type,"",this.drawer),this.drawer}})};const DISPLAY_GRAPH="graph",DISPLAY_TREE="tree",DISPLAY_TIMELINE="timeline",DISPLAY_HOURS="hours",DISPLAY_BLANK="blank",DISPLAY_PRE="pre",DISPLAY_HTMLTABLE="htmltable",DISPLAY_RECORDS="records",DISPLAY_TSNE="tsne",DISPLAY_HEATMAP="heatmap",DISPLAY_CROSSTAB="crosstab",DISPLAY_CORRELATION="correlation",DISPLAY_RANKING="ranking",DISPLAY_STATS="stats",DISPLAY_COOCCURENCE="cooccurence",DISPLAY_BOXTABLE="boxtable",DISPLAY_DATATABLE="datatable",DISPLAY_PERCENTCHANGE="percentchange",DISPLAY_SPARKLINE="sparkline",DISPLAY_POINTIMAGE="pointimage",DISPLAY_CANVAS="canvas",DISPLAY_FIELDTABLE="fieldtable",DISPLAY_DATEGRID="dategrid";function RamaddaGraphDisplay(t,e,i){const a="graph",s=new RamaddaDisplay(t,e,DISPLAY_GRAPH,i);window.ForceGraph||Utils.importJS("https://unpkg.com/force-graph");defineDisplay(addRamaddaDisplay(this),s,[{label:"Graph"},{p:"sourceField",ex:""},{p:"targetField",ex:""},{p:"nodeBackground",ex:"#ccc"},{p:"drawCircle",ex:"true"},{p:"nodeWidth",ex:"10"},{p:"linkColor",ex:"red"},{p:"linkWidth",ex:"3"},{p:"linkDash",ex:"5"},{p:"linkWidth",ex:"3"},{p:"arrowLength",ex:"6"},{p:"arrowColor",ex:"green"},{p:"directionalParticles",ex:"2"}],{needsData:function(){return!0},callbackWaiting:!1,updateUI:function(){if(!window.ForceGraph)return void(this.callbackWaiting||(this.callbackWaiting=!0,setTimeout((()=>{this.callbackWaiting=!1,this.updateUI()}),100)));let t=null,e=HU.div([ID,this.domId(a)]);this.setContents(e);let i=this.filterData();if(!i)return;let s={},l=[],r=[],o=this.getFieldsByIds(null,this.getProperty("valueFields","",!0)),n=this.getFieldById(null,this.getProperty("labelField"));if(!n){let t=this.getFieldsByType(null,"string");t.length>0&&(n=t[0])}let h=this.getFieldById(null,this.getProperty("sourceField","source")),d=this.getFieldById(null,this.getProperty("targetField","target")),p=this.getProperty("tooltip","${default}");if(o.length>0){let t={};i.map(((e,i)=>{let a=n?e.getValue(n.getIndex()):i,s=this.getRecordHtml(e,null,p);l.push({id:i,label:a,tooltip:s}),o.map((a=>{let s=e.getValue(a.getIndex());t[s+"_"+a.getId()]||(t[s+"_"+a.getId()]=!0,l.push({id:s,isValue:!0})),r.push({source:s,target:i})}))}))}else{if(null==h||null==d)return void this.setDisplayMessage("No source/target fields specified");i.map((t=>{let e=t.getValue(h.getIndex()),i=t.getValue(d.getIndex());s[e]||(s[e]=!0,l.push({id:e,tooltip:e})),s[i]||(s[i]=!0,l.push({id:i,tooltip:i})),r.push({source:e,target:i})}))}t={nodes:l,links:r};const g=this.getProperty("nodeBackground","rgba(255, 255, 255, 0.8)"),c=(this.getProperty("linkColor","#ccc"),this.getProperty("drawCircle",!1)),u=(this.getProperty("linkWidth",1),this.getProperty("linkDash",-1),this.getProperty("drawText",!0)),y=this.getProperty("nodeWidth",10),m=document.getElementById(this.domId(a)),f=ForceGraph()(m).graphData(t);f.nodeCanvasObject(((t,e,i)=>{let a=t.label;a||(a=t.id);const s=12/i;e.font=s+"px Sans-Serif";let l=e.measureText(a).width;if(u||(l=y),t.isValue){let i=[l,s].map((t=>t+.2*s+2));e.lineWidth=1,e.strokeStyle="#000",e.fillStyle="#fff",e.fillRect(t.x-i[0]/2,t.y-i[1]/2,...i),e.strokeRect(t.x-i[0]/2,t.y-i[1]/2,...i)}else{let i=[l,s].map((t=>t+.2*s+2));e.fillStyle=g,e.strokeStyle="#000",c?(e.beginPath(),e.arc(t.x,t.y,i[0]/2,0,2*Math.PI),e.fill()):(e.fillRect(t.x-i[0]/2,t.y-i[1]/2,...i),e.strokeRect(t.x-i[0]/2,t.y-i[1]/2,...i))}u&&(e.textAlign="center",e.textBaseline="middle",e.fillStyle="black",e.fillText(a,t.x,t.y))})),this.getWidth()&&f.width(this.getWidth()),this.getHeight()&&f.height(this.getHeight()),f.nodeLabel((t=>t.tooltip?t.tooltip:null)),f.linkWidth(+this.getProperty("linkWidth",4)),f.linkColor(this.getProperty("linkColor","#000")),this.getProperty("arrowColor")&&f.linkDirectionalArrowColor(this.getProperty("arrowColor")),this.getProperty("arrowLength")&&(f.linkDirectionalArrowLength(+this.getProperty("arrowLength")),f.linkDirectionalArrowRelPos(+this.getProperty("arrowPosition",.9))),this.getProperty("directionalParticles")&&f.linkDirectionalParticles(+this.getProperty("directionalParticles"))}})}function RamaddaTreeDisplay(t,e,i){const a=new RamaddaDisplay(t,e,DISPLAY_TREE,i);defineDisplay(addRamaddaDisplay(this),a,[{label:"Tree"},{p:"maxDepth",ex:"3"},{p:"showDetails",ex:"false"}],{countToRecord:{},needsData:function(){return!0},updateUI:function(){let t=this.filterData();if(!t)return;let e=null;try{e=this.makeTree(t)}catch(t){return void this.handleError("An error has occurred:"+t,t)}let i="",a=this.domId("node"),s=0,l=0,r=+this.getProperty("maxDepth",10),o=this.getProperty("recordTemplate","${default}"),n=this.getProperty("showDetails",!0),h=this,d=function(t){s++,t.record&&(h.countToRecord[s]=t.record),l++;let e=t.children.length>0&&l<=r,p=null;n&&t.record&&(p=h.getRecordHtml(t.record,null,o),""==p&&(p=null));let g="";(t.children.length>0||p)&&(g=HU.image(e?icon_downdart:icon_rightdart,[ID,a+"_toggle_image"+s])+" "),i+=HU.div([CLASS,"display-tree-toggle",ID,a+"_toggle"+s,"toggle-state",e,"block-count",s],g+t.label),i+=HU.open(DIV,[ID,a+"_block"+s,CLASS,"display-tree-block",STYLE,HU.css("display",e?"block":"none")]),p&&""!=p&&(t.children.length>0?(i+=HU.div([CLASS,"display-tree-toggle-details",ID,a+"_toggle_details"+s,"toggle-state",!1,"block-count",s],HU.image(icon_rightdart,[ID,a+"_toggle_details_image"+s])+" Details"),i+=HU.div([ID,a+"_block_details"+s,CLASS,"display-tree-block",STYLE,HU.css("display","none")],p)):i+=p),t.children.length>0&&t.children.map(d),l--,i+=HU.close(DIV)};e.map(d),this.myRecords=[],this.displayHtml(i),this.find(".display-tree-toggle").click((function(){let t=/true/i.test($(this).attr("toggle-state"));t=!t;let e=$(this).attr("block-count"),i=$("#"+a+"_block"+e),s=$("#"+a+"_toggle_image"+e);$(this).attr("toggle-state",t),t?(i.css("display","block"),s.attr("src",icon_downdart)):(i.css("display","none"),s.attr("src",icon_rightdart));let l=h.countToRecord[e];l&&h.propagateEventRecordSelection({record:l})})),this.find(".display-tree-toggle-details").click((function(){let t=/true/i.test($(this).attr("toggle-state"));t=!t;let e=$(this).attr("block-count"),i=$("#"+a+"_block_details"+e),s=$("#"+a+"_toggle_details_image"+e);$(this).attr("toggle-state",t),t?(i.css("display","block"),s.attr("src",icon_downdart)):(i.css("display","none"),s.attr("src",icon_rightdart))}))}})}function RamaddaTimelineDisplay(t,e,i){const a="timeline";i.height||(i.height=400);const s=new RamaddaFieldsDisplay(t,e,DISPLAY_TIMELINE,i);Utils.importJS(ramaddaCdn+"/lib/timeline3/timeline.js");$(HU.tag("link",["rel","stylesheet","href","https://cdn.knightlab.com/libs/timeline3/latest/css/timeline.css","type","text/css"])).appendTo("head"),defineDisplay(addRamaddaDisplay(this),s,[{label:"Timeline"},{p:"titleField",ex:""},{p:"imageField",ex:""},{p:"urlField",ex:""},{p:"textTemplate",ex:""},{p:"startDateField",ex:""},{p:"endDateField",ex:""},{p:"startAtSlide",ex:"0"},{p:"startAtEnd",ex:"true"},{p:"scaleFactor",ex:"10"},{p:"initialZoom",ex:"10"},{p:"navHeight",ex:"150"},{p:"backgroundColor",ex:"#ccc"},{p:"groupField",ex:""},{p:"urlField",ex:""},{p:"timeTo",ex:"year|day|hour|second"},{p:"hideBanner",ex:"true"}],{needsData:function(){return!0},loadCnt:0,timelineLoaded:!1,checkLayout:function(){this.updateUI()},updateUI:function(){if(!this.timelineLoaded)try{TL.Timeline;this.timelineLoaded=!0}catch(t){if(this.loadCnt++<100)return void setTimeout((()=>this.updateUI()),100)}if(!this.timelineLoaded)return void this.setDisplayMessage("Could not load timeline");let t=this.filterData();if(null==t)return;let e=this.domId(a),i=HU.div([ID,e]);this.setContents(i),this.timelineReady=!1;let s={timenav_position:this.getProperty("timelinePosition","top"),start_at_end:this.getPropertyStartAtEnd(!1),start_at_slide:this.getPropertyStartAtSlide(0),timenav_height:this.getPropertyNavHeight(200),height:100,menubar_height:100,gotoCallback:e=>{if(this.timelineReady){let i=t[e];i&&this.propagateEventRecordSelection({record:i})}}};this.getPropertyBackgroundColor()&&(s.default_bg_color=this.getPropertyBackgroundColor()),this.getPropertyScaleFactor(0)&&(s.scale_factor=this.getPropertyScaleFactor()),this.getPropertyInitialZoom(0)&&(s.scale_factor=this.getPropertyInitialZoom());let l={},r=[];l.events=r;let o=this.getFieldById(null,this.getPropertyTitleField());null==o&&(o=this.getFieldById(null,"title")),null==o&&(o=this.getFieldById(null,"name"));let n=this.getFieldById(null,this.getPropertyStartDateField());n||(n=this.getFieldByType(null,"date"));let h=this.getFieldById(null,this.getPropertyEndDateField()),d=this.getFieldById(null,this.getPropertyImageField()),p=this.getFieldById(null,this.getPropertyGroupField()),g=this.getFieldById(null,this.getPropertyUrlField()),c=this.getPropertyTextTemplate("${default}"),u=(this.getPropertyTimeTo("day"),this.getProperty("showYears",!1));this.recordToIndex={},this.idToRecord={};for(let e=0;e<t.length;e++){let i=t[e];this.idToRecord[i.getId()]=i,this.recordToIndex[i.getId()]=e;let a=i.getData(),s={},l=o?a[o.getIndex()]:" record:"+(e+1),y=!1,m=this.getRecordHtml(i,null,c,y);if(g){let t=i.getValue(g.getIndex());l=HU.href(t,l)}s.unique_id=i.getId(),s.text={headline:l,text:m},p&&(s.group=i.getValue(p.getIndex())),d&&(s.media={url:i.getValue(d.getIndex())},g&&(s.media.link=i.getValue(g.getIndex()),s.media.link_target="_timelinemedia"));let f=this.getDate(n?a[n.getIndex()]:i.getTime());u?s.start_date={year:f.year}:(s.start_date=f,h&&(s.end_date=a[h.getIndex()])),r.push(s)}0!=$("#"+e).length&&(this.timeline=new TL.Timeline(e,l,s),this.getPropertyHideBanner(!1)&&(this.jq(a).find(".tl-storyslider").css("display","none"),this.jq(a).find(".tl-menubar").css("display","none")),this.jq(a).find(".tl-text").css("padding","0px"),this.jq(a).find(".tl-slide-content").css("padding","0px 0px"),this.jq(a).find(".tl-slidenav-description").css("display","none"),this.timelineReady=!0)},handleEventRecordSelection:function(t,e){if(!e.record)return;let i=this.recordToIndex[e.record.getId()];Utils.isDefined(i)&&this.timeline.goTo(i)},getDate:function(t){let e=this.getPropertyTimeTo("day"),i={year:t.getUTCFullYear()};return"year"!=e&&(i.month=t.getUTCMonth()+1,"month"!=e&&(i.day=t.getUTCDate(),"day"!=e&&(i.hour=t.getHours(),i.minute=t.getMinutes(),"hour"!=e&&(i.second=t.getSeconds())))),i}})}function RamaddaHoursDisplay(t,e,i){const a=new RamaddaFieldsDisplay(t,e,DISPLAY_HOURS,i),s="lightblue",l="multiid";defineDisplay(addRamaddaDisplay(this),a,[{label:"Hours"},{p:"dateField",ex:""},{p:"boxWidth",ex:""},{p:"boxColor",ex:"blue"},{p:"rowBackground",ex:""},{p:"dayLabelStyle",ex:""},{p:"fillHours",ex:"false"}],{needsData:function(){return!0},updateUI:function(){let t=this.filterData();if(null==t)return;let e=this,i="",a=this.getFieldById(null,this.getPropertyDateField()),r=[],o={},n=this.getProperty("dateFormat","mdy");this.recordToIndex={};let h=+this.getProperty("timeZoneOffset",0);t.forEach(((t,e)=>{this.recordToIndex[t.getId()]=e;let i=a?recordtuple[a.getIndex()]:t.getTime(),s=i,l=s.getUTCHours()+h;s=new Date(Date.UTC(s.getUTCFullYear(),s.getUTCMonth(),s.getUTCDate(),l));let n=+s.getUTCHours(),d=new Date(Date.UTC(s.getUTCFullYear(),s.getUTCMonth(),s.getUTCDate())),p=o[d];p||(p=o[d]={dttm:s,hours:[],minutesCount:{},hourToRecords:{},minHour:n,maxHour:n},r.push(d)),p.minHour=Math.min(p.minHour,n),p.maxHour=Math.max(p.maxHour,n);let g=n+"_"+i.getMinutes();p.minutesCount[g]||(p.minutesCount[g]=0),p.minutesCount[g]++,p.hourToRecords[n]||(p.hours.push(n),p.hourToRecords[n]=[]),p.hourToRecords[n].push(t)})),Utils.sortDates(r),i=HU.open("div",[STYLE,"position:relative;"])+HU.open("table",["width","100%"]);let d=this.getPropertyBoxWidth(10),p=this.getPropertyBoxColor(s),g="";r.forEach((t=>{let s=o[t];if(this.getPropertyFillHours(!0))for(let t=s.minHour;t<s.maxHour;t++)s.hourToRecords[t]||(s.hours.push(t),s.hourToRecords[t]=[]);let r=Utils.formatDateWithFormat(t,n,!0);i+=HU.tr([STYLE,"border-bottom:1px solid #ccc;"],HU.tds([],["",HU.div([CLASS,"display-hours-label"],r),"#"]));let h=0;Utils.sortNumbers(s.hours).forEach((t=>{let r="<tr style='border-top:1px solid #ccc;'>",o=HU.div([STYLE,this.getPropertyDayLabelStyle("")],Utils.formatHour(t));r+=HU.td([WIDTH,"10","align","right"],o),r+=HU.open("td",[STYLE,HU.css("background","#efefef"),WIDTH,"100%"]),r+=HU.open("div",[STYLE,HU.css(HEIGHT,"100%",POSITION,"relative",WIDTH,"100%",BACKGROUND,this.getPropertyRowBackground("#eee"))]),r+="&nbsp;";let n={},c=!1;for(minute in s.hourToRecords[t].forEach((i=>{let o=(a?i.getValue(a.getIndex()):i.getTime()).getMinutes(),g=Math.round(o/61*100)+"%",u=t+"_"+o;if(s.minutesCount[u]>1){if(!n[o]){let e=this.domId("multi"+h++);n[o]={multiid:e,contents:""},r+=HU.div([ID,e,TITLE,"Click to view multiples","dttm",s.dttm.getTime(),"hour",t,"minute",o,STYLE,HU.css("top","0px","left",g),CLASS,"display-hours-box-multi"],s.minutesCount[u])}n[o].contents+=HU.div([l,n[o].multiid,RECORD_ID,i.getId(),RECORD_INDEX,e.recordToIndex[i.getId()],TITLE,"",STYLE,HU.css(WIDTH,d+"px",BACKGROUND,p),CLASS,"display-hours-box"],"")}else{let t=HU.css("position","absolute","top","0px",WIDTH,d+"px","background",p,"left",g);r+=HU.div([RECORD_ID,i.getId(),RECORD_INDEX,e.recordToIndex[i.getId()],TITLE,"",STYLE,t,CLASS,"display-hours-box"])}c=!0})),n){let e=s.dttm.getTime()+"_"+t+"_"+minute;g+=HU.div([ID,this.domId(e),CLASS,"display-hours-box-extra"],n[minute].contents)}r+="</div></td>",r+=HU.td([],s.hourToRecords[t].length),r+="</tr>",c&&(i+=r)}))})),i+="</table>",i+=g,i+="&nbsp;</div>",this.setContents(i),this.multis=this.find(".display-hours-box-multi"),this.multis.click((function(){let t=$(this).attr("dttm")+"_"+$(this).attr("hour")+"_"+$(this).attr("minute"),i=e.jq(t);if("true"==$(this).attr("showing"))return i.hide(),$(this).css("border","1px solid #ccc"),void $(this).attr("showing",!1);$(this).css("border","1px solid "+HIGHLIGHT_COLOR),$(this).attr("showing",!0),i.show(),i.position({of:$(this),my:"left top",at:"left bottom+2",collision:"none none"})})),this.boxes=this.find(".display-hours-box"),this.boxes.click((function(){let i=/true/i.test($(this).attr("toggle-state"));i=!i,e.boxes.css("background",s),i&&$(this).css("background",HIGHLIGHT_COLOR);let a=t[+$(this).attr(RECORD_INDEX)];a&&e.propagateEventRecordSelection({record:a})})),this.makeTooltips(this.boxes,t,null,null,!1)},handleEventRecordSelection:function(t,e){if(!e.record)return;let i=".display-hours-box["+RECORD_ID+"='"+e.record.getId()+"']",a=this.find(i);if(a.length){this.boxes.css("background",s),this.multis.css("background","#efefef");let t=a.attr(l);if(t){let e=this.find("#"+t);e.length>0&&(a=e,a.css("background",HIGHLIGHT_COLOR))}a.css("background",HIGHLIGHT_COLOR),HU.scrollVisible(this.getContents(),a)}}})}function RamaddaBlankDisplay(t,e,i){i.width||(i.width="100%"),i.showMenu=!1,i.showTitle=!1;const a=new RamaddaFieldsDisplay(t,e,DISPLAY_BLANK,i);defineDisplay(addRamaddaDisplay(this),a,[],{needsData:function(){return!0},updateUI:function(){let t=this.filterData();if(this.setContents(""),!t)return;let e=this.getColorByInfo(t);e.index>=0&&(t.map((t=>{color=e.getColor(t.getData()[e.index],t)})),e.displayColorTable())}})}function RamaddaPreDisplay(t,e,i){const a=new RamaddaFieldsDisplay(t,e,DISPLAY_PRE,i);defineDisplay(addRamaddaDisplay(this),a,[{label:"Pre"},{p:"numRecords",ex:"100",d:1e3},{p:"includeGeo",ex:"true",d:!0}],{updateUI:function(){let t=this.filterData();if(!t)return void this.setContents("Loading data...");let e=this.dataCollection.getList()[0].getRecordFields(),i=this.getNumRecords(),a=this.getIncludeGeo(),s="Number of records:"+t.length+"<pre>";e.forEach(((t,e)=>{e>0&&(s+=", "),s+=t.getId()+"["+t.getType()+"]"})),a&&(s+=", latitude, longitude"),s+="\n",t.every(((t,e)=>{if(i>-1&&e>i)return!1;let l=t.getData();return l=l.map((t=>t.getTime?this.formatDate(t):t)),s+="#"+e+": ",s+=l.join(", "),a&&(s+=", "+t.getLatitude()+","+t.getLongitude()),s+="\n",!0})),s+="</pre>",this.setContents(s)}})}function RamaddaHtmltableDisplay(t,e,i){const s="table",l=new RamaddaFieldsDisplay(t,e,DISPLAY_HTMLTABLE,i);defineDisplay(addRamaddaDisplay(this),l,[{label:"Html Table"},{p:"numRecords",ex:"5000",d:5e3,tt:"Number of records to show"},{p:"scrollY",ex:"300px"},{p:"includeGeo",ex:"true",d:!1},{p:"includeDate",ex:"true",d:!0},{p:"fancy",ex:"true",d:!0},{p:"colorCells",ex:"field1,field2"},{p:"iconField"},{p:"linkField"},{p:"showBar",ex:"true",tt:"Default show bar"},{p:"&lt;field&gt;.showBar",ex:"true",tt:"Show bar"},{p:"&lt;field&gt;.barMin",ex:"0",tt:"Min value"},{p:"&lt;field&gt;.barMax",ex:"100",tt:"Max value"},{p:"barLabelInside",ex:"false"},{p:"barStyle",ex:"background:red;",tt:"Bar style"},{p:"tableHeaderStyle"},{p:"showAddRow",ex:"true"}],{displayData:function(){this.updateUI()},updateUI:function(){let t=this.filterData();if(!t)return void this.setDisplayMessage("Loading data...");let e=this.getFancy(),i=this.getPointData().getRecordFields(),l=this.getSelectedFields(),o=this.getFieldById(null,this.getProperty("urlField")),n=this.getFieldById(null,this.getIconField());i=l&&l.length>0?l:i;let h=i.filter((t=>null==t||null!=t.getGroup())).length>0,d={};if(h){let t=[],e=null;for(let a=0;a<i.length;a++){let s=i[a];if(null!=s)if(e=s.getGroup(),null!=e){t.push(s),d[e]=1;for(let l=a+1;l<i.length;l++)null!=i[l]&&i[l].getGroup()==s.getGroup()&&(d[e]++,t.push(i[l]),i[l]=null)}else t.push(s)}i=t}let p=this.getFieldById(null,this.getProperty("aggregateBy"));if(p){let e=new CsvUtil,a=new PointData("",i,t),s=e.process(this,a,"aggregate(includeRows=true, groupBy="+p.getId()+");");t=s.getRecords(),i=s.getRecordFields()}let g={},c=[];this.getColorCells("").split(",").forEach((e=>{let i=this.getFieldById(null,e);i&&(g[e]=new ColorByInfo(this,null,t,null,e+".colorByMap",null,e,i),c.push(g[e]))}));let u=this.getNumRecords(),y=this.getIncludeGeo(),m=this.getIncludeGeo(),f=HU.openTag("table",[CLASS,"ramadda-table stripe","width","100%",ID,this.domId(s)]),D=[STYLE,"white-space:nowrap;background:#efefef;padding:5px; font-weight:bold;"];if(D=[],f+="<thead>\n",m&&(f+=HU.th(HU.div(D,"Date"))),h){let t=[STYLE,HU.css("background","#fff","width","100%")];f+="<tr style='background:transparent;' valign=top>\n";let e=null,a={};i.forEach(((i,s)=>{i.getGroup()?e!=i.getGroup()&&(e=i.getGroup(),a[e]||(a[e]=!0,f+=HU.th([CLASS,"display-table-group-header-th",STYLE,HU.css("border-bottom","0px solid transparent","background","transparent"),"colspan",d[e]],HU.div([CLASS,"display-table-group-header"],e))+"\n")):f+=HU.th([STYLE,HU.css("border-bottom","0px solid transparent","background","transparent")],HU.div(t,"&nbsp;"))+"\n"})),f+="</tr>\n"}f+="<tr  valign=top>\n";let I=this.getTableHeaderStyle("")+"text-align:center;",T={},b=this.getProperty("sortFields"),S=this.getSortAscending();if(b){let t={};b.split(",").forEach((e=>{t[e]=!0})),b=t}i.forEach(((t,i)=>{T[t.getId()]=t;let a=b&&b[t.getId()],s=[TITLE,"Click to sort",CLASS,"ramadda-clickable display-table-header","field-id",t.getId(),STYLE,I];if(a&&(s.push("sorted"),s.push("true")),e){let e=this.getFieldLabel(t);a&&(e=HU.getIconImage(S?"fas fa-arrow-down":"fas fa-arrow-up",null,[STYLE,HU.css("font-size","8pt !important")])+" "+e),f+=HU.th(s,HU.div(D,e))}else f+=HU.th(s,HU.div(D,t.getId()+"["+t.getType()+"]"))})),y&&(f+=HU.th(HU.div(D,"latitude"))+HU.th([],HU.div(D,"longitude"))),f+="</tr>\n",f+="</thead><tbody>\n",this.savedState=Utils.getLocalStorage(this.getProperty("storageKey",this.type),!0)||{};let x=!1;this.recordMap={},this.fieldMap={},i.forEach((t=>{this.fieldMap[t.getId()]=t}));let U="",L=[],E=(t,e,i,a)=>{if(!p)return HU.td(a,i);if(t.getId()!=p.getId())return HU.td(a,i);if(!e.isAggregate){let t="&nbsp;&nbsp;&nbsp;&nbsp;";return HU.td(a,HU.row([["width","1%","style","padding:2px;"],t],[["style","padding:0px;"],i]))}let s=HU.span([ID,U+"_toggle","toggleopen","false",CLASS,"ramadda-clickable"],HU.span([ID,U+"_toggleimage"],HU.getIconImage("fas fa-chevron-right"))+"&nbsp;"+i);return HU.td(Utils.mergeLists(a,["nowrap","true"]),s)};t.every(((t,e)=>{if(u>-1&&e>u)return!1;let s=t.getData();s=s.map((t=>t&&t.getTime?this.formatDate(t):t));let l="";t.isAggregate&&(U=HU.getUniqueId("agg_"),L.push(U));let h=e%2?"ramadda-row-odd":"ramadda-row-even";return h="display-htmltable-row",t.isAggregate?f+=HU.openTag("tr",["aggregateRow",U,"style",HU.css("font-weight","550"),"title","","valign","top","class",h,RECORD_ID,t.getId()]):f+=p?HU.openTag("tr",["style","display:none","aggregateId",U,"title","","valign","top","class",h,RECORD_ID,t.getId()]):HU.openTag("tr",["aggregateId",U,"title","","valign","top","class",h,RECORD_ID,t.getId()]),m&&(f+=HU.td([],this.formatDate(r.getDate()))),this.recordMap[t.rowIndex]=t,i.forEach(((e,i)=>{let r=s[e.getIndex()],h=String(r);if(h.length>500&&(h=HU.div([STYLE,"max-height:200px;overflow-y:auto;"],h)),e.canEdit()){let i=v;if(this.savedState){let a=this.savedState[e.getId()];if(a){let s=a[t.rowIndex];Utils.isDefined(s)&&(t.data[e.getIndex()]=s,i=s,x=!0)}}if("boolean"==e.getType())v=HU.checkbox("",["fieldid",e.getId(),"inputtype","checkbox",RECORD_INDEX,t.rowIndex,CLASS,"display-editable",ID,this.domId("editable_"+e.getId())],i);else if(e.isFieldEnumeration()){let s=e.getEnumeratedValues()||"",l=[];for(a in s)l.push([a,s[a]]);v=HU.select("",["fieldid",e.getId(),RECORD_INDEX,t.rowIndex,CLASS,"display-editable",STYLE,"",ID,this.domId("editable_"+e.getId())],l,i)}else v=HU.input("",i,["fieldid",e.getId(),RECORD_INDEX,t.rowIndex,CLASS,"display-editable",ID,this.domId("editable_"+e.getId())])}if("image"==e.getType()){let i=t.getValue(e.getIndex());h=HU.image(i,[STYLE,HU.css("width","150px;")])}if(0==i&&n){let e=t.getValue(n.getIndex());h=HU.image(e,[STYLE,HU.css("max-width","50px;")])+"&nbsp;"+v}if(o&&0==i){let e=t.getValue(o.getIndex());h&&Utils.stringDefined(e)&&(h&&(h=String(v).trim()),h=HU.href(e,h))}let d=g[e.getId()],p=[],c=this.getProperty("showBar",!1),u=!0,y=0,m=100,D="";if(e.isFieldNumeric()?(p=["align","right"],c=this.getProperty(e.getId()+".showBar",c),y=this.getProperty(e.getId()+".barMin",y),m=this.getProperty(e.getId()+".barMax",m),D=this.getProperty(e.getId()+".barStyle",this.getProperty("barStyle",D)),u=this.getProperty(e.getId()+".barLabelInside",this.getProperty("barLabelInside",u))):c=!1,p.push("class"),p.push("display-td"),d){let e=d.getColorFromRecord(t),i=Utils.getForegroundColor(e);f+=HU.td(Utils.mergeLists(p,[STYLE,HU.css("background",e,"color",i+" !important")]),h)}else if(c){let t=1-(r-y)/(m-y);t=100*t+"%";let e="";h=Utils.formatNumberComma(r)+"%",u&&(e=HU.div([STYLE,HU.css("padding-left","2px")],h),h="");let i=HU.div([CLASS,"ramadda-bar-inner",STYLE,HU.css("right",t)+D],e),a=this.getProperty("barLength","100px"),s=HU.div([CLASS,"ramadda-bar-outer",STYLE,(a?HU.css("width",HU.getDimension(a)):"")+HU.css("min-width","100px")+(u?HU.css("height","1.5em"):"")],i);f+=u?HU.td([],s):HU.td([],HU.row([["align","right"],h],s))}else e.isFieldNumeric()?f+=E(e,t,this.formatNumber(h,e.getId()),p):f+=E(e,t,h,p);l=""})),x&&this.getPointData().propagateEventDataChanged(this),y&&(f+=HU.td([],t.getLatitude())+HU.td([],t.getLongitude())),f+="</tr>\n",!0})),f+="</tbody>\n",f+="</table>\n",this.getShowAddRow()&&(f+=HU.div([ID,this.domId("addrow"),CLASS,"ramadda-clickable"],HU.getIconImage("fas fa-plus"))),this.setContents(f),L.forEach((t=>{$("#"+t+"_toggle").click((function(){let e="true"==$(this).attr("toggleopen");$(this).attr("toggleopen",!e);let i=C.jq(s).find(HU.attrSelect("aggregateRow",t));e?(i.find(".display-td").css("font-weight","plain").css("border-bottom","0px"),i.css("font-weight","plain").css("border-bottom","0px"),C.jq(s).find(HU.attrSelect("aggregateId",t)).hide(),$(this).find("#"+t+"_toggleimage").html(HU.getIconImage("fas fa-chevron-right"))):(i.find(".display-td").css("font-weight","bold").css("border-bottom","1px solid #888"),C.jq(s).find(HU.attrSelect("aggregateId",t)).show(),$(this).find("#"+t+"_toggleimage").html(HU.getIconImage("fas fa-chevron-down")))}))}));let P=this.jq(ID_COLORTABLE);c.forEach(((t,e)=>{let i=this.domId(ID_COLORTABLE+e);P.append(HU.div([ID,i])),t.displayColorTable(null,!0,ID_COLORTABLE+e)})),this.find(".display-table-header").click((function(){let t=T[$(this).attr("field-id")];"true"===$(this).attr("sorted")&&C.setProperty("sortAscending",!C.getSortAscending()),C.setProperty("sortFields",t.getId()),C.sortByFieldChanged(t.getId())}));let C=this,A=(this.getProperty("tooltipClick"),this.jq(s).find(".display-htmltable-row"));this.makeTooltips(A,t);let w={ordering:!1,scrollY:this.getScrollY("400px")};HU.formatTable("#"+this.domId(s),w),this.getShowAddRow()&&this.jq("addrow").click((()=>{let t=this.getPointData().getRecords(),e=t[t.length-1].clone();t.push(e),this.updateUI(),this.getPointData().propagateEventDataChanged(this)}));let H=t=>{let e;e="checkbox"==t.attr("inputtype")?t.is(":checked"):t.val();let i=t.attr("fieldid"),a=C.savedState[i]||{},s=t.attr(RECORD_INDEX);a[s]=e,C.savedState[i]=a,Utils.setLocalStorage(C.getProperty("storageKey",C.type),C.savedState,!0);let l=C.recordMap[s],r=C.fieldMap[i];l.data[r.getIndex()]=e,C.getPointData().propagateEventDataChanged(C)};this.jq(ID_DISPLAY_CONTENTS).find(".display-editable").change((function(){H($(this))})),this.jq(ID_DISPLAY_CONTENTS).find(".display-editable").keypress((function(t){13==t.which&&H($(this))}))}})}function RamaddaTsneDisplay(t,e,i){const a="tsnecanvas",s="tsnedetails",l="tsnerun",r="tsnereset",o="tsnestep",n="tsnesearch";$.extend(this,{colorTable:"red_white_blue",colorByMin:"-1",colorByMax:"1",height:"500px;"});const h=new RamaddaFieldsDisplay(t,e,DISPLAY_TSNE,i);defineDisplay(addRamaddaDisplay(this),h,[],{nameToIndex:{},needsData:function(){return!0},handleEventPointDataLoaded:function(t,e){this.needsData()||null==this.dataCollection&&(this.dataCollection=t.dataCollection,this.updateUI())},updateUI:async function(t){if(h.updateUI.call(this,t),!this.hasData())return void this.setDisplayMessage(this.getLoadingMessage());await Utils.importJS(ramaddaCdn+"/lib/tsne.js");let e=this.getProperty("height",400);String(e).endsWith("px")&&(e=String(e).replace("px","")),e=parseInt(e);let i=HU.div([STYLE,HU.css("height",e+"px","max-height",e+"px"),CLASS,"display-tnse-details",ID,this.domId(s)],""),d=HU.div([CLASS,"display-tnse-canvas-outer",STYLE,HU.css("height",e+"px")],HU.div([CLASS,"display-tnse-canvas",ID,this.domId(a)],"")),p=HU.div([ID,this.domId(l),CLASS,"ramadda-button","what","run"],"Stop")+SPACE+HU.div([ID,this.domId(o),CLASS,"ramadda-button","what","step"],"Step")+SPACE+HU.div([ID,this.domId(r),CLASS,"ramadda-button","what","reset"],"Reset")+SPACE+HU.input("","",[ID,this.domId(n),"placeholder","search"]);p=HU.div([CLASS,"display-tnse-toolbar"],p),this.jq(ID_TOP_LEFT).append(p),this.setContents(HU.table([WIDTH,"100%"],HU.tr(["valign","top"],HU.td(["width","80%"],d)+HU.td(["width","20%"],i)))),this.search=this.jq(n),this.search.keyup((t=>{let e=this.search.val().trim();if(this.canvas.find(".display-tnse-mark").removeClass("display-tnse-highlight"),""!=e)for(name in e=e.toLowerCase(),this.nameToIndex)name.toLowerCase().startsWith(e)&&this.jq("element-"+this.nameToIndex[name]).addClass("display-tnse-highlight")})),this.details=this.jq(s),this.reset=this.jq(r),this.step=this.jq(o),this.step.button().click((()=>{this.running=!1,this.run.html(this.running?"Stop":"Run"),this.takeStep()})),this.reset.button().click((()=>{this.start()})),this.run=this.jq(l),this.run.button().click((()=>{this.running=!this.running,this.running&&this.takeStep(),this.run.html(this.running?"Stop":"Run")})),this.canvas=this.jq(a),this.running=!0,this.start()},start:function(){this.canvas.html(""),this.haveStepped=!1,this.dataList=this.getStandardData(null,{includeIndex:!1});let t=this.dataCollection.getList()[0].getRecordFields();if(!this.fields){this.fields=this.getSelectedFields([]),0==this.fields.length&&(this.fields=t);let e=this.getFieldsByType(this.fields,"string");e.length>0&&(this.textField=e[0])}let e=[];for(let t=1;t<this.dataList.length;t++){let i=this.getDataValues(this.dataList[t]),a=[];for(let t=0;t<this.fields.length;t++)if(this.fields[t].isNumeric()){let e=i[this.fields[t].getIndex()];isNaN(e)&&(e=0),a.push(e)}e.push(a)}let i={epsilon:10,perplexity:30,dim:2};this.tsne=new tsnejs.tSNE(i),this.tsne.initDataRaw(e),this.takeStep()},takeStep:function(){for(let t=0;t<10;t++)this.tsne.step();let t,e,i,a,s=this.tsne.getSolution();for(let l=0;l<s.length;l++)0==l?(i=t=s[l][0],a=e=s[l][1]):(i=Math.max(i,s[l][0]),t=Math.min(t,s[l][0]),a=Math.max(a,s[l][1]),e=Math.min(e,s[l][1]));for(let l=0;l<s.length;l++){let r=100*(s[l][0]-t)/(i-t),o=100*(s[l][1]-e)/(a-e);if(this.haveStepped)this.jq("element-"+l).animate({left:r+"%",top:o+"%"},250,"linear");else{let t="";if(this.textField){t=this.getDataValues(this.dataList[l])[this.textField.getIndex()]}t.length>10&&(t.length=10),this.nameToIndex[t]=l,this.canvas.append(HU.div([TITLE,t,"index",l,ID,this.domId("element-"+l),CLASS,"display-tnse-mark",STYLE,HU.css("left",r+"%","top",o+"%")],t))}}let l=this;this.haveStepped||this.canvas.find(".display-tnse-mark").click((function(t){let e=parseInt($(this).attr("index"));if(e<0||e>=l.dataList.length)return;let i=l.getDataValues(l.dataList[e]),a=HU.open(TABLE,[CLASS,"formtable",WIDTH,"100%"]);for(let t=0;t<l.fields.length;t++){let e=l.fields[t];a+=HU.tr([],HU.td(["align","right",CLASS,"formlabel"],this.getFieldLabel(e)+":")+HU.td([],i[e.getIndex()]))}a+=HU.close(TABLE),l.details.html(a)})),this.haveStepped,this.haveStepped=!0,this.running&&setTimeout((()=>this.takeStep()),250)}})}function RamaddaHeatmapDisplay(t,e,i){$.extend(this,{colorTable:"red_white_blue"});const a=new RamaddaFieldsDisplay(t,e,DISPLAY_HEATMAP,i);defineDisplay(addRamaddaDisplay(this),a,[],{"map-display":!1,needsData:function(){return!0},getMenuItems:function(t){a.getMenuItems.call(this,t);this.getGet();let e=HU.formTable(),i=this.getColorTableName(),s=HU.open("select",[ID,this.domId("colortable")]);for(table in Utils.ColorTable)table==i?s+=HU.tag("option",["selected",null],table):s+=HU.tag("option",[],table);s+=HU.close("select"),e+=HU.formEntry("Color Table:",s),e+=HU.formEntry("Color By Range:",HU.input("",this.colorByMin,["size","7",ATTR_ID,this.domId("colorbymin")])+" - "+HU.input("",this.colorByMax,["size","7",ATTR_ID,this.domId("colorbymax")])),e+=HU.close(TABLE),t.push(e)},initDialog:function(){a.initDialog.call(this);let t=this,e=function(){t.colorByMin=t.jq("colorbymin").val(),t.colorByMax=t.jq("colorbymax").val(),t.updateUI()};this.jq("colorbymin").blur(e),this.jq("colorbymax").blur(e),this.jq("colortable").change((function(){t.colorTable=t.jq("colortable").val(),t.updateUI()}))},handleEventPointDataLoaded:function(t,e){this.needsData()||null==this.dataCollection&&(this.dataCollection=t.dataCollection,this.updateUI())},fieldSelectionChanged:function(){this.updateUI()},getContentsStyle:function(){let t=this.getProperty("height",-1);return t>0?" height:"+t+"px;  max-height:"+t+"px; overflow-y: auto;":""},updateUI:function(t){let e=this;if(!haveGoogleChartsLoaded()){let t=function(){e.updateUI()};return this.setDisplayMessage(this.getLoadingMessage()),void setTimeout(t,1e3)}if(a.updateUI.call(this,t),!this.hasData())return void this.setDisplayMessage(this.getLoadingMessage());let i=this.getStandardData(null,{includeIndex:!0}),s=this.getDataValues(i[0]),l=this.getProperty("showIndex",!0),r=this.getProperty("showValue",!0),o=this.getProperty("textColor","black"),n=this.getProperty("cellHeight",null),h="";this.getProperty("showBorder")&&(h=HU.css("border-bottom","1px #666 solid"));let d="";n&&(d+=HU.css("height",n+"px","max-height",n+"px","min-height",n+"px"));let p=this.dataCollection.getList()[0].getRecordFields(),g=this.getSelectedFields([]);0==g.length&&(g=p);let c="",u=null,y=null,m=null;if(Utils.stringDefined(this.getProperty("colorByMins"))){y=[];let t=this.getProperty("colorByMins").split(",");for(let e=0;e<t.length;e++)y.push(parseFloat(t[e]))}if(Utils.stringDefined(this.getProperty("colorByMaxes"))){m=[];let t=this.getProperty("colorByMaxes").split(",");for(let e=0;e<t.length;e++)m.push(parseFloat(t[e]))}if(Utils.stringDefined(this.getProperty("colorTables"))){let t=this.getProperty("colorTables").split(",");u=[];for(let e=0;e<t.length;e++){let i=t[e];if("none"==i){u.push(null);continue}let a=Utils.getColorTable(i,!0);u.push(a)}}else u=[this.getColorTable(!0)];let f=null,D=null;for(let t=1;t<i.length;t++){let e=this.getDataValues(i[t]);if(null==f){f=[],D=[];for(let t=1;t<e.length;t++)f.push(Number.MAX_VALUE),D.push(Number.MIN_VALUE)}for(let t=0;t<g.length;t++){let i=g[t],a=i.getIndex()+1;if(!i||!i.isFieldNumeric()||i.isFieldGeo())continue;let s=e[a];s!=Number.POSITIVE_INFINITY&&!isNaN(s)&&Utils.isNumber(s)&&Utils.isDefined(s)&&null!=s&&(f[t]=Math.min(f[t],s),D[t]=Math.max(D[t],s))}}c+=HU.open(TABLE,["border","0",CLASS,"display-heatmap"]),c+=HU.open(TR,[VALIGN,"bottom"]),l&&(c+=HU.td([ALIGN,"center"],HU.div([CLASS,"display-heatmap-heading-top"],s[0])));for(let t=0;t<g.length;t++){let e=g[t];e.isFieldNumeric()&&!e.isFieldGeo()&&(c+=HU.td([ALIGN,"center"],HU.div([CLASS,"display-heatmap-heading-top"],this.getFieldLabel(e))))}c+=HU.close(TR);for(let t=1;t<i.length;t++){let e=this.getDataValues(i[t]),a=e[0];a.f&&(a=a.f);let n=a;c+=HU.open("tr",["valign","center"]),l&&(c+=HU.td([CLASS,"display-heatmap-heading-side",STYLE,d+h],n));let p=0;for(let t=0;t<g.length;t++){let i=g[t],a=i.getIndex()+1;if(!i||!i.isFieldNumeric()||i.isFieldGeo())continue;let l="",I=e[a],T=f[t],b=D[t];y&&p<y.length&&(T=y[p]),m&&p<m.length&&(b=m[p]);let S,v=T!=b&&!(I==Number.POSITIVE_INFINITY||isNaN(I)||!Utils.isNumber(I)||!Utils.isDefined(I)||null==I),x=s[0]+": "+n+" - "+this.getFieldLabel(i)+": "+I;if(v&&null!=u){let t=u[Math.min(p,u.length-1)];if(t){let e=parseInt((I-T)/(b-T)*t.length);e>=t.length?e=t.length-1:e<0&&(e=0),l="background-color:"+t[e]+";"}}S=v?Utils.formatNumber(I):"-",r||(S=""),c+=HU.td(["valign","center","align","right",STYLE,l+d+h,CLASS,"display-heatmap-cell"],HU.div([TITLE,x,STYLE,d+HU.css("color",o)],S)),p++}c+=HU.close(TR)}c+=HU.close(TABLE),this.setContents(c),this.initTooltip()}})}function RamaddaRankingDisplay(t,e,i){const a="rankingtable";$.extend(this,{height:"500px",sortAscending:!1}),i.sortAscending&&(this.sortAscending="true"==i.sortAscending);const s=new RamaddaFieldsDisplay(t,e,DISPLAY_RANKING,i);defineDisplay(addRamaddaDisplay(this),s,[{label:"Ranking"},{p:"sortField",ex:""},{p:"nameFields",ex:""}],{needsData:function(){return!0},handleEventPointDataLoaded:function(t,e){this.needsData()||null==this.dataCollection&&(this.dataCollection=t.dataCollection,this.updateUI())},fieldSelectionChanged:function(){this.updateUI()},updateUI:function(t){s.updateUI.call(this,t);let e=this.records=this.filterData();if(null==e)return void this.setDisplayMessage(this.getLoadingMessage());this.idToRecord={},e.forEach((t=>{this.idToRecord[t.getId()]=t}));let i=this.dataCollection.getList()[0].getRecordFields(),l=this.getSelectedFields([]);0==l.length&&(l=i);let r=this.getFieldsByType(l,"numeric"),o=this.getFieldById(r,this.getProperty("sortField","",!0));if(0==r.length)return void this.setContents("No fields specified");if(o||(o=r[0]),!o)return void this.setDisplayMessage("No fields specified");let n=this.getFieldsByIds(i,this.getProperty("nameFields","",!0));if(0==n.length){let t=this.getFieldById(i,this.getProperty("nameField","",!0));t&&n.push(t)}if(0==n.length){let t=this.getFieldByType(i,"string");t&&n.push(t)}let h=HU.open("select",[CLASS,"ramadda-pulldown",ID,this.domId("sortfields")]);for(let t=0;t<r.length;t++){let e=r[t],i="";e.getId()==o.getId()&&(i=" selected "),h+=HU.tag("option",["value",e.getId(),i,null],this.getFieldLabel(e))}h+=HU.close("select");let d="";d+=HU.span([ID,this.domId("sort")],HU.getIconImage(this.sortAscending?"fa-sort-up":"fa-sort-down",[STYLE,HU.css("cursor","pointer"),TITLE,"Change sort order"])),this.getProperty("showRankingMenu",!0)&&(d+=" "+HU.div([STYLE,HU.css("display","inline-block"),CLASS,"display-filterby"],h)),this.jq(ID_TOP_LEFT).html(d),this.jq("sort").click((()=>{this.sortAscending=!this.sortAscending,this.sortAscending?this.jq("sort").html(HU.getIconImage("fa-sort-up",[STYLE,HU.css("cursor","pointer")])):this.jq("sort").html(HU.getIconImage("fa-sort-down",[STYLE,HU.css("cursor","pointer")])),this.updateUI()}));let p="";p+=HU.open(DIV,[STYLE,HU.css("max-height","100%","overflow-y","auto")]),p+=HU.open(TABLE,[ID,this.domId(a)]);let g=e,c=this.getProperty("includeNaN",!1);if(!c){let t=[];g.map((e=>{let i=o.getValue(e);isNaN(i)||t.push(e)})),g=t}let u=this.getFilterHighlight(),y=(t,e)=>{let i=e,a=t.isHighlight(this),s=i.isHighlight(this);if(u){if(a&&!s)return 1;if(!a&&s)return-1}let l=this.getDataValues(t),r=this.getDataValues(e),n=l[o.getIndex()],h=r[o.getIndex()];return n<h?-1:n>h?1:0};g.sort(((t,e)=>{let i=y(t,e);return 0==i?0:this.sortAscending?i:-i}));for(let t=0;t<g.length;t++){let e=g[t],i=(this.getDataValues(e),"");if(n.map((t=>{i+=t.getValue(e)+" "})),i=i.trim(),value=o.getValue(e),isNaN(value)||null===value){if(!c)continue;value="NA"}else value=this.formatNumber(value);p+=HU.tr([VALIGN,"top",CLASS,"display-ranking-row","what",e.getId()],HU.td([],"#"+(t+1))+HU.td([],SPACE+i)+HU.td([ALIGN,"right"],SPACE+value))}p+=HU.close(TABLE),p+=HU.close(DIV),this.setContents(p);let m=this;this.jq(a).find(".display-ranking-row").click((function(t){let e=m.idToRecord[$(this).attr("what")];m.propagateEventRecordSelection({record:e})})),HU.initSelect(this.jq("sortfields")),this.jq("sortfields").change((function(){m.setProperty("sortField",$(this).val()),m.updateUI()}))}})}function RamaddaCrosstabDisplay(t,e,i){const a="crosstab",s=new RamaddaFieldsDisplay(t,e,DISPLAY_CROSSTAB,i);defineDisplay(addRamaddaDisplay(this),s,[],{needsData:function(){return!0},handleEventPointDataLoaded:function(t,e){this.needsData()||null==this.dataCollection&&(this.dataCollection=t.dataCollection,this.updateUI())},fieldSelectionChanged:function(){this.updateUI()},updateUI:function(t){if(s.updateUI.call(this,t),!this.hasData())return void this.setDisplayMessage(this.getLoadingMessage());let e=this.dataCollection.getList()[0].getRecordFields(),i=[];e.map((t=>{let e=this.getFieldLabel(t);e.length>30&&(e=e.substring(0,29)),i.push([t.getId(),e])}));let l=HU.span([CLASS,"display-filterby"],"Display: "+HU.select("",[STYLE,"",ID,this.domId("crosstabselect")],i,this.getProperty("column","",!0)));this.setContents(l+HU.div([ID,this.domId(a)]));let r=this;this.jq("crosstabselect").change((function(){r.setProperty("column",$(this).val()),r.makeTable()})),this.makeTable()},makeTable:function(){let t=this.getStandardData(null,{includeIndex:!1}),e=this.dataCollection.getList()[0].getRecordFields(),i=this.getFieldById(null,this.getProperty("column","",!0)),s=this.getFieldsByIds(null,this.getProperty("rows",null,!0));i||(i=e[0]),0==s.length&&(s=e);let l=HU.open(TABLE,["border","1px","bordercolor","#ccc",CLASS,"display-crosstab","cellspacing","1","cellpadding","2"]),r=t.length-1,o=0;s.map((e=>{if(e.getId()==i.getId())return;o++;let a=[],s=[],n={},h={};for(let l=1;l<t.length;l++){let r=this.getDataValues(t[l]),o=(""+r[i.getIndex()]).trim(),d=(""+r[e.getIndex()]).trim(),p=o+"--"+d;a.indexOf(o)<0&&a.push(o),s.indexOf(d)<0&&s.push(d),d in h||(h[d]=0),h[d]++,p in n||(n[p]=0),n[p]++}a.sort(),s.sort(),1==o&&(l+=HU.tr([],HU.td()+HU.td([ALIGN,"center",CLASS,"display-crosstab-header","colspan",a.length],i.getLabel())+HU.td([],SPACE))),l+=HU.open(TR,[VALIGN,"bottom",CLASS,"display-crosstab-header-row"],HU.td([CLASS,"display-crosstab-header"],e.getLabel()));for(let t=0;t<a.length;t++){let e=a[t];l+=HU.td([],""==e?"&lt;blank&gt;":e)}l+=HU.td([],HU.b("Total")),l+=HU.close(TR);for(let t=0;t<s.length;t++){let e=s[t];l+=HU.open(TR),l+=HU.td([],""==e?"&lt;blank&gt;":e);for(let t=0;t<a.length;t++){let i=a[t]+"--"+e;if(Utils.isDefined(n[i])){let t=Math.round(n[i]/r*100)+"%";l+=HU.td([ALIGN,"right"],n[i]+"&nbsp;("+t+")")}else l+=HU.td([],SPACE)}let i=Math.round(h[e]/r*100)+"%";l+=HU.td([ALIGN,"right"],h[e]+SPACE+"("+i+")"),l+=HU.close(TR)}})),l+=HU.close(TABLE),this.jq(a).html(l)}})}function RamaddaCorrelationDisplay(t,e,i){const a="sliderlow",s="sliderlowmin",l="sliderlowmax",o="sliderhigh",n="sliderhighmin",h="sliderhighmax",d="table",p="lastrow";$.extend(this,{colorTable:"red_white_blue",colorByMin:"-1",colorByMax:"1"});const g=new RamaddaFieldsDisplay(t,e,DISPLAY_CORRELATION,i);defineDisplay(addRamaddaDisplay(this),g,[{label:"Correlation"},{p:"showSelectSlider",ex:"false",d:!0},{p:"range.low.min",ex:"-1"},{p:"range.low.max",ex:"0"},{p:"range.high.min",ex:"0"},{p:"range.high.max",ex:"1"},{p:"short",ex:"true",tt:"Abbreviated display"},{p:"showValue",ex:"false",tt:"Show the values"},{p:"useId ",ex:" true",tt:"Use field id instead of label"},{p:"useIdTop",ex:"true",tt:"Use field id for top header"},{p:"useIdSide ",ex:"true",tt:"Use field id for side header"},{p:"labelStyle",ex:"",tt:"CSS style for labels"}],{"map-display":!1,needsData:function(){return!0},getMenuItems:function(t){g.getMenuItems.call(this,t);this.getGet();let e=HU.formTable(),i=this.getColorTableName(),a=HU.open("select",[ID,this.domId("colortable")]);for(table in Utils.ColorTables)table==i?a+=HU.tag("option",["selected",null],table):a+=HU.tag("option",[],table);a+=HU.close("select"),e+=HU.formEntry("Color Bar:",a),e+=HU.formEntry("Color By Range:",HU.input("",this.colorByMin,["size","7",ATTR_ID,this.domId("colorbymin")])+" - "+HU.input("",this.colorByMax,["size","7",ATTR_ID,this.domId("colorbymax")])),e+=HU.close(TABLE),t.push(e)},initDialog:function(){g.initDialog.call(this);let t=this,e=function(){t.colorByMin=t.jq("colorbymin").val(),t.colorByMax=t.jq("colorbymax").val(),t.updateUI()};this.jq("colorbymin").blur(e),this.jq("colorbymax").blur(e),this.jq("colortable").change((function(){t.colorTable=t.jq("colortable").val(),t.updateUI()}))},handleEventPointDataLoaded:function(t,e){this.needsData()||null==this.dataCollection&&(this.dataCollection=t.dataCollection,this.updateUI())},fieldSelectionChanged:function(){this.updateUI()},updateUI:function(t){if(g.updateUI.call(this,t),!this.hasData())return void this.setDisplayMessage(this.getLoadingMessage());let e=this,i="";if(this.range={low:{min:this.getProperty("range.low.min",-1),max:this.getProperty("range.low.max",0)},high:{min:this.getProperty("range.high.min",0),max:this.getProperty("range.high.max",1)}},this.getShowSelectSlider()){let t=HU.div([STYLE,HU.css("display","inline-block")],"Low Range"+HU.tag(BR)+HU.div([ID,this.gid(s),STYLE,HU.css(WIDTH,"50px","display","inline-block","text-align","right","margin-right","15px")],this.range.low.min)+HU.div([STYLE,HU.css(HEIGHT,"20px","display","inline-block",WIDTH,"200px","background","#A6A6FF"),ID,this.gid(a)])+HU.div([ID,this.gid(l),STYLE,HU.css("text-align","left","width","50px","display","inline-block","margin-left","15px")],this.range.low.max)),e=HU.div(["display","inline-block;"],"High Range"+HU.tag(BR)+HU.div([ID,this.gid(n),STYLE,HU.css("width","50px","display","inline-block","text-align","right","margin-right","15px")],this.range.high.min)+HU.div([STYLE,HU.css(HEIGHT,"20px","display","inline-block","width","200px","background","#FD9596"),ID,this.gid(o)])+HU.div([ID,this.gid(h),STYLE,HU.css("text-align","left","width","50px","display","inline-block","margin-left","15px")],this.range.high.max));i+=HU.center(HU.hrow(t,e))}i+=HU.div([ID,this.domId(d)]),this.setContents(i),this.makeTable(),this.getShowSelectSlider()&&(this.jq(a).slider({range:!0,min:0,max:100,values:[100*(this.range.low.min+1),100*(this.range.low.max+1)],slide:function(t,i){let a=i.values[0]/100-1,r=i.values[1]/100-1,o=-1==a?-1:number_format(a,3),n=0==r?0:number_format(r,3);e.jq(s).html(o),e.jq(l).html(n)},stop:function(t,i){e.range.low.min=2*i.values[0]/100-1,e.range.low.max=2*i.values[1]/100-1,e.makeTable()}}),this.jq(o).slider({range:!0,min:0,max:100,values:[100*this.range.high.min,100*this.range.high.max],slide:function(t,i){let a=i.values[0]/100,s=i.values[1]/100;e.jq(n).html(0==a?0:number_format(a,3)),e.jq(h).html(1==s?1:number_format(s,3))},stop:function(t,i){e.range.high.min=i.values[0]/100,e.range.high.max=i.values[1]/100,e.makeTable()}})),this.initTooltip(),this.displayManager.propagateEventRecordSelection(this,this.dataCollection.getList()[0],{index:0})},makeTable:function(){let t=this.getStandardData(null,{includeIndex:!1}),e=this.dataCollection.getList()[0].getRecordFields(),i=this.getSelectedFields([]);0==i.length&&(i=e),i=i.filter((t=>!(!t.isFieldNumeric()||t.isFieldGeo())));let a=i.length,s="";i.length>8&&(s+=HU.openTag("div",[STYLE,HU.css("font-size","75%")])),s+=HU.open(TABLE,["cellspacing","0","cellpadding","0","border","0",CLASS,"display-correlation","width","100%"]);let l=90/a+"%";s+=HU.open(TR,["valign","bottom"])+HU.td([CLASS,"display-heading","width","10%"],SPACE);let o=this.getProperty("short",!1),n=this.getProperty("showValue",!o),h=this.getProperty("useId",!1),g=this.getProperty("useIdTop",h),c=this.getProperty("useIdSide",h),u=this.getProperty("labelStyle","");i.forEach((t=>{if(!t.isFieldNumeric()||t.isFieldGeo())return;let e=g?t.getId():this.getFieldLabel(t);o&&(e=""),e=e.replace(/\/ +/g,"/").replace(/ +\//g,"/"),e=HU.span([STYLE,u],e),s+=HU.td(["colfield",t.getId(),"align","center","width",l],HU.div([CLASS,"display-correlation-heading display-correlation-heading-top"],e))})),s+=HU.close(TR),this.getProperty("colorTable")||this.setProperty("colorTable","blue_white_red");let y=this.getColorTable(!0);colorByMin=parseFloat(this.colorByMin),colorByMax=parseFloat(this.colorByMax),y&&(y=this.addAlpha(y,.5));for(let e=0;e<i.length;e++){let a=i[e];if(!a.isFieldNumeric()||a.isFieldGeo())continue;let l=c?a.getId():this.getFieldLabel(a);l.replace(/ /g,SPACE),l=HU.span([STYLE,u],l),s+=HU.open(TR,["valign","center"]),s+=HU.td(["rowfield",a.getId(),CLASS,"display-correlation-heading"],HU.div([CLASS,"display-correlation-heading-side"],l));let h=this.getFieldLabel(a);for(let l=0;l<i.length;l++){let d=i[l];if(!d.isFieldNumeric()||d.isFieldGeo())continue;let p=this.getFieldLabel(d),g=0,c=0,u=0;for(let e=1;e<t.length;e++){let i=this.getDataValues(t[e]),s=i[a.getIndex()],l=i[d.getIndex()];g+=s,c+=l,u++}let m=g/u,f=c/u,D=0,I=0,T=0;for(let e=1;e<t.length;e++){let i=this.getDataValues(t[e]),s=i[a.getIndex()],l=i[d.getIndex()];D+=(s-m)*(l-f),I+=(s-m)*(s-m),T+=(l-f)*(l-f)}r=D/Math.sqrt(I*T);let b=r<0?r>=this.range.low.min&&r<=this.range.low.max:r>=this.range.high.min&&r<=this.range.high.max,S="";if(b&&null!=y)if(e!=l){let t=(r-colorByMin)/(colorByMax-colorByMin),e=parseInt(t*y.length);e>=y.length?e=y.length-1:e<0&&(e=0),S=HU.css("background-color",y[e])}else S=HU.css("background-color","#eee");let v=r.toFixed(3),x=v;e==l&&(x=SPACE),n&&!o||(x=SPACE);let U="";b&&(U=HU.div([CLASS,"display-correlation-element",TITLE,"&rho;("+h+","+p+") = "+v],x)),s+=HU.td(["colfield",d.getId(),"rowfield",a.getId(),CLASS,"display-correlation-cell","align","right",STYLE,S],U)}s+=HU.close(TR)}s+=HU.tr([],HU.td([])+HU.td(["colspan",a+1],HU.div([ID,this.domId(p)],""))),s+=HU.close(TABLE),this.jq(d).html(s);let m,f,D=this;this.jq(d).find("td").click((function(){let t=D.getFieldById(null,$(this).attr("rowfield")),e=D.getFieldById(null,$(this).attr("colfield")),i=D.jq(d).find("td");t&&(i.removeClass("display-correlation-row-cell-highlight"),t!=m?(m=t,D.jq(d).find(".display-correlation-cell[rowfield='"+t.getId()+"']").addClass("display-correlation-row-cell-highlight")):m=null),e&&(i.removeClass("display-correlation-col-cell-highlight"),e!=f?(f=e,D.jq(d).find(".display-correlation-cell[colfield='"+e.getId()+"']").addClass("display-correlation-col-cell-highlight")):f=null)})),this.displayColorTable(y,p,colorByMin,colorByMax)}})}function RamaddaRecordsDisplay(t,e,i,a){const s=new RamaddaFieldsDisplay(t,e,DISPLAY_RECORDS,i);defineDisplay(addRamaddaDisplay(this),s,[{label:"Records"},{p:"maxHeight",ex:"400px"},{p:"showCards",ex:"true",d:!0}],{needsData:function(){return!0},handleEventPointDataLoaded:function(t,e){this.needsData()||null==this.dataCollection&&(this.dataCollection=t.dataCollection,this.updateUI())},getFieldsToSelect:function(t){return t.getRecordFields()},defaultSelectedToAll:function(){return!0},fieldSelectionChanged:function(){s.fieldSelectionChanged.call(this),this.updateUI()},updateUI:function(t){s.updateUI.call(this,t);let e=this.filterData();if(!e)return void this.setDisplayMessage(this.getLoadingMessage());this.records=e;let i=this,a=this.getSelectedFields(this.getData().getRecordFields()),l="",r=this.getShowCards();r&&(l+=HU.open("div",[CLASS,"display-records-grid"]));for(let t=0;t<e.length;t++){let i="",s=this.getDataValues(e[t]);for(let t=0;t<a.length;t++){let e=a[t],l=s[e.getIndex()];l.getTime&&(l=this.formatDate(l)),i+=HU.b(this.getFieldLabel(e))+": "+l+"<br>\n"}let o=HU.div([CLASS,r?"":"display-records-record",RECORD_INDEX,t,RECORD_ID,e[t].getId()],i);r&&(o=HU.div([CLASS,"display-records-grid-box"],o)),l+=o}r&&(l+=HU.close("div"));let o=this.getProperty("maxHeight","400px");o.endsWith("px")||(o+="px"),this.setContents(HU.div([STYLE,HU.css("max-height",o,"overflow-y","auto")],l)),this.find(".display-records-record").click((function(){let t=i.records[$(this).attr(RECORD_INDEX)];t&&i.propagateEventRecordSelection({highlight:!0,record:t})}))},handleEventRecordSelection:function(t,e){}})}function RamaddaStatsDisplay(t,e,i,a){const s=new RamaddaFieldsDisplay(t,e,a||DISPLAY_STATS,i);a||addRamaddaDisplay(this);defineDisplay(this,s,[{label:"Summary Statistics"},{p:"showDefault",ex:"false"},{p:"showMin",ex:"false"},{p:"showMax",ex:"false"},{p:"showAverage",ex:"false"},{p:"showStd",ex:"false"},{p:"showPercentile",ex:"false"},{p:"showCount",ex:"false"},{p:"showTotal",ex:"false"},{p:"showPercentile",ex:"false"},{p:"showMissing",ex:"false"},{p:"showUnique",ex:"false"},{p:"showType",ex:"false"},{p:"showText",ex:"false"},{p:"sortStatsBy",ex:"min|max|total|average"},{p:"sortStatsAscending",ex:"false"},{p:"doValueSelection",ex:"false"},{p:"fieldHeaderLabel",ex:""},{p:"statsTableWidth",ex:"100%"}],{"map-display":!1,needsData:function(){return!0},handleEventPointDataLoaded:function(t,e){this.needsData()||null==this.dataCollection&&(this.dataCollection=t.dataCollection,this.updateUI())},getDefaultSelectedFields:function(t,e){if(null!=e&&e.length>0)return e;let i=[];return t.forEach((t=>{(this.getShowText()||t.isNumeric())&&(t.isFieldGeo()||i.push(t))})),i},getFieldsToSelect:function(t){return t.getRecordFields()},defaultSelectedToAll:function(){return!0},fieldSelectionChanged:function(){s.fieldSelectionChanged.call(this),this.updateUI()},updateUI:function(t){s.updateUI.call(this,t);let e=this.filterData();if(!e)return;let i=this.getSelectedFields([]),a=[];i.forEach(((t,e)=>{a.push({field:t,isNumber:!1,count:0,min:NaN,uniqueMap:{},unique:0,std:0,max:NaN,total:0,numMissing:0,numNotMissing:0,type:t.getType(),values:[]})})),e.forEach((t=>{a.forEach((e=>{let i=e.field,a=i.getValue(t);if(a&&(Utils.isDefined(e.uniqueMap[a])?e.uniqueMap[a]++:(e.uniqueMap[a]=1,e.unique++)),e.isNumber=i.isNumeric(),e.count++,null==a?e.numMissing++:e.numNotMissing++,null!==a&&"number"==typeof a){let t=this.getFieldLabel(i).toLowerCase();if(t.indexOf("latitude")>=0||t.indexOf("longitude")>=0)return;e.total+=a,e.max=Utils.max(e.max,a),e.min=Utils.min(e.min,a),e.values.push(a)}}))}));let l=this.getProperty("showDefault",!0);this.getShowUnique(l)&&a.forEach((t=>{t.field;t.uniqueMax=0,t.uniqueValue="";for(let e in t.uniqueMap){let i=t.uniqueMap[e];i>t.uniqueMax&&(t.uniqueMax=i,t.uniqueValue=e)}})),this.getShowStd(l)&&a.forEach((t=>{let e=t.values;if(e.length>0){let i=t.total/e.length,a=0;for(let t=0;t<e.length;t++){let s=e[t]-i;a+=s*s}let s=a/e.length;t.std=Math.sqrt(s)}}));let r=[ID,this.getDomId("statstable"),CLASS,"row-border stripe  display-stats"],o=this.getStatsTableWidth();o&&(r.push("width"),r.push(o));let n=HU.open(TABLE,r);n+=HU.open(THEAD),header=[this.getFieldHeaderLabel("")],this.getShowCount(l)&&header.push("Count"),this.getShowMin(l)&&header.push("Min"),this.getShowPercentile(l)&&header.push("25%","50%","75%"),this.getShowMax(l)&&header.push("Max"),this.getShowTotal(l)&&header.push("Total"),this.getShowAverage(l)&&header.push("Average"),this.getShowStd(l)&&header.push("Std"),this.getShowUnique(l)&&header.push("# Unique","Top","Freq."),this.getShowMissing(l)&&header.push("Not&nbsp;Missing","Missing"),n+=HU.tr(["valign","bottom"],HU.ths([CLASS,"display-stats-header","align","center"],header)),n+=HU.close(THEAD),n+=HU.open(TBODY);let h=this.getDoValueSelection(!1);a.forEach((t=>{t.average=0==t.numNotMissing?NaN:t.total/t.numNotMissing}));let d=this.getSortStatsBy(),p=this.getSortStatsAscending(!0);if(d){let t=(t,e)=>{let i=0;return"total"==d?i=t.total-e.total:"min"==d?i=t.min-e.min:"max"==d?i=t.max-e.max:"average"==d&&(i=t.average-e.average),0==i||p?i:-i};a.sort(t)}if(a.forEach((t=>{let e=t.field,i="",a=SPACE,s=this.getFieldLabel(e).toLowerCase(),r=0==t.numNotMissing?"NA":this.formatNumber(t.total/t.numNotMissing);s.indexOf("%")<0&&s.indexOf("percent")<0&&s.indexOf("median")<0&&(a=this.formatNumber(t.total));let o=[];if(!t.isNumber&&this.getShowText(l))this.getShowCount(l)&&o.push(t.count),this.getShowMin(l)&&o.push("-"),this.getShowPercentile(l)&&o.push("-","-","-"),this.getShowMax(l)&&o.push("-"),o.push("-"),this.getShowAverage(l)&&o.push("-"),this.getShowStd(l)&&o.push("-"),this.getShowUnique(l)&&o.push(t.unique,t.uniqueValue,t.uniqueMax),this.getShowMissing(l)&&o.push(t.numNotMissing,t.numMissing);else{if(this.getShowCount(l)&&o.push(t.count),this.getShowMin(l)&&o.push(this.formatNumber(t.min)),this.getShowPercentile(l)){let e=t.max-t.min,i=i=>{let a=this.formatNumber(t.min+e*i);h&&(a=HU.span([CLASS,"display-stats-value","data-type","percentile","data-value",i],a)),o.push(a)};[.25,.5,.75].map((t=>i(t)))}this.getShowMax(l)&&o.push(this.formatNumber(t.max)),this.getShowTotal(l)&&o.push(a),this.getShowAverage(l)&&o.push(r),this.getShowStd(l)&&o.push(this.formatNumber(t.std)),this.getShowUnique(l)&&(o.push(t.unique),Utils.isNumber(t.uniqueValue)?o.push(this.formatNumber(t.uniqueValue)):o.push(t.uniqueValue),o.push(t.uniqueMax)),this.getShowMissing(l)&&o.push(t.numNotMissing,t.numMissing)}i=HU.tds(["align","right"],o);let d=this.getFieldLabel(e),p=d.split("!!"),g="";g+=e.getId(),e.description&&""!=e.description&&(g+="\n"+e.description+"\n"),d=p[p.length-1],Utils.stringDefined(e.unit)&&(d=d+" ["+e.unit+"]"),d=d.replace(/ /g,SPACE);let c=HU.tr([],HU.td(["nowrap","true","align","left"],e.getTypeLabel()+SPACE+HU.b(HU.span([TITLE,g],d)))+i);n+=c})),n+=HU.close(TBODY,TABLE),this.setContents(n),HU.formatTable("#"+this.getDomId("statstable"),{ordering:!0,aaSorting:[]}),this.initTooltip(),h){let t=this.find(".display-stats-value");t.each((function(){let t=$(this).attr("data-type"),e=$(this).attr("data-value"),i=SPACE+HU.getIconImage("fa-less-than",[TITLE,"Filter other displays",CLASS,"display-stats-value-link","data-type",t,"data-value",e],[STYLE,HU.css("font-size","8pt")]);$(this).append(i)})),t=this.find(".display-stats-value-link"),t.each((function(){}))}}})}function RamaddaCooccurenceDisplay(t,e,i){const a="table",s="sortby",l=new RamaddaDisplay(t,e,DISPLAY_COOCCURENCE,i);defineDisplay(addRamaddaDisplay(this),l,[{label:"Cooccurence"},{p:"sourceField",ex:""},{p:"targetField",ex:""},{p:"colorBy",ex:""},{p:"directed",ex:"false"},{p:"missingBackground",ex:"#eee"},{p:"showSortBy",ex:"false"},{p:"sortBy",ex:"weight"},{p:"minWeight",ex:""},{p:"topSpace",ex:"50px"}],{needsData:function(){return!0},getHeader2:function(){let t=l.getHeader2.call(this);if(this.getFieldById(null,this.getProperty("colorBy","weight"))&&this.getProperty("showSortBy",!0)){let e=[["name","Name"],["weight","Weight"]];t+=HU.div([STYLE,HU.css("display","inline-block")],"Sort by: "+HU.select("",[ID,this.domId(s)],e,this.getProperty("sortBy","")))+SPACE2}return t},initHeader2:function(){let t=this;this.jq(s).change((function(){t.setProperty("sortBy",$(this).val()),t.updateUI()}))},updateUI:function(){let t=this.filterData();if(!t)return;let e=HU.div([ID,this.domId("coocheader")])+HU.div([ID,this.domId(a)]);this.setContents(e);let i=this.getFieldById(null,this.getProperty("sourceField","source")),s=this.getFieldById(null,this.getProperty("targetField","target")),l=this.getFieldById(null,this.getProperty("colorBy","weight"));if(null==i||null==s)return void this.setDisplayMessage("No source/target fields specified");let r=this.getColorTable();r||(r=Utils.getColorTable("blues",!0));let o=this.getColorByInfo(t,null,null,r),n=[],h=[],d={},p=0,g=this.getProperty("sortBy","name"),c=this.getProperty("directed",!0),u=-999999;t.map((t=>{let e=t.getValue(i.getIndex()),a=t.getValue(s.getIndex()),r=u;l&&(r=t.getValue(l.getIndex()),p=Math.max(p,r)),n.push({name:e,weight:r}),h.push({name:a,weight:r}),c||(n.push({name:a,weight:r}),h.push({name:e,weight:r})),d[e+"--"+a]=r})),p=this.getProperty("maxWeight",p);let y=(t,e)=>"name"==g||""==g?t.name.localeCompare(e.name):e.weight-t.weight;n.sort(y),h.sort(y);let m=this.getProperty("minWeight",u),f={},D=[],I=t=>{m!=u&&(t.weight==u||t.weight<m)||f[t.name]||(f[t.name]=!0,D.push(t.name))};n.map(I),n=D,f={},D=[],h.map(I),h=D;let T=HU.div([STYLE,HU.css("margin-top",this.getProperty("topSpace","100px"))])+HU.open(TABLE,[STYLE,HU.css("height","100%"),CLASS,"display-cooc-table","order",0]);T+=HU.open(TR,["valign","bottom"])+HU.td(["border","none"]),h.map((t=>{t=t.replace(/ /g,SPACE).replace(/-/g,SPACE),T+=HU.td([STYLE,HU.css("border","none"),"width","6"],HU.div([CLASS,"display-cooc-colheader"],t))}));let b=this.getProperty("missingBackground","#eee");n.map((t=>{let e=t.replace(/ /g,SPACE);T+=HU.open(TR,["valign","bottom"])+HU.td([STYLE,HU.css("border","none"),"align","right"],HU.div([CLASS,"display-cooc-rowheader"],e)),h.map((e=>{let i=d[t+"--"+e];c||Utils.isDefined(i)||(i=d[e+"--"+t]);let a="";i?i==u||0==p?a=HU.css("background","#ccc"):o.index>=0&&(color=o.getColor(i),a=HU.css("background",color)):a=HU.css("background",b),T+=HU.td([TITLE,t+" -> "+e+(i>0?" "+i:""),"width","3"],HU.div([CLASS,"display-cooc-cell",STYLE,a+HU.css("height","100%")],SPACE))})),T+=HU.close(TR)})),T+=HU.close(TR,TABLE),T+=HU.div([STYLE,HU.css("margin","5px")]),this.jq(a).html(T),o.displayColorTable()}})}function RamaddaBoxtableDisplay(t,e,i){const a=new RamaddaDisplay(t,e,DISPLAY_BOXTABLE,i);defineDisplay(addRamaddaDisplay(this),a,[{label:"Color Boxes"},{p:"categoryField",ex:""},{p:"colorBy",ex:""},{p:"tableWidth",ex:"300"}],{needsData:function(){return!0},updateUI:function(){let t=this.filterData();if(!t)return;let e=this.getFieldById(null,this.getProperty("categoryField","category"));if(null==e)return void this.setDisplayMessage("No category field field specified");let i=this.getColorTable();i||(i=Utils.getColorTable("blues",!0));let a=this.getColorByInfo(t,null,null,i),s={},l=[];t.forEach((t=>{let i=t.getValue(e.getIndex()),r=a.index>=0?t.getValue(a.index):0,o=s[i]&&s[i].list;o||(o=[],s[i]={list:o,max:0},l.push(i)),s[i].max=Math.max(s[i].max,r),o.push(t)}));let r=HU.open(TABLE,[CLASS,"display-colorboxes-table","cellpadding",5]);this.getProperty("tableWidth",300);l.sort(((t,e)=>s[e].max-s[t].max)),l.forEach((t=>{let i=s[t].list.length,l=HU.span(["field-id",e.getId(),"field-value",t],t),o=HU.open(TR,["valign","top"],HU.td(["align","right",CLASS,"display-colorboxes-header"],l+"("+i+")"));o+=HU.open(TD,[WIDTH,"${tableWidth}"]),a.index&&s[t].list.sort(((t,e)=>e.getData()[a.index]-t.getData()[a.index])),s[t].list.map(((t,e)=>{let i="#ccc";a.index&&(i=a.getColor(t.getData()[a.index],t)||i),o+=HU.div([TITLE,"",RECORD_ID,t.getId(),CLASS,"display-colorboxes-box",STYLE,HU.css("background",i)],"")})),o+=HU.close(TD,TR),r+=o})),r+=HU.close(TABLE),this.displayHtml(r),a.displayColorTable(500),this.getProperty("tooltip")||this.setProperty("tooltip","${default}"),this.makeTooltips(this.find(".display-colorboxes-box"),t),this.addFieldClickHandler(null,t)}})}function RamaddaPercentchangeDisplay(t,e,i){const a=new RamaddaFieldsDisplay(t,e,DISPLAY_PERCENTCHANGE,i);defineDisplay(addRamaddaDisplay(this),a,[{label:"Percent Change"},{p:"template",ex:"${date1} ${date2} ${value1} ${value2} ${percent} ${per_hour} ${per_day} ${per_week} ${per_month} ${per_year}"},{p:"fieldLabel",ex:""},{p:"sortFields",ex:"false"},{p:"highlightPercent",ex:"50"},{p:"highlightPercentPositive",ex:"50"},{p:"highlightPercentNegative",ex:"-50"},{p:"highlightColor",ex:""},{p:"highlightColorPositive",ex:""},{p:"highlightColorNegative",ex:""}],{updateUI:function(){let t=this.filterData();if(!t)return;let e=this.getData().getRecordFields(),i=this.getSelectedFields(e);i=this.getFieldsByType(i,"numeric");let a=t[0],s=t[t.length-1],l=this.getProperty("template",null),r=this.getProperty("headerTemplate",""),o=this.getProperty("footerTemplate",""),n=a.getDate(),h=s.getDate(),d="Start Value",p="End Value",g=1,c=1,u=1,y=1;if(n&&(d=this.formatDate(n)),h&&(p=this.formatDate(h)),n&&h){let t=h.getTime()-n.getTime();c=t/1e3/60/60/24,g=24*c,u=c/365,y=12*u}let m="";l?m=r:(m+=HU.open(TABLE,[CLASS,"stripe nowrap ramadda-table",ID,this.domId("percentchange")]),m+=HU.open(THEAD,[]),m+="\n",m+=HU.tr([],HU.th([STYLE,HU.css("text-align","center")],this.getProperty("fieldLabel","Field"))+HU.th([STYLE,HU.css("text-align","center")],d)+HU.th([STYLE,HU.css("text-align","center")],p)+HU.th([STYLE,HU.css("text-align","center")],"Percent Change")),m+=HU.close(THEAD),m+=HU.open(TBODY,[]));let f=[];i.map((e=>{let i=0;for(let a=0;a<t.length;a++){let s=t[a].getValue(e.getIndex());if(!isNaN(s)){i=s;break}}let a=0;for(let i=t.length-1;i>=0;i--){let s=t[i].getValue(e.getIndex());if(!isNaN(s)){a=s;break}}let s=parseInt(1e3*(a-i)/i)/10;f.push({field:e,val1:i,val2:a,percent:s})})),this.getProperty("sortFields",!0)&&f.sort(((t,e)=>-(t.percent-e.percent)));let D=this.getProperty("highlightPercent",NaN),I=this.getProperty("highlightPercentPositive",D),T=this.getProperty("highlightPercentNegative",-D),b=this.getProperty("highlightColor","#ccc"),S=this.getProperty("highlightColorPositive",b),v=this.getProperty("highlightColorNegative",b);f.map((t=>{if(l){let e=l.replace("${field}",this.getFieldLabel(t.field)).replace("${value1}",this.formatNumber(t.val1)).replace("${value2}",this.formatNumber(t.val2)).replace("${percent}",this.formatNumber(t.percent)).replace("${date1}",d).replace("${date2}",p).replace("${difference}",this.formatNumber(t.val2-t.val1));e=e.replace(/\${per_hour}/g,this.formatNumber(t.percent/g)),e=e.replace(/\${per_day}/g,this.formatNumber(t.percent/c)),e=e.replace(/\${per_week}/g,this.formatNumber(t.percent/(c/7))),e=e.replace(/\${per_month}/g,this.formatNumber(t.percent/y)),e=e.replace(/\${per_year}/g,this.formatNumber(t.percent/u)),m+=e}else{let e="";isNaN(I)||t.percent>I&&(e+=HU.css("background",S)),isNaN(T)||t.percent<T&&(e+=HU.css("background",v)),m+=HU.tr([STYLE,e],HU.td([],this.getFieldLabel(t.field))+HU.td(["align","right"],this.formatNumber(t.val1))+HU.td(["align","right"],this.formatNumber(t.val2))+HU.td(["align","right"],t.percent+"%"))}})),l?m+=o:(m+=HU.close(TBODY),m+=HU.close(TABLE)),this.setContents(m),HU.formatTable("#"+this.domId("percentchange"),{ordering:!1})}})}function RamaddaDatatableDisplay(t,e,i){const s=new RamaddaDisplay(t,e,DISPLAY_DATATABLE,i);defineDisplay(addRamaddaDisplay(this),s,[{label:"Data Table"},{p:"columnSelector",ex:"date_day|date_hour|date_dow|date_month|date_year"},{p:"selectors",ex:"date_day,date_hour,date_dow,date_month,date_year,date_fieldid"},{p:"columnSelector",ex:"date_day|date_hour|date_dow|date_month"},{p:"rowSelector",ex:"date_day|date_hour|date_dow|date_month"},{p:"checkedIcon",ex:"fa-checked"},{p:"checkedTooltipHeader",ex:"${numberChecked}"},{p:"dataCheckers",ex:"match|notmatch|lessthan|greaterthan|equals|notequals(field=field,value=value,label=label,enabled=false) "},{p:"showColumnSelector",ex:"false"},{p:"showRowSelector",ex:"false"},{p:"showValues",ex:"false"},{p:"showColors",ex:"false"},{p:"showRowTotals",ex:"false"},{p:"showColumnTotals",ex:"false"},{p:"slantHeader",ex:"true"}],{needsData:function(){return!0},updateUI:function(){this.setDisplayMessage(this.getLoadingMessage());let t=this.filterData();if(!t)return;let e=this.getColorTable(!0);e||(e=Utils.getColorTable("blues",!0));let i,s=this.getDataFilters(this.getProperty("dataCheckers")),l={},r=this.getFieldsByIds(null,this.getProperty("countFields")),o={};if(this.getProperty("selectors")){i=[];let t={date_day:"Day",date_dow:"Day of Week",date_hour:"Hour",date_month:"Month",date_year:"Year"};this.getProperty("selectors").split(",").map((e=>{let a=t[e];if(!a){let t=this.getFieldById(null,e);t&&(a=this.getFieldLabel(t),o[e]=t)}a&&i.push([e,a])}))}else i=[["date_day","Day"],["date_dow","Day of Week"],["date_hour","Hour"],["date_month","Month"],["date_year","Year"]];let n=this.getProperty("columnSelector",i[0][0]),h=this.getProperty("rowSelector",i[1][0]),d=e=>{let i=[];if("date_dow"==e)Utils.dayNamesShortShort.map(((t,e)=>{i.push({id:e,label:t})}));else if("date_hour"==e){let t=["12&nbsp;AM","1","2","3","4","5","6","7","8","9","10","11","12&nbsp;PM","1","2","3","4","5","6","7","8","9","10","11"];for(let e=0;e<24;e++)i.push({id:e,label:t[e]})}else if("date_day"==e)for(let t=1;t<=31;t++)i.push({id:t,label:String(t)});else if("date_month"==e)Utils.monthNames.map(((t,e)=>{i.push({id:e,label:t})}));else if("date_year"==e){let e=[],a={};t.map((t=>{let i=t.getDate().getUTCFullYear();a[i]||(e.push(i),a[i]=!0)})),e.sort(),e.map(((t,e)=>{i.push({id:t,label:String(t)})}))}else{let a=o[e];if(a){let e={},s=!1;this.getColumnValues(t,a).values.map((t=>{s=Utils.isNumber(t),Utils.isDefined(e[t])||(e[t]=!0,i.push({id:t,label:String(t)}))})),i.sort(((t,e)=>s?t.id-e.id:t.label.localeCompare(e.label)))}}return i},p=d(n),g=d(h),c=(t,e,i)=>{if("date_dow"==t)return i[e.getDate().getDay()].id;if("date_hour"==t)return i[e.getDate().getUTCHours()].id;if("date_day"==t)return i[e.getDate().getUTCDate()-1].id;if("date_month"==t)return i[e.getDate().getUTCMonth()].id;if("date_year"==t)return e.getDate().getUTCFullYear();{let i=o[t];if(i)return e.getValue(i.getIndex())}return"null"};t.map(((t,e)=>{let i=c(h,t,g),a=c(n,t,p),o=i+"-"+a,d=l[o];d||(d=l[o]={checked:[],row:i,column:a,count:0,records:[],countFields:{}},r.forEach((t=>{d.countFields[t.getId()]={values:[],counts:{}}}))),s&&s.length>0&&this.checkDataFilters(s,t)&&d.checked.push(t),r.forEach((e=>{let i=t.getValue(e.getIndex()),a=d.countFields[e.getId()];a.counts[i]||(a.counts[i]=0,a.values.push(i)),a.counts[i]++})),d.count++,d.records.push(t)}));let u=0,y=0,m=0;for(a in l){let t=l[a];u=0==m?t.count:Math.min(t.count,u),y=0==m?t.count:Math.max(t.count,y),m++,r.forEach((e=>{let i=t.countFields[e.getId()];i.values.sort(),i.values.forEach((t=>{}))}))}let f=this.getProperty("showValues",!0),D=this.getProperty("showColors",!0),I=p.length,T=0,b=0,S={},v={};g.map((t=>{let e=0;p.map((i=>{let a=t.id+"-"+i.id;l[a]&&(e+=l[a].count)})),v[t.id]=e,T=Math.max(T,e)})),p.map((t=>{let e=0;g.map((i=>{let a=i.id+"-"+t.id;l[a]&&(e+=l[a].count)})),S[t.id]=e,b=Math.max(b,e)}));let x=this.getProperty("showRowTotals",!0),U=this.getProperty("showColumnTotals",!0),L=Math.round(100/I),E="";E+=HU.open("tr",["valign","bottom"])+HU.td([],"");let P=this.getProperty("slantHeader",!1),C=0;p.map((t=>{let e=t.label;e.length>15&&(P=!0,C=Math.max(C,Math.round(3*e.length)),C=80)})),p.map((t=>{let e=t.label;P&&(e.length>20&&(e=e.substring(0,20)+"..."),e=e.replace(/ /g,SPACE).replace("-",SPACE),e=HU.div(["tootltip",t.label,CLASS,"display-datatable-header-slant"],e)),E+=HU.td([CLASS,"display-datatable-header","align","center"],e)})),E+=HU.close(TR),g.map((t=>{let i=HU.div([],t.label.replace(/ /g,SPACE));if(E+=HU.open(TR)+HU.td([CLASS,"display-datatable-name","align","right","width","100"],i),p.map((i=>{let a=t.id+"-"+i.id,s="",r="",o=l[a],n="",h="";if(o&&(f&&(s=HU.div([CLASS,"display-datatable-value"],o.count)),h=HU.div(["data-key",a,CLASS,"display-datatable-counts"]),o.checked.length&&(n=HU.getIconImage(this.getProperty("checkedIcon","fa-check"),[TITLE,"","data-key",a,CLASS,"display-datatable-checked"])),D)){let t=(o.count-u)/(y-u),i=parseInt(t*e.length);i>=e.length?i=e.length-1:i<0&&(i=0),r=HU.css("background-color",e[i])}let d=n+h+s;E+=HU.td([CLASS,"display-datatable-cell","align","right",STYLE,r,"width",L+"%"],d)})),x){let e=v[t.id],i=Math.round(e/T*100),a=HU.div([CLASS,"display-datatable-summary-row",STYLE,HU.css("width",i+"px")],e);E+=HU.td([WIDTH,100,"valign","top"],a)}E+=HU.close(TR)})),U&&(E+=HU.open(TR,["valign","top"])+HU.td(),p.map((t=>{let e=S[t.id],i=Math.round(e/b*100),a=HU.div([CLASS,"display-datatable-summary-column",STYLE,HU.css("height",i+"px")],e);E+=HU.td([],a)}))),E+=HU.close(TR),E+=HU.open(TR,[],HU.td()),E+=HU.td(["colspan",I,CLASS,"display-datatable-footer","align","center",ID,this.domId("ct")]),E+=HU.close(TR,TABLE),C>0&&(E=HU.div([STYLE,HU.css("margin-top",C+"px")],E));let A="",w=HU.open(TR);this.getProperty("showRowSelector",!0)&&(w+=HU.td([CLASS,"display-datatable-selector","width","align","center"],HU.select("",[ID,this.domId("rowSelector")],i,h,15))),this.getProperty("showColumnSelector",!0)&&(w+=HU.td(["colspan",p.length,CLASS,"display-datatable-selector","width","90%","align","center"],HU.select("",[ID,this.domId("columnSelector")],i,n)));let H=HU.open(TABLE,[STYLE,HU.css("font-size",this.getProperty("fontSize","8pt")),CLASS,"display-colorboxes-table","cellpadding",0,"cellspacing",0,WIDTH,"100%"]);H+=HU.tr([],w),H+=E,A+=H,this.setContents(A);let R=this;this.jq("rowSelector").change((function(){R.setProperty("rowSelector",$(this).val()),R.updateUI()})),this.jq("columnSelector").change((function(){R.setProperty("columnSelector",$(this).val()),R.updateUI()}));let k=this.getProperty("pieWidth",30);this.find(".display-datatable-counts").each((function(){let t=$(this).attr("data-key"),e=l[t];r.forEach((t=>{let i=R.getFieldLabel(t)+HU.tag(BR),a=e.countFields[t.getId()],s=[];a.values.forEach((t=>{s.push([t,a.counts[t]]),i+=t+":"+a.counts[t]+SPACE+HU.tag(BR)}));let l=R.domId(e.row+"-"+e.column+"-"+t.getId());$(this).append(HU.div([CLASS,"display-datatable-piechart",ID,l,TITLE,"",STYLE,HU.css(WIDTH,k+"px",HEIGHT,k+"px")])),drawPieChart(R,"#"+l,k,k,s),$("#"+l).tooltip({content:function(){return i}})}))})),this.find(".display-datatable-checked").tooltip({content:function(){let t=$(this).attr("data-key"),e=l[t].checked;if(e.length){let t=R.getProperty("tooltip","${default}");if(""==t)return null;let i=R.getProperty("checkedTooltipHeader",HU.b("#Items: ${numberChecked}")+HU.close(BR));return i=i.replace("${numberChecked}",e.length),e.map((e=>{""!=i&&(i+=HU.open(DIV,[CLASS,"ramadda-hline"])),i+=R.getRecordHtml(e,null,t)})),HU.div([CLASS,"display-datatable-tooltip"],i)}return null}}),D&&this.displayColorTable(e,"ct",u,y,{})}})}function RamaddaSparklineDisplay(t,e,i){const a="inner";i.groupBy||(i.displayInline=!0),Utils.isDefined(i.showDisplayTop)||(i.showDisplayTop=!1),Utils.isDefined(i.showDisplayBottom)||(i.showDisplayBottom=!1);const s=new RamaddaFieldsDisplay(t,e,DISPLAY_SPARKLINE,i);defineDisplay(addRamaddaDisplay(this),s,[{label:"Sparkline"},{p:"showDate",ex:"true"},{p:"showMin",ex:"true"},{p:"showMax",ex:"true"},{p:"labelStyle",ex:""},{p:"sparklineWidth",d:60},{p:"sparklineHeight",d:20},{p:"sparklineLineColor",ex:"#000"},{p:"sparklineBarColor",ex:"MediumSeaGreen"},{p:"sparklineCircleColor",ex:"#000"},{p:"sparklineCircleRadius",ex:"1"},{p:"sparklineLineWidth",ex:"1"},{p:"sparklineShowLines",ex:"true"},{p:"sparklineShowBars",ex:"true"},{p:"sparklineShowCircles",ex:"true"},{p:"sparklineShowEndPoints",ex:"true"},{p:"sparklineEndPointRadius",ex:"2"},{p:"sparklineEndPoint1Color",ex:""},{p:"sparklineEndPoint1Color",ex:"steelblue"},{p:"sparklineEndPointRadius",ex:"2"},{p:"sparklineEndPoint2Color",ex:""},{p:"sparklineEndPoint2Color",ex:"tomato"}],{getLoadingMessage:function(t){return"Loading..."},updateUI:function(){let t=this.getPropertySparklineWidth(60),e=this.getPropertySparklineHeight(20),i=this.filteredRecords=this.filterData();if(!i)return;let s=this.getFieldById(null,this.getProperty("field"));if(null==s)return void this.setDisplayMessage("No field specified");new Date;let l=this.getPropertyShowDate(),r=this.domId(a),o=this.getColorByInfo(i),n=this.getFieldById(null,this.getProperty("groupBy")),h=n?RecordUtil.groupBy(i,this,null,n):null,d=this.getColumnValues(i,s),p=d.min,g=d.max;if(this.getProperty("useAllRecords")){let t=this.getColumnValues(this.getRecords(),s);p=t.min,g=t.max}if(h){let i=this.getProperty("labelPosition","bottom");html=HU.div([ID,this.domId(a)]),this.setContents(html),h.values.forEach(((a,l)=>{let n=h.map[a],d=r+"_"+ +l,c=HU.div([CLASS,"display-sparkline-sparkline",ID,d,STYLE,HU.css("width",t+"px","height",e+"px")]),u=HU.div([CLASS,"display-sparkline-header"],a);"top"==i?c=u+HU.tag(BR)+c:"bottom"==i&&(c=c+HU.tag(BR)+u),$("#"+r).append(HU.div([STYLE,HU.css("display","inline-block","margin","4px")],c));let y=this.getColumnValues(n,s);drawSparkLine(this,"#"+d,t,e,y.values,n,p,g,o)}))}else{html=HU.div([CLASS,"display-sparkline-sparkline",ID,this.domId(a),STYLE,HU.css("width",t+"px","height",e+"px")]),l&&(html=HU.div([CLASS,"display-sparkline-date"],this.formatDate(i[0].getTime()))+html+HU.div([CLASS,"display-sparkline-date"],this.formatDate(i[i.length-1].getTime())));let s=this.getProperty("showMin")?HU.div([CLASS,"display-sparkline-value",STYLE,this.getPropertyLabelStyle("")],this.formatNumber(d.values[0])):"",n=this.getProperty("showMax",!0)?HU.div([CLASS,"display-sparkline-value",STYLE,this.getPropertyLabelStyle("")],this.formatNumber(d.values[d.values.length-1])):"";""==s&&""==n||(html=HU.leftCenterRight(s,html,n,"1%","99%","1%",null,"padding:2px 2px;")),this.setContents(html),drawSparkLine(this,"#"+r,t,e,d.values,i,p,g,o)}new Date}})}function RamaddaPointimageDisplay(t,e,i){i.width||(i.width="200"),i.displayInline=!0;const a=new RamaddaFieldsDisplay(t,e,DISPLAY_POINTIMAGE,i);defineDisplay(addRamaddaDisplay(this),a,[{label:"Point Image"},{p:"cellShape",ex:"rect|circle"},{p:"cellSize",ex:"4"},{p:"cellFilled",ex:"false"},{p:"cellColor",ex:"false"},{p:"doHeatmap",ex:"true"},{p:"padding",ex:"5"},{p:"borderColor",ex:"#ccc"},{p:"showTooltips",ex:"false"},{p:"colorBy",ex:""}],{needsData:function(){return!0},getLoadingMessage:function(t){return"Loading..."},findClosest:function(t,e){let i=null;return t.map(((t,a)=>{let s=t[this.getId()+"_coordinates"],l=s.x-e.offsetX,r=s.y-e.offsetY,o=Math.sqrt(l*l+r*r);0==a?(i=t,minDistance=o):o<minDistance&&(minDistance=o,i=t)})),i},updateUI:function(){let t=this.filterData();if(!t)return;this.getProperty("borderColor")&&$("#"+this.getProperty(PROP_DIVID)).css("border","1px solid "+this.getProperty("borderColor"));let e={};RecordUtil.getPoints(t,e);let i=(e.east-e.west)/(e.north-e.south),a=this.getProperty("padding")?HU.css("padding",+this.getProperty("padding")+"px"):"",s=HU.div([ID,this.domId("inner"),STYLE,a]);this.setContents(s);let l=Math.round(this.jq("inner").width()),r=Math.round(l/i);this.getProperty(PROP_DIVID);s=HU.div([ID,this.domId("inner"),STYLE,HU.css("width",l+"height",r+"px")+a]),s=HU.div([ID,this.domId("inner")]),this.setContents(s);let o=this.getColorByInfo(t);e=RecordUtil.expandBounds(e,.1);let n=$.extend({colorBy:o,w:l,h:r,cell3D:this.getProperty("cell3D"),bounds:e},this.getDefaultGridByArgs());n.doHeatmap=!0;let h=this.getFields(),d=Gfx.gridData(this.getId(),h,t,n);this.jq("inner").html(HU.image(d,[TITLE,"",ID,this.domId("image")])),this.jq("inner").append(HU.div([ID,this.domId("tooltip"),STYLE,HU.css("z-index:","2000","display","none","position","absolute","background","#fff","border","1px solid #ccc","padding","0px")]));let p=this;this.getProperty("showTooltips",!0)&&(this.jq("image").mouseout((function(t){p.jq("tooltip").hide()})),this.jq("image").mousemove((function(e){let i=p.findClosest(t,e);if(i){let t=HU.div([STYLE,HU.css("max-height","400px","overflow-y","auto")],p.getRecordHtml(i));p.jq("tooltip").html(t),p.jq("tooltip").show()}}))),this.jq("image").click((e=>{p.mouseEvent=event;let i=this.findClosest(t,e);i&&this.propagateEventRecordSelection({record:i})}))}})}function RamaddaCanvasDisplay(t,e,i){const a=new RamaddaFieldsDisplay(t,e,DISPLAY_CANVAS,i);defineDisplay(addRamaddaDisplay(this),a,[{label:"Canvas"},{p:"canvasWidth",d:100,ex:"100",tt:"Canvas width"},{p:"canvasHeight",d:100,ex:"100",tt:"Canvas height"},{p:"canvasStyle",d:"",ex:"",tt:"Canvas CSS style"},{p:"titleTemplate",tt:"Template to show as title"},{p:"topTitleTemplate",tt:"Template to show as top title"},{p:"urlField",tt:"Url Field"},{p:"iconField",tt:"Icon Field"},{p:"highlightStyle",tt:"Highlight Style"},{p:"unHighlightStyle",tt:"Unhighlight Style"},{p:"canvasOrigin",d:"sw",ex:"center",tt:"Origin point for drawing glyphs"},{label:"label glyph",p:"glyph1",ex:"type:label,pos:sw,dx:10,dy:-10,label:field_colon_ ${field}_nl_field2_colon_ ${field2}"},{label:"rect glyph",p:"glyph1",ex:"type:rect,pos:sw,dx:10,dy:0,colorBy:field,width:150,height:100"},{label:"circle glyph",p:"glyph1",ex:"type:circle,pos:n,dx:10,dy:-10,fill:true,colorBy:field,width:20,baseWidth:5,sizeBy:field"},{label:"3dbar glyph",p:"glyph1",ex:"type:3dbar,pos:sw,dx:10,dy:-10,height:30,width:8,baseHeight:5,sizeBy:field"},{label:"gauge glyph",p:"glyph1",ex:"type:gauge,color:#000,pos:sw,width:50,height:50,dx:10,dy:-10,sizeBy:field,sizeByMin:0"}],{needsData:function(){return!0},updateUI:function(){let t=this.filterData(),e=this.getFields();if(!t)return;if(0==t.length)return void this.setDisplayMessage(this.getNoDataMessage());let i=this.getPropertyCanvasStyle(""),a=this.getPropertyHighlightStyle(""),s=this.getPropertyUnHighlightStyle(""),l=(this.getProperty("columns"),""),r=this.getPropertyCanvasWidth(),o=this.getPropertyCanvasHeight(),n=this.getPropertyTitleTemplate(),h=this.getPropertyTopTitleTemplate(),d=this.getFieldById(null,this.getPropertyUrlField()),p=this.getFieldById(null,this.getPropertyIconField()),g=this.getFilterHighlight();t.forEach(((t,e)=>{let c=t.isHighlight(this),u=this.domId("canvas_"+e),y="display-canvas-canvas",m=i;g&&(c?(y+=" display-canvas-canvas-highlight ",m+=" "+a):(y+=" display-canvas-canvas-unhighlight ",m+=" "+s));let f=HU.tag("canvas",[CLASS,y,STYLE,m,WIDTH,r,HEIGHT,o,ID,u]),D=p?HU.image(t.getValue(p.getIndex()))+"&nbsp;":"",I=h?HU.div([CLASS,"display-canvas-title"],D+this.getRecordHtml(t,null,h)):D,T=n?HU.div([CLASS,"display-canvas-title"],this.getRecordHtml(t,null,n)):"",b=HU.div([TITLE,"",CLASS,"display-canvas-block",RECORD_INDEX,e,RECORD_ID,t.getId()],I+f+T);if(d){let e=t.getValue(d.getIndex());Utils.stringDefined(e)&&(b=HU.href(e,b))}l+=b})),this.setContents(l);let c=[],u=1;for(;u<11;){let i=this.getProperty("glyph"+u++);i&&c.push(new Glyph(this,1,e,t,{canvasWidth:r,canvasHeight:o},i))}let y={},m="center"==this.getPropertyCanvasOrigin()?o/2:o;t.forEach(((t,e)=>{let i=this.domId("canvas_"+e),a=document.getElementById(i),s=a.getContext("2d");c.forEach((e=>{e.draw(y,a,s,0,m,{record:t})}))}));let f=this.find(".display-canvas-block");this.makeTooltips(f,t,null,"${default}")}})}function RamaddaFieldtableDisplay(t,e,i){const a="fieldtable",s=new RamaddaFieldsDisplay(t,e,DISPLAY_FIELDTABLE,i);defineDisplay(addRamaddaDisplay(this),s,[{label:"Field Table"},{p:"field",ex:""},{p:"labelField",ex:"field"},{p:"columnWidth",ex:"150"},{p:"tableHeight",ex:"300"},{p:"markerShape",ex:"circle|rect|triangle|bar|arrow|dart|bar"},{p:"markerSize",ex:"16"},{p:"markerFill",ex:"#64CDCC"},{p:"markerStroke",ex:"#000"}],{needsData:function(){return!0},updateUI:function(){let t=this.filterData();if(!t)return;let e=this.getFieldsByIds(null,this.getPropertyFields());0==e.length&&(e=this.getFieldsByType(null,"numeric"));let i=this.getFieldById(null,this.getProperty("labelField"));i||(i=this.getFieldsByType(null,"string")[0]);let s=HU.open(TABLE,[CLASS,"","border",0,ID,this.domId(a)]);s+=HU.open(THEAD);let l=this.getProperty("columnWidth",150);s+=HU.open(TR,[]),s+=HU.td(["width",l],HU.div([CLASS,"display-fieldtable-header"],i?this.getFieldLabel(i):""));let r={};e.forEach((e=>{r[e.getId()]=this.getColumnValues(t,e)})),e.forEach((t=>{s+=HU.th(["width",l],HU.div([CLASS,"display-fieldtable-header"],this.getFieldLabel(t)))})),s+=HU.close(TR,THEAD),s+=HU.open(TBODY);let o=this.getProperty("markerShape","bar"),n=[],h={},d=0,p=this.getProperty("markerSize",16);e.forEach((e=>{h[e.getId()]=this.getColorByInfo(t,e)})),t.forEach(((t,a)=>{let g=i?t.getValue(i.getIndex()):"#"+(a+1),c=[CLASS,"display-fieldtable-rowheader"];i&&(c.push("field-id"),c.push(i.getId()),c.push("field-value"),c.push(t.getValue(i.getIndex()))),s+=HU.open(TR,["valign","center",RECORD_INDEX,a,RECORD_ID,t.getId(),CLASS,"display-fieldtable-row"]),s+=HU.td([STYLE,HU.css("vertical-align","center"),"align","right"],HU.div(c,g)),e.forEach((e=>{let i=t.getValue(e.getIndex()),a=r[e.getId()],g="";if(isNaN(i)||a.min==a.max)return;let c=100*(i-a.min)/(a.max-a.min),u=this.domId("cid"+d++),y={id:u,v:i,percent:c,field:e,record:t,colorBy:h[e.getId()]};n.push(y);let m=p,f=c+"%";"bar"==o&&(m=c*l,f=0);let D=HU.css("position","absolute","top","0%","left",f,"margin-top","-"+p/2+"px"),I=HU.tag("canvas",[TITLE,"Value:"+i+"   Range:"+a.min+" - "+a.max,STYLE,D,"width",m,"height",p,ID,u]);g+=HU.div([STYLE,HU.css("position","absolute","left","0px","right",p+"px")],I),s+=HU.td(["data-order",i,STYLE,HU.css("vertical-align","middle"),ALIGN,"right",TITLE,"Range:"+a.min+" - "+a.max],HU.div([STYLE,"position:relative;width:"+l+"px;height:1px;margin-left:10px; margin-right:10px;border:1px solid #ccc;"],g))})),s+=HU.close(TR)})),s+=HU.close(TBODY),s+=HU.open(TFOOT),s+=HU.open(TR),s+=HU.td([],""),e.forEach(((t,e)=>{s+=HU.td([],HU.div([STYLE,HU.css("max-width",l+"px","overflow-x","auto"),ID,this.domId("footer-"+e)],""))})),s+=HU.close(TR),s+=HU.close(TFOOT),s+=HU.close(TABLE),this.setContents(s);let g={ordering:!0};this.getProperty("tableHeight")&&(g.scrollY=this.getProperty("tableHeight")),this.getProperty("showColorTable")&&e.forEach(((t,e)=>{let i=h[t.getId()];if(i.index<0)return;let a="footer-"+e;i.displayColorTable(null,!1,a)})),HU.formatTable("#"+this.domId(a),g);this.find(".display-fieldtable-row");this.addFieldClickHandler(null,t,!0);let c=this.getProperty("markerFill","#64CDCC"),u=this.getProperty("markerStroke","#000");n.forEach((t=>{let e=document.getElementById(t.id).getContext("2d");e.strokeStyle=u,e.fillStyle=t.colorBy.getColorFromRecord(t.record,c),"circle"==o?(e.beginPath(),e.arc(p/2,p/2,p/2,0,2*Math.PI),e.fill(),e.stroke()):"rect"==o?(e.fillRect(0,0,p,p),e.strokeRect(0,0,p,p)):"bar"==o?(e.fillRect(0,0,t.percent/100*l,p),e.strokeRect(0,0,t.percent/100*l,p)):"line"==o?e.fillRect(p/2-2,0,4,p):"triangle"==o?(e.beginPath(),e.moveTo(p/2,0),e.lineTo(p,p),e.lineTo(0,p),e.lineTo(p/2,0),e.fill(),e.stroke()):"dart"==o?(e.beginPath(),e.moveTo(1,0),e.lineTo(p-1,0),e.lineTo(p/2,p/2),e.lineTo(1,0),e.fill(),e.stroke()):"arrow"==o&&(e.beginPath(),e.moveTo(0,0),e.lineTo(p/2,p/2),e.lineTo(p-1,0),e.stroke())}))}})}function RamaddaDotstackDisplay(t,e,i){const a=new RamaddaFieldsDisplay(t,e,"dotstack",i);defineDisplay(addRamaddaDisplay(this),a,[{label:"Dot Stack"},{p:"categoryField",ex:"field"}],{needsData:function(){return!0},updateUI:function(){let t=this.filterData();if(!t)return;let e={};t.forEach(((t,i)=>{e[t.getId()]=i}));this.getProperty("orientation","horizontal");let i=this.getFieldById(null,this.getProperty("categoryField")),a="",s=RecordUtil.groupBy(t,this,null,i),l=this.getColorByInfo(t),r=this.getProperty("boxWidth",4),o=this.getProperty("boxColumns",10);s.values.sort(((t,e)=>s.map[e].length-s.map[t].length)),s.values.forEach(((t,i)=>{let n=[],h=[];n.push(h);let d=s.map[t];d.forEach((t=>{h.length>o&&(h=[],n.push(h));let i=l.getColorFromRecord(t,"blue"),a=HU.div([TITLE,"",RECORD_ID,t.getId(),RECORD_INDEX,e[t.getId()],CLASS,"display-dotstack-dot",STYLE,HU.css("width",r+"px","height",r+"px","background",i)],"");h.push(a)})),a+=HU.open(DIV,[CLASS,"display-dotstack-block"]),a+=HU.div([],this.getProperty("labelTemplate","${count}").replace("${count}",d.length)),a+=HU.open(TABLE);for(let t=n.length-1;t>=0;t--)a+=HU.tr([],HU.tds([],n[t]));a+=HU.close(TABLE),a+=t,a+=HU.close(DIV)})),this.setContents(a);let n=this.find(".display-dotstack-dot");this.addFieldClickHandler(n,t,!1),this.makeTooltips(n,t,null,"${default}"),this.getProperty("tableHeight")&&(opts.scrollY=this.getProperty("tableHeight")),this.getProperty("showColorTable")&&l.displayColorTable(null,!1,domId)}})}function RamaddaDotbarDisplay(t,e,i){const a=new RamaddaFieldsDisplay(t,e,"dotbar",i);$.extend(this,a),addRamaddaDisplay(this);this.defineSizeByProperties(),defineDisplay(this,a,[{label:"Dot Bar"},{p:"keyField"},{p:"dotSize",d:16}],{needsData:function(){return!0},updateUI:function(){let t=this.filterData();if(!t)return;let e=this.getFieldById(null,this.getPropertyKeyField()),i=this.getFieldsByIds(null,this.getPropertyFields());0==i.length&&(i=this.getPointData().getRecordFields());let a,s=this.getPropertyDotSize(),l=new SizeBy(this,this.getProperty("sizeByAllRecords",!0)?this.getData().getRecords():t),r=HU.open(TABLE,["width","100%"]),o=(new Date,s);l.field&&(o=2*l.getMaxSize()),i.forEach(((n,h)=>{if(!n.isFieldNumeric())return;let d=new ColorByInfo(this,i,t,null,null,null,null,n),p=(this.domId("dots"+h),this.getColumnValues(t,n));r+=HU.open(TR,[VALIGN,"center"]),r+=HU.td([WIDTH,"10%",ALIGN,"right"],HU.div([STYLE,HU.css("margin-right","8px")],this.getFieldLabel(n).replace(/ /g,SPACE))),r+=HU.td([ALIGN,"right",WIDTH,"5%"],HU.div([STYLE,"margin-right:10px;"],this.formatNumber(p.min))),r+=HU.open(TD),r+=HU.open(DIV,[STYLE,HU.css(HEIGHT,HU.getDimension(o),WIDTH,"100%","position","relative","margin-top","4px")]),r+=HU.div([STYLE,HU.css("position","absolute","left","0px","right","0px","top","50%","border-top","1px solid #ccc")]),r+=SPACE,t.forEach(((t,i)=>{let h=t.getValue(n.getIndex()),g=d.getColor(h,t),c=Utils.pSBC(-.25,g);if(p.min==p.max)return;let u=(h-p.min)/(p.max-p.min),y="display-dotbar-dot",m=!1,f="";e&&this.selectedKey?this.selectedKey==t.getValue(e.getIndex())&&(m=!0):i==this.selectedIndex&&(m=!0);let D="2px solid "+c;this.selectedIndex>=0&&(m?D="1px solid #000":(D="1px solid "+c,g="rgba(200,200,200,0.2)")),m?(a=t,y+=" display-dotbar-dot-select"):this.getFilterHighlight()&&(t.isHighlight(this)||(f=HU.css("z-index","10","border","1px solid #aaa"))),u*=100;let I=s;if(l.field){if(I=2*l.getSize(t.getData(),s),I<0)return;f+=HU.css(HEIGHT,HU.getDimension(I),WIDTH,HU.getDimension(I))}let T=o/2-I/2;r+=HU.span([RECORD_INDEX,i,RECORD_ID,t.getId(),CLASS,y,STYLE,HU.css("border",D,"background",g,"position","absolute","top",HU.getDimension(T),"left",u+"%")+f,RECORD_INDEX,i,TITLE,""])})),r+=HU.close(DIV,TD),r+=HU.td([WIDTH,2*s]),r+=HU.td([ALIGN,"right",WIDTH,"5%"],HU.div([STYLE,HU.css("margin-left","10px")],this.formatNumber(p.max))),r+=HU.close(TR)}));new Date;r+=HU.close(TABLE),this.setContents(r);new Date;let n=this.find(".display-dotbar-dot"),h=(new Date,this);n.mouseleave((function(){n.removeClass("display-dotbar-dot-highlight")})),n.mouseover((function(){let t=$(this).attr(RECORD_INDEX);n.removeClass("display-dotbar-dot-highlight"),h.find("["+RECORD_INDEX+'="'+t+'"]').addClass("display-dotbar-dot-highlight")})),n.click((function(){let i=$(this).attr(RECORD_INDEX),a=t[i];if(a){if(n.removeClass("display-dotbar-dot-select"),h.selectedIndex==i)return h.selectedIndex=-1,void h.updateUI();h.selectedIndex=i,e&&(h.selectedKey=a.getValue(e.getIndex())),h.find("["+RECORD_INDEX+'="'+i+'"]').addClass("display-dotbar-dot-select"),h.hadClick=!0,h.propagateEventRecordSelection({record:a}),h.updateUI()}})),a&&setTimeout((()=>{this.propagateEventRecordSelection({record:a})}),10),this.makeTooltips(n,t,null);new Date}})}function RamaddaDategridDisplay(t,e,i){const a=new RamaddaFieldsDisplay(t,e,DISPLAY_DATEGRID,i);$.extend(this,a),addRamaddaDisplay(this);this.defineSizeByProperties(),defineDisplay(this,a,[{label:"Date Box"},{p:"groupField"},{p:"boxSize",d:16},{p:"showStats",ex:"true",d:!0,tt:"show starts per row"},{p:"showTotal",ex:"true",d:!0,tt:"show the totals"},{p:"showMin",ex:"true",d:!0,tt:"show min"},{p:"showMax",ex:"true",d:!0,tt:"show max"},{p:"showAverage",ex:"true",d:!1,tt:"show average"},{p:"leftWidth",tt:"width of left column",d:"100px"},{p:"rightWidth",tt:"width of right column",d:"100px"},{p:"leftLabel",tt:"Label for the left column"},{p:"rightLabel",tt:"Label for the left column",d:"Total/Min/Max"},{p:"dateHeaderStyle",tt:"Style to use for the date header"},{p:"dateStride",d:-1,tt:"The stride in hours to display the date label"},{p:"numLabels",d:8,tt:"Hour many date labels to show if no dateStride given"},{p:"boxStyle",tt:"Style to use for color boxes"},{p:"leftStyle",tt:"Style to use for left column"},{p:"rightStyle",tt:"Style to use for right column"}],{updateUI:function(){let t=this.filterData();if(!t)return;let e=this.getFieldById(null,this.getPropertyGroupField()),i=(this.getBoxSize(),[]),a=this.getColorByInfo(t),s=null,l=null;t.forEach((t=>{if(s){let e=t.getDate();s=e.getTime()<s.getTime()?e:s,l=e.getTime()>l.getTime()?e:l}else s=l=t.getDate();let a=t.getValue(e.getIndex()),r=i[a];null==r&&(r={records:[]},i[a]=r),r.records.push(t)})),this.dateFormat||(this.dateFormat=this.getProperty("dateFormat","ddd mm/dd"));let r=this.getShowStats(),o=HU.getDimension(this.getLeftWidth()),n=HU.getDimension(this.getRightWidth()),h="",d=l.getTime()-s.getTime(),p=t=>(t.getTime()-s.getTime())/d,g="1.5em";h="<div class=display-dategrid-table><table width=100% border=0 cellpadding=0 cellspacing=0>",h+="<tr><td width='"+o+"'>"+HU.div([CLASS,"display-dategrid-header"],this.getLeftLabel(this.getFieldLabel(e)))+"</td>";let c,u=this.getDateHeaderStyle("background:#eee;border-bottom:1px solid #888;"),y=this.getBoxStyle(""),m=this.getLeftStyle(""),f=this.getRightStyle(""),D=HU.open("div",[CLASS,"display-dategrid-dateheader",STYLE,u])+SPACE,I=s,T=this.getDateStride(-1);if(T>0)c=1e3*T*60*60;else{let t=Math.round((l.getTime()-s.getTime())/1e3/60/60),e=this.getNumLabels();c=1e3*Math.round(t/e)*60*60}let b=s.getTime()%c;for(I=new Date(s.getTime()-b+c);I.getTime()<=l.getTime();){let t=100*p(I)+"%",e=HU.css("left",t,"top","0%","transform","translate(-50%, 0%)");D+=HU.div([CLASS,"display-dategrid-header display-dategrid-date",STYLE,e],this.formatDate(I))+"\n",I=new Date(I.getTime()+c)}if(D+="</div>",h+=HU.td([],D),r){let t=[];this.getShowTotal()&&t.push("Total"),this.getShowMin()&&t.push("Min"),this.getShowMax()&&t.push("Max"),this.getShowAverage()&&t.push("Avg"),h+="<td width='"+n+"'>"+HU.div([CLASS,"display-dategrid-header display-dategrid-stats"],this.getRightLabel(Utils.join(t,"/")))+"</td>"}h+="</tr>",Object.keys(i).sort((t=>{let e=i[t],s=HU.open("div",[CLASS,"display-dategrid-row",STYLE,HU.css("height",g)]),l=e.records.sort(((t,e)=>t.getTime()-e.getTime())),n=0,d=NaN,c=NaN;for(let t=0;t<l.length;t++){let e=l[t],i=p(e.getDate()),r=l[t+1],o=i+.05;if(r){let t=p(r.getDate());o=1-t}i=100*i+"%",o=100*o+"%";let h=a.getColorFromRecord(e),u=e.getValue(a.index);isNaN(u)||(n+=u,d=Utils.min(d,u),c=Utils.max(c,u)),s+=HU.div(["foo","bar",RECORD_ID,e.getId(),CLASS,"display-dategrid-box",TITLE,u,STYLE,HU.css("left",i,"right",o,"height",g,"background",h)+y],"&nbsp;")}if(s+="</div>\n",h+="<tr><td width='"+o+"'>"+HU.div([STYLE,m,CLASS,"display-dategrid-rowlabel"],t)+"</td><td>"+s+"</td>",r){let t=[];this.getShowTotal()&&t.push(this.formatNumber(n)),this.getShowMin()&&t.push(this.formatNumber(d,null)),this.getShowMax()&&t.push(this.formatNumber(c)),this.getShowAverage()&&t.push(this.formatNumber(n/l.length)),h+=HU.td(["nowrap","true"],HU.div([STYLE,f,CLASS,"display-dategrid-stats"],Utils.join(t,SPACE)))}h+="</tr>"})),h+="</table></div>",this.setContents(h),this.boxes=this.find(".display-dategrid-box"),this.addFieldClickHandler(this.boxes,t,!1),this.makeTooltips(this.boxes,t,null),this.recordMap=this.makeIdToRecords(t),this.records=t,a.displayColorTable()},handleEventRecordSelection:function(t,e){if(a.handleEventRecordSelection.call(this,t,e),!this.boxes)return;let i=[],s=this.recordMap[e.record.getId()];if(s?i.push(s):i=this.findMatchingDates(e.record.getDate(),this.filteredRecords),0==i.length)return void console.log("none");this.boxes.removeClass("display-dategrid-box-highlight");let l={};this.boxes.each((function(){l[$(this).attr(RECORD_ID)]=$(this)})),i.forEach((t=>{let e=l[t.getId()];e&&e.addClass("display-dategrid-box-highlight")}))}})}addGlobalDisplayType({type:DISPLAY_RANKING,label:"Ranking",requiresData:!0,forUser:!0,category:CATEGORY_TABLE,tooltip:makeDisplayTooltip("Show fields ordered by values","ranking.png")}),addGlobalDisplayType({type:DISPLAY_CORRELATION,label:"Correlation",requiresData:!0,forUser:!0,category:CATEGORY_TABLE,tooltip:makeDisplayTooltip(null,"correlation.png")}),addGlobalDisplayType({type:DISPLAY_CROSSTAB,label:"Crosstab",requiresData:!0,forUser:!0,category:CATEGORY_TABLE,tooltip:makeDisplayTooltip("Cross Tabulation","crosstab.png")}),addGlobalDisplayType({type:DISPLAY_STATS,label:"Stats Table",requiresData:!1,forUser:!0,category:CATEGORY_TABLE,tooltip:makeDisplayTooltip("Statistical Summary","stats.png")}),addGlobalDisplayType({type:DISPLAY_RECORDS,label:"Records",requiresData:!0,forUser:!0,category:CATEGORY_TEXT,tooltip:makeDisplayTooltip("Displays records as text","records.png")}),addGlobalDisplayType({type:DISPLAY_TSNE,label:"TSNE",requiresData:!0,forUser:!1,category:CATEGORY_MISC}),addGlobalDisplayType({type:DISPLAY_HEATMAP,label:"Heatmap",requiresData:!0,forUser:!0,category:CATEGORY_MISC,tooltip:makeDisplayTooltip("Table showing colored fields","heatmap.png")}),addGlobalDisplayType({type:DISPLAY_GRAPH,label:"Graph",requiresData:!0,forUser:!0,category:CATEGORY_MISC,tooltip:makeDisplayTooltip("Display a force-directed graph","graph.png")}),addGlobalDisplayType({type:DISPLAY_PERCENTCHANGE,label:"Percent Change",requiresData:!0,forUser:!0,category:CATEGORY_TEXT,tooltip:makeDisplayTooltip("Percent Change","percentchange.png","Show percent change over a given time in a text template")}),addGlobalDisplayType({type:DISPLAY_SPARKLINE,label:"Sparkline",requiresData:!0,forUser:!0,category:CATEGORY_IMAGES,tooltip:makeDisplayTooltip("Embed little sparkline plots in text","sparkline.png")}),addGlobalDisplayType({type:DISPLAY_CANVAS,label:"Canvas",requiresData:!0,forUser:!0,category:CATEGORY_IMAGES,tooltip:makeDisplayTooltip("Draw records into a canvas","canvas.png")}),addGlobalDisplayType({type:DISPLAY_POINTIMAGE,label:"Point Image",requiresData:!0,forUser:!0,category:CATEGORY_IMAGES,tooltip:makeDisplayTooltip("Embed 2D images into text","pointimage.png")}),addGlobalDisplayType({type:DISPLAY_FIELDTABLE,label:"Field Table",requiresData:!0,forUser:!0,category:CATEGORY_TABLE,tooltip:makeDisplayTooltip(null,"fieldtable.png")}),addGlobalDisplayType({type:DISPLAY_TREE,forUser:!0,label:"Tree",requiresData:!1,category:CATEGORY_RADIAL_ETC,tooltip:makeDisplayTooltip(null,"tree.png")}),addGlobalDisplayType({type:DISPLAY_TIMELINE,label:"Timeline",requiresData:!0,forUser:!0,category:CATEGORY_MISC,tooltip:makeDisplayTooltip("Timeline showing text and images","timeline.png")}),addGlobalDisplayType({type:DISPLAY_HOURS,label:"Hours",requiresData:!0,forUser:!0,category:CATEGORY_MISC,tooltip:makeDisplayTooltip("Hourly timeline","timeline.png","Show data by the day and hour")}),addGlobalDisplayType({type:DISPLAY_BLANK,label:"Blank",requiresData:!0,forUser:!0,category:CATEGORY_CONTROLS,tooltip:makeDisplayTooltip("Shows no data",null,"Useful for just showing filters, etc")}),addGlobalDisplayType({type:DISPLAY_PRE,label:"Preformat",requiresData:!0,forUser:!0,category:CATEGORY_TABLE,tooltip:makeDisplayTooltip("Shows records in an HTML PRE tag",null,"Useful for looking at the data")}),addGlobalDisplayType({type:DISPLAY_HTMLTABLE,label:"HTML Table",requiresData:!0,forUser:!0,category:CATEGORY_TABLE,tooltip:makeDisplayTooltip("Shows records in an HTML table",null,"Useful for looking at the data")}),addGlobalDisplayType({type:DISPLAY_COOCCURENCE,label:"Cooccurence",requiresData:!0,forUser:!0,category:CATEGORY_TABLE,tooltip:makeDisplayTooltip("Cooccurence Table","cooccurrence.png","Tabular plot showing number of records that share values from two fields")}),addGlobalDisplayType({type:DISPLAY_BOXTABLE,label:"Box Table",requiresData:!0,forUser:!0,category:CATEGORY_TABLE,tooltip:makeDisplayTooltip("Box Table","boxtable.png","Shows number of records that share the same category field value")}),addGlobalDisplayType({type:DISPLAY_DATATABLE,label:"Data Table",requiresData:!0,forUser:!0,category:CATEGORY_TABLE,tooltip:makeDisplayTooltip("Data Table",["datatable1.png","datatable2.png"],"Selectable record grouping. Can be colored or show pie charts")}),addGlobalDisplayType({type:DISPLAY_DATEGRID,label:"Date Grid",requiresData:!0,forUser:!0,category:CATEGORY_TABLE,tooltip:makeDisplayTooltip("Date Grid",["dategrid.png"],"Show records grouped by category and date")});const DISPLAY_PLOTLY_RADAR="radar",DISPLAY_PLOTLY_WINDROSE="windrose",DISPLAY_PLOTLY_DENSITY="density",DISPLAY_PLOTLY_DOTPLOT="dotplot",DISPLAY_PLOTLY_SPLOM="splom",DISPLAY_PLOTLY_PROFILE="profile",DISPLAY_PLOTLY_3DSCATTER="3dscatter",DISPLAY_PLOTLY_3DMESH="3dmesh",DISPLAY_PLOTLY_TREEMAP="ptreemap",DISPLAY_PLOTLY_TERNARY="ternary",DISPLAY_PLOTLY_SUNBURST="sunburst",DISPLAY_PLOTLY_TEXTCOUNT="textcount",DISPLAY_PLOTLY_COMBOCHART="combochart",DISPLAY_PLOTLY_PARCOORDS="parcoords";function RamaddaPlotlyDisplay(t,e,i,a){let s=new RamaddaFieldsDisplay(t,e,i,a);RamaddaUtil.inherit(this,s),RamaddaUtil.defineMembers(this,{getRequirement:function(){return"Plotly"},needsData:function(){return!0},updateUI:function(t){if(window.Plotly)this.updateUIInner(t);else{let e=ramaddaCdn+"/lib/plotly/plotly-latest.min.js",i=this.loadingJS?null:()=>{this.updateUI(t)};Utils.loadScript(e,i)}},updateUIInner:function(t){},setDimensions:function(t,e){var i=parseInt(this.getProperty("height","400").replace("px","").replace("%",""));t.height=i,t.margin||(t.margin={}),[["l","marginLeft"],["r","marginRight"],["t","marginTop"],["b","marginBottom"]].map((e=>{Utils.isDefined(this.getProperty(e[1]))&&(t.margin[e[0]]=this.getProperty(e[1]))}))},pointDataLoaded:function(t,e,i){s.pointDataLoaded.call(this,t,e,i)},displayData:function(){this.updateUI()},pageHasLoaded:function(){s.pageHasLoaded.call(this),this.updateUI()},fieldSelectionChanged:function(){s.fieldSelectionChanged.call(this),this.updateUI()},makeAxis:function(t,e){return{title:t,titlefont:{size:20},tickangle:e,tickfont:{size:15},tickcolor:"rgba(0,0,0,0)",ticklen:5,showline:!0,showgrid:!0}},getDisplayStyle:function(){return""},makePlot:function(t,e){this.clearHtml();let i=HtmlUtils.div(["id",this.getDomId(ID_HEADER)],"")+HtmlUtils.div(["id",this.getDomId("tmp"),"style",this.getDisplayStyle()],"")+HtmlUtils.div(["id",this.getDomId(ID_FOOTER)],"");this.setContents(i);var a=Plotly.plot(this.getDomId("tmp"),t,e,{displayModeBar:!1}),s=document.getElementById(this.getDomId("tmp"));return s&&this.addEvents(a,s),s},handleClickEvent:function(t){if(t.points&&t.points.length>0){let i=t.points[0].record;if(!i){var e=t.points[0].pointIndex;i=this.indexToRecord[e]}i&&this.propagateEventRecordSelection({record:i})}},addEvents:function(t,e){let i=this;e.on("plotly_click",(function(t){i.handleClickEvent(t)}))}})}function RamaddaRadialDisplay(t,e,i,a){$.extend(this,{width:"400px",height:"400px"}),RamaddaUtil.inherit(this,new RamaddaPlotlyDisplay(t,e,i,a)),RamaddaUtil.defineMembers(this,{getPlotType:function(){return"barpolar"},updateUIInner:function(){var t=this.filterData();if(t){var e=this.getSelectedFields(this.getData().getRecordFields()),i=this.getFieldsByType(e,"numeric");if(0!=i.length){var a,s;if(this.getProperty("useDates")){var l=this.getDateValues(t);a=[];var r=this.getProperty("dateFormat","yyyyMMdd");s="category",l.map((t=>{a.push(Utils.formatDateWithFormat(t,r))}))}else{var o=this.getFieldById(null,this.getProperty("thetaField"));o&&(a=this.getColumnValues(t,o).values)}for(var n=[],h=Number.MAX_VALUE,d=Number.MIN_VALUE,p=[],g=0;g<i.length;g++){var c=i[g],u=this.getColumnValues(t,c);if(!a){a=[];var y=0;for(y=0;y<u.values.length;y++)a.push(360*y/u.values.length)}h=Math.min(h,u.min),d=Math.max(d,u.max);n=u.values;p.push({type:this.getPlotType(),r:n,theta:a,fill:"toself",name:c.getLabel()})}layout={polar:{angularaxis:{type:"category"},radialaxis:{visible:!0,range:[h,d]}}},s&&(layout.polar.angularaxis={type:s}),this.setDimensions(layout,2),this.makePlot(p,layout)}else this.displayError("No numeric fields specified")}}})}function RamaddaRadarDisplay(t,e,i){RamaddaUtil.inherit(this,new RamaddaRadialDisplay(t,e,DISPLAY_PLOTLY_RADAR,i)),RamaddaUtil.defineMembers(this,{getPlotType:function(){return"scatterpolar"}}),addRamaddaDisplay(this)}function RamaddaWindroseDisplay(t,e,i){RamaddaUtil.inherit(this,new RamaddaRadialDisplay(t,e,DISPLAY_PLOTLY_WINDROSE,i)),RamaddaUtil.defineMembers(this,{getPlotType:function(){return"barpolar"}}),addRamaddaDisplay(this)}function RamaddaDensityDisplay(t,e,i){$.extend(this,{width:"600px",height:"400px"}),RamaddaUtil.inherit(this,new RamaddaPlotlyDisplay(t,e,DISPLAY_PLOTLY_DENSITY,i)),addRamaddaDisplay(this),RamaddaUtil.defineMembers(this,{updateUIInner:function(){var t=this.filterData();if(t){var e=this.getSelectedFields(this.getData().getRecordFields()),i=this.getFieldsByType(e,"numeric");if(i.length<2)this.displayError("No numeric fields specified");else{var a=this.getColumnValues(t,i[0]),s=this.getColumnValues(t,i[1]),l={x:a.values,y:s.values,mode:"markers",name:"",marker:{color:this.getProperty("pointColor","rgb(102,0,0)"),size:parseInt(this.getProperty("markerSize","4")),opacity:.4},type:"scatter"},r={x:a.values,y:s.values,name:"density",ncontours:20,colorscale:"Hot",reversescale:!0,type:"histogram2dcontour"},o=[];this.getProperty("showDensity",!0)&&o.push(r),this.getProperty("showPoints",!0)&&o.push(l);var n={showlegend:!0,autosize:!0,margin:{t:50},hovermode:"closest",bargap:0,xaxis:{domain:[a.min,a.max],showline:this.getProperty("showLines",!0),showgrid:this.getProperty("showLines",!0),title:e[0].getLabel()},yaxis:{domain:[s.min,s.max],showline:this.getProperty("showLines",!0),showgrid:this.getProperty("showLines",!0),title:e[1].getLabel()}};this.setDimensions(n,2),this.makePlot(o,n)}}}})}function RamaddaPlotly3DDisplay(t,e,i,a){$.extend(this,{width:"400px",height:"400px"}),RamaddaUtil.inherit(this,new RamaddaPlotlyDisplay(t,e,i,a)),RamaddaUtil.defineMembers(this,{addEvents:function(t,e){e.on("plotly_click",(function(){}))},getDisplayStyle:function(){return"border: 1px #ccc solid;"},get3DType:function(){return"scatter3d"},updateUIInner:function(){var t=this.filterData();if(t){var e=this.getSelectedFields(this.getData().getRecordFields());this.getFieldByType(e,"string");if(0!=(e=this.getFieldsByType(e,"numeric")).length)if(e.length<3)this.displayError("Don't have 3 numeric fields specified");else{var i=this.getColumnValues(t,e[0]),a=this.getColumnValues(t,e[1]),s=this.getColumnValues(t,e[2]),l=[{x:i.values,y:a.values,z:s.values,mode:"markers",marker:{size:12,line:{color:"rgba(217, 217, 217, 0.14)",width:.5},opacity:.8},type:this.get3DType()}],r={scene:{xaxis:{backgroundcolor:"rgb(200, 200, 230)",gridcolor:"rgb(255, 255, 255)",showbackground:!0,zerolinecolor:"rgb(255, 255, 255)",title:e[0].getLabel()},yaxis:{backgroundcolor:"rgb(230, 200,230)",gridcolor:"rgb(255, 255, 255)",showbackground:!0,zerolinecolor:"rgb(255, 255, 255)",title:e[1].getLabel()},zaxis:{backgroundcolor:"rgb(230, 230,200)",gridcolor:"rgb(255, 255, 255)",showbackground:!0,zerolinecolor:"rgb(255, 255, 255)",title:e[2].getLabel()}},margin:{l:0,r:0,b:50,t:50,pad:4}};this.setDimensions(r,2),this.makePlot(l,r)}else this.displayError("No numeric fields specified")}}})}function Ramadda3dmeshDisplay(t,e,i){$.extend(this,{width:"100%",height:"100%"}),RamaddaUtil.inherit(this,new RamaddaPlotly3DDisplay(t,e,DISPLAY_PLOTLY_3DMESH,i)),addRamaddaDisplay(this),RamaddaUtil.defineMembers(this,{get3DType:function(){return"mesh3d"}})}function Ramadda3dscatterDisplay(t,e,i){$.extend(this,{width:"100%",height:"100%"}),RamaddaUtil.inherit(this,new RamaddaPlotly3DDisplay(t,e,DISPLAY_PLOTLY_3DSCATTER,i)),addRamaddaDisplay(this),RamaddaUtil.defineMembers(this,{get3DType:function(){return"scatter3d"}})}function RamaddaSunburstDisplay(t,e,i){$.extend(this,{width:"500",height:"500"});let a=new RamaddaPlotlyDisplay(t,e,DISPLAY_PLOTLY_SUNBURST,i);defineDisplay(addRamaddaDisplay(this),a,[{label:"Sunburst Display"},{p:"parentField",ex:""},{p:"labelField",ex:""},{p:"idField",ex:""},{p:"valueField",ex:""},{p:"nodeFields",ex:""},{p:"treeRoot",ex:"some label"},{p:"doTopColors",ex:"true"}],{getDisplayStyle:function(){return""},updateUIInner:function(){if(!this.filterData())return;this.getFieldById(null,this.getProperty("parentField"));var t=this.getFieldById(null,this.getProperty("valueField"));this.getFieldById(null,this.getProperty("labelField"));let e=null;try{e=this.makeTree()}catch(t){return void this.setContents(this.getMessage(t.toString()))}let i=[],a=[],s=[],l=[],r=[],o=function(e){if(0==e.children.length){if(e.record){var i=e.record.getValue(t.getIndex());return e.value=i,i}return 0}let a=0;return e.children.map((t=>{a+=o(t)})),e.value=a,e.record&&e.record.setValue(t.getIndex(),a),a};t&&e.map(o),this.myRecords=[];let n=this.myRecords,h=function(e){n.push(e.record),t&&r.push(e.value),s.push(e.parent),i.push(e.id),a.push(e.label),l.push(null==e.parent?"":e.parent.id),e.children.map(h)};e.map(h);var d=this.getColorTable(!0);let p=this.getProperty("doTopColors",!0);if(!d){var g=Utils.parseMap(this.getProperty("colorMap"));if(g){d=[];let t=0,e=["#1f77b4","#ff7f0e","#2ca02c","#d62728","#9467bd","#8c564b","#e377c2","#7f7f7f","#bcbd22","#17becf"];i.map(((i,l)=>{if(p&&null!=s[l])return;let r=g[i];r||(r=g[a[l]]),r||(t>=e.length&&(t=0),r=e[t],t++),d.push(r)}))}}var c=[{type:"sunburst",ids:i,labels:a,parents:l,outsidetextfont:{size:20,color:"#377eb8"},leaf:{opacity:.4},marker:{line:{width:1}},branchvalues:"total"}];t&&(c[0].values=r);var u={margin:{l:0,r:0,b:0,t:0},width:+this.getProperty("width"),height:+this.getProperty("height")};d&&(p?(u.sunburstcolorway=d,u.extendsunburstcolors=!0,u.extendsunburstcolorway=!0):c[0].marker.colors=d),this.makePlot(c,u).on("plotly_sunburstclick",(t=>{this.handleSunburstClickEvent(t)}))},handleSunburstClickEvent:function(t){if(t.points&&!(t.points.length<=0)){var e=t.points[0].pointNumber,i=this.myRecords[e];i&&this.propagateEventRecordSelection({record:i})}}})}function RamaddaTernaryDisplay(t,e,i){$.extend(this,{width:"400px",height:"400px"}),RamaddaUtil.inherit(this,new RamaddaPlotlyDisplay(t,e,DISPLAY_PLOTLY_TERNARY,i)),addRamaddaDisplay(this),RamaddaUtil.defineMembers(this,{updateUIInner:function(){var t=this.filterData();if(t){var e=this.getSelectedFields(this.getData().getRecordFields()),i=this.getFieldByType(e,"string");if(0!=(e=this.getFieldsByType(e,"numeric")).length)if(e.length<3)this.displayError("Don't have 3 numeric fields specified");else{for(var a=[],s=this.getColumnValues(t,e[0]),l=this.getColumnValues(t,e[1]),r=this.getColumnValues(t,e[2]),o=0;o<s.length;o++)a.push({a:100*s[o]/s.max,b:100*l[o]/l.max,c:100*r[o]/r.max,label:i?i.getLabel():"Point "+(o+1)});var n=[{type:"scatterternary",mode:"markers",a:a.map((function(t){return t.a})),b:a.map((function(t){return t.b})),c:a.map((function(t){return t.c})),text:a.map((function(t){return t.label})),marker:{symbol:100,color:"#DB7365",size:14,line:{width:2}}}],h={ternary:{sum:100,aaxis:this.makeAxis(e[0].getLabel(),0),baxis:this.makeAxis(e[1].getLabel(),45),caxis:this.makeAxis(e[2].getLabel(),-45),bgcolor:"#fff1e0"},annotations:[{showarrow:!1,text:this.getProperty("chartTitle",""),x:1,y:1.3,font:{size:15}}],paper_bgcolor:"#fff1e0"};this.setDimensions(h,2),this.makePlot(n,h)}else this.displayError("No numeric fields specified")}}})}function RamaddaDotplotDisplay(t,e,a){$.extend(this,{width:"600px",height:"400px"});let s=new RamaddaPlotlyDisplay(t,e,DISPLAY_PLOTLY_DOTPLOT,a);defineDisplay(addRamaddaDisplay(this),s,[{label:"Dotplot Display"},{p:"fields",ex:""},{p:"labelField",ex:""}],{getDisplayStyle:function(){return""},updateUIInner:function(){let t=this.filterData();if(!t)return;var e=this.getData();if(null==e)return;let a=e.getRecordFields(),s=this.getFieldById(a,this.getLabelField());s||(s=this.getFieldByType(a,"string")),s||(s=a[0]);let l=this.getFieldsByIds(null,this.getPropertyFields("",!0));if(0==l.length&&(l=this.getFieldsByType(a,"numeric")),0==l.length&&(l=this.getFieldsByType(a,"date")),0==l.length)return void this.displayError("No numeric fields specified");let r=null,o="";s&&(r=this.getColumnValues(t,s).values,o=s.getLabel());var n=this.getColorTable(!0);n||(n=["rgba(156, 165, 196, 0.95)","rgba(204,204,204,0.95)","rgba(255,255,255,0.85)","rgba(150,150,150,0.95)"]);var h=[],d=this.getColorByInfo(t),p=!1;for(i in l){var g=i>=n.length?n[0]:n[i],c=l[i],u=this.getColumnValues(t,c).values;if(d.index>=0&&(g=[],t.map((t=>{var e=t.getData()[d.index];p=!0,g.push(d.getColor(e,t))}))),!r){r=[];for(var y=0;y<u.length;y++)r.push("Point "+(y+1))}h.push({type:"scatter",x:u,y:r,mode:"markers",name:c.getLabel(),marker:{color:g,line:{color:"rgba(156, 165, 196, 1.0)",width:1},symbol:"circle",size:16}})}var m={title:"",yaxis:{title:this.getProperty("yAxisTitle",o),showline:this.getProperty("yAxisShowLine",!0),showgrid:this.getProperty("yAxisShowGrid",!0)},xaxis:{title:this.getProperty("xAxisTitle",l[i].getLabel()),showgrid:this.getProperty("xAxisShowGrid",!1),showline:this.getProperty("xAxisShowLine",!0),linecolor:"rgb(102, 102, 102)",titlefont:{font:{color:"rgb(204, 204, 204)"}},tickfont:{font:{color:"rgb(102, 102, 102)"}},autotick:!0,ticks:"outside",tickcolor:"rgb(102, 102, 102)"},margin:{l:this.getProperty("marginLeft",140),r:this.getProperty("marginRight",40),b:this.getProperty("marginBottom",50),t:this.getProperty("marginTop",20)},legend:{font:{size:10},yanchor:"middle",xanchor:"right"},paper_bgcolor:this.getProperty("chart.fill","rgb(254, 247, 234)"),plot_bgcolor:this.getProperty("chartArea.fill","rgb(254, 247, 234)"),hovermode:"closest"};this.setDimensions(m,2),this.makePlot(h,m),p&&d.displayColorTable()}})}function RamaddaProfileDisplay(t,e,i){let a=new RamaddaPlotlyDisplay(t,e,DISPLAY_PLOTLY_PROFILE,i);RamaddaUtil.inherit(this,a),addRamaddaDisplay(this),this.defineProperties([{label:"Profile Properties"},{p:"indexField",d:null,ex:""},{p:"fields",d:null,ex:""},{p:"profileMode",d:"lines",ex:"lines|markers|lines+markers"},{p:"yAxisTitle",d:"Pressure- Digiquartz",ex:""},{p:"yAxisShowLine",d:"true",ex:"false"},{p:"yAxisShowGrid",d:"true",ex:"false"},{p:"xAxisTitle",d:"",ex:""},{p:"xAxisShowGrid",d:"true",ex:"false"},{p:"xAxisShowLine",d:"true",ex:"false"},{p:"yAxisReverse",d:!1,ex:"true"},{p:"marginLeft",d:"60",ex:"60"},{p:"marginRight",d:"100",ex:"100"},{p:"marginBottom",d:"50",ex:"50"},{p:"marginTop",d:"100",ex:"100"},{p:"showLegend",d:"true",ex:"false"},{p:"legendYAnchor",d:null,ex:"top|middle|bottom"},{p:"legendXAnchor",d:null,ex:"right|center|left"},{p:"chart.fill",d:"rgb(254, 247, 234)",ex:"color"},{p:"chartArea.fill",d:"rgb(254, 247, 234)",ex:"color"},{p:"xAxis2Title",d:"Conductivity",ex:""}]),RamaddaUtil.defineMembers(this,{getDisplayStyle:function(){return""},updateUIInner:function(){let t=this.filterData();if(!t)return;let e=this.getFieldById(null,this.getProperty("indexField"));if(null==e)return void this.setContents(this.getMessage("No indexField specified"));let i=this.getSelectedFields(this.getData().getRecordFields());if(0==i.length){let t=this.getFieldsByType(null,"numeric");t.length>0&&i.push(t[0])}if(0==i.length)return void this.setContents(this.getMessage("No fields found"));let a=this.getColumnValues(t,e).values,s=[];i.forEach(((e,i)=>{let l=this.getColumnValues(t,e).values,r={y:a,x:l,type:"scatter",mode:this.getProperty("profileMode","lines"),name:e.getLabel(),marker:{line:{color:"rgba(156, 165, 196, 1.0)",width:1},symbol:"circle",size:16}};i>0&&(r.xaxis="x2"),s.push(r)}));let l=e.getLabel(),r={yaxis:{autorange:this.getProperty("yAxisReverse",!1)?"reversed":null,title:this.getProperty("yAxisTitle",l),showline:this.getProperty("yAxisShowLine",!0),showgrid:this.getProperty("yAxisShowGrid",!0)},xaxis:{title:this.getProperty("xAxisTitle",i[0].getLabel()),showgrid:this.getProperty("xAxisShowGrid",!0),showline:this.getProperty("xAxisShowLine",!0),linecolor:"rgb(102, 102, 102)",titlefont:{font:{color:"rgb(204, 204, 204)"}},tickfont:{font:{color:"rgb(102, 102, 102)"}},autotick:!0,ticks:"outside",tickcolor:"rgb(102, 102, 102)"},margin:{l:this.getProperty("marginLeft",60),r:this.getProperty("marginRight",100),b:this.getProperty("marginBottom",50),t:this.getProperty("marginTop",100)},legend:{font:{size:10},yanchor:this.getProperty("legendYAnchor"),xanchor:this.getProperty("legendXAnchor")},showlegend:this.getProperty("showLegend",!0),paper_bgcolor:this.getProperty("chart.fill","rgb(254, 247, 234)"),paper_bgcolor:this.getProperty("chart.fill","transparent"),plot_bgcolor:this.getProperty("chartArea.fill","rgb(254, 247, 234)"),hovermode:"closest"};i.length>1&&(r.xaxis2={overlaying:"x",side:"top",title:this.getProperty("xAxis2Title",i[1].getLabel()),showgrid:this.getProperty("xAxisShowGrid",!0),showline:this.getProperty("xAxisShowLine",!0),linecolor:"rgb(102, 102, 102)",titlefont:{font:{color:"rgb(204, 204, 204)"}},tickfont:{font:{color:"rgb(102, 102, 102)"}},autotick:!0,ticks:"outside",tickcolor:"rgb(102, 102, 102)"}),this.setDimensions(r,2),this.makePlot(s,r),this.writePropertyDef&&console.log(this.writePropertyDef),this.writePropertyDef=null}})}function RamaddaSplomDisplay(t,e,i){$.extend(this,{width:"600px",height:"600px"}),RamaddaUtil.inherit(this,new RamaddaPlotlyDisplay(t,e,DISPLAY_PLOTLY_SPLOM,i)),addRamaddaDisplay(this),RamaddaUtil.defineMembers(this,{setDimensions:function(t,e){var i=parseInt(this.getProperty("width","400").replace("px","").replace("%","")),a=parseInt(this.getProperty("height","400").replace("px","").replace("%",""));t.width=i-e,t.height=a},makeAxis:function(){return{showline:!1,zeroline:!1,gridcolor:this.getProperty("gridColor","white"),ticklen:2,tickfont:{size:this.getProperty("tickFontSize",12)},titlefont:{size:this.getProperty("titleFontSize",12)}}},updateUIInner:function(){var t=this.filterData();if(t){var e,i=this.getSelectedFields(this.getData().getRecordFields());0==i.length&&(i=this.getData().getRecordFields()),this.getProperty("labels")&&(e=this.getProperty("labels").split(","));var a={type:"splom",dimensions:[],marker:{size:parseInt(this.getProperty("markerSize",5)),line:{color:this.getProperty("lineColor","white"),width:.5}}},s=this.getFieldById(i,this.getProperty("colorBy")),l=this.getProperty("colorBy");if(l){if(s=this.getFieldById(i,l)){var r=this.getColumnValues(t,s),o=this.getColorTable();o||(o=Utils.getColorTable("blue_white_red"));var n=[],h=parseFloat(this.getProperty("colorByMin",r.min)),d=parseFloat(this.getProperty("colorByMax",r.max));if(Utils.isDefined(o.min)){for(var p=[],g=0;g<o.colors.length;g++){var c=g/o.colors.length;(m=o.min+(o.max-o.min)*c)>=h&&m<=d&&p.push(o.colors[g])}o=p}o.colors&&(o=o.colors);var u=d-h,y=[];for(g=0;g<r.values.length;g++){c=((m=r.values[g])-h)/u;y.push(c)}for(g=0;g<o.length;g++){var m=g/o.length,f=(g+1)/o.length;n.push([m,o[g]]),n.push([f,o[g]])}a.marker.color=y,a.marker.colorscale=n}this.displayColorTable(o,ID_DISPLAY_BOTTOM,h,d)}var D=this.getFieldByType(i,"string");if(D){var I=this.getColumnValues(t,D).values;a.text=[];for(g=0;g<I.length;g++)a.text.push(D.getLabel()+": "+I[g])}var T=[a],b={autosize:!1,hovermode:"closest",dragmode:"select",plot_bgcolor:this.getProperty("bgColor","rgba(240,240,240, 0.95)"),margin:{l:this.getProperty("marginLeft",140),r:this.getProperty("marginRight",40),b:this.getProperty("marginBottom",50),t:this.getProperty("marginTop",20)}},S=0;for(g=0;g<i.length;g++){var v=i[g];if(v.isFieldNumeric()){var x,U=this.getColumnValues(t,v).values;x=e&&g<e.length?e[g]:v.getUnitLabel(),a.dimensions.push({label:x,values:U});var L="axis"+(0==S?"":""+(S+1));b["x"+L]=this.makeAxis(),b["y"+L]=this.makeAxis(),S++}}this.setDimensions(b,2),this.makePlot(T,b)}}})}function RamaddaPTreemapDisplay(t,e,i){$.extend(this,{width:"400px",height:"400px"}),RamaddaUtil.inherit(this,new RamaddaPlotlyDisplay(t,e,DISPLAY_PLOTLY_TREEMAP,i)),addRamaddaDisplay(this),RamaddaUtil.defineMembers(this,{updateUIInner:function(){var t=this.filterData();if(t){var e=this.getSelectedFields(this.getData().getRecordFields()),i=this.getFieldByType(e,"numeric");if(i){var a=this.getColumnValues(t,i).values,s=[],l=[],r=0,o=[],n=[],h=[],d=this.getColorTable();d.colors&&(d=d.colors);var p=Treemap.generate(a,100,100);for(var g in p){var c={type:"rect",x0:p[g][0],y0:p[g][1],x1:p[g][2],y1:p[g][3],line:{width:2},fillcolor:d[r]};s.push(c);var u={x:(p[g][0]+p[g][2])/2,y:(p[g][1]+p[g][3])/2,text:String(a[r]),showarrow:!1};l.push(u),o.push((p[g][0]+p[g][2])/2),n.push((p[g][1]+p[g][3])/2),h.push(String(a[r])),r++}var y={x:o,y:n,text:h,mode:"text",type:"scatter"},m={height:700,width:700,shapes:s,hovermode:"closest",annotations:l,xaxis:{showgrid:!1,zeroline:!1},yaxis:{showgrid:!1,zeroline:!1}};this.setDimensions(m,2),this.makePlot([y],m)}else this.displayError("No numeric field specified")}}})}function TextcountDisplay(t,e,i){let a=new RamaddaPlotlyDisplay(t,e,DISPLAY_PLOTLY_TEXTCOUNT,i);defineDisplay(addRamaddaDisplay(this),a,[{label:"Text Count Display"},{p:"patterns",ex:"foo,bar"},{p:"labels",ex:"Foo,Bar"},{p:"textField",ex:""}],{getDialogContents:function(t,e){let i=HtmlUtils.div(["id",this.getDomId("dialog_set_pattern")],"Change patterns")+"<br>"+HtmlUtils.textarea("",Utils.join(this.patternList||[],"\n"),["id",this.getDomId("dialog_patterns"),"rows","10"]);t.push("Patterns"),e.push(i),a.getDisplayDialogContents.call(this,t,e)},initDialog:function(){a.initDialog.call(this);let t=this;this.jq("dialog_set_pattern").button().click((function(){t.patterns=t.jq("dialog_patterns").val().trim().replace(/\n/g,","),t.updateUI()}))},updateUIInner:function(){let t=this.filterData();if(!t)return;let e=this.getProperty("patterns");if(null==e)return void this.setContents(this.getMessage("No patterns specified"));this.patternList=e.split(",");let i=this.getProperty("labels");if(i&&(i=i.split(",")),this.textField=this.getFieldById(null,this.getProperty("textField")),this.textField||(this.textField=this.getFieldByType(null,"string")),!this.textField)return void this.setContents(this.getMessage("No text field in data"));let a=[],s=[];this.patternList.map((t=>{a.push(0),s.push(new TextMatcher(t))}));for(var l=0;l<t.length;l++){var r=t[l],o=(r.getData(),r.getValue(this.textField.getIndex()));s.map(((t,e)=>{t.matches(o)&&a[e]++}))}let n=[{type:"bar",x:a,y:i||this.patternList,orientation:"h"}],h={margin:{l:100,r:50,b:50,t:10,padding:4}};Utils.isDefined(this.properties.height)&&(h.height=+this.properties.height),this.makePlot(n,h)},handleClickEvent:function(t){if(t.points&&!(t.points.length<=0)){var e=t.points[0].pointNumber,i=this.patternList[e],a={fieldId:this.textField.getId(),value:i};this.propagateEvent(DisplayEvent.filterChanged,a)}}})}function CombochartDisplay(t,e,i){let a=new RamaddaPlotlyDisplay(t,e,DISPLAY_PLOTLY_COMBOCHART,i);defineDisplay(addRamaddaDisplay(this),a,[{label:"Combo Chart"},{p:"fields",ex:""},{p:"&lt;field&gt;.axisSide",ex:"right|left"},{p:"&lt;field&gt;.axisTitle",ex:""},{p:"&lt;field&gt;.chartType",ex:"scatter|bar"},{p:"chartType",ex:"scatter|bar"},{p:"&lt;field&gt;.chartColor",ex:""},{p:"chartType",ex:""},{p:"xAxisTitle",ex:""},{p:"xAxisShowGrid",ex:""},{p:"xAxisShowLine",ex:""},{p:"legendBackground",ex:""},{p:"legendBorder",ex:""},{p:"chartBackground",ex:""},{p:"plotBackground",ex:""},{p:"marginLeft",ex:""},{p:"marginRight",ex:""},{p:"marginBottom",ex:""},{p:"marginTop",ex:""},{p:"chartPad",ex:""}],{updateUIInner:function(){let t=this.filterData();if(!t)return;var e={xaxis:{title:this.getProperty("xAxisTitle","Time"),showgrid:this.getProperty("xAxisShowGrid",!1),showline:this.getProperty("xAxisShowLine",!0),linecolor:"rgb(102, 102, 102)",titlefont:{font:{color:"rgb(204, 204, 204)"}},tickfont:{font:{color:"rgb(102, 102, 102)"}},autotick:!0,ticks:"outside",tickcolor:"rgb(102, 102, 102)"},legend:{font:{size:10},bgcolor:this.getProperty("legendBackground","rgba(255,255,255,0)"),bordercolor:this.getProperty("legendBorder","rgba(255,255,255,0)"),x:0,y:1},margin:{l:this.getProperty("marginLeft",50),r:this.getProperty("marginRight",50),b:this.getProperty("marginBottom",50),t:this.getProperty("marginTop",0),pad:this.getProperty("chartPad",4)},paper_bgcolor:this.getProperty("chartBackground","rgb(255,255,255,0)"),plot_bgcolor:this.getProperty("plottBackground","rgb(255,255,255,0)")};let i=this.getFieldsByIds(null,this.getPropertyFields("",!0));var a=[],s=[];t.map(((t,e)=>{s.push(t.getTime())}));let l=!0;i.map(((i,r)=>{let o=this.getColumnValues(t,i).values;var n={x:s,y:o,name:i.getLabel(),type:this.getProperty(i.getId()+".chartType",this.getProperty("chartType","scatter")),marker:{color:this.getProperty(i.getId()+".chartColor",this.getProperty("chartColor"))}};r>0&&(n.yaxis="y"+(r+1)),a.push(n);var h=r>0?"yaxis"+(r+1):"yaxis",d={title:this.getProperty(i.getId()+".axisTitle",i.getLabel()),titlefont:{color:"rgb(0,0,0)"},tickfont:{color:"rgb(0,0,0,)"},side:this.getProperty(i.getId()+".axisSide",this.getProperty("axisSide",l?"right":"left"))};r>0&&(d.overlaying="y"),e[h]=d,l=!l})),this.setDimensions(e),this.makePlot(a,e)}})}function RamaddaParcoordsDisplay(t,e,i){let a=new RamaddaPlotlyDisplay(t,e,DISPLAY_PLOTLY_PARCOORDS,i);RamaddaUtil.inherit(this,a),addRamaddaDisplay(this),RamaddaUtil.defineMembers(this,{updateUIInner:function(){var t=this.filterData();if(!t)return;let e=this.getFieldsByIds(null,this.getPropertyFields(""));if(0==e.length)return void this.displayError("No fields specified");let i=[],a=this.getProperty("maxLabelLength",200/e.length);e.map((e=>{let s=this.getColumnValues(t,e).values,l=null,r=null;if(e.isString()){let t=[],e={};l=[],r=[];let i=1;s.map((a=>{e[a]||(e[a]=i++,l.push(a),r.push(e[a])),t.push(e[a])})),s=t}let o=this.getProperty(e.getId()+".label",e.getLabel());o.length>a&&(o=o.substring(0,a-1)+"...");let n={label:o,values:s};this.getProperty(e.getId()+".constraintrange")&&(n.constraintrange=this.getProperty(e.getId()+".constraintrange").split(",")),this.getProperty(e.getId()+".tickvals")&&(n.tickvals=this.getProperty(e.getId()+".tickvals").split(",")),this.getProperty(e.getId()+".ticktext")?n.ticktext=this.getProperty(e.getId()+".ticktext").split(","):(n.ticktext=l,n.tickvals=r),i.push(n)}));this.getProperty("color","blue");let s=this.getFieldById(null,this.getProperty("colorBy")),l={},r=null,o=0,n=0;if(s){let e=this.getColumnValues(t,s);if(o=e.min,n=e.max,l.color=e.values,r=this.getColorTable(!0,null,null),r){let t=[],e=1/(r.length-1);r.map(((i,a)=>{let s=a*e;t.push([s,i])})),l.colorscale=t}}var h=[{type:"parcoords",line:l,dimensions:i}];let d={margin:{l:175,t:50,b:25}};this.setDimensions(d,2),this.makePlot(h,d),r&&this.displayColorTable(r,ID_COLORTABLE,o,n)}})}addGlobalDisplayType({type:DISPLAY_PLOTLY_RADAR,label:"Radar",requiresData:!0,forUser:!0,category:CATEGORY_RADIAL_ETC}),addGlobalDisplayType({type:DISPLAY_PLOTLY_WINDROSE,label:"Wind Rose",requiresData:!0,forUser:!0,category:CATEGORY_RADIAL_ETC}),addGlobalDisplayType({type:DISPLAY_PLOTLY_SUNBURST,label:"Sunburst",requiresData:!0,forUser:!0,category:CATEGORY_RADIAL_ETC,tooltip:makeDisplayTooltip(null,"sunburst.png")}),addGlobalDisplayType({type:DISPLAY_PLOTLY_DENSITY,label:"Density",requiresData:!0,forUser:!0,category:CATEGORY_RADIAL_ETC}),addGlobalDisplayType({type:DISPLAY_PLOTLY_COMBOCHART,label:"Combo Chart",requiresData:!0,forUser:!0,category:CATEGORY_CHARTS,tooltip:makeDisplayTooltip(null,"combochart.png")}),addGlobalDisplayType({type:DISPLAY_PLOTLY_PARCOORDS,label:"Parallel Coords",requiresData:!0,forUser:!0,category:CATEGORY_RADIAL_ETC}),addGlobalDisplayType({type:DISPLAY_PLOTLY_DOTPLOT,label:"Dot Plot",requiresData:!0,forUser:!0,category:CATEGORY_CHARTS,tooltip:makeDisplayTooltip(null,"dotplot.png")}),addGlobalDisplayType({type:DISPLAY_PLOTLY_SPLOM,label:"Splom",requiresData:!0,forUser:!0,category:CATEGORY_RADIAL_ETC,tooltip:makeDisplayTooltip("A scatterplot matrix","splom.png")}),addGlobalDisplayType({type:DISPLAY_PLOTLY_3DSCATTER,label:"3D Scatter",requiresData:!0,forUser:!1,category:CATEGORY_RADIAL_ETC}),addGlobalDisplayType({type:DISPLAY_PLOTLY_PROFILE,label:"Profile",requiresData:!0,forUser:!0,category:CATEGORY_CHARTS,tooltip:makeDisplayTooltip(null,"profile.png")}),addGlobalDisplayType({type:DISPLAY_PLOTLY_3DMESH,label:"3D Mesh",requiresData:!1,forUser:!1,category:CATEGORY_RADIAL_ETC}),addGlobalDisplayType({type:DISPLAY_PLOTLY_TEXTCOUNT,label:"Text Count",requiresData:!0,forUser:!0,category:CATEGORY_TEXT,tooltip:makeDisplayTooltip("Shows counts of certain patterns","textcount.png","Given a text field show the number of <br>times certain word patterns occur")});const DISPLAY_THREE_GLOBE="three_globe";addGlobalDisplayType({type:DISPLAY_THREE_GLOBE,forUser:!0,label:"3D Globe",requiresData:!0,category:CATEGORY_MAPS});const DISPLAY_THREE_GRID="three_grid";addGlobalDisplayType({type:DISPLAY_THREE_GRID,forUser:!0,label:"3D Grid",requiresData:!0,category:CATEGORY_CHARTS});var ramaddaLoadedThree=!1,ramaddaLoadedThreeGlobe=!1;function RamaddaThree_Base(t,e,i,a){defineDisplay(this,new RamaddaDisplay(t,e,i,a),[],{parseInt:function(t,e){return"number"==typeof t?t:t?(t.match("rgb")&&(t=Utils.rgbToHex(t)),t.startsWith("#")&&(t=t.substring(1)),t.startsWith("0x")||(t="0x"+t),parseInt(Number(t),10)):e},getScene(){return this.scene},getControls(){return this.controls}})}function RamaddaThree_globeDisplay(t,e,i){const s="globe",l="popup",r="positionbutton";let o={Base:{position:{x:6048899205465489e-36,y:1.832130202344028e-20,z:250},up:{x:1546799663044268e-37,y:1,z:-7328520809376114e-38}},"North America":{position:{x:-185.0051316412852,y:166.36750886777244,z:-24.391663730099083},up:{x:.6540380289233074,y:.7458336330441189,z:.12635841302550785}},"South America":{position:{x:-220.53665870332205,y:-71.90185405284046,z:93.24004264123046},up:{x:-.2051500901346411,y:.9474654144116881,z:.24540319682399764}},Europe:{position:{x:76.01040670390248,y:193.37167151814756,z:139.03170403539133},up:{x:-.286288586763548,y:.6309644429890481,z:-.7210566668247681}},Asia:{position:{x:215.9418144948879,y:118.22041784669743,z:-43.50937320632211},up:{x:-.4872587496088534,y:.8718613869731202,z:-.04936226124191964}},Africa:{position:{x:82.50264441171257,y:6.133419606337622,z:235.91459223415376},up:{x:-.005217856566188513,y:.9996943480371796,z:-.024165770738191875}},Australia:{position:{x:166.64046097372514,y:-104.10022198889281,z:-154.57716696953614},up:{x:.32825699830271454,y:.9086541300046129,z:-.25806009976525474}},Pacific:{position:{x:-50.02109926067879,y:70.1629622786457,z:-293.1352563989274},up:{x:.578136747554258,y:.8103545388010297,z:.09530699120186392}},"North Atlantic":{position:{x:-137.7219663374266,y:134.93931772927482,z:159.1352899859414},up:{x:.3485760134063413,y:.8418048847668705,z:-.4121399020482765}},"South Pole":{position:{x:0,y:-249.99925472592855,z:-.6104395794518828},up:{x:.9999999999999998,y:0,z:0}},"North Pole":{position:{x:12.435991378990524,y:249.68975620440986,z:.6097253513751638},up:{x:-.9987620026286266,y:.049743817204226284,z:.00012147100820090829}}};const n=new RamaddaThree_Base(t,e,DISPLAY_THREE_GLOBE,i);defineDisplay(addRamaddaDisplay(this),n,[{label:"3D Globe Attributes"},{p:"globeWidth",d:800},{p:"globeHeight",d:400},{p:"baseImage",d:"earth-blue-marble.jpg",ex:"earth-blue-marble.jpg|earth-day.jpg|earth-dark.jpg|world-boundaries.png|caida.jpg|white.png|lightblue.png|black.png"},{p:"globeBackgroundImage",ex:"night-sky.png|white.png|lightblue.png|black.png"},{p:"backgroundColor",d:"#CAE1FF",ex:"#ffffff"},{p:"initialPosition",ex:"North America|South America|Europe|Asia|Africa|Australia|South Pole|North Pole"},{p:"linked",ex:!0,tt:"Link location with other globes"},{p:"linkGroup",ex:"some_name",tt:"Globe groups to link with"},{p:"mapColor",d:"blue"},{p:"showGraticules",ex:!0},{p:"showAtmosphere",d:!0,ex:"false"},{p:"atmosphereColor",d:"#fff",ex:"red"},{p:"atmosphereAltitude",d:.25,ex:.5},{p:"ambientLight",d:"ffffff",ex:"ffffff"},{p:"ambientIntensity",d:1,ex:"1"},{p:"directionalIntensity",d:1},{p:"directionalLight1",ex:"ffffff"},{p:"directionalIntensity1",ex:"0.5"},{p:"directionalPosition1",ex:"0,1,0"},{p:"directionalLight2",ex:"ffffff"},{p:"directionalIntensity2",ex:"0.5"},{p:"directionalPosition2",ex:"0,1,0"},{p:"initialAltitude",d:250,ex:500},{p:"color",d:"blue",ex:"red"},{p:"showPoints",d:!0,ex:"false"},{p:"showSpheres",ex:!0},{p:"pointRadius",d:1,ex:"1"},{p:"pointResolution",d:12},{p:"heightField",tt:"field to map height to"},{p:"heightMin",d:0,tt:"min height range that heightField value percent is mapped to"},{p:"heightMax",d:.5},{p:"radiusField",tt:"field to map radius to"},{p:"radiusMin",d:1},{p:"radiusMax",d:5},{p:"labelFields",tt:"fields for the label"},{p:"labelColor",d:"red",ex:"red"},{p:"labelSize",d:.5},{p:"labelDotRadius",d:.1},{p:"labelResolution",d:3},{p:"labelIncludeDot",d:!0},{p:"latField1",tt:"Field id for segments"},{p:"lonField1",tt:"Field id for segments"},{p:"latField2",tt:"Field id for segments"},{p:"lonField2",tt:"Field id for segments"},{p:"lineWidth",d:.1},{p:"lineAltitude",d:.05},{p:"showEndPoints",d:!0},{p:"polygonField",tt:"field that holds polygons"},{p:"geojson",tt:"base layer map or used for chloropleth display",ex:"us_states.geojson|us_counties.geojson|countries.geojson|entryid|url"},{p:"polygonNameField",tt:"Field to match with the name field in the geojson map, e.g., state"},{p:"polygonAltitude",d:.01},{p:"selectedDiv",ex:"div id to show selected record"},{p:"doPopup",d:!0,ex:"",tt:""},{p:"centerOnFilterChange",d:!0,ex:!1,tt:"Center map when the data filters change"}],{needsData:function(){return!0},initDisplay:function(){n.initDisplay.call(this)},dataFilterChanged:function(t){n.dataFilterChanged.call(this,t),this.getCenterOnFilterChange()&&this.filteredRecords&&0!=this.filteredRecords.length&&this.viewRecords(this.filteredRecords)},viewRecords:function(t){let e=RecordUtil.getBounds(t),i=e.south+(e.north-e.south)/2,a=e.west+(e.east-e.west)/2;this.globe.pointOfView({lat:i,lng:a,alt:1e4})},updateUI:async function(){if(!window.THREE)return ramaddaLoadedThree||(ramaddaLoadedThree=!0,Utils.importJS("//unpkg.com/three")),void setTimeout((()=>{this.updateUI()}),100);if(!window.Globe)return ramaddaLoadedThreeGlobe||(ramaddaLoadedThreeGlobe=!0,Utils.importJS("//unpkg.com/globe.gl")),void setTimeout((()=>{this.updateUI()}),100);n.updateUI.call(this),this.jq(l).hide();let t=this.filterData();if(!t)return;this.filteredRecords=t,this.globe||this.createGlobe();let e,i=this.getColorByInfo(t),a=this.getColor(),s=[],r=this.getFieldById(null,this.getHeightField());r&&(e=this.getColumnValues(t,r));let o,h=this.getHeightMin(),d=this.getHeightMax(),p=t=>{if(!e)return 0;let i=(r.getValue(t)-e.min)/(e.max-e.min);return h+i*(d-h)},g=this.getFieldById(null,this.getProperty("radiusField"));g&&(o=this.getColumnValues(t,g));let c=this.getRadiusMin(),u=this.getRadiusMax(),y=t=>{if(!o||!t)return this.getPointRadius();let e=(g.getValue(t)-o.min)/(o.max-o.min);return c+e*(u-c)},m=this.getFieldsByIds(null,this.getProperty("labelFields"));if(m&&m.length){let e=[],i=this.getLabelColor();t.forEach(((t,a)=>{let s="";m.forEach(((e,i)=>{i>0&&(s+=" "),s+=e.getValue(t)})),e.push({record:t,label:s,lat:t.getLatitude(),lng:t.getLongitude(),color:i})})),this.globe.labelsData(e).labelLat((t=>t.lat)).labelLng((t=>t.lng)).labelText((t=>t.label)).labelColor((t=>t.color)).labelDotRadius(this.getLabelDotRadius()).labelSize(this.getLabelSize()).labelResolution(this.getLabelResolution()),this.globe.labelIncludeDot(this.getLabelIncludeDot())}let f=this.getFieldById(null,this.getProperty("polygonField")),D=this.getFieldById(null,this.getProperty("latField1")),I=this.getFieldById(null,this.getProperty("lonField1")),T=this.getFieldById(null,this.getProperty("latField2")),b=this.getFieldById(null,this.getProperty("lonField2"));if(D&&I&&T&&b){let e=[],l=this.getShowEndPoints();t.forEach(((t,r)=>{let o=i.getColorFromRecord(t,a);e.push({startLat:D.getValue(t),startLng:I.getValue(t),endLat:T.getValue(t),endLng:b.getValue(t),color:o,record:t}),l&&(s.push({height:0,lat:D.getValue(t),lng:I.getValue(t),color:o,radius:this.getPointRadius(.5),record:t}),s.push({height:0,lat:T.getValue(t),lng:b.getValue(t),color:o,radius:this.getPointRadius(.5),record:t}))})),this.globe.arcsData(e).arcStroke(+this.getLineWidth()).arcAltitude(this.getLineAltitude()).arcColor("color").arcDashGap(0)}else if(f){let e,i=this.getColorTable(!0,"polygonColorTable",null);this.didit;this.didit||(this.didit=!0);let l=this.getProperty("latlon",!0),r=[],o=0;t.forEach(((t,n)=>{let h=a;i&&(o>=i.length&&(o=0),h=i[o++]);let d=[],g={points:d,record:t,color:h};r.push(g);let c=f.getValue(t);e||[";",","].forEach((t=>{c.indexOf(t)>=0&&(e=t)}));let u=c.split(e);for(let e=0;e<u.length;e+=2){let i=parseFloat(u[e]),a=parseFloat(u[e+1]);if(!l){let t=i;i=a,a=t}if(d.push([i,a,1]),0==e||e==u.length-2){let e={lat:i,lng:a,color:h,height:p(t),radius:this.getPointRadius(),record:t};s.push(e)}}})),this.globe.pathsData(r).pathPoints((t=>t.points)).pathColor((t=>[t.color,t.color])).pathDashLength(.01).pathDashGap(0).pathPointAlt((t=>0))}else t.forEach(((t,e)=>{let l={lat:t.getLatitude(),lng:t.getLongitude(),color:i.getColorFromRecord(t,a),height:p(t),radius:y(t),record:t};s.push(l)}));if(s.length>0&&(this.getShowSpheres()?this.globe.customLayerData(s).customThreeObject((t=>new THREE.Mesh(new THREE.SphereBufferGeometry(t.radius),new THREE.MeshLambertMaterial({color:t.color})))).customThreeObjectUpdate(((t,e)=>{Object.assign(t.position,this.globe.getCoords(e.lat,e.lng,e.height+.01))})):this.getShowPoints()&&this.globe.pointsData(s).pointAltitude("height").pointColor("color").pointRadius("radius").pointResolution(this.getPointResolution())),this.getProperty("geojson")){this.getFieldById(null,this.getPolygonNameField())&&this.addGeojsonLayer(t)}i.isEnabled()&&i.displayColorTable(),this.getInitialPosition()||this.viewRecords(t),this.callHook("updateUI")},getScene(){return this.globe.scene()},getControls(){return this.globe.controls()},setPosition:function(t){"string"==typeof t&&t.trim().startsWith("{")&&(t=this.parsePosition(t));let e=this.getControls();t.target&&e.target.copy(t.target),t.position&&e.object.position.copy(t.position),t.up&&e.object.up.copy(t.up),t.zoom&&(e.object.zoom=t.zoom),e.object.updateProjectionMatrix(),e.object.lookAt(e.target)},getDataObjects:function(t){let e=[],i=(a,s)=>{if(a.__data&&a.__data.record){if(t){let e=a.__data.record.getId();t[e]||(t[e]=[]),t[e].push(a)}e.push(a)}a.children&&a.children.length&&a.children.forEach(i)};return this.getScene().children.forEach(i),e},listScene:function(){this.getScene().children.forEach((t=>{console.log(t.type),console.dir(t)}))},addLights:function(){if(this.addedLight)return;this.addedLight=!0,this.getScene().children.filter((t=>"DirectionalLight"==t.type||"AmbientLight"==t.type)).forEach((t=>{this.getScene().remove(t)}));let t=this.getAmbientLight();t&&"none"!=t&&this.getScene().add(new THREE.AmbientLight(this.parseInt(t),this.getAmbientIntensity()));for(let t=1;t<10;t++){let e=this.getProperty("directionalLight"+t);if(!Utils.isDefined(e)||"none"==e)continue;let i=new THREE.DirectionalLight(this.parseInt(e),this.getProperty("directionalIntensity"+t,this.getDirectionalIntensity())),a=this.getProperty("directionalPosition"+t,"0,1,0").split(",");i.position.set(+a[0],+a[1],+a[2]),this.getScene().add(i)}},createGlobe:function(){let t=this,e=HU.div([CLASS,"display-three-globe-popup",ID,this.domId(l),STYLE,HU.css("display","none","position","absolute","left","60%","top","0px")],""),i=HU.div([TITLE,"Select Position",CLASS,"ramadda-clickable",ID,this.domId(r),STYLE,HU.css("position","absolute","left","10px","top","10px","z-index","1000")],HU.getIconImage("fa-globe")),n=HU.div([STYLE,HU.css("position","relative")],i+e+HU.div([ID,this.domId(s)])),h=HU.center(n);h=n,this.setContents(h),this.jq(l).click((()=>{this.jq(l).hide()})),this.jq(r).click((()=>{let e="";for(a in o)e+=HU.div([CLASS,"ramadda-clickable","place",a],a);e=HU.div([STYLE,HU.css("margin","5px")],e);let i=HU.makeDialog({content:e,anchor:this.jq(r)});i.find(".ramadda-clickable").click((function(){t.setPosition(o[$(this).attr("place")]),i.remove()}))}));let d=document.getElementById(this.domId(s)),p=this.getGlobeWidth(),g=this.getGlobeHeight();this.globe=Globe()(d),this.globe.onGlobeReady((()=>this.addLights())),this.globe.width(p),this.globe.height(g),this.globe.showGraticules(this.getShowGraticules()).showAtmosphere(this.getShowAtmosphere()).atmosphereColor(this.getAtmosphereColor()).atmosphereAltitude(this.getAtmosphereAltitude());let c=this.getImageUrl(this.getBaseImage());c&&this.globe.globeImageUrl(c);let u=this.getImageUrl(this.getGlobeBackgroundImage());u&&this.globe.backgroundImageUrl(u);let y=this.getBackgroundColor();y&&this.globe.backgroundColor(y);try{let t=this.jq(s).find("canvas");t.attr("tabindex","1"),t.mouseover((()=>{this.mouseOver=!0})),t.mouseout((()=>{this.mouseOver=!1})),d.addEventListener("keydown",(t=>{if("KeyD"!=t.code){if("KeyP"==t.code){let t=prompt("Name:");if(!t)return;let e=["x","y","z"],i="{position: {";e.forEach(((t,e)=>i+=(e>0?",":"")+t+":"+this.getControls().object.position[t])),i+="},\nup: {",e.forEach(((t,e)=>i+=(e>0?",":"")+t+":"+this.getControls().object.up[t])),i+="}}";let a='"'+t+'":'+i;console.log(a),Utils.copyToClipboard(i.replace(/\n/g,""))}if("KeyR"==t.code){let t=o[this.getInitialPosition()||"North America"]||this.getInitialPosition();t&&this.setPosition(t)}}else this.listScene()}))}catch(t){console.error("Error creating trackball control:"+t),console.log("ctor:"),console.log(THREE.TrackballControls),console.error(t.stack)}let m=this.handleMouseEvent=t=>{this.jq(l).hide();let e=t.record;e&&(this.propagateEventRecordSelection({record:e}),this.showRecord(e))};if(this.getProperty("geojson")){this.getFieldById(null,this.getPolygonNameField())||this.addGeojsonLayer()}this.globe.onPointClick(m),this.globe.onArcClick(m),this.globe.onPathClick(m),this.globe.onLabelClick(m),this.globe.onGlobeClick((()=>{this.jq(l).hide()}));this.getLinked(),this.getLinkGroup();if(this.globe.onZoom((()=>{if(!this.mouseOver)return;if(this.zooming)return;let t=Utils.displaysList.filter((t=>t.getId()!=this.getId()&&(t.type==DISPLAY_THREE_GLOBE&&(!!t.getLinked()&&(!!t.globe&&((!t.getLinkGroup()||!this.getLinkGroup()||t.getLinkGroup()==this.getLinkGroup())&&!t.zooming))))));this.zooming=!0,t.forEach((t=>{let e=this.getControls().object.position;t.zooming=!0,t.getControls().object.position.set(e.x,e.y,e.z),t.zooming=!1})),this.zooming=!1})),this.getInitialPosition()){let t=this.getInitialPosition(),e=o[t];if(!e&&t.startsWith("{")&&(e=this.parsePosition(t)),!e)return void console.error("Unknown initial position:"+this.getInitialPosition());this.setPosition(e)}this.callHook("createGlobe")},parsePosition:function(t){if(t&&"string"==typeof t&&t.startsWith("{")){t=t.replace("position",'"position"').replace("up",'"up"').replace(/x/g,'"x"').replace(/y/g,'"y"').replace(/z/g,'"z"');try{return JSON.parse(t)}catch(e){console.err("Error parsing position:"+e+"\n"+t)}}return null},showRecord:function(t){if(this.getDoPopup()){let e=this.getRecordHtml(t);return this.jq(l).html(e),void this.jq(l).show(1e3)}if(this.getSelectedDiv()){let e=this.getRecordHtml(t);$("#"+this.getSelectedDiv()).html(e)}},addGeojsonLayer:function(t){let e=this.getFieldById(null,this.getPolygonNameField()),i=null;t&&(i=this.getColorByInfo(t));let a=this.getMapUrl(this.getProperty("geojson")),s=this.getMapColor();$.getJSON(a,(a=>{let l={"united states of america":"united states",czechia:"czech republic",swaziland:"eswatini","south korea":"korea (rep.)","north korea":"korea (dem. people s rep.)","eq. guinea":"guinea",gambia:"gambia the",congo:"congo (rep.)","democratic republic of the congo":"congo (dem. rep.)","ivory coast":"cote d'ivoire"},r={};e&&t.forEach((t=>{let i=e.getValue(t);r[i]=t,r[i.toLowerCase()]=t,r[i.toUpperCase()]=t}));let o=0;a.features.forEach((t=>{if(!t.properties)return void(o++<50&&console.error("No properties in feature"));let e={},a=[t.properties.SOVEREIGNT,t.properties.name,t.properties.NAME,t.properties.ADMIN].filter((t=>!e[t]&&(e[t]=!0,t)));if(0==a.length)return void(o++<50&&console.log("Could not find name in feature:"+JSON.stringify(t.properties)));let s=null;a.every((t=>(s=r[t],!s))),s||a.every((t=>{let e=l[t.toLowerCase()];return!e||(s=r[e],!s)})),s&&(t.record=s,i&&i.isEnabled()&&(t.color=i.getColorFromRecord(s,null)))}));let n=this.getPolygonAltitude();if(this.globe.polygonsData(a.features).polygonStrokeColor((()=>s)).polygonCapColor((t=>t.color||"transparent")).polygonSideColor((t=>t.color||"transparent")).polygonAltitude(n),e){this.getProperty("tooltip")&&this.globe.polygonLabel((t=>{if(!t.record)return null;let e=this.getRecordHtml(t.record);return e=HU.div([CLASS,"display-three-globe-popup"],e),e})),this.globe.onPolygonHover((t=>{this.globe.polygonAltitude((e=>e===t?.08:n))})).polygonsTransitionDuration(300)}})).fail((t=>{console.error("failed to load json:"+a)})),e&&this.globe.onPolygonClick(this.handleMouseEvent)},getImageUrl:function(t){return t?(t.startsWith("http")||t.startsWith("/")||(t=ramaddaBaseHtdocs+"/images/maps/"+t),t):null},getMapUrl:function(t){return t?(t.startsWith("http")||t.startsWith("/")||(t=t.trim().match(/.*[0-9a-z]+-[0-9a-z]+-[0-9a-z]+-[0-9a-z]+-[0-9a-z]+.*/)?ramaddaBaseUrl+"/entry/get?entryid="+t:ramaddaBaseHtdocs+"/resources/"+t),t):null},handleEventRecordSelection:function(t,e){n.handleEventRecordSelection.call(this,t,e);let i=e.record;this.globe.pointOfView({lat:i.getLatitude(),lng:i.getLongitude(),alt:1e4});this.globe.getCoords(e.record.getLatitude(),e.record.getLongitude());this.selectedObjects&&this.selectedObjects.forEach((t=>{t.material.color.setHex(t.__oldcolor)}));let a={};this.getDataObjects(a);let s=a[e.record.getId()];this.selectedObjects=s,s&&s.forEach((t=>{t.__oldcolor=t.material.color.getHex(),t.material.color.setRGB(1,0,0)}))}})}function RamaddaThree_gridDisplay(t,e,i){const a="grid",s="popup";const l=new RamaddaThree_Base(t,e,DISPLAY_THREE_GRID,i);defineDisplay(addRamaddaDisplay(this),l,[{label:"3D Grid Attributes"},{p:"gridWidth",d:400},{p:"gridHeight",d:400},{p:"backgroundColor",d:"#CAE1FF",ex:"#ffffff"},{p:"canvasBorder",d:"1px solid #ccc"},{p:"shape",d:"box",ex:"box|cylinder"},{p:"heightField",tt:"field to scale height by"},{p:"heightScale",d:10,tt:"scale factor"},{p:"doPopup",d:!0,ex:"",tt:""},{p:"doImages",ex:!0}],{needsData:function(){return!0},initDisplay:function(){l.initDisplay.call(this)},dataFilterChanged:function(t){l.dataFilterChanged.call(this,t)},updateUI:async function(){if(ramaddaLoadedThree||(ramaddaLoadedThree=!0,await Utils.importJS(ramaddaBaseHtdocs+"/lib/three/three.min.js"),await Utils.importJS(ramaddaBaseHtdocs+"/lib/three/controls/OrbitControls.js")),!window.THREE)return void setTimeout((()=>{this.updateUI()}),100);if(!THREE.OrbitControls)return void setTimeout((()=>{this.updateUI()}),100);l.updateUI.call(this),this.jq(s).hide(),this.shapes||this.createScene(),this.shapes.forEach((t=>{this.scene.remove(t)}));let t=this.filterData();if(!t)return;this.filteredRecords=t;let e=Math.ceil(Math.sqrt(t.length)),i=1.5*e;if(!this.initCamera){this.initCamera=!0;let t=i/2/Math.tan(Utils.toRadians(22.5));this.camera.position.set(0,0,2*t)}let a=1.5*-e/2,r=-a,o=a,n=r,h=this.getColorByInfo(t),d=[];if(this.colorByFields){let e=this.getFields();this.colorByFields.forEach((i=>{let a=new ColorByInfo(this,e,t,null,null,null,null,i);d.push(a)}))}RecordUtil.getBounds(t);let p,g=this.getHeightScale();this.getProperty("heightField")&&(p=new SizeBy(this,this.getProperty("sizeByAllRecords",!0)?this.getData().getRecords():t,"heightField")),0==d.length&&(d=[h]),d=[h];let c=this.getDoImages(),u=this.getFieldsByType(null,"image");const y=new THREE.TextureLoader;let m=this.getShape();shapeWidth=.5;t.forEach(((t,e)=>{if(o>-a&&(n-=1.5,o=a),c){let e=new THREE.BoxGeometry(1,1,1);const i=[];u.forEach((e=>{let a=e.getValue(t);Utils.stringDefined(a)&&i.push(new THREE.MeshBasicMaterial({map:y.load(a)}))}));let a=new THREE.Mesh(e,i);a.position.x=o,a.position.y=n,this.scene.add(a),this.shapes.push(a)}else{let e,i=h.getColorFromRecord(t,null),a=new THREE.MeshLambertMaterial({color:this.parseInt(i,16711680)}),s=1;if(p){let e,i=t=>{e=t};p.getSize(t.getData(),0,i);isNaN(e)||(s+=e*s*g)}e="box"==m?new THREE.BoxGeometry(shapeWidth,shapeWidth,s):new THREE.CylinderGeometry(1,1,s,32);let l=new THREE.Mesh(e,a);"box"==m||(l.rotation.x=Utils.toRadians(90)),l.position.x=o,l.position.y=n,l.position.z=s/2,this.scene.add(l),l.__record=t,this.shapes.push(l)}o+=1.5})),h.isEnabled()&&h.displayColorTable(),this.callHook("updateUI")},addChecker:function(t){const e=1.1*t,i=(new THREE.TextureLoader).load("https://threejsfundamentals.org/threejs/resources/images/checker.png");i.wrapS=THREE.RepeatWrapping,i.wrapT=THREE.RepeatWrapping,i.magFilter=THREE.NearestFilter;const a=e/2;i.repeat.set(a,a);const s=new THREE.PlaneGeometry(e,e),l=new THREE.MeshPhongMaterial({map:i,side:THREE.DoubleSide}),r=new THREE.Mesh(s,l);this.scene.add(r)},createScene:function(){let t=HU.div([CLASS,"display-three-globe-popup",ID,this.domId(s),STYLE,HU.css("display","none","position","absolute","left","60%","top","0px")],""),e=HU.div([STYLE,HU.css("position","relative")],t+HU.div([STYLE,HU.css("min-width","200px","min-height","200px"),ID,this.domId(a)])),i=HU.center(e);this.setContents(i),this.scene=new THREE.Scene;let l=this.getGridWidth(),r=this.getGridHeight();this.aspectRatio=l/r;window.devicePixelRatio,window.devicePixelRatio;this.camera=new THREE.PerspectiveCamera(45,l/r,.1,1e3),this.camera=new THREE.OrthographicCamera(-100,100,100,-100,.1,1e3),this.camera.position.set(0,0,100);var o=new THREE.AxisHelper(1e3);this.scene.add(o),this.renderer=new THREE.WebGLRenderer({antialias:!0,alpha:!0}),this.renderer.setClearColor(this.getBackgroundColor()),this.renderer.setSize(l,r),this.controls=new THREE.OrbitControls(this.camera,this.renderer.domElement),this.controls.minDistance=0,this.controls.maxDistance=1e3,this.controls.target.set(0,0,5),this.controls.update(),this.jq(a).append(this.renderer.domElement);((t,e,i,a,s)=>{s=.01,Utils.isDefined(s)||(s=1);let l=new THREE.DirectionalLight(this.parseInt(t));l.position.set(e,i,a),this.getScene().add(l)})(16777215,-1,1,1);var n=new THREE.AmbientLight(16777215,.5);this.scene.add(n),n=new THREE.HemisphereLight(16777215,16777147,1);let h=this,d=this.jq(a).find("canvas");d.attr("tabindex","1"),d.css("border",this.getCanvasBorder()),this.renderer.domElement.addEventListener("keydown",(t=>{if("KeyP"==t.code){let t=prompt("Name:");if(!t)return;let e=["x","y","z"],i="{position: {";e.forEach(((t,e)=>i+=(e>0?",":"")+t+":"+this.getControls().object.position[t])),i+="},\nup: {",e.forEach(((t,e)=>i+=(e>0?",":"")+t+":"+this.getControls().object.up[t])),i+="}}";Utils.copyToClipboard(i.replace(/\n/g,""))}"KeyR"==t.code&&h.controls.reset()}));if(this.renderer.domElement.addEventListener("mouseup",(t=>{if(this.jq(s).hide(),t.preventDefault(),!t.shiftKey||1!=t.which)return;let e=new THREE.Raycaster,i={x:t.offsetX/l*2-1,y:-t.offsetY/r*2+1};e.setFromCamera(i,this.camera);let a=e.intersectObjects(this.shapes,!0);if(0==a.length)return void console.log("nothing found");let o=NaN,n=null;a.forEach((t=>{(null==n||o>t.distance)&&(n=t.object,o=t.distance)}));let h=t=>t.__record?t.__record:t.parent?h(t.parent):null,d=h(n);if(d){if(console.log("record:"+d),this.propagateEventRecordSelection({record:d}),this.getDoPopup()){let t=this.getRecordHtml(d);return this.jq(s).html(t),void this.jq(s).show(1e3)}if(this.getSelectedDiv()){let t=this.getRecordHtml(d);$("#"+this.getSelectedDiv()).html(t)}}else console.log("Could not find record")}),!1),h.renderer.render(h.scene,h.camera),this.shapes=[],!this.animating){this.animating=!0,function t(){requestAnimationFrame(t),h.controls.update(),h.shapes.forEach(((t,e)=>{})),h.renderer.render(h.scene,h.camera)}()}}})}function RamaddaXlsDisplay(t,e,i){var a="xaxis",s="yaxis",l="group",r="searchextra",o="searchheader",n="results",h="downloadurl",d="searchdiv",p="searchform",g="searchtext",c="tableholder",u="table",y="charttoolbar",m="chart";RamaddaUtil.inherit(this,new RamaddaDisplay(t,e,"xls",i)),addRamaddaDisplay(this),this.url=i.url,this.tableProps={fixedRowsTop:0,fixedColumnsLeft:0,rowHeaders:!0,colHeaders:!0,headers:null,skipRows:0,skipColumns:0},null!=i&&$.extend(this.tableProps,i),RamaddaUtil.defineMembers(this,{initDisplay:function(){this.createUI(),this.setDisplayTitle("Table Data");var t=HtmlUtils.div(["id",this.getDomId(o)])+HtmlUtils.div(["id",this.getDomId(c)])+HtmlUtils.div(["id",this.getDomId(y)])+HtmlUtils.div(["id",this.getDomId(m)]);this.setContents(t),this.loadTableData(this.url)}}),RamaddaUtil.defineMembers(this,{currentSheet:0,currentData:null,columnLabels:null,startRow:0,groupIndex:-1,xAxisIndex:-1,yAxisIndex:-1,header:null,cellSelected:function(t,e){this.startRow=t,this.jq("params-xaxis-select").attr("checked")?this.xAxisIndex=e:this.jq("params-group-select").attr("checked")?this.groupIndex=e:this.yAxisIndex=e;this.setAxisLabel(a,this.getHeading(this.xAxisIndex,!0)),this.setAxisLabel(l,this.getHeading(this.groupIndex,!0)),this.setAxisLabel(s,this.getHeading(this.yAxisIndex,!0))},getAxisLabelId:function(t){return"params-"+t+"-label"},setAxisLabel:function(t,e){t=this.getAxisLabelId(t);var i=HtmlUtils.getUniqueId();e.length>25&&(e=e.substring(0,25)+"..."),""!=e.trim()&&(e=HtmlUtils.span(["id",i,"class","ramadda-tag-box"],"&nbsp;&nbsp;"+e+"&nbsp;&nbsp;")),this.jq(t).html(e)},loadSheet:function(t){var e=$("[id^="+this.getDomId("sheet_")+"]"),i=$("#"+this.getDomId("sheet_")+t);e.css("font-weight","normal"),i.css("font-weight","bold"),e.css("border","1px #ccc solid"),i.css("border","1px #666 solid"),this.currentSheet=t;var a=this.sheets[t];let s;if(a&&(s=a.rows.slice(0),s.length>0&&(this.header=s[0])),s){var l=this,r={contextMenu:!0,stretchH:"all",colHeaders:!0,rowHeaders:!0,minSpareRows:1,afterSelection:function(){if(arguments.length>2){for(var t=0;t<arguments.length;t++);var e=arguments[0],i=arguments[1];l.cellSelected(e,i)}}};if($.extend(r,this.tableProps),this.tableProps.useFirstRowAsHeader){var o=s[0];r.colHeaders=o,s=s.splice(1)}for(var h=0;h<this.tableProps.skipRows;h++)s=s.splice(1);if(0==s.length)return this.displayMessage("No data found"),void this.jq(n).html("");this.jq(n).html("Found: "+s.length),r.data=s,this.currentData=s,null!=this.tableProps.headers&&(r.colHeaders=this.tableProps.headers),this.getProperty("showTable",!0)&&this.jq(u).handsontable(r)}else this.displayHtml(this.getMessage("No data"))},getDataForSheet:function(t,e){var i=this.sheets[t].rows.slice(0);if(i.length>0&&(this.header=i[0]),this.tableProps.useFirstRowAsHeader){var a=i[0];e&&(e.colHeaders=a),i=i.splice(1)}for(var s=0;s<this.tableProps.skipRows;s++)i=i.splice(1);return i},makeChart:function(t,e){if("undefined"!=typeof google){null==e&&(e={});var i=Utils.getDefined(e.xAxisIndex,this.xAxisIndex),a=Utils.getDefined(e.groupIndex,this.groupIndex),s=Utils.getDefined(e.yAxisIndex,this.yAxisIndex);if(s<0)alert("You must select a y-axis field.\n\nSelect the desired axis with the radio button.\n\nClick the column in the table to chart.");else{var l=this.currentSheet;if(void 0!==e.sheet&&(l=e.sheet),null!=(r=this.getDataForSheet(l))){for(var r=r.slice(1),o=0;o<this.startRow-1;o++)r=r.slice(1);var n=[];console.log("x:"+i+"  y:"+s+" group:"+a);for(var h=0;h<r.length;h++){var d=[];i>=0?d.push(r[h][i]):d.push(h),s>=0&&d.push(r[h][s]),n.push(d),h<2&&console.log("row:"+d)}r=n;for(h=0;h<r.length;h++)for(var p=r[h],g=0;g<p.length;g++){var c=p[g]+"";p[g]=parseFloat(c.trim())}var u=this.getHeading(i,!0),y=this.getHeading(s,!0);this.getHeading(a,!0);this.columnLabels=[u,y];var f=null!=this.columnLabels?this.columnLabels:["Field 1","Field 2"];r.splice(0,0,f);var D=google.visualization.arrayToDataTable(r),I={};$.extend(I,{legend:{position:"top"}}),null!=this.header&&(i>=0&&(I.hAxis={title:this.header[i]}),s>=0&&(I.vAxis={title:this.header[s]}));var T=HtmlUtils.getUniqueId(),b=["id",T];"scatterplot"==t&&(b.push("style"),b.push("width: 450px; height: 450px;")),this.jq(m).append(HtmlUtils.div(b)),"barchart"==t?(I.chartArea={left:75,top:10,height:"60%",width:"95%"},I.orientation="horizontal",this.chart=new google.visualization.BarChart(document.getElementById(T))):"table"==t?this.chart=new google.visualization.Table(document.getElementById(T)):"motion"==t?this.chart=new google.visualization.MotionChart(document.getElementById(T)):"scatterplot"==t?(I.chartArea={left:50,top:30,height:400,width:400},I.legend="none",I.axisTitlesPosition="in",this.chart=new google.visualization.ScatterChart(document.getElementById(T))):($.extend(I,{lineWidth:1}),I.chartArea={left:75,top:10,height:"60%",width:"95%"},this.chart=new google.visualization.LineChart(document.getElementById(T))),null!=this.chart&&this.chart.draw(D,I)}else this.jq(m).html("There is no data")}}else this.jq(m).html("No google chart available")},addNewChartListener:function(t,e){var i=this;$("#"+t+"-"+e).button().click((function(t){console.log("make chart:"+e),i.makeChart(e)}))},makeSheetButton:function(t,e){var i=this;$("#"+t).button().click((function(t){i.loadSheet(e)}))},clear:function(){this.jq(m).html(""),this.startRow=0,this.groupIndex=-1,this.xAxisIndex=-1,this.yAxisIndex=-1,this.setAxisLabel(l,""),this.setAxisLabel(a,""),this.setAxisLabel(s,"")},getHeading:function(t,e){if(t<0)return"";if(null!=this.header&&t>=0&&t<this.header.length){var i=this.header[t];if((i=i.trim()).length>0)return i}return e?"Field "+(t+1):""},showTableData:function(t){var e=this;this.data=t,this.sheets=this.data.sheets,this.columns=t.columns;for(var i="",a=0;a<this.sheets.length;a++){var s=this.getDomId("sheet_"+a);i+=HtmlUtils.div(["id",s,"class","ramadda-xls-button-sheet"],this.sheets[a].name),i+="\n"}var l='<table width=100% style="max-width:1000px;" > ';this.sheets.length,l+="<tr valign=top>",this.sheets.length>1&&(l+=HtmlUtils.td(["width","140"],HtmlUtils.div(["class","ramadda-xls-buttons"],i)));var m=HtmlUtils.getUniqueId(),f=this.getProperty("tableWidth",""),D="";""!=f&&(D+=" width:"+f+";"),D+=" height: "+this.getProperty("tableHeight","500px")+";",D+=" overflow: auto;",l+=HtmlUtils.td([],HtmlUtils.div(["id",this.getDomId(u),"class","ramadda-xls-table","style",D])),l+="</tr>",l+="</table>";for(var I="",T=["barchart","linechart","scatterplot"],b=0;b<T.length;b++)I+=HtmlUtils.div(["id",m+"-"+T[b],"class","ramadda-xls-button"],"Make "+T[b]),I+="&nbsp;";if(I+="&nbsp;",I+=HtmlUtils.div(["id",this.getDomId("removechart"),"class","ramadda-xls-button"],"Clear Charts"),I+="<p>",I+="<form>Fields: ",I+='<input type=radio checked name="param" id="'+this.getDomId("params-yaxis-select")+'"> y-axis:&nbsp;'+HtmlUtils.div(["id",this.getDomId("params-yaxis-label"),"style","border-bottom:1px #ccc dotted;min-width:10em;display:inline-block;"],""),I+="&nbsp;&nbsp;&nbsp;",I+='<input type=radio  name="param" id="'+this.getDomId("params-xaxis-select")+'"> x-axis:&nbsp;'+HtmlUtils.div(["id",this.getDomId("params-xaxis-label"),"style","border-bottom:1px #ccc dotted;min-width:10em;display:inline-block;"],""),I+="&nbsp;&nbsp;&nbsp;",I+='<input type=radio  name="param" id="'+this.getDomId("params-group-select")+'"> group:&nbsp;'+HtmlUtils.div(["id",this.getDomId("params-group-label"),"style","border-bottom:1px #ccc dotted;min-width:10em;display:inline-block;"],""),I+="</form>",this.getProperty("showSearch",!0)){var S=HtmlUtils.div(["style","display:inline-block;","id",this.getDomId(n)],""),v=HtmlUtils.div(["style","display:inline-block;","id",this.getDomId(h)]),x=HtmlUtils.div(["id",this.getDomId(d),"class","ramadda-xls-search-form"]),U="";if(U+=HtmlUtils.openTag("form",["action","#","id",this.getDomId(p)]),U+=HtmlUtils.image(icon_tree_closed,["id",this.getDomId("search_open")]),U+="\n",U+=HtmlUtils.input(g,this.jq(g).val(),["size","60","id",this.getDomId(g),"placeholder","Search"]),U+="<input type=submit name='' style='display:none;'>",U+=HtmlUtils.openTag("div",["id",this.getDomId(r),"class","ramadda-xls-search-extra"],""),this.columns){var L=HtmlUtils.openTag("table",["class","formtable"]);for(b=0;b<this.columns.length;b++){s="table_"+(P=this.columns[b]).name;var E=HtmlUtils.input(s,this.jq(s).val(),["id",this.getDomId(s),"placeholder","Search"]);L+=HtmlUtils.formEntry(P.name.replace("_"," ")+":",E)}U+=L+=HtmlUtils.closeTag("table")}if(this.searchFields){for(L=HtmlUtils.openTag("table",["class","formtable"]),b=0;b<this.searchFields.length;b++){var P;s="table_"+(P=this.searchFields[b]).name,E=HtmlUtils.input(s,this.jq(s).val(),["id",this.getDomId(s),"placeholder","Search"]);L+=HtmlUtils.formEntry(P.label+":",E)}U+=L+=HtmlUtils.closeTag("table")}U+="\n",U+=HtmlUtils.closeTag("div"),U+="\n",U+=HtmlUtils.closeTag("form"),this.jq(o).html(HtmlUtils.leftRight(x,S+" "+v)),this.jq(d).html(U),this.extraOpen||this.jq(r).hide(),this.jq("search_open").button().click((function(t){e.jq(r).toggle(),e.extraOpen=!e.extraOpen,e.extraOpen?e.jq("search_open").attr("src",icon_tree_open):e.jq("search_open").attr("src",icon_tree_closed)}))}this.getProperty("showTable",!0)&&(this.jq(c).html(l),I+="<br>",this.getProperty("showChart",!0)&&this.jq(y).html(I)),this.getProperty("showSearch",!0)&&(this.jq(p).submit((function(t){t.preventDefault(),e.loadTableData(e.url,"Searching...")})),this.jq(g).focus(),this.jq(g).select());for(b=0;b<T.length;b++)this.addNewChartListener(m,T[b]);this.jq("removechart").button().click((function(t){e.clear()}));for(a=0;a<this.sheets.length;a++){s=this.getDomId("sheet_"+a);this.makeSheetButton(s,a)}a=0;var C=/sheet=([^&]+)/g.exec(window.location.search);if(C&&(a=C[1]),this.loadSheet(a),this.defaultCharts)for(b=0;b<this.defaultCharts.length;b++){var A=this.defaultCharts[b];this.makeChart(A.type,A)}this.setAxisLabel("params-yaxis-label",this.getHeading(this.yAxisIndex,!0)),this.displayDownloadUrl()},displayMessage:function(t,e){e||(e=icon_information);var i=HtmlUtils.hbox([HtmlUtils.image(e,["align","left"]),HtmlUtils.inset(t,10,10,5,10)]);i=HtmlUtils.div(["class","note"],i),this.jq(c).html(i)},displayDownloadUrl:function(){var t=this.lastUrl;if(null!=t){t=t.replace("xls_json","media_tabular_extractsheet"),t+="&execute=true";var e=HtmlUtils.image(ramaddaBaseUrl+"/icons/xls.png",["title","Download XLSX"]);this.jq(h).html(HtmlUtils.href(t,e))}else this.jq(h).html("")},loadTableData:function(t,e){this.url=t,e||(e=this.getLoadingMessage()),this.displayMessage(e,icon_progress);var i=this;if((r=this.jq(g).val())&&""!=r&&(t=t+"&table.text="+encodeURIComponent(r)),this.columns)for(var a=0;a<this.columns.length;a++){var s="table_"+(l=this.columns[a]).name;(r=this.jq(s).val())&&(t=t+"&table."+l.name+"="+encodeURIComponent(r))}if(this.searchFields)for(a=0;a<this.searchFields.length;a++){var l,r;s="table_"+(l=this.searchFields[a]).name;(r=this.jq(s).val())&&(t=t+"&table."+l.name+"="+encodeURIComponent(r))}this.lastUrl=t;!async function(){this.loadedJS||(await Utils.importJS(ramaddaBaseHtdocs+"/lib/jquery.handsontable.full.min.js"),await Utils.importCSS(ramaddaBaseHtdocs+"/lib/jquery.handsontable.full.min.css"),this.loadedJS=!0);$.getJSON(t,(function(t){if(GuiUtils.isJsonError(t))i.displayMessage("Error: "+t.error);else try{i.showTableData(t)}catch(t){i.displayMessage("Error: "+t),this.handleError("Error:"+t,t)}})).fail((function(t,e,a){var s=e+", "+a;i.displayMessage("An error occurred: "+a),console.log("JSON error:"+s)}))}()}})}
