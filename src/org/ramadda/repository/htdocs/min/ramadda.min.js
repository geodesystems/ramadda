var RamaddaUtils,RamaddaUtil,Ramadda=RamaddaUtils=RamaddaUtil={contents:{},currentRamaddaBase:null,fileDrops:{},initFormTags:function(t){let e=$("#"+t),i=e.find(".metadata-tag-input");e.attr("autocomplete","off"),i.attr("autocomplete","off"),i.keyup((function(t){HtmlUtils.hidePopupObject();let e=$(this).val();if(""==e)return;let i=HU.getUrl(ramaddaBaseUrl+"/metadata/suggest",["value",e.trim()]),n=$(this);$.getJSON(i,(t=>{if(0==t.length)return;let e="";t.forEach((t=>{e+=HU.div([CLASS,"ramadda-clickable metadata-suggest","suggest",t],t)}));let i=HU.div([CLASS,"ramadda-search-popup",STYLE,HU.css("max-width","200px","padding","4px")],e);HU.makeDialog({content:i,my:"left top",at:"left bottom",anchor:n}).find(".metadata-suggest").click((function(){HtmlUtils.hidePopupObject(),n.val($(this).attr("suggest"))}))})).fail((t=>{console.log("url failed:"+i+"\n"+t)}))}));let n=$("#"+t).find(".metadata-tag");n.attr("title","Click to remove"),n.click((function(){let t=e.find("#"+$(this).attr("metadata-id"));$(this).hasClass("metadata-tag-deleted")?($(this).removeClass("metadata-tag-deleted"),t.val("")):($(this).addClass("metadata-tag-deleted"),t.val("delete"))}))},initFormUpload:function(t,e){let i=$("#"+t),n=i.closest("form"),a=HU.div([TITLE,"Click to select a file",ID,t+"_filewrapper",CLASS,"fileinput_wrapper"],HU.getIconImage("fas fa-cloud-upload-alt")+" "+HU.div([ID,t+"_filename",CLASS,"fileinput_label"]));i.after(a),i.hide();let l=$("#"+t+"_filewrapper");$("#"+t+"_filename");l.click((()=>{i.trigger("click")}));let s=()=>{let e=i[0].files?i[0].files[0]:null,n=e?e.name:i.val(),a=n.lastIndexOf("\\");a<0&&(a=n.lastIndexOf("/")),a>=0&&(n=n.substring(a+1)),e&&(n=n+" ("+Utils.formatFileLength(e.size)+")"),""==n&&(n=HU.span([CLASS,"fileinput_label_empty"],"Please select a file")),$("#"+t+"_filename").html(n)};if(i.bind("change",s),s(),Utils.stringDefined(e)){let i=$("#"+e),a={files:{},cnt:0,added:!1};i.append(HU.div([CLASS,"ramadda-dnd-target-files",ID,t+"_dnd_files"]));let l=$("#"+t+"_dnd_files");Utils.initDragAndDrop(i,(t=>{}),(t=>{}),((e,i,s,o)=>{a.cnt++;let r=i.name;if(!r){let t=i.type&&i.type.match("image/.*");if(r=prompt("Entry file name:",t?"image":"file"),!r)return;if(i.type)if("text/plain"==i.type)r.endsWith(".txt")||(r+=".txt");else{r=r+"."+i.type.replace(/.*\//,"")}}let d=t+"_list"+a.cnt,c=t+"_file"+a.cnt,h=t+"_file_name"+a.cnt,m="upload_file_"+a.cnt,u="upload_name_"+a.cnt;a.files[c]=s;let p=HU.span([CLASS,"ramadda-clickable",ID,d+"_trash"],HU.getIconImage(icon_trash)),f=Utils.isDefined(i.size)?Utils.formatFileLength(i.size):"";l.append(HU.div([ID,d],p+" "+r+" "+f)),n.append(HU.tag("input",["type","hidden","name",m,"id",c])),n.append(HU.tag("input",["type","hidden","name",u,"id",h])),$("#"+c).val(s),$("#"+h).val(r),$("#"+d+"_trash").click((function(){$("#"+d).remove(),$("#"+c).remove(),$("#"+h).remove()}))}),null,!0)}},handleDropEvent:function(t,e,i,n,a){let l=e.type.match("^image.*"),s=ramaddaBaseUrl+"/entry/addfile",o=e.name;if(!o&&(o=prompt("Name:"),!o))return;let r=e.name,d=e.type.replace(/image\//,"");r||(r=o+"."+d);let c=new FormData;c.append("filename",r),c.append("filetype",e.type),c.append("group",n),c.append("description",""),c.append("file",i),$.ajax({url:s,cache:!1,contentType:!1,processData:!1,method:"POST",type:"POST",data:c,success:t=>{"ok"==t.status?a&&a(t,t.entryid,t.name,l):alert("An error occurred creating file:"+t.message)},error:function(t){alert("An error occurred creating file:"+t)}})},inherit:function(t,e){return $.extend(t,e),e.getThis=function(){return t},t.getThis=function(){return t},t.mysuper=e,t},initMembers:function(t,e){return $.extend(t,e),t},defineMembers:function(t,e){return $.extend(t,e),t},showEntryPopup:function(t,e,i){let n=RamaddaUtils.contents[e];if(n)RamaddaUtils.showEntryPopupInner(t,e,i,n);else{let n=ramaddaBaseUrl+"/entry/menu?entryid="+e;$.ajax({url:n,dataType:"text",success:function(n){RamaddaUtils.contents[e]=n,RamaddaUtils.showEntryPopupInner(t,e,i,n)}}).fail(((t,e,i)=>{console.log("/entry/menu failed:"+i)}))}},showEntryPopupInner:function(t,e,i,n){let a=$("#"+t);HU.makeDialog({content:n,my:"left top",at:"left bottom",title:i,anchor:a,draggable:!0,header:!0,inPlace:!1})},mouseOverOnEntry:function(t,e,i){if(Utils.mouseIsDown&&Utils.entryDragInfo){if(Utils.entryDragInfo.hasEntry(e))return;$("#"+i).css("borderBottom","2px black solid")}},mouseOutOnEntry:function(t,e,i){Utils.entryDragInfo&&Utils.entryDragInfo.entryId==e||$("#"+i).css("borderBottom","")},mouseDownOnEntry:function(t,e,i,n,a){t=GuiUtils.getEvent(t),Utils.entryDragInfo={dragSource:n,getIds:function(){return this.entryIds.join(",")},getHtml:function(){let t="";return this.entries.forEach((e=>{""!=t&&(t+="<br>"),t+=HU.image(e.args.icon)+SPACE+e.args.name})),t},hasEntry:function(t){return this.entryIds.includes(t)},addEntry:function(t){this.hasEntry(t.entryId)||(this.entries.push(t),this.entryIds.push(t.entryId))},entryIds:[],entries:[]};let l=Utils.globalEntryRows[e];if(l&&Utils.entryDragInfo.addEntry(l),$(".ramadda-entry-select:checked").each((function(){let t=$(this).attr("id"),e=Utils.globalEntryRows[t];e&&Utils.entryDragInfo.addEntry(e)})),Utils.mouseIsDown=!0,!t.preventDefault)return t.returnValue=!1,!1;t.preventDefault()},mouseUpOnEntry:function(t,e,i){Utils.entryDragInfo&&(Utils.entryDragInfo.hasEntry(e)||($("#"+i).css("borderBottom",""),Utils.entryDragInfo.hasEntry(e)||(url=ramaddaBaseUrl+"/entry/copy?action=action.move&from="+Utils.entryDragInfo.getIds()+"&to="+e,document.location=url)))},initEntryListForm:function(t){let e=Utils.entryGroups[t];e&&(e.on=0,e.setVisbility())},hideEntryPopup:function(){HtmlUtils.getTooltip().hide()},findEntryRow:function(t){let e;for(e=0;e<Utils.groupList.length;e++){let i=Utils.groupList[e].findEntryRow(t);if(i)return i}return null},entryRowOver:function(t){let e=Ramadda.findEntryRow(t);e&&e.mouseOver()},entryRowOut:function(t){let e=Ramadda.findEntryRow(t);e&&e.mouseOut()},entryRowClick:function(t,e){let i=Ramadda.findEntryRow(e);i&&i.mouseClick(t)},originalImages:new Array,changeImages:new Array,folderClick:function(t,e,i){Ramadda.changeImages[t]=i;let n=$("#"+t);if(0==n.length)return;let a=$("#img_"+t);"none"!=n.css("display")?(i&&a.html(HU.getIconImage("fa-caret-right")),n.hide()):(Ramadda.originalImages[t]=a.html(),n.show(),a.html(HU.getIconImage("fa-caret-down")),(e+="&orderby=entryorder&ascending=true").startsWith("/")&&Ramadda.currentRamaddaBase&&(e=Ramadda.currentRamaddaBase+e),GuiUtils.loadXML(e,Ramadda.handleFolderList,t))},handleFolderList:function(request,uid){if(null!=request.responseXML){let xmlDoc=request.responseXML.documentElement,script,html;for(i=0;i<xmlDoc.childNodes.length;i++){let t=xmlDoc.childNodes[i];"javascript"==t.tagName?script=getChildText(t):"content"==t.tagName&&(html=getChildText(t))}html||(html=getChildText(xmlDoc)),html&&($("#"+uid).html("<div>"+html+"</div>"),Utils.checkTabs(html)),script&&eval(script)}Ramadda.changeImages[uid]?$("#img_"+uid).attr("src",icon_folderopen):$("#img_"+uid).attr("src",Ramadda.originalImages[uid])},Components:{init:function(t){let e=$("#"+t),i=$("#"+t+"_header");i.css("text-align","center");let n=HU.div([STYLE,HU.css("display","inline-block"),CLASS,"ramadda-button ramadda-button-bar ramadda-button-on","layout","grid",ID,t+"_button_grid"],"Grid")+HU.div([STYLE,HU.css("display","inline-block"),CLASS,"ramadda-button ramadda-button-bar","layout","date",ID,t+"_button_date"],"Date")+HU.div([STYLE,HU.css("display","inline-block"),CLASS,"ramadda-button ramadda-button-bar","layout","title",ID,t+"_button_title"],"Title")+HU.div([STYLE,HU.css("display","inline-block"),CLASS,"ramadda-button ramadda-button-bar","layout","tag",ID,t+"_button_tag"],"Tag")+HU.div([STYLE,HU.css("display","inline-block"),CLASS,"ramadda-button ramadda-button-bar","layout","author",ID,t+"_button_author"],"Author");i.append(HU.div([],n));let a=e.find(".ramadda-component");a.each((function(){let t=$(this).attr("component-date");if(!t)return;let e=Utils.parseDate(t);$(this).attr("component-day",Utils.formatDateWithFormat(e,"mmmm dd yyyy")),$(this).attr("component-month",Utils.formatDateWithFormat(e,"mmmm yyyy")),$(this).attr("component-year",Utils.formatDateWithFormat(e,"yyyy"))}));let l=i.find(".ramadda-button");l.click((function(){l.removeClass("ramadda-button-on"),$(this).addClass("ramadda-button-on");let t=$(this).attr("layout");"grid"==t?Ramadda.Components.layout(e,a,null):"title"==t?Ramadda.Components.layout(e,a,"component-title"):"date"==t?Ramadda.Components.layout(e,a,"component-month"):"tag"==t?Ramadda.Components.layout(e,a,"component-tags"):"author"==t&&Ramadda.Components.layout(e,a,"component-author")}))},layout:function(t,e,i){if(t.find(".ramadda-group").each((function(){$(this).detach()})),null!=i){let n="component-month"==i,a=[],l={};e.each((function(){let t=$(this).attr(i)||"";if("component-tag"==i){let e=t.split(",");t=e[0]}if(!l[t]){l[t]=[];if(n){let e=$(this).attr("component-date"),i=e?Utils.parseDate(e):null;a.push([t,i])}else a.push(t)}l[t].push($(this))})),a=n?a.sort(((t,e)=>(t=t[1],e=e[1],t&&e?t?e?t.getTime()-e.getTime():-1:1:0))):a.sort(),a.forEach((e=>{n&&(e=e[0]);let i=t.append($(HU.div([CLASS,"ramadda-group"],HU.div([CLASS,"ramadda-group-header"],e))));l[e].forEach((t=>{i.append(t)}))}))}else e.each((function(){$(this).detach(),t.append($(this))}))}}};function EntryFormList(t,e,n,a){this.entryRows=new Array,this.lastEntryRowClicked=null,Utils.entryGroups[t]=this,Utils.groupList.push(this),this.formId=t,this.toggleImg=e,this.on=a,this.entries=new Array,this.groupAddEntry=function(t){this.entries[this.entries.length]=t},this.addEntryRow=function(t){this.groupAddEntry(t.cbxWrapperId),this.entryRows[this.entryRows.length]=t,this.on?t.getCbx().show():t.getCbx().hide()},this.groupAddEntry(n),this.on||hideObject(n),this.groupToggleVisibility=function(){this.on=!this.on,HU.addToDocumentUrl(this.formId+"_visible",this.on),this.setVisibility()},this.findEntryRow=function(t){let e;for(e=0;e<this.entryRows.length;e++)if(this.entryRows[e].rowId==t)return this.entryRows[e];return null},this.checkboxClicked=function(t,e){if(!t)return;let n;for(i=0;i<this.entryRows.length;i++)if(this.entryRows[i].cbxId==e){n=this.entryRows[i];break}if(!n)return;let a=n.isSelected();if(t.ctrlKey)for(i=0;i<this.entryRows.length;i++)this.entryRows[i].setCheckbox(a);if(t.shiftKey){if(this.lastEntryRowClicked){let t=this.lastEntryRowClicked.getCbx().offset().top,e=n.getCbx().offset().top;if(t>e){let i=t;t=e,e=i}for(i=0;i<this.entryRows.length;i++){let n=this.entryRows[i].getCbx().offset().top;n>=t&&n<=e&&this.entryRows[i].setCheckbox(a)}}}else this.lastEntryRowClicked=n},this.setVisibility=function(){this.toggleImg&&(this.on?$("#"+this.toggleImg).html(HU.getIconImage("fas fa-caret-down")):$("#"+this.toggleImg).html(HU.getIconImage("fas fa-caret-right")));let t=$("#"+this.formId);for(this.on?t.find(":checkbox").show():t.find(":checkbox").hide(),i=0;i<this.entries.length;i++)obj=GuiUtils.getDomObject(this.entries[i]),obj&&(this.on?showObject(obj,"block"):hideObject(obj))};let l=HU.getUrlArgument(this.formId+"_visible");null!==l&&(this.on="true"==l,this.setVisibility())}function EntryRow(t,e,i,n,a,l){l||(l={showIcon:!0}),this.args=l,l.entryId=t,Utils.globalEntryRows[t]=this,Utils.globalEntryRows[e]=this,Utils.globalEntryRows[i]=this,this.entryId=t,this.showIcon=l.showIcon,this.onColor="#FFFFCC",this.overColor="#f4f4f4",this.rowId=e,this.cbxId=i,this.cbxWrapperId=n,this.showDetails=a,this.getRow=function(){return $("#"+this.rowId)},this.getCbx=function(){return $("#"+this.cbxId)};let s=this.getCbx().closest("form");if(s.length){let t=Utils.entryGroups[s.attr("id")];t&&t.addEntryRow(this)}else this.getCbx().hide();this.setCheckbox=function(t){this.getCbx().prop("checked",t),this.setRowColor()},this.isSelected=function(){return this.getCbx().is(":checked")},this.setRowColor=function(){this.getRow().removeClass("entry-row-hover"),this.isSelected()?this.getRow().addClass("entry-list-row-selected"):this.getRow().removeClass("entry-list-row-selected")},this.mouseOver=function(t){$("#entrymenuarrow_"+e).attr("src",icon_menuarrow),this.getRow().addClass("entry-row-hover")},this.mouseOut=function(t){$("#entrymenuarrow_"+e).attr("src",icon_blank),this.setRowColor()},this.mouseClick=function(e){eventX=GuiUtils.getEventX(e);let i=this.getRow().offset();if(eventX-i.left<150)return;this.lastClick=eventX;let n=ramaddaBaseUrl+"/entry/show?entryid="+t+"&output=metadataxml";this.showDetails?n+="&details=true":n+="&details=false",this.showIcon?n+="&showIcon=true":n+="&showIcon=false",GuiUtils.loadXML(n,this.handleTooltip,this)},this.handleTooltip=function(t,e){let i=t.responseXML.documentElement;text=getChildText(i);let n=e.getRow().offset().left,a=(e.lastClick,HU.jsLink("",HU.getIconImage(icon_close),["onmousedown","RamaddaUtil.hideEntryPopup();","id","tooltipclose"])),l=HU.image(e.args.icon)+SPACE+e.args.name,s=HU.div([CLASS,"ramadda-popup-header"],a+SPACE2+l),o=HU.div([CLASS,"ramadda-popup",STYLE,"display:block;"],s+"<table>"+text+"</table>"),r=HtmlUtils.getTooltip();r.html(o),r.draggable(),Utils.checkTabs(text);let d=e.getRow().offset(),c=(e.getRow().outerWidth(),e.getRow().outerHeight()),h=HtmlUtils.getTooltip().outerWidth(),m=$(window).width(),u=e.lastClick;e.lastClick+h>m&&(u-=e.lastClick+h-m);let p=u+"px",f=3+d.top+c+"px";r.css({position:"absolute",zIndex:5e3,left:p,top:f}),r.show()}}let selectors=new Array;function Selector(t,e,i,n,a,l,s,o){this.id=e,this.elementId=i,this.localeId=l,this.entryType=s,this.allEntries=n,this.selecttype=a,this.textComp=GuiUtils.getDomObject(this.elementId),this.ramaddaUrl=o||ramaddaBaseUrl,this.getTextComponent=function(){let t="#"+this.elementId;return $(t)},this.getHiddenComponent=function(){let t="#"+this.elementId+"_hidden";return $(t)},this.clearInput=function(){this.getHiddenComponent().val(""),this.getTextComponent().val("")},this.handleClick=function(t){let e=this.id+"_selectlink",i=null;t.target&&(i=$(t.target)),null==i&&(i=$("#"+e)),0==i.length&&(i=$("#"+this.id)),HtmlUtils.hidePopupObject(t),this.div=GuiUtils.getDomObject("ramadda-selectdiv");let n=$("#ramadda-selectdiv");n.show(),n.position({of:i,my:"left top",at:"left bottom",collision:"none none"});let a="/entry/show?output=selectxml&selecttype="+this.selecttype+"&allentries="+this.allEntries+"&target="+this.id+"&noredirect=true&firstclick=true";if(this.ramaddaUrl&&!this.ramaddaUrl.startsWith("/")){let t=new URL(this.ramaddaUrl).pathname,e=this.ramaddaUrl.replace(t,"");Ramadda.currentRamaddaBase=e,a=this.ramaddaUrl+a}else Ramadda.currentRamaddaBase=null,a=ramaddaBaseUrl+a;return this.localeId&&(a=a+"&localeid="+this.localeId),this.entryType&&(a=a+"&entrytype="+this.entryType),GuiUtils.loadXML(a,handleSelect,this.id),!1},this.handleClick(t)}let EntryTree={initSelectAll:function(){$("#selectall").click((function(t){let e=$(this).is(":checked");$(".ramadda-entry-select").each((function(){let t=Utils.globalEntryRows[$(this).attr("id")];t&&t.setCheckbox(e)}))}))},entryRowCheckboxClicked:function(t,e){let i=GuiUtils.getDomObject(e);if(!i)return;if(i=i.obj,!i.form)return;let n=Utils.entryGroups[i.form.id];n&&n.checkboxClicked(t,e)}};function selectClick(t,e,i,n){selector=selectors[t];let a=getHandler(t);if(a||(a=getHandler(selector.elementId)),a)return a.selectClick(selector.selecttype,t,e,i),selectCancel(),void console.log("no handler");if("wikilink"==selector.selecttype){let t={entryId:e,name:i};n&&$.extend(t,n),insertAtCursor(selector.elementId,selector.textComp.obj,t)}else if("fieldname"==selector.selecttype)insertAtCursor(selector.elementId,selector.textComp.obj,i);else if("image"==selector.selecttype)insertAtCursor(selector.elementId,selector.textComp.obj,'{{image entry="'+e+'" caption="'+i+'" width=400px align=center}} ');else if("entryid"==selector.selecttype){let t=HU.getWikiEditor(selector.elementId);t?t.insertTags(e," ","importtype"):insertText(selector.elementId,e)}else"entry:entryid"==selector.selecttype?HU.getWikiEditor(selector.elementId).insertTags("entry:"+e," ","importtype"):(selector.getHiddenComponent().val(e),selector.getTextComponent().val(i));selectCancel()}function selectCancel(t){!t&&$("#ramadda-selectdiv-pin").attr("data-pinned")||$("#ramadda-selectdiv").hide()}function selectCreate(t,e,i,n,a,l,s,o){let r=e+(o||"");selectors[r]?selectors[r].handleClick(t):selectors[e]=selectors[r]=new Selector(t,e,i,n,a,l,s,o)}function selectInitialClick(t,e,i,n,a,l,s,o){return selectCreate(t,e,i,n,a,l,s,o),!1}function clearSelect(t){if(selector=selectors[t],selector)selector.clearInput();else{let e=GuiUtils.getDomObject(t),i=GuiUtils.getDomObject(t+"_hidden");i&&(i.obj.value=""),e&&(e.obj.value="")}}function handleSelect(request,id){selector=selectors[id];let xmlDoc=request.responseXML.documentElement;text=getChildText(xmlDoc);let pinId=selector.div.id+"-pin",pin=HU.jsLink("",HtmlUtils.getIconImage(icon_pin),["class","ramadda-popup-pin","id",pinId]),closeImage=HtmlUtils.getIconImage(icon_close,[]),close='<a href="javascript:selectCancel(true);">'+closeImage+"</a>",header=HtmlUtils.div(["style","text-align:left;","class","ramadda-popup-header"],SPACE+close+SPACE+pin),popup=HtmlUtils.div(["id",id+"-popup"],header+text);selector.div.obj.innerHTML=popup,$("#"+selector.div.id).draggable(),$("#"+pinId).click((function(){$(this).attr("data-pinned")?($(this).removeClass("ramadda-popup-pin-pinned"),$(this).attr("data-pinned",!1)):($(this).addClass("ramadda-popup-pin-pinned"),$(this).attr("data-pinned",!0))}));let arr=selector.div.obj.getElementsByTagName("script");for(let n=0;n<arr.length;n++)eval(arr[n].innerHTML)}function getChildText(t){let e="";for(childIdx=0;childIdx<t.childNodes.length;childIdx++)e+=t.childNodes[childIdx].nodeValue;return e}function toggleBlockVisibility(t,e,i,n){toggleVisibility(t,"block")?HU.isFontAwesome(i)?$("#"+e).html(HU.makeToggleImage(i)):$("#"+e).attr("src",i):HU.isFontAwesome(i)?$("#"+e).html(HU.makeToggleImage(n)):$("#"+e).attr("src",n),Utils.ramaddaUpdateMaps()}function toggleInlineVisibility(t,e,i,n){let a,l=GuiUtils.getDomObject(e);a=toggleVisibility(t,"inline")?i:n,StringUtil.startsWith(a,"fa-")?$("#"+e).html(HtmlUtils.getIconImage(a,[])):l&&(l.obj.src=a),Utils.ramaddaUpdateMaps()}function toggleVisibility(t,e){let i=$("#"+t).css("display");return $("#"+t).toggle(),"block"!=i}function hide(t){$("#"+t).hide()}function hideObject(t){return t?($("#"+t.id).hide(),1):0}function showObject(t,e){if(!t)return 0;$("#"+t.id).show()}function toggleVisibilityOnObject(t,e){if(!t)return 0;$("#"+t.id).toggle()}
