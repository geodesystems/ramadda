var RamaddaUtils,RamaddaUtil,Ramadda=RamaddaUtils=RamaddaUtil={contents:{},currentRamaddaBase:null,getEntryUrl:function(t){return ramaddaBaseUrl+"/entry/show?entryid="+t},fileDrops:{},doSave:function(t,e,a,i,r){(a=a||{}).entryid=t,a.authtoken=e,a.response="json";let n=ramaddaBaseUrl+"/entry/change";$.post(n,a,(t=>{i&&i(t)})).fail((t=>{try{let e=JSON.parse(t.responseText);if(e.error)return void(t?t(e.error):alert("Error:"+e.error))}catch(t){}r?r(t.responseText):alert("Error:"+t.responseText)}))},initEntryTable:function(t,e,a){let i={};Utils.isDefined(e.details)&&0==e.details&&(e.simple=!0);let r=e.simple,n=!r,l={actions:[],showCrumbs:!1,showHeader:n,showDate:n,showCreateDate:n,showSize:n,showType:n,showIcon:n,showThumbnails:n,showArrow:n,showForm:n};$.extend(l,e);let s=a.map(((t,e)=>{let a=new Entry(t);return i[a.getId()]=a,a})),o="",d=[];if(d.push({id:"name",label:"Name"}),l.showDate&&d.push({id:"fromdate",label:"Date",width:120}),l.showCreateDate&&d.push({id:"createdate",label:"Create Date",width:120}),l.showSize&&d.push({id:"size",label:"Size",width:100}),l.showType&&d.push({id:"type",label:"Type",width:120}),l.showHeader){o+="<table cellspacing=0 cellpadding=0 width=100% class=entry-list-header><tr>";let e=["class","entry-list-header-column ramadda-clickable"];d.forEach(((a,i)=>{let r=e,n=a.width;0==i&&l.showForm&&(o+=HU.td(["style","padding-left:3px;","width","10"],HU.div(["style","width:15px","id",t+"_formarrow","title","Click to show entry form","class","ramadda-clickable"],HU.getIconImage("fas fa-caret-right"))),n-=10),Utils.isDefined(a.width)&&(r=Utils.mergeLists(r,["width",a.width])),r=Utils.mergeLists(r,["orderby",a.id,"title","Sort by "+a.label]);let s=a.label;a.id==l.orderby&&Utils.isDefined(l.ascending)&&(s=l.ascending?HU.getIconImage("fas fa-arrow-up")+SPACE+s:HU.getIconImage("fas fa-arrow-down")+SPACE+s),o+=HU.td(r,s)})),o+="</table>"}else r||(o+=HU.div(["class","entry-list-noheader"]));let c=Utils.getUniqueId(),m=Utils.getUniqueId(),h=r?"entry-list-simple":"entry-list";if(o+=HU.open("div",["id",c,"class",h]),l.showForm){o+=HU.open("form",["method","post","action",ramaddaBaseUrl+"/entry/getentries"]);let e=HU.checkbox("",["style",HU.css("margin-left","3px"),"title","Toggle all","id",t+"_form_cbx"],!1),a=[["","Apply action"]];l.actions.forEach((t=>{a.push([t.id,t.label])})),e+=SPACE1,e+=HU.select("",["name","output","id",t+"_form_action"],a),e+=SPACE1,e+=HU.open("input",["name","getselected","type","submit","value","Selected","class","submit ui-button ui-corner-all ui-widget","id","getselected1338","role","button"]),e+=HU.open("input",["name","getall","type","submit","value","All","class","submit ui-button ui-corner-all ui-widget","id","getall1337","role","button"]),l.canDelete&&(e+=SPACE1+HU.span(["target-type","repository.delete","title","Shift-drag-and-drop entries to delete","class","ramadda-entry-target ramadda-clickable ramadda-hoverable"],HU.getIconImage("fas fa-trash"))),l.canExport&&(e+=SPACE1+HU.span(["target-type","zip.export","title","Shift-drag-and-drop entries to export","class","ramadda-entry-target ramadda-clickable ramadda-hoverable"],HU.getIconImage("fas fa-file-export"))),o+=HU.div(["class",h+"-row","id",t+"_form","style","display:none;width:100%"],e)}o+=HU.open("div",["id",m]),o+="</div>",o+="</form>",o+="</div>";let p=jqid(t);p.html(o),p.find(".entry-list-header-column").click((function(){let t,e=$(this).attr("orderby");l.orderby==e?Utils.isDefined(l.ascending)?l.ascending?t=HU.addToDocumentUrl("ascending",!1):(t=HU.addToDocumentUrl("ascending",null),t=HU.addToDocumentUrl("orderby",null)):(t=HU.addToDocumentUrl("orderby",e),t=HU.addToDocumentUrl("ascending",!0)):(t=HU.addToDocumentUrl("ascending",!0),t=HU.addToDocumentUrl("orderby",e)),window.location=t})),HU.initSelect($("#"+t+"_form_action")),Ramadda.initDragAndDropEntries(p.find(".ramadda-entry-target"),i);let u=!1;$("#"+t+"_form_cbx").click((function(){let e=$(this).is(":checked");jqid(t).find(".entry-form-select").prop("checked",e)}));$("#"+t+"_formarrow").click((function(){u=!u,u?(jqid(t+"_form").show(),jqid(t).find(".entry-form-select").show(),$(this).html(HU.getIconImage("fas fa-caret-down"))):(jqid(t+"_form").hide(),jqid(t).find(".entry-form-select").hide(),$(this).html(HU.getIconImage("fas fa-caret-right")))})),Ramadda.showEntryTable(m,l,d,t,i,(t=>{u&&jqid(t).find(".entry-form-select").show()}),s)},showEntryTable:function(t,e,a,i,r,n,l){let s=$("#"+i),o="",d=e.simple?"entry-list-simple-row":"entry-list-row";if(l.forEach((t=>{let i=Utils.getUniqueId("row_"),r=HU.open("div",["entryid",t.getId(),"id",i]);r+=HU.open("div",["entryid",t.getId(),"id",i,"class",d]);let n=Utils.getUniqueId();r+=HU.open("table",["cellspacing","0","cellpadding","border","width","100%","class","entry-row-table","entryid",t.getId()]),r+="<tr valign=top>",a.forEach(((l,s)=>{let o=s==a.length-1,d=[],c=t.getProperty(l.id),m=null;if("name"==l.id){e.showIcon&&(c=t.getIconImage()+SPACE+c),c=t.getLink(c);let a=[],r=Utils.getUniqueId("entry_");if(e.showForm&&a.push(HU.hidden("allentry",t.getId())+HU.checkbox(r,["rowid",i,"name","selentry","value",t.getId(),"class","entry-form-select","style",HU.css("margin-right","2px","display","none")],!1)),a.push(HU.div(["style",HU.css("min-width","10px"),"innerid",n,"entryid",t.getId(),"title","Click to show contents","class","entry-arrow ramadda-clickable"],HU.getIconImage("fas fa-caret-right"))),e.showThumbnails){let e=t.getThumbnail();e&&a.push(HU.div(["class","ramadda-thumbnail","style",HU.css("max-height","100px","overflow-y","auto")],HU.image(e,["loading","lazy","class","ramadda-clickable ramadda-thumbnail-image","title","Click to enlarge","style",HU.css("width","100px")])))}if(e.showCrumbs&&t.breadcrumbs){let e=Utils.getUniqueId();c=HU.span(["id","breadcrumbtoggle_"+e,"breadcrumbid",e,"title","Show breadcrumbs","class","ramadda-clickable ramadda-breadcrumb-toggle"],HU.getIconImage("fas fa-plus-square"))+SPACE2+HU.span(["style",HU.css("display","none"),"id",e],t.breadcrumbs+"&nbsp;&raquo;&nbsp;")+c}a.push(c),e.simple||(m="Right-click to see entry menu. Shift-drag to copy/move"),c=HU.table([],HU.tr(["valign","top"],HU.tds([],a)))}else{"type"==l.id&&(c=HU.href(ramaddaBaseUrl+"/search/type/"+t.getType().id,c,["title","Search for entries of type "+c]));let e=l.width-20;e=l.width,c=HU.div(["style",HU.css("padding-left","5px","white-space","nowrap","width",HU.getDimension(l.width),"text-align","right","max-width",HU.getDimension(e),"overflow-x","hidden")+(o?HU.css("padding-right","4px"):"")],c),d.push("align","right")}Utils.isDefined(l.width)&&d.push("width",HU.getDimension(l.width)),m&&d.push("title",m),r+=HU.td(d,c)})),r+="</tr></table>",r+="</div>",r+=HU.div(["id",n,"style",HU.css("margin-left","20px")]),r+="</div>",o+=r})),o+=HU.close("div"),$("#"+t).html(o),$("#"+t).find(".ramadda-breadcrumb-toggle").click((function(){let t=$(this).attr("breadcrumbid"),e=$("#"+t);"none"==e.css("display")?($("#breadcrumbtoggle_"+t).html(HU.getIconImage("fas fa-minus-square")),e.css("display","inline")):($("#breadcrumbtoggle_"+t).html(HU.getIconImage("fas fa-plus-square")),e.css("display","none"))})),$("#"+t).find(".entry-arrow").click((function(){let t=$(this).attr("entryid"),l=$(this).attr("innerid"),s=$("#"+l),o=$(this).attr("filled"),d=$(this).attr("open");if(d?$(this).html(HU.getIconImage("fas fa-caret-right")):$(this).html(HU.getIconImage("fas fa-caret-down")),o)return void(d?(s.hide(),$(this).attr("open",!1)):(s.show(),$(this).attr("open",!0)));let c=r[t];$(this).attr("filled",!0),$(this).attr("open",!0);let m=ramaddaBaseUrl+"/entry/show?output=json&includeproperties=false&includedescription=false&includeservices=false&children=true&entryid="+t;$.getJSON(m,(function(t,s,o){if(GuiUtils.isJsonError(t))return;let d=t.map(((t,e)=>{let a=new Entry(t);return r[a.getId()]=a,a}));if(d.length>0)Ramadda.showEntryTable(l,e,a,i,r,n,d);else{let t=HU.open("table",["class","formtable"]);if(c.getIsUrl())t+=HU.formEntry("URL:",HU.href(c.getResourceUrl(),c.getResourceUrl()));else if(c.getIsFile()){let e=c.getResourceUrl();t+=HU.formEntry("File:",HU.href(e,c.getFilename())+"  ("+c.getFormattedFilesize()+") "+HU.href(e,HU.getIconImage("fas fa-download")))}t+=HU.formEntry("Kind:",HU.href(ramaddaBaseUrl+"/search/type/"+c.getType().id,c.typeName,["title","Search for entries of type "+c.typeName]));let e=ramaddaBaseUrl+"/search/type/"+c.getType().id+"?user_id="+c.creator+"&search.submit=true",a=HU.href(e,c.creator,["title","Search for entries of this type created by "+c.creator]);t+=HU.formEntry("Created by:",a),t+=HU.formEntry("Created:",c.createDateFormat),c.startDate&&c.startDate.getTime()!=c.createDate.getTime()&&(t+=HU.formEntry("Date:",c.startDateFormat)),c.startDate&&c.endDate&&c.startDate.getTime()!=c.endDate.getTime()&&(console.log(c.startDate),console.log(c.endDate),t+=HU.formEntry("To Date:",c.endDateFormat)),t+="</table>",HU.jqid(l).html(t)}}))})),e.simple)return;$("#"+t).find(".entry-form-select").click((function(t){$(this).is(":checked"),$("#"+$(this).attr("rowid"));HU.checkboxClicked(t,"entry_",$(this).attr("id")),s.find(".entry-form-select").each((function(){let t=$(this).is(":checked"),e=$("#"+$(this).attr("rowid"));t?e.addClass("entry-list-row-selected"):e.removeClass("entry-list-row-selected")}))})),$("#"+t).find(".ramadda-thumbnail-image").click((function(){let t=$(this).attr("src");HU.makeDialog({content:HU.image(t),my:"left top",at:"left bottom",anchor:this,header:!0,draggable:!0})}));let c=$("#"+t).find("."+d);c.bind("contextmenu",(function(t){let e=$(this),a=r[$(this).attr("entryid")];if(!a)return;eventX=GuiUtils.getEventX(t);let i=ramaddaBaseUrl+"/entry/show?entryid="+a.getId()+"&output=metadataxml";if(GuiUtils.loadXML(i,(function(t){let i=t.responseXML.documentElement;text=getChildText(i),HU.makeDialog({content:text,my:"left top",at:"left bottom",title:a.getIconImage()+" "+a.getName(),anchor:e,header:!0})}),this),!t.preventDefault)return t.returnValue=!1,!1;t.preventDefault()})),Ramadda.initDragAndDropEntries(c,r,i),n(t)},initDragAndDropEntries:function(t,e,a){function i(t){return t.hasClass("ramadda-entry-target")}t.mousedown((function(t){if(!t.shiftKey||!e)return;let i=e[$(this).attr("entryid")];if(!i)return;let r=$(this),n=[i];if($("#"+a).find(".entry-list-row-selected").each((function(){let t=e[$(this).attr("entryid")];t&&t.getId()!=i.getId()&&n.push(t)})),Utils.entryDragInfo={dragSource:r.attr("id"),entry:i,getIds:function(){return n.map((t=>t.getId())).join(",")},hasEntry:function(t){return n.includes(t)},getHtml:function(){let t="";return n.forEach((e=>{""!=t&&(t+="<br>"),t+=HU.image(e.getIconUrl())+SPACE+e.getName()})),t}},i){if(Utils.mouseIsDown=!0,!t.preventDefault)return t.returnValue=!1,!1;t.preventDefault()}})),t.mouseover((function(t){let a="#C6E2FF";if(i($(this)))return void(Utils.mouseIsDown&&Utils.entryDragInfo&&$(this).css("background",a));let r=e[$(this).attr("entryid")];if(r&&Utils.mouseIsDown&&Utils.entryDragInfo){if(Utils.entryDragInfo.hasEntry(r))return;$(this).css("background",a)}})),t.mouseout((function(t){if(Utils.entryDragInfo){if(i($(this)))return void $(this).css("background","");let t=e[$(this).attr("entryid")];if(Utils.entryDragInfo.entry==t)return;$(this).css("background","")}})),t.mouseup((function(t){if(!Utils.entryDragInfo)return;if($(this).css("background",""),i($(this))){let t=ramaddaBaseUrl+"/entry/getentries?output="+$(this).attr("target-type");return Utils.entryDragInfo.getIds().split(",").forEach((e=>{t+="&selentry="+e})),void(document.location=t)}let a=e[$(this).attr("entryid")];a&&(Utils.entryDragInfo.hasEntry(a)||Utils.entryDragInfo.hasEntry(a)||(url=ramaddaBaseUrl+"/entry/copy?action=action.move&from="+Utils.entryDragInfo.getIds()+"&to="+a.getId(),document.location=url))}))},initFormTags:function(t){let e=$("#"+t),a=e.find(".metadata-tag-input");e.attr("autocomplete","off"),a.attr("autocomplete","off"),a.keyup((function(t){HtmlUtils.hidePopupObject();let e=$(this).val();if(""==e)return;let a=HU.getUrl(ramaddaBaseUrl+"/metadata/suggest",["value",e.trim()]),i=$(this);$.getJSON(a,(t=>{if(0==t.length)return;let e="";t.forEach((t=>{e+=HU.div([CLASS,"ramadda-clickable metadata-suggest","suggest",t],t)}));let a=HU.div([CLASS,"ramadda-search-popup",STYLE,HU.css("max-width","200px","padding","4px")],e);HU.makeDialog({content:a,my:"left top",at:"left bottom",anchor:i}).find(".metadata-suggest").click((function(){HtmlUtils.hidePopupObject(),i.val($(this).attr("suggest"))}))})).fail((t=>{console.log("url failed:"+a+"\n"+t)}))}));let i=$("#"+t).find(".metadata-tag");i.attr("title","Click to remove"),i.click((function(){let t=e.find("#"+$(this).attr("metadata-id"));$(this).hasClass("metadata-tag-deleted")?($(this).removeClass("metadata-tag-deleted"),t.val("")):($(this).addClass("metadata-tag-deleted"),t.val("delete"))}))},initFormUpload:function(t,e){let a=$("#"+t),i=a.closest("form"),r=HU.div([TITLE,"Click to select a file",ID,t+"_filewrapper",CLASS,"fileinput_wrapper"],HU.getIconImage("fas fa-cloud-upload-alt")+" "+HU.div([ID,t+"_filename",CLASS,"fileinput_label"]));a.after(r),a.hide();let n=$("#"+t+"_filewrapper");$("#"+t+"_filename");n.click((()=>{a.trigger("click")}));let l=()=>{let e=a[0].files?a[0].files[0]:null,i=e?e.name:a.val(),r=i.lastIndexOf("\\");r<0&&(r=i.lastIndexOf("/")),r>=0&&(i=i.substring(r+1)),e&&(i=i+" ("+Utils.formatFileLength(e.size)+")"),""==i&&(i=HU.span([CLASS,"fileinput_label_empty"],"Please select a file")),$("#"+t+"_filename").html(i)};if(a.bind("change",l),l(),Utils.stringDefined(e)){let a=$("#"+e),r={files:{},cnt:0,added:!1};a.append(HU.div([CLASS,"ramadda-dnd-target-files",ID,t+"_dnd_files"]));let n=$("#"+t+"_dnd_files");Utils.initDragAndDrop(a,(t=>{}),(t=>{}),((e,a,l,s)=>{r.cnt++;let o=a.name;if(!o){let t=a.type&&a.type.match("image/.*");if(o=prompt("Entry file name:",t?"image":"file"),!o)return;if(a.type)if("text/plain"==a.type)o.endsWith(".txt")||(o+=".txt");else{o=o+"."+a.type.replace(/.*\//,"")}}let d=t+"_list"+r.cnt,c=t+"_file"+r.cnt,m=t+"_file_name"+r.cnt,h="upload_file_"+r.cnt,p="upload_name_"+r.cnt;r.files[c]=l;let u=HU.span([CLASS,"ramadda-clickable",ID,d+"_trash"],HU.getIconImage(icon_trash)),g=Utils.isDefined(a.size)?Utils.formatFileLength(a.size):"";n.append(HU.div([ID,d],u+" "+o+" "+g)),i.append(HU.tag("input",["type","hidden","name",h,"id",c])),i.append(HU.tag("input",["type","hidden","name",p,"id",m])),$("#"+c).val(l),$("#"+m).val(o),$("#"+d+"_trash").click((function(){$("#"+d).remove(),$("#"+c).remove(),$("#"+m).remove()}))}),null,!0)}},handleDropEvent:function(t,e,a,i,r){let n=e.type.match("^image.*"),l=ramaddaBaseUrl+"/entry/addfile",s=e.name;if(!s&&(s=prompt("Entry Name:"),!s))return;let o=e.name,d=e.type.replace(/image\//,"");o||(o=s+"."+d);let c,m=new FormData;m.append("filename",o),m.append("filetype",e.type),m.append("group",i),m.append("description",""),m.append("file",a),$.ajax({url:l,cache:!1,contentType:!1,processData:!1,method:"POST",type:"POST",data:m,success:t=>{c.remove(),"ok"==t.status?r&&r(t,t.entryid,t.name,n):alert("An error occurred creating entry: "+t.message)},error:function(t){c.remove(),alert("An error occurred creating entry: "+t)}});let h=HU.div(["style",HU.css("text-align","center","padding","5px")],"Creating entry<br>"+HU.image(ramaddaCdn+"/icons/mapprogress.gif",["width","50px"]));c=HU.makeDialog({content:h,anchor:$(document),my:"center top",at:"center top+100"})},inherit:function(t,e){return $.extend(t,e),e.getThis=function(){return t},t.getThis=function(){return t},t.mysuper=e,t},initMembers:function(t,e){return $.extend(t,e),t},defineMembers:function(t,e){return $.extend(t,e),t},showEntryPopup:function(t,e,a){let i=RamaddaUtils.contents[e];if(i)RamaddaUtils.showEntryPopupInner(t,e,a,i);else{let i=ramaddaBaseUrl+"/entry/menu?entryid="+e;$.ajax({url:i,dataType:"text",success:function(i){RamaddaUtils.contents[e]=i,RamaddaUtils.showEntryPopupInner(t,e,a,i)}}).fail(((t,e,a)=>{console.log("/entry/menu failed:"+a),alert("Failed to contact the server")}))}},showEntryPopupInner:function(t,e,a,i){let r=$("#"+t);HU.makeDialog({content:i,my:"left top",at:"left bottom",title:a,anchor:r,draggable:!0,header:!0,inPlace:!1})},initEntryListForm:function(t){let e=Utils.entryGroups[t];e&&(e.on=0,e.setVisbility())},hideEntryPopup:function(){HtmlUtils.getTooltip().hide()},originalImages:new Array,changeImages:new Array,folderClick:function(t,e,a){Ramadda.changeImages[t]=a;let i=$("#"+t);if(0==i.length)return;let r=$("#img_"+t);"none"!=i.css("display")?(a&&r.html(HU.getIconImage("fa-caret-right")),i.hide()):(Ramadda.originalImages[t]=r.html(),i.show(),r.html(HU.getIconImage("fa-caret-down")),(e+="&orderby=entryorder&ascending=true").startsWith("/")&&Ramadda.currentRamaddaBase&&(e=Ramadda.currentRamaddaBase+e),GuiUtils.loadXML(e,Ramadda.handleFolderList,t))},handleFolderList:function(request,uid){if(null!=request.responseXML){let xmlDoc=request.responseXML.documentElement,script,html;for(i=0;i<xmlDoc.childNodes.length;i++){let t=xmlDoc.childNodes[i];"javascript"==t.tagName?script=getChildText(t):"content"==t.tagName&&(html=getChildText(t))}html||(html=getChildText(xmlDoc)),html&&($("#"+uid).html("<div>"+html+"</div>"),Utils.checkTabs(html)),script&&eval(script)}Ramadda.changeImages[uid]?$("#img_"+uid).attr("src",icon_folderopen):$("#img_"+uid).attr("src",Ramadda.originalImages[uid])},Components:{init:function(t){let e=$("#"+t),a=$("#"+t+"_header"),i=!1,r=!1,n=e.find(".ramadda-component"),l={},s={},o={};n.each((function(){let t=$(this).attr("component-date");if(!t)return;let e,a=Utils.parseDate(t);$(this).attr("component-day",e=Utils.formatDateWithFormat(a,"mmmm d yyyy")),o[e]=!0,$(this).attr("component-month",e=Utils.formatDateWithFormat(a,"mmmm yyyy")),s[e]=!0,$(this).attr("component-year",e=Utils.formatDateWithFormat(a,"yyyy")),l[e]=!0,$(this).attr("component-latitude")&&(r=!0),Utils.stringDefined($(this).attr("component-tags"))&&(i=!0)})),a.css("text-align","center");let d=HU.div([STYLE,HU.css("display","inline-block"),CLASS,"ramadda-button ramadda-button-bar ramadda-button-on","layout","grid"],"Grid");Object.keys(l).length>1&&(d+=HU.div([STYLE,HU.css("display","inline-block"),CLASS,"ramadda-button ramadda-button-bar","layout","year"],"Year")),Object.keys(s).length>1&&(d+=HU.div([STYLE,HU.css("display","inline-block"),CLASS,"ramadda-button ramadda-button-bar","layout","month"],"Month")),Object.keys(o).length>1&&(d+=HU.div([STYLE,HU.css("display","inline-block"),CLASS,"ramadda-button ramadda-button-bar","layout","day"],"Day")),d+=HU.div([STYLE,HU.css("display","inline-block"),CLASS,"ramadda-button ramadda-button-bar","layout","title"],"Title"),i&&(d+=HU.div([STYLE,HU.css("display","inline-block"),CLASS,"ramadda-button ramadda-button-bar","layout","tags"],"Tag")),d+=HU.div([STYLE,HU.css("display","inline-block"),CLASS,"ramadda-button ramadda-button-bar","layout","author"],"Author"),r&&(d+=HU.div([STYLE,HU.css("display","inline-block"),CLASS,"ramadda-button ramadda-button-bar","layout","map"],"Map")),a.append(HU.div([],d));let c=a.find(".ramadda-button");c.click((function(){c.removeClass("ramadda-button-on"),$(this).addClass("ramadda-button-on");let t=$(this).attr("layout");"grid"==t?Ramadda.Components.layout(e,n,null):Ramadda.Components.layout(e,n,"component-"+t)}))},layout:function(t,e,a){if(t.find(".ramadda-group").each((function(){$(this).detach()})),t.mapId&&$("#"+t.mapId).detach(),t.ramaddaMap&&(ramaddaMapRemove(t.ramaddaMap),t.ramaddaMap=null),null==a)return e.show(),void e.each((function(){$(this).detach(),t.append($(this))}));if("component-map"==a){e.hide();let a=Utils.getUniqueId();t.mapId=a,t.append(HU.div([ID,a,STYLE,HU.css("width","100%","height","400px")]));let i=new RepositoryMap(a,{});t.ramaddaMap=i,i.initMap(!1),e.each((function(){let t=$(this).attr("component-url"),e=+$(this).attr("component-latitude"),a=+$(this).attr("component-longitude");if(!Utils.isNumber(e))return;let r=$(this).attr("component-image"),n=HU.center(HU.b($(this).attr("component-title")));r&&(n+=HU.image(r,[WIDTH,"300px"])),t&&(n=HU.href(t,n));let l=new MapUtils.createLonLat(a,e);i.addPoint("",l,{pointRadius:6,strokeWidth:1,strokeColor:"#000",fillColor:"blue"},n)})),i.centerOnMarkers()}else{e.show();let i="component-day"==a||"component-month"==a||"component-year"==a,r=[],n={};e.each((function(){let t=$(this).attr(a)||"";if("component-tags"==a){let e=t.split(",");t=e[0]}if(!n[t]){n[t]=[];if(i){let e=$(this).attr("component-date"),a=e?Utils.parseDate(e):null;r.push([t,a])}else r.push(t)}n[t].push($(this))})),r=i?r.sort(((t,e)=>(t=t[1],e=e[1],t&&e?t?e?e.getTime()-t.getTime():-1:1:0))):r.sort(),r.forEach((e=>{i&&(e=e[0]);let a=t.append($(HU.div([CLASS,"ramadda-group"],HU.div([CLASS,"ramadda-group-header"],e))));n[e].forEach((t=>{a.append(t)}))}))}}}};function EntryRow(t,e,a,i,r,n){n||(n={showIcon:!0}),this.args=n,n.entryId=t,Utils.globalEntryRows[t]=this,Utils.globalEntryRows[e]=this,Utils.globalEntryRows[a]=this,this.entryId=t,this.showIcon=n.showIcon,this.onColor="#FFFFCC",this.overColor="#f4f4f4",this.rowId=e,this.cbxId=a,this.cbxWrapperId=i,this.showDetails=r,this.getRow=function(){return $("#"+this.rowId)},this.getCbx=function(){return $("#"+this.cbxId)};let l=this.getCbx().closest("form");if(l.length){let t=Utils.entryGroups[l.attr("id")];t&&t.addEntryRow(this)}else this.getCbx().hide();this.setCheckbox=function(t){this.getCbx().prop("checked",t),this.setRowColor()},this.isSelected=function(){return this.getCbx().is(":checked")},this.setRowColor=function(){this.getRow().removeClass("entry-row-hover"),this.isSelected()?this.getRow().addClass("entry-list-row-selected"):this.getRow().removeClass("entry-list-row-selected")},this.mouseOver=function(t){$("#entrymenuarrow_"+e).attr("src",icon_menuarrow),this.getRow().addClass("entry-row-hover")},this.mouseOut=function(t){$("#entrymenuarrow_"+e).attr("src",icon_blank),this.setRowColor()},this.mouseClick=function(e){eventX=GuiUtils.getEventX(e);let a=this.getRow().offset();if(eventX-a.left<150)return;this.lastClick=eventX;let i=ramaddaBaseUrl+"/entry/show?entryid="+t+"&output=metadataxml";this.showDetails?i+="&details=true":i+="&details=false",this.showIcon?i+="&showIcon=true":i+="&showIcon=false",GuiUtils.loadXML(i,this.handleTooltip,this)},this.handleTooltip=function(t,e){let a=t.responseXML.documentElement;text=getChildText(a);let i=e.getRow().offset().left,r=(e.lastClick,HU.jsLink("",HU.getIconImage(icon_close),["onmousedown","RamaddaUtil.hideEntryPopup();","id","tooltipclose"])),n=HU.image(e.args.icon)+SPACE+e.args.name,l=HU.div([CLASS,"ramadda-popup-header"],r+SPACE2+n),s=HU.div([CLASS,"ramadda-popup",STYLE,"display:block;"],l+"<table>"+text+"</table>"),o=HtmlUtils.getTooltip();o.html(s),o.draggable(),Utils.checkTabs(text);let d=e.getRow().offset(),c=(e.getRow().outerWidth(),e.getRow().outerHeight()),m=HtmlUtils.getTooltip().outerWidth(),h=$(window).width(),p=e.lastClick;e.lastClick+m>h&&(p-=e.lastClick+m-h);let u=p+"px",g=3+d.top+c+"px";o.css({position:"absolute",zIndex:5e3,left:u,top:g}),o.show()}}var selectors=new Array;function Selector(t,e,a,i,r,n,l,s,o){this.id=e,this.props=o||{},this.elementId=a,this.localeId=n,this.entryType=l,this.allEntries=i,this.selecttype=r,this.textComp=GuiUtils.getDomObject(this.elementId),this.ramaddaUrl=s||ramaddaBaseUrl,this.getTextComponent=function(){let t="#"+this.elementId;return $(t)},this.getHiddenComponent=function(){let t="#"+this.elementId+"_hidden";return $(t)},this.clearInput=function(){this.getHiddenComponent().val(""),this.getTextComponent().val("")},this.handleClick=function(t){let e=null;if(this.props.eventSourceId&&(e=jqid(this.props.eventSourceId)),null!=e&&0!=e.length||t&&t.target&&(e=$(t.target)),null==e||0==e.length){let t=this.id+"_selectlink";e=jqid(t)}null!=e&&0!=e.length||(e=jqid(this.id)),HtmlUtils.hidePopupObject(t),this.div=GuiUtils.getDomObject("ramadda-selectdiv");let a=$("#ramadda-selectdiv");a.show(),a.position({of:e,my:"left top",at:"left bottom"});let i="/entry/show?output=selectxml&selecttype="+this.selecttype+"&allentries="+this.allEntries+"&target="+this.id+"&noredirect=true&firstclick=true";if(this.ramaddaUrl&&!this.ramaddaUrl.startsWith("/")){let t=new URL(this.ramaddaUrl).pathname,e=this.ramaddaUrl.replace(t,"");Ramadda.currentRamaddaBase=e,i=this.ramaddaUrl+i}else Ramadda.currentRamaddaBase=null,i=ramaddaBaseUrl+i;return this.localeId&&(i=i+"&localeid="+this.localeId),this.entryType&&(i=i+"&entrytype="+this.entryType),GuiUtils.loadXML(i,handleSelect,this.id),!1},this.handleClick(t)}function selectClick(t,e,a,i){selector=selectors[t];let r=getHandler(t);if(r||(r=getHandler(selector.elementId)),r)return r.selectClick(selector.selecttype,t,e,a),selectCancel(),void console.log("no handler");if("wikilink"==selector.selecttype){let t={entryId:e,name:a};i&&$.extend(t,i),insertAtCursor(selector.elementId,selector.textComp.obj,t)}else if("fieldname"==selector.selecttype)insertAtCursor(selector.elementId,selector.textComp.obj,a);else if("image"==selector.selecttype)insertAtCursor(selector.elementId,selector.textComp.obj,'{{image entry="'+e+'" caption="'+a+'" width=400px align=center}} ');else if("entryid"==selector.selecttype){let t=HU.getWikiEditor(selector.elementId);t?t.insertTags(e," ","importtype"):selector.props&&selector.props.callback?selector.props.callback(e,i):insertText(selector.elementId,e)}else"entry:entryid"==selector.selecttype?HU.getWikiEditor(selector.elementId).insertTags("entry:"+e," ","importtype"):(selector.getHiddenComponent().val(e),selector.getTextComponent().val(a));selectCancel()}function selectCancel(t){!t&&$("#ramadda-selectdiv-pin").attr("data-pinned")||$("#ramadda-selectdiv").hide()}function selectCreate(t,e,a,i,r,n,l,s,o){let d=e+(s||"");selectors[d]?selectors[d].handleClick(t):selectors[e]=selectors[d]=new Selector(t,e,a,i,r,n,l,s,o)}function selectInitialClick(t,e,a,i,r,n,l,s){return selectCreate(t,e,a,i,r,n,l,s),!1}function clearSelect(t){if(selector=selectors[t],selector)selector.clearInput();else{let e=GuiUtils.getDomObject(t),a=GuiUtils.getDomObject(t+"_hidden");a&&(a.obj.value=""),e&&(e.obj.value="")}}function handleSelect(request,id){selector=selectors[id];let xmlDoc=request.responseXML.documentElement;text=getChildText(xmlDoc);let pinId=selector.div.id+"-pin",pin=HU.jsLink("",HtmlUtils.getIconImage(icon_pin),["class","ramadda-popup-pin","id",pinId]),closeImage=HtmlUtils.getIconImage(icon_close,[]),close='<a href="javascript:selectCancel(true);">'+closeImage+"</a>",title=(selector.props?selector.props.title:"")??"",extra=(selector.props?selector.props.extra:"")??"";Utils.stringDefined(title)&&(title=HU.span(["style","margin-left:5px;"],title));let header=HtmlUtils.div(["style","text-align:left;","class","ramadda-popup-header"],SPACE+close+SPACE+pin+title),popup=HtmlUtils.div(["id",id+"-popup"],header+extra+text);selector.div.obj.innerHTML=popup,$("#"+selector.div.id).draggable(),$("#"+pinId).click((function(){$(this).attr("data-pinned")?($(this).removeClass("ramadda-popup-pin-pinned"),$(this).attr("data-pinned",!1)):($(this).addClass("ramadda-popup-pin-pinned"),$(this).attr("data-pinned",!0))}));let arr=selector.div.obj.getElementsByTagName("script");for(let n=0;n<arr.length;n++)eval(arr[n].innerHTML);selector.props&&selector.props.initCallback&&selector.props.initCallback()}function getChildText(t){let e="";for(childIdx=0;childIdx<t.childNodes.length;childIdx++)e+=t.childNodes[childIdx].nodeValue;return e}function toggleBlockVisibility(t,e,a,i){toggleVisibility(t,"block")?HU.isFontAwesome(a)?$("#"+e).html(HU.makeToggleImage(a)):$("#"+e).attr("src",a):HU.isFontAwesome(a)?$("#"+e).html(HU.makeToggleImage(i)):$("#"+e).attr("src",i),Utils.ramaddaUpdateMaps()}function toggleInlineVisibility(t,e,a,i){let r,n=GuiUtils.getDomObject(e);r=toggleVisibility(t,"inline")?a:i,StringUtil.startsWith(r,"fa-")?$("#"+e).html(HtmlUtils.getIconImage(r,[])):n&&(n.obj.src=r),Utils.ramaddaUpdateMaps()}function toggleVisibility(t,e){let a=$("#"+t).css("display");return $("#"+t).toggle(),"block"!=a}function hide(t){$("#"+t).hide()}function hideObject(t){return t?($("#"+t.id).hide(),1):0}function showObject(t,e){if(!t)return 0;$("#"+t.id).show()}function toggleVisibilityOnObject(t,e){if(!t)return 0;$("#"+t.id).toggle()}
