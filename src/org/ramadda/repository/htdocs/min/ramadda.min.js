var URL_ENTRY_SHOW="/entry/show",URL_ENTRY_GET="/entry/get",URL_SEARCH_DO="/search/do",URL_CHANGEFIELD="/entry/changefield",URL_PROXY="/proxy",RamaddaUtils,RamaddaUtil,Ramadda=RamaddaUtils=RamaddaUtil={entryListeners:[],addEntryListener:function(e){this.entryListeners.push(e)},handleEntrySelect:function(e,t){this.entryListeners.forEach((i=>{i(e,t)}))},contents:{},currentRamaddaBase:null,currentSelector:null,captureScreen:function(e){if(!confirm("Do you want to create a thumbnail image of the screen?"))return;let t=RamaddaUtil.getCdnUrl("/lib/html2canvas.min.js");Utils.importJS(t,(()=>{RamaddaUtil.hideEntryPopup();let t=document.body;html2canvas(t,{userCORS:!0,allowTaint:!0}).then((function(t){const i=document.createElement(TAG_CANVAS),a=i.getContext("2d");i.width=t.width+20,i.height=t.height+20,a.drawImage(t,0,0),a.fillStyle="white",a.fillRect(0,0,i.width,i.height),a.strokeStyle="#ccc",a.lineWidth=10,a.strokeRect(0,0,i.width,i.height),a.drawImage(t,10,10);let l=i.toDataURL("image/png"),s=new FormData;s.append("addthumbnail","true"),s.append("filename","screencapture.png"),s.append("file",l),s.append(ARG_ENTRYID,e);let r=RamaddaUtil.getUrl("/entry/addfile");$.ajax({url:r,cache:!1,contentType:!1,processData:!1,method:"POST",type:"POST",data:s,success:e=>{if("ok"!=e.status)return void alert("An error occurred creating entry: "+e.message);let t=e.message+HU.br()+HU.image(e.imageurl,[ATTR_WIDTH,HU.px(600)]);HU.makeDialog({content:t,my:POS_LEFT_TOP,at:POS_LEFT_TOP,title:"",anchor:$(TAG_BODY),draggable:!0,header:!0,inPlace:!1,stick:!0})},error:function(e){alert("An error occurred creating entry: "+e)}})}))}))},initToggleTable:function(container){let elements=$(container).find(HU.dotClass(CLASS_ENTRY_TABLE_ROW_TOGGLE));0==elements.length&&(elements=$(container).find("[data-url]")),elements.click((function(){let url=$(this).attr("data-url");if(!url)return;let title=$(this).attr("data-title")??"",entryId=$(this).attr("data-entryid"),handler=request=>{if(null==request.responseXML)return;let xmlDoc=request.responseXML.documentElement,script,html;for(i=0;i<xmlDoc.childNodes.length;i++){let e=xmlDoc.childNodes[i];"javascript"==e.tagName?script=getChildText(e):"content"==e.tagName&&(html=getChildText(e))}if(html||(html=getChildText(xmlDoc)),html){html=HU.div([ATTR_STYLE,HU.css(CSS_MARGIN,HU.px(5),CSS_MAX_HEIGHT,HU.px(300),CSS_OVERFLOW_Y,OVERFLOW_AUTO)],html),entryId&&(title=HU.href(RamaddaUtils.getEntryUrl(entryId),title));let e=HU.makeDialog({content:html,my:POS_LEFT_TOP,at:POS_LEFT_BOTTOM,title:title,anchor:this,draggable:!0,header:!0,inPlace:!1,sticky:!0});Utils.checkTabs(html)}script&&eval(script)};GuiUtils.loadXML(url,handler)}))},handleEntryCreated:function(e,t,i){if(!window.opener)return void console.log("RamaddaUtils.handleEntryCreated: no opener");let a=window.opener.document.getElementById(e),l=window.opener.document.getElementById(e+"_hidden");a&&l?(a.val?a.val(i):a.value=i,l.val?l.val(t):l.value=t,a.title&&setTimeout((()=>{alert("Entry ID has been set for "+a.title)}),1e3)):console.log("RamaddaUtils.handleEntryCreated: could not find entry widget:"+e)},selectInitialClick:function(e,t,i,a,l,s,r,n,o){return RamaddaUtils.currentSelector&&RamaddaUtils.currentSelector.cancel(),RamaddaUtils.currentSelector=RamaddaUtils.selectCreate(e,t,i,a,l,s,r,n,o),!1},selectCreate:function(e,t,i,a,l,s,r,n,o){let d=t+(n??"");return selectors[t]=selectors[d]=new Selector(e,t,i,a,l,s,r,n,o)},clearSelect:function(e){if(selector=selectors[e],selector)selector.clearInput();else{let t=GuiUtils.getDomObject(e),i=GuiUtils.getDomObject(e+"_hidden");i&&(i.obj.value=""),t&&(t.obj.value="")}},viewSelect:function(e){let t=GuiUtils.getDomObject(e+"_hidden");if(t){let e=t.obj.value;if(Utils.stringDefined(e)){let t=RamaddaUtils.getEntryUrl(e);window.open(t,"_blank")}}},selectorRamaddas:{},searchState:{},initEntryPopup:function(e,t,i,a,l){let s=l??{},r=t=>e+t,n=this.searchState,o=HU.input("","",[ATTR_ID,r("_input"),ATTR_CLASS,"input",ATTR_PLACEHOLDER,"Search",ATTR_STYLE,HU.css(CSS_WIDTH,HU.px(250))]);o+=SPACE+HU.span([ATTR_CLASS,CLASS_CLICKABLE,ATTR_TITLE,"Submit search",ATTR_ID,r("button")],HU.getIconImage("fas fa-magnifying-glass"));let d=!Utils.stringDefined(i);!d&&a&&(d=!0),d&&(o+=HU.div([ATTR_ID,r("types")]));let T=o+HU.div([ATTR_CLASS,"ramadda-select-search-results",ATTR_ID,e+"_results"]);if(jqid(e).html(T),d){let e=e=>{let t=[],i="",a=[],l={};e.forEach((e=>{e.getCategory()!=i&&(i=e.getCategory());let t=l[i];t||(a.push(i),l[i]=t=[]);let s={value:e.id,label:e.label,corpus:e.getSuperCategory()+" - "+e.getCategory()};t.push(s)})),a.forEach((e=>{t.push({category:e}),t=Utils.mergeLists(t,l[e])})),t.unshift({value:"",label:"Select entry type"});let s=r("types_select"),o=HU.select("",[ATTR_STYLE,HU.css(CSS_MAX_WIDTH,HU.px(250),CSS_MARGIN_TOP,HU.px(4)),ATTR_ID,s],t,n.selectedType);o=HU.vspace()+o,jqid(r("types")).html(o),HU.makeSelectTagPopup("#"+s,{after:!0,icon:!0,single:!0,showCategories:!0}),HU.initSelect("#"+s)},t=i??"",a=this.selectorRamaddas[t];a||(a=this.selectorRamaddas[t]=getGlobalRamadda(!0));let l=a.getEntryTypes(((t,i)=>{e(i)}),i);l&&e(l)}let c=jqid(r("_input")),h=()=>{let e=c.val()??"",a=HU.url(RamaddaUtil.getUrl(URL_SEARCH_DO),[ARG_ORDERBY,"createdate",ARG_ASCENDING,"false",ARG_TEXT,e,ARG_OUTPUT,"json"]),l=i;if(d){let e=jqid(r("types_select")).val();Utils.stringDefined(e)&&"any"!=e&&(l=e,n.selectedType=e)}Utils.stringDefined(l)&&(a=HU.url(a,[ARG_TYPE,l])),_.html(HU.getIconImage(icon_wait)+" Searching..."),_.show();let s={entryListChanged:function(e){let i=e.getEntries();if(0==i.length)return _.show(),void _.html("Nothing found");let a="";i.forEach(((e,t)=>{let i="Type: "+e.getTypeName()+HU.BR_ENTITY+"Parent: "+e.getParentName();a+=HU.div([ATTR_INDEX,t,ATTR_TITLE,i,ATTR_CLASS,HU.classes(CLASS_CLICKABLE,"ramadda-entry")],e.getIconImage()+" "+e.getName())})),_.html(a),_.find(HU.dotClass("ramadda-entry")).click((function(){let e=i[$(this).attr(ATTR_INDEX)];e&&RamaddaUtils.selectClick(t,e.getId(),e.getName(),{entry:e,entryName:e.getName(),isImage:e.getIsImage(),thumbnailUrl:e.getThumbnail(),icon:e.getIconUrl(),entryType:e.getType().id,north:e.getNorth(),west:e.getWest(),south:e.getSouth(),east:e.getEast()})})),_.show(400)},handleSearchError:function(e,t){_.html("An error occurred:"+t)}};new EntryList(getGlobalRamadda(),a,s,!1).doSearch()};jqid(r("button")).click(h);let _=jqid(e+"_results");c.keyup((function(e){let t=$(this).val();if(!Utils.isReturnKey(e)&&""==t)return _.hide(),void _.html("");13==(e.keyCode?e.keyCode:e.which)&&h()})),s.doSearch&&h()},selectClick:function(e,t,i,a){selector=selectors[e];let l=getHandler(e);if(l||(l=getHandler(selector.elementId)),l)return l.selectClick(selector.selecttype,e,t,i,a),void selector.cancel();if("wikilink"==selector.selecttype){let e={entryId:t,name:i};a&&$.extend(e,a),WikiUtil.insertAtCursor(selector.elementId,selector.textComp.obj,e)}else if("fieldname"==selector.selecttype)WikiUtil.insertAtCursor(selector.elementId,selector.textComp.obj,i);else if("image"==selector.selecttype)WikiUtil.insertAtCursor(selector.elementId,selector.textComp.obj,'{{image entry="'+t+'" caption="'+i+'" width=400px align=center}} ');else if("entryid"==selector.selecttype){let e=WikiUtil.getWikiEditor(selector.elementId);e?e.insertTags(t," ","importtype"):selector.props&&selector.props.callback?selector.props.callback(t,a):WikiUtil.insertText(selector.elementId,t,!0)}else"entry:entryid"==selector.selecttype?WikiUtil.getWikiEditor(selector.elementId).insertTags("entry:"+t," ","importtype"):(selector.getHiddenComponent().val(t),selector.getTextComponent().val(i));selector.cancel()},getBaseUrl:function(){return ramaddaBaseUrl},isRamaddaUrl:function(e){return e.startsWith(ramaddaBaseUrl)},getUrl:function(e,t){return t&&(console.error("RamaddaUtils.getUrl passed extra argument:"+t),console.trace()),RamaddaUtil.getBaseUrl()+e},getCdnUrl:function(e){return ramaddaCdn+e},getEntryUrl:function(e){return HU.url(RamaddaUtil.getUrl(URL_ENTRY_SHOW),ARG_ENTRYID,e)},fileDrops:{},changeField:function(e,t,i,a,l){let s={entryid:e,what:t,value:i,response:"json"},r=RamaddaUtil.getUrl(URL_CHANGEFIELD);$.post(r,s,(e=>{a&&a(e)})).fail((e=>{try{let t=JSON.parse(e.responseText);if(t.error)return void(l?l(t.error):alert("Error:"+t.error))}catch(e){}l?l(e.responseText):alert("Error:"+e.responseText)}))},doSave:function(e,t,i,a,l){(i=i||{}).entryid=e,i.authtoken=t,i.response="json";let s=RamaddaUtil.getUrl("/entry/change");$.post(s,i,(e=>{a&&a(e)})).fail((e=>{try{let t=JSON.parse(e.responseText);if(t.error)return void(e?e(t.error):alert("Error:"+t.error))}catch(e){}l?l(e.responseText):alert("Error:"+e.responseText)}))},initEntryTable:function(e,t,i){let a=jqid(e),l=this;t=t??{};let s={};Utils.isDefined(t.details)&&0==t.details&&(t.simple=!0);let r=t.simple,n=!r,o=null!=t.columns,d={actions:[],showName:!0,showCrumbs:!1,showCreator:o,showHeader:n,showDownload:o,showTime:o,showDate:o||n,showCreateDate:o||n,showChangeDate:o,showSize:o||n,showEntryOrder:o,showType:o||n,showAttachments:!1,showIcon:n,showThumbnails:n,showArrow:!Utils.isDefined(t.showArrow)||t.showArrow,showForm:n,formOpen:!1,inlineEdit:!1,metadataDisplay:null,bigTextLength:100};$.extend(d,t),this.props=d;let T=d.tableWidth??d.width??"100%",c=i.map(((e,t)=>{let i=new Entry(e);return s[i.getId()]=i,i})),h="",_=d.columns;_||(_=Utils.isMobile()?Utils.join([FIELD_NAME,FIELD_CREATEDATE],","):Utils.join([FIELD_NAME,FIELD_ENTRYORDER,FIELD_CREATOR,FIELD_DATE,FIELD_TIME,FIELD_CREATEDATE,FIELD_DOWNLOAD,FIELD_SIZE,FIELD_TYPE,FIELD_ATTACHMENTS],","),d.inlineEdit&&(_+=","+FIELD_EDITCOLUMNS));let U=d.typeWidth??150,p=Utils.split(_,",",!0,!0),m=[];p.forEach((e=>{e==FIELD_NAME&&d.showName?m.push({id:FIELD_NAME,label:d.nameLabel??"Name",width:d.nameWidth}):e==FIELD_DATE&&d.showDate?m.push({id:FIELD_FROMDATE,label:d.dateLabel??"Date",width:d.fromDateWidth??d.dateWidth??150}):e==FIELD_CREATEDATE&&d.showCreateDate?m.push({id:e,align:ALIGN_RIGHT,label:d.createDateLabel??"Create Date",width:d.createDateWidth??d.dateWidth??150}):e==FIELD_EDITCOLUMNS?m.push({align:ALIGN_LEFT,overflowX:OVERFLOW_AUTO,cansort:!1,id:FIELD_EDITCOLUMNS,label:"Edit Columns"}):"geo"==e?(m.push({id:FIELD_LATITUDE,label:"Latitude",width:100}),m.push({id:FIELD_LONGITUDE,label:"Longitude",width:100}),m.push({id:FIELD_ALTITUDE,label:"Altitude",width:100})):e==FIELD_ALTITUDE?m.push({id:FIELD_ALTITUDE,label:"Altitude",width:100}):"latlon"==e?(m.push({id:FIELD_LATITUDE,label:"Latitude",width:100}),m.push({id:FIELD_LONGITUDE,label:"Longitude",width:100})):e==FIELD_DOWNLOAD&&d.showDownload?m.push({id:e,label:"Download",width:100,align:ALIGN_LEFT}):e==FIELD_TIME&&d.showTime?m.push({id:e,label:"Time",width:100,align:ALIGN_RIGHT}):e==FIELD_CREATOR&&d.showCreator?m.push({id:e,label:"Creator",width:d.creatorWidth??150}):e==FIELD_ENTRYORDER&&d.showEntryOrder?m.push({id:e,align:ALIGN_RIGHT,label:"Order",width:75}):e==FIELD_CHANGEDATE&&d.showChangeDate?m.push({id:e,align:ALIGN_RIGHT,label:d.changeDateLabel??"Change Date",width:d.changeDateWidth??d.dateWidth??150}):e==FIELD_SIZE&&d.showSize?m.push({align:ALIGN_RIGHT,id:e,label:d.sizeLabel??"Size",width:d.sizeWidth??80}):e==FIELD_TYPE&&d.showType?m.push({id:e,label:d.typeLabel??"Type",align:ALIGN_LEFT,width:U}):e==FIELD_ATTACHMENTS&&d.showAttachments&&m.push({id:e,label:d.attachmentsLabel??"Attachments",align:ALIGN_LEFT,width:d.attachmentsWidth??240})}));let A=[];m.forEach(((e,t)=>{e.first=0==t,e.last=t==m.length-1;let i="";if(e.align&&(i=HU.css(CSS_TEXT_ALIGN,e.align)),e.last&&(i=HU.css(CSS_PADDING_LEFT,HU.px(4))),e.style=i,Utils.isDefined(e.width)){e.fixed=!0;let t="minmax(0,"+HU.px(e.width)+")";A.push(t)}else e.fixed=!1,e.id==FIELD_NAME?A.push("minmax(200px, 2fr)"):A.push("minmax(100px, 1fr)")}));let u="",g=Utils.join(A," ");if(u+=HU.css("grid-template-columns",g),d.showHeader){h+=HU.open(TAG_DIV,[ATTR_CLASS,HU.classes(CLASS_ENTRY_TABLE_ROW,CLASS_ENTRY_TABLE_HEADER),ATTR_STYLE,HU.css(CSS_WIDTH,T)+u]);let t=HU.classes(CLASS_ENTRY_TABLE_CELL,CLASS_ENTRY_TABLE_HEADER_COLUMN),i=HU.classes(CLASS_ENTRY_TABLE_CELL,CLASS_ENTRY_TABLE_HEADER_COLUMN);m.forEach(((a,l)=>{let s="";0==l&&d.showForm&&(s=HU.div([ATTR_CLASS,HU.classes(CLASS_CLICKABLE,"entry-table-row-toggle"),ATTR_STYLE,HU.css(CSS_PADDING_LEFT,HU.px(0),CSS_WIDTH,HU.px(10)),ATTR_ID,e+"_formarrow",ATTR_TITLE,"Click to show entry form"],HU.getIconImage("fas fa-caret-right")));let r=!Utils.isDefined(a.cansort)||a.cansort,n=[ATTR_STYLE,"",ATTR_CLASS,r?t:i],o=[];r&&(o=Utils.mergeLists(o,[ARG_ORDERBY,a.id==FIELD_DOWNLOAD?"size":a.id,ATTR_TITLE,"Sort by "+(a.id==FIELD_DOWNLOAD?"Size":a.label)]),n=Utils.mergeLists(n,[ARG_ORDERBY,a.id==FIELD_DOWNLOAD?"size":a.id,ATTR_TITLE,"Sort by "+(a.id==FIELD_DOWNLOAD?"Size":a.label)]));let T=a.label;o=Utils.mergeLists(o,[ATTR_CLASS,HU.classes(CLASS_CLICKABLE,CLASS_ENTRY_TABLE_HEADER_COLUMN,r?"entry-table-header-column-sortable":""),ATTR_STYLE,this.props.headerStyle??""]),T=HU.span(o,T),(a.id==d.orderby||"size"==d.orderby&&a.id==FIELD_DOWNLOAD)&&Utils.isDefined(d.ascending)&&(T=d.ascending?HU.getIconImage("fas fa-arrow-up")+SPACE+HU.span([],T):HU.getIconImage("fas fa-arrow-down")+SPACE+HU.span([],T)),h+=HU.div(n,s+T)})),h+=HU.close(TAG_DIV)}else r||(h+=HU.div([ATTR_CLASS,"entry-table-noheader"]));let S,E,R=Utils.getUniqueId(),L=Utils.getUniqueId(),f=[ATTR_ID,R,ATTR_CLASS,r?"entry-table-simple":"entry-table"];if(d.showHeader&&d.tableWidth&&f.push(ATTR_STYLE,HU.css(CSS_WIDTH,d.tableWidth)),h+=HU.open(TAG_DIV,f),d.showForm){S=HU.getUniqueId("form_"),h+=HU.open(TAG_FORM,[ATTR_ID,S,ATTR_METHOD,"post",ATTR_ACTION,RamaddaUtil.getUrl("/entry/getentries")]);let t=HU.checkbox("",[ATTR_STYLE,HU.css(CSS_MARGIN_LEFT,HU.px(3)),ATTR_TITLE,"Toggle all",ATTR_ID,e+"_form_cbx"],!1),i=[["","Apply action"]];d.actions.forEach((e=>{i.push([e.id,e.label])})),t+=SPACE1,t+=HU.select("",[ATTR_NAME,"output",ATTR_ID,e+"_form_action"],i),t+=SPACE1,t+=HU.open(TAG_INPUT,[ATTR_NAME,"getselected",ATTR_TYPE,"submit",ATTR_VALUE,"Selected",ATTR_CLASS,"submit ui-button ui-corner-all ui-widget",ATTR_ID,"getselected1338","role","button"]),t+=SPACE1,t+=HU.open(TAG_INPUT,[ATTR_NAME,"getall",ATTR_TYPE,"submit",ATTR_VALUE,"All",ATTR_CLASS,"submit ui-button ui-corner-all ui-widget",ATTR_ID,"getall1337","role","button"]),E=HU.getUniqueId("find"),t+=HU.span([ATTR_STYLE,HU.css(CSS_MARGIN_LEFT,HU.px(20)),ATTR_ID,E]),h+=HU.div([ATTR_CLASS,HU.classes("entry-table-form-header"),ATTR_ID,e+"_form",ATTR_STYLE,HU.css(CSS_DISPLAY,DISPLAY_NONE,CSS_WIDTH,HU.perc(100))],t)}let I=[ATTR_ID,L];d.maxHeight&&I.push(ATTR_STYLE,HU.css(CSS_MAX_HEIGHT,d.maxHeight,CSS_OVERFLOW_Y,OVERFLOW_AUTO)),h+=HU.open(TAG_DIV,I),h+=HU.close(TAG_DIV,TAG_TABLE,TAG_DIV),a.html(h),E&&HU.initPageSearch(".search-component,.entry-table-row-data",null,"Search table",!1,{target:jqid(E)}),S&&jqid(S).submit((t=>{Utils.stringDefined(jqid(e+"_form_action").val())||(alert("No action specified"),t.preventDefault())})),a.find(HU.dotClass("entry-table-header-column-sortable")).click((function(){let e,t=$(this).attr(ARG_ORDERBY);d.orderby==t?Utils.isDefined(d.ascending)?e=d.ascending?HU.addToDocumentUrl(ARG_ASCENDING,!d.ascending):HU.addToDocumentUrl(ARG_ASCENDING,!0):(e=HU.addToDocumentUrl(ARG_ORDERBY,t),e=HU.addToDocumentUrl(ARG_ASCENDING,!0)):(e=HU.addToDocumentUrl(ARG_ASCENDING,!0),e=HU.addToDocumentUrl(ARG_ORDERBY,t)),window.location=e})),jqid(e+"_form_cbx").click((function(){let t=HU.isChecked($(this));jqid(e).find(HU.dotClass(CLASS_ENTRY_FORM_SELECT)).prop("checked",t),l.highlightEntryTable(a)}));let H=jqid(e+"_formarrow"),C=()=>{d.formOpen?(jqid(e+"_form").show(),jqid(e).find(HU.dotClass(CLASS_ENTRY_FORM_SELECT)).show(),H.html(HU.getIconImage("fas fa-caret-down"))):(jqid(e+"_form").hide(),jqid(e).find(HU.dotClass(CLASS_ENTRY_FORM_SELECT)).hide(),H.html(HU.getIconImage("fas fa-caret-right")))};jqid(e+"_formarrow").click((function(){d.formOpen=!d.formOpen,C()})),d.formOpen&&C(),RamaddaUtil.showEntryTable(L,d,m,e,s,(e=>{d.formOpen&&jqid(e).find(HU.dotClass(CLASS_ENTRY_FORM_SELECT)).show()}),c,u)},formatMetadata:function(e,t,i){let a={doBigText:!0,wrapInDiv:!0,bigTextLength:100};i&&(a=$.extend(a,i));let l={};t.forEach((t=>{e.getMetadata().forEach((e=>{if(!t.ok(e))return;let i=l[e.type];i||(i=l[e.type]={display:t,contents:[]});let a=t.format(e).trim(),s=!1;Utils.split(a," ").every((e=>!(e.length>50)||(s=!0,!1))),s&&(a=HU.div([ATTR_STYLE,HU.css(CSS_WORD_BREAK,"break-all")],a)),i.contents.push(a)}))}));let s="";if(a.wrapInDiv?Object.keys(l).forEach((e=>{let t=l[e];t.display.delimiter?(s+=HU.open(TAG_DIV,[ATTR_CLASS,"ramadda-metadata-display"]),t.display.header&&(s+=HU.b(t.display.header+":")+" "),s+=Utils.join(t.contents,t.display.delimiter+" "),s+=HU.close(TAG_DIV)):(t.display.header&&(s+=HU.b(t.display.header+":")+" "),t.contents.forEach((e=>{s+=HU.div([ATTR_CLASS,"ramadda-metadata-display"],e)})))})):Object.keys(l).forEach((e=>{let t=l[e];s+=HU.open(TAG_DIV,[ATTR_CLASS,"ramadda-metadata-display"]),t.display.header&&(s+=HU.b(t.display.header+":")+" "),s+=Utils.join(t.contents,"; "),s+=HU.close(TAG_DIV)})),Utils.stringDefined(s)&&a.doBigText){let e=[ATTR_CLASS,"ramadda-metadata-bigtext","bigtext-length",a.bigTextLength];Utils.isDefined(a.bigTextHeight)&&e.push("bigtext-height",a.bigTextHeight),Utils.isDefined(a.bigTextLabelMore)&&e.push("bigtext-label-more",a.bigTextLabelMore),Utils.isDefined(a.bigTextLabelLess)&&e.push("bigtext-label-less",a.bigTextLabelLess),s=HU.div(e,s)}return s},makeMetadataDisplay:function(e){if(!e)return null;let t=[];return e=e.replace(/\\,/g,"_comma_"),Utils.split(e,",",!0,!0).forEach((e=>{let i,a,l,s,r=(e=(e=(e=e.replace(/_comma_/g,",")).replace(/\\:/g,"_colon_")).replace(/\\,/g,"_comma_")).split(":");if(0==r.length)return;let n="{attr1} {attr2}";r.forEach(((e,t)=>{if(e=(e=e.replace(/_colon_/g,":")).replace(/_comma_/g,","),0==t)return void(s=e);let r=e.split("=");if(2!=r.length)return;let o=r[0],d=r[1];o.startsWith("attr")?l=e=>e.value[o]==d:"template"==o?n=d:"delimiter"==o||"separator"==o?a=d:"header"==o&&(i=d)}));let o={prop:e,type:s,delimiter:a,header:i,template:n,check:l,ok:function(e){return e.type==this.type&&(!this.check||this.check(e))},format:function(e){let t=this.template;return["attr1","attr2","attr3","attr4"].forEach((i=>{t=t.replace("{"+i+"}",e.value[i]??"")})),t}};t.push(o)})),t},getToggleIcon:function(e){return e?HU.getIconImage("fas fa-caret-down",null,[ATTR_STYLE,this.props.toggleStyle||""]):HU.getIconImage("fas fa-caret-right",null,[ATTR_STYLE,this.props.toggleStyle||""])},applyInlineEdit:function(e,t){"string"==typeof e&&(e=$(e));let i=(e,t)=>{let i=e.attr(ATTR_ENTRYID);t=t??e.val().trim();let a=e.attr("data-field"),l=HU.url(RamaddaUtil.getUrl(URL_CHANGEFIELD),ARG_ENTRYID,i,"what",a,"value",t);if($.getJSON(l,(function(e){e.error&&alert("An error has occurred: "+e.error)})).fail((e=>{console.dir(e),alert("An error occurred:"+e)})),!event.preventDefault)return event.returnValue=!1,!1;event.preventDefault(),e.css(CSS_BACKGROUND,"yellow"),setTimeout((()=>{e.css(CSS_BACKGROUND,COLOR_WHITE)}),4e3)},a=(e,a)=>{let l=!1,s=parseInt(e.val()),r=e.attr(ATTR_ENTRYID);t.each((function(){let e=$(this).attr(ATTR_ENTRYID);if(l)s+=a;else{if(e!=r)return;l=!0}$(this).val(s),i($(this))}))};e.each((function(){let e=$(this).prop("tagName")??"",t=$(this).prop(ATTR_TYPE);e=e.toLowerCase(),"checkbox"==t?$(this).change((function(){i($(this),HU.isChecked($(this)))})):"select"==e?$(this).change((function(){i($(this))})):$(this).keypress((function(e){if(13==e.which){if(e.shiftKey&&"entryorder"==$(this).attr("data-field")){e.preventDefault?e.preventDefault():e.returnValue=!1;let t=prompt("Do you want to reorder all of the following entries. Delta:",5);return t&&a($(this),parseInt(t)),!1}i($(this))}}))}))},highlightEntryTable:function(e){e.find(HU.dotClass(CLASS_ENTRY_FORM_SELECT)).each((function(){let e=HU.isChecked($(this)),t=jqid($(this).attr("rowid"));e?t.addClass("entry-table-row-selected"):t.removeClass("entry-table-row-selected")}))},showEntryTable:function(e,t,i,a,l,s,r,n,o){let d=jqid(a),T=this,c="",h=t.simple?"entry-table-simple-row":"entry-table-row-data";h=HU.classes(h,CLASS_ENTRY_TABLE_ROW);let _=[];Utils.stringDefined(this.props.metadataDisplay)&&_.push(this.props.metadataDisplay);for(let e=1;e<=10;e++){let t=this.props["metadataDisplay"+e];Utils.stringDefined(t)&&_.push(t)}let U=RamaddaUtil.makeMetadataDisplay(Utils.join(_,",")),p=!1;r.forEach(((a,l)=>{let s="",r=Utils.getUniqueId("row_"),o=Utils.getUniqueId();i.forEach(((i,l)=>{let n=CLASS_ENTRY_TABLE_CELL;i.fixed?n+=HU.classes(CLASS_ENTRY_TABLE_CELL_FIXED):n+=HU.classes(CLASS_ENTRY_TABLE_CELL_FLEX);let d=a.getProperty(i.id,{},t.inlineEdit)??"";"number"==typeof d&&isNaN(d)&&(d="NA");let T=d,c=this.props.textClass??"";if(i.id==FIELD_NAME&&t.inlineEdit?d=HU.span([ATTR_CLASS,c,ATTR_STYLE,HU.css(CSS_WIDTH,HU.perc(100))],d):(c=HU.classes("ramadda-text",c),d=HU.span([ATTR_CLASS,c,ATTR_STYLE,this.props.textStyle??""],d)),i.id==FIELD_NAME){let e="";t.showIcon&&(e=a.getLink(a.getIconImage([ATTR_WIDTH,this.props.iconWidth??ramaddaGlobals.iconWidth]))),t.inlineEdit||(d=a.getLink(d)),t.showIcon&&(d=e+SPACE+d);let i="";if(U&&U.length){let e=RamaddaUtil.formatMetadata(a,U,{bigTextLength:t.bigTextLength,bigTextHeight:t.bigTextHeight,bigTextLabelMore:t.bigTextLabelMore,bigTextLabelLess:t.bigTextLabelLess});Utils.stringDefined(e)&&(i+=HU.div([ATTR_STYLE,HU.css(CSS_MAX_WIDTH,HU.perc(100),CSS_OVERFLOW_WRAP,"break-word")],e),p=!0)}t.showThumbnails&&a.getThumbnail()&&(i+=HU.br()+HU.div([ATTR_CLASS,HU.classes("ramadda-thumbnail",CLASS_CLICKABLE),ATTR_STYLE,HU.css(CSS_MAX_HEIGHT,HU.px(100),CSS_OVERFLOW_Y,OVERFLOW_AUTO)],HU.image(a.getThumbnail(),[ATTR_LOADING,LOADING_LAZY,ATTR_CLASS,HU.classes("ramadda-thumbnail-image"),ATTR_TITLE,"Click to enlarge",ATTR_STYLE,HU.css(CSS_WIDTH,HU.px(100)),"entry-url",a.getEntryUrl()]))),Utils.stringDefined(i)&&(d+=i)}else if(i.id==FIELD_TYPE)d=HU.href(RamaddaUtil.getUrl("/search/type/"+a.getType().id),d,[ATTR_DATA_CORPUS,"type:"+a.getType().getLabel()+" "+T,ATTR_TITLE,Utils.delimMsg("Search for entries of type")+" "+T]);else if(i.id==FIELD_ATTACHMENTS){d="";let e=[];a.getMetadata().forEach((t=>{if("content.thumbnail"!=t.type&&"content.attachment"!=t.type)return;let i,l=t.value.attr1,s=l.replace(/.*_file_/,""),r=HU.url(RamaddaUtil.getBaseUrl()+"/metadata/view/"+l,["element","1",ATTR_ENTRYID,a.getId(),"metadata_id",t.id]);if("content.thumbnail"==t.type||Utils.isImage(l))i=r;else{l=l.toLowerCase();let e=null;e=l.endsWith("pdf")?"/icons/pdf.png":l.endsWith("txt")?"/icons/txt.png":"/icons/file.png",e&&(i=RamaddaUtil.getBaseUrl()+e)}if(i){let a=t.value.attr2;Utils.stringDefined(a)||(a=s),Utils.stringDefined(a)&&(a=HU.div([ATTR_CLASS,"image-caption",ATTR_STYLE,HU.css(CSS_MAX_WIDTH,HU.px(80),CSS_OVERFLOW_X,OVERFLOW_HIDDEN,CSS_FONT_SIZE,HU.pt(9))],a)),e.push(HU.href(r,HU.image(i,[ATTR_CLASS,HU.classes("ramadda-attachment",CLASS_CLICKABLE),ATTR_DATA_CORPUS,s,ATTR_WIDTH,HU.px(75),ATTR_STYLE,HU.css(CSS_MARGIN,HU.px(2))])+(a??"")))}})),e.length>0&&(d=HU.hbox(e),d=HU.div([ATTR_STYLE,HU.css(CSS_MAX_WIDTH,HU.getDimension(i.width),CSS_OVERFLOW_X,OVERFLOW_AUTO)],d))}if(i.first){let i=[];if(t.showArrow&&i.push(HU.span(["innerid",o,ATTR_ENTRYID,a.getId(),"parentid",e,ATTR_TITLE,"Click to show contents",ATTR_CLASS,HU.classes(CLASS_ENTRY_TABLE_ROW_TOGGLE,"entry-table-widget",CLASS_CLICKABLE)],this.getToggleIcon(!1))),t.showForm){let e=Utils.getUniqueId("entry_");i.push(HU.hidden("allentry",a.getId())+HU.checkbox(e,["rowid",r,ATTR_NAME,"selentry",ATTR_VALUE,a.getId(),ATTR_CLASS,HU.classes("entry-table-widget",CLASS_ENTRY_FORM_SELECT),ATTR_STYLE,HU.css(CSS_MARGIN_RIGHT,HU.px(2),CSS_DISPLAY,DISPLAY_NONE)],!1))}if(t.showCrumbs&&a.breadcrumbs){let e=Utils.getUniqueId();i.push(HU.span([ATTR_ID,"breadcrumbtoggle_"+e,"breadcrumbid",e,ATTR_TITLE,"Show breadcrumbs",ATTR_CLASS,HU.classes("entry-row-widget",CLASS_CLICKABLE,"ramadda-breadcrumb-toggle")],HU.getIconImage(ICON_TOGGLE_CLOSED))+SPACE2+HU.span([ATTR_STYLE,HU.css(CSS_DISPLAY,DISPLAY_NONE),ATTR_ID,e],a.breadcrumbs+"&nbsp;&raquo;&nbsp;"))}i.push(d),d=Utils.wrap(i,"","")}s+=HU.div([ATTR_CLASS,n,ATTR_STYLE,i.style],d)}));let d="",T=[];if(!t.simple){a.getIconImage([ATTR_WIDTH,HU.px(32)]).replace(/"/g,"'");d=Utils.noMsg(a.getName()),a.remoteRepository&&T.push("remote-repository",a.remoteRepository.name);let e=a.getType();e&&T.push(ATTR_DATA_TYPE,e.name);let t=a.getThumbnail();t&&T.push("data-thumbnail",t);let i=a.getFilename();i&&T.push("data-filename",i),T.push(ATTR_TITLE,d,"data-icon",a.getIconUrl())}let _="";_+=HU.open(TAG_DIV,[ATTR_ENTRYID,a.getId()]),T=Utils.mergeLists(T,[ATTR_ID,r,ATTR_STYLE,n,ATTR_CLASS,h,ATTR_ENTRYID,a.getId()]),_+=HU.open(TAG_DIV,T),_+=s,_+=HU.close(TAG_DIV),_+=HU.div([ATTR_ID,o,ATTR_STYLE,HU.css(CSS_MARGIN_LEFT,HU.px(20))]),_+=HU.close(TAG_DIV),c+=_})),c+=HU.close(TAG_DIV);let m=jqid(e);!o&&t.tableWidth&&m.css(ATTR_WIDTH,t.tableWidth),c=$(c).appendTo(m),Translate.translate(c),p&&c.find(HU.dotClass("ramadda-metadata-bigtext")).each((function(){Utils.initBigText($(this))}));let A=d.find(HU.dotClass("ramadda-entry-inlineedit")),u=d.find(HU.dotClass("ramadda-entry-inlineedit-entryorder"));this.applyInlineEdit(A,u),c.find(HU.dotClass("entry-table-row-data")).tooltip({show:{effect:"slideDown",delay:1500,duration:300},position:{my:POS_RIGHT_TOP,at:POS_RIGHT_BOTTOM},content:function(){if($(this).hasClass("ramadda-edit-input"))return null;let e=$(this).attr(ATTR_TITLE),t=$(this).attr("data-icon"),i=$(this).attr("data-thumbnail");t&&(t=HU.image(t,[ATTR_WIDTH,HU.px(24)]),e=t+HU.space(1)+e),e=HU.div([],HU.b(e));let a=$(this).val();a&&(e+=HU.div([],a));let l=$(this).attr(ATTR_DATA_TYPE);l&&(e=e+"Type: "+l+HU.br());let s=$(this).attr("data-filename");s&&(e=e+"File: "+s+HU.br());let r=$(this).attr("remote-repository");return r&&(e=e+"Remote: "+r+HU.br()),e=e+HU.div([],"Right-click to see entry menu")+HU.div([],"Shift-drag to copy/move"),i&&(i=HU.image(i,[ATTR_WIDTH,HU.px(250)]),e+=HU.div([ATTR_STYLE,HU.css(CSS_MAX_HEIGHT,HU.px(200),CSS_OVERFLOW_Y,OVERFLOW_HIDDEN)],i)),HU.div([ATTR_STYLE,HU.css(CSS_MARGIN,HU.px(5))],e)}}),m.find(HU.dotClass("ramadda-breadcrumb-toggle")).click((function(){let e=$(this).attr("breadcrumbid"),t=jqid(e);t.css(CSS_DISPLAY)==DISPLAY_NONE?(jqid("breadcrumbtoggle_"+e).html(HU.getIconImage(ICON_TOGGLE_OPEN)),t.css(CSS_DISPLAY,DISPLAY_INLINE)):(jqid("breadcrumbtoggle_"+e).html(HU.getIconImage(ICON_TOGGLE_CLOSED)),t.css(CSS_DISPLAY,DISPLAY_NONE))}));if(m.find(HU.dotClass(CLASS_ENTRY_TABLE_ROW_TOGGLE)).click((function(e){(e=>{let r=e.attr(ATTR_ENTRYID),o=e.attr("innerid"),d=jqid(o),c=e.attr("filled"),h=e.attr(ATTR_OPEN);if(e.html(T.getToggleIcon(!h)),c)return void(h?(d.hide(),e.attr(ATTR_OPEN,!1)):(d.show(),e.attr(ATTR_OPEN,!0)));let _=l[r];e.attr("filled",!0),e.attr(ATTR_OPEN,!0);let U=HU.url(RamaddaUtil.getUrl(URL_ENTRY_SHOW),ARG_OUTPUT,"json","includeproperties","false","includedescription","false","includeservices","false","children","true",ARG_ENTRYID,r);t.sortby&&(U=HU.url(U,[ARG_ORDERBY,t.sortby])),t.orderby&&(U=HU.url(U,[ARG_ORDERBY,t.orderby])),t.ascending&&(U=HU.url(U,[ARG_ASCENDING,t.ascending])),t.sortdir&&(U=HU.url(U,[ARG_ASCENDING,"up"==t.sortdir])),t.showCrumbs&&(U=HU.url(U,["includecrumbs",!0])),$.getJSON(U,(function(e,r,d){if(GuiUtils.isJsonError(e))return;let T=e.map(((e,t)=>{let i=new Entry(e);return l[i.getId()]=i,i}));if(T.length>0)RamaddaUtil.showEntryTable(o,t,i,a,l,s,T,n,!0);else{let e=HU.open(TAG_TABLE,[ATTR_CLASS,"formtable"]);if(_.getIsUrl())e+=HU.formEntryLabel("URL",HU.href(_.getResourceUrl(),_.getResourceUrl()));else if(_.getIsFile()){let t=_.getResourceUrl();e+=HU.formEntryLabel("File",HU.href(t,_.getFilename())+"  ("+_.getFormattedFilesize()+") "+HU.href(t,HU.getIconImage("fas fa-download")))}e+=HU.formEntry(Utils.delimMsg("Kind"),HU.href(RamaddaUtil.getUrl("/search/type/"+_.getType().id),_.typeName,[ATTR_TITLE,Utils.delimMsg("Search for entries of type")+" "+_.typeName]));let t=HU.url(RamaddaUtil.getUrl("/search/type/"+_.getType().id),"user_id",_.creator,"search.submit",!0),i=HU.href(t,_.creator,[ATTR_TITLE,Utils.delimMsg("Search for entries of this type created by")+" "+_.creator]);e+=HU.formEntry(Utils.msgLabel("Created by"),i),e+=HU.formEntry(Utils.msgLabel("Created"),_.createDateFormat),_.startDate&&_.startDate.getTime()!=_.createDate.getTime()&&(e+=HU.formEntry(Utils.msgLabel("Date"),_.startDateFormat)),_.startDate&&_.endDate&&_.startDate.getTime()!=_.endDate.getTime()&&(e+=HU.formEntry(Utils.msgLabel("To Date"),_.endDateFormat)),e+=HU.close(TAG_TABLE),HU.jqid(o).html(e)}HU.handleNewContent(jqid(o))}))})($(this))})),t.simple)return;m.find(HU.dotClass(CLASS_ENTRY_FORM_SELECT)).click((function(e){HU.isChecked($(this)),jqid($(this).attr("rowid"));HU.checkboxClicked(e,"entry_",$(this).attr(ATTR_ID)),T.highlightEntryTable(d)})),m.find(HU.dotClass("ramadda-thumbnail-image")).click((function(){let e=$(this).attr(ATTR_SRC),t=$(this).attr("entry-url"),i=HU.href(t,HU.image(e),[ATTR_TITLE,"Click to view entry"]);HU.makeDialog({content:i,my:POS_LEFT_TOP,at:POS_LEFT_BOTTOM,anchor:this,header:!0,draggable:!0})})),m.find(HU.dotClass("ramadda-attachment")).tooltip({show:{effect:"slideDown",delay:500,duration:1e3},content:function(){return $(this).prop(ATTR_TITLE)}});let g=m.find(HU.dotClass("entry-table-row"));g.bind("contextmenu",(function(e){let t=$(this),i=l[$(this).attr(ATTR_ENTRYID)];if(!i)return;eventX=GuiUtils.getEventX(e);let a=HU.url(RamaddaUtil.getUrl(URL_ENTRY_SHOW),ARG_ENTRYID,i.getId(),ARG_OUTPUT,"metadataxml");if(GuiUtils.loadXML(a,(function(e){let a=e.responseXML.documentElement;text=getChildText(a),HU.makeDialog({content:text,my:POS_LEFT_TOP,at:POS_LEFT_BOTTOM,title:i.getIconImage()+" "+i.getName(),draggable:!0,anchor:t,header:!0})}),this),!e.preventDefault)return e.returnValue=!1,!1;e.preventDefault()})),RamaddaUtil.initDragAndDropEntries(g,l,a),s(e)},initDragAndDropOnHeader:function(e,t){let i=(e,t,i,a)=>{HU.makeOkCancelDialog($(HU.dotClass(CLASS_HEADER)),"New entry has been created: "+i+HU.div([],"Do you want to view it?"),(()=>{let e=HU.url(RamaddaUtil.getUrl(URL_ENTRY_SHOW),ARG_ENTRYID,t);document.location=e}),null,null,{okLabel:"Yes",cancelLabel:"No",at:"middle bottom",my:"middle top",title:"New Entry",header:!0})};Utils.initDragAndDrop($(HU.dotClass(CLASS_HEADER)),(e=>{}),(e=>{}),((a,l,s,r)=>{Ramadda.handleDropEvent(a,l,s,e,t,i)}),null,!0,!0)},initDragAndDropEntries:function(e,t,i){function a(e){return e.hasClass("ramadda-entry-target")}e.mousedown((function(e){if(!e.shiftKey||!t)return;let a=t[$(this).attr(ATTR_ENTRYID)];if(!a)return;let l=$(this),s=[a];if(jqid(i).find(".entry-table-row-selected").each((function(){let e=t[$(this).attr(ATTR_ENTRYID)];e&&e.getId()!=a.getId()&&s.push(e)})),Utils.entryDragInfo={dragSource:l.attr(ATTR_ID),entry:a,getIds:function(){return s.map((e=>e.getId())).join(",")},hasEntry:function(e){return s.includes(e)},getHtml:function(){let e="";return s.forEach((t=>{""!=e&&(e+=HU.br()),e+=t.getIconImage()+SPACE+t.getName()})),e}},a){if(Utils.mouseIsDown=!0,!e.preventDefault)return e.returnValue=!1,!1;e.preventDefault()}})),e.mouseover((function(e){let i="#C6E2FF";if(a($(this)))return void(Utils.mouseIsDown&&Utils.entryDragInfo&&$(this).css(CSS_BACKGROUND,i));let l=t[$(this).attr(ATTR_ENTRYID)];if(l&&Utils.mouseIsDown&&Utils.entryDragInfo){if(Utils.entryDragInfo.hasEntry(l))return;$(this).css(CSS_BACKGROUND,i)}})),e.mouseout((function(e){if(Utils.entryDragInfo){if(a($(this)))return void $(this).css(CSS_BACKGROUND,"");let e=t[$(this).attr(ATTR_ENTRYID)];if(Utils.entryDragInfo.entry==e)return;$(this).css(CSS_BACKGROUND,"")}})),e.mouseup((function(e){if(!Utils.entryDragInfo)return;if($(this).css(CSS_BACKGROUND,""),a($(this))){let e=HU.url(RamaddaUtil.getUrl("/entry/getentries"),ARG_OUTPUT,$(this).attr("target-type"));return Utils.entryDragInfo.getIds().split(",").forEach((t=>{e+="&selentry="+t})),void(document.location=e)}let i=t[$(this).attr(ATTR_ENTRYID)];i&&(Utils.entryDragInfo.hasEntry(i)||Utils.entryDragInfo.hasEntry(i)||(url=HU.url(RamaddaUtil.getUrl("/entry/copy"),"action","action.move","from",Utils.entryDragInfo.getIds(),"to",i.getId()),document.location=url))}))},initFormTags:function(e){let t=jqid(e),i=t.find(".metadata-tag-input");t.attr("autocomplete","off"),i.attr("autocomplete","off"),i.keyup((function(e){HU.hidePopupObject();let t=$(this).val();if(!Utils.stringDefined(t))return;let i=HU.url(RamaddaUtil.getUrl("/metadata/suggest"),ATTR_VALUE,t.trim()),a=$(this);$.getJSON(i,(e=>{if(0==e.length)return;let t="";e.forEach((e=>{t+=HU.div([ATTR_CLASS,HU.classes(CLASS_CLICKABLE,"metadata-suggest"),"suggest",e],e)}));let i=HU.div([ATTR_CLASS,"ramadda-search-popup",ATTR_STYLE,HU.css(CSS_MAX_WIDTH,HU.px(200),CSS_PADDING,HU.px(4))],t);HU.makeDialog({content:i,my:POS_LEFT_TOP,at:POS_LEFT_BOTTOM,anchor:a}).find(".metadata-suggest").click((function(){HU.hidePopupObject(),a.val($(this).attr("suggest"))}))})).fail((e=>{console.log("url failed:"+i+"\n"+e)}))}));let a=jqid(e).find(".metadata-tag");a.attr(ATTR_TITLE,"Click to remove"),a.click((function(){let e=t.find("#"+$(this).attr("metadata-id"));$(this).hasClass("metadata-tag-deleted")?($(this).removeClass("metadata-tag-deleted"),e.val("")):($(this).addClass("metadata-tag-deleted"),e.val("delete"))}))},initFormUpload:function(e,t,i,a){e||(e="upload");let l=jqid(t);a&&l.attr("multiple","");let s=l.closest("form"),r=HU.div([ATTR_TITLE,"Click to select a file",ATTR_ID,t+"_filewrapper",ATTR_CLASS,"fileinput_wrapper"],HU.getIconImage("fas fa-upload")+SPACE+HU.div([ATTR_ID,t+"_filename",ATTR_CLASS,"fileinput_label"]));l.after(r),l.hide();let n=jqid(t+"_filewrapper");jqid(t+"_filename");n.click((()=>{l.trigger("click")}));let o=()=>{let e=e=>{let t=e.lastIndexOf("\\");return t<0&&(t=e.lastIndexOf("/")),t>=0&&(e=e.substring(t+1)),e},i="";if(l[0].files){let t=[];for(let i=0;i<l[0].files.length;i++){let a=l[0].files[i];t.push(e(a.name)+" ("+Utils.formatFileLength(a.size)+")")}i=Utils.join(t,",")}else i=e(l.val());""==i&&(i=HU.span([ATTR_CLASS,"fileinput_label_empty"],"Click to select a file")),jqid(t+"_filename").html(i)};if(l.bind("change",o),o(),Utils.stringDefined(i)){let a=jqid(i),l={files:{},cnt:0,added:!1};a.append(HU.div([ATTR_CLASS,"ramadda-dnd-target-files",ATTR_ID,t+"_dnd_files"]));let r=jqid(t+"_dnd_files");Utils.initDragAndDrop(a,(e=>{}),(e=>{}),((i,a,n,o)=>{l.cnt++;let d=a.name;if(!d&&a.getAsFile&&(d=a.getAsFile().name),!d){let e=a.type&&a.type.match("image/.*");if(d=prompt("Entry file name:",e?"image":"file"),!d)return;if(a.type)if("text/plain"==a.type)d.endsWith(".txt")||(d+=".txt");else{d=d+"."+a.type.replace(/.*\//,"")}}let T=t+"_list"+l.cnt,c=t+"_file"+l.cnt,h=t+"_file_name"+l.cnt,_=e+"_file_"+l.cnt,U=e+"_name_"+l.cnt;l.files[c]=n;let p=HU.span([ATTR_CLASS,CLASS_CLICKABLE,ID,T+"_trash"],HU.getIconImage(icon_trash)),m=Utils.isDefined(a.size)?Utils.formatFileLength(a.size):"";r.append(HU.div([ATTR_ID,T],p+" "+d+" "+m)),s.append(HU.tag(TAG_INPUT,[ATTR_TYPE,"hidden",ATTR_NAME,_,ATTR_ID,c])),s.append(HU.tag(TAG_INPUT,[ATTR_TYPE,"hidden",ATTR_NAME,U,ATTR_ID,h])),jqid(c).val(n),jqid(h).val(d),jqid(T+"_trash").click((function(){jqid(T).remove(),jqid(c).remove(),jqid(h).remove()}))}),null,!0)}},handleDropEvent:function(e,t,i,a,l,s){let r,n=t.type.match("^image.*"),o=RamaddaUtil.getUrl("/entry/addfile"),d=t.name??"file",T=t.name;r="text/plain"==t.type?"txt":t.type.replace(/image\//,""),T||(T=d+"."+r);d=Utils.makeLabel(d.replace(/.[^\.]*$/,"")),d=t.name?prompt("Dropped file: "+T+"\nNew entry name:",d):prompt("Copied file: "+r+"\nNew entry name:",d),d&&(()=>{t.name||(T=Utils.makeId(d)+"."+r);let e,c=new FormData;c.append("filename",T),l&&c.append(ARG_AUTHTOKEN,l),"application/zip"==t.type?c.append("filetype","geo_shapefile"):"application/json"==t.type?c.append("filetype","geo_geojson"):c.append("filetype",t.type),c.append(ARG_NAME,d),c.append("group",a),c.append("description",""),c.append(ARG_FILE,i),$.ajax({url:o,cache:!1,contentType:!1,processData:!1,method:"POST",type:"POST",data:c,success:t=>{e.remove(),"ok"==t.status?s&&s(t,t.entryid,t.name,n):alert("An error occurred creating entry: "+t.message)},error:function(t){e.remove(),alert("An error occurred creating entry: "+t)}});let h=HU.div([ATTR_STYLE,HU.css(CSS_TEXT_ALIGN,ALIGN_CENTER,CSS_PADDING,HU.px(5))],HU.div([],"Creating entry")+HU.image(RamaddaUtil.getCdnUrl("/icons/mapprogress.gif"),[ATTR_WIDTH,HU.px(50)]));e=HU.makeDialog({content:h,anchor:$(document),my:"center top",at:"center top+100"})})()},inherit:function(e,t){return $.extend(e,t),t.getThis=function(){return e},e.getThis=function(){return e},e.mysuper=t,e},initMembers:function(e,t){return $.extend(e,t),e},defineMembers:function(e,t){return $.extend(e,t),e},showEntryPopup:function(e,t,i,a){let l=RamaddaUtils.contents[t];if(l)RamaddaUtils.showEntryPopupInner(e,t,i,l);else{let l=HU.url(RamaddaUtil.getUrl("/entry/menu"),ARG_ENTRYID,t);$.ajax({url:l,dataType:"text",success:function(l){RamaddaUtils.contents[t]=l,RamaddaUtils.showEntryPopupInner(e,t,i,l,a)}}).fail(((e,t,i)=>{console.log("/entry/menu failed:"+i),alert("Failed to contact the server")}))}},showEntryPopupInner:function(e,t,i,a,l){let s=jqid(e);this.entryPopup=HU.makeDialog({content:a,my:POS_LEFT_TOP,at:POS_LEFT_BOTTOM,title:i,rightSideTitle:l,anchor:s,draggable:!0,header:!0,inPlace:!1,headerRight:null})},initEntryListForm:function(e){let t=Utils.entryGroups[e];t&&(t.on=0,t.setVisbility())},hideEntryPopup:function(){this.entryPopup&&(this.entryPopup.remove(),this.entryPopup=null),HU.getTooltip().hide()},originalImages:new Array,changeImages:new Array,folderClick:function(e,t,i){RamaddaUtil.changeImages[e]=i;let a=jqid(e);if(0==a.length)return;let l=jqid("img_"+e);a.css(CSS_DISPLAY)!=DISPLAY_NONE?(i&&l.html(HU.getIconImage("fa-caret-right")),a.hide()):(RamaddaUtil.originalImages[e]=l.html(),a.show(),l.html(HU.getIconImage("fa-caret-down")),(t+="&orderby=entryorder&ascending=true").startsWith("/")&&RamaddaUtil.currentRamaddaBase&&(t=RamaddaUtil.currentRamaddaBase+t),GuiUtils.loadXML(t,RamaddaUtil.handleFolderList,e))},handleFolderList:function(request,uid){if(null!=request.responseXML){let xmlDoc=request.responseXML.documentElement,script,html;for(i=0;i<xmlDoc.childNodes.length;i++){let e=xmlDoc.childNodes[i];"javascript"==e.tagName?script=getChildText(e):"content"==e.tagName&&(html=getChildText(e))}html||(html=getChildText(xmlDoc)),html&&(jqid(uid).html(HU.div([],html)),Utils.checkTabs(html)),script&&eval(script)}RamaddaUtil.changeImages[uid]?jqid("img_"+uid).attr("src",icon_folderopen):jqid("img_"+uid).attr("src",RamaddaUtil.originalImages[uid])},Components:{init:function(e){let t=jqid(e),i=jqid(e+"_header"),a=!1,l=!1,s=t.find(".ramadda-component"),r={},n={},o={};s.each((function(){let e=$(this).attr("component-date");if(!e)return;let t,i=Utils.parseDate(e);$(this).attr("component-day",t=Utils.formatDateWithFormat(i,"mmmm d yyyy")),o[t]=!0,$(this).attr("component-month",t=Utils.formatDateWithFormat(i,"mmmm yyyy")),n[t]=!0,$(this).attr("component-year",t=Utils.formatDateWithFormat(i,"yyyy")),r[t]=!0,$(this).attr("component-latitude")&&(l=!0),Utils.stringDefined($(this).attr("component-tags"))&&(a=!0)})),i.css(CSS_TEXT_ALIGN,ALIGN_CENTER);let d=HU.div([ATTR_STYLE,HU.css(CSS_DISPLAY,DISPLAY_INLINE_BLOCK),ATTR_CLASS,HU.classes(CLASS_BUTTON,HU.classes(CLASS_BUTTON_BAR,"ramadda-button-on")),ATTR_LAYOUT,"grid"],"Grid");Object.keys(r).length>1&&(d+=HU.div([ATTR_STYLE,HU.css(CSS_DISPLAY,DISPLAY_INLINE_BLOCK),ATTR_CLASS,HU.classes(CLASS_BUTTON,CLASS_BUTTON_BAR),ATTR_LAYOUT,"year"],"Year")),Object.keys(n).length>1&&(d+=HU.div([ATTR_STYLE,HU.css(CSS_DISPLAY,DISPLAY_INLINE_BLOCK),ATTR_CLASS,HU.classes(CLASS_BUTTON,CLASS_BUTTON_BAR),ATTR_LAYOUT,"month"],"Month")),Object.keys(o).length>1&&(d+=HU.div([ATTR_STYLE,HU.css(CSS_DISPLAY,DISPLAY_INLINE_BLOCK),ATTR_CLASS,HU.classes(CLASS_BUTTON,CLASS_BUTTON_BAR),ATTR_LAYOUT,"day"],"Day")),d+=HU.div([ATTR_STYLE,HU.css(CSS_DISPLAY,DISPLAY_INLINE_BLOCK),ATTR_CLASS,HU.classes(CLASS_BUTTON,CLASS_BUTTON_BAR),ATTR_LAYOUT,ATTR_TITLE],"Title"),a&&(d+=HU.div([ATTR_STYLE,HU.css(CSS_DISPLAY,DISPLAY_INLINE_BLOCK),ATTR_CLASS,HU.classes(CLASS_BUTTON,CLASS_BUTTON_BAR),ATTR_LAYOUT,"tags"],"Tag")),d+=HU.div([ATTR_STYLE,HU.css(CSS_DISPLAY,DISPLAY_INLINE_BLOCK),ATTR_CLASS,HU.classes(CLASS_BUTTON,CLASS_BUTTON_BAR),ATTR_LAYOUT,"author"],"Author"),l&&(d+=HU.div([ATTR_STYLE,HU.css(CSS_DISPLAY,DISPLAY_INLINE_BLOCK),ATTR_CLASS,HU.classes(CLASS_BUTTON,CLASS_BUTTON_BAR),ATTR_LAYOUT,"map"],"Map")),i.append(HU.div([],d));let T=i.find(HU.dotClass(CLASS_BUTTON));T.click((function(){T.removeClass("ramadda-button-on"),$(this).addClass("ramadda-button-on");let e=$(this).attr(ATTR_LAYOUT);"grid"==e?RamaddaUtil.Components.layout(t,s,null):RamaddaUtil.Components.layout(t,s,"component-"+e)}))},layout:function(e,t,i){if(e.find(".ramadda-group").each((function(){$(this).detach()})),e.mapId&&jqid(e.mapId).detach(),e.ramaddaMap&&(ramaddaMapRemove(e.ramaddaMap),e.ramaddaMap=null),null==i)return t.show(),void t.each((function(){$(this).detach(),e.append($(this))}));if("component-map"==i){t.hide();let i=Utils.getUniqueId();e.mapId=i,e.append(HU.div([ATTR_ID,i,STYLE,HU.css(CSS_WIDTH,HU.perc(100),CSS_HEIGHT,HU.px(400))]));let a=new RepositoryMap(i,{});e.ramaddaMap=a,a.initMap(!1),t.each((function(){let e=$(this).attr("component-url"),t=+$(this).attr("component-latitude"),i=+$(this).attr("component-longitude");if(!Utils.isNumber(t))return;let l=$(this).attr("component-image"),s=HU.center(HU.b($(this).attr("component-title")));l&&(s+=HU.image(l,[ATTR_WIDTH,HU.px(300)])),e&&(s=HU.href(e,s));let r=new MapUtils.createLonLat(i,t);a.addPoint("",r,{pointRadius:6,strokeWidth:1,strokeColor:COLOR_BLACK,fillColor:"blue"},s)})),a.centerOnMarkers()}else{t.show();let a="component-day"==i||"component-month"==i||"component-year"==i,l=[],s={};t.each((function(){let e=$(this).attr(i)||"";if("component-tags"==i){let t=e.split(",");e=t[0]}if(!s[e]){s[e]=[];if(a){let t=$(this).attr("component-date"),i=t?Utils.parseDate(t):null;l.push([e,i])}else l.push(e)}s[e].push($(this))})),l=a?l.sort(((e,t)=>(e=e[1],t=t[1],e&&t?e?t?t.getTime()-e.getTime():-1:1:0))):l.sort(),l.forEach((t=>{a&&(t=t[0]);let i=e.append($(HU.div([ATTR_CLASS,"ramadda-group"],HU.div([ATTR_CLASS,"ramadda-group-header"],t))));s[t].forEach((e=>{i.append(e)}))}))}}}};function EntryRow(e,t,i,a,l,s){s||(s={showIcon:!0}),this.args=s,s.entryId=e,Utils.globalEntryRows[e]=this,Utils.globalEntryRows[t]=this,Utils.globalEntryRows[i]=this,this.entryId=e,this.showIcon=s.showIcon,this.onColor="#FFFFCC",this.overColor="#f4f4f4",this.rowId=t,this.cbxId=i,this.cbxWrapperId=a,this.showDetails=l,this.getRow=function(){return jqid(this.rowId)},this.getCbx=function(){return jqid(this.cbxId)};let r=this.getCbx().closest("form");if(r.length){let e=Utils.entryGroups[r.attr(ATTR_ID)];e&&e.addEntryRow(this)}else this.getCbx().hide();this.setCheckbox=function(e){this.getCbx().prop("checked",e),this.setRowColor()},this.isSelected=function(){return HU.isChecked(this.getCbx())},this.setRowColor=function(){this.getRow().removeClass("entry-row-hover"),this.isSelected()?this.getRow().addClass("entry-table-row-selected"):this.getRow().removeClass("entry-table-row-selected")},this.mouseOver=function(e){jqid("entrymenuarrow_"+t).attr("src",icon_menuarrow),this.getRow().addClass("entry-row-hover")},this.mouseOut=function(e){jqid("entrymenuarrow_"+t).attr("src",icon_blank),this.setRowColor()},this.mouseClick=function(t){eventX=GuiUtils.getEventX(t);let i=this.getRow().offset();if(eventX-i.left<150)return;this.lastClick=eventX;let a=HU.url(RamaddaUtil.getUrl(URL_ENTRY_SHOW),ARG_ENTRYID,e,ARG_OUTPUT,"metadataxml");this.showDetails?a+="&details=true":a+="&details=false",this.showIcon?a+="&showIcon=true":a+="&showIcon=false",GuiUtils.loadXML(a,this.handleTooltip,this)},this.handleTooltip=function(e,t){let i=e.responseXML.documentElement;text=getChildText(i);let a=t.getRow().offset().left,l=(t.lastClick,HU.jsLink("",HU.getIconImage(ICON_CLOSE),[ATTR_ONMOUSEDOWN,"RamaddaUtil.hideEntryPopup();",ATTR_ID,"tooltipclose"])),s=HU.image(t.args.icon)+SPACE+t.args.name,r=HU.div([ATTR_CLASS,"ramadda-popup-header"],l+SPACE2+s),n=HU.div([ATTR_CLASS,CLASS_POPUP,ATTR_STYLE,HU.css(CSS_DISPLAY,DISPLAY_BLOCK)],r+HU.table([],text)),o=HU.getTooltip();o.html(n),o.draggable(),Utils.checkTabs(text);let d=t.getRow().offset(),T=(t.getRow().outerWidth(),t.getRow().outerHeight()),c=HU.getTooltip().outerWidth(),h=$(window).width(),_=t.lastClick;t.lastClick+c>h&&(_-=t.lastClick+c-h);let U=HU.px(_),p=HU.px(3+d.top+T);o.css({position:POSITION_ABSOLUTE,zIndex:5e3,left:U,top:p}),o.show()}}var selectors=new Array;function Selector(e,t,i,a,l,s,r,n,o){let d=this;o=o??{},this.props=o,this.id=t,this.elementId=i,this.domId=HU.getUniqueId("selector_"),this.localeId=s,this.entryType=r,this.allEntries=a,this.selecttype=l,this.textComp=GuiUtils.getDomObject(this.elementId),this.ramaddaUrl=n??ramaddaBaseUrl,this.getTextComponent=function(){let e="#"+this.elementId;return $(e)},this.getHiddenComponent=function(){let e="#"+this.elementId+"_hidden";return $(e)},this.cancel=function(e){!e&&this.pinned||jqid(this.domId).remove()},this.clearInput=function(){this.getHiddenComponent().val(""),this.getTextComponent().val("")},this.handleClick=function(e){let t=this.props.anchor;if(!t){if(this.props.eventSourceId&&(t=jqid(this.props.eventSourceId)),null!=t&&0!=t.length||e&&e.target&&(t=$(e.target)),null==t||0==t.length){let e=this.id+"_selectlink";t=jqid(e)}null!=t&&0!=t.length||(t=jqid(this.id))}HU.hidePopupObject(e);let i=$(HU.div([ATTR_STYLE,HU.css(CSS_POSITION,POSITION_RELATIVE)])).appendTo(TAG_BODY);$(HU.div([ATTR_STYLE,HU.css(CSS_MIN_WIDTH,HU.px(200),CSS_MIN_HEIGHT,HU.px(200)),ATTR_CLASS,"ramadda-selectdiv",ATTR_ID,this.domId])).appendTo(i),this.div=jqid(this.domId),this.props.minWidth&&this.div.css("min-width",this.props.minWidth),this.div.draggable(),this.anchor=t,this.showDiv=()=>{this.div.show(),this.div.position({of:this.anchor,my:this.props.locationMy??POS_LEFT_TOP,at:this.props.locationAt??POS_LEFT_BOTTOM,collision:this.props.collision??"fit fit"})};let a=HU.url(URL_ENTRY_SHOW,ARG_OUTPUT,"selectxml","noredirect","true","firstclick",!0);if(this.props.searchFirst&&(a=HU.url(a,"searchfirst",!0)),this.props.doSearch&&(a=HU.url(a,"dosearch",!0)),this.selecttype&&(a=HU.url(a,["selecttype",this.selecttype])),a=HU.url(a,"allentries",this.allEntries,"target",this.id),this.ramaddaUrl&&!this.ramaddaUrl.startsWith("/")){let e=new URL(this.ramaddaUrl).pathname,t=this.ramaddaUrl.replace(e,"");RamaddaUtil.currentRamaddaBase=t,a=this.ramaddaUrl+a}else RamaddaUtil.currentRamaddaBase=null,a=RamaddaUtil.getUrl(a);return this.localeId&&(a=HU.url(a,"localeid",this.localeId)),this.entryType&&(a=HU.url(a,"entrytype",this.entryType)),this.props.typeLabel&&(a=HU.url(a,"typelabel",this.props.typeLabel)),Utils.isDefined(this.props.showTypeSelector)&&(a=HU.url(a,"showtypeselector",this.props.showTypeSelector)),GuiUtils.loadXML(a,((e,t)=>{d.handleSelect(e,t)}),this.id),!1},this.handleClick(e)}function getChildText(e){let t="";for(childIdx=0;childIdx<e.childNodes.length;childIdx++)t+=e.childNodes[childIdx].nodeValue;return t}function toggleBlockVisibility(e,t,i,a,l){HU.toggleBlockVisibility(e,t,i,a,null,l)}function toggleInlineVisibility(e,t,i,a){let l,s=GuiUtils.getDomObject(t);toggleVisibility(e,DISPLAY_INLINE),l=jqid(e).is(":visible")?i:a,StringUtil.startsWith(l,"fa-")?jqid(t).attr(ATTR_CLASS,l):s&&(s.obj.src=l),Utils.ramaddaUpdateMaps()}function toggleVisibility(e,t,i,a){let l=jqid(e).css(CSS_DISPLAY);return Utils.isDefined(a)?(a?jqid(e).show():jqid(e).hide(),a):(jqid(e).toggle(i),l!=DISPLAY_BLOCK)}function hide(e){jqid(e).hide()}function hideObject(e){return e?(jqid(e.id).hide(),1):0}function showObject(e,t){if(!e)return 0;jqid(e.id).show()}function toggleVisibilityOnObject(e,t){if(!e)return 0;jqid(e.id).toggle()}Selector.prototype={handleSelect:function(e,t){let i=this,a=e.responseXML.documentElement;text=getChildText(a);let l=this.domId+"-pin",s=HU.jsLink("",HU.getIconImage(icon_pin),[ATTR_CLASS,"ramadda-popup-pin",ATTR_ID,l]),r=HU.getIconImage(ICON_CLOSE,[]),n=t+"_close",o=HU.span([ATTR_ID,n,ATTR_CLASS,CLASS_CLICKABLE],r),d=(this.props?this.props.title:"")??"",T=(this.props?this.props.extra:"")??"";Utils.stringDefined(d)&&(d=HU.span([ATTR_STYLE,HU.css(CSS_MARGIN_LEFT,HU.px(5))],d));let c=HU.div([ATTR_STYLE,HU.css(CSS_TEXT_ALIGN,ALIGN_LEFT),ATTR_CLASS,"ramadda-popup-header"],SPACE+o+SPACE+s+d),h=HU.div([ATTR_ID,t+"-popup"],c+T+text);this.div.html(h),this.showDiv(),jqid(n).click((()=>{this.cancel(!0)})),jqid(l).click((function(){i.pinned=!i.pinned,i.pinned?$(this).addClass("ramadda-popup-pin-pinned"):$(this).removeClass("ramadda-popup-pin-pinned")})),this.props&&this.props.initCallback&&this.props.initCallback()}};
