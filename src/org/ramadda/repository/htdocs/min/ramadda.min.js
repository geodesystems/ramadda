var RamaddaUtils,RamaddaUtil,Ramadda=RamaddaUtils=RamaddaUtil={contents:{},currentRamaddaBase:null,currentSelector:null,initToggleTable:function(container){$(container).find(".entry-arrow").click((function(){let url=$(this).attr("data-url");if(!url)return;let title=$(this).attr("data-title")??"",handler=request=>{if(null==request.responseXML)return;let xmlDoc=request.responseXML.documentElement,script,html;for(i=0;i<xmlDoc.childNodes.length;i++){let t=xmlDoc.childNodes[i];"javascript"==t.tagName?script=getChildText(t):"content"==t.tagName&&(html=getChildText(t))}if(html||(html=getChildText(xmlDoc)),html){html=HU.div(["style",HU.css("margin","5px","max-height","300px","overflow-y","auto")],html);let t=HU.makeDialog({content:html,my:"left top",at:"left bottom",title:title,anchor:this,draggable:!0,header:!0,inPlace:!1,stick:!0});Utils.checkTabs(html)}script&&eval(script)};GuiUtils.loadXML(url,handler)}))},selectInitialClick:function(t,e,i,a,n,l,r,s,o){return RamaddaUtils.currentSelector&&RamaddaUtils.currentSelector.cancel(),RamaddaUtils.currentSelector=RamaddaUtils.selectCreate(t,e,i,a,n,l,r,s,o),!1},selectCreate:function(t,e,i,a,n,l,r,s,o){let d=e+(s||"");return selectors[e]=selectors[d]=new Selector(t,e,i,a,n,l,r,s,o)},clearSelect:function(t){if(selector=selectors[t],selector)selector.clearInput();else{let e=GuiUtils.getDomObject(t),i=GuiUtils.getDomObject(t+"_hidden");i&&(i.obj.value=""),e&&(e.obj.value="")}},viewSelect:function(t){let e=GuiUtils.getDomObject(t+"_hidden");if(e){let t=e.obj.value;if(Utils.stringDefined(t)){let e=RamaddaUtils.getEntryUrl(t);window.open(e,"_blank")}}},initEntryPopup:function(t,e){let i=HU.input("","",["id",t+"_input",CLASS,"input","placeholder","Search","style",HU.css("width","200px")]);i=HU.center(i);let a=i+HU.div([CLASS,"ramadda-select-search-results","id",t+"_results"]);$("#"+t).html(a);let n=$("#"+t+"_results");$("#"+t+"_input").keyup((function(t){let i=$(this).val();if(""==i)return n.hide(),void n.html("");if(13==(t.keyCode?t.keyCode:t.which)){let t=ramaddaBaseUrl+"/search/do?text="+encodeURIComponent(i)+"&output=json";n.html(HU.getIconImage(icon_wait)+" Searching..."),n.show();let a={entryListChanged:function(t){let i=t.getEntries();if(0==i.length)return n.show(),void n.html("Nothing found");let a="";i.forEach(((t,e)=>{a+=HU.div(["index",e,"class","ramadda-clickable ramadda-entry"],t.getIconImage()+" "+t.getName())})),n.html(a),n.find(".ramadda-entry").click((function(){let t=i[$(this).attr("index")];RamaddaUtils.selectClick(e,t.getId(),t.getName(),{entryName:t.getName(),icon:t.getIconUrl(),entryType:t.getType().id})})),n.show(400)},handleSearchError:function(t,e){n.html("An error occurred:"+e)}};new EntryList(getGlobalRamadda(),t,a,!1).doSearch()}}))},selectClick:function(t,e,i,a){selector=selectors[t];let n=getHandler(t);if(n||(n=getHandler(selector.elementId)),n)return n.selectClick(selector.selecttype,t,e,i),void selector.cancel();if("wikilink"==selector.selecttype){let t={entryId:e,name:i};a&&$.extend(t,a),WikiUtil.insertAtCursor(selector.elementId,selector.textComp.obj,t)}else if("fieldname"==selector.selecttype)WikiUtil.insertAtCursor(selector.elementId,selector.textComp.obj,i);else if("image"==selector.selecttype)WikiUtil.insertAtCursor(selector.elementId,selector.textComp.obj,'{{image entry="'+e+'" caption="'+i+'" width=400px align=center}} ');else if("entryid"==selector.selecttype){let t=WikiUtil.getWikiEditor(selector.elementId);t?t.insertTags(e," ","importtype"):selector.props&&selector.props.callback?selector.props.callback(e,a):WikiUtil.insertText(selector.elementId,e)}else"entry:entryid"==selector.selecttype?WikiUtil.getWikiEditor(selector.elementId).insertTags("entry:"+e," ","importtype"):(selector.getHiddenComponent().val(e),selector.getTextComponent().val(i));selector.cancel()},getBaseUrl:function(){return ramaddaBaseUrl},isRamaddaUrl:function(t){return t.startsWith(ramaddaBaseUrl)},getUrl:function(t){return RamaddaUtil.getBaseUrl()+t},getCdnUrl:function(t){return ramaddaCdn+t},getEntryUrl:function(t){return RamaddaUtil.getUrl("/entry/show?entryid="+t)},fileDrops:{},doSave:function(t,e,i,a,n){(i=i||{}).entryid=t,i.authtoken=e,i.response="json";let l=RamaddaUtil.getUrl("/entry/change");$.post(l,i,(t=>{a&&a(t)})).fail((t=>{try{let e=JSON.parse(t.responseText);if(e.error)return void(t?t(e.error):alert("Error:"+e.error))}catch(t){}n?n(t.responseText):alert("Error:"+t.responseText)}))},initEntryTable:function(t,e,i){e=e||{};let a={};Utils.isDefined(e.details)&&0==e.details&&(e.simple=!0);let n=e.simple,l=!n,r=null!=e.columns,s={actions:[],showName:!0,showCrumbs:!1,showCreator:r,showHeader:l,showDownload:r,showTime:r,showDate:r||l,showCreateDate:r||l,showChangeDate:r,showSize:r||l,showEntryOrder:r,showType:r||l,showAttachments:!1,showIcon:l,showThumbnails:l,showArrow:l,showForm:l,formOpen:!1,inlineEdit:!1};$.extend(s,e);let o=i.map(((t,e)=>{let i=new Entry(t);return a[i.getId()]=i,i})),d="",c=[],h=Utils.split(s.columns??"name,entryorder,creator,date,time,createdate,download,size,type,attachments",",",!0,!0);h.forEach((t=>{"name"==t&&s.showName?c.push({id:"name",label:"Name",width:s.nameWidth}):"date"==t&&s.showDate?c.push({id:"fromdate",label:"Date",width:s.fromDateWidth??s.dateWidth??130}):"createdate"==t&&s.showCreateDate?c.push({id:t,label:"Create Date",width:s.createDateWidth??s.dateWidth??130}):"download"==t&&s.showDownload?c.push({id:t,label:"&nbsp;Download&nbsp;",width:100,align:"left"}):"time"==t&&s.showTime?c.push({id:t,label:"&nbsp;Time&nbsp;",width:100,align:"right"}):"creator"==t&&s.showCreator?c.push({id:t,label:"Creator",width:s.creatorWidth??200}):"entryorder"==t&&s.showEntryOrder?c.push({id:t,label:"Order",width:75}):"changedate"==t&&s.showChangeDate?c.push({id:t,label:"Change Date",width:s.changeDateWidth??s.dateWidth??130}):"size"==t&&s.showSize?c.push({id:t,label:"Size",width:s.sizeWidth??80}):"type"==t&&s.showType?c.push({id:t,label:"Type",align:"left",paddingLeft:"10px",width:s.typeWidth??100}):"attachments"==t&&s.showAttachments&&c.push({id:t,label:"Attachments",align:"left",paddingLeft:"10px",width:s.attachmentsWidth??240})}));let m=s.tableWidth??"100%";if(s.showHeader){d+=HU.open("table",["cellspacing","0","cellpadding","0","class","entry-list-header","width",m]);let e=["class","entry-list-header-column ramadda-clickable"];c.forEach(((i,a)=>{let n=e,l=i.width;0==a&&s.showForm&&(d+=HU.td(["style","padding-left:3px;","width","10"],HU.div(["style","width:15px","id",t+"_formarrow","title","Click to show entry form","class","ramadda-clickable"],HU.getIconImage("fas fa-caret-right"))),l-=10),Utils.isDefined(i.width)&&(n=Utils.mergeLists(n,["width",i.width])),n.push("style",HU.css("padding-left",i.paddingLeft??"0px")),n=Utils.mergeLists(n,["orderby","download"==i.id?"size":i.id,"title","Sort by "+("download"==i.id?"Size":i.label)]);let r=i.label;(i.id==s.orderby||"size"==s.orderby&&"download"==i.id)&&Utils.isDefined(s.ascending)&&(r=s.ascending?HU.getIconImage("fas fa-arrow-up")+SPACE+HU.span([],r):HU.getIconImage("fas fa-arrow-down")+SPACE+HU.span([],r)),d+=HU.td(n,r)})),d+="</table>"}else n||(d+=HU.div(["class","entry-list-noheader"]));let p,u=Utils.getUniqueId(),g=Utils.getUniqueId(),f=n?"entry-list-simple":"entry-list",U=["id",u,"class",f];if(s.showHeader&&s.tableWidth&&U.push("style",HU.css("width",s.tableWidth)),d+=HU.open("div",U),s.showForm){p=HU.getUniqueId("form_"),d+=HU.open("form",["id",p,"method","post","action",RamaddaUtil.getUrl("/entry/getentries")]);let e=HU.checkbox("",["style",HU.css("margin-left","3px"),"title","Toggle all","id",t+"_form_cbx"],!1),i=[["","Apply action"]];s.actions.forEach((t=>{i.push([t.id,t.label])})),e+=SPACE1,e+=HU.select("",["name","output","id",t+"_form_action"],i),e+=SPACE1,e+=HU.open("input",["name","getselected","type","submit","value","Selected","class","submit ui-button ui-corner-all ui-widget","id","getselected1338","role","button"]),e+=SPACE1,e+=HU.open("input",["name","getall","type","submit","value","All","class","submit ui-button ui-corner-all ui-widget","id","getall1337","role","button"]),d+=HU.div(["class",f+"-row","id",t+"_form","style","display:none;width:100%"],e)}let y=["id",g];s.maxHeight&&y.push("style",HU.css("max-height",s.maxHeight,"overflow-y","auto")),d+=HU.open("div",y),d+="</div>",d+="</form>",d+="</div>";let b=jqid(t);b.html(d),p&&jqid(p).submit((e=>{Utils.stringDefined(jqid(t+"_form_action").val())||(alert("No action specified"),e.preventDefault())})),b.find(".entry-list-header-column").click((function(){let t,e=$(this).attr("orderby");s.orderby==e?Utils.isDefined(s.ascending)?s.ascending?t=HU.addToDocumentUrl("ascending",!1):(t=HU.addToDocumentUrl("ascending",null),t=HU.addToDocumentUrl("orderby",null)):(t=HU.addToDocumentUrl("orderby",e),t=HU.addToDocumentUrl("ascending",!0)):(t=HU.addToDocumentUrl("ascending",!0),t=HU.addToDocumentUrl("orderby",e)),window.location=t})),$("#"+t+"_form_cbx").click((function(){let e=$(this).is(":checked");jqid(t).find(".entry-form-select").prop("checked",e)}));let w=jqid(t+"_formarrow"),H=()=>{s.formOpen?(jqid(t+"_form").show(),jqid(t).find(".entry-form-select").show(),w.html(HU.getIconImage("fas fa-caret-down"))):(jqid(t+"_form").hide(),jqid(t).find(".entry-form-select").hide(),w.html(HU.getIconImage("fas fa-caret-right")))};$("#"+t+"_formarrow").click((function(){s.formOpen=!s.formOpen,H()})),s.formOpen&&H(),RamaddaUtil.showEntryTable(g,s,c,t,a,(t=>{s.formOpen&&jqid(t).find(".entry-form-select").show()}),o)},showEntryTable:function(t,e,i,a,n,l,r,s){let o=$("#"+a),d="",c=e.simple?"entry-list-simple-row":"entry-list-row entry-list-row-data";r.forEach(((t,a)=>{let n="",l=Utils.getUniqueId("row_"),r=Utils.getUniqueId();i.forEach(((a,s)=>{let o=s==i.length-1,d=[ATTR_CLASS,"entry-row"],c=t.getProperty(a.id,{},e.inlineEdit)??"",h=c;if(c=HU.span([],c),"name"==a.id){let i="";e.showIcon&&(i=t.getLink(t.getIconImage())),e.inlineEdit||(c=t.getLink(c)),e.showIcon&&(c=i+SPACE+c);let a=[],n=Utils.getUniqueId("entry_");if(e.showForm&&a.push(HU.hidden("allentry",t.getId())+HU.checkbox(n,["rowid",l,"name","selentry","value",t.getId(),"class","entry-form-select","style",HU.css("margin-right","2px","display","none")],!1)),a.push(HU.div(["style",HU.css("margin-right","2px","min-width","10px"),"innerid",r,"entryid",t.getId(),"title","Click to show contents","class","entry-arrow ramadda-clickable"],HU.getIconImage("fas fa-caret-right"))),e.showCrumbs&&t.breadcrumbs){let e=Utils.getUniqueId();c=HU.span(["id","breadcrumbtoggle_"+e,"breadcrumbid",e,"title","Show breadcrumbs","class","ramadda-clickable ramadda-breadcrumb-toggle"],HU.getIconImage("fas fa-plus-square"))+SPACE2+HU.span(["style",HU.css("display","none"),"id",e],t.breadcrumbs+"&nbsp;&raquo;&nbsp;")+c}e.showThumbnails&&t.getThumbnail()&&(c+="<br>"+HU.div(["class","ramadda-thumbnail",ATTR_STYLE,HU.css("max-height","100px","overflow-y","auto")],HU.image(t.getThumbnail(),["loading","lazy",ATTR_CLASS,"ramadda-clickable ramadda-thumbnail-image",ATTR_TITLE,"Click to enlarge",ATTR_STYLE,HU.css("width","100px"),"entry-url",t.getEntryUrl()]))),a.push(c),c=HU.table([],HU.tr(["valign","top"],HU.tds([],a)))}else{"attachments"==a.id?(c="",t.getMetadata().forEach((e=>{if("content.thumbnail"==e.type||"content.attachment"==e.type){let i,a=e.value.attr1,n=a.replace(/.*_file_/,""),l=HU.url(RamaddaUtil.getBaseUrl()+"/metadata/view/"+a,["element","1","entryid",t.getId(),"metadata_id",e.id]);if("content.thumbnail"==e.type||Utils.isImage(a))i=l,n+="<br>"+HU.image(i,["width","290px"]).replace(/"/g,"'");else{a=a.toLowerCase();let t=null;t=a.endsWith("pdf")?"/icons/pdf.png":a.endsWith("txt")?"/icons/txt.png":"/icons/file.png",t&&(i=RamaddaUtil.getBaseUrl()+t)}i&&(c+=HU.href(l,HU.image(i,["class","ramadda-attachment ramadda-clickable","title",n,"width","75px","style",HU.css("margin","2px")])))}})),""!=c&&(c=HU.div(["style",HU.css("max-width",HU.getDimension(a.width),"overflow-x","auto")],c))):"type"==a.id&&(c=HU.href(RamaddaUtil.getUrl("/search/type/"+t.getType().id),c,["title","Search for entries of type "+h]));let e=a.width-20;e=a.width,c=HU.div(["style",HU.css("padding-left",a.paddingLeft??"5px","white-space","nowrap","width",HU.getDimension(a.width),"text-align",a.align??"right","max-width",HU.getDimension(e),"overflow-x","hidden")+(o?HU.css("padding-right","4px"):"")],c),d.push("align",a.align??"right")}Utils.isDefined(a.width)&&d.push("width",HU.getDimension(a.width)),n+=HU.td(d,c)}));let s=HU.open("div",["entryid",t.getId(),"id",l]);s+=HU.open("div",["entryid",t.getId(),"id",l,"class",c]),s+=HU.open("table",["cellspacing","0","cellpadding","border","width","100%","class","entry-row-table","entryid",t.getId()]);let o="",h=[ATTR_CLASS,"entry-row","valign","top"];if(!e.simple){t.getIconImage(["width","32px"]).replace(/"/g,"'");o=t.getName(),t.remoteRepository&&h.push("remote-repository",t.remoteRepository.name);let e=t.getType();e&&h.push("data-type",e.name);let i=t.getThumbnail();i&&h.push("data-thumbnail",i);let a=t.getFilename();a&&h.push("data-filename",a),h.push(ATTR_TITLE,o,"data-icon",t.getIconUrl())}s+=HU.open("tr",h),s+=n,s+="</tr></table>",s+="</div>",s+=HU.div(["id",r,"style",HU.css("margin-left","20px")]),s+="</div>",d+=s})),d+=HU.close("div");let h=jqid(t);!s&&e.tableWidth&&h.css("width",e.tableWidth),d=$(d).appendTo(h),Translate.translate(d);let m=o.find(".ramadda-entry-inlineedit"),p=o.find(".ramadda-entry-inlineedit-entryorder"),u=t=>{let e=t.attr("entryid"),i=t.val().trim(),a=t.attr("data-field"),n=ramaddaBaseUrl+"/entry/changefield?entryid="+e+"&what="+a+"&value="+i;if($.getJSON(n,(function(t){t.error&&alert("An error has occurred: "+t.error)})).fail((t=>{console.dir(t),alert("An error occurred:"+t)})),!event.preventDefault)return event.returnValue=!1,!1;event.preventDefault(),t.css("background","yellow"),setTimeout((()=>{t.css("background","#fff")}),4e3)},g=(t,e)=>{let i=!1,a=parseInt(t.val()),n=t.attr("entryid");p.each((function(){let t=$(this).attr("entryid");if(i)a+=e;else{if(t!=n)return;i=!0}$(this).val(a),u($(this))}))};if(m.keypress((function(t){if(13==t.which){if(t.shiftKey&&"entryorder"==$(this).attr("data-field")){t.preventDefault?t.preventDefault():t.returnValue=!1;let e=prompt("Do you want to reorder all of the following entries. Delta:",5);return e&&g($(this),parseInt(e)),!1}u($(this))}})),d.find(".entry-row").tooltip({show:{effect:"slideDown",delay:1500,duration:300},position:{my:"right top",at:"right bottom"},content:function(){if($(this).hasClass("ramadda-edit-input"))return null;let t=$(this).attr("title"),e=$(this).attr("data-icon"),i=$(this).attr("data-thumbnail");e&&(e=HtmlUtils.image(e,[ATTR_WIDTH,"32px"]),t=e+HU.space(1)+t),t=HU.div([],HU.b(t));let a=$(this).attr("data-type");a&&(t=t+"Type: "+a+"<br>");let n=$(this).attr("data-filename");n&&(t=t+"File: "+n+"<br>");let l=$(this).attr("remote-repository");return l&&(t=t+"Remote: "+l+"<br>"),t=t+HU.div([],"Right-click to see entry menu")+HU.div([],"Shift-drag to copy/move"),i&&(i=HtmlUtils.image(i,[ATTR_WIDTH,"250px"]),t+=HU.div([ATTR_STYLE,"max-height:200px;overflow-y:hidden;"],i)),HU.div([ATTR_STYLE,HU.css("margin","5px")],t)}}),h.find(".ramadda-breadcrumb-toggle").click((function(){let t=$(this).attr("breadcrumbid"),e=$("#"+t);"none"==e.css("display")?($("#breadcrumbtoggle_"+t).html(HU.getIconImage("fas fa-minus-square")),e.css("display","inline")):($("#breadcrumbtoggle_"+t).html(HU.getIconImage("fas fa-plus-square")),e.css("display","none"))})),h.find(".entry-arrow").click((function(){let t=$(this).attr("entryid"),r=$(this).attr("innerid"),s=$("#"+r),o=$(this).attr("filled"),d=$(this).attr("open");if(d?$(this).html(HU.getIconImage("fas fa-caret-right")):$(this).html(HU.getIconImage("fas fa-caret-down")),o)return void(d?(s.hide(),$(this).attr("open",!1)):(s.show(),$(this).attr("open",!0)));let c=n[t];$(this).attr("filled",!0),$(this).attr("open",!0);let h=RamaddaUtil.getUrl("/entry/show?output=json&includeproperties=false&includedescription=false&includeservices=false&children=true&entryid="+t);e.sortby&&(h=HU.url(h,["orderby",e.sortby])),e.orderby&&(h=HU.url(h,["orderby",e.orderby])),e.ascending&&(h=HU.url(h,["ascending",e.ascending])),e.sortdir&&(h=HU.url(h,["ascending","up"==e.sortdir])),console.log(h),$.getJSON(h,(function(t,s,o){if(GuiUtils.isJsonError(t))return;let d=t.map(((t,e)=>{let i=new Entry(t);return n[i.getId()]=i,i}));if(d.length>0)RamaddaUtil.showEntryTable(r,e,i,a,n,l,d,!0);else{let t=HU.open("table",["class","formtable"]);if(c.getIsUrl())t+=HU.formEntry("URL:",HU.href(c.getResourceUrl(),c.getResourceUrl()));else if(c.getIsFile()){let e=c.getResourceUrl();t+=HU.formEntry("File:",HU.href(e,c.getFilename())+"  ("+c.getFormattedFilesize()+") "+HU.href(e,HU.getIconImage("fas fa-download")))}t+=HU.formEntry("Kind:",HU.href(RamaddaUtil.getUrl("/search/type/"+c.getType().id),c.typeName,["title","Search for entries of type "+c.typeName]));let e=RamaddaUtil.getUrl("/search/type/"+c.getType().id+"?user_id="+c.creator+"&search.submit=true"),i=HU.href(e,c.creator,["title","Search for entries of this type created by "+c.creator]);t+=HU.formEntry("Created by:",i),t+=HU.formEntry("Created:",c.createDateFormat),c.startDate&&c.startDate.getTime()!=c.createDate.getTime()&&(t+=HU.formEntry("Date:",c.startDateFormat)),c.startDate&&c.endDate&&c.startDate.getTime()!=c.endDate.getTime()&&(t+=HU.formEntry("To Date:",c.endDateFormat)),t+="</table>",HU.jqid(r).html(t)}}))})),e.simple)return;h.find(".entry-form-select").click((function(t){$(this).is(":checked"),$("#"+$(this).attr("rowid"));HU.checkboxClicked(t,"entry_",$(this).attr("id")),o.find(".entry-form-select").each((function(){let t=$(this).is(":checked"),e=$("#"+$(this).attr("rowid"));t?e.addClass("entry-list-row-selected"):e.removeClass("entry-list-row-selected")}))})),h.find(".ramadda-thumbnail-image").click((function(){let t=$(this).attr("src"),e=$(this).attr("entry-url"),i=HU.href(e,HU.image(t),[ATTR_TITLE,"Click to view entry"]);HU.makeDialog({content:i,my:"left top",at:"left bottom",anchor:this,header:!0,draggable:!0})})),h.find(".ramadda-attachment").tooltip({show:{effect:"slideDown",delay:500,duration:1e3},content:function(){return $(this).prop("title")}});let f=h.find(".entry-list-row");f.bind("contextmenu",(function(t){let e=$(this),i=n[$(this).attr("entryid")];if(!i)return;eventX=GuiUtils.getEventX(t);let a=RamaddaUtil.getUrl("/entry/show?entryid="+i.getId()+"&output=metadataxml");if(GuiUtils.loadXML(a,(function(t){let a=t.responseXML.documentElement;text=getChildText(a),HU.makeDialog({content:text,my:"left top",at:"left bottom",title:i.getIconImage()+" "+i.getName(),anchor:e,header:!0})}),this),!t.preventDefault)return t.returnValue=!1,!1;t.preventDefault()})),RamaddaUtil.initDragAndDropEntries(f,n,a),l(t)},initDragAndDropOnHeader:function(t,e){let i=(t,e,i,a)=>{HU.makeOkCancelDialog($(".ramadda-header"),"New entry has been created: "+i+"<br>Do you want to view it?",(()=>{let t=RamaddaUtil.getUrl("/entry/show?entryid="+e);document.location=t}),null,null,{okLabel:"Yes",cancelLabel:"No",at:"middle bottom",my:"middle top",title:"New Entry",header:!0})};Utils.initDragAndDrop($(".ramadda-header"),(t=>{}),(t=>{}),((a,n,l,r)=>{Ramadda.handleDropEvent(a,n,l,t,e,i)}),null,!0,!0)},initDragAndDropEntries:function(t,e,i){function a(t){return t.hasClass("ramadda-entry-target")}t.mousedown((function(t){if(!t.shiftKey||!e)return;let a=e[$(this).attr("entryid")];if(!a)return;let n=$(this),l=[a];if($("#"+i).find(".entry-list-row-selected").each((function(){let t=e[$(this).attr("entryid")];t&&t.getId()!=a.getId()&&l.push(t)})),Utils.entryDragInfo={dragSource:n.attr("id"),entry:a,getIds:function(){return l.map((t=>t.getId())).join(",")},hasEntry:function(t){return l.includes(t)},getHtml:function(){let t="";return l.forEach((e=>{""!=t&&(t+="<br>"),t+=e.getIconImage()+SPACE+e.getName()})),t}},a){if(Utils.mouseIsDown=!0,!t.preventDefault)return t.returnValue=!1,!1;t.preventDefault()}})),t.mouseover((function(t){let i="#C6E2FF";if(a($(this)))return void(Utils.mouseIsDown&&Utils.entryDragInfo&&$(this).css("background",i));let n=e[$(this).attr("entryid")];if(n&&Utils.mouseIsDown&&Utils.entryDragInfo){if(Utils.entryDragInfo.hasEntry(n))return;$(this).css("background",i)}})),t.mouseout((function(t){if(Utils.entryDragInfo){if(a($(this)))return void $(this).css("background","");let t=e[$(this).attr("entryid")];if(Utils.entryDragInfo.entry==t)return;$(this).css("background","")}})),t.mouseup((function(t){if(!Utils.entryDragInfo)return;if($(this).css("background",""),a($(this))){let t=RamaddaUtil.getUrl("/entry/getentries?output="+$(this).attr("target-type"));return Utils.entryDragInfo.getIds().split(",").forEach((e=>{t+="&selentry="+e})),void(document.location=t)}let i=e[$(this).attr("entryid")];i&&(Utils.entryDragInfo.hasEntry(i)||Utils.entryDragInfo.hasEntry(i)||(url=RamaddaUtil.getUrl("/entry/copy?action=action.move&from="+Utils.entryDragInfo.getIds()+"&to="+i.getId()),document.location=url))}))},initFormTags:function(t){let e=$("#"+t),i=e.find(".metadata-tag-input");e.attr("autocomplete","off"),i.attr("autocomplete","off"),i.keyup((function(t){HtmlUtils.hidePopupObject();let e=$(this).val();if(""==e)return;let i=HU.getUrl(RamaddaUtil.getUrl("/metadata/suggest"),["value",e.trim()]),a=$(this);$.getJSON(i,(t=>{if(0==t.length)return;let e="";t.forEach((t=>{e+=HU.div([CLASS,"ramadda-clickable metadata-suggest","suggest",t],t)}));let i=HU.div([CLASS,"ramadda-search-popup",STYLE,HU.css("max-width","200px","padding","4px")],e);HU.makeDialog({content:i,my:"left top",at:"left bottom",anchor:a}).find(".metadata-suggest").click((function(){HtmlUtils.hidePopupObject(),a.val($(this).attr("suggest"))}))})).fail((t=>{console.log("url failed:"+i+"\n"+t)}))}));let a=$("#"+t).find(".metadata-tag");a.attr("title","Click to remove"),a.click((function(){let t=e.find("#"+$(this).attr("metadata-id"));$(this).hasClass("metadata-tag-deleted")?($(this).removeClass("metadata-tag-deleted"),t.val("")):($(this).addClass("metadata-tag-deleted"),t.val("delete"))}))},initFormUpload:function(t,e){let i=$("#"+t),a=i.closest("form"),n=HU.div([TITLE,"Click to select a file",ID,t+"_filewrapper",CLASS,"fileinput_wrapper"],HU.getIconImage("fas fa-cloud-upload-alt")+" "+HU.div([ID,t+"_filename",CLASS,"fileinput_label"]));i.after(n),i.hide();let l=$("#"+t+"_filewrapper");$("#"+t+"_filename");l.click((()=>{i.trigger("click")}));let r=()=>{let e=i[0].files?i[0].files[0]:null,a=e?e.name:i.val(),n=a.lastIndexOf("\\");n<0&&(n=a.lastIndexOf("/")),n>=0&&(a=a.substring(n+1)),e&&(a=a+" ("+Utils.formatFileLength(e.size)+")"),""==a&&(a=HU.span([CLASS,"fileinput_label_empty"],"Please select a file")),$("#"+t+"_filename").html(a)};if(i.bind("change",r),r(),Utils.stringDefined(e)){let i=$("#"+e),n={files:{},cnt:0,added:!1};i.append(HU.div([CLASS,"ramadda-dnd-target-files",ID,t+"_dnd_files"]));let l=$("#"+t+"_dnd_files");Utils.initDragAndDrop(i,(t=>{}),(t=>{}),((e,i,r,s)=>{n.cnt++;let o=i.name;if(!o){let t=i.type&&i.type.match("image/.*");if(o=prompt("Entry file name:",t?"image":"file"),!o)return;if(i.type)if("text/plain"==i.type)o.endsWith(".txt")||(o+=".txt");else{o=o+"."+i.type.replace(/.*\//,"")}}let d=t+"_list"+n.cnt,c=t+"_file"+n.cnt,h=t+"_file_name"+n.cnt,m="upload_file_"+n.cnt,p="upload_name_"+n.cnt;n.files[c]=r;let u=HU.span([CLASS,"ramadda-clickable",ID,d+"_trash"],HU.getIconImage(icon_trash)),g=Utils.isDefined(i.size)?Utils.formatFileLength(i.size):"";l.append(HU.div([ID,d],u+" "+o+" "+g)),a.append(HU.tag("input",["type","hidden","name",m,"id",c])),a.append(HU.tag("input",["type","hidden","name",p,"id",h])),$("#"+c).val(r),$("#"+h).val(o),$("#"+d+"_trash").click((function(){$("#"+d).remove(),$("#"+c).remove(),$("#"+h).remove()}))}),null,!0)}},handleDropEvent:function(t,e,i,a,n,l){let r,s=e.type.match("^image.*"),o=RamaddaUtil.getUrl("/entry/addfile"),d=e.name??"file",c=e.name;r="text/plain"==e.type?"txt":e.type.replace(/image\//,""),c||(c=d+"."+r);d=Utils.makeLabel(d.replace(/.[^\.]*$/,"")),d=e.name?prompt("Dropped file: "+c+"\nNew entry name:",d):prompt("Copied file: "+r+"\nNew entry name:",d),d&&(()=>{e.name||(c=Utils.makeId(d)+"."+r);let t,h=new FormData;h.append("filename",c),n&&h.append("authtoken",n),"application/zip"==e.type?h.append("filetype","geo_shapefile"):"application/json"==e.type?h.append("filetype","geo_geojson"):h.append("filetype",e.type),h.append("name",d),h.append("group",a),h.append("description",""),h.append("file",i),$.ajax({url:o,cache:!1,contentType:!1,processData:!1,method:"POST",type:"POST",data:h,success:e=>{t.remove(),"ok"==e.status?l&&l(e,e.entryid,e.name,s):alert("An error occurred creating entry: "+e.message)},error:function(e){t.remove(),alert("An error occurred creating entry: "+e)}});let m=HU.div(["style",HU.css("text-align","center","padding","5px")],"Creating entry<br>"+HU.image(ramaddaCdn+"/icons/mapprogress.gif",["width","50px"]));t=HU.makeDialog({content:m,anchor:$(document),my:"center top",at:"center top+100"})})()},inherit:function(t,e){return $.extend(t,e),e.getThis=function(){return t},t.getThis=function(){return t},t.mysuper=e,t},initMembers:function(t,e){return $.extend(t,e),t},defineMembers:function(t,e){return $.extend(t,e),t},showEntryPopup:function(t,e,i){let a=RamaddaUtils.contents[e];if(a)RamaddaUtils.showEntryPopupInner(t,e,i,a);else{let a=RamaddaUtil.getUrl("/entry/menu?entryid="+e);$.ajax({url:a,dataType:"text",success:function(a){RamaddaUtils.contents[e]=a,RamaddaUtils.showEntryPopupInner(t,e,i,a)}}).fail(((t,e,i)=>{console.log("/entry/menu failed:"+i),alert("Failed to contact the server")}))}},showEntryPopupInner:function(t,e,i,a){let n=$("#"+t);HU.makeDialog({content:a,my:"left top",at:"left bottom",title:i,anchor:n,draggable:!0,header:!0,inPlace:!1,headerRight:null})},initEntryListForm:function(t){let e=Utils.entryGroups[t];e&&(e.on=0,e.setVisbility())},hideEntryPopup:function(){HtmlUtils.getTooltip().hide()},originalImages:new Array,changeImages:new Array,folderClick:function(t,e,i){console.log(e),RamaddaUtil.changeImages[t]=i;let a=$("#"+t);if(0==a.length)return;let n=$("#img_"+t);"none"!=a.css("display")?(i&&n.html(HU.getIconImage("fa-caret-right")),a.hide()):(RamaddaUtil.originalImages[t]=n.html(),a.show(),n.html(HU.getIconImage("fa-caret-down")),(e+="&orderby=entryorder&ascending=true").startsWith("/")&&RamaddaUtil.currentRamaddaBase&&(e=RamaddaUtil.currentRamaddaBase+e),GuiUtils.loadXML(e,RamaddaUtil.handleFolderList,t))},handleFolderList:function(request,uid){if(null!=request.responseXML){let xmlDoc=request.responseXML.documentElement,script,html;for(i=0;i<xmlDoc.childNodes.length;i++){let t=xmlDoc.childNodes[i];"javascript"==t.tagName?script=getChildText(t):"content"==t.tagName&&(html=getChildText(t))}html||(html=getChildText(xmlDoc)),html&&($("#"+uid).html("<div>"+html+"</div>"),Utils.checkTabs(html)),script&&eval(script)}RamaddaUtil.changeImages[uid]?$("#img_"+uid).attr("src",icon_folderopen):$("#img_"+uid).attr("src",RamaddaUtil.originalImages[uid])},Components:{init:function(t){let e=$("#"+t),i=$("#"+t+"_header"),a=!1,n=!1,l=e.find(".ramadda-component"),r={},s={},o={};l.each((function(){let t=$(this).attr("component-date");if(!t)return;let e,i=Utils.parseDate(t);$(this).attr("component-day",e=Utils.formatDateWithFormat(i,"mmmm d yyyy")),o[e]=!0,$(this).attr("component-month",e=Utils.formatDateWithFormat(i,"mmmm yyyy")),s[e]=!0,$(this).attr("component-year",e=Utils.formatDateWithFormat(i,"yyyy")),r[e]=!0,$(this).attr("component-latitude")&&(n=!0),Utils.stringDefined($(this).attr("component-tags"))&&(a=!0)})),i.css("text-align","center");let d=HU.div([STYLE,HU.css("display","inline-block"),CLASS,"ramadda-button ramadda-button-bar ramadda-button-on","layout","grid"],"Grid");Object.keys(r).length>1&&(d+=HU.div([STYLE,HU.css("display","inline-block"),CLASS,"ramadda-button ramadda-button-bar","layout","year"],"Year")),Object.keys(s).length>1&&(d+=HU.div([STYLE,HU.css("display","inline-block"),CLASS,"ramadda-button ramadda-button-bar","layout","month"],"Month")),Object.keys(o).length>1&&(d+=HU.div([STYLE,HU.css("display","inline-block"),CLASS,"ramadda-button ramadda-button-bar","layout","day"],"Day")),d+=HU.div([STYLE,HU.css("display","inline-block"),CLASS,"ramadda-button ramadda-button-bar","layout","title"],"Title"),a&&(d+=HU.div([STYLE,HU.css("display","inline-block"),CLASS,"ramadda-button ramadda-button-bar","layout","tags"],"Tag")),d+=HU.div([STYLE,HU.css("display","inline-block"),CLASS,"ramadda-button ramadda-button-bar","layout","author"],"Author"),n&&(d+=HU.div([STYLE,HU.css("display","inline-block"),CLASS,"ramadda-button ramadda-button-bar","layout","map"],"Map")),i.append(HU.div([],d));let c=i.find(".ramadda-button");c.click((function(){c.removeClass("ramadda-button-on"),$(this).addClass("ramadda-button-on");let t=$(this).attr("layout");"grid"==t?RamaddaUtil.Components.layout(e,l,null):RamaddaUtil.Components.layout(e,l,"component-"+t)}))},layout:function(t,e,i){if(t.find(".ramadda-group").each((function(){$(this).detach()})),t.mapId&&$("#"+t.mapId).detach(),t.ramaddaMap&&(ramaddaMapRemove(t.ramaddaMap),t.ramaddaMap=null),null==i)return e.show(),void e.each((function(){$(this).detach(),t.append($(this))}));if("component-map"==i){e.hide();let i=Utils.getUniqueId();t.mapId=i,t.append(HU.div([ID,i,STYLE,HU.css("width","100%","height","400px")]));let a=new RepositoryMap(i,{});t.ramaddaMap=a,a.initMap(!1),e.each((function(){let t=$(this).attr("component-url"),e=+$(this).attr("component-latitude"),i=+$(this).attr("component-longitude");if(!Utils.isNumber(e))return;let n=$(this).attr("component-image"),l=HU.center(HU.b($(this).attr("component-title")));n&&(l+=HU.image(n,[WIDTH,"300px"])),t&&(l=HU.href(t,l));let r=new MapUtils.createLonLat(i,e);a.addPoint("",r,{pointRadius:6,strokeWidth:1,strokeColor:"#000",fillColor:"blue"},l)})),a.centerOnMarkers()}else{e.show();let a="component-day"==i||"component-month"==i||"component-year"==i,n=[],l={};e.each((function(){let t=$(this).attr(i)||"";if("component-tags"==i){let e=t.split(",");t=e[0]}if(!l[t]){l[t]=[];if(a){let e=$(this).attr("component-date"),i=e?Utils.parseDate(e):null;n.push([t,i])}else n.push(t)}l[t].push($(this))})),n=a?n.sort(((t,e)=>(t=t[1],e=e[1],t&&e?t?e?e.getTime()-t.getTime():-1:1:0))):n.sort(),n.forEach((e=>{a&&(e=e[0]);let i=t.append($(HU.div([CLASS,"ramadda-group"],HU.div([CLASS,"ramadda-group-header"],e))));l[e].forEach((t=>{i.append(t)}))}))}}}};function EntryRow(t,e,i,a,n,l){l||(l={showIcon:!0}),this.args=l,l.entryId=t,Utils.globalEntryRows[t]=this,Utils.globalEntryRows[e]=this,Utils.globalEntryRows[i]=this,this.entryId=t,this.showIcon=l.showIcon,this.onColor="#FFFFCC",this.overColor="#f4f4f4",this.rowId=e,this.cbxId=i,this.cbxWrapperId=a,this.showDetails=n,this.getRow=function(){return $("#"+this.rowId)},this.getCbx=function(){return $("#"+this.cbxId)};let r=this.getCbx().closest("form");if(r.length){let t=Utils.entryGroups[r.attr("id")];t&&t.addEntryRow(this)}else this.getCbx().hide();this.setCheckbox=function(t){this.getCbx().prop("checked",t),this.setRowColor()},this.isSelected=function(){return this.getCbx().is(":checked")},this.setRowColor=function(){this.getRow().removeClass("entry-row-hover"),this.isSelected()?this.getRow().addClass("entry-list-row-selected"):this.getRow().removeClass("entry-list-row-selected")},this.mouseOver=function(t){$("#entrymenuarrow_"+e).attr("src",icon_menuarrow),this.getRow().addClass("entry-row-hover")},this.mouseOut=function(t){$("#entrymenuarrow_"+e).attr("src",icon_blank),this.setRowColor()},this.mouseClick=function(e){eventX=GuiUtils.getEventX(e);let i=this.getRow().offset();if(eventX-i.left<150)return;this.lastClick=eventX;let a=RamaddaUtil.getUrl("/entry/show?entryid="+t+"&output=metadataxml");this.showDetails?a+="&details=true":a+="&details=false",this.showIcon?a+="&showIcon=true":a+="&showIcon=false",GuiUtils.loadXML(a,this.handleTooltip,this)},this.handleTooltip=function(t,e){let i=t.responseXML.documentElement;text=getChildText(i);let a=e.getRow().offset().left,n=(e.lastClick,HU.jsLink("",HU.getIconImage(icon_close),["onmousedown","RamaddaUtil.hideEntryPopup();","id","tooltipclose"])),l=HU.image(e.args.icon)+SPACE+e.args.name,r=HU.div([CLASS,"ramadda-popup-header"],n+SPACE2+l),s=HU.div([CLASS,"ramadda-popup",STYLE,"display:block;"],r+"<table>"+text+"</table>"),o=HtmlUtils.getTooltip();o.html(s),o.draggable(),Utils.checkTabs(text);let d=e.getRow().offset(),c=(e.getRow().outerWidth(),e.getRow().outerHeight()),h=HtmlUtils.getTooltip().outerWidth(),m=$(window).width(),p=e.lastClick;e.lastClick+h>m&&(p-=e.lastClick+h-m);let u=p+"px",g=3+d.top+c+"px";o.css({position:"absolute",zIndex:5e3,left:u,top:g}),o.show()}}var selectors=new Array;function Selector(t,e,i,a,n,l,r,s,o){let d=this;this.id=e,this.domId=HU.getUniqueId("selector_"),this.props=o||{},this.elementId=i,this.localeId=l,this.entryType=r,this.allEntries=a,this.selecttype=n,this.textComp=GuiUtils.getDomObject(this.elementId),this.ramaddaUrl=s||ramaddaBaseUrl,this.getTextComponent=function(){let t="#"+this.elementId;return $(t)},this.getHiddenComponent=function(){let t="#"+this.elementId+"_hidden";return $(t)},this.cancel=function(t){!t&&this.pinned||jqid(this.domId).remove()},this.clearInput=function(){this.getHiddenComponent().val(""),this.getTextComponent().val("")},this.handleClick=function(t){let e=this.props.anchor;if(!e){if(this.props.eventSourceId&&(e=jqid(this.props.eventSourceId)),null!=e&&0!=e.length||t&&t.target&&(e=$(t.target)),null==e||0==e.length){let t=this.id+"_selectlink";e=jqid(t)}null!=e&&0!=e.length||(e=jqid(this.id))}HtmlUtils.hidePopupObject(t);let i=$(HU.div(["style","position:relative;"])).appendTo("body");$(HU.div(["style",HU.css("min-width","200px","min-height","200px"),"class","ramadda-selectdiv","id",this.domId])).appendTo(i),this.div=jqid(this.domId),this.props.minWidth&&this.div.css("min-width",this.props.minWidth),this.div.draggable(),this.anchor=e,this.showDiv=()=>{this.div.show(),this.div.position({of:this.anchor,my:this.props.locationMy??"left top",at:this.props.locationAt??"left bottom",collision:this.props.collision??"fit fit"})};let a="/entry/show?output=selectxml&selecttype="+this.selecttype+"&allentries="+this.allEntries+"&target="+this.id+"&noredirect=true&firstclick=true";if(this.ramaddaUrl&&!this.ramaddaUrl.startsWith("/")){let t=new URL(this.ramaddaUrl).pathname,e=this.ramaddaUrl.replace(t,"");RamaddaUtil.currentRamaddaBase=e,a=this.ramaddaUrl+a}else RamaddaUtil.currentRamaddaBase=null,a=RamaddaUtil.getUrl(a);return this.localeId&&(a=a+"&localeid="+this.localeId),this.entryType&&(a=a+"&entrytype="+this.entryType),this.props.typeLabel&&(a=a+"&typelabel="+this.props.typeLabel),GuiUtils.loadXML(a,((t,e)=>{d.handleSelect(t,e)}),this.id),!1},this.handleClick(t)}function getChildText(t){let e="";for(childIdx=0;childIdx<t.childNodes.length;childIdx++)e+=t.childNodes[childIdx].nodeValue;return e}function toggleBlockVisibility(t,e,i,a){HtmlUtils.toggleBlockVisibility(t,e,i,a)}function toggleInlineVisibility(t,e,i,a){let n,l=GuiUtils.getDomObject(e);toggleVisibility(t,"inline"),n=jqid(t).is(":visible")?i:a,StringUtil.startsWith(n,"fa-")?$("#"+e).attr("class",n):l&&(l.obj.src=n),Utils.ramaddaUpdateMaps()}function toggleVisibility(t,e,i){let a=$("#"+t).css("display");return $("#"+t).toggle(i),"block"!=a}function hide(t){$("#"+t).hide()}function hideObject(t){return t?($("#"+t.id).hide(),1):0}function showObject(t,e){if(!t)return 0;$("#"+t.id).show()}function toggleVisibilityOnObject(t,e){if(!t)return 0;$("#"+t.id).toggle()}Selector.prototype={handleSelect:function(t,e){let i=this,a=t.responseXML.documentElement;text=getChildText(a);let n=this.domId+"-pin",l=HU.jsLink("",HtmlUtils.getIconImage(icon_pin),["class","ramadda-popup-pin","id",n]),r=HtmlUtils.getIconImage(icon_close,[]),s=e+"_close",o=HU.span(["id",s,"class","ramadda-clickable"],r),d=(this.props?this.props.title:"")??"",c=(this.props?this.props.extra:"")??"";Utils.stringDefined(d)&&(d=HU.span(["style","margin-left:5px;"],d));let h=HtmlUtils.div(["style","text-align:left;","class","ramadda-popup-header"],SPACE+o+SPACE+l+d),m=HtmlUtils.div(["id",e+"-popup"],h+c+text);this.div.html(m),this.showDiv(),jqid(s).click((()=>{this.cancel(!0)})),$("#"+n).click((function(){i.pinned=!i.pinned,i.pinned?$(this).addClass("ramadda-popup-pin-pinned"):$(this).removeClass("ramadda-popup-pin-pinned")})),this.props&&this.props.initCallback&&this.props.initCallback()}};
