var RamaddaUtils,RamaddaUtil,Ramadda=RamaddaUtils=RamaddaUtil={entryListeners:[],addEntryListener:function(t){this.entryListeners.push(t)},handleEntrySelect:function(t,e){this.entryListeners.forEach((a=>{a(t,e)}))},contents:{},currentRamaddaBase:null,currentSelector:null,captureScreen:function(t){if(!confirm("Do you want to create a thumbnail image of the screen?"))return;let e=RamaddaUtil.getCdnUrl("/lib/html2canvas.min.js");Utils.importJS(e,(()=>{RamaddaUtil.hideEntryPopup();let e=document.body;html2canvas(e,{userCORS:!0,allowTaint:!0}).then((function(e){const a=document.createElement("canvas"),i=a.getContext("2d");a.width=e.width+20,a.height=e.height+20,i.drawImage(e,0,0),i.fillStyle="white",i.fillRect(0,0,a.width,a.height),i.strokeStyle="#ccc",i.lineWidth=10,i.strokeRect(0,0,a.width,a.height),i.drawImage(e,10,10);let n=a.toDataURL("image/png"),r=new FormData;r.append("addthumbnail","true"),r.append("filename","screencapture.png"),r.append("file",n),r.append("entryid",t);let l=RamaddaUtil.getUrl("/entry/addfile");$.ajax({url:l,cache:!1,contentType:!1,processData:!1,method:"POST",type:"POST",data:r,success:t=>{if("ok"!=t.status)return void alert("An error occurred creating entry: "+t.message);let e=t.message+"<br>"+HU.image(t.imageurl,[ATTR_WIDTH,HU.px(600)]);HU.makeDialog({content:e,my:"left top",at:"left top",title:"",anchor:$("body"),draggable:!0,header:!0,inPlace:!1,stick:!0})},error:function(t){alert("An error occurred creating entry: "+t)}})}))}))},initToggleTable:function(container){$(container).find(".entry-arrow").click((function(){let url=$(this).attr("data-url");if(!url)return;let title=$(this).attr("data-title")??"",handler=request=>{if(null==request.responseXML)return;let xmlDoc=request.responseXML.documentElement,script,html;for(i=0;i<xmlDoc.childNodes.length;i++){let t=xmlDoc.childNodes[i];"javascript"==t.tagName?script=getChildText(t):"content"==t.tagName&&(html=getChildText(t))}if(html||(html=getChildText(xmlDoc)),html){html=HU.div([ATTR_STYLE,HU.css(CSS_MARGIN,HU.px(5),CSS_MAX_HEIGHT,HU.px(300),CSS_OVERFLOW_Y,"auto")],html);let t=HU.makeDialog({content:html,my:"left top",at:"left bottom",title:title,anchor:this,draggable:!0,header:!0,inPlace:!1,stick:!0});Utils.checkTabs(html)}script&&eval(script)};GuiUtils.loadXML(url,handler)}))},handleEntryCreated:function(t,e,a){if(!window.opener)return void console.log("RamaddaUtils.handleEntryCreated: no opener");let i=window.opener.document.getElementById(t),n=window.opener.document.getElementById(t+"_hidden");i&&n?(i.val?i.val(a):i.value=a,n.val?n.val(e):n.value=e,i.title&&setTimeout((()=>{alert("Entry ID has been set for "+i.title)}),1e3)):console.log("RamaddaUtils.handleEntryCreated: could not find entry widget:"+t)},selectInitialClick:function(t,e,a,i,n,r,l,s,o){return RamaddaUtils.currentSelector&&RamaddaUtils.currentSelector.cancel(),RamaddaUtils.currentSelector=RamaddaUtils.selectCreate(t,e,a,i,n,r,l,s,o),!1},selectCreate:function(t,e,a,i,n,r,l,s,o){let d=e+(s??"");return selectors[e]=selectors[d]=new Selector(t,e,a,i,n,r,l,s,o)},clearSelect:function(t){if(selector=selectors[t],selector)selector.clearInput();else{let e=GuiUtils.getDomObject(t),a=GuiUtils.getDomObject(t+"_hidden");a&&(a.obj.value=""),e&&(e.obj.value="")}},viewSelect:function(t){let e=GuiUtils.getDomObject(t+"_hidden");if(e){let t=e.obj.value;if(Utils.stringDefined(t)){let e=RamaddaUtils.getEntryUrl(t);window.open(e,"_blank")}}},selectorRamaddas:{},initEntryPopup:function(t,e,a,i){let n=e=>t+e,r=HU.input("","",[ATTR_ID,n("_input"),ATTR_CLASS,"input",ATTR_PLACEHOLDER,"Search",ATTR_STYLE,HU.css(CSS_WIDTH,HU.px(250))]);r+=SPACE+HU.span([ATTR_CLASS,"ramadda-clickable",ATTR_TITLE,"Submit search",ATTR_ID,n("button")],HU.getIconImage("fas fa-magnifying-glass"));let l=!Utils.stringDefined(a);!l&&i&&(l=!0),l&&(r+=HU.div([ATTR_ID,n("types")]));let s=r+HU.div([ATTR_CLASS,"ramadda-select-search-results",ATTR_ID,t+"_results"]);if($("#"+t).html(s),l){let t=t=>{let e=[],a="",i=[],r={};t.forEach((t=>{t.getCategory()!=a&&(a=t.getCategory());let e=r[a];e||(i.push(a),r[a]=e=[]);let n={value:t.id,label:t.label,corpus:t.getSuperCategory()+" - "+t.getCategory()};e.push(n)})),i.forEach((t=>{e.push({category:t}),e=Utils.mergeLists(e,r[t])})),e.unshift({value:"",label:"Select entry type"});let l=n("types_select"),s=HU.select("",[ATTR_STYLE,HU.css(CSS_MAX_WIDTH,HU.px(250),CSS_MARGIN_TOP,HU.px(4)),ATTR_ID,l],e);s=HU.vspace()+s,jqid(n("types")).html(s),HtmlUtils.makeSelectTagPopup("#"+l,{after:!0,icon:!0,single:!0,showCategories:!0}),HU.initSelect("#"+l)},e=a??"",i=this.selectorRamaddas[e];i||(i=this.selectorRamaddas[e]=getGlobalRamadda(!0));let r=i.getEntryTypes(((e,a)=>{t(a)}),a);r&&t(r)}let o=jqid(n("_input")),d=()=>{let t=o.val()??"",i=ramaddaBaseUrl+"/search/do?orderby=createdate&ascending=false&text="+encodeURIComponent(t)+"&output=json",r=a;if(l){let t=jqid(n("types_select")).val();Utils.stringDefined(t)&&"any"!=t&&(r=t)}Utils.stringDefined(r)&&(i=HU.url(i,["type",r])),c.html(HU.getIconImage(icon_wait)+" Searching..."),c.show();let s={entryListChanged:function(t){let a=t.getEntries();if(0==a.length)return c.show(),void c.html("Nothing found");let i="";a.forEach(((t,e)=>{let a="Type: "+t.getTypeName()+HU.BR_ENTITY+"Parent: "+t.getParentName();i+=HU.div([ATTR_INDEX,e,ATTR_TITLE,a,ATTR_CLASS,"ramadda-clickable ramadda-entry"],t.getIconImage()+" "+t.getName())})),c.html(i),c.find(".ramadda-entry").click((function(){let t=a[$(this).attr(ATTR_INDEX)];t&&RamaddaUtils.selectClick(e,t.getId(),t.getName(),{entry:t,entryName:t.getName(),isImage:t.getIsImage(),thumbnailUrl:t.getThumbnail(),icon:t.getIconUrl(),entryType:t.getType().id,north:t.getNorth(),west:t.getWest(),south:t.getSouth(),east:t.getEast()})})),c.show(400)},handleSearchError:function(t,e){c.html("An error occurred:"+e)}};new EntryList(getGlobalRamadda(),i,s,!1).doSearch()};jqid(n("button")).click(d);let c=$("#"+t+"_results");o.keyup((function(t){let e=$(this).val();if(!Utils.isReturnKey(t)&&""==e)return c.hide(),void c.html("");13==(t.keyCode?t.keyCode:t.which)&&d()}))},selectClick:function(t,e,a,i){selector=selectors[t];let n=getHandler(t);if(n||(n=getHandler(selector.elementId)),n)return n.selectClick(selector.selecttype,t,e,a,i),void selector.cancel();if("wikilink"==selector.selecttype){let t={entryId:e,name:a};i&&$.extend(t,i),WikiUtil.insertAtCursor(selector.elementId,selector.textComp.obj,t)}else if("fieldname"==selector.selecttype)WikiUtil.insertAtCursor(selector.elementId,selector.textComp.obj,a);else if("image"==selector.selecttype)WikiUtil.insertAtCursor(selector.elementId,selector.textComp.obj,'{{image entry="'+e+'" caption="'+a+'" width=400px align=center}} ');else if("entryid"==selector.selecttype){let t=WikiUtil.getWikiEditor(selector.elementId);t?t.insertTags(e," ","importtype"):selector.props&&selector.props.callback?selector.props.callback(e,i):WikiUtil.insertText(selector.elementId,e,!0)}else"entry:entryid"==selector.selecttype?WikiUtil.getWikiEditor(selector.elementId).insertTags("entry:"+e," ","importtype"):(selector.getHiddenComponent().val(e),selector.getTextComponent().val(a));selector.cancel()},getBaseUrl:function(){return ramaddaBaseUrl},isRamaddaUrl:function(t){return t.startsWith(ramaddaBaseUrl)},getUrl:function(t){return RamaddaUtil.getBaseUrl()+t},getCdnUrl:function(t){return ramaddaCdn+t},getEntryUrl:function(t){return RamaddaUtil.getUrl("/entry/show?entryid="+t)},fileDrops:{},doSave:function(t,e,a,i,n){(a=a||{}).entryid=t,a.authtoken=e,a.response="json";let r=RamaddaUtil.getUrl("/entry/change");$.post(r,a,(t=>{i&&i(t)})).fail((t=>{try{let e=JSON.parse(t.responseText);if(e.error)return void(t?t(e.error):alert("Error:"+e.error))}catch(t){}n?n(t.responseText):alert("Error:"+t.responseText)}))},initEntryTable:function(t,e,a){e=e||{};let i={};Utils.isDefined(e.details)&&0==e.details&&(e.simple=!0);let n=e.simple,r=!n,l=null!=e.columns,s={actions:[],showName:!0,showCrumbs:!1,showCreator:l,showHeader:r,showDownload:l,showTime:l,showDate:l||r,showCreateDate:l||r,showChangeDate:l,showSize:l||r,showEntryOrder:l,showType:l||r,showAttachments:!1,showIcon:r,showThumbnails:r,showArrow:r,showForm:r,formOpen:!1,inlineEdit:!1,metadataDisplay:null};$.extend(s,e),this.props=s;let o=a.map(((t,e)=>{let a=new Entry(t);return i[a.getId()]=a,a})),d="",c=[],h=Utils.split(s.columns??"name,entryorder,creator,date,time,createdate,download,size,type,attachments",",",!0,!0);h.forEach((t=>{"name"==t&&s.showName?c.push({id:"name",label:"Name",width:s.nameWidth}):"date"==t&&s.showDate?c.push({id:"fromdate",label:"Date",width:s.fromDateWidth??s.dateWidth??130}):"geo"==t?(c.push({id:"latitude",label:"Latitude",width:100}),c.push({id:"longitude",label:"Longitude",width:100}),c.push({id:"altitude",label:"Altitude",width:100})):"altitude"==t?c.push({id:"altitude",label:"Altitude",width:100}):"latlon"==t?(c.push({id:"latitude",label:"Latitude",width:100}),c.push({id:"longitude",label:"Longitude",width:100})):"createdate"==t&&s.showCreateDate?c.push({id:t,label:"Create Date",width:s.createDateWidth??s.dateWidth??130}):"download"==t&&s.showDownload?c.push({id:t,label:"&nbsp;Download&nbsp;",width:100,align:"left"}):"time"==t&&s.showTime?c.push({id:t,label:"&nbsp;Time&nbsp;",width:100,align:"right"}):"creator"==t&&s.showCreator?c.push({id:t,label:"Creator",width:s.creatorWidth??200}):"entryorder"==t&&s.showEntryOrder?c.push({id:t,label:"Order",width:75}):"changedate"==t&&s.showChangeDate?c.push({id:t,label:"Change Date",width:s.changeDateWidth??s.dateWidth??130}):"size"==t&&s.showSize?c.push({id:t,label:"Size",width:s.sizeWidth??80}):"type"==t&&s.showType?c.push({id:t,label:"Type",align:"left",paddingLeft:HU.px(10),width:s.typeWidth??100}):"attachments"==t&&s.showAttachments&&c.push({id:t,label:"Attachments",align:"left",paddingLeft:HU.px(10),width:s.attachmentsWidth??240})}));let T=s.tableWidth??"100%";if(s.showHeader){d+=HU.open(TAG_TABLE,[ATTR_CELLSPACING,"0",ATTR_CELLPADDING,"0",ATTR_CLASS,"entry-list-header",ATTR_WIDTH,T]);let e=[ATTR_CLASS,"entry-list-header-column ramadda-clickable"];c.forEach(((a,i)=>{let n=e,r=a.width;0==i&&s.showForm&&(d+=HU.td([ATTR_STYLE,HU.css(CSS_PADDING_LEFT,HU.px(3),CSS_WIDTH,HU.px(10))],HU.div([ATTR_STYLE,HU.css(CSS_WIDTH,HU.px(15)),ATTR_ID,t+"_formarrow",ATTR_TITLE,"Click to show entry form",ATTR_CLASS,"ramadda-clickable"],HU.getIconImage("fas fa-caret-right"))),r-=10),Utils.isDefined(a.width)&&(n=Utils.mergeLists(n,[ATTR_WIDTH,a.width])),n.push(ATTR_STYLE,HU.css(CSS_PADDING_LEFT,a.paddingLeft??HU.px(0))),n=Utils.mergeLists(n,["orderby","download"==a.id?"size":a.id,ATTR_TITLE,"Sort by "+("download"==a.id?"Size":a.label)]);let l=a.label;l=HU.span([ATTR_STYLE,this.props.headerStyle??""],l),(a.id==s.orderby||"size"==s.orderby&&"download"==a.id)&&Utils.isDefined(s.ascending)&&(l=s.ascending?HU.getIconImage("fas fa-arrow-up")+SPACE+HU.span([],l):HU.getIconImage("fas fa-arrow-down")+SPACE+HU.span([],l)),d+=HU.td(n,l)})),d+=HU.close(TAG_TABLE)}else n||(d+=HU.div([ATTR_CLASS,"entry-list-noheader"]));let m,p=Utils.getUniqueId(),u=Utils.getUniqueId(),g=n?"entry-list-simple":"entry-list",U=[ATTR_ID,p,ATTR_CLASS,g];if(s.showHeader&&s.tableWidth&&U.push(ATTR_STYLE,HU.css(CSS_WIDTH,s.tableWidth)),d+=HU.open(TAG_DIV,U),s.showForm){m=HU.getUniqueId("form_"),d+=HU.open(TAG_FORM,[ATTR_ID,m,ATTR_METHOD,"post",ATTR_ACTION,RamaddaUtil.getUrl("/entry/getentries")]);let e=HU.checkbox("",[ATTR_STYLE,HU.css(CSS_MARGIN_LEFT,HU.px(3)),ATTR_TITLE,"Toggle all",ATTR_ID,t+"_form_cbx"],!1),a=[["","Apply action"]];s.actions.forEach((t=>{a.push([t.id,t.label])})),e+=SPACE1,e+=HU.select("",[ATTR_NAME,"output",ATTR_ID,t+"_form_action"],a),e+=SPACE1,e+=HU.open(TAG_INPUT,[ATTR_NAME,"getselected",ATTR_TYPE,"submit",ATTR_VALUE,"Selected",ATTR_CLASS,"submit ui-button ui-corner-all ui-widget",ATTR_ID,"getselected1338","role","button"]),e+=SPACE1,e+=HU.open(TAG_INPUT,[ATTR_NAME,"getall",ATTR_TYPE,"submit",ATTR_VALUE,"All",ATTR_CLASS,"submit ui-button ui-corner-all ui-widget",ATTR_ID,"getall1337","role","button"]),d+=HU.div([ATTR_CLASS,g+"-row",ATTR_ID,t+"_form",ATTR_STYLE,HU.css(CSS_DISPLAY,"none",CSS_WIDTH,HU.perc(100))],e)}let f=[ATTR_ID,u];s.maxHeight&&f.push(ATTR_STYLE,HU.css(CSS_MAX_HEIGHT,s.maxHeight,CSS_OVERFLOW_Y,"auto")),d+=HU.open(TAG_DIV,f),d+=HU.close(TAG_DIV,TAG_TABLE,TAG_DIV);let _=jqid(t);_.html(d),m&&jqid(m).submit((e=>{Utils.stringDefined(jqid(t+"_form_action").val())||(alert("No action specified"),e.preventDefault())})),_.find(".entry-list-header-column").click((function(){let t,e=$(this).attr("orderby");s.orderby==e?Utils.isDefined(s.ascending)?t=s.ascending?HU.addToDocumentUrl("ascending",!s.ascending):HU.addToDocumentUrl("ascending",!0):(t=HU.addToDocumentUrl("orderby",e),t=HU.addToDocumentUrl("ascending",!0)):(t=HU.addToDocumentUrl("ascending",!0),t=HU.addToDocumentUrl("orderby",e)),window.location=t})),$("#"+t+"_form_cbx").click((function(){let e=$(this).is(":checked");jqid(t).find(".entry-form-select").prop("checked",e)}));let A=jqid(t+"_formarrow"),y=()=>{s.formOpen?(jqid(t+"_form").show(),jqid(t).find(".entry-form-select").show(),A.html(HU.getIconImage("fas fa-caret-down"))):(jqid(t+"_form").hide(),jqid(t).find(".entry-form-select").hide(),A.html(HU.getIconImage("fas fa-caret-right")))};$("#"+t+"_formarrow").click((function(){s.formOpen=!s.formOpen,y()})),s.formOpen&&y(),RamaddaUtil.showEntryTable(u,s,c,t,i,(t=>{s.formOpen&&jqid(t).find(".entry-form-select").show()}),o)},formatMetadata:function(t,e,a){let i={doBigText:!0,wrapInDiv:!0};a&&(i=$.extend(i,a));let n={};e.forEach((e=>{t.getMetadata().forEach((t=>{if(!e.ok(t))return;let a=n[t.type];a||(a=n[t.type]={display:e,contents:[]});let i=e.format(t).trim(),r=!1;Utils.split(i," ").every((t=>!(t.length>50)||(r=!0,!1))),r&&(i=HU.div([ATTR_STYLE,HU.css(CSS_WORD_BREAK,"break-all")],i)),a.contents.push(i)}))}));let r="";return i.wrapInDiv?Object.keys(n).forEach((t=>{let e=n[t];e.display.delimiter?(r+=HU.open(TAG_DIV,[ATTR_CLASS,"ramadda-metadata-display"]),e.display.header&&(r+=HU.b(e.display.header+":")+" "),r+=Utils.join(e.contents,e.display.delimiter+" "),r+=HU.close(TAG_DIV)):(e.display.header&&(r+=HU.b(e.display.header+":")+" "),e.contents.forEach((t=>{r+=HU.div([ATTR_CLASS,"ramadda-metadata-display"],t)})))})):Object.keys(n).forEach((t=>{let e=n[t];r+=HU.open(TAG_DIV,[ATTR_CLASS,"ramadda-metadata-display"]),e.display.header&&(r+=HU.b(e.display.header+":")+" "),r+=Utils.join(e.contents,"; "),r+=HU.close(TAG_DIV)})),Utils.stringDefined(r)&&i.doBigText&&(r=HU.div([ATTR_CLASS,"ramadda-metadata-bigtext","bigtext-length","100"],r)),r},makeMetadataDisplay:function(t){if(!t)return null;let e=[];return Utils.split(t,",",!0,!0).forEach((t=>{let a,i,n,r,l=t.split(":");if(0==l.length)return;let s="{attr1} {attr2}";l.forEach(((t,e)=>{if(0==e)return void(r=t);let l=t.split("=");if(2!=l.length)return;let o=l[0],d=l[1];o.startsWith("attr")?n=t=>t.value[o]==d:"template"==o?s=d:"delimiter"==o?i=d:"header"==o&&(a=d)}));let o={prop:t,type:r,delimiter:i,header:a,template:s.replace("_colon_",":","_comma_",","),check:n,ok:function(t){return t.type==this.type&&(!this.check||this.check(t))},format:function(t){let e=this.template;return["attr1","attr2","attr3","attr4"].forEach((a=>{e=e.replace("{"+a+"}",t.value[a]??"")})),e}};e.push(o)})),e},getToggleIcon:function(t){return t?HU.getIconImage("fas fa-caret-down",null,[ATTR_STYLE,this.props.toggleStyle||""]):HU.getIconImage("fas fa-caret-right",null,[ATTR_STYLE,this.props.toggleStyle||""])},applyInlineEdit:function(t,e){"string"==typeof t&&(t=$(t));let a=t=>{let e=t.attr(ATTR_ENTRYID),a=t.val().trim(),i=t.attr("data-field"),n=ramaddaBaseUrl+"/entry/changefield?entryid="+e+"&what="+i+"&value="+a;if($.getJSON(n,(function(t){t.error&&alert("An error has occurred: "+t.error)})).fail((t=>{console.dir(t),alert("An error occurred:"+t)})),!event.preventDefault)return event.returnValue=!1,!1;event.preventDefault(),t.css("background","yellow"),setTimeout((()=>{t.css("background","#fff")}),4e3)},i=(t,i)=>{let n=!1,r=parseInt(t.val()),l=t.attr(ATTR_ENTRYID);e.each((function(){let t=$(this).attr(ATTR_ENTRYID);if(n)r+=i;else{if(t!=l)return;n=!0}$(this).val(r),a($(this))}))};t.each((function(){let t=$(this).prop("tagName")??"";t=t.toLowerCase(),"select"==t?$(this).change((function(){a($(this))})):$(this).keypress((function(t){if(13==t.which){if(t.shiftKey&&"entryorder"==$(this).attr("data-field")){t.preventDefault?t.preventDefault():t.returnValue=!1;let e=prompt("Do you want to reorder all of the following entries. Delta:",5);return e&&i($(this),parseInt(e)),!1}a($(this))}}))}))},showEntryTable:function(t,e,a,i,n,r,l,s){let o=$("#"+i),d="",c=e.simple?"entry-list-simple-row":"entry-list-row entry-list-row-data",h=RamaddaUtil.makeMetadataDisplay(this.props.metadataDisplay),T=!1;l.forEach(((t,i)=>{let n="",r=Utils.getUniqueId("row_"),l=Utils.getUniqueId();a.forEach(((i,s)=>{let o=s==a.length-1,d=[ATTR_CLASS,"entry-row"],c=t.getProperty(i.id,{},e.inlineEdit)??"";"number"==typeof c&&isNaN(c)&&(c="NA");let m=c;if(c=HU.span([ATTR_CLASS,this.props.textClass??"",ATTR_STYLE,this.props.textStyle??""],c),"name"==i.id){let a="";if(e.showIcon&&(a=t.getLink(t.getIconImage([ATTR_WIDTH,this.props.iconWidth??ramaddaGlobals.iconWidth]))),e.inlineEdit||(c=t.getLink(c)),e.showIcon&&(c=a+SPACE+c),h&&h.length){let e=RamaddaUtil.formatMetadata(t,h);Utils.stringDefined(e)&&(c+=HU.div([ATTR_STYLE,HU.css(CSS_MAX_WIDTH,HU.perc(100),CSS_OVERFLOW_WRAP,"break-word")],e),T=!0)}let i=[],n=Utils.getUniqueId("entry_");if(e.showForm&&i.push(HU.hidden("allentry",t.getId())+HU.checkbox(n,["rowid",r,ATTR_NAME,"selentry",ATTR_VALUE,t.getId(),ATTR_CLASS,"entry-form-select",ATTR_STYLE,HU.css(CSS_MARGIN_RIGHT,HU.px(2),CSS_DISPLAY,"none")],!1)),i.push(HU.div([ATTR_STYLE,HU.css(CSS_MARGIN_RIGHT,HU.px(2),CSS_MIN_WIDTH,HU.px(10)),"innerid",l,ATTR_ENTRYID,t.getId(),ATTR_TITLE,"Click to show contents",ATTR_CLASS,"entry-arrow ramadda-clickable"],this.getToggleIcon(!1))),e.showCrumbs&&t.breadcrumbs){let e=Utils.getUniqueId();c=HU.span([ATTR_ID,"breadcrumbtoggle_"+e,"breadcrumbid",e,ATTR_TITLE,"Show breadcrumbs",ATTR_CLASS,"ramadda-clickable ramadda-breadcrumb-toggle"],HU.getIconImage("fas fa-plus-square"))+SPACE2+HU.span([ATTR_STYLE,HU.css(CSS_DISPLAY,"none"),ATTR_ID,e],t.breadcrumbs+"&nbsp;&raquo;&nbsp;")+c}e.showThumbnails&&t.getThumbnail()&&(c+="<br>"+HU.div([ATTR_CLASS,"ramadda-thumbnail",ATTR_STYLE,HU.css(CSS_MAX_HEIGHT,HU.px(100),CSS_OVERFLOW_Y,"auto")],HU.image(t.getThumbnail(),[ATTR_LOADING,"lazy",ATTR_CLASS,"ramadda-clickable ramadda-thumbnail-image",ATTR_TITLE,"Click to enlarge",ATTR_STYLE,HU.css(CSS_WIDTH,HU.px(100)),"entry-url",t.getEntryUrl()]))),i.push(c),c=HU.table([],HU.tr([ATTR_VALIGN,"top"],HU.tds([],i)))}else{"attachments"==i.id?(c="",t.getMetadata().forEach((e=>{if("content.thumbnail"==e.type||"content.attachment"==e.type){let a,i=e.value.attr1,n=i.replace(/.*_file_/,""),r=HU.url(RamaddaUtil.getBaseUrl()+"/metadata/view/"+i,["element","1",ATTR_ENTRYID,t.getId(),"metadata_id",e.id]);if("content.thumbnail"==e.type||Utils.isImage(i))a=r,n+="<br>"+HU.image(a,[ATTR_WIDTH,HU.px(290)]).replace(/"/g,"'");else{i=i.toLowerCase();let t=null;t=i.endsWith("pdf")?"/icons/pdf.png":i.endsWith("txt")?"/icons/txt.png":"/icons/file.png",t&&(a=RamaddaUtil.getBaseUrl()+t)}a&&(c+=HU.href(r,HU.image(a,[ATTR_CLASS,"ramadda-attachment ramadda-clickable",ATTR_TITLE,n,ATTR_WIDTH,HU.px(75),ATTR_STYLE,HU.css(CSS_MARGIN,HU.px(2))])))}})),""!=c&&(c=HU.div([ATTR_STYLE,HU.css(CSS_MAX_WIDTH,HU.getDimension(i.width),CSS_OVERFLOW_X,"auto")],c))):"type"==i.id&&(c=HU.href(RamaddaUtil.getUrl("/search/type/"+t.getType().id),c,[ATTR_TITLE,Utils.delimMsg("Search for entries of type")+" "+m]));let e=i.width-20;e=i.width,c=HU.div([ATTR_STYLE,HU.css(CSS_PADDING_LEFT,i.paddingLeft??HU.px(5),CSS_WHITE_SPACE,"nowrap",CSS_WIDTH,HU.getDimension(i.width),CSS_TEXT_ALIGN,i.align??"right",CSS_MAX_WIDTH,HU.getDimension(e),CSS_OVERFLOW_X,"hidden")+(o?HU.css(CSS_PADDING_LEFT,HU.px(4)):"")],c),d.push(ATTR_ALIGN,i.align??"right")}Utils.isDefined(i.width)&&d.push(ATTR_WIDTH,HU.getDimension(i.width)),n+=HU.td(d,c)}));let s=HU.open(TAG_DIV,[ATTR_ENTRYID,t.getId(),ATTR_ID,r]);s+=HU.open(TAG_DIV,[ATTR_ENTRYID,t.getId(),ATTR_ID,r,ATTR_CLASS,c]),s+=HU.open(TAG_TABLE,[ATTR_CELLSPACING,"0",ATTR_CELLPADDING,"border",ATTR_WIDTH,"100%",ATTR_CLASS,"entry-row-table",ATTR_ENTRYID,t.getId()]);let o="",m=[ATTR_CLASS,"entry-row",ATTR_VALIGN,"top"];if(!e.simple){t.getIconImage([ATTR_WIDTH,HU.px(32)]).replace(/"/g,"'");o=t.getName(),t.remoteRepository&&m.push("remote-repository",t.remoteRepository.name);let e=t.getType();e&&m.push("data-type",e.name);let a=t.getThumbnail();a&&m.push("data-thumbnail",a);let i=t.getFilename();i&&m.push("data-filename",i),m.push(ATTR_TITLE,o,"data-icon",t.getIconUrl())}s+=HU.open(TAG_TR,m),s+=n,s+=HU.close(TAG_TR,TAG_TABLE,TAG_DIV),s+=HU.div([ATTR_ID,l,ATTR_STYLE,HU.css(CSS_MARGIN_LEFT,HU.px(20))]),s+=HU.close(TAG_DIV),d+=s})),d+=HU.close(TAG_DIV);let m=jqid(t);!s&&e.tableWidth&&m.css(ATTR_WIDTH,e.tableWidth),d=$(d).appendTo(m),Translate.translate(d),T&&d.find(".ramadda-metadata-bigtext").each((function(){Utils.initBigText($(this))}));let p=o.find(".ramadda-entry-inlineedit"),u=o.find(".ramadda-entry-inlineedit-entryorder");this.applyInlineEdit(p,u),d.find(".entry-row").tooltip({show:{effect:"slideDown",delay:1500,duration:300},position:{my:"right top",at:"right bottom"},content:function(){if($(this).hasClass("ramadda-edit-input"))return null;let t=$(this).attr(ATTR_TITLE),e=$(this).attr("data-icon"),a=$(this).attr("data-thumbnail");e&&(e=HtmlUtils.image(e,[ATTR_WIDTH,HU.px(32)]),t=e+HU.space(1)+t),t=HU.div([],HU.b(t));let i=$(this).val();i&&(t+=HU.div([],i));let n=$(this).attr("data-type");n&&(t=t+"Type: "+n+"<br>");let r=$(this).attr("data-filename");r&&(t=t+"File: "+r+"<br>");let l=$(this).attr("remote-repository");return l&&(t=t+"Remote: "+l+"<br>"),t=t+HU.div([],"Right-click to see entry menu")+HU.div([],"Shift-drag to copy/move"),a&&(a=HtmlUtils.image(a,[ATTR_WIDTH,HU.px(250)]),t+=HU.div([ATTR_STYLE,HU.css(CSS_MAX_HEIGHT,HU.px(200),CSS_OVERFLOW_Y,"hidden")],a)),HU.div([ATTR_STYLE,HU.css(CSS_MARGIN,HU.px(5))],t)}}),m.find(".ramadda-breadcrumb-toggle").click((function(){let t=$(this).attr("breadcrumbid"),e=$("#"+t);"none"==e.css("display")?($("#breadcrumbtoggle_"+t).html(HU.getIconImage("fas fa-minus-square")),e.css(CSS_DISPLAY,DISPLAY_INLINE)):($("#breadcrumbtoggle_"+t).html(HU.getIconImage("fas fa-plus-square")),e.css("display","none"))}));let g=this;if(m.find(".entry-arrow").click((function(){let t=$(this).attr(ATTR_ENTRYID),l=$(this).attr("innerid"),s=$("#"+l),o=$(this).attr("filled"),d=$(this).attr("open");if($(this).html(g.getToggleIcon(!d)),o)return void(d?(s.hide(),$(this).attr("open",!1)):(s.show(),$(this).attr("open",!0)));let c=n[t];$(this).attr("filled",!0),$(this).attr("open",!0);let h=RamaddaUtil.getUrl("/entry/show?output=json&includeproperties=false&includedescription=false&includeservices=false&children=true&entryid="+t);e.sortby&&(h=HU.url(h,["orderby",e.sortby])),e.orderby&&(h=HU.url(h,["orderby",e.orderby])),e.ascending&&(h=HU.url(h,["ascending",e.ascending])),e.sortdir&&(h=HU.url(h,["ascending","up"==e.sortdir])),$.getJSON(h,(function(t,s,o){if(GuiUtils.isJsonError(t))return;let d=t.map(((t,e)=>{let a=new Entry(t);return n[a.getId()]=a,a}));if(d.length>0)RamaddaUtil.showEntryTable(l,e,a,i,n,r,d,!0);else{let t=HU.open(TAG_TABLE,[ATTR_CLASS,"formtable"]);if(c.getIsUrl())t+=HU.formEntry("URL:",HU.href(c.getResourceUrl(),c.getResourceUrl()));else if(c.getIsFile()){let e=c.getResourceUrl();t+=HU.formEntry("File:",HU.href(e,c.getFilename())+"  ("+c.getFormattedFilesize()+") "+HU.href(e,HU.getIconImage("fas fa-download")))}t+=HU.formEntry(Utils.delimMsg("Kind"),HU.href(RamaddaUtil.getUrl("/search/type/"+c.getType().id),c.typeName,[ATTR_TITLE,Utils.delimMsg("Search for entries of type")+" "+c.typeName]));let e=RamaddaUtil.getUrl("/search/type/"+c.getType().id+"?user_id="+c.creator+"&search.submit=true"),a=HU.href(e,c.creator,[ATTR_TITLE,Utils.delimMsg("Search for entries of this type created by")+" "+c.creator]);t+=HU.formEntry(Utils.msgLabel("Created by"),a),t+=HU.formEntry(Utils.msgLabel("Created"),c.createDateFormat),c.startDate&&c.startDate.getTime()!=c.createDate.getTime()&&(t+=HU.formEntry(Utils.msgLabel("Date"),c.startDateFormat)),c.startDate&&c.endDate&&c.startDate.getTime()!=c.endDate.getTime()&&(t+=HU.formEntry(Utils.msgLabel("To Date"),c.endDateFormat)),t+=HU.close(TAG_TABLE),HU.jqid(l).html(t)}HU.handleNewContent(jqid(l))}))})),e.simple)return;m.find(".entry-form-select").click((function(t){$(this).is(":checked"),$("#"+$(this).attr("rowid"));HU.checkboxClicked(t,"entry_",$(this).attr(ATTR_ID)),o.find(".entry-form-select").each((function(){let t=$(this).is(":checked"),e=$("#"+$(this).attr("rowid"));t?e.addClass("entry-list-row-selected"):e.removeClass("entry-list-row-selected")}))})),m.find(".ramadda-thumbnail-image").click((function(){let t=$(this).attr(ATTR_SRC),e=$(this).attr("entry-url"),a=HU.href(e,HU.image(t),[ATTR_TITLE,"Click to view entry"]);HU.makeDialog({content:a,my:"left top",at:"left bottom",anchor:this,header:!0,draggable:!0})})),m.find(".ramadda-attachment").tooltip({show:{effect:"slideDown",delay:500,duration:1e3},content:function(){return $(this).prop(ATTR_TITLE)}});let U=m.find(".entry-list-row");U.bind("contextmenu",(function(t){let e=$(this),a=n[$(this).attr(ATTR_ENTRYID)];if(!a)return;eventX=GuiUtils.getEventX(t);let i=RamaddaUtil.getUrl("/entry/show?entryid="+a.getId()+"&output=metadataxml");if(GuiUtils.loadXML(i,(function(t){let i=t.responseXML.documentElement;text=getChildText(i),HU.makeDialog({content:text,my:"left top",at:"left bottom",title:a.getIconImage()+" "+a.getName(),anchor:e,header:!0})}),this),!t.preventDefault)return t.returnValue=!1,!1;t.preventDefault()})),RamaddaUtil.initDragAndDropEntries(U,n,i),r(t)},initDragAndDropOnHeader:function(t,e){let a=(t,e,a,i)=>{HU.makeOkCancelDialog($(".ramadda-header"),"New entry has been created: "+a+"<br>Do you want to view it?",(()=>{let t=RamaddaUtil.getUrl("/entry/show?entryid="+e);document.location=t}),null,null,{okLabel:"Yes",cancelLabel:"No",at:"middle bottom",my:"middle top",title:"New Entry",header:!0})};Utils.initDragAndDrop($(".ramadda-header"),(t=>{}),(t=>{}),((i,n,r,l)=>{Ramadda.handleDropEvent(i,n,r,t,e,a)}),null,!0,!0)},initDragAndDropEntries:function(t,e,a){function i(t){return t.hasClass("ramadda-entry-target")}t.mousedown((function(t){if(!t.shiftKey||!e)return;let i=e[$(this).attr(ATTR_ENTRYID)];if(!i)return;let n=$(this),r=[i];if($("#"+a).find(".entry-list-row-selected").each((function(){let t=e[$(this).attr(ATTR_ENTRYID)];t&&t.getId()!=i.getId()&&r.push(t)})),Utils.entryDragInfo={dragSource:n.attr(ATTR_ID),entry:i,getIds:function(){return r.map((t=>t.getId())).join(",")},hasEntry:function(t){return r.includes(t)},getHtml:function(){let t="";return r.forEach((e=>{""!=t&&(t+="<br>"),t+=e.getIconImage()+SPACE+e.getName()})),t}},i){if(Utils.mouseIsDown=!0,!t.preventDefault)return t.returnValue=!1,!1;t.preventDefault()}})),t.mouseover((function(t){let a="#C6E2FF";if(i($(this)))return void(Utils.mouseIsDown&&Utils.entryDragInfo&&$(this).css("background",a));let n=e[$(this).attr(ATTR_ENTRYID)];if(n&&Utils.mouseIsDown&&Utils.entryDragInfo){if(Utils.entryDragInfo.hasEntry(n))return;$(this).css("background",a)}})),t.mouseout((function(t){if(Utils.entryDragInfo){if(i($(this)))return void $(this).css("background","");let t=e[$(this).attr(ATTR_ENTRYID)];if(Utils.entryDragInfo.entry==t)return;$(this).css("background","")}})),t.mouseup((function(t){if(!Utils.entryDragInfo)return;if($(this).css("background",""),i($(this))){let t=RamaddaUtil.getUrl("/entry/getentries?output="+$(this).attr("target-type"));return Utils.entryDragInfo.getIds().split(",").forEach((e=>{t+="&selentry="+e})),void(document.location=t)}let a=e[$(this).attr(ATTR_ENTRYID)];a&&(Utils.entryDragInfo.hasEntry(a)||Utils.entryDragInfo.hasEntry(a)||(url=RamaddaUtil.getUrl("/entry/copy?action=action.move&from="+Utils.entryDragInfo.getIds()+"&to="+a.getId()),document.location=url))}))},initFormTags:function(t){let e=$("#"+t),a=e.find(".metadata-tag-input");e.attr("autocomplete","off"),a.attr("autocomplete","off"),a.keyup((function(t){HtmlUtils.hidePopupObject();let e=$(this).val();if(""==e)return;let a=HU.getUrl(RamaddaUtil.getUrl("/metadata/suggest"),[ATTR_VALUE,e.trim()]),i=$(this);$.getJSON(a,(t=>{if(0==t.length)return;let e="";t.forEach((t=>{e+=HU.div([ATTR_CLASS,"ramadda-clickable metadata-suggest","suggest",t],t)}));let a=HU.div([ATTR_CLASS,"ramadda-search-popup",ATTR_STYLE,HU.css(CSS_MAX_WIDTH,HU.px(200),CSS_PADDING,HU.px(4))],e);HU.makeDialog({content:a,my:"left top",at:"left bottom",anchor:i}).find(".metadata-suggest").click((function(){HtmlUtils.hidePopupObject(),i.val($(this).attr("suggest"))}))})).fail((t=>{console.log("url failed:"+a+"\n"+t)}))}));let i=$("#"+t).find(".metadata-tag");i.attr(ATTR_TITLE,"Click to remove"),i.click((function(){let t=e.find("#"+$(this).attr("metadata-id"));$(this).hasClass("metadata-tag-deleted")?($(this).removeClass("metadata-tag-deleted"),t.val("")):($(this).addClass("metadata-tag-deleted"),t.val("delete"))}))},initFormUpload:function(t,e,a,i){t||(t="upload");let n=$("#"+e);i&&n.attr("multiple","");let r=n.closest("form"),l=HU.div([ATTR_TITLE,"Click to select a file",ATTR_ID,e+"_filewrapper",ATTR_CLASS,"fileinput_wrapper"],HU.getIconImage("fas fa-upload")+SPACE+HU.div([ATTR_ID,e+"_filename",ATTR_CLASS,"fileinput_label"]));n.after(l),n.hide();let s=$("#"+e+"_filewrapper");$("#"+e+"_filename");s.click((()=>{n.trigger("click")}));let o=()=>{let t=t=>{let e=t.lastIndexOf("\\");return e<0&&(e=t.lastIndexOf("/")),e>=0&&(t=t.substring(e+1)),t},a="";if(n[0].files){let e=[];for(let a=0;a<n[0].files.length;a++){let i=n[0].files[a];e.push(t(i.name)+" ("+Utils.formatFileLength(i.size)+")")}a=Utils.join(e,",")}else a=t(n.val());""==a&&(a=HU.span([ATTR_CLASS,"fileinput_label_empty"],"Click to select a file")),$("#"+e+"_filename").html(a)};if(n.bind("change",o),o(),Utils.stringDefined(a)){let i=$("#"+a),n={files:{},cnt:0,added:!1};i.append(HU.div([ATTR_CLASS,"ramadda-dnd-target-files",ID,e+"_dnd_files"]));let l=$("#"+e+"_dnd_files");Utils.initDragAndDrop(i,(t=>{}),(t=>{}),((a,i,s,o)=>{n.cnt++;let d=i.name;if(!d&&i.getAsFile&&(d=i.getAsFile().name),!d){let t=i.type&&i.type.match("image/.*");if(d=prompt("Entry file name:",t?"image":"file"),!d)return;if(i.type)if("text/plain"==i.type)d.endsWith(".txt")||(d+=".txt");else{d=d+"."+i.type.replace(/.*\//,"")}}let c=e+"_list"+n.cnt,h=e+"_file"+n.cnt,T=e+"_file_name"+n.cnt,m=t+"_file_"+n.cnt,p=t+"_name_"+n.cnt;n.files[h]=s;let u=HU.span([ATTR_CLASS,"ramadda-clickable",ID,c+"_trash"],HU.getIconImage(icon_trash)),g=Utils.isDefined(i.size)?Utils.formatFileLength(i.size):"";l.append(HU.div([ATTR_ID,c],u+" "+d+" "+g)),r.append(HU.tag(TAG_INPUT,[ATTR_TYPE,"hidden",ATTR_NAME,m,ATTR_ID,h])),r.append(HU.tag(TAG_INPUT,[ATTR_TYPE,"hidden",ATTR_NAME,p,ATTR_ID,T])),$("#"+h).val(s),$("#"+T).val(d),$("#"+c+"_trash").click((function(){$("#"+c).remove(),$("#"+h).remove(),$("#"+T).remove()}))}),null,!0)}},handleDropEvent:function(t,e,a,i,n,r){let l,s=e.type.match("^image.*"),o=RamaddaUtil.getUrl("/entry/addfile"),d=e.name??"file",c=e.name;l="text/plain"==e.type?"txt":e.type.replace(/image\//,""),c||(c=d+"."+l);d=Utils.makeLabel(d.replace(/.[^\.]*$/,"")),d=e.name?prompt("Dropped file: "+c+"\nNew entry name:",d):prompt("Copied file: "+l+"\nNew entry name:",d),d&&(()=>{e.name||(c=Utils.makeId(d)+"."+l);let t,h=new FormData;h.append("filename",c),n&&h.append("authtoken",n),"application/zip"==e.type?h.append("filetype","geo_shapefile"):"application/json"==e.type?h.append("filetype","geo_geojson"):h.append("filetype",e.type),h.append("name",d),h.append("group",i),h.append("description",""),h.append("file",a),$.ajax({url:o,cache:!1,contentType:!1,processData:!1,method:"POST",type:"POST",data:h,success:e=>{t.remove(),"ok"==e.status?r&&r(e,e.entryid,e.name,s):alert("An error occurred creating entry: "+e.message)},error:function(e){t.remove(),alert("An error occurred creating entry: "+e)}});let T=HU.div([ATTR_STYLE,HU.css(CSS_TEXT_ALIGN,"center",CSS_PADDING,HU.px(5))],"Creating entry<br>"+HU.image(ramaddaCdn+"/icons/mapprogress.gif",[ATTR_WIDTH,HU.px(50)]));t=HU.makeDialog({content:T,anchor:$(document),my:"center top",at:"center top+100"})})()},inherit:function(t,e){return $.extend(t,e),e.getThis=function(){return t},t.getThis=function(){return t},t.mysuper=e,t},initMembers:function(t,e){return $.extend(t,e),t},defineMembers:function(t,e){return $.extend(t,e),t},showEntryPopup:function(t,e,a,i){let n=RamaddaUtils.contents[e];if(n)RamaddaUtils.showEntryPopupInner(t,e,a,n);else{let n=RamaddaUtil.getUrl("/entry/menu?entryid="+e);$.ajax({url:n,dataType:"text",success:function(n){RamaddaUtils.contents[e]=n,RamaddaUtils.showEntryPopupInner(t,e,a,n,i)}}).fail(((t,e,a)=>{console.log("/entry/menu failed:"+a),alert("Failed to contact the server")}))}},showEntryPopupInner:function(t,e,a,i,n){let r=$("#"+t);this.entryPopup=HU.makeDialog({content:i,my:"left top",at:"left bottom",title:a,rightSideTitle:n,anchor:r,draggable:!0,header:!0,inPlace:!1,headerRight:null})},initEntryListForm:function(t){let e=Utils.entryGroups[t];e&&(e.on=0,e.setVisbility())},hideEntryPopup:function(){this.entryPopup&&(this.entryPopup.remove(),this.entryPopup=null),HtmlUtils.getTooltip().hide()},originalImages:new Array,changeImages:new Array,folderClick:function(t,e,a){RamaddaUtil.changeImages[t]=a;let i=$("#"+t);if(0==i.length)return;let n=$("#img_"+t);"none"!=i.css("display")?(a&&n.html(HU.getIconImage("fa-caret-right")),i.hide()):(RamaddaUtil.originalImages[t]=n.html(),i.show(),n.html(HU.getIconImage("fa-caret-down")),(e+="&orderby=entryorder&ascending=true").startsWith("/")&&RamaddaUtil.currentRamaddaBase&&(e=RamaddaUtil.currentRamaddaBase+e),GuiUtils.loadXML(e,RamaddaUtil.handleFolderList,t))},handleFolderList:function(request,uid){if(null!=request.responseXML){let xmlDoc=request.responseXML.documentElement,script,html;for(i=0;i<xmlDoc.childNodes.length;i++){let t=xmlDoc.childNodes[i];"javascript"==t.tagName?script=getChildText(t):"content"==t.tagName&&(html=getChildText(t))}html||(html=getChildText(xmlDoc)),html&&($("#"+uid).html(HU.div([],html)),Utils.checkTabs(html)),script&&eval(script)}RamaddaUtil.changeImages[uid]?$("#img_"+uid).attr("src",icon_folderopen):$("#img_"+uid).attr("src",RamaddaUtil.originalImages[uid])},Components:{init:function(t){let e=$("#"+t),a=$("#"+t+"_header"),i=!1,n=!1,r=e.find(".ramadda-component"),l={},s={},o={};r.each((function(){let t=$(this).attr("component-date");if(!t)return;let e,a=Utils.parseDate(t);$(this).attr("component-day",e=Utils.formatDateWithFormat(a,"mmmm d yyyy")),o[e]=!0,$(this).attr("component-month",e=Utils.formatDateWithFormat(a,"mmmm yyyy")),s[e]=!0,$(this).attr("component-year",e=Utils.formatDateWithFormat(a,"yyyy")),l[e]=!0,$(this).attr("component-latitude")&&(n=!0),Utils.stringDefined($(this).attr("component-tags"))&&(i=!0)})),a.css("text-align","center");let d=HU.div([ATTR_STYLE,HU.css(CSS_DISPLAY,DISPLAY_INLINE_BLOCK),ATTR_CLASS,"ramadda-button ramadda-button-bar ramadda-button-on",ATTR_LAYOUT,"grid"],"Grid");Object.keys(l).length>1&&(d+=HU.div([ATTR_STYLE,HU.css(CSS_DISPLAY,DISPLAY_INLINE_BLOCK),ATTR_CLASS,"ramadda-button ramadda-button-bar",ATTR_LAYOUT,"year"],"Year")),Object.keys(s).length>1&&(d+=HU.div([ATTR_STYLE,HU.css(CSS_DISPLAY,DISPLAY_INLINE_BLOCK),ATTR_CLASS,"ramadda-button ramadda-button-bar",ATTR_LAYOUT,"month"],"Month")),Object.keys(o).length>1&&(d+=HU.div([ATTR_STYLE,HU.css(CSS_DISPLAY,DISPLAY_INLINE_BLOCK),ATTR_CLASS,"ramadda-button ramadda-button-bar",ATTR_LAYOUT,"day"],"Day")),d+=HU.div([ATTR_STYLE,HU.css(CSS_DISPLAY,DISPLAY_INLINE_BLOCK),ATTR_CLASS,"ramadda-button ramadda-button-bar",ATTR_LAYOUT,ATTR_TITLE],"Title"),i&&(d+=HU.div([ATTR_STYLE,HU.css(CSS_DISPLAY,DISPLAY_INLINE_BLOCK),ATTR_CLASS,"ramadda-button ramadda-button-bar",ATTR_LAYOUT,"tags"],"Tag")),d+=HU.div([ATTR_STYLE,HU.css(CSS_DISPLAY,DISPLAY_INLINE_BLOCK),ATTR_CLASS,"ramadda-button ramadda-button-bar",ATTR_LAYOUT,"author"],"Author"),n&&(d+=HU.div([ATTR_STYLE,HU.css(CSS_DISPLAY,DISPLAY_INLINE_BLOCK),ATTR_CLASS,"ramadda-button ramadda-button-bar",ATTR_LAYOUT,"map"],"Map")),a.append(HU.div([],d));let c=a.find(".ramadda-button");c.click((function(){c.removeClass("ramadda-button-on"),$(this).addClass("ramadda-button-on");let t=$(this).attr(ATTR_LAYOUT);"grid"==t?RamaddaUtil.Components.layout(e,r,null):RamaddaUtil.Components.layout(e,r,"component-"+t)}))},layout:function(t,e,a){if(t.find(".ramadda-group").each((function(){$(this).detach()})),t.mapId&&$("#"+t.mapId).detach(),t.ramaddaMap&&(ramaddaMapRemove(t.ramaddaMap),t.ramaddaMap=null),null==a)return e.show(),void e.each((function(){$(this).detach(),t.append($(this))}));if("component-map"==a){e.hide();let a=Utils.getUniqueId();t.mapId=a,t.append(HU.div([ATTR_ID,a,STYLE,HU.css(CSS_WIDTH,HU.perc(100),CSS_HEIGHT,HU.px(400))]));let i=new RepositoryMap(a,{});t.ramaddaMap=i,i.initMap(!1),e.each((function(){let t=$(this).attr("component-url"),e=+$(this).attr("component-latitude"),a=+$(this).attr("component-longitude");if(!Utils.isNumber(e))return;let n=$(this).attr("component-image"),r=HU.center(HU.b($(this).attr("component-title")));n&&(r+=HU.image(n,[ATTR_WIDTH,HU.px(300)])),t&&(r=HU.href(t,r));let l=new MapUtils.createLonLat(a,e);i.addPoint("",l,{pointRadius:6,strokeWidth:1,strokeColor:"#000",fillColor:"blue"},r)})),i.centerOnMarkers()}else{e.show();let i="component-day"==a||"component-month"==a||"component-year"==a,n=[],r={};e.each((function(){let t=$(this).attr(a)||"";if("component-tags"==a){let e=t.split(",");t=e[0]}if(!r[t]){r[t]=[];if(i){let e=$(this).attr("component-date"),a=e?Utils.parseDate(e):null;n.push([t,a])}else n.push(t)}r[t].push($(this))})),n=i?n.sort(((t,e)=>(t=t[1],e=e[1],t&&e?t?e?e.getTime()-t.getTime():-1:1:0))):n.sort(),n.forEach((e=>{i&&(e=e[0]);let a=t.append($(HU.div([ATTR_CLASS,"ramadda-group"],HU.div([ATTR_CLASS,"ramadda-group-header"],e))));r[e].forEach((t=>{a.append(t)}))}))}}}};function EntryRow(t,e,a,i,n,r){r||(r={showIcon:!0}),this.args=r,r.entryId=t,Utils.globalEntryRows[t]=this,Utils.globalEntryRows[e]=this,Utils.globalEntryRows[a]=this,this.entryId=t,this.showIcon=r.showIcon,this.onColor="#FFFFCC",this.overColor="#f4f4f4",this.rowId=e,this.cbxId=a,this.cbxWrapperId=i,this.showDetails=n,this.getRow=function(){return $("#"+this.rowId)},this.getCbx=function(){return $("#"+this.cbxId)};let l=this.getCbx().closest("form");if(l.length){let t=Utils.entryGroups[l.attr(ATTR_ID)];t&&t.addEntryRow(this)}else this.getCbx().hide();this.setCheckbox=function(t){this.getCbx().prop("checked",t),this.setRowColor()},this.isSelected=function(){return this.getCbx().is(":checked")},this.setRowColor=function(){this.getRow().removeClass("entry-row-hover"),this.isSelected()?this.getRow().addClass("entry-list-row-selected"):this.getRow().removeClass("entry-list-row-selected")},this.mouseOver=function(t){$("#entrymenuarrow_"+e).attr("src",icon_menuarrow),this.getRow().addClass("entry-row-hover")},this.mouseOut=function(t){$("#entrymenuarrow_"+e).attr("src",icon_blank),this.setRowColor()},this.mouseClick=function(e){eventX=GuiUtils.getEventX(e);let a=this.getRow().offset();if(eventX-a.left<150)return;this.lastClick=eventX;let i=RamaddaUtil.getUrl("/entry/show?entryid="+t+"&output=metadataxml");this.showDetails?i+="&details=true":i+="&details=false",this.showIcon?i+="&showIcon=true":i+="&showIcon=false",GuiUtils.loadXML(i,this.handleTooltip,this)},this.handleTooltip=function(t,e){let a=t.responseXML.documentElement;text=getChildText(a);let i=e.getRow().offset().left,n=(e.lastClick,HU.jsLink("",HU.getIconImage(ICON_CLOSE),[ATTR_ONMOUSEDOWN,"RamaddaUtil.hideEntryPopup();",ATTR_ID,"tooltipclose"])),r=HU.image(e.args.icon)+SPACE+e.args.name,l=HU.div([ATTR_CLASS,"ramadda-popup-header"],n+SPACE2+r),s=HU.div([ATTR_CLASS,"ramadda-popup",ATTR_STYLE,HU.css(CSS_DISPLAY,"block")],l+HU.table([],text)),o=HtmlUtils.getTooltip();o.html(s),o.draggable(),Utils.checkTabs(text);let d=e.getRow().offset(),c=(e.getRow().outerWidth(),e.getRow().outerHeight()),h=HtmlUtils.getTooltip().outerWidth(),T=$(window).width(),m=e.lastClick;e.lastClick+h>T&&(m-=e.lastClick+h-T);let p=HU.px(m),u=HU.px(3+d.top+c);o.css({position:"absolute",zIndex:5e3,left:p,top:u}),o.show()}}var selectors=new Array;function Selector(t,e,a,i,n,r,l,s,o){let d=this;this.id=e,this.elementId=a,this.domId=HU.getUniqueId("selector_"),this.props=o||{},this.localeId=r,this.entryType=l,this.allEntries=i,this.selecttype=n,this.textComp=GuiUtils.getDomObject(this.elementId),this.ramaddaUrl=s??ramaddaBaseUrl,this.getTextComponent=function(){let t="#"+this.elementId;return $(t)},this.getHiddenComponent=function(){let t="#"+this.elementId+"_hidden";return $(t)},this.cancel=function(t){!t&&this.pinned||jqid(this.domId).remove()},this.clearInput=function(){this.getHiddenComponent().val(""),this.getTextComponent().val("")},this.handleClick=function(t){let e=this.props.anchor;if(!e){if(this.props.eventSourceId&&(e=jqid(this.props.eventSourceId)),null!=e&&0!=e.length||t&&t.target&&(e=$(t.target)),null==e||0==e.length){let t=this.id+"_selectlink";e=jqid(t)}null!=e&&0!=e.length||(e=jqid(this.id))}HtmlUtils.hidePopupObject(t);let a=$(HU.div([ATTR_STYLE,HU.css(CSS_POSITION,"relative")])).appendTo("body");$(HU.div([ATTR_STYLE,HU.css(CSS_MIN_WIDTH,HU.px(200),CSS_MIN_HEIGHT,HU.px(200)),ATTR_CLASS,"ramadda-selectdiv",ATTR_ID,this.domId])).appendTo(a),this.div=jqid(this.domId),this.props.minWidth&&this.div.css("min-width",this.props.minWidth),this.div.draggable(),this.anchor=e,this.showDiv=()=>{this.div.show(),this.div.position({of:this.anchor,my:this.props.locationMy??"left top",at:this.props.locationAt??"left bottom",collision:this.props.collision??"fit fit"})};let i=HU.url("/entry/show",["output","selectxml","noredirect","true","firstclick",!0]);if(this.selecttype&&(i=HU.url(i,["selecttype",this.selecttype])),i=HU.url(i,"allentries",this.allEntries,"target",this.id),this.ramaddaUrl&&!this.ramaddaUrl.startsWith("/")){let t=new URL(this.ramaddaUrl).pathname,e=this.ramaddaUrl.replace(t,"");RamaddaUtil.currentRamaddaBase=e,i=this.ramaddaUrl+i}else RamaddaUtil.currentRamaddaBase=null,i=RamaddaUtil.getUrl(i);return this.localeId&&(i=i+"&localeid="+this.localeId),this.entryType&&(i=i+"&entrytype="+this.entryType),this.props.typeLabel&&(i=i+"&typelabel="+this.props.typeLabel),Utils.isDefined(this.props.showTypeSelector)&&(i=i+"&showtypeselector="+this.props.showTypeSelector),GuiUtils.loadXML(i,((t,e)=>{d.handleSelect(t,e)}),this.id),!1},this.handleClick(t)}function getChildText(t){let e="";for(childIdx=0;childIdx<t.childNodes.length;childIdx++)e+=t.childNodes[childIdx].nodeValue;return e}function toggleBlockVisibility(t,e,a,i,n){HtmlUtils.toggleBlockVisibility(t,e,a,i,null,n)}function toggleInlineVisibility(t,e,a,i){let n,r=GuiUtils.getDomObject(e);toggleVisibility(t,DISPLAY_INLINE),n=jqid(t).is(":visible")?a:i,StringUtil.startsWith(n,"fa-")?$("#"+e).attr(ATTR_CLASS,n):r&&(r.obj.src=n),Utils.ramaddaUpdateMaps()}function toggleVisibility(t,e,a,i){let n=$("#"+t).css("display");return Utils.isDefined(i)?(i?$("#"+t).show():$("#"+t).hide(),i):($("#"+t).toggle(a),"block"!=n)}function hide(t){$("#"+t).hide()}function hideObject(t){return t?($("#"+t.id).hide(),1):0}function showObject(t,e){if(!t)return 0;$("#"+t.id).show()}function toggleVisibilityOnObject(t,e){if(!t)return 0;$("#"+t.id).toggle()}Selector.prototype={handleSelect:function(t,e){let a=this,i=t.responseXML.documentElement;text=getChildText(i);let n=this.domId+"-pin",r=HU.jsLink("",HtmlUtils.getIconImage(icon_pin),[ATTR_CLASS,"ramadda-popup-pin",ATTR_ID,n]),l=HtmlUtils.getIconImage(ICON_CLOSE,[]),s=e+"_close",o=HU.span([ATTR_ID,s,ATTR_CLASS,"ramadda-clickable"],l),d=(this.props?this.props.title:"")??"",c=(this.props?this.props.extra:"")??"";Utils.stringDefined(d)&&(d=HU.span([ATTR_STYLE,HU.css(CSS_MARGIN_LEFT,HU.px(5))],d));let h=HtmlUtils.div([ATTR_STYLE,HU.css(CSS_TEXT_ALIGN,"left"),ATTR_CLASS,"ramadda-popup-header"],SPACE+o+SPACE+r+d),T=HtmlUtils.div([ATTR_ID,e+"-popup"],h+c+text);this.div.html(T),this.showDiv(),jqid(s).click((()=>{this.cancel(!0)})),$("#"+n).click((function(){a.pinned=!a.pinned,a.pinned?$(this).addClass("ramadda-popup-pin-pinned"):$(this).removeClass("ramadda-popup-pin-pinned")})),this.props&&this.props.initCallback&&this.props.initCallback()}};
