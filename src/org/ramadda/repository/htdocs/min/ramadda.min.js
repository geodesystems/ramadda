var currentRamaddaBase,lastCbxClicked,lastCbxIdClicked;function mouseOverOnEntry(t,e,i){if(Utils.mouseIsDown&&Utils.entryDragInfo){if(Utils.entryDragInfo.hasEntry(e))return;$("#"+i).css("borderBottom","2px black solid")}}function mouseOutOnEntry(t,e,i){Utils.entryDragInfo&&Utils.entryDragInfo.entryId==e||$("#"+i).css("borderBottom","")}function mouseDownOnEntry(t,e,i,s,n){t=GuiUtils.getEvent(t),Utils.entryDragInfo={dragSource:s,getIds:function(){return this.entryIds.join(",")},getHtml:function(){let t="";return this.entries.forEach((e=>{""!=t&&(t+="<br>"),t+=HU.image(e.args.icon)+SPACE+e.args.name})),t},hasEntry:function(t){return this.entryIds.includes(t)},addEntry:function(t){this.hasEntry(t.entryId)||(this.entries.push(t),this.entryIds.push(t.entryId))},entryIds:[],entries:[]};let o=Utils.globalEntryRows[e];if(o&&Utils.entryDragInfo.addEntry(o),$(".ramadda-entry-select:checked").each((function(){let t=$(this).attr("id"),e=Utils.globalEntryRows[t];e&&Utils.entryDragInfo.addEntry(e)})),Utils.mouseIsDown=!0,!t.preventDefault)return t.returnValue=!1,!1;t.preventDefault()}function mouseUpOnEntry(t,e,i){Utils.entryDragInfo&&(Utils.entryDragInfo.hasEntry(e)||($("#"+i).css("borderBottom",""),Utils.entryDragInfo.hasEntry(e)||(url=ramaddaBaseUrl+"/entry/copy?action=action.move&from="+Utils.entryDragInfo.getIds()+"&to="+e,document.location=url)))}function EntryFormList(t,e,s,n){this.entryRows=new Array,this.lastEntryRowClicked=null,Utils.entryGroups[t]=this,Utils.groupList.push(this),this.formId=t,this.toggleImg=e,this.on=n,this.entries=new Array,this.groupAddEntry=function(t){this.entries[this.entries.length]=t},this.addEntryRow=function(t){this.groupAddEntry(t.cbxWrapperId),this.entryRows[this.entryRows.length]=t,this.on?t.getCbx().show():t.getCbx().hide()},this.groupAddEntry(s),this.on||hideObject(s),this.groupToggleVisibility=function(){this.on=!this.on,HU.addToDocumentUrl(this.formId+"_visible",this.on),this.setVisibility()},this.findEntryRow=function(t){let e;for(e=0;e<this.entryRows.length;e++)if(this.entryRows[e].rowId==t)return this.entryRows[e];return null},this.checkboxClicked=function(t,e){if(!t)return;let s;for(i=0;i<this.entryRows.length;i++)if(this.entryRows[i].cbxId==e){s=this.entryRows[i];break}if(!s)return;let n=s.isSelected();if(t.ctrlKey)for(i=0;i<this.entryRows.length;i++)this.entryRows[i].setCheckbox(n);if(t.shiftKey){if(this.lastEntryRowClicked){let t=this.lastEntryRowClicked.getCbx().offset().top,e=s.getCbx().offset().top;if(t>e){let i=t;t=e,e=i}for(i=0;i<this.entryRows.length;i++){let s=this.entryRows[i].getCbx().offset().top;s>=t&&s<=e&&this.entryRows[i].setCheckbox(n)}}}else this.lastEntryRowClicked=s},this.setVisibility=function(){this.toggleImg&&(this.on?$("#"+this.toggleImg).html(HU.getIconImage("fas fa-caret-down")):$("#"+this.toggleImg).html(HU.getIconImage("fas fa-caret-right")));let t=$("#"+this.formId);for(this.on?t.find(":checkbox").show():t.find(":checkbox").hide(),i=0;i<this.entries.length;i++)obj=GuiUtils.getDomObject(this.entries[i]),obj&&(this.on?showObject(obj,"block"):hideObject(obj))};let o=HU.getUrlArgument(this.formId+"_visible");null!==o&&(this.on="true"==o,this.setVisibility())}function initEntryListForm(t){let e=Utils.entryGroups[t];e&&(e.on=0,e.setVisbility())}function EntryRow(t,e,i,s,n,o){o||(o={showIcon:!0}),this.args=o,o.entryId=t,Utils.globalEntryRows[t]=this,Utils.globalEntryRows[e]=this,Utils.globalEntryRows[i]=this,this.entryId=t,this.showIcon=o.showIcon,this.onColor="#FFFFCC",this.overColor="#f4f4f4",this.rowId=e,this.cbxId=i,this.cbxWrapperId=s,this.showDetails=n,this.getRow=function(){return $("#"+this.rowId)},this.getCbx=function(){return $("#"+this.cbxId)};let l=this.getCbx().closest("form");if(l.length){let t=Utils.entryGroups[l.attr("id")];t&&t.addEntryRow(this)}else this.getCbx().hide();this.setCheckbox=function(t){this.getCbx().prop("checked",t),this.setRowColor()},this.isSelected=function(){return this.getCbx().is(":checked")},this.setRowColor=function(){this.getRow().removeClass("entry-row-hover"),this.isSelected()?this.getRow().addClass("entry-list-row-selected"):this.getRow().removeClass("entry-list-row-selected")},this.mouseOver=function(t){$("#entrymenuarrow_"+e).attr("src",icon_menuarrow),this.getRow().addClass("entry-row-hover")},this.mouseOut=function(t){$("#entrymenuarrow_"+e).attr("src",icon_blank),this.setRowColor()},this.mouseClick=function(e){eventX=GuiUtils.getEventX(e);let i=this.getRow().offset();if(eventX-i.left<150)return;this.lastClick=eventX;let s=ramaddaBaseUrl+"/entry/show?entryid="+t+"&output=metadataxml";this.showDetails?s+="&details=true":s+="&details=false",this.showIcon?s+="&showIcon=true":s+="&showIcon=false",GuiUtils.loadXML(s,this.handleTooltip,this)},this.handleTooltip=function(t,e){let i=t.responseXML.documentElement;text=getChildText(i);let s=e.getRow().offset().left,n=(e.lastClick,HU.jsLink("",HU.getIconImage(icon_close),["onmousedown","hideEntryPopup();","id","tooltipclose"])),o=HU.image(e.args.icon)+SPACE+e.args.name,l=HU.div([CLASS,"ramadda-popup-header"],n+SPACE2+o),r=HU.div([CLASS,"ramadda-popup",STYLE,"display:block;"],l+"<table>"+text+"</table>"),a=HtmlUtils.getTooltip();a.html(r),a.draggable(),Utils.checkTabs(text);let c=e.getRow().offset(),d=(e.getRow().outerWidth(),e.getRow().outerHeight()),h=HtmlUtils.getTooltip().outerWidth(),u=$(window).width(),g=e.lastClick;e.lastClick+h>u&&(g-=e.lastClick+h-u);let m=g+"px",f=3+c.top+d+"px";a.css({position:"absolute",zIndex:5e3,left:m,top:f}),a.show()}}function hideEntryPopup(){HtmlUtils.getTooltip().hide()}function findEntryRow(t){let e;for(e=0;e<Utils.groupList.length;e++){let i=Utils.groupList[e].findEntryRow(t);if(i)return i}return null}function entryRowOver(t){let e=findEntryRow(t);e&&e.mouseOver()}function entryRowOut(t){let e=findEntryRow(t);e&&e.mouseOut()}function entryRowClick(t,e){let i=findEntryRow(e);i&&i.mouseClick(t)}function checkboxClicked(t,e,s){if(!t)return;let n=GuiUtils.getDomObject(s);if(!n)return;n=n.obj;let o=new Array;if(!n.form)return;let l=n.form.elements;for(i=0;i<l.length;i++)(l[i].name.indexOf(e)>=0||l[i].id.indexOf(e)>=0)&&o.push(l[i]);let r=n.checked;if(t.ctrlKey)for(i=0;i<o.length;i++)o[i].checked=r;if(t.shiftKey){if(lastCbxClicked){let t=GuiUtils.getTop(n),e=GuiUtils.getTop(lastCbxClicked),l=$("#"+lastCbxIdClicked),a=$("#"+s);if(l.position()&&(e=l.position().top),a.position()&&(t=a.position().top),t>e){let i=t;t=e,e=i}for(i=0;i<o.length;i++){let s=$("#"+o[i].id).position().top;s>=t&&s<=e&&(o[i].checked=r)}}}else lastCbxClicked=n,lastCbxIdClicked=s}function toggleBlockVisibility(t,e,i,s){toggleVisibility(t,"block")?HU.isFontAwesome(i)?$("#"+e).html(HU.makeToggleImage(i)):$("#"+e).attr("src",i):HU.isFontAwesome(i)?$("#"+e).html(HU.makeToggleImage(s)):$("#"+e).attr("src",s),Utils.ramaddaUpdateMaps()}function toggleInlineVisibility(t,e,i,s){let n,o=GuiUtils.getDomObject(e);n=toggleVisibility(t,"inline")?i:s,StringUtil.startsWith(n,"fa-")?$("#"+e).html(HtmlUtils.getIconImage(n,[])):o&&(o.obj.src=n),Utils.ramaddaUpdateMaps()}let originalImages=new Array,changeImages=new Array;function folderClick(t,e,i){changeImages[t]=i;let s=$("#"+t);if(0==s.length)return;let n=$("#img_"+t);"none"!=s.css("display")?(i&&n.html(HU.getIconImage("fa-caret-right")),s.hide()):(originalImages[t]=n.html(),s.show(),n.html(HU.getIconImage("fa-caret-down")),(e+="&orderby=entryorder&ascending=true").startsWith("/")&&currentRamaddaBase&&(e=currentRamaddaBase+e),GuiUtils.loadXML(e,handleFolderList,t))}function handleFolderList(request,uid){if(null!=request.responseXML){let xmlDoc=request.responseXML.documentElement,script,html;for(i=0;i<xmlDoc.childNodes.length;i++){let t=xmlDoc.childNodes[i];"javascript"==t.tagName?script=getChildText(t):"content"==t.tagName&&(html=getChildText(t))}html||(html=getChildText(xmlDoc)),html&&($("#"+uid).html("<div>"+html+"</div>"),Utils.checkTabs(html)),script&&eval(script)}changeImages[uid]?$("#img_"+uid).attr("src",icon_folderopen):$("#img_"+uid).attr("src",originalImages[uid])}let selectors=new Array;function Selector(t,e,i,s,n,o,l,r){this.id=e,this.elementId=i,this.localeId=o,this.entryType=l,this.allEntries=s,this.selecttype=n,this.textComp=GuiUtils.getDomObject(this.elementId),this.ramaddaUrl=r||ramaddaBaseUrl,this.getTextComponent=function(){let t="#"+this.elementId;return $(t)},this.getHiddenComponent=function(){let t="#"+this.elementId+"_hidden";return $(t)},this.clearInput=function(){this.getHiddenComponent().val(""),this.getTextComponent().val("")},this.handleClick=function(t){let e=this.id+"_selectlink",i=$("#"+e);0==i.length&&(i=$("#"+this.id)),HtmlUtils.hidePopupObject(t),this.div=GuiUtils.getDomObject("ramadda-selectdiv");let s=$("#ramadda-selectdiv");s.show(),s.position({of:i,my:"left top",at:"left bottom",collision:"none none"});let n="/entry/show?output=selectxml&selecttype="+this.selecttype+"&allentries="+this.allEntries+"&target="+this.id+"&noredirect=true&firstclick=true";if(this.ramaddaUrl&&!this.ramaddaUrl.startsWith("/")){let t=new URL(this.ramaddaUrl).pathname,e=this.ramaddaUrl.replace(t,"");currentRamaddaBase=e,n=this.ramaddaUrl+n}else currentRamaddaBase=null,n=ramaddaBaseUrl+n;return this.localeId&&(n=n+"&localeid="+this.localeId),this.entryType&&(n=n+"&entrytype="+this.entryType),GuiUtils.loadXML(n,handleSelect,this.id),!1},this.handleClick(t)}function selectClick(t,e,i){selector=selectors[t];let s=getHandler(t);if(s||(s=getHandler(selector.elementId)),s)return s.selectClick(selector.selecttype,t,e,i),selectCancel(),void console.log("no handler");if("wikilink"==selector.selecttype)insertAtCursor(selector.elementId,selector.textComp.obj,"[["+e+"|"+i+"]]");else if("fieldname"==selector.selecttype)insertAtCursor(selector.elementId,selector.textComp.obj,i);else if("entryid"==selector.selecttype){let t=HU.getWikiEditor(selector.elementId);t?t.insertTags(e," ","importtype"):insertText(selector.elementId,e)}else"entry:entryid"==selector.selecttype?HU.getWikiEditor(selector.elementId).insertTags("entry:"+e," ","importtype"):(selector.getHiddenComponent().val(e),selector.getTextComponent().val(i));selectCancel()}function selectCancel(t){!t&&$("#ramadda-selectdiv-pin").attr("data-pinned")||$("#ramadda-selectdiv").hide()}function selectCreate(t,e,i,s,n,o,l,r){let a=e+(r||"");selectors[a]?selectors[a].handleClick(t):selectors[e]=selectors[a]=new Selector(t,e,i,s,n,o,l,r)}function selectInitialClick(t,e,i,s,n,o,l,r){return selectCreate(t,e,i,s,n,o,l,r),!1}function clearSelect(t){if(selector=selectors[t],selector)selector.clearInput();else{let e=GuiUtils.getDomObject(t),i=GuiUtils.getDomObject(t+"_hidden");i&&(i.obj.value=""),e&&(e.obj.value="")}}function handleSelect(request,id){selector=selectors[id];let xmlDoc=request.responseXML.documentElement;text=getChildText(xmlDoc);let pinId=selector.div.id+"-pin",pin=HU.jsLink("",HtmlUtils.getIconImage(icon_pin),["class","ramadda-popup-pin","id",pinId]),closeImage=HtmlUtils.getIconImage(icon_close,[]),close='<a href="javascript:selectCancel(true);">'+closeImage+"</a>",header=HtmlUtils.div(["style","text-align:left;","class","ramadda-popup-header"],SPACE+close+SPACE+pin),popup=HtmlUtils.div(["id",id+"-popup"],header+text);selector.div.obj.innerHTML=popup,$("#"+selector.div.id).draggable(),$("#"+pinId).click((function(){$(this).attr("data-pinned")?($(this).removeClass("ramadda-popup-pin-pinned"),$(this).attr("data-pinned",!1)):($(this).addClass("ramadda-popup-pin-pinned"),$(this).attr("data-pinned",!0))}));let arr=selector.div.obj.getElementsByTagName("script");for(let n=0;n<arr.length;n++)eval(arr[n].innerHTML)}function getChildText(t){let e="";for(childIdx=0;childIdx<t.childNodes.length;childIdx++)e+=t.childNodes[childIdx].nodeValue;return e}function toggleVisibility(t,e){let i=$("#"+t).css("display");return $("#"+t).toggle(),"block"!=i}function hide(t){$("#"+t).hide()}function showStickyPopup(t,e,i,s){let n="left top",o="left top";$("#"+i).show("slow"),$("#"+i).position({of:jQuery("#"+e),my:n,at:o,collision:"none none"}),$("#"+i).position({of:jQuery("#"+e),my:n,at:o,collision:"none none"})}function hideObject(t){return t?($("#"+t.id).hide(),1):0}function showObject(t,e){if(!t)return 0;$("#"+t.id).show()}function toggleVisibilityOnObject(t,e){if(!t)return 0;$("#"+t.id).toggle()}let EntryTree={initSelectAll:function(){$("#selectall").click((function(t){let e=$(this).is(":checked");$(".ramadda-entry-select").each((function(){let t=Utils.globalEntryRows[$(this).attr("id")];t&&t.setCheckbox(e)}))}))},entryRowCheckboxClicked:function(t,e){let i=GuiUtils.getDomObject(e);if(!i)return;if(i=i.obj,!i.form)return;let s=Utils.entryGroups[i.form.id];s&&s.checkboxClicked(t,e)}};
