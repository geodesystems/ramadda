<wiki>
<title>RAMADDA Data Tables</title>
+section title="RAMADDA Data Tables"

:navtop


<link rel="stylesheet" type="text/css" href="dbstyle.css" title="Style">
:heading Introduction to Data Tables
The data tables facility allow you to define a structured data base table via 
an XML definition in a RAMADDA plugin. 
The RAMADDA database facility looks for any file that ends with "db.xml", e.g., 
testdb.xml
in the plugins directory. 
There are lots of examples on <a href="https://github.com/geodesystems/ramadda/tree/master/src/org/ramadda/plugins/db">Github</a>

:heading Defining a new Data Table
Here is an example DB xml file that defines an "example_instrument" database.
+pre
&lt;tables&gt;
  &lt;table   id="example_instrument"  name="Example Instrument" cansearch="true"  canlist="true"&gt;
    &lt;column  name="temp"  type="double"  label="Temperature"   /&gt;
    &lt;column  name="rh"  type="double"  label="Relative Humidity"   /&gt;
  &lt;/table&gt;
&lt;/tables&gt;
-pre


Each  database table is defined with a table tag. There can be any number of table tags
contained by the outer tables tag. You need to specify a unique id and a name.
Contained in the table tag are a set of column definitions. Each column has a name which ends 
up being the database column name so this should be legal sql. The column definition also contains
a label and a number of flags,
e.g. cansearch, canlist, that determine whether the column is shown in the list and in the search form.
    
<p>
The column type attribute can be one of:
<pre>
string
enumeration
enumerationplus
date
datetime
double
int
latlon
latlonbbox
clob
email
</pre>

If the column is an <i>enumeration</i> then you also have to specify a column separated list of values.
See the prioriity example below. The  <i>enumerationplus</i> type allows the user to enter 
their own value and/or use values that have already been created.
If its a string or a clob then you also need to specify a size (byte size)
<p>
Here is another example, a tasks data table - 
<pre>
&lt;table id="tasks" name="Tasks" icon="/db/tasks.gif"&gt;
   &lt;column name="title" type="string" label="Title" cansearch="true"   canlist="true" required="true"/&gt;
   &lt;column name="priority" type="enumeration" label="Priority" values="High,Medium,Low" cansearch="true"   canlist="true"/&gt;
   &lt;column name="status" type="enumeration" label="Status" values="Not Started,In Progress,Completed,Deferred,Waiting" cansearch="true"   canlist="true"&gt;
       &lt;property name="iscategory" value="true"/&gt;
   &lt;/column&gt;

   &lt;column name="complete" type="percentage" label="% Complete" cansearch="true"   canlist="true"/&gt;
   &lt;column name="assignedto" type="enumerationplus" values="" label="Assigned To" cansearch="true"   canlist="true"&gt;
       &lt;property name="iscategory" value="true"/&gt;
   &lt;/column&gt;
   &lt;column name="description" type="string" label="Description"  canlist="false" rows="5" columns="40" size="10000" /&gt;
   &lt;column name="startdate" type="date" label="Start Date" cansearch="true"   canlist="true"/&gt;
   &lt;column name="enddate" type="date" label="End Date" cansearch="true"   canlist="true"/&gt;
&lt;/table&gt;
</pre>

Column tags can also contain property tags
If a column tag has a property tag iscategory then the categorical views are shown, e.g.:
<pre>
&lt;column ...&gt;
     &lt;property name="iscategory" value="true"/&gt;
 &lt;/column&gt;
</pre>


If  a column has a "label=true" property, e.g.:
<pre>
      &lt;property name="label" value="true"/&gt;
</pre>
then that column value is used as the label for the entry





:heading Templates
You can define additional display templates. These show up in the "View As" menu in the search form.
Templates are specified within the table tag with a template tag. There can be any number of templates.
A template is defined with an id, name and (optional) mimetype. You can define  optional prefix and suffix.
The main part of the template is define with the contents tag. This holds macros with the names of the table columns.

<pre>
&lt;tables&gt;
&lt;table  id="airplane_crashes"  name="Airplane Crashes"  icon="/db/database.png" &gt;
...
&lt;template id="t1" name="Template 1" mimetype="text"&gt;
&lt;contents&gt;
&lt;![CDATA[
&lt;h2&gt;Crash&lt;/h2&gt;
Date: ${date}&lt;br&gt;
Location: ${location}&lt;br&gt;
Operator: ${operator}
]]&gt;
&lt;/contents&gt;
&lt;prefix&gt;
&lt;![CDATA[
&lt;h1&gt;Crashes&lt;/h1&gt;
]]&gt;
&lt;/prefix&gt;
&lt;suffix&gt;
&lt;![CDATA[
End
]]&gt;
&lt;/suffix&gt;
&lt;/template&gt;
&lt;/table&gt;
&lt;/tables&gt;
 
</pre>

:heading Upload API
RAMADDA provides an upload API for each DB entry.
The general form of the API is:
<pre>
https://hostname/db/upload?entryid=&lt;entry id&gt;&amp;&lt;param1&gt;=0.0&amp;&lt;param2&gt;=0.0&amp;key=HIDDEN
</pre>
where param1, param2, etc are the column names as specified above.
One can view the example API for an entry
through the  Information page (from the entry menu).
For the instrument example above the upload URL is of the form:
<pre>
https://hostname/db/upload?entryid=5da1c7c8-57c2-4102-acfe-c02e1aa1d4e5&temp=0.0&rh=0.0&key=HIDDEN
</pre>

Note: if the target DB entry has an alias, e.g. "site1", then that alias can be used in the API:
<pre>
https://hostname/db/upload?entryid=site1&temp=0.0&rh=0.0&key=HIDDEN
</pre>

Note: for compatability with the <a href="https://earthcubeprojects-chords.github.io/chords-docs/">CHORDS</a> system
the below API is also provided:
<pre>
https://hostname/measurements/url_create?instrument_id=5da1c7c8-57c2-4102-acfe-c02e1aa1d4e5&temp=0.0&rh=0.0&key=HIDDEN
</pre>


The key is an API key. These are defined by a site administrator in either a .properties file installed
in the RAMADDA home directory or through the Admin-&gt;Site and Contact Information-&gt;Extra Properties section.
The API keys are of the form:
<pre>
db.apikey.&lt;some API key&gt;=&lt;comma separated list of entry ids&gt;
db.apikey.&lt;some other API key&gt;=&lt;comma separated list of entry ids&gt;
</pre>

The above example would permit uploads to the DB entry with ID ff29d75c-8baf-4b17-b121-6c0e10eb9c60 or, the
entry ID could be an ancestor entry of the target DB entry.  This allows for upload access to a group of DB
entries.


+callout-info
It is strongly encouraged to have the API key (e.g. "some_unique_password") be hard to guess.
-callout-info

+callout-info
Note: if no entry IDs are specified then the API key is valid for <em>any</em> entry.
-callout-info


For example with the key defintion:
<pre>
db.apikey.some_unique_password=ff29d75c-8baf-4b17-b121-6c0e10eb9c60,d3016687-af06-4f06-acb5-d41bf19b8c33
db.apikey.some_other_password=ff29d75c-8baf-4b17-b121-6c0e10eb9c60
</pre>


The below URLs should work with the above API key definition:
<pre>
https://hostname/db/upload?entryid=ff29d75c-8baf-4b17-b121-6c0e10eb9c60&temp=0.0&rh=0.0&key=some_unique_password
https://hostname/db/upload?entryid=d3016687-af06-4f06-acb5-d41bf19b8c33&temp=0.0&rh=0.0&key=some_unique_password
Or with the alternate URL:
https://hostname/measurements/url_create?instrument_id=ff29d75c-8baf-4b17-b121-6c0e10eb9c60&temp=0.0&rh=0.0&key=some_other_password  
</pre>

A JSON object is returned with either an error or an ok result.


-section
